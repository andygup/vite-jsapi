import{e as o,y as l,aB as E,b as y,T as c,C as m,aj as b,a7 as w,w as I,aC as H,aw as P}from"./index-df1c7459.js";import{q as T}from"./DynamicLayerView3D-8c9c8187.js";import{s as F}from"./popupUtils-5b2188de.js";import"./LayerView3D-6a4e3fea.js";import"./projectExtentUtils-110dff46.js";import"./ImageMaterial-292dd32e.js";import"./LayerView-17796f9f.js";import"./RefreshableLayerView-60f1a82b.js";const C=e=>{let t=class extends e{constructor(){super(...arguments),this.view=null}async fetchPopupFeatures(a,r){const{layer:n}=this;if(!a)throw new c("imagerylayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:n});const{popupEnabled:i}=n,s=F(n,r);if(!i||m(s))throw new c("imagerylayerview:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:i,popupTemplate:s});const g=await s.getRequiredFields(),d=new b;d.timeExtent=this.timeExtent,d.geometry=a,d.outFields=g,d.outSpatialReference=a.spatialReference;const{resolution:p,spatialReference:u}=this.view,x=this.view.type==="2d"?new w(p,p,u):new w(.5*p,.5*p,u),{returnTopmostRaster:f,showNoDataRecords:R}=s.layerOptions||{returnTopmostRaster:!0,showNoDataRecords:!1},v={returnDomainValues:!0,returnTopmostRaster:f,pixelSize:x,showNoDataRecords:R,signal:I(r)?r.signal:null};return n.queryVisibleRasters(d,v).then(D=>D)}canResume(){var a;return!!super.canResume()&&!((a=this.timeExtent)!=null&&a.isEmpty)}};return o([l()],t.prototype,"layer",void 0),o([l()],t.prototype,"suspended",void 0),o([l(E)],t.prototype,"timeExtent",void 0),o([l()],t.prototype,"view",void 0),t=o([y("esri.views.layers.ImageryLayerView")],t),t};let h=class extends C(T){constructor(){super(...arguments),this.type="imagery-3d",this.redrawDebounced=H(async e=>{this.redraw((t,a)=>this._redrawImage(t,a),e)},2e3)}initialize(){this.handles.add([P(()=>this.view.basemapTerrain.ready,()=>this._initializeMaximumDataResolution(),{once:!0,initial:!0}),this.layer.on("redraw",()=>this.updatingHandles.addPromise(this.redrawDebounced()))]),this.updatingHandles.add(()=>{var e,t;return(t=(e=this.layer)==null?void 0:e.exportImageServiceParameters)==null?void 0:t.version},()=>{this.updatingHandles.addPromise(this.refreshDebounced())}),this.updatingHandles.add(()=>{var e;return(e=this.layer)==null?void 0:e.renderer},()=>{this.updatingHandles.addPromise(this.refreshDebounced())}),this.updatingHandles.add(()=>this.timeExtent,()=>this.updatingHandles.addPromise(this.refreshDebounced()))}_initializeMaximumDataResolution(){this.maximumDataResolution=this.layer.loaded?this.layer.serviceRasterInfo.pixelSize:null}getFetchOptions(){return{timeExtent:this.timeExtent}}async processResult(e,t,a){t.imageOrCanvasElement?e.image=t.imageOrCanvasElement:(e.image=document.createElement("canvas"),e.pixelData=t.pixelData,await this._redrawImage(e,a))}async _redrawImage(e,t){if(!(e.image instanceof HTMLCanvasElement)||m(e.pixelData))throw new Error;const a=e.image,r=a.getContext("2d"),n=await this.layer.applyRenderer(e.pixelData,{signal:t}),i=this.layer.applyFilter(n).pixelBlock;if(m(i))throw new Error;a.width=i.width,a.height=i.height;const s=r.createImageData(i.width,i.height);s.data.set(i.getAsRGBA()),r.putImageData(s,0,0)}};h=o([y("esri.views.3d.layers.ImageryLayerView3D")],h);const B=h;export{B as default};
