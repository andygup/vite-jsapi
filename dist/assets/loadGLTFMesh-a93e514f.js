import{L as F,aA as _,ay as B,aR as $,gZ as A,jD as C,by as P}from"./index-989909ce.js";import{e as E}from"./mat3f64-221ce671.js";import{r as z}from"./vec4f64-aa64c7e9.js";import{p as D,m as N,u as q,g as G}from"./meshFeatureSet-5d9a0c82.js";import{c as O,x as j,L as k,O as S,i as L,E as K,T as Q,u as U}from"./BufferView-d0acf3a4.js";import{t as V,f as Z,i as H,o as M}from"./vec32-c2909e9e.js";import{n as J,l as W,a as X,d as Y,r as ee,e as te,g as v,h as oe,i as ne,j as I,k as re,m as se,o as le}from"./DefaultMaterial_COLOR_GAMMA-302922de.js";import{e as ae}from"./types-1305598a.js";import{x as ie}from"./georeference-e9721e55.js";import{t as ue}from"./resourceUtils-1d112ccb.js";import{D as w}from"./enums-b14466b3.js";import"./imageUtils-c2d0d1ae.js";import"./earcut-27e6c8d6.js";import"./Indices-91be4389.js";import"./deduplicate-0f8126a2.js";import"./External-bfc27801.js";import"./infoFor3D-5881142c.js";import"./mat4f64-1413b4a7.js";import"./spatialReferenceEllipsoidUtils-dbdaf591.js";import"./FeatureSet-8fc9b923.js";import"./Field-52715ac0.js";import"./fieldType-72d6c895.js";import"./Version-f874365f.js";import"./quat-6714c1ef.js";import"./quatf64-3363c48e.js";import"./basicInterfaces-4ab7cc6a.js";function ce(e,o,t){const i=e.typedBuffer,r=e.typedBufferStride,f=o.typedBuffer,u=o.typedBufferStride,l=t?t.count:o.count;let s=(t&&t.dstIndex?t.dstIndex:0)*r,m=(t&&t.srcIndex?t.srcIndex:0)*u;for(let a=0;a<l;++a){for(let n=0;n<9;++n)i[s+n]=f[m+n];s+=r,m+=u}}Object.freeze(Object.defineProperty({__proto__:null,copy:ce},Symbol.toStringTag,{value:"Module"}));function fe(e,o,t){const i=e.typedBuffer,r=e.typedBufferStride,f=o.typedBuffer,u=o.typedBufferStride,l=t?t.count:o.count;let s=(t&&t.dstIndex?t.dstIndex:0)*r,m=(t&&t.srcIndex?t.srcIndex:0)*u;for(let a=0;a<l;++a){for(let n=0;n<16;++n)i[s+n]=f[m+n];s+=r,m+=u}}Object.freeze(Object.defineProperty({__proto__:null,copy:fe},Symbol.toStringTag,{value:"Module"}));function y(e,o){return new e(new ArrayBuffer(o*e.ElementCount*ae(e.ElementType)))}async function He(e,o,t){const i=new J(me(t)),r=(await W(i,o,t,!0)).model,f=r.lods.shift(),u=new Map,l=new Map;r.textures.forEach((g,h)=>u.set(h,xe(g))),r.materials.forEach((g,h)=>l.set(h,ge(g,u)));const s=de(f);for(const g of s.parts)$e(s,g,l);const{position:m,normal:a,tangent:n,color:c,texCoord0:p}=s.vertexAttributes,x={position:m.typedBuffer,normal:a!=null?a.typedBuffer:null,tangent:n!=null?n.typedBuffer:null,uv:p!=null?p.typedBuffer:null,color:c!=null?c.typedBuffer:null},b=ie(x,e,t);return{transform:b.transform,components:s.components,spatialReference:e.spatialReference,vertexAttributes:new D({position:b.vertexAttributes.position,normal:b.vertexAttributes.normal,tangent:b.vertexAttributes.tangent,color:x.color,uv:x.uv})}}function me(e){const o=e==null?void 0:e.resolveFile;return o?{busy:!1,request:async(t,i,r)=>{const f=o(t);return(await F(f,{responseType:i==="image"?"image":i==="binary"?"array-buffer":"json",signal:r!=null?r.signal:null})).data}}:null}function T(e,o){if(e==null)return"-";const t=e.typedBuffer;return`${_(o,t.buffer,()=>o.size)}/${t.byteOffset}/${t.byteLength}`}function pe(e){return e!=null?e.toString():"-"}function de(e){let o=0;const t={color:!1,tangent:!1,normal:!1,texCoord0:!1},i=new Map,r=new Map,f=[];for(const u of e.parts){const{attributes:{position:l,normal:s,color:m,tangent:a,texCoord0:n}}=u,c=`
      ${T(l,i)}/
      ${T(s,i)}/
      ${T(m,i)}/
      ${T(a,i)}/
      ${T(n,i)}/
      ${pe(u.transform)}
    `;let p=!1;const x=_(r,c,()=>(p=!0,{start:o,length:l.count}));p&&(o+=l.count),s&&(t.normal=!0),m&&(t.color=!0),a&&(t.tangent=!0),n&&(t.texCoord0=!0),f.push({gltf:u,writeVertices:p,region:x})}return{vertexAttributes:{position:y(Q,o),normal:t.normal?y(L,o):null,tangent:t.tangent?y(O,o):null,color:t.color?y(j,o):null,texCoord0:t.texCoord0?y(U,o):null},parts:f,components:[]}}function xe(e){return new N({data:(ue(e.data),e.data),wrap:be(e.parameters.wrap)})}function ge(e,o){const t=new B(he(e.color,e.opacity)),i=e.emissiveFactor?new B(ve(e.emissiveFactor)):null;return new q({color:t,colorTexture:$(e.textureColor,r=>o.get(r)),normalTexture:$(e.textureNormal,r=>o.get(r)),emissiveColor:i,emissiveTexture:$(e.textureEmissive,r=>o.get(r)),occlusionTexture:$(e.textureOcclusion,r=>o.get(r)),alphaMode:Te(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:$(e.textureMetallicRoughness,r=>o.get(r)),colorTextureTransform:e.colorTextureTransform,normalTextureTransform:e.normalTextureTransform,occlusionTextureTransform:e.occlusionTextureTransform,emissiveTextureTransform:e.emissiveTextureTransform,metallicRoughnessTextureTransform:e.metallicRoughnessTextureTransform})}function $e(e,o,t){o.writeVertices&&ye(e,o);const{indices:i,attributes:r,primitiveType:f,material:u}=o.gltf;let l=X(i||r.position.count,f);const s=o.region.start;if(s){const m=new Uint32Array(l);for(let a=0;a<l.length;a++)m[a]+=s;l=m}e.components.push(new G({faces:l,material:t.get(u),trustSourceNormals:!0}))}function ye(e,o){const{position:t,normal:i,tangent:r,color:f,texCoord0:u}=e.vertexAttributes,l=o.region.start,{attributes:s,transform:m}=o.gltf,a=s.position.count;if(V(t.slice(l,a),s.position,m),s.normal!=null&&i!=null){const n=A(E(),m),c=i.slice(l,a);Z(c,s.normal,n),C(n)&&H(c,c)}else i!=null&&Y(i,0,0,1,{dstIndex:l,count:a});if(s.tangent!=null&&r!=null){const n=A(E(),m),c=r.slice(l,a);ee(c,s.tangent,n),C(n)&&te(c,c)}else r!=null&&v(r,0,0,1,1,{dstIndex:l,count:a});if(s.texCoord0!=null&&u!=null?oe(u.slice(l,a),s.texCoord0):u!=null&&ne(u,0,0,{dstIndex:l,count:a}),s.color!=null&&f!=null){const n=s.color,c=f.slice(l,a);if(n.elementCount===4)n instanceof O?I(c,n,255):n instanceof j?re(c,n):n instanceof k&&I(c,n,1/256);else{v(c,255,255,255,255);const p=S.fromTypedArray(c.typedBuffer,c.typedBufferStride);n instanceof L?M(p,n,255):n instanceof S?se(p,n):n instanceof K&&M(p,n,1/256)}}else f!=null&&v(f.slice(l,a),255,255,255,255)}function Te(e){switch(e){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function be(e){return{horizontal:R(e.s),vertical:R(e.t)}}function R(e){switch(e){case w.CLAMP_TO_EDGE:return"clamp";case w.MIRRORED_REPEAT:return"mirror";case w.REPEAT:return"repeat"}}function d(e){return e**(1/le)*255}function he(e,o){return z(d(e[0]),d(e[1]),d(e[2]),o)}function ve(e){return P(d(e[0]),d(e[1]),d(e[2]))}export{He as loadGLTFMesh};
