import{aM as Ae,an as $,A as be,aZ as R,bf as N,eo as _e,J as Z,ae as l,af as u,bF as O,ag as Te,ai as xe,E as Ce,aB as U,bt as I,du as Ue,cG as We,ca as De,Z as je,r as X,cH as Be,ih as $e,b9 as qe,ii as ke,bb as Ge,ah as Ve,fV as Je,bW as He,bG as K,dX as Xe,f6 as Qe,cE as ze,a$ as Ze}from"./index-b4b3ae7d.js";import{a as Ke,M as Ye}from"./MultiOriginJSONSupport-a39561fd.js";import{g as ie}from"./scaleUtils-85736d03.js";import{B as et}from"./BlendLayer-0a837fcb.js";import{O as tt}from"./OperationalLayer-fae6e909.js";import{P as rt}from"./PortalLayer-e5a901dc.js";import{R as nt}from"./RefreshableLayer-1a6ca7d6.js";import{S as st}from"./ScaleRangeLayer-a596cf96.js";import{T as it}from"./TemporalLayer-d110d041.js";import{i as z}from"./crsUtils-6c7bea10.js";import{a as at,u as ot}from"./commonProperties-6e3ee32c.js";import{E as ae}from"./ExportWMSImageParameters-b7561ae1.js";import{a as lt}from"./imageBitmapUtils-ba2a9275.js";import"./jsonUtils-2ab9edfc.js";import"./parser-7991567d.js";import"./_commonjsHelpers-725317a4.js";import"./portalItemUtils-6119446c.js";import"./ElevationInfo-f0fe59c0.js";import"./lengthUtils-ae3367a7.js";var D;let ut=0,g=D=class extends Ae(Ke){constructor(t){super(t),this.dimensions=null,this.fullExtents=null,this.legendUrl=null,this.legendEnabled=!0,this.layer=null,this.maxScale=0,this.minScale=0,this.parent=null,this.popupEnabled=!1,this.queryable=!1,this.sublayers=null,this.spatialReferences=null,this.addHandles([$(()=>this.sublayers,"after-add",({item:e})=>{e.parent=this,e.layer=this.layer},R),$(()=>this.sublayers,"after-remove",({item:e})=>{e.layer=e.parent=null},R),be(()=>this.sublayers,(e,r)=>{if(r)for(const n of r)n.layer=n.parent=null;if(e)for(const n of e)n.parent=this,n.layer=this.layer},R)])}get description(){return this._get("description")}set description(t){this._set("description",t)}get fullExtent(){return this._get("fullExtent")}set fullExtent(t){this._set("fullExtent",t)}readExtent(t,e){return t=e.extent,t?N.fromJSON(t):null}get id(){const t=this._get("id");return t??ut++}set id(t){this._set("id",t)}readLegendUrl(t,e){return(e==null?void 0:e.legendUrl)??(e==null?void 0:e.legendURL)??null}get effectiveScaleRange(){const{minScale:t,maxScale:e}=this;return{minScale:t,maxScale:e}}get name(){return this._get("name")}set name(t){this._set("name",t)}castSublayers(t){return _e(Z.ofType(D),t)}get title(){return this._get("title")}set title(t){this._set("title",t)}get visible(){return this._get("visible")}set visible(t){this._setAndNotifyLayer("visible",t)}clone(){var e,r;const t=new D;return this.hasOwnProperty("description")&&(t.description=this.description),this.hasOwnProperty("fullExtent")&&(t.fullExtent=this.fullExtent.clone()),this.hasOwnProperty("fullExtents")&&(t.fullExtents=((e=this.fullExtents)==null?void 0:e.map(n=>n.clone()))??null),this.hasOwnProperty("legendUrl")&&(t.legendUrl=this.legendUrl),this.hasOwnProperty("legendEnabled")&&(t.legendEnabled=this.legendEnabled),this.hasOwnProperty("layer")&&(t.layer=this.layer),this.hasOwnProperty("name")&&(t.name=this.name),this.hasOwnProperty("parent")&&(t.parent=this.parent),this.hasOwnProperty("queryable")&&(t.queryable=this.queryable),this.hasOwnProperty("sublayers")&&(t.sublayers=this.sublayers&&this.sublayers.map(n=>n.clone())),this.hasOwnProperty("spatialReferences")&&(t.spatialReferences=(r=this.spatialReferences)==null?void 0:r.map(n=>n)),this.hasOwnProperty("visible")&&(t.visible=this.visible),this.hasOwnProperty("title")&&(t.title=this.title),t}_setAndNotifyLayer(t,e){const r=this.layer;this._get(t)!==e&&(this._set(t,e),r&&r.emit("wms-sublayer-update",{propertyName:t,id:this.id}))}};l([u()],g.prototype,"description",null);l([u({readOnly:!0})],g.prototype,"dimensions",void 0);l([u({value:null})],g.prototype,"fullExtent",null);l([O("fullExtent",["extent"])],g.prototype,"readExtent",null);l([u()],g.prototype,"fullExtents",void 0);l([u({type:Number,json:{write:{enabled:!1,overridePolicy:()=>({ignoreOrigin:!0,enabled:!0})}}})],g.prototype,"id",null);l([u({type:String,json:{origins:{"web-document":{read:{source:["legendUrl","legendURL"]},write:{target:"legendUrl",ignoreOrigin:!0}}},read:{source:"legendURL"},write:{ignoreOrigin:!0}}})],g.prototype,"legendUrl",void 0);l([O(["web-document"],"legendUrl")],g.prototype,"readLegendUrl",null);l([u({value:!0,type:Boolean,json:{read:{source:"showLegend"},write:{target:"showLegend"},origins:{"web-map":{read:!1,write:!1},"web-scene":{read:!1,write:!1}}}})],g.prototype,"legendEnabled",void 0);l([u()],g.prototype,"layer",void 0);l([u()],g.prototype,"maxScale",void 0);l([u()],g.prototype,"minScale",void 0);l([u({readOnly:!0})],g.prototype,"effectiveScaleRange",null);l([u({type:String,value:null,json:{read:{source:"name"},write:{ignoreOrigin:!0}}})],g.prototype,"name",null);l([u()],g.prototype,"parent",void 0);l([u({type:Boolean,json:{read:{source:"showPopup"},write:{ignoreOrigin:!0,target:"showPopup"}}})],g.prototype,"popupEnabled",void 0);l([u({type:Boolean,json:{write:{ignoreOrigin:!0}}})],g.prototype,"queryable",void 0);l([u()],g.prototype,"sublayers",void 0);l([Te("sublayers")],g.prototype,"castSublayers",null);l([u({type:[Number],json:{read:{source:"spatialReferences"}}})],g.prototype,"spatialReferences",void 0);l([u({type:String,value:null,json:{write:{ignoreOrigin:!0}}})],g.prototype,"title",null);l([u({type:Boolean,value:!0,json:{read:{source:"defaultVisibility"}}})],g.prototype,"visible",null);g=D=l([xe("esri.layers.support.WMSSublayer")],g);const Y=g,oe={84:4326,83:4269,27:4267};function ct(s){if(!s)return null;const t={idCounter:-1};typeof s=="string"&&(s=new DOMParser().parseFromString(s,"text/xml"));const e=s.documentElement;if(e.nodeName==="ServiceExceptionReport"){const J=Array.prototype.slice.call(e.childNodes).map(H=>H.textContent).join(`\r
`);throw new Ce("wmslayer:wms-capabilities-xml-is-not-valid","The server returned errors when the WMS capabilities were requested.",J)}const r=S("Capability",e),n=S("Service",e),o=r&&S("Request",r);if(!r||!n||!o)return null;const a=S("Layer",r);if(!a)return null;const c=e.nodeName==="WMS_Capabilities"||e.nodeName==="WMT_MS_Capabilities"?e.getAttribute("version"):"1.3.0",h=E("Title",n,"")||E("Name",n,""),i=E("AccessConstraints",n,""),y=/^none$/i.test(i)?"":i,m=E("Abstract",n,""),d=parseInt(E("MaxWidth",n,"5000"),10),f=parseInt(E("MaxHeight",n,"5000"),10),x=ue(o,"GetMap"),v=le(o,"GetMap"),b=C(a,c,t);if(!b)return null;let M=0,q;const k=Array.prototype.slice.call(r.childNodes),Ie=b.sublayers??[],G=w=>{w!=null&&Ie.push(w)};k.forEach(w=>{w.nodeName==="Layer"&&(M===0?q=w:(M===1&&b.name&&(b.name="",G(C(q,c,t))),G(C(w,c,t))),M++)});let F=b.sublayers,V=b.extent;const Oe=b.fullExtents??[];if(F||(F=[]),F.length===0&&F.push(b),!V){const w=new N(F[0].extent);b.extent=w.toJSON(),V=b.extent}const Fe=b.spatialReferences.length>0?b.spatialReferences:Se(b),ee=le(o,"GetFeatureInfo"),Pe=ee?ue(o,"GetFeatureInfo"):null,te=we(F),Le=b.minScale||0,Re=b.maxScale||0,re=b.dimensions??[],Ne=te.reduce((w,A)=>w.concat(A.dimensions??[]),[]),ne=re.concat(Ne).filter(ve);let se=null;if(ne.length){const A=ne.map(Me=>{const{extent:_}=Me;return mt(_)?_.map(W=>W.getTime()):_==null?void 0:_.map(W=>[W.min.getTime(),W.max.getTime()])}).flat(2).filter(U),J=Math.min(...A),H=Math.max(...A);se={startTimeField:null,endTimeField:null,trackIdField:void 0,timeExtent:[J,H]}}return{copyright:y,description:m,dimensions:re,extent:V,fullExtents:Oe,featureInfoFormats:Pe,featureInfoUrl:ee,mapUrl:v,maxWidth:d,maxHeight:f,maxScale:Re,minScale:Le,layers:te,spatialReferences:Fe,supportedImageFormatTypes:x,timeInfo:se,title:h,version:c}}function pt(s){const t=s.filter(e=>e.popupEnabled&&e.name&&e.queryable);return t.length?t.map(({name:e})=>e).join():null}function Se(s){if(s.spatialReferences.length>0)return s.spatialReferences;if(s.sublayers)for(const t of s.sublayers){const e=Se(t);if(e.length>0)return e}return[]}function we(s){var e;let t=[];for(const r of s)t.push(r),(e=r.sublayers)!=null&&e.length&&(t=t.concat(we(r.sublayers)),delete r.sublayers);return t}function j(s,t,e){return t.getAttribute(s)??e}function ft(s,t,e,r){const n=S(s,e);return n?j(t,n,r):r}function S(s,t){for(let e=0;e<t.childNodes.length;e++){const r=t.childNodes[e];if(Ee(r)&&r.nodeName===s)return r}return null}function B(s,t){if(t==null)return[];const e=[];for(let r=0;r<t.childNodes.length;r++){const n=t.childNodes[r];Ee(n)&&n.nodeName===s&&e.push(n)}return e}function E(s,t,e){var r;return((r=S(s,t))==null?void 0:r.textContent)??e}function T(s,t,e){if(!s)return null;const r=parseFloat(s.getAttribute("minx")),n=parseFloat(s.getAttribute("miny")),o=parseFloat(s.getAttribute("maxx")),a=parseFloat(s.getAttribute("maxy"));let c,h,i,y;e?(c=isNaN(n)?-Number.MAX_VALUE:n,h=isNaN(r)?-Number.MAX_VALUE:r,i=isNaN(a)?Number.MAX_VALUE:a,y=isNaN(o)?Number.MAX_VALUE:o):(c=isNaN(r)?-Number.MAX_VALUE:r,h=isNaN(n)?-Number.MAX_VALUE:n,i=isNaN(o)?Number.MAX_VALUE:o,y=isNaN(a)?Number.MAX_VALUE:a);const m=new I({wkid:t});return new N({xmin:c,ymin:h,xmax:i,ymax:y,spatialReference:m})}function le(s,t){const e=S(t,s);if(e){const r=S("DCPType",e);if(r){const n=S("HTTP",r);if(n){const o=S("Get",n);if(o){let a=ft("OnlineResource","xlink:href",o,null);if(a)return a.indexOf("&")===a.length-1&&(a=a.substring(0,a.length-1)),yt(a,["service","request"])}}}}return null}function ue(s,t){const e=B("Operation",s);if(!e.length){const n=S(t,s);return B("Format",n).map(({textContent:a})=>a).filter(U)}const r=[];for(const n of e)if(n.getAttribute("name")===t){const o=B("Format",n);for(const{textContent:a}of o)a!=null&&r.push(a)}return r}function ce(s,t,e){const r=S(t,s);if(!r)return e;const{textContent:n}=r;if(n==null||n==="")return e;const o=Number(n);return isNaN(o)?e:o}function C(s,t,e){if(!s)return null;const r={id:e.idCounter++,fullExtents:[],parentLayerId:null,queryable:s.getAttribute("queryable")==="1",spatialReferences:[],sublayers:null},n=S("LatLonBoundingBox",s),o=S("EX_GeographicBoundingBox",s);let a=null;n&&(a=T(n,4326)),o&&(a=new N(0,0,0,0,new I({wkid:4326})),a.xmin=parseFloat(E("westBoundLongitude",o,"0")),a.ymin=parseFloat(E("southBoundLatitude",o,"0")),a.xmax=parseFloat(E("eastBoundLongitude",o,"0")),a.ymax=parseFloat(E("northBoundLatitude",o,"0"))),!n&&!o&&(a=new N(-180,-90,180,90,new I({wkid:4326}))),r.minScale=ce(s,"MaxScaleDenominator",0),r.maxScale=ce(s,"MinScaleDenominator",0);const c=["1.0.0","1.1.0","1.1.1"].includes(t)?"SRS":"CRS";return Array.prototype.slice.call(s.childNodes).forEach(i=>{var y;if(i.nodeName==="Name")r.name=i.textContent||"";else if(i.nodeName==="Title")r.title=i.textContent||"";else if(i.nodeName==="Abstract")r.description=i.textContent||"";else if(i.nodeName==="BoundingBox"){const m=i.getAttribute(c);if(m&&m.indexOf("EPSG:")===0){const f=parseInt(m.substring(5),10);f!==0&&!isNaN(f)&&!a&&(a=t==="1.3.0"?T(i,f,z(f)):T(i,f))}const d=m&&m.indexOf(":");if(d&&d>-1){let f=parseInt(m.substring(d+1,m.length),10);f!==0&&!isNaN(f)&&(f=oe[f]??f);const x=t==="1.3.0"?T(i,f,z(f)):T(i,f);x&&r.fullExtents&&r.fullExtents.push(x)}}else if(i.nodeName===c)(((y=i.textContent)==null?void 0:y.split(" "))??[]).forEach(d=>{const f=d.includes(":")?parseInt(d.split(":")[1],10):parseInt(d,10);if(f!==0&&!isNaN(f)){const x=oe[f]??f;r.spatialReferences.includes(x)||r.spatialReferences.push(x)}});else if(i.nodeName==="Style"&&!r.legendURL){const m=S("LegendURL",i);if(m){const d=S("OnlineResource",m);d&&(r.legendURL=d.getAttribute("xlink:href"))}}else if(i.nodeName==="Layer"){const m=C(i,t,e);m&&(m.parentLayerId=r.id,r.sublayers||(r.sublayers=[]),r.sublayers.push(m))}}),r.extent=a==null?void 0:a.toJSON(),r.dimensions=B("Dimension",s).filter(i=>i.getAttribute("name")&&i.getAttribute("units")&&i.textContent).map(i=>{const y=i.getAttribute("name"),m=i.getAttribute("units"),d=i.textContent,f=i.getAttribute("unitSymbol")??void 0,x=i.getAttribute("default")??void 0,v=j("default",i,"0")!=="0",b=j("nearestValue",i,"0")!=="0",M=j("current",i,"0")!=="0";return ve({name:y,units:m})?{name:"time",units:"ISO8601",extent:me(d),default:me(x),multipleValues:v,nearestValue:b,current:M}:dt({name:y,units:m})?{name:"elevation",units:m,extent:pe(d),unitSymbol:f,default:pe(x),multipleValues:v,nearestValue:b}:{name:y,units:m,extent:fe(d),unitSymbol:f,default:fe(x),multipleValues:v,nearestValue:b}}),r}function mt(s){return Array.isArray(s)&&s.length>0&&s[0]instanceof Date}function Ee(s){return s.nodeType===Node.ELEMENT_NODE}function dt(s){return/^elevation$/i.test(s.name)&&/^(epsg|crs):\d+$/i.test(s.units)}function ve(s){return/^time$/i.test(s.name)&&/^iso8601$/i.test(s.units)}function yt(s,t){const e=[],r=Ue(s);for(const n in r.query)r.query.hasOwnProperty(n)&&(t.includes(n.toLowerCase())||e.push(n+"="+r.query[n]));return r.path+(e.length?"?"+e.join("&"):"")}function pe(s){if(!s)return;const t=s.includes("/"),e=s.split(",");return t?e.map(r=>{const n=r.split("/");if(n.length<2)return null;const o=parseFloat(n[0]),a=parseFloat(n[1]),c=n.length>=3&&n[2]!=="0"?parseFloat(n[2]):void 0;return{min:o,max:a,resolution:c}}).filter(U):e.map(r=>parseFloat(r))}function fe(s){if(!s)return;const t=s.includes("/"),e=s.split(",");return t?e.map(r=>{const n=r.split("/");if(n.length<2)return null;const o=n[0],a=n[1],c=n.length>=3&&n[2]!=="0"?n[2]:void 0;return{min:o,max:a,resolution:c}}).filter(U):e}function me(s){if(!s)return;const t=s.includes("/"),e=s.split(",");return t?e.map(r=>{const n=r.split("/");if(n.length<2)return null;const o=new Date(n[0]),a=new Date(n[1]),c=n.length>=3&&n[2]!=="0"?ht(n[2]):void 0;return{min:o,max:a,resolution:c}}).filter(U):e.map(r=>new Date(r))}function ht(s){const t=/(?:p(\d+y|\d+(?:.|,)\d+y)?(\d+m|\d+(?:.|,)\d+m)?(\d+d|\d+(?:.|,)\d+d)?)?(?:t(\d+h|\d+(?:.|,)\d+h)?(\d+m|\d+(?:.|,)\d+m)?(\d+s|\d+(?:.|,)\d+s)?)?/i,e=s.match(t);if(!e)return null;const r=P(e[1]),n=P(e[2]),o=P(e[3]),a=P(e[4]),c=P(e[5]),h=P(e[6]);return{years:r,months:n,days:o,hours:a,minutes:c,seconds:h}}function P(s){if(!s)return 0;const t=/(?:\d+(?:.|,)\d+|\d+)/,e=s.match(t);if(!e)return 0;const r=e[0].replace(",",".");return Number(r)}function L(s){return s.toISOString().replace(/\.[0-9]{3}/,"")}const de=new Set([102100,3857,102113,900913]),gt=new Set([3395,54004]);function bt(s,t){let e=s.wkid;return t==null||((e==null||!t.includes(e))&&s.latestWkid&&(e=s.latestWkid),e==null||!de.has(e))?e:t.find(r=>de.has(r))||t.find(r=>gt.has(r))||102100}const Q=new We({bmp:"image/bmp",gif:"image/gif",jpg:"image/jpeg",png:"image/png",svg:"image/svg+xml"},{ignoreUnknown:!1});function ye(s){return s==="text/html"}function he(s){return s==="text/plain"}let p=class extends et(it(nt(st(tt(rt(Ye(Ze))))))){constructor(...t){super(...t),this.allSublayers=new De({getCollections:()=>[this.sublayers],getChildrenFunction(e){return e.sublayers}}),this.customParameters=null,this.customLayerParameters=null,this.copyright=null,this.description=null,this.dimensions=null,this.fullExtent=null,this.fullExtents=null,this.featureInfoFormats=null,this.featureInfoUrl=null,this.fetchFeatureInfoFunction=null,this.imageFormat=null,this.imageMaxHeight=2048,this.imageMaxWidth=2048,this.imageTransparency=!0,this.legendEnabled=!0,this.mapUrl=null,this.isReference=null,this.operationalLayerType="WMS",this.spatialReference=null,this.spatialReferences=null,this.sublayers=null,this.type="wms",this.url=null,this.version=null,this.addHandles([$(()=>this.sublayers,"after-add",({item:e})=>{e.parent=e.layer=this},R),$(()=>this.sublayers,"after-remove",({item:e})=>{e.layer=e.parent=null},R),be(()=>this.sublayers,(e,r)=>{if(r)for(const n of r)n.layer=n.parent=null;if(e)for(const n of e)n.parent=n.layer=this},R)])}normalizeCtorArgs(t,e){return typeof t=="string"?{url:t,...e}:t}destroy(){this.allSublayers.destroy()}load(t){const e=t!=null?t.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WMS"]},t).catch(je).then(()=>this._fetchService(e))),Promise.resolve(this)}readFullExtentFromItemOrMap(t,e){const r=e.extent;return r?new N({xmin:r[0][0],ymin:r[0][1],xmax:r[1][0],ymax:r[1][1]}):null}writeFullExtent(t,e){e.extent=[[t.xmin,t.ymin],[t.xmax,t.ymax]]}get featureInfoFormat(){return this.featureInfoFormats==null?null:this.featureInfoFormats.find(ye)??this.featureInfoFormats.find(he)??null}set featureInfoFormat(t){if(t!=null){(ye(t)||he(t))&&this._override("featureInfoFormat",t);return}this.revert("featureInfoFormat","service"),this._clearOverride("featureInfoFormat")}readImageFormat(t,e){const r=e.supportedImageFormatTypes;return r&&r.includes("image/png")?"image/png":r&&r[0]}readSpatialReferenceFromItemOrDocument(t,e){return new I(e.spatialReferences[0])}writeSpatialReferences(t,e){var n;const r=(n=this.spatialReference)==null?void 0:n.wkid;t&&r?(e.spatialReferences=t.filter(o=>o!==r),e.spatialReferences.unshift(r)):e.spatialReferences=t}readSublayersFromItemOrMap(t,e,r){return ge(e.layers,r,e.visibleLayers)}readSublayers(t,e,r){return ge(e.layers,r)}writeSublayers(t,e,r,n){var c,h;e.layers=[];const o=new Map,a=t.flatten(({sublayers:i})=>i??[]);for(const i of a)if(typeof((c=i.parent)==null?void 0:c.id)=="number"){const y=o.get(i.parent.id);y!=null?y.push(i.id):o.set(i.parent.id,[i.id])}for(const i of a){const y={sublayer:i,...n},m=i.write({parentLayerId:typeof((h=i.parent)==null?void 0:h.id)=="number"?i.parent.id:-1},y);if(o.has(i.id)&&(m.sublayerIds=o.get(i.id)),!i.sublayers&&i.name){const d=i.write({},y);delete d.id,e.layers.push(d)}}e.visibleLayers=a.filter(({visible:i,sublayers:y})=>i&&!y).map(({name:i})=>i).toArray()}createExportImageParameters(t,e,r,n){const o=(n==null?void 0:n.pixelRatio)??1,a=ie({extent:t,width:e})*o,c=new ae({layer:this,scale:a}),{xmin:h,ymin:i,xmax:y,ymax:m,spatialReference:d}=t,f=bt(d,this.spatialReferences),x=this.version==="1.3.0"&&z(f)?`${i},${h},${m},${y}`:`${h},${i},${y},${m}`,v=c.toJSON(),b=this.version==="1.3.0"?"crs":"srs";return{bbox:x,[b]:f==null||isNaN(f)?void 0:"EPSG:"+f,...v}}async fetchImage(t,e,r,n){var m,d;const o=this.mapUrl,a=this.createExportImageParameters(t,e,r,n);if(!a.layers){const f=document.createElement("canvas");return f.width=e,f.height=r,f}const c=(m=n==null?void 0:n.timeExtent)==null?void 0:m.start,h=(d=n==null?void 0:n.timeExtent)==null?void 0:d.end,i=c!=null&&h!=null?c.getTime()===h.getTime()?L(c):`${L(c)}/${L(h)}`:void 0,y={responseType:"image",query:this._mixCustomParameters({width:e,height:r,...a,time:i,...this.refreshParameters}),signal:n==null?void 0:n.signal};return X(o??"",y).then(f=>f.data)}async fetchImageBitmap(t,e,r,n){var d,f;const o=this.mapUrl??"",a=this.createExportImageParameters(t,e,r,n);if(!a.layers){const x=document.createElement("canvas");return x.width=e,x.height=r,x}const c=(d=n==null?void 0:n.timeExtent)==null?void 0:d.start,h=(f=n==null?void 0:n.timeExtent)==null?void 0:f.end,i=c!=null&&h!=null?c.getTime()===h.getTime()?L(c):`${L(c)}/${L(h)}`:void 0,y={responseType:"blob",query:this._mixCustomParameters({width:e,height:r,...a,time:i,...this.refreshParameters}),signal:n==null?void 0:n.signal},{data:m}=await X(o,y);return lt(m,o,n==null?void 0:n.signal)}fetchFeatureInfo(t,e,r,n,o){const a=ie({extent:t,width:e}),c=new ae({layer:this,scale:a}),h=pt(c.visibleSublayers);if(this.featureInfoUrl==null||h==null)return Promise.resolve([]);if(this.fetchFeatureInfoFunction==null&&this.featureInfoFormat==null)return Promise.resolve([]);const i=this.version==="1.3.0"?{I:n,J:o}:{x:n,y:o},y={query_layers:h,request:"GetFeatureInfo",info_format:this.featureInfoFormat,feature_count:25,width:e,height:r,...i},m={...this.createExportImageParameters(t,e,r),...y},d=this._mixCustomParameters(m);return this.fetchFeatureInfoFunction!=null?this.fetchFeatureInfoFunction(d):this._defaultFetchFeatureInfoFunction(Be(this.featureInfoUrl,d))}findSublayerById(t){return this.allSublayers.find(e=>e.id===t)}findSublayerByName(t){return this.allSublayers.find(e=>e.name===t)}serviceSupportsSpatialReference(t){return $e(this.url)||this.spatialReferences!=null&&this.spatialReferences.some(e=>{const r=e===900913?I.WebMercator:new I({wkid:e});return qe(r,t)})}_defaultFetchFeatureInfoFunction(t){const e=document.createElement("iframe");e.src=ke(t),e.style.border="none",e.style.margin="0",e.style.width="100%",e.setAttribute("sandbox","");const r=new Ge({title:this.title,content:e}),n=new Ve({sourceLayer:this,popupTemplate:r});return Promise.resolve([n])}async _fetchService(t){if(!this.resourceInfo){const{path:e,query:r}=this.parsedUrl??{};r!=null&&r.service&&(r.SERVICE=r.service,delete r.service),r!=null&&r.request&&(r.REQUEST=r.request,delete r.request);const{data:n}=await X(e??"",{query:{SERVICE:"WMS",REQUEST:"GetCapabilities",...r,...this.customParameters},responseType:"xml",signal:t});this.resourceInfo=ct(n)}if(this.parsedUrl){const e=new Je(this.parsedUrl.path),{httpsDomains:r}=He.request;e.scheme==="https"&&(!e.port||e.port==="443")&&e.host&&!r.includes(e.host)&&r.push(e.host)}this.read(this.resourceInfo,{origin:"service"})}_mixCustomParameters(t){if(!this.customLayerParameters&&!this.customParameters)return t;const e={...this.customParameters,...this.customLayerParameters};for(const r in e)t[r.toLowerCase()]=e[r];return t}};l([u({readOnly:!0})],p.prototype,"allSublayers",void 0);l([u({json:{type:Object,write:!0}})],p.prototype,"customParameters",void 0);l([u({json:{type:Object,write:!0}})],p.prototype,"customLayerParameters",void 0);l([u({type:String,json:{write:!0}})],p.prototype,"copyright",void 0);l([u()],p.prototype,"description",void 0);l([u({readOnly:!0})],p.prototype,"dimensions",void 0);l([u({json:{type:[[Number]],read:{source:"extent"},write:{target:"extent"},origins:{"web-document":{write:{ignoreOrigin:!0}},"portal-item":{write:{ignoreOrigin:!0}}}}})],p.prototype,"fullExtent",void 0);l([O(["web-document","portal-item"],"fullExtent",["extent"])],p.prototype,"readFullExtentFromItemOrMap",null);l([K(["web-document","portal-item"],"fullExtent",{extent:{type:[[Number]]}})],p.prototype,"writeFullExtent",null);l([u()],p.prototype,"fullExtents",void 0);l([u({type:String,json:{write:{ignoreOrigin:!0}}})],p.prototype,"featureInfoFormat",null);l([u({type:[String],readOnly:!0})],p.prototype,"featureInfoFormats",void 0);l([u({type:String,json:{write:{ignoreOrigin:!0}}})],p.prototype,"featureInfoUrl",void 0);l([u()],p.prototype,"fetchFeatureInfoFunction",void 0);l([u({type:String,json:{origins:{"web-document":{default:"image/png",type:Q.jsonValues,read:{reader:Q.read,source:"format"},write:{writer:Q.write,target:"format"}}}}})],p.prototype,"imageFormat",void 0);l([O("imageFormat",["supportedImageFormatTypes"])],p.prototype,"readImageFormat",null);l([u({type:Number,json:{read:{source:"maxHeight"},write:{target:"maxHeight"}}})],p.prototype,"imageMaxHeight",void 0);l([u({type:Number,json:{read:{source:"maxWidth"},write:{target:"maxWidth"}}})],p.prototype,"imageMaxWidth",void 0);l([u()],p.prototype,"imageTransparency",void 0);l([u(at)],p.prototype,"legendEnabled",void 0);l([u({type:["show","hide","hide-children"]})],p.prototype,"listMode",void 0);l([u({type:String,json:{write:{ignoreOrigin:!0}}})],p.prototype,"mapUrl",void 0);l([u({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],p.prototype,"isReference",void 0);l([u({type:["WMS"]})],p.prototype,"operationalLayerType",void 0);l([u()],p.prototype,"resourceInfo",void 0);l([u({type:I,json:{origins:{service:{read:{source:"extent.spatialReference"}}},write:!1}})],p.prototype,"spatialReference",void 0);l([O(["web-document","portal-item"],"spatialReference",["spatialReferences"])],p.prototype,"readSpatialReferenceFromItemOrDocument",null);l([u({type:[Xe],json:{read:!1,origins:{service:{read:!0},"web-document":{read:!1,write:{ignoreOrigin:!0}},"portal-item":{read:!1,write:{ignoreOrigin:!0}}}}})],p.prototype,"spatialReferences",void 0);l([K(["web-document","portal-item"],"spatialReferences")],p.prototype,"writeSpatialReferences",null);l([u({type:Z.ofType(Y),json:{write:{target:"layers",overridePolicy(s,t,e){if(xt(this.allSublayers,e))return{ignoreOrigin:!0}}}}})],p.prototype,"sublayers",void 0);l([O(["web-document","portal-item"],"sublayers",["layers","visibleLayers"])],p.prototype,"readSublayersFromItemOrMap",null);l([O("service","sublayers",["layers"])],p.prototype,"readSublayers",null);l([K("sublayers",{layers:{type:[Y]},visibleLayers:{type:[String]}})],p.prototype,"writeSublayers",null);l([u({json:{read:!1},readOnly:!0,value:"wms"})],p.prototype,"type",void 0);l([u(ot)],p.prototype,"url",void 0);l([u({type:String,json:{write:{ignoreOrigin:!0}}})],p.prototype,"version",void 0);p=l([xe("esri.layers.WMSLayer")],p);function xt(s,t){return s.some(e=>{for(const r in e)if(Qe(e,r,null,t))return!0;return!1})}function ge(s,t,e){s=s??[];const r=new Map;s.every(o=>o.id==null)&&(s=ze(s),s.forEach((o,a)=>o.id=a));for(const o of s){const a=new Y;a.read(o,t),e&&!e.includes(a.name)&&(a.visible=!1),r.set(a.id,a)}const n=[];for(const o of s){const a=o.id!=null?r.get(o.id):null;if(a)if(o.parentLayerId!=null&&o.parentLayerId>=0){const c=r.get(o.parentLayerId);if(!c)continue;c.sublayers||(c.sublayers=new Z),c.sublayers.push(a)}else n.push(a)}return n}const $t=p;export{$t as default};
