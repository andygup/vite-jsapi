import{r as w,hi as W,E as p,hj as I,fU as x,hk as P,hl as E,bt as _,bf as U,b9 as k,g5 as T,U as L,V as v,I as M,eC as j}from"./index-0ea7d266.js";import{g as $}from"./geojson-c6fe8811.js";import{v as S,i as F}from"./xmlUtils-2b925ee3.js";import{F as m}from"./Field-da71a869.js";function V(n){return X(n)??Y(n)}function Y(n){const t=new Date(n).getTime();return Number.isNaN(t)?null:t}function X(n){const t=H.exec(n);if(!(t!=null&&t.groups))return null;const e=t.groups,r=+e.year,o=+e.month-1,a=+e.day,s=+(e.hours??"0"),i=+(e.minutes??"0"),c=+(e.seconds??"0");if(s>23||i>59||c>59)return null;const u=e.ms??"0",l=u?+u.padEnd(3,"0").substring(0,3):0;let f;if(e.isUTC)f=Date.UTC(r,o,a,s,i,c,l);else if(e.offsetSign){const y=+e.offsetHours,R=+e.offsetMinutes;f=6e4*(e.offsetSign==="+"?-1:1)*(y*60+R)+Date.UTC(r,o,a,s,i,c,l)}else f=new Date(r,o,a,s,i,c,l).getTime();return Number.isNaN(f)?null:f}const H=/^(?:(?<year>-?\d{4,})-(?<month>\d{2})-(?<day>\d{2}))(?:T(?<hours>\d{2}):(?<minutes>\d{2}):(?<seconds>\d{2})(?:\.(?<ms>\d+))?)?(?:(?<isUTC>Z)|(?:(?<offsetSign>\+|-)(?<offsetHours>\d{2}):(?<offsetMinutes>\d{2})))?$/,b="xlink:href",d="2.0.0",O="__esri_wfs_id__",K="wfs-layer:getWFSLayerTypeInfo-error",q="wfs-layer:empty-service",C="wfs-layer:feature-type-not-found",z="wfs-layer:geojson-not-supported",J="wfs-layer:kvp-encoding-not-supported",B="wfs-layer:malformed-json",N="wfs-layer:unknown-geometry-type",Q="wfs-layer:unknown-field-type",Z="wfs-layer:unsupported-spatial-reference",ee="wfs-layer:unsupported-wfs-version";async function be(n,t){const e=await w(n,{responseType:"text",query:{SERVICE:"WFS",REQUEST:"GetCapabilities",VERSION:d,...t==null?void 0:t.customParameters},signal:t==null?void 0:t.signal}),r=te(e.data);return ae(n,r),r}function te(n){const t=D(n);Te(t),A(t);const e=t.firstElementChild,r=W(se(e));return{operations:ne(e),get featureTypes(){return Array.from(r())},readFeatureTypes:r}}const re=new Set(["json","application/json","geojson","application/json; subtype=geojson"]);function ne(n){let t=!1;const e={GetCapabilities:{url:""},DescribeFeatureType:{url:""},GetFeature:{url:"",outputFormat:null,supportsPagination:!1}};if(S(n,{OperationsMetadata:{Operation:r=>{switch(r.getAttribute("name")){case"GetCapabilities":return{DCP:{HTTP:{Get:a=>{e.GetCapabilities.url=a.getAttribute(b)}}}};case"DescribeFeatureType":return{DCP:{HTTP:{Get:a=>{e.DescribeFeatureType.url=a.getAttribute(b)}}}};case"GetFeature":return{DCP:{HTTP:{Get:a=>{e.GetFeature.url=a.getAttribute(b)}}},Parameter:a=>{if(a.getAttribute("name")==="outputFormat")return{AllowedValues:{Value:s=>{const i=s.textContent;i&&re.has(i.toLowerCase())&&(e.GetFeature.outputFormat=i)}}}}}}},Constraint:r=>{switch(r.getAttribute("name")){case"KVPEncoding":return{DefaultValue:a=>{t=a.textContent.toLowerCase()==="true"}};case"ImplementsResultPaging":return{DefaultValue:a=>{e.GetFeature.supportsPagination=a.textContent.toLowerCase()==="true"}}}}}}),!t)throw new p(J,"WFS service doesn't support key/value pair (KVP) encoding");if(e.GetFeature.outputFormat==null)throw new p(z,"WFS service doesn't support GeoJSON output format");return e}function ae(n,t){I(n)&&(x(n,t.operations.DescribeFeatureType.url,!0)&&(t.operations.DescribeFeatureType.url=P(t.operations.DescribeFeatureType.url)),x(n,t.operations.GetFeature.url,!0)&&(t.operations.GetFeature.url=P(t.operations.GetFeature.url)))}function se(n){return F(n,{FeatureTypeList:{FeatureType:t=>{const e={typeName:"undefined:undefined",name:"",title:"",description:"",extent:null,namespacePrefix:"",namespaceUri:"",supportedSpatialReferences:[]},r=new Set([4326]),o=a=>{var i,c,u;const s=parseInt(((u=(c=(i=a.textContent)==null?void 0:i.match(/(?<wkid>\d+$)/i))==null?void 0:c.groups)==null?void 0:u.wkid)??"",10);Number.isNaN(s)||r.add(s)};return S(t,{Name:a=>{const{name:s,prefix:i}=g(a.textContent);e.typeName=`${i}:${s}`,e.name=s,e.namespacePrefix=i,e.namespaceUri=a.lookupNamespaceURI(i)},Abstract:a=>{e.description=a.textContent},Title:a=>{e.title=a.textContent},WGS84BoundingBox:a=>{e.extent=oe(a)},DefaultSRS:o,DefaultCRS:o,OtherSRS:o,OtherCRS:o}),e.title||(e.title=e.name),e.supportedSpatialReferences.push(...r),e}}})}function oe(n){let t,e,r,o;for(const a of n.children)switch(a.localName){case"LowerCorner":[t,e]=a.textContent.split(" ").map(s=>Number.parseFloat(s));break;case"UpperCorner":[r,o]=a.textContent.split(" ").map(s=>Number.parseFloat(s));break}return{xmin:t,ymin:e,xmax:r,ymax:o,spatialReference:T}}function ie(n,t,e){return E(n,r=>e?r.name===t&&r.namespaceUri===e:r.typeName===t||r.name===t)}async function Ee(n,t,e,r={}){const{featureType:o,extent:a}=await ue(n,t,e,r),{fields:s,geometryType:i,swapXY:c,objectIdField:u,geometryField:l}=await ce(n,o.typeName,r);return{url:n.operations.GetCapabilities.url,name:o.name,namespaceUri:o.namespaceUri,fields:s,geometryField:l,geometryType:i,objectIdField:u,spatialReference:r.spatialReference??_.WGS84,extent:a,swapXY:c,wfsCapabilities:n,customParameters:r.customParameters}}async function ue(n,t,e,r={}){const{spatialReference:o=_.WGS84}=r,a=n.readFeatureTypes(),s=t?ie(a,t,e):a.next().value;if(s==null)throw t?new p(C,`The type '${t}' could not be found in the service`):new p(q,"The service is empty");let i=new U({...s.extent,spatialReference:o});if(!k(o,T))try{await L(T,o,void 0,r),i=v(i,T)}catch{throw new p(Z,"Projection not supported")}return{extent:i,spatialReference:o,featureType:s}}async function ce(n,t,e={}){var u,l,f;const[r,o]=await M([fe(n.operations.DescribeFeatureType.url,t,e),pe(n,t,e)]);if(r.error||o.error)throw new p(K,`An error occurred while getting info about the feature type '${t}'`,{error:r.error||o.error});const{fields:a,errors:s}=r.value??{},i=((u=r.value)==null?void 0:u.geometryType)||((l=o.value)==null?void 0:l.geometryType),c=((f=o.value)==null?void 0:f.swapXY)??!1;if(i==null)throw new p(N,`The geometry type could not be determined for type '${t}`,{typeName:t,geometryType:i,fields:a,errors:s});return{...le(a??[]),geometryType:i,swapXY:c}}function le(n){const t=n.find(r=>r.type==="geometry");let e=n.find(r=>r.type==="oid");return n=n.filter(r=>r.type!=="geometry"),e||(e=new m({name:O,type:"oid",alias:O}),n.unshift(e)),{geometryField:(t==null?void 0:t.name)??null,objectIdField:e.name,fields:n}}async function pe(n,t,e={}){var c;let r,o=!1;const[a,s]=await Promise.all([ge(n.operations.GetFeature.url,t,n.operations.GetFeature.outputFormat,{...e,count:1}),w(n.operations.GetFeature.url,{responseType:"text",query:G(t,void 0,{...e,count:1}),signal:e==null?void 0:e.signal})]),i=a.type==="FeatureCollection"&&((c=a.features[0])==null?void 0:c.geometry);if(i){r=j.fromJSON($(i.type));let u;switch(i.type){case"Point":u=i.coordinates;break;case"LineString":case"MultiPoint":u=i.coordinates[0];break;case"MultiLineString":case"Polygon":u=i.coordinates[0][0];break;case"MultiPolygon":u=i.coordinates[0][0][0];break}const l=/<[^>]*pos[^>]*> *(-?\d+(?:\.\d+)?) (-?\d+(?:\.\d+)?)/.exec(s.data);if(l){const f=u[0].toFixed(3),y=u[1].toFixed(3),R=parseFloat(l[1]).toFixed(3),h=parseFloat(l[2]).toFixed(3);f===h&&y===R&&(o=!0)}}return{geometryType:r,swapXY:o}}async function fe(n,t,e){const r=await w(n,{responseType:"text",query:{SERVICE:"WFS",REQUEST:"DescribeFeatureType",VERSION:d,TYPENAME:t,...e==null?void 0:e.customParameters},signal:e==null?void 0:e.signal});return me(t,r.data)}function me(n,t){const{name:e}=g(n),r=D(t);A(r);const o=E(F(r.firstElementChild,{element:a=>({name:a.getAttribute("name"),typeName:g(a.getAttribute("type")).name})}),({name:a})=>a===e);if(o!=null){const a=E(F(r.firstElementChild,{complexType:s=>s}),s=>s.getAttribute("name")===o.typeName);if(a!=null)return de(a)}throw new p(C,`Type '${n}' not found in document`,{document:new XMLSerializer().serializeToString(r)})}const ye=new Set(["objectid","fid"]);function de(n){const t=[],e=[];let r;const o=F(n,{complexContent:{extension:{sequence:{element:a=>a}}}});for(const a of o){const s=a.getAttribute("name");if(!s)continue;let i,c;if(a.hasAttribute("type")?i=g(a.getAttribute("type")).name:S(a,{simpleType:{restriction:f=>(i=g(f.getAttribute("base")).name,{maxLength:y=>{c=+y.getAttribute("value")}})}}),!i)continue;const u=a.getAttribute("nillable")==="true";let l=!1;switch(i.toLowerCase()){case"integer":case"nonpositiveinteger":case"negativeinteger":case"long":case"int":case"short":case"byte":case"nonnegativeinteger":case"unsignedlong":case"unsignedint":case"unsignedshort":case"unsignedbyte":case"positiveinteger":e.push(new m({name:s,alias:s,type:"integer",nullable:u}));break;case"float":case"double":case"decimal":e.push(new m({name:s,alias:s,type:"double",nullable:u}));break;case"boolean":case"string":case"gyearmonth":case"gyear":case"gmonthday":case"gday":case"gmonth":case"anyuri":case"qname":case"notation":case"normalizedstring":case"token":case"language":case"idrefs":case"entities":case"nmtoken":case"nmtokens":case"name":case"ncname":case"id":case"idref":case"entity":case"duration":case"time":e.push(new m({name:s,alias:s,type:"string",nullable:u,length:c??255}));break;case"datetime":case"date":e.push(new m({name:s,alias:s,type:"date",nullable:u,length:c??36}));break;case"pointpropertytype":r="point",l=!0;break;case"multipointpropertytype":r="multipoint",l=!0;break;case"curvepropertytype":case"multicurvepropertytype":case"multilinestringpropertytype":r="polyline",l=!0;break;case"surfacepropertytype":case"multisurfacepropertytype":case"multipolygonpropertytype":r="polygon",l=!0;break;case"geometrypropertytype":case"multigeometrypropertytype":l=!0,t.push(new p(N,`geometry type '${i}' is not supported`,{type:new XMLSerializer().serializeToString(n)}));break;default:t.push(new p(Q,`Unknown field type '${i}'`,{type:new XMLSerializer().serializeToString(n)}))}l&&e.push(new m({name:s,alias:s,type:"geometry",nullable:u}))}for(const a of e)if(a.type==="integer"&&!a.nullable&&ye.has(a.name.toLowerCase())){a.type="oid";break}return{geometryType:r,fields:e,errors:t}}async function ge(n,t,e,r){var a;let{data:o}=await w(n,{responseType:"text",query:G(t,e,r),signal:r==null?void 0:r.signal});o=o.replace(/": +(-?\d+),(\d+)(,)?/g,'": $1.$2$3');try{if((a=r==null?void 0:r.dateFields)!=null&&a.length){const s=new Set(r.dateFields);return JSON.parse(o,(i,c)=>s.has(i)?V(c):c)}return JSON.parse(o)}catch(s){throw new p(B,"Error while parsing the response",{response:o,error:s})}}function G(n,t,e){return{SERVICE:"WFS",REQUEST:"GetFeature",VERSION:d,TYPENAMES:n,OUTPUTFORMAT:t,SRSNAME:"EPSG:4326",STARTINDEX:e==null?void 0:e.startIndex,COUNT:e==null?void 0:e.count,...e==null?void 0:e.customParameters}}function D(n){return new DOMParser().parseFromString(n.trim(),"text/xml")}function g(n){const[t,e]=n.split(":");return{prefix:e?t:"",name:e??t}}function Te(n){var e;const t=(e=n.firstElementChild)==null?void 0:e.getAttribute("version");if(t&&t!==d)throw new p(ee,`Unsupported WFS version ${t}. Supported version: ${d}`)}function A(n){let t="",e="";if(S(n.firstElementChild,{Exception:r=>(t=r.getAttribute("exceptionCode"),{ExceptionText:o=>{e=o.textContent}})}),t)throw new p(`wfs-layer:${t}`,e)}export{O as W,be as a,Ee as b,ie as f,ge as g,le as p};
