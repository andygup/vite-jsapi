import{ae as q,af as H,ag as Lt,ai as Rt,bD as Nt,E as Ot,cE as Gt,L as Q,cG as Pt,m as et,t as Xt,bP as Dt,bf as Wt,cR as bt,br as qt}from"./index-b4b3ae7d.js";class yt{constructor(e=null,t=null,l=null){this.minValue=e,this.maxValue=t,this.noDataValue=l}}const Bt=9999999e31,Ht=2e-7,Jt={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-34028234663852886e22,34028234663852886e22],f64:[-Number.MAX_VALUE,Number.MAX_VALUE],unknown:void 0,c64:void 0,c128:void 0};function ft(n){return Jt[n]??[-34028234663852886e22,34028234663852886e22]}function ye(n,e,t){if(n.depthCount&&n.depthCount>1)return;const{pixels:l,statistics:a,pixelType:i}=n,h=l[0].length,s=n.bandMasks??[],f=n.mask??new Uint8Array(h).fill(255),r=i==="f32"||i==="f64",c=ft(i);let o=!1;for(let p=0;p<l.length;p++){const u=typeof e=="number"?e:e[p];if(u==null)continue;const d=(a==null?void 0:a[p].minValue)??c[0],m=(a==null?void 0:a[p].maxValue)??c[1];if(d>u+Number.EPSILON||m<u-Number.EPSILON)continue;const x=s[p]||new Uint8Array(h).fill(255),y=l[p],A=t==null?void 0:t.customFloatTolerance;if(r&&A!==0){let M=A;M||(M=Math.abs(u)>=Bt?Ht*Math.abs(u):i==="f32"?2**-23:Number.EPSILON);for(let g=0;g<y.length;g++)x[g]&&Math.abs(y[g]-u)<M&&(y[g]=0,x[g]=0,f[g]=0,o=!0)}else for(let M=0;M<y.length;M++)x[M]&&y[M]===u&&(y[M]=0,x[M]=0,f[M]=0,o=!0);s[p]=x}o&&(n.bandMasks=s,n.mask=f),o&&"updateStatistics"in n&&n.updateStatistics()}var Y;let D=Y=class extends Nt{static createEmptyBand(e,t){const l=Y.getPixelArrayConstructor(e);return new l(t)}static getPixelArrayConstructor(e){let t;switch(e){case"u1":case"u2":case"u4":case"u8":t=Uint8Array;break;case"u16":t=Uint16Array;break;case"u32":t=Uint32Array;break;case"s8":t=Int8Array;break;case"s16":t=Int16Array;break;case"s32":t=Int32Array;break;case"f32":t=Float32Array;break;case"f64":t=Float64Array;break;case"c64":case"c128":case"unknown":t=Float32Array;break}return t}constructor(e){super(e),this.width=null,this.height=null,this.pixelType="f32",this.validPixelCount=null,this.mask=null,this.maskIsAlpha=!1,this.premultiplyAlpha=!1,this.statistics=null,this.depthCount=1}castPixelType(e){if(!e)return"f32";let t=e.toLowerCase();return["u1","u2","u4"].includes(t)?t="u8":["unknown","u8","s8","u16","s16","u32","s32","f32","f64"].includes(t)||(t="f32"),t}getPlaneCount(){var e;return(e=this.pixels)==null?void 0:e.length}addData(e){if(!e.pixels||e.pixels.length!==this.width*this.height)throw new Ot("pixelblock:invalid-or-missing-pixels","add data requires valid pixels array that has same length defined by pixel block width * height");this.pixels||(this.pixels=[]),this.statistics||(this.statistics=[]),this.pixels.push(e.pixels),this.statistics.push(e.statistics??new yt)}getAsRGBA(){const e=new ArrayBuffer(this.width*this.height*4);switch(this.pixelType){case"s8":case"s16":case"u16":case"s32":case"u32":case"f32":case"f64":this._fillFromNon8Bit(e);break;default:this._fillFrom8Bit(e);break}return new Uint8ClampedArray(e)}getAsRGBAFloat(){const e=new Float32Array(this.width*this.height*4);return this._fillFrom32Bit(e),e}updateStatistics(){if(!this.pixels)return;this.statistics=this.pixels.map(l=>this._calculateBandStatistics(l,this.mask));const e=this.mask;let t=0;if(e!=null)for(let l=0;l<e.length;l++)e[l]&&t++;else t=this.width*this.height;this.validPixelCount=t}clamp(e){if(!e||e==="f64"||e==="f32"||!this.pixels)return;const[t,l]=ft(e),a=this.pixels,i=this.width*this.height,h=a.length;let s,f,r;const c=[];for(let o=0;o<h;o++){r=Y.createEmptyBand(e,i),s=a[o];for(let p=0;p<i;p++)f=s[p],r[p]=f>l?l:f<t?t:f;c.push(r)}this.pixels=c,this.pixelType=e}extractBands(e){const{pixels:t,statistics:l}=this;if(e==null||e.length===0||!t||t.length===0)return this;const a=t.length,i=e.some(s=>s>=t.length),h=a===e.length&&!e.some((s,f)=>s!==f);return i||h?this:new Y({pixelType:this.pixelType,width:this.width,height:this.height,mask:this.mask,validPixelCount:this.validPixelCount,maskIsAlpha:this.maskIsAlpha,pixels:e.map(s=>t[s]),statistics:l&&e.map(s=>l[s])})}clone(){const e=new Y({width:this.width,height:this.height,pixelType:this.pixelType,maskIsAlpha:this.maskIsAlpha,validPixelCount:this.validPixelCount});this.mask!=null&&(this.mask instanceof Uint8Array?e.mask=new Uint8Array(this.mask):e.mask=this.mask.slice(0));let t;const l=Y.getPixelArrayConstructor(this.pixelType);if(this.pixels&&this.pixels.length>0){e.pixels=[];const a=!!this.pixels[0].slice;for(t=0;t<this.pixels.length;t++)a?e.pixels[t]=this.pixels[t].slice(0,this.pixels[t].length):e.pixels[t]=new l(this.pixels[t])}if(this.statistics)for(e.statistics=[],t=0;t<this.statistics.length;t++)e.statistics[t]=Gt(this.statistics[t]);return e.premultiplyAlpha=this.premultiplyAlpha,e}_fillFrom8Bit(e){const{mask:t,maskIsAlpha:l,premultiplyAlpha:a,pixels:i}=this;if(!e||!i||!i.length){Q.getLogger(this.declaredClass).error("getAsRGBA()","Unable to convert to RGBA. The input pixel block is empty.");return}let h,s,f,r;h=s=f=i[0],i.length>=3?(s=i[1],f=i[2]):i.length===2&&(s=i[1]);const c=new Uint32Array(e),o=this.width*this.height;if(h.length!==o){Q.getLogger(this.declaredClass).error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.");return}if(t!=null&&t.length===o)if(l)for(r=0;r<o;r++){const p=t[r];if(p){const u=p/255;c[r]=a?p<<24|f[r]*u<<16|s[r]*u<<8|h[r]*u:p<<24|f[r]<<16|s[r]<<8|h[r]}}else for(r=0;r<o;r++)t[r]&&(c[r]=255<<24|f[r]<<16|s[r]<<8|h[r]);else for(r=0;r<o;r++)c[r]=255<<24|f[r]<<16|s[r]<<8|h[r]}_fillFromNon8Bit(e){const{pixels:t,mask:l,statistics:a}=this;if(!e||!t||!t.length){Q.getLogger(this.declaredClass).error("getAsRGBA()","Unable to convert to RGBA. The input pixel block is empty.");return}const i=this.pixelType;let h=1,s=0,f=1;if(a&&a.length>0){for(const x of a)if(x.minValue!=null&&(s=Math.min(s,x.minValue)),x.maxValue!=null&&x.minValue!=null){const y=x.maxValue-x.minValue;f=Math.max(f,y)}h=255/f}else{let x=255;i==="s8"?(s=-128,x=127):i==="u16"?x=65535:i==="s16"?(s=-32768,x=32767):i==="u32"?x=4294967295:i==="s32"?(s=-2147483648,x=2147483647):i==="f32"?(s=-3.4*1e39,x=3.4*1e39):i==="f64"&&(s=-Number.MAX_VALUE,x=Number.MAX_VALUE),h=255/(x-s)}const r=new Uint32Array(e),c=this.width*this.height;let o,p,u,d,m;if(o=p=u=t[0],o.length!==c)return Q.getLogger(this.declaredClass).error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.");if(t.length>=2)if(p=t[1],t.length>=3&&(u=t[2]),l!=null&&l.length===c)for(d=0;d<c;d++)l[d]&&(r[d]=255<<24|(u[d]-s)*h<<16|(p[d]-s)*h<<8|(o[d]-s)*h);else for(d=0;d<c;d++)r[d]=255<<24|(u[d]-s)*h<<16|(p[d]-s)*h<<8|(o[d]-s)*h;else if(l!=null&&l.length===c)for(d=0;d<c;d++)m=(o[d]-s)*h,l[d]&&(r[d]=255<<24|m<<16|m<<8|m);else for(d=0;d<c;d++)m=(o[d]-s)*h,r[d]=255<<24|m<<16|m<<8|m}_fillFrom32Bit(e){const{pixels:t,mask:l}=this;if(!e||!t||!t.length)return Q.getLogger(this.declaredClass).error("getAsRGBAFloat()","Unable to convert to RGBA. The input pixel block is empty.");let a,i,h,s;a=i=h=t[0],t.length>=3?(i=t[1],h=t[2]):t.length===2&&(i=t[1]);const f=this.width*this.height;if(a.length!==f)return Q.getLogger(this.declaredClass).error("getAsRGBAFloat()","Unable to convert to RGBA. The pixelblock is invalid.");let r=0;if(l!=null&&l.length===f)for(s=0;s<f;s++)e[r++]=a[s],e[r++]=i[s],e[r++]=h[s],e[r++]=l[s]&1;else for(s=0;s<f;s++)e[r++]=a[s],e[r++]=i[s],e[r++]=h[s],e[r++]=1}_calculateBandStatistics(e,t){let l=1/0,a=-1/0;const i=e.length;let h,s=0;if(t!=null)for(h=0;h<i;h++)t[h]&&(s=e[h],l=s<l?s:l,a=s>a?s:a);else for(h=0;h<i;h++)s=e[h],l=s<l?s:l,a=s>a?s:a;return new yt(l,a)}};q([H({json:{write:!0}})],D.prototype,"width",void 0);q([H({json:{write:!0}})],D.prototype,"height",void 0);q([H({json:{write:!0}})],D.prototype,"pixelType",void 0);q([Lt("pixelType")],D.prototype,"castPixelType",null);q([H({json:{write:!0}})],D.prototype,"validPixelCount",void 0);q([H({json:{write:!0}})],D.prototype,"mask",void 0);q([H({json:{write:!0}})],D.prototype,"maskIsAlpha",void 0);q([H({json:{write:!0}})],D.prototype,"pixels",void 0);q([H()],D.prototype,"premultiplyAlpha",void 0);q([H({json:{write:!0}})],D.prototype,"statistics",void 0);q([H({json:{write:!0}})],D.prototype,"depthCount",void 0);q([H({json:{write:!0}})],D.prototype,"noDataValues",void 0);q([H({json:{write:!0}})],D.prototype,"bandMasks",void 0);D=Y=q([Rt("esri.layers.support.PixelBlock")],D);const L=D;var gt;(function(n){n[n.matchAny=0]="matchAny",n[n.matchAll=1]="matchAll"})(gt||(gt={}));var wt;(function(n){n[n.bestMatch=0]="bestMatch",n[n.fail=1]="fail"})(wt||(wt={}));const we=6;function O(n){return n!=null&&n.declaredClass==="esri.layers.support.PixelBlock"&&n.pixels&&n.pixels.length>0}function Me(n,e){if(!(e!=null&&e.length)||!O(n))return n;const t=n.pixels.length;return e&&e.some(l=>l>=t)||t===1&&e.length===1&&e[0]===0||t===e.length&&!e.some((l,a)=>l!==a)?n:new L({pixelType:n.pixelType,width:n.width,height:n.height,mask:n.mask,validPixelCount:n.validPixelCount,maskIsAlpha:n.maskIsAlpha,pixels:e.map(l=>n.pixels[l]),statistics:n.statistics&&e.map(l=>n.statistics[l])})}function Ae(n){var c;if(!(n!=null&&n.length)||n.some(o=>!O(o)))return null;if(n.length===1)return((c=n[0])==null?void 0:c.clone())??null;const e=n,{width:t,height:l,pixelType:a}=e[0];if(e.some(o=>o.width!==t||o.height!==l))return null;const i=e.map(({mask:o})=>o).filter(o=>o!=null);let h=null;i.length&&(h=new Uint8Array(t*l),h.set(i[0]),i.length>1&&Ut(i.slice(1),h));const s=[];e.forEach(({pixels:o})=>s.push(...o));const f=e.map(({statistics:o})=>o).filter(o=>o==null?void 0:o.length),r=[];return f.forEach(o=>r.push(...o)),new L({pixelType:a,width:t,height:l,mask:h,pixels:s,statistics:r.length?r:null})}function ve(n){if(!n)return;const e=n.colormap;if(!e||e.length===0)return;const t=e.sort((o,p)=>o[0]-p[0]);let l=0;t[0][0]<0&&(l=t[0][0]);const a=Math.max(256,t[t.length-1][0]-l+1),i=new Uint8Array(a*4),h=[];let s,f=0,r=0;const c=t[0].length===5;if(a>65536)return t.forEach(o=>{h[o[0]-l]=c?o.slice(1):o.slice(1).concat([255])}),{indexed2DColormap:h,offset:l,alphaSpecified:c};if(n.fillUnspecified)for(s=t[r],f=s[0]-l;f<a;f++)i[f*4]=s[1],i[f*4+1]=s[2],i[f*4+2]=s[3],c?i[f*4+3]=s[4]:i[f*4+3]=255,f===s[0]-l&&(s=r===t.length-1?s:t[++r]);else for(f=0;f<t.length;f++)s=t[f],r=(s[0]-l)*4,i[r]=s[1],i[r+1]=s[2],i[r+2]=s[3],c?i[r+3]=s[4]:i[r+3]=255;return{indexedColormap:i,offset:l,alphaSpecified:c}}function ke(n,e){if(!O(n)||!(e&&(e.indexedColormap||e.indexed2DColormap)))return n;const t=n.clone(),l=t.pixels;let a=t.mask;const i=t.width*t.height;if(l.length!==1)return n;const{indexedColormap:s,indexed2DColormap:f,offset:r,alphaSpecified:c}=e;let o=0;const p=l[0],u=new Uint8Array(p.length),d=new Uint8Array(p.length),m=new Uint8Array(p.length);let x=0,y;if(s){const A=s.length-1;if(a!=null)for(o=0;o<i;o++)a[o]&&(x=(p[o]-r)*4,x<r||x>A?a[o]=0:(u[o]=s[x],d[o]=s[x+1],m[o]=s[x+2],a[o]=s[x+3]));else{for(a=new Uint8Array(i),o=0;o<i;o++)x=(p[o]-r)*4,x<r||x>A?a[o]=0:(u[o]=s[x],d[o]=s[x+1],m[o]=s[x+2],a[o]=s[x+3]);t.mask=a}}else if(f)if(a!=null)for(o=0;o<i;o++)a[o]&&(y=f[p[o]],u[o]=y[0],d[o]=y[1],m[o]=y[2],a[o]=y[3]);else{for(a=new Uint8Array(i),o=0;o<i;o++)y=f[p[o]],u[o]=y[0],d[o]=y[1],m[o]=y[2],a[o]=y[3];t.mask=a}return t.pixels=[u,d,m],t.statistics=null,t.pixelType="u8",t.maskIsAlpha=c,t}function _e(n,e){if(!O(n))return null;const{pixels:t,mask:l}=n,a=t.length;let i=e.lut;const{offset:h}=e;i&&i[0].length===1&&(i=t.map(()=>i));const s=[],f=e.outputPixelType||"u8";for(let c=0;c<a;c++){const o=Vt(t[c],l,i[c],h||0,f);s.push(o)}const r=new L({width:n.width,height:n.height,pixels:s,mask:l,pixelType:f});return r.updateStatistics(),r}function Vt(n,e,t,l,a){const i=n.length,h=L.createEmptyBand(a,i);if(e)for(let s=0;s<i;s++)e[s]&&(h[s]=t[n[s]-l]);else for(let s=0;s<i;s++)h[s]=t[n[s]-l];return h}function Ce(n,e){if(!O(n))return null;const t=n.clone(),{pixels:l}=t,a=t.width*t.height,i=e.length,h=Math.floor(i/2),s=e[Math.floor(h)],f=l[0];let r,c,o,p,u,d,m=!1;const x=new Uint8Array(a),y=new Uint8Array(a),A=new Uint8Array(a);let M=t.mask;const g=e[0].mappedColor.length===4;for(M||(M=new Uint8Array(a),M.fill(g?255:1),t.mask=M),u=0;u<a;u++)if(M[u]){for(r=f[u],m=!1,d=h,c=s,o=0,p=i-1;p-o>1;){if(r===c.value){m=!0;break}r>c.value?o=d:p=d,d=Math.floor((o+p)/2),c=e[Math.floor(d)]}m||(r===e[o].value?(c=e[o],m=!0):r===e[p].value?(c=e[p],m=!0):r<e[o].value?(m=!1,c=null):r>e[o].value&&(r<e[p].value?(c=e[o],m=!0):p===i-1?(m=!1,c=null):(c=e[p],m=!0))),m?(x[u]=c.mappedColor[0],y[u]=c.mappedColor[1],A[u]=c.mappedColor[2],M[u]=c.mappedColor[3]):x[u]=y[u]=A[u]=M[u]=0}return t.pixels=[x,y,A],t.mask=M,t.pixelType="u8",t.maskIsAlpha=g,t}function be(n,e){if(!O(n))return null;const{width:t,height:l}=n,{inputRanges:a,outputValues:i,outputPixelType:h,noDataRanges:s,allowUnmatched:f,isLastInputRangeInclusive:r}=e,c=n.pixels[0],o=L.createEmptyBand(h,c.length),p=n.mask,u=new Uint8Array(t*l);p?u.set(p):u.fill(255);const m=n.pixelType.startsWith("f")?1e-6:0,x=a.map(k=>k-m);x[0]=a[0],x[x.length-1]=a[a.length-1]+(r?1e-6:0);const y=a.length/2,[A,M]=ft(h);for(let k=0;k<l;k++)for(let w=0;w<t;w++){const _=k*t+w;if(u[_]){const C=c[_];let v=!1;for(let b=y-1;b>=0;b--)if(C===x[2*b]||C>x[2*b]&&C<x[2*b+1]){o[_]=i[b],v=!0;break}v||(f?o[_]=C>M?M:C<A?A:C:u[_]=0)}}const g=s==null?void 0:s.length;if(g)for(let k=0;k<l;k++)for(let w=0;w<t;w++){const _=k*t+w;if(!p||p[_]){const C=c[_];for(let v=0;v<g;v+=2)if(C>=s[v]&&C<=s[v+1]){o[_]=0,u[_]=0;break}}}return new L({width:t,height:l,pixelType:h,pixels:[o],mask:u})}function Mt(n,e,t,l){const a=t!=null&&t.length>=2?new Set(t):null,i=(t==null?void 0:t.length)===1?t[0]:null,h=!!(e!=null&&e.length);for(let s=0;s<n.length;s++)if(l[s]){const f=n[s];if(h){let r=!1;for(let c=0;c<e.length;c+=2)if(f>=e[c]&&f<=e[c+1]){r=!0;break}r||(l[s]=0)}l[s]&&(f===i||a!=null&&a.has(f))&&(l[s]=0)}}function At(n,e){const t=n[0].length;for(let l=0;l<t;l++)if(e[l]){let a=!1;for(let i=0;i<n.length;i++)if(n[i][l]){a=!0;break}a||(e[l]=0)}}function Ut(n,e){const t=n[0].length;for(let l=0;l<t;l++)if(e[l]){let a=!1;for(let i=0;i<n.length;i++)if(n[i][l]===0){a=!0;break}a&&(e[l]=0)}}function Ve(n,e){if(!O(n))return null;const{width:t,height:l,pixels:a}=n,i=t*l,h=new Uint8Array(i);n.mask?h.set(n.mask):h.fill(255);const s=a.length,{includedRanges:f,noDataValues:r,outputPixelType:c,matchAll:o,lookups:p}=e;if(p){const u=[];for(let d=0;d<s;d++){const m=p[d],x=Vt(a[d],h,m.lut,m.offset||0,"u8");u.push(x)}u.length===1?h.set(u[0]):o?At(u,h):Ut(u,h)}else if(o){const u=[];for(let d=0;d<s;d++){const m=new Uint8Array(i);m.set(h),Mt(a[d],f==null?void 0:f.slice(d*2,d*2+2),r==null?void 0:r[d],m),u.push(m)}u.length===1?h.set(u[0]):At(u,h)}else for(let u=0;u<s;u++)Mt(a[u],f==null?void 0:f.slice(u*2,u*2+2),r==null?void 0:r[u],h);return new L({width:t,height:l,pixelType:c,pixels:a,mask:h})}function Ue(n){const{srcPixelType:e,inputRanges:t,outputValues:l,allowUnmatched:a,noDataRanges:i,isLastInputRangeInclusive:h,outputPixelType:s}=n;if(!(e==="u8"||e==="s8"||e==="u16"||e==="s16"))return null;const f=e.includes("16")?65536:256,r=e.includes("s")?-f/2:0,c=L.createEmptyBand(s,f),o=new Uint8Array(f);a&&o.fill(255);const[p,u]=ft(s);if(t!=null&&t.length&&(l!=null&&l.length)){const m=t.map(x=>x-1e-6);m[0]=t[0],h&&(m[m.length-1]=t[t.length-1]);for(let x=0;x<m.length;x++){const y=l[x]>u?u:l[x]<p?p:l[x],A=Math.ceil(m[2*x]-r),M=Math.floor(m[2*x+1]-r);for(let g=A;g<=M;g++)c[g]=y,o[g]=255}}if(i!=null&&i.length)for(let d=0;d<i.length;d++){const m=Math.ceil(i[2*d]-r),x=Math.floor(i[2*d+1]-r);for(let y=m;y<=x;y++)o[y]=0}return{lut:c,offset:r,mask:o}}function Ie(n,e,t){if(!(n==="u8"||n==="s8"||n==="u16"||n==="s16"))return null;const l=n.includes("16")?65536:256,a=n.includes("s")?-l/2:0,i=new Uint8Array(l);if(e)for(let h=0;h<e.length;h++){const s=Math.ceil(e[2*h]-a),f=Math.floor(e[2*h+1]-a);for(let r=s;r<=f;r++)i[r]=255}else i.fill(255);if(t)for(let h=0;h<t.length;h++)i[t[h]-a]=0;return{lut:i,offset:a}}function Kt(n,e,t,l,a,i,h,s){const f=a<=t*n?0:a<t*n+n?a-t*n:n,r=i<=l*e?0:i<l*e+e?i-l*e:e,c=a+h<=t*n?0:a+h<t*n+n?a+h-t*n:n,o=i+s<=l*e?0:i+s<l*e+e?i+s-l*e:e;return{xmin:f,ymin:r,xmax:c,ymax:o}}function Te(n,e){if(!n||n.length===0)return null;const t=n.find(y=>y.pixelBlock);if(!t||t.pixelBlock==null)return null;const l=(t.extent.xmax-t.extent.xmin)/t.pixelBlock.width,a=(t.extent.ymax-t.extent.ymin)/t.pixelBlock.height,i=Math.min(l,a)*.01,h=n.sort((y,A)=>Math.abs(y.extent.ymax-A.extent.ymax)>i?A.extent.ymax-y.extent.ymax:Math.abs(y.extent.xmin-A.extent.xmin)>i?y.extent.xmin-A.extent.xmin:0),s=Math.min.apply(null,h.map(y=>y.extent.xmin)),f=Math.min.apply(null,h.map(y=>y.extent.ymin)),r=Math.max.apply(null,h.map(y=>y.extent.xmax)),c=Math.max.apply(null,h.map(y=>y.extent.ymax)),o={x:Math.round((e.xmin-s)/l),y:Math.round((c-e.ymax)/a)},p={width:Math.round((r-s)/l),height:Math.round((c-f)/a)},u={width:Math.round((e.xmax-e.xmin)/l),height:Math.round((e.ymax-e.ymin)/a)};if(Math.round(p.width/t.pixelBlock.width)*Math.round(p.height/t.pixelBlock.height)!==h.length||o.x<0||o.y<0||p.width<u.width||p.height<u.height)return null;const m=h.map(y=>y.pixelBlock),x=$t(m,p,{clipOffset:o,clipSize:u});return{extent:e,pixelBlock:x}}function lt(n,e,t,l,a,i){const{width:h,height:s}=t.block,{x:f,y:r}=t.offset,{width:c,height:o}=t.mosaic,p=Kt(h,s,l,a,f,r,c,o);let u=0,d=0;if(i){const m=i.hasGCSSShiftTransform?360:i.halfWorldWidth??0,x=h*i.resolutionX,y=i.startX+l*x,A=y+x;y<m&&A>m?d=i.rightPadding:y>=m&&(u=i.leftMargin-i.rightPadding,d=0)}if(p.xmax-=d,typeof e=="number"){for(let m=p.ymin;m<p.ymax;m++){const x=(a*s+m-r)*c+(l*h-f)+u;for(let y=p.xmin;y<p.xmax;y++)n[x+y]=e}return}for(let m=p.ymin;m<p.ymax;m++){const x=(a*s+m-r)*c+(l*h-f)+u,y=m*h;for(let A=p.xmin;A<p.xmax;A++)n[x+A]=e[y+A]}}function $t(n,e,t={}){const{clipOffset:l,clipSize:a,alignmentInfo:i,blockWidths:h}=t;if(h)return Zt(n,e,{blockWidths:h});const s=n.find(C=>O(C));if(s==null)return null;const f=a?a.width:e.width,r=a?a.height:e.height,c=s.width,o=s.height,p=e.width/c,u=e.height/o,d={offset:l||{x:0,y:0},mosaic:a||e,block:{width:c,height:o}},m=s.pixelType,x=L.getPixelArrayConstructor(m),y=s.pixels.length,A=[];let M,g;for(let C=0;C<y;C++){g=new x(f*r);for(let v=0;v<u;v++)for(let b=0;b<p;b++){const V=v*p+b,I=n[V];O(I)&&(M=I.pixels[C],lt(g,M,d,b,v,i))}A.push(g)}const k=n.some(C=>C==null||C.mask!=null&&C.mask.length>0);let w;if(k){w=new Uint8Array(f*r);for(let C=0;C<u;C++)for(let v=0;v<p;v++){const b=C*p+v,V=n[b],I=V!=null?V.mask:null;I!=null?lt(w,I,d,v,C,i):V?lt(w,1,d,v,C,i):lt(w,0,d,v,C,i)}}const _=new L({width:f,height:r,pixels:A,pixelType:m,mask:w});return _.updateStatistics(),_}function Zt(n,e,t){const l=n.find(u=>u!=null);if(l==null)return null;const a=n.some(u=>u!=null?!!u.mask:!0),{width:i,height:h}=e,s=a?new Uint8Array(i*h):null,{blockWidths:f}=t,r=[],c=l.getPlaneCount(),o=L.getPixelArrayConstructor(l.pixelType);if(a)for(let u=0,d=0;u<n.length;d+=f[u],u++){const m=n[u];if(!O(m))continue;const x=m.mask;for(let y=0;y<h;y++)for(let A=0;A<f[u];A++)s[y*i+A+d]=x==null?255:x[y*m.width+A]}for(let u=0;u<c;u++){const d=new o(i*h);for(let m=0,x=0;m<n.length;x+=f[m],m++){const y=n[m];if(!O(y))continue;const A=y.pixels[u];if(A!=null)for(let M=0;M<h;M++)for(let g=0;g<f[m];g++)d[M*i+g+x]=A[M*y.width+g]}r.push(d)}const p=new L({width:i,height:h,mask:s,pixels:r,pixelType:l.pixelType});return p.updateStatistics(),p}function Ee(n,e,t){if(!O(n))return null;const{width:l,height:a}=n,i=e.x,h=e.y,s=t.width+i,f=t.height+h;if(i<0||h<0||s>l||f>a||i===0&&h===0&&s===l&&f===a)return n;n.mask||(n.mask=new Uint8Array(l*a));const r=n.mask;for(let c=0;c<a;c++){const o=c*l;for(let p=0;p<l;p++)c<h||c>=f||p<i||p>=s?r[o+p]=0:r[o+p]=1}return n.updateStatistics(),n}function Qt(n){if(!O(n))return null;const e=n.clone(),{width:t,height:l,pixels:a}=n,i=a[0],h=e.pixels[0],s=n.mask;for(let f=2;f<l-1;f++){const r=new Map;for(let o=f-2;o<f+2;o++)for(let p=0;p<4;p++){const u=o*t+p;ot(r,i[u],s?s[u]:1)}h[f*t]=vt(r),h[f*t+1]=h[f*t+2]=h[f*t];let c=3;for(;c<t-1;c++){let o=(f-2)*t+c+1;ot(r,i[o],s?s[o]:1),o=(f-1)*t+c+1,ot(r,i[o],s?s[o]:1),o=f*t+c+1,ot(r,i[o],s?s[o]:1),o=(f+1)*t+c+1,ot(r,i[o],s?s[o]:1),o=(f-2)*t+c-3,at(r,i[o],s?s[o]:1),o=(f-1)*t+c-3,at(r,i[o],s?s[o]:1),o=f*t+c-3,at(r,i[o],s?s[o]:1),o=(f+1)*t+c-3,at(r,i[o],s?s[o]:1),h[f*t+c]=vt(r)}h[f*t+c+1]=h[f*t+c]}for(let f=0;f<t;f++)h[f]=h[t+f]=h[2*t+f],h[(l-1)*t+f]=h[(l-2)*t+f];return e.updateStatistics(),e}function vt(n){if(n.size===0)return 0;let e=0,t=-1,l=0;const a=n.keys();let i=a.next();for(;!i.done;)l=n.get(i.value),l>e&&(t=i.value,e=l),i=a.next();return t}function at(n,e,t){if(t===0)return;const l=n.get(e);l===1?n.delete(e):n.set(e,l-1)}function ot(n,e,t){t!==0&&n.set(e,n.has(e)?n.get(e)+1:1)}function Yt(n,e,t){let{x:l,y:a}=e;const{width:i,height:h}=t;if(l===0&&a===0&&h===n.height&&i===n.width)return n;const{width:s,height:f}=n,r=Math.max(0,a),c=Math.max(0,l),o=Math.min(l+i,s),p=Math.min(a+h,f);if(o<0||p<0||!O(n))return null;l=Math.max(0,-l),a=Math.max(0,-a);const{pixels:u}=n,d=i*h,m=u.length,x=[];for(let g=0;g<m;g++){const k=u[g],w=L.createEmptyBand(n.pixelType,d);for(let _=r;_<p;_++){const C=_*s;let v=(_+a-r)*i+l;for(let b=c;b<o;b++)w[v++]=k[C+b]}x.push(w)}const y=new Uint8Array(d),A=n.mask;for(let g=r;g<p;g++){const k=g*s;let w=(g+a-r)*i+l;for(let _=c;_<o;_++)y[w++]=A?A[k+_]:1}const M=new L({width:t.width,height:t.height,pixelType:n.pixelType,pixels:x,mask:y});return M.updateStatistics(),M}function zt(n,e=!0){if(!O(n))return null;const{pixels:t,width:l,height:a,mask:i,pixelType:h}=n,s=[],f=Math.round(l/2),r=Math.round(a/2),c=a-1,o=l-1;for(let u=0;u<t.length;u++){const d=t[u],m=L.createEmptyBand(h,f*r);let x=0;for(let y=0;y<a;y+=2)for(let A=0;A<l;A+=2){const M=d[y*l+A];if(e){const g=A===o?M:d[y*l+A+1],k=y===c?M:d[y*l+A+l],w=A===o?k:y===c?g:d[y*l+A+l+1];m[x++]=(M+g+k+w)/4}else m[x++]=M}s.push(m)}let p=null;if(i!=null){p=new Uint8Array(f*r);let u=0;for(let d=0;d<a;d+=2)for(let m=0;m<l;m+=2){const x=i[d*l+m];if(e){const y=m===o?x:i[d*l+m+1],A=d===c?x:i[d*l+m+l],M=m===o?A:d===c?y:i[d*l+m+l+1];p[u++]=x*y*A*M?1:0}else p[u++]=x}}return new L({width:f,height:r,pixelType:h,pixels:s,mask:p})}function Fe(n,e,t){if(!O(n))return null;const{width:l,height:a}=e;let{width:i,height:h}=n;const s=new Map,f={x:0,y:0},r=t==null?1:1+t;let c=n;for(let o=0;o<r;o++){const p=Math.ceil(i/l),u=Math.ceil(h/a);for(let d=0;d<u;d++){f.y=d*a;for(let m=0;m<p;m++){f.x=m*l;const x=Yt(c,f,e);s.set(`${o}/${d}/${m}`,x)}}o<r-1&&(c=zt(c)),i=Math.round(i/2),h=Math.round(h/2)}return s}function It(n,e,t,l,a=0){const{width:i,height:h}=n,{width:s,height:f}=e,r=l.cols,c=l.rows,o=Math.ceil(s/r-.1/r),p=Math.ceil(f/c-.1/c);let u,d,m,x,y,A,M;const g=o*r,k=g*p*c,w=new Float32Array(k),_=new Float32Array(k),C=new Uint32Array(k),v=new Uint32Array(k);let b=0,V,I;for(let E=0;E<p;E++)for(let S=0;S<o;S++){u=(E*o+S)*12,d=t[u],m=t[u+1],x=t[u+2],y=t[u+3],A=t[u+4],M=t[u+5];for(let T=0;T<c;T++){b=(E*c+T)*g+S*r,I=(T+.5)/c;for(let U=0;U<T;U++)V=(U+.5)/r,w[b+U]=(d*V+m*I+x)*i+a,_[b+U]=(y*V+A*I+M)*h+a,C[b+U]=Math.floor(w[b+U]),v[b+U]=Math.floor(_[b+U])}u+=6,d=t[u],m=t[u+1],x=t[u+2],y=t[u+3],A=t[u+4],M=t[u+5];for(let T=0;T<c;T++){b=(E*c+T)*g+S*r,I=(T+.5)/c;for(let U=T;U<r;U++)V=(U+.5)/r,w[b+U]=(d*V+m*I+x)*i+a,_[b+U]=(y*V+A*I+M)*h+a,C[b+U]=Math.floor(w[b+U]),v[b+U]=Math.floor(_[b+U])}}return{offsets_x:w,offsets_y:_,offsets_xi:C,offsets_yi:v,gridWidth:g}}function Se(n,e){const{coefficients:t,spacing:l}=e,{offsets_x:a,offsets_y:i,gridWidth:h}=It(n,n,t,{rows:l[0],cols:l[1]}),{width:s,height:f}=n,r=s*f,c=new Float32Array(r),o=180/Math.PI;for(let p=0;p<f;p++)for(let u=0;u<s;u++){const d=p*h+u,m=p===0?d:d-h,x=p===f-1?d:d+h,y=a[m]-a[x],A=i[x]-i[m];if(!isNaN(y)&&!isNaN(A)){let M=Math.atan2(A,y)*o;M=(360+M)%360,c[p*s+u]=M}else c[p*s+u]=90}return c}function je(n,e,t,l,a="nearest"){if(!O(n))return null;a==="majority"&&(n=Qt(n));const{pixels:i,mask:h,pixelType:s}=n,f=n.width,r=n.height,c=L.getPixelArrayConstructor(s),o=i.length,{width:p,height:u}=e;let d=!1;for(let v=0;v<t.length;v+=3)t[v]===-1&&t[v+1]===-1&&t[v+2]===-1&&(d=!0);const{offsets_x:m,offsets_y:x,offsets_xi:y,offsets_yi:A,gridWidth:M}=It({width:f,height:r},e,t,l,a==="majority"?.5:0);let g;const k=(v,b,V)=>{const I=v instanceof Float32Array||v instanceof Float64Array?0:.5;for(let E=0;E<u;E++){g=E*M;for(let S=0;S<p;S++){if(m[g]<0||x[g]<0)v[E*p+S]=0;else if(V)v[E*p+S]=b[y[g]+A[g]*f];else{const T=Math.floor(m[g]),U=Math.floor(x[g]),F=Math.ceil(m[g]),j=Math.ceil(x[g]),G=m[g]-T,B=x[g]-U;if(!h||h[T+U*f]&&h[F+U*f]&&h[T+j*f]&&h[F+j*f]){const P=b[T+U*f],W=b[F+U*f],$=b[T+j*f],K=b[F+j*f],it=(1-G)*P+G*W,tt=(1-G)*$+G*K;v[E*p+S]=(1-B)*it+B*tt+I}else v[E*p+S]=b[y[g]+A[g]*f]}g++}}},w=[];let _;for(let v=0;v<o;v++)_=new c(p*u),k(_,i[v],a==="nearest"||a==="majority"),w.push(_);const C=new L({width:p,height:u,pixelType:s,pixels:w});if(h!=null)C.mask=new Uint8Array(p*u),k(C.mask,h,!0);else if(d){C.mask=new Uint8Array(p*u);for(let v=0;v<p*u;v++)C.mask[v]=m[v]<0||x[v]<0?0:1}return C.updateStatistics(),C}const z=new Map;z.set("meter-per-second",1);z.set("kilometer-per-hour",.277778);z.set("knots",.514444);z.set("feet-per-second",.3048);z.set("mile-per-hour",.44704);const dt=180/Math.PI,mt=5,ht=new Pt({esriMetersPerSecond:"meter-per-second",esriKilometersPerHour:"kilometer-per-hour",esriKnots:"knots",esriFeetPerSecond:"feet-per-second",esriMilesPerHour:"mile-per-hour"});function xt(n,e){return z.get(n)/z.get(e)||1}function Tt(n){return(450-n)%360}function Et(n,e="geographic"){const[t,l]=n,a=Math.sqrt(t*t+l*l);let i=Math.atan2(l,t)*dt;return i=(360+i)%360,e==="geographic"&&(i=Tt(i)),[a,i]}function Ft(n,e="geographic"){let t=n[1];e==="geographic"&&(t=Tt(t)),t%=360;const l=n[0],a=l*Math.cos(t/dt),i=l*Math.sin(t/dt);return[a,i]}function Le(n,e,t,l="geographic"){if(!O(n)||t==null)return n;const a=e==="vector-magdir"?n.clone():kt(n,e),i=a.pixels[1];for(let h=0;h<i.length;h++)l==="geographic"?i[h]=(i[h]+t[h]+270)%360:i[h]=(i[h]+360-t[h])%360;return e==="vector-magdir"?a:kt(a,"vector-magdir")}function kt(n,e,t="geographic",l=1){if(!O(n))return n;const{pixels:a,width:i,height:h}=n,s=i*h,f=a[0],r=a[1],c=n.pixelType.startsWith("f")?n.pixelType:"f32",o=L.createEmptyBand(c,s),p=L.createEmptyBand(c,s);let u=0;for(let m=0;m<h;m++)for(let x=0;x<i;x++)e==="vector-uv"?([o[u],p[u]]=Et([f[u],r[u]],t),o[u]*=l):([o[u],p[u]]=Ft([f[u],r[u]],t),o[u]*=l,p[u]*=l),u++;const d=new L({pixelType:c,width:n.width,height:n.height,mask:n.mask,validPixelCount:n.validPixelCount,maskIsAlpha:n.maskIsAlpha,pixels:[o,p]});return d.updateStatistics(),d}function Re(n,e,t=1){if(t===1||!O(n))return n;const l=n.clone(),{pixels:a,width:i,height:h}=l,s=a[0],f=a[1];let r=0;for(let c=0;c<h;c++)for(let o=0;o<i;o++)e==="vector-uv"?(s[r]*=t,f[r]*=t):s[r]*=t,r++;return l.updateStatistics(),l}function Ne(n,e,t,l,a){if(a==null||!a.spatialReference.equals(n.spatialReference))return{extent:n,width:Math.round(e/l),height:Math.round(t/l),resolution:n.width/e};const i=a.xmin,h=a.ymax,s=(n.xmax-n.xmin)/e*l,f=(n.ymax-n.ymin)/t*l,r=(s+f)/2;return n.xmin=i+Math.floor((n.xmin-i)/s)*s,n.xmax=i+Math.ceil((n.xmax-i)/s)*s,n.ymin=h+Math.floor((n.ymin-h)/f)*f,n.ymax=h+Math.ceil((n.ymax-h)/f)*f,{extent:n,width:Math.round(n.width/s),height:Math.round(n.height/f),resolution:r}}const te=St(0,0,0);function St(n=0,e=0,t=Math.PI,l=!0){l&&(t=(Math.PI*2-t)%(Math.PI*2));const a=l?-1:1,i=13*a,h=-7*a,s=-2*a,f=-16*a,r=29*.75,[c,o]=X(0,e+i,t,r),[p,u]=X(n-5.5,e+h,t,r),[d,m]=X(n+5.5,e+h,t,r),[x,y]=X(n-1.5,e+s,t,r),[A,M]=X(n+1.5,e+s,t,r),[g,k]=X(n-1.5,e+f,t,r),[w,_]=X(n+1.5,e+f,t,r);return[c,o,p,u,x,y,A,M,d,m,g,k,w,_]}function ee(n=0,e=Math.PI,t=!0){t&&(e=(Math.PI*2-e)%(Math.PI*2));const l=10,a=t?-1:1,i=5*a,h=20*a,s=25*a,f=45,r=0,c=0,o=2,p=0,u=o*a,d=t?1:-1,m=l/2*d;let[x,y]=[r+m,c-h],[A,M]=[x+o*d,y],[g,k]=[A-p*d,M+u],[w,_]=[r-m,c-s],[C,v]=[w+p*d,_-u],b=Math.ceil(n/mt),V=Math.floor(b/10);b=b-V*8;const I=[],E=[];for(let K=0;K<b/2;K++,V--){V<=0&&b%2===1&&K===(b-1)/2&&(w=r,C=w+p*d,_=(_+y)/2,v=_-u);const[tt,rt]=X(w,_,e,f);if(V>0){const[nt,R]=X(A,_,e,f),[N,st]=X(x,y,e,f);I.push(nt),I.push(R),I.push(tt),I.push(rt),I.push(N),I.push(st)}else{const[nt,R]=X(A,M,e,f),[N,st]=X(g,k,e,f),[ut,jt]=X(C,v,e,f);E.push(tt),E.push(rt),E.push(ut),E.push(jt),E.push(N),E.push(st),E.push(nt),E.push(R)}_+=i,y+=i,M+=i,k+=i,v+=i}const[S,T]=X(r+m,c+h,e,f),U=(l/2+o)*d,[F,j]=X(r+U,c+h,e,f),[G,B]=X(r+m,c-s,e,f),[P,W]=X(r+U,c-s,e,f);return{pennants:I,barbs:E,shaft:[S,T,F,j,G,B,P,W]}}function X(n,e,t,l=1){const a=Math.sqrt(n*n+e*e)/l,i=(Math.PI*2+Math.atan2(e,n))%(Math.PI*2),h=(Math.PI*2+i-t)%(Math.PI*2);return[a,h]}const ct=[0,1,3,6,10,16,21,27,33,40,47,55,63],ne=[0,.5,1,1.5,2],se=[0,.25,.5,1,1.5,2,2.5,3,3.5,4];function Z(n,e,t,l){const a=xt(l||"knots",t);let i;for(i=1;i<e.length;i++)if(i===e.length-1){if(n<e[i]*a)break}else if(n<=e[i]*a)break;return Math.min(i-1,e.length-2)}function oe(n,e,t,l,a){let i=0;switch(e){case"beaufort_kn":i=Z(n,ct,"knots",t);break;case"beaufort_km":i=Z(n,ct,"kilometer-per-hour",t);break;case"beaufort_ft":i=Z(n,ct,"feet-per-second",t);break;case"beaufort_m":i=Z(n,ct,"meter-per-second",t);break;case"classified_arrow":i=Z(n,a??[],l,t);break;case"ocean_current_m":i=Z(n,ne,"meter-per-second",t);break;case"ocean_current_kn":i=Z(n,se,"knots",t);break}return i}function ie(n,e){const{style:t,inputUnit:l,outputUnit:a,breakValues:i}=e,h=ht.fromJSON(l),s=ht.fromJSON(a),r=6*7,c=15;let o=0,p=0;const{width:u,height:d,mask:m}=n,x=n.pixels[0],y=n.pixels[1],A=m!=null?m.filter(w=>w>0).length:u*d,M=new Float32Array(A*r),g=new Uint32Array(c*A),k=e.invertDirection?St(0,0,0,!1):te;for(let w=0;w<d;w++)for(let _=0;_<u;_++){const C=w*u+_;if(!m||m[w*u+_]){const v=(y[C]+360)%360/180*Math.PI,b=oe(x[C],t,h,s,i);for(let I=0;I<k.length;I+=2)M[o++]=(_+.5)/u,M[o++]=(w+.5)/d,M[o++]=k[I],M[o++]=k[I+1]+v,M[o++]=b,M[o++]=x[C];const V=(o/r-1)*7;g[p++]=V,g[p++]=V+1,g[p++]=V+2,g[p++]=V+0,g[p++]=V+4,g[p++]=V+3,g[p++]=V+0,g[p++]=V+2,g[p++]=V+3,g[p++]=V+2,g[p++]=V+5,g[p++]=V+3,g[p++]=V+5,g[p++]=V+6,g[p++]=V+3}}return{vertexData:M,indexData:g}}const pt=[];function re(n,e){if(pt.length===0)for(let d=0;d<30;d++)pt.push(ee(d*5,0,!e.invertDirection));const t=ht.fromJSON(e.inputUnit),l=xt(t,"knots"),{width:a,height:i,mask:h}=n,s=n.pixels[0],f=n.pixels[1],r=6,c=[],o=[];let p=0,u=0;for(let d=0;d<i;d++)for(let m=0;m<a;m++){const x=d*a+m,y=s[x]*l;if((!h||h[d*a+m])&&y>=mt){const A=(f[x]+360)%360/180*Math.PI,{pennants:M,barbs:g,shaft:k}=pt[Math.min(Math.floor(y/5),29)];if(M.length+g.length===0)continue;let w=c.length/r;const _=(m+.5)/a,C=(d+.5)/i;for(let v=0;v<M.length;v+=2)c[p++]=_,c[p++]=C,c[p++]=M[v],c[p++]=M[v+1]+A,c[p++]=0,c[p++]=y;for(let v=0;v<g.length;v+=2)c[p++]=_,c[p++]=C,c[p++]=g[v],c[p++]=g[v+1]+A,c[p++]=0,c[p++]=y;for(let v=0;v<k.length;v+=2)c[p++]=_,c[p++]=C,c[p++]=k[v],c[p++]=k[v+1]+A,c[p++]=0,c[p++]=y;for(let v=0;v<M.length/6;v++)o[u++]=w,o[u++]=w+1,o[u++]=w+2,w+=3;for(let v=0;v<g.length/8;v++)o[u++]=w,o[u++]=w+1,o[u++]=w+2,o[u++]=w+1,o[u++]=w+2,o[u++]=w+3,w+=4;o[u++]=w+0,o[u++]=w+1,o[u++]=w+2,o[u++]=w+1,o[u++]=w+3,o[u++]=w+2,w+=4}}return{vertexData:new Float32Array(c),indexData:new Uint32Array(o)}}function le(n,e){let a=0,i=0;const{width:h,height:s,mask:f}=n,r=n.pixels[0],c=[],o=[],p=ht.fromJSON(e.inputUnit),u=xt(p,"knots"),d=e.style==="wind_speed"?mt:Number.MAX_VALUE;for(let m=0;m<s;m++)for(let x=0;x<h;x++){const y=m*h+x,A=r[y]*u;if((!f||f[m*h+x])&&A<d){for(let g=0;g<4;g++)c[a++]=(x+.5)/h,c[a++]=(m+.5)/s,c[a++]=g<2?-.5:.5,c[a++]=g%2===0?-.5:.5,c[a++]=0,c[a++]=A;const M=(a/24-1)*4;o[i++]=M,o[i++]=M+1,o[i++]=M+2,o[i++]=M+1,o[i++]=M+2,o[i++]=M+3}}return{vertexData:new Float32Array(c),indexData:new Uint32Array(o)}}function Oe(n,e){return e.style==="simple_scalar"?le(n,e):e.style==="wind_speed"?re(n,e):ie(n,e)}function Ge(n,e,t,l=[0,0],a=.5){const{width:i,height:h,mask:s}=n,[f,r]=n.pixels,[c,o]=l,p=Math.round((i-c)/t),u=Math.round((h-o)/t),d=p*u,m=new Float32Array(d),x=new Float32Array(d),y=new Uint8Array(d),A=e==="vector-uv";for(let g=0;g<u;g++)for(let k=0;k<p;k++){let w=0;const _=g*p+k,C=Math.max(0,g*t+o),v=Math.max(0,k*t+c),b=Math.min(h,C+t),V=Math.min(i,v+t);for(let I=C;I<b;I++)for(let E=v;E<V;E++){const S=I*i+E;if(!s||s[S]){w++;const T=A?[f[S],r[S]]:[f[S],(360+r[S])%360],[U,F]=A?T:Ft(T);m[_]+=U,x[_]+=F}}if(w>=(b-C)*(V-v)*(1-a)){y[_]=1;const[I,E]=Et([m[_]/w,x[_]/w]);m[_]=I,x[_]=E}else y[_]=0,m[_]=0,x[_]=0}const M=new L({width:p,height:u,pixels:[m,x],mask:y});return M.updateStatistics(),M}const J=Q.getLogger("esri.views.2d.engine.flow.dataUtils"),ae=10;async function Pe(n,e,t,l){const a=performance.now(),i=ce(e,t),h=performance.now(),s=fe(e,i,t.width,t.height),f=performance.now(),r=pe(s,!0),c=performance.now(),o=n==="Streamlines"?de(r,ae):me(r),p=performance.now();return et("esri-2d-profiler")&&(J.info("I.1","_createFlowFieldFromData (ms)",Math.round(h-a)),J.info("I.2","_getStreamlines (ms)",Math.round(f-h)),J.info("I.3","createAnimatedLinesData (ms)",Math.round(c-f)),J.info("I.4","create{Streamlines|Particles}Mesh (ms)",Math.round(p-c)),J.info("I.5","createFlowMesh (ms)",Math.round(p-a)),J.info("I.6","Mesh size (bytes)",o.vertexData.buffer.byteLength+o.indexData.buffer.byteLength)),await Promise.resolve(),Xt(l),o}function ce(n,e){const t=ue(e.data,e.width,e.height,n.smoothing);return n.interpolate?(i,h)=>{const s=Math.floor(i),f=Math.floor(h);if(s<0||s>=e.width)return[0,0];if(f<0||f>=e.height)return[0,0];const r=i-s,c=h-f,o=s,p=f,u=s<e.width-1?s+1:s,d=f<e.height-1?f+1:f,m=t[(p*e.width+o)*2],x=t[(p*e.width+u)*2],y=t[(d*e.width+o)*2],A=t[(d*e.width+u)*2],M=t[(p*e.width+o)*2+1],g=t[(p*e.width+u)*2+1],k=t[(d*e.width+o)*2+1],w=t[(d*e.width+u)*2+1],_=m*(1-c)+y*c,C=x*(1-c)+A*c,v=_*(1-r)+C*r,b=M*(1-c)+k*c,V=g*(1-c)+w*c,I=b*(1-r)+V*r;return[v,I]}:(a,i)=>{const h=Math.round(a),s=Math.round(i);return h<0||h>=e.width?[0,0]:s<0||s>=e.height?[0,0]:[t[2*(s*e.width+h)],t[2*(s*e.width+h)+1]]}}function he(n,e,t,l,a,i,h,s,f){const r=[];let c=t,o=l,p=0,[u,d]=e(c,o);u*=n.velocityScale,d*=n.velocityScale;const m=Math.sqrt(u*u+d*d);r.push({x:c,y:o,t:p,speed:m});let x,y;for(let A=0;A<n.verticesPerLine;A++){let[M,g]=e(c,o);M*=n.velocityScale,g*=n.velocityScale;const k=Math.sqrt(M*M+g*g);if(k<n.minSpeedThreshold)return r;const w=M/k,_=g/k;c+=w*n.segmentLength,o+=_*n.segmentLength;const C=n.segmentLength/k;if(p+=C,Math.acos(w*x+_*y)>n.maxTurnAngle)return r;if(n.collisions){const v=Math.round(c*f),b=Math.round(o*f);if(v<0||v>h-1||b<0||b>s-1)return r;const V=i[b*h+v];if(V!==-1&&V!==a)return r;i[b*h+v]=a}r.push({x:c,y:o,t:p,speed:k}),x=w,y=_}return r}function fe(n,e,t,l){const a=[],i=new bt,h=1/Math.max(n.lineCollisionWidth,1),s=Math.round(t*h),f=Math.round(l*h),r=new Int32Array(s*f);for(let o=0;o<r.length;o++)r[o]=-1;const c=[];for(let o=0;o<l;o+=n.lineSpacing)for(let p=0;p<t;p+=n.lineSpacing)c.push({x:p,y:o,sort:i.getFloat()});c.sort((o,p)=>o.sort-p.sort);for(const{x:o,y:p}of c)if(i.getFloat()<n.density){const u=he(n,e,o,p,a.length,r,s,f,h);if(u.length<2)continue;a.push(u)}return a}function ue(n,e,t,l){if(l===0)return n;const a=Math.round(3*l),i=new Array(a*2+1);let h=0;for(let r=-a;r<=a;r++){const c=Math.exp(-r*r/(l*l));i[r+a]=c,h+=c}for(let r=-a;r<=a;r++)i[r+a]/=h;const s=new Float32Array(n.length);for(let r=0;r<t;r++)for(let c=0;c<e;c++){let o=0,p=0;for(let u=-a;u<=a;u++){if(c+u<0||c+u>=e)continue;const d=i[u+a];o+=d*n[2*(r*e+(c+u))],p+=d*n[2*(r*e+(c+u))+1]}s[2*(r*e+c)]=o,s[2*(r*e+c)+1]=p}const f=new Float32Array(n.length);for(let r=0;r<e;r++)for(let c=0;c<t;c++){let o=0,p=0;for(let u=-a;u<=a;u++){if(c+u<0||c+u>=t)continue;const d=i[u+a];o+=d*s[2*((c+u)*e+r)],p+=d*s[2*((c+u)*e+r)+1]}f[2*(c*e+r)]=o,f[2*(c*e+r)+1]=p}return f}function pe(n,e){const t=new bt,l=n.reduce((r,c)=>r+c.length,0),a=new Float32Array(l*4),i=new Array(n.length);let h=0,s=0;for(const r of n){const c=h;for(const o of r)a[h*4]=o.x,a[h*4+1]=o.y,a[h*4+2]=o.t,a[h*4+3]=o.speed,h++;i[s++]={startVertex:c,numberOfVertices:r.length,totalTime:r[r.length-1].t,timeSeed:e?t.getFloat():0}}return{lineVertices:a,lineDescriptors:i}}function de(n,e){const{lineVertices:l,lineDescriptors:a}=n;let i=0,h=0;for(const u of a){i+=u.numberOfVertices*2;const d=u.numberOfVertices-1;h+=d*6}const s=new Float32Array(i*9),f=new Uint32Array(h);let r=0,c=0;function o(){f[c++]=r-2,f[c++]=r,f[c++]=r-1,f[c++]=r,f[c++]=r+1,f[c++]=r-1}function p(u,d,m,x,y,A,M,g){const k=r*9;let w=0;s[k+w++]=u,s[k+w++]=d,s[k+w++]=1,s[k+w++]=m,s[k+w++]=A,s[k+w++]=M,s[k+w++]=x/2,s[k+w++]=y/2,s[k+w++]=g,r++,s[k+w++]=u,s[k+w++]=d,s[k+w++]=-1,s[k+w++]=m,s[k+w++]=A,s[k+w++]=M,s[k+w++]=-x/2,s[k+w++]=-y/2,s[k+w++]=g,r++}for(const u of a){const{totalTime:d,timeSeed:m}=u;let x=null,y=null,A=null,M=null,g=null,k=null;for(let w=0;w<u.numberOfVertices;w++){const _=l[(u.startVertex+w)*4],C=l[(u.startVertex+w)*4+1],v=l[(u.startVertex+w)*4+2],b=l[(u.startVertex+w)*4+3];let V=null,I=null,E=null,S=null;if(w>0){V=_-x,I=C-y;const T=Math.sqrt(V*V+I*I);if(V/=T,I/=T,w>1){let U=V+g,F=I+k;const j=Math.sqrt(U*U+F*F);U/=j,F/=j;const G=Math.min(1/(U*V+F*I),e);U*=G,F*=G,E=-F,S=U}else E=-I,S=V;E!==null&&S!==null&&(p(x,y,A,E,S,d,m,b),o())}x=_,y=C,A=v,g=V,k=I,M=b}p(x,y,A,-k,g,d,m,M)}return{vertexData:s,indexData:f}}function me(n){const{lineVertices:a,lineDescriptors:i}=n;let h=0,s=0;for(const T of i){const U=T.numberOfVertices-1;h+=U*4*2,s+=U*6*2}const f=new Float32Array(h*16),r=new Uint32Array(s);let c=0,o=0;function p(){r[o++]=c-8,r[o++]=c-7,r[o++]=c-6,r[o++]=c-7,r[o++]=c-5,r[o++]=c-6,r[o++]=c-4,r[o++]=c-3,r[o++]=c-2,r[o++]=c-3,r[o++]=c-1,r[o++]=c-2}function u(T,U,F,j,G,B,P,W,$,K,it,tt,rt,nt){const R=c*16;let N=0;for(const st of[1,2])for(const ut of[1,2,3,4])f[R+N++]=T,f[R+N++]=U,f[R+N++]=F,f[R+N++]=j,f[R+N++]=P,f[R+N++]=W,f[R+N++]=$,f[R+N++]=K,f[R+N++]=st,f[R+N++]=ut,f[R+N++]=rt,f[R+N++]=nt,f[R+N++]=G/2,f[R+N++]=B/2,f[R+N++]=it/2,f[R+N++]=tt/2,c++}let d,m,x,y,A,M,g,k,w,_,C,v,b,V;function I(T,U){let F=w+C,j=_+v;const G=Math.sqrt(F*F+j*j);F/=G,j/=G;const B=w*F+_*j;F/=B,j/=B;let P=C+b,W=v+V;const $=Math.sqrt(P*P+W*W);P/=$,W/=$;const K=C*P+v*W;P/=K,W/=K,u(d,m,x,y,-j,F,A,M,g,k,-W,P,T,U),p()}function E(T,U,F,j,G,B){if(w=C,_=v,C=b,v=V,w==null&&_==null&&(w=C,_=v),A!=null&&M!=null){b=T-A,V=U-M;const P=Math.sqrt(b*b+V*V);b/=P,V/=P}w!=null&&_!=null&&I(G,B),d=A,m=M,x=g,y=k,A=T,M=U,g=F,k=j}function S(T,U){w=C,_=v,C=b,v=V,w==null&&_==null&&(w=C,_=v),w!=null&&_!=null&&I(T,U)}for(const T of i){d=null,m=null,x=null,y=null,A=null,M=null,g=null,k=null,w=null,_=null,C=null,v=null,b=null,V=null;const{totalTime:U,timeSeed:F}=T;for(let j=0;j<T.numberOfVertices;j++){const G=a[(T.startVertex+j)*4],B=a[(T.startVertex+j)*4+1],P=a[(T.startVertex+j)*4+2],W=a[(T.startVertex+j)*4+3];E(G,B,P,W,U,F)}S(U,F)}return{vertexData:f,indexData:r}}function _t(n,e){const t=e.pixels,{width:l,height:a}=e,i=new Float32Array(l*a*2),h=e.mask||new Uint8Array(l*a*2);if(e.mask||h.fill(255),n==="vector-uv")for(let s=0;s<l*a;s++)i[2*s]=t[0][s],i[2*s+1]=-t[1][s];else if(n==="vector-magdir")for(let s=0;s<l*a;s++){const f=t[0][s],r=qt(t[1][s]),c=Math.cos(r-Math.PI/2),o=Math.sin(r-Math.PI/2);i[2*s]=c*f,i[2*s+1]=o*f}return{data:i,mask:h,width:l,height:a}}async function Xe(n,e,t,l,a,i){const h=performance.now(),s=Dt(e.spatialReference);if(!s){const g=await Ct(n,e,t,l,a,i);return et("esri-2d-profiler")&&J.info("I.7","loadImagery, early exit (ms)",Math.round(performance.now()-h)),et("esri-2d-profiler")&&J.info("I.9","Number of parts",1),g}const[f,r]=s.valid,c=r-f,o=Math.ceil(e.width/c),p=e.width/o,u=Math.round(t/o);let d=e.xmin;const m=[],x=performance.now();for(let g=0;g<o;g++){const k=new Wt({xmin:d,xmax:d+p,ymin:e.ymin,ymax:e.ymax,spatialReference:e.spatialReference});m.push(Ct(n,k,u,l,a,i)),d+=p}const y=await Promise.all(m);et("esri-2d-profiler")&&J.info("I.8","All calls to _fetchPart (ms)",Math.round(performance.now()-x)),et("esri-2d-profiler")&&J.info("I.9","Number of parts",y.length);const A={data:new Float32Array(t*l*2),mask:new Uint8Array(t*l),width:t,height:l};let M=0;for(const g of y){for(let k=0;k<g.height;k++)for(let w=0;w<g.width;w++)M+w>=t||(A.data[2*(k*t+M+w)]=g.data[2*(k*g.width+w)],A.data[2*(k*t+M+w)+1]=g.data[2*(k*g.width+w)+1],A.mask[k*t+M+w]=g.mask[k*g.width+w]);M+=g.width}return et("esri-2d-profiler")&&J.info("I.10","loadImagery, general exit (ms)",Math.round(performance.now()-h)),A}async function Ct(n,e,t,l,a,i){const h={requestProjectedLocalDirections:!0,signal:i};if(a!=null&&(h.timeExtent=a),n.type==="imagery"){await n.load({signal:i});const r=n.rasterInfo.dataType,c=await n.fetchImage(e,t,l,h);return!c||c.pixelData==null||c.pixelData.pixelBlock==null?{data:new Float32Array(t*l*2),mask:new Uint8Array(t*l),width:t,height:l}:_t(r,c.pixelData.pixelBlock)}await n.load({signal:i});const s=n.rasterInfo.dataType,f=await n.fetchPixels(e,t,l,h);return!f||f.pixelBlock==null?{data:new Float32Array(t*l*2),mask:new Uint8Array(t*l),width:t,height:l}:_t(s,f.pixelBlock)}export{Vt as A,be as B,Et as C,ht as D,xt as E,Re as F,Ee as G,wt as M,gt as N,L as P,Ge as a,Oe as b,kt as c,le as d,Me as e,Fe as f,$t as g,je as h,Se as i,Le as j,Pe as k,Xe as l,Te as m,ye as n,O as o,ft as p,ke as q,Ce as r,Ne as s,_e as t,ve as u,Ae as v,Ie as w,we as x,Ve as y,Ue as z};
