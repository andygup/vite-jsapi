import{E as p,dt as T,a$ as f,P as v,ej as F}from"./index-37fc1c1b.js";import{f as h,a as G}from"./fetchService-bdc0dcb8.js";import{c as C}from"./jsonContext-f87bfb34.js";import{h as R}from"./portalItemUtils-89a65566.js";import{l as $}from"./styleUtils-e7ec34e5.js";async function X(e,t){const r=e.instance.portalItem;if(!(!r||!r.id))return await r.load(t),x(e),E(e,t)}function x(e){const t=e.instance.portalItem;if(!(t!=null&&t.type)||!e.supportedTypes.includes(t.type))throw new p("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:t==null?void 0:t.type,expectedType:e.supportedTypes.join(", ")})}async function E(e,t){const r=e.instance,n=r.portalItem;if(!n)return;const{url:o,title:l}=n,a=C(n);if(r.type==="group")return r.read({title:l},a),M(r,e);o&&r.read({url:o},a);const s=await m(e,t);return s&&r.read(s,a),r.resourceReferences={portalItem:n,paths:a.readResourcePaths??[]},r.type!=="subtype-group"&&r.read({title:l},a),$(r,a)}async function M(e,t){let r;const{portalItem:n}=e;if(!n)return;const o=n.type,l=t.layerModuleTypeMap,a=R(n,"Oriented Imagery Layer")??!1;switch(o){case"Feature Service":r=a?l.OrientedImageryLayer:l.FeatureLayer;break;case"Stream Service":r=l.StreamLayer;break;case"Scene Service":r=l.SceneLayer;break;case"Feature Collection":r=l.FeatureLayer;break;default:throw new p("portal:unsupported-item-type-as-group",`The item type '${o}' is not supported as a 'IGroupLayer'`)}let[s,u]=await Promise.all([r(),m(t)]),i=()=>s;if(o==="Feature Service"){if(u=n.url?await A(u,n.url):{},I(u).length){const w=l.SubtypeGroupLayer,L=await w();i=S=>S.layerType==="SubtypeGroupLayer"?L:s}const g=await q(n.url);return c(e,i,u,g)}return y(u)>0?c(e,i,u):k(e,i)}async function k(e,t){var o,l;const{portalItem:r}=e;if(!(r!=null&&r.url))return;const n=await h(r.url);n&&c(e,t,{layers:(o=n.layers)==null?void 0:o.map(d),tables:(l=n.tables)==null?void 0:l.map(d)})}function d(e){return{id:e.id,name:e.name}}function c(e,t,r,n){var a;let o=r.layers||[];const l=r.tables||[];if(((a=e.portalItem)==null?void 0:a.type)==="Feature Collection"&&(o.forEach(s=>{var u;((u=s==null?void 0:s.layerDefinition)==null?void 0:u.type)==="Table"&&l.push(s)}),o=o.filter(s=>{var u;return((u=s==null?void 0:s.layerDefinition)==null?void 0:u.type)!=="Table"})),"coverage"in r){const s=O(r);s&&e.add(s)}o.reverse().forEach(s=>{const u=b(e,t(s),r,s,n==null?void 0:n(s));e.add(u)}),l.reverse().forEach(s=>{const u=b(e,t(s),r,s,n==null?void 0:n(s));e.tables.add(u)})}function b(e,t,r,n,o){const l=e.portalItem,a=new t({portalItem:l.clone(),layerId:n.id});if("sourceJSON"in a&&(a.sourceJSON=o),a.type!=="subtype-group"&&(a.sublayerTitleMode="service-name"),l.type==="Feature Collection"){const s={origin:"portal-item",portal:l.portal||T.getDefault()};a.read(n,s);const u=r.showLegend;u!=null&&a.read({showLegend:u},s)}return a}async function m(e,t){if(e.supportsData===!1)return;const r=e.instance,n=r.portalItem;if(!n)return;let o=null;try{o=await n.fetchData("json",t)}catch{}if(K(r)){let l=null,a=!0;if(o&&y(o)>0){if(r.layerId==null){const s=I(o);r.layerId=r.type==="subtype-group"?s==null?void 0:s[0]:U(o)}l=j(o,r),l&&(y(o)===1&&(a=!1),o.showLegend!=null&&(l.showLegend=o.showLegend))}return a&&"sublayerTitleMode"in r&&r.sublayerTitleMode!=="service-name"&&(r.sublayerTitleMode="item-title-and-service-name"),l}return o}async function A(e,t){if((e==null?void 0:e.layers)==null||(e==null?void 0:e.tables)==null){const r=await h(t);e=e||{},e.layers=e.layers||(r==null?void 0:r.layers),e.tables=e.tables||(r==null?void 0:r.tables)}return e}function U(e){const t=e.layers;if(t&&t.length)return t[0].id;const r=e.tables;return r&&r.length?r[0].id:null}function j(e,t){var o,l;const{layerId:r}=t,n=((o=e.layers)==null?void 0:o.find(a=>a.id===r))||((l=e.tables)==null?void 0:l.find(a=>a.id===r));return n&&V(n,t)?n:null}function y(e){var n,o;const t=((n=e==null?void 0:e.layers)==null?void 0:n.length)??0,r=((o=e==null?void 0:e.tables)==null?void 0:o.length)??0;return t+r}function K(e){return e.type==="stream"||e.type==="oriented-imagery"?!1:"layerId"in e}function O(e){const{coverage:t}=e;if(!t)return null;const r=new URL(t);if(t.toLowerCase().includes("item.html")){const n=r.searchParams.get("id"),o=r.origin;return f.fromPortalItem({portalItem:new v({id:n,url:o})})}else if(F(t))return f.fromArcGISServerUrl({url:t});throw new p("portal:oriented-imagery-layer-coverage","the provided coverage url couldn't be loaded as a layer")}function I(e){var r;const t=[];return(r=e==null?void 0:e.layers)==null||r.forEach(n=>{n.layerType==="SubtypeGroupLayer"&&t.push(n.id)}),t}function V(e,t){return!(t.type==="feature"&&"layerType"in e&&e.layerType==="SubtypeGroupLayer"||t.type==="subtype-group"&&!("layerType"in e))}async function q(e){const{layersJSON:t}=await G(e);if(!t)return null;const r=[...t.layers,...t.tables];return n=>r.find(o=>o.id===n.id)}export{U as getFirstLayerOrTableId,y as getNumLayersAndTables,I as getSubtypeGroupLayerIds,X as load,A as preprocessFSItemData};
