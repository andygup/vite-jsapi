import{E as rt,ba as Rs,aR as Os,p as y,cF as Bs,L as ut,d2 as qe,d1 as Dt,D as $e,ds as Ds,d6 as Fs,bj as ks,d7 as Vs,bN as wt,d5 as St,bX as re,a as Gs,t as oe,dt as Ns,du as Zs,dv as Ls,i as Xs,dw as ve,_ as Qe,aB as Ks,dc as Hs}from"./index-fb3bdf4f.js";import{l as jt,m as Ys,g as nt,k as Us,G as Je,n as O,o as js,S as R,h as qs,B as ts,p as es,q as Q,r as $s,s as ss,t as is,u as Qs,v as Js,w as ns,x as Ft,y as rs,z as os}from"./definitions-3f56d206.js";import{g as ti,i as ei}from"./visualVariablesUtils-d21fefd2.js";import{a as C,u as qt,A,z as M,B as k,D as b,b as kt,E as si,F as ii}from"./color-0f742f04.js";import{g as ni}from"./tileUtils-fdb57ff2.js";import{t as ri,L as oi,l as ai}from"./TurboLine-d388e3dd.js";import{o as Z,E as vt,C as Te}from"./enums-eb6e4255.js";import{M as $t,g as li,a as as,b as ls,d as hi,e as ci,L as Xt,f as fi,j as _i,k as ae,l as bt,F as ct,m as At,n as hs,T as ui,c as le}from"./MaterialKey-5e53447a.js";import{i as di,j as pi,k as cs,l as fs,m as _s,n as Kt,e as Ie,o as xi,p as Tt,q as T,E as mi,t as gi,u as yi}from"./ExpandedCIM-4a2a07c8.js";import{d as he,e as ce}from"./featureConversionUtils-f24a23cd.js";import{e as Ee,f as Pe,g as Ce}from"./defaultsJSON-b396ba80.js";import{d as Qt}from"./GeometryUtils-0ab64fac.js";import"./earcut-db592379.js";import{T as us,G as ds}from"./GeometryUtils-26dde58c.js";import{O as Mi}from"./OptimizedGeometry-af84d2ad.js";import{L as wi}from"./LRUCache-59f262f3.js";import{i as Si,a as vi}from"./devEnvironmentUtils-e2e22b53.js";import{f as Ti,S as Ii,r as ps,m as xs,s as Ei}from"./styleUtils-572710a0.js";function F(o,t){const e=o;if(e&&"name"in e){const s=o;return t&&t.error(new rt(s.name,s.message,s.details)),!1}return!0}const Pi=1.25;class It{get length(){return this._pos}constructor(t,e){this._pos=0;const s=e?this._roundToNearest(e,t.BYTES_PER_ELEMENT):40;this._array=new ArrayBuffer(s),this._buffer=new t(this._array),this._ctor=t,this._i16View=new Int16Array(this._array)}_roundToNearest(t,e){const s=Math.round(t);return e===1?s:s+(e-s%e)}_ensureSize(t){if(this._pos+t>=this._buffer.length){const e=this._roundToNearest((this._array.byteLength+t*this._buffer.BYTES_PER_ELEMENT)*Pi,this._buffer.BYTES_PER_ELEMENT),s=new ArrayBuffer(e),i=new this._ctor(s);i.set(this._buffer,0),this._array=s,this._buffer=i,this._i16View=new Int16Array(this._array)}}ensureSize(t){this._ensureSize(t)}writeF32(t){this._ensureSize(1);const e=this._pos,s=new Float32Array(this._array,this._pos*4,1);return s[0]=t,this._pos++,e}push(t){this._ensureSize(1);const e=this._pos;return this._buffer[this._pos++]=t,e}writeFixed(t){this._buffer[this._pos++]=t}setValue(t,e){this._buffer[t]=e}i1616Add(t,e,s){this._i16View[t*2]+=e,this._i16View[t*2+1]+=s}getValue(t){return this._buffer[t]}incr(t){if(this._buffer.length<t)throw new Error("Increment index overflows the target buffer");this._buffer[t]++}decr(t){this._buffer[t]--}writeRegion(t){this._ensureSize(t.length);const e=this._pos;return this._buffer.set(t,this._pos),this._pos+=t.length,e}writeManyFrom(t,e,s){this._ensureSize(s-e);for(let i=e;i!==s;i++)this.writeFixed(t._buffer[i])}buffer(){const t=this._array.slice(0,this._pos*4);return this.destroy(),t}toArray(){return[...this._buffer]}seek(t){this._pos=t}destroy(){this._array=null,this._buffer=null}}const dt=new Map;dt.set(C.MARKER,{multiplier:1,indicesPerRecord:6,verticesPerRecord:4});dt.set(C.LINE,{multiplier:1,indicesPerRecord:3*8,verticesPerRecord:8});dt.set(C.FILL,{multiplier:1,indicesPerRecord:10,verticesPerRecord:10});dt.set(C.TEXT,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4});dt.set(C.LABEL,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4});function Ci(o,t,e){const{indicesPerRecord:s,multiplier:i,verticesPerRecord:n}=dt.get(o),r=e*jt*Uint32Array.BYTES_PER_ELEMENT,a=i*s*e*Uint32Array.BYTES_PER_ELEMENT,l=i*n*e*t;return{recordBytes:r,indexBytes:a,vertexBytes:l}}class be{constructor(t,e,s){this._start={index:0,vertex:0};const i=Ci(t,e,s),n=e/4;this.geometryType=t,this._records=new It(Int32Array,i.recordBytes),this._indices=new It(Uint32Array,i.indexBytes),this._vertices=new It(Uint32Array,i.vertexBytes),this._metrics=new It(Float32Array,0),this._strideInt=n}serialize(t){const e=this._records.buffer(),s=this._indices.buffer(),i=this._vertices.buffer(),n=this._metrics.length?this._metrics.buffer():null,r=this._strideInt*4;return t.push(e,s,i),{stride:r,records:e,indices:s,vertices:i,metrics:n}}get strideInt(){return this._strideInt}get recordCount(){return this._records.length/jt}get vertexCount(){return this._vertices.length/this._strideInt}get indexCount(){return this._indices.length}get indexWriter(){return this._indices}get vertexWriter(){return this._vertices}get metricWriter(){return this._metrics}vertexEnsureSize(t){this._vertices.ensureSize(t)}indexEnsureSize(t){this._indices.ensureSize(t)}recordStart(){this._start.index=this._indices.length,this._start.vertex=this._vertices.length}recordEnd(t,e,s,i,n,r,a,l){this._records.push(t),this._records.push(e??0),this._records.push(s),this._records.push(i),this._records.push(n),this._records.push(r),this._records.push(a),this._records.writeF32(l)}writeIndex(t){this._indices.push(t)}writeVertex(t){this._vertices.push(t)}writeVertexF32(t){this._vertices.writeF32(t)}copyLastFrom(t,e,s){const i=t._records.length-jt,n=t._records.getValue(i),r=t._records.getValue(i+1),a=t._records.getValue(i+2),l=t._records.getValue(i+4),h=t._records.getValue(i+6),f=t._records.getValue(i+7),c=this._vertices.length,_=(t._start.vertex-this._vertices.length)/this._strideInt,d=this._indices.length,u=this.vertexCount;for(let p=t._start.index;p!==t._indices.length;p++){const m=t._indices.getValue(p);this._indices.push(m-_)}for(let p=t._start.vertex;p!==t._vertices.length;p++){const m=t._vertices.getValue(p);this._vertices.push(m)}for(let p=c;p<=this._vertices.length;p+=this._strideInt)this._vertices.i1616Add(p,e,s);this._records.push(n),this._records.push(r),this._records.push(a),this._records.push(d),this._records.push(l),this._records.push(u),this._records.push(h),this._records.push(f)}}const Vt=1,fe=2,Gt=4,_e=8,ue=16,Nt=32,de=64,Zt=128;function Ae(o){switch(o){case Vt:case _e:case Nt:return-1;case fe:case de:return 0;case Gt:case ue:case Zt:return 1}}function ze(o){switch(o){case Vt:case fe:case Gt:return-1;case _e:case ue:return 0;case Nt:case de:case Zt:return 1}}const We=Vt|_e|Nt,Re=Gt|ue|Zt,Oe=Vt|fe|Gt,Be=Nt|de|Zt;class er{constructor(t,e,s,i,n,r=0){this._hasAggregate=!1,this.hasRecords=!1,this._data={self:new Map,neighbors:new Array},this._version=0,this._current={geometryType:0,writer:null,overlaps:0,start:0,insertAfter:0,sortKey:0,id:0,materialKey:0,indexStart:0,vertStart:0,isDotDensity:!1,bufferingEnabled:!1,metricBoxLenPointer:0},this.hint=e,this.tileKey=t,this._hasAggregate=i,this._pixelBufferEnabled=n,this._version=r,this._symbologyType=s}get hasAggregates(){return this._hasAggregate}get hasPixelBufferEnabled(){return this._pixelBufferEnabled}serialize(t){const e=[];return e.push(this._serializeTileVertexData(this.tileKey,this.tileKey,this._data.self)),this._data.neighbors.forEach((s,i)=>{const n=1<<i,r=Ae(n),a=ze(n),l=ni(new Rs(this.tileKey),r,a,t),h=this._serializeTileVertexData(this.tileKey,l.id,s.vertexData);h.message.bufferIds=s.displayIds,e.push(h)}),e}_serializeTileVertexData(t,e,s){var a,l,h,f,c;const i=new Array,n={[C.MARKER]:(a=s.get(C.MARKER))==null?void 0:a.serialize(i),[C.FILL]:(l=s.get(C.FILL))==null?void 0:l.serialize(i),[C.LINE]:(h=s.get(C.LINE))==null?void 0:h.serialize(i),[C.TEXT]:(f=s.get(C.TEXT))==null?void 0:f.serialize(i),[C.LABEL]:(c=s.get(C.LABEL))==null?void 0:c.serialize(i)};return{message:{tileKeyOrigin:t,tileKey:e,data:n,version:this._version},transferList:i}}featureStart(t,e){this._current.insertAfter=t,this._current.sortKey=e}featureEnd(){}recordStart(t,e,s,i){this._current.writer=this._getVertexWriter(s),this._current.overlaps=0,this._current.indexStart=this._current.writer.indexCount,this._current.vertStart=this._current.writer.vertexCount,this._current.bufferingEnabled=i,this._current.id=t,this._current.materialKey=e,this._current.geometryType=s,this._current.isDotDensity=!1,this._current.writer.recordStart()}recordCount(){return this._current.writer.recordCount}vertexCount(){return this._current.writer.vertexCount}indexCount(){return this._current.writer.indexCount}vertexEnsureSize(t){this._current.writer.vertexEnsureSize(t)}indexEnsureSize(t){this._current.writer.indexEnsureSize(t)}vertexBounds(t,e,s,i){this._current.bufferingEnabled&&this._addOverlap(t,e,s,i)}vertexWrite(t){this._current.writer.writeVertex(t)}vertexWriteF32(t){this._current.writer.writeVertexF32(t)}vertexEnd(){}vertexWriter(){return this._current.writer.vertexWriter}indexWrite(t){this._current.writer.writeIndex(t)}indexWriter(){return this._current.writer.indexWriter}metricWriter(){return this._current.writer.metricWriter}metricStart(t,e,s,i,n,r,a,l){this._current.writer=this._getVertexWriter(C.LABEL);const h=this._current.writer.metricWriter;h.push(ti(t)),h.push(e),h.push(s),h.push(i),h.push(n),h.push(r),h.push(a),h.push(l),h.push(255),this._current.metricBoxLenPointer=h.push(0)}metricEnd(){const t=this._current.writer.metricWriter;t.getValue(this._current.metricBoxLenPointer)===0&&t.seek(t.length-10)}metricBoxWrite(t,e,s,i){const n=this._current.writer.metricWriter;n.incr(this._current.metricBoxLenPointer),n.push(0),n.push(0),n.push(t),n.push(e),n.push(s),n.push(i)}recordEnd(){const t=this._current.vertStart,e=this._current.writer.vertexCount-t;if(!e)return!1;this.hasRecords=!0;const s=this._current.indexStart,n=this._current.writer.indexCount-s;if(this._current.writer.recordEnd(this._current.id,this._current.materialKey,this._current.insertAfter,s,n,t,e,this._current.sortKey),!this._pixelBufferEnabled||this._hasAggregate||this._current.overlaps===0||this._current.geometryType===C.LABEL)return!0;const r=this._current.writer;for(let a=0;a<8;a++){const l=1<<a;if(!!(this._current.overlaps&l)){this._data.neighbors[a]||(this._data.neighbors[a]={vertexData:new Map,displayIds:new Set});const f=this._data.neighbors[a],c=this._current.geometryType;if(!f.vertexData.has(c)){const m=qt(c,this._symbologyType).geometry,x=new be(c,m,Ys);f.vertexData.set(c,x)}const _=f.vertexData.get(this._current.geometryType),d=8,u=-Ae(l)*512*d,p=-ze(l)*512*d;_==null||_.copyLastFrom(r,u,p),f.displayIds.add(this._current.id)}}return!0}_addOverlap(t,e,s,i){const n=t<0+s?Re:t>=nt-s?We:Re|We,r=e<0+i?Be:e>=nt-i?Oe:Be|Oe,a=255^(n|r);this._current.overlaps|=a}_getVertexWriter(t){if(!this._data.self.has(t)){const e=this._data.self,s=qt(t,this._symbologyType).geometry;e.set(t,new be(t,s,this.hint.records))}return this._data.self.get(t)}}const X=0,K=100;function De(o,t,e){return o[0]=t[0]-e[0],o[1]=t[1]-e[1],o}function ms(o,t){return Math.sqrt(o*o+t*t)}function Fe(o){const t=ms(o[0],o[1]);o[0]/=t,o[1]/=t}function bi(o,t){const e=o[0],s=t[0],i=o[1],n=t[1],r=e-s,a=i-n;return ms(r,a)}function Jt(o=2){return 1/Math.max(o,1)}function tt(o,t){const e=!!(o!=null&&o.minScale)&&t.scaleToZoom(o.minScale)||X,s=!!(o!=null&&o.maxScale)&&t.scaleToZoom(o.maxScale)||K;return[e,s]}function Ai(o,t){return o[t+1]}function gs(o){return o.length-1}function zi(o){let t=0;for(let e=0;e<gs(o);e++)t+=Wi(o,e);return t}function Wi(o,t,e=1){const[s,i]=Ai(o,t);return Math.sqrt(s*s+i*i)*e}class zt{constructor(t,e,s,i,n){this._segments=t,this._index=e,this._distance=s,this._xStart=i,this._yStart=n,this._done=!1}static create(t){return new zt(t,0,0,t[0][0],t[0][1])}clone(){return new zt(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(t){return this._index===t._index||t._index===this._index-1&&(this._distance===0||t._distance===1)||t._index===this._index+1&&(this._distance===1||t._distance===0)}leq(t){return this._index<t._index||this._index===t._index&&this._distance<=t._distance}geq(t){return this._index>t._index||this._index===t._index&&this._distance>=t._distance}get _segment(){return this._segments[this._index+1]}get angle(){const t=this.dy,e=-this.dx,i=(0*t+-1*e)/(1*this.length);let n=Math.acos(i);return t>0&&(n=2*Math.PI-n),n}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){const{dx:t,dy:e}=this;return Math.sqrt(t*t+e*e)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<gs(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(t,e){const s=this.backwardLength;if(t<=s)return this._distance=(s-t)/this.length,this;let i=this.backwardLength;for(;this.prev();){if(i+this.length>t)return this._seekBackwards(t-i);i+=this.length}return this._distance=0,e?this:null}seek(t,e=!1){if(t<0)return this._seekBackwards(Math.abs(t),e);const s=this.remainingLength;if(t<=s)return this._distance=(this.backwardLength+t)/this.length,this;let i=this.remainingLength;for(;this.next();){if(i+this.length>t)return this.seek(t-i,e);i+=this.length}return this._distance=1,e?this:null}}function Ri(o,t,e,s=!0){const i=zi(o),n=zt.create(o),r=i/2;if(!s){n.seek(r),e(n.clone(),0,r+0*t,i);return}const a=Math.max((i-t)/2,0),l=Math.floor(a/t),h=r-l*t;n.seek(h);for(let f=-l;f<=l;f++)n.x<512&&n.x>=0&&n.y<512&&n.y>=0&&e(n.clone(),f,r+f*t,i),n.seek(t)}function Oi(o,t){const e=t;for(let s=0;s<o.length;s++){let i=o[s];const n=[];n.push(i[0]);for(let a=1;a<i.length;a++){let[l,h]=n[a-1];l+=i[a][0],h+=i[a][1],n.push([l,h])}Bi(n,e);const r=[];r.push(n[0]);for(let a=1;a<n.length;a++){const[l,h]=n[a-1],[f,c]=n[a],_=Math.round(f-l),d=Math.round(c-h);r.push([_,d])}o[s]=r,i=r}return o}function Bi(o,t){if(t<=0)return;const s=o.length;if(s<3)return;const i=[];let n=0;i.push(0);for(let c=1;c<s;c++)n+=bi(o[c],o[c-1]),i.push(n);t=Math.min(t,.2*n);const r=[];r.push(o[0][0]),r.push(o[0][1]);const a=o[s-1][0],l=o[s-1][1],h=De([0,0],o[0],o[1]);Fe(h),o[0][0]+=t*h[0],o[0][1]+=t*h[1],De(h,o[s-1],o[s-2]),Fe(h),o[s-1][0]+=t*h[0],o[s-1][1]+=t*h[1];for(let c=1;c<s;c++)i[c]+=t;i[s-1]+=t;const f=.5*t;for(let c=1;c<s-1;c++){let _=0,d=0,u=0;for(let p=c-1;p>=0&&!(i[p+1]<i[c]-f);p--){const m=f+i[p+1]-i[c],x=i[p+1]-i[p],g=i[c]-i[p]<f?1:m/x;if(Math.abs(g)<1e-6)break;const w=g*g,S=g*m-.5*w*x,I=g*x/t,v=o[p+1],P=o[p][0]-v[0],E=o[p][1]-v[1];_+=I/S*(v[0]*g*m+.5*w*(m*P-x*v[0])-w*g*x*P/3),d+=I/S*(v[1]*g*m+.5*w*(m*E-x*v[1])-w*g*x*E/3),u+=I}for(let p=c+1;p<s&&!(i[p-1]>i[c]+f);p++){const m=f-i[p-1]+i[c],x=i[p]-i[p-1],g=i[p]-i[c]<f?1:m/x;if(Math.abs(g)<1e-6)break;const w=g*g,S=g*m-.5*w*x,I=g*x/t,v=o[p-1],P=o[p][0]-v[0],E=o[p][1]-v[1];_+=I/S*(v[0]*g*m+.5*w*(m*P-x*v[0])-w*g*x*P/3),d+=I/S*(v[1]*g*m+.5*w*(m*E-x*v[1])-w*g*x*E/3),u+=I}r.push(_/u),r.push(d/u)}r.push(a),r.push(l);for(let c=0,_=0;c<s;c++)o[c][0]=r[_++],o[c][1]=r[_++]}class ys{static getPlacement(t,e,s,i,n){const r=di(e);return r?r.execute(t,e,s,i,n):null}}const ot=8,V=M(4,4),Wt=M(4,2),G=M(4,6),ke=[Wt,Wt,G,G],Ve=[Wt,G,Wt,G],Di=[G,G,V,V],Fi=[V,V,G,G],ki=[G,V,G,V],Vi=[V,G,V,G],Ms=o=>class extends o{constructor(...t){super(...t),this._isCIM=!1,this._vertexBoundsScale=1,this.geometryType=C.TEXT,this._aux=A(0,0,this._referenceSize,this._bitset)}bindTextInfo(t,e){if(!t||!t.length){this._shapingInfo=null;return}this._shapingInfo=Os(t,s=>pi(s,e,{scale:this._scale,angle:this._angle,xOffset:this._xOffset,yOffset:this._yOffset,hAlign:this._xAlignD,vAlign:this._yAlignD,maxLineWidth:Math.max(32,Math.min(this._lineWidth,512)),lineHeight:Us*Math.max(.25,Math.min(this._lineHeight,4)),decoration:this._decoration,isCIM:this._isCIM,hasBackground:!!this._backgroundColor,borderLineSize:this._borderLineSize}))}_write(t,e,s,i){const n=e.getDisplayId();this._writeGeometry(t,e,n,s,i)}_writeGeometry(t,e,s,i,n){const r=this._shapingInfo;if(r==null)return;if(this._textPlacement!=null)return this._writePlacedText(t,s,r,i,e,n);const a=n?he(ce(n),2):e.geometryType==="esriGeometryPolygon"?e.readCentroid():e.readGeometryForDisplay();if(a!=null){if(a.isPoint){const[l,h]=a.coords;return!t.hasAggregates&&t.hasPixelBufferEnabled&&(l<0||l>=512||h<0||h>=512)?void 0:this._writeGlyphs(t,s,{x:l,y:h},r)}a.forEachVertex((l,h)=>this._writeGlyphs(t,s,{x:l,y:h},r))}}_writePlacedText(t,e,s,i,n,r){const a=this._textPlacement;r&&cs(r);const l=r?fs(r):_s(n.readGeometryForDisplay(),n.geometryType??null,!0),h=ys.getPlacement(l,a,y(1),t.tileKey,i.geometryEngine);if(!h)return;let f=h.next();for(;f!=null;){const c=-f.getAngle();s.setRotation(c);const _=f.tx,d=-f.ty;if(_<0||_>=512||d<0||d>=512){f=h.next();continue}this._writeGlyphs(t,e,{x:_,y:d},s),s.setRotation(-c),f=h.next()}}_writeGlyphs(t,e,s,i){const n=$t.load(this._materialKey),r=M(Math.round(ot*s.x),Math.round(ot*s.y)),a=this._vertexBoundsScale,{bounds:l,background:h,glyphs:f}=i;f.length>0&&(this._borderLineColor||this._backgroundColor)&&(n.textureBinding=f[0].textureBinding,t.recordStart(e,n.data,this.geometryType,!0),this._writeBackgroundGeometry(t,e,s,l,h),t.recordEnd());const c=Math.max(l.width,l.height)*2;for(const _ of i.glyphs)n.textureBinding=_.textureBinding,t.recordStart(e,n.data,this.geometryType,!0),t.vertexBounds(s.x+l.x+this._xOffset,s.y+l.y-this._yOffset,c*a,c*a),this._writeVertices(t,e,r,_),t.recordEnd()}_writeGlyph(t,e,s,i,n){const r=$t.load(this._materialKey),a=M(Math.round(ot*s),Math.round(ot*i));r.textureBinding=n.textureBinding,t.recordStart(e,r.data,this.geometryType,!0);const l=n.bounds,h=this._vertexBoundsScale;t.vertexBounds(s+l.x*h,i+l.y*h,l.width*h,l.height*h),this._writeVertices(t,e,a,n),t.recordEnd()}_writeVertices(t,e,s,i){const n=t.vertexCount();this._writeVertexCommon(t,e,s,i),t.vertexWrite(i.offsets.upperLeft),t.vertexWrite(i.texcoords.upperLeft),t.vertexEnd(),this._writeVertexCommon(t,e,s,i),t.vertexWrite(i.offsets.upperRight),t.vertexWrite(i.texcoords.upperRight),t.vertexEnd(),this._writeVertexCommon(t,e,s,i),t.vertexWrite(i.offsets.lowerLeft),t.vertexWrite(i.texcoords.lowerLeft),t.vertexEnd(),this._writeVertexCommon(t,e,s,i),t.vertexWrite(i.offsets.lowerRight),t.vertexWrite(i.texcoords.lowerRight),t.vertexEnd(),t.indexWrite(n+0),t.indexWrite(n+1),t.indexWrite(n+2),t.indexWrite(n+1),t.indexWrite(n+3),t.indexWrite(n+2)}_writeVertexCommon(t,e,s,i){const n=this._color,r=this._haloColor,a=A(0,0,this._referenceSize,this._bitset),l=A(0,0,this._size,this._haloSize);t.vertexWrite(s),t.vertexWrite(e),t.vertexWrite(n),t.vertexWrite(r),t.vertexWrite(l),t.vertexWrite(a),t.vertexWrite(this._minMaxZoom)}_writeBackgroundVertex(t,e,s,i,n,r){const a=A(0,1,this._referenceSize,this._bitset),l=A(0,0,this._size,this._haloSize),h=A(0,0,0,0);t.vertexWrite(s),t.vertexWrite(e),t.vertexWrite(i),t.vertexWrite(h),t.vertexWrite(l),t.vertexWrite(a),t.vertexWrite(this._minMaxZoom),t.vertexWrite(n),t.vertexWrite(r),t.vertexEnd()}_writeBackgroundQuad(t,e,s,i,n,r){const a=t.vertexCount();this._writeBackgroundVertex(t,e,s,i,n.upperLeft,r[0]),this._writeBackgroundVertex(t,e,s,i,n.upperRight,r[1]),this._writeBackgroundVertex(t,e,s,i,n.lowerLeft,r[2]),this._writeBackgroundVertex(t,e,s,i,n.lowerRight,r[3]),t.indexWrite(a+0),t.indexWrite(a+1),t.indexWrite(a+2),t.indexWrite(a+1),t.indexWrite(a+3),t.indexWrite(a+2)}_writeBackgroundGeometry(t,e,s,i,n){const r=M(Math.round(ot*s.x),Math.round(ot*s.y)),{x:a,y:l,width:h,height:f}=i,c=Math.max(h,f)*2;if(t.vertexBounds(s.x+a+this._xOffset,s.y+l-this._yOffset,c*this._vertexBoundsScale,c*this._vertexBoundsScale),this._backgroundColor){const _=[V,V,V,V];this._writeBackgroundQuad(t,e,r,this._backgroundColor,n.main,_)}if(this._borderLineColor||this._backgroundColor){const _=!!this._borderLineColor&&!!this._borderLineSize&&this._borderLineSize>0,[d,u,p,m,x]=_?[ke,ke,Ve,Ve,this._borderLineColor]:[Di,Fi,ki,Vi,this._backgroundColor];this._writeBackgroundQuad(t,e,r,x,n.top,d),this._writeBackgroundQuad(t,e,r,x,n.bot,u),this._writeBackgroundQuad(t,e,r,x,n.left,p),this._writeBackgroundQuad(t,e,r,x,n.right,m)}}};class Mt{constructor(){this._materialKey=null}bindFeature(t,e,s){}write(t,e,s,i){var a;if(this._effects==null||((a=this._effects)==null?void 0:a.length)===0)return this._write(t,e,i);const n=Kt.executeEffects(this._effects,e.readLegacyGeometryForDisplay(),t.tileKey,i.geometryEngine);let r=Kt.next(n);for(;r;)this._write(t,e,i,r),r=Kt.next(n)}_write(t,e,s,i){}}const Gi=5;class ft extends Ms(Mt){constructor(t,e,s,i,n,r,a,l,h,f,c,_,d,u,p,m,x,g,w,S,I,v,P,E){super(),this._xOffset=y(d),this._yOffset=y(u),this._decoration=f||"none",this._backgroundColor=v,this._borderLineColor=P,this._borderLineSize=E,this._color=n,this._haloColor=r,this._haloSize=Math.min(Math.floor(Gi*y(Bs(s))),127),this._size=Math.min(Math.round(y(e)),127);const z=Math.min(Math.round(y(i||e)),127);this._referenceSize=Math.round(Math.sqrt(z*256)),this._scale=this._size/Je,this._angle=_,this._justify=li(a||"center"),this._xAlignD=as(a||"center"),this._yAlignD=ls(l||"baseline"),this._baseline=(l||"baseline")==="baseline",this._bitset=(h===Z.MAP?1:0)|(c?1:0)<<1;const N=$t.load(t);N.sdf=!0,this._materialKey=N.data,this._lineWidth=y(p)||512,this._lineHeight=m||1,this._textPlacement=x,this._effects=g,this._isCIM=w??!1,this._minMaxZoom=M(Math.round(S*O),Math.round(I*O))}static fromText(t,e){var r,a;const s=(r=t.font)==null?void 0:r.size,i=new ft(t.materialKey,s,t.haloSize||0,s,t.color&&k(t.color)||0,t.haloColor&&k(t.haloColor)||0,t.horizontalAlignment,t.verticalAlignment,Z.SCREEN,(a=t.font)==null?void 0:a.decoration,!1,t.angle||0,t.xoffset||0,t.yoffset||0,t.lineWidth||0,t.lineHeight||0,null,null,!1,X,K,t.backgroundColor&&k(t.backgroundColor),t.borderLineColor&&k(t.borderLineColor),t.borderLineSize),[,n]=Ie(t.text);return i.bindTextInfo(e??[],n),i._vertexBoundsScale=t.maxVVSize&&s?t.maxVVSize/s:1,i}static fromCIMText(t,e,s){const i=t.scaleFactor||1,n=t.size*t.sizeRatio*i,[r,a]=tt(t.scaleInfo,s),l=new ft(t.materialKey,n,t.outlineSize*t.sizeRatio,t.referenceSize,b(t.color),b(t.outlineColor),t.horizontalAlignment,t.verticalAlignment,t.alignment,t.decoration,t.colorLocked??!1,t.angle,t.offsetX*t.sizeRatio*i,t.offsetY*t.sizeRatio*i,512,1,t.markerPlacement,t.effects,!0,r,a,t.backgroundColor?b(t.backgroundColor):void 0,t.borderLineColor?b(t.borderLineColor):void 0,t.borderLineWidth),[,h]=Ie(t.text);return l.bindTextInfo(e,h),l._vertexBoundsScale=t.maxVVSize?t.maxVVSize/n:1,l}}const ws=ut.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),Ni=(o,t="mapview-labeling")=>ws.error(new rt(t,o)),Et=1,at=0,Zi=4,Ht=25;function Li(o,t){const s=!!o.minScale&&t.scaleToZoom(o.minScale)||0;return $e(s,0,25.5)}function Xi(o,t){const s=!!o.maxScale&&t.scaleToZoom(o.maxScale)||255;return $e(s,0,25.5)}function Ki(o){const t=new Map;return e=>(t.has(e)||t.set(e,o(e)),t.get(e))}const Hi=Ki(o=>{let t=0;if(o===0)return 1/0;for(;!(o%2);)t++,o/=2;return t}),Pt=o=>Math.floor(o*127+127),et=o=>Math.floor(o*10),$=o=>Math.round(o*(254/360));class Rt extends ft{constructor(t,e,s,i){var c,_,d;super(t,(c=s.font)==null?void 0:c.size,s.haloSize||0,(_=s.font)==null?void 0:_.size,s.color&&k(s.color)||0,s.haloColor&&k(s.haloColor)||0,s.horizontalAlignment,s.verticalAlignment,hi(e.labelPlacement)?Z.MAP:Z.SCREEN,(d=s.font)==null?void 0:d.decoration,!1,s.angle||0,s.xoffset,s.yoffset,s.lineWidth,s.lineHeight,null,null,!1,null,null,s.backgroundColor&&k(s.backgroundColor),s.borderLineColor&&k(s.borderLineColor),s.borderLineSize),this._outLineLabelAngle=0,this._refPlacementPadding=0,this._refPlacementDirX=0,this._refPlacementDirY=0,this._refOffsetX=0,this._refOffsetY=0,this._zoomLevel=0,this.geometryType=C.LABEL,this._allowOverrun=e.allowOverrun??!1,this._repeatLabel=e.repeatLabel??!0,this._labelPosition=e.labelPosition??"curved";const n=Li(e,i),r=Xi(e,i),a=e.labelPlacement,[l,h]=ci(a);this._xAlignD=l,this._yAlignD=h,this._minZoom=n,this._maxZoom=r,this._minBackgroundZoom=n,this._maxBackgroundZoom=r,this._refPlacementPadding=y(s.haloSize)+js,this._repeatLabelDistance=e.repeatLabelDistance?y(e.repeatLabelDistance):128;const f=Xt.load(t);f.sdf=!0,this._materialKey=f.data}static fromLabelClass(t,e){if(t.labelPlacement==="esriServerLinePlacementCenterAlong"){const s=t.symbol;s.xoffset=0,s.yoffset=0,s.angle=0,s.font.decoration="none"}return new Rt(t.materialKey,t,t.symbol,e)}get _shapedBox(){return this._shapingInfo.bounds}setZoomLevel(t){this._zoomLevel=t}bindReferenceTemplate(t){let e=fi(this._xAlignD),s=_i(this._yAlignD);if(this._refOffsetX=0,this._refOffsetY=0,t==null){this._refSymbolAndPlacementOffset=A(0,0,Pt(e),Pt(s));return}if(t.boundsType==="circle"&&(e||s)){const r=Math.sqrt(e*e+s*s);e/=r,s/=r}const i=Math.max(t.height,t.width),n=this._refPlacementPadding*Zi;this._refSymbolAndPlacementOffset=A(n,i,Pt(e),Pt(s)),this._referenceSize=i,this._refPlacementDirX=e,this._refPlacementDirY=s,this._refOffsetX=t.xOffset,this._refOffsetY=t.yOffset}_write(t,e){if(this._shapingInfo==null)return;const s=this._shapingInfo,i=e.getDisplayId(),n=e.geometryType==="esriGeometryPolygon"?e.readLegacyCentroid():e.readLegacyGeometry();if(n)switch(this._current={out:t,inId:i,inShaping:s,zoomLevel:this._zoomLevel},e.geometryType==="esriGeometryPolyline"&&this._labelPosition==="curved"&&(this._borderLineColor||this._backgroundColor)&&ws.warnOnce("TextSymbol properties 'borderLineColor', 'borderLineSize', and 'backgroundColor' are not supported in curved labels"),e.geometryType){case"esriGeometryPolyline":this._placeLineLabels(n);break;case"esriGeometryPoint":case"esriGeometryPolygon":this._placePointLabels(n);break;default:Ni(`Geometry of type ${e.geometryType} is not supported`)}}_isVisible(t,e){const s=et(this._current.zoomLevel);return et(t)<=s&&s<=et(e)}_placePointLabels(t){const{out:e,inId:s,inShaping:i}=this._current;this._writeGlyphs(e,s,t,i)}_placeLineLabels(t){const e=Oi(t.paths,this._current.inShaping.bounds.width),s=this._placeSubdivGlyphs.bind(this),i=(this._shapedBox.width+this._repeatLabelDistance)/(1<<Et);for(const n of e)Ri(n,i,s,this._repeatLabel)}_placeSubdivGlyphs(t,e,s,i){const n=Hi(e),r=this._shapedBox.width/(1<<Et),a=Math.sqrt(this._repeatLabelDistance)/(1<<Et),l=Math.min(s,i-s),h=this._current.inShaping.isMultiline?Ht:Math.log2(l/(a+r/2)),f=e===0?h:Math.min(n,h),c=Math.max(this._minZoom,this._current.zoomLevel+Et-f),_=this._current.zoomLevel-c,d=this._shapedBox.width/2*2**_;this._current.inShaping.isMultiline?e===0&&this._placeStraight(t,c):this._allowOverrun&&_<0?this._placeStraightAlong(t,this._minZoom):this._labelPosition==="parallel"?this._placeStraightAlong(t,c):this._labelPosition==="curved"&&this._placeCurved(t,c,d)}_placeStraight(t,e){const{out:s,inId:i,inShaping:n}=this._current,r=Math.ceil(t.angle*(180/Math.PI)%360),a=Math.ceil((t.angle*(180/Math.PI)+180)%360);this._outLineLabelAngle=$(r),this._writeGlyphs(s,i,t,n,e),this._outLineLabelAngle=$(a),this._writeGlyphs(s,i,t,n,e)}_placeCurved(t,e,s){const{out:i,inId:n}=this._current;i.metricStart(n,e,t.x,t.y,0,0,0,0);const r=t.clone(),a=t.angle*(180/Math.PI)%360,l=(t.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=$(a),this._placeFirst(r,e,1),this._placeBack(t,r,e,s,1),this._placeForward(t,r,e,s,1),this._outLineLabelAngle=$(l),this._placeFirst(r,e,0),this._placeBack(t,r,e,s,0),this._placeForward(t,r,e,s,0),i.metricEnd()}_placeStraightAlong(t,e){const{out:s,inId:i,inShaping:n}=this._current;s.metricStart(i,e,t.x,t.y,0,0,0,0);const r=t.clone(),a=t.angle*(180/Math.PI)%360,l=(t.angle*(180/Math.PI)+180)%360,h=n.glyphs.length>0&&(this._borderLineColor||this._backgroundColor);if(this._maxBackgroundZoom=Ht,this._minBackgroundZoom=Math.max(e,0),h){const f=Xt.load(this._materialKey);f.textureBinding=n.glyphs[0].textureBinding;const c=qe(Dt(),-t.angle),[_,d]=n.shapeBackground(c);this._outLineLabelAngle=$(a),s.recordStart(i,f.data,this.geometryType,!0),this._writeBackgroundGeometry(s,i,t,_,d),s.recordEnd(),this._outLineLabelAngle=$(l),s.recordStart(i,f.data,this.geometryType,!0),this._writeBackgroundGeometry(s,i,t,_,d),s.recordEnd()}this._outLineLabelAngle=$(a),this._placeFirst(r,e,1,!0),this._outLineLabelAngle=$(l),this._placeFirst(r,e,0,!0),s.metricEnd()}_placeBack(t,e,s,i,n){const r=t.clone();let a=t.backwardLength+at;for(;r.prev()&&!(a>=i);)this._placeOnSegment(r,e,a,s,-1,n),a+=r.length+at}_placeForward(t,e,s,i,n){const r=t.clone();let a=t.remainingLength+at;for(;r.next()&&!(a>=i);)this._placeOnSegment(r,e,a,s,1,n),a+=r.length+at}_placeFirst(t,e,s,i=!1){const n=t,r=this._current.inShaping,a=r.glyphs,l=this._current.zoomLevel,{out:h,inId:f}=this._current;for(const c of a){const _=c.x>r.bounds.x?s:1-s,d=_*t.remainingLength+(1-_)*t.backwardLength,u=Math.abs(c.x+c.width/2-r.bounds.x),p=Math.max(0,l+Math.log2(u/(d+at))),m=Math.max(e,i?0:p);if(c.maxZoom=Ht,c.angle=t.angle+(1-s)*Math.PI,c.minZoom=m,this._writeGlyph(h,f,n.x,n.y,c),s&&this._isVisible(c.minZoom,c.maxZoom)){const x=c.bounds;h.metricBoxWrite(x.center[0],x.center[1],x.width,x.height)}}}_placeOnSegment(t,e,s,i,n,r){const a=this._current.inShaping.glyphs,{out:l,inId:h}=this._current,f=this._current.inShaping,c=this._current.zoomLevel,_=t.dx/t.length,d=t.dy/t.length,u=t.x+s*-n*_,p=t.y+s*-n*d,m={x:u,y:p};for(const x of a){const g=x.x>f.bounds.x?r:1-r;if(!(g&&n===1||!g&&n===-1))continue;const S=Math.abs(x.x+x.width/2-f.bounds.x),I=Math.max(0,c+Math.log2(S/s)-.1),v=Math.max(i,c+Math.log2(S/(s+t.length+at)));if(I!==0&&(x.angle=t.angle+(1-r)*Math.PI,x.minZoom=v,x.maxZoom=I,this._writeGlyph(l,h,m.x,m.y,x),r&&this._isVisible(x.minZoom,x.maxZoom))){const P=x.bounds,E=t.x-e.x,z=t.y-e.y;l.metricBoxWrite(P.center[0]+E,P.center[1]+z,P.width,P.height)}}}_writeGlyphs(t,e,s,i,n=this._minZoom){if(s.x<0||s.x>=512||s.y<0||s.y>=512)return;if(i.glyphs.length>0&&(this._borderLineColor||this._backgroundColor)){const c=Xt.load(this._materialKey);c.textureBinding=i.glyphs[0].textureBinding,t.recordStart(e,c.data,this.geometryType,!0),this._writeBackgroundGeometry(t,e,s,i.bounds,i.background),t.recordEnd()}const r=s.x+this._refOffsetX,a=s.y-this._refOffsetY;for(const c of i.glyphs)c.minZoom=n,c.maxZoom=this._maxZoom,this._writeGlyph(t,e,r,a,c);const l=this._refPlacementDirX,h=this._refPlacementDirY,f=i.boundsT;t.metricStart(e,n,r,a,l,h,this._referenceSize,this._materialKey),t.metricBoxWrite(f.center[0],f.center[1],f.width,f.height),t.metricEnd()}_writeVertexCommon(t,e,s,i){const n=this._color,r=this._haloColor,a=A(0,0,this._size,this._haloSize),l=Math.max(i.minZoom,this._minZoom),h=Math.min(i.maxZoom,this._maxZoom),f=A(et(l),et(h),this._outLineLabelAngle,0);t.vertexWrite(s),t.vertexWrite(e),t.vertexWrite(n),t.vertexWrite(r),t.vertexWrite(a),t.vertexWrite(this._refSymbolAndPlacementOffset),t.vertexWrite(f)}_writeBackgroundVertex(t,e,s,i,n,r){const a=A(0,0,this._size,this._haloSize),l=A(0,0,0,0),h=A(et(this._minBackgroundZoom),et(this._maxBackgroundZoom),this._outLineLabelAngle,1);t.vertexWrite(s),t.vertexWrite(e),t.vertexWrite(i),t.vertexWrite(l),t.vertexWrite(a),t.vertexWrite(this._refSymbolAndPlacementOffset),t.vertexWrite(h),t.vertexWrite(n),t.vertexWrite(r),t.vertexEnd()}}const Yt=3.14159265359/180,Ge=8,Ss=o=>class extends o{constructor(...t){super(...t),this.angle=0,this.xOffset=0,this.yOffset=0,this.width=0,this.height=0,this.boundsType="square",this._anchorX=0,this._anchorY=0,this._computedWidth=0,this._computedHeight=0,this._allowBorrowing=!0,this._vertexBoundsScaleX=1,this._vertexBoundsScaleY=1,this.geometryType=C.MARKER}_write(t,e,s,i){const n=e.getDisplayId();t.recordStart(n,this._materialKey,this.geometryType,!0),this._writeGeometry(t,e,n,s,i),t.recordEnd()}_writeGeometry(t,e,s,i,n){if(this._markerPlacement!=null)return this._writePlacedMarkers(t,e,i,n);if(this._allowBorrowing=!0,!n&&e.geometryType==="esriGeometryPoint"){const a=e.getX(),l=e.getY();return!t.hasAggregates&&t.hasPixelBufferEnabled&&(a<0||a>=513||l<0||l>=513)?void 0:this._writeVertices(t,s,this._getPos(a,l),a,l)}const r=n?he(ce(n),2):e.geometryType==="esriGeometryPolygon"?e.readCentroid():e.readGeometryForDisplay();if(r!=null){if(r.isPoint){const[a,l]=r.coords;return!t.hasAggregates&&t.hasPixelBufferEnabled&&(a<0||a>=512||l<0||l>=512)?void 0:this._writeVertices(t,s,this._getPos(a,l),a,l)}r.forEachVertex((a,l)=>{const h=nt*2;a<-h||a>=h||l<-h||l>=h||this._writeVertices(t,s,this._getPos(a,l),a,l)})}}_writePlacedMarkers(t,e,s,i){i&&cs(i);const n=i?fs(i):_s(e.readGeometryForDisplay(),e.geometryType??null,!0),r=ys.getPlacement(n,this._markerPlacement,y(1),t.tileKey,s.geometryEngine);if(!r)return;this._allowBorrowing=e.geometryType!=="esriGeometryPolygon";const a=e.getDisplayId(),l=re(),h=Dt(),f=-128,c=640;let _=r.next();for(;_!=null;){const d=_.tx,u=-_.ty;d>=f&&d<=c&&u>=f&&u<=c&&(this._applyTransformation(h,l,-_.getAngle()/Yt),this._writeVertices(t,a,this._getPos(d,u),d,u)),_=r.next()}}_writeVertices(t,e,s,i,n){const r=ae.load(this._materialKey);switch(r.symbologyType){case kt.HEATMAP:return this._writeHeatmapVertices(t,e,s);default:return this._writeMarkerVertices(t,e,r,s,i,n)}}_writeMarkerVertices(t,e,s,i,n,r){const a=s.vvRotation,l=t.vertexCount();let h=this._computedWidth*this._vertexBoundsScaleX,f=this._computedHeight*this._vertexBoundsScaleY;if(this.angle){const c=Math.max(h,f);h=c,f=c}if(a){const c=Math.max(this.xOffset,this.yOffset);h+=c,f+=c}this._allowBorrowing&&t.vertexBounds(n+this.xOffset,r-this.yOffset,h,f),t.vertexWrite(i),t.vertexWrite(this._offsetUpperLeft),t.vertexWrite(this._texUpperLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetUpperRight),t.vertexWrite(this._texUpperRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomLeft),t.vertexWrite(this._texBottomLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomRight),t.vertexWrite(this._texBottomRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),this._writeIndices(t,l)}_writeHeatmapVertices(t,e,s){const i=t.vertexCount();t.vertexWrite(s),t.vertexWrite(this._offsetUpperLeft),t.vertexWrite(e),t.vertexEnd(),t.vertexWrite(s),t.vertexWrite(this._offsetUpperRight),t.vertexWrite(e),t.vertexEnd(),t.vertexWrite(s),t.vertexWrite(this._offsetBottomLeft),t.vertexWrite(e),t.vertexEnd(),t.vertexWrite(s),t.vertexWrite(this._offsetBottomRight),t.vertexWrite(e),t.vertexEnd(),this._writeIndices(t,i)}_writeIndices(t,e){t.indexWrite(e+0),t.indexWrite(e+1),t.indexWrite(e+2),t.indexWrite(e+1),t.indexWrite(e+3),t.indexWrite(e+2)}_applyTransformation(t,e,s=0){s?qe(t,Yt*s):Ds(t),Fs(t,t,ks(this.xOffset,-this.yOffset)),this.angle&&Vs(t,t,Yt*this.angle);const i=this._computedWidth,n=this._computedHeight,r=-(.5+this._anchorX)*i,a=-(.5-this._anchorY)*n;wt(e,r,a),St(e,e,t),this._offsetUpperLeft=M(e[0]*16,e[1]*16),wt(e,r+i,a),St(e,e,t),this._offsetUpperRight=M(e[0]*16,e[1]*16),wt(e,r,a+n),St(e,e,t),this._offsetBottomLeft=M(e[0]*16,e[1]*16),wt(e,r+i,a+n),St(e,e,t),this._offsetBottomRight=M(e[0]*16,e[1]*16)}_computeSize(t,e,s,i,n,r,a,l){const h=t*s,f=e*s;if(!!r.sdf&&!a){const P=l&&t>e?h:t,E=e,N=i+2*1;t=Math.min(P+N,h),e=Math.min(E+N,f)}else t=h,e=f;const _=qs/Math.max(h,f),d=.5*(h-t)*_,u=.5*(f-e)*_,p=r.rect.x+R+d,m=r.rect.y+R+u,x=p+r.width-2*d,g=m+r.height-2*u,w=Math.floor(p),S=Math.floor(m),I=Math.ceil(x),v=Math.ceil(g);t*=(I-w)/(x-p),e*=(v-S)/(g-m),this._texUpperLeft=M(w,S),this._texUpperRight=M(I,S),this._texBottomLeft=M(w,v),this._texBottomRight=M(I,v),this._anchorX*=h/t,this._anchorY*=f/e,t*=n,e*=n,this._computedWidth=t,this._computedHeight=e}_getPos(t,e){return M(Math.round(Ge*t),Math.round(Ge*e))}};class L extends Ss(Mt){constructor(t,e,s,i,n,r,a,l,h,f,c,_,d,u,p,m,x,g,w,S,I,v,P,E){super(),this.angle=i,this.height=a,this.width=r,this.xOffset=e*w,this.yOffset=s*w,this._markerPlacement=S,this._effects=I,this._anchorX=m,this._anchorY=x,this._minMaxZoom=M(Math.round(v*O),Math.round(P*O));const z=(u===Z.MAP?ts:es)|(c?Q:0)|(d?$s:0)|(_?ss:0),N=p&&p.sdf,q=ae.load(t);q.sdf=N,q.pattern=!0,q.textureBinding=p.textureBinding,this._materialKey=q.data,this._fillColor=n,this._outlineColor=h,this._sizeOutlineWidth=A(Math.round(Math.min(Math.sqrt(r*128),255)),Math.round(Math.min(Math.sqrt(a*128),255)),Math.round(Math.min(Math.sqrt(f*128),255)),Math.round(Math.min(Math.sqrt(l*128),255))),q.symbologyType===kt.PIE_CHART?(r*=g*w,a*=g*w,this._computedWidth=r,this._computedHeight=a,this._texUpperLeft=M(0,1),this._texUpperRight=M(1,1),this._texBottomLeft=M(0,0),this._texBottomRight=M(1,0)):this._computeSize(r,a,g,f,w,p,q.hasSizeVV(),E);const As=Math.round(g*64);this._bitestAndDistRatio=M(z,As);const zs=re(),Ws=Dt();this._applyTransformation(Ws,zs)}static fromCIMMarker(t,e,s){const i=e&&e.width||1,n=e&&e.height||1,r=t.size,a=t.scaleX,l=i/n*a,h=t.scaleSymbolsProportionally&&t.frameHeight?r/t.frameHeight:1,f=b(t.color),c=b(t.outlineColor),_=y(r),d=_*l,u=y(t.offsetX||0),p=y(t.offsetY||0),m=y(t.outlineWidth||0)*h,x=t.alignment||Z.SCREEN,g=y(t.referenceSize),[w,S]=tt(t.scaleInfo,s);let I=t.rotation||0;t.rotateClockwise||(I=-I);let v=0,P=0;const E=t.anchorPoint;E&&(t.isAbsoluteAnchorPoint?r&&(v=E.x/(r*l),P=E.y/r):(v=E.x,P=E.y));const z=new L(t.materialKey,u,p,I,f,d,_,g,c,m,t.colorLocked,t.scaleSymbolsProportionally,!1,x,e,v,P,t.sizeRatio,t.scaleFactor??1,t.markerPlacement,t.effects,w,S,!0);return z._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/d:1,z._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/_:1,z}static fromPictureMarker(t,e){const s=Math.round(y(t.width)),i=Math.round(y(t.height)),n=is,r=Math.round(y(t.xoffset||0)),a=Math.round(y(t.yoffset||0)),l=new L(t.materialKey,r,a,t.angle,n,s,i,i,0,0,!1,!1,!1,Z.SCREEN,e,0,0,1,1,null,null,X,K,!1);return l._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/t.width:1,l._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/t.height:1,l}static fromSimpleMarker(t,e){const s=t.style,i=k(t.color),n=Math.round(y(t.size));let r=n;s==="esriSMSTriangle"&&(r*=e.height/e.width);const a=Math.round(y(t.xoffset||0)),l=Math.round(y(t.yoffset||0)),h=t.outline,f=((h==null?void 0:h.color)&&k(h.color))|0,c=((h==null?void 0:h.width)&&Math.round(y(h.width)))|0,_=new L(t.materialKey,a,l,t.angle??0,i,n,r,r,f,c,!1,!1,s==="esriSMSCross"||s==="esriSMSX",Z.SCREEN,e,0,0,124/62,1,null,null,X,K,!1);return _.boundsType=s==="esriSMSCircle"?"circle":"square",_._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/t.size:1,_._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/t.size:1,_}static fromLineSymbolMarker(t,e){const s=k(t.color),i=6,n=Math.round(y(i*t.lineWidth)),r=n,a=t.style==="cross"||t.style==="x";let l;switch(t.placement){case"begin-end":l=vt.Both;break;case"begin":l=vt.JustBegin;break;case"end":l=vt.JustEnd;break;default:l=vt.None}const h={type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:l,offsetAlongLine:0},f=new L(t.materialKey,0,0,0,s,n,r,r/i,s,a?Math.round(y(t.lineWidth)):0,!1,!1,a,Z.MAP,e,0,0,124/62,1,h,null,X,K,!1);return f.boundsType=t.style==="circle"?"circle":"square",f}}function Yi(o,t,e,s,i,n,r){se=0;const a=(s-e)*n,l=i&&i.length,h=l?(i[0]-e)*n:a;let f=vs(t,e,s,0,h,n,!0);if(!f||f.next===f.prev)return;let c,_,d,u,p;if(l&&(f=$i(t,e,s,i,f,n)),a>80*n){c=d=t[0+e*n],_=u=t[1+e*n];for(let m=n;m<h;m+=n){const x=t[m+e*n],g=t[m+1+e*n];c=Math.min(c,x),_=Math.min(_,g),d=Math.max(d,x),u=Math.max(u,g)}p=Math.max(d-c,u-_),p=p!==0?1/p:0}mt(f,o,n,c,_,p,r,0)}function vs(o,t,e,s,i,n,r){let a;if(r===sn(o,t,e,s,i,n)>0)for(let l=s;l<i;l+=n)a=Ne(l+t*n,o[l+t*n],o[l+1+t*n],a);else for(let l=i-n;l>=s;l-=n)a=Ne(l+t*n,o[l+t*n],o[l+1+t*n],a);return a&&it(a,a.next)&&(gt(a),a=a.next),a}function xt(o,t=o){if(!o)return o;let e=o,s;do if(s=!1,!e.steiner&&(it(e,e.next)||W(e.prev,e,e.next)===0)){if(gt(e),e=t=e.prev,e===e.next)break;s=!0}else e=e.next;while(s||e!==t);return t}function mt(o,t,e,s,i,n,r,a){if(!o)return;!a&&n&&(o=Ts(o,s,i,n));let l=o;for(;o.prev!==o.next;){const h=o.prev,f=o.next;if(n?ji(o,s,i,n):Ui(o)){t.push(h.index/e+r),t.push(o.index/e+r),t.push(f.index/e+r),gt(o),o=f.next,l=f.next;continue}if(o=f,o===l){a?a===1?(o=rn(o,t,e,r),mt(o,t,e,s,i,n,r,2)):a===2&&on(o,t,e,s,i,n,r):mt(xt(o),t,e,s,i,n,r,1);break}}}function Ui(o){const t=o.prev,e=o,s=o.next;if(W(t,e,s)>=0)return!1;let i=o.next.next;const n=i;let r=0;for(;i!==o.prev&&(r===0||i!==n);){if(r++,ht(t.x,t.y,e.x,e.y,s.x,s.y,i.x,i.y)&&W(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function ji(o,t,e,s){const i=o.prev,n=o,r=o.next;if(W(i,n,r)>=0)return!1;const a=i.x<n.x?i.x<r.x?i.x:r.x:n.x<r.x?n.x:r.x,l=i.y<n.y?i.y<r.y?i.y:r.y:n.y<r.y?n.y:r.y,h=i.x>n.x?i.x>r.x?i.x:r.x:n.x>r.x?n.x:r.x,f=i.y>n.y?i.y>r.y?i.y:r.y:n.y>r.y?n.y:r.y,c=te(a,l,t,e,s),_=te(h,f,t,e,s);let d=o.prevZ,u=o.nextZ;for(;d&&d.z>=c&&u&&u.z<=_;){if(d!==o.prev&&d!==o.next&&ht(i.x,i.y,n.x,n.y,r.x,r.y,d.x,d.y)&&W(d.prev,d,d.next)>=0||(d=d.prevZ,u!==o.prev&&u!==o.next&&ht(i.x,i.y,n.x,n.y,r.x,r.y,u.x,u.y)&&W(u.prev,u,u.next)>=0))return!1;u=u.nextZ}for(;d&&d.z>=c;){if(d!==o.prev&&d!==o.next&&ht(i.x,i.y,n.x,n.y,r.x,r.y,d.x,d.y)&&W(d.prev,d,d.next)>=0)return!1;d=d.prevZ}for(;u&&u.z<=_;){if(u!==o.prev&&u!==o.next&&ht(i.x,i.y,n.x,n.y,r.x,r.y,u.x,u.y)&&W(u.prev,u,u.next)>=0)return!1;u=u.nextZ}return!0}function Ne(o,t,e,s){const i=_t.create(o,t,e);return s?(i.next=s.next,i.prev=s,s.next.prev=i,s.next=i):(i.prev=i,i.next=i),i}function gt(o){o.next.prev=o.prev,o.prev.next=o.next,o.prevZ&&(o.prevZ.nextZ=o.nextZ),o.nextZ&&(o.nextZ.prevZ=o.prevZ)}function qi(o){let t=o,e=o;do(t.x<e.x||t.x===e.x&&t.y<e.y)&&(e=t),t=t.next;while(t!==o);return e}function $i(o,t,e,s,i,n){const r=new Array;for(let a=0,l=s.length;a<l;a++){const h=s[a]*n,f=a<l-1?s[a+1]*n:e*n,c=vs(o,t,e,h,f,n,!1);c===c.next&&(c.steiner=!0),r.push(qi(c))}r.sort(nn);for(const a of r)i=Qi(a,i);return i}function Qi(o,t){const e=Ji(o,t);if(!e)return t;const s=Es(e,o);return xt(s,s.next),xt(e,e.next)}function Ji(o,t){let e=t;const s=o.x,i=o.y;let n=-1/0,r;do{if(i<=e.y&&i>=e.next.y&&e.next.y!==e.y){const _=e.x+(i-e.y)*(e.next.x-e.x)/(e.next.y-e.y);if(_<=s&&_>n){if(n=_,_===s){if(i===e.y)return e;if(i===e.next.y)return e.next}r=e.x<e.next.x?e:e.next}}e=e.next}while(e!==t);if(!r)return null;if(s===n)return r.prev;const a=r,l=r.x,h=r.y;let f=1/0,c;for(e=r.next;e!==a;)s>=e.x&&e.x>=l&&s!==e.x&&ht(i<h?s:n,i,l,h,i<h?n:s,i,e.x,e.y)&&(c=Math.abs(i-e.y)/(s-e.x),(c<f||c===f&&e.x>r.x)&&yt(e,o)&&(r=e,f=c)),e=e.next;return r}function Ts(o,t,e,s){let i;for(;i!==o;i=i.next){if(i=i||o,i.z===null&&(i.z=te(i.x,i.y,t,e,s)),i.prev.next!==i||i.next.prev!==i)return i.prev.next=i,i.next.prev=i,Ts(o,t,e,s);i.prevZ=i.prev,i.nextZ=i.next}return o.prevZ.nextZ=null,o.prevZ=null,tn(o)}function tn(o){let t,e=1;for(;;){let s=o,i;o=null,t=null;let n=0;for(;s;){n++,i=s;let r=0;for(;r<e&&i;r++)i=i.nextZ;let a=e;for(;r>0||a>0&&i;){let l;r===0?(l=i,i=i.nextZ,a--):a===0||!i||s.z<=i.z?(l=s,s=s.nextZ,r--):(l=i,i=i.nextZ,a--),t?t.nextZ=l:o=l,l.prevZ=t,t=l}s=i}if(t.nextZ=null,e*=2,n<2)return o}}function W(o,t,e){return(t.y-o.y)*(e.x-t.x)-(t.x-o.x)*(e.y-t.y)}function Is(o,t,e,s){return it(o,t)&&it(e,s)||it(o,s)&&it(e,t)?!0:W(o,t,e)>0!=W(o,t,s)>0&&W(e,s,o)>0!=W(e,s,t)>0}function en(o,t){let e=o;do{if(e.index!==o.index&&e.next.index!==o.index&&e.index!==t.index&&e.next.index!==t.index&&Is(e,e.next,o,t))return!0;e=e.next}while(e!==o);return!1}function sn(o,t,e,s,i,n){let r=0;for(let a=s,l=i-n;a<i;a+=n)r+=(o[l+t*n]-o[a+t*n])*(o[a+1+t*n]+o[l+1+t*n]),l=a;return r}function ht(o,t,e,s,i,n,r,a){return(i-r)*(t-a)-(o-r)*(n-a)>=0&&(o-r)*(s-a)-(e-r)*(t-a)>=0&&(e-r)*(n-a)-(i-r)*(s-a)>=0}function yt(o,t){return W(o.prev,o,o.next)<0?W(o,t,o.next)>=0&&W(o,o.prev,t)>=0:W(o,t,o.prev)<0||W(o,o.next,t)<0}function te(o,t,e,s,i){return o=32767*(o-e)*i,t=32767*(t-s)*i,o=(o|o<<8)&16711935,o=(o|o<<4)&252645135,o=(o|o<<2)&858993459,o=(o|o<<1)&1431655765,t=(t|t<<8)&16711935,t=(t|t<<4)&252645135,t=(t|t<<2)&858993459,t=(t|t<<1)&1431655765,o|t<<1}function it(o,t){return o.x===t.x&&o.y===t.y}function nn(o,t){return o.x-t.x}function rn(o,t,e,s){let i=o;do{const n=i.prev,r=i.next.next;!it(n,r)&&Is(n,i,i.next,r)&&yt(n,r)&&yt(r,n)&&(t.push(n.index/e+s),t.push(i.index/e+s),t.push(r.index/e+s),gt(i),gt(i.next),i=o=r),i=i.next}while(i!==o);return i}function on(o,t,e,s,i,n,r){let a=o;do{let l=a.next.next;for(;l!==a.prev;){if(a.index!==l.index&&an(a,l)){let h=Es(a,l);a=xt(a,a.next),h=xt(h,h.next),mt(a,t,e,s,i,n,r,0),mt(h,t,e,s,i,n,r,0);return}l=l.next}a=a.next}while(a!==o)}function an(o,t){return o.next.index!==t.index&&o.prev.index!==t.index&&!en(o,t)&&yt(o,t)&&yt(t,o)&&ln(o,t)}function ln(o,t){let e=o,s=!1;const i=(o.x+t.x)/2,n=(o.y+t.y)/2;do e.y>n!=e.next.y>n&&e.next.y!==e.y&&i<(e.next.x-e.x)*(n-e.y)/(e.next.y-e.y)+e.x&&(s=!s),e=e.next;while(e!==o);return s}function Es(o,t){const e=_t.create(o.index,o.x,o.y),s=_t.create(t.index,t.x,t.y),i=o.next,n=t.prev;return o.next=t,t.prev=o,e.next=i,i.prev=e,s.next=e,e.prev=s,n.next=s,s.prev=n,s}class _t{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(t,e,s){const n=se<ee.length?ee[se++]:new _t;return n.index=t,n.x=e,n.y=s,n.prev=null,n.next=null,n.z=null,n.prevZ=null,n.nextZ=null,n.steiner=!1,n}}const ee=new Array,hn=8096;let se=0;for(let o=0;o<hn;o++)ee.push(new _t);const cn=1e-5,st=new us(0,0,0,1,0),ie=new us(0,0,0,1,0);st.setExtent(nt);ie.setExtent(nt);function Ze(o,t,e){let s=0;for(let i=1;i<e;i++){const n=o[2*(t+i-1)],r=o[2*(t+i-1)+1],a=o[2*(t+i)],l=o[2*(t+i)+1],h=(a-n)*(l+r);s+=h}return s}function fn(o,t,e,s,i){let n=0;const r=2;for(let a=e;a<s;a+=3){const l=(o[a]-i)*r,h=(o[a+1]-i)*r,f=(o[a+2]-i)*r;n+=Math.abs((t[l]-t[f])*(t[h+1]-t[l+1])-(t[l]-t[h])*(t[f+1]-t[l+1]))}return n}function _n(o,t){const{coords:e,lengths:s,hasIndeterminateRingOrder:i}=t,n=0,r=o;if(i)return!1;let a=0;for(let l=0;l<s.length;){let h=l,f=s[l],c=Ze(e,a,f);const _=[];for(;++h<s.length;){const x=s[h],g=Ze(e,a+f,x);if(!(g>0))break;c+=g,_.push(a+f),f+=x}const d=r.length;Yi(r,e,a,a+f,_,2,n);const u=fn(r,e,d,r.length,n),p=Math.abs(c);if(Math.abs((u-p)/Math.max(1e-7,p))>cn)return r.length=0,!1;l=h,a+=f}return!0}function un(o){const{coords:t,lengths:e}=o,{buffer:s}=ri(t,e);return s}function dn(o,t,e){let s=0;for(let i=0;i<o.lengths.length;i++){const n=o.lengths[i];for(let r=0;r<n;r++){const a=o.coords[2*(r+s)],l=o.coords[2*(r+s)+1];if(a<t||a>e||l<t||l>e)return!0}s+=n}return!1}function pn(o,t){if(o==null)return null;if(!dn(o,-128,nt+128))return o;st.setPixelMargin(t),st.reset(ds.Polygon);let e=0;for(let r=0;r<o.lengths.length;r++){const a=o.lengths[r];let l=o.coords[2*(0+e)],h=o.coords[2*(0+e)+1];st.moveTo(l,h);for(let f=1;f<a;f++)l=o.coords[2*(f+e)],h=o.coords[2*(f+e)+1],st.lineTo(l,h);st.close(),e+=a}const s=st.result(!1);if(!s)return null;const i=[],n=[];for(const r of s){let a=0;for(const l of r)n.push(l.x),n.push(l.y),a++;i.push(a)}return new Mi(i,n)}function xn(o,t){ie.setPixelMargin(t);const e=ie,s=-t,i=nt+t;let n=[],r=!1,a=0;for(;a<o.length;){const l=[],h=o[a];if(!h)return null;e.reset(ds.LineString);let[f,c]=h[0];if(r)e.moveTo(f,c);else{if(f<s||f>i||c<s||c>i){r=!0;continue}l.push({x:f,y:c})}let _=!1;const d=h.length;for(let u=1;u<d;++u)if(f+=h[u][0],c+=h[u][1],r)e.lineTo(f,c);else{if(f<s||f>i||c<s||c>i){_=!0;break}l.push({x:f,y:c})}if(_){r=!0;continue}if(r){const u=e.resultWithStarts();if(u)for(const p of u)n.push(p)}else n.push({line:l,start:0});a++,r=!1}return n=n.filter(l=>l.line.length>1),n.length===0?null:n}const Ot=8,D=16,Le=256*256-1,Ps=o=>class extends o{constructor(...t){super(...t),this.tessellationProperties={},this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0},this.geometryType=C.LINE}writeGeometry(t,e,s,i){this._writeGeometry(t,e,s,i)}_initializeTessellator(t){const e=bt.load(this._materialKey),s=ct.load(this._materialKey),i=this._tessellationOptions,n=e.vvSizeFieldStops||e.vvSizeMinMaxValue||e.vvSizeScaleStops||e.vvSizeUnitValue,a=this.tessellationProperties._halfWidth<Qs&&!t&&!n;this.tessellationProperties.minMaxZoom=this._minMaxZoom,i.wrapDistance=Le,i.textured=this._isDashed||this._hasPattern,i.offset=this.tessellationProperties.offset,i.halfWidth=this.tessellationProperties._halfWidth;const l=a?0:1,h=At(s)?gn:mn;this._lineTessellator=new oi(h(this.tessellationProperties,l,l),yn(this.tessellationProperties),a)}_write(t,e,s,i){const n=e.geometryType==="esriGeometryPoint";t.recordStart(e.getDisplayId(),this._materialKey,this.geometryType,n),this._writeGeometry(t,e,i,n),t.recordEnd()}_writeGeometry(t,e,s,i){const n=s??e.readLegacyGeometryForDisplay(),r=this._getLines(n,i);r!=null&&this._writeVertices(t,e,r)}_getLines(t,e){if(t==null)return null;const s=t.paths||t.rings;return s==null?null:xn(s,e?256:16)}_writeVertices(t,e,s){const i=e.getDisplayId(),n=t.vertexCount(),r=this.tessellationProperties,a=this._tessellationOptions;r.out=t,r.id=i,r.indexCount=0,r.vertexCount=0,r.offset=n,a.capType=this._capType,a.joinType=this._joinType;const l=ct.load(this._materialKey);this.tessellationProperties.key=At(l)?l:bt.load(this._materialKey);for(const{line:h,start:f}of s)a.initialDistance=f%Le,this._lineTessellator.tessellate(h,a)}},mn=(o,t,e)=>(s,i,n,r,a,l,h,f,c,_,d)=>{const u=M(d,Math.ceil(D*o._halfWidth)),p=A(Math.round(D*h),Math.round(D*f),Math.round(D*c),Math.round(D*_)),m=A(D*a,D*l,0,o._bitset),x=o.out;return x.vertexBounds(s,i,t,e),x.vertexWrite(M(Ot*s,Ot*i)),x.vertexWrite(o.id),x.vertexWrite(o._fillColor),x.vertexWrite(p),x.vertexWrite(u),x.vertexWrite(o._tl),x.vertexWrite(o._br),x.vertexWrite(m),x.vertexWrite(M(Math.ceil(D*o._halfReferenceWidth),0)),x.vertexWrite(o.minMaxZoom),x.vertexEnd(),o.offset+o.vertexCount++},gn=(o,t,e)=>(s,i,n,r,a,l,h,f,c,_,d)=>{const u=M(D*o._halfWidth,D*o._halfReferenceWidth),p=A(D*h+128,D*f+128,D*c+128,D*_+128),m=o.out,x=o._bitset<<24|o.id;m.vertexBounds(s,i,t,e),m.vertexWrite(M(Ot*s,Ot*i)),m.vertexWrite(x),m.vertexWrite(o._fillColor);const g=hs(o.key);return g||(m.vertexWrite(0),m.vertexWrite(0)),m.vertexWrite(0),m.vertexWrite(u),m.vertexWrite(p),g||m.vertexWrite(o.minMaxZoom),m.vertexEnd(),o.offset+o.vertexCount++},yn=o=>(t,e,s)=>{const i=o.out;i.indexWrite(t),i.indexWrite(e),i.indexWrite(s),o.indexCount+=3};class U extends Ps(Mt){constructor(t,e,s,i,n,r,a,l,h,f,c,_,d,u,p,m,x,g,w,S){super();const I=bt.load(t);e&&(I.sdf=e.sdf,I.pattern=!0,I.textureBinding=e.textureBinding),this._capType=i,this._joinType=n,this._miterLimitCosine=Jt(r),this.tessellationProperties._fillColor=a,this.tessellationProperties._tl=l,this.tessellationProperties._br=h,this._hasPattern=f,this._isDashed=c,this._zOrder=x,this._effects=g,this._minMaxZoom=M(Math.round(w*O),Math.round(S*O)),this._materialKey=I.data;const v=u?Js:0,P=d?Q:0,E=_?ns:0,z=p?Ft:0,N=P|v|E|z;this.tessellationProperties._bitset=N,this.tessellationProperties._halfWidth=.5*s,this.tessellationProperties._halfReferenceWidth=.5*m,this.tessellationProperties.offset=0,this._initializeTessellator(!1)}static fromCIMLine(t,e,s){const i=t.color,n=t.scaleFactor||1,r=!!t.dashTemplate;let a=t.cap;r&&a===Te.ROUND&&(a=Te.SQUARE);const l=t.join,h=y(t.width)*n,f=y(t.referenceWidth),c=y(t.miterLimit),_=i&&b(i)||0,[d,u]=tt(t.scaleInfo,s),p=!1;if(!e)return new U(t.materialKey,e,h,a,l,c,_,0,0,!1,r,t.scaleDash??!1,t.colorLocked??!1,p,t.sampleAlphaOnly,f,t.zOrder,t.effects,d,u);const{rect:m,width:x,height:g}=e,w=m.x+R,S=m.y+R,I=w+x,v=S+g,P=M(w,S),E=M(I,v),z=!1;return new U(t.materialKey,e,h,a,l,c,_,P,E,!0,r,t.scaleDash??!1,t.colorLocked??!1,z,t.sampleAlphaOnly,f,t.zOrder,t.effects,d,u)}static fromFillOutline(t){var s;const e=ct.load(t.materialKey);return!At(e)||!t.outline||((s=t.outline)==null?void 0:s.style)!=="esriSLSSolid"?null:U.fromSimpleLine({hash:"",materialKey:t.materialKey,...t.outline},null,!0)}static fromSimpleLine(t,e,s=!1){const{color:i}=t,n=t.style!=="esriSLSSolid"&&t.style!=="esriSLSNull",r=si(t.cap||"round"),a=ii(t.join||"round");let l=i&&t.style!=="esriSLSNull"&&k(i)||0;t.style==="esriSLSNull"&&(l=0);const h=y(t.width),f=t.miterLimit;if(!e)return new U(t.materialKey,e,h,r,a,f,l,0,0,!1,n,!0,!1,s,!1,h,0,null,X,K);const{rect:c,width:_,height:d}=e,u=c.x+R,p=c.y+R,m=u+_,x=p+d,g=M(u,p),w=M(m,x);return new U(t.materialKey,e,h,r,a,f,l,g,w,!0,n,!0,!1,s,!1,h,0,null,X,K)}static fromPictureLineSymbol(t,e,s,i){return ut.getLogger("esri.views.2d.engine.webgl.WGLLineTemplate").error("PictureLineSymbol support does not exist!"),null}}const Mn=100,Xe=1,Cs=o=>class extends o{constructor(...t){super(...t),this.forceLibtess=!1,this._bitset=0,this._lineTemplate=null,this.geometryType=C.FILL}_maybeAddLineTemplate(t){this._lineTemplate=U.fromFillOutline(t)}_write(t,e,s,i){const n=e.geometryType==="esriGeometryPoint",r=ct.load(this._materialKey);t.recordStart(e.getDisplayId(),this._materialKey,this.geometryType,n),this._writeGeometry(t,e,r,i,n),At(r)&&this._lineTemplate!=null&&this._lineTemplate.writeGeometry(t,e,i,n),t.recordEnd()}_writeGeometry(t,e,s,i,n){const r=this._getGeometry(e,i,n);if(r==null)return;const a=r.maxLength>Mn,l=[];if(!a&&!this.forceLibtess&&_n(l,r)){l.length&&this._writeVertices(t,e,r.coords,r.lengths,s,l);return}const h=un(r);this._writeVertices(t,e,h,[h.length/2],s)}_writeVertex(t,e,s,i,n,r){const a=M(Xe*i,Xe*n);if(t.vertexBounds(i,n,0,0),t.vertexWrite(a),t.vertexWrite(e),s.symbologyType===kt.DOT_DENSITY)t.vertexWriteF32(1/Math.abs(r.readGeometryArea()));else{t.vertexWrite(this.fillColor);const l=hs(s);l||(t.vertexWrite(this.tl),t.vertexWrite(this.br)),t.vertexWrite(this.aux21),t.vertexWrite(this.aux22),t.vertexWrite(this.aux3),l||t.vertexWrite(this._minMaxZoom)}}_writeVertices(t,e,s,i,n,r){const a=e.getDisplayId(),h=this._bitset<<24|a,f=i.reduce((u,p)=>u+p),c=qt(n.geometryType,n.symbologyType).geometry/4,_=t.vertexCount();t.vertexEnsureSize(c*f);let d=0;if(r)for(const u of r){const p=s[u*2],m=s[u*2+1];this._writeVertex(t,h,n,p,m,e),d++}else for(let u=0;u<s.length;u+=2){const p=Math.round(s[u]),m=Math.round(s[u+1]);this._writeVertex(t,h,n,p,m,e),d++}t.indexEnsureSize(d);for(let u=0;u<d;u++)t.indexWrite(u+_)}_getGeometry(t,e,s){const i=e?he(ce(e),2):t.readGeometryForDisplay();return i?pn(i,s?256:8):null}},Ke=ut.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");class Lt extends Mt{constructor(t){super(),this._ongoingMaterialRequestMap=new Map,this._materialCache=new Map,this._dynamicPropertyMap=new Map,this._cimLayer=t}async analyze(t,e,s,i,n){if(n&&n.length===0)return null;const r=n&&n.length>0,a=e.readLegacyFeature(),l=e.getObjectId(),h=this._materialCache,f=this._cimLayer.materialHash;if(!f)return Ke.error("A Dynamic mesh template must have a material hash value or function!"),null;const c=typeof f=="function"?f(a,s,i,l):f,_=h.get(c);if(_!=null)return _;const d=this._ongoingMaterialRequestMap.get(c);if(d)return d;const u=this._cimLayer,p=xi(u.cim,this._cimLayer.materialOverrides);p.mosaicHash=c;const{type:m,url:x}=u,g={cim:p,type:m,mosaicHash:c,url:x,size:null,dashTemplate:null,text:null,fontName:null,objectId:l,animatedSymbolProperties:null};switch(m){case"marker":g.size=Tt(u.size,a,s,i),g.animatedSymbolProperties=Tt(u.animatedSymbolProperties,a,s,i);break;case"line":g.dashTemplate=u.dashTemplate;break;case"text":g.text=Tt(u.text,a,s,i),g.fontName=Tt(u.fontName,a,s,i)}const w=t.getMosaicItem(g,n).then(S=>(r||(this._ongoingMaterialRequestMap.delete(c),h.set(c,S)),S)).catch(S=>(this._ongoingMaterialRequestMap.delete(c),Ke.error(".analyze()",S.message),null));return r||this._ongoingMaterialRequestMap.set(c,w),w}}const He=128;class pe extends Cs(Lt){constructor(t,e,s){var f;if(super(t),this._minMaxZoom=M(Math.round(e*O),Math.round(s*O)),T(t.color)){const c=(_,d,u)=>{const p=t.color(_,d,u);return p&&b(p)||0};this._dynamicPropertyMap.set("fillColor",c)}else{const c=t.color;this.fillColor=c&&b(c)||0}const i=((f=t.cim.placement)==null?void 0:f.type)==="CIMMarkerPlacementInsidePolygon"&&t.cim.placement.shiftOddRows?2:1,n=t.height;if(!T(n))this._height=(n||0)*i;else{const c=(_,d,u)=>n(_,d,u)*i;this._dynamicPropertyMap.set("_height",c)}const r=t.offsetX;if(!T(r))this._offsetX=y(r||0);else{const c=(_,d,u)=>y(r(_,d,u));this._dynamicPropertyMap.set("_offsetX",c)}const a=t.offsetY;if(!T(a))this._offsetY=y(-a||0);else{const c=(_,d,u)=>y(-a(_,d,u));this._dynamicPropertyMap.set("_offsetY",c)}const l=t.scaleX;T(l)?this._dynamicPropertyMap.set("_scaleX",l):this._scaleX=l||1;const h=t.angle;if(!T(h))this._angle=Qt(h)||0;else{const c=(_,d,u)=>Qt(h(_,d,u));this._dynamicPropertyMap.set("_angle",c)}if(t.effects!=null){const c=t.effects;T(c)?this._dynamicPropertyMap.set("_effects",c):this._effects=c}this._cimFillLayer=t,this._bitset=(t.colorLocked?Q:0)|(t.applyRandomOffset?rs:0)|(t.sampleAlphaOnly?Ft:0)|(t.hasUnresolvedReplacementColor?os:0),this._fillMaterialKey=t.materialKey}static fromCIMFill(t,e){const[s,i]=tt(t.scaleInfo,e);return new pe(t,s,i)}bindFeature(t,e,s){const i=t.readLegacyFeature();this._dynamicPropertyMap.forEach((_,d)=>{this[d]=_(i,e,s)});const n=ct.load(this._fillMaterialKey),r=this._materialCache,l=this._cimFillLayer.materialHash,h=l(i,e,s),f=r.get(h);let c=null;if(f&&F(f.spriteMosaicItem)&&(c=f.spriteMosaicItem),c){const{rect:_,width:d,height:u}=c,p=_.x+R,m=_.y+R,x=p+d,g=m+u;let w=Math.round(y(this._height));w<=0&&(w=g-m);let S=Math.round(y(this._height/u*d||0));S<=0&&(S=x-p);const I=this._scaleX,v=1;this.tl=M(p,m),this.br=M(x,g),this.aux21=M(S,w),this.aux22=M(this._offsetX,this._offsetY),this.aux3=A(I*He,v*He,this._angle,0),n.sdf=c.sdf,n.pattern=!0,n.textureBinding=c.textureBinding}else this.tl=0,this.br=0,this.aux21=0,this.aux22=0,this.aux3=0,n.sdf=!1,n.pattern=!1,n.textureBinding=0;this._materialKey=n.data}}class xe extends Ps(Lt){constructor(t,e,s){super(t),this._minMaxZoom=M(Math.round(e*O),Math.round(s*O)),this._cimLineLayer=t;let i=0;T(t.width)||(i=.5*y(t.width));const n=(c,_,d)=>T(t.width)?.5*y(t.width(c,_,d)):i;this._dynamicPropertyMap.set("_halfWidth",n),T(t.cap)?this._dynamicPropertyMap.set("_capType",t.cap):this._capType=t.cap,T(t.join)?this._dynamicPropertyMap.set("_joinType",t.join):this._joinType=t.join;const r=t.color;if(!T(r))this._fillColor=r&&b(r)||0;else{const c=(_,d,u)=>b(r(_,d,u));this._dynamicPropertyMap.set("_fillColor",c)}const a=t.miterLimit;if(!T(a))this._miterLimitCosine=Jt(a);else{const c=(_,d,u)=>Jt(a(_,d,u));this._dynamicPropertyMap.set("_miterLimitCosine",c)}if(t.effects!=null){const c=t.effects;T(c)?this._dynamicPropertyMap.set("_effects",c):this._effects=c}this._scaleFactor=t.scaleFactor||1,this._isDashed=t.dashTemplate!=null;const l=t.colorLocked?Q:0,h=t.scaleDash?ns:0,f=t.sampleAlphaOnly?Ft:0;this.tessellationProperties._bitset=l|h|f,this._materialKey=t.materialKey,this._initializeTessellator(!0)}static fromCIMLine(t,e){const[s,i]=tt(t.scaleInfo,e);return new xe(t,s,i)}bindFeature(t,e,s){const i=t.readLegacyFeature();this._dynamicPropertyMap.forEach((c,_)=>{this[_]=c(i,e,s)}),this._halfWidth*=this._scaleFactor;const n=this._materialCache,r=this._cimLineLayer.materialHash,a=r(i,e,s),l=n.get(a);let h=null;if(l&&F(l.spriteMosaicItem)&&(h=l.spriteMosaicItem),h){this._hasPattern=!0;const{rect:c,width:_,height:d}=h,u=c.x+R,p=c.y+R,m=u+_,x=p+d;this.tessellationProperties._tl=M(u,p),this.tessellationProperties._br=M(m,x)}else this._hasPattern=!1,this.tessellationProperties._tl=0,this.tessellationProperties._br=0;this.tessellationProperties._fillColor=this._fillColor,this.tessellationProperties._halfWidth=this._halfWidth,this.tessellationProperties.offset=0,this.tessellationProperties._halfReferenceWidth=this.tessellationProperties._halfWidth;const f=bt.load(this._materialKey);h&&(f.sdf=h.sdf,f.pattern=!0,f.textureBinding=h.textureBinding),this._materialKey=f.data}}const wn=re(),Sn=Dt();class me extends Ss(Lt){constructor(t,e,s){super(t),this._cimMarkerLayer=t,this._minMaxZoom=M(Math.round(e*O),Math.round(s*O));const i=t.color;if(!T(i))this._fillColor=b(i);else{const _=(d,u,p)=>b(i(d,u,p));this._dynamicPropertyMap.set("_fillColor",_)}const n=t.outlineColor;if(!T(n))this._outlineColor=b(n);else{const _=(d,u,p)=>b(n(d,u,p));this._dynamicPropertyMap.set("_outlineColor",_)}const r=t.size;if(!T(r))this._size=y(r)||0;else{const _=(d,u,p)=>y(r(d,u,p));this._dynamicPropertyMap.set("_size",_)}const a=t.scaleX;T(a)?this._dynamicPropertyMap.set("_scaleX",a):this._scaleX=a;const l=t.offsetX;if(!T(l))this.xOffset=y(l)||0;else{const _=(d,u,p)=>y(l(d,u,p));this._dynamicPropertyMap.set("xOffset",_)}const h=t.offsetY;if(!T(h))this.yOffset=y(h)||0;else{const _=(d,u,p)=>y(h(d,u,p));this._dynamicPropertyMap.set("yOffset",_)}const f=t.outlineWidth;if(!T(f))this._outlineWidth=y(f)||0;else{const _=(d,u,p)=>y(f(d,u,p));this._dynamicPropertyMap.set("_outlineWidth",_)}const c=t.rotation;if(T(c)?this._dynamicPropertyMap.set("_angle",c):this._angle=c||0,t.effects!=null){const _=t.effects;T(_)?this._dynamicPropertyMap.set("_effects",_):this._effects=_}if(t.markerPlacement!=null){const _=t.markerPlacement;T(_)?this._dynamicPropertyMap.set("_markerPlacement",_):this._markerPlacement=_}this._scaleFactor=t.scaleFactor??1,this._bitSet=(t.alignment===Z.MAP?ts:es)|(t.colorLocked?Q:0)|(t.scaleSymbolsProportionally?ss:0),this._materialKey=t.materialKey}static fromCIMMarker(t,e){const[s,i]=tt(t.scaleInfo,e);return new me(t,s,i)}bindFeature(t,e,s){const i=t.readLegacyFeature(),n=t.getObjectId();this._dynamicPropertyMap.forEach((N,q)=>{this[q]=N(i,e,s)});const r=this._cimMarkerLayer.materialHash,a=typeof r=="function"?r(i,e,s,n):r,l=this._materialCache.get(a);if(!l||!F(l.spriteMosaicItem)||!l.spriteMosaicItem){ut.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate").error(new rt("mapview-cim","Encountered an error when binding feature"));return}const h=l.spriteMosaicItem,f=this._cimMarkerLayer.sizeRatio,c=h.width/h.height*this._scaleX,_=ae.load(this._materialKey);_.sdf=h.sdf,_.pattern=!0,_.textureBinding=h.textureBinding,this._materialKey=_.data;const d=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle,u=this._size,p=u*c,m=this.xOffset,x=this.yOffset;this.xOffset*=this._scaleFactor,this.yOffset*=this._scaleFactor;const w=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/y(this._cimMarkerLayer.frameHeight):1,S=this._outlineWidth*w,I=y(this._cimMarkerLayer.referenceSize);let v=0,P=0;const E=this._cimMarkerLayer.anchorPoint;E&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(v=y(E.x)/(this._size*c),P=y(E.y)/this._size):(v=E.x,P=E.y)),this._anchorX=v,this._anchorY=P,this._sizeOutlineWidth=A(Math.round(Math.min(Math.sqrt(p*128),255)),Math.round(Math.min(Math.sqrt(u*128),255)),Math.round(Math.min(Math.sqrt(S*128),255)),Math.round(Math.min(Math.sqrt(I*128),255))),this.angle=d;const z=Math.round(f*64);this._bitestAndDistRatio=M(this._bitSet,z),this._computeSize(p,u,f,S,this._scaleFactor,h,_.hasSizeVV(),!0),this._applyTransformation(Sn,wn),this.xOffset=m,this.yOffset=x}}function bs(o){if(o==null)return[];const t=new Array(o.length);for(let e=0;e<o.length;e++)t[e]=o.charCodeAt(e);return t}const Ye=5;function vn(o,t,e,s){return typeof o.text=="string"?o.text:typeof o.text=="function"?o.text(t,e,s)??"":""}class ge extends Ms(Lt){constructor(t,e,s){super(t),this._horizontalAlignment="center",this._verticalAlignment="middle",this._textToGlyphs=new Map,this._minMaxZoom=M(Math.round(e*O),Math.round(s*O));const i=t.scaleFactor||1;this._cimTextLayer=t;const n=t.color;if(!T(n))this._color=b(n);else{const p=(m,x,g)=>b(n(m,x,g));this._dynamicPropertyMap.set("_color",p)}const r=t.outlineColor;if(!T(r))this._haloColor=b(r);else{const p=(m,x,g)=>b(r(m,x,g));this._dynamicPropertyMap.set("_haloColor",p)}let a;T(t.size)||(a=Math.min(Math.round(y(t.size*t.sizeRatio)),127));const l=(p,m,x)=>T(t.size)?Math.min(Math.round(y(t.size(p,m,x)*t.sizeRatio)),127):a;if(this._dynamicPropertyMap.set("_size",l),!T(t.outlineSize))this._haloSize=Math.min(Math.floor(Ye*y(t.outlineSize*t.sizeRatio)),127);else{const p=(m,x,g)=>Math.min(Math.floor(Ye*y(t.outlineSize(m,x,g)*t.sizeRatio)),127);this._dynamicPropertyMap.set("_haloSize",p)}let h;T(t.offsetX)||(h=Math.round(y(t.offsetX*t.sizeRatio)));const f=(p,m,x)=>T(t.offsetX)?Math.round(y(t.offsetX(p,m,x)*t.sizeRatio)):h;this._dynamicPropertyMap.set("_xOffset",f);let c;T(t.offsetY)||(c=Math.round(y(t.offsetY*t.sizeRatio)));const _=(p,m,x)=>T(t.offsetY)?Math.round(y(t.offsetY(p,m,x)*t.sizeRatio)):c;if(this._dynamicPropertyMap.set("_yOffset",_),T(t.angle)?this._dynamicPropertyMap.set("_angle",t.angle):this._angle=t.angle,T(t.horizontalAlignment)?this._dynamicPropertyMap.set("_horizontalAlignment",t.horizontalAlignment):this._horizontalAlignment=t.horizontalAlignment,T(t.verticalAlignment)?this._dynamicPropertyMap.set("_verticalAlignment",t.verticalAlignment):this._verticalAlignment=t.verticalAlignment,t.effects!=null){const p=t.effects;T(p)?this._dynamicPropertyMap.set("_effects",p):this._effects=p}if(t.markerPlacement!=null){const p=t.markerPlacement;T(p)?this._dynamicPropertyMap.set("_markerPlacement",p):this._textPlacement=p}T(t.text)?this._dynamicPropertyMap.set("_text",t.text):this._text=t.text,this._backgroundColor=t.backgroundColor&&b(t.backgroundColor),this._borderLineColor=t.borderLineColor&&b(t.borderLineColor),this._borderLineSize=t.borderLineWidth,this._scaleFactor=i;const d=Math.min(Math.round(y(t.referenceSize*t.sizeRatio)),127);this._referenceSize=Math.round(Math.sqrt(d*256)),this._materialKey=t.materialKey;const u=ui.load(this._materialKey);u.sdf=!0,this._bitset=(t.alignment===Z.MAP?1:0)|(t.colorLocked?1:0)<<1,this._materialKey=u.data,this._decoration="none",this._lineHeight=1,this._lineWidth=512,this._isCIM=!0}static fromCIMText(t,e){const[s,i]=tt(t.scaleInfo,e);return new ge(t,s,i)}async analyze(t,e,s,i){const n=e.readLegacyFeature(),r=vn(this._cimTextLayer,n,s,i),a=await super.analyze(t,e,s,i,bs(r));return a&&a.glyphMosaicItems&&this._textToGlyphs.set(r,a.glyphMosaicItems),a}bindFeature(t,e,s){const i=t.readLegacyFeature();if(this._dynamicPropertyMap.forEach((r,a)=>{this[a]=r(i,e,s)}),!this._text||this._text.length===0){this._shapingInfo=null;return}this._size*=this._scaleFactor,this._scale=this._size/Je,this._xOffset*=this._scaleFactor,this._yOffset*=this._scaleFactor,this._xAlignD=as(this._horizontalAlignment??"center"),this._yAlignD=ls(this._verticalAlignment??"baseline");const n=this._textToGlyphs.get(this._text)??[];this.bindTextInfo(n,!1)}}const lt=128;class j extends Cs(Mt){constructor(t,e,s,i,n,r,a,l,h,f,c,_,d,u,p,m){super(),this._effects=u;const x=ct.load(t);e&&(x.sdf=e.sdf,x.pattern=!0,x.textureBinding=e.textureBinding),this.fillColor=s,this.tl=i,this.br=n,this.aux21=M(r,a),this.aux22=M(l,h),this.aux3=A(f,c,_,0),this._bitset=d,this._minMaxZoom=M(Math.round(p*O),Math.round(m*O)),this._materialKey=x.data}static fromCIMFill(t,e,s){const i=t.color,n=i&&b(i)||0,r=t.materialKey,[a,l]=tt(t.scaleInfo,s),h=(t.colorLocked?Q:0)|(t.applyRandomOffset?rs:0)|(t.sampleAlphaOnly?Ft:0)|(t.hasUnresolvedReplacementColor?os:0);if(!e)return new j(r,null,n,0,0,0,0,0,0,0,0,0,h,t.effects,a,l);const{rect:f,width:c,height:_}=e,d=t.scaleX||1,u=f.x+R,p=f.y+R,m=u+c,x=p+_,g=y(t.height);let w=d*g;t.cim.type==="CIMHatchFill"&&(w*=c/_);let S=Math.round(g);S<=0&&(S=x-p);let I=Math.round(w);I<=0&&(I=m-u);const v=y(t.offsetX||0),P=y(-t.offsetY||0),E=M(u,p),z=M(m,x);return new j(r,e,n,E,z,I,S,v,P,lt,lt,Qt(t.angle),h,t.effects,a,l)}static fromSimpleFill(t,e,s=!1){const{color:i}=t,n=i&&t.style!=="esriSFSNull"&&k(i)||0,r=s?Q:0,a=t.materialKey;let l;if(!e)l=new j(a,null,n,0,0,0,0,0,0,0,0,0,r,null,X,K);else{const{rect:h,width:f,height:c,pixelRatio:_}=e,d=h.x+R,u=h.y+R,p=d+f,m=u+c,x=M(d,u),g=M(p,m);l=new j(a,e,n,x,g,f/_,c/_,0,0,lt,lt,0,r,null,X,K)}return l._maybeAddLineTemplate(t),l}static fromPictureFill(t,e,s=!1){const i=is,{rect:n,width:r,height:a}=e,l=n.x+R,h=n.y+R,f=l+r,c=h+a,_=M(l,h),d=M(f,c),u=Math.round(y(t.width)),p=Math.round(y(t.height)),m=y(t.xoffset),x=y(-t.yoffset),g=t.materialKey,w=s?Q:0,S=new j(g,e,i,_,d,u,p,m,x,lt*t.xscale,lt*t.yscale,0,w,null,X,K);return S._maybeAddLineTemplate(t),S}}class Tn{constructor(){this._resolver=null}isHeld(){return!!this._resolver}async acquire(){if(!this._resolver){this._resolver=Gs();return}await this._resolver.promise,await this.acquire()}release(){const t=this._resolver;this._resolver=null,t==null||t.resolve()}}async function In(o,t,e){try{await o.acquire(),await t(e),o.release()}catch(s){throw o.release(),s}}async function En(o,t,e){if(!o.name)throw new rt("style-symbol-reference-name-missing","Missing name in style symbol reference");if(o.styleName&&o.styleName==="Esri2DPointSymbolsStyle")return Pn(o,e);try{const s=await Ti(o,t,e);return Cn(s,o.name,t,e)}catch(s){return oe(s),null}}async function Pn(o,t){const e=Ii.replace(/\{SymbolName\}/gi,o.name);try{const s=await ps(e,t);return xs(s.data)}catch(s){return oe(s),null}}async function Cn(o,t,e,s){const i=o.data,n={portal:e&&e.portal!=null?e.portal:Ns.getDefault(),url:Zs(o.baseUrl),origin:"portal-item"},r=i.items.find(l=>l.name===t);if(!r){const l=`The symbol name '${t}' could not be found`;throw new rt("symbolstyleutils:symbol-name-not-found",l,{symbolName:t})}let a=Ls(Ei(r,"cimRef"),n);Si()&&(a=vi(a));try{const l=await ps(a,s);return xs(l.data)}catch(l){return oe(l),null}}const Ue=async(o,t,e)=>{const s=new gi(e,t);return new mi(await s.analyzeSymbolReference(o.data,!1),o.data,o.rendererKey,o.maxVVSize)};async function H(o,t,e,s){if(!o)return null;if(o.type==="cim")return Ue(o,t,e);if(o.type==="web-style"){const i={type:"cim",data:await En(o,null,s)??void 0,rendererKey:o.rendererKey,maxVVSize:o.maxVVSize};return Ue(i,t,e)}return o}function Ct(o){if(!o)return null;const{avoidSDFRasterization:t,type:e,cim:s,url:i,materialHash:n}=o,r={cim:s,type:e,mosaicHash:n,url:i,size:null,dashTemplate:null,path:null,text:null,fontName:null,animatedSymbolProperties:null,avoidSDFRasterization:t};switch(e){case"marker":r.size=o.size,r.path=o.path,r.animatedSymbolProperties=o.animatedSymbolProperties;break;case"line":r.dashTemplate=o.dashTemplate;break;case"text":r.text=o.text,r.fontName=o.fontName}return r}const B=ut.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),je={sortKey:null,templates:new Array},ye={isOutline:!1,placement:null,symbologyType:kt.DEFAULT,vvFlags:0},bn={...Ee,hash:JSON.stringify(Ee),materialKey:le(C.MARKER,ye)},An={...Pe,hash:JSON.stringify(Pe),materialKey:le(C.LINE,ye)},zn={...Ce,hash:JSON.stringify(Ce),materialKey:le(C.FILL,ye)};function Y(o,t){const e=o.length;return o.push(null),t.then(s=>o[e]=s),o}function pt(o){return o!=null&&!!(o&1)}function Wn(o){return o.name==="worker:port-closed"}class sr{constructor(t,e){this._idCounter=1,this._templateIdCounter=1,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._cimTemplateCache=new Map,this._cimAnalyses=[],this._lock=new Tn,this._fetchResource=t,this._tileInfo=e}get _markerError(){return this._errorTemplates.marker[0]}get _fillError(){return this._errorTemplates.fill[0]}get _lineError(){return this._errorTemplates.line[0]}get _textError(){return this._errorTemplates.line[0]}createTemplateGroup(t,e,s=null){this._initErrorTemplates();const i=t.hash,n=this._symbolToTemplate.get(i);if(n!=null)return n;const r=new Array,a={sortKey:s,templates:r};e&&this._createMeshTemplates(r,e,!0),this._createMeshTemplates(r,t,!1);const l=this._createGroupId(t.type==="expanded-cim"&&Rn(t));return this._idToTemplateGroup.set(l,a),this._symbolToTemplate.set(i,l),l}getTemplateGroup(t){return this._idToTemplateGroup.get(t)??je}getDynamicTemplateGroup(t){return this._idToTemplateGroup.has(t)?(pt(t)||B.error("mapview-template-store",`Id ${t} does not refer to a dynamic template`),this._idToTemplateGroup.get(t)):je}getMosaicItem(t,e){const s=this._createTemplateId(),i=new Promise(n=>this._idToResolver.set(s,n));return this._fetchQueue.push({symbol:t,id:s,glyphIds:e}),i}finalize(t){return!this._fetchQueue.length&&!this._lock.isHeld()?Promise.resolve():In(this._lock,this._fetchAllQueuedResources.bind(this),t)}_initErrorTemplates(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],zn,!1),marker:this._createMeshTemplates([],bn,!1),line:this._createMeshTemplates([],An,!1)})}_fetchAllQueuedResources(t){if(!this._fetchQueue.length)return Promise.resolve();const e=this._fetchQueue,s=this._cimAnalyses;return this._fetchQueue=[],this._cimAnalyses=[],Promise.all(s).then(()=>this._fetchResource(e,t).then(i=>{for(const{id:n,mosaicItem:r}of i)this._idToResolver.get(n)(r),this._idToResolver.delete(n)})).catch(i=>{Xs(i)?this._fetchQueue=this._fetchQueue.concat(e):Wn(i)||B.error(new rt("mapview-template-store","Unable to fetch requested texture resources",i))})}_createGroupId(t){return this._idCounter++<<1|(t?1:0)}_createTemplateId(){return this._templateIdCounter++}async _createSMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return F(e,B)?L.fromSimpleMarker(t,e):this._markerError}async _createPMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return F(e,B)?L.fromPictureMarker(t,e):this._markerError}async _createSFS(t,e){const{spriteMosaicItem:s}=await this.getMosaicItem(t);return F(s,B)?j.fromSimpleFill(t,s,e):this._fillError}async _createPFS(t,e){const{spriteMosaicItem:s}=await this.getMosaicItem(t);return F(s,B)?j.fromPictureFill(t,s,e):this._fillError}async _createSLS(t,e){const{spriteMosaicItem:s}=await this.getMosaicItem(t);return F(s,B)?U.fromSimpleLine(t,s):this._lineError}async _createLMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return F(e,B)?L.fromLineSymbolMarker(t,e):this._markerError}async _createTS(t){const{glyphMosaicItems:e}=await this.getMosaicItem(t);return ft.fromText(t,e??[])}async _createCIMText(t){const{glyphMosaicItems:e}=await this.getMosaicItem(Ct(t),bs(t.text));return F(e,B)?ft.fromCIMText(t,e,this._tileInfo):this._textError}async _createCIMFill(t){const{spriteMosaicItem:e}=await this.getMosaicItem(Ct(t));return F(e,B)?j.fromCIMFill(t,e,this._tileInfo):this._fillError}async _createCIMLine(t){const{spriteMosaicItem:e}=await this.getMosaicItem(Ct(t));return F(e,B)?U.fromCIMLine(t,e,this._tileInfo):this._lineError}async _createCIMMarker(t){const{spriteMosaicItem:e}=await this.getMosaicItem(Ct(t));return F(e,B)?L.fromCIMMarker(t,e,this._tileInfo):this._markerError}async _createCIM(t){const e=t.templateHash;let s=this._cimTemplateCache.get(e);if(s!=null)return s;switch(t.type){case"marker":s=await this._createCIMMarker(t);break;case"line":s=await this._createCIMLine(t);break;case"fill":s=await this._createCIMFill(t);break;case"text":s=await this._createCIMText(t);break}return this._cimTemplateCache.set(e,s),s}async _createDynamicCIM(t){const e=t.templateHash;let s=this._cimTemplateCache.get(e);if(s!=null)return s;switch(t.type){case"marker":s=me.fromCIMMarker(t,this._tileInfo);break;case"line":s=xe.fromCIMLine(t,this._tileInfo);break;case"fill":s=pe.fromCIMFill(t,this._tileInfo);break;case"text":s=ge.fromCIMText(t,this._tileInfo);break}return this._cimTemplateCache.set(e,s),s}_createPrimitiveMeshTemplates(t,e,s){switch(e.type){case"esriSMS":return Y(t,this._createSMS(e));case"esriPMS":return Y(t,this._createPMS(e));case"esriSFS":return Y(t,this._createSFS(e,s));case"line-marker":return Y(t,this._createLMS(e));case"esriPFS":return Y(t,this._createPFS(e,s));case"esriSLS":return Y(t,this._createSLS(e,!1));case"esriTS":return Y(t,this._createTS(e));default:return B.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),t}}_createMeshTemplates(t,e,s){if(e.type.includes("3d"))return B.error("3D symbols are not supported with MapView"),t;if(e.type==="expanded-cim"){for(const i of e.layers)typeof i.materialHash=="function"?Y(t,this._createDynamicCIM(i)):Y(t,this._createCIM(i));return t}if(e.type==="composite-symbol"){for(const i of e.layers)this._createPrimitiveMeshTemplates(t,i,s);return t}return e.type==="cim"||e.type==="label"||e.type==="web-style"?t:this._createPrimitiveMeshTemplates(t,e,s)}}const Rn=o=>{if(!o.layers)return!1;for(const t of o.layers)if(typeof t.materialHash=="function")return!0;return!1};class ir{constructor(t,e,s){this._loadPromise=ai(),this._geometryType=t,this._idField=e,this._templateStore=s}update(t,e){t.mesh.labels!=null&&(this._labelTemplates=this._createLabelTemplates(t.mesh.labels,e)),this._schema=t}_createLabelTemplates(t,e){const s=new Map;if(t.type==="simple"){for(const i of t.classes){const n=Rt.fromLabelClass(i,e);s.set(i.index,n)}return s}for(const i in t.classes){const n=t.classes[i];for(const r of n){const a=Rt.fromLabelClass(r,e);s.set(r.index,a)}}return s}get templates(){return this._templateStore}async analyze(t,e,s,i,n,r,a){if(ve(a))return;let l;(s==null?void 0:s.type)==="dictionary"&&(l=await s.analyze(this._idField,t.copy(),e,n,r,a));let h=0;for(;t.next();){let f=null;if(l?f=l[h++]:i!=null&&ei(t.getDisplayId())&&t.readAttribute("cluster_count")!==1?f=i.match(this._idField,t,this._geometryType,n,r):f=s.match(this._idField,t,this._geometryType,n,r),t.setGroupId(f),pt(f)){const c=this._templateStore.getDynamicTemplateGroup(f).templates;for(const _ of c)_&&_.analyze&&_.analyze(this._templateStore,t,n,r)}}return await this._loadPromise,this._templateStore.finalize(a)}async analyzeGraphics(t,e,s,i,n,r){if(ve(r))return;const a=t.getCursor();for(s&&await s.analyze(this._idField,a.copy(),e,i,n,r);a.next();){let l=a.getGroupId();if((l==null||l===-1)&&(l=s==null?void 0:s.match(this._idField,a,a.geometryType,i,n),a.setGroupId(l)),pt(l)){const h=this._templateStore.getDynamicTemplateGroup(l).templates;for(const f of h)f&&f.analyze&&f.analyze(this._templateStore,a,i,n)}a.setGroupId(l)}return await this._loadPromise,this._templateStore.finalize(r)}writeGraphic(t,e,s,i){const n=e.getGroupId(),r=e.getDisplayId(),a=this._templateStore.getTemplateGroup(n);if(t.featureStart(e.insertAfter,0),r!=null){if(pt(n))for(const l of a.templates)l&&l.bindFeature(e,null,null);if(a){for(const l of a.templates)l&&l.write(t,e,s,i);t.featureEnd()}}}writeCursor(t,e,s,i,n,r,a){const l=e.getGroupId(),h=e.getDisplayId(),f=this._templateStore.getTemplateGroup(l),c=f.templates,_=this._getSortKeyValue(e,f);if(t.featureStart(0,_),h!=null&&c){if(pt(l))for(const d of c)d.bindFeature(e,s,i);for(const d of c)d.write(t,e,n,a);if(r!=null&&t.hasRecords){const d=r&&this._findLabelRef(c);this._writeLabels(t,e,r,d,n,a)}t.featureEnd()}}_getSortKeyValue(t,e){const s=this._schema.mesh.sortKey;if(s==null)return 0;let i=0;return s.byRenderer===!0&&e.sortKey!=null?i=e.sortKey:s.fieldIndex!=null?i=t.getComputedNumericAtIndex(s.fieldIndex):s.field!=null?i=t.readAttribute(s.field):i=t.readAttribute(this._idField),i*=s.order==="asc"?1:-1,i==null||isNaN(i)?0:i}_findLabelRef(t){for(const e of t)if(e instanceof L)return e;return null}_writeLabels(t,e,s,i,n,r){for(const a of s)if(a!=null&&a){const{glyphs:l,rtl:h,index:f}=a,c=this._labelTemplates.get(f);if(!c)continue;c.setZoomLevel(n),c.bindReferenceTemplate(i),c.bindTextInfo(l,h),c.write(t,e,null,r)}}}const ne=ut.getLogger("esri/views/2d/engine/webgl/util/Matcher");async function On(o,t,e,s){switch(o.type){case"simple":case"heatmap":return J.fromBasicRenderer(o,t,e,s);case"map":return we.fromUVRenderer(o,t,e,s);case"interval":return Me.fromCBRenderer(o,t,e,s);case"dictionary":return Se.fromDictionaryRenderer(o,t,e,s);case"pie-chart":return Bt.fromPieChartRenderer(o,t,e,s);case"subtype":return Bt.fromSubtypes(o,t,e,s)}}class J{constructor(){this.type="feature",this._defaultResult=null}static async fromBasicRenderer(t,e,s,i){const n=new J;if(t.symbol){const r=await H(t.symbol,s,i),a=e.createTemplateGroup(r,null);n.setDefault(a)}return n}static async fromPieChartRenderer(t,e,s,i){const n=new J;if(t.markerSymbol){const r=await H(t.markerSymbol,s,i);let a;t.fillSymbol&&(a=await H(t.fillSymbol,s,i));const l=e.createTemplateGroup(r,a);n.setDefault(l)}return n}size(){return 1}getDefault(){return this._defaultResult}setDefault(t){this._defaultResult=t}match(t,e,s,i,n){return this.getDefault()}async analyze(t,e,s,i,n,r){return null}}class Bt extends J{constructor(t,e){super(),this._subMatchers=t,this._subtypeField=e}static async fromSubtypes(t,e,s,i){const n=new Map,r=[];for(const a in t.renderers){const l=parseInt(a,10),h=t.renderers[a],f=On(h,e,s,i).then(c=>n.set(l,c));r.push(f)}return await Promise.all(r),new Bt(n,t.subtypeField)}match(t,e,s,i,n){const r=e.readAttribute(this._subtypeField),a=this._subMatchers.get(r);return a?a.match(t,e,s,i,n):null}}class Me extends J{constructor(t,e,s,i){super(),this.type="interval",this._intervals=[],this._isMaxInclusive=e,this._fieldIndex=i,this._field=t,this._normalizationInfo=s}static async fromCBRenderer(t,e,s,i){const{isMaxInclusive:n,normalizationField:r,normalizationTotal:a,normalizationType:l}=t,h=t.field,f={normalizationField:r,normalizationTotal:a,normalizationType:l},c=new Me(h,n,f,t.fieldIndex),_=await H(t.backgroundFillSymbol,s,i);await Promise.all(t.intervals.map(async u=>{const p=await H(u.symbol,s,i),m=await e.createTemplateGroup(p,_),x={min:u.min,max:u.max};c.add(x,m)}));const d=await H(t.defaultSymbol,s,i);if(d){const u=await e.createTemplateGroup(d,_);c.setDefault(u)}return c}add(t,e){this._intervals.push({interval:t,result:e}),this._intervals.sort((s,i)=>s.interval.min-i.interval.min)}size(){return super.size()+this._intervals.length}match(t,e,s,i,n){if(this._fieldIndex==null&&!this._field)return this.getDefault();const r=this._fieldIndex!=null?e.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(e);if(r==null||isNaN(r)||r===1/0||r===-1/0)return this.getDefault();for(let l=0;l<this._intervals.length;l++){const{interval:h,result:f}=this._intervals[l],c=r>=h.min,_=this._isMaxInclusive?r<=h.max:r<h.max;if(c&&_)return f}return this.getDefault()}_needsNormalization(){const t=this._normalizationInfo;return t&&(t.normalizationField||t.normalizationTotal||t.normalizationType)}_getValueFromField(t){const e=t.readAttribute(this._field);if(!this._needsNormalization()||e==null)return e;const{normalizationField:s,normalizationTotal:i,normalizationType:n}=this._normalizationInfo,r=t.readAttribute(s)??1;if(!n){ne.error("Normalization is required, but no type was set!");return}switch(n){case"esriNormalizeByField":return(r||void 0)&&e/r;case"esriNormalizeByLog":return Math.log(e)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return e/i*100;default:ne.error(`Found unknown normalization type: ${n}`);return}}}class we extends J{constructor(t,e,s){super(),this.type="map",this._nullResult=null,this._resultsMap=new Map,this._fields=[],this._fieldsIndex=s,this._fields=t,this._seperator=e||""}static async fromUVRenderer(t,e,s,i){const n=t.fieldDelimiter,r=[t.field];t.field2&&r.push(t.field2),t.field3&&r.push(t.field3);const a=await H(t.backgroundFillSymbol,s,i),l=new we(r,n,t.fieldIndex);await Promise.all(t.map.map(async(f,c)=>{const _=await H(f.symbol,s,i),d=c+1,u=await e.createTemplateGroup(_,a,d);f.value==="<Null>"?l.setNullResult(u):l.add(f.value,u)}));const h=await H(t.defaultSymbol,s,i);if(h){const f=Number.MAX_SAFE_INTEGER,c=await e.createTemplateGroup(h,a,f);l.setDefault(c)}return l}setNullResult(t){this._nullResult=t}add(t,e){this._resultsMap.set(t.toString(),e)}size(){return super.size()+this._resultsMap.size}match(t,e,s,i,n){if(this._fieldsIndex==null&&!this._fields)return this.getDefault();const r=this._fieldsIndex!=null?e.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(e);if(this._nullResult!==null&&(r==null||r===""||r==="<Null>"))return this._nullResult;if(r==null)return this.getDefault();const l=r.toString();return this._resultsMap.has(l)?this._resultsMap.get(l):this.getDefault()}_getValueFromFields(t){const e=[];for(const s of this._fields){const i=t.readAttribute(s);i==null||i===""?e.push("<Null>"):e.push(i)}return e.join(this._seperator)}}async function Bn(o,t){const e=o||1;if(typeof e=="number")return(i,n,r)=>e;const s=await Hs(e,t.spatialReference,t.fields);return(i,n,r)=>yi(s,i,{$view:r},t.geometryType,n)||1}let Ut;async function Dn(){return Ut||(Ut=Qe(()=>import("./schemaUtils-14cc7974.js").then(o=>o.e),["assets/schemaUtils-14cc7974.js","assets/index-fb3bdf4f.js","assets/index-d832a396.css","assets/sql-0af83f60.js","assets/diffUtils-64bbc518.js","assets/labelingInfo-3bb75bee.js","assets/labelUtils-5f0b2e6a.js","assets/defaultsJSON-b396ba80.js","assets/jsonUtils-3a34d9bc.js","assets/color-0f742f04.js","assets/enums-eb6e4255.js","assets/enums-08489827.js","assets/VertexElementDescriptor-24e04d97.js","assets/utils-4f50f73a.js","assets/MaterialKey-5e53447a.js","assets/definitions-3f56d206.js","assets/heatmapUtils-a281406f.js","assets/vec4-3dd523e8.js","assets/vec4f64-efdcb593.js","assets/visualVariablesUtils-71336366.js","assets/ExpandedCIM-4a2a07c8.js","assets/BidiEngine-cdaf024a.js","assets/GeometryUtils-26dde58c.js","assets/Rect-df8ea165.js","assets/quantizationUtils-a7076d8a.js","assets/floatRGBA-2bfd4a13.js","assets/featureFlags-4ba2b89f.js","assets/clusterUtils-c169a684.js","assets/SizeVariable-74abd6da.js","assets/colorRamps-81a71b30.js","assets/LegendOptions-a28747c0.js","assets/sizeVariableUtils-2914222a.js","assets/lengthUtils-1e4d8fd6.js","assets/util-f2f72a6d.js"])),Ut}class Se extends J{constructor(t,e,s,i,n,r){super(),this.type="dictionary",this._groupIdCache=new wi(100),this._loader=t,this._fieldMap=t.fieldMap,this._symbolFields=t.getSymbolFields(),this._templates=e,this._info=s,this._scaleFn=i,this._schemaUtilsModule=n,this._symbolOptions=r}static async fromDictionaryRenderer(t,e,s,i){const[{DictionaryLoader:n},r]=await Promise.all([Qe(()=>import("./DictionaryLoader-0b6ffeed.js"),["assets/DictionaryLoader-0b6ffeed.js","assets/index-fb3bdf4f.js","assets/index-d832a396.css","assets/LRUCache-59f262f3.js","assets/MemCache-3f213196.js","assets/FieldsIndex-56690a21.js"]),Dn()]),a=new n(t.url,t.config,t.fieldMap);await a.fetchResources({spatialReference:s.spatialReference,fields:s.fields});const l=await Bn(t.scaleExpression,s);return new Se(a,e,s,l,r,t.symbolOptions)}async _analyzeFeature(t,e,s,i,n){const r=t.readLegacyFeature(),a=this._scaleFn(r,s,i),l=this._attributeHash(r)+"-"+a,h=this._groupIdCache.get(l);if(h)return h;const f={...i,spatialReference:this._info.spatialReference,abortOptions:n,fields:this._info.fields},c=await this._loader.getSymbolAsync(r,f),_=this._schemaUtilsModule.createSymbolSchema(c,this._symbolOptions),d=H(_,this._info,e,n).then(u=>{if((u==null?void 0:u.type)!=="expanded-cim")return ne.error(new rt("mapview-bad-type",`Found unexpected type ${u==null?void 0:u.type} in dictionary response`)),null;u.hash+="-"+a;for(const p of u.layers)p.scaleFactor=a,p.templateHash+="-"+a;return this._templates.createTemplateGroup(u,null)});return this._groupIdCache.put(l,d,1),d}async analyze(t,e,s,i,n,r){const a=e.getCursor(),l=[];for(;a.next();)l.push(this._analyzeFeature(a,s,i,n,r));return Promise.all(l).then(h=>h.filter(Ks))}match(t,e,s,i,n){return null}_attributeHash(t){var s;let e="";for(const i of this._symbolFields){const n=(s=this._fieldMap)==null?void 0:s[i];n&&(e+=t.attributes[n]+"-")}return e}}export{er as M,It as W,sr as a,ir as b,On as c,bs as d,H as e,F as o};
