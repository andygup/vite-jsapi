import{O as I,ba as W,ae as c,af as l,ai as T,aj as B,be as P,t as _,bP as N,Z as A,I as C,N as R,bp as H,b6 as q}from"./index-cc043433.js";import{B as O}from"./Bitmap-590eead2.js";const V=Math.PI/180;function U(h){return h*V}function $(h,s){const i=U(s.rotation),a=Math.abs(Math.cos(i)),t=Math.abs(Math.sin(i)),[r,o]=s.size;return h[0]=Math.round(o*t+r*a),h[1]=Math.round(o*a+r*t),h}function j(h,s,i,a){const[t,r]=s,[o,p]=a,e=i*.5;return h[0]=t-e*o,h[1]=r-e*p,h[2]=t+e*o,h[3]=r+e*p,h}const u=I(),m=[0,0],w=new W(0,0,0,0),S={container:null,fetchSource:null,requestUpdate:null,imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1};let n=class extends B{constructor(s){super(s),this._imagePromise=null,this.bitmaps=[],this.hidpi=S.hidpi,this.imageMaxWidth=S.imageMaxWidth,this.imageMaxHeight=S.imageMaxHeight,this.imageRotationSupported=S.imageRotationSupported,this.imageNormalizationSupported=S.imageNormalizationSupported,this.update=P(async(i,a)=>{if(_(a),!i.stationary||this.destroyed)return;const t=i.state,r=N(t.spatialReference),o=this.hidpi?i.pixelRatio:1,p=this.imageNormalizationSupported&&t.worldScreenWidth&&t.worldScreenWidth<t.size[0],e=this.imageMaxWidth??0,g=this.imageMaxHeight??0;p?(m[0]=t.worldScreenWidth,m[1]=t.size[1]):this.imageRotationSupported?(m[0]=t.size[0],m[1]=t.size[1]):$(m,t);const b=Math.floor(m[0]*o)>e||Math.floor(m[1]*o)>g,M=r&&(t.extent.xmin<r.valid[0]||t.extent.xmax>r.valid[1]),x=!this.imageNormalizationSupported&&M,v=!b&&!x,y=this.imageRotationSupported?t.rotation:0,z=this.container.children.slice();if(v){const d=p?t.paddedViewState.center:t.center;this._imagePromise&&console.error("Image promise was not defined!"),this._imagePromise=this._singleExport(t,m,d,t.resolution,y,o,a)}else{let d=Math.min(e,g);x&&(d=Math.min(t.worldScreenWidth,d)),this._imagePromise=this._tiledExport(t,d,o,a)}try{const d=await this._imagePromise??[];_(a);const E=[];if(this._imagePromise=null,this.destroyed)return;this.bitmaps=d;for(const f of z)d.includes(f)||E.push(f.fadeOut().then(()=>{f.remove(),f.destroy()}));for(const f of d)E.push(f.fadeIn());await Promise.all(E)}catch(d){this._imagePromise=null,A(d)}},5e3),this.updateExports=P(async i=>{const a=[];for(const t of this.container.children){if(!t.visible||!t.stage)return;a.push(i(t).then(()=>{t.invalidateTexture(),t.requestRender()}))}this._imagePromise=C(a).then(()=>this._imagePromise=null),await this._imagePromise})}destroy(){this.bitmaps.forEach(s=>s.destroy()),this.bitmaps=[]}get updating(){return!this.destroyed&&this._imagePromise!==null}async _export(s,i,a,t,r,o){const p=await this.fetchSource(s,Math.floor(i*r),Math.floor(a*r),{rotation:t,pixelRatio:r,signal:o});_(o);const e=new O(null,{immutable:!0,requestRenderOnSourceChangedEnabled:!0});return e.x=s.xmin,e.y=s.ymax,e.resolution=s.width/i,e.rotation=t,e.pixelRatio=r,e.opacity=0,this.container.addChild(e),await e.setSourceAsync(p,o),_(o),e}async _singleExport(s,i,a,t,r,o,p){j(u,a,t,i);const e=R(u,s.spatialReference);return[await this._export(e,i[0],i[1],r,o,p)]}_tiledExport(s,i,a,t){const r=H.create({size:i,spatialReference:s.spatialReference,scales:[s.scale]}),o=new q(r),p=o.getTileCoverage(s);if(!p)return null;const e=[];return p.forEach((g,b,M,x)=>{w.set(g,b,M,0),o.getTileBounds(u,w);const v=R(u,s.spatialReference);e.push(this._export(v,i,i,0,a,t).then(y=>(x!==0&&(w.set(g,b,M,x),o.getTileBounds(u,w),y.x=u[0],y.y=u[3]),y)))}),Promise.all(e)}};c([l()],n.prototype,"_imagePromise",void 0);c([l()],n.prototype,"bitmaps",void 0);c([l()],n.prototype,"container",void 0);c([l()],n.prototype,"fetchSource",void 0);c([l()],n.prototype,"hidpi",void 0);c([l()],n.prototype,"imageMaxWidth",void 0);c([l()],n.prototype,"imageMaxHeight",void 0);c([l()],n.prototype,"imageRotationSupported",void 0);c([l()],n.prototype,"imageNormalizationSupported",void 0);c([l()],n.prototype,"requestUpdate",void 0);c([l()],n.prototype,"updating",null);n=c([T("esri.views.2d.layers.support.ExportStrategy")],n);const L=n;export{L as E};
