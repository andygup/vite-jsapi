import{d as D,e as z,bi as xe,j as $,bj as G,h as be,bk as Te,bl as oe,C as j,bm as J,O as le,bn as we,ae as f,af as m,ai as B,bg as ve,be as Pe,b8 as X,bf as Ie,bo as Ue,b6 as Re,b7 as Se,K as Fe,bp as W,i as M,L,I as Y,bq as Ce,A as I,E as Z,ah as ce,bh as K,aZ as De,B as Me}from"./index-fb3bdf4f.js";import{h as ee}from"./multidimensionalUtils-3dae8755.js";import{R as Le,B as ze,F as Be}from"./RasterVFDisplayObject-fc4a1751.js";import{L as Ve,a as Ge}from"./LayerView-9bea169e.js";import{e as ue,P as Ee,a as Ae}from"./dataUtils-dc72bf0e.js";import{D as Oe}from"./Container-196ddee7.js";import{T as q,f as ke,d as $e,e as We,a as je,B as E,C as te,b as qe,c as Ne}from"./enums-08489827.js";import{c as Qe,a as He,b as se,s as C,d as b,g as N,e as Je,f as Xe,h as Ye,i as Ze,j as Ke}from"./rasterUtils-76d321db.js";import{a as et,T as tt}from"./TextureDescriptor-575a7c2b.js";import{g as U}from"./definitions-3f56d206.js";import{c as st,V as re}from"./WGLContainer-45eec68a.js";import{F as rt}from"./VertexArrayObject-99e12d54.js";import{T as he}from"./TiledDisplayObject-246392fd.js";import{W as A}from"./color-0f742f04.js";import{T as de}from"./TileContainer-9dd22085.js";import{u as ie,a as ne,r as it,g as nt}from"./RawBlockCache-7d21e101.js";import{g as at,c as ot,a as ae,p as lt}from"./rasterProjectionHelper-bfd0aace.js";import{c as fe}from"./util-f2f72a6d.js";import{c as ct}from"./commonProperties-a5bf3577.js";import{g as ut}from"./popupUtils-93028533.js";import{R as ht}from"./RefreshableLayerView-58b3a174.js";import"./VertexElementDescriptor-24e04d97.js";import"./parser-77953c84.js";import"./_commonjsHelpers-725317a4.js";import"./ProgramTemplate-80c5e243.js";import"./MaterialKey-5e53447a.js";import"./utils-4f50f73a.js";import"./heatmapUtils-a281406f.js";import"./vec4-3dd523e8.js";import"./vec4f64-efdcb593.js";import"./StyleDefinition-edaaf36e.js";import"./enums-eb6e4255.js";import"./config-c06e4a6d.js";import"./GeometryUtils-0ab64fac.js";import"./earcut-db592379.js";import"./featureConversionUtils-f24a23cd.js";import"./OptimizedGeometry-af84d2ad.js";import"./OptimizedFeatureSet-5c82fe5a.js";import"./ElevationInfo-2af660b1.js";import"./lengthUtils-1e4d8fd6.js";const dt={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class ft extends Oe{constructor(e=null,t=null,s=null){super(),this._textureInvalidated=!0,this._colormapTextureInvalidated=!0,this._rasterTexture=null,this._rasterTextureBandIds=null,this._transformGridTexture=null,this._colormapTexture=null,this._colormap=null,this._supportsBilinearTexture=!0,this._processedTexture=null,this.functionTextures=[],this.projected=!1,this.stencilRef=0,this.coordScale=[1,1],this._processed=!1,this._symbolizerParameters=null,this.height=null,this.isRendereredSource=!1,this.pixelRatio=1,this.resolution=0,this.rotation=0,this._source=null,this.rawPixelData=null,this._suspended=!1,this._bandIds=null,this._interpolation=null,this._transformGrid=null,this.width=null,this.x=0,this.y=0,this.source=e,this.transformGrid=t,this.interpolation=s}destroy(){this._disposeTextures()}get processedTexture(){return this._processedTexture}set processedTexture(e){this._processedTexture!==e&&(this._disposeTextures(!0),this._processedTexture=e)}get rasterTexture(){return this._rasterTexture}set rasterTexture(e){var t;this._rasterTexture!==e&&((t=this._rasterTexture)==null||t.dispose(),this._rasterTexture=e)}get processed(){return this._processed}set processed(e){this._processed=e,e||(D(this.processedTexture),this.invalidateTexture())}get symbolizerParameters(){return this._symbolizerParameters||dt}set symbolizerParameters(e){this._symbolizerParameters!==e&&(this._symbolizerParameters=e,this._colormapTextureInvalidated=!0,this.commonUniforms=null)}get source(){return this._source}set source(e){this._source!==e&&(this._source=e,this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null,this._rasterTextureBandIds=null),this.projected=!1,this.invalidateTexture())}get suspended(){return this._suspended}set suspended(e){this._suspended&&!e&&this.stage&&(this.ready(),this.requestRender()),this._suspended=e}get bandIds(){return this._bandIds}set bandIds(e){this._bandIds=e,this._isBandIdschanged(e)&&(this.projected=!1,this.invalidateTexture())}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){this._interpolation=e,this._rasterTexture&&this._rasterTexture.setSamplingMode(this._getTextureSamplingMethod(e||"nearest")==="bilinear"?q.LINEAR:q.NEAREST)}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture=D(this._transformGridTexture)}invalidateTexture(){this._textureInvalidated||(this._textureInvalidated=!0,this.requestRender())}_createTransforms(){return{dvs:z()}}setTransform(e){const t=xe(this.transforms.dvs),[s,r]=e.toScreenNoRotation([0,0],[this.x,this.y]),i=this.resolution/this.pixelRatio/e.resolution,n=i*this.width,o=i*this.height,l=Math.PI*this.rotation/180;$(t,t,G(s,r)),$(t,t,G(n/2,o/2)),be(t,t,-l),$(t,t,G(-n/2,-o/2)),Te(t,t,G(n,o)),oe(this.transforms.dvs,e.displayViewMat3,t)}getTextures({forProcessing:e=!1,useProcessedTexture:t=!1}={}){const s=t?this._processedTexture??this._rasterTexture:this._rasterTexture,r=[],i=[];return s?t?(i.push(s),r.push("u_image"),this._colormapTexture&&(i.push(this._colormapTexture),r.push("u_colormap")),{names:r,textures:i}):(this._transformGridTexture&&(i.push(this._transformGridTexture),r.push("u_transformGrid")),i.push(s),r.push("u_image"),this._colormapTexture&&!e&&(i.push(this._colormapTexture),r.push("u_colormap")),{names:r,textures:i}):{names:r,textures:i}}onAttach(){this.invalidateTexture()}onDetach(){this.invalidateTexture()}updateTexture({context:e}){if(!this.stage){this._disposeTextures();return}const t=this._isValidSource(this.source);t&&this._colormapTextureInvalidated&&(this._colormapTextureInvalidated=!1,this._updateColormapTexture(e)),this._textureInvalidated&&(this._textureInvalidated=!1,this._createOrDestroyRasterTexture(e),this._rasterTexture&&(t?this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=Qe(e,this.transformGrid)):this._rasterTexture.setData(null)),this.suspended||(this.ready(),this.requestRender()))}updateProcessedTexture(){const{functionTextures:e}=this;e.length!==0&&(this.processedTexture=e.shift(),e.forEach(t=>t==null?void 0:t.dispose()),e.length=0)}_createOrDestroyRasterTexture(e){var o,l;const t=this.source!=null?ue(this.source,this.bandIds):null;if(!this._isValidSource(t)){this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTextureBandIds=null,this._rasterTexture=null);return}const r=!this._isBandIdschanged(this.bandIds);if(this._rasterTexture){if(r)return;this._rasterTexture.dispose(),this._rasterTextureBandIds=null,this._rasterTexture=null}this._supportsBilinearTexture=!!((o=e.capabilities.textureFloat)!=null&&o.textureFloatLinear);const i=this._getTextureSamplingMethod(this.interpolation),n=this.isRendereredSource||!((l=e.capabilities.textureFloat)!=null&&l.textureFloat);this._rasterTexture=He(e,t,i,n),this.projected=!1,this._processed=!1,this._rasterTextureBandIds=this.bandIds?[...this.bandIds]:null}_isBandIdschanged(e){const t=this._rasterTextureBandIds;return!(t==null&&e==null||t&&e&&t.join("")===e.join(""))}_isValidSource(e){var t;return e!=null&&((t=e.pixels)==null?void 0:t.length)>0}_getTextureSamplingMethod(e){const{type:t,colormap:s}=this.symbolizerParameters,r=t==="lut"||t==="stretch"&&s!=null;return this._supportsBilinearTexture&&!r&&(e==="bilinear"||e==="cubic")?"bilinear":"nearest"}_updateColormapTexture(e){const t=this._colormap,s=this.symbolizerParameters.colormap;if(!s){this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormap=null;return}if(!t){this._colormapTexture=se(e,s),this._colormap=s;return}if(s.length!==t.length||s.some((r,i)=>r!==t[i])){this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=se(e,s),this._colormap=s;return}}_disposeTextures(e=!1){this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null),!e&&this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null,this._colormap=null,this._colormapTextureInvalidated=!0),!e&&this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null,this._rasterTextureBandIds=null),this._processedTexture&&(this._processedTexture.dispose(),this._processedTexture=null)}}function pt(a){return a.source!=null}function Q(a){const e=[];return a&&(e.push("applyProjection"),a.spacing[0]===1&&e.push("lookupProjection")),e}function pe(a,e,t){var i;const s=!((i=t.capabilities.textureFloat)!=null&&i.textureFloatLinear),r=[];return a==="cubic"?r.push("bicubic"):a==="bilinear"&&(e?(r.push("bilinear"),r.push("nnedge")):s&&r.push("bilinear")),r}const mt={vsPath:"raster/common",fsPath:"raster/lut",attributes:new Map([["a_position",0],["a_texcoord",1]])};function gt(a,e,t){const s=t?[]:Q(e.transformGrid),r=a.painter.materialManager.getProgram(mt,s);return{defines:s,program:r}}function _t(a,e,t,s,r=!1){const{names:i,textures:n}=t.getTextures({useProcessedTexture:r});C(a.context,e,i,n),b(e,s,t.commonUniforms),e.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs);const{colormap:o,colormapOffset:l}=t.symbolizerParameters,c=N(o,l);b(e,s,c)}const yt={createProgram:gt,bindTextureAndUniforms:_t},xt={vsPath:"raster/common",fsPath:"raster/hillshade",attributes:new Map([["a_position",0],["a_texcoord",1]])};function bt(a,e,t){const{colormap:s}=e.symbolizerParameters,r=t?[]:Q(e.transformGrid),i=pe(e.interpolation,s!=null,a.context),n=[...r,...i];s!=null&&n.push("applyColormap");const o=a.painter.materialManager.getProgram(xt,n);return{defines:n,program:o}}function Tt(a,e,t,s,r=!1){const{names:i,textures:n}=t.getTextures({useProcessedTexture:r});C(a.context,e,i,n),b(e,s,t.commonUniforms),e.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs);const o=t.symbolizerParameters,{colormap:l,colormapOffset:c}=o;if(l!=null){const d=N(l,c);b(e,s,d)}const u=Je(o);b(e,s,u)}const wt={createProgram:bt,bindTextureAndUniforms:Tt},vt={vsPath:"raster/common",fsPath:"raster/stretch",attributes:new Map([["a_position",0],["a_texcoord",1]])};function Pt(a,e,t){const{colormap:s}=e.symbolizerParameters,r=t?[]:Q(e.transformGrid),i=pe(e.interpolation,s!=null,a.context),n=[...r,...i];e.isRendereredSource&&!t?n.push("noop"):s!=null&&n.push("applyColormap");const o=a.painter.materialManager.getProgram(vt,n);return{defines:n,program:o}}function It(a,e,t,s,r=!1){const{names:i,textures:n}=t.getTextures({useProcessedTexture:r});C(a.context,e,i,n),b(e,s,t.commonUniforms),e.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs);const o=t.symbolizerParameters,{colormap:l,colormapOffset:c}=o;if(l!=null){const d=N(l,c);b(e,s,d)}const u=Xe(o);b(e,s,u)}const Ut={createProgram:Pt,bindTextureAndUniforms:It},O=new Map;O.set("lut",yt);O.set("hillshade",wt);O.set("stretch",Ut);function Rt(a){return O.get(a)}const St=[1,1],Ft=[2,0,0,0,2,0,-1,-1,0];function x(a,e,t){const{context:s,rasterFunction:r,hasBranches:i}=a,{raster:n}=r.parameters,o=i?(n==null?void 0:n.id)??-1:0,l=t.functionTextures[o]??t.rasterTexture;C(s,e,["u_image"],[l])}function me(a,e,t){const{rasters:s}=a.rasterFunction.parameters;if(!s)return;if(s.length<2)return x(a,e,t);const r=s.filter(i=>i.name!=="Constant").map(i=>i.id!=null&&i.name!=="Identity"?t.functionTextures[i.id]:t.rasterTexture);if(C(a.context,e,["u_image","u_image1","u_image2"].slice(0,r.length),r),r.length!==s.length){if(s.length===2){const i=s.findIndex(l=>l.name==="Constant"),n=i===0?[0,1,0,1,0,0,0,0,0]:[1,0,0,0,1,0,0,0,0],{value:o}=s[i].parameters;e.setUniform1f("u_image1Const",o),e.setUniformMatrix3fv("u_imageSwap",n)}else if(s.length===3){const i=[];if(s.forEach((n,o)=>n.name==="Constant"&&i.push(o)),i.length===1){const{value:n}=s[i[0]].parameters;e.setUniform1f("u_image1Const",n);const o=i[0]===0?[0,1,0,0,0,1,1,0,0]:i[0]===1?[1,0,0,0,0,1,0,1,0]:[1,0,0,0,1,0,0,0,1];e.setUniformMatrix3fv("u_imageSwap",o)}else if(i.length===2){const{value:n}=s[i[0]].parameters;e.setUniform1f("u_image1Const",n);const{value:o}=s[i[1]].parameters;e.setUniform1f("u_image2Const",o);const l=s.findIndex(u=>u.name!=="Constant"),c=l===0?[1,0,0,0,1,0,0,0,1]:l===1?[0,1,0,1,0,0,0,0,1]:[0,0,1,1,0,0,0,1,0];e.setUniformMatrix3fv("u_imageSwap",c)}}}}function y(a){a.setUniform2fv("u_coordScale",St),a.setUniformMatrix3fv("u_dvsMat3",Ft)}const Ct={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/aspect",attributes:new Map([["a_position",0],["a_texcoord",1]])};function Dt(a,e){return a.painter.materialManager.getProgram(Ct,[])}function Mt(a,e,t){x(a,e,t),y(e);const{width:s,height:r,resolution:i}=t;e.setUniform2fv("u_srcImageSize",[s,r]),e.setUniform2fv("u_cellSize",[i,i])}const Lt={createProgram:Dt,bindTextureAndUniforms:Mt},zt={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/bandarithmetic",attributes:new Map([["a_position",0],["a_texcoord",1]])};function Bt(a,e){const{painter:t,rasterFunction:s}=a,{indexType:r}=s.parameters;return t.materialManager.getProgram(zt,[r])}function Vt(a,e,t){x(a,e,t),y(e);const{bandIndexMat3:s}=a.rasterFunction.parameters;e.setUniformMatrix3fv("u_bandIndexMat3",s)}const Gt={createProgram:Bt,bindTextureAndUniforms:Vt},Et={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/compositeband",attributes:new Map([["a_position",0],["a_texcoord",1]])};function At(a,e){return a.painter.materialManager.getProgram(Et,[])}function Ot(a,e,t){me(a,e,t),y(e)}const kt={createProgram:At,bindTextureAndUniforms:Ot},$t={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/convolution",attributes:new Map([["a_position",0],["a_texcoord",1]])};function Wt(a,e){const{painter:t,rasterFunction:s}=a,{kernelRows:r,kernelCols:i}=s.parameters,n=[{name:"rows",value:r},{name:"cols",value:i}];return t.materialManager.getProgram($t,n)}function jt(a,e,t){x(a,e,t),y(e),e.setUniform2fv("u_srcImageSize",[t.width,t.height]);const{kernel:s,clampRange:r}=a.rasterFunction.parameters;e.setUniform1fv("u_kernel",s),e.setUniform2fv("u_clampRange",r)}const qt={createProgram:Wt,bindTextureAndUniforms:jt},Nt={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/curvature",attributes:new Map([["a_position",0],["a_texcoord",1]])};function Qt(a,e){const{painter:t,rasterFunction:s}=a,{curvatureType:r}=s.parameters,i=[r];return t.materialManager.getProgram(Nt,i)}function Ht(a,e,t){x(a,e,t),y(e);const{width:s,height:r,resolution:i}=t,{zFactor:n}=a.rasterFunction.parameters;e.setUniform2fv("u_srcImageSize",[s,r]),e.setUniform1f("u_zlFactor",200*n/i/i)}const Jt={createProgram:Qt,bindTextureAndUniforms:Ht},Xt={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/extractband",attributes:new Map([["a_position",0],["a_texcoord",1]])};function Yt(a,e){return a.painter.materialManager.getProgram(Xt,[])}function Zt(a,e,t){x(a,e,t),y(e);const{bandIndexMat3:s}=a.rasterFunction.parameters;e.setUniformMatrix3fv("u_bandIndexMat3",s)}const Kt={createProgram:Yt,bindTextureAndUniforms:Zt},es={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/local",attributes:new Map([["a_position",0],["a_texcoord",1]])},ts=new Set(["sinh","cosh","tanh","asinh","acosh","atanh"]);function ss(a){const{painter:e,rasterFunction:t}=a,{imageCount:s,operationName:r,rasters:i,isOutputRounded:n}=t.parameters;let o=r.toLowerCase();a.context.type===j.WEBGL1&&ts.has(o)&&(o=`polyfill${o}`);const l=[o];s===2&&l.push("twoImages");const c=i.filter(u=>u.name==="Constant");return c.length&&(l.push("oneConstant"),c.length===2&&l.push("twoConstant")),n&&l.push("roundOutput"),e.materialManager.getProgram(es,l)}function rs(a,e,t){me(a,e,t),y(e);const{domainRange:s}=a.rasterFunction.parameters;e.setUniform2fv("u_domainRange",s)}const is={createProgram:ss,bindTextureAndUniforms:rs},ns={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/mask",attributes:new Map([["a_position",0],["a_texcoord",1]])};function as(a,e){const{painter:t,rasterFunction:s}=a,r=s.parameters.bandCount>1?["multiBand"]:[];return t.materialManager.getProgram(ns,r)}function os(a,e,t){x(a,e,t),y(e);const{includedRanges:s,noDataValues:r}=a.rasterFunction.parameters;e.setUniform1fv("u_includedRanges",s),e.setUniform1fv("u_noDataValues",r)}const ls={createProgram:as,bindTextureAndUniforms:os},cs={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/ndvi",attributes:new Map([["a_position",0],["a_texcoord",1]])};function us(a,e){const{painter:t,rasterFunction:s}=a,r=s.parameters.scaled?["scaled"]:[];return t.materialManager.getProgram(cs,r)}function hs(a,e,t){x(a,e,t),y(e);const{bandIndexMat3:s}=a.rasterFunction.parameters;e.setUniformMatrix3fv("u_bandIndexMat3",s)}const ds={createProgram:us,bindTextureAndUniforms:hs},fs={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/remap",attributes:new Map([["a_position",0],["a_texcoord",1]])};function ps(a,e){return a.painter.materialManager.getProgram(fs,[])}function ms(a,e,t){x(a,e,t),y(e);const{noDataRanges:s,rangeMaps:r,allowUnmatched:i,clampRange:n}=a.rasterFunction.parameters;e.setUniform1fv("u_noDataRanges",s),e.setUniform1fv("u_rangeMaps",r),e.setUniform1f("u_unmatchMask",i?1:0),e.setUniform2fv("u_clampRange",n)}const gs={createProgram:ps,bindTextureAndUniforms:ms},_s={vsPath:"raster/common",fsPath:"raster/reproject",attributes:new Map([["a_position",0],["a_texcoord",1]])};function ys(a,e){var l,c,u;const{painter:t}=a,s=[],{interpolation:r,transformGrid:i}=e,n=!!((c=(l=a.rasterFunction)==null?void 0:l.parameters)!=null&&c.requireBilinear),o=r==="bilinear"?!((u=a.context.capabilities.textureFloat)!=null&&u.textureFloatLinear):n;return r==="cubic"?s.push("bicubic"):o&&s.push("bilinear"),i&&(s.push("applyProjection"),i.spacing[0]===1&&s.push("lookupProjection")),t.materialManager.getProgram(_s,s)}function xs(a,e,t){const{names:s,textures:r}=t.getTextures({forProcessing:!0});C(a.context,e,s,r),e.setUniform1f("u_scale",1),e.setUniform2fv("u_offset",[0,0]),e.setUniform2fv("u_coordScale",[1,1]),e.setUniformMatrix3fv("u_dvsMat3",[2,0,0,0,2,0,-1,-1,0]),e.setUniform1i("u_flipY",0),e.setUniform1f("u_opacity",1);const{width:i,height:n,source:o,transformGrid:l}=t;e.setUniform2fv("u_srcImageSize",[o.width,o.height]),e.setUniform2fv("u_targetImageSize",[i,n]),e.setUniform2fv("u_transformSpacing",l?l.spacing:J),e.setUniform2fv("u_transformGridSize",l?l.size:J)}const bs={createProgram:ys,bindTextureAndUniforms:xs},Ts={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/slope",attributes:new Map([["a_position",0],["a_texcoord",1]])};function ws(a,e){const{painter:t,rasterFunction:s}=a,{slopeType:r}=s.parameters,i=r==="percent-rise"?["percentRise"]:[];return t.materialManager.getProgram(Ts,i)}function vs(a,e,t){x(a,e,t),y(e);const{width:s,height:r,resolution:i}=t,{zFactor:n,slopeType:o,pixelSizePower:l,pixelSizeFactor:c}=a.rasterFunction.parameters;e.setUniform2fv("u_srcImageSize",[s,r]),e.setUniform2fv("u_cellSize",[i,i]),e.setUniform1f("u_zFactor",n),e.setUniform1f("u_pixelSizePower",o==="adjusted"?l:0),e.setUniform1f("u_pixelSizeFactor",o==="adjusted"?c:0)}const Ps={createProgram:ws,bindTextureAndUniforms:vs},Is={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/stretch",attributes:new Map([["a_position",0],["a_texcoord",1]])};function Us(a,e){const{useGamma:t,bandCount:s,isOutputRounded:r}=a.rasterFunction.parameters,i=[];return t&&i.push("useGamma"),s>1&&i.push("multiBand"),r&&i.push("roundOutput"),a.painter.materialManager.getProgram(Is,i)}function Rs(a,e,t){x(a,e,t),y(e);const{width:s,height:r}=t,i=a.rasterFunction.parameters;e.setUniform2fv("u_srcImageSize",[s,r]),e.setUniform1f("u_minOutput",i.outMin),e.setUniform1f("u_maxOutput",i.outMax),e.setUniform1fv("u_factor",i.factor),e.setUniform1fv("u_minCutOff",i.minCutOff),e.setUniform1fv("u_maxCutOff",i.maxCutOff),e.setUniform1fv("u_gamma",i.gamma),e.setUniform1fv("u_gammaCorrection",i.gammaCorrection)}const Ss={createProgram:Us,bindTextureAndUniforms:Rs},_=new Map;_.set("aspect",Lt);_.set("bandarithmetic",Gt);_.set("compositeband",kt);_.set("convolution",qt);_.set("curvature",Jt);_.set("extractband",Kt);_.set("local",is);_.set("mask",ls);_.set("ndvi",ds);_.set("remap",gs);_.set("slope",Ps);_.set("stretch",Ss);function ge(a,e,t){const s=new et;return s.width=e,s.height=t,s.internalFormat=a.type===j.WEBGL2?ke.RGBA32F:$e.RGBA,s.samplingMode=q.NEAREST,s.dataType=We.FLOAT,s.isImmutable=a.type===j.WEBGL2,s.wrapMode=je.CLAMP_TO_EDGE,new tt(a,s)}function Fs(a,e,t,s){const{context:r,requestRender:i,allowDelayedRender:n}=a,o=s.createProgram(a,t);if(n&&i!=null&&!o.compiled)return i(),null;const{width:l,height:c}=t;return r.bindFramebuffer(e),r.setViewport(0,0,l,c),r.useProgram(o),o}function Cs(a){return _.get(a.toLowerCase())}function Ds(a,e,t,s){const r=a.rasterFunction.name.toLowerCase(),i=r==="reproject"?bs:Cs(r);if(i==null)return;const n=Fs(a,t,s,i);if(!n)return;i.bindTextureAndUniforms(a,n,s),e.draw();const{width:o,height:l}=s,c=ge(a.context,o,l);if(t.copyToTexture(0,0,o,l,0,0,c),r==="reproject")s.rasterTexture=c,s.projected=!0;else{const u=a.hasBranches?a.rasterFunction.id:0;s.functionTextures[u]=c}}class Ms extends st{constructor(){super(...arguments),this.name="raster",this._quad=null,this._rendererUniformInfos=new Map,this._fbo=null}dispose(){D(this._quad),D(this._fbo)}prepareState(e){const{context:t,renderPass:s}=e,r=s==="raster";t.setBlendingEnabled(!r),t.setBlendFunctionSeparate(E.ONE,E.ONE_MINUS_SRC_ALPHA,E.ONE,E.ONE_MINUS_SRC_ALPHA),t.setColorMask(!0,!0,!0,!0),t.setStencilWriteMask(0),t.setStencilTestEnabled(!r)}draw(e,t){if(!pt(t)||t.suspended)return;const{renderPass:s}=e;if(s==="raster-bitmap"){this._drawBitmap(e,t);return}if(s==="raster")return this._process(e,t);this._drawBitmap(e,t,!0)}_process(e,t){const{rasterFunction:s}=e,r=s.name==="Reproject";if(!(r?!(t.rasterTexture&&t.projected):!t.processed))return;const{timeline:n,context:o}=e;n.begin(this.name);const l=o.getBoundFramebufferObject(),c=o.getViewport();r||(t.processedTexture=D(t.processedTexture)),o.setStencilFunction(te.EQUAL,t.stencilRef,255),t.updateTexture(e),this._initQuad(o);const{isStandardRasterTileSize:u,fbo:d}=this._getRasterFBO(o,t.width,t.height);Ds(e,this._quad,d,t),u||d.dispose(),o.bindFramebuffer(l),o.setViewport(c.x,c.y,c.width,c.height),n.end(this.name)}_drawBitmap(e,t,s=!1){const{timeline:r,context:i}=e;if(r.begin(this.name),i.setStencilFunction(te.EQUAL,t.stencilRef,255),t.updateTexture(e),s&&!t.processedTexture){if(t.updateProcessedTexture(),!t.processedTexture){r.end(this.name);return}t.processed=!0}this._initBitmapCommonUniforms(t);const n=t.symbolizerParameters.type,o=Rt(n),{requestRender:l,allowDelayedRender:c}=e,{defines:u,program:d}=o.createProgram(e,t,s);if(c&&l!=null&&!d.compiled){l();return}i.useProgram(d);const h=this._getUniformInfos(n,i,d,u);this._quad||(this._quad=new re(i,[0,0,1,0,0,1,1,1])),o.bindTextureAndUniforms(e,d,t,h,s),this._quad.draw(),r.end(this.name)}_initBitmapCommonUniforms(e){if(!e.commonUniforms){const t=Ke(1,[0,0]),{transformGrid:s,width:r,height:i}=e,n=Ye(s,[r,i],[e.source.width,e.source.height],1,!1);e.commonUniforms={...t,...n,u_coordScale:e.coordScale}}}_getRasterFBO(e,t,s){const r=t===U||s===U;return r?(this._fbo||(this._fbo=this._createNewFBO(e,t,s)),{isStandardRasterTileSize:r,fbo:this._fbo}):{isStandardRasterTileSize:r,fbo:this._createNewFBO(e,t,s)}}_createNewFBO(e,t,s){const r=ge(e,t,s);return new rt(e,{colorTarget:qe.TEXTURE,depthStencilTarget:Ne.NONE,width:t,height:s},r)}_initQuad(e){this._quad||(this._quad=new re(e,[0,0,1,0,0,1,1,1]))}_getUniformInfos(e,t,s,r){const i=r.length>0?e+"-"+r.join("-"):e;if(this._rendererUniformInfos.has(i))return this._rendererUniformInfos.get(i);const n=Ze(t,s);return this._rendererUniformInfos.set(i,n),n}}class Ls extends he{constructor(e,t,s,r,i,n,o=null){super(e,t,s,r,i,n),this.bitmap=null,this.bitmap=new ft(o,null,null),this.bitmap.coordScale=[i,n],this.bitmap.once("isReady",()=>this.ready())}destroy(){super.destroy(),this.bitmap.destroy(),this.bitmap=null,this.stage=null}set stencilRef(e){this.bitmap.stencilRef=e}get stencilRef(){return this.bitmap.stencilRef}setTransform(e){super.setTransform(e),this.bitmap.transforms.dvs=this.transforms.dvs}_createTransforms(){return{dvs:z(),tileMat3:z()}}onAttach(){this.bitmap.stage=this.stage}onDetach(){this.bitmap.stage=null}}class zs extends de{constructor(){super(...arguments),this.isCustomTilingScheme=!1}createTile(e){const t=this._getTileBounds(e),[s,r]=this._tileInfoView.tileInfo.size,i=this._tileInfoView.getTileResolution(e.level);return new Ls(e,i,t[0],t[3],s,r)}prepareRenderPasses(e){const t=e.registerRenderPass({name:"imagery (tile)",brushes:[Ms],target:()=>this.children.map(s=>s.bitmap),drawPhase:A.MAP});return[...super.prepareRenderPasses(e),t]}doRender(e){if(!this.visible||e.drawPhase!==A.MAP)return;const{rasterFunctionChain:t}=this;if(!t){e.renderPass="raster-bitmap",super.doRender(e);return}const[s,r]=this._tileInfoView.tileInfo.size;if(e.renderPass="raster",e.rasterFunction={name:"Reproject",parameters:{targetImageSize:[s,r],requireBilinear:t.hasSurfaceFunction},pixelType:"f32",id:0,isNoopProcess:!1},super.doRender(e),t!=null&&t.functions.length){const{functions:i,hasBranches:n}=t;for(let o=0;o<i.length;o++){const l=i[o];l.name==="Constant"||l.name==="Identity"||(e.renderPass="raster",e.rasterFunction=l,e.hasBranches=n,super.doRender(e))}}e.rasterFunction=null,e.renderPass="bitmap",super.doRender(e)}_getTileBounds(e){const t=this._tileInfoView.getTileBounds(le(),e);if(this.isCustomTilingScheme&&e.world){const{tileInfo:s}=this._tileInfoView,r=we(s.spatialReference);if(r){const i=s.lodAt(e.level);if(!i)return t;const{resolution:n}=i,o=r/n%s.size[0],l=o?(s.size[0]-o)*n:0;t[0]-=l*e.world,t[2]-=l*e.world}}return t}}const Bs=[0,0];let g=class extends ve{constructor(){super(...arguments),this._emptyTilePixelBlock=null,this._tileStrategy=null,this._tileInfoView=null,this._fetchQueue=null,this._blockCacheRegistryUrl=null,this._blockCacheRegistryId=null,this._srcResolutions=[],this.previousLOD=null,this._needBlockCacheUpdate=!1,this._globalSymbolizerParams=null,this._symbolizerParams=null,this._abortController=null,this._isCustomTilingScheme=!1,this._rasterFunctionState="na",this._globalUpdateRequested=!1,this.attached=!1,this.timeExtent=null,this.redrawOrRefetch=Pe(async(e={})=>{if(!this.previousLOD||this.layerView.suspended)return;const t=this._rasterFunctionState;e.reprocess&&(await this.updatingHandles.addPromise(this.layer.updateRasterFunction()),this.updateRasterFunctionParameters());const s=this._rasterFunctionState,{type:r}=this;return e.refetch||r!=="raster"&&!!e.reprocess||s==="cpu"||t==="cpu"?this.updatingHandles.addPromise(this.doRefresh()):this.updatingHandles.addPromise(this._redrawImage(e.signal))})}get useWebGLForProcessing(){return this._get("useWebGLForProcessing")??!0}set useWebGLForProcessing(e){this._set("useWebGLForProcessing",e)}get useProgressiveUpdate(){return this._get("useProgressiveUpdate")??!0}set useProgressiveUpdate(e){if(this._tileStrategy&&this.useProgressiveUpdate!==e){this._tileStrategy.destroy(),this.container.removeAllChildren();const t=this._getCacheSize(e);this._tileStrategy=new X({cachePolicy:"purge",acquireTile:s=>this.acquireTile(s),releaseTile:s=>this.releaseTile(s),cacheSize:t,tileInfoView:this._tileInfoView}),this._set("useProgressiveUpdate",e),this.layerView.requestUpdate()}}update(e){var n;this._fetchQueue.pause(),this._fetchQueue.state=e.state,this._tileStrategy.update(e),this._fetchQueue.resume();const{extent:t,resolution:s,scale:r}=e.state,i=this._tileInfoView.getClosestInfoForScale(r);if(this.layer.raster){if(!this.useProgressiveUpdate||this._needBlockCacheUpdate){const l=this._srcResolutions[i.level],c=t.toJSON?t:Ie.fromJSON(t);ie(this._blockCacheRegistryUrl,this._blockCacheRegistryId,c,s,l,this.layer.raster.ioConfig.sampling)}this._needBlockCacheUpdate=!1,((n=this.previousLOD)==null?void 0:n.level)!==i.level&&(this.previousLOD=i,this._symbolizerParams!=null&&!this.layerView.hasTilingEffects&&this._updateSymbolizerParams(),this._tileStrategy.updateCacheSize(0))}}moveEnd(){(this.layerView.hasTilingEffects||!this.useProgressiveUpdate)&&(this._abortController&&this._abortController.abort(),this._abortController=new AbortController,this._fetchQueue.length===0&&this._redrawImage(this._abortController.signal).then(()=>{this._globalUpdateRequested=!1,this.layerView.requestUpdate()}));const e=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy.updateCacheSize(e),this.layerView.requestUpdate()}get updating(){var e;return((e=this._fetchQueue)==null?void 0:e.updating)||this._globalUpdateRequested||!!(this.updatingHandles&&this.updatingHandles.updating)}attach(){Ue("2d").supportsTextureFloat||(this.useWebGLForProcessing=!1),this._initializeTileInfo(),this._tileInfoView=new Re(this.layerView.tileInfo,this.layerView.fullExtent);const e=this._computeFetchConcurrency();this._fetchQueue=new Se({tileInfoView:this._tileInfoView,concurrency:e,process:(s,r)=>this._fetchTile1(s,r)});const t=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy=new X({cachePolicy:"purge",acquireTile:s=>this.acquireTile(s),releaseTile:s=>this.releaseTile(s),cacheSize:t,tileInfoView:this._tileInfoView}),this._updateBlockCacheRegistry()}detach(){this._tileStrategy.destroy(),this._fetchQueue.clear(),this.container.removeAllChildren(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null,ne(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryUrl=this._blockCacheRegistryId=null}acquireTile(e){const t=this.container.createTile(e);return this._enqueueTileFetch(t),this.layerView.requestUpdate(),this._needBlockCacheUpdate=!0,this._globalUpdateRequested=this.layerView.hasTilingEffects||!this.useProgressiveUpdate,t}releaseTile(e){this._fetchQueue.abort(e.key.id),this.container.removeChild(e),e.once("detach",()=>{e.destroy(),this.layerView.requestUpdate()}),this.layerView.requestUpdate()}createEmptyTilePixelBlock(e=null){const t=e==null||e.join(",")===this._tileInfoView.tileInfo.size.join(",");if(t&&this._emptyTilePixelBlock!=null)return this._emptyTilePixelBlock;e=e||this._tileInfoView.tileInfo.size;const[s,r]=e,i=new Ee({width:s,height:r,pixels:[new Uint8Array(s*r)],mask:new Uint8Array(s*r),pixelType:"u8"});return t&&(this._emptyTilePixelBlock=i),i}_getBandIds(){if(!("rasterFunctionChain"in this.container&&this.container.rasterFunctionChain))return this.layer.bandIds;const{bandIds:e,raster:t}=this.layer,s="rasterFunction"in t?t.rasterFunction.rawInputBandIds:null;return!(e!=null&&e.length)||!(s!=null&&s.length)||t.rasterInfo.bandCount===1?e||s:e.map(r=>s[Math.min(r,s.length-1)])}updateRasterFunctionParameters(){}_fetchTile1(e,t){const s=t!=null?t.signal:null,r=this.canUseWebGLForProcessing(),{layerView:i}=this,{tileInfo:n}=i,o=!n.isWrappable&&at(i.view.spatialReference)!=null,l=r&&this.layer.raster.hasUniqueSourceStorageInfo,c={allowPartialFill:!0,datumTransformation:i.datumTransformation,interpolation:r?"nearest":this.layer.interpolation,registryId:this._blockCacheRegistryId,requestRawData:l,skipRasterFunction:this.type==="raster"&&this.container.rasterFunctionChain!=null,signal:s,srcResolution:this._srcResolutions[e.level],timeExtent:i.timeExtent,tileInfo:n,disableWrapAround:o};return this.fetchTile(e,c)}_getCacheSize(e){return e?40:0}_initializeTileInfo(){const{layerView:e}=this,t=e.view.spatialReference,s=new Fe({x:e.fullExtent.xmin,y:e.fullExtent.ymax,spatialReference:t});if(this._canUseLayerLODs()){const{lods:c}=this.layer.tileInfo,u=c.map(({scale:p})=>p),d=W.create({spatialReference:t,size:U,scales:u}),h=t.isGeographic?.01*1e-5:.01;if(this._isCustomTilingScheme=Math.abs(d.origin.x-s.x)>h,(d.origin.x===0||d.origin.x>s.x)&&(d.origin=s),!this._isCustomTilingScheme){const w=W.create({spatialReference:t,size:U}).lods.map(({scale:v})=>v);this._isCustomTilingScheme=u.some(v=>!w.some(P=>Math.abs(P-v)<.001))}e.set("tileInfo",d),this._srcResolutions=c.map(({resolution:p})=>({x:p,y:p}));return}const{scales:i,srcResolutions:n,isCustomTilingScheme:o}=ot(this.layer.rasterInfo,t,U),l=W.create({spatialReference:t,size:U,scales:i});(l.origin.x===0||l.origin.x>s.x)&&(l.origin=s),this._isCustomTilingScheme=o,e.set("tileInfo",l),this._srcResolutions=n??[]}_canUseLayerLODs(){var l;const{layer:e,layerView:t}=this;if(e.raster.tileType!=="Map")return!1;const{lods:s}=e.tileInfo,r=(l=t.view.constraints)==null?void 0:l.effectiveLODs;if(!((r==null?void 0:r.length)===s.length&&r.every(({scale:c},u)=>Math.abs(c-s[u].scale)<.001)))return!1;const n=[];for(let c=0;c<s.length-1;c++)n.push(Math.round(10*s[c].resolution/s[c+1].resolution)/10);return n.some(c=>c!==n[0])}_computeFetchConcurrency(){const{blockBoundary:e}=this.layer.rasterInfo.storageInfo,t=e[e.length-1];return(t.maxCol-t.minCol+1)*(t.maxRow-t.minRow+1)>64?2:10}async _enqueueTileFetch(e,t){this.updatingHandles.addPromise(this._enqueueTileFetch1(e,t))}async _enqueueTileFetch1(e,t){var s;if(!this._fetchQueue.has(e.key.id)){try{const r=await this._fetchQueue.push(e.key),i=this._getBandIds();let n=!this.useProgressiveUpdate||this.layerView.hasTilingEffects&&!this._globalSymbolizerParams;if(this._globalUpdateRequested&&!this.layerView.moving&&this._fetchQueue.length===0){n=!1;try{await this._redrawImage((s=this._abortController)==null?void 0:s.signal)}catch(u){M(u)&&L.getLogger(this.declaredClass).error(u)}this._globalUpdateRequested=!1}(this.canUseWebGLForProcessing()||this.type==="rasterVF")&&!this.layerView.hasTilingEffects&&this._symbolizerParams==null&&this._updateSymbolizerParams();const l=this._tileInfoView.getTileCoords(Bs,e.key),c=this._tileInfoView.getTileResolution(e.key);await this.updateTileSource(e,{source:r,symbolizerParams:this._symbolizerParams,globalSymbolizerParams:this._globalSymbolizerParams,suspended:n,bandIds:i,coords:l,resolution:c}),e.once("attach",()=>this.layerView.requestUpdate()),this.container.addChild(e)}catch(r){M(r)||L.getLogger(this.declaredClass).error(r)}this.layerView.requestUpdate()}}async _redrawImage(e){if(this.container.children.length===0)return;await this.layer.updateRenderer(),this.layerView.hasTilingEffects?await this._updateGlobalSymbolizerParams(e):(this._updateSymbolizerParams(),this._globalSymbolizerParams=null);const t=this.container.children.map(async s=>this.updateTileSymbolizerParameters(s,{local:this._symbolizerParams,global:this._globalSymbolizerParams}));await Y(t),this.container.requestRender()}async _updateGlobalSymbolizerParams(e){const t={srcResolution:this._srcResolutions[this.previousLOD.level],registryId:this._blockCacheRegistryId,signal:e},s=await this.layer.fetchPixels(this.layerView.view.extent,this.layerView.view.width,this.layerView.view.height,t);if(!(s&&s.pixelBlock))return;const{resolution:r}=this.previousLOD,i=this._getBandIds(),n=this.layer.symbolizer.generateWebGLParameters({pixelBlock:ue(s.pixelBlock,i),isGCS:this.layerView.view.spatialReference.isGeographic,resolution:{x:r,y:r},bandIds:i});!this.canUseWebGLForProcessing()&&n&&n.type==="stretch"&&this.layer.renderer&&this.layer.renderer.type==="raster-stretch"&&(n.factor=n.factor.map(o=>o*255),n.outMin=Math.round(n.outMin*255),n.outMax=Math.round(n.outMax*255)),this._globalSymbolizerParams=n}_updateSymbolizerParams(){const{resolution:e}=this.previousLOD,t=this._getBandIds();this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null,isGCS:this.layerView.view.spatialReference.isGeographic,resolution:{x:e,y:e},bandIds:t})}_updateBlockCacheRegistry(e=!1){const{layer:t,layerView:s}=this,{url:r,raster:i}=t,{multidimensionalDefinition:n}=t.normalizeRasterFetchOptions({multidimensionalDefinition:t.multidimensionalDefinition,timeExtent:s.timeExtent}),o=i.rasterInfo.multidimensionalInfo?i.getSliceIndex(n):null,l=nt(r,o);if(l!==this._blockCacheRegistryUrl){if(this._blockCacheRegistryUrl!=null&&ne(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryId=it(l,i.rasterInfo),e){const{view:c}=s,u=this._tileInfoView.getClosestInfoForScale(c.scale),d=this._srcResolutions[u.level];ie(l,this._blockCacheRegistryId,c.extent,c.resolution,d,i.ioConfig.sampling)}this._blockCacheRegistryUrl=l}}async doRefresh(){if(!this.attached)return;await this.layer.updateRenderer(),this.layerView.hasTilingEffects||this._updateSymbolizerParams(),this._updateBlockCacheRegistry(!0),this._fetchQueue.reset();const e=[];this._globalUpdateRequested=this.layerView.hasTilingEffects||!this.useProgressiveUpdate,this._tileStrategy.tiles.forEach(t=>e.push(this._enqueueTileFetch(t))),await Y(e)}};f([m()],g.prototype,"_fetchQueue",void 0);f([m()],g.prototype,"_globalUpdateRequested",void 0);f([m()],g.prototype,"attached",void 0);f([m()],g.prototype,"container",void 0);f([m()],g.prototype,"layer",void 0);f([m()],g.prototype,"layerView",void 0);f([m()],g.prototype,"type",void 0);f([m()],g.prototype,"useWebGLForProcessing",null);f([m()],g.prototype,"useProgressiveUpdate",null);f([m()],g.prototype,"timeExtent",void 0);f([m()],g.prototype,"updating",null);g=f([B("esri.views.2d.layers.imagery.BaseImageryTileSubView2D")],g);let R=class extends g{constructor(){super(...arguments),this.type="raster"}attach(){super.attach(),this.container=new zs(this._tileInfoView),this.container.isCustomTilingScheme=this._isCustomTilingScheme,this.updateRasterFunctionParameters()}detach(){super.detach(),this.container.removeAllChildren(),this.container=null}canUseWebGLForProcessing(){return this.useWebGLForProcessing&&this.layer.symbolizer.canRenderInWebGL&&!(this.layer.interpolation==="majority"&&fe(this.layer))}fetchTile(e,t){return this.layer.fetchTile(e.level,e.row,e.col,t)}updateRasterFunctionParameters(){const{raster:e,type:t}=this.layer,{container:s}=this;if(e.datasetFormat!=="Function"||t==="wcs"){s.rasterFunctionChain=null,s.children.forEach(h=>{const{bitmap:p}=h;p&&(p.suspended=!0,p.processed=!1,p.projected&&(p.invalidateTexture(),p.rasterTexture=null))}),this._rasterFunctionState="na";return}const r=this._rasterFunctionState,{rasterFunction:i,primaryRasters:n}=e,o=i.supportsGPU&&(!n||n.rasters.length<=1),l=o?i.flatWebGLFunctionChain:null,{renderer:c}=this.layer,u=!o||!(l!=null&&l.functions.length)||c.type==="raster-stretch"&&c.dynamicRangeAdjustment||!this.canUseWebGLForProcessing();s.rasterFunctionChain=u?null:l;const d=i==null?"na":s.rasterFunctionChain?"gpu":"cpu";s.children.forEach(h=>{const{bitmap:p}=h;p&&(p.suspended=r!==d,p.processed=!1,p.processedTexture=null)}),this._rasterFunctionState=d}async updateTileSource(e,t){const s=this._getBandIds(),r=this._getLayerInterpolation(),i=this.canUseWebGLForProcessing(),{source:n,globalSymbolizerParams:o,suspended:l,coords:c,resolution:u}=t,d=this.layerView.hasTilingEffects?o:t.symbolizerParams,{bitmap:h}=e;if([h.x,h.y]=c,h.resolution=u,n&&n!=null&&n.pixelBlock!=null){const p={extent:n.extent,pixelBlock:n.pixelBlock};if(h.rawPixelData=p,i)h.source=n.pixelBlock,h.isRendereredSource=!1;else{const w=await this.layer.applyRenderer(p,(o==null?void 0:o.type)==="stretch"?o:void 0);h.source=w,h.isRendereredSource=!0}h.symbolizerParameters=i?d:null,i?h.transformGrid||(h.transformGrid=n.transformGrid):h.transformGrid=null}else{const p=this.createEmptyTilePixelBlock();h.source=p,h.symbolizerParameters=i?d:null,h.transformGrid=null}h.bandIds=i?s:null,h.width=this._tileInfoView.tileInfo.size[0],h.height=this._tileInfoView.tileInfo.size[1],h.interpolation=r,h.suspended=l,h.invalidateTexture()}async updateTileSymbolizerParameters(e,t){const{local:s,global:r}=t,i=this._getBandIds(),n=this._getLayerInterpolation(),o=this.canUseWebGLForProcessing(),{bitmap:l}=e,{rawPixelData:c}=l;!o&&c!=null?(l.source=await this.layer.applyRenderer(c,(r==null?void 0:r.type)==="stretch"?r:void 0),l.isRendereredSource=!0):(l.isRendereredSource&&c!=null&&(l.source=c.pixelBlock),l.isRendereredSource=!1),l.symbolizerParameters=o?this.layerView.hasTilingEffects?r:s:null,l.bandIds=o?i:null,l.interpolation=n,l.suspended=!1}_getLayerInterpolation(){const e=this.layer.renderer.type;if(e==="raster-colormap"||e==="unique-value"||e==="class-breaks")return"nearest";const{interpolation:t}=this.layer,{renderer:s}=this.layer;return s.type==="raster-stretch"&&s.colorRamp!=null?t==="bilinear"||t==="cubic"?"bilinear":"nearest":t}};f([m()],R.prototype,"container",void 0);f([m()],R.prototype,"layer",void 0);f([m()],R.prototype,"type",void 0);R=f([B("esri.views.2d.layers.imagery.ImageryTileView2D")],R);const Vs=R;class Gs extends he{constructor(e,t,s,r,i,n,o=null){super(e,t,s,r,i,n),this.tileData=new Le(o),this.tileData.coordScale=[i,n],this.tileData.once("isReady",()=>this.ready())}destroy(){super.destroy(),this.tileData.destroy(),this.tileData=null,this.stage=null}set stencilRef(e){this.tileData.stencilRef=e}get stencilRef(){return this.tileData.stencilRef}_createTransforms(){return{dvs:z(),tileMat3:z()}}setTransform(e){super.setTransform(e);const t=this.resolution/(e.resolution*e.pixelRatio),s=this.transforms.tileMat3,[r,i]=this.tileData.offset,n=[this.x+r*this.resolution,this.y-i*this.resolution],[o,l]=e.toScreenNoRotation([0,0],n),{symbolTileSize:c}=this.tileData.symbolizerParameters,u=Math.round((this.width-this.tileData.offset[0])/c)*c,d=Math.round((this.height-this.tileData.offset[1])/c)*c,h=u/this.rangeX*t,p=d/this.rangeY*t;Ce(s,h,0,0,0,p,0,o,l,1),oe(this.transforms.dvs,e.displayViewMat3,s),this.tileData.transforms.dvs=this.transforms.dvs}onAttach(){this.tileData.stage=this.stage}onDetach(){this.tileData.stage=null}}class Es extends de{constructor(){super(...arguments),this.isCustomTilingScheme=!1,this.symbolTypes=["triangle"]}createTile(e){const t=this._tileInfoView.getTileBounds(le(),e),[s,r]=this._tileInfoView.tileInfo.size,i=this._tileInfoView.getTileResolution(e.level);return new Gs(e,i,t[0],t[3],s,r)}prepareRenderPasses(e){const t=e.registerRenderPass({name:"imagery (vf tile)",brushes:[ze],target:()=>this.children.map(s=>s.tileData),drawPhase:A.MAP});return[...super.prepareRenderPasses(e),t]}doRender(e){!this.visible||e.drawPhase!==A.MAP||this.symbolTypes.forEach(t=>{e.renderPass=t,super.doRender(e)})}}let S=class extends g{constructor(){super(...arguments),this._handle=null,this.type="rasterVF"}canUseWebGLForProcessing(){return!1}async fetchTile(e,t){t={...t,interpolation:"nearest",requestProjectedLocalDirections:!0};const s=await this.layer.fetchTile(e.level,e.row,e.col,t);return this.layer.rasterInfo.dataType==="vector-magdir"&&(s!=null&&s.pixelBlock)&&(s.pixelBlock=await this.layer.convertVectorFieldData(s.pixelBlock,t)),s}updateTileSource(e,t){const s=t.symbolizerParams,{tileData:r}=e;r.key=e.key,r.width=this._tileInfoView.tileInfo.size[0],r.height=this._tileInfoView.tileInfo.size[1];const{symbolTileSize:i}=s,{source:n}=t;if(r.offset=this._getTileSymbolOffset(r.key,i),n!=null&&n.pixelBlock!=null){const o={extent:n.extent,pixelBlock:n.pixelBlock};r.rawPixelData=o,r.symbolizerParameters=s,r.source=this._sampleVectorFieldData(n.pixelBlock,s,r.offset)}else{const o=[Math.round((this._tileInfoView.tileInfo.size[0]-r.offset[0])/i),Math.round((this._tileInfoView.tileInfo.size[1]-r.offset[1])/i)],l=this.createEmptyTilePixelBlock(o);r.source=l,r.symbolizerParameters=s}return r.invalidateVAO(),Promise.resolve()}updateTileSymbolizerParameters(e,t){var l;const s=t.local,{symbolTileSize:r}=s,{tileData:i}=e;i.offset=this._getTileSymbolOffset(i.key,r);const n=i.symbolizerParameters.symbolTileSize;i.symbolizerParameters=s;const o=(l=i.rawPixelData)==null?void 0:l.pixelBlock;return o!=null&&n!==r&&(i.source=this._sampleVectorFieldData(o,i.symbolizerParameters,i.offset)),Promise.resolve()}attach(){super.attach(),this.container=new Es(this._tileInfoView),this.container.isCustomTilingScheme=this._isCustomTilingScheme,this._updateSymbolType(this.layer.renderer),this._handle=I(()=>this.layer.renderer,e=>this._updateSymbolType(e))}detach(){var e;super.detach(),this.container.removeAllChildren(),(e=this._handle)==null||e.remove(),this._handle=null,this.container=null}_getTileSymbolOffset(e,t){const s=e.col*this._tileInfoView.tileInfo.size[0]%t,r=e.row*this._tileInfoView.tileInfo.size[1]%t;return[s>t/2?t-s:-s,r>t/2?t-r:-r]}_sampleVectorFieldData(e,t,s){const{symbolTileSize:r}=t;return Ae(e,"vector-uv",r,s)}_updateSymbolType(e){e.type==="vector-field"&&(this.container.symbolTypes=e.style==="wind-barb"?["scalar","triangle"]:e.style==="simple-scalar"?["scalar"]:["triangle"])}};f([m()],S.prototype,"container",void 0);f([m()],S.prototype,"layer",void 0);f([m()],S.prototype,"type",void 0);S=f([B("esri.views.2d.layers.imagery.VectorFieldTileView2D")],S);const As=S,Os=a=>{let e=class extends a{constructor(){super(...arguments),this._rasterFieldPrefix="Raster.",this.layer=null,this.view=null,this.tileInfo=null}get fullExtent(){return this._getfullExtent()}_getfullExtent(){return this.projectFullExtent(this.view.spatialReference)}get hasTilingEffects(){return this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment}get datumTransformation(){return ae(this.layer.fullExtent,this.view.spatialReference,!0)}supportsSpatialReference(s){return!!this.projectFullExtent(s)}projectFullExtent(s){const r=this.layer.fullExtent,i=ae(r,s,!1);return lt(r,s,i)}async fetchPopupFeatures(s,r){const{layer:i}=this;if(!s)throw new Z("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:i});const{popupEnabled:n}=i,o=ut(i,r);if(!n||o==null)throw new Z("imageryTileLayerView:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:n,popupTemplate:o});const l=[],{value:c,magdirValue:u}=await i.identify(s,{timeExtent:this.timeExtent});let d="";if(c&&c.length){i.type==="imagery-tile"&&i.hasStandardTime()&&c[0]!=null?d=c.map(k=>i.getStandardTimeValue(k)).join(", "):d=c.join(", ");const h={ObjectId:0},p="Raster.ServicePixelValue";h[p]=d;const w=i.rasterInfo.attributeTable;if(w!=null){const{fields:k,features:_e}=w,H=k.find(({name:T})=>T.toLowerCase()==="value"),V=H?_e.find(T=>String(T.attributes[H.name])===d):null;if(V){for(const T in V.attributes)if(V.attributes.hasOwnProperty(T)){const ye=this._rasterFieldPrefix+T;h[ye]=V.attributes[T]}}}const v=i.rasterInfo.dataType;(v==="vector-magdir"||v==="vector-uv")&&(h["Raster.Magnitude"]=u==null?void 0:u[0],h["Raster.Direction"]=u==null?void 0:u[1]);const P=new ce(this.fullExtent.clone(),null,h);P.layer=i,P.sourceLayer=P.layer,l.push(P)}return l}};return f([m()],e.prototype,"layer",void 0),f([m(ct)],e.prototype,"timeExtent",void 0),f([m()],e.prototype,"view",void 0),f([m()],e.prototype,"fullExtent",null),f([m()],e.prototype,"tileInfo",void 0),f([m({readOnly:!0})],e.prototype,"hasTilingEffects",null),f([m()],e.prototype,"datumTransformation",null),e=f([B("esri.views.layers.ImageryTileLayerView")],e),e};let F=class extends Os(ht(Ve(Ge))){constructor(){super(...arguments),this._useWebGLForProcessing=!0,this._useProgressiveUpdate=!0,this.subview=null}get useWebGLForProcessing(){return this._useWebGLForProcessing}set useWebGLForProcessing(e){this._useWebGLForProcessing=e,this.subview&&"useWebGLForProcessing"in this.subview&&(this.subview.useWebGLForProcessing=e)}get useProgressiveUpdate(){return this._useWebGLForProcessing}set useProgressiveUpdate(e){this._useProgressiveUpdate=e,this.subview&&"useProgressiveUpdate"in this.subview&&(this.subview.useProgressiveUpdate=e)}update(e){var t;(t=this.subview)==null||t.update(e),this.notifyChange("updating")}isUpdating(){return!this.subview||this.subview.updating}attach(){this.layer.increaseRasterJobHandlerUsage(),this._updateSubview(),this.addAttachHandles([I(()=>{const{layer:e}=this;return{bandIds:e.bandIds,renderer:e.renderer,interpolation:e.interpolation,multidimensionalDefinition:e.multidimensionalDefinition,rasterFunction:e.type==="imagery-tile"?e.rasterFunction:null}},(e,t)=>{var d,h;const r=e.interpolation!==(t==null?void 0:t.interpolation)&&(e.interpolation==="majority"||(t==null?void 0:t.interpolation)==="majority")&&fe(this.layer),n=e.renderer!==(t==null?void 0:t.renderer)&&((d=t==null?void 0:t.renderer)==null?void 0:d.type)!==((h=e.renderer)==null?void 0:h.type);n&&this._updateSubview();const o=e.multidimensionalDefinition!==(t==null?void 0:t.multidimensionalDefinition),l=e.rasterFunction!==(t==null?void 0:t.rasterFunction),c=l&&!this._useWebGLForProcessing,u=o||r||n||c;this.subview.redrawOrRefetch({refetch:u,reprocess:l}).catch(p=>{M(p)||L.getLogger(this.declaredClass).error(p)}),this.notifyChange("updating")}),I(()=>this.layer.blendMode??"normal",e=>{this.subview.container.blendMode=e},K),I(()=>this.layer.effect??null,e=>{this.subview.container.effect=e},K),I(()=>this.layer.multidimensionalSubset??null,(e,t)=>{const{multidimensionalDefinition:s}=this.layer;s!=null&&ee(s,e)!==ee(s,t)&&(this.subview.redrawOrRefetch({refetch:!0}).catch(r=>{M(r)||L.getLogger(this.declaredClass).error(r)}),this.notifyChange("updating"))},De),I(()=>this.timeExtent,()=>{this.subview.timeExtent=this.timeExtent,this.subview.redrawOrRefetch({refetch:!0}).catch(e=>{M(e)||L.getLogger(this.declaredClass).error(e)})},Me)])}detach(){var e;this.layer.decreaseRasterJobHandlerUsage(),this._detachSubview(this.subview),(e=this.subview)==null||e.destroy(),this.subview=null}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.subview.moveEnd()}async hitTest(e,t){return[{type:"graphic",layer:this.layer,mapPoint:e,graphic:new ce({attributes:{},geometry:e.clone()})}]}doRefresh(){return this.subview?this.subview.doRefresh():Promise.resolve()}_updateSubview(){var r;const e=this.layer.renderer.type==="vector-field"?"rasterVF":this.layer.renderer.type==="flow"?"flow":"raster";if(this.subview){if(this.subview.type===e){this._attachSubview(this.subview);return}this._detachSubview(this.subview),(r=this.subview)==null||r.destroy(),this.subview=null}const{layer:t}=this;let s;if(e==="rasterVF"?s=new As({layer:t,layerView:this}):e==="flow"?s=new Be({layer:t,layerView:this}):s=new Vs({layer:t,layerView:this}),"useWebGLForProcessing"in s&&(s.useWebGLForProcessing=this._useWebGLForProcessing),"useProgressiveUpdate"in s&&(s.useProgressiveUpdate=this._useProgressiveUpdate),"previousLOD"in s){const{subview:i}=this;s.previousLOD=i&&"previousLOD"in i?i.previousLOD:null}this._attachSubview(s),this.subview=s,this.requestUpdate()}_attachSubview(e){e&&!e.attached&&(e.attach(),e.attached=!0,this.container.addChildAt(e.container,0),e.container.blendMode=this.layer.blendMode,e.container.effect=this.layer.effect)}_detachSubview(e){e!=null&&e.attached&&(this.container.removeChild(e.container),e.detach(),e.attached=!1)}};f([m()],F.prototype,"subview",void 0);f([m()],F.prototype,"useWebGLForProcessing",null);f([m()],F.prototype,"useProgressiveUpdate",null);F=f([B("esri.views.2d.layers.ImageryTileLayerView2D")],F);const Mr=F;export{Mr as default};
