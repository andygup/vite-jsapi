import{fj as Bs,b6 as Zs,lH as Ys,lI as Xs,dn as Qs,mE as Js,dq as zt,z as Vt,cm as he,C as g,mF as Ks,mG as er,dg as V,mf as b,ly as tr,kp as Ji,lF as Ki,e7 as en,iP as A,ds as re,b$ as L,mm as Rn,kr as Ye,dt as Dn,ct as Ti,mH as te,mI as qe,mJ as tn,d6 as _e,cU as pi,e as u,y as p,a as I,m as pe,t as Yt,l as ht,g as x,bg as F,gZ as ir,d as An,at as C,mK as nr,mL as Xe,cM as vt,mM as lt,mN as fi,kC as E,mO as sr,cL as Ln,kI as zn,dk as ae,kw as q,mP as rr,a3 as Ue,mv as mi,cJ as gi,cK as Ke,mw as nn,mA as ar,mQ as or,mR as lr,mS as dr,mT as cr,li as It,lN as w,cV as ni,lP as We,fc as pt,mU as Vn,m2 as ce,bV as Hn,mV as sn,mW as ur,cN as hr,mX as pr,mY as fr,mZ as mr,bT as Gt,bX as _i,m_ as Ve,dR as In,l_ as gr,lZ as oe,m$ as rn,ma as si,cj as _r,m9 as xt,cu as ie,m8 as Gn,bB as Fn,kE as ve,fi as yi,n0 as yr,bk as vr,bQ as Ge,me as Nn,n1 as ri,mn as Sr,lQ as Te,dW as an,n2 as wr,f8 as Pr,eS as on,n3 as xr,V as et,h as Ft,ms as ft,mr as St,mq as dt,n4 as br,n5 as Mr,n6 as vi,n7 as Si,jk as Re,mc as $r,dv as Ri,d$ as Cr,aY as Qe,bi as Er,df as Or,_ as bt,n8 as Tr,lC as kn,mi as Rr,aK as Dr,P as ln,R as Ar,bo as Lr,bJ as Nt,n9 as zr,be as jn,fY as qn,bf as mt,x as Di,aI as wi,bs as Un,aM as Vr,aL as Ai,na as Pi,e5 as Hr,A as Ir,nb as Gr,nc as Fr,cg as Nr,nd as Wn,m3 as kr,m4 as jr,ne as qr,nf as Ur,ng as st,lR as Wr,lV as Br,ai as dn}from"./index-d29f6b97.js";import{i as Xt,u as Zr,a as Bn,b as xe,d as Yr,r as Xr,t as Qr}from"./LineVisualElement-db91c665.js";import{t as O,r as Jr,u as Kr}from"./LengthDimension-1fe5a076.js";import{r as ea,f as Zn,a as De,e as ta,b as ia,u as H,g as na,h as sa}from"./Segment-1413661a.js";import{T as ra,$ as Yn,e as ct,U as Xn,R as aa,L as oa,f as wt,N as Li,j as zi,D as la,C as Qn,v as cn,a as da,b as ca,c as ua,l as ha}from"./analysisViewUtils-c120a7c9.js";import{F as pa,H as Jn,A as Vi,n as fa}from"./Factory-71ec2c06.js";import{c as ma,v as ga,b as R,p as un}from"./elevationInfoUtils-77250170.js";import{t as Kn,P as _a}from"./RightAngleQuadVisualElement-62adb2cd.js";import{c as ya,y as hn}from"./PointVisualElement-df95dd99.js";import{y as va,p as Sa}from"./colorUtils-c0f43caf.js";import{c as wa}from"./ImageMaterial-be81a34f.js";import{b as N,L as ai,m as Pa,_ as xa,p as ba,w as Ma}from"./EditGeometryOperations-31ebd7de.js";import{r as $a}from"./dehydratedFeatureComparison-9b093626.js";import{s as Ca}from"./RenderTexture-fb0e3709.js";function Ea(i){const e=Bs(i),t=e===Ys?Xs:e;return Zs(i,t)?t:i}var Be;function Oa(i,e){const{spatialReference:t}=i;return Qs(t,e.spatialReference)?(Mt[0]=i.x,Mt[1]=i.y,Mt[2]=i.hasZ?i.z:0,$t[0]=e.x,$t[1]=e.y,$t[2]=e.hasZ?e.z:0,es(Mt,$t,t)):null}function es(i,e,t){const n=Ta(i,e,t,Be.Direct);return n!=null?ea(n.direct,n.unit):null}function Ta(i,e,t,n){const s=Ea(t),r=Js(s);if(r==null)return null;const a=e[2]-i[2];if(n===Be.Vertical)return{verticalSigned:a,unit:r};if(!zt(i,t,oi,s)||!zt(e,t,Ct,s))return null;if(n===Be.Direct)return{direct:Vt(Ct,oi),unit:r};if(he(Et,i[0],i[1],e[2]),!zt(Et,t,Et,s))return null;const l=Vt(Et,Ct);return n===Be.Horizontal?{horizontal:l,unit:r}:{direct:Vt(Ct,oi),horizontal:l,vertical:Math.abs(a),unit:r}}(function(i){i[i.Direct=0]="Direct",i[i.Horizontal=1]="Horizontal",i[i.Vertical=2]="Vertical"})(Be||(Be={}));const Mt=g(),$t=g(),oi=g(),Ct=g(),Et=g();function Ra(i,e,t){if(i==null)return null;const n=i.dimensionSegment.startRenderSpace,s=i.dimensionSegment.endRenderSpace,r=es(n,s,i.spatialReference);if(r==null)return null;const a=e===O.Vertical?Ks(r.value,r.unit,t):er(r.value,r.unit,t);return Zn(r,a)}function kt(i){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,dimension:{offset:n,measureType:s,orientation:r}}=i;return{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,offset:n,measureType:s,orientation:r}}function jt({elevationAlignedStartPoint:i,elevationAlignedEndPoint:e,offset:t,measureType:n,orientation:s},r,a=null){if(i==null||e==null)return null;const l=is(a!=null?a.directSegment:new De,{elevationAlignedStartPoint:i,elevationAlignedEndPoint:e},r),o=a!=null?a.primaryOffsetAxis:g();Qt(o,{measureType:n,elevationAlignedStartPoint:i,elevationAlignedEndPoint:e,directSegment:l,orientation:s,renderCoordsHelper:r});const d=a!=null?a.dimensionSegment:new De;return Hi({elevationAlignedStartPoint:i,elevationAlignedEndPoint:e})&&n===O.Vertical?(V(d.startRenderSpace,l.startRenderSpace),V(d.endRenderSpace,l.endRenderSpace)):ns(d,{offsetAxis:o,offset:t,relativeToSegment:l,renderCoordsHelper:r}),{directSegment:l,dimensionSegment:d,primaryOffsetAxis:o,spatialReference:r.spatialReference}}function pn(i,e,t,n){return e===gt.Start?(V(i.startRenderSpace,t.startRenderSpace),V(i.endRenderSpace,n.startRenderSpace)):(V(i.startRenderSpace,t.endRenderSpace),V(i.endRenderSpace,n.endRenderSpace)),i}var gt;function Da(i,e,t,n){te(i.startRenderSpace,e.startRenderSpace,t,n),te(i.endRenderSpace,e.endRenderSpace,t,n)}function ts(i,e,t,n){switch(e){case O.Direct:return is(i,t,n);case O.Horizontal:case O.Vertical:{const{elevationAlignedStartPoint:s,elevationAlignedEndPoint:r,dimension:a,geometry:l}=t;let o;a.measureType===O.Direct?(o=Aa(l,n)===s.z>r.z,e===O.Horizontal&&(o=!o)):o=!La(l);const[d,c]=o?[s,r]:[r,s],h=qe(c,za);return e===O.Horizontal?h.z=d.z:(h.x=d.x,h.y=d.y),n.toRenderCoords(d,i.startRenderSpace),n.toRenderCoords(h,i.endRenderSpace),i}}}function is(i,e,t){return t.toRenderCoords(e.elevationAlignedStartPoint,i.startRenderSpace),t.toRenderCoords(e.elevationAlignedEndPoint,i.endRenderSpace),i}function Aa(i,e){const t=i.directSegment.eval(.5,b.get()),n=e.worldUpAtPosition(t,b.get()),s=i.dimensionSegment.eval(.5,b.get()),r=A(b.get(),s,t);return!Rn(r,Ye)&&L(r,n)>0}function La(i){const{startRenderSpace:e,endRenderSpace:t}=i.dimensionSegment,{startRenderSpace:n,endRenderSpace:s}=i.directSegment;return tn(n,e)<tn(s,t)}(function(i){i[i.Start=0]="Start",i[i.End=1]="End"})(gt||(gt={}));const za=_e(0,0,0,null);function Va(i,e,t,n){const{directSegment:s}=t,r=Qt(b.get(),{measureType:e,directSegment:s,renderCoordsHelper:n}),a=ns(Ha,{offsetAxis:r,offset:0,relativeToSegment:s,renderCoordsHelper:n}).eval(.5,b.get()),l=A(b.get(),i,a);return L(l,r)*n.unitInMeters}const Ha=new De;function Qt(i,e){const{measureType:t,elevationAlignedStartPoint:n,elevationAlignedEndPoint:s,directSegment:{startRenderSpace:r,endRenderSpace:a},directSegment:l,renderCoordsHelper:o}=e,d=l.eval(.5,b.get()),c=o.worldUpAtPosition(d,b.get()),h=o.worldBasisAtPosition(d,tr.Y,b.get());switch(t){case O.Horizontal:V(i,c);break;case O.Vertical:L(r,c)<L(a,c)?A(i,a,r):A(i,r,a),re(i,i,c),re(i,i,c);break;case O.Direct:{const f=e.orientation??0;if(Hi({elevationAlignedStartPoint:n,elevationAlignedEndPoint:s}))Ji(Ot,-Ki(f),c),en(i,h,Ot);else{const m=A(b.get(),a,r),y=re(b.get(),m,c);re(y,y,m),Ji(Ot,Ki(f),m),en(i,y,Ot)}break}}return Rn(i,Ye)?V(i,h):Dn(i,i)}const Ot=Ti();function Hi({elevationAlignedStartPoint:i,elevationAlignedEndPoint:e}){return i!=null&&e!=null&&i.x===e.x&&i.y===e.y}function ns(i,e){const{offsetAxis:t,offset:n,relativeToSegment:{startRenderSpace:s,endRenderSpace:r},relativeToSegment:a,renderCoordsHelper:l}=e,o=n/l.unitInMeters,[d,c]=Ia(s,r,t,o);return te(i.startRenderSpace,a.startRenderSpace,t,d),te(i.endRenderSpace,a.endRenderSpace,t,c),i}function Ia(i,e,t,n=0){const s=L(e,t),r=L(i,t),a=Math.abs(s-r)+n;return s>r?[a,n]:[n,a]}function Jt(i,e,t){const n=e.directSegment.eval(.5,b.get());return t.worldUpAtPosition(n,i)}function Ii(i,e){const{startRenderSpace:t,endRenderSpace:n}=e.directSegment;return A(i,n,t)}function Gi(i,e,t={invert:!1}){const{startRenderSpace:n,endRenderSpace:s}=e.dimensionSegment;return t.invert?A(i,n,s):A(i,s,n)}function xi(i,e){const t=i.directSegment.eval(.5,b.get());return e.headingAtPosition(t,i.primaryOffsetAxis)}function Ga(i,e){return pi(Gi(Fa,i))/e**2}const Fa=g();function ss(i){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}=i;if(e==null||t==null)return!1;const n=Oa(e,t);return n!=null&&Zn(n,"meters").value>rs}const rs=1e5;function _t(i){return i.geometry!=null}let be=class extends pe{constructor(e){super(e),this._handles=new Yt}initialize(){const{computations:e}=this.analysisViewData;for(const t of e)this._addComputation(t);this.addHandles(e.on("change",({added:t,removed:n})=>{for(const s of n)this._removeComputation(s);for(const s of t)this._addComputation(s)}))}destroy(){this._handles=ht(this._handles)}get analysis(){return this.analysisViewData.analysis}get _defaultUnit(){return ta(this.view)}_addComputation(e){this._handles.has(e)||this._handles.add(x(()=>kt(e),t=>{const{measureType:n}=t;if(ss(t)&&n!==O.Direct){const r=Math.round(ir(rs,"meters","kilometers"));return An.getLogger(this.declaredClass).warnOnce(`A ${n} dimension in the analysis (id: '${this.analysis.id}') will not display, because only direct dimensions can measure lengths greater than ${r} km. Update the measureType of the affected dimension to "direct" to display it.`),void(e.geometry=null)}const s=jt(t,this.view.renderCoordsHelper,e.geometry);e.geometry=s,e.result.length=Ra(s,n,this._defaultUnit)},F),e)}_removeComputation(e){this._handles.remove(e)}};u([p({constructOnly:!0})],be.prototype,"analysisViewData",void 0),u([p({constructOnly:!0})],be.prototype,"view",void 0),u([p()],be.prototype,"analysis",null),u([p()],be.prototype,"_defaultUnit",null),be=u([I("esri.views.3d.analysis.Dimension.support.DimensionController")],be);let Na=class{constructor(){this.color=Xt(.5),this.radius=5}},ka=class{constructor(){this.color=new C([127,127,127,.5]),this.radius=5}},ja=class{constructor(){this.lineSizeFraction=.8}},qa=class{constructor(){this.color=Xt(.5),this.linePaddingPx=4,this.focusedLinePaddingPx=6,this.lengthFraction=.5,this.minLengthMeters=.1}},Ua=class{constructor(){this.calloutOffsetPx=18,this.calloutWidth=2,this.discScale=.3,this.focusMultiplier=2,this.color=Xt(.5),this.contrastColor=Zr()}},Wa=class{constructor(){this.lineSizeFraction=.25}},Ba=class{constructor(){this.marginPx=20,this.minScreenLengthFontSizeFactor=5}},Za=class{constructor(){this.color=Xt(.5)}},Ya=class{constructor(){this.pointManipulators=new Na,this.offsetManipulator=new qa,this.orientationManipulator=new Ua,this.markers=new ja,this.labels=new Ba,this.offsetLine=new Wa,this.constraint=new Za,this.constraintThresholdPx=10,this.initialOffsetPx=50,this.orientationSnapThresholdDegrees=5,this.disabledPointIndicator=new ka,this.smallScreenLengthLineSizeFactor=2,this.pointerMoveTimeoutMs=2500}},T=new Ya;class Xa{constructor(e){this.start=e.start,this.end=e.end,this.offset=e.offset,this.heading=e.heading,this.rotation=e.rotation,this.direct=e.direct,this.horizontal=e.horizontal,this.vertical=e.vertical}manipulatorName(e){return Object.keys(this).find(t=>this.hasOwnProperty(t)&&e===this[t])}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(e){for(const t of Jr)e(this.manipulatorForMeasureType(t),t)}manipulatorForMeasureType(e){switch(e){case O.Direct:return this.direct;case O.Horizontal:return this.horizontal;case O.Vertical:return this.vertical}}}function Qa(i,e){const t=ra(i,C.toUnitRGBA(T.pointManipulators.color),ue);return t.available=!1,t.grabCursor="crosshair",t.radius=T.pointManipulators.radius,t.metadata=e.metadata,t.collisionPriority=1,t}function Ja(i,e){const t=[q(-.5,0,0),q(.5,0,0)],{lengthFraction:n}=T.offsetManipulator,s=Xe(e.unfocusedMaterial,t.map(a=>vt(g(),a,n))),r=s.instantiate({material:e.focusedMaterial});return new Yn({view:i,renderObjects:[new ct(s,lt.Unfocused|lt.Selected|ue),new ct(r,lt.Focused|ue)],collisionType:{type:"line",paths:[t]},radius:Fi(e.lineSizePt)/2,metadata:e.metadata,available:!1,...Xn})}function as(i,{lineSizePt:e,material:t}){const{calloutOffsetPx:n,calloutWidth:s,discScale:r,focusMultiplier:a,color:l}=T.orientationManipulator;return{calloutLength:.25*rr*T.markers.lineSizeFraction*ae(e)+n,calloutColor:C.toUnitRGBA(l),calloutWidth:s,customStateMask:ue,discScale:r,focusMultiplier:a,material:t,metadata:i}}function fn(i,e){return aa(i,as(e.metadata,e))}function mn(i,e){oa(i,as(i.metadata,e))}function Ka(i,e){const t=[q(-.5,0,0),q(.5,0,0)],{lengthFraction:n}=T.offsetManipulator,s=Xe(e.thinOffsetManipulatorMaterial,t),r=Xe(e.unfocusedMaterial,t.map(l=>vt(g(),l,n))),a=r.instantiate({material:e.focusedMaterial});return new Yn({view:i,renderObjects:[new ct(r,lt.Unfocused|ue),new ct(a,lt.Focused|ue),new ct(s,ue)],collisionType:{type:"line",paths:[t]},radius:Fi(e.lineSizePt)/2,available:!1,metadata:e.metadata,...Xn})}function eo(i,{isStart:e,createSnappingPipelineStep:t,dimension:n,onUpdate:s,view:r}){const a=e?"startPoint":"endPoint";return[wt(i,(o,d,c,h)=>{const f=Vi(o),{snappingStep:m,cancelSnapping:y}=t(h);c=c.next(f).next(zi(n,[a,"measureType","orientation"])).next(y),d.next(f).next(pa(r)).next(...m).next(S=>{const v=qe(S.mapEnd,new Ue);s(a==="startPoint"?{startPoint:v}:{endPoint:v})})})]}function to(i,{computation:e,view:t}){return[wt(i,(n,s,r)=>{if(!_t(e)||!n.selected)return;const{geometry:a,dimension:l}=e,o=Vi(n);s.next(o).next(ls(t,l,a.dimensionSegment,a.primaryOffsetAxis)),r.next(o).next(zi(l,["offset"]))})]}function io(i,{computation:e,view:t}){return[wt(i,(n,s,r)=>{os({cancel:r,computation:e,settingHeading:!0,steps:s,view:t})})]}function no(i,{computation:e,view:t}){return[wt(i,(n,s,r)=>{os({cancel:r,computation:e,settingHeading:!1,steps:s,view:t})}),i.events.on("immediate-click",n=>{so(n,e,t)})]}function so(i,e,t){const{dimension:n,geometry:s}=e;if(n.orientation===90||n.orientation===270)return n.orientation=0,void i.stopPropagation();if(s==null)return;const{renderCoordsHelper:r}=t,a=jt({...kt(e),orientation:90},r),l=jt({...kt(e),orientation:270},r);if(a==null||l==null)return;const o=xi(a,r),d=xi(l,r),c=ds(s,t),h=fi.shortestSignedDiff(c,o),f=fi.shortestSignedDiff(c,d);n.orientation=Math.abs(h)<Math.abs(f)?90:270,i.stopPropagation()}function os(i){const{cancel:e,computation:t,settingHeading:n,steps:s,view:r}=i;if(!_t(t))return;const{renderCoordsHelper:a}=r,{dimension:l,geometry:o}=t,d=g(),c=us(g(),o,o.directSegment,a),h=hs(b.get(),{forHeading:n,geometry:o,renderCoordsHelper:a}),f=mi(c,h,gi()),m=n?l.orientation??xi(o,r.renderCoordsHelper):l.orientation??0;s.next(Jn(r,f)).next(y=>{y.action==="start"&&V(d,y.renderStart);const S=ar(f),v=la(d,y.renderEnd,c,S);let D=m-or(v);n||(D=ro(D)),l.orientation=D}),e.next(zi(l,["orientation"]))}function ro(i){const e=fi.normalize(i)%90;return e<T.orientationSnapThresholdDegrees?i-e:90-e<T.orientationSnapThresholdDegrees?i+(90-e):i}function ao(i,{computation:e,manipulatorMeasureType:t,view:n}){let s=O.Direct,r=0,a=0;return[i.events.on("grab-changed",l=>{if(l.action!=="start"||!_t(e))return;const{dimension:o,geometry:d}=e;s=o.measureType,r=o.offset,a=o.orientation;const c=V(b.get(),i.renderLocation);o.measureType=t,o.offset=Va(c,t,d,n.renderCoordsHelper),o.orientation=0}),wt(i,(l,o,d)=>{if(!_t(e))return;const{geometry:c,dimension:h}=e,{renderCoordsHelper:f}=n,m=ts(ps,t,e,f),y=Qt(b.get(),{measureType:t,directSegment:c.directSegment,renderCoordsHelper:f}),S=Vi(l);o.next(S).next(ls(n,h,m,y)),d.next(S).next(v=>(h.measureType=s,h.offset=r,h.orientation=a,v))})]}function ls(i,e,t,n){const s=Ke(b.get(),t.endRenderSpace,t.startRenderSpace);re(s,s,n);const r=mi(t.startRenderSpace,s,gi()),a=mi(t.startRenderSpace,n,gi()),l=e.offset;let o,d=0;const c=new Qn;return c.next(Jn(i,r)).next(h=>{h.action==="start"&&(d=nn(a,h.renderStart));const f=(nn(a,h.renderEnd)-d)*i.renderCoordsHelper.unitInMeters;e.offset=l+f,o=h}),h=>(c.execute(h),o)}function ds(i,e){const{directSegment:t}=i,{renderCoordsHelper:n}=e,s=Jt(b.get(),i,n),r=Ii(b.get(),i),a=re(b.get(),r,s),{viewForward:l}=e.state.camera;L(a,l)>0&&vt(a,a,-1);const o=t.eval(.5,b.get());return n.headingAtPosition(o,a)}function oo(i,e,t){const{dimensionSegment:n,primaryOffsetAxis:s}=e,r=Gi(ut,e),a=E(r,Ye)?sr(qt):Li(r,s,Ye,qt),l=Math.max(Ln(r),T.offsetManipulator.minLengthMeters/t.unitInMeters);zn(a,a,he(ut,l,l,l)),i.modelTransform=a,i.renderLocation=n.eval(.5,ut)}function lo(i,e,t){cs(i,e,t,{forHeading:!0})}function co(i,e,t){cs(i,e,t,{forHeading:!1})}function cs(i,e,t,{forHeading:n}){const{dimension:s,geometry:r}=e,{primaryOffsetAxis:a}=r,l=vt(uo,a,s.offset>=0?1:-1),o=hs(ho,{forHeading:n,geometry:r,renderCoordsHelper:t});re(o,o,l);const d=Li(l,o,Ye,qt);i.modelTransform=d,i.renderLocation=us(ut,r,r.dimensionSegment,t)}const uo=g(),ho=g();function po(i,e,t,n){const{geometry:s}=e,r=ts(ps,t,e,n),a=Qt(ut,{measureType:t,directSegment:s.directSegment,renderCoordsHelper:n}),l=A(li,r.endRenderSpace,r.startRenderSpace),o=Li(l,a,Ye,qt),d=Ln(l);zn(o,o,he(li,d,d,d)),i.modelTransform=o,i.renderLocation=r.eval(.5,li)}function us(i,e,t,n){const{startRenderSpace:s,endRenderSpace:r}=t,a=fo(e,n)?s:r;return V(i,a)}function hs(i,{forHeading:e,geometry:t,renderCoordsHelper:n}){return e?Jt(i,t,n):Gi(i,t,{invert:!0})}function fo(i,e){const t=Ii(mo,i),n=Jt(go,i,e);return L(t,n)>0}const mo=g(),go=g();function _o(i){return ae(i)+T.offsetManipulator.linePaddingPx}function Fi(i){return ae(i)+T.offsetManipulator.focusedLinePaddingPx}const ue=nr.Custom1,ut=g(),li=g(),qt=Ti(),ps=new De;function yo(i){let e,t,n=[],s=!1;function r(...a){return s&&e===this&&vo(a,n)||(t=i.apply(this,a),e=this,n=a,s=!0),t}return r}function vo(i,e){if(i.length!==e.length)return!1;for(let t=0;t<i.length;++t)if(i[t]!==e[t])return!1;return!0}var X;function So(i,e){return{enabled:e.effectiveFeatureEnabled,elevationAlignedStartPoint:i.elevationAlignedStartPoint,elevationAlignedEndPoint:i.elevationAlignedEndPoint,geometry:i.geometry}}function wo(i,e){if(ss(i))return X.Direct;if(!i.enabled)return null;const{geometry:t}=i;if(t==null||E(t.directSegment.startRenderSpace,t.directSegment.endRenderSpace))return null;const{constraintThresholdPx:n}=T,{camera:s}=e.state,r=Jt(b.get(),t,e.renderCoordsHelper),a=Ii(b.get(),t),l=vt(b.get(),r,L(a,r)),o=Ke(b.get(),a,l),d=pi(o),c=pi(l),{startRenderSpace:h,endRenderSpace:f}=t.directSegment,m=Math.max(s.computeRenderPixelSizeAt(h)*n,s.computeRenderPixelSizeAt(f)*n)**2;return d<m?X.Vertical:c<m?X.Horizontal:null}function Po(i,e,{constraint:t,view:n}){const{unconstrainedGeometry:s}=i;if(s==null)return;const{renderCoordsHelper:r,spatialReference:a}=n,{startRenderSpace:l,endRenderSpace:o}=s.directSegment,d=r.fromRenderCoords(l,new Ue,a),c=r.fromRenderCoords(o,new Ue,a);let h;h=e==="start"?{startPoint:d}:{endPoint:c},fs(i,h,{constraint:t,elevationAlignedStartPoint:i.elevationAlignedStartPoint,elevationAlignedEndPoint:i.elevationAlignedEndPoint,unconstrainedGeometry:s,view:n})}function fs(i,e,t){const{constraint:n,elevationAlignedStartPoint:s,elevationAlignedEndPoint:r,unconstrainedGeometry:a,view:l}=t,{dimension:o,previousConstraint:d,preConstraintProperties:c}=i;if(s==null||r==null)return;const h=()=>{"startPoint"in e?o.startPoint=e.startPoint:"endPoint"in e&&(o.endPoint=e.endPoint)};if(n==null)h(),d!=null&&c!=null&&(o.measureType=c.measureType,o.orientation=c.orientation);else switch(o.measureType=O.Direct,n){case X.Horizontal:if(n!==d&&(o.orientation=0),"startPoint"in e){const f=e.startPoint;f!=null&&(f.z=r.z),o.startPoint=f}else if("endPoint"in e){const f=e.endPoint;f!=null&&(f.z=s.z),o.endPoint=f}break;case X.Vertical:if(n!==d&&(o.orientation=ds(a,l)),"startPoint"in e){const f=e.startPoint;f!=null&&(f.x=r.x,f.y=r.y),o.startPoint=f}else if("endPoint"in e){const f=e.endPoint;f!=null&&(f.x=s.x,f.y=s.y),o.endPoint=f}break;case X.Direct:n!==d&&c!=null&&(o.orientation=c.orientation),h()}i.previousConstraint=n,i.unconstrainedGeometry=a}(function(i){i[i.Horizontal=0]="Horizontal",i[i.Vertical=1]="Vertical",i[i.Direct=2]="Direct"})(X||(X={}));let xo=class extends Kn{constructor(e){super(e),this._ray=cr(),this._isWorldDown=!1,this._start=g(),this._end=q(1,0,0),this._width=1,this._color=It(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=It(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=Z.LINE,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=w.OccludeAndTransparent,this._fadedExtensions=yn,this._laserline=new ya({view:this.view}),this.applyProps(e)}destroy(){this._laserline.destroy(),super.destroy()}createObject3DResourceFactory(e){return{view:e,createResources:t=>this._createObject3DResources(t),destroyResources:t=>this._destroyExternalResources(t),recreateGeometry:(t,n)=>this._recreateObject3DGeometry(t,n),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:t=>this._destroyExternalResources(t),recreateGeometry:t=>this._recreateDrapedGeometry(t)}}updateVisibility(e){super.updateVisibility(e),this._laserline.visible=e}onAttachedChange(){this._laserline.attached=this._laserlineAttached}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,V(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),Ke(this._end,e,this._end),ni(this._start,this._end,this._ray),this._updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,E(this._start,e)||(V(this._start,e),ni(this._start,this._end,this._ray),this._updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,E(this._end,e)||(V(this._end,e),ni(this._start,this._end,this._ray),this._updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){We(e,this._color)||(pt(this._color,e),this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){We(e,this._innerColor)||(pt(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const t=e!=null!=(this._stipplePattern!=null);this._stipplePattern=e,t?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){e!=null&&this._stippleOffColor!=null&&We(e,this._stippleOffColor)||(this._stippleOffColor=e!=null?Vn(e):null,this._updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this.recreateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&this._laserlineStyle!=null&&this.attached&&!this.isDraped}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this._laserlineAttached,e!=null&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this._laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get _normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===w.OccludeAndTransparentStencil?w.OccludeAndTransparent:this._renderOccluded}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=e??yn,this.recreateGeometry()}_updateMaterial(){var t,n;const{materialParameters:e}=this;(t=this.object3dResources.resources)==null||t.material.setParameters(e),(n=this.drapedResources.resources)==null||n.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,hasPolygonOffset:this._polygonOffset,renderOccluded:this._normalizedRenderOccluded,writeDepth:this._writeDepthEnabled}}_createObject3DResources(e){const t=new ce(this.materialParameters),n=new Array;return this._createObject3DGeometry(t,e,n),{material:t,geometries:n,forEach:s=>{s(t),n.forEach(s)}}}_destroyExternalResources(e){e.geometries=[],e.material.dispose()}_recreateObject3DGeometry(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)}_createObject3DGeometry(e,t,n){const s=this._createGeometry(e);n.push(s),t.addGeometry(s),this._updateVerticesObject3D(t)}_createDrapedResources(){const e=new ce(this.materialParameters);return{material:e,geometries:[this._createDrapedGeometry(e)]}}_recreateDrapedGeometry(e){e.geometries=[this._createDrapedGeometry(e.material)]}_createDrapedGeometry(e){const t=this._createGeometry(e);return this._updateVerticesDraped(t),new Hn(t)}_createGeometry(e){const t=this.extensionType===Z.FADED,n=t?[g(),g(),g(),g()]:[g(),g()];return Xe(e,n,null,t?[1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]:null)}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=this.object3dResources.object;e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const t=this._lineSegment;this._updateVertexAttributesObject3D(e,t),this._laserline.intersectsLine=t}_updateVerticesDraped(e){this._updateVertexAttributesDraped(e,this._lineSegment)}get _lineSegment(){return this._extensionType===Z.FADED?this._updateLineSegmentFinite(gn):this._updateLineSegmentInfinite(this._extensionType,gn)}_updateLineSegmentFinite(e){return sn(this._start,this._end,e)}_updateLineSegmentInfinite(e,t){const n=this.view.state.camera;switch(ur(this._ray,me),e){case Z.LINE:me.c0=-Number.MAX_VALUE;break;case Z.RAY:case Z.GROUND_RAY:{const a=this._ray.origin,l=this.view.elevationProvider.getElevation(a[0],a[1],a[2],this.view.renderCoordsHelper.spatialReference,"ground")??0,o=this.view.renderCoordsHelper.getAltitude(a);this._isWorldDown&&o<l&&hr(me.ray.direction,me.ray.direction),this._extensionType===Z.GROUND_RAY&&l!=null&&(me.c1=Math.abs(o-l));break}}if(!pr(n.frustum,me))return this._updateLineSegmentFinite(t);const s=fr(me,Se),r=mr(me,bo);return sn(s,r,t)}_updateVertexAttributesObject3D(e,t){var r;const n=(r=e.geometries[0].getMutableAttribute(Gt.POSITION))==null?void 0:r.data;if(!n)return;let s=0;for(const a of this._lineVertices(t))n[s++]=a[0],n[s++]=a[1],n[s++]=a[2];e.geometryVertexAttrsUpdated(e.geometries[0])}_updateVertexAttributesDraped(e,t){var r;const n=(r=e.getMutableAttribute(Gt.POSITION))==null?void 0:r.data;if(!n)return;let s=0;for(const a of this._lineVertices(t))n[s++]=a[0],n[s++]=a[1],n[s++]=_i;e.invalidateBoundingInfo()}*_lineVertices(e){this.extensionType===Z.FADED?(yield Ve(e,-this.fadedExtensions.start,Se),yield Ve(e,0,Se),yield Ve(e,1,Se),yield Ve(e,1+this.fadedExtensions.end,Se)):(yield Ve(e,0,Se),yield Ve(e,1,Se))}};const me=lr(),Se=g(),bo=g(),gn=dr();var Z;(function(i){i[i.LINE=0]="LINE",i[i.RAY=1]="RAY",i[i.GROUND_RAY=2]="GROUND_RAY",i[i.FADED=3]="FADED"})(Z||(Z={}));const _n=1/3,yn={start:_n,end:_n};let Mo=class extends Kn{constructor(e){super(e),this._location=g(),this._direction=q(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=It(1,0,1,1),this._renderOccluded=w.OccludeAndTransparent,this.applyProps(e)}createObject3DResourceFactory(e){return{view:e,createResources:t=>this._createObject3DResources(t),destroyResources:t=>this._destroyObject3DResources(t),recreateGeometry:(t,n)=>this._recreateObject3DGeometry(t,n),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:t=>this._destroyDrapedResources(t),recreateGeometry:t=>this._recreateDrapedGeometry(t)}}get location(){return this._location}set location(e){E(this._location,e)||(V(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){E(this._direction,e)||(V(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,t){Dn(this._direction,Ke(this._direction,t,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){We(e,this._color)||(pt(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}_createObject3DResources(e){const t=new ce(this.materialParameters),n=new Array;return this._createObject3DGeometry(t,e,n),{material:t,geometries:n,forEach:s=>{s(t),n.forEach(s)}}}_destroyObject3DResources(e){e.geometries.length=0,e.material.dispose()}_recreateObject3DGeometry(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)}_createObject3DGeometry(e,t,n){const[s,r]=this._createGeometries(e);t.addGeometry(s),t.addGeometry(r),n.push(s),n.push(r),this._updateVerticesObject3D(t)}_createDrapedResources(){const e=new ce(this.materialParameters),t=x(()=>this.view.state.contentPixelRatio,()=>{this.drapedResources.recreateGeometry()});return{material:e,geometries:this._createDrapedGeometry(e),pixelRatioHandle:t}}_destroyDrapedResources(e){e.pixelRatioHandle.remove(),e.geometries=[],e.material.dispose()}_recreateDrapedGeometry(e){e.geometries=this._createDrapedGeometry(e.material)}_createDrapedGeometry(e){const t=this._createGeometries(e);return this._updateVerticesDraped(t),t.map(n=>new Hn(n))}_createGeometries(e){return[Xe(e,[g(),g()]),Xe(e,[g(),g()])]}_updateMaterial(){var t,n;const{materialParameters:e}=this;(t=this.object3dResources.resources)==null||t.material.setParameters(e),(n=this.drapedResources.resources)==null||n.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=this.object3dResources.object;e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const t=this.view.state.camera;t.projectToScreen(this.location,Rt),In(se,this.location,this.direction),t.projectToScreen(se,He),gr(He,oe(He,He,Rt)),this._updateVertexAttributesObject3D(t,e,0,Rt,He,1),this._updateVertexAttributesObject3D(t,e,1,Rt,He,-1)}_updateVertexAttributesObject3D(e,t,n,s,r,a){var h;const l=t.geometries[n],o=(h=l.getMutableAttribute(Gt.POSITION))==null?void 0:h.data;if(!o)return;const{start:d,end:c}=this._computeStartEnd(r,s,a,this.offset,this.width,this.length);e.unprojectFromScreen(rn(d),se),o[0]=se[0],o[1]=se[1],o[2]=se[2],e.unprojectFromScreen(rn(c),se),o[3]=se[0],o[4]=se[1],o[5]=se[2],t.geometryVertexAttrsUpdated(l)}_updateVerticesDraped(e){const{view:{basemapTerrain:{overlayManager:t},state:{contentPixelRatio:n}}}=this,{location:s,width:r,length:a,offset:l}=this,o=$o;o.spatialReference=t.renderer.spatialReference,o.x=s[0],o.y=s[1];const d=t.overlayPixelSizeInMapUnits(o)*n,c=r*d,h=a*d,f=l*d;this._updateVertexAttributesDraped(e[0],c,h,f,-1),this._updateVertexAttributesDraped(e[1],c,h,f,1)}_updateVertexAttributesDraped(e,t,n,s,r){var h;const a=(h=e.getMutableAttribute(Gt.POSITION))==null?void 0:h.data;if(!a)return;const{location:l,direction:o}=this,{start:d,end:c}=this._computeStartEnd(o,l,r,s,t,n);a[0]=d[0],a[1]=d[1],a[2]=_i,a[3]=c[0],a[4]=c[1],a[5]=_i,e.invalidateBoundingInfo()}_computeStartEnd(e,t,n,s,r,a){const l=si(vn,_r(vn,e[1]*n,e[0]*-n),s+r/2),o=xt(Tt,xt(Tt,xt(Tt,t,si(Tt,e,a/2)),l),l);return{start:o,end:xt(Sn,o,si(Sn,e,-a))}}};const se=g(),vn=ie(),Tt=ie(),Sn=ie(),Rt=Gn(),He=Gn(),$o=_e(0,0,void 0,null);let K=class extends Fn{constructor(){super(...arguments),this.enabled=!0}};u([p({type:Boolean})],K.prototype,"enabled",void 0),K=u([I("esri.views.interactive.snapping.Settings.DefaultSnappingAlgorithm")],K);let M=class extends Fn{constructor(e){super(e),this.lineSnapper=new K,this.parallelLineSnapper=new K,this.rightAngleSnapper=new K,this.rightAngleTriangleSnapper=new K,this.shortLineThreshold=15,this.distance=5,this.pointThreshold=1e-6,this.intersectionParallelLineThreshold=1e-6,this.parallelLineThreshold=1e-6,this.verticalLineThreshold=.1,this.touchSensitivityMultiplier=1.5,this.pointOnLineThreshold=1e-6,this.orange=new C([255,127,0]),this.orangeTransparent=new C([255,127,0,.5]),this.lineHintWidthReference=3,this.lineHintWidthTarget=3,this.lineHintFadedExtensions=.3,this.parallelLineHintWidth=2,this.parallelLineHintLength=24,this.parallelLineHintOffset=1.5,this.rightAngleHintSize=24,this.rightAngleHintOutlineSize=1.5,this.satisfiesConstraintScreenThreshold=1}};u([p({type:K,constructOnly:!0,nonNullable:!0,json:{write:!0}})],M.prototype,"lineSnapper",void 0),u([p({type:K,constructOnly:!0,nonNullable:!0,json:{write:!0}})],M.prototype,"parallelLineSnapper",void 0),u([p({type:K,constructOnly:!0,nonNullable:!0,json:{write:!0}})],M.prototype,"rightAngleSnapper",void 0),u([p({type:K,constructOnly:!0,nonNullable:!0,json:{write:!0}})],M.prototype,"rightAngleTriangleSnapper",void 0),u([p({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],M.prototype,"shortLineThreshold",void 0),u([p({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],M.prototype,"distance",void 0),u([p({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],M.prototype,"pointThreshold",void 0),u([p({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],M.prototype,"intersectionParallelLineThreshold",void 0),u([p({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],M.prototype,"parallelLineThreshold",void 0),u([p({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],M.prototype,"verticalLineThreshold",void 0),u([p({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],M.prototype,"touchSensitivityMultiplier",void 0),u([p({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],M.prototype,"pointOnLineThreshold",void 0),u([p({type:C,nonNullable:!0})],M.prototype,"orange",void 0),u([p({type:C,nonNullable:!0})],M.prototype,"orangeTransparent",void 0),u([p({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],M.prototype,"lineHintWidthReference",void 0),u([p({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],M.prototype,"lineHintWidthTarget",void 0),u([p({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],M.prototype,"lineHintFadedExtensions",void 0),u([p({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],M.prototype,"parallelLineHintWidth",void 0),u([p({type:Number,nonNullable:!0,range:{min:0,max:50},json:{write:!0}})],M.prototype,"parallelLineHintLength",void 0),u([p({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],M.prototype,"parallelLineHintOffset",void 0),u([p({type:Number,nonNullable:!0,range:{min:0,max:46},json:{write:!0}})],M.prototype,"rightAngleHintSize",void 0),u([p({type:Number,nonNullable:!0,range:{min:0,max:6},json:{write:!0}})],M.prototype,"rightAngleHintOutlineSize",void 0),u([p({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],M.prototype,"satisfiesConstraintScreenThreshold",void 0),M=u([I("esri.views.interactive.snapping.Settings.Defaults")],M);const P=new M;var z;(function(i){i[i.FEATURE=1]="FEATURE",i[i.SELF=2]="SELF",i[i.ALL=3]="ALL"})(z||(z={}));function vd(i){return i}function ms(i){return ve(i)}function Co(i,e,t){return q(i,e,t)}function $(i,e,t){return i==null?null:at(t.coordinateHelper.vectorToDehydratedPoint(i,Eo),e,t)}function at(i,e,t){if(i==null)return null;if(e==null)return q(i.x,i.y,i.z??0);if(e.type==="2d")return q(i.x,i.y,0);const{elevationInfo:n}=t,s=ma(e,i,n,R)??0;return q(i.x,i.y,s)}function wn(i,e,{z:t,m:n,spatialReference:s,elevationInfo:r}){if(t==null&&n==null){const o=_e(i[0],i[1],void 0,s);return n!=null&&(o.m=n,o.hasM=!0),o}if(e==null||e.type==="2d"){const o=_e(i[0],i[1],t,s);return n!=null&&(o.m=n,o.hasM=!0),o}const a=ga(e,i,s,R,r)??0,l=_e(i[0],i[1],a,s);return n!=null&&(l.m=n,l.hasM=!0),l}function Pn(i,e){return _e(i[0],i[1],i[2],e)}const Eo=_e(0,0,0,null),xn={redo:"r",undo:"z",center:"Alt",constraint:"Shift",cancel:"Escape",delete:["Backspace","Delete"],complete:"Enter",vertexAdd:"f",pan:" "},bn={toggle:"Control"};function Ae(i,e){const t=i.x-e.x,n=i.y-e.y;return t*t+n*n}function Oo(i,e){return Math.sqrt(Ae(i,e))}function Ni(i,e){e.sort((t,n)=>yi(t.targetPoint,i)-yi(n.targetPoint,i))}var k;function Sd({point:i,distance:e,returnEdge:t,returnVertex:n,coordinateHelper:{spatialReference:s}},r,a){return{point:_e(i[0],i[1],i[2],s.toJSON()),mode:r,distance:e,returnEdge:t,returnVertex:n,query:a!=null?a.toJSON():{where:"1=1"}}}function Ut(i,e,t){return{left:$(i.leftVertex.pos,e,t),right:$(i.rightVertex.pos,e,t)}}function wd(i){return i.createQuery()}function To(i,e=()=>{}){const t=x(()=>({view:i.view,snappingOptions:i.snappingOptions}),({view:n,snappingOptions:s})=>{const r="snapping-toggle",a=yr.TOOL;if(i.removeHandles(r),n&&s!=null){const l=[n.on("key-down",o=>{o.key!==bn.toggle||o.repeat||(s.enabledToggled=!0,e())},a),n.on("key-up",o=>{o.key===bn.toggle&&(s.enabledToggled=!1,e())},a),n.on("pointer-move",o=>{const d=o.native.ctrlKey;s.enabledToggled!==d&&(s.enabledToggled=d,e())},a)];i.addHandles(l,r)}},F);i.addHandles(t)}(function(i){i[i.TARGET=0]="TARGET",i[i.REFERENCE=1]="REFERENCE",i[i.REFERENCE_EXTENSION=2]="REFERENCE_EXTENSION"})(k||(k={}));let Pt=class{constructor(e,t){this.isDraped=e,this.domain=t}},gs=class _s extends Pt{constructor(e,t,n=z.ALL){super(t,n),this.intersectionPoint=e}equals(e){return e instanceof _s&&E(this.intersectionPoint,e.intersectionPoint)}},Y=class ys extends Pt{constructor(e,t,n,s,r=z.ALL,a=!0,l=!0){super(s,r),this.type=e,this.lineStart=t,this.lineEnd=n,this.fadeLeft=a,this.fadeRight=l}equals(e){return e instanceof ys&&this.type===e.type&&E(this.lineStart,e.lineStart)&&E(this.lineEnd,e.lineEnd)&&this.fadeLeft===e.fadeLeft&&this.fadeRight===e.fadeRight}get length(){return Vt(this.lineStart,this.lineEnd)}},vs=class Ss extends Pt{constructor(e,t,n,s=z.ALL){super(n,s),this.lineStart=e,this.lineEnd=t}equals(e){return e instanceof Ss&&E(this.lineStart,e.lineStart)&&E(this.lineEnd,e.lineEnd)}},Ro=class ws extends Pt{constructor(e,t,n){super(t,n),this.point=e}equals(e){return e instanceof ws&&E(this.point,e.point)}},ki=class Ps extends Pt{constructor(e,t,n,s,r=z.ALL){super(s,r),this.previousVertex=e,this.centerVertex=t,this.nextVertex=n}equals(e){return e instanceof Ps&&E(this.previousVertex,e.previousVertex)&&E(this.centerVertex,e.centerVertex)&&E(this.nextVertex,e.nextVertex)}},Do=class{draw(e,t){const n=this._getUniqueHints(e),s=this.sortUniqueHints(n),r=[];for(const a of s)a instanceof gs&&r.push(this.visualizeIntersectionPoint(a,t)),a instanceof Y&&r.push(this.visualizeLine(a,t)),a instanceof vs&&r.push(this.visualizeParallelSign(a,t)),a instanceof ki&&r.push(this.visualizeRightAngleQuad(a,t)),a instanceof Ro&&r.push(this.visualizePoint(a,t));return vr(r)}sortUniqueHints(e){return e}_getUniqueHints(e){const t=[];for(const n of e){let s=!0;for(const r of t)if(n.equals(r)){s=!1;break}s&&t.push(n)}return t}},Ao=class extends Do{sortUniqueHints(e){return e.sort((t,n)=>(n instanceof Y?n.length:0)-(t instanceof Y?t.length:0))}visualizeIntersectionPoint(e,t){const{spatialReference:n,view:s}=t;return Ge(new hn({view:s,primitive:"circle",geometry:Pn(e.intersectionPoint,n),elevationInfo:e.isDraped?un:R,size:20,outlineSize:2,color:[0,0,0,0],outlineColor:C.toUnitRGBA(P.orange),pixelSnappingEnabled:!1}))}visualizePoint(e,t){const{view:n,spatialReference:s}=t,r=this._alignPoint(e.point,e.domain,t);return Ge(new hn({view:n,primitive:"circle",geometry:Pn(r,s),elevationInfo:this._hintElevationInfo(e,t),size:20,outlineSize:2,color:[0,0,0,0],outlineColor:C.toUnitRGBA(P.orange),pixelSnappingEnabled:!1}))}visualizeLine(e,t){const{view:n,spatialReference:s}=t,r=this._alignPoint(e.lineStart,e.domain,t),a=this._alignPoint(e.lineEnd,e.domain,t);return Ge(this._createLineSegmentHint(e.type,r,a,s,this._hintElevationInfo(e,t),n,e.isDraped,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,t){const{view:n,spatialReference:s}=t,{isDraped:r}=e,a=this._hintElevationInfo(e,t),l=this._alignPoint(e.lineStart,e.domain,t),o=this._alignPoint(e.lineEnd,e.domain,t),d=we(l,s,a,n,r),c=we(o,s,a,n,r),h=Nn(c,d,c,.5),f=new Mo({view:n,attached:!1,offset:P.parallelLineHintOffset,length:P.parallelLineHintLength,width:P.parallelLineHintWidth,color:C.toUnitRGBA(P.orange),location:h,renderOccluded:r?w.OccludeAndTransparent:w.Opaque,isDraped:r,renderGroup:ri.SnappingHint});return f.setDirectionFromPoints(d,h),f.attached=!0,Ge(f)}visualizeRightAngleQuad(e,t){const{view:n,spatialReference:s}=t,r=this._hintElevationInfo(e,t),{isDraped:a}=e,l=this._alignPoint(e.previousVertex,e.domain,t),o=this._alignPoint(e.centerVertex,e.domain,t),d=this._alignPoint(e.nextVertex,e.domain,t),c=we(l,s,r,n,a),h=we(o,s,r,n,a),f=we(d,s,r,n,a);return Ge(new _a({view:n,attached:!0,color:a?C.toUnitRGBA(P.orangeTransparent):C.toUnitRGBA(P.orange),renderOccluded:a?w.OccludeAndTransparent:w.Transparent,outlineRenderOccluded:a?w.OccludeAndTransparent:w.Opaque,outlineColor:C.toUnitRGBA(P.orange),outlineSize:P.rightAngleHintOutlineSize,size:P.rightAngleHintSize,isDraped:a,geometry:{previous:c,center:h,next:f},renderGroup:ri.SnappingHint}))}_createLineSegmentHint(e,t,n,s,r,a,l=!1,o=!0,d=!0){const c=we(t,s,r,a,l),h=we(n,s,r,a,l),f=new xo({view:a,extensionType:Z.FADED,start:c,end:h,isDraped:l,color:C.toUnitRGBA(P.orange),renderOccluded:l?w.OccludeAndTransparent:w.Opaque,renderGroup:ri.SnappingHint});switch(e){case k.TARGET:f.width=P.lineHintWidthTarget,f.fadedExtensions={start:0,end:P.lineHintFadedExtensions};break;case k.REFERENCE_EXTENSION:f.width=P.lineHintWidthReference,f.fadedExtensions={start:0,end:0};break;case k.REFERENCE:f.width=P.lineHintWidthReference,f.fadedExtensions={start:o?P.lineHintFadedExtensions:0,end:d?P.lineHintFadedExtensions:0}}return f.attached=!0,f}_alignPoint(e,t,n){const s=this._getSelfSnappingZ(t,n);return s==null?e:Co(e[0],e[1],s)}_hintElevationInfo(e,t){return this._getSelfSnappingZ(e.domain,t)!=null?t.selfSnappingZ.elevationInfo:e.isDraped?un:R}_getSelfSnappingZ(e,{selfSnappingZ:t}){return e===z.SELF&&t!=null?t.value:null}};function we(i,e,t,n,s,r=g()){if(s){const a=n.basemapTerrain.overlayManager.renderer.spatialReference;zt(i,e,r,a)}else ia(i,e,t,n,r);return r}const _={main:new C([255,127,0]),selected:new C([255,255,255]),staged:new C([12,207,255]),outline:new C([0,0,0,.5]),selectedOutline:new C([255,255,255])},Ze=.3;function yt(i,e){const t=i.clone();return t.a*=e,t}function Lo(i,e){const t=i.clone(),n=va(t);n.s*=e;const s=Sa(n);return t.r=s.r,t.g=s.g,t.b=s.b,t}function Q(i,e){e&&Object.assign(i,e)}let zo=class{constructor(e){this.color=_.main,this.height=90,this.coneHeight=40,this.coneWidth=23,this.width=3,this.renderOccluded=w.Opaque,Q(this,e)}},di=class{constructor(e){this.size=11,this.outlineSize=1,this.collisionPadding=9,this.color=_.main,this.outlineColor=_.outline,this.renderOccluded=w.Opaque,this.hoverOutlineColor=_.selectedOutline,Q(this,e)}apply(e,t){const n=this[e];t.setParameters({color:ye(n),transparent:e!=="color"||n.a<1,renderOccluded:this.renderOccluded})}},Vo=class{constructor(e){this.size=40,this.height=.2,this.offset=.25,this.collisionPadding=2,this.color=yt(_.main,.5),this.hoverColor=_.main,this.renderOccluded=w.Transparent,this.minSquaredEdgeLength=900,Q(this,e)}apply(e,t){const n=this[e];t.setParameters({color:ye(n),transparent:n.a<1,renderOccluded:this.renderOccluded})}},Ho=class{constructor(e){this.vertex=new di({color:_.main,outlineColor:_.outline}),this.edge=new di({color:Lo(yt(_.main,2/3),.5),outlineColor:yt(_.outline,.5),size:8,collisionPadding:8}),this.selected=new di({color:_.selected,outlineColor:_.outline}),this.edgeOffset=new Vo,Q(this,e)}},bi=class{constructor(e){this.color=_.selected,this.width=1.5,this.stipplePattern=Te(5),this.stippleOffColor=_.outline,this.falloff=0,this.innerWidth=1.5,this.innerColor=_.selected,this.renderOccluded=w.OccludeAndTransparent,Q(this,e)}apply(e){e.color=ye(this.color),e.width=this.width,e.stipplePattern=this.stipplePattern,e.stippleOffColor=ye(this.stippleOffColor),e.falloff=this.falloff,e.innerWidth=this.innerWidth,e.innerColor=ye(this.innerColor),e.renderOccluded=this.renderOccluded}},Io=class{constructor(e){this.color=_.selected,this.size=4,this.outlineSize=1,this.outlineColor=_.outline,this.shape="square",Q(this,e)}apply(e){e.color=ye(this.color),e.size=this.size,e.outlineSize=this.outlineSize,e.outlineColor=ye(this.outlineColor),e.primitive=this.shape}},Wt=class{constructor(e){this.innerColor=_.selected,this.innerWidth=1,this.glowColor=_.main,this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=Ze,this.globalAlphaContrastBoost=1.5,this.radius=3,this.heightFillColor=_.main,Q(this,e)}apply(e,t=1){const n={glowColor:C.toUnitRGB(this.glowColor),glowFalloff:this.glowFalloff,glowWidth:this.glowWidth,innerColor:C.toUnitRGB(this.innerColor),innerWidth:this.innerWidth,globalAlpha:this.globalAlpha*t,globalAlphaContrastBoost:this.globalAlphaContrastBoost,intersectsLineRadius:this.radius};"style"in e?e.style=n:e.laserlineStyle=n}},Go=class{constructor(e){this.outline=new bi({color:_.outline,renderOccluded:w.OccludeAndTransparentStencil,stippleOffColor:_.selected,stipplePattern:Te(5),width:1.5,innerWidth:0}),this.staged=new bi({color:_.selected,renderOccluded:w.OccludeAndTransparentStencil,innerColor:_.staged,stippleOffColor:_.outline,stipplePattern:Te(5),width:1.5}),this.shadowStyle=new Wt({globalAlpha:Ze,glowColor:_.main,glowFalloff:8,glowWidth:8,innerColor:_.selected,innerWidth:1}),Q(this,e)}},Fo=class{constructor(e){this.outline=new Io({color:_.selected,outlineColor:_.outline,outlineSize:1,shape:"circle",size:4}),this.shadowStyle=new Wt({globalAlpha:Ze,glowColor:_.main,glowFalloff:1.5,glowWidth:6,innerColor:_.selected,innerWidth:1,radius:2}),Q(this,e)}};class No extends bi{constructor(e){super(),this.extensionType=Z.GROUND_RAY,Q(this,e)}}let ko=class{constructor(e){this.lineGraphics=new Go,this.pointGraphics=new Fo,this.heightPlane=new Wt({globalAlpha:Ze,glowColor:_.main,glowFalloff:8,glowWidth:8,innerColor:_.selected,innerWidth:1}),this.heightBox=new Wt({globalAlpha:Ze,glowColor:_.main,glowFalloff:8,glowWidth:8,innerColor:_.selected,innerWidth:0,heightFillColor:_.main}),this.zVerticalLine=new No({color:yt(_.main,5*Ze/3),falloff:2,innerColor:yt(_.selected,0),renderOccluded:w.OccludeAndTransparent,stipplePattern:null,width:5,extensionType:Z.GROUND_RAY}),this.laserlineAlphaMultiplier=1.5,this.heightPlaneAngleCutoff=20,Q(this,e)}},jo=class{constructor(e){this.visualElements=new ko,this.reshapeManipulators=new Ho,this.zManipulator=new zo,Q(this,e)}colorToVec4(e){return ye(e)}};function ye(i){return Sr(C.toUnitRGBA(i))}const Ie=new jo;function qo(i,e,t,n,s){const r=an(3*i.length),a=an(r.length);i.forEach((d,c)=>{r[3*c]=d[0],r[3*c+1]=d[1],r[3*c+2]=d.length>2?d[2]:0});const l=wr(r,e,0,a,0,r,0,r.length/3,t,n,s),o=l!=null;return{numVertices:i.length,position:r,mapPositions:a,projectionSuccess:o,sampledElevation:l}}let Uo=class extends Bn{constructor(e){super(e),this.view=null,this._renderOccluded=w.OccludeAndTransparent,this._vertices=null,this._spatialReference=null,this._color=Ie.colorToVec4(Ie.reshapeManipulators.vertex.color),this._size=Ie.reshapeManipulators.vertex.size,this._outlineColor=Ie.colorToVec4(Ie.reshapeManipulators.vertex.outlineColor),this._outlineSize=Ie.reshapeManipulators.vertex.outlineSize,this._elevationInfo=null,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){We(e,this._color)||(pt(this._color,e),this._updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){We(e,this._outlineColor)||(pt(this._outlineColor,e),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get _vertexMaterialParameters(){return{color:this._color,transparent:this._color[3]<1,screenSizeScale:this.size,renderOccluded:this._renderOccluded}}get _vertexOutlineMaterialParameters(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSizeScale:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}_updateMaterial(){this.attached&&this._vertexMaterial.setParameters(this._vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this._vertexOutlineMaterial.setParameters(this._vertexOutlineMaterialParameters)}_createRenderGeometries(){const e=this.vertices;if(e==null||e.length===0)return[];const t=.5,n=.5,s=qo(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,Pr.fromElevationInfo(this.elevationInfo)),r=[],a=s.numVertices,l=s.position;for(let o=0;o<a;++o){const d=he(Wo,l[3*o],l[3*o+1],l[3*o+2]),c=Mn(this._vertexMaterial,t,d),h=Mn(this._vertexOutlineMaterial,n,d);r.push({vertexGeometry:c,vertexOutlineGeometry:h})}return r}createGeometries(e){const t=this._createRenderGeometries();for(const{vertexGeometry:n,vertexOutlineGeometry:s}of t)e.addGeometry(n),e.addGeometry(s)}createExternalResources(){this._vertexMaterial=new cn({...this._vertexMaterialParameters,writeDepth:!0,cullFace:on.Back,screenSizeEnabled:!0}),this._vertexOutlineMaterial=new cn({...this._vertexOutlineMaterialParameters,transparent:!0,writeDepth:!0,cullFace:on.Front,screenSizeEnabled:!0,shadingEnabled:!1})}destroyExternalResources(){this._vertexMaterial=null,this._vertexOutlineMaterial=null}forEachExternalMaterial(e){e(this._vertexMaterial),e(this._vertexOutlineMaterial)}};const Wo=g();function Mn(i,e,t){return xr(i,e,16,16,{offset:t})}let Me=class extends pe{constructor(e){super(e),this.layer=null,this.enabled=!0,this.updating=!1,this.availability=1}};u([p({constructOnly:!0})],Me.prototype,"layer",void 0),u([p()],Me.prototype,"enabled",void 0),u([p()],Me.prototype,"updating",void 0),u([p()],Me.prototype,"availability",void 0),Me=u([I("esri.views.interactive.snapping.FeatureSnappingLayerSource")],Me);const xs=Me;let U=class extends pe{constructor(e){super(e),this.enabled=!1,this.enabledToggled=!1,this.selfEnabled=!0,this.featureEnabled=!0,this.featureSources=new et,this.distance=P.distance,this.touchSensitivityMultiplier=P.touchSensitivityMultiplier}get effectiveEnabled(){return this.enabledToggled?!this.enabled:this.enabled}get effectiveSelfEnabled(){return this.effectiveEnabled&&this.selfEnabled}get effectiveFeatureEnabled(){return this.effectiveEnabled&&this.featureEnabled}};u([p()],U.prototype,"enabled",void 0),u([p()],U.prototype,"enabledToggled",void 0),u([p()],U.prototype,"selfEnabled",void 0),u([p()],U.prototype,"featureEnabled",void 0),u([p({type:et.ofType(xs)})],U.prototype,"featureSources",void 0),u([p()],U.prototype,"distance",void 0),u([p()],U.prototype,"touchSensitivityMultiplier",void 0),u([p({readOnly:!0})],U.prototype,"effectiveEnabled",null),u([p({readOnly:!0})],U.prototype,"effectiveSelfEnabled",null),u([p({readOnly:!0})],U.prototype,"effectiveFeatureEnabled",null),U=u([I("esri.views.interactive.snapping.SnappingOptions")],U);const bs=U;function Bo(i,e){const t=new bs({enabled:!0,selfEnabled:!1,featureEnabled:!0,distance:(e==null?void 0:e.distance)??P.distance,touchSensitivityMultiplier:(e==null?void 0:e.touchSensitivityMultiplier)??P.touchSensitivityMultiplier});return{...x(()=>{var n,s;return((s=(n=i.map)==null?void 0:n.allLayers)==null?void 0:s.toArray())??[]},n=>{t.featureSources=new et(n.map(s=>new xs({layer:s,enabled:!0})))},Ft),options:t}}function Mi({start:i,end:e,type:t},n,s){const r=[],a=oe(Le,e,i),l=oe(tt,i,n),o=ft(a),d=2*St(a,l),c=d*d-4*o*(ft(l)-s*s);if(c===0){const h=-d/(2*o);(t===ne.PLANE||h>=0)&&r.push(dt(ie(),i,a,h))}else if(c>0){const h=Math.sqrt(c),f=(-d+h)/(2*o);(t===ne.PLANE||f>=0)&&r.push(dt(ie(),i,a,f));const m=(-d-h)/(2*o);(t===ne.PLANE||m>=0)&&r.push(dt(ie(),i,a,m))}return r}function $i(i,e){const t=i.start,n=i.end,s=oe(Le,n,t),r=he(tt,-s[1],s[0],0),a=e.start,l=e.end,o=A(qi,l,a),d=L(o,r),c=he(Es,t[0],t[1],0),h=A(Os,c,a),f=L(h,r);if(Math.abs(d)<ee)return[];const m=te(Ts,a,o,f/d);if(e.type===N.RAY){const y=A(Zt,m,a);if(L(y,o)<-ee)return[]}if(i.type===ne.HALF_PLANE){const y=br(Zt,m,t);if(St(y,s)<-ee)return[]}return[ve(m)]}function Ci(i,e){return Ei(Bt(Ui,e[2],i),e)}function Ms(i,e){const n=Cs(Bt(Ui,0,i),Bt(Xo,0,e)),s=[];for(const r of n)s.push(Mr(r));return s}function $s(i,e){return ji(i,Bt(Ui,i[2],e))}function Zo(i,e,t){const n=oe(Le,i,e),s=t/$r(n),r=dt(g(),e,n,s);return r[2]=i[2],r}function ji(i,{start:e,end:t,type:n}){const s=A(Le,i,e),r=A(tt,t,e),a=L(s,r)/L(r,r);return te(g(),e,r,n===N.RAY?Math.max(a,0):a)}function $n({start:i,end:e,type:t},n,s){const r=[],a=Ke(Le,e,i),l=oe(tt,i,n),o=ft(a),d=2*St(a,l),c=d*d-4*o*(ft(l)-s*s);if(c===0){const h=-d/(2*o);(t===N.LINE||h>=0)&&r.push(te(g(),i,a,h))}else if(c>0){const h=Math.sqrt(c),f=(-d+h)/(2*o);(t===N.LINE||f>=0)&&r.push(te(g(),i,a,f));const m=(-d-h)/(2*o);(t===N.LINE||m>=0)&&r.push(te(g(),i,a,m))}return r}function Cs(i,e){const t=i.start,n=i.end,s=e.start,r=e.end,a=A(Le,n,t),l=A(tt,r,s),o=A(qi,s,t),d=re(Es,a,l),c=L(o,d);if(!vi(c,0,ee))return[];const h=Si(d);if(vi(h,0,ee))return[];const f=re(Os,o,l),m=L(f,d)/h,y=te(Ts,t,a,m);if(i.type===N.RAY){const S=A(Zt,y,t);if(L(a,S)<-ee)return[]}if(e.type===N.RAY){const S=A(Zt,y,s);if(L(l,S)<-ee)return[]}return[ve(y)]}function Ei({start:i,end:e,type:t},n){const s=A(Le,n,i),r=A(tt,e,i),a=re(qi,r,s);if(Si(a)/Si(r)<ee)switch(t){case N.LINE:return[ve(n)];case N.RAY:return L(r,s)<-ee?[]:[ve(n)]}return[]}function Cn(i,e,t){return vi(Re(t,i),e*e,ee)?[ve(t)]:[]}function Bt(i,e,{start:t,end:n,type:s}){return he(i.start,t[0],t[1],e),he(i.end,n[0],n[1],e),i.type=Yo[s],i}var ne;(function(i){i[i.PLANE=0]="PLANE",i[i.HALF_PLANE=1]="HALF_PLANE"})(ne||(ne={}));const Yo={[ne.PLANE]:N.LINE,[ne.HALF_PLANE]:N.RAY},ee=1e-6,Le=g(),tt=g(),qi=g(),Es=g(),Os=g(),Ts=g(),Zt=g(),Ui={start:g(),end:g(),type:N.LINE},Xo={start:g(),end:g(),type:N.LINE};let ze=class{intersect(e){return el(this,e)}},Qo=class extends ze{constructor(e){super(),this.point=e}equals(e){return Ne(e)&&E(this.point,e.point)}closestTo(){return ms(this.point)}};class Rs extends ze{constructor(e,t,n){super(),this.start=e,this.end=t,this.type=n,this.lineLike={start:this.start,end:this.end,type:this.type}}equals(e){return Ce(e)&&this.type===e.type&&E(this.start,e.start)&&E(this.end,e.end)}closestTo(e){const t=ji(e,this.lineLike);return t}}let Jo=class extends Rs{constructor(e,t){super(e,t,N.LINE)}};class Kt extends ze{constructor(e,t,n){super(),this.intersection=e,this.first=t,this.second=n}equals(e){return e instanceof Kt&&this.first.equals(e.first)&&this.second.equals(e.second)}closestTo(){return ms(this.intersection)}}let ci=class Ds extends ze{constructor(e,t,n){super(),this.basePoint=e,this.first=t,this.second=n}equals(e){return e instanceof Ds&&this.first.equals(e.first)&&this.second.equals(e.second)}closestTo(e){const t=this.basePoint;return q(t[0],t[1],e[2])}},As=class extends ze{constructor(e,t){super(),this.center=e,this.radius=t}equals(e){return ke(e)&&this.center[0]===e.center[0]&&this.center[1]===e.center[1]&&this.radius===e.radius}closestTo(e){const t=Zo(e,this.center,this.radius);return t}},Wi=class extends ze{constructor(e,t,n){super(),this.start=e,this.end=t,this.type=n,this.planeLike={start:e,end:t,type:n}}equals(e){return Ee(e)&&this.type===e.type&&E(this.start,e.start)&&E(this.end,e.end)}closestTo(e){return $s(e,this.planeLike)}closestEndTo(e){const{start:t,end:n}=this;return Math.sign(St(oe(il,n,t),oe(nl,e,t)))>0?n:t}};class Ls extends Wi{constructor(e,t){super(e,t,ne.HALF_PLANE)}}let zs=class extends Wi{constructor(e,t){super(e,t,ne.PLANE)}};class Vs extends ze{constructor(e,t,n){super(),this.start=e,this.end=t,this.getZ=n,this.planeLike={start:e,end:t,type:ne.PLANE}}equals(e){return Oe(e)&&E(this.start,e.start)&&E(this.end,e.end)&&this.getZ===e.getZ}closestTo(e){return Ko(this,e)}addIfOnTheGround(e,t){for(const n of t){const s=this.getZ(n[0],n[1],n[2])??0;Math.abs(n[2]-s)<ee&&(n[2]=s,e.push(n))}}}function Ko(i,e){const t=$s(e,i.planeLike);return t[2]=i.getZ(e[0],e[1],e[2])??Hs,t}function el(i,e){let t=[];if(Ne(i)){const{point:n}=i;Ce(e)?t=Ei(e.lineLike,n):ke(e)?t=Cn(e.center,e.radius,n):Ee(e)?t=Ci(e.planeLike,n):Oe(e)&&(t=rt(e,i))}else if(Ce(i)){const{lineLike:n}=i;Ne(e)?t=Ei(n,e.point):Ce(e)?t=Cs(n,e.lineLike):ke(e)?t=$n(n,e.center,e.radius):Ee(e)?t=$i(e.planeLike,n):Oe(e)&&(t=rt(e,i))}else if(ke(i)){const{center:n,radius:s}=i;if(Ce(e))t=$n(e.lineLike,n,s);else if(Ne(e))t=Cn(n,s,e.point);else{if(Ee(e))return Mi(e.planeLike,n,s).map(r=>new ci(r,i,e));Oe(e)&&(t=rt(e,i))}}else if(Ee(i)){const{planeLike:n}=i;if(Ee(e))return Ms(n,e.planeLike).map(s=>new ci(s,i,e));if(Ne(e))t=Ci(n,e.point);else if(Ce(e))t=$i(n,e.lineLike);else{if(ke(e))return Mi(n,e.center,e.radius).map(s=>new ci(s,i,e));Oe(e)&&(t=rt(e,i))}}else Oe(i)&&(t=rt(i,e));return tl(t,i,e)}function rt(i,e){const{planeLike:t,getZ:n}=i,s=[];if(Ne(e))i.addIfOnTheGround(s,Ci(t,e.point));else if(Ce(e))i.addIfOnTheGround(s,$i(t,e.lineLike));else if(ke(e))for(const[r,a]of Mi(t,e.center,e.radius)){const l=n(r,a,0);l!=null&&s.push(q(r,a,l))}else if(Ee(e)||Oe(e))for(const[r,a]of Ms(t,e.planeLike)){const l=n(r,a,0)??Hs;s.push(q(r,a,l))}return s}function tl(i,e,t){return i.map(n=>new Kt(n,e,t))}function Ne(i){return i instanceof Qo}function Ce(i){return i instanceof Rs}function ke(i){return i instanceof As}function Ee(i){return i instanceof Wi}function Oe(i){return i instanceof Vs}const il=ie(),nl=ie(),Hs=0;let it=class{constructor(e,t,n,s){this.targetPoint=e,this.constraint=t,this.isDraped=n,this.domain=s}},Bi=class extends it{constructor({targetPoint:e,objectId:t,constraint:n,isDraped:s}){super(e,n,s,z.FEATURE),this.objectId=t}},sl=class extends Bi{constructor(e){super({...e,isDraped:!0,constraint:new Vs(e.edgeStart,e.edgeEnd,e.getGroundElevation)})}get hints(){return[new Y(k.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}},rl=class extends Bi{constructor(e){super({...e,constraint:new Jo(e.edgeStart,e.edgeEnd)})}get hints(){return[new Y(k.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}},Is=class extends it{constructor({targetPoint:e,constraint:t,previousVertex:n,otherVertex:s,otherVertexType:r,objectId:a,isDraped:l}){super(e,t,l,z.SELF),this.previousVertex=n,this.otherVertex=s,this.otherVertexType=r,this.objectId=a}get hints(){const e=this.previousVertex,t=this.otherVertexType===Je.CENTER?this.otherVertex:this.targetPoint,n=this.otherVertexType===Je.CENTER?this.targetPoint:this.otherVertex;return[new Y(k.TARGET,t,n,this.isDraped,this.domain),new Y(k.REFERENCE,e,t,this.isDraped,this.domain),new ki(this.previousVertex,t,n,this.isDraped,this.domain)]}};var Je;(function(i){i[i.NEXT=0]="NEXT",i[i.CENTER=1]="CENTER"})(Je||(Je={}));let le=class extends Ri{get updating(){return Cr(this.snappingSources,({snappingSource:i})=>i.updating)||this.updatingHandles.updating}get snappingSources(){const i=this._get("snappingSources")||new Map,e=new Map;if(this.options!=null&&this.options.featureSources!=null)for(const t of this.options.featureSources.items){const n=t.layer.uid,s=i.get(n);if(s){i.delete(n),e.set(n,s);continue}if(!t.layer.loaded){this.updatingHandles.addPromise(t.layer.load());continue}const r=this._createSourceInfo(t);r!=null&&e.set(n,r)}for(const[,t]of i)t.destroy();return e}constructor(i){super(i),this.options=null,this._domain=z.FEATURE,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){this.updatingHandles.add(()=>this.snappingSources,()=>this.notifyChange("updating"),Qe),this.view!=null&&this.handles.add([this.view.on("layerview-create",i=>this._updateLayerView(i.layer,i.layerView)),this.view.on("layerview-destroy",i=>this._updateLayerView(i.layer,null))])}_updateLayerView(i,e){for(const[,t]of this.snappingSources)t.snappingSource.layerSource.layer===i&&(t.layerView=e)}destroy(){this._set("options",null);for(const[,i]of this.snappingSources)i.destroy()}async fetchCandidates(i,e,t,n){var o;if(!(e&this._domain&&this.options!=null&&this.options.effectiveFeatureEnabled))return[];const s=[],r=this._computeScreenSizeDistanceParameters(i,t),a={distance:r,mode:((o=this.view)==null?void 0:o.type)??"2d",point:i,coordinateHelper:t.coordinateHelper,...this._types};for(const[,{snappingSource:d,layerView:c}]of this.snappingSources)!d.layerSource.enabled||c!=null&&c.suspended||s.push(d.fetchCandidates(a,n).then(h=>h.filter(f=>!this._candidateIsExcluded(d,f,t.excludeFeature))));const l=(await Er(s)).flat();return this._addRightAngleCandidates(l,i,r,t),Or(n),Ni(i,l),l}_addRightAngleCandidates(i,e,t,n){var c,h,f,m,y,S,v,D;const s=n.vertexHandle!=null?(h=(c=n.vertexHandle.rightEdge)==null?void 0:c.rightVertex)==null?void 0:h.pos:n.editGeometryOperations!=null&&n.editGeometryOperations.data.type==="polygon"?(m=(f=n.editGeometryOperations.data.components[0])==null?void 0:f.getFirstVertex())==null?void 0:m.pos:null,r=n.vertexHandle!=null?(S=(y=n.vertexHandle.leftEdge)==null?void 0:y.leftVertex)==null?void 0:S.pos:n.editGeometryOperations!=null?(D=(v=n.editGeometryOperations.data.components[0])==null?void 0:v.getLastVertex())==null?void 0:D.pos:null,{view:a}=this,l=$(s,a,n),o=$(r,a,n),d=i.length;for(let fe=0;fe<d;fe++)this._addRightAngleCandidate(i[fe],o,e,t,i),this._addRightAngleCandidate(i[fe],l,e,t,i)}_addRightAngleCandidate(i,e,t,n,s){if(e==null||!ol(i))return;const r=i.constraint.closestTo(e),a=(r[0]-t[0])/n.x,l=(r[1]-t[1])/n.y,{start:o,end:d}=i.constraint;if(a*a+l*l<=1){const c=new Is({targetPoint:r,otherVertex:e,otherVertexType:Je.NEXT,previousVertex:Re(r,o)>Re(r,d)?o:d,constraint:new Ls(e,r),objectId:i.objectId,isDraped:i.isDraped});s.push(c)}}_computeScreenSizeDistanceParameters(i,e){let t=this.options!=null?this.options.distance*(e.pointer==="touch"?this.options.touchSensitivityMultiplier:1):0;return this.view==null?{x:t,y:t,z:t,distance:t}:this.view.type==="2d"?(t*=this.view.resolution,{x:t,y:t,z:t,distance:t}):this._computeScreenSizeDistanceParameters3D(i,t,this.view,e)}_computeScreenSizeDistanceParameters3D(i,e,t,n){const{spatialReference:s}=n;t.renderCoordsHelper.toRenderCoords(i,s,En);const r=t.state.camera.computeScreenPixelSizeAt(En),a=r*t.renderCoordsHelper.unitInMeters/t.mapCoordsHelper.unitInMeters,l=e*a,o=H(i,s,R,t),d=o?ui(o,i,a,0,0,t,n):0,c=o?ui(o,i,0,a,0,t,n):0,h=o?ui(o,i,0,0,a,t,n):0;return{x:d===0?0:l/d,y:c===0?0:l/c,z:h===0?0:l/h,distance:r*e}}get _types(){return{returnEdge:!0,returnVertex:!0}}_candidateIsExcluded(i,e,t){if(t==null)return!1;const n=this._getCandidateObjectId(e);if(n==null)return!1;const s=i.layerSource.layer;return s.type==="graphics"?t.uid===n:t.sourceLayer===s&&!(!t.attributes||!("objectIdField"in s))&&t.attributes[s.objectIdField]===n}_getCandidateObjectId(i){return i instanceof Bi?i.objectId:null}_createSourceInfo(i){const e=this._createFeatureSnappingSourceType(i);if(e==null)return null;if("loading"in e)return this.updatingHandles.addPromise(e.loading.then(()=>{this.destroyed||this.notifyChange("snappingSources")})),null;const t=this.view!=null?this.view.allLayerViews.find(n=>n.layer===i.layer):null;return new al(e.source,t)}_createFeatureSnappingSourceType(i){switch(i.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(i);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(i);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(i);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(i)}return null}_createFeatureSnappingSourceSceneLayer(i){const{view:e}=this;if(e==null||e.type!=="3d")return null;const t=this._getSourceModule("scene");return t.module!=null?{source:new t.module.SceneLayerSnappingSource({layerSource:i,view:e})}:{loading:t.loader}}_createFeatureSnappingSourceFeatureLayer(i){var e;switch((e=i.layer.source)==null?void 0:e.type){case"feature-layer":case"oriented-imagery":{const t=this._getSourceModule("featureService");return t.module!=null?{source:new t.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:i})}:{loading:t.loader}}case"memory":case"csv":case"geojson":case"wfs":{if(i.layer.geometryType==="mesh")return null;const t=this._getSourceModule("featureCollection");return t.module!=null?{source:new t.module.FeatureCollectionSnappingSource({layerSource:i,view:this.view})}:{loading:t.loader}}}return null}_createFeatureSnappingSourceGraphicsLayer(i){const e=this._getSourceModule("graphics");return e.module!=null?{source:new e.module.GraphicsSnappingSource({getGraphicsLayers:()=>[i.layer],spatialReference:this.spatialReference,view:this.view,layerSource:i})}:{loading:e.loader}}_createFeatureSnappingSourceMapNotesLayer(i){const e=this._getSourceModule("notes");return e.module!=null?{source:new e.module.GraphicsSnappingSource({getGraphicsLayers:()=>i.layer.sublayers!=null?i.layer.sublayers.toArray():[],spatialReference:this.spatialReference,view:this.view,layerSource:i})}:{loading:e.loader}}_getSourceModule(i){const e=this._sourceModules[i];if(e.loader==null){const t=this._loadSourceModule(i).then(n=>{e.module=n});return e.loader=t,{module:e.module,loader:t}}return{module:e.module,loader:e.loader}}_loadSourceModule(i){const e=this.updatingHandles;switch(i){case"featureService":return e.addPromise(bt(()=>import("./FeatureServiceSnappingSource-637dc2fb.js"),["assets/FeatureServiceSnappingSource-637dc2fb.js","assets/index-d29f6b97.js","assets/index-0492b785.css","assets/elevationInfoUtils-77250170.js","assets/queryEngineUtils-3bf87c8f.js","assets/VertexSnappingCandidate-e19f94c2.js","assets/TileTreeDebugger-842c5f90.js","assets/LineVisualElement-db91c665.js","assets/LengthDimension-1fe5a076.js","assets/Segment-1413661a.js","assets/unitFormatUtils-233032b0.js","assets/analysisViewUtils-c120a7c9.js","assets/ImageMaterial-be81a34f.js","assets/Factory-71ec2c06.js","assets/RightAngleQuadVisualElement-62adb2cd.js","assets/VisualElementResources-0bc87c86.js","assets/PointVisualElement-df95dd99.js","assets/colorUtils-c0f43caf.js","assets/EditGeometryOperations-31ebd7de.js","assets/dehydratedFeatureComparison-9b093626.js","assets/RenderTexture-fb0e3709.js"]));case"featureCollection":return e.addPromise(bt(()=>import("./FeatureCollectionSnappingSource-50f9c1c5.js"),["assets/FeatureCollectionSnappingSource-50f9c1c5.js","assets/index-d29f6b97.js","assets/index-0492b785.css","assets/elevationInfoUtils-77250170.js","assets/queryEngineUtils-3bf87c8f.js","assets/VertexSnappingCandidate-e19f94c2.js","assets/symbologySnappingCandidates-5d86c7dd.js","assets/LRUCache-2af9f319.js","assets/LineVisualElement-db91c665.js","assets/LengthDimension-1fe5a076.js","assets/Segment-1413661a.js","assets/unitFormatUtils-233032b0.js","assets/analysisViewUtils-c120a7c9.js","assets/ImageMaterial-be81a34f.js","assets/Factory-71ec2c06.js","assets/RightAngleQuadVisualElement-62adb2cd.js","assets/VisualElementResources-0bc87c86.js","assets/PointVisualElement-df95dd99.js","assets/colorUtils-c0f43caf.js","assets/EditGeometryOperations-31ebd7de.js","assets/dehydratedFeatureComparison-9b093626.js","assets/RenderTexture-fb0e3709.js"]));case"graphics":case"notes":return e.addPromise(bt(()=>import("./GraphicsSnappingSource-7a66f015.js"),["assets/GraphicsSnappingSource-7a66f015.js","assets/index-d29f6b97.js","assets/index-0492b785.css","assets/normalizeUtilsSync-4e86052e.js","assets/normalizeUtilsCommon-6017271d.js","assets/FeatureStore-f7e2c654.js","assets/BoundsStore-0665b530.js","assets/PooledRBush-5ef79871.js","assets/quickselect-6ad44cba.js","assets/optimizedFeatureQueryEngineAdapter-faf2ce2d.js","assets/centroid-8e8cfa47.js","assets/QueryEngine-059f149f.js","assets/normalizeUtils-4068a3de.js","assets/WhereClause-bfeee3cb.js","assets/executionError-c92d3b85.js","assets/json-48e3ea08.js","assets/QueryEngineCapabilities-42e44ded.js","assets/utils-bcda6eea.js","assets/generateRendererUtils-9b13adb9.js","assets/FieldsIndex-f92177f9.js","assets/elevationInfoUtils-77250170.js","assets/queryEngineUtils-3bf87c8f.js","assets/VertexSnappingCandidate-e19f94c2.js","assets/symbologySnappingCandidates-5d86c7dd.js","assets/LRUCache-2af9f319.js","assets/LineVisualElement-db91c665.js","assets/LengthDimension-1fe5a076.js","assets/Segment-1413661a.js","assets/unitFormatUtils-233032b0.js","assets/analysisViewUtils-c120a7c9.js","assets/ImageMaterial-be81a34f.js","assets/Factory-71ec2c06.js","assets/RightAngleQuadVisualElement-62adb2cd.js","assets/VisualElementResources-0bc87c86.js","assets/PointVisualElement-df95dd99.js","assets/colorUtils-c0f43caf.js","assets/EditGeometryOperations-31ebd7de.js","assets/dehydratedFeatureComparison-9b093626.js","assets/RenderTexture-fb0e3709.js"]));case"scene":return e.addPromise(bt(()=>import("./SceneLayerSnappingSource-69371fc4.js"),["assets/SceneLayerSnappingSource-69371fc4.js","assets/index-d29f6b97.js","assets/index-0492b785.css","assets/VertexSnappingCandidate-e19f94c2.js","assets/LineVisualElement-db91c665.js","assets/LengthDimension-1fe5a076.js","assets/Segment-1413661a.js","assets/unitFormatUtils-233032b0.js","assets/elevationInfoUtils-77250170.js","assets/analysisViewUtils-c120a7c9.js","assets/ImageMaterial-be81a34f.js","assets/Factory-71ec2c06.js","assets/RightAngleQuadVisualElement-62adb2cd.js","assets/VisualElementResources-0bc87c86.js","assets/PointVisualElement-df95dd99.js","assets/colorUtils-c0f43caf.js","assets/EditGeometryOperations-31ebd7de.js","assets/dehydratedFeatureComparison-9b093626.js","assets/RenderTexture-fb0e3709.js"]))}}};u([p({constructOnly:!0})],le.prototype,"spatialReference",void 0),u([p({constructOnly:!0})],le.prototype,"view",void 0),u([p()],le.prototype,"options",void 0),u([p({readOnly:!0})],le.prototype,"updating",null),u([p({readOnly:!0})],le.prototype,"snappingSources",null),le=u([I("esri.views.interactive.snapping.FeatureSnappingEngine")],le);class al{constructor(e,t){this.snappingSource=e,this.layerView=t,this.handles=new Yt;const n=this.snappingSource.layerSource.layer;if("refresh"in n){const s=n;this.handles.add(s.on("refresh",()=>e.refresh()))}this.handles.add([x(()=>e.updating,s=>e.layerSource.updating=s,F),x(()=>e.availability,s=>e.layerSource.availability=s,F)])}destroy(){this.snappingSource.destroy(),this.handles.destroy()}}function ol(i){return(i instanceof rl||i instanceof sl)&&!ll(i)}function ll({constraint:{start:i,end:e}}){const t=yi(i,e),n=Re(i,e);return t<Tr()||n/t<cl}function ui(i,e,t,n,s,r,{spatialReference:a}){const l=V(dl,e);l[0]+=t,l[1]+=n,l[2]+=s;const o=H(l,a,R,r);return o?Oo(o,i):1/0}const En=g(),dl=g(),cl=1e-4;let ei=class{constructor(e,t){this.view=e,this.options=t,this.squaredShortLineThreshold=P.shortLineThreshold*P.shortLineThreshold}snap(e,t){return t.vertexHandle!=null?t.vertexHandle.type!=="vertex"?[]:this.snapExistingVertex(e,t):this.snapNewVertex(e,t)}edgeExceedsShortLineThreshold(e,t){return this.exceedsShortLineThreshold($(e.leftVertex.pos,this.view,t),$(e.rightVertex.pos,this.view,t),t)}exceedsShortLineThreshold(e,t,{spatialReference:n}){return this.squaredShortLineThreshold===0||Ae(H(t,n,R,this.view),H(e,n,R,this.view))>this.squaredShortLineThreshold}isVertical(e,t){return Re(e,t)<P.verticalLineThreshold}squaredProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,n=e*t;return n*n}},ul=class extends it{constructor({lineStart:e,lineEnd:t,targetPoint:n,isDraped:s}){super(n,new zs(e,t),s,z.SELF),this._referenceLineHint=new Y(k.REFERENCE_EXTENSION,e,t,s,this.domain)}get hints(){return[this._referenceLineHint,new Y(k.TARGET,this._lineEndClosestToTarget(),this.targetPoint,this.isDraped,this.domain)]}_lineEndClosestToTarget(){return this.constraint.closestEndTo(this.targetPoint)}},hl=class extends ei{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],s=n.edges.length,r=[];if(s<1)return r;const{spatialReference:a}=t,l=H(e,a,R,this.view),{view:o}=this,d=n.edges[s-1];let c=d;do{if(this.edgeExceedsShortLineThreshold(c,t)){const h=Ut(c,o,t);this._processCandidateProposal(h.left,h.right,e,l,t,r)}c=c.leftVertex.leftEdge}while(c&&c!==d);return r}snapExistingVertex(e,t){const n=[],s=t.vertexHandle,r=s.component;if(r.edges.length<2)return n;const{view:a}=this,{spatialReference:l}=t,o=H(e,l,R,a),d=s.leftEdge,c=s.rightEdge;d&&c&&this.edgeExceedsShortLineThreshold(d,t)&&this.edgeExceedsShortLineThreshold(c,t)&&this._processCandidateProposal($(d.leftVertex.pos,a,t),$(c.rightVertex.pos,a,t),e,o,t,n);const h=r.edges[0];let f=h;do{if(f!==s.leftEdge&&f!==s.rightEdge&&this.edgeExceedsShortLineThreshold(f,t)){const m=Ut(f,a,t);this._processCandidateProposal(m.left,m.right,e,o,t,n)}f=f.rightVertex.rightEdge}while(f&&f!==h);return n}_processCandidateProposal(e,t,n,s,r,a){var c;const{spatialReference:l,pointer:o}=r,d=ji(n,{start:e,end:t,type:N.LINE});Ae(s,H(d,l,R,this.view))<this.squaredProximityThreshold(o)&&a.push(new ul({lineStart:e,lineEnd:t,targetPoint:d,isDraped:((c=r.elevationInfo)==null?void 0:c.mode)==="on-the-ground"}))}},pl=class extends it{constructor({referenceLine:e,lineStart:t,targetPoint:n,isDraped:s}){const r=ve(t),{left:a,right:l}=e;Ke(r,In(r,r,l),a),super(n,new zs(t,r),s,z.SELF),this._referenceLines=[{edge:e,fadeLeft:!0,fadeRight:!0}]}get hints(){return[new Y(k.TARGET,this.constraint.start,this.targetPoint,this.isDraped,this.domain),new vs(this.constraint.start,this.targetPoint,this.isDraped,this.domain),...this._referenceLines.map(e=>new Y(k.REFERENCE,e.edge.left,e.edge.right,this.isDraped,this.domain,e.fadeLeft,e.fadeRight))]}addReferenceLine(e){const t={edge:e,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach(n=>{E(e.right,n.edge.left)&&(n.fadeLeft=!1,t.fadeRight=!1),E(e.right,n.edge.right)&&(n.fadeRight=!1,t.fadeRight=!1),E(e.left,n.edge.right)&&(n.fadeRight=!1,t.fadeLeft=!1),E(e.left,n.edge.left)&&(n.fadeLeft=!1,t.fadeLeft=!1)}),this._referenceLines.push(t)}},fl=class extends ei{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],s=n.edges.length,r=n.vertices.length,a=[];if(s<2)return a;const{view:l}=this,o=H(e,t.spatialReference,R,l),d=$(n.vertices[r-1].pos,l,t),c=$(n.vertices[0].pos,l,t),h=n.edges[s-1];let f=h;do{if(this.edgeExceedsShortLineThreshold(f,t)){const m=Ut(f,l,t);this._checkEdgeForParallelLines(m,d,e,o,t,a),this._checkEdgeForParallelLines(m,c,e,o,t,a)}f=f.leftVertex.leftEdge}while(f&&f!==h);return a}snapExistingVertex(e,t){const n=[],s=t.vertexHandle,r=s.component;if(r.edges.length<3)return n;const{view:a}=this,l=H(e,t.spatialReference,R,a),o=s.leftEdge,d=s.rightEdge,c=r.vertices[0],h=$(c.pos,a,t),f=r.vertices.length,m=r.vertices[f-1],y=$(m.pos,a,t),S=r.edges[0];let v=S;do{if(v!==o&&v!==d&&this.edgeExceedsShortLineThreshold(v,t)){const D=Ut(v,a,t);o&&this._checkEdgeForParallelLines(D,$(o.leftVertex.pos,a,t),e,l,t,n),d&&this._checkEdgeForParallelLines(D,$(d.rightVertex.pos,a,t),e,l,t,n),s===c?this._checkEdgeForParallelLines(D,y,e,l,t,n):s===m&&this._checkEdgeForParallelLines(D,h,e,l,t,n)}v=v.rightVertex.rightEdge}while(v&&v!==S);return n}_checkEdgeForParallelLines(e,t,n,s,r,a){var f;const l=e.left,o=e.right;if(ai(Pe,t,l,o),Re(Pe,t)<P.parallelLineThreshold)return;ai(Pe,n,l,o,t);const{spatialReference:d,pointer:c}=r,h=q(Pe[0],Pe[1],n[2]);if(Ae(s,H(h,d,R,this.view))<this.squaredProximityThreshold(c)){if(this.isVertical(h,t)||this.isVertical(l,o)||this._parallelToPreviousCandidate(e,a))return;a.push(new pl({referenceLine:e,lineStart:t,targetPoint:h,isDraped:((f=r.elevationInfo)==null?void 0:f.mode)==="on-the-ground"}))}}_parallelToPreviousCandidate(e,t){const n=e.left,s=e.right;for(const r of t)if(ai(Pe,s,r.constraint.start,r.constraint.end,n),Re(Pe,s)<P.parallelLineThreshold)return r.addReferenceLine(e),!0;return!1}};const Pe=ie();let ml=class extends ei{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],s=n.vertices.length,r=[];if(s<2)return r;const{view:a}=this,l=H(e,t.spatialReference,R,a),o=n.vertices[s-1];if(this.edgeExceedsShortLineThreshold(o.leftEdge,t)){const c=$(o.pos,a,t),h=$(o.leftEdge.leftVertex.pos,a,t);this._checkForSnappingCandidate(r,h,c,e,l,t)}const d=n.vertices[0];if(this.edgeExceedsShortLineThreshold(d.rightEdge,t)){const c=$(d.pos,a,t),h=$(d.rightEdge.rightVertex.pos,a,t);this._checkForSnappingCandidate(r,h,c,e,l,t)}return r}snapExistingVertex(e,t){const n=[],s=t.vertexHandle;if(s.component.vertices.length<3)return n;const{view:r}=this,a=H(e,t.spatialReference,R,r),l=s.leftEdge,o=s.rightEdge;if(l&&l.leftVertex.leftEdge){const d=l.leftVertex.leftEdge;if(this.edgeExceedsShortLineThreshold(d,t)){const c=$(d.rightVertex.pos,r,t),h=$(d.leftVertex.pos,r,t);this._checkForSnappingCandidate(n,h,c,e,a,t)}}if(o&&o.rightVertex.rightEdge){const d=o.rightVertex.rightEdge;if(this.edgeExceedsShortLineThreshold(d,t)){const c=$(d.leftVertex.pos,r,t),h=$(d.rightVertex.pos,r,t);this._checkForSnappingCandidate(n,h,c,e,a,t)}}return n}_checkForSnappingCandidate(e,t,n,s,r,a){var f;const{spatialReference:l,pointer:o}=a;oe(Dt,n,t);const d=he(gl,Dt[1],-Dt[0],0),c=St(d,oe(Dt,s,n))/ft(d),h=dt(ve(s),n,d,c);if(Ae(r,H(h,l,R,this.view))<this.squaredProximityThreshold(o)){if(this.isVertical(h,n)||this.isVertical(n,t))return;const m=te(g(),n,d,Math.sign(c));e.push(new Is({targetPoint:h,constraint:new Ls(n,m),previousVertex:t,otherVertex:n,otherVertexType:Je.CENTER,isDraped:((f=a.elevationInfo)==null?void 0:f.mode)==="on-the-ground"}))}}};const Dt=ie(),gl=g();let _l=class extends it{constructor({targetPoint:e,point1:t,point2:n,isDraped:s}){super(e,new As(Nn(g(),t,n,.5),.5*kn(t,n)),s,z.SELF),this._p1=t,this._p2=n}get hints(){return[new Y(k.REFERENCE,this.targetPoint,this._p1,this.isDraped,this.domain),new Y(k.REFERENCE,this.targetPoint,this._p2,this.isDraped,this.domain),new ki(this._p1,this.targetPoint,this._p2,this.isDraped,this.domain)]}},yl=class extends ei{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],s=[],r=n.vertices.length;if(t.editGeometryOperations.data.type!=="polygon"||r<2)return s;const{view:a}=this,l=n.vertices[0],o=n.vertices[r-1],d=$(l.pos,a,t),c=$(o.pos,a,t);return this._processCandidateProposal(d,c,e,t,s),s}snapExistingVertex(e,t){const n=[],s=t.vertexHandle,r=s.component;if(r.edges.length<2||t.editGeometryOperations.data.type==="polyline"&&(s.index===0||s.index===r.vertices.length-1))return n;const{view:a}=this,l=$(s.leftEdge.leftVertex.pos,a,t),o=$(s.rightEdge.rightVertex.pos,a,t);return this._processCandidateProposal(l,o,e,t,n),n}_processCandidateProposal(e,t,n,s,r){var m;if(!this.exceedsShortLineThreshold(e,t,s))return;const a=Rr(vl,e,t,.5),l=.5*kn(e,t),o=g();Pa(o,n,a,l),o[2]=n[2];const d=o,{spatialReference:c,pointer:h}=s,f=H(n,c,R,this.view);if(Ae(f,H(d,c,R,this.view))<this.squaredProximityThreshold(h)){if(this.isVertical(e,d)||this.isVertical(d,t))return;r.push(new _l({targetPoint:d,point1:e,point2:t,isDraped:((m=s.elevationInfo)==null?void 0:m.mode)==="on-the-ground"}))}}};const vl=ie();let Fe=class extends pe{constructor(e){super(e),this.updating=!1,this._snappers=new et,this._domain=z.SELF}initialize(){this._snappers.push(new fl(this.view,this.options),new hl(this.view,this.options),new ml(this.view,this.options),new yl(this.view,this.options))}set options(e){this._set("options",e);for(const t of this._snappers)t.options=e}async fetchCandidates(e,t,n){if(!(t&this._domain&&this.options.effectiveSelfEnabled))return[];const s=[];for(const r of this._snappers.items)for(const a of r.snap(e,n))s.push(a);return Ni(e,s),s}};u([p({readOnly:!0})],Fe.prototype,"updating",void 0),u([p({constructOnly:!0})],Fe.prototype,"view",void 0),u([p()],Fe.prototype,"options",null),Fe=u([I("esri.views.interactive.snapping.SelfSnappingEngine")],Fe);function Sl(i,e){return[new Fe({view:i,options:e}),new le({view:i,options:e,spatialReference:i.spatialReference})]}let At=class extends it{constructor(e,t,n,s){super(e,new Kt(e,t.constraint,n.constraint),s,z.ALL),this.first=t,this.second=n}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new gs(this.targetPoint,this.isDraped,this.domain)]}},J=class extends Dr.EventedMixin(Ri){constructor(e){super(e),this.options=new bs,this.snappingEnginesFactory=Sl,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=de.MAIN}initialize(){this.handles.add([x(()=>{const{effectiveFeatureEnabled:e,effectiveSelfEnabled:t,touchSensitivityMultiplier:n,distance:s}=this.options;return{effectiveFeatureEnabled:e,effectiveSelfEnabled:t,touchSensitivityMultiplier:n,distance:s}},()=>{this.doneSnapping(),this.emit("changed")},Qe),x(()=>this.options,e=>{for(const t of this._engines)t.options=e},Qe),x(()=>({viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,snappingEnginesFactory:this.snappingEnginesFactory}),({viewReady:e,snappingEnginesFactory:t})=>this._recreateEngines(e,t),F)])}destroy(){this._destroyEngines()}get updating(){return this._engines.some(e=>e.updating)}_recreateEngines(e,t){if(this._destroyEngines(),!e)return;const{view:n,options:s}=this;this._engines=t(n,s)}_destroyEngines(){for(const e of this._engines)e.destroy();this._engines=[]}get _squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,n=e*t;return n*n}get _squaredSatisfiesConstraintThreshold(){return P.satisfiesConstraintScreenThreshold*P.satisfiesConstraintScreenThreshold}async snap(e){return wl(e)?this._snapMultiPoint(e):this._snapSinglePoint(e)}update(e){const{point:t,context:n}=e;this._removeVisualization();const s=this._currentMainCandidate;if(s==null)return t;const r=this._selectUpdateInput(e);if(r==null)return t;const{spatialReference:a}=n,l=ln(r,a);if(l==null)return t;const{view:o}=this,{elevationInfo:d,visualizer:c}=n,h=[],f=at(l,o,n),m=s.constraint.closestTo(f);if(!this._arePointsWithinScreenThreshold(f,m,n))return this._resetSnappingState(),t;s.targetPoint=m,h.push(...s.hints);for(const y of this._currentOtherActiveCandidates)y.targetPoint=m,h.push(...y.hints);return c!=null&&this.handles.add(c.draw(h,{spatialReference:a,elevationInfo:Pl(n),view:o,selfSnappingZ:n.selfSnappingZ}),Lt),wn(m,o,{z:t.z,m:t.m,spatialReference:t.spatialReference,elevationInfo:d})}doneSnapping(){this._removeVisualization(),this._resetSnappingState()}_selectUpdateInput({point:e,scenePoint:t}){switch(this._currentSnappedType){case de.MAIN:return e;case de.SCENE:return t}}_resetSnappingState(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=de.MAIN}_removeVisualization(){this.handles.remove(Lt)}async _snapSinglePoint({point:e,context:t,signal:n}){const{view:s}=this,r=at(e,s,t),a=await this._fetchCandidates(r,z.ALL,t,n);return this._createSnapResult(r,de.MAIN,a,s,t,{z:e.z,m:e.m,spatialReference:e.spatialReference,elevationInfo:t.elevationInfo},n)}async _snapMultiPoint({point:e,scenePoint:t,context:n,signal:s}){const{view:r}=this,{coordinateHelper:a,spatialReference:l}=n;await Ar(t.spatialReference,l);const o=ln(t,l),d=at(o,r,n),c=await this._fetchCandidates(d,z.FEATURE,n,s);if(c.length>0){const m=await this._fetchCandidates(d,z.SELF,n,s);return this._createSnapResult(d,de.SCENE,[...c,...m],r,n,{z:o.z,m:o.m,spatialReference:o.spatialReference,elevationInfo:n.elevationInfo},s)}const h=at(e,r,n),f=await this._fetchCandidates(h,z.SELF,n,s);return this._createSnapResult(h,de.MAIN,f,r,n,{z:a.hasZ()&&e.hasZ?e.z??0:void 0,m:a.hasM()&&e.hasM?e.m??0:void 0,spatialReference:e.spatialReference,elevationInfo:n.elevationInfo},s)}async _fetchCandidates(e,t,n,s){return(await Promise.all(this._engines.map(r=>r.fetchCandidates(e,t,n,s)))).flat()}_createSnapResult(e,t,n,s,r,a,l){return{get valid(){return!Lr(l)},apply:()=>{const{spatialReference:o}=r,{snappedPoint:d,hints:c}=this._processCandidates(e,t,n,r);return this._removeVisualization(),r.visualizer!=null&&this.handles.add(r.visualizer.draw(c,{spatialReference:o,elevationInfo:R,view:s,selfSnappingZ:r.selfSnappingZ}),Lt),wn(d,s,a)}}}_processCandidates(e,t,n,s){if(n.length<1)return this.doneSnapping(),{snappedPoint:e,hints:[]};this._currentSnappedType!==t&&this._resetSnappingState(),Ni(e,n);const r=this._currentMainCandidate;if(r!=null){const a=this._findOldConstraintInNewCandidates(r,n);if(a>=0){if(!(n[a]instanceof At))return this._intersectWithOtherCandidates(a,n,e,t,s);if(this._arePointsWithinScreenThreshold(e,r.targetPoint,s))return this._updateSnappingCandidate(r,t,n,s)}}return this._intersectWithOtherCandidates(0,n,e,t,s)}_findOldConstraintInNewCandidates(e,t){return e instanceof At?this._findOldCandidateIndex(t,e.first)>=0&&this._findOldCandidateIndex(t,e.second)>=0?0:-1:this._findOldCandidateIndex(t,e)}_intersectWithOtherCandidates(e,t,n,s,r){const{coordinateHelper:a}=r,l=t[e],o=[];for(let d=0;d<t.length;++d){if(d===e)continue;const c=t[d];for(const h of l.constraint.intersect(c.constraint)){const f=h.closestTo(l.targetPoint);o.push([new At(f,l,c,c.isDraped),this._squaredScreenDistance(n,f,a)])}}return o.length>0&&(o.sort((d,c)=>d[1]-c[1]),o[0][1]<this._squaredPointProximityThreshold(r.pointer))?this._updateSnappingCandidate(o[0][0],s,t,r):this._updateSnappingCandidate(l,s,t,r)}_updateSnappingCandidate(e,t,n,s){this.doneSnapping(),this._currentMainCandidate=e,this._currentSnappedType=t;const r=this._currentMainCandidate.targetPoint,a=[];a.push(...e.hints);for(const l of n){if(e instanceof At){if(l.constraint.equals(e.first.constraint)||l.constraint.equals(e.second.constraint))continue}else if(l.constraint.equals(e.constraint))continue;const o=l.constraint.closestTo(r);this._squaredScreenDistance(o,r,s.coordinateHelper)<this._squaredSatisfiesConstraintThreshold&&(l.targetPoint=r,this._currentOtherActiveCandidates.push(l),a.push(...l.hints))}return{snappedPoint:r,hints:a}}_squaredPointProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityTreshold}_arePointsWithinScreenThreshold(e,t,n){return this._squaredScreenDistance(e,t,n.coordinateHelper)<this._squaredPointProximityThreshold(n.pointer)}_squaredScreenDistance(e,t,n){return Ae(this._toScreen(e,n),this._toScreen(t,n))}_toScreen(e,t){return H(e,t.spatialReference,R,this.view)}_findOldCandidateIndex(e,t){let n=-1;for(let s=0;s<e.length;++s)if(t.constraint.equals(e[s].constraint)){n=s;break}return n}get test(){return{visualizationsActive:this.handles.has(Lt),engines:this._engines}}};var de;u([p({constructOnly:!0})],J.prototype,"view",void 0),u([p()],J.prototype,"options",void 0),u([p({readOnly:!0})],J.prototype,"updating",null),u([p()],J.prototype,"snappingEnginesFactory",void 0),u([p()],J.prototype,"_engines",void 0),u([p()],J.prototype,"_squaredMouseProximityTreshold",null),u([p()],J.prototype,"_squaredTouchProximityThreshold",null),u([p()],J.prototype,"_squaredSatisfiesConstraintThreshold",null),J=u([I("esri.views.interactive.snapping.SnappingManager")],J),function(i){i[i.MAIN=0]="MAIN",i[i.SCENE=1]="SCENE"}(de||(de={}));const Lt="visualization-handle";function wl(i){return i.scenePoint!=null}function Pl({coordinateHelper:i,elevationInfo:e}){return i.hasZ()?R:e}const Ht=new Map;function xl(i){if(!Ht.has(i)){const n=Bo(i,{distance:10}),s=Ml(i,n.options);Ht.set(i,{referenceCount:0,snappingManager:s,remove:()=>{n.remove(),s.destroy()}})}const e=Ht.get(i);e.referenceCount++;const t=Nt(()=>bl(i,e));return{snappingManager:e.snappingManager,...t}}function bl(i,e){e.referenceCount--,e.referenceCount>0||zr(()=>{e.referenceCount===0&&(e.remove(),Ht.delete(i))})}function Ml(i,e){return new J({view:i,options:e,snappingEnginesFactory:(t,n)=>[new le({view:i,spatialReference:i.spatialReference,options:n})]})}class Gs{constructor(e){this.vertexHandle=null,this.excludeFeature=null,this.visualizer=null,this.selfSnappingZ=null,this.editGeometryOperations=e.editGeometryOperations,this.elevationInfo=e.elevationInfo,this.pointer=e.pointer,this.vertexHandle=e.vertexHandle,this.excludeFeature=e.excludeFeature,this.visualizer=e.visualizer,this.selfSnappingZ=e.selfSnappingZ}get coordinateHelper(){return this.editGeometryOperations.data.coordinateHelper}get spatialReference(){return this.coordinateHelper.spatialReference}}function $l({predicate:i=()=>!0,snappingManager:e,snappingContext:t,updatingHandles:n,useZ:s=!0}){const r=new Qn;if(e==null)return{snappingStep:[On,r],cancelSnapping:On};let a,l=null,o=null,d=null;const c=()=>{l=mt(l),e.doneSnapping(),o!=null&&o.frameTask.remove(),o=null,a=Di(a),d=null},h=Cl(e,s,r);let f=null,m=null,y=null;return{snappingStep:[S=>{if(!i(S))return S;const{action:v}=S;if(v==="start"){const{info:D}=S,fe=El(e.view);if(o=Ol(t,S,fe),o.context.selfSnappingZ=null,!s&&D!=null){const nt=Rl(t.coordinateHelper,D.handle.component);nt!=null&&(o.context.selfSnappingZ={value:nt,elevationInfo:t.elevationInfo??R})}}if(o!=null){const{context:D,originalScenePos:fe,originalPos:nt}=o,{mapEnd:Zi,mapStart:Yi,scenePoints:ks}=S,ti=Fs(nt,Oi(Zi,Yi)),Xi=Oi(Yi,nt),js={...S,action:"update"},qs=o.context,ii=Tl(fe,ks),Qi=e.update({point:ti,scenePoint:ii,context:D});if(y=Qi,Ns(Zi,Qi,Xi,s),f=ti,m=ii,v!=="end"){const{frameTask:Us}=o;l==null&&(l=new AbortController),d=Ws=>{n.addPromise(wi(h({frameTask:Us,event:js,context:qs,point:ti,scenePoint:ii,delta:Xi,getLastState:()=>({point:f,scenePoint:m,updatePoint:Ws.forceUpdate?null:y})},l.signal)))},d({forceUpdate:!1}),a==null&&(a=x(()=>e.options.effectiveEnabled,()=>d==null?void 0:d({forceUpdate:!0})))}}return v==="end"&&c(),S},r],cancelSnapping:S=>(c(),S)}}function Cl(i,e,t){return Un(async({frameTask:n,point:s,scenePoint:r,context:a,event:l,delta:o,getLastState:d},c)=>{const h=await n.schedule(()=>i.snap({point:s,scenePoint:r,context:a,signal:c}),c);if(h.valid){let f=await n.schedule(()=>h.apply(),c);const m=d();m.point!=null&&s!==m.point&&(f=i.update({point:m.point,scenePoint:m.scenePoint,context:a})),m.updatePoint!=null&&$a(f,m.updatePoint)||(Ns(l.mapEnd,f,o,e),t.execute(l))}})}function El(i){return i.type==="3d"?i.resourceController.scheduler.registerTask(jn.SNAPPING):qn}function Ol(i,e,t){return{context:new Gs({editGeometryOperations:i.editGeometryOperations,elevationInfo:i.elevationInfo,pointer:i.pointer,vertexHandle:e.info!=null?e.info.handle:null,excludeFeature:i.excludeFeature,visualizer:i.visualizer}),originalPos:e.snapOrigin!=null?i.coordinateHelper.vectorToDehydratedPoint(e.snapOrigin):e.mapStart,originalScenePos:e.scenePoints!=null?e.scenePoints.sceneStart:null,frameTask:t}}function Fs(i,[e,t,n]){const s=qe(i);return s.x+=e,s.y+=t,s.hasZ&&(s.z+=n),s}function Tl(i,e){return i==null||e==null?null:Fs(i,Oi(e.sceneEnd,e.sceneStart))}function Oi(i,e){const t=i.hasZ&&e.hasZ?i.z-e.z:0;return[i.x-e.x,i.y-e.y,t]}function Ns(i,e,[t,n,s],r){i.x=e.x+t,i.y=e.y+n,r&&i.hasZ&&e.hasZ&&(i.z=e.z+s)}function Rl(i,e){if(!i.hasZ())return null;const t=e.vertices;let n=null;for(const s of t){const r=i.getZ(s.pos);if(n!=null&&r!=null&&Math.abs(r-n)>1e-6)return null;n==null&&(n=r)}return n}function On(i){return i}let $e=class extends pe{constructor(e){super(e),this.constrainResult=t=>t,this._snapPoints=null,this._frameTask=null,this._abortController=null,this._stagedPoint=null,this._snap=Un(async(t,n,s,r)=>{const a=this._frameTask;if(a==null)return;const l=await a.schedule(()=>n.snap({...t,context:s,signal:r}),r);l.valid&&await a.schedule(()=>{this.stagedPoint=l.apply(),t!==this._snapPoints&&this._snapPoints!=null&&(this.stagedPoint=n.update({...this._snapPoints,context:s}))},r)})}get stagedPoint(){return this._stagedPoint}set stagedPoint(e){this._stagedPoint=this.constrainResult(e)}initialize(){var t,n;const e=this.view.type==="3d"?(n=(t=this.view)==null?void 0:t.resourceController)==null?void 0:n.scheduler:null;this._frameTask=e!=null?e.registerTask(jn.SNAPPING):qn}destroy(){this._abortController=mt(this._abortController),this._frameTask=Di(this._frameTask)}update(e,t,n){this._snapPoints=e;const{point:s,scenePoint:r}=e,a=t.update({point:s,scenePoint:r,context:n});return this.stagedPoint=a,a}async snap(e,t,n){const{point:s,scenePoint:r}=e;return this.stagedPoint=t.update({point:s,scenePoint:r,context:n}),this._snapPoints=e,this._abortController==null&&(this._abortController=new AbortController),this._snap(e,t,n,this._abortController.signal)}async resnap(e,t){this._snapPoints!=null&&await this.snap(this._snapPoints,e,t)}abort(){this._abortController=mt(this._abortController),this._snapPoints=null}};u([p({constructOnly:!0})],$e.prototype,"view",void 0),u([p()],$e.prototype,"stagedPoint",null),u([p()],$e.prototype,"constrainResult",void 0),u([p()],$e.prototype,"_stagedPoint",void 0),$e=u([I("esri.views.interactive.snapping.SnappingOperation")],$e);let G=class extends Ri{constructor(i){super(i),this._stagedDimension=null,this._computationManipulators=new Map,this._computationHandles=new Yt,this._getSnappingContext=yo(t=>new Gs({elevationInfo:{mode:"absolute-height",offset:0},pointer:t,editGeometryOperations:new xa(new ba("point",Ma(!0,!1,this.view.spatialReference))),visualizer:new Ao})),this._snappingManagerResult=xl(i.view),this.addHandles(this._snappingManagerResult),this._unfocusedOffsetManipulatorMaterial=hi(),this._focusedOffsetManipulatorMaterial=hi(),this._thinOffsetManipulatorMaterial=hi(),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:Te(2)}),this._constraintSnappingIndicator=new xe({view:i.view,attached:!0,width:1,color:C.toUnitRGBA(T.constraint.color),renderOccluded:w.OccludeAndTransparent,stipplePattern:Te(5)});const e=C.toUnitRGBA(T.disabledPointIndicator.color);this._stagedStartIndicator=new Uo({view:i.view,attached:!1,color:e,size:2*T.disabledPointIndicator.radius,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:i.view.renderCoordsHelper.spatialReference,outlineSize:0,renderOccluded:w.OccludeAndTransparent})}initialize(){var s;this._snappingOperation=new $e({view:this.view});const{color:i,contrastColor:e}=T.orientationManipulator,t=!((s=this.view._stage)!=null&&s.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result);this._orientationManipulatorTexture=fa(this.view.toolViewManager.textures,{accentColor:i,contrastColor:e,preMultiplyAlpha:t}),this._orientationManipulatorMaterial=new wa({transparent:!0,writeDepth:!1,textureId:this._orientationManipulatorTexture.texture.id,renderOccluded:w.Opaque});const{computations:n}=this.analysisViewData;for(const r of n)this._addComputation(r);this.addHandles([n.on("after-add",r=>this._addComputation(r.item)),n.on("after-remove",r=>this._removeComputation(r.item))]),this.addHandles([x(()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation}),({stagedPoint:r,stagedComputation:a})=>{if(a==null||r==null)return;const l=qe(r,new Ue);this._applyPointUpdate(a,{endPoint:l})},Qe),x(()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}),(r,a)=>{const{stagedDimension:l,selectedComputation:o,firstGrabbedManipulator:d}=r;if(l===(a==null?void 0:a.stagedDimension)&&d===(a==null?void 0:a.firstGrabbedManipulator)){for(const c of[o,a==null?void 0:a.selectedComputation])if(c!=null){const h=this._computationManipulators.get(c);this._updateManipulators(c,h,r)}}else for(const[c,h]of this._computationManipulators)this._updateManipulators(c,h,r)},F),x(()=>this.analysis.style.lineSize,r=>{this._updateManipulatorStyle(r)},Ft),x(()=>this.view.state.camera,()=>{this._stagedComputation!=null&&this._updateStagedDimensionOffset(this._stagedComputation)}),x(()=>Vr(this._stagedComputation,r=>{const a=r.elevationAlignedStartPoint,l=g();return a!=null&&this.view.renderCoordsHelper.toRenderCoords(a,l)?l:null}),r=>{r!=null?(this._stagedStartIndicator.vertices=[r],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1})]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles),To(this,()=>{const r=this._activeComputation,a=this._stagedComputation;if(r==null||a!=null){const l=this.view.inputManager.latestPointerType??"mouse",o=this._getSnappingContext(l);this.updatingHandles.addPromise(wi(this._snappingOperation.resnap(this._snappingManager,o)))}if(r!=null){const{start:l,end:o}=this._computationManipulators.get(r);if(l.grabbing||o.grabbing){const d=l.grabbing?"start":"end",c=this._computeConstraint(r);Po(r,d,{constraint:c,view:this.view})}}})}destroy(){this._snappingOperation=ht(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),this._orientationManipulatorMaterial.dispose(),this._orientationManipulatorTexture.release()}get updating(){return this.updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get snappingOptions(){return this._snappingManager.options}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(this._stagedComputation!=null)return this._stagedComputation;const{selectedComputation:i}=this.analysisViewData;return this.hasGrabbedManipulators&&i!=null?i:null}get _stagedComputation(){const i=this._stagedDimension,e=this.analysisViewData.computations.at(-1);return i==null||e==null||e.dimension!==i?null:e}get _constraintHandles(){return[Ai(()=>this.analysisViewData.selectedComputation,i=>{i.previousConstraint=this._computeConstraint(i)},{...F,equals:Pi}),x(()=>{const i=this._activeComputation;if(i==null)return null;const{measureType:e,orientation:t}=i.dimension;return{measureType:e,orientation:t,computation:i}},(i,e)=>{if(i!=null&&e==null){const{measureType:t,orientation:n,computation:s}=i;switch(s.previousConstraint){case X.Horizontal:s.preConstraintProperties={measureType:O.Horizontal,orientation:0};break;case X.Vertical:s.preConstraintProperties={measureType:O.Vertical,orientation:0};break;case X.Direct:s.preConstraintProperties={measureType:O.Direct,orientation:n};break;default:s.preConstraintProperties={measureType:t,orientation:n}}}i==null&&e!=null&&(e.computation.preConstraintProperties=null)},Qe)]}get _snappingIndicatorHandles(){const i="snapping-indicator-event-handles";return[x(()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation}),({stagedComputation:e,activeComputation:t})=>{const n=this._constraintSnappingIndicator;if(this.removeHandles(i),t!=null)if(t===e)n.attached=!0;else{const{start:s,end:r}=this._computationManipulators.get(t),a=()=>{n.attached=s.grabbing||r.grabbing};a(),this.addHandles([s.events.on("grab-changed",a),r.events.on("grab-changed",a)],i)}else n.attached=!1}),x(()=>{const e=this._activeComputation;return e!=null?{geometry:e.geometry,constraint:e.previousConstraint}:{}},({geometry:e,constraint:t})=>{const n=this._constraintSnappingIndicator;e!=null&&t!=null&&t!==X.Direct?(n.visible=!0,n.setGeometryFromSegment(e.directSegment)):n.visible=!1})]}removeStaged(){return this._stagedDimension!=null&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(i){const{_stagedDimension:e}=this;if(e==null){const t=this._onUnstagedClick(i);return this.analysis.dimensions.add(t),null}return this._onStagedClick(i),e}onPointerMove({mapPoint:i,pointerType:e}){if(e==="touch")return;const t=this._getSnappingContext(e);this.updatingHandles.addPromise(wi(this._snappingOperation.snap({point:i},this._snappingManager,t)))}onManipulatorSelectionChanged(){this.analysisViewData.selectedComputation!=null&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:i,pointerType:e}){let t=i;if(e==="mouse"){const s=this._getSnappingContext(e);t=this._snappingManager.update({point:i,context:s})}const n=new Kr({startPoint:qe(t,new Ue),endPoint:null,measureType:O.Horizontal});return this._stagedDimension=n,this._resetSnappingState(),n}_onStagedClick({mapPoint:i,pointerType:e}){const t=this._stagedComputation;if(t==null)return;let n=i;if(e==="mouse"){const r=this._getSnappingContext(e);n=this._snappingManager.update({point:i,context:r})}const s=qe(n,new Ue);this._applyPointUpdate(t,{endPoint:s}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._snappingManager.doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_addComputation(i){if(this._computationManipulators.has(i))return;const e=this._setupPointManipulator(i,{isStart:!0}),t=this._setupPointManipulator(i,{isStart:!1}),n=this._setupOffsetManipulator(i),s=this._setupHeadingManipulator(i),r=this._setupRotationManipulator(i),a=this._setupMeasureTypeManipulator(i,O.Direct),l=this._setupMeasureTypeManipulator(i,O.Horizontal),o=this._setupMeasureTypeManipulator(i,O.Vertical),d=new Xa({start:e,end:t,offset:n,heading:s,rotation:r,direct:a,horizontal:l,vertical:o});this._setupComputationToManipulatorsSync(i,d),this._computationManipulators.set(i,d),this.manipulators.addMany(d.values())}_removeComputation(i){const e=this._computationManipulators.get(i);if(e!=null){this._computationHandles.remove(i),this._computationManipulators.delete(i);for(const t of e.values())this.manipulators.remove(t)}}_setupComputationToManipulatorsSync(i,e){this._computationHandles.add([x(()=>i.geometry,()=>this._updateManipulators(i,e),{...F,equals:Pi})],i)}_setupPointManipulator(i,e){const{view:t}=this,{dimension:n}=i,s=Qa(t,{metadata:n}),r=eo(s,{isStart:e.isStart,createSnappingPipelineStep:a=>$l({snappingContext:this._getSnappingContext(a),snappingManager:this._snappingManager,updatingHandles:this.updatingHandles}),dimension:n,onUpdate:a=>this._applyPointUpdate(i,a),view:t});return this._computationHandles.add(r,i),s}_setupOffsetManipulator(i){const{view:e}=this,t=Ja(e,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:i.dimension}),n=to(t,{computation:i,view:e});return this._computationHandles.add(n,i),t}_setupHeadingManipulator(i){const{view:e}=this,t=fn(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:i.dimension}),n=io(t,{computation:i,view:e});return this._computationHandles.add(n,i),t}_setupRotationManipulator(i){const{view:e}=this,t=fn(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:i.dimension}),n=no(t,{computation:i,view:e});return this._computationHandles.add(n,i),t}_setupMeasureTypeManipulator(i,e){const{view:t}=this,n=Ka(t,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:i.dimension}),s=ao(n,{computation:i,manipulatorMeasureType:e,view:t});return this._computationHandles.add(s,i),n}_updateManipulators(i,e,t={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:n,selectedComputation:s,firstGrabbedManipulator:r}=t,{start:a,end:l,offset:o,heading:d,rotation:c}=e,h=s===i,f=_t(i),{dimension:m}=i;for(const v of e.values()){const D=f&&n==null&&(r==null||v===r);v===o?(v.available=D,v.selected=h):v.available=D&&h}if(!f)return;this._computeConstraint(i)!=null?e.forEachMeasureTypeManipulator(v=>v.available=!1):e.manipulatorForMeasureType(m.measureType).available=!1;for(const v of[d,c])m.measureType===O.Direct&&m.offset!==0||(v.available=!1);Hi(i)?c.available=!1:d.available=!1;const{geometry:y}=i;a.renderLocation=y.directSegment.startRenderSpace,l.renderLocation=y.directSegment.endRenderSpace;const{renderCoordsHelper:S}=this.view;oo(o,y,S),d.available&&lo(d,i,S),c.available&&co(c,i,S),e.forEachMeasureTypeManipulator((v,D)=>{v.available&&po(v,i,D,S)})}_updateManipulatorStyle(i){const e=_o(i),t=Fi(i),n={lineSizePt:i,material:this._orientationManipulatorMaterial};for(const{offset:s,heading:r,rotation:a}of this._computationManipulators.values())s.radius=t/2,mn(r,n),mn(a,n);this._unfocusedOffsetManipulatorMaterial.setParameters({width:e}),this._focusedOffsetManipulatorMaterial.setParameters({width:t})}_applyPointUpdate(i,e){const{view:t}=this,n=kt(i);"startPoint"in e&&(n.elevationAlignedStartPoint=e.startPoint),"endPoint"in e&&(n.elevationAlignedEndPoint=e.endPoint);const s=jt(n,t.renderCoordsHelper);if(s==null)return;const r=this._computeConstraint({...n,geometry:s});fs(i,e,{...n,constraint:r,unconstrainedGeometry:s,view:t}),i===this._stagedComputation&&this._updateStagedDimensionOffset(i)}_updateStagedDimensionOffset(i){if(i.geometry==null)return;i.geometry.directSegment.eval(.5,Tn);const e=this.view.state.camera.computeRenderPixelSizeAt(Tn);i.dimension.offset=T.initialOffsetPx*e}_computeConstraint(i){return wo(So(i,this._snappingManager.options),this.view)}get testInfo(){const i=e=>this.analysisViewData.computations.find(t=>t.dimension===e);return{disableManipulatorPartialOcclusion:()=>{this._stagedStartIndicator.renderOccluded=w.Occlude,this.manipulators.forEach(({manipulator:e})=>{for(const{geometry:t}of e.renderObjects)t.material.setParameters({renderOccluded:w.Occlude})})},getManipulatorsForDimension:e=>this._computationManipulators.get(i(e)),getComputationForDimension:e=>i(e),getConstraintForDimension:e=>{const t=i(e);return t!=null?this._computeConstraint(t):null},stagedDimension:this._stagedDimension,stagedStartIndicator:this._stagedStartIndicator,constraintSnappingIndicator:this._constraintSnappingIndicator,snappingManager:this._snappingManager}}};function hi(){const{color:i}=T.offsetManipulator;return new ce({color:C.toUnitRGBA(i),width:1,renderOccluded:w.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0})}u([p({constructOnly:!0})],G.prototype,"analysis",void 0),u([p({constructOnly:!0})],G.prototype,"analysisViewData",void 0),u([p({constructOnly:!0})],G.prototype,"manipulators",void 0),u([p({constructOnly:!0})],G.prototype,"parentTool",void 0),u([p({constructOnly:!0,nonNullable:!0})],G.prototype,"view",void 0),u([p({readOnly:!0})],G.prototype,"updating",null),u([p()],G.prototype,"firstGrabbedManipulator",null),u([p()],G.prototype,"hasGrabbedManipulators",null),u([p()],G.prototype,"snappingOptions",null),u([p()],G.prototype,"_stagedDimension",void 0),u([p()],G.prototype,"_activeComputation",null),u([p()],G.prototype,"_stagedComputation",null),G=u([I("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],G);const Tn=g();var je;(function(i){i.Ready="ready",i.Creating="creating",i.Created="created"})(je||(je={}));let W=class extends da{constructor(i){super(i),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._pointerMoveTimerMs=T.pointerMoveTimeoutMs,this._prevPointerMoveTimeout=null}initialize(){this._intersector=Hr(this.view.state.viewingMode),this._intersector.options.store=Ir.MIN,this._lengthDimensionSubTool=new G({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([Ge(this._lengthDimensionSubTool),Nt(()=>this._clearPointerMoveTimeout()),x(()=>this.state,i=>{i===je.Created&&this.finishToolCreation()},F),Ai(()=>this.firstGrabbedManipulator,i=>{this.selectedDimension=i.metadata},F),x(()=>this.selectedDimension,()=>this._resetPointerMoveTimeout(),F)])}get state(){return this.analysis.dimensions.some(i=>i.type==="length")?this._activeSubTool!=null?je.Creating:je.Created:je.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(i){this.analysisViewData.selectedDimension=i}onInputEvent(i){switch(i.type){case"immediate-click":this._clickHandler(i);break;case"immediate-double-click":this._doubleClickHandler(i);break;case"pointer-move":this._pointerMoveHandler(i);break;case"key-down":if(xn.cancel===i.key){if(this._activeSubTool!=null&&this._activeSubTool.removeStaged())return void i.stopPropagation();this.active||(this.selectedDimension=null)}else xn.delete.includes(i.key)&&this._deleteKeyHandler()}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){this._activeSubTool!=null&&(this._activeSubTool.onDeactivate(),this._activeSubTool=null)}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(i){if(this.hasFocusedManipulators)return void i.stopPropagation();if(this._activeSubTool==null)return;const e=this._intersectScreen(i);e!=null&&(this.selectedDimension=this._activeSubTool.onClick({mapPoint:e,pointerType:i.pointerType}),i.stopPropagation())}_doubleClickHandler(i){this.active&&(this.view.activeTool=null,i.stopPropagation())}_pointerMoveHandler(i){if(this._resetPointerMoveTimeout(),this._activeSubTool==null||this.hasFocusedManipulators)return;const e=this._intersectScreen(i);e!=null&&this._activeSubTool.onPointerMove({mapPoint:e,pointerType:i.pointerType})}_deleteKeyHandler(){this._activeSubTool!=null&&this._activeSubTool.removeStaged(),this._removeSelected()}_intersectScreen(i){const e=Gr(i);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const t=this._intersector.results.min,n=b.get();return t.getIntersectionPoint(n)?this.view.renderCoordsHelper.fromRenderCoords(n,this.view.spatialReference):null}_removeSelected(){this.selectedDimension!=null&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=Di(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach(i=>{i.manipulator.state|=ue}),this._prevPointerMoveTimeout=Fr.setTimeout(()=>{this.manipulators.forEach(i=>{i.manipulator.state&=~ue})},this._pointerMoveTimerMs)}get testInfo(){return{...this._lengthDimensionSubTool.testInfo,setManipulatorAutoHideDelay:i=>{this._pointerMoveTimerMs=i,this._resetPointerMoveTimeout()}}}};u([p({constructOnly:!0})],W.prototype,"view",void 0),u([p({constructOnly:!0})],W.prototype,"analysis",void 0),u([p({readOnly:!0})],W.prototype,"state",null),u([p({readOnly:!0})],W.prototype,"updating",null),u([p({readOnly:!0})],W.prototype,"cursor",null),u([p({constructOnly:!0})],W.prototype,"analysisViewData",void 0),u([p()],W.prototype,"selectedDimension",null),u([p()],W.prototype,"automaticManipulatorSelection",void 0),u([p()],W.prototype,"_activeSubTool",void 0),u([p()],W.prototype,"_lengthDimensionSubTool",void 0),W=u([I("esri.views.3d.analysis.Dimension.DimensionTool")],W);class Dl extends Bn{constructor(e,t){super(e),this._hasExternalMaterial=!1,this._renderOccluded=w.OccludeAndTransparent,this._width=1,this._color=It(1,0,1,1),this._placement="end",this._textureId=null,this._material=t,this._hasExternalMaterial=t!=null,this.applyProps(e)}setGeometryFromSegment(e,t){const n=e.endRenderSpace;this.transform=Nr(Al,n),this._normal=t;const{points:s}=e.createRenderGeometry(n,this.view.renderCoordsHelper);this.geometry=[s]}get renderOccluded(){return this._material!=null?this._material.parameters.renderOccluded:this._renderOccluded}set renderOccluded(e){this._renderOccluded=e,this._material!=null&&this._material.setParameters({renderOccluded:e})}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get normal(){return this._normal}set normal(e){this._normal=e,this.recreateGeometry()}get width(){return this._material!=null?this._material.parameters.width:this._width}set width(e){this._width=e,this._material!=null&&this._material.setParameters({width:e})}get color(){return this._material!=null?this._material.parameters.color:this._color}set color(e){this._color=Vn(e),this._material!=null&&this._material.setParameters({color:this._color})}get placement(){return this._material!=null?this._material.parameters.placement:this._placement}set placement(e){this._placement=e,this._material!=null&&this._material.setParameters({placement:this._placement})}get textureId(){return this._material!=null?this._material.parameters.textureId:this._textureId}set textureId(e){this._textureId=e,this._material!=null&&this._material.setParameters({textureId:e})}createExternalResources(){this._hasExternalMaterial||(this._material=new Wn({width:this._width,color:this._color,placement:this._placement,renderOccluded:this._renderOccluded,textureId:this._textureId}))}destroyExternalResources(){this._hasExternalMaterial||(this._material=null)}createGeometries(e){for(const t of kr(this.geometry,this.normal)){const n=jr(this._material,t);e.addGeometry(n)}}forEachExternalMaterial(e){this._hasExternalMaterial||e(this._material)}}const Al=Ti();let Ll=class{set visible(e){for(const t of this._visualElements.values())t.attached=e}constructor(e){this.destroyed=!1,this._handles=new Yt,this._messages=null,this._labelSegment=new De;const{analysis:t,computation:n,view:s,messages:r}=e;this.analysis=t,this.computation=n,this.view=s,this._messages=r;const a=e.visible,l={view:s,attached:a},{fontSize:o,textColor:d,textBackgroundColor:c}=t.style;this._visualElements=new Gl({marker:new Dl(l,e.markerMaterial),dimension:new xe(l,e.dimensionLineMaterial),startOffset:new xe(l,e.offsetLineMaterial),endOffset:new xe(l,e.offsetLineMaterial),dimensionSmall:new xe(l,e.smallDimensionLineMaterial),startOffsetSmall:new xe(l,e.smallOffsetLineMaterial),endOffsetSmall:new xe(l,e.smallOffsetLineMaterial),label:new na({view:s,attached:a,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:ae(o),textColor:d.clone(),backgroundColor:c.clone()})}),this._handles.add([x(()=>n.geometry,h=>{this.updateCameraDependentElements(s.state.camera,h,t.style),n.geometry!=null&&this._updateLines(n.geometry)},{...Ft,equals:Pi}),x(()=>n.length,h=>this._updateLabelContent(h),Ft)])}destroy(){this.destroyed=!0,this._handles=ht(this._handles);for(const e of this._visualElements.values())e.destroy()}get testInfo(){return{dimensionVisualElement:this._visualElements.dimension,label:this._visualElements.label}}_updateLines(e){const t=pn(Vl,gt.Start,e.directSegment,e.dimensionSegment),n=pn(Hl,gt.End,e.directSegment,e.dimensionSegment),s=this._visualElements;s.marker.setGeometryFromSegment(e.dimensionSegment,e.primaryOffsetAxis),s.dimension.setGeometryFromSegment(e.dimensionSegment),s.startOffset.setGeometryFromSegment(t),s.endOffset.setGeometryFromSegment(n),s.dimensionSmall.setGeometryFromSegment(e.dimensionSegment),s.startOffsetSmall.setGeometryFromSegment(t),s.endOffsetSmall.setGeometryFromSegment(n)}updateCameraDependentElements(e,t,n){const s=this._visualElements;if(t==null){for(const S of s.values())S.visible=!1;return}const r=e.computeScreenPixelSizeAt(t.dimensionSegment.eval(.5,Il)),a=Ga(t,r),l=a<(ae(n.lineSize)*T.smallScreenLengthLineSizeFactor)**2,o=!l;s.marker.visible=o,s.dimension.visible=o,s.startOffset.visible=o,s.endOffset.visible=o,s.dimensionSmall.visible=l,s.startOffsetSmall.visible=l,s.endOffsetSmall.visible=l;const d=ae(n.fontSize)*T.labels.minScreenLengthFontSizeFactor,{label:c}=s;if(c.visible=a>=d**2,!c.visible)return;const{dimensionSegment:h,primaryOffsetAxis:f}=t,{offset:m}=this.computation.dimension,y=(Math.sign(m)>=0?1:-1)*zl(n)*r;Da(this._labelSegment,h,f,y),c.updateLabelPosition()}updateLabelStyle(e){const{label:t}=this._visualElements;t.fontSize=ae(e.fontSize),t.textColor=e.textColor,t.backgroundColor=e.textBackgroundColor}updateUnitsMessages(e){this._messages=e;const{length:t}=this.computation;this._updateLabelContent(t)}_updateLabelContent(e){const{label:t}=this._visualElements;e!=null&&this._messages!=null?t.text=sa(this._messages,e,e.unit):t.text=""}};function zl(i){return 1.5*ae(i.fontSize)+T.labels.marginPx+ae(i.lineSize/2)}const Vl=new De,Hl=new De,Il=g();class Gl{constructor(e){this.marker=e.marker,this.dimension=e.dimension,this.startOffset=e.startOffset,this.endOffset=e.endOffset,this.dimensionSmall=e.dimensionSmall,this.startOffsetSmall=e.startOffsetSmall,this.endOffsetSmall=e.endOffsetSmall,this.label=e.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}let Fl=class{constructor(e,t){this._textures=e,this._textureRepository=t,this._texturesByPrimitive=new Map}acquire(e){if(!this._texturesByPrimitive.has(e)){const t=qr(this._textures,e),n=new Ca(this._textureRepository,t.texture.id);return this._texturesByPrimitive.set(e,{result:t,reference:n}),t.texture}return this._texturesByPrimitive.get(e).result.texture}destroy(){this._texturesByPrimitive.forEach(({result:e,reference:t})=>{t.dispose(),e.release()}),this._texturesByPrimitive.clear()}},ge=class extends pe{get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}constructor(i){super(i),this.loadingMessages=!1,this._messages=null,this._dimensionVisualizations=new Map,this._markerMaterial=new Wn({width:1,anchor:Ur.Tip,color:st,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:w.OccludeAndTransparent}),this._dimensionLineMaterial=new ce({width:1,color:st,renderOccluded:w.OccludeAndTransparent,markerParameters:this._markerMaterial.parameters}),this._offsetLineMaterial=new ce({width:1,color:st,renderOccluded:w.OccludeAndTransparent,stipplePattern:Te(5),stippleScaleWithLineWidth:!0}),this._smallDimensionLineMaterial=new ce({width:1,color:st,renderOccluded:w.OccludeAndTransparent}),this._smallOffsetLineMaterial=new ce({width:1,color:st,renderOccluded:w.OccludeAndTransparent,stipplePattern:Te(5),stippleScaleWithLineWidth:!0})}initialize(){var t;const i=(t=this.view.sharedSymbolResources)==null?void 0:t.textures;if(i!=null){const{textureRepository:n}=this.view._stage.renderView,s=new Fl(i,n),r=s.acquire("triangle");this.addHandles(Nt(()=>s.destroy())),this._markerMaterial.setParameters({textureId:r.id})}for(const n of this._lineMaterials())this.view._stage.add(n),this.addHandles(Nt(()=>{var s;(s=this.view._stage)==null||s.remove(n),n.dispose()}));const{computations:e}=this.analysisViewData;for(const n of e)this._addComputation(n);this.addHandles([e.on("change",({added:n,removed:s})=>{for(const r of s)this._removeComputation(r);for(const r of n)this._addComputation(r)}),x(()=>C.toUnitRGBA(this.analysis.style.color),n=>{for(const s of this._lineMaterials())s.setParameters({color:n})},F),x(()=>this.analysis.style.lineSize,n=>{const s=ae(n);this._markerMaterial.setParameters({width:s*T.markers.lineSizeFraction}),this._dimensionLineMaterial.setParameters({width:s,markerParameters:this._markerMaterial.parameters});const r=Math.max(s*T.offsetLine.lineSizeFraction,1);this._offsetLineMaterial.setParameters({width:r})},F),x(()=>({camera:this.view.state.camera,style:Nl(this.analysis)}),({camera:n,style:s})=>{for(const[r,a]of this._dimensionVisualizations)a.updateCameraDependentElements(n,r.geometry,s),a.updateLabelStyle(s)}),x(()=>this.visible,n=>{for(const s of this._dimensionVisualizations.values())s.visible=n})]),this.addHandles([Wr(()=>this._updateMessageBundle()),Ai(()=>!this.loadingMessages,()=>{for(const n of this._dimensionVisualizations.values())n.updateUnitsMessages(this._messages)},Qe)]),this._updateMessageBundle()}destroy(){this._dimensionVisualizations.forEach(i=>{i.destroy()}),this._dimensionVisualizations.clear()}get testInfo(){return{visualizations:Array.from(this._dimensionVisualizations.values()),disablePartialOcclusion:()=>{for(const i of this._lineMaterials())i.setParameters({renderOccluded:w.Occlude})}}}_addComputation(i){this._dimensionVisualizations.has(i)||this._dimensionVisualizations.set(i,new Ll({analysis:this.analysis,computation:i,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages}))}_removeComputation(i){const e=this._dimensionVisualizations.get(i);e!=null&&(e.destroy(),this._dimensionVisualizations.delete(i))}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await Br("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function Nl(i){const{fontSize:e,lineSize:t,textColor:n,textBackgroundColor:s}=i.style;return{fontSize:e,lineSize:t,textBackgroundColor:s.clone(),textColor:n.clone()}}u([p({constructOnly:!0})],ge.prototype,"analysisViewData",void 0),u([p({constructOnly:!0,nonNullable:!0})],ge.prototype,"view",void 0),u([p()],ge.prototype,"analysis",null),u([p()],ge.prototype,"visible",null),u([p()],ge.prototype,"loadingMessages",void 0),ge=u([I("esri.views.3d.analysis.Dimension.DimensionVisualization")],ge);let ot=class extends pe{constructor(i){super(i),this.dimension=null,this.length=null}};u([p({constructOnly:!0,nonNullable:!0})],ot.prototype,"dimension",void 0),u([p()],ot.prototype,"length",void 0),ot=u([I("esri.views.3d.analysis.LengthDimensionResult")],ot);const kl=ot;let B=class extends pe{constructor(i){super(i),this.geometry=null,this.unconstrainedGeometry=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}normalizeCtorArgs(i){const{dimension:e,...t}=i;return{result:new kl({dimension:e}),...t}}initialize(){this.addHandles([x(()=>this.dimension.startPoint,i=>this.elevationAlignedStartPoint=this.projectAndAlignPoint(i),F),x(()=>this.dimension.endPoint,i=>this.elevationAlignedEndPoint=this.projectAndAlignPoint(i),F)])}get dimension(){return this.result.dimension}get length(){return this.result.length}};u([p({constructOnly:!0,nonNullable:!0})],B.prototype,"result",void 0),u([p({constructOnly:!0,nonNullable:!0})],B.prototype,"projectAndAlignPoint",void 0),u([p()],B.prototype,"dimension",null),u([p()],B.prototype,"length",null),u([p()],B.prototype,"geometry",void 0),u([p()],B.prototype,"unconstrainedGeometry",void 0),u([p()],B.prototype,"elevationAlignedStartPoint",void 0),u([p()],B.prototype,"elevationAlignedEndPoint",void 0),u([p()],B.prototype,"preConstraintProperties",void 0),u([p()],B.prototype,"previousConstraint",void 0),B=u([I("esri.views.3d.analysis.LengthDimensionComputation")],B);const jl=i=>{let e=class extends i{constructor(...t){super(...t),this.analysis=null,this.tool=null,this.selectedDimension=null,this.interactive=!1,this.visible=null}get results(){return new et}createLengthDimensions(t){throw new Error("Method not implemented.")}};return u([p({constructOnly:!0})],e.prototype,"view",void 0),u([p({constructOnly:!0,nonNullable:!0})],e.prototype,"analysis",void 0),u([p()],e.prototype,"tool",void 0),u([p({readOnly:!0})],e.prototype,"results",null),u([p()],e.prototype,"selectedDimension",void 0),u([p()],e.prototype,"interactive",void 0),u([p()],e.prototype,"visible",void 0),e=u([I("esri.views.analysis.DimensionAnalysisView")],e),e};let j=class extends jl(Yr(pe)){constructor(i){super(i),this.type="dimension-view-3d",this.tool=null,this.computations=new et,this.selectedDimension=null,this._dimensionsToComputations=new Map,this._placementTask=null,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=i=>{if(i==null)return null;const{spatialReference:e,elevationProvider:t}=this.view,n=Xr(i,e,t);return n==null&&Qr(this.analysis,i.spatialReference,An.getLogger(this.declaredClass)),n},this.addHandles([ca(this,W),dn(()=>this.analysis.dimensions,"after-add",i=>this._onDimensionAdd(i.item),{onListenerAdd:i=>{for(const e of i)this._onDimensionAdd(e)},onListenerRemove:()=>{this._onDimensionsClear()}}),dn(()=>this.analysis.dimensions,"after-remove",i=>this._onDimensionRemove(i.item))]),this._analysisVisualization=new ge({analysisViewData:this,view:this.view}),this._analysisController=new be({analysisViewData:this,view:this.view})}destroy(){this._placementTask=mt(this._placementTask),this._analysisVisualization=ht(this._analysisVisualization),ua(this)}get updating(){var i;return((i=this._analysisVisualization)==null?void 0:i.loadingMessages)??!1}get results(){return this.analysis.dimensions.map(i=>this._dimensionsToComputations.get(i).result)}get selectedComputation(){const{selectedDimension:i}=this;return i==null?null:this._dimensionsToComputations.get(i)}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}async createLengthDimensions(i){return this.selectedDimension=null,this._placementTask=mt(this._placementTask),this._placementTask=ha(this,i),this._placementTask.promise}_onDimensionAdd(i){const{computations:e,_dimensionsToComputations:t}=this;if(t.has(i))return;const n=new B({dimension:i,projectAndAlignPoint:this._projectAndAlignPoint});e.add(n),t.set(i,n)}_onDimensionRemove(i){const{computations:e,_dimensionsToComputations:t}=this,n=e.findIndex(r=>r.dimension===i),s=e.getItemAt(n);s.dimension===this.selectedDimension&&(this.selectedDimension=null),e.removeAt(n),t.delete(i),ht(s)}_onDimensionsClear(){this.computations.drain(i=>i.destroy()),this._dimensionsToComputations.clear()}};u([p({readOnly:!0})],j.prototype,"type",void 0),u([p()],j.prototype,"tool",void 0),u([p()],j.prototype,"updating",null),u([p({readOnly:!0})],j.prototype,"results",null),u([p({readOnly:!0})],j.prototype,"computations",void 0),u([p()],j.prototype,"selectedDimension",void 0),u([p()],j.prototype,"selectedComputation",null),u([p()],j.prototype,"_analysisVisualization",void 0),u([p()],j.prototype,"_analysisController",void 0),u([p()],j.prototype,"_dimensionsToComputations",void 0),u([p()],j.prototype,"_placementTask",void 0),j=u([I("esri.views.3d.analysis.DimensionAnalysisView3D")],j);const ql=j,cc=Object.freeze(Object.defineProperty({__proto__:null,default:ql},Symbol.toStringTag,{value:"Module"}));export{cc as D,wd as E,Ro as a,Sd as b,Qo as g,vd as l,Bi as n,rl as r,sl as s,Ni as u};
