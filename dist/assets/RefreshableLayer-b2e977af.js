import{h as p,e as o,y as h,n as u}from"./cast-daef7652.js";import{s as c}from"./Error-bd05b442.js";import{x as d,g}from"./promiseUtils-29120e0a.js";import"./typedArrayUtil-2bcf3cee.js";import"./ensureType-fa162cfc.js";import{j as v}from"./Collection-e2259e32.js";import"./string-3d0ebcd3.js";const a=new v,n=new WeakMap;function y(e){l(e)&&a.push(e)}function I(e){l(e)&&a.includes(e)&&a.remove(e)}function l(e){return e!=null&&typeof e=="object"&&"refreshInterval"in e&&"refresh"in e}function m(e,r){return Number.isFinite(e)&&Number.isFinite(r)?r<=0?e:m(r,e%r):0}let f=0,i=0;function b(){const e=Date.now();for(const r of a)r.refreshInterval&&e-(n.get(r)??0)+5>=6e4*r.refreshInterval&&(n.set(r,e),r.refresh(e))}p(()=>{const e=Date.now();let r=0;for(const t of a)r=m(Math.round(6e4*t.refreshInterval),r),t.refreshInterval?n.get(t)||n.set(t,e):n.delete(t);if(r!==i){if(i=r,clearInterval(f),i===0)return void(f=0);f=setInterval(b,i)}});const _=e=>{let r=class extends e{constructor(...t){super(...t),this.refreshInterval=0,this.refreshTimestamp=0,this._debounceHasDataChanged=d(()=>this.hasDataChanged()),this.when().then(()=>{y(this)},()=>{})}destroy(){I(this)}get refreshParameters(){return{_ts:this.refreshTimestamp||null}}refresh(t=Date.now()){g(this._debounceHasDataChanged()).then(s=>{s&&this._set("refreshTimestamp",t),this.emit("refresh",{dataChanged:s})},s=>{c.getLogger(this.declaredClass).error(s),this.emit("refresh",{dataChanged:!1,error:s})})}async hasDataChanged(){return!0}};return o([h({type:Number,cast:t=>t>=.1?t:t<=0?0:.1,json:{write:!0}})],r.prototype,"refreshInterval",void 0),o([h({readOnly:!0})],r.prototype,"refreshTimestamp",void 0),o([h()],r.prototype,"refreshParameters",null),r=o([u("esri.layers.mixins.RefreshableLayer")],r),r};export{_ as p};
