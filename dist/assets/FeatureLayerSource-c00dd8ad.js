import{cw as N,ab as I,ac as q,i6 as U,ao as Q,m as v,L as m,aj as j,i7 as M,ap as $,aR as D,gM as L,eH as P,_ as G,s as _,aL as V,i8 as z,i9 as H,J,aF as X,ai as Y,aQ as Z,ad as K,ed as B,ia as W}from"./index-33447e96.js";import{i as ee}from"./External-ca569a47.js";import{o as te}from"./clientSideDefaults-7078ae2c.js";import{x as se}from"./QueryTask-e99d3da3.js";import"./infoFor3D-1eaade9a.js";import"./QueryEngineCapabilities-42e44ded.js";import"./executeForIds-dae93528.js";const ae=new N({originalAndCurrentFeatures:"original-and-current-features",none:"none"}),re=new Set(["Feature Layer","Table"]),ie=new N({Started:"published",Publishing:"publishing",Stopped:"unavailable"});let b=class extends U{constructor(){super(...arguments),this.type="feature-layer",this.refresh=Q(async()=>{var a,r;await this.load();const t=(a=this.sourceJSON.editingInfo)==null?void 0:a.lastEditDate;if(t==null)return{dataChanged:!0,updates:{}};try{await this._fetchService(null)}catch{return{dataChanged:!0,updates:{}}}const e=t!==((r=this.sourceJSON.editingInfo)==null?void 0:r.lastEditDate);return{dataChanged:e,updates:e?{editingInfo:this.sourceJSON.editingInfo,extent:this.sourceJSON.extent}:null}}),this._ongoingAssetUploads=new Map}load(t){const e=t!=null?t.signal:null,a=this.layer.sourceJSON;return this.addResolvingPromise(this._fetchService(a,e)),Promise.resolve(this)}get queryTask(){var d;const{capabilities:t,parsedUrl:e,dynamicDataSource:a,infoFor3D:r,gdbVersion:s,spatialReference:l,fieldsIndex:i}=this.layer,o=v("featurelayer-pbf")&&(t==null?void 0:t.query.supportsFormatPBF)&&r==null,u=((d=t==null?void 0:t.operations)==null?void 0:d.supportsQueryAttachments)??!1;return new se({url:e.path,pbfSupported:o,fieldsIndex:i,infoFor3D:r,dynamicDataSource:a,gdbVersion:s,sourceSpatialReference:l,queryAttachmentsSupported:u})}async addAttachment(t,e){await this.load();const a=t.attributes[this.layer.objectIdField],r=this.layer.parsedUrl.path+"/"+a+"/addAttachment",s=this._getLayerRequestOptions(),l=this._getFormDataForAttachment(e,s.query);try{const i=await m(r,{body:l});return this._createFeatureEditResult(i.data.addAttachmentResult)}catch(i){throw this._createAttachmentErrorResult(a,i)}}async updateAttachment(t,e,a){await this.load();const r=t.attributes[this.layer.objectIdField],s=this.layer.parsedUrl.path+"/"+r+"/updateAttachment",l=this._getLayerRequestOptions({query:{attachmentId:e}}),i=this._getFormDataForAttachment(a,l.query);try{const o=await m(s,{body:i});return this._createFeatureEditResult(o.data.updateAttachmentResult)}catch(o){throw this._createAttachmentErrorResult(r,o)}}async applyEdits(t,e){var E,w,O,S,A,T,x;await this.load();const a=this.layer.infoFor3D,r=a!=null,s=r||((e==null?void 0:e.globalIdUsed)??!1),l=((E=t.addFeatures)==null?void 0:E.map(p=>this._serializeFeature(p,a)).filter(j))??[],i=((w=t.updateFeatures)==null?void 0:w.map(p=>this._serializeFeature(p,a)).filter(j))??[],o=this._getFeatureIds(t.deleteFeatures,s),u=r&&this.layer.capabilities.editing.supportsAsyncApplyEdits;M(l,i,this.layer.spatialReference);const d=[],h=[],R=[...t.deleteAttachments??[]];for(const p of t.addAttachments??[])d.push(await this._serializeAttachment(p));for(const p of t.updateAttachments??[])h.push(await this._serializeAttachment(p));const g=d.length||h.length||R.length?{adds:d,updates:h,deletes:R}:null;let y;if(r&&((O=t.addAssetFeatures)!=null&&O.length)){const{addAssetFeatures:p}=t,C=p.map(k=>k.geometry);await this.uploadAssets(C),y={adds:this._createAssetMapEdits(p),updates:[],deletes:[]}}const n={gdbVersion:(e==null?void 0:e.gdbVersion)||this.layer.gdbVersion,rollbackOnFailure:e==null?void 0:e.rollbackOnFailureEnabled,useGlobalIds:s,returnEditMoment:e==null?void 0:e.returnEditMoment,usePreviousEditMoment:e==null?void 0:e.usePreviousEditMoment,sessionId:e==null?void 0:e.sessionId,async:u};e!=null&&e.returnServiceEditsOption?(n.edits=JSON.stringify([{id:this.layer.layerId,adds:l,updates:i,deletes:o,attachments:g,assetMaps:y}]),n.returnServiceEditsOption=ae.toJSON(e==null?void 0:e.returnServiceEditsOption),n.returnServiceEditsInSourceSR=e==null?void 0:e.returnServiceEditsInSourceSR):(n.adds=l.length?JSON.stringify(l):null,n.updates=i.length?JSON.stringify(i):null,n.deletes=o.length?s?JSON.stringify(o):o.join(","):null,n.attachments=g&&JSON.stringify(g),n.assetMaps=y!=null?JSON.stringify(y):void 0);const c=this._getLayerRequestOptions({method:"post",query:n}),f=e!=null&&e.returnServiceEditsOption?this.layer.url:this.layer.parsedUrl.path,F=u?await this._asyncApplyEdits(f+"/applyEdits",c):await m(f+"/applyEdits",c);if(!((S=this.layer.capabilities.operations)!=null&&S.supportsEditing)&&((T=(A=this.layer.effectiveCapabilities)==null?void 0:A.operations)!=null&&T.supportsEditing)){const p=(x=B)==null?void 0:x.findCredential(this.layer.url);await(p==null?void 0:p.refreshToken())}return this._createEditsResult(F)}async deleteAttachments(t,e){await this.load();const a=t.attributes[this.layer.objectIdField],r=this.layer.parsedUrl.path+"/"+a+"/deleteAttachments";try{return(await m(r,this._getLayerRequestOptions({query:{attachmentIds:e.join(",")},method:"post"}))).data.deleteAttachmentResults.map(this._createFeatureEditResult)}catch(s){throw this._createAttachmentErrorResult(a,s)}}fetchRecomputedExtents(t={}){const e=t.signal;return this.load({signal:e}).then(async()=>{const a=this._getLayerRequestOptions({...t,query:{returnUpdates:!0}}),{layerId:r,url:s}=this.layer,{data:l}=await m(`${s}/${r}`,a),{id:i,extent:o,fullExtent:u,timeExtent:d}=l,h=o||u;return{id:i,fullExtent:h&&$.fromJSON(h),timeExtent:d&&D.fromJSON({start:d[0],end:d[1]})}})}async queryAttachments(t,e={}){await this.load();const a=this._getLayerRequestOptions(e);return this.queryTask.executeAttachmentQuery(t,a)}async queryFeatures(t,e){return await this.load(),this.queryTask.execute(t,{...e,query:this._createRequestQueryOptions(e)})}async queryFeaturesJSON(t,e){return await this.load(),this.queryTask.executeJSON(t,{...e,query:this._createRequestQueryOptions(e)})}async queryObjectIds(t,e){return await this.load(),this.queryTask.executeForIds(t,{...e,query:this._createRequestQueryOptions(e)})}async queryFeatureCount(t,e){return await this.load(),this.queryTask.executeForCount(t,{...e,query:this._createRequestQueryOptions(e)})}async queryExtent(t,e){return await this.load(),this.queryTask.executeForExtent(t,{...e,query:this._createRequestQueryOptions(e)})}async queryRelatedFeatures(t,e){return await this.load(),this.queryTask.executeRelationshipQuery(t,{...e,query:this._createRequestQueryOptions(e)})}async queryRelatedFeaturesCount(t,e){return await this.load(),this.queryTask.executeRelationshipQueryForCount(t,{...e,query:this._createRequestQueryOptions(e)})}async queryTopFeatures(t,e){return await this.load(),this.queryTask.executeTopFeaturesQuery(t,{...e,query:this._createRequestQueryOptions(e)})}async queryTopObjectIds(t,e){return await this.load(),this.queryTask.executeForTopIds(t,{...e,query:this._createRequestQueryOptions(e)})}async queryTopExtents(t,e){return await this.load(),this.queryTask.executeForTopExtents(t,{...e,query:this._createRequestQueryOptions(e)})}async queryTopCount(t,e){return await this.load(),this.queryTask.executeForTopCount(t,{...e,query:this._createRequestQueryOptions(e)})}async fetchPublishingStatus(){if(!L(this.layer.url))return"unavailable";const t=P(this.layer.url,"status"),e=await m(t,{query:{f:"json"}});return ie.fromJSON(e.data.status)}async uploadAssets(t,e){const{uploadAssets:a}=await G(()=>import("./uploadAssets-db29e9c4.js"),["assets/uploadAssets-db29e9c4.js","assets/index-33447e96.js","assets/index-d832a396.css","assets/External-ca569a47.js","assets/infoFor3D-1eaade9a.js"]);return a(t,{layer:this.layer,ongoingUploads:this._ongoingAssetUploads},e)}async _asyncApplyEdits(t,e){const a=(await m(t,e)).data.statusUrl;for(;;){const r=(await m(a,{query:{f:"json"},responseType:"json"})).data;switch(r.status){case"Completed":return m(r.resultUrl,{query:{f:"json"},responseType:"json"});case"CompletedWithErrors":throw new _("async-applyEdits-failed","asynchronous applyEdits call failed.");case"Failed ImportChanges":case"InProgress":case"Pending":case"ExportAttachments":case"ExportChanges":case"ExportingData":case"ExportingSnapshot":case"ImportAttachments":case"ProvisioningReplica":case"UnRegisteringReplica":break;default:throw new _("async-applyEdits-failed","asynchronous applyEdits call failed (undefined response status)")}await V(ne)}}_createRequestQueryOptions(t){const e={...this.layer.customParameters,token:this.layer.apiKey,...t==null?void 0:t.query};return this.layer.datesInUnknownTimezone&&(e.timeReferenceUnknownClient=!0),e}async _fetchService(t,e){if(!t){const{data:r}=await m(this.layer.parsedUrl.path,this._getLayerRequestOptions({query:v("featurelayer-advanced-symbols")?{returnAdvancedSymbols:!0}:{},signal:e}));t=r}this.sourceJSON=this._patchServiceJSON(t);const a=t.type;if(!re.has(a))throw new _("feature-layer-source:unsupported-type",`Source type "${a}" is not supported`)}_patchServiceJSON(t){var e;if(t.type!=="Table"&&t.geometryType&&!((e=t==null?void 0:t.drawingInfo)!=null&&e.renderer)&&!t.defaultSymbol){const a=te(t.geometryType).renderer;z("drawingInfo.renderer",a,t)}return t.geometryType==="esriGeometryMultiPatch"&&t.infoFor3D&&(t.geometryType="mesh"),t}_serializeFeature(t,e){const{geometry:a,attributes:r}=t;if(e!=null&&t.geometry!=null&&t.geometry.type==="mesh"){const s={...r},l=t.geometry,i=l.origin,o=l.transform;if(s[e.transformFieldRoles.originX]=i.x,s[e.transformFieldRoles.originY]=i.y,s[e.transformFieldRoles.originZ]=i.z,o!=null){const u=o.translation,d=o.scale,h=o.rotation;s[e.transformFieldRoles.translationX]=u[0],s[e.transformFieldRoles.translationY]=-u[2],s[e.transformFieldRoles.translationZ]=u[1],s[e.transformFieldRoles.scaleX]=d[0],s[e.transformFieldRoles.scaleY]=d[1],s[e.transformFieldRoles.scaleZ]=d[2],s[e.transformFieldRoles.rotationX]=h[0],s[e.transformFieldRoles.rotationY]=h[2],s[e.transformFieldRoles.rotationZ]=h[1],s[e.transformFieldRoles.rotationDeg]=h[3]}return{geometry:null,attributes:s}}return a==null?{attributes:r}:a.type==="mesh"||a.type==="extent"?null:{geometry:a.toJSON(),attributes:r}}async _serializeAttachment(t){const{feature:e,attachment:a}=t,{globalId:r,name:s,contentType:l,data:i,uploadId:o}=a,u={globalId:r,parentGlobalId:null,contentType:null,name:null,uploadId:null,data:null};if(e&&(u.parentGlobalId="attributes"in e?e.attributes&&e.attributes[this.layer.globalIdField]:e.globalId),o)u.uploadId=o;else if(i){const d=await H(i);d&&(u.contentType=d.mediaType,u.data=d.data),i instanceof File&&(u.name=i.name)}return s&&(u.name=s),l&&(u.contentType=l),u}_createAssetMapEdits(t){var l;const e=new Array,a=this.layer.globalIdField,r=this.layer.parsedUrl,s=(i,o,u)=>{const d=`{${W()}}`;e.push({globalId:d,parentGlobalId:o,assetName:i.assetName,assetHash:i.assetHash,flags:u})};for(const i of t){const o=i.geometry,{externalSources:u}=o.metadata,d=u.items.filter(n=>ee(n,r)),h=i.getAttribute(a),R=(l=i.geometry.transform)==null?void 0:l.geographic,g=R?["PROJECT_VERTICES"]:[],y=n=>s(n,h,g);for(const n of d){const{source:c}=n;Array.isArray(c)?c.map(y):y(c)}}return e}_getFeatureIds(t,e){const a=t==null?void 0:t[0];return a?this._canUseGlobalIds(e,t)?this._getGlobalIdsFromFeatureIdentifier(t):"objectId"in a?this._getObjectIdsFromFeatureIdentifier(t):this._getIdsFromFeatures(t):[]}_getIdsFromFeatures(t){const e=this.layer.objectIdField;return t.map(a=>a.attributes&&a.attributes[e])}_canUseGlobalIds(t,e){return t&&"globalId"in e[0]}_getObjectIdsFromFeatureIdentifier(t){return t.map(e=>e.objectId)}_getGlobalIdsFromFeatureIdentifier(t){return t.map(e=>e.globalId)}_createEditsResult(t){var u,d,h,R,g,y;const e=t.data,{layerId:a}=this.layer,r=[];let s=null;if(Array.isArray(e))for(const n of e)r.push({id:n.id,editedFeatures:n.editedFeatures}),n.id===a&&(s={addResults:n.addResults??[],updateResults:n.updateResults??[],deleteResults:n.deleteResults??[],attachments:n.attachments,editMoment:n.editMoment});else s=e;const l=s==null?void 0:s.assetMaps;if(l){for(const n of l.addResults)n.success||J.getLogger(this.declaredClass).error(`Failed to map asset to feature with globalId ${n.globalId}.`);for(const n of l.updateResults)n.success||J.getLogger(this.declaredClass).error(`Failed to map asset to feature with globalId ${n.globalId}.`)}const i=s==null?void 0:s.attachments,o={addFeatureResults:((u=s==null?void 0:s.addResults)==null?void 0:u.map(this._createFeatureEditResult,this))??[],updateFeatureResults:((d=s==null?void 0:s.updateResults)==null?void 0:d.map(this._createFeatureEditResult,this))??[],deleteFeatureResults:((h=s==null?void 0:s.deleteResults)==null?void 0:h.map(this._createFeatureEditResult,this))??[],addAttachmentResults:i&&i.addResults?i.addResults.map(this._createFeatureEditResult,this):[],updateAttachmentResults:i&&i.updateResults?i.updateResults.map(this._createFeatureEditResult,this):[],deleteAttachmentResults:i&&i.deleteResults?i.deleteResults.map(this._createFeatureEditResult,this):[]};if(s!=null&&s.editMoment&&(o.editMoment=s.editMoment),r.length>0){o.editedFeatureResults=[];for(const n of r){const{editedFeatures:c}=n,f=c!=null&&c.spatialReference?new X(c.spatialReference):null;o.editedFeatureResults.push({layerId:n.id,editedFeatures:{adds:((R=c==null?void 0:c.adds)==null?void 0:R.map(F=>this._createEditedFeature(F,f)))||[],updates:((g=c==null?void 0:c.updates)==null?void 0:g.map(F=>({original:this._createEditedFeature(F[0],f),current:this._createEditedFeature(F[1],f)})))||[],deletes:((y=c==null?void 0:c.deletes)==null?void 0:y.map(F=>this._createEditedFeature(F,f)))||[],spatialReference:f}})}}return o}_createEditedFeature(t,e){return new Y({attributes:t.attributes,geometry:Z({...t.geometry,spatialReference:e})})}_createFeatureEditResult(t){const e=t.success===!0?null:t.error||{code:void 0,description:void 0};return{objectId:t.objectId,globalId:t.globalId,error:e?new _("feature-layer-source:edit-failure",e.description,{code:e.code}):null}}_createAttachmentErrorResult(t,e){const a=e.details.messages&&e.details.messages[0]||e.message,r=e.details.httpStatus||e.details.messageCode;return{objectId:t,globalId:null,error:new _("feature-layer-source:attachment-failure",a,{code:r})}}_getFormDataForAttachment(t,e){const a=t instanceof FormData?t:t&&t.elements?new FormData(t):null;if(a)for(const r in e){const s=e[r];s!=null&&(a.set?a.set(r,s):a.append(r,s))}return a}_getLayerRequestOptions(t={}){const{parsedUrl:e,gdbVersion:a,dynamicDataSource:r}=this.layer;return{...t,query:{gdbVersion:a,layer:r?JSON.stringify({source:r}):void 0,...e.query,f:"json",...this._createRequestQueryOptions(t)},responseType:"json"}}};I([q()],b.prototype,"type",void 0),I([q({constructOnly:!0})],b.prototype,"layer",void 0),I([q({readOnly:!0})],b.prototype,"queryTask",null),b=I([K("esri.layers.graphics.sources.FeatureLayerSource")],b);const ne=1e3,ye=b;export{ye as default};
