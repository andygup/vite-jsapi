import{e6 as D,cZ as Mt,aK as F,W,C as G,w as S,$,v as Rt,a7 as N,a9 as Pt,T as bt,iS as T,iT as k,iU as it,iV as St,iW as Et,aL as Nt,iX as ot}from"./index-df1c7459.js";var Z;function mt(t,e,i){return!Pt(t,e,i)}function z(t,e,i){const r=mt(t,e,i);if(r&&!D())throw new bt("rasterprojectionhelper-project","projection engine is not loaded");return r}(function(t){t[t.None=0]="None",t[t.North=1]="North",t[t.South=2]="South",t[t.Both=3]="Both"})(Z||(Z={}));const st=(t,e,i,r=0)=>{if(i[0]===1)return[0,0];let s=1,n=-1,o=1,u=-1;for(let f=0;f<t.length;f+=2)isNaN(t[f])||(s=s>t[f]?t[f]:s,n=n>t[f]?n:t[f],o=o>t[f+1]?t[f+1]:o,u=u>t[f+1]?u:t[f+1]);const{cols:c,rows:l}=e,a=(n-s)/c/i[0],d=(u-o)/l/i[1],x=2*r;let m=0,h=!1,g=[0,0];for(let f=0;f<c-3;f++){for(let M=0;M<l-3;M++){const y=f*l*2+2*M,p=(t[y]+t[y+4]+t[y+4*l]+t[y+4*l+4])/4,w=(t[y+1]+t[y+5]+t[y+4*l+1]+t[y+4*l+5])/4,R=Math.abs((p-t[y+2*l+2])/a),P=Math.abs((w-t[y+2*l+3])/d);if(R+P>m&&(m=R+P,g=[R,P]),x&&m>x){h=!0;break}}if(h)break}return g},Gt={3395:20037508342789244e-9,3410:17334193943686873e-9,3857:20037508342788905e-9,3975:17367530445161372e-9,4087:20037508342789244e-9,4088:20015108787169147e-9,6933:17367530445161372e-9,32662:20037508342789244e-9,53001:2001508679602057e-8,53002:1000754339801029e-8,53003:2001508679602057e-8,53004:2001508679602057e-8,53016:14152803599503474e-9,53017:17333573624304302e-9,53034:2001508679602057e-8,53079:20015114352186374e-9,53080:20015114352186374e-9,54001:20037508342789244e-9,54002:10018754171394624e-9,54003:20037508342789244e-9,54004:20037508342789244e-9,54016:14168658027268292e-9,54017:1736753044516137e-8,54034:20037508342789244e-9,54079:20037508342789244e-9,54080:20037508342789244e-9,54100:20037508342789244e-9,54101:20037508342789244e-9},B=32,I=4,X=I,K=new Map,U=new Map,j=500;async function $t(){D()||await Mt()}function At(t,e,i){return z(t.spatialReference,e)?i?ot(e,t.spatialReference,t):ot(t.spatialReference,e,t):null}function Bt(t,e,i,r=null){const s=t.spatialReference;if(s.equals(e))return t;z(s,e,r);const n=i.center,o=new F({xmin:n.x-t.x/2,xmax:n.x+t.x/2,ymin:n.y-t.y/2,ymax:n.y+t.y/2,spatialReference:s}),u=W(o,e,r),c=v(e);let l;if(G(u)||S(c)&&u.width>=c){const a=$(s)/$(e);l={x:t.x*a,y:t.y*a}}else l={x:u.width,y:u.height};return l}function E(t,e=.01){return $(t)?e/$(t):0}function rt(t,e,i=null,r=!0){const s=t.spatialReference;if(s.equals(e))return t;z(s,e,i);const n=W(t,e,i);return r&&n&&ht([t],[n],s,e),n}function ht(t,e,i,r){const s=Y(i,!0),n=Y(r,!0),o=E(i,j),u=E(r,j);if(o&&S(s)&&S(n))for(let c=0;c<t.length;c++){const l=e[c];if(!l)continue;const{x:a}=t[c],{x:d}=l;d>=n[1]-u&&Math.abs(a-s[0])<o?l.x-=n[1]-n[0]:d<=n[0]+u&&Math.abs(a-s[1])<o&&(l.x+=n[1]-n[0])}}function kt(t){const{inSR:e,outSR:i,datumTransformation:r,preferPE:s}=t;if(e.equals(i)){const{points:n}=H(t,null);return n}if(e.isWebMercator&&i.isWGS84||e.isWGS84&&i.isWebMercator)return vt(t);if(z(e,i,r)&&s){if(e.isGeographic)return at(t);const n=O(e);if(S(n))return at(t)}return Tt(t)}function Tt(t){const{points:e}=H(t,null),{inSR:i,outSR:r,datumTransformation:s}=t,n=e.map(u=>new N(u[0],u[1],i)),o=W(n,r,s);return s&&ht(n,o,i,r),o.map(u=>u?[u.x,u.y]:[NaN,NaN])}function at(t){const{inSR:e,outSR:i,datumTransformation:r}=t,s=O(e),{points:n,mask:o}=H(t,s);if(!e.isGeographic){const c=e.wkid?T.coordsys(e.wkid):T.fromString(e.isGeographic?k.PE_TYPE_GEOGCS:k.PE_TYPE_PROJCS,e.wkt);it.projToGeog(c,n.length,n)}if(S(r)&&r.steps.length){let c;if(i.isGeographic&&(c=n.map(([a])=>a>179.9955?1:a<-179.9955?-1:0)),r.steps.forEach(a=>{const d=a.wkid?T.geogtran(a.wkid):T.fromString(k.PE_TYPE_GEOGTRAN,a.wkt);St.geogToGeog(d,n.length,n,null,a.isInverse?k.PE_TRANSFORM_2_TO_1:k.PE_TRANSFORM_1_TO_2)}),c)for(let a=0;a<n.length;a++){const d=c[a],x=n[a][0],m=x>179.9955?1:x<-179.9955?-1:0;d&&m&&d!==m&&(n[a][0]=d>0?x+360:x-360)}}if(!i.isGeographic){const c=O(i,!0),l=S(c)&&c.isEnvelope?[c.bbox[1],c.bbox[3]]:[-90,90];Ct(n,l);const a=i.wkid?T.coordsys(i.wkid):T.fromString(i.isGeographic?k.PE_TYPE_GEOGCS:k.PE_TYPE_PROJCS,i.wkt);it.geogToProj(a,n.length,n)}let u=n;if(o&&n.length!==o.length){u=[];for(let c=0,l=0;c<o.length;c++)o[c]?u.push(n[l++]):u.push([NaN,NaN])}return u}function vt(t){const{cols:e,rows:i,xres:r,yres:s,usePixelCenter:n,inSR:o,outSR:u}=t;let{xmin:c,ymax:l}=t;n&&(c+=r/2,l-=s/2);const a=[],d=[],x=Math.max(e,i);for(let h=0;h<x;h++){const g=c+r*Math.min(e,h),f=l-s*Math.min(i,h),M=W(new N({x:g,y:f,spatialReference:o}),u);h<=e&&a.push(M.x),h<=i&&d.push(M.y)}const m=[];for(let h=0;h<e;h++)for(let g=0;g<i;g++)m.push([a[h],d[g]]);return m}function O(t,e=!1){let i=t.wkid||t.wkt;if(!i||t.isGeographic)return null;if(i=String(i),K.has(i)){const o=K.get(i);return e?o==null?void 0:o.gcs:o==null?void 0:o.pcs}const r=t.wkid?T.coordsys(t.wkid):T.fromString(t.isGeographic?k.PE_TYPE_GEOGCS:k.PE_TYPE_PROJCS,t.wkt),s=lt(r,E(t,1e-4)),n=lt(r,0,!0);return K.set(i,{pcs:s,gcs:n}),e?n:s}function lt(t,e=0,i=!1){const r=Et.generate(t),s=i?t.horizonGcsGenerate():t.horizonPcsGenerate();if(!r||!(s!=null&&s.length))return null;let n=!1,o=s.find(f=>f.getInclusive()===1&&f.getKind()===1);if(!o){if(o=s.find(f=>f.getInclusive()===1&&f.getKind()===0),!o)return null;n=!0}const u=i?0:(r.getNorthPoleLocation()===2?1:0)|(r.getSouthPoleLocation()===2?2:0),c=r.isPannableRectangle(),l=o.getCoord();if(n)return{isEnvelope:n,isPannable:c,vertices:l,coef:null,bbox:[l[0][0]-e,l[0][1]-e,l[1][0]+e,l[1][1]+e],poleLocation:u};let a=0;const d=[];let[x,m]=l[0],[h,g]=l[0];for(let f=0,M=l.length;f<M;f++){a++,a===M&&(a=0);const[y,p]=l[f],[w,R]=l[a];if(R===p)d.push([y,w,p,R,2]);else{const P=(w-y)/(R-p||1e-4),C=y-P*p;p<R?d.push([P,C,p,R,0]):d.push([P,C,R,p,1])}x=x<y?x:y,m=m<p?m:p,h=h>y?h:y,g=g>p?g:p}return{isEnvelope:!1,isPannable:c,vertices:l,coef:d,bbox:[x,m,h,g],poleLocation:u}}function H(t,e){const i=[],{cols:r,rows:s,xres:n,yres:o,usePixelCenter:u}=t;let{xmin:c,ymax:l}=t;if(u&&(c+=n/2,l-=o/2),G(e)){for(let m=0;m<r;m++)for(let h=0;h<s;h++)i.push([c+n*m,l-o*h]);return{points:i}}const a=new Uint8Array(r*s);if(e.isEnvelope){const{bbox:[m,h,g,f]}=e;for(let M=0,y=0;M<r;M++){const p=c+n*M,w=e.isPannable||p>=m&&p<=g;for(let R=0;R<s;R++,y++){const P=l-o*R;w&&P>=h&&P<=f&&(i.push([p,P]),a[y]=1)}}return{points:i,mask:a}}const d=e.coef,x=[];for(let m=0;m<s;m++){const h=l-o*m,g=[],f=[];for(let y=0;y<d.length;y++){const[p,w,R,P,C]=d[y];if(h===R&&R===P)g.push(p),g.push(w),f.push(2),f.push(2);else if(h>=R&&h<=P){const A=p*h+w;g.push(A),f.push(C)}}let M=g;if(g.length>2){let y=f[0]===2?0:f[0],p=g[0];M=[];for(let w=1;w<f.length;w++)f[w]===2&&w!==f.length-1||(f[w]!==y&&(M.push(y===0?Math.min(p,g[w-1]):Math.max(p,g[w-1])),y=f[w],p=g[w]),w===f.length-1&&M.push(f[w]===0?Math.min(p,g[w]):Math.max(p,g[w])));M.sort((w,R)=>w-R)}else g[0]>g[1]&&(M=[g[1],g[0]]);x.push(M)}for(let m=0,h=0;m<r;m++){const g=c+n*m;for(let f=0;f<s;f++,h++){const M=l-o*f,y=x[f];if(y.length===2)g>=y[0]&&g<=y[1]&&(i.push([g,M]),a[h]=1);else if(y.length>2){let p=!1;for(let w=0;w<y.length;w+=2)if(g>=y[w]&&g<=y[w+1]){p=!0;break}p&&(i.push([g,M]),a[h]=1)}}}return{points:i,mask:a}}function Ct(t,e){const[i,r]=e;for(let s=0;s<t.length;s++){const n=t[s][1];(n<i||n>r)&&(t[s]=[NaN,NaN])}}function xt(t){const e=v(t[0].spatialReference);if(t.length<2||G(e))return t[0];let{xmin:i,xmax:r,ymin:s,ymax:n}=t[0];for(let o=1;o<t.length;o++){const u=t[o];r=u.xmax+e*o,s=Math.min(s,u.ymin),n=Math.max(n,u.ymax)}return new F({xmin:i,xmax:r,ymin:s,ymax:n,spatialReference:t[0].spatialReference})}function _t(t,e,i=null,r=!0){const s=t.spatialReference;if(s.equals(e))return t;const n=Wt(t),o=v(s,!0),u=v(e);if(n===0||G(o)||G(u)){const l=ct(t,e,i,r);if(G(o)&&S(u)&&Math.abs(l.width-u)<E(e)&&D()){const a=O(s);if(S(a)&&a.poleLocation===Z.None&&t.width<(a.bbox[2]-a.bbox[0])/2)return Ot(t,e)||l}return l}const c=t.clone().normalize();if(c.length===1&&t.xmax<o&&t.xmax-o/2>E(s)){const{xmin:l,xmax:a}=t;for(let d=0;d<=n;d++){const x=d===0?l:-o/2,m=d===n?a-o*d:o/2;c[d]=new F({xmin:x,xmax:m,ymin:t.ymin,ymax:t.ymax,spatialReference:s})}}return xt(c.map(l=>ct(l,e,i,r)).filter(S))}function Ot(t,e){const i=v(e);if(G(i))return null;let{xmin:r,ymin:s,xmax:n,ymax:o}=t;const u=t.spatialReference,c=new Rt({spatialReference:u,rings:[[[r,s],[n,s],[n,o],[r,o],[r,s]]]}),l=W(c,e);if(l.rings.length!==2||!l.rings[0].length||!l.rings[1].length)return null;const{rings:a}=l,d=E(u),x=new F({spatialReference:e});for(let m=0;m<2;m++){r=n=a[m][0][0],s=o=a[m][0][1];for(let h=0;h<a[m].length;h++)r=r>a[m][h][0]?a[m][h][0]:r,n=n<a[m][h][0]?a[m][h][0]:n,s=s>a[m][h][1]?a[m][h][1]:s,o=o<a[m][h][1]?a[m][h][1]:o;if(m===0)x.ymin=s,x.ymax=o,x.xmin=r,x.xmax=n;else if(x.ymin=Math.min(x.ymin,s),x.ymax=Math.max(x.ymax,o),Math.abs(n-i/2)<d)x.xmin=r,x.xmax=x.xmax+i;else{if(!(Math.abs(r+i/2)<d))return null;x.xmax=n+i}}return x}function ct(t,e,i=null,r=!0,s=!0){const n=t.spatialReference;if(n.equals(e)||!e)return t;z(n,e,i);const o=W(t,e,i);if(s&&e.isWebMercator&&o&&(o.ymax=Math.min(20037508342787e-6,o.ymax),o.ymin=Math.max(-20037508342787e-6,o.ymin),o.ymin>=o.ymax))return null;if(!r||!o)return o;const u=Y(n,!0),c=Y(e,!0);if(G(u)||G(c))return o;const l=E(n,.001),a=E(n,j),d=E(e,.001);if(Math.abs(o.xmin-c[0])<d&&Math.abs(o.xmax-c[1])<d){const x=Math.abs(t.xmin-u[0]),m=Math.abs(u[1]-t.xmax);if(x<l&&m>a){o.xmin=c[0];const h=[];h.push(new N(t.xmax,t.ymin,n)),h.push(new N(t.xmax,(t.ymin+t.ymax)/2,n)),h.push(new N(t.xmax,t.ymax,n));const g=h.map(f=>rt(f,e,i)).filter(f=>!isNaN(f==null?void 0:f.x)).map(f=>f.x);o.xmax=Math.max.apply(null,g)}if(m<l&&x>a){o.xmax=c[1];const h=[];h.push(new N(t.xmin,t.ymin,n)),h.push(new N(t.xmin,(t.ymin+t.ymax)/2,n)),h.push(new N(t.xmin,t.ymax,n));const g=h.map(f=>rt(f,e,i)).filter(f=>!isNaN(f==null?void 0:f.x)).map(f=>f.x);o.xmin=Math.min.apply(null,g)}}else{const x=E(e,.001);Math.abs(o.xmin-c[0])<x&&(o.xmin=c[0]),Math.abs(o.xmax-c[1])<x&&(o.xmax=c[1])}return o}function v(t,e=!1){if(!t)return null;const i=e?20037508342787e-6:20037508342788905e-9;return t.isWebMercator?2*i:t.wkid&&t.isGeographic?360:2*Gt[t.wkid]||null}function Y(t,e=!1){if(t.isGeographic)return[-180,180];const i=v(t,e);return S(i)?[-i/2,i/2]:null}function ft(t,e,i,r){let s=(t-e)/i;return s-Math.floor(s)!=0?s=Math.floor(s):r&&(s-=1),s}function Wt(t,e=!1){const i=v(t.spatialReference);if(G(i))return 0;const r=e?0:-(i/2),s=E(t.spatialReference),n=!e&&Math.abs(t.xmax-i/2)<s?i/2:t.xmax,o=!e&&Math.abs(t.xmin+i/2)<s?-i/2:t.xmin;return ft(n,r,i,!0)-ft(o,r,i,!1)}function It(t){const e=t.storageInfo.origin.x,i=v(t.spatialReference,!0);if(G(i))return{originX:e,halfWorldWidth:null,pyramidsInfo:null};const r=i/2,{nativePixelSize:s,storageInfo:n,extent:o}=t,{maximumPyramidLevel:u,blockWidth:c,pyramidScalingFactor:l}=n;let a=s.x;const d=[],x=S(t.transform)&&t.transform.type==="gcs-shift",m=e+(x?0:r),h=x?i-e:r-e;for(let g=0;g<=u;g++){const f=(o.xmax-e)/a/c,M=f-Math.floor(f)==0?f:Math.ceil(f),y=h/a/c,p=y-Math.floor(y)==0?y:Math.ceil(y),w=Math.floor(m/a/c),R=Math.round(m/a)%c,P=(c-Math.round(h/a)%c)%c;d.push({resolutionX:a,blockWidth:c,datsetColumnCount:M,worldColumnCountFromOrigin:p,leftMargin:R,rightPadding:P,originColumnOffset:w}),a*=l}return{originX:e,halfWorldWidth:r,pyramidsInfo:d,hasGCSSShiftTransform:x}}function zt(t){if(!t||t.isGeographic)return t;const e=String(t.wkid||t.wkt);let i;return U.has(e)?i=U.get(e):(i=(t.wkid?T.coordsys(t.wkid):T.fromString(k.PE_TYPE_PROJCS,t.wkt)).getGeogcs().getCode(),U.set(e,i)),new Nt({wkid:i})}function jt(t){const e=t.isAdaptive&&t.spacing==null;let i=t.spacing||[B,B],r=V(t),s={cols:r.size[0]+1,rows:r.size[1]+1};const n=r.outofBoundPointCount>0&&r.outofBoundPointCount<r.offsets.length/2;let o=r.outofBoundPointCount===r.offsets.length/2||e&&n?[0,0]:st(r.offsets,s,i,X);const u=(o[0]+o[1])/2,c=t.projectedExtent.spatialReference,l=t.srcBufferExtent.spatialReference;if(e&&(n||u>X)&&(mt(c,l,t.datumTransformation)&&(c.isGeographic||S(O(c))),i=[I,I],r=V({...t,spacing:i}),s={cols:r.size[0]+1,rows:r.size[1]+1},o=st(r.offsets,s,i,X)),r.error=o,i[0]>1&&(r.coefficients=ut(r.offsets,s,n)),t.includeGCSGrid&&!c.isGeographic&&!c.isWebMercator)if(l.isGeographic)r.gcsGrid={offsets:r.offsets,coefficients:r.coefficients,spacing:i};else{const a=O(c);if(S(a)&&!a.isEnvelope){const d=zt(c),x=_t(t.projectedExtent,d),{offsets:m}=V({...t,srcBufferExtent:x,spacing:i}),h=ut(m,s,n);r.gcsGrid={offsets:m,coefficients:h,spacing:i}}}return r}function V(t){const{projectedExtent:e,srcBufferExtent:i,pixelSize:r,datumTransformation:s,rasterTransform:n}=t,o=e.spatialReference,u=i.spatialReference,c=z(o,u),{xmin:l,ymin:a,xmax:d,ymax:x}=e,m=v(u),h=S(m)&&(t.hasWrapAround||(n==null?void 0:n.type)==="gcs-shift"),g=t.spacing||[B,B],f=g[0]*r.x,M=g[1]*r.y,y=g[0]===1,p=Math.ceil((d-l)/f-.1/g[0])+(y?0:1),w=Math.ceil((x-a)/M-.1/g[1])+(y?0:1),R=kt({cols:p,rows:w,xmin:l,ymax:x,xres:f,yres:M,inSR:o,outSR:u,datumTransformation:s,preferPE:g[0]<=I,usePixelCenter:y}),P=[];let C,A=0;const Q=y?-1:NaN,{xmin:tt,xmax:q,ymax:pt,width:gt,height:yt}=i,dt=E(u,j),wt=S(m)&&tt>0&&q>m/2;let nt=!1;if(c){const _=O(o);nt=S(_)&&_.poleLocation>0}for(let _=0;_<p;_++){const J=[];for(let L=0;L<w;L++){let b=R[_*w+L];if(h&&b[0]>q&&b[0]>m/2-dt?b[0]-=m:h&&_===0&&b[0]<0&&wt&&!n&&(b[0]+=m),!b||isNaN(b[0])||isNaN(b[1]))P.push(Q),P.push(Q),J.push(null),A++;else{if(n){const et=n.inverseTransform(new N({x:b[0],y:b[1],spatialReference:u}));b=[et.x,et.y]}J.push(b),_>0&&h&&C[L]&&b[0]<C[L][0]&&(b[0]+=m,nt&&b[0]>q&&b[0]>m&&(b[0]-=m)),P.push((b[0]-tt)/gt),P.push((pt-b[1])/yt)}}C=J}return{offsets:P,error:null,coefficients:null,outofBoundPointCount:A,spacing:g,size:y?[p,w]:[p-1,w-1]}}function ut(t,e,i){const{cols:r,rows:s}=e,n=new Float32Array((r-1)*(s-1)*2*6),o=new Float32Array([-0,-1,1,-1,1,-0,1,-0,-0]),u=new Float32Array([-1,1,0,0,-1,1,1,0,0]);for(let c=0;c<r-1;c++){for(let l=0;l<s-1;l++){let a=c*s*2+2*l;const d=t[a],x=t[a+1],m=t[a+2],h=t[a+3];a+=2*s;const g=t[a],f=t[a+1],M=t[a+2],y=t[a+3];let p=0,w=12*(l*(r-1)+c);for(let R=0;R<3;R++)n[w++]=o[p++]*d+o[p++]*m+o[p++]*M;p=0;for(let R=0;R<3;R++)n[w++]=o[p++]*x+o[p++]*h+o[p++]*y;p=0;for(let R=0;R<3;R++)n[w++]=u[p++]*d+u[p++]*g+u[p++]*M;p=0;for(let R=0;R<3;R++)n[w++]=u[p++]*x+u[p++]*f+u[p++]*y}if(i)for(let l=0;l<n.length;l++)isNaN(n[l])&&(n[l]=-1)}return n}function Yt(t){const e=t.clone().normalize();return e.length===1?e[0]:xt(e)}function Ft(t,e,i){const{storageInfo:r,pixelSize:s}=e;let n=0,o=!1;const{pyramidResolutions:u}=r;if(S(u)&&u.length){const x=(t.x+t.y)/2,m=u[u.length-1],h=(m.x+m.y)/2,g=(s.x+s.y)/2;if(x<=g)n=0;else if(x>=h)n=u.length,o=x/h>8;else{let M,y=g;for(let p=1;p<=u.length;p++){if(M=(u[p-1].x+u[p-1].y)/2,x<=M){x===M?n=p:i==="down"?(n=p-1,o=x/y>8):n=i==="up"||x-y>M-x||x/y>2?p:p-1;break}y=M}}const f=n===0?s:u[n-1];return o&&Math.min(f.x,f.y)*$(e.spatialReference)>19567&&(o=!1),{pyramidLevel:n,pyramidResolution:new N({x:f.x,y:f.y,spatialReference:e.spatialReference}),excessiveReading:o}}const c=Math.log(t.x/s.x)/Math.LN2,l=Math.log(t.y/s.y)/Math.LN2,a=e.storageInfo.maximumPyramidLevel||0;n=i==="down"?Math.floor(Math.min(c,l)):i==="up"?Math.ceil(Math.max(c,l)):Math.round((c+l)/2),n<0?n=0:n>a&&(o=n>a+3,n=a);const d=2**n;return{pyramidLevel:n,pyramidResolution:new N({x:d*e.nativePixelSize.x,y:d*e.nativePixelSize.y,spatialReference:e.spatialReference}),excessiveReading:o}}export{jt as $,Bt as C,_t as J,mt as M,Wt as Q,$t as T,v as U,It as V,rt as j,Yt as n,Ft as o,At as v};
