import{bC as $e,d7 as _e,sj as Ie,bz as j,sk as be,sl as Le,sm as he,K as He,gv as z,e as i,b as R,lW as ke,C as p,iD as oe,i as F,y as l,a7 as h,lT as Me,aL as Ee,sn as Ae,T as Y,w as C,d as K,kb as q,so as Ne,aP as X,aQ as le,kI as B,kn as me,v as ce,bK as L,f as Ge,jG as Q,aK as pe,kZ as Be,sp as ze,sq as Fe,gB as Se,U as re,pd as Ke,hO as fe,qk as je,hT as Ce,hS as qe,hP as De,hR as Je,sr as Ye,hV as Qe,hW as Ze,R as ie,aa as Xe,ab as et,ac as tt,l as nt,cv as st,aA as ot,V as rt,cE as it,W as at,Y as lt,ss as ct,r5 as pt,r6 as ut,mL as dt,mN as ht,lU as mt,cP as ft}from"./index-df1c7459.js";import{t as yt}from"./resourceExtension-e15c22c9.js";import{o as gt}from"./BoundsStore-968ad8c4.js";import{u as Pt}from"./MediaElementView-555babcb.js";import"./PooledRBush-47b3e53d.js";import"./quickselect-56c5966e.js";import"./normalizeUtilsSync-7d22b6b0.js";const y=He(),k=z(),te=z(),ye=z();function O(e,t,n){return $e(y,t[0],t[1],1),_e(y,y,Ie(k,n)),y[2]===0?j(e,y[0],y[1]):j(e,y[0]/y[2],y[1]/y[2])}function vt(e,t,n){return ge(te,t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7]),ge(ye,n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7]),be(e,Le(te,te),ye),e[8]!==0&&(e[0]/=e[8],e[1]/=e[8],e[2]/=e[8],e[3]/=e[8],e[4]/=e[8],e[5]/=e[8],e[6]/=e[8],e[7]/=e[8],e[8]/=e[8]),e}function ge(e,t,n,s,o,r,a,c,d){he(e,t,s,r,n,o,a,1,1,1),$e(y,c,d,1),Le(k,e);const[g,P,v]=_e(y,y,Ie(k,k));return he(k,g,0,0,0,P,0,0,0,v),be(e,k,e)}let ae=class extends ke{projectOrWarn(t,n){if(p(t))return t;const{geometry:s,pending:o}=oe(t,n);return o?null:o||s?s:(F.getLogger(this.declaredClass).warn("geometry could not be projected to the spatial reference",{georeference:this,geometry:t,sourceSpatialReference:t.spatialReference,targetSpatialReference:n}),null)}};ae=i([R("esri.layers.support.GeoreferenceBase")],ae);const ee=ae,ne=z(),u=L();let D=class extends Ge{constructor(){super(...arguments),this.sourcePoint=null,this.mapPoint=null}};i([l()],D.prototype,"sourcePoint",void 0),i([l({type:h})],D.prototype,"mapPoint",void 0),D=i([R("esri.layers.support.ControlPoint")],D);let x=class extends Me(ee){constructor(t){super(t),this.controlPoints=null,this.height=0,this.type="control-points",this.width=0}readControlPoints(t,n){const s=Ee.fromJSON(n.spatialReference),o=Ae(...n.coefficients,1);return t.map(r=>(j(u,r.x,r.y),O(u,u,o),{sourcePoint:r,mapPoint:new h({x:u[0],y:u[1],spatialReference:s})}))}writeControlPoints(t,n,s,o){if(p(this.transform)){const r=new Y("web-document-write:invalid-georeference","Invalid 'controlPoints', 'width', 'height' configuration.",{layer:o==null?void 0:o.layer,georeference:this});o!=null&&o.messages?o.messages.push(r):F.getLogger(this.declaredClass).error(r.name,r.message)}else C(t)&&m(t[0])&&(n.controlPoints=t.map(r=>{const a=K(r.sourcePoint);return{x:a.x,y:a.y}}),n.spatialReference=t[0].mapPoint.spatialReference.toJSON(),n.coefficients=this.transform.slice(0,8))}get coords(){if(p(this.controlPoints))return null;const t=this._updateTransform(ne);if(p(t)||!m(this.controlPoints[0]))return null;const n=this.controlPoints[0].mapPoint.spatialReference;return _t(t,this.width,this.height,n)}set coords(t){if(p(this.controlPoints)||!m(this.controlPoints[0]))return;const n=this.controlPoints[0].mapPoint.spatialReference;if(t=this.projectOrWarn(t,n),p(t))return;const{width:s,height:o}=this,{rings:[[r,a,c,d]]}=t,g={sourcePoint:q(0,o),mapPoint:new h({x:r[0],y:r[1],spatialReference:n})},P={sourcePoint:q(0,0),mapPoint:new h({x:a[0],y:a[1],spatialReference:n})},v={sourcePoint:q(s,0),mapPoint:new h({x:c[0],y:c[1],spatialReference:n})},M={sourcePoint:q(s,o),mapPoint:new h({x:d[0],y:d[1],spatialReference:n})};m(g)&&m(P)&&m(v)&&m(M)&&(Pe(ne,g,P,v,M),this.controlPoints=K(this.controlPoints).map(({sourcePoint:W})=>(j(u,W.x,W.y),O(u,u,ne),{sourcePoint:W,mapPoint:new h({x:u[0],y:u[1],spatialReference:n})})))}get inverseTransform(){return p(this.transform)?null:Ne(z(),this.transform)}get transform(){return this._updateTransform()}toMap(t){if(p(t)||p(this.transform)||p(this.controlPoints)||!m(this.controlPoints[0]))return null;j(u,t.x,t.y);const n=this.controlPoints[0].mapPoint.spatialReference;return O(u,u,this.transform),new h({x:u[0],y:u[1],spatialReference:n})}toSource(t){if(p(t)||p(this.inverseTransform)||p(this.controlPoints)||!m(this.controlPoints[0]))return null;const n=this.controlPoints[0].mapPoint.spatialReference;return t=t.normalize(),t=oe(t,n).geometry,p(t)?null:(j(u,t.x,t.y),O(u,u,this.inverseTransform),q(u[0],u[1]))}_updateTransform(t){const{controlPoints:n,width:s,height:o}=this;if(p(n)||!(s>0)||!(o>0))return null;const[r,a,c,d]=n;if(!m(r))return null;const g=r.mapPoint.spatialReference,P=this._projectControlPoint(a,g),v=this._projectControlPoint(c,g),M=this._projectControlPoint(d,g);if(!P.valid||!v.valid||!M.valid||!m(P.controlPoint))return null;p(t)&&(t=z());let W=null;return W=m(v.controlPoint)&&m(M.controlPoint)?Pe(t,r,P.controlPoint,v.controlPoint,M.controlPoint):m(v.controlPoint)?Rt(t,r,P.controlPoint,v.controlPoint):xt(t,r,P.controlPoint),W.every(Ue=>Ue===0)?null:W}_projectControlPoint(t,n){if(!m(t))return{valid:!0,controlPoint:t};const{sourcePoint:s,mapPoint:o}=t,{geometry:r,pending:a}=oe(o,n);return a?{valid:!1,controlPoint:null}:a||r?{valid:!0,controlPoint:{sourcePoint:s,mapPoint:r}}:(F.getLogger(this.declaredClass).warn("map point could not be projected to the spatial reference",{georeference:this,controlPoint:t,sourceSpatialReference:o.spatialReference,targetSpatialReference:n}),{valid:!1,controlPoint:null})}};function m(e){return C(e)&&C(e.sourcePoint)&&C(e.mapPoint)}i([l({type:[D],json:{write:{allowNull:!1,isRequired:!0}}})],x.prototype,"controlPoints",void 0),i([X("controlPoints")],x.prototype,"readControlPoints",null),i([le("controlPoints")],x.prototype,"writeControlPoints",null),i([l()],x.prototype,"coords",null),i([l({json:{write:!0}})],x.prototype,"height",void 0),i([l({readOnly:!0})],x.prototype,"inverseTransform",null),i([l({readOnly:!0})],x.prototype,"transform",null),i([l({json:{write:!0}})],x.prototype,"width",void 0),x=i([R("esri.layers.support.ControlPointsGeoreference")],x);const w=L(),$=L(),U=L(),T=L(),_=L(),I=L(),H=L(),V=L(),Z=Math.PI/2;function b(e,t,n){j(e,n.sourcePoint.x,n.sourcePoint.y),j(t,n.mapPoint.x,n.mapPoint.y)}function xt(e,t,n){return b(w,_,t),b($,I,n),B(U,$,w,Z),B(T,w,$,Z),B(H,I,_,-Z),B(V,_,I,-Z),ue(e,w,$,U,T,_,I,H,V)}function Rt(e,t,n,s){return b(w,_,t),b($,I,n),b(U,H,s),me(T,w,$,.5),B(T,U,T,Math.PI),me(V,_,I,.5),B(V,H,V,Math.PI),ue(e,w,$,U,T,_,I,H,V)}function Pe(e,t,n,s,o){return b(w,_,t),b($,I,n),b(U,H,s),b(T,V,o),ue(e,w,$,U,T,_,I,H,V)}const wt=new Array(8).fill(0),$t=new Array(8).fill(0);function ve(e,t,n,s,o){return e[0]=t[0],e[1]=t[1],e[2]=n[0],e[3]=n[1],e[4]=s[0],e[5]=s[1],e[6]=o[0],e[7]=o[1],e}function ue(e,t,n,s,o,r,a,c,d){return vt(e,ve(wt,t,n,s,o),ve($t,r,a,c,d))}function _t(e,t,n,s){const o=Q(0,n),r=Q(0,0),a=Q(t,0),c=Q(t,n);return O(o,o,e),O(r,r,e),O(a,a,e),O(c,c,e),new ce({rings:[[o,r,a,c,o]],spatialReference:s})}const Oe=x;let E=class extends ee{constructor(t){super(t),this.bottomLeft=null,this.bottomRight=null,this.topLeft=null,this.topRight=null,this.type="corners"}get coords(){let{topLeft:t,topRight:n,bottomLeft:s,bottomRight:o}=this;if(p(t)||p(n)||p(s)||p(o))return null;const r=t.spatialReference;return n=this.projectOrWarn(n,r),s=this.projectOrWarn(s,r),o=this.projectOrWarn(o,r),p(n)||p(s)||p(o)?null:new ce({rings:[[[s.x,s.y],[t.x,t.y],[n.x,n.y],[o.x,o.y],[s.x,s.y]]],spatialReference:r})}set coords(t){const{topLeft:n}=this;if(p(n))return;const s=n.spatialReference;if(t=this.projectOrWarn(t,s),p(t))return;const{rings:[[o,r,a,c]]}=t;this.bottomLeft=new h({x:o[0],y:o[1],spatialReference:s}),this.topLeft=new h({x:r[0],y:r[1],spatialReference:s}),this.topRight=new h({x:a[0],y:a[1],spatialReference:s}),this.bottomRight=new h({x:c[0],y:c[1],spatialReference:s})}};i([l()],E.prototype,"coords",null),i([l({type:h})],E.prototype,"bottomLeft",void 0),i([l({type:h})],E.prototype,"bottomRight",void 0),i([l({type:h})],E.prototype,"topLeft",void 0),i([l({type:h})],E.prototype,"topRight",void 0),E=i([R("esri.layers.support.CornersGeoreference")],E);const It=E;let A=class extends ee{constructor(e){super(e),this.extent=null,this.rotation=0,this.type="extent-and-rotation"}get coords(){if(p(this.extent))return null;const{xmin:e,ymin:t,xmax:n,ymax:s,spatialReference:o}=this.extent;let r;if(this.rotation){const{x:a,y:c}=this.extent.center,d=xe(a,c,this.rotation);r=[d(e,t),d(e,s),d(n,s),d(n,t)],r.push(r[0])}else r=[[e,t],[e,s],[n,s],[n,t],[e,t]];return new ce({rings:[r],spatialReference:o})}set coords(e){if(p(e)||p(this.extent))return;const t=this.extent.spatialReference;if(e=this.projectOrWarn(e,t),p(e)||p(e.extent))return;const{rings:[[n,s,o]],extent:{center:{x:r,y:a}}}=e,c=Be(Math.PI/2-Math.atan2(s[1]-n[1],s[0]-n[0])),d=xe(r,a,-c),[g,P]=d(n[0],n[1]),[v,M]=d(o[0],o[1]);this.extent=new pe({xmin:g,ymin:P,xmax:v,ymax:M,spatialReference:t}),this.rotation=c}};function xe(e,t,n){const s=ze(n),o=Math.cos(s),r=Math.sin(s);return(a,c)=>[o*(a-e)+r*(c-t)+e,o*(c-t)-r*(a-e)+t]}i([l()],A.prototype,"coords",null),i([l({type:pe})],A.prototype,"extent",void 0),i([l({type:Number})],A.prototype,"rotation",void 0),A=i([R("esri.layers.support.ExtentAndRotationGeoreference")],A);const bt=A,Lt={key:"type",base:ee,typeMap:{"control-points":Oe,corners:It,"extent-and-rotation":bt}};let N=class extends Fe(Me(Se)){constructor(){super(...arguments),this.georeference=null,this.opacity=1}readGeoreference(e){return Oe.fromJSON(e)}};i([l({types:Lt,json:{write:!0}})],N.prototype,"georeference",void 0),i([X("georeference")],N.prototype,"readGeoreference",null),i([l()],N.prototype,"opacity",void 0),N=i([R("esri.layers.support.MediaElementBase")],N);const de=N;let S=class extends de{constructor(e){super(e),this.content=null,this.image=null,this.type="image",this.image=null}load(){const e=this.image;if(typeof e=="string"){const t=re(e,{responseType:"image"}).then(({data:n})=>{this._set("content",n)});this.addResolvingPromise(t)}else if(e instanceof HTMLImageElement){const t=e.decode().then(()=>{this._set("content",e)});this.addResolvingPromise(t)}else e?this._set("content",e):this.addResolvingPromise(Promise.reject(new Y("image-element:invalid-image-type","Invalid image type",{image:e})));return Promise.resolve(this)}readImage(e,t,n){return Ke(t.url,n)}writeImage(e,t,n,s){if(p(e))return;const o=s==null?void 0:s.portalItem,r=s==null?void 0:s.resources;if(!o||!r)return void(typeof e=="string"&&(t[n]=fe(e,s)));const a=typeof e!="string"||je(e)||Ce(e)?null:e;if(a){if(qe(a)==null)return void(t[n]=a);const c=fe(a,{...s,verifyItemRelativeUrls:s&&s.verifyItemRelativeUrls?{writtenUrls:s.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},De.NO);if(o&&c&&!Je(c))return r.toKeep.push({resource:o.resourceFromPath(c),compress:!1}),void(t[n]=c)}t[n]="<pending>",r.pendingOperations.push(Ve(e).then(c=>{const d=Et(c,o);t[n]=d.itemRelativeUrl,r.toAdd.push({resource:d,content:c,compress:!1,finish:g=>{this.image=g.url}})}))}};i([l({readOnly:!0})],S.prototype,"content",void 0),i([l({json:{name:"url",type:String}})],S.prototype,"image",void 0),i([X("image",["url"])],S.prototype,"readImage",null),i([le("image")],S.prototype,"writeImage",null),i([l({readOnly:!0,json:{name:"mediaType"}})],S.prototype,"type",void 0),S=i([R("esri.layers.support.ImageElement")],S);const Te=S;async function Ve(e){if(typeof e=="string"){if(Ce(e)){const{data:t}=await re(e,{responseType:"blob"});return t}return je(e)?Ye(e):Ve((await re(e,{responseType:"image"})).data)}return new Promise(t=>Mt(e).toBlob(t))}function Mt(e){if(e instanceof HTMLCanvasElement)return e;const t=e instanceof HTMLImageElement?e.naturalWidth:e.width,n=e instanceof HTMLImageElement?e.naturalHeight:e.height,s=document.createElement("canvas"),o=s.getContext("2d");return s.width=t,s.height=n,e instanceof HTMLImageElement?o.drawImage(e,0,0,e.width,e.height):e instanceof ImageData&&o.putImageData(e,0,0),s}function Et(e,t){const n=Qe(),s=`${Ze("media",n)}.${yt(e)}`;return t.resourceFromPath(s)}let J=class extends de{constructor(e){super(e),this.content=null,this.type="video"}load(){const e=this.video;if(typeof e=="string"){const t=document.createElement("video");t.src=e,t.crossOrigin="anonymous",t.autoplay=!0,t.muted=!0,t.loop=!0,this.addResolvingPromise(this._loadVideo(t).then(()=>{this._set("content",t)}))}else e instanceof HTMLVideoElement?this.addResolvingPromise(this._loadVideo(e).then(()=>{this._set("content",e)})):this.addResolvingPromise(Promise.reject(new Y("video-element:invalid-video-type","Invalid video type",{video:e})));return Promise.resolve(this)}set video(e){this.loadStatus==="not-loaded"?this._set("video",e):F.getLogger(this.declaredClass).error("#video","video cannot be changed after the element is loaded.")}_loadVideo(e){return new Promise((t,n)=>{e.oncanplay=()=>{e.oncanplay=null,e.play().then(t,n)},e.crossOrigin!=="anonymous"&&(e.crossOrigin="anonymous",e.src=e.src)})}};i([l({readOnly:!0})],J.prototype,"content",void 0),i([l()],J.prototype,"video",null),J=i([R("esri.layers.support.VideoElement")],J);const We=J,St={key:"type",defaultKeyValue:"image",base:de,typeMap:{image:Te,video:We}},Re=ie.ofType(St);let G=class extends Se.LoadableMixin(Xe(et(tt.EventedAccessor))){constructor(e){super(e),this._index=new gt,this._elementViewsMap=new Map,this._elementsIndexes=new Map,this._elementsChangedHandler=t=>{for(const s of t.removed){const o=this._elementViewsMap.get(s);this._elementViewsMap.delete(s),this._index.delete(o),this.handles.remove(o),o.destroy(),this.notifyChange("fullExtent")}const{spatialReference:n}=this;for(const s of t.added){if(this._elementViewsMap.get(s))continue;const o=new Pt({spatialReference:n,element:s});this._elementViewsMap.set(s,o);const r=nt(()=>o.coords,()=>this._updateIndexForElement(o,!1));this._updateIndexForElement(o,!0),this.handles.add(r,o)}this._elementsIndexes.clear(),this.elements.forEach((s,o)=>this._elementsIndexes.set(s,o)),this.emit("refresh")},this.elements=new Re}async load(e){if(st(e),!this.spatialReference){const t=this.elements.find(n=>C(n.georeference)&&C(n.georeference.coords));this._set("spatialReference",t?K(K(t.georeference).coords).spatialReference:Ee.WGS84)}return this._elementsChangedHandler({added:this.elements.items,removed:[]}),this.handles.add(this.elements.on("change",this._elementsChangedHandler)),this}destroy(){this._index.clear(),this._elementViewsMap.clear(),this._elementsIndexes.clear()}set elements(e){this._set("elements",ot(e,this._get("elements"),Re))}get fullExtent(){if(this.loadStatus==="not-loaded")return null;const e=this._index.fullBounds;return p(e)?null:new pe({xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:this.spatialReference})}set spatialReference(e){this.loadStatus==="not-loaded"?this._set("spatialReference",e):F.getLogger(this.declaredClass).error("#spatialReference","spatialReference cannot be changed after the source is loaded.")}async queryElements(e,t){await this.load(),await rt(e.spatialReference,this.spatialReference,null,t);const n=it(e.spatialReference,this.spatialReference)?e:at(e,this.spatialReference);if(!n)return[];const s=n.normalize(),o=[];for(const r of s)this._index.forEachInBounds(lt(r),({normalizedCoords:a,element:c})=>{C(a)&&ct(r,a)&&o.push(c)});return o.sort((r,a)=>this._elementsIndexes.get(r)-this._elementsIndexes.get(a)),o}_updateIndexForElement(e,t){const n=e.normalizedBounds,s=this._index.has(e),o=C(n);this._index.delete(e),o&&this._index.set(e,n),this.notifyChange("fullExtent"),t||(s!==o?this.emit("refresh"):this.emit("change",{element:e.element}))}};i([l()],G.prototype,"elements",null),i([l({readOnly:!0})],G.prototype,"fullExtent",null),i([l()],G.prototype,"spatialReference",null),G=i([R("esri.layers.support.LocalMediaElementSource")],G);const se=G;function we(e){return typeof e=="object"&&e!=null&&"type"in e}let f=class extends pt(ut(dt(ht(ft)))){constructor(e){super(e),this.effectiveSource=null,this.copyright=null,this.operationalLayerType="MediaLayer",this.spatialReference=null,this.type="media",this.source=new se}load(e){const t=this.source;if(!t)return this.addResolvingPromise(Promise.reject(new Y("media-layer:source-missing","Set 'MediaLayer.source' before loading the layer."))),Promise.resolve(this);const n=we(t)?new se({elements:new ie([t])}):t;this._set("effectiveSource",n),this.spatialReference&&(n.spatialReference=this.spatialReference);const s=n.load(e).then(()=>{this.spatialReference=n.spatialReference});return this.addResolvingPromise(s),Promise.resolve(this)}destroy(){var e,t;(e=K(this.effectiveSource))==null||e.destroy(),(t=K(this.source))==null||t.destroy()}get fullExtent(){return this.loaded?this.effectiveSource.fullExtent:null}set source(e){this.loadStatus==="not-loaded"?this._set("source",e):F.getLogger(this.declaredClass).error("#source","source cannot be changed after the layer is loaded.")}castSource(e){return e?Array.isArray(e)||e instanceof ie?new se({elements:e}):e:null}readSource(e,t,n){const s=t.mediaType==="image"?new Te:t.mediaType==="video"?new We:null;return s==null||s.read(t,n),s}writeSource(e,t,n,s){var o;e&&we(e)&&e.type==="image"?e.write(t,s):s!=null&&s.messages&&((o=s==null?void 0:s.messages)==null||o.push(new Y("media-layer:unsupported-source","source must be an 'ImageElement'")))}};i([l({readOnly:!0})],f.prototype,"effectiveSource",void 0),i([l({type:String})],f.prototype,"copyright",void 0),i([l({readOnly:!0})],f.prototype,"fullExtent",null),i([l({type:["MediaLayer"]})],f.prototype,"operationalLayerType",void 0),i([l({type:["show","hide"]})],f.prototype,"listMode",void 0),i([l({nonNullable:!0,json:{write:{enabled:!0,allowNull:!1}}})],f.prototype,"source",null),i([mt("source")],f.prototype,"castSource",null),i([X("source",["url"])],f.prototype,"readSource",null),i([le("source")],f.prototype,"writeSource",null),i([l()],f.prototype,"spatialReference",void 0),i([l({readOnly:!0})],f.prototype,"type",void 0),f=i([R("esri.layers.MediaLayer")],f);const Nt=f;export{Nt as default};
