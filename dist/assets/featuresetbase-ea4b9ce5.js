import{c as he}from"./arcadeTimeUtils-55255860.js";import{q as A,z as v,b as R,_ as P,t as x,ah as ge,U as we,V as se,O as S,G as H,P as N,J as V,Q as Ie,E as z,ai as Fe,R as Ee,c as j,k as De,aj as be,ak as q,a0 as K,al as Y}from"./arcadeUtils-6e7a9456.js";import{t as m,e as p}from"./executionError-fb3f283a.js";import{e as le,b as xe,j as fe,f as Ae,c as ce,a as Ne,d as Te,g as Se,S as X,C as ve,I as Le,h as Pe,y as k,A as Re,x as B,D as L,E as _}from"./featureSetUtils-18877582.js";import{t as Ce}from"./portalUtils-0919d377.js";import{e as Oe,A as ue}from"./SpatialFilter-65f4e5b4.js";import{hI as Me}from"./index-65afe59f.js";import{f as b}from"./WhereClause-61ed1eef.js";import $ from"./FeatureLayer-d29725e7.js";import{y as W}from"./Field-f17f32a3.js";import"./FieldsIndex-6df00c0a.js";import"./number-f3406daf.js";import"./featureConversionUtils-a232f677.js";import"./OptimizedGeometry-33b2eb0d.js";import"./OptimizedFeatureSet-1d1ac4b9.js";import"./sizeVariableUtils-d4870b0d.js";import"./clusterUtils-a342a95a.js";import"./SizeVariable-e7f3c0e2.js";import"./colorRamps-08b57831.js";import"./LegendOptions-d5bf6b73.js";import"./lengthUtils-00939dab.js";import"./Query-380d10a1.js";import"./executeQueryJSON-7789df5f.js";import"./query-3d2830b1.js";import"./normalizeUtils-678d9dd1.js";import"./normalizeUtilsCommon-2b774e39.js";import"./pbfQueryUtils-91e4521c.js";import"./pbf-5511d482.js";import"./queryZScale-2ed7be3c.js";import"./FeatureSet-725ad5ad.js";import"./AttachmentInfo-d8820005.js";import"./AttachmentQuery-02a78654.js";import"./executeForIds-a7c5782c.js";import"./RelationshipQuery-8b36d96a.js";import"./fieldType-d8edb871.js";import"./TopFeaturesQuery-a106986f.js";import"./FeatureType-cefa53ac.js";import"./FeatureTemplate-e720f0c6.js";import"./geometryEngineAsync-e8fd2709.js";import"./UniqueValueRenderer-c45fa812.js";import"./diffUtils-0f0e8cfe.js";import"./ColorStop-03954883.js";import"./jsonUtils-15c906c8.js";import"./styleUtils-00c8d6d5.js";import"./featureFlags-acda3469.js";import"./jsonUtils-cf75a5b6.js";import"./DictionaryLoader-b3115f22.js";import"./LRUCache-fba88a6d.js";import"./MemCache-b8f96232.js";import"./heatmapUtils-1ed1bbca.js";import"./vec4f64-aa64c7e9.js";import"./MultiOriginJSONSupport-94ddedfa.js";import"./sql-c4c85944.js";import"./FeatureLayerBase-6ded2ba8.js";import"./commonProperties-605b6017.js";import"./ElevationInfo-926fbbdf.js";import"./serviceCapabilitiesUtils-722c1e48.js";import"./editsZScale-c8ac5d3c.js";import"./APIKeyMixin-a73b4a94.js";import"./ArcGISService-d205da9a.js";import"./BlendLayer-bf12370f.js";import"./jsonUtils-7e0542f0.js";import"./parser-8554880e.js";import"./CustomParametersMixin-c6bdaa0b.js";import"./EditBusLayer-418a86f7.js";import"./FeatureReductionLayer-3b76ad31.js";import"./FeatureEffect-8de6067b.js";import"./labelingInfo-a25619a7.js";import"./labelUtils-ec59d2a3.js";import"./defaultsJSON-b087dd4d.js";import"./OperationalLayer-87798fca.js";import"./OrderedLayer-73c6bf5c.js";import"./PortalLayer-22d5b96f.js";import"./portalItemUtils-44900d59.js";import"./RefreshableLayer-25a5ecc8.js";import"./ScaleRangeLayer-bcba2562.js";import"./TemporalLayer-2faea16c.js";import"./fieldProperties-776bdeb8.js";import"./versionUtils-87e003f4.js";import"./styleUtils-c510b82d.js";import"./popupUtils-15651f00.js";function ke(o,n,i,d){if(d.length===1){if(N(d[0]))return Y(o,d[0],-1);if(z(d[0]))return Y(o,d[0].toArray(),-1)}return Y(o,d,-1)}async function ee(o,n,i){const d=o.getVariables();if(d.length>0){const F=[];for(let r=0;r<d.length;r++){const t={name:d[r]};F.push(await n.evaluateIdentifier(i,t))}const e={};for(let r=0;r<d.length;r++)e[d[r]]=F[r];return o.parameters=e,o}return o}function u(o,n,i=null){for(const d in o)if(d.toLowerCase()===n.toLowerCase())return o[d];return i}function de(o){if(o===null)return null;const n={type:u(o,"type",""),name:u(o,"name","")};if(n.type==="range")n.range=u(o,"range",[]);else{n.codedValues=[];for(const i of u(o,"codedValues",[]))n.codedValues.push({name:u(i,"name",""),code:u(i,"code",null)})}return n}function ne(o){if(o===null)return null;const n={},i=u(o,"wkt",null);i!==null&&(n.wkt=i);const d=u(o,"wkid",null);return d!==null&&(n.wkid=d),n}function me(o){if(o===null)return null;const n={hasZ:u(o,"hasz",!1),hasM:u(o,"hasm",!1)},i=u(o,"spatialreference",null);i&&(n.spatialReference=ne(i));const d=u(o,"x",null);if(d!==null)return n.x=d,n.y=u(o,"y",null),n;const F=u(o,"rings",null);if(F!==null)return n.rings=F,n;const e=u(o,"paths",null);if(e!==null)return n.paths=e,n;const r=u(o,"points",null);if(r!==null)return n.points=r,n;for(const t of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const c=u(o,t,null);c!==null&&(n[t]=c)}return n}function ze(o,n){for(const i of n)if(i===o)return!0;return!1}function He(o){return!!o.layerDefinition&&!!o.featureSet&&ze(o.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&N(o.layerDefinition.fields)!==!1&&N(o.featureSet.features)!==!1}function mt(o){o.mode==="async"&&(o.functions.timezone=function(n,i){return o.standardFunctionAsync(n,i,async(d,F,e)=>{if(A(e,1,2,n,i),v(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].dateTimeReferenceFieldIndex.layerDateFieldsTimeZone;if(!(e[1]instanceof R)||e[1].hasField("type")===!1)throw new m(n,p.InvalidParameter,i);const c=e[1].field("type");if(P(c)===!1)throw new m(n,p.InvalidParameter,i);switch(x(c).toLowerCase()){case"preferredtimezone":return e[0].dateTimeReferenceFieldIndex.layerPreferredTimeZone;case"editfieldsinfo":return e[0].dateTimeReferenceFieldIndex.layerEditFieldsTimeZone;case"timeinfo":return e[0].dateTimeReferenceFieldIndex.layerTimeInfoTimeZone;case"field":if(e[1].hasField("fieldname")&&P(e[1].field("fieldname")))return e[0].dateTimeReferenceFieldIndex.fieldTimeZone(x(e[1].field("fieldname")))}throw new m(n,p.InvalidParameter,i)}const r=ge(e[0],we(n));if(r===null)return null;const t=r.timeZone;return t==="system"?he.systemTimeZoneCanonicalName:t})},o.functions.sqltimestamp=function(n,i){return o.standardFunctionAsync(n,i,async(d,F,e)=>{A(e,1,3,n,i);const r=e[0];if(se(r)){if(e.length===1)return r.toSQLString();if(e.length===2)return r.changeTimeZone(x(e[1])).toSQLString();throw new m(n,p.InvalidParameter,i)}if(v(r)){if(e.length!==3)throw new m(n,p.InvalidParameter,i);await r.load();const t=x(e[1]);if(se(e[2])===!1)throw new m(n,p.InvalidParameter,i);const c=r.fieldTimeZone(t);return c===null?e[2].toSQLString():e[2].changeTimeZone(c).toSQLString()}throw new m(n,p.InvalidParameter,i)})},o.signatures.push({name:"sqltimestamp",min:2,max:4}),o.functions.featuresetbyid=function(n,i){return o.standardFunctionAsync(n,i,(d,F,e)=>{if(A(e,2,4,n,i),e[0]instanceof le){const r=x(e[1]);let t=S(e[2],null);const c=H(S(e[3],!0));if(t===null&&(t=["*"]),N(t)===!1)throw new m(n,p.InvalidParameter,i);return e[0].featureSetById(r,c,t)}throw new m(n,p.InvalidParameter,i)})},o.signatures.push({name:"featuresetbyid",min:2,max:4}),o.functions.getfeatureset=function(n,i){return o.standardFunctionAsync(n,i,(d,F,e)=>{if(A(e,1,2,n,i),V(e[0])){let r=S(e[1],"datasource");return r===null&&(r="datasource"),r=x(r).toLowerCase(),xe(e[0].fullSchema(),r,n.lrucache,n.interceptor,n.spatialReference)}throw new m(n,p.InvalidParameter,i)})},o.signatures.push({name:"getfeatureset",min:1,max:2}),o.functions.featuresetbyportalitem=function(n,i){return o.standardFunctionAsync(n,i,(d,F,e)=>{if(A(e,2,5,n,i),e[0]===null)throw new m(n,p.PortalRequired,i);if(e[0]instanceof Ie){const l=x(e[1]),a=x(e[2]);let s=S(e[3],null);const f=H(S(e[4],!0));if(s===null&&(s=["*"]),N(s)===!1)throw new m(n,p.InvalidParameter,i);let h=null;return n.services&&n.services.portal&&(h=n.services.portal),h=Ce(e[0],h),fe(l,a,n.spatialReference,s,f,h,n.lrucache,n.interceptor)}if(P(e[0])===!1)throw new m(n,p.PortalRequired,i);const r=x(e[0]),t=x(e[1]);let c=S(e[2],null);const y=H(S(e[3],!0));if(c===null&&(c=["*"]),N(c)===!1)throw new m(n,p.InvalidParameter,i);if(n.services&&n.services.portal)return fe(r,t,n.spatialReference,c,y,n.services.portal,n.lrucache,n.interceptor);throw new m(n,p.PortalRequired,i)})},o.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),o.functions.featuresetbyname=function(n,i){return o.standardFunctionAsync(n,i,(d,F,e)=>{if(A(e,2,4,n,i),e[0]instanceof le){const r=x(e[1]);let t=S(e[2],null);const c=H(S(e[3],!0));if(t===null&&(t=["*"]),N(t)===!1)throw new m(n,p.InvalidParameter,i);return e[0].featureSetByName(r,c,t)}throw new m(n,p.InvalidParameter,i)})},o.signatures.push({name:"featuresetbyname",min:2,max:4}),o.functions.featureset=function(n,i){return o.standardFunction(n,i,(d,F,e)=>{var c;A(e,1,1,n,i);let r=e[0];const t={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(P(r))r=JSON.parse(r),r.layerDefinition!==void 0?(t.layerDefinition=r.layerDefinition,t.featureSet=r.featureSet,r.layerDefinition.spatialReference&&(t.layerDefinition.spatialReference=r.layerDefinition.spatialReference)):(t.featureSet.features=r.features,t.featureSet.geometryType=r.geometryType,t.layerDefinition.geometryType=t.featureSet.geometryType,t.layerDefinition.objectIdField=r.objectIdFieldName??"",t.layerDefinition.typeIdField=r.typeIdFieldName,t.layerDefinition.globalIdField=r.globalIdFieldName,t.layerDefinition.fields=r.fields,r.spatialReference&&(t.layerDefinition.spatialReference=r.spatialReference));else{if(!(e[0]instanceof R))throw new m(n,p.InvalidParameter,i);{r=JSON.parse(e[0].castToText(!0));const y=u(r,"layerdefinition");if(y!==null){t.layerDefinition.geometryType=u(y,"geometrytype",""),t.featureSet.geometryType=t.layerDefinition.geometryType,t.layerDefinition.globalIdField=u(y,"globalidfield",""),t.layerDefinition.objectIdField=u(y,"objectidfield",""),t.layerDefinition.typeIdField=u(y,"typeidfield","");const l=u(y,"spatialreference",null);l&&(t.layerDefinition.spatialReference=ne(l));for(const s of u(y,"fields",[])){const f={name:u(s,"name",""),alias:u(s,"alias",""),type:u(s,"type",""),nullable:u(s,"nullable",!0),editable:u(s,"editable",!0),length:u(s,"length",null),domain:de(u(s,"domain"))};t.layerDefinition.fields.push(f)}const a=u(r,"featureset",null);if(a){const s={};for(const f of t.layerDefinition.fields)s[f.name.toLowerCase()]=f.name;for(const f of u(a,"features",[])){const h={},E=u(f,"attributes",{});for(const w in E)h[s[w.toLowerCase()]]=E[w];t.featureSet.features.push({attributes:h,geometry:me(u(f,"geometry",null))})}}}else{t.layerDefinition.geometryType=u(r,"geometrytype",""),t.featureSet.geometryType=t.layerDefinition.geometryType,t.layerDefinition.objectIdField=u(r,"objectidfieldname",""),t.layerDefinition.typeIdField=u(r,"typeidfieldname","");const l=u(r,"spatialreference",null);l&&(t.layerDefinition.spatialReference=ne(l));let a=u(r,"fields",null);if(N(a))for(const h of a){const E={name:u(h,"name",""),alias:u(h,"alias",""),type:u(h,"type",""),nullable:u(h,"nullable",!0),editable:u(h,"editable",!0),length:u(h,"length",null),domain:de(u(h,"domain"))};t.layerDefinition.fields.push(E)}else a=null,t.layerDefinition.fields=a;const s={};for(const h of t.layerDefinition.fields)s[h.name.toLowerCase()]=h.name;let f=u(r,"features",null);if(N(f))for(const h of f){const E={},w=u(h,"attributes",{});for(const D in w)E[s[D.toLowerCase()]]=w[D];t.featureSet.features.push({attributes:E,geometry:me(u(h,"geometry",null))})}else f=null,t.featureSet.features=f}}}if(He(t)===!1)throw new m(n,p.InvalidParameter,i);return(((c=t==null?void 0:t.layerDefinition)==null?void 0:c.geometryType)||"")===""&&(t.layerDefinition.geometryType="esriGeometryNull"),Ae.create(t,n.spatialReference)})},o.signatures.push({name:"featureset",min:1,max:1}),o.functions.filter=function(n,i){return o.standardFunctionAsync(n,i,async(d,F,e)=>{if(A(e,2,2,n,i),N(e[0])||z(e[0])){const r=[];let t=e[0];t instanceof Fe&&(t=t.toArray());let c=null;if(!Ee(e[1]))throw new m(n,p.InvalidParameter,i);c=e[1].createFunction(n);for(const y of t){const l=c(y);Me(l)?await l===!0&&r.push(y):l===!0&&r.push(y)}return r}if(v(e[0])){const r=await e[0].load(),t=b.create(e[1],r.getFieldsIndex()),c=t.getVariables();if(c.length>0){const y=[];for(let a=0;a<c.length;a++){const s={name:c[a]};y.push(await o.evaluateIdentifier(n,s))}const l={};for(let a=0;a<c.length;a++)l[c[a]]=y[a];return t.parameters=l,new ce({parentfeatureset:e[0],whereclause:t})}return new ce({parentfeatureset:e[0],whereclause:t})}throw new m(n,p.InvalidParameter,i)})},o.signatures.push({name:"filter",min:2,max:2}),o.functions.orderby=function(n,i){return o.standardFunctionAsync(n,i,async(d,F,e)=>{if(A(e,2,2,n,i),v(e[0])){const r=new Ne(e[1]);return new Te({parentfeatureset:e[0],orderbyclause:r})}throw new m(n,p.InvalidParameter,i)})},o.signatures.push({name:"orderby",min:2,max:2}),o.functions.top=function(n,i){return o.standardFunctionAsync(n,i,async(d,F,e)=>{if(A(e,2,2,n,i),v(e[0]))return new Se({parentfeatureset:e[0],topnum:e[1]});if(N(e[0]))return j(e[1])>=e[0].length?e[0].slice(0):e[0].slice(0,j(e[1]));if(z(e[0]))return j(e[1])>=e[0].length()?e[0].slice(0):e[0].slice(0,j(e[1]));throw new m(n,p.InvalidParameter,i)})},o.signatures.push({name:"top",min:2,max:2}),o.functions.first=function(n,i){return o.standardFunctionAsync(n,i,async(d,F,e)=>{if(A(e,1,1,n,i),v(e[0])){const r=await e[0].first(d.abortSignal);if(r!==null){const t=De.createFromGraphicLikeObject(r.geometry,r.attributes,e[0],n.timeReference);return t._underlyingGraphic=r,t}return r}return N(e[0])?e[0].length===0?null:e[0][0]:z(e[0])?e[0].length()===0?null:e[0].get(0):null})},o.signatures.push({name:"first",min:1,max:1}),o.functions.attachments=function(n,i){return o.standardFunctionAsync(n,i,async(d,F,e)=>{A(e,1,2,n,i);const r={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof R){if(e[1].hasField("minsize")&&(r.minsize=j(e[1].field("minsize"))),e[1].hasField("metadata")&&(r.returnMetadata=H(e[1].field("metadata"))),e[1].hasField("maxsize")&&(r.maxsize=j(e[1].field("maxsize"))),e[1].hasField("types")){const t=be(e[1].field("types"),!1);t.length>0&&(r.types=t)}}else if(e[1]!==null)throw new m(n,p.InvalidParameter,i)}if(V(e[0])){let t=e[0]._layer;return t instanceof $&&(t=X(t,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),t===null?[]:v(t)===!1?[]:(await t.load(),t.queryAttachments(e[0].field(t.objectIdField),r.minsize,r.maxsize,r.types,r.returnMetadata))}if(e[0]===null)return[];throw new m(n,p.InvalidParameter,i)})},o.signatures.push({name:"attachments",min:1,max:2}),o.functions.featuresetbyrelationshipname=function(n,i){return o.standardFunctionAsync(n,i,async(d,F,e)=>{A(e,2,4,n,i);const r=e[0],t=x(e[1]);let c=S(e[2],null);const y=H(S(e[3],!0));if(c===null&&(c=["*"]),N(c)===!1)throw new m(n,p.InvalidParameter,i);if(e[0]===null)return null;if(!V(e[0]))throw new m(n,p.InvalidParameter,i);let l=r._layer;if(l instanceof $&&(l=X(l,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),l===null||v(l)===!1)return null;l=await l.load();const a=l.relationshipMetaData().filter(w=>w.name===t);if(a.length===0)return null;if(a[0].relationshipTableId!==void 0&&a[0].relationshipTableId!==null&&a[0].relationshipTableId>-1)return ve(l,a[0],r.field(l.objectIdField),l.spatialReference,c,y,n.lrucache,n.interceptor);let s=l.serviceUrl();if(!s)return null;s=s.charAt(s.length-1)==="/"?s+a[0].relatedTableId.toString():s+"/"+a[0].relatedTableId.toString();const f=await Le(s,l.spatialReference,c,y,n.lrucache,n.interceptor);await f.load();let h=f.relationshipMetaData();if(h=h.filter(w=>w.id===a[0].id),r.hasField(a[0].keyField)===!1||r.field(a[0].keyField)===null){const w=await l.getFeatureByObjectId(r.field(l.objectIdField),[a[0].keyField]);if(w){const D=b.create(h[0].keyField+"= @id",f.getFieldsIndex());return D.parameters={id:w.attributes[a[0].keyField]},f.filter(D)}return new Oe({parentfeatureset:f})}const E=b.create(h[0].keyField+"= @id",f.getFieldsIndex());return E.parameters={id:r.field(a[0].keyField)},f.filter(E)})},o.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),o.functions.featuresetbyassociation=function(n,i){return o.standardFunctionAsync(n,i,async(d,F,e)=>{A(e,2,3,n,i);const r=e[0],t=x(S(e[1],"")).toLowerCase(),c=P(e[2])?x(e[2]):null;if(e[0]===null)return null;if(!V(e[0]))throw new m(n,p.InvalidParameter,i);let y=r._layer;if(y instanceof $&&(y=X(y,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),y===null||v(y)===!1)return null;await y.load();const l=y.serviceUrl(),a=await Pe(l,n.spatialReference);let s=null,f=null,h=!1;if(c!==null&&c!==""&&c!==void 0){for(const I of a.terminals)I.terminalName===c&&(f=I.terminalId);f===null&&(h=!0)}const E=a.associations.getFieldsIndex(),w=E.get("TOGLOBALID").name,D=E.get("FROMGLOBALID").name,J=E.get("TOTERMINALID").name,Q=E.get("FROMTERMINALID").name,G=E.get("FROMNETWORKSOURCEID").name,Z=E.get("TONETWORKSOURCEID").name,M=E.get("ASSOCIATIONTYPE").name,pe=E.get("ISCONTENTVISIBLE").name,ye=E.get("OBJECTID").name;for(const I of y.fields)if(I.type==="global-id"){s=r.field(I.name);break}let C=null,te=new k(new W({name:"percentalong",alias:"percentalong",type:"double"}),b.create("0",a.associations.getFieldsIndex())),ie=new k(new W({name:"side",alias:"side",type:"string"}),b.create("''",a.associations.getFieldsIndex()));const T="globalid",re="globalId",ae={};for(const I in a.lkp)ae[I]=a.lkp[I].sourceId;const O=new Re(new W({name:"classname",alias:"classname",type:"string"}),null,ae);let g="";switch(t){case"midspan":{g=`((${w}='${s}') OR ( ${D}='${s}')) AND (${M} IN (5))`,O.codefield=b.create(`CASE WHEN (${w}='${s}') THEN ${G} ELSE ${Z} END`,a.associations.getFieldsIndex());const I=K(L.findField(a.associations.fields,D));I.name=T,I.alias=T,C=new k(I,b.create(`CASE WHEN (${D}='${s}') THEN ${w} ELSE ${D} END`,a.associations.getFieldsIndex())),te=a.unVersion>=4?new _(L.findField(a.associations.fields,E.get("PERCENTALONG").name)):new k(new W({name:"percentalong",alias:"percentalong",type:"double"}),b.create("0",a.associations.getFieldsIndex()));break}case"junctionedge":{g=`((${w}='${s}') OR ( ${D}='${s}')) AND (${M} IN (4,6))`,O.codefield=b.create(`CASE WHEN (${w}='${s}') THEN ${G} ELSE ${Z} END`,a.associations.getFieldsIndex());const I=K(L.findField(a.associations.fields,D));I.name=T,I.alias=T,C=new k(I,b.create(`CASE WHEN (${D}='${s}') THEN ${w} ELSE ${D} END`,a.associations.getFieldsIndex())),ie=new k(new W({name:"side",alias:"side",type:"string"}),b.create(`CASE WHEN (${M}=4) THEN 'from' ELSE 'to' END`,a.associations.getFieldsIndex()));break}case"connected":{let I=`${w}='@T'`,oe=`${D}='@T'`;f!==null&&(I+=` AND ${J}=@A`,oe+=` AND ${Q}=@A`),g="(("+I+") OR ("+oe+"))",g=q(g,"@T",s??""),I=q(I,"@T",s??""),f!==null&&(I=q(I,"@A",f.toString()),g=q(g,"@A",f.toString())),O.codefield=b.create("CASE WHEN "+I+` THEN ${G} ELSE ${Z} END`,a.associations.getFieldsIndex());const U=K(L.findField(a.associations.fields,D));U.name=T,U.alias=T,C=new k(U,b.create("CASE WHEN "+I+` THEN ${D} ELSE ${w} END`,a.associations.getFieldsIndex()));break}case"container":g=`${w}='${s}' AND ${M} = 2`,f!==null&&(g+=` AND ${J} = `+f.toString()),O.codefield=G,g="( "+g+" )",C=new B(L.findField(a.associations.fields,D),T,T);break;case"content":g=`(${D}='${s}' AND ${M} = 2)`,f!==null&&(g+=` AND ${Q} = `+f.toString()),O.codefield=Z,g="( "+g+" )",C=new B(L.findField(a.associations.fields,w),T,T);break;case"structure":g=`(${w}='${s}' AND ${M} = 3)`,f!==null&&(g+=` AND ${J} = `+f.toString()),O.codefield=G,g="( "+g+" )",C=new B(L.findField(a.associations.fields,D),T,re);break;case"attached":g=`(${D}='${s}' AND ${M} = 3)`,f!==null&&(g+=` AND ${Q} = `+f.toString()),O.codefield=Z,g="( "+g+" )",C=new B(L.findField(a.associations.fields,w),T,re);break;default:throw new m(n,p.InvalidParameter,i)}return h&&(g="1 <> 1"),new L({parentfeatureset:a.associations,adaptedFields:[new _(L.findField(a.associations.fields,ye)),new _(L.findField(a.associations.fields,pe)),C,ie,O,te],extraFilter:g?b.create(g,a.associations.getFieldsIndex()):null})})},o.signatures.push({name:"featuresetbyassociation",min:2,max:6}),o.functions.groupby=function(n,i){return o.standardFunctionAsync(n,i,async(d,F,e)=>{if(A(e,3,3,n,i),!v(e[0]))throw new m(n,p.InvalidParameter,i);const r=await e[0].load(),t=[],c=[];let y=!1,l=[];if(P(e[1]))l.push(e[1]);else if(e[1]instanceof R)l.push(e[1]);else if(N(e[1]))l=e[1];else{if(!z(e[1]))throw new m(n,p.InvalidParameter,i);l=e[1].toArray()}for(const a of l)if(P(a)){const s=b.create(x(a),r.getFieldsIndex()),f=ue(s)===!0?x(a):"%%%%FIELDNAME";t.push({name:f,expression:s}),f==="%%%%FIELDNAME"&&(y=!0)}else{if(!(a instanceof R))throw new m(n,p.InvalidParameter,i);{const s=a.hasField("name")?a.field("name"):"%%%%FIELDNAME",f=a.hasField("expression")?a.field("expression"):"";if(s==="%%%%FIELDNAME"&&(y=!0),!s)throw new m(n,p.InvalidParameter,i);t.push({name:s,expression:b.create(f||s,r.getFieldsIndex())})}}if(l=[],P(e[2]))l.push(e[2]);else if(N(e[2]))l=e[2];else if(z(e[2]))l=e[2].toArray();else{if(!(e[2]instanceof R))throw new m(n,p.InvalidParameter,i);l.push(e[2])}for(const a of l){if(!(a instanceof R))throw new m(n,p.InvalidParameter,i);{const s=a.hasField("name")?a.field("name"):"",f=a.hasField("statistic")?a.field("statistic"):"",h=a.hasField("expression")?a.field("expression"):"";if(!s||!f||!h)throw new m(n,p.InvalidParameter,i);c.push({name:s,statistic:f.toLowerCase(),expression:b.create(h,r.getFieldsIndex())})}}if(y){const a={};for(const f of r.fields)a[f.name.toLowerCase()]=1;for(const f of t)f.name!=="%%%%FIELDNAME"&&(a[f.name.toLowerCase()]=1);for(const f of c)f.name!=="%%%%FIELDNAME"&&(a[f.name.toLowerCase()]=1);let s=0;for(const f of t)if(f.name==="%%%%FIELDNAME"){for(;a["field_"+s.toString()]===1;)s++;a["field_"+s.toString()]=1,f.name="FIELD_"+s.toString()}}for(const a of t)await ee(a.expression,o,n);for(const a of c)await ee(a.expression,o,n);return e[0].groupby(t,c)})},o.signatures.push({name:"groupby",min:3,max:3}),o.functions.distinct=function(n,i){return o.standardFunctionAsync(n,i,async(d,F,e)=>{if(v(e[0])){A(e,2,2,n,i);const r=await e[0].load(),t=[];let c=[];if(P(e[1]))c.push(e[1]);else if(e[1]instanceof R)c.push(e[1]);else if(N(e[1]))c=e[1];else{if(!z(e[1]))throw new m(n,p.InvalidParameter,i);c=e[1].toArray()}let y=!1;for(const l of c)if(P(l)){const a=b.create(x(l),r.getFieldsIndex()),s=ue(a)===!0?x(l):"%%%%FIELDNAME";t.push({name:s,expression:a}),s==="%%%%FIELDNAME"&&(y=!0)}else{if(!(l instanceof R))throw new m(n,p.InvalidParameter,i);{const a=l.hasField("name")?l.field("name"):"%%%%FIELDNAME",s=l.hasField("expression")?l.field("expression"):"";if(a==="%%%%FIELDNAME"&&(y=!0),!a)throw new m(n,p.InvalidParameter,i);t.push({name:a,expression:b.create(s||a,r.getFieldsIndex())})}}if(y){const l={};for(const s of r.fields)l[s.name.toLowerCase()]=1;for(const s of t)s.name!=="%%%%FIELDNAME"&&(l[s.name.toLowerCase()]=1);let a=0;for(const s of t)if(s.name==="%%%%FIELDNAME"){for(;l["field_"+a.toString()]===1;)a++;l["field_"+a.toString()]=1,s.name="FIELD_"+a.toString()}}for(const l of t)await ee(l.expression,o,n);return e[0].groupby(t,[])}return ke("distinct",d,F,e)})})}export{mt as registerFunctions};
