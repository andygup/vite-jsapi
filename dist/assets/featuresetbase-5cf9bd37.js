import{A as pe}from"./arcadeTimeUtils-275f29fb.js";import{p as T,q as R,D as O,l as $,w as A,ah as he,X as ge,H as ae,L,T as H,m as N,o as U,W as we,n as G,ai as Ie,k as Ee,t as B,F as De,aj as Se,ak as V,a0 as K,al as Q}from"./arcadeUtils-938fc326.js";import{A as y,E as m}from"./executionError-e2eca390.js";import{F as fe,c as Ae,a as oe,b as Te,d as ue,O as Ne,e as be,T as Le,f as Y,g as Re,h as Pe,i as $e,S as M,j as Oe,k as q,A as P,l as X}from"./featureSetUtils-002bada0.js";import{g as _e}from"./portalUtils-b3bb204e.js";import{E as Ce,i as ce}from"./SpatialFilter-e7784152.js";import{ho as ke}from"./index-fb3bdf4f.js";import{W as S}from"./WhereClause-8e84f842.js";import x from"./FeatureLayer-68e80759.js";import{F as j}from"./Field-f5f1ebb3.js";import"./FieldsIndex-56690a21.js";import"./number-c93bbabc.js";import"./featureConversionUtils-f24a23cd.js";import"./OptimizedGeometry-af84d2ad.js";import"./OptimizedFeatureSet-5c82fe5a.js";import"./sizeVariableUtils-2914222a.js";import"./clusterUtils-c169a684.js";import"./SizeVariable-74abd6da.js";import"./colorRamps-81a71b30.js";import"./LegendOptions-a28747c0.js";import"./lengthUtils-1e4d8fd6.js";import"./Query-476cb6f1.js";import"./executeQueryJSON-bebc1e7a.js";import"./query-747d6c78.js";import"./normalizeUtils-fa48684e.js";import"./normalizeUtilsCommon-baa6918e.js";import"./pbfQueryUtils-67c1a394.js";import"./pbf-b7e849f9.js";import"./queryZScale-46b0ae7d.js";import"./FeatureSet-4f5601d6.js";import"./AttachmentInfo-6cd791bd.js";import"./AttachmentQuery-60b44dd6.js";import"./executeForIds-5753ceb7.js";import"./RelationshipQuery-b61588d7.js";import"./fieldType-d335b740.js";import"./TopFeaturesQuery-9293a704.js";import"./FeatureType-9a9366e5.js";import"./FeatureTemplate-33a4a082.js";import"./geometryEngineAsync-9fac0bd8.js";import"./_commonjsHelpers-725317a4.js";import"./UniqueValueRenderer-55012b53.js";import"./diffUtils-64bbc518.js";import"./ColorStop-b29cec61.js";import"./jsonUtils-3a34d9bc.js";import"./styleUtils-572710a0.js";import"./featureFlags-4ba2b89f.js";import"./jsonUtils-e6785b6d.js";import"./DictionaryLoader-0b6ffeed.js";import"./LRUCache-59f262f3.js";import"./MemCache-3f213196.js";import"./heatmapUtils-a281406f.js";import"./vec4-3dd523e8.js";import"./vec4f64-efdcb593.js";import"./MultiOriginJSONSupport-ea9beeba.js";import"./sql-0af83f60.js";import"./FeatureLayerBase-f47ab54b.js";import"./commonProperties-a5bf3577.js";import"./ElevationInfo-2af660b1.js";import"./serviceCapabilitiesUtils-2aaa1333.js";import"./editsZScale-a68f4aa0.js";import"./APIKeyMixin-9c9fbfaf.js";import"./ArcGISService-61e08bf7.js";import"./BlendLayer-2ddbe670.js";import"./jsonUtils-93f2c64d.js";import"./parser-77953c84.js";import"./CustomParametersMixin-3a61540d.js";import"./EditBusLayer-373c3cca.js";import"./FeatureReductionLayer-71c72362.js";import"./FeatureEffect-2fdde62f.js";import"./labelingInfo-3bb75bee.js";import"./labelUtils-5f0b2e6a.js";import"./defaultsJSON-b396ba80.js";import"./OperationalLayer-914d208b.js";import"./OrderedLayer-9e11b7fe.js";import"./PortalLayer-d73148b9.js";import"./portalItemUtils-dd754f4b.js";import"./RefreshableLayer-3b03bf7b.js";import"./ScaleRangeLayer-77c2a39c.js";import"./TemporalLayer-a15af708.js";import"./fieldProperties-dcd9d2f8.js";import"./versionUtils-5af0a6f3.js";import"./styleUtils-6e60a30e.js";import"./popupUtils-0e01ee8b.js";function Me(l,t,n,d){if(d.length===1){if(N(d[0]))return Q(l,d[0],-1);if(G(d[0]))return Q(l,d[0].toArray(),-1)}return Q(l,d,-1)}async function ee(l,t,n){const d=l.getVariables();if(d.length>0){const E=[];for(let r=0;r<d.length;r++){const i={name:d[r]};E.push(await t.evaluateIdentifier(n,i))}const e={};for(let r=0;r<d.length;r++)e[d[r]]=E[r];return l.parameters=e,l}return l}function c(l,t,n=null){for(const d in l)if(d.toLowerCase()===t.toLowerCase())return l[d];return n}function de(l){if(l===null)return null;const t={type:c(l,"type",""),name:c(l,"name","")};if(t.type==="range")t.range=c(l,"range",[]);else{t.codedValues=[];for(const n of c(l,"codedValues",[]))t.codedValues.push({name:c(n,"name",""),code:c(n,"code",null)})}return t}function te(l){if(l===null)return null;const t={},n=c(l,"wkt",null);n!==null&&(t.wkt=n);const d=c(l,"wkid",null);return d!==null&&(t.wkid=d),t}function ye(l){if(l===null)return null;const t={hasZ:c(l,"hasz",!1),hasM:c(l,"hasm",!1)},n=c(l,"spatialreference",null);n&&(t.spatialReference=te(n));const d=c(l,"x",null);if(d!==null)return t.x=d,t.y=c(l,"y",null),t;const E=c(l,"rings",null);if(E!==null)return t.rings=E,t;const e=c(l,"paths",null);if(e!==null)return t.paths=e,t;const r=c(l,"points",null);if(r!==null)return t.points=r,t;for(const i of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const u=c(l,i,null);u!==null&&(t[i]=u)}return t}function Ge(l,t){for(const n of t)if(n===l)return!0;return!1}function ze(l){return!(!l.layerDefinition||!l.featureSet||Ge(l.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])===!1||N(l.layerDefinition.fields)===!1||N(l.featureSet.features)===!1)}function Fi(l){l.mode==="async"&&(l.functions.timezone=function(t,n){return l.standardFunctionAsync(t,n,async(d,E,e)=>{if(T(e,1,2,t,n),R(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].dateTimeReferenceFieldIndex.layerDateFieldsTimeZone;if(!(e[1]instanceof O)||e[1].hasField("type")===!1)throw new y(t,m.InvalidParameter,n);const u=e[1].field("type");if($(u)===!1)throw new y(t,m.InvalidParameter,n);switch(A(u).toLowerCase()){case"preferredtimezone":return e[0].dateTimeReferenceFieldIndex.layerPreferredTimeZone;case"editfieldsinfo":return e[0].dateTimeReferenceFieldIndex.layerEditFieldsTimeZone;case"timeinfo":return e[0].dateTimeReferenceFieldIndex.layerTimeInfoTimeZone;case"field":if(e[1].hasField("fieldname")&&$(e[1].field("fieldname")))return e[0].dateTimeReferenceFieldIndex.fieldTimeZone(A(e[1].field("fieldname")))}throw new y(t,m.InvalidParameter,n)}const r=he(e[0],ge(t));if(r===null)return null;const i=r.timeZone;return i==="system"?pe.systemTimeZoneCanonicalName:i})},l.functions.sqltimestamp=function(t,n){return l.standardFunctionAsync(t,n,async(d,E,e)=>{T(e,1,3,t,n);const r=e[0];if(ae(r)){if(e.length===1)return r.toSQLString();if(e.length===2)return r.changeTimeZone(A(e[1])).toSQLString();throw new y(t,m.InvalidParameter,n)}if(R(r)){if(e.length!==3)throw new y(t,m.InvalidParameter,n);await r.load();const i=A(e[1]);if(ae(e[2])===!1)throw new y(t,m.InvalidParameter,n);const u=r.fieldTimeZone(i);return u===null?e[2].toSQLString():e[2].changeTimeZone(u).toSQLString()}throw new y(t,m.InvalidParameter,n)})},l.signatures.push({name:"sqltimestamp",min:2,max:4}),l.functions.featuresetbyid=function(t,n){return l.standardFunctionAsync(t,n,(d,E,e)=>{if(T(e,2,4,t,n),e[0]instanceof fe){const r=A(e[1]);let i=L(e[2],null);const u=H(L(e[3],!0));if(i===null&&(i=["*"]),N(i)===!1)throw new y(t,m.InvalidParameter,n);return e[0].featureSetById(r,u,i)}throw new y(t,m.InvalidParameter,n)})},l.signatures.push({name:"featuresetbyid",min:2,max:4}),l.functions.getfeatureset=function(t,n){return l.standardFunctionAsync(t,n,(d,E,e)=>{if(T(e,1,2,t,n),U(e[0])){let r=L(e[1],"datasource");return r===null&&(r="datasource"),r=A(r).toLowerCase(),Ae(e[0].fullSchema(),r,t.lrucache,t.interceptor,t.spatialReference)}throw new y(t,m.InvalidParameter,n)})},l.signatures.push({name:"getfeatureset",min:1,max:2}),l.functions.featuresetbyportalitem=function(t,n){return l.standardFunctionAsync(t,n,(d,E,e)=>{if(T(e,2,5,t,n),e[0]===null)throw new y(t,m.PortalRequired,n);if(e[0]instanceof we){const f=A(e[1]),s=A(e[2]);let a=L(e[3],null);const o=H(L(e[4],!0));if(a===null&&(a=["*"]),N(a)===!1)throw new y(t,m.InvalidParameter,n);let p=null;return t.services&&t.services.portal&&(p=t.services.portal),p=_e(e[0],p),oe(f,s,t.spatialReference,a,o,p,t.lrucache,t.interceptor)}if($(e[0])===!1)throw new y(t,m.PortalRequired,n);const r=A(e[0]),i=A(e[1]);let u=L(e[2],null);const F=H(L(e[3],!0));if(u===null&&(u=["*"]),N(u)===!1)throw new y(t,m.InvalidParameter,n);if(t.services&&t.services.portal)return oe(r,i,t.spatialReference,u,F,t.services.portal,t.lrucache,t.interceptor);throw new y(t,m.PortalRequired,n)})},l.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),l.functions.featuresetbyname=function(t,n){return l.standardFunctionAsync(t,n,(d,E,e)=>{if(T(e,2,4,t,n),e[0]instanceof fe){const r=A(e[1]);let i=L(e[2],null);const u=H(L(e[3],!0));if(i===null&&(i=["*"]),N(i)===!1)throw new y(t,m.InvalidParameter,n);return e[0].featureSetByName(r,u,i)}throw new y(t,m.InvalidParameter,n)})},l.signatures.push({name:"featuresetbyname",min:2,max:4}),l.functions.featureset=function(t,n){return l.standardFunction(t,n,(d,E,e)=>{var u;T(e,1,1,t,n);let r=e[0];const i={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if($(r))r=JSON.parse(r),r.layerDefinition!==void 0?(i.layerDefinition=r.layerDefinition,i.featureSet=r.featureSet,r.layerDefinition.spatialReference&&(i.layerDefinition.spatialReference=r.layerDefinition.spatialReference)):(i.featureSet.features=r.features,i.featureSet.geometryType=r.geometryType,i.layerDefinition.geometryType=i.featureSet.geometryType,i.layerDefinition.objectIdField=r.objectIdFieldName??"",i.layerDefinition.typeIdField=r.typeIdFieldName,i.layerDefinition.globalIdField=r.globalIdFieldName,i.layerDefinition.fields=r.fields,r.spatialReference&&(i.layerDefinition.spatialReference=r.spatialReference));else if(e[0]instanceof O){r=JSON.parse(e[0].castToText(!0));const F=c(r,"layerdefinition");if(F!==null){i.layerDefinition.geometryType=c(F,"geometrytype",""),i.featureSet.geometryType=i.layerDefinition.geometryType,i.layerDefinition.globalIdField=c(F,"globalidfield",""),i.layerDefinition.objectIdField=c(F,"objectidfield",""),i.layerDefinition.typeIdField=c(F,"typeidfield","");const f=c(F,"spatialreference",null);f&&(i.layerDefinition.spatialReference=te(f));for(const a of c(F,"fields",[])){const o={name:c(a,"name",""),alias:c(a,"alias",""),type:c(a,"type",""),nullable:c(a,"nullable",!0),editable:c(a,"editable",!0),length:c(a,"length",null),domain:de(c(a,"domain"))};i.layerDefinition.fields.push(o)}const s=c(r,"featureset",null);if(s){const a={};for(const o of i.layerDefinition.fields)a[o.name.toLowerCase()]=o.name;for(const o of c(s,"features",[])){const p={},I=c(o,"attributes",{});for(const D in I)p[a[D.toLowerCase()]]=I[D];i.featureSet.features.push({attributes:p,geometry:ye(c(o,"geometry",null))})}}}else{i.layerDefinition.geometryType=c(r,"geometrytype",""),i.featureSet.geometryType=i.layerDefinition.geometryType,i.layerDefinition.objectIdField=c(r,"objectidfieldname",""),i.layerDefinition.typeIdField=c(r,"typeidfieldname","");const f=c(r,"spatialreference",null);f&&(i.layerDefinition.spatialReference=te(f));let s=c(r,"fields",null);if(N(s))for(const p of s){const I={name:c(p,"name",""),alias:c(p,"alias",""),type:c(p,"type",""),nullable:c(p,"nullable",!0),editable:c(p,"editable",!0),length:c(p,"length",null),domain:de(c(p,"domain"))};i.layerDefinition.fields.push(I)}else s=null,i.layerDefinition.fields=s;const a={};for(const p of i.layerDefinition.fields)a[p.name.toLowerCase()]=p.name;let o=c(r,"features",null);if(N(o))for(const p of o){const I={},D=c(p,"attributes",{});for(const g in D)I[a[g.toLowerCase()]]=D[g];i.featureSet.features.push({attributes:I,geometry:ye(c(p,"geometry",null))})}else o=null,i.featureSet.features=o}}else throw new y(t,m.InvalidParameter,n);if(ze(i)===!1)throw new y(t,m.InvalidParameter,n);return(((u=i==null?void 0:i.layerDefinition)==null?void 0:u.geometryType)||"")===""&&(i.layerDefinition.geometryType="esriGeometryNull"),Te.create(i,t.spatialReference)})},l.signatures.push({name:"featureset",min:1,max:1}),l.functions.filter=function(t,n){return l.standardFunctionAsync(t,n,async(d,E,e)=>{if(T(e,2,2,t,n),N(e[0])||G(e[0])){const r=[];let i=e[0];i instanceof Ie&&(i=i.toArray());let u=null;if(Ee(e[1]))u=e[1].createFunction(t);else throw new y(t,m.InvalidParameter,n);for(const F of i){const f=u(F);ke(f)?await f===!0&&r.push(F):f===!0&&r.push(F)}return r}else if(R(e[0])){const r=await e[0].load(),i=S.create(e[1],r.getFieldsIndex()),u=i.getVariables();if(u.length>0){const F=[];for(let s=0;s<u.length;s++){const a={name:u[s]};F.push(await l.evaluateIdentifier(t,a))}const f={};for(let s=0;s<u.length;s++)f[u[s]]=F[s];return i.parameters=f,new ue({parentfeatureset:e[0],whereclause:i})}return new ue({parentfeatureset:e[0],whereclause:i})}throw new y(t,m.InvalidParameter,n)})},l.signatures.push({name:"filter",min:2,max:2}),l.functions.orderby=function(t,n){return l.standardFunctionAsync(t,n,async(d,E,e)=>{if(T(e,2,2,t,n),R(e[0])){const r=new Ne(e[1]);return new be({parentfeatureset:e[0],orderbyclause:r})}throw new y(t,m.InvalidParameter,n)})},l.signatures.push({name:"orderby",min:2,max:2}),l.functions.top=function(t,n){return l.standardFunctionAsync(t,n,async(d,E,e)=>{if(T(e,2,2,t,n),R(e[0]))return new Le({parentfeatureset:e[0],topnum:e[1]});if(N(e[0]))return B(e[1])>=e[0].length?e[0].slice(0):e[0].slice(0,B(e[1]));if(G(e[0]))return B(e[1])>=e[0].length()?e[0].slice(0):e[0].slice(0,B(e[1]));throw new y(t,m.InvalidParameter,n)})},l.signatures.push({name:"top",min:2,max:2}),l.functions.first=function(t,n){return l.standardFunctionAsync(t,n,async(d,E,e)=>{if(T(e,1,1,t,n),R(e[0])){const r=await e[0].first(d.abortSignal);if(r!==null){const i=De.createFromGraphicLikeObject(r.geometry,r.attributes,e[0],t.timeReference);return i._underlyingGraphic=r,i}return r}return N(e[0])?e[0].length===0?null:e[0][0]:G(e[0])?e[0].length()===0?null:e[0].get(0):null})},l.signatures.push({name:"first",min:1,max:1}),l.functions.attachments=function(t,n){return l.standardFunctionAsync(t,n,async(d,E,e)=>{T(e,1,2,t,n);const r={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof O){if(e[1].hasField("minsize")&&(r.minsize=B(e[1].field("minsize"))),e[1].hasField("metadata")&&(r.returnMetadata=H(e[1].field("metadata"))),e[1].hasField("maxsize")&&(r.maxsize=B(e[1].field("maxsize"))),e[1].hasField("types")){const i=Se(e[1].field("types"),!1);i.length>0&&(r.types=i)}}else if(e[1]!==null)throw new y(t,m.InvalidParameter,n)}if(U(e[0])){let i=e[0]._layer;return i instanceof x&&(i=Y(i,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),i===null?[]:R(i)===!1?[]:(await i.load(),i.queryAttachments(e[0].field(i.objectIdField),r.minsize,r.maxsize,r.types,r.returnMetadata))}if(e[0]===null)return[];throw new y(t,m.InvalidParameter,n)})},l.signatures.push({name:"attachments",min:1,max:2}),l.functions.featuresetbyrelationshipname=function(t,n){return l.standardFunctionAsync(t,n,async(d,E,e)=>{T(e,2,4,t,n);const r=e[0],i=A(e[1]);let u=L(e[2],null);const F=H(L(e[3],!0));if(u===null&&(u=["*"]),N(u)===!1)throw new y(t,m.InvalidParameter,n);if(e[0]===null)return null;if(!U(e[0]))throw new y(t,m.InvalidParameter,n);let f=r._layer;if(f instanceof x&&(f=Y(f,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),f===null||R(f)===!1)return null;f=await f.load();const a=f.relationshipMetaData().filter(g=>g.name===i);if(a.length===0)return null;if(a[0].relationshipTableId!==void 0&&a[0].relationshipTableId!==null&&a[0].relationshipTableId>-1)return Re(f,a[0],r.field(f.objectIdField),f.spatialReference,u,F,t.lrucache,t.interceptor);let o=f.serviceUrl();if(!o)return null;o=o.charAt(o.length-1)==="/"?o+a[0].relatedTableId.toString():o+"/"+a[0].relatedTableId.toString();const p=await Pe(o,f.spatialReference,u,F,t.lrucache,t.interceptor);await p.load();let I=p.relationshipMetaData();if(I=I.filter(g=>g.id===a[0].id),r.hasField(a[0].keyField)===!1||r.field(a[0].keyField)===null){const g=await f.getFeatureByObjectId(r.field(f.objectIdField),[a[0].keyField]);if(g){const z=S.create(I[0].keyField+"= @id",p.getFieldsIndex());return z.parameters={id:g.attributes[a[0].keyField]},p.filter(z)}return new Ce({parentfeatureset:p})}const D=S.create(I[0].keyField+"= @id",p.getFieldsIndex());return D.parameters={id:r.field(a[0].keyField)},p.filter(D)})},l.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),l.functions.featuresetbyassociation=function(t,n){return l.standardFunctionAsync(t,n,async(d,E,e)=>{T(e,2,3,t,n);const r=e[0],i=A(L(e[1],"")).toLowerCase(),u=$(e[2])?A(e[2]):null;if(e[0]===null)return null;if(!U(e[0]))throw new y(t,m.InvalidParameter,n);let F=r._layer;if(F instanceof x&&(F=Y(F,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),F===null||R(F)===!1)return null;await F.load();const f=F.serviceUrl(),s=await $e(f,t.spatialReference);let a=null,o=null,p=!1;if(u!==null&&u!==""&&u!==void 0){for(const w of s.terminals)w.terminalName===u&&(o=w.terminalId);o===null&&(p=!0)}const I=s.associations.getFieldsIndex(),D=I.get("TOGLOBALID").name,g=I.get("FROMGLOBALID").name,z=I.get("TOTERMINALID").name,v=I.get("FROMTERMINALID").name,W=I.get("FROMNETWORKSOURCEID").name,Z=I.get("TONETWORKSOURCEID").name,k=I.get("ASSOCIATIONTYPE").name,me=I.get("ISCONTENTVISIBLE").name,Fe=I.get("OBJECTID").name;for(const w of F.fields)if(w.type==="global-id"){a=r.field(w.name);break}let _=null,ie=new M(new j({name:"percentalong",alias:"percentalong",type:"double"}),S.create("0",s.associations.getFieldsIndex())),ne=new M(new j({name:"side",alias:"side",type:"string"}),S.create("''",s.associations.getFieldsIndex()));const b="globalid",re="globalId",le={};for(const w in s.lkp)le[w]=s.lkp[w].sourceId;const C=new Oe(new j({name:"classname",alias:"classname",type:"string"}),null,le);let h="";switch(i){case"midspan":{h=`((${D}='${a}') OR ( ${g}='${a}')) AND (${k} IN (5))`,C.codefield=S.create(`CASE WHEN (${D}='${a}') THEN ${W} ELSE ${Z} END`,s.associations.getFieldsIndex());const w=K(P.findField(s.associations.fields,g));w.name=b,w.alias=b,_=new M(w,S.create(`CASE WHEN (${g}='${a}') THEN ${D} ELSE ${g} END`,s.associations.getFieldsIndex())),ie=s.unVersion>=4?new X(P.findField(s.associations.fields,I.get("PERCENTALONG").name)):new M(new j({name:"percentalong",alias:"percentalong",type:"double"}),S.create("0",s.associations.getFieldsIndex()));break}case"junctionedge":{h=`((${D}='${a}') OR ( ${g}='${a}')) AND (${k} IN (4,6))`,C.codefield=S.create(`CASE WHEN (${D}='${a}') THEN ${W} ELSE ${Z} END`,s.associations.getFieldsIndex());const w=K(P.findField(s.associations.fields,g));w.name=b,w.alias=b,_=new M(w,S.create(`CASE WHEN (${g}='${a}') THEN ${D} ELSE ${g} END`,s.associations.getFieldsIndex())),ne=new M(new j({name:"side",alias:"side",type:"string"}),S.create(`CASE WHEN (${k}=4) THEN 'from' ELSE 'to' END`,s.associations.getFieldsIndex()));break}case"connected":{let w=`${D}='@T'`,se=`${g}='@T'`;o!==null&&(w+=` AND ${z}=@A`,se+=` AND ${v}=@A`),h="(("+w+") OR ("+se+"))",h=V(h,"@T",a??""),w=V(w,"@T",a??""),o!==null&&(w=V(w,"@A",o.toString()),h=V(h,"@A",o.toString())),C.codefield=S.create("CASE WHEN "+w+` THEN ${W} ELSE ${Z} END`,s.associations.getFieldsIndex());const J=K(P.findField(s.associations.fields,g));J.name=b,J.alias=b,_=new M(J,S.create("CASE WHEN "+w+` THEN ${g} ELSE ${D} END`,s.associations.getFieldsIndex()));break}case"container":h=`${D}='${a}' AND ${k} = 2`,o!==null&&(h+=` AND ${z} = `+o.toString()),C.codefield=W,h="( "+h+" )",_=new q(P.findField(s.associations.fields,g),b,b);break;case"content":h=`(${g}='${a}' AND ${k} = 2)`,o!==null&&(h+=` AND ${v} = `+o.toString()),C.codefield=Z,h="( "+h+" )",_=new q(P.findField(s.associations.fields,D),b,b);break;case"structure":h=`(${D}='${a}' AND ${k} = 3)`,o!==null&&(h+=` AND ${z} = `+o.toString()),C.codefield=W,h="( "+h+" )",_=new q(P.findField(s.associations.fields,g),b,re);break;case"attached":h=`(${g}='${a}' AND ${k} = 3)`,o!==null&&(h+=` AND ${v} = `+o.toString()),C.codefield=Z,h="( "+h+" )",_=new q(P.findField(s.associations.fields,D),b,re);break;default:throw new y(t,m.InvalidParameter,n)}return p&&(h="1 <> 1"),new P({parentfeatureset:s.associations,adaptedFields:[new X(P.findField(s.associations.fields,Fe)),new X(P.findField(s.associations.fields,me)),_,ne,C,ie],extraFilter:h?S.create(h,s.associations.getFieldsIndex()):null})})},l.signatures.push({name:"featuresetbyassociation",min:2,max:6}),l.functions.groupby=function(t,n){return l.standardFunctionAsync(t,n,async(d,E,e)=>{if(T(e,3,3,t,n),!R(e[0]))throw new y(t,m.InvalidParameter,n);const r=await e[0].load(),i=[],u=[];let F=!1,f=[];if($(e[1]))f.push(e[1]);else if(e[1]instanceof O)f.push(e[1]);else if(N(e[1]))f=e[1];else if(G(e[1]))f=e[1].toArray();else throw new y(t,m.InvalidParameter,n);for(const s of f)if($(s)){const a=S.create(A(s),r.getFieldsIndex()),o=ce(a)===!0?A(s):"%%%%FIELDNAME";i.push({name:o,expression:a}),o==="%%%%FIELDNAME"&&(F=!0)}else if(s instanceof O){const a=s.hasField("name")?s.field("name"):"%%%%FIELDNAME",o=s.hasField("expression")?s.field("expression"):"";if(a==="%%%%FIELDNAME"&&(F=!0),!a)throw new y(t,m.InvalidParameter,n);i.push({name:a,expression:S.create(o||a,r.getFieldsIndex())})}else throw new y(t,m.InvalidParameter,n);if(f=[],$(e[2]))f.push(e[2]);else if(N(e[2]))f=e[2];else if(G(e[2]))f=e[2].toArray();else if(e[2]instanceof O)f.push(e[2]);else throw new y(t,m.InvalidParameter,n);for(const s of f)if(s instanceof O){const a=s.hasField("name")?s.field("name"):"",o=s.hasField("statistic")?s.field("statistic"):"",p=s.hasField("expression")?s.field("expression"):"";if(!a||!o||!p)throw new y(t,m.InvalidParameter,n);u.push({name:a,statistic:o.toLowerCase(),expression:S.create(p,r.getFieldsIndex())})}else throw new y(t,m.InvalidParameter,n);if(F){const s={};for(const o of r.fields)s[o.name.toLowerCase()]=1;for(const o of i)o.name!=="%%%%FIELDNAME"&&(s[o.name.toLowerCase()]=1);for(const o of u)o.name!=="%%%%FIELDNAME"&&(s[o.name.toLowerCase()]=1);let a=0;for(const o of i)if(o.name==="%%%%FIELDNAME"){for(;s["field_"+a.toString()]===1;)a++;s["field_"+a.toString()]=1,o.name="FIELD_"+a.toString()}}for(const s of i)await ee(s.expression,l,t);for(const s of u)await ee(s.expression,l,t);return e[0].groupby(i,u)})},l.signatures.push({name:"groupby",min:3,max:3}),l.functions.distinct=function(t,n){return l.standardFunctionAsync(t,n,async(d,E,e)=>{if(R(e[0])){T(e,2,2,t,n);const r=await e[0].load(),i=[];let u=[];if($(e[1]))u.push(e[1]);else if(e[1]instanceof O)u.push(e[1]);else if(N(e[1]))u=e[1];else if(G(e[1]))u=e[1].toArray();else throw new y(t,m.InvalidParameter,n);let F=!1;for(const f of u)if($(f)){const s=S.create(A(f),r.getFieldsIndex()),a=ce(s)===!0?A(f):"%%%%FIELDNAME";i.push({name:a,expression:s}),a==="%%%%FIELDNAME"&&(F=!0)}else if(f instanceof O){const s=f.hasField("name")?f.field("name"):"%%%%FIELDNAME",a=f.hasField("expression")?f.field("expression"):"";if(s==="%%%%FIELDNAME"&&(F=!0),!s)throw new y(t,m.InvalidParameter,n);i.push({name:s,expression:S.create(a||s,r.getFieldsIndex())})}else throw new y(t,m.InvalidParameter,n);if(F){const f={};for(const a of r.fields)f[a.name.toLowerCase()]=1;for(const a of i)a.name!=="%%%%FIELDNAME"&&(f[a.name.toLowerCase()]=1);let s=0;for(const a of i)if(a.name==="%%%%FIELDNAME"){for(;f["field_"+s.toString()]===1;)s++;f["field_"+s.toString()]=1,a.name="FIELD_"+s.toString()}}for(const f of i)await ee(f.expression,l,t);return e[0].groupby(i,[])}return Me("distinct",d,E,e)})})}export{Fi as registerFunctions};
