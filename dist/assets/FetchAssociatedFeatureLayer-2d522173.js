import{gJ as _,O as m,I as E,r as d,hw as A,hx as P,eZ as U,Z as y,P as R,dt as v}from"./index-b51e75d5.js";import{e as w,b as T,r as C}from"./I3SBinaryReader-70543c24.js";import"./spatialReferenceEllipsoidUtils-4185bdd7.js";import"./Query-aa3f0821.js";import{f as g}from"./vec4f64-efdcb593.js";import"./symbolColorUtils-26b961a1.js";import{c as D}from"./quatf64-5b0101cd.js";import{a as F}from"./vec3f32-ec4c3c20.js";import"./plane-278f0b8c.js";import S from"./FeatureLayer-2876df1d.js";const Z={analytics:{supportsCacheHint:!1},attachment:{supportsContentType:!1,supportsExifInfo:!1,supportsKeywords:!1,supportsName:!1,supportsSize:!1,supportsCacheHint:!1,supportsResize:!1},data:{isVersioned:!1,supportsAttachment:!1,supportsM:!1,supportsZ:!1},editing:{supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsGeometryUpdate:!1,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsAsyncApplyEdits:!1},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:!1,supportsDelete:!1,supportsEditing:!1,supportsChangeTracking:!1,supportsQuery:!1,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:!1,supportsExceedsLimitStatistics:!1},queryRelated:{supportsCount:!1,supportsOrderBy:!1,supportsPagination:!1,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},query:{maxRecordCount:0,maxRecordCountFactor:0,standardMaxRecordCount:0,supportsCacheHint:!1,supportsCentroid:!1,supportsCompactGeometry:!1,supportsDefaultSpatialReference:!1,supportsFullTextSearch:!1,supportsDisjointSpatialRelationship:!1,supportsDistance:!1,supportsDistinct:!1,supportsExtent:!1,supportsFormatPBF:!1,supportsGeometryProperties:!1,supportsHavingClause:!1,supportsHistoricMoment:!1,supportsMaxRecordCountFactor:!1,supportsOrderBy:!1,supportsPagination:!1,supportsPercentileStatistics:!1,supportsQuantization:!1,supportsQuantizationEditMode:!1,supportsQueryByOthers:!1,supportsQueryGeometry:!1,supportsResultType:!1,supportsSqlExpression:!1,supportsStandardizedQueriesOnly:!1,supportsTopFeaturesQuery:!1,supportsSpatialAggregationStatistics:!1,supportedSpatialAggregationStatistics:{envelope:!1,centroid:!1,convexHull:!1},supportsStatistics:!1,tileMaxRecordCount:0}};var h;(function(s){s[s.INVISIBLE=0]="INVISIBLE",s[s.TRANSPARENT=1]="TRANSPARENT",s[s.OPAQUE=2]="OPAQUE"})(h||(h={}));function N(s){return{...$,...s,type:"solid"}}const $={color:g(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:h.OPAQUE,hasSlicePlane:!1};g(0,0,0,.2),h.OPAQUE;function L(s=[0,0,0],t=[-1,-1,-1],e=D()){return{center:_(s),halfSize:F(t),quaternion:w(e)}}(()=>{const s=new Int8Array(162);let t=0;const e=r=>{for(let a=0;a<r.length;a++)s[t+a]=r[a];t+=6};return e([6,2,3,1,5,4]),e([0,2,3,1,5,4]),e([0,2,3,7,5,4]),e([0,1,3,2,6,4]),e([0,1,3,2,0,0]),e([0,1,5,7,3,2]),e([0,1,3,7,6,4]),e([0,1,3,7,6,2]),e([0,1,5,7,6,2]),e([0,1,5,4,6,2]),e([0,1,5,4,0,0]),e([0,1,3,7,5,4]),e([0,2,6,4,0,0]),e([0,0,0,0,0,0]),e([1,3,7,5,0,0]),e([2,3,7,6,4,0]),e([2,3,7,6,0,0]),e([2,3,1,5,7,6]),e([0,1,5,7,6,2]),e([0,1,5,7,6,4]),e([0,1,3,7,6,4]),e([4,5,7,6,2,0]),e([4,5,7,6,0,0]),e([4,5,1,3,7,6]),e([0,2,3,7,5,4]),e([6,2,3,7,5,4]),e([6,2,3,1,5,4]),s})();m();var I;(function(s){s[s.OUTSIDE=0]="OUTSIDE",s[s.INTERSECTS_CENTER_OUTSIDE=1]="INTERSECTS_CENTER_OUTSIDE",s[s.INTERSECTS_CENTER_INSIDE=2]="INTERSECTS_CENTER_INSIDE",s[s.INSIDE=3]="INSIDE"})(I||(I={}));function W(s,t,e,r,a){const n=[];for(const o of t)if(o&&a.includes(o.name)){const l=`${s}/nodes/${e}/attributes/${o.key}/0`;n.push({url:l,storageInfo:o})}return E(n.map(o=>d(o.url,{responseType:"array-buffer"}).then(l=>C(o.storageInfo,l.data)))).then(o=>{const l=[];for(const c of r){const u={};for(let i=0;i<o.length;i++){const p=o[i].value;p!=null&&(u[n[i].storageInfo.name]=q(p,c))}l.push(u)}return l})}const x=-(2**15),O=-(2**31);function q(s,t){if(!s)return null;const e=s[t];return A(s)?e===x?null:e:P(s)?e===O?null:e:e!==e?null:e}N({color:[0,0,0,0],opacity:0});new Array(3*8);T();m();m();L();new Array(3*24);class J{constructor(t,e,r,a){var o;this._parsedUrl=t,this._portalItem=e,this._apiKey=r,this.signal=a,this._rootDocument=null;const n=(o=this._parsedUrl)==null?void 0:o.path.match(/^(.*)\/SceneServer\/layers\/([\d]*)\/?$/i);n&&(this._urlParts={root:n[1],layerId:parseInt(n[2],10)})}async fetch(){if(!this._urlParts)return null;const t=this._portalItem??await this._portalItemFromServiceItemId();if(t==null)return this._loadFromUrl();const e=await this._findAndLoadRelatedPortalItem(t);return e==null?null:this._loadFeatureLayerFromPortalItem(e)}async fetchPortalItem(){if(!this._urlParts)return null;const t=this._portalItem??await this._portalItemFromServiceItemId();return t==null?null:this._findAndLoadRelatedPortalItem(t)}async _fetchRootDocument(){if(this._rootDocument!=null)return this._rootDocument;if(this._urlParts==null)return this._rootDocument={},{};const t={query:{f:"json",token:this._apiKey},responseType:"json",signal:this.signal},e=`${this._urlParts.root}/SceneServer`;try{const r=await d(e,t);this._rootDocument=r.data}catch{this._rootDocument={}}return this._rootDocument}async _fetchServiceOwningPortalUrl(){var a,n;const t=(a=this._parsedUrl)==null?void 0:a.path,e=t?(n=U)==null?void 0:n.findServerInfo(t):null;if(e!=null&&e.owningSystemUrl)return e.owningSystemUrl;const r=t?t.replace(/(.*\/rest)\/.*/i,"$1")+"/info":null;try{const l=(await d(r,{query:{f:"json"},responseType:"json",signal:this.signal})).data.owningSystemUrl;if(l)return l}catch(o){y(o)}return null}async _findAndLoadRelatedPortalItem(t){try{return(await t.fetchRelatedItems({relationshipType:"Service2Service",direction:"reverse"},{signal:this.signal})).find(r=>r.type==="Feature Service")||null}catch(e){return y(e),null}}async _loadFeatureLayerFromPortalItem(t){await t.load({signal:this.signal});const e=await this._findMatchingAssociatedSublayerUrl(t.url??"");return new S({url:e,portalItem:t}).load({signal:this.signal})}async _loadFromUrl(){var r;const t=await this._findMatchingAssociatedSublayerUrl(`${(r=this._urlParts)==null?void 0:r.root}/FeatureServer`);return new S({url:t}).load({signal:this.signal})}async _findMatchingAssociatedSublayerUrl(t){var p;const e=t.replace(/^(.*FeatureServer)(\/[\d]*\/?)?$/i,"$1"),r={query:{f:"json"},responseType:"json",authMode:"no-prompt",signal:this.signal},a=(p=this._urlParts)==null?void 0:p.layerId,n=this._fetchRootDocument(),o=d(e,r),[l,c]=await Promise.all([o,n]),u=c&&c.layers,i=l.data&&l.data.layers;if(!Array.isArray(i))throw new Error("expected layers array");if(Array.isArray(u)){for(let f=0;f<Math.min(u.length,i.length);f++)if(u[f].id===a)return`${e}/${i[f].id}`}else if(a!=null&&a<i.length)return`${e}/${i[a].id}`;throw new Error("could not find matching associated sublayer")}async _portalItemFromServiceItemId(){const e=(await this._fetchRootDocument()).serviceItemId;if(!e)return null;const r=new R({id:e,apiKey:this._apiKey}),a=await this._fetchServiceOwningPortalUrl();a!=null&&(r.portal=new v({url:a}));try{return r.load({signal:this.signal})}catch(n){return y(n),null}}}export{J as F,W as q,Z as z};
