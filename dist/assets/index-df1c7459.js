(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function r(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=r(s);fetch(s.href,n)}})();function u(t,e,r,i){var s,n=arguments.length,o=n<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,r):i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(t,e,r,i);else for(var a=t.length-1;a>=0;a--)(s=t[a])&&(o=(n<3?s(o):n>3?s(e,r,o):s(e,r))||o);return n>3&&o&&Object.defineProperty(e,r,o),o}const oAe="modulepreload",aAe=function(t){return"/vite-jsapi/dist/"+t},MJ={},te=function(e,r,i){if(!r||r.length===0)return e();const s=document.getElementsByTagName("link");return Promise.all(r.map(n=>{if(n=aAe(n),n in MJ)return;MJ[n]=!0;const o=n.endsWith(".css"),a=o?'[rel="stylesheet"]':"";if(!!i)for(let h=s.length-1;h>=0;h--){const p=s[h];if(p.href===n&&(!o||p.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${n}"]${a}`))return;const c=document.createElement("link");if(c.rel=o?"stylesheet":oAe,o||(c.as="script",c.crossOrigin=""),c.href=n,document.head.appendChild(c),o)return new Promise((h,p)=>{c.addEventListener("load",h),c.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${n}`)))})})).then(()=>e())};function lAe(t){return t&&t.release&&typeof t.release=="function"}function cAe(t){return t&&t.acquire&&typeof t.acquire=="function"}let Co=class $k{constructor(e,r,i,s=1,n=0){if(this._ctor=e,this._acquireFunction=r,this._releaseFunction=i,this.allocationSize=s,this._pool=new Array(n),this._initialSize=n,this._ctor)for(let o=0;o<n;o++)this._pool[o]=new this._ctor;this.allocationSize=Math.max(s,1)}destroy(){this.prune(0)}acquire(...e){let r;if($k.test.disabled)r=new this._ctor;else{if(this._pool.length===0){const i=this.allocationSize;for(let s=0;s<i;s++)this._pool[s]=new this._ctor}r=this._pool.pop()}return this._acquireFunction?this._acquireFunction(r,...e):cAe(r)&&r.acquire(...e),r}release(e){e&&!$k.test.disabled&&(this._releaseFunction?this._releaseFunction(e):lAe(e)&&e.release(),this._pool.push(e))}prune(e=this._initialSize){if(!(e>=this._pool.length)){for(let r=e;r<this._pool.length;++r){const i=this._pool[r];this._dispose(i)}this._pool.length=e}}_dispose(e){e.dispose&&typeof e.dispose=="function"&&e.dispose()}};Co.test={disabled:!1};function uAe(t){t.length=0}let wc=class{constructor(e=50,r=50){this._pool=new Co(Array,void 0,uAe,r,e)}acquire(){return this._pool.acquire()}release(e){this._pool.release(e)}prune(){this._pool.prune(0)}static acquire(){return w6.acquire()}static release(e){return w6.release(e)}static prune(){w6.prune()}};const w6=new wc(100);function abt(t){const e=[];return function*(){yield*e;for(const r of t)e.push(r),yield r}}function hAe(t,e){for(const r of t)if(r!=null&&e(r))return r}function Lk(t){return t!=null&&typeof t[Symbol.iterator]=="function"}const d1=null;function v(t){return t!=null}function C(t){return t==null}function so(t,e){return v(t)?e(t):d1}function lbt(t){return t}function cbt(t){return t}function Dl(t,e){return e4(t,e),t}function e4(t,e){if(C(t))throw new Error(e??"value is None")}function It(t,e){return v(t)?t:typeof e=="function"?e():e}function PJ(t,e){return v(t)?t:e}function ke(t){return v(t)&&t.destroy(),null}function Qe(t){return v(t)&&t.dispose(),null}function ji(t){return v(t)&&t.remove(),null}function Fh(t){return v(t)&&t.abort(),null}function Bi(t){return v(t)&&t.release(),null}function dAe(t,e,r){return v(t)&&v(e)?v(r)?r(t,e):t.equals(e):t===e}function sw(t){return null}function ubt(t,e){const r=new Array;return t.forEach(i=>{const s=e(i);v(s)&&r.push(s)}),r}function hbt(t,e){const r=new Array;for(const i of t)r.push(_u(i,null,e));return r}function dbt(t,e){for(const r of t)so(r,e)}function _u(t,e,r){return v(t)?r(t):e}function pbt(t){return t.filter(e=>v(e))}function Dn(t,...e){let r=t;for(let i=0;i<e.length&&r;++i)r=r[e[i]];return r}function fbt(t){return t}let ei=class{constructor(){this._groups=new Map}destroy(){this.removeAll()}get size(){let e=0;return this._groups.forEach(r=>{e+=r.length}),e}add(e,r){if(Lk(e)){const i=this._getOrCreateGroup(r);for(const s of e)this._isHandle(s)&&i.push(s)}else this._isHandle(e)&&this._getOrCreateGroup(r).push(e);return this}forEach(e,r){if(typeof e=="function")this._groups.forEach(i=>i.forEach(e));else{const i=this._getGroup(e);i&&r&&i.forEach(r)}}has(e){return this._groups.has(this._ensureGroupKey(e))}remove(e){if(typeof e!="string"&&Lk(e)){for(const r of e)this.remove(r);return this}return this.has(e)?(this._removeAllFromGroup(this._getGroup(e)),this._groups.delete(this._ensureGroupKey(e)),this):this}removeAll(){return this._groups.forEach(e=>this._removeAllFromGroup(e)),this._groups.clear(),this}_isHandle(e){return e&&!!e.remove}_getOrCreateGroup(e){if(this.has(e))return this._getGroup(e);const r=[];return this._groups.set(this._ensureGroupKey(e),r),r}_getGroup(e){return this._groups.get(this._ensureGroupKey(e))}_ensureGroupKey(e){return e||"_default_"}_removeAllFromGroup(e){e.forEach(r=>r.remove())}};const Vce=Symbol("Accessor-beforeDestroy");function yS(t){return cp(()=>t.forEach(e=>v(e)&&e.remove()))}function cp(t){return{remove:()=>{t&&(t(),t=void 0)}}}function gbt(t){return cp(v(t)?()=>t.destroy():void 0)}let L3=class p1{constructor(e=1){this._seed=e}set seed(e){this._seed=e??Math.random()*p1._m}getInt(){return this._seed=(p1._a*this._seed+p1._c)%p1._m,this._seed}getFloat(){return this.getInt()/(p1._m-1)}getIntRange(e,r){return Math.round(this.getFloatRange(e,r))}getFloatRange(e,r){const i=r-e;return e+this.getInt()/p1._m*i}};L3._m=2147483647,L3._a=48271,L3._c=0;function zO(t,e){return e?t.filter((r,i,s)=>s.findIndex(e.bind(null,r))===i):t.filter((r,i,s)=>s.indexOf(r)===i)}function Xg(t,e,r){if(C(t)&&C(e))return!0;if(C(t)||C(e)||t.length!==e.length)return!1;if(r){for(let i=0;i<t.length;i++)if(!r(t[i],e[i]))return!1}else for(let i=0;i<t.length;i++)if(t[i]!==e[i])return!1;return!0}function UH(t,e){let r=t.length!==e.length;r&&(t.length=e.length);for(let i=0;i<e.length;++i)t[i]!==e[i]&&(t[i]=e[i],r=!0);return r}function pAe(t,e,r){let i,s;return r?(i=e.filter(n=>!t.some(o=>r(o,n))),s=t.filter(n=>!e.some(o=>r(o,n)))):(i=e.filter(n=>!t.includes(n)),s=t.filter(n=>!e.includes(n))),{added:i,removed:s}}function fAe(t){return t&&typeof t.length=="number"}function ybt(t,e){const r=t.length;if(r===0)return[];const i=[];for(let s=0;s<r;s+=e)i.push(t.slice(s,s+e));return i}const mAe=!!Array.prototype.fill;function _bt(t,e){if(mAe)return new Array(t).fill(e);const r=new Array(t);for(let i=0;i<t;i++)r[i]=e;return r}function gAe(t,e){e===void 0&&(e=t,t=0);const r=new Array(e-t);for(let i=t;i<e;i++)r[i-t]=i;return r}function yAe(t,e,r){const i=t.length;let s=0,n=i-1;for(;s<n;){const a=s+Math.floor((n-s)/2);e>t[a]?s=a+1:n=a}const o=t[s];return r?e>=t[i-1]?-1:o===e?s:s-1:o===e?s:-1}let Bce=class{constructor(){this.last=0}};const zce=new Bce;function Dk(t,e,r,i){i=i||zce;const s=Math.max(0,i.last-10);for(let o=s;o<r;++o)if(t[o]===e)return i.last=o,o;const n=Math.min(s,r);for(let o=0;o<n;++o)if(t[o]===e)return i.last=o,o;return-1}function PR(t,e,r,i){const s=r??t.length,n=Dk(t,e,s,i);if(n!==-1)return t[n]=t[s-1],r==null&&t.pop(),e}const td=new Set;function _Ae(t,e,r=t.length,i=e.length,s,n){if(i===0||r===0)return r;td.clear();for(let a=0;a<i;++a)td.add(e[a]);s=s||zce;const o=Math.max(0,s.last-10);for(let a=o;a<r;++a)if(td.has(t[a])&&(n&&n.push(t[a]),td.delete(t[a]),t[a]=t[r-1],--r,--a,td.size===0||r===0))return td.clear(),r;for(let a=0;a<o;++a)if(td.has(t[a])&&(n&&n.push(t[a]),td.delete(t[a]),t[a]=t[r-1],--r,--a,td.size===0||r===0))return td.clear(),r;return td.clear(),r}function vAe(t,e){let r=0;for(let i=0;i<t.length;++i){const s=t[i];e(s,i)&&(t[r]=s,r++)}t.length=r}function bAe(t){return t?(IJ.seed=t,()=>IJ.getFloat()):Math.random}function bbt(t,e){const r=bAe(e);for(let i=t.length-1;i>0;i--){const s=Math.floor(r()*(i+1)),n=t[i];t[i]=t[s],t[s]=n}return t}const IJ=new L3;function kH(t,e){const r=t.indexOf(e);return r!==-1?(t.splice(r,1),e):null}function wbt(t,e){const r=new Map,i=t.length;for(let s=0;s<i;s++){const n=t[s],o=e(n,s,t),a=r.get(o);a?a.push(n):r.set(o,[n])}return r}function JE(t){return t instanceof ArrayBuffer}function wAe(t){return t&&t.constructor&&t.constructor.name==="Int8Array"}function pb(t){return t&&t.constructor&&t.constructor.name==="Uint8Array"}function xAe(t){return t&&t.constructor&&t.constructor.name==="Uint8ClampedArray"}function TAe(t){return t&&t.constructor&&t.constructor.name==="Int16Array"}function VH(t){return t&&t.constructor&&t.constructor.name==="Uint16Array"}function SAe(t){return t&&t.constructor&&t.constructor.name==="Int32Array"}function BH(t){return t&&t.constructor&&t.constructor.name==="Uint32Array"}function zH(t){return t&&t.constructor&&t.constructor.name==="Float32Array"}function GH(t){return t&&t.constructor&&t.constructor.name==="Float64Array"}function qM(t){return v(t)?128+t.buffer.byteLength+64:0}const em=1024;function Gce(t,e){let r;if(e)for(r in t)t.hasOwnProperty(r)&&(t[r]===void 0?delete t[r]:t[r]instanceof Object&&Gce(t[r],!0));else for(r in t)t.hasOwnProperty(r)&&t[r]===void 0&&delete t[r];return t}function ne(t){if(!t||typeof t!="object"||typeof t=="function")return t;const e=Wce(t);if(v(e))return e;if(jce(t))return t.clone();if(Hce(t))return t.map(ne);if(qce(t))return t.clone();const r={};for(const i of Object.getOwnPropertyNames(t))r[i]=ne(t[i]);return r}function Nk(t){if(!t||typeof t!="object"||typeof t=="function"||"HTMLElement"in globalThis&&t instanceof HTMLElement)return t;const e=Wce(t);if(v(e))return e;if(Hce(t)){let r=!0;const i=t.map(s=>{const n=Nk(s);return s!=null&&n==null&&(r=!1),n});return r?i:null}if(jce(t))return t.clone();if(!qce(t)){const r=new(Object.getPrototypeOf(t)).constructor;for(const i of Object.getOwnPropertyNames(t)){const s=t[i],n=Nk(s);if(s!=null&&n==null)return null;r[i]=n}return r}return null}function jce(t){return typeof t.clone=="function"}function Hce(t){return typeof t.map=="function"&&typeof t.forEach=="function"}function qce(t){return typeof t.notifyChange=="function"&&typeof t.watch=="function"}function $J(t){if(Object.prototype.toString.call(t)!=="[object Object]")return!1;const e=Object.getPrototypeOf(t);return e===null||e===Object.prototype}function Wce(t){if(wAe(t)||pb(t)||xAe(t)||TAe(t)||VH(t)||SAe(t)||BH(t)||zH(t)||GH(t))return t.slice();if(t instanceof Date)return new Date(t.getTime());if(t instanceof ArrayBuffer)return t.slice(0,t.byteLength);if(t instanceof Map){const e=new Map;for(const[r,i]of t)e.set(r,ne(i));return e}if(t instanceof Set){const e=new Set;for(const r of t)e.add(ne(r));return e}return null}function jH(t,e){return t===e||typeof t=="number"&&isNaN(t)&&typeof e=="number"&&isNaN(e)||typeof(t||{}).getTime=="function"&&typeof(e||{}).getTime=="function"&&t.getTime()===e.getTime()||!1}function EAe(t,e){return t===e||(t==null||typeof t=="string"?t===e:typeof t=="number"?t===e||typeof e=="number"&&isNaN(t)&&isNaN(e):t instanceof Date?e instanceof Date&&t.getTime()===e.getTime():Array.isArray(t)?Array.isArray(e)&&Xg(t,e):t instanceof Set?e instanceof Set&&AAe(t,e):t instanceof Map?e instanceof Map&&RAe(t,e):!!$J(t)&&$J(e)&&CAe(t,e))}function CAe(t,e){if(t===null||e===null)return!1;const r=Object.keys(t);if(e===null||Object.keys(e).length!==r.length)return!1;for(const i of r)if(t[i]!==e[i]||!Object.prototype.hasOwnProperty.call(e,i))return!1;return!0}function AAe(t,e){if(t.size!==e.size)return!1;for(const r of t)if(!e.has(r))return!1;return!0}function RAe(t,e){if(t.size!==e.size)return!1;for(const[r,i]of t){const s=e.get(r);if(s!==i||s===void 0&&!e.has(r))return!1}return!0}function Qa(t){return t?t.__accessor__?t.__accessor__:t.propertyInvalidated?t:null:null}function OAe(t,e){return t!=null&&t.metadatas&&t.metadatas[e]!=null}function V$(t,e,r){return r?ND(t,e,{policy:r,path:""}):ND(t,e,null)}function ND(t,e,r){return e?Object.keys(e).reduce((i,s)=>{let n=null,o="merge";if(r&&(n=r.path?`${r.path}.${s}`:s,o=r.policy(n)),o==="replace"||o==="replace-arrays"&&Array.isArray(i[s]))return i[s]=e[s],i;if(i[s]===void 0)return i[s]=ne(e[s]),i;let a=i[s],l=e[s];if(a===l)return i;if(Array.isArray(l)||Array.isArray(i))a=a?Array.isArray(a)?i[s]=a.concat():i[s]=[a]:i[s]=[],l&&(Array.isArray(l)||(l=[l]),l.forEach(c=>{a.includes(c)||a.push(c)}));else if(l&&typeof l=="object")if(r){const c=r.path;r.path=n,i[s]=ND(a,l,r),r.path=c}else i[s]=ND(a,l,null);else i.hasOwnProperty(s)&&!e.hasOwnProperty(s)||(i[s]=l);return i},t||{}):t}function Xce(t){return Array.isArray(t)?t:t.split(".")}function LJ(t){return t.includes(",")?t.split(",").map(e=>e.trim()):[t.trim()]}function MAe(t){if(Array.isArray(t)){const e=[];for(const r of t)e.push(...LJ(r));return e}return LJ(t)}function Yce(t,e,r,i){const s=MAe(e);if(s.length!==1){const n=s.map(o=>i(t,o,r));return yS(n)}return i(t,s[0],r)}function HH(t){let e=!1;return()=>{e||(e=!0,t())}}function Zce(t,e){const r=t[t.length-1]==="?"?t.slice(0,-1):t;if(e.getItemAt!=null||Array.isArray(e)){const s=parseInt(r,10);if(!isNaN(s))return Array.isArray(e)?e[s]:e.getItemAt(s)}const i=Qa(e);return OAe(i,r)?i.get(r):e[r]}function Jce(t,e,r){if(t==null)return t;const i=Zce(e[r],t);return!i&&r<e.length-1?void 0:r===e.length-1?i:Jce(i,e,r+1)}function GO(t,e,r=0){return typeof e!="string"||e.includes(".")?Jce(t,Xce(e),r):Zce(e,t)}function FD(t,e){return GO(t,e)}function DJ(t,e){return GO(e,t)!==void 0}function jO(t){let e=t.constructor.__accessorMetadata__;const r=Object.prototype.hasOwnProperty.call(t.constructor,"__accessorMetadata__");if(e){if(!r){e=Object.create(e);for(const i in e)e[i]=ne(e[i]);Object.defineProperty(t.constructor,"__accessorMetadata__",{value:e,enumerable:!1,configurable:!0,writable:!0})}}else e={},Object.defineProperty(t.constructor,"__accessorMetadata__",{value:e,enumerable:!1,configurable:!0,writable:!0});return t.constructor.__accessorMetadata__}function t4(t,e){const r=jO(t);let i=r[e];return i||(i=r[e]={}),i}function PAe(t,e){return V$(t,e,$Ae)}const IAe=/^(?:[^.]+\.)?(?:value|type|(?:json\.type|json\.origins\.[^.]\.type))$/;function $Ae(t){return IAe.test(t)?"replace":"merge"}let f_;function de(t){return typeof f_[t]=="function"?f_[t]=f_[t](globalThis):f_[t]}var Ice,$ce,Lce,Dce;f_=(Ice=globalThis.dojoConfig)!=null&&Ice.has||($ce=globalThis.esriConfig)!=null&&$ce.has?{...(Lce=globalThis.dojoConfig)==null?void 0:Lce.has,...(Dce=globalThis.esriConfig)==null?void 0:Dce.has}:{},de.add=(t,e,r,i)=>((i||f_[t]===void 0)&&(f_[t]=e),r&&de(t)),de.cache=f_,de.add("esri-deprecation-warnings",!0),(()=>{var e;de.add("host-webworker",globalThis.WorkerGlobalScope!==void 0&&self instanceof globalThis.WorkerGlobalScope);const t=typeof window<"u"&&typeof location<"u"&&typeof document<"u"&&window.location===location&&window.document===document;if(de.add("host-browser",t),de.add("host-node",typeof globalThis.process=="object"&&((e=globalThis.process.versions)==null?void 0:e.node)&&globalThis.process.versions.v8),de.add("dom",t),de("host-browser")){const r=navigator,i=r.userAgent,s=r.appVersion,n=parseFloat(s);if(de.add("wp",parseFloat(i.split("Windows Phone")[1])||void 0),de.add("msapp",parseFloat(i.split("MSAppHost/")[1])||void 0),de.add("khtml",s.includes("Konqueror")?n:void 0),de.add("edge",parseFloat(i.split("Edge/")[1])||void 0),de.add("opr",parseFloat(i.split("OPR/")[1])||void 0),de.add("webkit",!de("wp")&&!de("edge")&&parseFloat(i.split("WebKit/")[1])||void 0),de.add("chrome",!de("edge")&&!de("opr")&&parseFloat(i.split("Chrome/")[1])||void 0),de.add("android",!de("wp")&&parseFloat(i.split("Android ")[1])||void 0),de.add("safari",!s.includes("Safari")||de("wp")||de("chrome")||de("android")||de("edge")||de("opr")?void 0:parseFloat(s.split("Version/")[1])),de.add("mac",s.includes("Macintosh")),!de("wp")&&i.match(/(iPhone|iPod|iPad)/)){const o=RegExp.$1.replace(/P/,"p"),a=i.match(/OS ([\d_]+)/)?RegExp.$1:"1",l=parseFloat(a.replace(/_/,".").replace(/_/g,""));de.add(o,l),de.add("ios",l)}de("webkit")||(!i.includes("Gecko")||de("wp")||de("khtml")||de("edge")||de.add("mozilla",n),de("mozilla")&&de.add("ff",parseFloat(i.split("Firefox/")[1]||i.split("Minefield/")[1])||void 0))}})(),(()=>{if(globalThis.navigator){const t=navigator.userAgent,e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|Opera Mini|IEMobile/i.test(t),r=/iPhone/i.test(t);e&&de.add("esri-mobile",e),r&&de.add("esri-iPhone",r),de.add("esri-geolocation",!!navigator.geolocation)}de.add("esri-wasm","WebAssembly"in globalThis),de.add("esri-shared-array-buffer",()=>{const t="SharedArrayBuffer"in globalThis,e=globalThis.crossOriginIsolated===!1;return t&&!e}),de.add("wasm-simd",()=>{const t=[0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11];return WebAssembly.validate(new Uint8Array(t))}),de.add("esri-atomics","Atomics"in globalThis),de.add("esri-workers","Worker"in globalThis),de.add("web-feat:cache","caches"in globalThis),de.add("esri-workers-arraybuffer-transfer",!de("safari")||Number(de("safari"))>=12),de.add("featurelayer-simplify-thresholds",[.5,.5,.5,.5]),de.add("featurelayer-simplify-payload-size-factors",[1,1,4]),de.add("featurelayer-snapshot-enabled",!0),de.add("featurelayer-snapshot-point-min-threshold",8e4),de.add("featurelayer-snapshot-point-max-threshold",4e5),de.add("featurelayer-snapshot-point-coverage",.1),de.add("featurelayer-advanced-symbols",!1),de.add("featurelayer-pbf",!0),de.add("featurelayer-pbf-statistics",!1),de.add("feature-layers-workers",!0),de.add("feature-polyline-generalization-factor",1),de.add("mapview-transitions-duration",200),de.add("mapview-srswitch-adjust-rotation-scale-threshold",24e6),de.add("mapserver-pbf-version-support",10.81),de.add("mapservice-popup-identify-max-tolerance",20),de.add("heatmap-allow-raster-fallback",!0),de.add("heatmap-force-raster",!1),de("host-webworker")||de("host-browser")&&(de.add("esri-csp-restrictions",()=>{try{new Function}catch{return!0}return!1}),de.add("esri-image-decode",()=>{if("decode"in new Image){const t=new Image;return t.src='data:image/svg+xml;charset=UTF-8,<svg version="1.1" xmlns="http://www.w3.org/2000/svg"></svg>',void t.decode().then(()=>{de.add("esri-image-decode",!0,!0,!0)}).catch(()=>{de.add("esri-image-decode",!1,!0,!0)})}return!1}),de.add("esri-url-encodes-apostrophe",()=>{const t=window.document.createElement("a");return t.href="?'",t.href.includes("?%27")}))})();function Kce(t,e,r=!1){return eue(t,e,r)}function HO(t,e){if(e!=null)return e[t]||Qce(t.split("."),!1,e)}function el(t,e,r){const i=t.split("."),s=i.pop(),n=Qce(i,!0,r);n&&s&&(n[s]=e)}function Qce(t,e,r){let i=r;for(const s of t){if(i==null)return;if(!(s in i)){if(!e)return;i[s]={}}i=i[s]}return i}function eue(t,e,r){return e?Object.keys(e).reduce((i,s)=>{let n=i[s],o=e[s];return n===o?i:n===void 0?(i[s]=ne(o),i):(Array.isArray(o)||Array.isArray(i)?(n=n?Array.isArray(n)?i[s]=n.concat():i[s]=[n]:i[s]=[],o&&(Array.isArray(o)||(o=[o]),r?o.forEach(a=>{n.includes(a)||n.push(a)}):i[s]=o.concat())):o&&typeof o=="object"?i[s]=eue(n,o,r):i.hasOwnProperty(s)&&!e.hasOwnProperty(s)||(i[s]=o),i)},t||{}):t}var Nce;const Yr={analysisTheme:{accentColor:[255,128,0],textColor:"white"},apiKey:void 0,applicationUrl:(Nce=globalThis.location)==null?void 0:Nce.href,assetsPath:"",fontsUrl:"https://static.arcgis.com/fonts",geometryServiceUrl:"https://utility.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer",geoRSSServiceUrl:"https://utility.arcgis.com/sharing/rss",kmlServiceUrl:"https://utility.arcgis.com/sharing/kml",userPrivilegesApplied:!1,portalUrl:"https://www.arcgis.com",routeServiceUrl:"https://route-api.arcgis.com/arcgis/rest/services/World/Route/NAServer/Route_World",workers:{loaderConfig:{has:{},paths:{},map:{},packages:[]}},request:{crossOriginNoCorsDomains:null,httpsDomains:["arcgis.com","arcgisonline.com","esrikr.com","premiumservices.blackbridge.com","esripremium.accuweather.com","gbm.digitalglobe.com","firstlook.digitalglobe.com","msi.digitalglobe.com"],interceptors:[],maxUrlLength:2e3,priority:"high",proxyRules:[],proxyUrl:null,timeout:6e4,trustedServers:[],useIdentity:!0},log:{interceptors:[],level:null}};if(globalThis.esriConfig&&(Kce(Yr,globalThis.esriConfig,!0),delete Yr.has),!Yr.assetsPath){{const t="4.26.5";Yr.assetsPath=`https://js.arcgis.com/${t.slice(0,-2)}/@arcgis/core/assets`}Yr.defaultAssetsPath=Yr.assetsPath}const LAe=/\{([^\}]+)\}/g;function NJ(t){return t??""}function tm(t,e){return t.replace(LAe,typeof e=="object"?(r,i)=>NJ(HO(i,e)):(r,i)=>NJ(e(i)))}function xbt(t,e){return t.replace(/([\.$?*|{}\(\)\[\]\\\/\+\-^])/g,r=>e&&e.includes(r)?r:`\\${r}`)}function qH(t){let e=0;for(let r=0;r<t.length;r++)e=(e<<5)-e+t.charCodeAt(r),e|=0;return e}function Tbt(t){return new DOMParser().parseFromString(t||"","text/html").body.innerText||""}const FJ={info:0,warn:1,error:2,none:3};let se=class La{constructor(e){this.level=null,this._module="",this._parent=null,this.writer=null,this._loggedMessages={error:new Map,warn:new Map,info:new Map},e.level!=null&&(this.level=e.level),e.writer!=null&&(this.writer=e.writer),this._module=e.module,La._loggers[this.module]=this;const r=this.module.lastIndexOf(".");r!==-1&&(this._parent=La.getLogger(this.module.slice(0,r)))}get module(){return this._module}get parent(){return this._parent}error(...e){this._log("error","always",...e)}warn(...e){this._log("warn","always",...e)}info(...e){this._log("info","always",...e)}errorOnce(...e){this._log("error","once",...e)}warnOnce(...e){this._log("warn","once",...e)}infoOnce(...e){this._log("info","once",...e)}errorOncePerTick(...e){this._log("error","oncePerTick",...e)}warnOncePerTick(...e){this._log("warn","oncePerTick",...e)}infoOncePerTick(...e){this._log("info","oncePerTick",...e)}get test(){const e=this;return{loggedMessages:e._loggedMessages,clearLoggedWarnings:()=>e._loggedMessages.warn.clear()}}static get testSingleton(){return{resetLoggers(e={}){const r=La._loggers;return La._loggers=e,r},set throttlingDisabled(e){La._throttlingDisabled=e}}}static getLogger(e){let r=La._loggers[e];return r||(r=new La({module:e})),r}_log(e,r,...i){if(this._matchLevel(e)){if(r!=="always"&&!La._throttlingDisabled){const s=this._argsToKey(i),n=this._loggedMessages[e].get(s);if(r==="once"&&n!=null||r==="oncePerTick"&&n&&n>=La._tickCounter)return;this._loggedMessages[e].set(s,La._tickCounter),La._scheduleTickCounterIncrement()}for(const s of Yr.log.interceptors)if(s(e,this.module,...i))return;this._inheritedWriter()(e,this.module,...i)}}_parentWithMember(e,r){let i=this;for(;v(i);){const s=i[e];if(v(s))return s;i=i.parent}return r}_inheritedWriter(){return this._parentWithMember("writer",this._consoleWriter)}_consoleWriter(e,r,...i){console[e](`[${r}]`,...i)}_matchLevel(e){const r=Yr.log.level?Yr.log.level:"warn";return FJ[this._parentWithMember("level",r)]<=FJ[e]}_argsToKey(...e){return qH(JSON.stringify(e,(i,s)=>typeof s!="object"||Array.isArray(s)?s:"[Object]"))}static _scheduleTickCounterIncrement(){La._tickCounterScheduled||(La._tickCounterScheduled=!0,Promise.resolve().then(()=>{La._tickCounter++,La._tickCounterScheduled=!1}))}};se._loggers={},se._tickCounter=0,se._tickCounterScheduled=!1,se._throttlingDisabled=!1;var Ag;(function(t){t[t.INITIALIZING=0]="INITIALIZING",t[t.CONSTRUCTING=1]="CONSTRUCTING",t[t.CONSTRUCTED=2]="CONSTRUCTED"})(Ag||(Ag={}));let DAe=class{constructor(e,r){this._observers=e,this._observer=r}remove(){kH(this._observers,this._observer)}},tue=class{constructor(){this._observers=null,this.destroyed=!1}observe(e){if(this.destroyed||e.destroyed)return NAe;this._observers==null&&(this._observers=[]);const r=this._observers;let i=!1,s=!1;const n=r.length;for(let o=0;o<n;++o){const a=r[o];if(a.destroyed)s=!0;else if(a===e){i=!0;break}}return i||(r.push(e),s&&this._removeDestroyedObservers()),new DAe(r,e)}_removeDestroyedObservers(){const e=this._observers;if(!e||e.length===0)return;const r=e.length;let i=0;for(let s=0;s<r;++s){for(;s+i<r&&e[s+i].destroyed;)++i;if(i>0){if(!(s+i<r))break;e[s]=e[s+i]}}e.length=r-i}destroy(){if(this.destroyed)return;this.destroyed=!0;const e=this._observers;if(e!=null){for(const r of e)r.onCommitted();this._observers=null}}};const NAe={remove:()=>{}};var Gr;(function(t){t[t.DEFAULTS=0]="DEFAULTS",t[t.COMPUTED=1]="COMPUTED",t[t.SERVICE=2]="SERVICE",t[t.PORTAL_ITEM=3]="PORTAL_ITEM",t[t.WEB_SCENE=4]="WEB_SCENE",t[t.WEB_MAP=5]="WEB_MAP",t[t.USER=6]="USER"})(Gr||(Gr={}));const Fk=Gr.USER+1;function m_(t){switch(t){case"defaults":return Gr.DEFAULTS;case"service":return Gr.SERVICE;case"portal-item":return Gr.PORTAL_ITEM;case"web-scene":return Gr.WEB_SCENE;case"web-map":return Gr.WEB_MAP;case"user":return Gr.USER;default:return null}}function UD(t){switch(t){case Gr.DEFAULTS:return"defaults";case Gr.SERVICE:return"service";case Gr.PORTAL_ITEM:return"portal-item";case Gr.WEB_SCENE:return"web-scene";case Gr.WEB_MAP:return"web-map";case Gr.USER:return"user"}return void 0}function FAe(t){return UD(t)}var $i;(function(t){t[t.Dirty=1]="Dirty",t[t.Overriden=2]="Overriden",t[t.Computing=4]="Computing",t[t.NonNullable=8]="NonNullable",t[t.HasDefaultValue=16]="HasDefaultValue",t[t.DepTrackingInitialized=32]="DepTrackingInitialized",t[t.AutoTracked=64]="AutoTracked",t[t.ExplicitlyTracking=128]="ExplicitlyTracking"})($i||($i={}));const kD={onObservableAccessed:()=>{},onTrackingEnd:()=>{}},cA=[];let D3=kD;function br(t){D3.onObservableAccessed(t)}let B$=!1,z$=!1;function Yg(t,e,r){if(B$)return WH(t,e,r);rue(t);const i=e.call(r);return iue(),i}function UAe(t,e){return Yg(kD,t,e)}function WH(t,e,r){const i=B$;B$=!0,rue(t);let s=null;try{s=e.call(r)}catch(n){z$&&se.getLogger("esri.core.accessorSupport.tracking").error(n)}return iue(),B$=i,s}function rue(t){D3=t,cA.push(t)}function iue(){const t=cA.length;if(t>1){const e=cA.pop();D3=cA[t-2],e.onTrackingEnd()}else if(t===1){const e=cA.pop();D3=kD,e.onTrackingEnd()}else D3=kD}function sue(t,e){const r=e.observerObject;if(r.flags&$i.DepTrackingInitialized)return;const i=z$;z$=!1,r.flags&$i.AutoTracked?WH(e,e.metadata.get,t):nue(t,e),z$=i}const kAe=[];function nue(t,e){const r=e.observerObject;r.flags&$i.ExplicitlyTracking||(r.flags|=$i.ExplicitlyTracking,WH(e,()=>{const i=e.metadata.dependsOn||kAe;for(const s of i)if(typeof s!="string"||s.includes(".")){const n=Xce(s);for(let o=0,a=t;o<n.length&&a!=null&&typeof a=="object";++o)a=UJ(a,n[o],o!==n.length-1)}else UJ(t,s,!1)}),r.flags&=~$i.ExplicitlyTracking)}function UJ(t,e,r){var n;const i=e[e.length-1]==="?"?e.slice(0,-1):e;if(t.getItemAt!=null||Array.isArray(t)){const o=parseInt(i,10);if(!isNaN(o))return Array.isArray(t)?t[o]:t.getItemAt(o)}const s=(n=Qa(t))==null?void 0:n.properties.get(i);return s&&(br(s.observerObject),sue(t,s)),r?t[i]:void 0}let kJ=class{constructor(e,r,i){this.properties=e,this.propertyName=r,this.metadata=i,this.observerObject=new VAe,this._accessed=null,this._handles=null,this.observerObject.flags=$i.Dirty|(i.nonNullable?$i.NonNullable:0)|(i.hasOwnProperty("value")?$i.HasDefaultValue:0)|(i.get===void 0?$i.DepTrackingInitialized:0)|(i.dependsOn===void 0?$i.AutoTracked:0),VJ.register(this,this.observerObject)}destroy(){this.observerObject.destroy(),this._accessed=null,this._clearObservationHandles(),VJ.unregister(this)}getComputed(){const e=this.observerObject;br(e);const r=this.properties.store,i=this.propertyName,s=e.flags,n=r.get(i);if(s&$i.Computing||~s&$i.Dirty&&r.has(i))return n;e.flags|=$i.Computing;const o=this.properties.host;let a;s&$i.AutoTracked?a=Yg(this,this.metadata.get,o):(nue(o,this),a=this.metadata.get.call(o)),r.set(i,a,Gr.COMPUTED);const l=r.get(i);return l===n?e.flags&=~$i.Dirty:UAe(this.commit,this),e.flags&=~$i.Computing,l}onObservableAccessed(e){e!==this.observerObject&&(this._accessed===null&&(this._accessed=[]),this._accessed.includes(e)||this._accessed.push(e))}onTrackingEnd(){this._clearObservationHandles();const e=this.observerObject;e.flags|=$i.DepTrackingInitialized;const r=this._accessed;if(r===null)return;let i=this._handles;i===null&&(i=this._handles=[]);for(let s=0;s<r.length;++s)i.push(r[s].observe(e));r.length=0}notifyChange(){const e=this.observerObject;e.onInvalidated(),e.onCommitted()}invalidate(){this.observerObject.onInvalidated()}commit(){const e=this.observerObject;e.flags&=~$i.Dirty,e.onCommitted()}_clearObservationHandles(){const e=this._handles;if(e!==null){for(let r=0;r<e.length;++r)e[r].remove();e.length=0}}},VAe=class extends tue{constructor(){super(...arguments),this.flags=0}onInvalidated(){~this.flags&$i.Overriden&&(this.flags|=$i.Dirty);const e=this._observers;if(e&&e.length>0)for(const r of e)r.onInvalidated()}onCommitted(){const e=this._observers;if(e&&e.length>0){const r=e.slice();for(const i of r)i.onCommitted()}}destroy(){this.flags&$i.Dirty&&this.onCommitted(),super.destroy()}};const VJ=new FinalizationRegistry(t=>{t.destroy()});let BAe=class oue{constructor(){this._values=new Map,this.multipleOriginsSupported=!1}clone(e){const r=new oue;return this._values.forEach((i,s)=>{e&&e.has(s)||r.set(s,ne(i))}),r}get(e){return this._values.get(e)}originOf(){return Gr.USER}keys(){return[...this._values.keys()]}set(e,r){this._values.set(e,r)}delete(e){this._values.delete(e)}has(e){return this._values.has(e)}forEach(e){this._values.forEach(e)}};function WM(t,e,r){return t!==void 0}function BJ(t,e,r,i){return t!==void 0&&(!(r==null&&t.observerObject.flags&$i.NonNullable)||(i.lifecycle,Ag.INITIALIZING,!1))}function zAe(t){return t&&typeof t.destroy=="function"}se.getLogger("esri.core.accessorSupport.Properties");let GAe=class{constructor(e){this.host=e,this.properties=new Map,this.ctorArgs=null,this.destroyed=!1,this.lifecycle=Ag.INITIALIZING,this.store=new BAe,this._origin=Gr.USER;const r=this.host.constructor.__accessorMetadata__;for(const i in r){const s=new kJ(this,i,r[i]);this.properties.set(i,s)}this.metadatas=r}initialize(){this.lifecycle=Ag.CONSTRUCTING}constructed(){this.lifecycle=Ag.CONSTRUCTED}destroy(){this.destroyed=!0;for(const[e,r]of this.properties){if(r.metadata.autoDestroy){const i=this.internalGet(e);i&&zAe(i)&&(i.destroy(),~r.observerObject.flags&$i.NonNullable&&this._internalSet(r,null))}r.destroy()}}get initialized(){return this.lifecycle!==Ag.INITIALIZING}get(e){const r=this.properties.get(e);if(r.metadata.get)return r.getComputed();br(r.observerObject);const i=this.store;return i.has(e)?i.get(e):r.metadata.value}originOf(e){const r=this.store.originOf(e);if(r===void 0){const i=this.properties.get(e);if(i!==void 0&&i.observerObject.flags&$i.HasDefaultValue)return"defaults"}return UD(r)}has(e){return!!this.properties.has(e)&&this.store.has(e)}keys(){return[...this.properties.keys()]}internalGet(e){const r=this.properties.get(e);if(WM(r))return this.store.has(e)?this.store.get(e):r.metadata.value}internalSet(e,r){const i=this.properties.get(e);WM(i)&&this._internalSet(i,r)}getDependsInfo(e,r,i){const s=this.properties.get(r);if(!WM(s))return"";const n=new Set,o=Yg({onObservableAccessed:l=>n.add(l),onTrackingEnd:()=>{}},()=>{var l;return(l=s.metadata.get)==null?void 0:l.call(e)});let a=`${i}${e.declaredClass.split(".").pop()}.${r}: ${o}
`;if(n.size===0)return a;i+="  ";for(const l of n){if(!(l instanceof kJ))continue;const c=l.properties.host,h=l.propertyName,p=Qa(c);a+=p?p.getDependsInfo(c,h,i):`${i}${h}: undefined
`}return a}setAtOrigin(e,r,i){const s=this.properties.get(e);if(WM(s))return this._setAtOrigin(s,r,i)}isOverridden(e){const r=this.properties.get(e);return r!==void 0&&!!(r.observerObject.flags&$i.Overriden)}clearOverride(e){const r=this.properties.get(e),i=r==null?void 0:r.observerObject;i&&i.flags&$i.Overriden&&(i.flags&=~$i.Overriden,r.notifyChange())}override(e,r){const i=this.properties.get(e);if(!BJ(i,e,r,this))return;const s=i.metadata.cast;if(s){const n=this._cast(s,r),{valid:o,value:a}=n;if(x6.release(n),!o)return;r=a}i.observerObject.flags|=$i.Overriden,this._internalSet(i,r)}set(e,r){const i=this.properties.get(e);if(!BJ(i,e,r,this))return;const s=i.metadata.cast;if(s){const o=this._cast(s,r),{valid:a,value:l}=o;if(x6.release(o),!a)return;r=l}const n=i.metadata.set;n?n.call(this.host,r):this._internalSet(i,r)}setDefaultOrigin(e){this._origin=m_(e)}getDefaultOrigin(){return UD(this._origin)}notifyChange(e){const r=this.properties.get(e);r!==void 0&&r.notifyChange()}invalidate(e){const r=this.properties.get(e);r!==void 0&&r.invalidate()}commit(e){const r=this.properties.get(e);r!==void 0&&r.commit()}_internalSet(e,r){const i=this.lifecycle!==Ag.INITIALIZING?this._origin:Gr.DEFAULTS;this._setAtOrigin(e,r,i)}_setAtOrigin(e,r,i){const s=this.store,n=e.propertyName;s.has(n,i)&&jH(r,s.get(n))&&~e.observerObject.flags&$i.Overriden&&i===s.originOf(n)||(e.invalidate(),s.set(n,r,i),e.commit(),sue(this.host,e))}_cast(e,r){const i=x6.acquire();return i.valid=!0,i.value=r,e&&(i.value=e.call(this.host,r,i)),i}},jAe=class{constructor(){this.value=null,this.valid=!0}acquire(){this.valid=!0}release(){this.value=null}};const x6=new Co(jAe);function HAe(t,e){return t.replace(/\$\{([^\s\:\}]*)(?:\:([^\s\:\}]+))?\}/g,(r,i)=>{if(i==="")return"$";const s=HO(i,e),n=s??"";if(n===void 0)throw new Error(`could not find key "${i}" in template`);return n.toString()})}let aue=class lue{constructor(e,r,i){this.name=e,this.details=i,this instanceof lue&&(this.message=(r&&HAe(r,i))??"")}toString(){return"["+this.name+"]: "+this.message}},q=class G$ extends aue{constructor(e,r,i){if(super(e,r,i),!(this instanceof G$))return new G$(e,r,i)}toJSON(){if(this.details!=null)try{return{name:this.name,message:this.message,details:JSON.parse(JSON.stringify(this.details,(e,r)=>{if(r&&typeof r=="object"&&typeof r.toJSON=="function")return r;try{return ne(r)}catch{return"[object]"}}))}}catch(e){throw se.getLogger("esri.core.Error").error(e),e}return{name:this.name,message:this.message,details:this.details}}static fromJSON(e){return new G$(e.name,e.message,e.details)}};q.prototype.type="error";function VD(t,e,r){if(t&&e)if(typeof e=="object")for(const i of Object.getOwnPropertyNames(e))VD(t,i,e[i]);else{if(e.includes(".")){const s=e.split("."),n=s.splice(s.length-1,1)[0];return void VD(FD(t,s),n,r)}const i=t.__accessor__;i!=null&&qAe(e,i),t[e]=r}}function qAe(t,e){if(de("esri-unknown-property-errors")&&!WAe(t,e))throw new q("set:unknown-property",XAe(t,e))}function WAe(t,e){return e.metadatas[t]!=null}function XAe(t,e){return"setting unknown property '"+t+"' on instance of "+e.host.declaredClass}let cue=class extends Co{constructor(){super(...arguments),this._set=new Set}destroy(){super.destroy(),this._set=sw(this._set)}acquire(...e){const r=super.acquire(...e);return this._set.delete(r),r}release(e){e&&!this._set.has(e)&&(super.release(e),this._set.add(e))}_dispose(e){this._set.delete(e),super._dispose(e)}};const XM=[];function _S(t){XM.push(t),XM.length===1&&queueMicrotask(()=>{const e=XM.slice();XM.length=0;for(const r of e)r()})}let Ig=class{constructor(e,r=30){this.name=e,this._counter=0,this._samples=new Array(r)}record(e){v(e)&&(this._samples[++this._counter%this._samples.length]=e)}get median(){return this._samples.slice().sort((e,r)=>e-r)[Math.floor(this._samples.length/2)]}get average(){return this._samples.reduce((e,r)=>e+r,0)/this._samples.length}get last(){return this._samples[this._counter%this._samples.length]}};var Uk;(function(t){const e=(n,o,a,l)=>{let c=o,h=o;const p=a>>>1,f=n[c-1];for(;h<=p;){h=c<<1,h<a&&l(n[h-1],n[h])<0&&++h;const m=n[h-1];if(l(m,f)<=0)break;n[c-1]=m,c=h}n[c-1]=f},r=(n,o)=>n<o?-1:n>o?1:0;function i(n,o,a,l){o===void 0&&(o=0),a===void 0&&(a=n.length),l===void 0&&(l=r);for(let h=a>>>1;h>o;h--)e(n,h,a,l);const c=o+1;for(let h=a-1;h>o;h--){const p=n[o];n[o]=n[h],n[h]=p,e(n,c,h,l)}}function*s(n,o,a,l){o===void 0&&(o=0),a===void 0&&(a=n.length),l===void 0&&(l=r);for(let h=a>>>1;h>o;h--)e(n,h,a,l),yield;const c=o+1;for(let h=a-1;h>o;h--){const p=n[o];n[o]=n[h],n[h]=p,e(n,c,h,l),yield}}t.sort=i,t.iterableSort=s})(Uk||(Uk={}));const zJ=Uk,YAe=1.5,ZAe=1.1;let Jt=class{constructor(e){this.data=[],this._length=0,this._allocator=void 0,this._deallocator=()=>null,this._shrink=()=>{},this._hint=new Bce,e&&(e.initialSize&&(this.data=new Array(e.initialSize)),e.allocator&&(this._allocator=e.allocator),e.deallocator!==void 0&&(this._deallocator=e.deallocator),e.shrink&&(this._shrink=()=>GJ(this)))}toArray(){return this.data.slice(0,this.length)}filter(e){const r=new Array;for(let i=0;i<this._length;i++){const s=this.data[i];e(s)&&r.push(s)}return r}getItemAt(e){if(!(e<0||e>=this._length))return this.data[e]}includes(e,r){const i=this.data.indexOf(e,r);return i!==-1&&i<this.length}get length(){return this._length}set length(e){if(e>this._length){if(this._allocator){for(;this._length<e;)this.data[this._length++]=this._allocator(this.data[this._length]);return}this._length=e}else{if(this._deallocator)for(let r=e;r<this._length;++r)this.data[r]=this._deallocator(this.data[r]);this._length=e,this._shrink()}}clear(){this.length=0}prune(){this.clear(),this.data=[]}push(e){this.data[this._length++]=e}pushArray(e,r=e.length){for(let i=0;i<r;i++)this.data[this._length++]=e[i]}fill(e,r){for(let i=0;i<r;i++)this.data[this._length++]=e}pushNew(){this._allocator&&(this.data[this.length]=this._allocator(this.data[this.length]));const e=this.data[this._length];return++this._length,e}unshift(e){this.data.unshift(e),this._length++,GJ(this)}pop(){if(this.length===0)return;const e=this.data[this.length-1];return this.length=this.length-1,this._shrink(),e}remove(e){const r=Dk(this.data,e,this.length,this._hint);if(r!==-1)return this.data.splice(r,1),this.length=this.length-1,e}removeUnordered(e){return this.removeUnorderedIndex(Dk(this.data,e,this.length,this._hint))}removeUnorderedIndex(e){if(!(e>=this.length||e<0))return this.swapElements(e,this.length-1),this.pop()}removeUnorderedMany(e,r=e.length,i){this.length=_Ae(this.data,e,this.length,r,this._hint,i),this._shrink()}front(){if(this.length!==0)return this.data[0]}back(){if(this.length!==0)return this.data[this.length-1]}swapElements(e,r){if(e>=this.length||r>=this.length||e===r)return;const i=this.data[e];this.data[e]=this.data[r],this.data[r]=i}sort(e){zJ.sort(this.data,0,this.length,e)}iterableSort(e){return zJ.iterableSort(this.data,0,this.length,e)}some(e,r){for(let i=0;i<this.length;++i)if(e.call(r,this.data[i],i,this.data))return!0;return!1}find(e,r){for(let i=0;i<this.length;++i){const s=this.data[i];if(e.call(r,s,i))return s}}filterInPlace(e,r){let i=0;for(let s=0;s<this._length;++s){const n=this.data[s];e.call(r,n,s,this.data)&&(this.data[s]=this.data[i],this.data[i]=n,i++)}if(this._deallocator)for(let s=i;s<this._length;s++)this.data[s]=this._deallocator(this.data[s]);return this._length=i,this._shrink(),this}forAll(e,r){const i=this.length,s=this.data;for(let n=0;n<i;++n)e.call(r,s[n],n,s)}forEach(e,r){for(let i=0;i<this.length;++i)e.call(r,this.data[i],i,this.data)}map(e,r){const i=new Array(this.length);for(let s=0;s<this.length;++s)i[s]=e.call(r,this.data[s],s,this.data);return i}reduce(e,r){let i=r;for(let s=0;s<this.length;++s)i=e(i,this.data[s],s,this.data);return i}has(e){const r=this.length,i=this.data;for(let s=0;s<r;++s)if(i[s]===e)return!0;return!1}};function GJ(t){t.data.length>YAe*t.length&&(t.data.length=Math.floor(t.length*ZAe))}function JAe(t){return{setTimeout:(e,r)=>{const i=t.setTimeout(e,r);return{remove:()=>t.clearTimeout(i)}}}}const r4=JAe(globalThis),jJ=new Set;function KAe(t,e,r=!1){r&&jJ.has(e)||(r&&jJ.add(e),t.warn(`🛑 DEPRECATED - ${e}`))}function kk(t,e,r={}){if(de("esri-deprecation-warnings")){const{moduleName:i}=r;uue(t,`Property: ${(i?i+"::":"")+e}`,r)}}function uue(t,e,r={}){if(de("esri-deprecation-warnings")){const{replacement:i,version:s,see:n,warnOnce:o}=r;let a=e;i&&(a+=`
	🛠️ Replacement: ${i}`),s&&(a+=`
	⚙️ Version: ${s}`),n&&(a+=`
	🔗 See ${n} for more details.`),KAe(t,a,o)}}function i4(t){return t&&(typeof t.on=="function"||typeof t.addEventListener=="function")}function qO(t,e,r){if(!i4(t))throw new TypeError("target is not a Evented or EventTarget object");if("on"in t)return t.on(e,r);if(Array.isArray(e)){const i=e.slice();for(const s of i)t.addEventListener(s,r);return{remove(){for(const s of i)t.removeEventListener(s,r)}}}return t.addEventListener(e,r),{remove(){t.removeEventListener(e,r)}}}function hue(t,e,r){if(!i4(t))throw new TypeError("target is not a Evented or EventTarget object");if("once"in t)return t.once(e,r);const i=qO(t,e,s=>{i.remove(),r.call(t,s)});return{remove(){i.remove()}}}const QAe={Win:"Meta",Scroll:"ScrollLock",Spacebar:" ",Down:"ArrowDown",Left:"ArrowLeft",Right:"ArrowRight",Up:"ArrowUp",Del:"Delete",Apps:"ContextMenu",Esc:"Escape",Multiply:"*",Add:"+",Subtract:"-",Decimal:".",Divide:"/"};function fb({key:t}){return QAe[t]||t}function Hr(t="Aborted"){return new q("AbortError",t)}function fr(t,e="Aborted"){if(Ln(t))throw Hr(e)}function s4(t){return v(t)?"aborted"in t?t:t.signal:t}function Ln(t){const e=s4(t);return v(e)&&e.aborted}function xc(t){if(Qs(t))throw t}function Vk(t){if(!Qs(t))throw t}function fa(t,e){const r=s4(t);if(!C(r)){if(!r.aborted)return hue(r,"abort",()=>e());e()}}function XH(t,e){const r=s4(t);if(!C(r))return fr(r),hue(r,"abort",()=>e(Hr()))}function YH(t,e){const r=s4(e);return C(r)?t:new Promise((i,s)=>{let n=fa(e,()=>s(Hr()));const o=()=>n=ji(n);t.then(o,o),t.then(i,s)})}function Qs(t){return(t==null?void 0:t.name)==="AbortError"}async function k2(t){try{return await t}catch(e){if(!Qs(e))throw e;return}}async function $bt(t,e=se.getLogger("esri")){try{return await t}catch(r){Qs(r)||e.error(r)}}function j_(){let t=null;const e=new Promise((r,i)=>{t={promise:void 0,resolve:r,reject:i}});return t.promise=e,t}async function jl(t){if(!t)return;if(typeof t.forEach!="function"){const r=Object.keys(t),i=r.map(o=>t[o]),s=await jl(i),n={};return r.map((o,a)=>n[o]=s[a]),n}const e=t;return new Promise(r=>{const i=[];let s=e.length;s===0&&r(i),e.forEach(n=>{const o={promise:n||Promise.resolve(n)};i.push(o),o.promise.then(a=>{o.value=a}).catch(a=>{o.error=a}).then(()=>{--s,s===0&&r(i)})})})}async function Bk(t){return(await jl(t)).filter(e=>!!e.value).map(e=>e.value)}function nw(t,e,r){const i=new AbortController;return fa(r,()=>i.abort()),new Promise((s,n)=>{let o=setTimeout(()=>{o=0,s(e)},t);fa(i,()=>{o&&(clearTimeout(o),n(Hr()))})})}function Uu(t){return t&&typeof t.then=="function"}function zk(t){return Uu(t)?t:Promise.resolve(t)}function due(t,e=-1){let r,i,s,n,o=null;const a=(...l)=>{if(r){i=l,n&&n.reject(Hr()),n=j_();const f=n.promise;if(o){const m=o;o=null,m.abort()}return f}if(s=n||j_(),n=null,e>0){const f=new AbortController;r=zk(t(...l,f.signal));const m=r;nw(e).then(()=>{r===m&&(n?f.abort():o=f)})}else r=1,r=zk(t(...l));const c=()=>{const f=i;i=s=r=o=null,f!=null&&a(...f)},h=r,p=s;return h.then(c,c),h.then(p.resolve,p.reject),p.promise};return a}function H_(){let t,e;const r=new Promise((s,n)=>{t=s,e=n}),i=s=>{t(s)};return i.resolve=s=>t(s),i.reject=s=>e(s),i.timeout=(s,n)=>r4.setTimeout(()=>i.reject(n),s),i.promise=r,i}function Lbt(t,e){return t.then(e,e)}async function HJ(t){await Promise.resolve(),fr(t)}function Dbt(t){return t}function pue(t){return 1e3*t}function ZH(t){return .001*t}let e3e=class{constructor(e){this.phases=e,this.paused=!1,this.ticks=-1,this.removed=!1}},t3e=class{constructor(e){this.callback=e,this.isActive=!0}remove(){this.isActive=!1}},Gk=0,jk=0;const KE={time:0,deltaTime:0,elapsedFrameTime:0,frameDuration:0},Hk=["prepare","preRender","render","postRender","update","finish"],qk=[],ow=new Jt;let r3e=class{constructor(e){this._task=e}remove(){this._task.removed=!0}pause(){this._task.paused=!0}resume(){this._task.paused=!1}};const BD={frameTasks:ow,willDispatch:!1,clearFrameTasks:i3e,dispatch:gue,executeFrameTasks:n3e};function gE(t){const e=new t3e(t);return qk.push(e),BD.willDispatch||(BD.willDispatch=!0,_S(gue)),e}function vS(t){const e=new e3e(t);return ow.push(e),zD==null&&(Gk=performance.now(),zD=requestAnimationFrame(fue)),new r3e(e)}let zD=null;function i3e(t=!1){ow.forAll(e=>{e.removed=!0}),t&&mue()}function s3e(t){jk=Math.max(0,t)}function fue(){const t=performance.now();zD=null,zD=ow.length>0?requestAnimationFrame(fue):null,BD.executeFrameTasks(t)}function n3e(t){const e=t-Gk;Gk=t;const r=jk>0?jk:1e3/60,i=Math.max(0,e-r);KE.time=t,KE.frameDuration=r-i;for(let s=0;s<Hk.length;s++){const n=performance.now(),o=Hk[s];ow.forAll(a=>{var l;a.paused||a.removed||(s===0&&a.ticks++,a.phases[o]&&(KE.elapsedFrameTime=performance.now()-t,KE.deltaTime=a.ticks===0?0:e,(l=a.phases[o])==null||l.call(a,KE)))}),o3e[s].record(performance.now()-n)}mue(),a3e.record(performance.now()-t)}const YM=new Jt;function mue(){ow.forAll(t=>{t.removed&&YM.push(t)}),ow.removeUnorderedMany(YM.data,YM.length),YM.clear()}function gue(){for(;qk.length;){const t=qk.shift();t.isActive&&t.callback()}BD.willDispatch=!1}function kbt(t=1,e){const r=H_(),i=()=>{Ln(e)?r.reject(Hr()):t===0?r():(--t,_S(()=>i()))};return i(),r.promise}const o3e=Hk.map(t=>new Ig(t)),a3e=new Ig("total");function j$(t,e){for(const r of t.entries())if(e(r[0]))return!0;return!1}let l3e=0;const c3e=0;function Pc(){return++l3e}let n4=class{constructor(e){this._notify=e,this._accessed=[],this._handles=[],this._observerObject=new u3e(this._notify),qJ.register(this,this._observerObject)}destroy(){var e;this._accessed.length=0,(e=this._observerObject)==null||e.destroy(),this.clear(),qJ.unregister(this)}onObservableAccessed(e){const r=this._accessed;r.includes(e)||r.push(e)}onTrackingEnd(){const e=this._handles,r=this._accessed,i=this._observerObject;for(let s=0;s<r.length;++s)e.push(r[s].observe(i));r.length=0}clear(){const e=this._handles;for(let r=0;r<e.length;++r)e[r].remove();e.length=0}},u3e=class{constructor(e){this._notify=e,this._invalidCount=0,this.destroyed=!1}onInvalidated(){this._invalidCount++}onCommitted(){if(this.destroyed)return;const e=this._invalidCount;if(e===1)return this._invalidCount=0,void this._notify();this._invalidCount=e>0?e-1:0}destroy(){this.destroyed=!0,this._notify=h3e}};const qJ=new FinalizationRegistry(t=>{t.destroy()});function h3e(){}let V2=!1;const GD=[];function yue(t,e){let r=new n4(n),i=null,s=!1;function n(){if(!r||s)return;if(V2)return void bue(n);const a=i;r.clear(),V2=!0,s=!0,i=Yg(r,t),s=!1,V2=!1,e(i,a),wue()}function o(){r&&(r.destroy(),r=null,i=null)}return s=!0,i=Yg(r,t),s=!1,{remove:o}}function _ue(t,e){let r=new n4(s),i=null;function s(){e(i,o)}function n(){r&&(r.destroy(),r=null),i=null}function o(){return r?(r.clear(),i=Yg(r,t),i):null}return o(),{remove:n}}function vue(t){let e=new n4(i),r=!1;function i(){e&&!r&&(V2?bue(i):(e.clear(),V2=!0,r=!0,Yg(e,t),r=!1,V2=!1,wue()))}function s(){e&&(e.destroy(),e=null)}return r=!0,Yg(e,t),r=!1,{remove:s}}function bue(t){GD.includes(t)||GD.unshift(t)}function wue(){for(;GD.length;)GD.pop()()}var N3;(function(t){t[t.Untracked=0]="Untracked",t[t.Tracked=1]="Tracked"})(N3||(N3={}));let IR=class{constructor(){this.uid=Pc(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}static acquireUntracked(e,r,i,s,n){return this.pool.acquire(N3.Untracked,e,r,i,s,n,jH)}static acquireTracked(e,r,i,s){return this.pool.acquire(N3.Tracked,e,r,i,null,null,s)}notify(e,r){this.type===N3.Untracked?this.callback.call(this.target,e,r,this.path,this.target):this.callback.call(null,e,r)}acquire(e,r,i,s,n,o,a){this.uid=Pc(),this.removed=!1,this.type=e,this.oldValue=r,this.callback=i,this.getValue=s,this.target=n,this.path=o,this.equals=a}release(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=Pc(),this.removed=!0}};IR.pool=new cue(IR);const H$=new wc,Ng=new Set;let jD;function HD(t){Ng.delete(t),Ng.add(t),jD||(jD=gE(f3e))}function d3e(t){if(t.removed)return;const e=t.oldValue,r=t.getValue();t.equals(e,r)||(t.oldValue=r,t.notify(r,e))}function p3e(t){for(const e of Ng.values())e.target===t&&(e.removed=!0)}function f3e(){let t=10;for(;jD&&t--;){jD=null;const e=m3e(),r=H$.acquire();for(const i of e){const s=i.uid;d3e(i),s===i.uid&&i.removed&&r.push(i)}for(const i of Ng)i.removed&&(r.push(i),Ng.delete(i));for(const i of r)IR.pool.release(i);H$.release(r),H$.release(e),Wk.forEach(i=>i())}}function m3e(){const t=H$.acquire();t.length=Ng.size;let e=0;for(const r of Ng)t[e]=r,++e;return Ng.clear(),t}const Wk=new Set;function xue(t){return Wk.add(t),{remove(){Wk.delete(t)}}}function g3e(t,e,r){let i=Yce(t,e,r,(s,n,o)=>{let a,l,c=_ue(()=>GO(s,n),(h,p)=>{s.__accessor__.destroyed||a&&a.uid!==l?i.remove():(a||(a=IR.acquireUntracked(h,o,p,s,n),l=a.uid),HD(a))});return{remove:HH(()=>{c.remove(),a&&(a.uid!==l||a.removed||(a.removed=!0,HD(a)),a=null),i=c=null})}});return i}function y3e(t,e,r){const i=Yce(t,e,r,(s,n,o)=>{let a=!1;return yue(()=>GO(s,n),(l,c)=>{s.__accessor__.destroyed?i.remove():a||(a=!0,jH(c,l)||o.call(s,l,c,n,s),a=!1)})});return i}function _3e(t,e,r,i=!1){return!t.__accessor__||t.__accessor__.destroyed?{remove(){}}:i?y3e(t,e,r):g3e(t,e,r)}function v3e(t,e,r){let i,s,n=_ue(t,(o,a)=>{i&&i.uid!==s?n.remove():(i||(i=IR.acquireTracked(o,e,a,r),s=i.uid),HD(i))});return{remove:HH(()=>{n.remove(),i&&(i.uid!==s||i.removed||(i.removed=!0,HD(i)),i=null),n=null})}}function b3e(t,e,r){let i=!1;return yue(t,(s,n)=>{i||(i=!0,r(n,s)||e(s,n),i=!1)})}function w3e(t,e,r=!1,i=EAe){return r?b3e(t,e,i):v3e(t,e,i)}function WJ(t){return j$(Ng,e=>e.oldValue===t)}function Ho(t,e){for(const[r,i]of t)if(e(i,r))return!0;return!1}function Gbt(t,e){for(const[r,i]of t)if(e(i,r))return i;return null}function JH(t,e,r){const i=t.get(e);if(i!==void 0)return i;const s=r();return t.set(e,s),s}const B2=se.getLogger("esri.core.accessorSupport.ensureTypes");function x3e(t){return t==null?t:new Date(t)}function T3e(t){return t==null?t:!!t}function WO(t){return t==null?t:t.toString()}function bh(t){return t==null?t:(t=parseFloat(t),isNaN(t)?0:t)}function KH(t){return t==null?t:Math.round(parseFloat(t))}function Tue(t){return t&&t.constructor&&t.constructor.__accessorMetadata__!==void 0}function qD(t,e){return e!=null&&t&&!(e instanceof t)}function Sue(t){return t&&"isCollection"in t}function XJ(t){return t&&t.Type?typeof t.Type=="function"?t.Type:t.Type.base:null}function S3e(t,e){if(!e||!e.constructor||!Sue(e.constructor))return Xk(t,e)?e:new t(e);const r=XJ(t.prototype.itemType),i=XJ(e.constructor.prototype.itemType);return r?i?r===i?e:r.prototype.isPrototypeOf(i.prototype)?new t(e):(Xk(t,e),e):new t(e):e}function Xk(t,e){return!!Tue(e)&&(B2.error("Accessor#set","Assigning an instance of '"+(e.declaredClass||"unknown")+"' which is not a subclass of '"+o4(t)+"'"),!0)}function bS(t,e){return e==null?e:Sue(t)?S3e(t,e):qD(t,e)?Xk(t,e)?e:new t(e):e}function o4(t){return t&&t.prototype&&t.prototype.declaredClass||"unknown"}const E3e=new WeakMap;function C3e(t){switch(t){case Number:return bh;case Gi:return KH;case Boolean:return T3e;case String:return WO;case Date:return x3e;default:return JH(E3e,t,()=>bS.bind(null,t))}}function us(t,e){const r=C3e(t);return arguments.length===1?r:r(e)}function $R(t,e,r){return arguments.length===1?$R.bind(null,t):e&&(Array.isArray(e)?e.map(i=>t(i,r)):[t(e,r)])}function A3e(t,e){return arguments.length===1?$R(us.bind(null,t)):$R(us.bind(null,t),e)}function Eue(t,e,r){return e!==0&&Array.isArray(r)?r.map(i=>Eue(t,e-1,i)):t(r)}function WD(t,e,r){if(arguments.length===2)return WD.bind(null,t,e);if(!r)return r;let i=e,s=r=Eue(t,e,r);for(;i>0&&Array.isArray(s);)i--,s=s[0];if(s!==void 0)for(let n=0;n<i;n++)r=[r];return r}function R3e(t,e,r){return arguments.length===2?WD(us.bind(null,t),e):WD(us.bind(null,t),e,r)}function Cue(t){return!!Array.isArray(t)&&!t.some(e=>{const r=typeof e;return!(r==="string"||r==="number"||r==="function"&&t.length>1)})}function Yk(t,e){if(arguments.length===2)return Yk(t).call(null,e);const r=new Set,i=t.filter(a=>typeof a!="function"),s=t.filter(a=>typeof a=="function");for(const a of t)typeof a!="string"&&typeof a!="number"||r.add(a);let n=null,o=null;return(a,l)=>{if(a==null)return a;const c=typeof a,h=c==="string"||c==="number";return h&&(r.has(a)||s.some(p=>c==="string"&&p===String||c==="number"&&p===Number))||c==="object"&&s.some(p=>!qD(a,p))?a:(h&&i.length?(n||(n=i.map(p=>typeof p=="string"?`'${p}'`:`${p}`).join(", ")),B2.error("Accessor#set",`'${a}' is not a valid value for this property, only the following values are valid: ${n}`)):typeof a=="object"&&s.length?(o||(o=s.map(p=>o4(p)).join(", ")),B2.error("Accessor#set",`'${a}' is not a valid value for this property, value must be one of ${o}`)):B2.error("Accessor#set",`'${a}' is not a valid value for this property`),l&&(l.valid=!1),null)}}function up(t,e){if(arguments.length===2)return up(t).call(null,e);const r={},i=[],s=[];for(const l in t.typeMap){const c=t.typeMap[l];r[l]=us(c),i.push(o4(c)),s.push(l)}const n=()=>`'${i.join("', '")}'`,o=()=>`'${s.join("', '")}'`,a=typeof t.key=="string"?l=>l[t.key]:t.key;return l=>{if(t.base&&!qD(t.base,l)||l==null)return l;const c=a(l)||t.defaultKeyValue,h=r[c];if(!h)return B2.error("Accessor#set",`Invalid property value, value needs to be one of ${n()}, or a plain object that can autocast (having .type = ${o()})`),null;if(!qD(t.typeMap[c],l))return l;if(typeof t.key=="string"&&!Tue(l)){const p={};for(const f in l)f!==t.key&&(p[f]=l[f]);return h(p)}return h(l)}}let Gi=class{};const Hbt={native:t=>({type:"native",value:t}),array:t=>({type:"array",value:t}),oneOf:t=>({type:"one-of",values:t})};function O3e(t){if(!t||!("type"in t))return!1;switch(t.type){case"native":case"array":case"one-of":return!0}return!1}function Aue(t){switch(t.type){case"native":return us(t.value);case"array":return $R(Aue(t.value));case"one-of":return M3e(t);default:return null}}function M3e(t){let e=null;return(r,i)=>Jk(r,t)?r:(e==null&&(e=Zk(t)),B2.error("Accessor#set",`Invalid property value, value needs to be of type ${e}`),i&&(i.valid=!1),null)}function Zk(t){switch(t.type){case"native":switch(t.value){case Number:return"number";case String:return"string";case Boolean:return"boolean";case Gi:return"integer";case Date:return"date";default:return o4(t.value)}case"array":return`array of ${Zk(t.value)}`;case"one-of":{const e=t.values.map(r=>Zk(r));return`one of ${e.slice(0,e.length-1)} or ${e[e.length-1]}`}}return"unknown"}function Jk(t,e){if(t==null)return!0;switch(e.type){case"native":switch(e.value){case Number:case Gi:return typeof t=="number";case Boolean:return typeof t=="boolean";case String:return typeof t=="string"}return t instanceof e.value;case"array":return!!Array.isArray(t)&&!t.some(r=>!Jk(r,e.value));case"one-of":return e.values.some(r=>Jk(t,r))}}function d(t={}){return(e,r)=>{if(e===Function.prototype)throw new Error(`Inappropriate use of @property() on a static field: ${e.name}.${r}. Accessor does not support static properties.`);const i=Object.getOwnPropertyDescriptor(e,r),s=t4(e,r);i&&(i.get||i.set?(s.get=i.get||s.get,s.set=i.set||s.set):"value"in i&&("value"in t&&se.getLogger("esri.core.accessorSupport.decorators.property").warn(`@property() will redefine the value of "${r}" on "${e.constructor.name}" already defined in the metadata`,t),s.value=t.value=i.value)),t.readOnly!=null&&(s.readOnly=t.readOnly);const n=t.aliasOf;if(n){const l=typeof n=="string"?n:n.source,c=typeof n=="string"?null:n.overridable===!0;let h;s.dependsOn=[l],s.get=function(){let p=FD(this,l);if(typeof p=="function"){h||(h=l.split(".").slice(0,-1).join("."));const f=FD(this,h);f&&(p=p.bind(f))}return p},s.readOnly||(s.set=c?function(p){this._override(r,p)}:function(p){VD(this,l,p)})}const o=t.type,a=t.types;s.cast||(o?s.cast=P3e(o):a&&(Array.isArray(a)?s.cast=$R(up(a[0])):s.cast=up(a))),PAe(s,t),t.range&&(s.cast=I3e(s.cast,t.range))}}function Rue(t,e,r){const i=t4(t,r);i.json||(i.json={});let s=i.json;return e!==void 0&&(s.origins||(s.origins={}),s.origins[e]||(s.origins[e]={}),s=s.origins[e]),s}function P3e(t){let e=0,r=t;if(O3e(t))return Aue(t);for(;Array.isArray(r)&&r.length===1&&typeof r[0]!="string"&&typeof r[0]!="number";)r=r[0],e++;const i=r;if(Cue(i))return e===0?Yk(i):WD(Yk(i),e);if(e===1)return A3e(i);if(e>1)return R3e(i,e);const s=t;return s.from?s.from:us(s)}function I3e(t,e){return r=>{let i=+t(r);return e.step!=null&&(i=Math.round(i/e.step)*e.step),e.min!=null&&(i=Math.max(e.min,i)),e.max!=null&&(i=Math.min(e.max,i)),i}}function $3e(t){if(t.json&&t.json.origins){const e=t.json.origins,r={"web-document":["web-scene","web-map"]};for(const i in r)if(e[i]){const s=e[i];r[i].forEach(n=>{e[n]=s}),delete e[i]}}}let rm=class Kk extends aue{constructor(e,r,i){if(super(e,r,i),!(this instanceof Kk))return new Kk(e,r,i)}};rm.prototype.type="warning";function Oue(t){return!!t&&t.prototype&&t.prototype.declaredClass&&t.prototype.declaredClass.indexOf("esri.core.Collection")===0}const Qk=se.getLogger("esri.core.accessorSupport.extensions.serializableProperty.reader");function YJ(t,e,r){var i,s;t&&(!r&&!e.read||(i=e.read)!=null&&i.reader||((s=e.read)==null?void 0:s.enabled)===!1||N3e(t)&&el("read.reader",dv(t),e))}function dv(t){var r,i;const e=t.ndimArray??0;if(e>1)return D3e(t);if(e===1)return ZJ(t);if("type"in t&&Pue(t.type)){const s=(i=(r=t.type.prototype)==null?void 0:r.itemType)==null?void 0:i.Type,n=ZJ(typeof s=="function"?{type:s}:{types:s});return(o,a,l)=>{const c=n(o,a,l);return c&&new t.type(c)}}return QH(t)}function QH(t){return"type"in t?L3e(t.type):F3e(t.types)}function L3e(t){return t.prototype.read?(e,r,i)=>{if(e==null)return e;const s=typeof e;if(s!=="object")return void Qk.error(`Expected JSON value of type 'object' to deserialize type '${t.prototype.declaredClass}', but got '${s}'`);const n=new t;return n.read(e,i),n}:t.fromJSON}function Mue(t,e,r,i){return i!==0&&Array.isArray(e)?e.map(s=>Mue(t,s,r,i-1)):t(e,void 0,r)}function D3e(t){const e=QH(t),r=Mue.bind(null,e),i=t.ndimArray??0;return(s,n,o)=>{if(s==null)return s;s=r(s,o,i);let a=i,l=s;for(;a>0&&Array.isArray(l);)a--,l=l[0];if(l!==void 0)for(let c=0;c<a;c++)s=[s];return s}}function ZJ(t){const e=QH(t);return(r,i,s)=>{if(r==null)return r;if(Array.isArray(r)){const o=[];for(const a of r){const l=e(a,void 0,s);l!==void 0&&o.push(l)}return o}const n=e(r,void 0,s);return n!==void 0?[n]:void 0}}function Pue(t){if(!Oue(t))return!1;const e=t.prototype.itemType;return!(!e||!e.Type)&&(typeof e.Type=="function"?eq(e.Type):Iue(e.Type))}function N3e(t){return"types"in t?Iue(t.types):eq(t.type)}function eq(t){return!Array.isArray(t)&&!!t&&t.prototype&&("read"in t.prototype||"fromJSON"in t||Pue(t))}function Iue(t){for(const e in t.typeMap)if(!eq(t.typeMap[e]))return!1;return!0}function F3e(t){let e=null;const r=t.errorContext??"type";return(i,s,n)=>{if(i==null)return i;const o=typeof i;if(o!=="object")return void Qk.error(`Expected JSON value of type 'object' to deserialize, but got '${o}'`);e||(e=U3e(t));const a=t.key;if(typeof a!="string")return;const l=i[a],c=l?e[l]:t.defaultKeyValue?t.typeMap[t.defaultKeyValue]:void 0;if(!c){const p=`Type '${l||"unknown"}' is not supported`;return n&&n.messages&&i&&n.messages.push(new rm(`${r}:unsupported`,p,{definition:i,context:n})),void Qk.error(p)}const h=new c;return h.read(i,n),h}}function U3e(t){var r,i;const e={};for(const s in t.typeMap){const n=t.typeMap[s],o=jO(n.prototype);if(typeof t.key=="function")continue;const a=o[t.key];if(!a)continue;(r=a.json)!=null&&r.type&&Array.isArray(a.json.type)&&a.json.type.length===1&&typeof a.json.type[0]=="string"&&(e[a.json.type[0]]=n);const l=(i=a.json)==null?void 0:i.write;if(!l||!l.writer){e[s]=n;continue}const c=l.target,h=typeof c=="string"?c:t.key,p={};l.writer(s,p,h),p[h]&&(e[p[h]]=n)}return e}function k3e(t){if(t.json||(t.json={}),KJ(t.json),QJ(t.json),JJ(t.json),t.json.origins)for(const e in t.json.origins)KJ(t.json.origins[e]),QJ(t.json.origins[e]),JJ(t.json.origins[e]);return!0}function JJ(t){t.name&&(t.read&&typeof t.read=="object"?t.read.source===void 0&&(t.read.source=t.name):t.read={source:t.name},t.write&&typeof t.write=="object"?t.write.target===void 0&&(t.write.target=t.name):t.write={target:t.name})}function KJ(t){typeof t.read=="boolean"?t.read={enabled:t.read}:typeof t.read=="function"?t.read={enabled:!0,reader:t.read}:t.read&&typeof t.read=="object"&&t.read.enabled===void 0&&(t.read.enabled=!0)}function QJ(t){typeof t.write=="boolean"?t.write={enabled:t.write}:typeof t.write=="function"?t.write={enabled:!0,writer:t.write}:t.write&&typeof t.write=="object"&&t.write.enabled===void 0&&(t.write.enabled=!0)}function eK(t,e){if(!e.write||e.write.writer||e.write.enabled===!1&&!e.write.overridePolicy)return;const r=(t==null?void 0:t.ndimArray)??0;t&&(r===1||"type"in t&&Oue(t.type))?e.write.writer=z3e:r>1?e.write.writer=G3e(r):e.types?Array.isArray(e.types)?e.write.writer=B3e(e.types[0]):e.write.writer=V3e(e.types):e.write.writer=LR}function V3e(t){return(e,r,i,s)=>e?$ue(e,t,s)?LR(e,r,i,s):void 0:LR(e,r,i,s)}function $ue(t,e,r){for(const i in e.typeMap)if(t instanceof e.typeMap[i])return!0;if(r!=null&&r.messages){const i=e.errorContext??"type",s=`Values of type '${(typeof e.key!="function"?t[e.key]:t.declaredClass)??"Unknown"}' cannot be written`;r&&r.messages&&t&&r.messages.push(new q(`${i}:unsupported`,s,{definition:t,context:r})),se.getLogger("esri.core.accessorSupport.extensions.serializableProperty.writer").error(s)}return!1}function B3e(t){return(e,r,i,s)=>!e||!Array.isArray(e)?LR(e,r,i,s):LR(e.filter(n=>$ue(n,t,s)),r,i,s)}function LR(t,e,r,i){el(r,XD(t,i),e)}function XD(t,e){return t&&typeof t.write=="function"?t.write({},e):t&&typeof t.toJSON=="function"?t.toJSON():typeof t=="number"?YD(t):t}function YD(t){return t===-1/0?-Number.MAX_VALUE:t===1/0?Number.MAX_VALUE:isNaN(t)?null:t}function z3e(t,e,r,i){let s;t===null?s=null:t&&typeof t.map=="function"?(s=t.map(n=>XD(n,i)),typeof s.toArray=="function"&&(s=s.toArray())):s=[XD(t,i)],el(r,s,e)}function Lue(t,e,r){return r!==0&&Array.isArray(t)?t.map(i=>Lue(i,e,r-1)):XD(t,e)}function G3e(t){return(e,r,i,s)=>{let n;if(e===null)n=null;else{n=Lue(e,s,t);let o=t,a=n;for(;o>0&&Array.isArray(a);)o--,a=a[0];if(a!==void 0)for(let l=0;l<o;l++)n=[n]}el(i,n,r)}}function eV(t,e){return tq(t,"read",e)}function Due(t,e){return tq(t,"write",e)}function tq(t,e,r){let i=t&&t.json;if(t&&t.json&&t.json.origins&&r){const s=r.origin&&t.json.origins[r.origin];s&&(e==="any"||e in s)&&(i=s)}return i}function j3e(t){const e=H3e(t);if(t.json.origins)for(const r in t.json.origins){const i=t.json.origins[r],s=i.types?q3e(i):e;YJ(s,i,!1),i.types&&!i.write&&t.json.write&&t.json.write.enabled&&(i.write={...t.json.write}),eK(s,i)}YJ(e,t.json,!0),eK(e,t.json)}function H3e(t){return t.json.types?tV(t.json):t.type?Nue(t):tV(t)}function q3e(t){return t.type?Nue(t):tV(t)}function Nue(t){if(!t.type)return;let e=0,r=t.type;for(;Array.isArray(r)&&!Cue(r);)r=r[0],e++;return{type:r,ndimArray:e}}function tV(t){if(!t.types)return;let e=0,r=t.types;for(;Array.isArray(r);)r=r[0],e++;return{types:r,ndimArray:e}}function W3e(t){k3e(t)&&($3e(t),j3e(t))}const T6=new Set,S6=new Set;function I(t){return e=>{e.prototype.declaredClass=t,Y3e(e);const r=[],i=[];let s=e.prototype;for(;s;)s.hasOwnProperty("initialize")&&!T6.has(s.initialize)&&(T6.add(s.initialize),r.push(s.initialize)),s.hasOwnProperty("destroy")&&!S6.has(s.destroy)&&(S6.add(s.destroy),i.push(s.destroy)),s=Object.getPrototypeOf(s);T6.clear(),S6.clear();class n extends e{constructor(...a){if(super(...a),this.constructor===n&&typeof this.postscript=="function"){if(r.length&&Object.defineProperty(this,"initialize",{enumerable:!1,configurable:!0,value(){for(let l=r.length-1;l>=0;l--)r[l].call(this)}}),i.length){let l=!1;const c=this[Vce];Object.defineProperty(this,"destroy",{enumerable:!1,configurable:!0,value(){if(!l){l=!0,c.call(this);for(let h=0;h<i.length;h++)i[h].call(this)}}})}this.postscript(...a)}}}return n.__accessorMetadata__=jO(e.prototype),n.prototype.declaredClass=t,n}}function X3e(t,e){return e.get==null?function(){const r=this.__accessor__.properties.get(t);if(r===void 0)return;br(r.observerObject);const i=this.__accessor__.store;return i.has(t)?i.get(t):r.metadata.value}:function(){const r=this.__accessor__.properties.get(t);if(r!==void 0)return r.getComputed()}}function Y3e(t){const e=t.prototype,r=jO(e),i={};for(const s of Object.getOwnPropertyNames(r)){const n=r[s];W3e(n),i[s]={enumerable:!0,configurable:!0,get:X3e(s,n),set(o){const a=this.__accessor__;if(a!==void 0){if(!Object.isFrozen(this)){if(a.initialized&&n.readOnly)throw new TypeError(`[accessor] cannot assign to read-only property '${s}' of ${this.declaredClass}`);if(a.lifecycle===Ag.CONSTRUCTED&&n.constructOnly)throw new TypeError(`[accessor] cannot assign to construct-only property '${s}' of ${this.declaredClass}`);a.set(s,o)}}else Object.defineProperty(this,s,{enumerable:!0,configurable:!0,writable:!0,value:o})}}}Object.defineProperties(t.prototype,i)}var Fue,Uue;function Z3e(t){var e;if(t==null)return{value:t};if(Array.isArray(t))return{type:[t[0]],value:null};switch(typeof t){case"object":return(e=t.constructor)!=null&&e.__accessorMetadata__||t instanceof Date?{type:t.constructor,value:t}:t;case"boolean":return{type:Boolean,value:t};case"string":return{type:String,value:t};case"number":return{type:Number,value:t};case"function":return{type:t,value:null};default:return}}const f1=Symbol("Accessor-Handles"),rV=Symbol("Accessor-Initialized");let Te=class kue{static createSubclass(e={}){if(Array.isArray(e))throw new Error("Multi-inheritance unsupported since 4.16");const{properties:r,declaredClass:i,constructor:s}=e;delete e.declaredClass,delete e.properties,delete e.constructor;const n=this;class o extends n{constructor(...l){super(...l),this.inherited=null,s&&s.apply(this,l)}}jO(o.prototype);for(const a in e){const l=e[a];o.prototype[a]=typeof l=="function"?function(...c){const h=this.inherited;let p;this.inherited=function(...f){if(n.prototype[a])return n.prototype[a].apply(this,f)};try{p=l.apply(this,c)}catch(f){throw this.inherited=h,f}return this.inherited=h,p}:e[a]}for(const a in r){const l=Z3e(r[a]);d(l)(o.prototype,a)}return I(i)(o)}constructor(...e){if(this[Fue]=null,this[Uue]=!1,this.constructor===kue)throw new Error("[accessor] cannot instantiate Accessor. This can be fixed by creating a subclass of Accessor");Object.defineProperty(this,"__accessor__",{enumerable:!1,value:new GAe(this)}),e.length>0&&this.normalizeCtorArgs&&(this.__accessor__.ctorArgs=this.normalizeCtorArgs.apply(this,e))}postscript(e){const r=this.__accessor__,i=r.ctorArgs||e;r.initialize(),i&&(this.set(i),r.ctorArgs=null),r.constructed(),this.initialize(),this[rV]=!0}initialize(){}[Vce](){this[f1]=ke(this[f1])}destroy(){this.destroyed||(p3e(this),this.__accessor__.destroy())}get constructed(){return this.__accessor__&&this.__accessor__.initialized||!1}get initialized(){return this[rV]}get destroyed(){return this.__accessor__&&this.__accessor__.destroyed||!1}commitProperty(e){this.get(e)}get(e){return FD(this,e)}hasOwnProperty(e){return this.__accessor__?this.__accessor__.has(e):Object.prototype.hasOwnProperty.call(this,e)}keys(){return this.__accessor__?this.__accessor__.keys():[]}set(e,r){return VD(this,e,r),this}watch(e,r,i){return _3e(this,e,r,i)}own(e){this.addHandles(e)}addHandles(e,r){let i=this[f1];C(i)&&(i=this[f1]=new ei),i.add(e,r)}removeHandles(e){const r=this[f1];C(r)||r.remove(e)}hasHandles(e){const r=this[f1];return!!v(r)&&r.has(e)}_override(e,r){r===void 0?this.__accessor__.clearOverride(e):this.__accessor__.override(e,r)}_clearOverride(e){return this.__accessor__.clearOverride(e)}_overrideIfSome(e,r){r==null?this.__accessor__.clearOverride(e):this.__accessor__.override(e,r)}_isOverridden(e){return this.__accessor__.isOverridden(e)}notifyChange(e){this.__accessor__.notifyChange(e)}_get(e){return this.__accessor__.internalGet(e)}_set(e,r){return this.__accessor__.internalSet(e,r),this}};Fue=f1,Uue=rV;let q$=class Vue{constructor(){this._emitter=new Vue.EventEmitter(this)}emit(e,r){return this._emitter.emit(e,r)}on(e,r){return this._emitter.on(e,r)}once(e,r){return this._emitter.once(e,r)}hasEventListener(e){return this._emitter.hasEventListener(e)}};(function(t){class e{constructor(s=null){this._target=s,this._listenersMap=null}clear(){this._listenersMap&&this._listenersMap.clear(),this._listenersMap=null}emit(s,n){const o=this._listenersMap&&this._listenersMap.get(s);if(!o)return!1;const a=this._target||this;return[...o].forEach(l=>{l.call(a,n)}),o.length>0}on(s,n){if(Array.isArray(s)){const a=s.map(l=>this.on(l,n));return yS(a)}if(s.includes(","))throw new TypeError("Evented.on() with a comma delimited string of event types is not supported");this._listenersMap||(this._listenersMap=new Map);const o=this._listenersMap.get(s)||[];return o.push(n),this._listenersMap.set(s,o),{remove:()=>{const a=this._listenersMap&&this._listenersMap.get(s)||[],l=a.indexOf(n);l>=0&&a.splice(l,1)}}}once(s,n){const o=this.on(s,a=>{o.remove(),n.call(null,a)});return o}hasEventListener(s){const n=this._listenersMap&&this._listenersMap.get(s);return n!=null&&n.length>0}}t.EventEmitter=e,t.EventedMixin=i=>{let s=class extends i{constructor(){super(...arguments),this._emitter=new e}destroy(){this._emitter.clear()}emit(n,o){return this._emitter.emit(n,o)}on(n,o){return this._emitter.on(n,o)}once(n,o){return this._emitter.once(n,o)}hasEventListener(n){return this._emitter.hasEventListener(n)}};return s=u([I("esri.core.Evented")],s),s};let r=class extends Te{constructor(){super(...arguments),this._emitter=new q$.EventEmitter(this)}destroy(){this._emitter.clear()}emit(i,s){return this._emitter.emit(i,s)}on(i,s){return this._emitter.on(i,s)}once(i,s){return this._emitter.once(i,s)}hasEventListener(i){return this._emitter.hasEventListener(i)}};r=u([I("esri.core.Evented")],r),t.EventedAccessor=r})(q$||(q$={}));const vs=q$;var fi;(function(t){t[t.ADD=1]="ADD",t[t.REMOVE=2]="REMOVE",t[t.MOVE=4]="MOVE"})(fi||(fi={}));function rq(t){return(e,r)=>{e[r]=t}}let iq=class extends tue{notify(){const e=this._observers;if(e&&e.length>0){const r=e.slice();for(const i of r)i.onInvalidated(),i.onCommitted()}}};var Sg;let J3e=class{constructor(){this.target=null,this.cancellable=!1,this.defaultPrevented=!1,this.item=void 0,this.type=void 0}preventDefault(){this.cancellable&&(this.defaultPrevented=!0)}reset(e){this.defaultPrevented=!1,this.item=e}};const Bu=new Co(J3e,void 0,t=>{t.item=null,t.target=null,t.defaultPrevented=!1,t.cancellable=!1}),K3e=()=>{};function E6(t){return t?t instanceof mb?t.toArray():t.length?Array.prototype.slice.apply(t):[]:[]}function C6(t){if(t&&t.length)return t[0]}function Q3e(t,e,r,i){const s=Math.min(t.length-r,e.length-i);let n=0;for(;n<s&&t[r+n]===e[i+n];)n++;return n}function Bue(t,e,r,i){e&&e.forEach((s,n,o)=>{t.push(s),Bue(t,r.call(i,s,n,o),r,i)})}const Oy=new Set,My=new Set,Py=new Set,A6=new Map;let eRe=0,mb=Sg=class extends vs.EventedAccessor{static isCollection(t){return t!=null&&t instanceof Sg}constructor(t){super(t),this._chgListeners=[],this._notifications=null,this._timer=null,this._observable=new iq,this.length=0,this._items=[],Object.defineProperty(this,"uid",{value:eRe++})}normalizeCtorArgs(t){return t?Array.isArray(t)||t instanceof Sg?{items:t}:t:{}}destroy(){this.removeAll()}*[Symbol.iterator](){yield*this.items}get items(){return br(this._observable),this._items}set items(t){this._emitBeforeChanges(fi.ADD)||(this._splice(0,this.length,E6(t)),this._emitAfterChanges(fi.ADD))}hasEventListener(t){return t==="change"?this._chgListeners.length>0:this._emitter.hasEventListener(t)}on(t,e){if(t==="change"){const r=this._chgListeners,i={removed:!1,callback:e};return r.push(i),this._notifications&&this._notifications.push({listeners:r.slice(),items:this._items.slice(),changes:[]}),{remove(){this.remove=K3e,i.removed=!0,r.splice(r.indexOf(i),1)}}}return this._emitter.on(t,e)}once(t,e){const r=this.on(t,e);return{remove(){r.remove()}}}add(t,e){if(br(this._observable),this._emitBeforeChanges(fi.ADD))return this;const r=this.getNextIndex(e??null);return this._splice(r,0,[t]),this._emitAfterChanges(fi.ADD),this}addMany(t,e=this._items.length){if(br(this._observable),!t||!t.length)return this;if(this._emitBeforeChanges(fi.ADD))return this;const r=this.getNextIndex(e);return this._splice(r,0,E6(t)),this._emitAfterChanges(fi.ADD),this}at(t){if(br(this._observable),(t=Math.trunc(t)||0)<0&&(t+=this.length),!(t<0||t>=this.length))return this._items[t]}removeAll(){if(br(this._observable),!this.length||this._emitBeforeChanges(fi.REMOVE))return[];const t=this._splice(0,this.length)||[];return this._emitAfterChanges(fi.REMOVE),t}clone(){return br(this._observable),this._createNewInstance({items:this._items.map(ne)})}concat(...t){br(this._observable);const e=t.map(E6);return this._createNewInstance({items:this._items.concat(...e)})}drain(t,e){if(br(this._observable),!this.length||this._emitBeforeChanges(fi.REMOVE))return;const r=this._splice(0,this.length),i=r.length;for(let s=0;s<i;s++)t.call(e,r[s],s,r);this._emitAfterChanges(fi.REMOVE)}every(t,e){return br(this._observable),this._items.every(t,e)}filter(t,e){let r;return br(this._observable),r=arguments.length===2?this._items.filter(t,e):this._items.filter(t),this._createNewInstance({items:r})}find(t,e){return br(this._observable),this._items.find(t,e)}findIndex(t,e){return br(this._observable),this._items.findIndex(t,e)}flatten(t,e){br(this._observable);const r=[];return Bue(r,this,t,e),new Sg(r)}forEach(t,e){return br(this._observable),this._items.forEach(t,e)}getItemAt(t){return br(this._observable),this._items[t]}getNextIndex(t){br(this._observable);const e=this.length;return(t=t??e)<0?t=0:t>e&&(t=e),t}includes(t,e=0){return br(this._observable),this._items.includes(t,e)}indexOf(t,e=0){return br(this._observable),this._items.indexOf(t,e)}join(t=","){return br(this._observable),this._items.join(t)}lastIndexOf(t,e=this.length-1){return br(this._observable),this._items.lastIndexOf(t,e)}map(t,e){br(this._observable);const r=this._items.map(t,e);return new Sg({items:r})}reorder(t,e=this.length-1){br(this._observable);const r=this.indexOf(t);if(r!==-1){if(e<0?e=0:e>=this.length&&(e=this.length-1),r!==e){if(this._emitBeforeChanges(fi.MOVE))return t;this._splice(r,1),this._splice(e,0,[t]),this._emitAfterChanges(fi.MOVE)}return t}}pop(){if(br(this._observable),!this.length||this._emitBeforeChanges(fi.REMOVE))return;const t=C6(this._splice(this.length-1,1));return this._emitAfterChanges(fi.REMOVE),t}push(...t){return br(this._observable),this._emitBeforeChanges(fi.ADD)||(this._splice(this.length,0,t),this._emitAfterChanges(fi.ADD)),this.length}reduce(t,e){br(this._observable);const r=this._items;return arguments.length===2?r.reduce(t,e):r.reduce(t)}reduceRight(t,e){br(this._observable);const r=this._items;return arguments.length===2?r.reduceRight(t,e):r.reduceRight(t)}remove(t){return br(this._observable),this.removeAt(this.indexOf(t))}removeAt(t){if(br(this._observable),t<0||t>=this.length||this._emitBeforeChanges(fi.REMOVE))return;const e=C6(this._splice(t,1));return this._emitAfterChanges(fi.REMOVE),e}removeMany(t){if(br(this._observable),!t||!t.length||this._emitBeforeChanges(fi.REMOVE))return[];const e=t instanceof Sg?t.toArray():t,r=this._items,i=[],s=e.length;for(let n=0;n<s;n++){const o=e[n],a=r.indexOf(o);if(a>-1){const l=1+Q3e(e,r,n+1,a+1),c=this._splice(a,l);c&&c.length>0&&i.push.apply(i,c),n+=l-1}}return this._emitAfterChanges(fi.REMOVE),i}reverse(){if(br(this._observable),this._emitBeforeChanges(fi.MOVE))return this;const t=this._splice(0,this.length);return t&&(t.reverse(),this._splice(0,0,t)),this._emitAfterChanges(fi.MOVE),this}shift(){if(br(this._observable),!this.length||this._emitBeforeChanges(fi.REMOVE))return;const t=C6(this._splice(0,1));return this._emitAfterChanges(fi.REMOVE),t}slice(t=0,e=this.length){return br(this._observable),this._createNewInstance({items:this._items.slice(t,e)})}some(t,e){return br(this._observable),this._items.some(t,e)}sort(t){if(br(this._observable),!this.length||this._emitBeforeChanges(fi.MOVE))return this;const e=this._splice(0,this.length);return arguments.length?e.sort(t):e.sort(),this._splice(0,0,e),this._emitAfterChanges(fi.MOVE),this}splice(t,e,...r){br(this._observable);const i=(e?fi.REMOVE:0)|(r.length?fi.ADD:0);if(this._emitBeforeChanges(i))return[];const s=this._splice(t,e,r)||[];return this._emitAfterChanges(i),s}toArray(){return br(this._observable),this._items.slice()}toJSON(){return br(this._observable),this.toArray()}toLocaleString(){return br(this._observable),this._items.toLocaleString()}toString(){return br(this._observable),this._items.toString()}unshift(...t){return br(this._observable),!t.length||this._emitBeforeChanges(fi.ADD)||(this._splice(0,0,t),this._emitAfterChanges(fi.ADD)),this.length}_createNewInstance(t){return new this.constructor(t)}_splice(t,e,r){const i=this._items,s=this.itemType;let n,o;if(!this._notifications&&this.hasEventListener("change")&&(this._notifications=[{listeners:this._chgListeners.slice(),items:this._items.slice(),changes:[]}],this._timer&&this._timer.remove(),this._timer=gE(()=>this._dispatchChange())),e){if(o=i.splice(t,e),this.hasEventListener("before-remove")){const a=Bu.acquire();a.target=this,a.cancellable=!0;for(let l=0,c=o.length;l<c;l++)n=o[l],a.reset(n),this.emit("before-remove",a),a.defaultPrevented&&(o.splice(l,1),i.splice(t,0,n),t+=1,l-=1,c-=1);Bu.release(a)}if(this.length=this._items.length,this.hasEventListener("after-remove")){const a=Bu.acquire();a.target=this,a.cancellable=!1;const l=o.length;for(let c=0;c<l;c++)a.reset(o[c]),this.emit("after-remove",a);Bu.release(a)}}if(r&&r.length){if(s){const h=[];for(const p of r){const f=s.ensureType(p);f==null&&p!=null||h.push(f)}r=h}const a=this.hasEventListener("before-add"),l=this.hasEventListener("after-add"),c=t===this.length;if(a||l){const h=Bu.acquire();h.target=this,h.cancellable=!0;const p=Bu.acquire();p.target=this,p.cancellable=!1;for(const f of r)a?(h.reset(f),this.emit("before-add",h),h.defaultPrevented||(c?i.push(f):i.splice(t++,0,f),this._set("length",i.length),l&&(p.reset(f),this.emit("after-add",p)))):(c?i.push(f):i.splice(t++,0,f),this._set("length",i.length),p.reset(f),this.emit("after-add",p));Bu.release(p),Bu.release(h)}else{if(c)for(const h of r)i.push(h);else i.splice(t,0,...r);this._set("length",i.length)}}return(r&&r.length||o&&o.length)&&this._notifyChangeEvent(r,o),o}_emitBeforeChanges(t){let e=!1;if(this.hasEventListener("before-changes")){const r=Bu.acquire();r.target=this,r.cancellable=!0,r.type=t,this.emit("before-changes",r),e=r.defaultPrevented,Bu.release(r)}return e}_emitAfterChanges(t){if(this.hasEventListener("after-changes")){const e=Bu.acquire();e.target=this,e.cancellable=!1,e.type=t,this.emit("after-changes",e),Bu.release(e)}this._observable.notify()}_notifyChangeEvent(t,e){this.hasEventListener("change")&&this._notifications&&this._notifications[this._notifications.length-1].changes.push({added:t,removed:e})}_dispatchChange(){if(this._timer&&(this._timer.remove(),this._timer=null),!this._notifications)return;const t=this._notifications;this._notifications=null;for(const e of t){const r=e.changes;Oy.clear(),My.clear(),Py.clear();for(const{added:l,removed:c}of r){if(l)if(Py.size===0&&My.size===0)for(const h of l)Oy.add(h);else for(const h of l)My.has(h)?(Py.add(h),My.delete(h)):Py.has(h)||Oy.add(h);if(c)if(Py.size===0&&Oy.size===0)for(const h of c)My.add(h);else for(const h of c)Oy.has(h)?Oy.delete(h):(Py.delete(h),My.add(h))}const i=wc.acquire();Oy.forEach(l=>{i.push(l)});const s=wc.acquire();My.forEach(l=>{s.push(l)});const n=this._items,o=e.items,a=wc.acquire();if(Py.forEach(l=>{o.indexOf(l)!==n.indexOf(l)&&a.push(l)}),e.listeners&&(i.length||s.length||a.length)){const l={target:this,added:i,removed:s,moved:a},c=e.listeners.length;for(let h=0;h<c;h++){const p=e.listeners[h];p.removed||p.callback.call(this,l)}}wc.release(i),wc.release(s),wc.release(a)}Oy.clear(),My.clear(),Py.clear()}};mb.ofType=t=>{if(!t)return Sg;if(A6.has(t))return A6.get(t);let e=null;if(typeof t=="function")e=t.prototype.declaredClass;else if(t.base)e=t.base.prototype.declaredClass;else for(const i in t.typeMap){const s=t.typeMap[i].prototype.declaredClass;e?e+=` | ${s}`:e=s}let r=class extends Sg{};return u([rq({Type:t,ensureType:typeof t=="function"?us(t):up(t)})],r.prototype,"itemType",void 0),r=u([I(`esri.core.Collection<${e}>`)],r),A6.set(t,r),r},u([d()],mb.prototype,"length",void 0),u([d()],mb.prototype,"items",null),mb=Sg=u([I("esri.core.Collection")],mb);const Pt=mb;function aw(t,e,r=Pt){return e||(e=new r),e===t||(e.removeAll(),tRe(t)?e.addMany(t):t&&e.add(t)),e}function zue(t){return t}function tRe(t){return t&&(Array.isArray(t)||"items"in t&&Array.isArray(t.items))}let rRe=class Gue{constructor(){this._values=new Map,this.multipleOriginsSupported=!1}clone(e){const r=new Gue;return this._values.forEach((i,s)=>{e&&e.has(s)||r.set(s,ne(i.value),i.origin)}),r}get(e,r){r=this._normalizeOrigin(r);const i=this._values.get(e);return r==null||(i==null?void 0:i.origin)===r?i==null?void 0:i.value:void 0}originOf(e){var r;return((r=this._values.get(e))==null?void 0:r.origin)??Gr.USER}keys(e){e=this._normalizeOrigin(e);const r=[...this._values.keys()];return e==null?r:r.filter(i=>{var s;return((s=this._values.get(i))==null?void 0:s.origin)===e})}set(e,r,i){if((i=this._normalizeOrigin(i))===Gr.DEFAULTS){const s=this._values.get(e);if(s&&s.origin!=null&&s.origin>i)return}this._values.set(e,new iRe(r,i))}delete(e,r){var i;(r=this._normalizeOrigin(r))!=null&&((i=this._values.get(e))==null?void 0:i.origin)!==r||this._values.delete(e)}has(e,r){var i;return(r=this._normalizeOrigin(r))!=null?((i=this._values.get(e))==null?void 0:i.origin)===r:this._values.has(e)}forEach(e){this._values.forEach(({value:r},i)=>e(r,i))}_normalizeOrigin(e){if(e!=null)return e===Gr.DEFAULTS?e:Gr.USER}},iRe=class{constructor(e,r){this.value=e,this.origin=r}};function jue(t,e,r){e.keys().forEach(s=>{r.set(s,e.get(s),Gr.DEFAULTS)});const i=t.metadatas;Object.keys(i).forEach(s=>{t.internalGet(s)&&r.set(s,t.internalGet(s),Gr.DEFAULTS)})}function sRe(t,e,r){if(!t||!t.read||t.read.enabled===!1||!t.read.source)return!1;const i=t.read.source;if(typeof i=="string"){if(i===e||i.includes(".")&&i.indexOf(e)===0&&DJ(i,r))return!0}else for(const s of i)if(s===e||s.includes(".")&&s.indexOf(e)===0&&DJ(s,r))return!0;return!1}function nRe(t){return t&&(!t.read||t.read.enabled!==!1&&!t.read.source)}function oRe(t,e,r,i,s){let n=eV(e[r],s);nRe(n)&&(t[r]=!0);for(const o of Object.getOwnPropertyNames(e))n=eV(e[o],s),sRe(n,r,i)&&(t[o]=!0)}function aRe(t,e,r,i){const s=r.metadatas,n=tq(s[e],"any",i),o=n&&n.default;if(o===void 0)return;const a=typeof o=="function"?o.call(t,e,i):o;a!==void 0&&r.set(e,a)}const Hue={origin:"service"};function que(t,e,r=Hue){if(!e||typeof e!="object")return;const i=Qa(t),s=i.metadatas,n={};for(const o of Object.getOwnPropertyNames(e))oRe(n,s,o,e,r);i.setDefaultOrigin(r.origin);for(const o of Object.getOwnPropertyNames(n)){const a=eV(s[o],r).read,l=a&&a.source;let c;c=l&&typeof l=="string"?GO(e,l):e[o],a&&a.reader&&(c=a.reader.call(t,c,e,r)),c!==void 0&&i.set(o,c)}if(!r||!r.ignoreDefaults){i.setDefaultOrigin("defaults");for(const o of Object.getOwnPropertyNames(s))n[o]||aRe(t,o,i,r)}i.setDefaultOrigin("user")}function lRe(t,e,r,i=Hue){var n;const s={...i,messages:[]};r(s),(n=s.messages)==null||n.forEach(o=>{o.type!=="warning"||t.loaded?i&&i.messages&&i.messages.push(o):t.loadWarnings.push(o)})}function cRe(t,e,r,i,s){var o,a;const n={};return(a=(o=e.write)==null?void 0:o.writer)==null||a.call(t,i,n,r,s),n}function Wue(t,e,r,i,s,n){if(!i||!i.write)return!1;const o=t.get(r);if(!s&&i.write.overridePolicy){const a=i.write.overridePolicy.call(t,o,r,n);a!==void 0&&(s=a)}if(s||(s=i.write),!s||s.enabled===!1)return!1;if((o===null&&!s.allowNull&&!s.writerEnsuresNonNull||o===void 0)&&s.isRequired){const a=new q("web-document-write:property-required",`Missing value for required property '${r}' on '${t.declaredClass}'`,{propertyName:r,target:t});return a&&n&&n.messages?n.messages.push(a):a&&!n&&se.getLogger("esri.core.accessorSupport.write").error(a.name,a.message),!1}return!(o===void 0||o===null&&!s.allowNull&&!s.writerEnsuresNonNull||(!e.store.multipleOriginsSupported||e.store.originOf(r)===Gr.DEFAULTS)&&uRe(t,r,n,i,o)||!s.ignoreOrigin&&n&&n.origin&&e.store.multipleOriginsSupported&&e.store.originOf(r)<m_(n.origin))}function uRe(t,e,r,i,s){const n=i.default;if(n===void 0)return!1;if(i.defaultEquals!=null)return i.defaultEquals(s);if(typeof n=="function"){if(Array.isArray(s)){const o=n.call(t,e,r);return Xg(o,s)}return!1}return n===s}function hRe(t,e,r,i){const s=Qa(t),n=s.metadatas,o=Due(n[e],i);return!!o&&Wue(t,s,e,o,r,i)}function Xue(t,e,r){var n,o;if(t&&typeof t.toJSON=="function"&&(!t.toJSON.isDefaultToJSON||!t.write))return V$(e,t.toJSON(r));const i=Qa(t),s=i.metadatas;for(const a in s){const l=Due(s[a],r);if(!Wue(t,i,a,l,void 0,r))continue;const c=t.get(a),h=cRe(t,l,l.write&&typeof l.write.target=="string"?l.write.target:a,c,r);Object.keys(h).length>0&&(e=V$(e,h),(o=(n=r==null?void 0:r.resources)==null?void 0:n.pendingOperations)!=null&&o.length&&r.resources.pendingOperations.push(Promise.all(r.resources.pendingOperations).then(()=>V$(e,h,()=>"replace-arrays"))),r&&r.writtenProperties&&r.writtenProperties.push({target:t,propName:a,oldOrigin:FAe(i.store.originOf(a)),newOrigin:r.origin}))}return e}const XO=t=>{let e=class extends t{constructor(...r){super(...r);const i=Qa(this),s=i.store,n=new rRe;i.store=n,jue(i,s,n)}read(r,i){que(this,r,i)}write(r={},i){return Xue(this,r,i)}toJSON(r){return this.write({},r)}static fromJSON(r,i){return dRe.call(this,r,i)}};return e=u([I("esri.core.JSONSupport")],e),e.prototype.toJSON.isDefaultToJSON=!0,e};function dRe(t,e){if(!t)return null;if(t.declaredClass)throw new Error("JSON object is already hydrated");const r=new this;return r.read(t,e),r}let ve=class extends XO(Te){};ve=u([I("esri.core.JSONSupport")],ve);var Y0;(function(t){t[t.PENDING=0]="PENDING",t[t.RESOLVED=1]="RESOLVED",t[t.REJECTED=2]="REJECTED"})(Y0||(Y0={}));let pRe=class{constructor(e){this.instance=e,this._resolver=j_(),this._status=Y0.PENDING,this._resolvingPromises=[],this._resolver.promise.then(()=>{this._status=Y0.RESOLVED,this._cleanUp()},()=>{this._status=Y0.REJECTED,this._cleanUp()})}addResolvingPromise(e){this._resolvingPromises.push(e),this._tryResolve()}isResolved(){return this._status===Y0.RESOLVED}isRejected(){return this._status===Y0.REJECTED}isFulfilled(){return this._status!==Y0.PENDING}abort(){this._resolver.reject(Hr())}when(e,r){return this._resolver.promise.then(e,r)}_cleanUp(){this._allPromise=this._resolvingPromises=this._allPromise=null}_tryResolve(){if(this.isFulfilled())return;const e=j_(),r=[...this._resolvingPromises,e.promise],i=this._allPromise=Promise.all(r);i.then(()=>{this.isFulfilled()||this._allPromise!==i||this._resolver.resolve(this.instance)},s=>{this.isFulfilled()||this._allPromise!==i||Qs(s)||this._resolver.reject(s)}),e.resolve()}};const a4=t=>{let e=class extends t{constructor(...r){super(...r),this._promiseProps=new pRe(this),this.addResolvingPromise(Promise.resolve())}isResolved(){return this._promiseProps.isResolved()}isRejected(){return this._promiseProps.isRejected()}isFulfilled(){return this._promiseProps.isFulfilled()}when(r,i){return new Promise((s,n)=>{this._promiseProps.when(s,n)}).then(r,i)}catch(r){return this.when(null,r)}addResolvingPromise(r){r&&!this._promiseProps.isFulfilled()&&this._promiseProps.addResolvingPromise("_promiseProps"in r?r.when():r)}};return e=u([I("esri.core.Promise")],e),e};let ZD=class extends a4(Te){};ZD=u([I("esri.core.Promise")],ZD);const fRe="not-loaded",mRe="loading",gRe="failed",tK="loaded",Yue=t=>{let e=class extends t{constructor(...r){super(...r),this._loadController=null,this.loadError=null,this.loadStatus="not-loaded",this._set("loadWarnings",[]),this.addResolvingPromise(new Promise(i=>{const s=this.load.bind(this);this.load=n=>{const o=new Promise((a,l)=>{const c=XH(n,l);this.destroyed&&l(new q("load:instance-destroyed",`Instance of '${this.declaredClass||this.constructor.name}' is already destroyed`,{instance:this})),this._promiseProps.when(a,l).finally(()=>{c&&c.remove()})});if(this.loadStatus===fRe){this._set("loadStatus",mRe);const a=this._loadController=new AbortController;s({signal:a.signal}),fa(a.signal,()=>{this._promiseProps.abort()})}return i(),o}})),this.when(()=>{this._set("loadStatus",tK),this._loadController=null},i=>{this._set("loadStatus",gRe),this._set("loadError",i),this._loadController=null})}get loaded(){return this.loadStatus===tK}get loadWarnings(){return this._get("loadWarnings")}load(){return null}cancelLoad(){var r;return this.isFulfilled()||(this._set("loadError",new q("load:cancelled","Cancelled")),(r=this._loadController)==null||r.abort()),this}};return u([d({readOnly:!0})],e.prototype,"loaded",null),u([d({readOnly:!0})],e.prototype,"loadError",void 0),u([d({clonable:!1})],e.prototype,"loadStatus",void 0),u([d({type:[rm],readOnly:!0})],e.prototype,"loadWarnings",null),e=u([I("esri.core.Loadable")],e),e};let uA=class extends Yue(ZD){};uA=u([I("esri.core.Loadable")],uA),function(t){function e(r){return!(!r||!r.load)}t.LoadableMixin=Yue,t.isLoadable=e}(uA||(uA={}));const Zg=uA;function l4(t,e,r){return jl(t.map((i,s)=>e.apply(r,[i,s])))}async function yRe(t,e,r){return(await jl(t.map((i,s)=>e.apply(r,[i,s])))).map(i=>i.value)}function sq(t){return{ok:!0,value:t}}function nq(t){return{ok:!1,error:t}}function _Re(t){return v(t)&&t.ok===!0?t.value:null}function vRe(t){return v(t)&&t.ok===!1?t.error:null}async function hp(t){if(C(t))return{ok:!1,error:new Error("no promise provided")};try{return sq(await t)}catch(e){return nq(e)}}async function Qbt(t){try{return sq(await t)}catch(e){return xc(e),nq(e)}}function ewt(t){if(t.ok===!0)return t.value;throw t.error}function YO(t,e){return new y0(t,e)}let y0=class extends Te{get value(){return _Re(this._result)}get error(){return vRe(this._result)}get finished(){return v(this._result)}constructor(e,r){super({}),this._result=null,this._abortHandle=null,this.abort=()=>{this._abortController=Fh(this._abortController)},this.remove=this.abort,this._abortController=new AbortController;const{signal:i}=this._abortController;this.promise=e(i),this.promise.then(s=>{this._result=sq(s),this._cleanup()},s=>{this._result=nq(s),this._cleanup()}),this._abortHandle=fa(r,this.abort)}normalizeCtorArgs(){return{}}destroy(){this.abort()}_cleanup(){this._abortHandle=ji(this._abortHandle),this._abortController=null}};u([d()],y0.prototype,"value",null),u([d()],y0.prototype,"error",null),u([d()],y0.prototype,"finished",null),u([d()],y0.prototype,"promise",void 0),u([d()],y0.prototype,"_result",void 0),y0=u([I("esri.core.asyncUtils.ReactiveTask")],y0);async function Zue(t,e){return await t.load(),bRe(t,e)}async function bRe(t,e){const r=[],i=(...n)=>{for(const o of n)C(o)||(Array.isArray(o)?i(...o):Pt.isCollection(o)?o.forEach(a=>i(a)):Zg.isLoadable(o)&&r.push(o))};e(i);let s=null;if(await yRe(r,async n=>{const o=await hp(wRe(n)?n.loadAll():n.load());o.ok!==!1||s||(s=o)}),s)throw s.error;return t}function wRe(t){return"loadAll"in t&&typeof t.loadAll=="function"}const xRe=/^https:\/\/([a-z\d-]+)(\.maps([^.]*))?\.arcgis\.com/i,TRe={devext:{customBaseUrl:"mapsdevext.arcgis.com",portalHostname:"devext.arcgis.com"},qaext:{customBaseUrl:"mapsqa.arcgis.com",portalHostname:"qaext.arcgis.com"},www:{customBaseUrl:"maps.arcgis.com",portalHostname:"www.arcgis.com"}};function rK(t){const e=t==null?void 0:t.match(xRe);if(!e)return null;const[,r,i,s]=e;if(!r)return null;let n=null,o=null,a=null;const{devext:l,qaext:c,www:h}=TRe;if(i)if(n=r,s)switch(s.toLowerCase()){case"devext":({customBaseUrl:o,portalHostname:a}=l);break;case"qa":({customBaseUrl:o,portalHostname:a}=c);break;default:return null}else({customBaseUrl:o,portalHostname:a}=h);else switch(r.toLowerCase()){case"devext":({customBaseUrl:o,portalHostname:a}=l);break;case"qaext":({customBaseUrl:o,portalHostname:a}=c);break;case"www":({customBaseUrl:o,portalHostname:a}=h);break;default:return null}return{customBaseUrl:o,isPortal:!1,portalHostname:a,urlKey:n}}function SRe(t){return/\/(sharing|usrsvcs)\/(appservices|servers)\//i.test(t)}const ERe=se.getLogger("esri.core.urlUtils"),yE=Yr.request,iK="esri/config: esriConfig.request.proxyUrl is not set.",Jue=/^\s*[a-z][a-z0-9-+.]*:(?![0-9])/i,Kue=/^\s*http:/i,CRe=/^\s*https:/i,ARe=/^\s*file:/i,RRe=/:\d+$/,ORe=/^https?:\/\/[^/]+\.arcgis.com\/sharing(\/|$)/i,MRe=new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?$"),PRe=new RegExp("^((([^\\[:]+):)?([^@]+)@)?(\\[([^\\]]+)\\]|([^\\[:]*))(:([0-9]+))?$");let z2=class{constructor(e=""){this.uri=e,this.scheme=null,this.authority=null,this.path=null,this.query=null,this.fragment=null,this.user=null,this.password=null,this.host=null,this.port=null;let r=this.uri.match(MRe);this.scheme=r[2]||(r[1]?"":null),this.authority=r[4]||(r[3]?"":null),this.path=r[5],this.query=r[7]||(r[6]?"":null),this.fragment=r[9]||(r[8]?"":null),this.authority!=null&&(r=this.authority.match(PRe),this.user=r[3]||null,this.password=r[4]||null,this.host=r[6]||r[7],this.port=r[9]||null)}toString(){return this.uri}};const ZM={},IRe=new z2(Yr.applicationUrl);let qa=IRe;const $Re=LRe();let oq=$Re;const aq=()=>qa,iwt=()=>oq;function LRe(){const t=qa.path,e=t.substring(0,t.lastIndexOf(t.split("/")[t.split("/").length-1]));return`${`${qa.scheme}://${qa.host}${qa.port!=null?`:${qa.port}`:""}`}${e}`}function sl(t){if(!t)return null;const e={path:null,query:null},r=new z2(t),i=t.indexOf("?");return r.query===null?e.path=t:(e.path=t.substring(0,i),e.query=Que(r.query)),r.fragment&&(e.hash=r.fragment,r.query===null&&(e.path=e.path.substring(0,e.path.length-(r.fragment.length+1)))),e}function Que(t){const e=t.split("&"),r={};for(const i of e){if(!i)continue;const s=i.indexOf("=");let n,o;s<0?(n=decodeURIComponent(i),o=""):(n=decodeURIComponent(i.slice(0,s)),o=decodeURIComponent(i.slice(s+1)));let a=r[n];typeof a=="string"&&(a=r[n]=[a]),Array.isArray(a)?a.push(o):r[n]=o}return r}function sK(t){return t&&typeof t=="object"&&"toJSON"in t&&typeof t.toJSON=="function"}function DR(t,e){return t?e&&typeof e=="function"?Object.keys(t).map(r=>encodeURIComponent(r)+"="+encodeURIComponent(e(r,t[r]))).join("&"):Object.keys(t).map(r=>{const i=t[r];if(i==null)return"";const s=encodeURIComponent(r)+"=",n=e&&e[r];return n?s+encodeURIComponent(n(i)):Array.isArray(i)?i.map(o=>sK(o)?s+encodeURIComponent(JSON.stringify(o)):s+encodeURIComponent(o)).join("&"):sK(i)?s+encodeURIComponent(JSON.stringify(i)):s+encodeURIComponent(i)}).filter(r=>r).join("&"):""}function DRe(t=!1){let e,r=yE.proxyUrl;if(typeof t=="string"){e=zRe(t);const i=c4(t);i&&(r=i.proxyUrl)}else e=!!t;if(!r)throw ERe.warn(iK),new q("urlutils:proxy-not-set",iK);return e&&iV()&&(r=pq(r)),sl(r)}function swt(t){const e=c4(t);let r,i;if(e){const s=lq(e.proxyUrl);r=s.path,i=s.query?Que(s.query):null}if(r){const s=sl(t);t=r+"?"+s.path;const n=DR({...i,...s.query});n&&(t=`${t}?${n}`)}return t}const QE={path:"",query:""};function lq(t){const e=t.indexOf("?");return e!==-1?(QE.path=t.slice(0,e),QE.query=t.slice(e+1)):(QE.path=t,QE.query=null),QE}function ehe(t){return t=(t=KD(t=XRe(t=lq(t).path),!0)).toLowerCase()}function NRe(t){const e={proxyUrl:t.proxyUrl,urlPrefix:ehe(t.urlPrefix)},r=yE.proxyRules,i=e.urlPrefix;let s=r.length;for(let n=0;n<r.length;n++){const o=r[n].urlPrefix;if(i.indexOf(o)===0){if(i.length===o.length)return-1;s=n;break}o.indexOf(i)===0&&(s=n+1)}return r.splice(s,0,e),s}function c4(t){const e=yE.proxyRules,r=ehe(t);for(let i=0;i<e.length;i++)if(r.indexOf(e[i].urlPrefix)===0)return e[i]}function FRe(t,e){if(!t||!e)return!1;t=JD(t),e=JD(e);const r=rK(t),i=rK(e);return v(r)&&v(i)?r.portalHostname===i.portalHostname:!v(r)&&!v(i)&&wS(t,e,!0)}function the(t,e){return t=JD(t),e=JD(e),KD(t)===KD(e)}function JD(t){const e=(t=ip(t)).indexOf("/sharing");return e>0?t.substring(0,e):t.replace(/\/+$/,"")}function rhe(t){const e=i=>i==null||i instanceof RegExp&&i.test(t)||typeof i=="string"&&t.startsWith(i),r=yE.interceptors;if(r){for(const i of r)if(Array.isArray(i.urls)){if(i.urls.some(e))return i}else if(e(i.urls))return i}return null}function wS(t,e,r=!1){if(!t||!e)return!1;const i=nV(t),s=nV(e);return!(!r&&i.scheme!==s.scheme)&&i.host!=null&&s.host!=null&&i.host.toLowerCase()===s.host.toLowerCase()&&i.port===s.port}function cq(t){if(typeof t=="string"){if(!Au(t))return!0;t=nV(t)}if(wS(t,qa))return!0;const e=yE.trustedServers||[];for(let r=0;r<e.length;r++){const i=URe(e[r]);for(let s=0;s<i.length;s++)if(wS(t,i[s]))return!0}return!1}function URe(t){return ZM[t]||(dq(t)||im(t)?ZM[t]=[new z2(wu(t))]:ZM[t]=[new z2(`http://${t}`),new z2(`https://${t}`)]),ZM[t]}function wu(t,e=oq,r){return im(t)?r&&r.preserveProtocolRelative?t:qa.scheme==="http"&&qa.authority===sp(t).slice(2)?`http:${t}`:`https:${t}`:dq(t)?t:lw(t[0]==="/"?qRe(e):e,t)}function uq(t,e=oq,r){if(t==null||!Au(t))return t;const i=ip(t),s=i.toLowerCase(),n=ip(e).toLowerCase().replace(/\/+$/,""),o=r?ip(r).toLowerCase().replace(/\/+$/,""):null;if(o&&n.indexOf(o)!==0)return t;const a=(p,f,m)=>(m=p.indexOf(f,m))===-1?p.length:m;let l=a(s,"/",s.indexOf("//")+2),c=-1;for(;s.slice(0,l+1)===n.slice(0,l)+"/"&&(c=l+1,l!==s.length);)l=a(s,"/",l+1);if(c===-1||o&&c<o.length)return t;t=i.slice(c);const h=n.slice(c-1).replace(/[^/]+/g,"").length;if(h>0)for(let p=0;p<h;p++)t=`../${t}`;else t=`./${t}`;return t}function ip(t){return t=JRe(t=ZRe(t=YRe(t=wu(t=t.trim()))))}function lw(...t){const e=t.filter(v);if(!e||!e.length)return;const r=[];if(Au(e[0])){const s=e[0],n=s.indexOf("//");n!==-1&&(r.push(s.slice(0,n+1)),jRe(e[0])&&(r[0]+="/"),e[0]=s.slice(n+2))}else e[0][0]==="/"&&r.push("");const i=e.reduce((s,n)=>n?s.concat(n.split("/")):s,[]);for(let s=0;s<i.length;s++){const n=i[s];n===".."&&r.length>0&&r[r.length-1]!==".."?r.pop():(!n&&s===i.length-1||n&&(n!=="."||r.length===0))&&r.push(n)}return r.join("/")}function sp(t,e=!1){if(t==null||xS(t)||pm(t))return null;let r=t.indexOf("://");if(r===-1&&im(t))r=2;else{if(r===-1)return null;r+=3}const i=t.indexOf("/",r);return i!==-1&&(t=t.slice(0,i)),e&&(t=KD(t,!0)),t}function Au(t){return im(t)||dq(t)}function xS(t){return t!=null&&t.slice(0,5)==="blob:"}function pm(t){return t!=null&&t.slice(0,5)==="data:"}function hq(t){const e=ZO(t);if(!e||!e.isBase64)return null;const r=atob(e.data),i=new Uint8Array(r.length);for(let s=0;s<r.length;s++)i[s]=r.charCodeAt(s);return i.buffer}function nwt(t){return btoa(String.fromCharCode.apply(null,t)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}const kRe=/^data:(.*?)(;base64)?,(.*)$/;function ZO(t){const e=t.match(kRe);if(!e)return null;const[,r,i,s]=e;return{mediaType:r,isBase64:!!i,data:s}}function ihe(t){return t.isBase64?`data:${t.mediaType};base64,${t.data}`:`data:${t.mediaType},${t.data}`}function owt(t){const e=hq(t);if(!e)return null;const r=ZO(t);return new Blob([e],{type:r.mediaType})}function awt(t,e){VRe(t,e)||BRe(t,e)}function VRe(t,e){if(!t)return!1;const r=document.createElement("a");if(!("download"in r))return!1;const i=URL.createObjectURL(t);return r.download=e,r.href=i,r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i),!0}function BRe(t,e){return!!window.navigator.msSaveOrOpenBlob&&window.navigator.msSaveOrOpenBlob(t,e)}function im(t){return t!=null&&t[0]==="/"&&t[1]==="/"}function dq(t){return t!=null&&Jue.test(t)}function zRe(t){return t!=null&&CRe.test(t)||qa.scheme==="https"&&im(t)}function GRe(t){return t!=null&&Kue.test(t)||qa.scheme==="http"&&im(t)}function jRe(t){return t!=null&&ARe.test(t)}function pq(t){return im(t)?`https:${t}`:t.replace(Kue,"https:")}function HRe(){return qa.scheme==="http"}function iV(){return qa.scheme==="https"}function KD(t,e=!1){return im(t)?t.slice(2):(t=t.replace(Jue,""),e&&t.length>1&&t[0]==="/"&&t[1]==="/"&&(t=t.slice(2)),t)}function qRe(t){const e=t.indexOf("//"),r=t.indexOf("/",e+2);return r===-1?t:t.slice(0,r)}function WRe(t){let e=0;if(Au(t)){const i=t.indexOf("//");i!==-1&&(e=i+2)}const r=t.lastIndexOf("/");return r<e?t:t.slice(0,r+1)}function lwt(t,e){if(!t)return"";const r=sl(t).path.replace(/\/+$/,""),i=r.substring(r.lastIndexOf("/")+1);if(!(e!=null&&e.length))return i;const s=new RegExp(`.(${e.join("|")})$`,"ig");return i.replace(s,"")}function XRe(t){return t&&t[t.length-1]==="/"?t:`${t}/`}function she(t){return t.replace(/\/+$/,"")}function YRe(t){if(/^https?:\/\//i.test(t)){const e=lq(t);t=(t=e.path.replace(/\/{2,}/g,"/")).replace("/","//"),e.query&&(t+=`?${e.query}`)}return t}function ZRe(t){return t.replace(/^(https?:\/\/)(arcgis\.com)/i,"$1www.$2")}function JRe(t){const e=yE.httpsDomains;if(!GRe(t))return t;const r=t.indexOf("/",7);let i;if(i=r===-1?t:t.slice(0,r),i=i.toLowerCase().slice(7),RRe.test(i)){if(!i.endsWith(":80"))return t;i=i.slice(0,-3),t=t.replace(":80","")}return HRe()&&i===qa.authority&&!ORe.test(t)||(iV()&&i===qa.authority||e&&e.some(s=>i===s||i.endsWith(`.${s}`))||iV()&&!c4(t))&&(t=pq(t)),t}function sV(t,e,r){if(!(e&&r&&t&&Au(t)))return t;const i=t.indexOf("//"),s=t.indexOf("/",i+2),n=t.indexOf(":",i+2),o=Math.min(s<0?t.length:s,n<0?t.length:n);return t.slice(i+2,o).toLowerCase()!==e.toLowerCase()?t:`${t.slice(0,i+2)}${r}${t.slice(o)}`}function nV(t){return typeof t=="string"?new z2(wu(t)):(t.scheme||(t.scheme=qa.scheme),t)}function nhe(t){return KRe.test(t)}function ohe(t,e){const r=sl(t),i=Object.keys(r.query||{});return i.length>0&&e&&e.warn("removeQueryParameters()",`Url query parameters are not supported, the following parameters have been removed: ${i.join(", ")}.`),r.path}function ahe(t,e,r){const i=sl(t),s=i.query||{};return s[e]=String(r),`${i.path}?${DR(s)}`}function R6(t,e){const r=sl(t),i=r.query||{};for(const n in e)i[n]=e[n];const s=DR(i);return s?`${r.path}?${s}`:r.path}function cwt(t){if(C(t))return null;const e=t.match(lhe);return e?e[2]:null}function nK(t){if(C(t))return null;const e=t.match(lhe);return e?{path:e[1],extension:e[2]}:{path:t,extension:null}}const lhe=/([^.]*)\.([^\/]*)$/,KRe=/(^data:image\/svg|\.svg$)/i;function He(t,e,r){let i,s;return e===void 0?(s=t,i=[void 0]):typeof e!="string"?(s=t,i=[void 0],r=e):(s=e,i=Array.isArray(t)?t:[t]),(n,o)=>{const a=n.constructor.prototype;for(const l of i){const c=Rue(n,l,s);c.write&&typeof c.write=="object"||(c.write={}),r&&(c.write.target=r),c.write.writer=a[o]}}}let mr=class{constructor(e,r={ignoreUnknown:!1,useNumericKeys:!1}){this._jsonToAPI=e,this._options=r,this.apiValues=[],this.jsonValues=[],this._apiToJSON=this._invertMap(e),this.apiValues=this._getKeysSorted(this._apiToJSON),this.jsonValues=this._getKeysSorted(this._jsonToAPI),this.read=i=>this.fromJSON(i),this.write=(i,s,n)=>{const o=this.toJSON(i);o!==void 0&&el(n,o,s)},this.write.isJSONMapWriter=!0}toJSON(e){if(e==null)return null;if(this._apiToJSON.hasOwnProperty(e)){const r=this._apiToJSON[e];return this._options.useNumericKeys?+r:r}return this._options.ignoreUnknown?void 0:e}fromJSON(e){return e!=null&&this._jsonToAPI.hasOwnProperty(e)?this._jsonToAPI[e]:this._options.ignoreUnknown?void 0:e}_invertMap(e){const r={};for(const i in e)r[e[i]]=i;return r}_getKeysSorted(e){const r=[];for(const i in e)r.push(i);return r.sort(),r}};function Ta(){return function(t,e){return new mr(t,{ignoreUnknown:!0,...e})}}let fq=class{constructor(e,r,i,s){this.semiMajorAxis=e,this.flattening=r,this.outerAtmosphereRimWidth=i;const n=1-this.flattening;this.semiMinorAxis=this.semiMajorAxis*n,this.halfSemiMajorAxis=this.semiMajorAxis/2,this.halfCircumference=Math.PI*this.semiMajorAxis,this.metersPerDegree=this.halfCircumference/180,this.inverseFlattening=1/(1-this.flattening)-1,this.eccentricitySquared=s||2*this.flattening-this.flattening*this.flattening,this.meanRadiusSemiAxes=(2*this.semiMajorAxis+this.semiMinorAxis)/3}get radius(){return this.semiMajorAxis}};const wr=new fq(6378137,1/298.257223563,3e5,.006694379990137799),Gf=new fq(3396190,1/169.8944472236118,23e4),Jg=new fq(1737400,0,0);var Ah;(function(t){t[t.CGCS2000=4490]="CGCS2000",t[t.GCSMARS2000=104971]="GCSMARS2000",t[t.GCSMARS2000_SPHERE=104905]="GCSMARS2000_SPHERE",t[t.GCSMOON2000=104903]="GCSMOON2000"})(Ah||(Ah={}));let g;const D={values:[1,.3048,.3048006096012192,.3047972654,.9143917962,.201166195164,.9143984146160287,.3047994715386762,20.11676512155263,20.11678249437587,.9143985307444408,.91439523,.3047997101815088,20.1168,20.116756,5e4,15e4],units:["Meter","Foot","Foot_US","Foot_Clarke","Yard_Clarke","Link_Clarke","Yard_Sears","Foot_Sears","Chain_Sears","Chain_Benoit_1895_B","Yard_Indian","Yard_Indian_1937","Foot_Gold_Coast","Chain","Chain_Sears_1922_Truncated","50_Kilometers","150_Kilometers"],2066:5,2136:12,2155:2,2157:0,2158:0,2159:12,2160:12,2204:2,2219:0,2220:0,2254:2,2255:2,2256:1,2265:1,2266:1,2267:2,2268:2,2269:1,2270:1,2271:2,2272:2,2273:1,2294:0,2295:0,2314:3,2899:2,2900:2,2901:1,2909:1,2910:1,2911:2,2912:2,2913:1,2914:1,2992:1,2993:0,2994:1,3080:1,3089:2,3090:0,3091:2,3102:2,3141:0,3142:0,3167:14,3359:2,3360:0,3361:1,3362:0,3363:2,3364:0,3365:2,3366:3,3404:2,3405:0,3406:0,3407:3,3439:0,3440:0,3479:1,3480:0,3481:1,3482:0,3483:1,3484:0,3485:2,3486:0,3487:2,3488:0,3489:0,3490:2,3491:0,3492:2,3493:0,3494:2,3495:0,3496:2,3497:0,3498:2,3499:0,3500:2,3501:0,3502:2,3503:0,3504:2,3505:0,3506:2,3507:0,3508:2,3509:0,3510:2,3511:0,3512:2,3513:0,3514:0,3515:2,3516:0,3517:2,3518:0,3519:2,3520:0,3521:2,3522:0,3523:2,3524:0,3525:2,3526:0,3527:2,3528:0,3529:2,3530:0,3531:2,3532:0,3533:2,3534:0,3535:2,3536:0,3537:2,3538:0,3539:2,3540:0,3541:2,3542:0,3543:2,3544:0,3545:2,3546:0,3547:2,3548:0,3549:2,3550:0,3551:2,3552:0,3553:2,3582:2,3583:0,3584:2,3585:0,3586:2,3587:0,3588:1,3589:0,3590:1,3591:0,3592:0,3593:1,3598:2,3599:0,3600:2,3605:1,3606:0,3607:0,3608:2,3609:0,3610:2,3611:0,3612:2,3613:0,3614:2,3615:0,3616:2,3617:0,3618:2,3619:0,3620:2,3621:0,3622:2,3623:0,3624:2,3625:0,3626:2,3627:0,3628:2,3629:0,3630:2,3631:0,3632:2,3633:0,3634:1,3635:0,3636:1,3640:2,3641:0,3642:2,3643:0,3644:1,3645:0,3646:1,3647:0,3648:1,3649:0,3650:2,3651:0,3652:2,3653:0,3654:2,3655:0,3656:1,3657:0,3658:2,3659:0,3660:2,3661:0,3662:2,3663:0,3664:2,3668:2,3669:0,3670:2,3671:0,3672:2,3673:0,3674:2,3675:0,3676:1,3677:2,3678:0,3679:1,3680:2,3681:0,3682:1,3683:2,3684:0,3685:0,3686:2,3687:0,3688:2,3689:0,3690:2,3691:0,3692:2,3696:2,3697:0,3698:2,3699:0,3700:2,3793:0,3794:0,3812:0,3854:0,3857:0,3920:0,3978:0,3979:0,3991:2,3992:2,4026:0,4037:0,4038:0,4071:0,4082:0,4083:0,4087:0,4088:0,4217:2,4414:0,4415:0,4417:0,4434:0,4437:0,4438:2,4439:2,4462:0,4467:0,4471:0,4474:0,4559:0,4647:0,4822:0,4826:0,4839:0,5018:0,5041:0,5042:0,5048:0,5167:0,5168:0,5221:0,5223:0,5234:0,5235:0,5243:0,5247:0,5266:0,5316:0,5320:0,5321:0,5325:0,5337:0,5361:0,5362:0,5367:0,5382:0,5383:0,5396:0,5456:0,5457:0,5469:0,5472:4,5490:0,5513:0,5514:0,5523:0,5559:0,5588:1,5589:3,5596:0,5627:0,5629:0,5641:0,5643:0,5644:0,5646:2,5654:2,5655:2,5659:0,5700:0,5825:0,5836:0,5837:0,5839:0,5842:0,5844:0,5858:0,5879:0,5880:0,5887:0,5890:0,6128:1,6129:1,6141:1,6204:0,6210:0,6211:0,6307:0,6312:0,6316:0,6362:0,6391:1,6405:1,6406:0,6407:1,6408:0,6409:1,6410:0,6411:2,6412:0,6413:2,6414:0,6415:0,6416:2,6417:0,6418:2,6419:0,6420:2,6421:0,6422:2,6423:0,6424:2,6425:0,6426:2,6427:0,6428:2,6429:0,6430:2,6431:0,6432:2,6433:0,6434:2,6435:0,6436:2,6437:0,6438:2,6439:0,6440:0,6441:2,6442:0,6443:2,6444:0,6445:2,6446:0,6447:2,6448:0,6449:2,6450:0,6451:2,6452:0,6453:2,6454:0,6455:2,6456:0,6457:2,6458:0,6459:2,6460:0,6461:2,6462:0,6463:2,6464:0,6465:2,6466:0,6467:2,6468:0,6469:2,6470:0,6471:2,6472:0,6473:2,6474:0,6475:2,6476:0,6477:2,6478:0,6479:2,6484:2,6485:0,6486:2,6487:0,6488:2,6489:0,6490:2,6491:0,6492:2,6493:0,6494:1,6495:0,6496:1,6497:0,6498:0,6499:1,6500:0,6501:2,6502:0,6503:2,6504:0,6505:2,6506:0,6507:2,6508:0,6509:0,6510:2,6515:1,6516:0,6518:0,6519:2,6520:0,6521:2,6522:0,6523:2,6524:0,6525:2,6526:0,6527:2,6528:0,6529:2,6530:0,6531:2,6532:0,6533:2,6534:0,6535:2,6536:0,6537:2,6538:0,6539:2,6540:0,6541:2,6542:0,6543:2,6544:0,6545:1,6546:0,6547:1,6548:0,6549:2,6550:0,6551:2,6552:0,6553:2,6554:0,6555:2,6556:0,6557:1,6558:0,6559:1,6560:0,6561:1,6562:0,6563:2,6564:0,6565:2,6566:0,6567:0,6568:2,6569:0,6570:1,6571:0,6572:2,6573:0,6574:2,6575:0,6576:2,6577:0,6578:2,6582:2,6583:0,6584:2,6585:0,6586:2,6587:0,6588:2,6589:0,6590:2,6591:0,6592:0,6593:2,6594:0,6595:2,6596:0,6597:2,6598:0,6599:2,6600:0,6601:2,6602:0,6603:2,6605:2,6606:0,6607:2,6608:0,6609:2,6610:0,6611:0,6612:2,6613:0,6614:2,6615:0,6616:2,6617:0,6618:2,6633:2,6646:0,6703:0,6784:0,6785:1,6786:0,6787:1,6788:0,6789:1,6790:0,6791:1,6792:0,6793:1,6794:0,6795:1,6796:0,6797:1,6798:0,6799:1,6800:0,6801:1,6802:0,6803:1,6804:0,6805:1,6806:0,6807:1,6808:0,6809:1,6810:0,6811:1,6812:0,6813:1,6814:0,6815:1,6816:0,6817:1,6818:0,6819:1,6820:0,6821:1,6822:0,6823:1,6824:0,6825:1,6826:0,6827:1,6828:0,6829:1,6830:0,6831:1,6832:0,6833:1,6834:0,6835:1,6836:0,6837:1,6838:0,6839:1,6840:0,6841:1,6842:0,6843:1,6844:0,6845:1,6846:0,6847:1,6848:0,6849:1,6850:0,6851:1,6852:0,6853:1,6854:0,6855:1,6856:0,6857:1,6858:0,6859:1,6860:0,6861:1,6862:0,6863:1,6867:0,6868:1,6870:0,6875:0,6876:0,6879:0,6880:2,6884:0,6885:1,6886:0,6887:1,6915:0,6922:0,6923:2,6924:0,6925:2,6962:0,6984:0,6991:0,7128:2,7131:0,7132:2,7142:0,7257:0,7258:2,7259:0,7260:2,7261:0,7262:2,7263:0,7264:2,7265:0,7266:2,7267:0,7268:2,7269:0,7270:2,7271:0,7272:2,7273:0,7274:2,7275:0,7276:2,7277:0,7278:2,7279:0,7280:2,7281:0,7282:2,7283:0,7284:2,7285:0,7286:2,7287:0,7288:2,7289:0,7290:2,7291:0,7292:2,7293:0,7294:2,7295:0,7296:2,7297:0,7298:2,7299:0,7300:2,7301:0,7302:2,7303:0,7304:2,7305:0,7306:2,7307:0,7308:2,7309:0,7310:2,7311:0,7312:2,7313:0,7314:2,7315:0,7316:2,7317:0,7318:2,7319:0,7320:2,7321:0,7322:2,7323:0,7324:2,7325:0,7326:2,7327:0,7328:2,7329:0,7330:2,7331:0,7332:2,7333:0,7334:2,7335:0,7336:2,7337:0,7338:2,7339:0,7340:2,7341:0,7342:2,7343:0,7344:2,7345:0,7346:2,7347:0,7348:2,7349:0,7350:2,7351:0,7352:2,7353:0,7354:2,7355:0,7356:2,7357:0,7358:2,7359:0,7360:2,7361:0,7362:2,7363:0,7364:2,7365:0,7366:2,7367:0,7368:2,7369:0,7370:2,7877:0,7878:0,7882:0,7883:0,7887:0,7899:0,7991:0,7992:0,8035:2,8036:2,8058:0,8059:0,8082:0,8083:0,8088:0,8090:0,8091:2,8092:0,8093:2,8095:0,8096:2,8097:0,8098:2,8099:0,8100:2,8101:0,8102:2,8103:0,8104:2,8105:0,8106:2,8107:0,8108:2,8109:0,8110:2,8111:0,8112:2,8113:0,8114:2,8115:0,8116:2,8117:0,8118:2,8119:0,8120:2,8121:0,8122:2,8123:0,8124:2,8125:0,8126:2,8127:0,8128:2,8129:0,8130:2,8131:0,8132:2,8133:0,8134:2,8135:0,8136:2,8137:0,8138:2,8139:0,8140:2,8141:0,8142:2,8143:0,8144:2,8145:0,8146:2,8147:0,8148:2,8149:0,8150:2,8151:0,8152:2,8153:0,8154:2,8155:0,8156:2,8157:0,8158:2,8159:0,8160:2,8161:0,8162:2,8163:0,8164:2,8165:0,8166:2,8167:0,8168:2,8169:0,8170:2,8171:0,8172:2,8173:0,8177:2,8179:0,8180:2,8181:0,8182:2,8184:0,8185:2,8187:0,8189:2,8191:0,8193:2,8196:0,8197:2,8198:0,8200:2,8201:0,8202:2,8203:0,8204:2,8205:0,8206:2,8207:0,8208:2,8209:0,8210:2,8212:0,8213:2,8214:0,8216:2,8218:0,8220:2,8222:0,8224:2,8225:0,8226:2,8311:0,8312:1,8313:0,8314:1,8315:0,8316:1,8317:0,8318:1,8319:0,8320:1,8321:0,8322:1,8323:0,8324:1,8325:0,8326:1,8327:0,8328:1,8329:0,8330:1,8331:0,8332:1,8333:0,8334:1,8335:0,8336:1,8337:0,8338:1,8339:0,8340:1,8341:0,8342:1,8343:0,8344:1,8345:0,8346:1,8347:0,8348:1,8352:0,8353:0,8379:0,8380:2,8381:0,8382:2,8383:0,8384:2,8385:0,8387:2,8391:0,8395:0,8433:0,8441:0,8455:0,8456:0,8531:2,8682:0,8686:0,8687:0,8692:0,8693:0,8826:0,8903:0,8950:0,8951:0,9039:0,9040:0,9141:0,9149:0,9150:0,9191:0,9221:0,9222:0,9249:0,9250:0,9252:0,9254:0,9265:0,9284:0,9285:0,9300:0,9354:0,9367:0,9373:0,9377:0,9387:0,9391:0,9456:0,9473:0,9498:0,9674:0,9678:0,9680:0,9709:0,9712:0,9713:0,9716:0,9741:0,9748:2,9749:2,9761:0,9766:0,9793:0,9794:0,9869:0,9874:0,9875:0,9880:0,9943:0,9945:0,9947:0,9967:0,9972:0,9977:0,20042:0,20050:1,20499:0,20538:0,20539:0,20790:0,20791:0,21291:0,21292:0,21500:0,21817:0,21818:0,22032:0,22033:0,22091:0,22092:0,22239:0,22240:0,22332:0,22337:0,22338:0,22391:0,22392:0,22639:0,22700:0,22739:0,22770:0,22780:0,22832:0,23090:0,23095:0,23239:0,23240:0,23433:0,23700:0,24047:0,24048:0,24100:3,24200:0,24305:0,24306:0,24382:10,24383:0,24500:0,24547:0,24548:0,24571:9,24600:0,25e3:0,25231:0,25884:0,25932:0,26237:0,26331:0,26332:0,26432:0,26591:0,26592:0,26632:0,26692:0,27120:0,27200:0,27291:6,27292:6,27429:0,27492:0,27493:0,27500:0,27700:0,28232:0,28600:0,28991:0,28992:0,29100:0,29101:0,29220:0,29221:0,29333:0,29635:0,29636:0,29701:0,29738:0,29739:0,29849:0,29850:0,29871:8,29872:7,29873:0,29874:0,30200:5,30339:0,30340:0,30591:0,30592:0,30791:0,30792:0,30800:0,31028:0,31121:0,31154:0,31170:0,31171:0,31370:0,31528:0,31529:0,31600:0,31700:0,31838:0,31839:0,31900:0,31901:0,32061:0,32062:0,32098:0,32099:2,32100:0,32104:0,32161:0,32766:0,53048:0,53049:0,54090:0,54091:0,65061:2,65062:2,65161:0,65163:0,102041:2,102064:11,102068:15,102069:16,102118:2,102119:1,102120:2,102121:2,102217:2,102218:0,102219:2,102220:2,102378:1,102379:1,102380:0,102381:1,102589:2,102599:2,102600:2,102604:2,102647:0,102704:2,102705:2,102706:0,102731:0,102732:0,102759:1,102760:1,102761:2,102762:0,102763:2,102764:0,102765:0,102766:2,102970:1,102974:2,102993:0,102994:0,102995:2,102996:2,103015:0,103016:2,103017:0,103018:2,103025:0,103026:0,103027:2,103028:2,103035:0,103036:0,103037:2,103038:2,103039:0,103040:0,103041:2,103042:2,103043:0,103044:0,103045:2,103046:2,103047:0,103048:0,103049:2,103050:2,103051:0,103052:2,103053:0,103054:2,103055:0,103056:2,103057:0,103058:0,103059:2,103060:2,103061:0,103062:0,103063:2,103064:2,103069:2,103070:0,103071:0,103072:2,103073:2,103086:0,103087:0,103088:2,103089:2,103094:1,103095:0,103096:2,103103:0,103104:2,103105:0,103106:2,103121:0,103122:2,103123:0,103124:0,103125:1,103126:1,103127:0,103128:0,103129:2,103130:2,103131:0,103132:0,103133:2,103134:2,103135:0,103136:0,103137:1,103138:1,103139:0,103140:2,103141:0,103142:2,103143:0,103144:2,103145:0,103146:1,103147:0,103148:0,103149:2,103150:2,103151:0,103152:2,103172:0,103173:2,103174:0,103175:0,103176:2,103177:2,103178:0,103179:0,103180:2,103181:2,103182:0,103183:0,103184:2,103185:2,103228:0,103229:0,103230:2,103231:2,103250:0,103251:2,103252:0,103253:2,103260:0,103261:0,103262:2,103263:2,103270:0,103271:0,103272:2,103273:2,103274:0,103275:0,103276:2,103277:2,103278:0,103279:0,103280:2,103281:2,103282:0,103283:0,103284:2,103285:2,103286:0,103287:2,103288:0,103289:2,103290:0,103291:2,103292:0,103293:0,103294:2,103295:2,103296:0,103297:0,103298:2,103299:2,103376:2,103377:0,103378:0,103379:2,103380:2,103393:0,103394:0,103395:2,103396:2,103472:0,103473:1,103474:0,103475:2,103482:0,103483:2,103484:0,103485:2,103500:0,103501:2,103502:0,103503:0,103504:1,103505:1,103506:0,103507:0,103508:2,103509:2,103510:0,103511:0,103512:2,103513:2,103514:0,103515:2,103516:0,103517:2,103518:0,103519:2,103520:0,103521:1,103522:0,103523:0,103524:2,103525:2,103526:0,103527:2,103561:2,103562:2,103563:0,103564:0,103565:2,103566:2,103567:0,103568:0,103569:2,103570:2,103584:0,103585:2,103586:0,103587:2,103588:1,103589:0,103590:2,103591:1,103592:0,103593:2,103594:1,103695:2};for(g=2e3;g<=2045;g++)D[g]=0;for(g=2056;g<=2065;g++)D[g]=0;for(g=2067;g<=2135;g++)D[g]=0;for(g=2137;g<=2154;g++)D[g]=0;for(g=2161;g<=2170;g++)D[g]=0;for(g=2172;g<=2193;g++)D[g]=0;for(g=2195;g<=2198;g++)D[g]=0;for(g=2200;g<=2203;g++)D[g]=0;for(g=2205;g<=2217;g++)D[g]=0;for(g=2222;g<=2224;g++)D[g]=1;for(g=2225;g<=2250;g++)D[g]=2;for(g=2251;g<=2253;g++)D[g]=1;for(g=2257;g<=2264;g++)D[g]=2;for(g=2274;g<=2279;g++)D[g]=2;for(g=2280;g<=2282;g++)D[g]=1;for(g=2283;g<=2289;g++)D[g]=2;for(g=2290;g<=2292;g++)D[g]=0;for(g=2308;g<=2313;g++)D[g]=0;for(g=2315;g<=2491;g++)D[g]=0;for(g=2494;g<=2866;g++)D[g]=0;for(g=2867;g<=2869;g++)D[g]=1;for(g=2870;g<=2888;g++)D[g]=2;for(g=2891;g<=2895;g++)D[g]=2;for(g=2896;g<=2898;g++)D[g]=1;for(g=2902;g<=2908;g++)D[g]=2;for(g=2915;g<=2920;g++)D[g]=2;for(g=2921;g<=2923;g++)D[g]=1;for(g=2924;g<=2930;g++)D[g]=2;for(g=2931;g<=2962;g++)D[g]=0;for(g=2964;g<=2968;g++)D[g]=2;for(g=2969;g<=2973;g++)D[g]=0;for(g=2975;g<=2991;g++)D[g]=0;for(g=2995;g<=3051;g++)D[g]=0;for(g=3054;g<=3079;g++)D[g]=0;for(g=3081;g<=3088;g++)D[g]=0;for(g=3092;g<=3101;g++)D[g]=0;for(g=3106;g<=3138;g++)D[g]=0;for(g=3146;g<=3151;g++)D[g]=0;for(g=3153;g<=3166;g++)D[g]=0;for(g=3168;g<=3172;g++)D[g]=0;for(g=3174;g<=3203;g++)D[g]=0;for(g=3294;g<=3358;g++)D[g]=0;for(g=3367;g<=3403;g++)D[g]=0;for(g=3408;g<=3416;g++)D[g]=0;for(g=3417;g<=3438;g++)D[g]=2;for(g=3441;g<=3446;g++)D[g]=2;for(g=3447;g<=3450;g++)D[g]=0;for(g=3451;g<=3459;g++)D[g]=2;for(g=3460;g<=3478;g++)D[g]=0;for(g=3554;g<=3559;g++)D[g]=0;for(g=3560;g<=3570;g++)D[g]=2;for(g=3571;g<=3581;g++)D[g]=0;for(g=3594;g<=3597;g++)D[g]=0;for(g=3601;g<=3604;g++)D[g]=0;for(g=3637;g<=3639;g++)D[g]=0;for(g=3665;g<=3667;g++)D[g]=0;for(g=3693;g<=3695;g++)D[g]=0;for(g=3701;g<=3727;g++)D[g]=0;for(g=3728;g<=3739;g++)D[g]=2;for(g=3740;g<=3751;g++)D[g]=0;for(g=3753;g<=3760;g++)D[g]=2;for(g=3761;g<=3773;g++)D[g]=0;for(g=3775;g<=3777;g++)D[g]=0;for(g=3779;g<=3781;g++)D[g]=0;for(g=3783;g<=3785;g++)D[g]=0;for(g=3788;g<=3791;g++)D[g]=0;for(g=3797;g<=3802;g++)D[g]=0;for(g=3814;g<=3816;g++)D[g]=0;for(g=3825;g<=3829;g++)D[g]=0;for(g=3832;g<=3841;g++)D[g]=0;for(g=3844;g<=3852;g++)D[g]=0;for(g=3873;g<=3885;g++)D[g]=0;for(g=3890;g<=3893;g++)D[g]=0;for(g=3907;g<=3912;g++)D[g]=0;for(g=3942;g<=3950;g++)D[g]=0;for(g=3968;g<=3970;g++)D[g]=0;for(g=3973;g<=3976;g++)D[g]=0;for(g=3986;g<=3989;g++)D[g]=0;for(g=3994;g<=3997;g++)D[g]=0;for(g=4048;g<=4051;g++)D[g]=0;for(g=4056;g<=4063;g++)D[g]=0;for(g=4093;g<=4096;g++)D[g]=0;for(g=4390;g<=4398;g++)D[g]=0;for(g=4399;g<=4413;g++)D[g]=2;for(g=4418;g<=4433;g++)D[g]=2;for(g=4455;g<=4457;g++)D[g]=2;for(g=4484;g<=4489;g++)D[g]=0;for(g=4491;g<=4554;g++)D[g]=0;for(g=4568;g<=4589;g++)D[g]=0;for(g=4652;g<=4656;g++)D[g]=0;for(g=4766;g<=4800;g++)D[g]=0;for(g=5014;g<=5016;g++)D[g]=0;for(g=5069;g<=5072;g++)D[g]=0;for(g=5105;g<=5130;g++)D[g]=0;for(g=5173;g<=5188;g++)D[g]=0;for(g=5253;g<=5259;g++)D[g]=0;for(g=5269;g<=5275;g++)D[g]=0;for(g=5292;g<=5311;g++)D[g]=0;for(g=5329;g<=5331;g++)D[g]=0;for(g=5343;g<=5349;g++)D[g]=0;for(g=5355;g<=5357;g++)D[g]=0;for(g=5387;g<=5389;g++)D[g]=0;for(g=5459;g<=5463;g++)D[g]=0;for(g=5479;g<=5482;g++)D[g]=0;for(g=5518;g<=5520;g++)D[g]=0;for(g=5530;g<=5539;g++)D[g]=0;for(g=5550;g<=5552;g++)D[g]=0;for(g=5562;g<=5583;g++)D[g]=0;for(g=5623;g<=5625;g++)D[g]=2;for(g=5631;g<=5639;g++)D[g]=0;for(g=5649;g<=5653;g++)D[g]=0;for(g=5663;g<=5680;g++)D[g]=0;for(g=5682;g<=5685;g++)D[g]=0;for(g=5875;g<=5877;g++)D[g]=0;for(g=5896;g<=5899;g++)D[g]=0;for(g=5921;g<=5940;g++)D[g]=0;for(g=6050;g<=6125;g++)D[g]=0;for(g=6244;g<=6275;g++)D[g]=0;for(g=6328;g<=6348;g++)D[g]=0;for(g=6350;g<=6356;g++)D[g]=0;for(g=6366;g<=6372;g++)D[g]=0;for(g=6381;g<=6387;g++)D[g]=0;for(g=6393;g<=6404;g++)D[g]=0;for(g=6480;g<=6483;g++)D[g]=0;for(g=6511;g<=6514;g++)D[g]=0;for(g=6579;g<=6581;g++)D[g]=0;for(g=6619;g<=6624;g++)D[g]=0;for(g=6625;g<=6627;g++)D[g]=2;for(g=6628;g<=6632;g++)D[g]=0;for(g=6634;g<=6637;g++)D[g]=0;for(g=6669;g<=6692;g++)D[g]=0;for(g=6707;g<=6709;g++)D[g]=0;for(g=6720;g<=6723;g++)D[g]=0;for(g=6732;g<=6738;g++)D[g]=0;for(g=6931;g<=6933;g++)D[g]=0;for(g=6956;g<=6959;g++)D[g]=0;for(g=7005;g<=7007;g++)D[g]=0;for(g=7057;g<=7070;g++)D[g]=2;for(g=7074;g<=7082;g++)D[g]=0;for(g=7109;g<=7118;g++)D[g]=0;for(g=7119;g<=7127;g++)D[g]=1;for(g=7374;g<=7376;g++)D[g]=0;for(g=7528;g<=7586;g++)D[g]=0;for(g=7587;g<=7645;g++)D[g]=2;for(g=7692;g<=7696;g++)D[g]=0;for(g=7755;g<=7787;g++)D[g]=0;for(g=7791;g<=7795;g++)D[g]=0;for(g=7799;g<=7801;g++)D[g]=0;for(g=7803;g<=7805;g++)D[g]=0;for(g=7825;g<=7831;g++)D[g]=0;for(g=7845;g<=7859;g++)D[g]=0;for(g=8013;g<=8032;g++)D[g]=0;for(g=8065;g<=8068;g++)D[g]=1;for(g=8518;g<=8529;g++)D[g]=2;for(g=8533;g<=8536;g++)D[g]=2;for(g=8538;g<=8540;g++)D[g]=2;for(g=8677;g<=8679;g++)D[g]=0;for(g=8836;g<=8840;g++)D[g]=0;for(g=8857;g<=8859;g++)D[g]=0;for(g=8908;g<=8910;g++)D[g]=0;for(g=9154;g<=9159;g++)D[g]=0;for(g=9205;g<=9218;g++)D[g]=0;for(g=9271;g<=9273;g++)D[g]=0;for(g=9295;g<=9297;g++)D[g]=0;for(g=9356;g<=9360;g++)D[g]=0;for(g=9404;g<=9407;g++)D[g]=0;for(g=9476;g<=9482;g++)D[g]=0;for(g=9487;g<=9494;g++)D[g]=0;for(g=9697;g<=9699;g++)D[g]=0;for(g=9821;g<=9865;g++)D[g]=0;for(g=20002;g<=20032;g++)D[g]=0;for(g=20047;g<=20049;g++)D[g]=0;for(g=20062;g<=20092;g++)D[g]=0;for(g=20135;g<=20138;g++)D[g]=0;for(g=20248;g<=20258;g++)D[g]=0;for(g=20348;g<=20358;g++)D[g]=0;for(g=20436;g<=20440;g++)D[g]=0;for(g=20822;g<=20824;g++)D[g]=0;for(g=20904;g<=20932;g++)D[g]=0;for(g=20934;g<=20936;g++)D[g]=0;for(g=21004;g<=21032;g++)D[g]=0;for(g=21035;g<=21037;g++)D[g]=0;for(g=21095;g<=21097;g++)D[g]=0;for(g=21148;g<=21150;g++)D[g]=0;for(g=21207;g<=21264;g++)D[g]=0;for(g=21307;g<=21364;g++)D[g]=0;for(g=21413;g<=21423;g++)D[g]=0;for(g=21453;g<=21463;g++)D[g]=0;for(g=21473;g<=21483;g++)D[g]=0;for(g=21780;g<=21782;g++)D[g]=0;for(g=21891;g<=21894;g++)D[g]=0;for(g=21896;g<=21899;g++)D[g]=0;for(g=22171;g<=22177;g++)D[g]=0;for(g=22181;g<=22187;g++)D[g]=0;for(g=22191;g<=22197;g++)D[g]=0;for(g=22207;g<=22222;g++)D[g]=0;for(g=22234;g<=22236;g++)D[g]=0;for(g=22243;g<=22250;g++)D[g]=0;for(g=22262;g<=22265;g++)D[g]=0;for(g=22307;g<=22322;g++)D[g]=0;for(g=22348;g<=22357;g++)D[g]=0;for(g=22407;g<=22422;g++)D[g]=0;for(g=22462;g<=22465;g++)D[g]=0;for(g=22521;g<=22525;g++)D[g]=0;for(g=22607;g<=22622;g++)D[g]=0;for(g=22641;g<=22646;g++)D[g]=0;for(g=22648;g<=22657;g++)D[g]=0;for(g=22707;g<=22722;g++)D[g]=0;for(g=22762;g<=22765;g++)D[g]=0;for(g=22991;g<=22994;g++)D[g]=0;for(g=23028;g<=23038;g++)D[g]=0;for(g=23830;g<=23853;g++)D[g]=0;for(g=23866;g<=23872;g++)D[g]=0;for(g=23877;g<=23884;g++)D[g]=0;for(g=23886;g<=23894;g++)D[g]=0;for(g=23946;g<=23948;g++)D[g]=0;for(g=24311;g<=24313;g++)D[g]=0;for(g=24342;g<=24347;g++)D[g]=0;for(g=24370;g<=24374;g++)D[g]=10;for(g=24375;g<=24381;g++)D[g]=0;for(g=24718;g<=24721;g++)D[g]=0;for(g=24817;g<=24821;g++)D[g]=0;for(g=24877;g<=24882;g++)D[g]=0;for(g=24891;g<=24893;g++)D[g]=0;for(g=25391;g<=25395;g++)D[g]=0;for(g=25828;g<=25838;g++)D[g]=0;for(g=26191;g<=26195;g++)D[g]=0;for(g=26391;g<=26393;g++)D[g]=0;for(g=26701;g<=26722;g++)D[g]=0;for(g=26729;g<=26799;g++)D[g]=2;for(g=26801;g<=26803;g++)D[g]=2;for(g=26811;g<=26813;g++)D[g]=2;for(g=26847;g<=26870;g++)D[g]=2;for(g=26891;g<=26899;g++)D[g]=0;for(g=26901;g<=26923;g++)D[g]=0;for(g=26929;g<=26946;g++)D[g]=0;for(g=26948;g<=26998;g++)D[g]=0;for(g=27037;g<=27040;g++)D[g]=0;for(g=27205;g<=27232;g++)D[g]=0;for(g=27258;g<=27260;g++)D[g]=0;for(g=27391;g<=27398;g++)D[g]=0;for(g=27561;g<=27564;g++)D[g]=0;for(g=27571;g<=27574;g++)D[g]=0;for(g=27581;g<=27584;g++)D[g]=0;for(g=27591;g<=27594;g++)D[g]=0;for(g=28191;g<=28193;g++)D[g]=0;for(g=28348;g<=28358;g++)D[g]=0;for(g=28402;g<=28432;g++)D[g]=0;for(g=28462;g<=28492;g++)D[g]=0;for(g=29118;g<=29122;g++)D[g]=0;for(g=29168;g<=29172;g++)D[g]=0;for(g=29177;g<=29185;g++)D[g]=0;for(g=29187;g<=29195;g++)D[g]=0;for(g=29900;g<=29903;g++)D[g]=0;for(g=30161;g<=30179;g++)D[g]=0;for(g=30491;g<=30494;g++)D[g]=0;for(g=30729;g<=30732;g++)D[g]=0;for(g=31251;g<=31259;g++)D[g]=0;for(g=31265;g<=31268;g++)D[g]=0;for(g=31275;g<=31279;g++)D[g]=0;for(g=31281;g<=31297;g++)D[g]=0;for(g=31461;g<=31469;g++)D[g]=0;for(g=31491;g<=31495;g++)D[g]=0;for(g=31917;g<=31922;g++)D[g]=0;for(g=31965;g<=32e3;g++)D[g]=0;for(g=32001;g<=32003;g++)D[g]=2;for(g=32005;g<=32031;g++)D[g]=2;for(g=32033;g<=32060;g++)D[g]=2;for(g=32064;g<=32067;g++)D[g]=2;for(g=32074;g<=32077;g++)D[g]=2;for(g=32081;g<=32086;g++)D[g]=0;for(g=32107;g<=32130;g++)D[g]=0;for(g=32133;g<=32159;g++)D[g]=0;for(g=32164;g<=32167;g++)D[g]=2;for(g=32180;g<=32199;g++)D[g]=0;for(g=32201;g<=32260;g++)D[g]=0;for(g=32301;g<=32360;g++)D[g]=0;for(g=32601;g<=32662;g++)D[g]=0;for(g=32664;g<=32667;g++)D[g]=2;for(g=32701;g<=32761;g++)D[g]=0;for(g=53001;g<=53004;g++)D[g]=0;for(g=53008;g<=53019;g++)D[g]=0;for(g=53021;g<=53032;g++)D[g]=0;for(g=53034;g<=53037;g++)D[g]=0;for(g=53042;g<=53046;g++)D[g]=0;for(g=53074;g<=53080;g++)D[g]=0;for(g=54001;g<=54004;g++)D[g]=0;for(g=54008;g<=54019;g++)D[g]=0;for(g=54021;g<=54032;g++)D[g]=0;for(g=54034;g<=54037;g++)D[g]=0;for(g=54042;g<=54046;g++)D[g]=0;for(g=54048;g<=54053;g++)D[g]=0;for(g=54074;g<=54080;g++)D[g]=0;for(g=54098;g<=54101;g++)D[g]=0;for(g=102001;g<=102040;g++)D[g]=0;for(g=102042;g<=102063;g++)D[g]=0;for(g=102065;g<=102067;g++)D[g]=0;for(g=102070;g<=102117;g++)D[g]=0;for(g=102122;g<=102216;g++)D[g]=0;for(g=102221;g<=102377;g++)D[g]=0;for(g=102382;g<=102388;g++)D[g]=0;for(g=102389;g<=102398;g++)D[g]=2;for(g=102399;g<=102444;g++)D[g]=0;for(g=102445;g<=102447;g++)D[g]=2;for(g=102448;g<=102458;g++)D[g]=0;for(g=102459;g<=102468;g++)D[g]=2;for(g=102469;g<=102499;g++)D[g]=0;for(g=102500;g<=102519;g++)D[g]=1;for(g=102520;g<=102524;g++)D[g]=0;for(g=102525;g<=102529;g++)D[g]=2;for(g=102530;g<=102588;g++)D[g]=0;for(g=102590;g<=102598;g++)D[g]=0;for(g=102601;g<=102603;g++)D[g]=0;for(g=102605;g<=102628;g++)D[g]=0;for(g=102629;g<=102646;g++)D[g]=2;for(g=102648;g<=102700;g++)D[g]=2;for(g=102701;g<=102703;g++)D[g]=0;for(g=102707;g<=102730;g++)D[g]=2;for(g=102733;g<=102758;g++)D[g]=2;for(g=102767;g<=102900;g++)D[g]=0;for(g=102901;g<=102933;g++)D[g]=2;for(g=102934;g<=102950;g++)D[g]=13;for(g=102951;g<=102955;g++)D[g]=0;for(g=102961;g<=102963;g++)D[g]=0;for(g=102965;g<=102969;g++)D[g]=0;for(g=102971;g<=102973;g++)D[g]=0;for(g=102975;g<=102989;g++)D[g]=0;for(g=102990;g<=102992;g++)D[g]=1;for(g=102997;g<=103002;g++)D[g]=0;for(g=103003;g<=103008;g++)D[g]=2;for(g=103009;g<=103011;g++)D[g]=0;for(g=103012;g<=103014;g++)D[g]=2;for(g=103019;g<=103021;g++)D[g]=0;for(g=103022;g<=103024;g++)D[g]=2;for(g=103029;g<=103031;g++)D[g]=0;for(g=103032;g<=103034;g++)D[g]=2;for(g=103065;g<=103068;g++)D[g]=0;for(g=103074;g<=103076;g++)D[g]=0;for(g=103077;g<=103079;g++)D[g]=1;for(g=103080;g<=103082;g++)D[g]=0;for(g=103083;g<=103085;g++)D[g]=2;for(g=103090;g<=103093;g++)D[g]=0;for(g=103097;g<=103099;g++)D[g]=0;for(g=103100;g<=103102;g++)D[g]=2;for(g=103107;g<=103109;g++)D[g]=0;for(g=103110;g<=103112;g++)D[g]=2;for(g=103113;g<=103116;g++)D[g]=0;for(g=103117;g<=103120;g++)D[g]=2;for(g=103153;g<=103157;g++)D[g]=0;for(g=103158;g<=103162;g++)D[g]=2;for(g=103163;g<=103165;g++)D[g]=0;for(g=103166;g<=103168;g++)D[g]=1;for(g=103169;g<=103171;g++)D[g]=2;for(g=103186;g<=103188;g++)D[g]=0;for(g=103189;g<=103191;g++)D[g]=2;for(g=103192;g<=103195;g++)D[g]=0;for(g=103196;g<=103199;g++)D[g]=2;for(g=103200;g<=103224;g++)D[g]=0;for(g=103225;g<=103227;g++)D[g]=1;for(g=103232;g<=103237;g++)D[g]=0;for(g=103238;g<=103243;g++)D[g]=2;for(g=103244;g<=103246;g++)D[g]=0;for(g=103247;g<=103249;g++)D[g]=2;for(g=103254;g<=103256;g++)D[g]=0;for(g=103257;g<=103259;g++)D[g]=2;for(g=103264;g<=103266;g++)D[g]=0;for(g=103267;g<=103269;g++)D[g]=2;for(g=103300;g<=103375;g++)D[g]=0;for(g=103381;g<=103383;g++)D[g]=0;for(g=103384;g<=103386;g++)D[g]=1;for(g=103387;g<=103389;g++)D[g]=0;for(g=103390;g<=103392;g++)D[g]=2;for(g=103397;g<=103399;g++)D[g]=0;for(g=103400;g<=103471;g++)D[g]=2;for(g=103476;g<=103478;g++)D[g]=0;for(g=103479;g<=103481;g++)D[g]=2;for(g=103486;g<=103488;g++)D[g]=0;for(g=103489;g<=103491;g++)D[g]=2;for(g=103492;g<=103495;g++)D[g]=0;for(g=103496;g<=103499;g++)D[g]=2;for(g=103528;g<=103543;g++)D[g]=0;for(g=103544;g<=103548;g++)D[g]=2;for(g=103549;g<=103551;g++)D[g]=0;for(g=103552;g<=103554;g++)D[g]=1;for(g=103555;g<=103557;g++)D[g]=2;for(g=103558;g<=103560;g++)D[g]=0;for(g=103571;g<=103573;g++)D[g]=0;for(g=103574;g<=103576;g++)D[g]=2;for(g=103577;g<=103580;g++)D[g]=0;for(g=103581;g<=103583;g++)D[g]=2;for(g=103595;g<=103694;g++)D[g]=0;for(g=103696;g<=103699;g++)D[g]=0;for(g=103700;g<=103793;g++)D[g]=2;for(g=103794;g<=103890;g++)D[g]=0;for(g=103891;g<=103896;g++)D[g]=2;for(g=103900;g<=103971;g++)D[g]=2;for(g=103972;g<=103977;g++)D[g]=0;for(g=112e3;g<=112101;g++)D[g]=0;const QRe={102113:!0,102100:!0,3857:!0,3785:!0},eOe={4326:!0,3785:!0,3857:!0,102113:!0,102100:!0,104905:!0,104971:!0},oK='PROJCS["WGS_1984_Web_Mercator_Auxiliary_Sphere",GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Mercator_Auxiliary_Sphere"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],PARAMETER["Standard_Parallel_1",0.0],PARAMETER["Auxiliary_Sphere_Type",0.0],UNIT["Meter",1.0]]',JM=[-20037508342788905e-9,20037508342788905e-9],KM=[-20037508342787e-6,20037508342787e-6],che={102113:{wkTemplate:'PROJCS["WGS_1984_Web_Mercator",GEOGCS["GCS_WGS_1984_Major_Auxiliary_Sphere",DATUM["D_WGS_1984_Major_Auxiliary_Sphere",SPHEROID["WGS_1984_Major_Auxiliary_Sphere",6378137.0,0.0]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Mercator"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],PARAMETER["Standard_Parallel_1",0.0],UNIT["Meter",1.0]]',valid:JM,origin:KM,dx:1e-5},102100:{wkTemplate:oK,valid:JM,origin:KM,dx:1e-5},3785:{wkTemplate:'PROJCS["WGS_1984_Web_Mercator",GEOGCS["GCS_WGS_1984_Major_Auxiliary_Sphere",DATUM["D_WGS_1984_Major_Auxiliary_Sphere",SPHEROID["WGS_1984_Major_Auxiliary_Sphere",6378137.0,0.0]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Mercator"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],PARAMETER["Standard_Parallel_1",0.0],UNIT["Meter",1.0]]',valid:JM,origin:KM,dx:1e-5},3857:{wkTemplate:oK,valid:JM,origin:KM,dx:1e-5},4326:{wkTemplate:'GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",{Central_Meridian}],UNIT["Degree",0.0174532925199433]]',altTemplate:'PROJCS["WGS_1984_Plate_Carree",GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Plate_Carree"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],UNIT["Degrees",111319.491]]',valid:[-180,180],origin:[-180,90],dx:1e-5},104971:{wkTemplate:'GEOGCS["Mars_2000_(Sphere)",DATUM["Mars_2000_(Sphere)",SPHEROID["Mars_2000_(Sphere)",3396190.0,0.0]],PRIMEM["Reference_Meridian",0.0],UNIT["Degree",0.0174532925199433]]',valid:[-180,180],origin:[-180,90],dx:1e-5},104905:{wkTemplate:'GEOGCS["GCS_Mars_2000",DATUM["D_Mars_2000",SPHEROID["Mars_2000_IAU_IAG",3396190.0,169.8944472236118]],PRIMEM["Reference_Meridian",0.0],UNIT["Degree",0.0174532925199433]]',valid:[-180,180],origin:[-180,90],dx:1e-5}};function Tn(t,e){return t===e||!C(t)&&!C(e)&&(t.wkid!=null||e.wkid!=null?t.wkid===e.wkid||cw(t)&&cw(e)||e.latestWkid!=null&&t.wkid===e.latestWkid||t.latestWkid!=null&&e.wkid===t.latestWkid:!(!t.wkt||!e.wkt)&&t.wkt.toUpperCase()===e.wkt.toUpperCase())}function I_(t){return pa(t)&&t.wkid&&che[t.wkid]||null}function uhe(t){return!!pa(t)&&(t.wkid?D[t.wkid]==null:!!t.wkt&&!!/^\s*GEOGCS/i.test(t.wkt))}function NR(t){return!(fm(t)||mm(t))}function FR(t){return pa(t)&&t.wkid===4326}function hhe(t){return pa(t)&&t.wkid===Ah.CGCS2000}function cw(t){return pa(t)&&t.wkid!=null&&QRe[t.wkid]===!0}function mq(t){return pa(t)&&t.wkid===32662}function gq(t){return t===Ah.GCSMARS2000||t===Ah.GCSMARS2000_SPHERE}function fm(t){return pa(t)&&t.wkid!=null&&gq(t.wkid)}function yq(t){return t===Ah.GCSMOON2000}function mm(t){return pa(t)&&t.wkid!=null&&yq(t.wkid)}function tOe(t){return pa(t)&&t.wkid!=null&&eOe[t.wkid]===!0}function pa(t){return v(t)&&(t.wkid!=null&&t.wkid>=2e3||t.wkt!=null)}const rOe={wkid:4326,wkt:tm(che[4326].wkTemplate,{Central_Meridian:"0.0"})},iOe={wkid:102100,latestWkid:3857},sOe={wkid:32662};function _q(t){return{wkt:`GEOCCS["Spherical geocentric",
    DATUM["Not specified",
      SPHEROID["Sphere",${t.radius},0]],
    PRIMEM["Greenwich",0.0,
      AUTHORITY["EPSG","8901"]],
    UNIT["m",1.0],
    AXIS["Geocentric X",OTHER],
    AXIS["Geocentric Y",EAST],
    AXIS["Geocentric Z",NORTH]
  ]`}}const dhe=_q(wr),vq=_q(Gf),bq=_q(Jg),phe={wkt:`GEOCCS["WGS 84",
  DATUM["WGS_1984",
    SPHEROID["WGS 84",${wr.radius},298.257223563,
      AUTHORITY["EPSG","7030"]],
    AUTHORITY["EPSG","6326"]],
  PRIMEM["Greenwich",0,
    AUTHORITY["EPSG","8901"]],
  UNIT["m",1.0,
    AUTHORITY["EPSG","9001"]],
  AXIS["Geocentric X",OTHER],
  AXIS["Geocentric Y",OTHER],
  AXIS["Geocentric Z",NORTH],
  AUTHORITY["EPSG","4978"]
]`};function Jr(t){return v(t)&&(fm(t)||Tn(t,vq))?Gf:v(t)&&(mm(t)||Tn(t,bq))?Jg:wr}function dwt(t){return gq(t)?Gf:yq(t)?Jg:wr}const wq=39.37,nOe=wr.radius*Math.PI/200,fhe=/UNIT\[([^\]]+)\]\]$/i,jb=D,mhe=/UNIT\[([^\]]+)\]/i,oOe=new Set([4261,4305,4807,4810,4811,4812,4816,4819,4821,4901,4902,37225,104139,104140]),aOe=Ta()({meter:"meters",foot:"feet",foot_us:"us-feet",foot_clarke:"clarke-feet",yard_clarke:"clarke-yards",link_clarke:"clarke-links",yard_sears:"sears-yards",foot_sears:"sears-feet",chain_sears:"sears-chains",chain_benoit_1895_b:"benoit-1895-b-chains",yard_indian:"indian-yards",yard_indian_1937:"indian-1937-yards",foot_gold_coast:"gold-coast-feet",chain_sears_1922_truncated:"sears-1922-truncated-chains","50_kilometers":"50-kilometers","150_kilometers":"150-kilometers"}),Rp=t=>t*t,Iy=t=>t*t*t,UR={length:{baseUnit:"meters",units:{millimeters:{inBaseUnits:.001},centimeters:{inBaseUnits:.01},decimeters:{inBaseUnits:.1},meters:{inBaseUnits:1},kilometers:{inBaseUnits:1e3},inches:{inBaseUnits:.0254},feet:{inBaseUnits:.3048},yards:{inBaseUnits:.9144},miles:{inBaseUnits:1609.344},"nautical-miles":{inBaseUnits:1852},"us-feet":{inBaseUnits:1200/3937}}},area:{baseUnit:"square-meters",units:{"square-millimeters":{inBaseUnits:Rp(.001)},"square-centimeters":{inBaseUnits:Rp(.01)},"square-decimeters":{inBaseUnits:Rp(.1)},"square-meters":{inBaseUnits:1},"square-kilometers":{inBaseUnits:Rp(1e3)},"square-inches":{inBaseUnits:Rp(.0254)},"square-feet":{inBaseUnits:Rp(.3048)},"square-yards":{inBaseUnits:Rp(.9144)},"square-miles":{inBaseUnits:Rp(1609.344)},"square-us-feet":{inBaseUnits:Rp(1200/3937)},acres:{inBaseUnits:.0015625*Rp(1609.344)},ares:{inBaseUnits:100},hectares:{inBaseUnits:1e4}}},volume:{baseUnit:"liters",units:{liters:{inBaseUnits:1},"cubic-millimeters":{inBaseUnits:1e3*Iy(.001)},"cubic-centimeters":{inBaseUnits:1e3*Iy(.01)},"cubic-decimeters":{inBaseUnits:1e3*Iy(.1)},"cubic-meters":{inBaseUnits:1e3},"cubic-kilometers":{inBaseUnits:1e3*Iy(1e3)},"cubic-inches":{inBaseUnits:1e3*Iy(.0254)},"cubic-feet":{inBaseUnits:1e3*Iy(.3048)},"cubic-yards":{inBaseUnits:1e3*Iy(.9144)},"cubic-miles":{inBaseUnits:1e3*Iy(1609.344)}}},angle:{baseUnit:"radians",units:{radians:{inBaseUnits:1},degrees:{inBaseUnits:Math.PI/180}}}},lOe=(()=>{const t={};for(const e in UR)for(const r in UR[e].units)t[r]=e;return t})();function cOe(t,e,r){return t*UR[r].units[e].inBaseUnits}function uOe(t,e,r){return t/UR[r].units[e].inBaseUnits}const hOe=["metric","imperial","inches","feet","yards","miles","nautical-miles","us-feet","meters","kilometers"];function oV(t){const e=lOe[t];if(!e)throw new Error("unknown type");return e}function aK(t,e=null){return e=e||oV(t),UR[e].baseUnit===t}function gn(t,e,r){if(e===r)return t;const i=oV(e);if(i!==oV(r))throw new Error("incompatible units");const s=aK(e,i)?t:cOe(t,e,i);return aK(r,i)?s:uOe(s,r,i)}function pwt(t,e,r){switch(r){case"metric":return ghe(t,e);case"imperial":return _he(t,e);default:return r}}function fwt(t,e,r){switch(r){case"metric":return yhe(t,e);case"imperial":return vhe(t,e);default:return r}}function ghe(t,e){const r=gn(t,e,"meters");return Math.abs(r)<3e3?"meters":"kilometers"}function yhe(t,e){const r=gn(t,e,"meters");return Math.abs(r)<1e5?"meters":"kilometers"}function _he(t,e){const r=gn(t,e,"feet");return Math.abs(r)<1e3?"feet":"miles"}function vhe(t,e){const r=gn(t,e,"feet");return Math.abs(r)<1e5?"feet":"miles"}function mwt(t,e){const r=gn(t,e,"square-meters");return Math.abs(r)<3e6?"square-meters":"square-kilometers"}function gwt(t,e){const r=gn(t,e,"square-feet");return Math.abs(r)<1e6?"square-feet":"square-miles"}function dOe(t,e,r){return gn(t,e,"meters")/(r*Math.PI/180)}function bhe(t){return aOe.fromJSON(t.toLowerCase())||null}function uw(t){if(v(t)&&!NR(t))return 1;const e=nl(t);return e>1e5?1:e}function pOe(t){return nl(t)>=Jr(t).metersPerDegree?"meters":u4(t)}function nl(t,e=wr.metersPerDegree){return It(fOe(t,!0),e)}function fOe(t,e=!1){const r=v(t)?t.wkid:null,i=v(t)?t.wkt:null;let s=null;if(r){if(gq(r))return Gf.metersPerDegree;if(yq(r))return Jg.metersPerDegree;s=jb.values[jb[r]],!s&&e&&oOe.has(r)&&(s=nOe)}else i&&(The(i)?s=lK(fhe.exec(i),s):xhe(i)&&(s=lK(mhe.exec(i),s)));return s}function lK(t,e){return t&&t[1]?whe(t[1]):e}function whe(t){return parseFloat(t.split(",")[1])}function u4(t){const e=v(t)?t.wkid:null,r=v(t)?t.wkt:null;let i=null;if(e)i=jb.units[jb[e]];else if(r){const s=The(r)?fhe:xhe(r)?mhe:null;if(s){const n=s.exec(r);n&&n[1]&&(i=gOe(n[1]))}}return v(i)?bhe(i):null}function ywt(t){const e=u4(t);return C(e)||!hOe.includes(e)?null:e}function xhe(t){return/^GEOCCS/i.test(t)}function The(t){return/^PROJCS/i.test(t)}const mOe=1e-7;function gOe(t){const e=/[\\"\\']{1}([^\\"\\']+)/.exec(t);let r=e&&e[1];if(!r||!jb.units.includes(r)){const i=whe(t);r=null;const s=jb.values;for(let n=0;n<s.length;++n)if(Math.abs(i-s[n])<mOe){r=jb.units[n];break}}return r}function _wt(t){const e=u4(t);if(C(e))return null;switch(e){case"feet":case"us-feet":case"clarke-feet":case"clarke-yards":case"clarke-links":case"sears-yards":case"sears-feet":case"sears-chains":case"benoit-1895-b-chains":case"indian-yards":case"indian-1937-yards":case"gold-coast-feet":case"sears-1922-truncated-chains":return"imperial";case"50-kilometers":case"150-kilometers":case"meters":return"metric"}return null}const yOe={esriAcres:"acres",esriAres:"ares",esriHectares:"hectares",esriSquareCentimeters:"square-centimeters",esriSquareDecimeters:"square-decimeters",esriSquareFeet:"square-feet",esriSquareInches:"square-inches",esriSquareKilometers:"square-kilometers",esriSquareMeters:"square-meters",esriSquareMiles:"square-miles",esriSquareMillimeters:"square-millimeters",esriSquareUsFeet:"square-us-feet",esriSquareYards:"square-yards"},_Oe={esriCentimeters:"centimeters",esriDecimeters:"decimeters",esriFeet:"feet",esriInches:"inches",esriKilometers:"kilometers",esriMeters:"meters",esriMiles:"miles",esriMillimeters:"millimeters",esriNauticalMiles:"nautical-miles",esriYards:"yards"},vOe={esriDUDecimalDegrees:"degrees",esriDURadians:"radians"},bOe=Ta()(yOe),wOe=Ta()(_Oe),vwt=Ta()(vOe);var Xp;let Ci=Xp=class extends ve{static fromJSON(t){if(!t)return null;if(t.wkid){if(t.wkid===102100)return Xp.WebMercator;if(t.wkid===4326)return Xp.WGS84}const e=new Xp;return e.read(t),e}constructor(t){super(t),this.latestWkid=null,this.wkid=null,this.wkt=null,this.vcsWkid=null,this.latestVcsWkid=null,this.imageCoordinateSystem=null}normalizeCtorArgs(t){return t&&typeof t=="object"?t:{[typeof t=="string"?"wkt":"wkid"]:t}}get isWGS84(){return FR(this)}get isWebMercator(){return cw(this)}get isGeographic(){return uhe(this)}get isWrappable(){return tOe(this)}get metersPerUnit(){return nl(this)}get unit(){return u4(this)||(this.isGeographic?"degrees":null)}writeWkt(t,e){this.wkid||(e.wkt=t)}clone(){if(this===Xp.WGS84)return Xp.WGS84;if(this===Xp.WebMercator)return Xp.WebMercator;const t=new Xp;return this.wkid!=null?(t.wkid=this.wkid,this.latestWkid!=null&&(t.latestWkid=this.latestWkid),this.vcsWkid!=null&&(t.vcsWkid=this.vcsWkid),this.latestVcsWkid!=null&&(t.latestVcsWkid=this.latestVcsWkid)):this.wkt!=null&&(t.wkt=this.wkt),this.imageCoordinateSystem&&(t.imageCoordinateSystem=ne(this.imageCoordinateSystem)),t}equals(t){if(t==null)return!1;if(this.imageCoordinateSystem||t.imageCoordinateSystem){if(this.imageCoordinateSystem==null||t.imageCoordinateSystem==null)return!1;const{id:e,referenceServiceName:r}=t.imageCoordinateSystem,{geodataXform:i}=t.imageCoordinateSystem,s=this.imageCoordinateSystem;return e==null||i?JSON.stringify(s)===JSON.stringify(t.imageCoordinateSystem):r?s.id===e&&s.referenceServiceName===r:s.id===e}return Tn(this,t)}toJSON(t){return this.write(void 0,t)}};Ci.GCS_NAD_1927=null,Ci.WGS84=null,Ci.WebMercator=null,Ci.PlateCarree=null,u([d({readOnly:!0})],Ci.prototype,"isWGS84",null),u([d({readOnly:!0})],Ci.prototype,"isWebMercator",null),u([d({readOnly:!0})],Ci.prototype,"isGeographic",null),u([d({readOnly:!0})],Ci.prototype,"isWrappable",null),u([d({type:Gi,json:{write:!0}})],Ci.prototype,"latestWkid",void 0),u([d({readOnly:!0})],Ci.prototype,"metersPerUnit",null),u([d({readOnly:!0})],Ci.prototype,"unit",null),u([d({type:Gi,json:{write:!0,origins:{"web-scene":{write:{overridePolicy(){return{isRequired:this.wkt===null}}}}}}})],Ci.prototype,"wkid",void 0),u([d({type:String,json:{origins:{"web-scene":{write:{overridePolicy(){return{isRequired:this.wkid===null}}}}}}})],Ci.prototype,"wkt",void 0),u([He("wkt"),He("web-scene","wkt")],Ci.prototype,"writeWkt",null),u([d({type:Gi,json:{write:!0}})],Ci.prototype,"vcsWkid",void 0),u([d({type:Gi,json:{write:!0}})],Ci.prototype,"latestVcsWkid",void 0),u([d()],Ci.prototype,"imageCoordinateSystem",void 0),Ci=Xp=u([I("esri.geometry.SpatialReference")],Ci),Ci.prototype.toJSON.isDefaultToJSON=!0,Ci.GCS_NAD_1927=new Ci({wkid:4267,wkt:'GEOGCS["GCS_North_American_1927",DATUM["D_North_American_1927",SPHEROID["Clarke_1866",6378206.4,294.9786982]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]]'}),Ci.WGS84=new Ci(rOe),Ci.WebMercator=new Ci(iOe),Ci.PlateCarree=new Ci(sOe),Object.freeze&&(Object.freeze(Ci.GCS_NAD_1927),Object.freeze(Ci.WGS84),Object.freeze(Ci.WebMercator));const et=Ci,She="20230301",Ehe="2657e728c1857e6d94c324181c0788310bb0958a",Che="4.26",xOe={async request(t,e){var a,l;const{default:r}=await te(()=>Promise.resolve().then(()=>UOe),void 0),i=t.options,s=i.responseType;i.signal=e==null?void 0:e.signal,i.responseType=s==="native"||s==="native-request-init"?"native-request-init":s&&["blob","json","text"].includes(s)&&((a=rhe(t.url))!=null&&a.after)?s:"array-buffer";const n=await r(t.url,i),o={data:n.data,httpStatus:n.httpStatus,ssl:n.ssl};switch((l=n.requestOptions)==null?void 0:l.responseType){case"native-request-init":return delete o.data.signal,o;case"blob":o.data=await o.data.arrayBuffer();break;case"json":o.data=new TextEncoder().encode(JSON.stringify(o.data)).buffer;break;case"text":o.data=new TextEncoder().encode(o.data).buffer}return{result:o,transferList:[o.data]}}};let wi;function bwt(t){wi=t}function wwt(t){const e=wi&&wi.findCredential(t);return e&&e.token?ahe(t,"token",e.token):t}de("host-webworker");const TOe=["elevation3d.arcgis.com","js.arcgis.com","jsdev.arcgis.com","jsqa.arcgis.com","static.arcgis.com"];function Ahe(t){const e=sp(t,!0);return!!e&&e.endsWith(".arcgis.com")&&!TOe.includes(e)&&!t.endsWith("/sharing/rest/generateToken")}function Rhe(t,e,r=!1,i){return new Promise((s,n)=>{if(Ln(i))return void n(cK());let o=()=>{c(),n(new Error(`Unable to load ${e}`))},a=()=>{const h=t;c(),s(h)},l=()=>{if(!t)return;const h=t;c(),h.src="",n(cK())};const c=()=>{de("esri-image-decode")||(t.removeEventListener("error",o),t.removeEventListener("load",a)),o=null,a=null,t=null,v(i)&&i.removeEventListener("abort",l),l=null,r&&URL.revokeObjectURL(e)};v(i)&&i.addEventListener("abort",l),de("esri-image-decode")?t.decode().then(a,o):(t.addEventListener("error",o),t.addEventListener("load",a))})}function cK(){try{return new DOMException("Aborted","AbortError")}catch{const t=new Error;return t.name="AbortError",t}}function SOe(t){Yr.request.crossOriginNoCorsDomains||(Yr.request.crossOriginNoCorsDomains={});const e=Yr.request.crossOriginNoCorsDomains;for(let r of t)r=r.toLowerCase(),/^https?:\/\//.test(r)?e[sp(r)??""]=0:(e[sp("http://"+r)??""]=0,e[sp("https://"+r)??""]=0)}function EOe(t){const e=Yr.request.crossOriginNoCorsDomains;if(e){let r=sp(t);if(r)return r=r.toLowerCase(),!wS(r,aq())&&e[r]<Date.now()-36e5}return!1}async function COe(t){var s;const e=Yr.request.crossOriginNoCorsDomains,r=sp(t);e&&r&&(e[r.toLowerCase()]=Date.now());const i=sl(t);t=i.path,((s=i.query)==null?void 0:s.f)==="json"&&(t+="?f=json");try{await fetch(t,{mode:"no-cors",credentials:"include"})}catch{}}async function Ni(t,e){var c;const r=pm(t),i=xS(t);i||r||(t=ip(t));const s={url:t,requestOptions:{...e}};let n=rhe(t);if(n){const h=await LOe(n,s);if(h!=null)return{data:h,getHeader:xq,httpStatus:200,requestOptions:s.requestOptions,url:s.url};n.after||n.error||(n=null)}if(t=s.url,(e=s.requestOptions).responseType==="image"){if(de("host-webworker")||de("host-node"))throw Wd("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),s)}else if(r)throw Wd("request:invalid-parameters",new Error("Data URLs are not supported for responseType = "+e.responseType),s);if(e.method==="head"){if(e.body)throw Wd("request:invalid-parameters",new Error("body parameter cannot be set when method is 'head'"),s);if(r||i)throw Wd("request:invalid-parameters",new Error("data and blob URLs are not supported for method 'head'"),s)}if(await POe(),QD)return QD.execute(t,e);const o=new AbortController;fa(e,()=>o.abort());const a={controller:o,credential:void 0,credentialToken:void 0,fetchOptions:void 0,hasToken:!1,interceptor:n,params:s,redoRequest:!1,useIdentity:Fd.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1},l=await NOe(a);return(c=n==null?void 0:n.after)==null||c.call(n,l),l}let QD;const Fd=Yr.request,Ohe="FormData"in globalThis,AOe=[499,498,403,401],ROe=["COM_0056","COM_0057","SB_0008"],OOe=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],xq=()=>null,eN=Symbol();function MOe(t){const e=sp(t);e&&!Ni._corsServers.includes(e)&&Ni._corsServers.push(e)}function uK(t){const e=sp(t);return!e||e.endsWith(".arcgis.com")||Ni._corsServers.includes(e)||cq(e)}function Wd(t,e,r,i){let s="Error";const n={url:r.url,requestOptions:r.requestOptions,getHeader:xq,ssl:!1};if(e instanceof q)return e.details?(e.details=ne(e.details),e.details.url=r.url,e.details.requestOptions=r.requestOptions):e.details=n,e;if(e){const o=i&&(c=>i.headers.get(c)),a=i&&i.status,l=e.message;l&&(s=l),o&&(n.getHeader=o),n.httpStatus=(e.httpCode!=null?e.httpCode:e.code)||a||0,n.subCode=e.subcode,n.messageCode=e.messageCode,typeof e.details=="string"?n.messages=[e.details]:n.messages=e.details,n.raw=eN in e?e[eN]:e}return Qs(e)?Hr():new q(t,s,n)}async function POe(){de("host-webworker")?QD||(QD=await te(()=>import("./request-9419f500.js"),[])):Ni._abortableFetch||(Ni._abortableFetch=globalThis.fetch.bind(globalThis))}async function aV(){wi||await te(()=>import("./IdentityManager-70febd2d.js"),[])}async function IOe(t){var a;const e=t.params.url,r=t.params.requestOptions,i=t.controller.signal,s=r.body;let n=null,o=null;if(Ohe&&"HTMLFormElement"in globalThis&&(s instanceof FormData?n=s:s instanceof HTMLFormElement&&(n=new FormData(s))),typeof s=="string"&&(o=s),t.fetchOptions={cache:r.cacheBust&&!Ni._abortableFetch.polyfill?"no-cache":"default",credentials:"same-origin",headers:r.headers||{},method:r.method==="head"?"HEAD":"GET",mode:"cors",priority:Fd.priority,redirect:"follow",signal:i},(n||o)&&(t.fetchOptions.body=n||o),r.authMode==="anonymous"&&(t.useIdentity=!1),t.hasToken=!!(/token=/i.test(e)||(a=r.query)!=null&&a.token||n!=null&&n.get("token")),!t.hasToken&&Yr.apiKey&&Ahe(e)&&(r.query||(r.query={}),r.query.token=Yr.apiKey,t.hasToken=!0),t.useIdentity&&!t.hasToken&&!t.credentialToken&&!Mhe(e)&&!Ln(i)){let l;r.authMode==="immediate"?(await aV(),l=await wi.getCredential(e,{signal:i}),t.credential=l):r.authMode==="no-prompt"?(await aV(),l=await wi.getCredential(e,{prompt:!1,signal:i}).catch(()=>{}),t.credential=l):wi&&(l=wi.findCredential(e)),l&&(t.credentialToken=l.token,t.useSSL=!!l.ssl)}}function Mhe(t){return OOe.some(e=>e.test(t))}async function $Oe(t){let e=t.params.url;const r=t.params.requestOptions,i=t.fetchOptions??{},s=xS(e)||pm(e),n=r.responseType||"json",o=s?0:r.timeout!=null?r.timeout:Fd.timeout;let a=!1;if(!s){t.useSSL&&(e=pq(e)),r.cacheBust&&i.cache==="default"&&(e=ahe(e,"request.preventCache",Date.now()));let f={...r.query};t.credentialToken&&(f.token=t.credentialToken);let m=DR(f);de("esri-url-encodes-apostrophe")&&(m=m.replace(/'/g,"%27"));const y=e.length+1+m.length;let _;a=r.method==="delete"||r.method==="post"||r.method==="put"||!!r.body||y>Fd.maxUrlLength;const b=r.useProxy||!!c4(e);if(b){const x=DRe(e);_=x.path,!a&&_.length+1+y>Fd.maxUrlLength&&(a=!0),x.query&&(f={...x.query,...f})}if(i.method==="HEAD"&&(a||b)){if(a)throw y>Fd.maxUrlLength?Wd("request:invalid-parameters",new Error("URL exceeds maximum length"),t.params):Wd("request:invalid-parameters",new Error("cannot use POST request when method is 'head'"),t.params);if(b)throw Wd("request:invalid-parameters",new Error("cannot use proxy when method is 'head'"),t.params)}if(a?(i.method=r.method==="delete"?"DELETE":r.method==="put"?"PUT":"POST",r.body?e=R6(e,f):(i.body=DR(f),i.headers||(i.headers={}),i.headers["Content-Type"]="application/x-www-form-urlencoded")):e=R6(e,f),b&&(t.useProxy=!0,e=`${_}?${e}`),f.token&&Ohe&&i.body instanceof FormData&&!SRe(e)&&i.body.set("token",f.token),r.hasOwnProperty("withCredentials"))t.withCredentials=r.withCredentials;else if(!wS(e,aq())){if(cq(e))t.withCredentials=!0;else if(wi){const x=wi.findServerInfo(e);x&&x.webTierAuth&&(t.withCredentials=!0)}}t.withCredentials&&(i.credentials="include",EOe(e)&&await COe(a?R6(e,f):e))}let l,c,h=0,p=!1;o>0&&(h=setTimeout(()=>{p=!0,t.controller.abort()},o));try{if(r.responseType==="native-request-init")c=i,c.url=e;else if(r.responseType!=="image"||i.cache!=="default"||i.method!=="GET"||a||DOe(r.headers)||!s&&!t.useProxy&&Fd.proxyUrl&&!uK(e)){if(l=await Ni._abortableFetch(e,i),t.useProxy||MOe(e),r.responseType==="native")c=l;else if(i.method!=="HEAD")if(l.ok){switch(n){case"array-buffer":c=await l.arrayBuffer();break;case"blob":case"image":c=await l.blob();break;default:c=await l.text()}if(h&&(clearTimeout(h),h=0),n==="json"||n==="xml"||n==="document")if(c)switch(n){case"json":c=JSON.parse(c);break;case"xml":c=hK(c,"application/xml");break;case"document":c=hK(c,"text/html")}else c=null;if(c){if(n==="array-buffer"||n==="blob"){const f=l.headers.get("Content-Type");if(f&&/application\/json|text\/plain/i.test(f)&&c[n==="blob"?"size":"byteLength"]<=750)try{const m=await new Response(c).json();m.error&&(c=m)}catch{}}n==="image"&&c instanceof Blob&&(c=await dK(URL.createObjectURL(c),t,!0))}}else c=await l.text()}else c=await dK(e,t)}catch(f){if(f.name==="AbortError")throw p?new Error("Timeout exceeded"):Hr("Request canceled");if(!(!l&&f instanceof TypeError&&Fd.proxyUrl)||r.body||r.method==="delete"||r.method==="head"||r.method==="post"||r.method==="put"||t.useProxy||uK(e))throw f;t.redoRequest=!0,NRe({proxyUrl:Fd.proxyUrl,urlPrefix:sp(e)??""})}finally{h&&clearTimeout(h)}return[l,c]}async function LOe(t,e){if(t.responseData!=null)return t.responseData;if(t.headers&&(e.requestOptions.headers={...e.requestOptions.headers,...t.headers}),t.query&&(e.requestOptions.query={...e.requestOptions.query,...t.query}),t.before){let r,i;try{i=await t.before(e)}catch(s){r=Wd("request:interceptor",s,e)}if((i instanceof Error||i instanceof q)&&(r=Wd("request:interceptor",i,e)),r)throw t.error&&t.error(r),r;return i}}function DOe(t){if(t){for(const e of Object.getOwnPropertyNames(t))if(t[e])return!0}return!1}function hK(t,e){let r;try{r=new DOMParser().parseFromString(t,e)}catch{}if(!r||r.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return r}async function NOe(t){var n;let e,r;await IOe(t);try{do[e,r]=await $Oe(t);while(!await FOe(t,e,r))}catch(o){const a=Wd("request:server",o,t.params,e);throw a.details.ssl=t.useSSL,t.interceptor&&t.interceptor.error&&t.interceptor.error(a),a}const i=t.params.url;if(r&&/\/sharing\/rest\/(accounts|portals)\/self/i.test(i)){if(!t.hasToken&&!t.credentialToken&&((n=r.user)!=null&&n.username)&&!cq(i)){const o=sp(i,!0);o&&Fd.trustedServers.push(o)}Array.isArray(r.authorizedCrossOriginNoCorsDomains)&&SOe(r.authorizedCrossOriginNoCorsDomains)}const s=t.credential;if(s&&wi){const o=wi.findServerInfo(s.server);let a=o&&o.owningSystemUrl;if(a){a=a.replace(/\/?$/,"/sharing");const l=wi.findCredential(a,s.userId);l&&wi._getIdenticalSvcIdx(a,l)===-1&&l.resources.unshift(a)}}return{data:r,getHeader:e?o=>e==null?void 0:e.headers.get(o):xq,httpStatus:(e==null?void 0:e.status)??200,requestOptions:t.params.requestOptions,ssl:t.useSSL,url:t.params.url}}async function FOe(t,e,r){if(t.redoRequest)return t.redoRequest=!1,!1;const i=t.params.requestOptions;if(!e||i.responseType==="native"||i.responseType==="native-request-init")return!0;let s,n;if(!e.ok)throw s=new Error(`Unable to load ${e.url} status: ${e.status}`),s[eN]=r,s;r&&(r.error?s=r.error:r.status==="error"&&Array.isArray(r.messages)&&(s={...r},s[eN]=r,s.details=r.messages));let o,a=null;s&&(n=Number(s.code),a=s.hasOwnProperty("subcode")?Number(s.subcode):null,o=s.messageCode,o=o&&o.toUpperCase());const l=i.authMode;if(n===403&&(a===4||s.message&&s.message.toLowerCase().includes("ssl")&&!s.message.toLowerCase().includes("permission"))){if(!t.useSSL)return t.useSSL=!0,!1}else if(!t.hasToken&&t.useIdentity&&(l!=="no-prompt"||n===498)&&n!==void 0&&AOe.includes(n)&&!Mhe(t.params.url)&&(n!==403||o&&!ROe.includes(o)&&(a==null||a===2&&t.credentialToken))){await aV();try{const c=await wi.getCredential(t.params.url,{error:Wd("request:server",s,t.params),prompt:l!=="no-prompt",signal:t.controller.signal,token:t.credentialToken});return t.credential=c,t.credentialToken=c.token,t.useSSL=t.useSSL||c.ssl,!1}catch(c){if(l==="no-prompt")return t.credential=void 0,t.credentialToken=void 0,!1;s=c}}if(s)throw s;return!0}function dK(t,e,r=!1){const i=e.controller.signal,s=new Image;return e.withCredentials?s.crossOrigin="use-credentials":s.crossOrigin="anonymous",s.alt="",s.fetchPriority=Fd.priority,s.src=t,Rhe(s,t,r,i)}Ni._abortableFetch=null,Ni._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"];const UOe=Object.freeze(Object.defineProperty({__proto__:null,default:Ni},Symbol.toStringTag,{value:"Module"}));function Fe(t,e,r){let i,s;return e===void 0||Array.isArray(e)?(s=t,r=e,i=[void 0]):(s=e,i=Array.isArray(t)?t:[t]),(n,o)=>{const a=n.constructor.prototype;i.forEach(l=>{const c=Rue(n,l,s);c.read&&typeof c.read=="object"||(c.read={}),c.read.reader=a[o],r&&(c.read.source=(c.read.source||[]).concat(r))})}}let Yp=class extends ve{constructor(...e){super(...e),this.type=null,this.hasM=!1,this.hasZ=!1,this.spatialReference=et.WGS84}get cache(){return this.commitProperty("spatialReference"),{}}get extent(){return null}readSpatialReference(e,r){if(e instanceof et)return e;if(e!=null){const i=new et;return i.read(e,r),i}return e}clone(){return console.warn(".clone() is not implemented for "+this.declaredClass),null}clearCache(){this.notifyChange("cache")}getCacheValue(e){return this.cache[e]}setCacheValue(e,r){this.cache[e]=r}};u([d()],Yp.prototype,"type",void 0),u([d({readOnly:!0})],Yp.prototype,"cache",null),u([d({readOnly:!0})],Yp.prototype,"extent",null),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],Yp.prototype,"hasM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],Yp.prototype,"hasZ",void 0),u([d({type:et,json:{write:!0},value:et.WGS84})],Yp.prototype,"spatialReference",void 0),u([Fe("spatialReference")],Yp.prototype,"readSpatialReference",null),Yp=u([I("esri.geometry.Geometry")],Yp);const pv=Yp,kOe=Object.prototype.toString;function VOe(t){const e="__accessorMetadata__"in t?us(t):t;return function(...r){if(r.push(e),typeof r[2]=="number")throw new Error("Using @cast has parameter decorator is not supported since 4.16");return BOe.apply(this,r)}}function BOe(t,e,r,i){t4(t,e).cast=i}function zOe(t){return(e,r)=>{t4(e,t).cast=e[r]}}function cr(...t){if(t.length!==3||typeof t[1]!="string")return t.length===1&&kOe.call(t[0])==="[object Function]"?VOe(t[0]):t.length===1&&typeof t[0]=="string"?zOe(t[0]):void 0}function GOe(t,e){const r=t.x-e.x,i=t.y-e.y,s=t.hasZ&&e.hasZ?t.z-e.z:0;return Math.sqrt(r*r+i*i+s*s)}const jOe=57.29577951308232,HOe=.017453292519943;function pK(t){return t*jOe}function fK(t){return t*HOe}function mK(t){return t/wr.radius}function tN(t){return Math.PI/2-2*Math.atan(Math.exp(-t/wr.radius))}function lV(t){return t.wkid!=null||t.wkt!=null}const O6=[0,0];function rN(t,e,r,i,s){const n=t,o=s;if(o.spatialReference=r,"x"in n&&"x"in o)[o.x,o.y]=e(n.x,n.y,O6,i);else if("xmin"in n&&"xmin"in o)[o.xmin,o.ymin]=e(n.xmin,n.ymin,O6,i),[o.xmax,o.ymax]=e(n.xmax,n.ymax,O6,i);else if("paths"in n&&"paths"in o||"rings"in n&&"rings"in o){const a="paths"in n?n.paths:n.rings,l=[];let c;for(let h=0;h<a.length;h++){const p=a[h];c=[],l.push(c);for(let f=0;f<p.length;f++)c.push(e(p[f][0],p[f][1],[0,0],i)),p[f].length>2&&c[f].push(p[f][2]),p[f].length>3&&c[f].push(p[f][3])}"paths"in o?o.paths=l:o.rings=l}else if("points"in n&&"points"in o){const a=n.points,l=[];for(let c=0;c<a.length;c++)l[c]=e(a[c][0],a[c][1],[0,0],i),a[c].length>2&&l[c].push(a[c][2]),a[c].length>3&&l[c].push(a[c][3]);o.points=l}return s}function $_(t,e){const r=t&&(lV(t)?t:t.spatialReference),i=e&&(lV(e)?e:e.spatialReference);return!(t&&"type"in t&&t.type==="mesh"||e&&"type"in e&&e.type==="mesh"||!r||!i)&&(!!Tn(i,r)||cw(i)&&FR(r)||cw(r)&&FR(i))}function Gw(t,e){if(C(t))return null;const r=t.spatialReference,i=e&&(lV(e)?e:e.spatialReference);return $_(r,i)?Tn(r,i)?ne(t):cw(i)?rN(t,y2,et.WebMercator,!1,ne(t)):FR(i)?rN(t,F3,et.WGS84,!1,ne(t)):null:null}function y2(t,e,r=[0,0]){e>89.99999?e=89.99999:e<-89.99999&&(e=-89.99999);const i=fK(e);return r[0]=fK(t)*wr.radius,r[1]=wr.halfSemiMajorAxis*Math.log((1+Math.sin(i))/(1-Math.sin(i))),r}function F3(t,e,r=[0,0],i=!1){const s=pK(t/wr.radius);return r[0]=i?s:s-360*Math.floor((s+180)/360),r[1]=pK(Math.PI/2-2*Math.atan(Math.exp(-e/wr.radius))),r}function jf(t,e=!1,r=ne(t)){return rN(t,y2,et.WebMercator,e,r)}function _2(t,e=!1,r=ne(t)){return rN(t,F3,et.WGS84,e,r)}var W$;const eC=[0,0];function gK(t){return t&&(t.declaredClass==="esri.geometry.SpatialReference"||t.wkid!=null)}let bl=W$=class extends pv{static copy(t,e){e._set("x",t._get("x")),e._set("y",t._get("y")),e._set("z",t._get("z")),e._set("m",t._get("m"));const r=t._get("spatialReference");e._set("spatialReference",Object.isFrozen(r)?r:r.clone())}constructor(...t){super(...t),this.x=0,this.y=0,this.z=void 0,this.m=void 0,this.type="point"}normalizeCtorArgs(t,e,r,i,s){let n;if(Array.isArray(t))n=t,s=e,t=n[0],e=n[1],r=n[2],i=n[3];else if(t&&typeof t=="object"){if(n=t,t=n.x!=null?n.x:n.longitude,e=n.y!=null?n.y:n.latitude,r=n.z,i=n.m,(s=n.spatialReference)&&s.declaredClass!=="esri.geometry.SpatialReference"&&(s=new et(s)),n.longitude!=null||n.latitude!=null){if(n.longitude==null)se.getLogger(this.declaredClass).warn(".longitude=","Latitude was defined without longitude");else if(n.latitude==null)se.getLogger(this.declaredClass).warn(".latitude=","Longitude was defined without latitude");else if(!n.declaredClass&&s&&s.isWebMercator){const a=y2(n.longitude,n.latitude,eC);t=a[0],e=a[1]}}}else gK(r)?(s=r,r=null):gK(i)&&(s=i,i=null);const o={x:t,y:e};return o.x==null&&o.y!=null?se.getLogger(this.declaredClass).warn(".y=","Y coordinate was defined without an X coordinate"):o.y==null&&o.x!=null&&se.getLogger(this.declaredClass).warn(".x=","X coordinate was defined without a Y coordinate"),s!=null&&(o.spatialReference=s),r!=null&&(o.z=r),i!=null&&(o.m=i),o}get cache(){return this.commitProperty("x"),this.commitProperty("y"),this.commitProperty("z"),this.commitProperty("m"),this.commitProperty("spatialReference"),{}}get hasM(){return this.m!==void 0}set hasM(t){t!==(this._get("m")!==void 0)&&(this._set("m",t?0:void 0),this._set("hasM",t))}get hasZ(){return this.z!==void 0}set hasZ(t){t!==(this._get("z")!==void 0)&&(this._set("z",t?0:void 0),this._set("hasZ",t))}get latitude(){const{spatialReference:t,x:e,y:r}=this;if(t){if(t.isWebMercator)return F3(e,r,eC)[1];if(t.isGeographic)return r}return null}set latitude(t){const{spatialReference:e,x:r}=this;t!=null&&e&&(e.isWebMercator?this._set("y",y2(r,t,eC)[1]):e.isGeographic&&this._set("y",t),this._set("latitude",t))}get longitude(){const{x:t,y:e,spatialReference:r}=this;if(r){if(r.isWebMercator)return F3(t,e,eC)[0];if(r.isGeographic)return t}return null}set longitude(t){const{y:e,spatialReference:r}=this;t!=null&&r&&(r.isWebMercator?this._set("x",y2(t,e,eC)[0]):r.isGeographic&&this._set("x",t),this._set("longitude",t))}writeX(t,e,r){e[r]=isNaN(t)?"NaN":t}readX(t){return typeof t=="string"?NaN:t}clone(){const t=new W$;return t.x=this.x,t.y=this.y,t.z=this.z,t.m=this.m,t.spatialReference=this.spatialReference,t}copy(t){return W$.copy(t,this),this}equals(t){if(C(t))return!1;const{x:e,y:r,z:i,m:s,spatialReference:n}=this,{z:o,m:a}=t;let{x:l,y:c,spatialReference:h}=t;if(!n.equals(h))if(n.isWebMercator&&h.isWGS84)[l,c]=y2(l,c),h=n;else{if(!n.isWGS84||!h.isWebMercator)return!1;[l,c]=F3(l,c),h=n}return e===l&&r===c&&i===o&&s===a&&n.wkid===h.wkid}offset(t,e,r){return this.x+=t,this.y+=e,r!=null&&(this.z=(this.z??0)+r),this}normalize(){if(!this.spatialReference)return this;const t=I_(this.spatialReference);if(!t)return this;let e=this.x;const[r,i]=t.valid,s=2*i;let n;return e>i?(n=Math.ceil(Math.abs(e-i)/s),e-=n*s):e<r&&(n=Math.ceil(Math.abs(e-r)/s),e+=n*s),this._set("x",e),this}distance(t){return GOe(this,t)}toArray(){const t=this.hasZ,e=this.hasM;return t&&e?[this.x,this.y,this.z,this.m]:t?[this.x,this.y,this.z]:e?[this.x,this.y,this.m]:[this.x,this.y]}toJSON(t){return this.write({},t)}};u([d({readOnly:!0})],bl.prototype,"cache",null),u([d({type:Boolean,json:{read:!1,write:{enabled:!1,overridePolicy:null}}})],bl.prototype,"hasM",null),u([d({type:Boolean,json:{read:!1,write:{enabled:!1,overridePolicy:null}}})],bl.prototype,"hasZ",null),u([d({type:Number})],bl.prototype,"latitude",null),u([d({type:Number})],bl.prototype,"longitude",null),u([d({type:Number,json:{type:[Number,String],write:{isRequired:!0,allowNull:!0}}}),cr(t=>isNaN(t)?t:bh(t))],bl.prototype,"x",void 0),u([He("x")],bl.prototype,"writeX",null),u([Fe("x")],bl.prototype,"readX",null),u([d({type:Number,json:{write:!0}})],bl.prototype,"y",void 0),u([d({type:Number,json:{write:{overridePolicy(){return{enabled:this.hasZ}}}}})],bl.prototype,"z",void 0),u([d({type:Number,json:{write:{overridePolicy(){return{enabled:this.hasM}}}}})],bl.prototype,"m",void 0),bl=W$=u([I("esri.geometry.Point")],bl),bl.prototype.toJSON.isDefaultToJSON=!0;const mt=bl,M6=[0,0];function Tq(t,e){return!!v(e)&&ja(t,e.x,e.y,e.z)}function Twt(t,e){if(!e.points||e.points.length)return!1;for(const r of e.points)if(!TS(t,r))return!1;return!0}function qOe(t,e){const{xmin:r,ymin:i,zmin:s,xmax:n,ymax:o,zmax:a}=e;return t.hasZ&&e.hasZ?ja(t,r,i,s)&&ja(t,r,o,s)&&ja(t,n,o,s)&&ja(t,n,i,s)&&ja(t,r,i,a)&&ja(t,r,o,a)&&ja(t,n,o,a)&&ja(t,n,i,a):ja(t,r,i)&&ja(t,r,o)&&ja(t,n,o)&&ja(t,n,i)}function TS(t,e){return ja(t,e[0],e[1])}function WOe(t,e){return ja(t,e[0],e[1],e[2])}function ja(t,e,r,i){return e>=t.xmin&&e<=t.xmax&&r>=t.ymin&&r<=t.ymax&&(i==null||!t.hasZ||i>=t.zmin&&i<=t.zmax)}function XOe(t,e){return M6[1]=e.y,M6[0]=e.x,YOe(t,M6)}function YOe(t,e){return Phe(t.rings,e)}function Phe(t,e){if(!t)return!1;if(ZOe(t))return yK(!1,t,e);let r=!1;for(let i=0,s=t.length;i<s;i++)r=yK(r,t[i],e);return r}function ZOe(t){return!Array.isArray(t[0][0])}function yK(t,e,r){const[i,s]=r;let n=t,o=0;for(let a=0,l=e.length;a<l;a++){o++,o===l&&(o=0);const[c,h]=e[a],[p,f]=e[o];(h<s&&f>=s||f<s&&h>=s)&&c+(s-h)/(f-h)*(p-c)<i&&(n=!n)}return n}function JOe(t,e){return Tq(t,e)}function KOe(t,e){const r=t.hasZ&&e.hasZ;let i,s,n;if(t.xmin<=e.xmin){if(i=e.xmin,t.xmax<i)return!1}else if(i=t.xmin,e.xmax<i)return!1;if(t.ymin<=e.ymin){if(s=e.ymin,t.ymax<s)return!1}else if(s=t.ymin,e.ymax<s)return!1;if(r&&e.hasZ){if(t.zmin<=e.zmin){if(n=e.zmin,t.zmax<n)return!1}else if(n=t.zmin,e.zmax<n)return!1}return!0}function QOe(t,e){const{points:r,hasZ:i}=e,s=i?WOe:TS;for(const n of r)if(s(t,n))return!0;return!1}const hw=[0,0],dw=[0,0],pw=[0,0],fw=[0,0],eMe=[hw,dw,pw,fw],Ihe=[[pw,hw],[hw,dw],[dw,fw],[fw,pw]];function tMe(t,e){return rMe(t,e.rings)}function rMe(t,e){hw[0]=t.xmin,hw[1]=t.ymax,dw[0]=t.xmax,dw[1]=t.ymax,pw[0]=t.xmin,pw[1]=t.ymin,fw[0]=t.xmax,fw[1]=t.ymin;for(const r of eMe)if(Phe(e,r))return!0;for(const r of e){if(!r.length)continue;let i=r[0];if(TS(t,i))return!0;for(let s=1;s<r.length;s++){const n=r[s];if(TS(t,n)||$he(i,n,Ihe))return!0;i=n}}return!1}function iMe(t,e){hw[0]=t.xmin,hw[1]=t.ymax,dw[0]=t.xmax,dw[1]=t.ymax,pw[0]=t.xmin,pw[1]=t.ymin,fw[0]=t.xmax,fw[1]=t.ymin;const r=e.paths;for(const i of r){if(!r.length)continue;let s=i[0];if(TS(t,s))return!0;for(let n=1;n<i.length;n++){const o=i[n];if(TS(t,o)||$he(s,o,Ihe))return!0;s=o}}return!1}const No=[0,0];function sMe(t){for(let e=0;e<t.length;e++){const r=t[e];for(let s=0;s<r.length-1;s++){const n=r[s],o=r[s+1];for(let a=e+1;a<t.length;a++)for(let l=0;l<t[a].length-1;l++){const c=t[a][l],h=t[a][l+1];if(cV(n,o,c,h,No)&&!(No[0]===n[0]&&No[1]===n[1]||No[0]===c[0]&&No[1]===c[1]||No[0]===o[0]&&No[1]===o[1]||No[0]===h[0]&&No[1]===h[1]))return!0}}const i=r.length;if(!(i<=4))for(let s=0;s<i-3;s++){let n=i-1;s===0&&(n=i-2);const o=r[s],a=r[s+1];for(let l=s+2;l<n;l++){const c=r[l],h=r[l+1];if(cV(o,a,c,h,No)&&!(No[0]===o[0]&&No[1]===o[1]||No[0]===c[0]&&No[1]===c[1]||No[0]===a[0]&&No[1]===a[1]||No[0]===h[0]&&No[1]===h[1]))return!0}}}return!1}function $he(t,e,r){for(let i=0;i<r.length;i++)if(cV(t,e,r[i][0],r[i][1]))return!0;return!1}function cV(t,e,r,i,s){const[n,o]=t,[a,l]=e,[c,h]=r,[p,f]=i,m=p-c,y=n-c,_=a-n,b=f-h,x=o-h,T=l-o,S=b*_-m*T;if(S===0)return!1;const E=(m*x-b*y)/S,O=(_*x-T*y)/S;return E>=0&&E<=1&&O>=0&&O<=1&&(s&&(s[0]=n+E*(a-n),s[1]=o+E*(l-o)),!0)}function nMe(t){switch(t){case"esriGeometryEnvelope":case"extent":return KOe;case"esriGeometryMultipoint":case"multipoint":return QOe;case"esriGeometryPoint":case"point":return JOe;case"esriGeometryPolygon":case"polygon":return tMe;case"esriGeometryPolyline":case"polyline":return iMe}}var eh;function oMe(t){return t&&(t.declaredClass==="esri.geometry.SpatialReference"||t.wkid!=null)}function $y(t,e,r){return e==null?r:r==null?e:t(e,r)}let uo=eh=class extends pv{constructor(...t){super(...t),this.type="extent",this.xmin=0,this.ymin=0,this.mmin=void 0,this.zmin=void 0,this.xmax=0,this.ymax=0,this.mmax=void 0,this.zmax=void 0}normalizeCtorArgs(t,e,r,i,s){return oMe(t)?{spatialReference:t,xmin:0,ymin:0,xmax:0,ymax:0}:typeof t=="object"?(t.spatialReference=t.spatialReference==null?et.WGS84:t.spatialReference,t):{xmin:t,ymin:e,xmax:r,ymax:i,spatialReference:s??et.WGS84}}static fromBounds(t,e){return new eh({xmin:t[0],ymin:t[1],xmax:t[2],ymax:t[3],spatialReference:e})}static fromPoint(t){return new eh({xmin:t.x,ymin:t.y,zmin:t.z,xmax:t.x,ymax:t.y,zmax:t.z,spatialReference:t.spatialReference})}get cache(){return this.commitProperty("xmin"),this.commitProperty("ymin"),this.commitProperty("zmin"),this.commitProperty("mmin"),this.commitProperty("xmax"),this.commitProperty("ymax"),this.commitProperty("zmax"),this.commitProperty("mmax"),this.commitProperty("spatialReference"),{}}get center(){const t=new mt({x:.5*(this.xmin+this.xmax),y:.5*(this.ymin+this.ymax),spatialReference:this.spatialReference});return this.hasZ&&(t.z=.5*(this.zmin+this.zmax)),this.hasM&&(t.m=.5*(this.mmin+this.mmax)),t}get extent(){return this.clone()}get hasM(){return this.mmin!=null&&this.mmax!=null}get hasZ(){return this.zmin!=null&&this.zmax!=null}get height(){return Math.abs(this.ymax-this.ymin)}get width(){return Math.abs(this.xmax-this.xmin)}centerAt(t){const e=this.center;return t.z!=null&&this.hasZ?this.offset(t.x-e.x,t.y-e.y,t.z-e.z):this.offset(t.x-e.x,t.y-e.y)}clone(){const t=new eh;return t.xmin=this.xmin,t.ymin=this.ymin,t.xmax=this.xmax,t.ymax=this.ymax,t.spatialReference=this.spatialReference,this.zmin!=null&&(t.zmin=this.zmin,t.zmax=this.zmax),this.mmin!=null&&(t.mmin=this.mmin,t.mmax=this.mmax),t}contains(t){if(!t)return!1;const e=this.spatialReference,r=t.spatialReference;return e&&r&&!e.equals(r)&&$_(e,r)&&(t=e.isWebMercator?jf(t):_2(t,!0)),t.type==="point"?Tq(this,t):t.type==="extent"&&qOe(this,t)}equals(t){if(this===t)return!0;if(C(t))return!1;const e=this.spatialReference,r=t.spatialReference;return e&&r&&!e.equals(r)&&$_(e,r)&&(t=e.isWebMercator?jf(t):_2(t,!0)),this.xmin===t.xmin&&this.ymin===t.ymin&&this.zmin===t.zmin&&this.mmin===t.mmin&&this.xmax===t.xmax&&this.ymax===t.ymax&&this.zmax===t.zmax&&this.mmax===t.mmax}expand(t){const e=.5*(1-t),r=this.width*e,i=this.height*e;if(this.xmin+=r,this.ymin+=i,this.xmax-=r,this.ymax-=i,this.hasZ){const s=(this.zmax-this.zmin)*e;this.zmin+=s,this.zmax-=s}if(this.hasM){const s=(this.mmax-this.mmin)*e;this.mmin+=s,this.mmax-=s}return this}intersects(t){if(C(t))return!1;t.type==="mesh"&&(t=t.extent);const e=this.spatialReference,r=t.spatialReference;return e&&r&&!Tn(e,r)&&$_(e,r)&&(t=e.isWebMercator?jf(t):_2(t,!0)),nMe(t.type)(this,t)}normalize(){const t=this._normalize(!1,!0);return Array.isArray(t)?t:[t]}offset(t,e,r){return this.xmin+=t,this.ymin+=e,this.xmax+=t,this.ymax+=e,r!=null&&(this.zmin+=r,this.zmax+=r),this}shiftCentralMeridian(){return this._normalize(!0)}union(t){return this===t||(this.xmin=Math.min(this.xmin,t.xmin),this.ymin=Math.min(this.ymin,t.ymin),this.xmax=Math.max(this.xmax,t.xmax),this.ymax=Math.max(this.ymax,t.ymax),(this.hasZ||t.hasZ)&&(this.zmin=$y(Math.min,this.zmin,t.zmin),this.zmax=$y(Math.max,this.zmax,t.zmax)),(this.hasM||t.hasM)&&(this.mmin=$y(Math.min,this.mmin,t.mmin),this.mmax=$y(Math.max,this.mmax,t.mmax))),this}intersection(t){return this===t?this:C(t)||!this.intersects(t)?null:(this.xmin=Math.max(this.xmin,t.xmin),this.ymin=Math.max(this.ymin,t.ymin),this.xmax=Math.min(this.xmax,t.xmax),this.ymax=Math.min(this.ymax,t.ymax),(this.hasZ||t.hasZ)&&(this.zmin=$y(Math.max,this.zmin,t.zmin),this.zmax=$y(Math.min,this.zmax,t.zmax)),(this.hasM||t.hasM)&&(this.mmin=$y(Math.max,this.mmin,t.mmin),this.mmax=$y(Math.min,this.mmax,t.mmax)),this)}toJSON(t){return this.write({},t)}_shiftCM(t=I_(this.spatialReference)){if(!t||!this.spatialReference)return this;const e=this.spatialReference,r=this._getCM(t);if(r){const i=e.isWebMercator?_2(r):r;this.xmin-=r.x,this.xmax-=r.x,e.isWebMercator||(i.x=this._normalizeX(i.x,t).x),this.spatialReference=new et(tm((e.isWGS84?t.altTemplate:null)??t.wkTemplate,{Central_Meridian:i.x}))}return this}_getCM(t){let e=null;const[r,i]=t.valid,s=this.xmin,n=this.xmax;return s>=r&&s<=i&&n>=r&&n<=i||(e=this.center),e}_normalize(t,e,r){const i=this.spatialReference;if(!i)return this;const s=r??I_(i);if(s==null)return this;const n=this._getParts(s).map(l=>l.extent);if(n.length<2)return n[0]||this;if(n.length>2)return t?this._shiftCM(s):this.set({xmin:s.valid[0],xmax:s.valid[1]});if(t)return this._shiftCM(s);if(e)return n;let o=!0,a=!0;return n.forEach(l=>{l.hasZ||(o=!1),l.hasM||(a=!1)}),{rings:n.map(l=>{const c=[[l.xmin,l.ymin],[l.xmin,l.ymax],[l.xmax,l.ymax],[l.xmax,l.ymin],[l.xmin,l.ymin]];if(o){const h=(l.zmax-l.zmin)/2;for(let p=0;p<c.length;p++)c[p].push(h)}if(a){const h=(l.mmax-l.mmin)/2;for(let p=0;p<c.length;p++)c[p].push(h)}return c}),hasZ:o,hasM:a,spatialReference:i}}_getParts(t){let e=this.cache._parts;if(!e){e=[];const{ymin:s,ymax:n,spatialReference:o}=this,a=this.width,l=this.xmin,c=this.xmax;let h;t=t||I_(o);const[p,f]=t.valid;h=this._normalizeX(this.xmin,t);const m=h.x,y=h.frameId;h=this._normalizeX(this.xmax,t);const _=h.x,b=h.frameId,x=m===_&&a>0;if(a>2*f){const T=new eh(l<c?m:_,s,f,n,o),S=new eh(p,s,l<c?_:m,n,o),E=new eh(0,s,f,n,o),O=new eh(p,s,0,n,o),R=[],L=[];T.contains(E)&&R.push(y),T.contains(O)&&L.push(y),S.contains(E)&&R.push(b),S.contains(O)&&L.push(b);for(let P=y+1;P<b;P++)R.push(P),L.push(P);e.push({extent:T,frameIds:[y]},{extent:S,frameIds:[b]},{extent:E,frameIds:R},{extent:O,frameIds:L})}else m>_||x?e.push({extent:new eh(m,s,f,n,o),frameIds:[y]},{extent:new eh(p,s,_,n,o),frameIds:[b]}):e.push({extent:new eh(m,s,_,n,o),frameIds:[y]});this.cache._parts=e}const r=this.hasZ,i=this.hasM;if(r||i){const s={};r&&(s.zmin=this.zmin,s.zmax=this.zmax),i&&(s.mmin=this.mmin,s.mmax=this.mmax);for(let n=0;n<e.length;n++)e[n].extent.set(s)}return e}_normalizeX(t,e){const[r,i]=e.valid,s=2*i;let n,o=0;return t>i?(n=Math.ceil(Math.abs(t-i)/s),t-=n*s,o=n):t<r&&(n=Math.ceil(Math.abs(t-r)/s),t+=n*s,o=-n),{x:t,frameId:o}}};u([d({readOnly:!0})],uo.prototype,"cache",null),u([d({readOnly:!0})],uo.prototype,"center",null),u([d({readOnly:!0})],uo.prototype,"extent",null),u([d({readOnly:!0,json:{write:{enabled:!1,overridePolicy:null}}})],uo.prototype,"hasM",null),u([d({readOnly:!0,json:{write:{enabled:!1,overridePolicy:null}}})],uo.prototype,"hasZ",null),u([d({readOnly:!0})],uo.prototype,"height",null),u([d({readOnly:!0})],uo.prototype,"width",null),u([d({type:Number,json:{type:[Number,String],write:{enabled:!0,allowNull:!0}}})],uo.prototype,"xmin",void 0),u([d({type:Number,json:{write:!0}})],uo.prototype,"ymin",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasM}}}}})],uo.prototype,"mmin",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasZ}}}}})],uo.prototype,"zmin",void 0),u([d({type:Number,json:{write:!0}})],uo.prototype,"xmax",void 0),u([d({type:Number,json:{write:!0}})],uo.prototype,"ymax",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasM}}}}})],uo.prototype,"mmax",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasZ}}}}})],uo.prototype,"zmax",void 0),uo=eh=u([I("esri.geometry.Extent")],uo),uo.prototype.toJSON.isDefaultToJSON=!0;const Zr=uo;let U3;var Fce,Uce;const aMe=((Fce=globalThis.esriConfig)==null?void 0:Fce.locale)??((Uce=globalThis.dojoConfig)==null?void 0:Uce.locale);function Lhe(){var t;return aMe??((t=globalThis.navigator)==null?void 0:t.language)??"en"}function Ih(){return U3===void 0&&(U3=Lhe()),U3}const k3=[];function Dhe(t){return k3.push(t),{remove(){k3.splice(k3.indexOf(t),1)}}}const uV=[];function Sq(t){return uV.push(t),{remove(){k3.splice(uV.indexOf(t),1)}}}function lMe(){const t=Lhe();U3!==t&&(U3=t,[...uV].forEach(e=>{e.call(null,t)}),[...k3].forEach(e=>{e.call(null,t)}))}var kce;(kce=globalThis.addEventListener)==null||kce.call(globalThis,"languagechange",lMe);var hV;const cMe=new mr({avgRating:"avg-rating",numRatings:"num-ratings",numComments:"num-comments",numViews:"num-views"});let th=hV=class extends Te{constructor(t){super(t),this.categories=null,this.disableExtraQuery=!1,this.extent=null,this.filter=null,this.num=10,this.query=null,this.sortField=null,this.start=1}get sortOrder(){return this._get("sortOrder")||"asc"}set sortOrder(t){t!=="asc"&&t!=="desc"||this._set("sortOrder",t)}clone(){return new hV({categories:this.categories?ne(this.categories):null,disableExtraQuery:this.disableExtraQuery,extent:this.extent?this.extent.clone():null,filter:this.filter,num:this.num,query:this.query,sortField:this.sortField,sortOrder:this.sortOrder,start:this.start})}toRequestOptions(t,e){let r=[];this.categories&&(r=this.categories.map(o=>Array.isArray(o)?JSON.stringify(o):o));let i="";if(this.extent){const o=Gw(this.extent,et.WGS84);v(o)&&(i=`${o.xmin},${o.ymin},${o.xmax},${o.ymax}`)}let s=this.query;!this.disableExtraQuery&&t.extraQuery&&(s="("+s+")"+t.extraQuery);const n={categories:r,bbox:i,q:s,filter:this.filter,num:this.num,sortField:null,sortOrder:null,start:this.start};return this.sortField&&(n.sortField=this.sortField.split(",").map(o=>cMe.toJSON(o.trim())).join(","),n.sortOrder=this.sortOrder),{query:{...e,...n}}}};u([d()],th.prototype,"categories",void 0),u([d()],th.prototype,"disableExtraQuery",void 0),u([d({type:Zr})],th.prototype,"extent",void 0),u([d()],th.prototype,"filter",void 0),u([d()],th.prototype,"num",void 0),u([d()],th.prototype,"query",void 0),u([d()],th.prototype,"sortField",void 0),u([d()],th.prototype,"sortOrder",null),u([d()],th.prototype,"start",void 0),th=hV=u([I("esri.portal.PortalQueryParams")],th);const Rg=th;let m1=class extends Te{constructor(e){super(e),this.nextQueryParams=null,this.queryParams=null,this.results=null,this.total=null}};u([d()],m1.prototype,"nextQueryParams",void 0),u([d()],m1.prototype,"queryParams",void 0),u([d()],m1.prototype,"results",void 0),u([d()],m1.prototype,"total",void 0),m1=u([I("esri.portal.PortalQueryResult")],m1);const uMe=m1;let Zm=class extends ve{constructor(e){super(e),this.created=null,this.id=null,this.portal=null,this.title=null,this.username=null}get url(){const e=this.get("portal.restUrl");return e?`${e}/content/users/${this.username}/${this.id}`:null}toJSON(){throw new q("internal:not-yet-implemented","PortalFolder.toJSON is not yet implemented")}};u([d({type:Date})],Zm.prototype,"created",void 0),u([d()],Zm.prototype,"id",void 0),u([d()],Zm.prototype,"portal",void 0),u([d()],Zm.prototype,"title",void 0),u([d({readOnly:!0})],Zm.prototype,"url",null),u([d()],Zm.prototype,"username",void 0),Zm=u([I("esri.portal.PortalFolder")],Zm);const hMe=Zm;let ho=class extends ve{constructor(e){super(e),this.access=null,this.created=null,this.description=null,this.id=null,this.isInvitationOnly=!1,this.modified=null,this.owner=null,this.portal=null,this.snippet=null,this.sortField=null,this.sortOrder=null,this.tags=null,this.title=null}get thumbnailUrl(){var i;const e=this.url,r=this.thumbnail;return e&&r&&this.portal?(i=this.portal)==null?void 0:i.normalizeUrl(`${e}/info/${r}?f=json`):null}get url(){const e=this.get("portal.restUrl");return e?e+"/community/groups/"+this.id:null}fetchCategorySchema(e){return Dl(this.portal).request(this.url+"/categorySchema",e).then(r=>{const i=r.categorySchema||[];return i.some(s=>s.source==="contentCategorySetsGroupQuery.LivingAtlas")?this._fetchCategorySchemaSet("LivingAtlas",e):i})}fetchMembers(e){return Dl(this.portal).request(this.url+"/users",e)}getThumbnailUrl(e){let r=this.thumbnailUrl;return r&&e&&(r+=`&w=${e}`),r}toJSON(){throw new q("internal:not-yet-implemented","PortalGroup.toJSON is not yet implemented")}queryItems(e,r){let i=us(Rg,e);const s=Dl(this.portal);return parseFloat(s.currentVersion)>5?(i=i||new Rg,s.queryPortal(`/content/groups/${this.id}/search`,i,"PortalItem",r)):(i=i?i.clone():new Rg,i.query="group:"+this.id+(i.query?" "+i.query:""),s.queryItems(i,r))}_fetchCategorySchemaSet(e,r){const i=Dl(this.portal);return i.fetchSelf(i.authMode,!0,r).then(s=>{const n=s.contentCategorySetsGroupQuery;if(n){const o=new Rg;return o.disableExtraQuery=!0,o.num=1,o.query=n,i.queryGroups(o,r)}throw new q("portal-group:fetchCategorySchema","contentCategorySetsGroupQuery value not found")}).then(s=>{if(s.total){const n=s.results[0],o=new Rg;return o.num=1,o.query=`typekeywords:"${e}"`,n.queryItems(o,r)}throw new q("portal-group:fetchCategorySchema","contentCategorySetsGroupQuery group not found")}).then(s=>s.total?s.results[0].fetchData("json",r).then(n=>{const o=n&&n.categorySchema;return o&&o.length?o:[]}):[])}};u([d()],ho.prototype,"access",void 0),u([d({type:Date})],ho.prototype,"created",void 0),u([d()],ho.prototype,"description",void 0),u([d()],ho.prototype,"id",void 0),u([d()],ho.prototype,"isInvitationOnly",void 0),u([d({type:Date})],ho.prototype,"modified",void 0),u([d()],ho.prototype,"owner",void 0),u([d()],ho.prototype,"portal",void 0),u([d()],ho.prototype,"snippet",void 0),u([d()],ho.prototype,"sortField",void 0),u([d()],ho.prototype,"sortOrder",void 0),u([d()],ho.prototype,"tags",void 0),u([d()],ho.prototype,"thumbnail",void 0),u([d({readOnly:!0})],ho.prototype,"thumbnailUrl",null),u([d()],ho.prototype,"title",void 0),u([d({readOnly:!0})],ho.prototype,"url",null),ho=u([I("esri.portal.PortalGroup")],ho);const dV=ho,dMe=Object.freeze(Object.defineProperty({__proto__:null,default:dV},Symbol.toStringTag,{value:"Module"}));var pV;let Cs=pV=class extends ve{constructor(...t){super(...t),this.access=null,this.created=null,this.culture=null,this.description=null,this.email=null,this.fullName=null,this.modified=null,this.orgId=null,this.portal=null,this.preferredView=null,this.privileges=null,this.region=null,this.role=null,this.roleId=null,this.sourceJSON=null,this.units=null,this.username=null,this.userType=null}get thumbnailUrl(){const t=this.url,e=this.thumbnail;return t&&e?this.portal.normalizeUrl(`${t}/info/${e}?f=json`):null}get userContentUrl(){const t=this.get("portal.restUrl");return t?`${t}/content/users/${this.username}`:null}get url(){const t=this.get("portal.restUrl");return t?`${t}/community/users/${this.username}`:null}addItem(t){const e=t&&t.item,r=t&&t.data,i=t&&t.folder,s={method:"post"};e&&(s.query=e.createPostQuery(),r!=null&&(typeof r=="string"?s.query.text=r:typeof r=="object"&&(s.query.text=JSON.stringify(r))));let n=this.userContentUrl;return i&&(n+="/"+(typeof i=="string"?i:i.id)),this.portal.request(n+"/addItem",s).then(o=>(e.id=o.id,e.portal=this.portal,e.loaded?e.reload():e.load()))}deleteItem(t){let e=this.userContentUrl;return t.ownerFolder&&(e+="/"+t.ownerFolder),this.portal.request(e+`/items/${t.id}/delete`,{method:"post"}).then(()=>{t.id=null,t.portal=null})}deleteItems(t){const e=this.userContentUrl+"/deleteItems",r=t.map(i=>i.id);if(r.length){const i={method:"post",query:{items:r.join(",")}};return this.portal.request(e,i).then(()=>{t.forEach(s=>{s.id=null,s.portal=null})})}return Promise.resolve(void 0)}fetchFolders(){const t={query:{num:1}};return this.portal.request(this.userContentUrl??"",t).then(e=>{let r;return r=e&&e.folders?e.folders.map(i=>{const s=hMe.fromJSON(i);return s.portal=this.portal,s}):[],r})}fetchGroups(){return this.portal.request(this.url??"").then(t=>{let e;return e=t&&t.groups?t.groups.map(r=>{const i=dV.fromJSON(r);return i.portal=this.portal,i}):[],e})}fetchItems(t){const e=t??{};let r,i=this.userContentUrl??"";return e.folder&&(i+="/"+e.folder.id),te(()=>Promise.resolve().then(()=>Nhe),void 0).then(({default:s})=>{r=s;const n={folders:!1,num:e.num||10,start:e.start||1,sortField:e.sortField||"created",sortOrder:e.sortOrder||"asc"};return this.portal.request(i,{query:n})}).then(s=>{let n;return s&&s.items?(n=s.items.map(o=>{const a=r.fromJSON(o);return a.portal=this.portal,a}),Promise.all(n.map(o=>o.load())).catch(o=>o).then(()=>({items:n,nextStart:s.nextStart,total:s.total}))):{items:[],nextStart:-1,total:0}})}fetchTags(){return this.portal.request(this.url+"/tags").then(t=>t.tags)}getThumbnailUrl(t){let e=this.thumbnailUrl;return e&&t&&(e+=`&w=${t}`),e}queryFavorites(t){return this.favGroupId?(this._favGroup||(this._favGroup=new dV({id:this.favGroupId,portal:this.portal})),this._favGroup.queryItems(t)):Promise.reject(new q("internal:unknown","Unknown internal error",{internalError:"Unknown favGroupId"}))}toJSON(){throw new q("internal:not-yet-implemented","PortalGroup.toJSON is not yet implemented")}static fromJSON(t){if(!t)return null;if(t.declaredClass)throw new Error("JSON object is already hydrated");const e=new pV;return e.sourceJSON=t,e.read(t),e}};u([d()],Cs.prototype,"access",void 0),u([d({type:Date})],Cs.prototype,"created",void 0),u([d()],Cs.prototype,"culture",void 0),u([d()],Cs.prototype,"description",void 0),u([d()],Cs.prototype,"email",void 0),u([d()],Cs.prototype,"favGroupId",void 0),u([d()],Cs.prototype,"fullName",void 0),u([d({type:Date})],Cs.prototype,"modified",void 0),u([d()],Cs.prototype,"orgId",void 0),u([d()],Cs.prototype,"portal",void 0),u([d()],Cs.prototype,"preferredView",void 0),u([d()],Cs.prototype,"privileges",void 0),u([d()],Cs.prototype,"region",void 0),u([d()],Cs.prototype,"role",void 0),u([d()],Cs.prototype,"roleId",void 0),u([d()],Cs.prototype,"sourceJSON",void 0),u([d()],Cs.prototype,"thumbnail",void 0),u([d({readOnly:!0})],Cs.prototype,"thumbnailUrl",null),u([d()],Cs.prototype,"units",void 0),u([d({readOnly:!0})],Cs.prototype,"userContentUrl",null),u([d({readOnly:!0})],Cs.prototype,"url",null),u([d()],Cs.prototype,"username",void 0),u([d()],Cs.prototype,"userType",void 0),Cs=pV=u([I("esri.portal.PortalUser")],Cs);const Eq=Cs,pMe=Object.freeze(Object.defineProperty({__proto__:null,default:Eq},Symbol.toStringTag,{value:"Module"}));var Jc;let P6;const _K={PortalGroup:()=>te(()=>Promise.resolve().then(()=>dMe),void 0),PortalItem:()=>te(()=>Promise.resolve().then(()=>Nhe),void 0),PortalUser:()=>te(()=>Promise.resolve().then(()=>pMe),void 0)};let ze=Jc=class extends XO(Zg){constructor(t){super(t),this._esriIdCredentialCreateHandle=null,this.access=null,this.allSSL=!1,this.authMode="auto",this.authorizedCrossOriginDomains=null,this.basemapGalleryGroupQuery=null,this.bingKey=null,this.canListApps=!1,this.canListData=!1,this.canListPreProvisionedItems=!1,this.canProvisionDirectPurchase=!1,this.canSearchPublic=!0,this.canShareBingPublic=!1,this.canSharePublic=!1,this.canSignInArcGIS=!1,this.canSignInIDP=!1,this.colorSetsGroupQuery=null,this.commentsEnabled=!1,this.created=null,this.culture=null,this.customBaseUrl=null,this.defaultBasemap=null,this.defaultDevBasemap=null,this.defaultExtent=null,this.defaultVectorBasemap=null,this.description=null,this.devBasemapGalleryGroupQuery=null,this.eueiEnabled=null,this.featuredGroups=null,this.featuredItemsGroupQuery=null,this.galleryTemplatesGroupQuery=null,this.livingAtlasGroupQuery=null,this.hasCategorySchema=!1,this.helperServices=null,this.homePageFeaturedContent=null,this.homePageFeaturedContentCount=null,this.httpPort=null,this.httpsPort=null,this.id=null,this.ipCntryCode=null,this.isPortal=!1,this.isReadOnly=!1,this.layerTemplatesGroupQuery=null,this.maxTokenExpirationMinutes=null,this.modified=null,this.name=null,this.portalHostname=null,this.portalMode=null,this.portalProperties=null,this.region=null,this.rotatorPanels=null,this.showHomePageDescription=!1,this.sourceJSON=null,this.supportsHostedServices=!1,this.symbolSetsGroupQuery=null,this.templatesGroupQuery=null,this.units=null,this.url=Yr.portalUrl,this.urlKey=null,this.user=null,this.useStandardizedQuery=!1,this.useVectorBasemaps=!1,this.vectorBasemapGalleryGroupQuery=null}normalizeCtorArgs(t){return typeof t=="string"?{url:t}:t}destroy(){this._esriIdCredentialCreateHandle=ji(this._esriIdCredentialCreateHandle)}readAuthorizedCrossOriginDomains(t){if(t)for(const e of t)Yr.request.trustedServers.includes(e)||Yr.request.trustedServers.push(e);return t}readDefaultBasemap(t){return this._readBasemap(t)}readDefaultDevBasemap(t){return this._readBasemap(t)}readDefaultVectorBasemap(t){return this._readBasemap(t)}get extraQuery(){const t=!(this.user&&this.user.orgId)||this.canSearchPublic;return this.id&&!t?` AND orgid:${this.id}`:null}get isOrganization(){return!!this.access}get itemPageUrl(){return this.url?`${this.url}/home/item.html`:null}get restUrl(){let t=this.url;if(t){const e=t.indexOf("/sharing");t=e>0?t.substring(0,e):this.url.replace(/\/+$/,""),t+="/sharing/rest"}return t}get thumbnailUrl(){const t=this.restUrl,e=this.thumbnail;return t&&e?this._normalizeSSL(t+"/portals/self/resources/"+e):null}readUrlKey(t){return t&&t.toLowerCase()}readUser(t){let e=null;return t&&(e=Eq.fromJSON(t),e.portal=this),e}load(t){const e=te(()=>Promise.resolve().then(()=>NMe),void 0).then(({default:r})=>{fr(t),P6=r}).then(()=>this.sourceJSON?this.sourceJSON:this.fetchSelf(this.authMode,!1,t)).then(r=>{if(wi){const i=wi;this.credential=i.findCredential(this.restUrl),this.credential||this.authMode!==Jc.AUTH_MODE_AUTO||(this._esriIdCredentialCreateHandle=i.on("credential-create",()=>{i.findCredential(this.restUrl)&&this.signIn().catch(()=>{})}))}this.sourceJSON=r,this.read(r)});return this.addResolvingPromise(e),Promise.resolve(this)}async createElevationLayers(){await this.load();const t=this._getHelperService("defaultElevationLayers"),e=(await te(()=>import("./ElevationLayer-8d353e13.js"),["assets/ElevationLayer-8d353e13.js","assets/ArcGISCachedService-5987493e.js","assets/TilemapCache-fc3c869b.js"])).default;return t?t.map(r=>new e({id:r.id,url:r.url})):[]}fetchBasemaps(t,e){const r=new Rg;return r.query=t||(Yr.apiKey&&Ahe(this.url)?this.devBasemapGalleryGroupQuery:this.useVectorBasemaps?this.vectorBasemapGalleryGroupQuery:this.basemapGalleryGroupQuery),r.disableExtraQuery=!0,this.queryGroups(r,e).then(i=>{if(r.num=100,r.query='type:"Web Map" -type:"Web Application"',i.total){const s=i.results[0];return r.sortField=s.sortField||"name",r.sortOrder=s.sortOrder||"desc",s.queryItems(r,e)}return null}).then(i=>{let s;return s=i&&i.total?i.results.filter(n=>n.type==="Web Map").map(n=>new P6({portalItem:n})):[],s})}fetchCategorySchema(t){return this.hasCategorySchema?this.request(this.restUrl+"/portals/self/categorySchema",t).then(e=>e.categorySchema):Ln(t)?Promise.reject(Hr()):Promise.resolve([])}fetchFeaturedGroups(t){const e=this.featuredGroups,r=new Rg;if(r.num=100,r.sortField="title",e&&e.length){const i=[];for(const s of e)i.push(`(title:"${s.title}" AND owner:${s.owner})`);return r.query=i.join(" OR "),this.queryGroups(r,t).then(s=>s.results)}return Ln(t)?Promise.reject(Hr()):Promise.resolve([])}fetchRegions(t){var r;const e=((r=this.user)==null?void 0:r.culture)||this.culture||Ih();return this.request(this.restUrl+"/portals/regions",{...t,query:{culture:e}})}fetchSettings(t){var r;const e=((r=this.user)==null?void 0:r.culture)||this.culture||Ih();return this.request(this.restUrl+"/portals/self/settings",{...t,query:{culture:e}})}static getDefault(){return Jc._default&&!Jc._default.destroyed||(Jc._default=new Jc),Jc._default}queryGroups(t,e){return this.queryPortal("/community/groups",t,"PortalGroup",e)}queryItems(t,e){return this.queryPortal("/search",t,"PortalItem",e)}queryUsers(t,e){return t.sortField||(t.sortField="username"),this.queryPortal("/community/users",t,"PortalUser",e)}fetchSelf(t=this.authMode,e=!1,r){const i=this.restUrl+"/portals/self",s={authMode:t,query:{culture:Ih().toLowerCase()},...r};return s.authMode==="auto"&&(s.authMode="no-prompt"),e&&(s.query.default=!0),this.request(i,s)}queryPortal(t,e,r,i){const s=us(Rg,e),n=o=>this.request(this.restUrl+t,{...s.toRequestOptions(this),...i}).then(a=>{const l=s.clone();return l.start=a.nextStart,new uMe({nextQueryParams:l,queryParams:s,total:a.total,results:Jc._resultsToTypedArray(o,{portal:this},a,i)})}).then(a=>Promise.all(a.results.map(l=>typeof l.when=="function"?l.when():a)).then(()=>a,l=>(xc(l),a)));return r&&_K[r]?_K[r]().then(({default:o})=>(fr(i),n(o))):n()}signIn(){if(this.authMode===Jc.AUTH_MODE_ANONYMOUS)return Promise.reject(new q("portal:invalid-auth-mode",`Current "authMode"' is "${this.authMode}"`));if(this.loadStatus==="failed")return Promise.reject(this.loadError);const t=e=>Promise.resolve().then(()=>this.loadStatus==="not-loaded"?(e||(this.authMode="immediate"),this.load().then(()=>null)):this.loadStatus==="loading"?this.load().then(()=>this.credential?null:(this.credential=e,this.fetchSelf("immediate"))):this.user&&this.credential===e?null:(this.credential=e,this.fetchSelf("immediate"))).then(r=>{r&&(this.sourceJSON=r,this.read(r))});return wi?wi.getCredential(this.restUrl).then(e=>t(e)):t(this.credential)}normalizeUrl(t){const e=this.credential&&this.credential.token;return this._normalizeSSL(e?t+(t.includes("?")?"&":"?")+"token="+e:t)}requestToTypedArray(t,e,r){return this.request(t,e).then(i=>{const s=Jc._resultsToTypedArray(r,{portal:this},i);return Promise.all(s.map(n=>typeof n.when=="function"?n.when():i)).then(()=>s,()=>s)})}request(t,e={}){const r={f:"json",...e.query},{authMode:i=this.authMode===Jc.AUTH_MODE_ANONYMOUS?"anonymous":"auto",body:s=null,cacheBust:n=!1,method:o="auto",responseType:a="json",signal:l}=e,c={authMode:i,body:s,cacheBust:n,method:o,query:r,responseType:a,timeout:0,signal:l};return Ni(this._normalizeSSL(t),c).then(h=>h.data)}toJSON(){throw new q("internal:not-yet-implemented","Portal.toJSON is not yet implemented")}static fromJSON(t){if(!t)return null;if(t.declaredClass)throw new Error("JSON object is already hydrated");return new Jc({sourceJSON:t})}_getHelperService(t){const e=this.helperServices&&this.helperServices[t];if(!e)throw new q("portal:service-not-found",`The \`helperServices\` do not include an entry named "${t}"`);return e}_normalizeSSL(t){return t.replace(/^http:/i,"https:").replace(":7080",":7443")}_readBasemap(t){if(t){const e=P6.fromJSON(t);return e.portalItem={portal:this},e}return null}static _resultsToTypedArray(t,e,r,i){let s=[];if(r){const n=v(i)?i.signal:null;s=r.listings||r.notifications||r.userInvitations||r.tags||r.items||r.groups||r.comments||r.provisions||r.results||r.relatedItems||r,(t||e)&&(s=s.map(o=>{const a=Object.assign(t?t.fromJSON(o):o,e);return typeof a.load=="function"&&a.load(n),a}))}else s=[];return s}};ze.AUTH_MODE_ANONYMOUS="anonymous",ze.AUTH_MODE_AUTO="auto",ze.AUTH_MODE_IMMEDIATE="immediate",u([d()],ze.prototype,"access",void 0),u([d()],ze.prototype,"allSSL",void 0),u([d()],ze.prototype,"authMode",void 0),u([d()],ze.prototype,"authorizedCrossOriginDomains",void 0),u([Fe("authorizedCrossOriginDomains")],ze.prototype,"readAuthorizedCrossOriginDomains",null),u([d()],ze.prototype,"basemapGalleryGroupQuery",void 0),u([d()],ze.prototype,"bingKey",void 0),u([d()],ze.prototype,"canListApps",void 0),u([d()],ze.prototype,"canListData",void 0),u([d()],ze.prototype,"canListPreProvisionedItems",void 0),u([d()],ze.prototype,"canProvisionDirectPurchase",void 0),u([d()],ze.prototype,"canSearchPublic",void 0),u([d()],ze.prototype,"canShareBingPublic",void 0),u([d()],ze.prototype,"canSharePublic",void 0),u([d()],ze.prototype,"canSignInArcGIS",void 0),u([d()],ze.prototype,"canSignInIDP",void 0),u([d()],ze.prototype,"colorSetsGroupQuery",void 0),u([d()],ze.prototype,"commentsEnabled",void 0),u([d({type:Date})],ze.prototype,"created",void 0),u([d()],ze.prototype,"credential",void 0),u([d()],ze.prototype,"culture",void 0),u([d()],ze.prototype,"currentVersion",void 0),u([d()],ze.prototype,"customBaseUrl",void 0),u([d()],ze.prototype,"defaultBasemap",void 0),u([Fe("defaultBasemap")],ze.prototype,"readDefaultBasemap",null),u([d()],ze.prototype,"defaultDevBasemap",void 0),u([Fe("defaultDevBasemap")],ze.prototype,"readDefaultDevBasemap",null),u([d({type:Zr})],ze.prototype,"defaultExtent",void 0),u([d()],ze.prototype,"defaultVectorBasemap",void 0),u([Fe("defaultVectorBasemap")],ze.prototype,"readDefaultVectorBasemap",null),u([d()],ze.prototype,"description",void 0),u([d()],ze.prototype,"devBasemapGalleryGroupQuery",void 0),u([d()],ze.prototype,"eueiEnabled",void 0),u([d({readOnly:!0})],ze.prototype,"extraQuery",null),u([d()],ze.prototype,"featuredGroups",void 0),u([d()],ze.prototype,"featuredItemsGroupQuery",void 0),u([d()],ze.prototype,"galleryTemplatesGroupQuery",void 0),u([d()],ze.prototype,"livingAtlasGroupQuery",void 0),u([d()],ze.prototype,"hasCategorySchema",void 0),u([d()],ze.prototype,"helpBase",void 0),u([d()],ze.prototype,"helperServices",void 0),u([d()],ze.prototype,"helpMap",void 0),u([d()],ze.prototype,"homePageFeaturedContent",void 0),u([d()],ze.prototype,"homePageFeaturedContentCount",void 0),u([d()],ze.prototype,"httpPort",void 0),u([d()],ze.prototype,"httpsPort",void 0),u([d()],ze.prototype,"id",void 0),u([d()],ze.prototype,"ipCntryCode",void 0),u([d({readOnly:!0})],ze.prototype,"isOrganization",null),u([d()],ze.prototype,"isPortal",void 0),u([d()],ze.prototype,"isReadOnly",void 0),u([d({readOnly:!0})],ze.prototype,"itemPageUrl",null),u([d()],ze.prototype,"layerTemplatesGroupQuery",void 0),u([d()],ze.prototype,"maxTokenExpirationMinutes",void 0),u([d({type:Date})],ze.prototype,"modified",void 0),u([d()],ze.prototype,"name",void 0),u([d()],ze.prototype,"portalHostname",void 0),u([d()],ze.prototype,"portalMode",void 0),u([d()],ze.prototype,"portalProperties",void 0),u([d()],ze.prototype,"region",void 0),u([d({readOnly:!0})],ze.prototype,"restUrl",null),u([d()],ze.prototype,"rotatorPanels",void 0),u([d()],ze.prototype,"showHomePageDescription",void 0),u([d()],ze.prototype,"sourceJSON",void 0),u([d()],ze.prototype,"staticImagesUrl",void 0),u([d({json:{name:"2DStylesGroupQuery"}})],ze.prototype,"stylesGroupQuery2d",void 0),u([d({json:{name:"stylesGroupQuery"}})],ze.prototype,"stylesGroupQuery3d",void 0),u([d()],ze.prototype,"supportsHostedServices",void 0),u([d()],ze.prototype,"symbolSetsGroupQuery",void 0),u([d()],ze.prototype,"templatesGroupQuery",void 0),u([d()],ze.prototype,"thumbnail",void 0),u([d({readOnly:!0})],ze.prototype,"thumbnailUrl",null),u([d()],ze.prototype,"units",void 0),u([d()],ze.prototype,"url",void 0),u([d()],ze.prototype,"urlKey",void 0),u([Fe("urlKey")],ze.prototype,"readUrlKey",null),u([d()],ze.prototype,"user",void 0),u([Fe("user")],ze.prototype,"readUser",null),u([d()],ze.prototype,"useStandardizedQuery",void 0),u([d()],ze.prototype,"useVectorBasemaps",void 0),u([d()],ze.prototype,"vectorBasemapGalleryGroupQuery",void 0),ze=Jc=u([I("esri.portal.Portal")],ze);const tl=ze,fMe=se.getLogger("esri.assets");function mMe(t,e){return Ni(Wr(t),e)}function Wr(t){if(!Yr.assetsPath)throw fMe.errorOnce("The API assets location needs to be set using config.assetsPath. More information: https://arcg.is/1OzLe50"),new q("assets:path-not-set","config.assetsPath is not set");return lw(Yr.assetsPath,t)}let _0=class extends Te{constructor(e){super(e),this.portalItem=null}normalizeCtorArgs(e){return e&&e.portalItem&&e.path?{...e,path:this._normalizePath(e.path,e.portalItem)}:e}set path(e){v(e)&&Au(e)?se.getLogger(this.declaredClass).error("portalitemresource:invalid-path","A portal item resource path must be relative"):this._set("path",e)}_castPath(e){return this._normalizePath(e,this.portalItem)}get url(){return this.portalItem&&this.path?`${this.portalItem.itemUrl}/resources/${this.path}`:null}get itemRelativeUrl(){return this.portalItem&&this.path?`./resources/${this.path}`:null}fetch(e="json",r){const i=this.url;if(C(i))throw new q("portal-item-resource:fetch","Portal item resource does not refer to a valid item or path");return this.portalItem.portal.request(i,{responseType:e,query:{token:this.portalItem.apiKey},signal:Dn(r,"signal")})}async update(e,r){return(await te(()=>import("./resourceUtils-73fdab9e.js"),[])).addOrUpdateResource(this,"update",e,r)}hasPath(){return v(this.path)}_normalizePath(e,r){return C(e)?e:(e=e.replace(/^\/+/,""),v(r)&&Au(e)&&(e=uq(e,r.itemUrl)),e==null?void 0:e.replace(/^\/+/,"").replace(/^(\.\/)?resources\//,""))}};u([d()],_0.prototype,"portalItem",void 0),u([d({type:String,value:null})],_0.prototype,"path",null),u([cr("path")],_0.prototype,"_castPath",null),u([d({type:String,readOnly:!0})],_0.prototype,"url",null),u([d({type:String,readOnly:!0})],_0.prototype,"itemRelativeUrl",null),_0=u([I("esri.portal.PortalItemResource")],_0);const gMe=_0;let hA=class extends Te{constructor(e){super(e),this.created=null,this.rating=null}};u([d()],hA.prototype,"created",void 0),u([d()],hA.prototype,"rating",void 0),hA=u([I("esri.portal.PortalRating")],hA);const I6=hA;var g1;const yMe=new Set(["Map Service","Feature Service","Feature Collection","Scene Service","Image Service","Stream Service","Vector Tile Service","GeoJson","CSV","KML","WFS","WMTS","WMS","Feed"]),_Me=new Set(["KML","GeoJson","CSV"]);let _r=g1=class extends XO(Zg){static from(t){return bS(g1,t)}constructor(t){super(t),this.access=null,this.accessInformation=null,this.apiKey=null,this.applicationProxies=null,this.avgRating=null,this.categories=null,this.created=null,this.culture=null,this.description=null,this.extent=null,this.groupCategories=null,this.id=null,this.isOrgItem=!1,this.itemControl=null,this.licenseInfo=null,this.modified=null,this.name=null,this.numComments=null,this.numRatings=null,this.numViews=null,this.owner=null,this.ownerFolder=null,this.portal=null,this.screenshots=null,this.size=null,this.snippet=null,this.sourceJSON=null,this.sourceUrl=null,this.spatialReference=null,this.tags=null,this.title=null,this.type=null,this.typeKeywords=null,this.url=null}destroy(){this.portal=null}get displayName(){const t=this.type,e=this.typeKeywords||[];let r=t;return t==="Feature Service"||t==="Feature Collection"?r=e.includes("Table")?"Table":e.includes("Route Layer")?"Route Layer":e.includes("Markup")?"Markup":"Feature Layer":t==="Image Service"?r=e.includes("Elevation 3D Layer")?"Elevation Layer":e.includes("Tiled Imagery")?"Tiled Imagery Layer":"Imagery Layer":t==="Scene Service"?r="Scene Layer":t==="Video Service"?r="Video Layer":t==="Scene Package"?r="Scene Layer Package":t==="Stream Service"?r="Feature Layer":t==="Geoprocessing Service"&&this.portal&&this.portal.isPortal?r=e.includes("Web Tool")?"Tool":"Geoprocessing Service":t==="Geocoding Service"?r="Locator":t==="Geoenrichment Service"?r="GeoEnrichment Service":t==="Microsoft Powerpoint"?r="Microsoft PowerPoint":t==="GeoJson"?r="GeoJSON":t==="Globe Service"?r="Globe Layer":t==="Vector Tile Service"?r="Tile Layer":t==="netCDF"?r="NetCDF":t==="Map Service"?r=e.includes("Spatiotemporal")||!e.includes("Hosted Service")&&!e.includes("Tiled")||e.includes("Relational")?"Map Image Layer":"Tile Layer":t&&t.toLowerCase().includes("add in")?r=t.replace(/(add in)/gi,"Add-In"):t==="datastore catalog service"?r="Big Data File Share":t==="Compact Tile Package"?r="Tile Package (tpkx)":t==="OGCFeatureServer"?r="OGC Feature Layer":t==="web mapping application"&&e.includes("configurableApp")?r="Instant App":t==="Insights Page"&&(r="Insights Report"),r}readExtent(t){return t&&t.length?new Zr(t[0][0],t[0][1],t[1][0],t[1][1]):null}get iconUrl(){const t=this.type&&this.type.toLowerCase()||"",e=this.typeKeywords||[],r="esri/images/portal/",i="16";let s,n=!1,o=!1,a=!1,l=!1,c=!1,h=!1;return t.indexOf("service")>0||t==="feature collection"||t==="kml"||t==="wms"||t==="wmts"||t==="wfs"?(n=e.includes("Hosted Service"),t==="feature service"||t==="feature collection"||t==="kml"||t==="wfs"?(o=e.includes("Table"),a=e.includes("Route Layer"),l=e.includes("Markup"),c=e.includes("Spatiotemporal"),h=e.includes("UtilityNetwork"),s=c&&o?"spatiotemporaltable":o?"table":a?"routelayer":l?"markup":c?"spatiotemporal":n?"featureshosted":h?"utilitynetwork":"features"):s=t==="map service"||t==="wms"||t==="wmts"?n||e.includes("Tiled")||t==="wmts"?"maptiles":"mapimages":t==="scene service"?e.includes("Line")?"sceneweblayerline":e.includes("3DObject")?"sceneweblayermultipatch":e.includes("Point")?"sceneweblayerpoint":e.includes("IntegratedMesh")?"sceneweblayermesh":e.includes("PointCloud")?"sceneweblayerpointcloud":e.includes("Polygon")?"sceneweblayerpolygon":e.includes("Building")?"sceneweblayerbuilding":e.includes("Voxel")?"sceneweblayervoxel":"sceneweblayer":t==="image service"?e.includes("Elevation 3D Layer")?"elevationlayer":e.includes("Tiled Imagery")?"tiledimagerylayer":"imagery":t==="stream service"?"streamlayer":t==="video service"?"mediaservice":t==="vector tile service"?"vectortile":t==="datastore catalog service"?"datastorecollection":t==="geocoding service"?"geocodeservice":t==="geoprocessing service"?e.includes("Web Tool")&&this.portal&&this.portal.isPortal?"tool":"layers":t==="geodata service"?"geodataservice":"layers"):s=t==="web map"||t==="cityengine web scene"?"maps":t==="web scene"?e.includes("ViewingMode-Local")?"webscenelocal":"websceneglobal":t==="web mapping application"&&e.includes("configurableApp")?"instantapps":t==="web mapping application"||t==="mobile application"||t==="application"||t==="operation view"||t==="desktop application"?"apps":t==="map document"||t==="map package"||t==="published map"||t==="scene document"||t==="globe document"||t==="basemap package"||t==="mobile basemap package"||t==="mobile map package"||t==="project package"||t==="project template"||t==="pro map"||t==="layout"||t==="layer"&&e.includes("ArcGIS Pro")||t==="explorer map"&&e.indexOf("Explorer Document")?"mapsgray":t==="service definition"||t==="csv"||t==="shapefile"||t==="cad drawing"||t==="geojson"||t==="360 vr experience"||t==="netcdf"||t==="administrative report"?"datafiles":t==="explorer add in"||t==="desktop add in"||t==="windows viewer add in"||t==="windows viewer configuration"?"appsgray":t==="arcgis pro add in"||t==="arcgis pro configuration"?"addindesktop":t==="rule package"||t==="file geodatabase"||t==="sqlite geodatabase"||t==="csv collection"||t==="kml collection"||t==="windows mobile package"||t==="map template"||t==="desktop application template"||t==="gml"||t==="arcpad package"||t==="code sample"||t==="form"||t==="document link"||t==="earth configuration"||t==="operations dashboard add in"||t==="rules package"||t==="image"||t==="workflow manager package"||t==="explorer map"&&e.includes("Explorer Mapping Application")||e.includes("Document")?"datafilesgray":t==="network analysis service"||t==="geoprocessing service"||t==="geodata service"||t==="geometry service"||t==="geoprocessing package"||t==="locator package"||t==="geoprocessing sample"||t==="workflow manager service"?"toolsgray":t==="layer"||t==="layer package"||t==="explorer layer"?"layersgray":t==="scene package"?"scenepackage":t==="mobile scene package"?"mobilescenepackage":t==="tile package"||t==="compact tile package"?"tilepackage":t==="task file"?"taskfile":t==="report template"?"report-template":t==="statistical data collection"?"statisticaldatacollection":t==="insights workbook"?"workbook":t==="insights model"?"insightsmodel":t==="insights page"?"insightspage":t==="insights theme"?"insightstheme":t==="hub initiative"?"hubinitiative":t==="hubpage"?"hubpage":t==="hub event"?"hubevent":t==="hub site application"?"hubsite":t==="hub project"?"hubproject":t==="relational database connection"?"relationaldatabaseconnection":t==="big data file share"?"datastorecollection":t==="image collection"?"imagecollection":t==="style"?"style":t==="desktop style"?"desktopstyle":t==="dashboard"?"dashboard":t==="raster function template"?"rasterprocessingtemplate":t==="vector tile package"?"vectortilepackage":t==="ortho mapping project"?"orthomappingproject":t==="ortho mapping template"?"orthomappingtemplate":t==="solution"?"solutions":t==="geopackage"?"geopackage":t==="deep learning package"?"deeplearningpackage":t==="real time analytic"?"realtimeanalytics":t==="big data analytic"?"bigdataanalytics":t==="feed"?"feed":t==="excalibur imagery project"?"excaliburimageryproject":t==="notebook"?"notebook":t==="storymap"?"storymap":t==="survey123 add in"?"survey123addin":t==="mission"?"mission":t==="mission report"?"missionreport":t==="quickcapture project"?"quickcaptureproject":t==="pro report"?"proreport":t==="pro report template"?"proreporttemplate":t==="urban model"?"urbanmodel":t==="web experience"?"experiencebuilder":t==="web experience template"?"webexperiencetemplate":t==="experience builder widget"?"experiencebuilderwidget":t==="experience builder widget package"?"experiencebuilderwidgetpackage":t==="workflow"?"workflow":t==="insights script"?"insightsscript":t==="kernel gateway connection"?"kernelgatewayconnection":t==="hub initiative template"?"hubinitiativetemplate":t==="storymap theme"?"storymaptheme":t==="knowledge graph"?"knowledgegraph":t==="native application"?"nativeapp":t==="native application installer"?"nativeappinstaller":t==="link chart"?"linkchart":t==="investigation"?"investigation":t==="ogcfeatureserver"?"features":t==="pro project"?"proproject":t==="insights workbook package"?"insightsworkbookpackage":t==="apache parquet"?"apacheparquet":t==="notebook code snippets"||t==="notebook code snippet library"?"notebookcodesnippets":t==="suitability model"?"suitabilitymodel":t==="esri classifier definition"?"classifierdefinition":t==="esri classification schema"?"classificationschema":t==="insights data engineering workbook"?"dataengineeringworkbook":t==="insights data engineering model"?"dataengineeringmodel":t==="deep learning studio project"?"deeplearningproject":t==="discussion"?"discussion":t==="allsource project"?"allsourceproject":t==="api key"?"apikey":"maps",s?Wr(r+s+i+".png"):null}get isLayer(){return this.type!=null&&yMe.has(this.type)}get itemPageUrl(){var e;const t=(e=this.portal)==null?void 0:e.itemPageUrl;return t&&this.id?`${t}?id=${this.id}`:null}get itemUrl(){var e;const t=(e=this.portal)==null?void 0:e.restUrl;return t&&this.id?`${t}/content/items/${this.id}`:null}get thumbnailUrl(){var r;const t=this.itemUrl,e=this.thumbnail;return t&&e?((r=this.portal)==null?void 0:r.normalizeUrl(`${t}/info/${e}?f=json`))??null:null}get userItemUrl(){const t=this.get("portal.restUrl");if(!t)return null;const e=this.owner||this.get("portal.user.username");return e?`${t}/content/users/${this.ownerFolder?`${e}/${this.ownerFolder}`:e}/items/${this.id}`:null}load(t){const e=this.portal??(this.portal=tl.getDefault()),r=e.load(t).then(()=>this.sourceJSON?this.sourceJSON:this.id&&this.itemUrl?e.request(this.itemUrl,{signal:v(t)?t.signal:null,query:{token:this.apiKey}}):{}).then(i=>{this.sourceJSON=i,this.read(i)});return this.addResolvingPromise(r),Promise.resolve(this)}async addRating(t){const e={method:"post",query:{}};return t instanceof I6&&(t=t.rating),t==null||isNaN(t)||typeof t!="number"||(e.query.rating=t),this.portal?(await this.portal.request(this.itemUrl+"/addRating",e),new I6({rating:t,created:new Date})):null}clone(){const t={access:this.access,accessInformation:this.accessInformation,applicationProxies:ne(this.applicationProxies),avgRating:this.avgRating,categories:ne(this.categories),created:ne(this.created),culture:this.culture,description:this.description,extent:ne(this.extent),groupCategories:ne(this.groupCategories),id:this.id,itemControl:this.itemControl,licenseInfo:this.licenseInfo,modified:ne(this.modified),name:this.name,numComments:this.numComments,numRatings:this.numRatings,numViews:this.numViews,owner:this.owner,ownerFolder:this.ownerFolder,portal:this.portal,screenshots:ne(this.screenshots),size:this.size,snippet:this.snippet,sourceUrl:this.sourceUrl,spatialReference:this.spatialReference,tags:ne(this.tags),thumbnail:this.thumbnail,title:this.title,type:this.type,typeKeywords:ne(this.typeKeywords),url:this.url};this.loaded&&(t.loadStatus="loaded");const e=new g1({sourceJSON:this.sourceJSON}).set(t);return e._set("isOrgItem",this.isOrgItem),e}createPostQuery(){const t=this.toJSON();for(const r of["tags","typeKeywords","categories"])t[r]&&(t[r]=t[r].join(", "));const{extent:e}=t;return e&&(t.extent=JSON.stringify(e)),t}async deleteRating(){await Dl(this.portal).request(this.itemUrl+"/deleteRating",{method:"post"})}fetchData(t="json",e){return Dl(this.portal).request(this.itemUrl+"/data",{responseType:t,...e,query:{token:this.apiKey}})}async fetchRating(t){const e=await Dl(this.portal).request(this.itemUrl+"/rating",{query:{token:this.apiKey},...t});return e.rating!=null?(e.created=new Date(e.created),new I6(e)):null}fetchRelatedItems(t,e){return Dl(this.portal).requestToTypedArray(this.itemUrl+"/relatedItems",{query:{...t,token:this.apiKey},...e},g1)}getThumbnailUrl(t){let e=this.thumbnailUrl;return e&&t&&(e+=`&w=${t}`),e}reload(){return Dl(this.portal).request(this.itemUrl??"",{cacheBust:!0,query:{token:this.apiKey}}).then(t=>(this.sourceJSON=t,this.read(t),this))}update(t){return this.id?this.load().then(()=>Dl(this.portal).signIn()).then(()=>{const e=t&&t.data,r={method:"post"};r.query=this.createPostQuery();for(const i in r.query)r.query[i]===null&&(r.query[i]="");return r.query.clearEmptyFields=!0,e!=null&&(typeof e=="string"?r.query.text=e:typeof e=="object"&&(r.query.text=JSON.stringify(e))),this.portal.request(`${this.userItemUrl}/update`,r).then(()=>this.reload())}):Promise.reject(new q("portal:item-does-not-exist","The item does not exist yet and cannot be updated"))}async copy(t){if(!this.id)throw new q("portal:item-does-not-exist","The item does not exist yet");await this.load();const{portal:e,itemUrl:r}=this;await Dl(e).signIn();const{copyResources:i,folder:s,tags:n,title:o}=t||{},a={method:"post",query:{copyPrivateResources:i==="all",folder:typeof s=="string"?s:s==null?void 0:s.id,includeResources:!!i,tags:n==null?void 0:n.join(","),title:o}},{itemId:l}=await e.request(`${r}/copy`,a);return new g1({id:l,portal:e})}updateThumbnail(t){return this.id?this.load().then(()=>this.portal.signIn()).then(()=>{const e=t.thumbnail,r=t.filename,i={method:"post"};if(typeof e=="string")pm(e)?i.query={data:e}:i.query={url:wu(e)},v(r)&&(i.query.filename=r);else{const s=new FormData;v(r)?s.append("file",e,r):s.append("file",e),i.body=s}return this.portal.request(`${this.userItemUrl}/updateThumbnail`,i).then(()=>this.reload())}):Promise.reject(new q("portal:item-does-not-exist","The item does not exist yet and cannot be updated"))}async fetchResources(t={},e){return(await te(()=>import("./resourceUtils-73fdab9e.js"),[])).fetchResources(this,t,e)}async addResource(t,e,r){const i=await te(()=>import("./resourceUtils-73fdab9e.js"),[]);return t.portalItem=this,i.addOrUpdateResource(t,"add",e,r)}async removeResource(t,e){const r=await te(()=>import("./resourceUtils-73fdab9e.js"),[]);if(t.portalItem&&t.portalItem.itemUrl!==this.itemUrl)throw new q("removeresource:portal-item-mismatch","The portal item associated with the provided resource does not match the item");return r.removeResource(this,t,e)}async removeAllResources(t){return(await te(()=>import("./resourceUtils-73fdab9e.js"),[])).removeAllResources(this,t)}resourceFromPath(t){return new gMe({portalItem:this,path:t})}toJSON(){const t=this.extent,e={accessInformation:this.accessInformation,categories:ne(this.categories),created:this.created&&this.created.getTime(),description:this.description,extent:t&&[[t.xmin,t.ymin],[t.xmax,t.ymax]],id:this.id,isOrgItem:this.isOrgItem,licenseInfo:this.licenseInfo,modified:this.modified&&this.modified.getTime(),name:this.name,owner:this.owner,ownerFolder:this.ownerFolder,snippet:this.snippet,sourceUrl:this.sourceUrl,spatialReference:this.spatialReference,tags:ne(this.tags),thumbnail:this.thumbnail,title:this.title,type:this.type,typeKeywords:ne(this.typeKeywords),url:this.url};return Gce(e)}static fromJSON(t){if(!t)return null;if(t.declaredClass)throw new Error("JSON object is already hydrated");return new g1({sourceJSON:t})}_getPostQuery(){const t=this.toJSON();for(const e in t)e==="tags"&&t[e]!==null&&(t[e]=t[e].join(", ")),e==="typeKeywords"&&t[e]!==null&&(t[e]=t[e].join(", ")),e==="extent"&&t[e]&&(t[e]=JSON.stringify(t[e]));return t}};u([d({type:["private","shared","org","public"]})],_r.prototype,"access",void 0),u([d()],_r.prototype,"accessInformation",void 0),u([d({type:String})],_r.prototype,"apiKey",void 0),u([d({json:{read:{source:"appProxies"}}})],_r.prototype,"applicationProxies",void 0),u([d()],_r.prototype,"avgRating",void 0),u([d()],_r.prototype,"categories",void 0),u([d({type:Date})],_r.prototype,"created",void 0),u([d()],_r.prototype,"culture",void 0),u([d()],_r.prototype,"description",void 0),u([d({readOnly:!0})],_r.prototype,"displayName",null),u([d({type:Zr})],_r.prototype,"extent",void 0),u([Fe("extent")],_r.prototype,"readExtent",null),u([d()],_r.prototype,"groupCategories",void 0),u([d({readOnly:!0})],_r.prototype,"iconUrl",null),u([d()],_r.prototype,"id",void 0),u([d({readOnly:!0})],_r.prototype,"isLayer",null),u([d({type:Boolean,readOnly:!0})],_r.prototype,"isOrgItem",void 0),u([d()],_r.prototype,"itemControl",void 0),u([d({readOnly:!0})],_r.prototype,"itemPageUrl",null),u([d({readOnly:!0})],_r.prototype,"itemUrl",null),u([d()],_r.prototype,"licenseInfo",void 0),u([d({type:Date})],_r.prototype,"modified",void 0),u([d()],_r.prototype,"name",void 0),u([d()],_r.prototype,"numComments",void 0),u([d()],_r.prototype,"numRatings",void 0),u([d()],_r.prototype,"numViews",void 0),u([d()],_r.prototype,"owner",void 0),u([d()],_r.prototype,"ownerFolder",void 0),u([d({type:tl})],_r.prototype,"portal",void 0),u([d()],_r.prototype,"screenshots",void 0),u([d()],_r.prototype,"size",void 0),u([d()],_r.prototype,"snippet",void 0),u([d()],_r.prototype,"sourceJSON",void 0),u([d({type:String})],_r.prototype,"sourceUrl",void 0),u([d({type:String})],_r.prototype,"spatialReference",void 0),u([d()],_r.prototype,"tags",void 0),u([d()],_r.prototype,"thumbnail",void 0),u([d({readOnly:!0})],_r.prototype,"thumbnailUrl",null),u([d()],_r.prototype,"title",void 0),u([d()],_r.prototype,"type",void 0),u([d()],_r.prototype,"typeKeywords",void 0),u([d({type:String,json:{read(t,e){var r;if(_Me.has(e.type)){const i=(r=this.portal)==null?void 0:r.restUrl;t||(t=i&&this.id?`${i}/content/items/${this.id}/data`:null)}return t}}})],_r.prototype,"url",void 0),u([d({readOnly:!0})],_r.prototype,"userItemUrl",null),_r=g1=u([I("esri.portal.PortalItem")],_r);const V3=_r,Nhe=Object.freeze(Object.defineProperty({__proto__:null,default:V3},Symbol.toStringTag,{value:"Module"})),vK=/^([a-z]{2})(?:[-_]([A-Za-z]{2}))?$/,vMe={ar:!0,bg:!0,bs:!0,ca:!0,cs:!0,da:!0,de:!0,el:!0,en:!0,es:!0,et:!0,fi:!0,fr:!0,he:!0,hr:!0,hu:!0,id:!0,it:!0,ja:!0,ko:!0,lt:!0,lv:!0,nb:!0,nl:!0,pl:!0,"pt-BR":!0,"pt-PT":!0,ro:!0,ru:!0,sk:!0,sl:!0,sr:!0,sv:!0,th:!0,tr:!0,uk:!0,vi:!0,"zh-CN":!0,"zh-HK":!0,"zh-TW":!0};function bK(t){return vMe[t]??!1}const dA=[],G2=new Map;function wK(t){for(const e of G2.keys())Uhe(t.pattern,e)&&G2.delete(e)}function bMe(t){return dA.includes(t)||(wK(t),dA.unshift(t)),{remove(){const e=dA.indexOf(t);e>-1&&(dA.splice(e,1),wK(t))}}}async function Fhe(t){const e=Ih();G2.has(t)||G2.set(t,xMe(t,e));const r=G2.get(t);return r&&await TMe.add(r),r}function wMe(t){if(!vK.test(t))return null;const e=vK.exec(t);if(e===null)return null;const[,r,i]=e,s=r+(i?"-"+i.toUpperCase():"");return bK(s)?s:bK(r)?r:null}async function xMe(t,e){const r=[];for(const i of dA)if(Uhe(i.pattern,t))try{return await i.fetchMessageBundle(t,e)}catch(s){r.push(s)}throw r.length?new q("intl:message-bundle-error",`Errors occurred while loading "${t}"`,{errors:r}):new q("intl:no-message-bundle-loader",`No loader found for message bundle "${t}"`)}function Uhe(t,e){return typeof t=="string"?e.startsWith(t):t.test(e)}Sq(()=>{G2.clear()});const TMe=new class{constructor(){this._numLoading=0,this._dfd=null}async waitForAll(){this._dfd&&await this._dfd.promise}add(t){return this._increase(),t.then(()=>this._decrease(),()=>this._decrease()),this.waitForAll()}_increase(){this._numLoading++,this._dfd||(this._dfd=j_())}_decrease(){this._numLoading=Math.max(this._numLoading-1,0),this._dfd&&this._numLoading===0&&(this._dfd.resolve(),this._dfd=null)}};async function SMe(t){if(!t)return;const e=t.includes("-vector")?t.slice(0,t.indexOf("-vector")):t,r=await Fhe("esri/t9n/basemaps");return r[t]||r[e]}const fV={streets:{id:"streets",classic:!0,deprecated:!0,get thumbnailUrl(){return Wr("esri/images/basemap/streets.jpg")},baseMapLayers:[{id:"streets-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Street Map",showLegend:!1,visibility:!0,opacity:1}]},satellite:{id:"satellite",classic:!0,get thumbnailUrl(){return Wr("esri/images/basemap/satellite.jpg")},baseMapLayers:[{id:"satellite-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Imagery",showLegend:!1,visibility:!0,opacity:1}]},hybrid:{id:"hybrid",classic:!0,get thumbnailUrl(){return Wr("esri/images/basemap/hybrid.jpg")},baseMapLayers:[{id:"hybrid-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Imagery",showLegend:!1,visibility:!0,opacity:1},{id:"hybrid-reference-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/30d6b8271e1849cd9c3042060001f425/resources/styles/root.json",layerType:"VectorTileLayer",title:"Hybrid Reference Layer",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},terrain:{id:"terrain",classic:!0,get thumbnailUrl(){return Wr("esri/images/basemap/terrain.jpg")},baseMapLayers:[{id:"terrain-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Terrain Base",showLegend:!1,visibility:!0,opacity:1},{id:"terrain-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Reference_Overlay/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Reference Overlay",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},topo:{id:"topo",classic:!0,deprecated:!0,get thumbnailUrl(){return Wr("esri/images/basemap/topo.jpg")},baseMapLayers:[{id:"topo-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Topo Map",showLegend:!1,visibility:!0,opacity:1}]},gray:{id:"gray",classic:!0,deprecated:!0,get thumbnailUrl(){return Wr("esri/images/basemap/gray.jpg")},baseMapLayers:[{id:"gray-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Light Gray Base",showLegend:!1,visibility:!0,opacity:1},{id:"gray-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Light Gray Reference",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},"dark-gray":{id:"dark-gray",classic:!0,deprecated:!0,get thumbnailUrl(){return Wr("esri/images/basemap/dark-gray.jpg")},baseMapLayers:[{id:"dark-gray-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Dark Gray Base",showLegend:!1,visibility:!0,opacity:1},{id:"dark-gray-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Reference/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Dark Gray Reference",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},oceans:{id:"oceans",classic:!0,get thumbnailUrl(){return Wr("esri/images/basemap/oceans.jpg")},baseMapLayers:[{id:"oceans-base-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Ocean Base",showLegend:!1,visibility:!0,opacity:1},{id:"oceans-reference-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Reference/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Ocean Reference",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},"national-geographic":{id:"national-geographic",classic:!0,deprecated:!0,get thumbnailUrl(){return Wr("esri/images/basemap/national-geographic.jpg")},baseMapLayers:[{id:"national-geographic-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer",title:"NatGeo World Map",showLegend:!1,layerType:"ArcGISTiledMapServiceLayer",visibility:!0,opacity:1}]},osm:{id:"osm",classic:!0,get thumbnailUrl(){return Wr("esri/images/basemap/osm.jpg")},baseMapLayers:[{id:"osm-base-layer",layerType:"OpenStreetMap",title:"Open Street Map",showLegend:!1,visibility:!0,opacity:1}]},"dark-gray-vector":{id:"dark-gray-vector",classic:!0,get thumbnailUrl(){return Wr("esri/images/basemap/dark-gray-vector.jpg")},baseMapLayers:[{id:"dark-gray-base-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/5e9b3685f4c24d8781073dd928ebda50/resources/styles/root.json",layerType:"VectorTileLayer",title:"Dark Gray Base",visibility:!0,opacity:1},{id:"dark-gray-reference-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/747cb7a5329c478cbe6981076cc879c5/resources/styles/root.json",layerType:"VectorTileLayer",title:"Dark Gray Reference",isReference:!0,visibility:!0,opacity:1}]},"gray-vector":{id:"gray-vector",classic:!0,get thumbnailUrl(){return Wr("esri/images/basemap/gray-vector.jpg")},baseMapLayers:[{id:"gray-base-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/291da5eab3a0412593b66d384379f89f/resources/styles/root.json",layerType:"VectorTileLayer",title:"Light Gray Base",visibility:!0,opacity:1},{id:"gray-reference-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/1768e8369a214dfab4e2167d5c5f2454/resources/styles/root.json",layerType:"VectorTileLayer",title:"Light Gray Reference",isReference:!0,visibility:!0,opacity:1}]},"streets-vector":{id:"streets-vector",classic:!0,get thumbnailUrl(){return Wr("esri/images/basemap/streets-vector.jpg")},baseMapLayers:[{id:"streets-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/de26a3cf4cc9451298ea173c4b324736/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Streets",visibility:!0,opacity:1}]},"topo-vector":{id:"topo-vector",classic:!0,get thumbnailUrl(){return Wr("esri/images/basemap/topo-vector.jpg")},baseMapLayers:[{id:"world-hillshade-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Hillshade",showLegend:!1,visibility:!0,opacity:1},{id:"topo-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/7dc6cea0b1764a1f9af2e679f642f0f5/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Topo",visibility:!0,opacity:1}]},"streets-night-vector":{id:"streets-night-vector",classic:!0,get thumbnailUrl(){return Wr("esri/images/basemap/streets-night.jpg")},baseMapLayers:[{id:"streets-night-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/86f556a2d1fd468181855a35e344567f/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Streets Night",visibility:!0,opacity:1}]},"streets-relief-vector":{id:"streets-relief-vector",classic:!0,get thumbnailUrl(){return Wr("esri/images/basemap/streets-relief.jpg")},baseMapLayers:[{id:"world-hillshade-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Hillshade",showLegend:!1,visibility:!0,opacity:1},{id:"streets-relief-vector-base-layer",styleUrl:"//www.arcgis.com/sharing/rest/content/items/b266e6d17fc345b498345613930fbd76/resources/styles/root.json",title:"World Streets Relief",layerType:"VectorTileLayer",visibility:!0,opacity:1}]},"streets-navigation-vector":{id:"streets-navigation-vector",classic:!0,get thumbnailUrl(){return Wr("esri/images/basemap/streets-navigation.jpg")},baseMapLayers:[{id:"streets-navigation-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/63c47b7177f946b49902c24129b87252/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Streets Navigation",visibility:!0,opacity:1}]},"arcgis-imagery":{get thumbnailUrl(){return Wr("esri/images/basemap/hybrid.jpg")},title:"Imagery Hybrid",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Imagery",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/World_Imagery/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Imagery:Labels",title:"Hybrid Reference Layer",isReference:!0}]},"arcgis-imagery-standard":{get thumbnailUrl(){return Wr("esri/images/basemap/satellite.jpg")},title:"Imagery",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Imagery",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/World_Imagery/MapServer"}]},"arcgis-imagery-labels":{title:"Hybrid [Reference]",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Imagery:Labels",title:"Hybrid Reference Layer",isReference:!0}]},"arcgis-light-gray":{get thumbnailUrl(){return Wr("esri/images/basemap/gray-vector.jpg")},title:"Light Gray Canvas",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:LightGray:Base",title:"Light Gray Canvas Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:LightGray:Labels",title:"Light Gray Canvas Labels",isReference:!0}]},"arcgis-dark-gray":{get thumbnailUrl(){return Wr("esri/images/basemap/dark-gray.jpg")},title:"Dark Gray Canvas",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:DarkGray:Base",title:"Dark Gray Canvas Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:DarkGray:Labels",title:"Dark Gray Canvas Labels",isReference:!0}]},"arcgis-navigation":{get thumbnailUrl(){return Wr("esri/images/basemap/streets-navigation.jpg")},title:"Navigation",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Navigation",title:"World Navigation Map"}]},"arcgis-navigation-night":{title:"Navigation (Dark Mode)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:NavigationNight",title:"World Navigation Map (Dark Mode)"}]},"arcgis-streets":{get thumbnailUrl(){return Wr("esri/images/basemap/streets-vector.jpg")},title:"Streets",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Streets",title:"World Street Map"}]},"arcgis-streets-night":{get thumbnailUrl(){return Wr("esri/images/basemap/streets-night.jpg")},title:"Streets (Night)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:StreetsNight",title:"World Street Map (Night)"}]},"arcgis-streets-relief":{get thumbnailUrl(){return Wr("esri/images/basemap/streets-relief.jpg")},title:"Streets (with Relief)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:StreetsRelief:Base",title:"World Street Map (with Relief)"}]},"arcgis-topographic":{get thumbnailUrl(){return Wr("esri/images/basemap/topo.jpg")},title:"Topographic",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Topographic:Base",title:"World Topographic Map"}]},"arcgis-oceans":{get thumbnailUrl(){return Wr("esri/images/basemap/oceans.jpg")},title:"Oceans",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Ocean Base",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Oceans:Labels",title:"World Ocean Reference",isReference:!0}]},"osm-standard":{title:"OpenStreetMap",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:Standard",title:"OpenStreetMap"}]},"osm-standard-relief":{title:"OpenStreetMap (with relief)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:StandardRelief:Base",layerType:"VectorTileLayer",title:"OpenStreetMap Relief Base"}]},"osm-streets":{title:"OpenStreetMap (Streets)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:Streets",title:"OpenStreetMap (Streets)"}]},"osm-streets-relief":{title:"OpenStreetMap (Streets with relief)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:StreetsRelief:Base",layerType:"VectorTileLayer",title:"OpenStreetMap Relief Base"}]},"osm-light-gray":{title:"OpenStreetMap (Light Gray Canvas)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:LightGray:Base",title:"OSM (Light Gray Base)"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:LightGray:Labels",title:"OSM (Light Gray Reference)",isReference:!0}]},"osm-dark-gray":{title:"OpenStreetMap (Dark Gray Canvas)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:DarkGray:Base",title:"OSM (Dark Gray Base)"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:DarkGray:Labels",title:"OSM (Dark Gray Reference)",isReference:!0}]},"arcgis-terrain":{title:"Terrain with Labels",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Terrain:Base",title:"World Terrain Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Terrain:Detail",title:"World Terrain Reference",isReference:!0}]},"arcgis-community":{title:"Community",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Community",title:"Community"}]},"arcgis-charted-territory":{title:"Charted Territory",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:ChartedTerritory:Base",title:"Charted Territory"}]},"arcgis-colored-pencil":{title:"Colored Pencil",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:ColoredPencil",title:"Colored Pencil"}]},"arcgis-nova":{title:"Nova",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Nova",title:"Nova"}]},"arcgis-modern-antique":{title:"Modern Antique",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:ModernAntique:Base",title:"Modern Antique"}]},"arcgis-midcentury":{title:"Mid-Century",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Midcentury",title:"Mid-Century"}]},"arcgis-newspaper":{title:"Newspaper",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Newspaper",title:"Newspaper"}]},"arcgis-hillshade-light":{title:"Hillshade",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"}]},"arcgis-hillshade-dark":{title:"Hillshade (Dark)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade (Dark)",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade_Dark/MapServer"}]},"arcgis-human-geography":{title:"Human Geography",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:HumanGeography:Base",title:"Human Geography Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:HumanGeography:Detail",title:"Human Geography Detail",isReference:!0},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:HumanGeography:Label",title:"Human Geography Label",isReference:!0}]},"arcgis-human-geography-dark":{title:"Human Geography (Dark)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:HumanGeographyDark:Base",title:"Human Geography Dark Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:HumanGeographyDark:Detail",title:"Human Geography Dark Detail",isReference:!0},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:HumanGeographyDark:Label",title:"Human Geography Dark Label",isReference:!0}]}};function B3(t){const e=t==null?void 0:t.type;return e==="base-tile"||e==="tile"||e==="elevation"||e==="imagery-tile"||e==="base-elevation"||e==="open-street-map"||e==="wcs"||e==="web-tile"||e==="wmts"||e==="vector-tile"}function SS(t){return t!=null&&"type"in t&&t.type==="group"}const Owt={Point:"SceneLayer","3DObject":"SceneLayer",IntegratedMesh:"IntegratedMeshLayer",PointCloud:"PointCloudLayer",Building:"BuildingSceneLayer"};function khe(t){const e=t==null?void 0:t.type;return e==="building-scene"||e==="integrated-mesh"||e==="point-cloud"||e==="scene"}function xK(t){return(t==null?void 0:t.type)==="voxel"}function TK(t){return(t==null?void 0:t.type)==="imagery-tile"}function Vhe(t){return t!=null&&t.parent!=null&&"declaredClass"in t.parent&&t.parent.declaredClass==="esri.Basemap"&&t.parent.baseLayers.includes(t)}function Cq(t){var e;return(t==null?void 0:t.type)==="feature"&&!t.url&&((e=t.source)==null?void 0:e.type)==="memory"}function Mwt(t){var e;return(t==null?void 0:t.type)==="feature"&&((e=t.source)==null?void 0:e.type)==="feature-layer"}function EMe(t){if(t.activeLayer){const e=t.activeLayer.tileMatrixSet;if(e)return e;const r=t.activeLayer.tileMatrixSets;if(r)return r}return null}async function Bhe(t,e){const r=wi==null?void 0:wi.findServerInfo(t);if((r==null?void 0:r.currentVersion)!=null)return r.owningSystemUrl||null;const i=t.toLowerCase().indexOf("/rest/services");if(i===-1)return null;const s=`${t.substring(0,i)}/rest/info`,n=v(e)?e.signal:null,{data:o}=await Ni(s,{query:{f:"json"},responseType:"json",signal:n});return(o==null?void 0:o.owningSystemUrl)||null}function CMe(t){if(!("capabilities"in t))return!1;switch(t.type){case"csv":case"feature":case"geojson":case"imagery":case"knowledge-graph-sublayer":case"ogc-feature":case"oriented-imagery":case"scene":case"subtype-group":case"subtype-sublayer":case"wfs":return!0;default:return!1}}function zhe(t){return CMe(t)?"effectiveCapabilities"in t?t.effectiveCapabilities:t.capabilities:null}function AMe(t){if(!("editingEnabled"in t))return!1;switch(t.type){case"csv":case"feature":case"geojson":case"oriented-imagery":case"scene":case"subtype-group":case"subtype-sublayer":return!0;default:return!1}}function RMe(t){return!!AMe(t)&&("effectiveEditingEnabled"in t?t.effectiveEditingEnabled:t.editingEnabled)}const OMe=new Set(["bing-maps","imagery","imagery-tile","map-image","open-street-map","tile","unknown","unsupported","vector-tile","web-tile","wms","wmts"]),MMe=new Set(["csv","feature","geo-rss","geojson","group","imagery","imagery-tile","kml","map-image","map-notes","media","ogc-feature","route","subtype-group","tile","unknown","unsupported","vector-tile","web-tile","wfs","wms","wmts"]);function PMe(t){return t.layerContainerType==="basemap"?OMe:t.layerContainerType==="operational-layers"?MMe:null}function IMe(t,e){if(e.restrictedWebMapWriting){const r=PMe(e);return!v(r)||r.has(t.type)&&!Cq(t)}return!0}function $Me(t,e){if(e)if(Cq(t)){const r=HO("featureCollection.layers",e),i=r&&r[0]&&r[0].layerDefinition;i&&$6(t,i)}else t.type==="stream"?$6(t,e.layerDefinition=e.layerDefinition||{}):t.type!=="group"&&$6(t,e)}function $6(t,e){"maxScale"in t&&(e.maxScale=YD(t.maxScale)??void 0),"minScale"in t&&(e.minScale=YD(t.minScale)??void 0)}function LMe(t,e){if($Me(t,e),e&&("blendMode"in t&&(e.blendMode=t.blendMode,e.blendMode==="normal"&&delete e.blendMode),e.opacity=YD(t.opacity)??void 0,e.title=t.title||"Layer",e.visibility=t.visible,"legendEnabled"in t&&t.type!=="wmts"))if(Cq(t)){const r=e.featureCollection;r&&(r.showLegend=t.legendEnabled)}else e.showLegend=t.legendEnabled}function SK(t,e,r){if(!("write"in t)||!t.write)return r&&r.messages&&r.messages.push(new q("layer:unsupported",`Layers (${t.title}, ${t.id}) of type '${t.declaredClass}' cannot be persisted`,{layer:t})),null;if(IMe(t,r)){const i={};return t.write(i,r)?i:null}return v(e)&&LMe(t,e=ne(e)),e}var X$;let DMe=0;const Ghe="esri.Basemap";let rh=X$=class extends XO(Zg){constructor(t){super(t),this.id=null,this.portalItem=null,this.spatialReference=null,this.thumbnailUrl=null,this.title="Basemap",this.id=Date.now().toString(16)+"-basemap-"+DMe++,this.baseLayers=new Pt,this.referenceLayers=new Pt;const e=i=>{i.parent&&i.parent!==this&&"remove"in i.parent&&i.parent.remove(i),i.parent=this,i.type==="elevation"&&se.getLogger(this.declaredClass).error(`Layer '${i.title}, id:${i.id}' of type '${i.type}' is not supported as a basemap layer and will therefore be ignored.`)},r=i=>{i.parent=null};this.baseLayers.on("after-add",i=>e(i.item)),this.referenceLayers.on("after-add",i=>e(i.item)),this.baseLayers.on("after-remove",i=>r(i.item)),this.referenceLayers.on("after-remove",i=>r(i.item))}initialize(){this.when().catch(t=>{se.getLogger(this.declaredClass).error("#load()",`Failed to load basemap (title: '${this.title}', id: '${this.id}')`,t)}),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){var r;const t=this.baseLayers.removeAll();for(const i of t)i.destroy();const e=this.referenceLayers.removeAll();for(const i of e)i.destroy();this.baseLayers.destroy(),this.referenceLayers.destroy(),(r=this.portalItem)==null||r.destroy(),this.portalItem=null}normalizeCtorArgs(t){return t&&"resourceInfo"in t&&(this._set("resourceInfo",t.resourceInfo),delete(t={...t}).resourceInfo),t}set baseLayers(t){this._set("baseLayers",aw(t,this._get("baseLayers")))}_writeBaseLayers(t,e,r){const i=[];t&&(r={...r,layerContainerType:"basemap"},this.baseLayers.forEach(s=>{const n=SK(s,r.webmap?r.webmap.getLayerJSONFromResourceInfo(s):null,r);v(n)&&i.push(n)}),this.referenceLayers.forEach(s=>{const n=SK(s,r.webmap?r.webmap.getLayerJSONFromResourceInfo(s):null,r);v(n)&&(s.type!=="scene"&&(n.isReference=!0),i.push(n))})),e.baseMapLayers=i}set referenceLayers(t){this._set("referenceLayers",aw(t,this._get("referenceLayers")))}writeTitle(t,e){e.title=t||"Basemap"}load(t){return this.addResolvingPromise(this._loadFromSource(t)),Promise.resolve(this)}loadAll(){return Zue(this,t=>{t(this.baseLayers,this.referenceLayers)})}clone(){const t={id:this.id,title:this.title,portalItem:this.portalItem,baseLayers:this.baseLayers.slice(),referenceLayers:this.referenceLayers.slice()};return this.loaded&&(t.loadStatus="loaded"),new X$({resourceInfo:this.resourceInfo}).set(t)}read(t,e){this.resourceInfo||this._set("resourceInfo",{data:t,context:e}),super.read(t,e)}write(t,e){return t=t||{},e&&e.origin||(e={origin:"web-map",...e}),super.write(t,e),!this.loaded&&this.resourceInfo&&this.resourceInfo.data.baseMapLayers&&(t.baseMapLayers=this.resourceInfo.data.baseMapLayers.map(r=>{const i=ne(r);return i.url&&im(i.url)&&(i.url=`https:${i.url}`),i.templateUrl&&im(i.templateUrl)&&(i.templateUrl=`https:${i.templateUrl}`),i})),t}async _loadFromSource(t){const{resourceInfo:e,portalItem:r}=this;fr(t);const i=[];if(e){const s=e.context?e.context.url:null;if(i.push(this._loadLayersFromJSON(e.data,s,t)),e.data.id&&!e.data.title){const n=e.data.id;i.push(SMe(n).then(o=>{o&&this.read({title:o},e.context)}))}}else r&&i.push(this._loadFromItem(r,t));await Promise.all(i)}async _loadLayersFromJSON(t,e,r){const i=this.resourceInfo&&this.resourceInfo.context,s=this.portalItem&&this.portalItem.portal||i&&i.portal||null,n=i&&i.origin==="web-scene"?"web-scene":"web-map",{populateOperationalLayers:o}=await te(()=>import("./layersCreator-5f5275f2.js"),["assets/layersCreator-5f5275f2.js","assets/lazyLayerLoader-b79dca54.js","assets/portalLayers-a50d3025.js","assets/layersLoader-c65033be.js","assets/fetchService-d31d8618.js","assets/jsonContext-999facfa.js"]),a=[];if(fr(r),t.baseMapLayers&&Array.isArray(t.baseMapLayers)){const l={context:{origin:n,url:e,portal:s,layerContainerType:"basemap"},defaultLayerType:"DefaultTileLayer"},c=f=>n==="web-scene"&&f.layerType==="ArcGISSceneServiceLayer"||f.isReference,h=o(this.baseLayers,t.baseMapLayers.filter(f=>!c(f)),l);a.push(h);const p=o(this.referenceLayers,t.baseMapLayers.filter(c),l);a.push(p)}await jl(a)}async _loadFromItem(t,e){const r=await t.load(e),i=await r.fetchData("json",e),s=sl(t.itemUrl??"");return this._set("resourceInfo",{data:i.baseMap??{},context:{origin:t.type==="Web Scene"?"web-scene":"web-map",portal:t.portal||tl.getDefault(),url:s}}),this.read(this.resourceInfo.data,this.resourceInfo.context),this.read({spatialReference:i.spatialReference},this.resourceInfo.context),this.read({title:t.title,thumbnailUrl:t.thumbnailUrl},{origin:"portal-item",portal:t.portal||tl.getDefault(),url:s}),this._loadLayersFromJSON(this.resourceInfo.data,s,e)}static fromId(t){const e=fV[t];if(e){if(e.deprecated){let r=null;t==="dark-gray"?r="dark-gray-vector":t==="gray"?r="gray-vector":t==="streets"?r="streets-vector":t==="topo"&&(r="topo-vector"),uue(se.getLogger(Ghe),`The ${t} basemap has entered mature support and is no longer being updated.`,{replacement:r,see:"https://arcg.is/1iq8aD",warnOnce:!0})}return X$.fromJSON(e)}return null}};u([d({json:{write:{ignoreOrigin:!0,target:"baseMapLayers",writer(t,e,r,i){this._writeBaseLayers(t,e,i)}},origins:{"web-scene":{write:{ignoreOrigin:!0,target:{baseMapLayers:{type:Pt}},writer(t,e,r,i){this._writeBaseLayers(t,e,i)}}}}}})],rh.prototype,"baseLayers",null),u([d({type:String,json:{origins:{"web-scene":{write:!0}}}})],rh.prototype,"id",void 0),u([d({type:V3})],rh.prototype,"portalItem",void 0),u([d()],rh.prototype,"referenceLayers",null),u([d({readOnly:!0})],rh.prototype,"resourceInfo",void 0),u([d({type:et})],rh.prototype,"spatialReference",void 0),u([d()],rh.prototype,"thumbnailUrl",void 0),u([d({type:String,json:{origins:{"web-scene":{write:{isRequired:!0}}}}})],rh.prototype,"title",void 0),u([He("title")],rh.prototype,"writeTitle",null),rh=X$=u([I(Ghe)],rh);const iN=rh,NMe=Object.freeze(Object.defineProperty({__proto__:null,default:iN},Symbol.toStringTag,{value:"Module"})),sN={transparent:[0,0,0,0],black:[0,0,0,1],silver:[192,192,192,1],gray:[128,128,128,1],white:[255,255,255,1],maroon:[128,0,0,1],red:[255,0,0,1],purple:[128,0,128,1],fuchsia:[255,0,255,1],green:[0,128,0,1],lime:[0,255,0,1],olive:[128,128,0,1],yellow:[255,255,0,1],navy:[0,0,128,1],blue:[0,0,255,1],teal:[0,128,128,1],aqua:[0,255,255,1],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],blanchedalmond:[255,235,205,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],oldlace:[253,245,230,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],rebeccapurple:[102,51,153,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],whitesmoke:[245,245,245,1],yellowgreen:[154,205,50,1]};function jhe(t){return sN[t]||sN[t.toLowerCase()]}function Aq(t){return sN[t]??sN[t.toLowerCase()]}function FMe(t){return[...Aq(t)]}function L6(t,e,r){r<0&&++r,r>1&&--r;const i=6*r;return i<1?t+(e-t)*i:2*r<1?e:3*r<2?t+(e-t)*(2/3-r)*6:t}function Hhe(t,e,r,i=1){const s=(t%360+360)%360/360,n=r<=.5?r*(e+1):r+e-r*e,o=2*r-n;return[Math.round(255*L6(o,n,s+1/3)),Math.round(255*L6(o,n,s)),Math.round(255*L6(o,n,s-1/3)),i]}function UMe(t){const e=t.length>5,r=e?8:4,i=(1<<r)-1,s=e?1:17,n=e?t.length===9:t.length===5;let o=+("0x"+t.substr(1));if(isNaN(o))return null;const a=[0,0,0,1];let l;return n&&(l=o&i,o>>=r,a[3]=s*l/255),l=o&i,o>>=r,a[2]=s*l,l=o&i,o>>=r,a[1]=s*l,l=o&i,o>>=r,a[0]=s*l,a}function M(){return[0,0,0]}function ms(t){return[t[0],t[1],t[2]]}function $e(t,e,r){return[t,e,r]}function Nl(t){const e=M(),r=Math.min(3,t.length);for(let i=0;i<r;++i)e[i]=t[i];return e}function Rq(t,e){return new Float64Array(t,e,3)}function qhe(){return M()}function Whe(){return $e(1,1,1)}function Xhe(){return $e(1,0,0)}function Yhe(){return $e(0,1,0)}function Oq(){return $e(0,0,1)}const ma=qhe(),Nf=Whe(),kMe=Xhe(),VMe=Yhe(),Zhe=Oq();Object.freeze(Object.defineProperty({__proto__:null,ONES:Nf,UNIT_X:kMe,UNIT_Y:VMe,UNIT_Z:Zhe,ZEROS:ma,clone:ms,create:M,createView:Rq,fromArray:Nl,fromValues:$e,ones:Whe,unitX:Xhe,unitY:Yhe,unitZ:Oq,zeros:qhe},Symbol.toStringTag,{value:"Module"}));let Mq=1e-6;function Sa(){return Mq}function BMe(t){Mq=t}const JO=Math.random,zMe=Math.PI/180,GMe=180/Math.PI;function h4(t){return t*zMe}function jMe(t){return t*GMe}function HMe(t,e){return Math.abs(t-e)<=Mq*Math.max(1,Math.abs(t),Math.abs(e))}Object.freeze(Object.defineProperty({__proto__:null,RANDOM:JO,equals:HMe,getEpsilon:Sa,setEpsilon:BMe,toDegree:jMe,toRadian:h4},Symbol.toStringTag,{value:"Module"}));function Me(t){const e=t[0],r=t[1],i=t[2];return Math.sqrt(e*e+r*r+i*i)}function le(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function ce(t,e,r,i){return t[0]=e,t[1]=r,t[2]=i,t}function fe(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t}function me(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t}function d4(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t}function nN(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t}function qMe(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t}function Jhe(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t}function mV(t,e){return t[0]=Math.abs(e[0]),t[1]=Math.abs(e[1]),t[2]=Math.abs(e[2]),t}function Khe(t,e){return t[0]=Math.sign(e[0]),t[1]=Math.sign(e[1]),t[2]=Math.sign(e[2]),t}function Qhe(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t[2]=Math.min(e[2],r[2]),t}function WMe(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t}function XMe(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t}function ae(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t}function Pb(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t}function xi(t,e){const r=e[0]-t[0],i=e[1]-t[1],s=e[2]-t[2];return Math.sqrt(r*r+i*i+s*s)}function Ro(t,e){const r=e[0]-t[0],i=e[1]-t[1],s=e[2]-t[2];return r*r+i*i+s*s}function ua(t){const e=t[0],r=t[1],i=t[2];return e*e+r*r+i*i}function ga(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t}function YMe(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t}function _e(t,e){const r=e[0],i=e[1],s=e[2];let n=r*r+i*i+s*s;return n>0&&(n=1/Math.sqrt(n),t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n),t}function ye(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function pt(t,e,r){const i=e[0],s=e[1],n=e[2],o=r[0],a=r[1],l=r[2];return t[0]=s*l-n*a,t[1]=n*o-i*l,t[2]=i*a-s*o,t}function Ys(t,e,r,i){const s=e[0],n=e[1],o=e[2];return t[0]=s+i*(r[0]-s),t[1]=n+i*(r[1]-n),t[2]=o+i*(r[2]-o),t}function ZMe(t,e,r,i,s,n){const o=n*n,a=o*(2*n-3)+1,l=o*(n-2)+n,c=o*(n-1),h=o*(3-2*n);return t[0]=e[0]*a+r[0]*l+i[0]*c+s[0]*h,t[1]=e[1]*a+r[1]*l+i[1]*c+s[1]*h,t[2]=e[2]*a+r[2]*l+i[2]*c+s[2]*h,t}function JMe(t,e,r,i,s,n){const o=1-n,a=o*o,l=n*n,c=a*o,h=3*n*a,p=3*l*o,f=l*n;return t[0]=e[0]*c+r[0]*h+i[0]*p+s[0]*f,t[1]=e[1]*c+r[1]*h+i[1]*p+s[1]*f,t[2]=e[2]*c+r[2]*h+i[2]*p+s[2]*f,t}function KMe(t,e){e=e||1;const r=JO,i=2*r()*Math.PI,s=2*r()-1,n=Math.sqrt(1-s*s)*e;return t[0]=Math.cos(i)*n,t[1]=Math.sin(i)*n,t[2]=s*e,t}function We(t,e,r){const i=e[0],s=e[1],n=e[2];return t[0]=r[0]*i+r[4]*s+r[8]*n+r[12],t[1]=r[1]*i+r[5]*s+r[9]*n+r[13],t[2]=r[2]*i+r[6]*s+r[10]*n+r[14],t}function Ac(t,e,r){const i=e[0],s=e[1],n=e[2];return t[0]=i*r[0]+s*r[3]+n*r[6],t[1]=i*r[1]+s*r[4]+n*r[7],t[2]=i*r[2]+s*r[5]+n*r[8],t}function np(t,e,r){const i=r[0],s=r[1],n=r[2],o=r[3],a=e[0],l=e[1],c=e[2];let h=s*c-n*l,p=n*a-i*c,f=i*l-s*a,m=s*f-n*p,y=n*h-i*f,_=i*p-s*h;const b=2*o;return h*=b,p*=b,f*=b,m*=2,y*=2,_*=2,t[0]=a+h+m,t[1]=l+p+y,t[2]=c+f+_,t}function QMe(t,e,r,i){const s=[],n=[];return s[0]=e[0]-r[0],s[1]=e[1]-r[1],s[2]=e[2]-r[2],n[0]=s[0],n[1]=s[1]*Math.cos(i)-s[2]*Math.sin(i),n[2]=s[1]*Math.sin(i)+s[2]*Math.cos(i),t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t}function ePe(t,e,r,i){const s=[],n=[];return s[0]=e[0]-r[0],s[1]=e[1]-r[1],s[2]=e[2]-r[2],n[0]=s[2]*Math.sin(i)+s[0]*Math.cos(i),n[1]=s[1],n[2]=s[2]*Math.cos(i)-s[0]*Math.sin(i),t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t}function tPe(t,e,r,i){const s=[],n=[];return s[0]=e[0]-r[0],s[1]=e[1]-r[1],s[2]=e[2]-r[2],n[0]=s[0]*Math.cos(i)-s[1]*Math.sin(i),n[1]=s[0]*Math.sin(i)+s[1]*Math.cos(i),n[2]=s[2],t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t}function ede(t,e){le(QM,t),le(eP,e),_e(QM,QM),_e(eP,eP);const r=ye(QM,eP);return r>1?0:r<-1?Math.PI:Math.acos(r)}const QM=M(),eP=M();function rPe(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"}function Ya(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function q_(t,e){if(t===e)return!0;const r=t[0],i=t[1],s=t[2],n=e[0],o=e[1],a=e[2],l=Sa();return Math.abs(r-n)<=l*Math.max(1,Math.abs(r),Math.abs(n))&&Math.abs(i-o)<=l*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(s-a)<=l*Math.max(1,Math.abs(s),Math.abs(a))}function ay(t,e,r){const i=r[0]-e[0],s=r[1]-e[1],n=r[2]-e[2];let o=i*i+s*s+n*n;return o>0?(o=1/Math.sqrt(o),t[0]=i*o,t[1]=s*o,t[2]=n*o,t):(t[0]=0,t[1]=0,t[2]=0,t)}const to=me,iPe=d4,sPe=nN,KO=xi,Pq=Ro,mc=Me,gV=ua,EK=Object.freeze(Object.defineProperty({__proto__:null,abs:mV,add:fe,angle:ede,bezier:JMe,ceil:qMe,copy:le,cross:pt,direction:ay,dist:KO,distance:xi,div:sPe,divide:nN,dot:ye,equals:q_,exactEquals:Ya,floor:Jhe,hermite:ZMe,inverse:YMe,len:mc,length:Me,lerp:Ys,max:WMe,min:Qhe,mul:iPe,multiply:d4,negate:ga,normalize:_e,random:KMe,rotateX:QMe,rotateY:ePe,rotateZ:tPe,round:XMe,scale:ae,scaleAndAdd:Pb,set:ce,sign:Khe,sqrDist:Pq,sqrLen:gV,squaredDistance:Ro,squaredLength:ua,str:rPe,sub:to,subtract:me,transformMat3:Ac,transformMat4:We,transformQuat:np},Symbol.toStringTag,{value:"Module"}));function Xd(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function ti(t,e,r,i,s){return t[0]=e,t[1]=r,t[2]=i,t[3]=s,t}function Iq(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t}function tde(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t}function rde(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t[3]=e[3]*r[3],t}function ide(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t[3]=e[3]/r[3],t}function nPe(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t[3]=Math.ceil(e[3]),t}function oPe(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t[3]=Math.floor(e[3]),t}function aPe(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t[2]=Math.min(e[2],r[2]),t[3]=Math.min(e[3],r[3]),t}function lPe(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t[3]=Math.max(e[3],r[3]),t}function cPe(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t[3]=Math.round(e[3]),t}function _E(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t}function uPe(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t}function sde(t,e){const r=e[0]-t[0],i=e[1]-t[1],s=e[2]-t[2],n=e[3]-t[3];return Math.sqrt(r*r+i*i+s*s+n*n)}function oN(t,e){const r=e[0]-t[0],i=e[1]-t[1],s=e[2]-t[2],n=e[3]-t[3];return r*r+i*i+s*s+n*n}function $q(t){const e=t[0],r=t[1],i=t[2],s=t[3];return Math.sqrt(e*e+r*r+i*i+s*s)}function Lq(t){const e=t[0],r=t[1],i=t[2],s=t[3];return e*e+r*r+i*i+s*s}function hPe(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t}function dPe(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t}function nde(t,e){const r=e[0],i=e[1],s=e[2],n=e[3];let o=r*r+i*i+s*s+n*n;return o>0&&(o=1/Math.sqrt(o),t[0]=r*o,t[1]=i*o,t[2]=s*o,t[3]=n*o),t}function ode(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function p4(t,e,r,i){const s=e[0],n=e[1],o=e[2],a=e[3];return t[0]=s+i*(r[0]-s),t[1]=n+i*(r[1]-n),t[2]=o+i*(r[2]-o),t[3]=a+i*(r[3]-a),t}function pPe(t,e){const r=JO;let i,s,n,o,a,l;e=e||1;do i=2*r()-1,s=2*r()-1,a=i*i+s*s;while(a>=1);do n=2*r()-1,o=2*r()-1,l=n*n+o*o;while(l>=1);const c=Math.sqrt((1-a)/l);return t[0]=e*i,t[1]=e*s,t[2]=e*n*c,t[3]=e*o*c,t}function Su(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3];return t[0]=r[0]*i+r[4]*s+r[8]*n+r[12]*o,t[1]=r[1]*i+r[5]*s+r[9]*n+r[13]*o,t[2]=r[2]*i+r[6]*s+r[10]*n+r[14]*o,t[3]=r[3]*i+r[7]*s+r[11]*n+r[15]*o,t}function fPe(t,e,r){const i=e[0],s=e[1],n=e[2],o=r[0],a=r[1],l=r[2],c=r[3],h=c*i+a*n-l*s,p=c*s+l*i-o*n,f=c*n+o*s-a*i,m=-o*i-a*s-l*n;return t[0]=h*c+m*-o+p*-l-f*-a,t[1]=p*c+m*-a+f*-o-h*-l,t[2]=f*c+m*-l+h*-a-p*-o,t[3]=e[3],t}function mPe(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}function j2(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function Dq(t,e){const r=t[0],i=t[1],s=t[2],n=t[3],o=e[0],a=e[1],l=e[2],c=e[3],h=Sa();return Math.abs(r-o)<=h*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(i-a)<=h*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(s-l)<=h*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(n-c)<=h*Math.max(1,Math.abs(n),Math.abs(c))}const gPe=tde,yPe=rde,_Pe=ide,vPe=sde,bPe=oN,wPe=$q,xPe=Lq,ade=Object.freeze(Object.defineProperty({__proto__:null,add:Iq,ceil:nPe,copy:Xd,dist:vPe,distance:sde,div:_Pe,divide:ide,dot:ode,equals:Dq,exactEquals:j2,floor:oPe,inverse:dPe,len:wPe,length:$q,lerp:p4,max:lPe,min:aPe,mul:yPe,multiply:rde,negate:hPe,normalize:nde,random:pPe,round:cPe,scale:_E,scaleAndAdd:uPe,set:ti,sqrDist:bPe,sqrLen:xPe,squaredDistance:oN,squaredLength:Lq,str:mPe,sub:gPe,subtract:tde,transformMat4:Su,transformQuat:fPe},Symbol.toStringTag,{value:"Module"})),CK=new Float32Array(1);function ES(t){--t;for(let e=1;e<32;e<<=1)t|=t>>e;return t+1}function ge(t,e,r){return Math.min(Math.max(t,e),r)}function dp(t){return(t&t-1)==0}function Pwt(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}function Iwt(t){return 10**Math.ceil(Math.LOG10E*Math.log(t))}function Ft(t,e,r){return t+(e-t)*r}function Gt(t){return t*Math.PI/180}function rl(t){return 180*t/Math.PI}function D6(t,e=1e-6){return(t<0?-1:1)/Math.max(Math.abs(t),e)}function Sn(t){return Math.acos(ge(t,-1,1))}function Uh(t){return Math.asin(ge(t,-1,1))}function H2(t,e,r=1e-6){return t===e?!0:!Number.isFinite(t)||!Number.isFinite(e)?!1:(t>e?t-e:e-t)<=r}const aN=new DataView(new ArrayBuffer(Float64Array.BYTES_PER_ELEMENT));function TPe(t){return aN.setFloat64(0,t),aN.getBigInt64(0)}function SPe(t){return aN.setBigInt64(0,t),aN.getFloat64(0)}const N6=BigInt("1000000");EPe(1);function EPe(t){const e=TPe(t=Math.abs(t)),r=SPe(e<=N6?N6:e-N6);return Math.abs(t-r)}function CPe(t,e,r=1e-6){if(t===e)return!0;if(!Number.isFinite(t)||!Number.isFinite(e))return!1;const i=Math.abs(t-e),s=Math.abs(t),n=Math.abs(e);if(t===0||e===0||s<1e-12&&n<1e-12){if(i>.01*r)return!1}else if(i/(s+n)>r)return!1;return!0}function APe(t){return lde(Math.max(-yV,Math.min(t,yV)))}function lde(t){return CK[0]=t,CK[0]}function CS(t,e,r){const i=ge((r-t)/(e-t),0,1);return i*i*(3-2*i)}function AK(t,e){const r=Me(t),i=Uh(t[2]/r),s=Math.atan2(t[1]/r,t[0]/r);return ce(e,r,i,s),e}function $wt(t,e,r){return ti(t,e[0],e[1],e[2],e[3]*r)}function Lwt(t){const e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],r=t[3]*t[3]+t[4]*t[4]+t[5]*t[5],i=t[6]*t[6]+t[7]*t[7]+t[8]*t[8];return!(H2(e,1)&&H2(r,1)&&H2(i,1))}const yV=lde(34028234663852886e22);function tP(t){return ge(KH(t),0,255)}function rP(t,e,r){return t=Number(t),isNaN(t)?r:t<e?e:t>r?r:t}let Y$=class sa{static blendColors(e,r,i,s=new sa){return s.r=Math.round(e.r+(r.r-e.r)*i),s.g=Math.round(e.g+(r.g-e.g)*i),s.b=Math.round(e.b+(r.b-e.b)*i),s.a=e.a+(r.a-e.a)*i,s._sanitize()}static fromRgb(e,r){const i=e.toLowerCase().match(/^(rgba?|hsla?)\(([\s\.\-,%0-9]+)\)/);if(i){const s=i[2].split(/\s*,\s*/),n=i[1];if(n==="rgb"&&s.length===3||n==="rgba"&&s.length===4){const o=s[0];if(o.charAt(o.length-1)==="%"){const a=s.map(l=>2.56*parseFloat(l));return s.length===4&&(a[3]=parseFloat(s[3])),sa.fromArray(a,r)}return sa.fromArray(s.map(a=>parseFloat(a)),r)}if(n==="hsl"&&s.length===3||n==="hsla"&&s.length===4)return sa.fromArray(Hhe(parseFloat(s[0]),parseFloat(s[1])/100,parseFloat(s[2])/100,parseFloat(s[3])),r)}return null}static fromHex(e,r=new sa){if(e.length!==4&&e.length!==7||e[0]!=="#")return null;const i=e.length===4?4:8,s=(1<<i)-1;let n=+("0x"+e.substr(1));return isNaN(n)?null:(["b","g","r"].forEach(o=>{const a=n&s;n>>=i,r[o]=i===4?17*a:a}),r.a=1,r)}static fromArray(e,r=new sa){return r._set(Number(e[0]),Number(e[1]),Number(e[2]),Number(e[3])),isNaN(r.a)&&(r.a=1),r._sanitize()}static fromString(e,r){const i=jhe(e)?Aq(e):null;return i&&sa.fromArray(i,r)||sa.fromRgb(e,r)||sa.fromHex(e,r)}static fromJSON(e){return e&&new sa([e[0],e[1],e[2],e[3]/255])}static toUnitRGB(e){return v(e)?[e.r/255,e.g/255,e.b/255]:null}static toUnitRGBA(e){return v(e)?[e.r/255,e.g/255,e.b/255,e.a!=null?e.a:1]:null}constructor(e){this.r=255,this.g=255,this.b=255,this.a=1,e&&this.setColor(e)}get isBright(){return .299*this.r+.587*this.g+.114*this.b>=127}setColor(e){return typeof e=="string"?sa.fromString(e,this):Array.isArray(e)?sa.fromArray(e,this):(this._set(e.r??0,e.g??0,e.b??0,e.a??1),e instanceof sa||this._sanitize()),this}toRgb(){return[this.r,this.g,this.b]}toRgba(){return[this.r,this.g,this.b,this.a]}toHex(){const e=this.r.toString(16),r=this.g.toString(16),i=this.b.toString(16);return`#${e.length<2?"0"+e:e}${r.length<2?"0"+r:r}${i.length<2?"0"+i:i}`}toCss(e=!1){const r=this.r+", "+this.g+", "+this.b;return e?`rgba(${r}, ${this.a})`:`rgb(${r})`}toString(){return this.toCss(!0)}toJSON(){return this.toArray()}toArray(e=sa.AlphaMode.ALWAYS){const r=tP(this.r),i=tP(this.g),s=tP(this.b);return e===sa.AlphaMode.ALWAYS||this.a!==1?[r,i,s,tP(255*this.a)]:[r,i,s]}clone(){return new sa(this.toRgba())}hash(){return this.r<<24|this.g<<16|this.b<<8|255*this.a}equals(e){return v(e)&&e.r===this.r&&e.g===this.g&&e.b===this.b&&e.a===this.a}_sanitize(){return this.r=Math.round(rP(this.r,0,255)),this.g=Math.round(rP(this.g,0,255)),this.b=Math.round(rP(this.b,0,255)),this.a=rP(this.a,0,1),this}_set(e,r,i,s){this.r=e,this.g=r,this.b=i,this.a=s}};Y$.prototype.declaredClass="esri.Color",function(t){var e;(e=t.AlphaMode||(t.AlphaMode={}))[e.ALWAYS=0]="ALWAYS",e[e.UNLESS_OPAQUE=1]="UNLESS_OPAQUE"}(Y$||(Y$={}));const Ze=Y$;function Dwt(t){}function RPe(t){return()=>t}function gt(t,e={}){const r=t instanceof mr?t:new mr(t,e),i={type:(e==null?void 0:e.ignoreUnknown)??1?r.apiValues:String,json:{type:r.jsonValues,read:!(e!=null&&e.readOnly)&&{reader:r.read},write:{writer:r.write}}};return(e==null?void 0:e.readOnly)!==void 0&&(i.readOnly=!!e.readOnly),(e==null?void 0:e.default)!==void 0&&(i.json.default=e.default),(e==null?void 0:e.name)!==void 0&&(i.json.name=e.name),(e==null?void 0:e.nonNullable)!==void 0&&(i.nonNullable=e.nonNullable),d(i)}var _V;let Z$=_V=class extends ve{constructor(t){super(t),this.type="none"}clone(){return new _V({type:this.type})}};u([gt({none:"none",stayAbove:"stay-above"})],Z$.prototype,"type",void 0),Z$=_V=u([I("esri.ground.NavigationConstraint")],Z$);let As=class extends Te{constructor(){super(...arguments),this.SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,this.DECONFLICTOR_SHOW_VISIBLE=!1,this.DECONFLICTOR_SHOW_INVISIBLE=!1,this.DECONFLICTOR_SHOW_GRID=!1,this.LABELS_SHOW_BORDER=!1,this.TEXT_SHOW_BASELINE=!1,this.TEXT_SHOW_BORDER=!1,this.OVERLAY_DRAW_DEBUG_TEXTURE=!1,this.OVERLAY_SHOW_CENTER=!1,this.SHOW_POI=!1,this.TESTS_DISABLE_OPTIMIZATIONS=!1,this.TESTS_DISABLE_FAST_UPDATES=!1,this.DRAW_MESH_GEOMETRY_NORMALS=!1,this.FEATURE_TILE_FETCH_SHOW_TILES=!1,this.FEATURE_TILE_TREE_SHOW_TILES=!1,this.TERRAIN_TILE_TREE_SHOW_TILES=!1,this.I3S_TREE_SHOW_TILES=!1,this.I3S_SHOW_MODIFICATIONS=!1,this.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,this.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,this.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1,this.LINE_WIREFRAMES=!1,this.TERRAIN_USE_LEGACY_SHADING=!1}};u([d()],As.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),u([d()],As.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),u([d()],As.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),u([d()],As.prototype,"DECONFLICTOR_SHOW_GRID",void 0),u([d()],As.prototype,"LABELS_SHOW_BORDER",void 0),u([d()],As.prototype,"TEXT_SHOW_BASELINE",void 0),u([d()],As.prototype,"TEXT_SHOW_BORDER",void 0),u([d()],As.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),u([d()],As.prototype,"OVERLAY_SHOW_CENTER",void 0),u([d()],As.prototype,"SHOW_POI",void 0),u([d()],As.prototype,"TESTS_DISABLE_OPTIMIZATIONS",void 0),u([d()],As.prototype,"TESTS_DISABLE_FAST_UPDATES",void 0),u([d()],As.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),u([d()],As.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),u([d()],As.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),u([d()],As.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),u([d()],As.prototype,"I3S_TREE_SHOW_TILES",void 0),u([d()],As.prototype,"I3S_SHOW_MODIFICATIONS",void 0),u([d()],As.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),u([d()],As.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),u([d()],As.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0),u([d()],As.prototype,"LINE_WIREFRAMES",void 0),u([d()],As.prototype,"TERRAIN_USE_LEGACY_SHADING",void 0),As=u([I("esri.views.3d.support.DebugFlags")],As);const qr=new As;function f4(t){const e=KH(100*(1-t));return Math.max(0,Math.min(e,100))}function kR(t){const e=1-t/100;return Math.max(0,Math.min(e,1))}var vV;let Zp=vV=class extends XO(Zg){constructor(t){super(t),this.opacity=1,this.shading=!qr.TERRAIN_USE_LEGACY_SHADING,this.surfaceColor=null,this.navigationConstraint=null,this.layers=new Pt;const e=i=>{i.parent&&i.parent!==this&&"remove"in i.parent&&i.parent.remove(i),i.parent=this,i.type!=="elevation"&&i.type!=="base-elevation"&&se.getLogger(this.declaredClass).error(`Layer '${i.title}, id:${i.id}' of type '${i.type}' is not supported as a ground layer and will therefore be ignored. Only layers of type 'elevation' are supported.`)},r=i=>{i.parent=null};this.layers.on("after-add",i=>e(i.item)),this.layers.on("after-remove",i=>r(i.item))}initialize(){this.when().catch(t=>{se.getLogger(this.declaredClass).error("#load()","Failed to load ground",t)}),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){const t=this.layers.removeAll();for(const e of t)e.destroy();this.layers.destroy()}normalizeCtorArgs(t){return t&&"resourceInfo"in t&&(this._set("resourceInfo",t.resourceInfo),delete(t={...t}).resourceInfo),t}set layers(t){this._set("layers",aw(t,this._get("layers")))}writeLayers(t,e,r,i){const s=[];t&&(i={...i,layerContainerType:"ground"},t.forEach(n=>{if("write"in n){const o={};RPe(n)().write(o,i)&&s.push(o)}else i&&i.messages&&i.messages.push(new q("layer:unsupported",`Layers (${n.title}, ${n.id}) of type '${n.declaredClass}' cannot be persisted in the ground`,{layer:n}))})),e.layers=s}load(t){return this.addResolvingPromise(this._loadFromSource(t)),Promise.resolve(this)}loadAll(){return Zue(this,t=>{t(this.layers)})}async queryElevation(t,e){await this.load({signal:e==null?void 0:e.signal});const{ElevationQuery:r}=await te(()=>import("./ElevationQuery-ab1834a6.js"),[]);fr(e);const i=new r,s=this.layers.filter(RK).toArray();return i.queryAll(s,t,e)}async createElevationSampler(t,e){await this.load({signal:e==null?void 0:e.signal});const{ElevationQuery:r}=await te(()=>import("./ElevationQuery-ab1834a6.js"),[]);fr(e);const i=new r,s=this.layers.filter(RK).toArray();return i.createSamplerAll(s,t,e)}clone(){const t={opacity:this.opacity,surfaceColor:ne(this.surfaceColor),navigationConstraint:ne(this.navigationConstraint),layers:this.layers.slice()};return this.loaded&&(t.loadStatus="loaded"),new vV({resourceInfo:this.resourceInfo}).set(t)}read(t,e){this.resourceInfo||this._set("resourceInfo",{data:t,context:e}),super.read(t,e)}_loadFromSource(t){const e=this.resourceInfo;return e?this._loadLayersFromJSON(e.data,e.context,t):Promise.resolve()}_loadLayersFromJSON(t,e,r){const i=e&&e.origin||"web-scene",s=e&&e.portal||null,n=e&&e.url||null;return te(()=>import("./layersCreator-5f5275f2.js"),["assets/layersCreator-5f5275f2.js","assets/lazyLayerLoader-b79dca54.js","assets/portalLayers-a50d3025.js","assets/layersLoader-c65033be.js","assets/fetchService-d31d8618.js","assets/jsonContext-999facfa.js"]).then(({populateOperationalLayers:o})=>{fr(r);const a=[];if(t.layers&&Array.isArray(t.layers)){const l={context:{origin:i,url:n,portal:s,layerContainerType:"ground"},defaultLayerType:"ArcGISTiledElevationServiceLayer"};a.push(o(this.layers,t.layers,l))}return jl(a)}).then(()=>{})}};function OPe(t){return t&&"createElevationSampler"in t}function RK(t){return t.type==="elevation"||OPe(t)}u([d({json:{read:!1}})],Zp.prototype,"layers",null),u([He("layers")],Zp.prototype,"writeLayers",null),u([d({readOnly:!0})],Zp.prototype,"resourceInfo",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{type:Gi,read:{reader:kR,source:"transparency"},write:{writer:(t,e)=>{e.transparency=f4(t)},target:"transparency"}}})],Zp.prototype,"opacity",void 0),u([d({type:Boolean,nonNullable:!0,json:{read:!1}})],Zp.prototype,"shading",void 0),u([d({type:Ze,json:{type:[Gi],write:(t,e)=>{e.surfaceColor=t.toJSON().slice(0,3)}}})],Zp.prototype,"surfaceColor",void 0),u([d({type:Z$,json:{write:!0}})],Zp.prototype,"navigationConstraint",void 0),Zp=vV=u([I("esri.Ground")],Zp);const lN=Zp;let yT=class extends Pt{constructor(e){super(e),this.getCollections=null}initialize(){this.own(vue(()=>this._refresh()))}destroy(){this.getCollections=null}_refresh(){const e=v(this.getCollections)?this.getCollections():null;if(C(e))return void this.removeAll();let r=0;for(const i of e)v(i)&&(r=this._processCollection(r,i));this.splice(r,this.length)}_createNewInstance(e){return new Pt(e)}_processCollection(e,r){if(!r)return e;const i=this.itemFilterFunction?this.itemFilterFunction:s=>!!s;for(const s of r)if(s){if(i(s)){const n=this.indexOf(s,e);n>=0?n!==e&&this.reorder(s,e):this.add(s,e),++e}if(this.getChildrenFunction){const n=this.getChildrenFunction(s);if(Array.isArray(n))for(const o of n)e=this._processCollection(e,o);else e=this._processCollection(e,n)}}return e}};u([d()],yT.prototype,"getCollections",void 0),u([d()],yT.prototype,"getChildrenFunction",void 0),u([d()],yT.prototype,"itemFilterFunction",void 0),yT=u([I("esri.core.CollectionFlattener")],yT);const VR=yT;function MPe(t){var e,r;return!(!(t!=null&&t.loaded)||!((r=(e=zhe(t))==null?void 0:e.operations)!=null&&r.supportsEditing)||"editingEnabled"in t&&!RMe(t))}const OK=se.getLogger("esri.support.basemapUtils");function PPe(){return{}}function IPe(t){for(const e in t){const r=t[e];(r==null?void 0:r.destroyed)===!1&&r.destroy(),delete t[e]}}function $Pe(t,e){let r;if(typeof t=="string"){if(!(t in fV)){const i=Object.entries(fV).filter(([s,n])=>Yr.apiKey&&!n.classic||!Yr.apiKey&&n.classic&&!n.deprecated).map(([s])=>`"${s}"`).join(", ");return OK.warn(`Unable to find basemap definition for: ${t}. Try one of these: ${i}`),null}e&&(r=e[t]),r||(r=iN.fromId(t),e&&(e[t]=r))}else r=us(iN,t);return r!=null&&r.destroyed&&(OK.warn("The provided basemap is already destroyed",{basemap:r}),r=null),r}function LPe(t){return new VR({getCollections:()=>[t.tables,t.layers],getChildrenFunction:e=>{const r=[];return"tables"in e&&r.push(e.tables),"layers"in e&&r.push(e.layers),r},itemFilterFunction:e=>{const r=e.parent;return!!r&&"tables"in r&&r.tables.includes(e)}})}const MK={"world-elevation":{id:"worldElevation",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"},"world-topobathymetry":{id:"worldTopoBathymetry",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/TopoBathy3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"}};function DPe(t){let e=null;if(typeof t=="string")if(t in MK){const r=MK[t];e=new lN({resourceInfo:{data:{layers:[r]}}})}else se.getLogger("esri.support.groundUtils").warn(`Unable to find ground definition for: ${t}. Try "world-elevation"`);else e=us(lN,t);return e}function AS(t,e,r=!1){let{hasM:i,hasZ:s}=t;Array.isArray(e)?e.length!==4||i||s?e.length===3&&r&&!i?(s=!0,i=!1):e.length===3&&i&&s&&(i=!1,s=!1):(i=!0,s=!0):(s=!s&&e.hasZ&&(!i||e.hasM),i=!i&&e.hasM&&(!s||e.hasZ)),t.hasZ=s,t.hasM=i}var bV;function PK(t){return(e,r)=>e==null?r:r==null?e:t(e,r)}function NPe(t){return t&&(t.declaredClass==="esri.geometry.SpatialReference"||t.wkid!=null)}let v0=bV=class extends pv{constructor(...t){super(...t),this.points=[],this.type="multipoint"}normalizeCtorArgs(t,e){if(!t&&!e)return{};const r={};Array.isArray(t)?(r.points=t,r.spatialReference=e):NPe(t)?r.spatialReference=t:(t.points&&(r.points=t.points),t.spatialReference&&(r.spatialReference=t.spatialReference),t.hasZ&&(r.hasZ=t.hasZ),t.hasM&&(r.hasM=t.hasM));const i=r.points&&r.points[0];return i&&(r.hasZ===void 0&&r.hasM===void 0?(r.hasZ=i.length>2,r.hasM=!1):r.hasZ===void 0?r.hasZ=i.length>3:r.hasM===void 0&&(r.hasM=i.length>3)),r}get cache(){return this.commitProperty("points"),this.commitProperty("hasZ"),this.commitProperty("hasM"),this.commitProperty("spatialReference"),{}}get extent(){const t=this.points;if(!t.length)return null;const e=new Zr,r=this.hasZ,i=this.hasM,s=r?3:2,n=t[0],o=PK(Math.min),a=PK(Math.max);let l,c,h,p,[f,m]=n,[y,_]=n;for(let b=0,x=t.length;b<x;b++){const T=t[b],[S,E]=T;if(f=o(f,S),m=o(m,E),y=a(y,S),_=a(_,E),r&&T.length>2){const O=T[2];l=o(l,O),h=a(h,O)}if(i&&T.length>s){const O=T[s];c=o(c,O),p=a(p,O)}}return e.xmin=f,e.ymin=m,e.xmax=y,e.ymax=_,e.spatialReference=this.spatialReference,r?(e.zmin=l,e.zmax=h):(e.zmin=void 0,e.zmax=void 0),i?(e.mmin=c,e.mmax=p):(e.mmin=void 0,e.mmax=void 0),e}writePoints(t,e){e.points=ne(this.points)}addPoint(t){return AS(this,t),Array.isArray(t)?this.points.push(t):this.points.push(t.toArray()),this.notifyChange("points"),this}clone(){const t={points:ne(this.points),spatialReference:this.spatialReference};return this.hasZ&&(t.hasZ=!0),this.hasM&&(t.hasM=!0),new bV(t)}getPoint(t){if(!this._validateInputs(t))return null;const e=this.points[t],r={x:e[0],y:e[1],spatialReference:this.spatialReference};let i=2;return this.hasZ&&(r.z=e[2],i=3),this.hasM&&(r.m=e[i]),new mt(r)}removePoint(t){if(!this._validateInputs(t))return null;const e=new mt(this.points.splice(t,1)[0],this.spatialReference);return this.notifyChange("points"),e}setPoint(t,e){return this._validateInputs(t)?(AS(this,e),Array.isArray(e)||(e=e.toArray()),this.points[t]=e,this.notifyChange("points"),this):this}toJSON(t){return this.write({},t)}_validateInputs(t){return t!=null&&t>=0&&t<this.points.length}};u([d({readOnly:!0})],v0.prototype,"cache",null),u([d()],v0.prototype,"extent",null),u([d({type:[[Number]],json:{write:{isRequired:!0}}})],v0.prototype,"points",void 0),u([He("points")],v0.prototype,"writePoints",null),v0=bV=u([I("esri.geometry.Multipoint")],v0),v0.prototype.toJSON.isDefaultToJSON=!0;const QO=v0;function Nq(t,e){const r=e[0]-t[0],i=e[1]-t[1];if(t.length>2&&e.length>2){const s=t[2]-e[2];return Math.sqrt(r*r+i*i+s*s)}return Math.sqrt(r*r+i*i)}function cde(t,e,r){const i=t[0]+r*(e[0]-t[0]),s=t[1]+r*(e[1]-t[1]);return t.length>2&&e.length>2?[i,s,t[2]+r*(e[2]-t[2])]:[i,s]}function Uwt(t,e,r,i){const[s,n]=e,[o,a]=r[i],[l,c]=r[i+1],h=l-o,p=c-a,f=h*h+p*p,m=(s-o)*h+(n-a)*p,y=Math.min(1,Math.max(0,m/f));return t[0]=o+h*y,t[1]=a+p*y,t}function kwt(t,e,r){const i=r.rings;let s,n,o=!1,a=1/0;for(let l=0;l<i.length;l++){const c=i[l];for(let h=0,p=c.length-1;h<c.length;p=h++)s=c[h],n=c[p],s[1]>e!=n[1]>e&&t<(n[0]-s[0])*(e-s[1])/(n[1]-s[1])+s[0]&&(o=!o),a=Math.min(a,FPe(t,e,s,n))}return a===0?0:(o?1:-1)*Math.sqrt(a)}function FPe(t,e,r,i){let s=r[0],n=r[1],o=i[0]-s,a=i[1]-n;if(o!==0||a!==0){const l=((t-s)*o+(e-n)*a)/(o*o+a*a);l>1?(s=i[0],n=i[1]):l>0&&(s+=o*l,n+=a*l)}return o=t-s,a=e-n,o*o+a*a}function UPe(t,e){return cde(t,e,.5)}function ude(t){const e=t.length;let r=0;for(let i=0;i<e-1;++i)r+=Nq(t[i],t[i+1]);return r}function hde(t,e){if(e<=0)return t[0];const r=t.length;let i=0;for(let s=0;s<r-1;++s){const n=Nq(t[s],t[s+1]);if(e-i<n){const o=(e-i)/n;return cde(t[s],t[s+1],o)}i+=n}return t[r-1]}function dde(t,e,r){const i=t.length;let s=0,n=0,o=0;for(let a=0;a<i;a++){const l=t[a],c=t[(a+1)%i];let h=2;s+=l[0]*c[1]-c[0]*l[1],l.length>2&&c.length>2&&r&&(n+=l[0]*c[2]-c[0]*l[2],h=3),l.length>h&&c.length>h&&e&&(o+=l[0]*c[h]-c[0]*l[h])}return s<=0&&n<=0&&o<=0}function kPe(t){const e=t.length;return e>2&&Xg(t[0],t[e-1])}function Vwt(t){if("rings"in t)for(const e of t.rings)kPe(e)||e.push(e[0].slice())}function pde(t){if(!t||t.length<3)return 0;let e=0;const r=t.length-1;for(let i=0;i<r;i++)e+=(t[i][0]-t[i+1][0])*(t[i][1]+t[i+1][1]);return e+=(t[r][0]-t[0][0])*(t[r][1]+t[0][1]),-.5*e}function Bwt(t){return t?t.hasZ?[t.xmax-t.xmin/2,t.ymax-t.ymin/2,t.zmax-t.zmin/2]:[t.xmax-t.xmin/2,t.ymax-t.ymin/2]:null}function VPe(t){return t?Fq(t.rings,t.hasZ??!1):null}function Fq(t,e){if(!t||!t.length)return null;const r=[],i=[],s=e?[1/0,-1/0,1/0,-1/0,1/0,-1/0]:[1/0,-1/0,1/0,-1/0];for(let n=0,o=t.length;n<o;n++){const a=BPe(t[n],e,s);a&&i.push(a)}if(i.sort((n,o)=>{let a=n[2]-o[2];return a===0&&e&&(a=n[4]-o[4]),a}),i.length&&(r[0]=i[0][0],r[1]=i[0][1],e&&(r[2]=i[0][3]),(r[0]<s[0]||r[0]>s[1]||r[1]<s[2]||r[1]>s[3]||e&&(r[2]<s[4]||r[2]>s[5]))&&(r.length=0)),!r.length){const n=t[0]&&t[0].length?zPe(t[0],e):null;if(!n)return null;r[0]=n[0],r[1]=n[1],e&&n.length>2&&(r[2]=n[2])}return r}function BPe(t,e,r){let i=0,s=0,n=0,o=0,a=0;const l=t.length?t[0][0]:0,c=t.length?t[0][1]:0,h=t.length&&e?t[0][2]:0;for(let f=0;f<t.length;f++){const m=t[f],y=t[(f+1)%t.length],[_,b,x]=m,T=_-l,S=b-c,[E,O,R]=y,L=E-l,P=O-c,U=T*P-L*S;if(o+=U,i+=(T+L)*U,s+=(S+P)*U,e&&m.length>2&&y.length>2){const B=x-h,z=R-h,G=T*z-L*B;n+=(B+z)*G,a+=G}_<r[0]&&(r[0]=_),_>r[1]&&(r[1]=_),b<r[2]&&(r[2]=b),b>r[3]&&(r[3]=b),e&&(x<r[4]&&(r[4]=x),x>r[5]&&(r[5]=x))}if(o>0&&(o*=-1),a>0&&(a*=-1),!o)return null;o*=.5,a*=.5;const p=[i/(6*o)+l,s/(6*o)+c,o];return e&&(r[4]===r[5]||a===0?(p[3]=(r[4]+r[5])/2,p[4]=0):(p[3]=n/(6*a)+h,p[4]=a)),p}function zPe(t,e){const r=e?[0,0,0]:[0,0],i=e?[0,0,0]:[0,0];let s=0,n=0,o=0,a=0;for(let l=0,c=t.length;l<c-1;l++){const h=t[l],p=t[l+1];if(h&&p){r[0]=h[0],r[1]=h[1],i[0]=p[0],i[1]=p[1],e&&h.length>2&&p.length>2&&(r[2]=h[2],i[2]=p[2]);const f=Nq(r,i);if(f){s+=f;const m=UPe(h,p);n+=f*m[0],o+=f*m[1],e&&m.length>2&&(a+=f*m[2])}}}return s>0?e?[n/s,o/s,a/s]:[n/s,o/s]:t.length?t[0]:null}const GPe=1e-6;function zwt(t){if(!t||!t.rings)return null;const{rings:e}=t;let r=0;for(let n=0;n<e.length;n++)r+=pde(e[n]);if(r<GPe)return Fq(e,!1);const i=[0,0],s=e[0][0];for(let n=0;n<e.length;n++)HPe(i,s,e[n]);return i[0]*=1/r,i[1]*=1/r,i[0]+=s[0],i[1]+=s[1],i}const jPe=1/3;function HPe(t,e,r){if(!t||!r||r.length<3)return null;const i=r[0],s=[0,0],n=[r[1][0]-i[0],r[1][1]-i[1]];let o;for(let c=2;c<r.length;c++)s[0]=r[c][0]-i[0],s[1]=r[c][1]-i[1],o=.5*jPe*(s[0]*n[1]-s[1]*n[0]),t[0]+=o*(n[0]+s[0]),t[1]+=o*(n[1]+s[1]),n[0]=s[0],n[1]=s[1];const a=pde(r),l=[i[0],i[1]];return l[0]-=e[0],l[1]-=e[1],l[0]*=a,l[1]*=a,t[0]+=l[0],t[1]+=l[1],t}function fde(t){return t.xmin!==void 0&&t.ymin!==void 0&&t.xmax!==void 0&&t.ymax!==void 0}function mde(t){return t.points!==void 0}function gde(t){return t.x!==void 0&&t.y!==void 0}function yde(t){return t.paths!==void 0}function _de(t){return t.rings!==void 0}function vde(t){function e(r,i){return r==null?i:i==null?r:t(r,i)}return e}const g_=vde(Math.min),y_=vde(Math.max);function Gwt(t,e){return yde(e)?RS(t,e.paths,!1,!1):_de(e)?RS(t,e.rings,!1,!1):mde(e)?Uq(t,e.points,!1,!1,!1,!1):fde(e)?bde(t,e):(gde(e)&&(t[0]=e.x,t[1]=e.y,t[2]=e.x,t[3]=e.y),t)}function jwt(t,e){return yde(e)?RS(t,e.paths,!0,!1):_de(e)?RS(t,e.rings,!0,!1):mde(e)?Uq(t,e.points,!0,!1,!0,!1):fde(e)?bde(t,e,!0,!1,!0,!1):(gde(e)&&(t[0]=e.x,t[1]=e.y,t[2]=e.z,t[3]=e.x,t[4]=e.y,t[5]=e.z),t)}function RS(t,e,r,i){const s=r?3:2;if(!e.length||!e[0].length)return null;let n,o,a,l,[c,h]=e[0][0],[p,f]=e[0][0];for(let m=0;m<e.length;m++){const y=e[m];for(let _=0;_<y.length;_++){const b=y[_],[x,T]=b;if(c=g_(c,x),h=g_(h,T),p=y_(p,x),f=y_(f,T),r&&b.length>2){const S=b[2];n=g_(n,S),o=y_(o,S)}if(i&&b.length>s){const S=b[s];a=g_(n,S),l=y_(o,S)}}}return r?i?(t[0]=c,t[1]=h,t[2]=n,t[3]=a,t[4]=p,t[5]=f,t[6]=o,t[7]=l,t.length=8,t):(t[0]=c,t[1]=h,t[2]=n,t[3]=p,t[4]=f,t[5]=o,t.length=6,t):i?(t[0]=c,t[1]=h,t[2]=a,t[3]=p,t[4]=f,t[5]=l,t.length=6,t):(t[0]=c,t[1]=h,t[2]=p,t[3]=f,t.length=4,t)}function bde(t,e,r,i,s,n){const o=e.xmin,a=e.xmax,l=e.ymin,c=e.ymax;let h=e.zmin,p=e.zmax,f=e.mmin,m=e.mmax;return s?(h=h||0,p=p||0,n?(f=f||0,m=m||0,t[0]=o,t[1]=l,t[2]=h,t[3]=f,t[4]=a,t[5]=c,t[6]=p,t[7]=m,t):(t[0]=o,t[1]=l,t[2]=h,t[3]=a,t[4]=c,t[5]=p,t)):n?(f=f||0,m=m||0,t[0]=o,t[1]=l,t[2]=f,t[3]=a,t[4]=c,t[5]=m,t):(t[0]=o,t[1]=l,t[2]=a,t[3]=c,t)}function Uq(t,e,r,i,s,n){const o=r?3:2,a=i&&n,l=r&&s;if(!e.length||!e[0].length)return null;let c,h,p,f,[m,y]=e[0],[_,b]=e[0];for(let x=0;x<e.length;x++){const T=e[x],[S,E]=T;if(m=g_(m,S),y=g_(y,E),_=y_(_,S),b=y_(b,E),l&&T.length>2){const O=T[2];c=g_(c,O),h=y_(h,O)}if(a&&T.length>o){const O=T[o];p=g_(c,O),f=y_(h,O)}}return s?(c=c||0,h=h||0,n?(p=p||0,f=f||0,t[0]=m,t[1]=y,t[2]=c,t[3]=p,t[4]=_,t[5]=b,t[6]=h,t[7]=f,t):(t[0]=m,t[1]=y,t[2]=c,t[3]=_,t[4]=b,t[5]=h,t)):n?(p=p||0,f=f||0,t[0]=m,t[1]=y,t[2]=p,t[3]=_,t[4]=b,t[5]=f,t):(t[0]=m,t[1]=y,t[2]=_,t[3]=b,t)}function qPe(t){return t.xmin!==void 0&&t.ymin!==void 0&&t.xmax!==void 0&&t.ymax!==void 0}function WPe(t){return t.points!==void 0}function XPe(t){return t.x!==void 0&&t.y!==void 0}function YPe(t){return t.paths!==void 0}function ZPe(t){return t.rings!==void 0}const kq=[];function wde(t,e,r,i){return{xmin:t,ymin:e,xmax:r,ymax:i}}function xde(t,e,r,i,s,n){return{xmin:t,ymin:e,zmin:r,xmax:i,ymax:s,zmax:n}}function Tde(t,e,r,i,s,n){return{xmin:t,ymin:e,mmin:r,xmax:i,ymax:s,mmax:n}}function Sde(t,e,r,i,s,n,o,a){return{xmin:t,ymin:e,zmin:r,mmin:i,xmax:s,ymax:n,zmax:o,mmax:a}}function Vq(t,e=!1,r=!1){return e?r?Sde(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7]):xde(t[0],t[1],t[2],t[3],t[4],t[5]):r?Tde(t[0],t[1],t[2],t[3],t[4],t[5]):wde(t[0],t[1],t[2],t[3])}function Hwt(t){return t?qPe(t)?t:XPe(t)?KPe(t):ZPe(t)?Ede(t):YPe(t)?Cde(t):WPe(t)?JPe(t):null:null}function JPe(t){const{hasZ:e,hasM:r,points:i}=t;return Vq(Uq(kq,i,e??!1,r??!1),e,r)}function KPe(t){const{x:e,y:r,z:i,m:s}=t,n=s!=null;return i!=null?n?Sde(e,r,i,s,e,r,i,s):xde(e,r,i,e,r,i):n?Tde(e,r,s,e,r,s):wde(e,r,e,r)}function Ede(t){const{hasZ:e,hasM:r,rings:i}=t,s=RS(kq,i,e??!1,r??!1);return s?Vq(s,e,r):null}function Cde(t){const{hasZ:e,hasM:r,paths:i}=t,s=RS(kq,i,e??!1,r??!1);return s?Vq(s,e,r):null}var J$;function IK(t){return!Array.isArray(t[0])}let Jp=J$=class extends pv{static fromExtent(t){const e=t.clone().normalize(),r=t.spatialReference;let i=!1,s=!1;for(const o of e)o.hasZ&&(i=!0),o.hasM&&(s=!0);const n={rings:e.map(o=>{const a=[[o.xmin,o.ymin],[o.xmin,o.ymax],[o.xmax,o.ymax],[o.xmax,o.ymin],[o.xmin,o.ymin]];if(i&&o.hasZ){const l=o.zmin+.5*(o.zmax-o.zmin);for(let c=0;c<a.length;c++)a[c].push(l)}if(s&&o.hasM){const l=o.mmin+.5*(o.mmax-o.mmin);for(let c=0;c<a.length;c++)a[c].push(l)}return a}),spatialReference:r};return i&&(n.hasZ=!0),s&&(n.hasM=!0),new J$(n)}constructor(...t){super(...t),this.rings=[],this.type="polygon"}normalizeCtorArgs(t,e){let r,i,s=null,n=null;return t&&!Array.isArray(t)?(s=t.rings?t.rings:null,e||(t.spatialReference?e=t.spatialReference:t.rings||(e=t)),r=t.hasZ,i=t.hasM):s=t,s=s||[],e=e||et.WGS84,s.length&&s[0]&&s[0][0]!=null&&typeof s[0][0]=="number"&&(s=[s]),n=s[0]&&s[0][0],n&&(r===void 0&&i===void 0?(r=n.length>2,i=n.length>3):r===void 0?r=i?n.length>3:n.length>2:i===void 0&&(i=r?n.length>3:n.length>2)),{rings:s,spatialReference:e,hasZ:r,hasM:i}}get cache(){return this.commitProperty("rings"),this.commitProperty("hasZ"),this.commitProperty("hasM"),this.commitProperty("spatialReference"),{}}get centroid(){const t=VPe(this);if(!t||isNaN(t[0])||isNaN(t[1])||this.hasZ&&isNaN(t[2]))return null;const e=new mt;return e.x=t[0],e.y=t[1],e.spatialReference=this.spatialReference,this.hasZ&&(e.z=t[2]),e}get extent(){const{spatialReference:t}=this,e=Ede(this);if(!e)return null;const r=new Zr(e);return r.spatialReference=t,r}get isSelfIntersecting(){return sMe(this.rings)}writeRings(t,e){e.rings=ne(this.rings)}addRing(t){if(!t)return;const e=this.rings,r=e.length;if(IK(t)){const i=[];for(let s=0,n=t.length;s<n;s++)i[s]=t[s].toArray();e[r]=i}else e[r]=t.concat();return this.notifyChange("rings"),this}clone(){const t=new J$;return t.spatialReference=this.spatialReference,t.rings=ne(this.rings),t.hasZ=this.hasZ,t.hasM=this.hasM,t}equals(t){if(this===t)return!0;if(C(t))return!1;const e=this.spatialReference,r=t.spatialReference;if(v(e)!==v(r)||v(e)&&v(r)&&!e.equals(r)||this.rings.length!==t.rings.length)return!1;const i=([s,n,o,a],[l,c,h,p])=>s===l&&n===c&&(o==null&&h==null||o===h)&&(a==null&&p==null||a===p);for(let s=0;s<this.rings.length;s++){const n=this.rings[s],o=t.rings[s];if(!Xg(n,o,i))return!1}return!0}contains(t){if(!t)return!1;const e=Gw(t,this.spatialReference);return XOe(this,v(e)?e:t)}isClockwise(t){let e;return e=IK(t)?t.map(r=>this.hasZ?this.hasM?[r.x,r.y,r.z,r.m]:[r.x,r.y,r.z]:[r.x,r.y]):t,dde(e,this.hasM,this.hasZ)}getPoint(t,e){if(!this._validateInputs(t,e))return null;const r=this.rings[t][e],i=this.hasZ,s=this.hasM;return i&&!s?new mt(r[0],r[1],r[2],void 0,this.spatialReference):s&&!i?new mt(r[0],r[1],void 0,r[2],this.spatialReference):i&&s?new mt(r[0],r[1],r[2],r[3],this.spatialReference):new mt(r[0],r[1],this.spatialReference)}insertPoint(t,e,r){return this._validateInputs(t,e,!0)?(AS(this,r),Array.isArray(r)||(r=r.toArray()),this.rings[t].splice(e,0,r),this.notifyChange("rings"),this):this}removePoint(t,e){if(!this._validateInputs(t,e))return null;const r=new mt(this.rings[t].splice(e,1)[0],this.spatialReference);return this.notifyChange("rings"),r}removeRing(t){if(!this._validateInputs(t,null))return null;const e=this.rings.splice(t,1)[0],r=this.spatialReference,i=e.map(s=>new mt(s,r));return this.notifyChange("rings"),i}setPoint(t,e,r){return this._validateInputs(t,e)?(AS(this,r),Array.isArray(r)||(r=r.toArray()),this.rings[t][e]=r,this.notifyChange("rings"),this):this}_validateInputs(t,e,r=!1){if(t==null||t<0||t>=this.rings.length)return!1;if(e!=null){const i=this.rings[t];if(r&&(e<0||e>i.length)||!r&&(e<0||e>=i.length))return!1}return!0}toJSON(t){return this.write({},t)}};u([d({readOnly:!0})],Jp.prototype,"cache",null),u([d({readOnly:!0})],Jp.prototype,"centroid",null),u([d({readOnly:!0})],Jp.prototype,"extent",null),u([d({readOnly:!0})],Jp.prototype,"isSelfIntersecting",null),u([d({type:[[[Number]]],json:{write:{isRequired:!0}}})],Jp.prototype,"rings",void 0),u([He("rings")],Jp.prototype,"writeRings",null),Jp=J$=u([I("esri.geometry.Polygon")],Jp),Jp.prototype.toJSON.isDefaultToJSON=!0;const pp=Jp;var wV;function QPe(t){return!Array.isArray(t[0])}let b0=wV=class extends pv{constructor(...t){super(...t),this.paths=[],this.type="polyline"}normalizeCtorArgs(t,e){let r,i,s=null,n=null;return t&&!Array.isArray(t)?(s=t.paths?t.paths:null,e||(t.spatialReference?e=t.spatialReference:t.paths||(e=t)),r=t.hasZ,i=t.hasM):s=t,s=s||[],e=e||et.WGS84,s.length&&s[0]&&s[0][0]!=null&&typeof s[0][0]=="number"&&(s=[s]),n=s[0]&&s[0][0],n&&(r===void 0&&i===void 0?(r=n.length>2,i=!1):r===void 0?r=!i&&n.length>3:i===void 0&&(i=!r&&n.length>3)),{paths:s,spatialReference:e,hasZ:r,hasM:i}}get cache(){return this.commitProperty("paths"),this.commitProperty("hasZ"),this.commitProperty("hasM"),this.commitProperty("spatialReference"),{}}get extent(){const{spatialReference:t}=this,e=Cde(this);if(!e)return null;const r=new Zr(e);return r.spatialReference=t,r}writePaths(t,e){e.paths=ne(this.paths)}addPath(t){if(!t)return;const e=this.paths,r=e.length;if(QPe(t)){const i=[];for(let s=0,n=t.length;s<n;s++)i[s]=t[s].toArray();e[r]=i}else e[r]=t.concat();return this.notifyChange("paths"),this}clone(){const t=new wV;return t.spatialReference=this.spatialReference,t.paths=ne(this.paths),t.hasZ=this.hasZ,t.hasM=this.hasM,t}getPoint(t,e){if(!this._validateInputs(t,e))return null;const r=this.paths[t][e],i=this.hasZ,s=this.hasM;return i&&!s?new mt(r[0],r[1],r[2],void 0,this.spatialReference):s&&!i?new mt(r[0],r[1],void 0,r[2],this.spatialReference):i&&s?new mt(r[0],r[1],r[2],r[3],this.spatialReference):new mt(r[0],r[1],this.spatialReference)}insertPoint(t,e,r){return this._validateInputs(t,e,!0)?(AS(this,r),Array.isArray(r)||(r=r.toArray()),this.paths[t].splice(e,0,r),this.notifyChange("paths"),this):this}removePath(t){if(!this._validateInputs(t,null))return null;const e=this.paths.splice(t,1)[0],r=this.spatialReference,i=e.map(s=>new mt(s,r));return this.notifyChange("paths"),i}removePoint(t,e){if(!this._validateInputs(t,e))return null;const r=new mt(this.paths[t].splice(e,1)[0],this.spatialReference);return this.notifyChange("paths"),r}setPoint(t,e,r){return this._validateInputs(t,e)?(AS(this,r),Array.isArray(r)||(r=r.toArray()),this.paths[t][e]=r,this.notifyChange("paths"),this):this}_validateInputs(t,e,r=!1){if(t==null||t<0||t>=this.paths.length)return!1;if(e!=null){const i=this.paths[t];if(r&&(e<0||e>i.length)||!r&&(e<0||e>=i.length))return!1}return!0}toJSON(t){return this.write({},t)}};u([d({readOnly:!0})],b0.prototype,"cache",null),u([d({readOnly:!0})],b0.prototype,"extent",null),u([d({type:[[[Number]]],json:{write:{isRequired:!0}}})],b0.prototype,"paths",void 0),u([He("paths")],b0.prototype,"writePaths",null),b0=wV=u([I("esri.geometry.Polyline")],b0),b0.prototype.toJSON.isDefaultToJSON=!0;const Eu=b0,Ade=Ta()({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon"}),$K=Ta()({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryEnvelope:"extent",mesh:"mesh"});function Rde(t){return t.xmin!==void 0&&t.ymin!==void 0&&t.xmax!==void 0&&t.ymax!==void 0}function Bq(t){return t.points!==void 0}function zq(t){return t.x!==void 0&&t.y!==void 0}function Gq(t){return t.paths!==void 0}function Hb(t){return t.rings!==void 0}function il(t){return C(t)?null:t instanceof pv?t:zq(t)?mt.fromJSON(t):Gq(t)?Eu.fromJSON(t):Hb(t)?pp.fromJSON(t):Bq(t)?QO.fromJSON(t):Rde(t)?Zr.fromJSON(t):null}function vE(t){return t?zq(t)?"esriGeometryPoint":Gq(t)?"esriGeometryPolyline":Hb(t)?"esriGeometryPolygon":Rde(t)?"esriGeometryEnvelope":Bq(t)?"esriGeometryMultipoint":null:null}const eIe={esriGeometryPoint:mt,esriGeometryPolyline:Eu,esriGeometryPolygon:pp,esriGeometryEnvelope:Zr,esriGeometryMultipoint:QO};function tIe(t){return t&&eIe[t]||null}const jw={base:pv,key:"type",typeMap:{extent:Zr,multipoint:QO,point:mt,polyline:Eu,polygon:pp}};up(jw);let Ode=0;const eM=t=>{let e=class extends t{constructor(...r){super(...r),Object.defineProperty(this,"uid",{writable:!1,configurable:!1,value:Date.now().toString(16)+"-object-"+Ode++})}};return e=u([I("esri.core.Identifiable")],e),e},qwt=t=>{let e=class extends t{constructor(...r){super(...r),Object.defineProperty(this,"uid",{writable:!1,configurable:!1,value:Ode++})}};return e=u([I("esri.core.NumericIdentifiable")],e),e};let LK=class extends eM(class{}){};LK=u([I("esri.core.Identifiable")],LK);async function rIe(t){const e="portalItem"in t?t:{portalItem:t},r=await te(()=>import("./portalLayers-a50d3025.js"),["assets/portalLayers-a50d3025.js","assets/lazyLayerLoader-b79dca54.js","assets/layersLoader-c65033be.js","assets/fetchService-d31d8618.js","assets/jsonContext-999facfa.js"]);try{return await r.fromItem(e)}catch(i){const s=e&&e.portalItem,n=s&&s.id||"unset",o=s&&s.portal&&s.portal.url||Yr.portalUrl;throw se.getLogger("esri.layers.support.fromPortalItem").error("#fromPortalItem()","Failed to create layer from portal item (portal: '"+o+"', id: '"+n+"')",i),i}}let iIe=0,po=class extends vs.EventedMixin(eM(Zg)){constructor(){super(...arguments),this.attributionDataUrl=null,this.fullExtent=new Zr(-180,-90,180,90,et.WGS84),this.id=Date.now().toString(16)+"-layer-"+iIe++,this.legendEnabled=!0,this.listMode="show",this.opacity=1,this.parent=null,this.popupEnabled=!0,this.attributionVisible=!0,this.spatialReference=et.WGS84,this.title=null,this.type=null,this.url=null,this.visible=!0}static async fromArcGISServerUrl(e){const r=typeof e=="string"?{url:e}:e;return(await te(()=>import("./arcgisLayers-2df6e08e.js"),["assets/arcgisLayers-2df6e08e.js","assets/fetchService-d31d8618.js","assets/lazyLayerLoader-b79dca54.js"])).fromUrl(r)}static fromPortalItem(e){return rIe(e)}initialize(){this.when().catch(e=>{Qs(e)||se.getLogger(this.declaredClass).error("#load()",`Failed to load layer (title: '${this.title??"no title"}', id: '${this.id??"no id"}')`,{error:e})})}destroy(){if(this.parent){const e=this,r=this.parent;"layers"in r&&r.layers.includes(e)?r.layers.remove(e):"tables"in r&&r.tables.includes(e)?r.tables.remove(e):"baseLayers"in r&&r.baseLayers.includes(e)?r.baseLayers.remove(e):"baseLayers"in r&&r.referenceLayers.includes(e)&&r.referenceLayers.remove(e)}}get hasAttributionData(){return this.attributionDataUrl!=null}get parsedUrl(){return sl(this.url)}async fetchAttributionData(){const e=this.attributionDataUrl;if(this.hasAttributionData&&e)return(await Ni(e,{query:{f:"json"},responseType:"json"})).data;throw new q("layer:no-attribution-data","Layer does not have attribution data")}};u([d({type:String})],po.prototype,"attributionDataUrl",void 0),u([d({type:Zr})],po.prototype,"fullExtent",void 0),u([d({readOnly:!0})],po.prototype,"hasAttributionData",null),u([d({type:String,clonable:!1})],po.prototype,"id",void 0),u([d({type:Boolean,nonNullable:!0})],po.prototype,"legendEnabled",void 0),u([d({type:["show","hide","hide-children"]})],po.prototype,"listMode",void 0),u([d({type:Number,range:{min:0,max:1},nonNullable:!0})],po.prototype,"opacity",void 0),u([d({clonable:!1})],po.prototype,"parent",void 0),u([d({readOnly:!0})],po.prototype,"parsedUrl",null),u([d({type:Boolean})],po.prototype,"popupEnabled",void 0),u([d({type:Boolean})],po.prototype,"attributionVisible",void 0),u([d({type:et})],po.prototype,"spatialReference",void 0),u([d({type:String})],po.prototype,"title",void 0),u([d({readOnly:!0,json:{read:!1}})],po.prototype,"type",void 0),u([d()],po.prototype,"url",void 0),u([d({type:Boolean,nonNullable:!0})],po.prototype,"visible",void 0),po=u([I("esri.layers.Layer")],po);const cN=po;function xV(t,e,r){let i,s;if(t)for(let n=0,o=t.length;n<o;n++){if(i=t.getItemAt(n),i[e]===r)return i;if((i==null?void 0:i.type)==="group"&&(s=xV(i.layers,e,r),s))return s}}const sIe=t=>{let e=class extends t{constructor(...r){super(...r),this.layers=new Pt;const i=o=>{o.parent&&"remove"in o.parent&&o.parent.remove(o)},s=o=>{o.parent=this,this.layerAdded(o),o.type!=="elevation"&&o.type!=="base-elevation"||se.getLogger(this.declaredClass).error(`Layer 'title:${o.title}, id:${o.id}' of type '${o.type}' is not supported as an operational layer and will therefore be ignored.`)},n=o=>{o.parent=null,this.layerRemoved(o)};this.layers.on("before-add",o=>i(o.item)),this.layers.on("after-add",o=>s(o.item)),this.layers.on("after-remove",o=>n(o.item))}destroy(){const r=this.layers.removeAll();for(const i of r)this.layerRemoved(i),i.destroy();this.layers.destroy()}set layers(r){this._set("layers",aw(r,this._get("layers")))}add(r,i){const s=this.layers;if(i=s.getNextIndex(i),r instanceof cN){const n=r;n.parent===this?this.reorder(n,i):s.add(n,i)}else Uu(r)?r.then(n=>{this.destroyed||this.add(n,i)}):se.getLogger(this.declaredClass).error("#add()","The item being added is not a Layer or a Promise that resolves to a Layer.")}addMany(r,i){const s=this.layers;let n=s.getNextIndex(i);r.slice().forEach(o=>{o.parent!==this?(s.add(o,n),n+=1):this.reorder(o,n)})}findLayerById(r){return xV(this.layers,"id",r)}findLayerByUid(r){return xV(this.layers,"uid",r)}remove(r){return this.layers.remove(r)}removeMany(r){return this.layers.removeMany(r)}removeAll(){return this.layers.removeAll()}reorder(r,i){return this.layers.reorder(r,i)}layerAdded(r){}layerRemoved(r){}};return u([d()],e.prototype,"layers",null),e=u([I("esri.support.LayersMixin")],e),e};function TV(t,e,r){if(t)for(let i=0,s=t.length;i<s;i++){const n=t.getItemAt(i);if(n[e]===r)return n;if((n==null?void 0:n.type)==="group"){const o=TV(n.tables,e,r);if(o)return o}}}const nIe=t=>{let e=class extends t{constructor(...r){super(...r),this.tables=new Pt,this.tables.on("after-add",i=>{const s=i.item;s.parent&&s.parent!==this&&"tables"in s.parent&&s.parent.tables.remove(s),s.parent=this,s.type!=="feature"&&se.getLogger(this.declaredClass).error(`Layer 'title:${s.title}, id:${s.id}' of type '${s.type}' is not supported as a table and will therefore be ignored.`)}),this.tables.on("after-remove",i=>{i.item.parent=null})}destroy(){const r=this.tables.removeAll();for(const i of r)i.destroy();this.tables.destroy()}set tables(r){this._set("tables",aw(r,this._get("tables")))}findTableById(r){return TV(this.tables,"id",r)}findTableByUid(r){return TV(this.tables,"uid",r)}};return u([d()],e.prototype,"tables",null),e=u([I("esri.support.TablesMixin")],e),e};let Kp=class extends nIe(sIe(vs.EventedMixin(Te))){constructor(e){super(e),this.allLayers=new VR({getCollections:()=>{var r,i,s;return[(r=this.basemap)==null?void 0:r.baseLayers,(i=this.ground)==null?void 0:i.layers,this.layers,(s=this.basemap)==null?void 0:s.referenceLayers]},getChildrenFunction:r=>"layers"in r?r.layers:null}),this.allTables=LPe(this),this.basemap=null,this.editableLayers=new VR({getCollections:()=>[this.allLayers],itemFilterFunction:MPe}),this.ground=new lN,this._basemapCache=PPe()}destroy(){var e,r;this.allLayers.destroy(),this.allTables.destroy(),this.editableLayers.destroy(),(e=this.ground)==null||e.destroy(),(r=this.basemap)==null||r.destroy(),IPe(this._basemapCache),this._basemapCache=null}castBasemap(e){return $Pe(e,this._basemapCache)}castGround(e){const r=DPe(e);return C(r)?this._get("ground"):r}findLayerById(e){return this.allLayers.find(r=>r.id===e)}findTableById(e){return this.allTables.find(r=>r.id===e)}};u([d({readOnly:!0,dependsOn:[]})],Kp.prototype,"allLayers",void 0),u([d({readOnly:!0})],Kp.prototype,"allTables",void 0),u([d({type:iN})],Kp.prototype,"basemap",void 0),u([cr("basemap")],Kp.prototype,"castBasemap",null),u([d({readOnly:!0})],Kp.prototype,"editableLayers",void 0),u([d({type:lN,nonNullable:!0})],Kp.prototype,"ground",void 0),u([cr("ground")],Kp.prototype,"castGround",null),Kp=u([I("esri.Map")],Kp);const Mde=Kp,bs=t=>{let e=class extends t{clone(){var l;const r=Dl(Qa(this),"unable to clone instance of non-accessor class"),i=r.metadatas,s=r.store,n={},o=new Map;for(const c in i){const h=i[c],p=s==null?void 0:s.originOf(c),f=h.clonable;if(h.readOnly||f===!1||p!==Gr.USER&&p!==Gr.DEFAULTS&&p!==Gr.WEB_MAP&&p!==Gr.WEB_SCENE)continue;const m=this[c];let y=null;y=typeof f=="function"?f(m):f==="reference"?m:Nk(m),m!=null&&y==null||(p===Gr.DEFAULTS?o.set(c,y):n[c]=y)}const a=new(Object.getPrototypeOf(this)).constructor(n);if(o.size){const c=(l=Qa(a))==null?void 0:l.store;if(c)for(const[h,p]of o)c.set(h,p,Gr.DEFAULTS)}return a}};return e=u([I("esri.core.Clonable")],e),e};let DK=class extends bs(Te){};DK=u([I("esri.core.Clonable")],DK);let W_=class{constructor(e,r){this.min=e,this.max=r,this.range=r-e}ndiff(e,r=0){return Math.ceil((e-r)/this.range)*this.range+r}_normalize(e,r,i,s=0,n=!1){return(i-=s)<e?i+=this.ndiff(e-i):i>r&&(i-=this.ndiff(i-r)),n&&i===r&&(i=e),i+s}normalize(e,r=0,i=!1){return this._normalize(this.min,this.max,e,r,i)}clamp(e,r=0){return ge(e-r,this.min,this.max)+r}monotonic(e,r,i){return e<r?r:r+this.ndiff(e-r,i)}minimalMonotonic(e,r,i){return this._normalize(e,e+this.range,r,i)}center(e,r,i){return r=this.monotonic(e,r,i),this.normalize((e+r)/2,i)}diff(e,r,i){return this.monotonic(e,r,i)-e}shortestSignedDiff(e,r){e=this.normalize(e);const i=(r=this.normalize(r))-e,s=r<e?this.minimalMonotonic(e,r)-e:r-this.minimalMonotonic(r,e);return Math.abs(i)<Math.abs(s)?i:s}contains(e,r,i){return r=this.minimalMonotonic(e,r),(i=this.minimalMonotonic(e,i))>e&&i<r}};function jq(t){for(const e in t){const r=t[e];r instanceof Function&&(t[e]=r.bind(t))}return t}const oIe=jq(new W_(0,2*Math.PI)),X_=jq(new W_(-Math.PI,Math.PI)),Hq=jq(new W_(0,360));let Jm=class extends bs(ve){constructor(...e){super(...e),this.position=new mt([0,0,0]),this.heading=0,this.tilt=0,this.fov=55}normalizeCtorArgs(e,r,i,s){if(e&&typeof e=="object"&&("x"in e||Array.isArray(e))){const n={position:e};return r!=null&&(n.heading=r),i!=null&&(n.tilt=i),s!=null&&(n.fov=s),n}return e}writePosition(e,r,i,s){const n=e.clone();n.x=bh(e.x||0),n.y=bh(e.y||0),n.z=e.hasZ?bh(e.z||0):e.z,r[i]=n.write({},s)}readPosition(e,r){const i=new mt;return i.read(e,r),i.x=bh(i.x||0),i.y=bh(i.y||0),i.z=i.hasZ?bh(i.z||0):i.z,i}equals(e){return!C(e)&&this.tilt===e.tilt&&this.heading===e.heading&&this.fov===e.fov&&this.position.equals(e.position)}};u([d({type:mt,json:{write:{isRequired:!0}}})],Jm.prototype,"position",void 0),u([He("position")],Jm.prototype,"writePosition",null),u([Fe("position")],Jm.prototype,"readPosition",null),u([d({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),cr(t=>Hq.normalize(bh(t)))],Jm.prototype,"heading",void 0),u([d({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),cr(t=>ge(bh(t),-180,180))],Jm.prototype,"tilt",void 0),u([d({type:Number,nonNullable:!0,json:{read:!1,write:!1}})],Jm.prototype,"fov",void 0),Jm=u([I("esri.Camera")],Jm);const kh=Jm;var OS;function aIe(t,e){switch(t.type){case"range":{const r="range"in t?t.range[0]:t.minValue,i="range"in t?t.range[1]:t.maxValue;if(r!=null&&+e<r||i!=null&&+e>i)return OS.VALUE_OUT_OF_RANGE;break}case"coded-value":case"codedValue":if(t.codedValues==null||t.codedValues.every(r=>r==null||r.code!==e))return OS.INVALID_CODED_VALUE}return null}(function(t){t.VALUE_OUT_OF_RANGE="domain-validation-error::value-out-of-range",t.INVALID_CODED_VALUE="domain-validation-error::invalid-coded-value"})(OS||(OS={}));const lIe=se.getLogger("esri.support.arcadeOnDemand");let F6;function sm(){return F6||(F6=(async()=>{const t=await te(()=>import("./arcadeUtils-58980892.js").then(e=>e.ax),["assets/arcadeUtils-58980892.js","assets/arcadeTimeUtils-8aa77359.js","assets/executionError-fb3f283a.js","assets/number-cd7d5381.js","assets/hash-0ddfbf4b.js"]);return{arcade:t.arcade,arcadeUtils:t,Dictionary:t.Dictionary,Feature:t.arcadeFeature}})()),F6}const cIe=(t,e,r)=>qq.create(t,e,r,null,["$feature"]),uIe=(t,e,r)=>qq.create(t,e,r,null,["$feature","$view"]),hIe=(t,e,r,i)=>qq.create(t,e,r,i,["$feature","$view"]);let qq=class Pde{constructor(e,r,i,s,n,o,a){this.script=e,this.evaluate=s;const l=Array.isArray(o)?o:o.fields;this.fields=l,this._syntaxTree=i,this._arcade=r,this._arcadeFeature=n,this._spatialReference=a,this._referencesGeometry=r.scriptTouchesGeometry(this._syntaxTree),this._referencesScale=this._arcade.referencesMember(this._syntaxTree,"scale")}static async create(e,r,i,s,n,o){const{arcade:a,Feature:l,Dictionary:c}=await sm(),h=et.fromJSON(r);let p;try{p=a.parseScript(e,o)}catch(P){return lIe.error(new q("arcade-bad-expression","Failed to parse arcade script",{script:e,error:P})),null}const f=n.reduce((P,U)=>({...P,[U]:null}),{});let m=null;v(s)&&(m=new c(s),m.immutable=!0,f.$config=null);const y=a.scriptUsesGeometryEngine(p),_=y&&a.enableGeometrySupport(),b=a.scriptUsesFeatureSet(p)&&a.enableFeatureSetSupport(),x=a.scriptIsAsync(p),T=x&&a.enableAsyncSupport(),S={vars:f,spatialReference:h,useAsync:!!T};await Promise.all([_,b,T]);const E=new Set;await a.loadDependentModules(E,p,null,x,y);const O=new c;O.immutable=!1,O.setField("scale",0);const R=a.compileScript(p,S),L=P=>("$view"in P&&P.$view&&(O.setField("scale",typeof P.$view=="object"?P.$view.scale:void 0),P.$view=O),m&&(P.$config=m),R({vars:P,spatialReference:h}));return new Pde(e,a,p,L,new l,i,h)}repurposeFeature(e){return e.geometry&&!e.geometry.spatialReference&&(e.geometry.spatialReference=this._spatialReference),this._arcadeFeature.repurposeFromGraphicLikeObject(e.geometry,e.attributes,{fields:this.fields}),this._arcadeFeature}referencesGeometry(){return this._referencesGeometry}referencesScale(){return this._referencesScale}};const dIe=/^([0-9])/,pIe=/[^a-z0-9_\u0080-\uffff]/gi,fIe=/_{2,}/g,mIe=/^_/,gIe=/_$/;function yIe(t){return t==null?null:t.trim().replace(pIe,"_").replace(fIe,"_").replace(mIe,"").replace(gIe,"").replace(dIe,"F$1")||null}const _Ie=["field","field2","field3","normalizationField","rotationInfo.field","proportionalSymbolInfo.field","proportionalSymbolInfo.normalizationField","colorInfo.field","colorInfo.normalizationField"],vIe=["field","normalizationField"];function NK(t,e){if(t!=null&&e!=null){for(const r of Array.isArray(t)?t:[t])if(FK(_Ie,r,e),"visualVariables"in r&&r.visualVariables)for(const i of r.visualVariables)FK(vIe,i,e)}}function FK(t,e,r){if(t)for(const i of t){const s=HO(i,e),n=s&&typeof s!="function"&&r.get(s);n&&el(i,n.name,e)}}function Ide(t,e){var r;if(t!=null&&((r=e==null?void 0:e.fields)!=null&&r.length))if("startField"in t){const i=e.get(t.startField),s=e.get(t.endField);t.startField=(i==null?void 0:i.name)??null,t.endField=(s==null?void 0:s.name)??null}else{const i=e.get(t.startTimeField),s=e.get(t.endTimeField);t.startTimeField=(i==null?void 0:i.name)??null,t.endTimeField=(s==null?void 0:s.name)??null}}const U6=new Set;function $de(t,e){return t&&e?(U6.clear(),BR(U6,t,e),Array.from(U6).sort()):[]}function BR(t,e,r){var i;if(r)if((i=e==null?void 0:e.fields)!=null&&i.length)if(r.includes("*"))for(const{name:s}of e.fields)t.add(s);else for(const s of r)Ru(t,e,s);else{if(r.includes("*"))return t.clear(),void t.add("*");for(const s of r)s!=null&&t.add(s)}}function Ru(t,e,r){if(typeof r=="string")if(e){const i=e.get(r);i&&t.add(i.name)}else t.add(r)}function Qwt(t,e){return C(e)||C(t)?[]:e.includes("*")?(t.fields??[]).map(r=>r.name):e}async function Hl(t,e,r){var n;if(!r)return;const{arcadeUtils:i}=await sm(),s=i.extractFieldNames(r,(n=e==null?void 0:e.fields)==null?void 0:n.map(o=>o.name));for(const o of s)Ru(t,e,o)}async function Lde(t,e,r){if(r&&r!=="1=1"){const i=(await te(()=>import("./WhereClause-2e7ef2fe.js").then(s=>s.W),["assets/WhereClause-2e7ef2fe.js","assets/executionError-fb3f283a.js"])).WhereClause.create(r,e);if(!i.isStandardized)throw new q("fieldUtils:collectFilterFields","Where clause is not standardized",{where:r});BR(t,e,i.fieldNames)}}function bIe({displayField:t,fields:e}){return t||(e&&e.length?k6(e,"name-or-title")||k6(e,"unique-identifier")||k6(e,"type-or-category")||wIe(e):null)}function wIe(t){for(const e of t){if(!e||!e.name)continue;const r=e.name.toLowerCase();if(r.includes("name")||r.includes("title"))return e.name}return null}function k6(t,e){for(const r of t)if(r&&r.valueType&&r.valueType===e)return r.name;return null}async function ext(t,e){var i;if(!e)return;const r=(i=e.elevationInfo)==null?void 0:i.featureExpressionInfo;return r?r.collectRequiredFields(t,e.fieldsIndex):void 0}function xIe(t,e,r){r.onStatisticExpression?Hl(t,e,r.onStatisticExpression.expression):t.add(r.onStatisticField)}async function txt(t,e,r){if(!e||!r||!("fields"in r))return;const i=[],s=r.popupTemplate;i.push(TIe(t,e,s)),r.fields&&i.push(...r.fields.map(async n=>xIe(t,e.fieldsIndex,n))),await Promise.all(i)}async function TIe(t,e,r){const i=[];r!=null&&r.expressionInfos&&i.push(...r.expressionInfos.map(n=>Hl(t,e.fieldsIndex,n.expression)));const s=r==null?void 0:r.content;if(Array.isArray(s))for(const n of s)n.type==="expression"&&n.expressionInfo&&i.push(Hl(t,e.fieldsIndex,n.expressionInfo.expression));await Promise.all(i)}async function rxt(t,e,r){e&&(e.timeInfo&&v(r)&&r.timeExtent&&BR(t,e.fieldsIndex,[e.timeInfo.startField,e.timeInfo.endField]),e.floorInfo&&BR(t,e.fieldsIndex,[e.floorInfo.floorField]),v(r)&&v(r.where)&&await Lde(t,e.fieldsIndex,r.where))}async function ixt(t,e,r){e&&r&&await Promise.all(r.map(i=>SIe(t,e,i)))}async function SIe(t,e,r){e&&r&&(r.valueExpression?await Hl(t,e.fieldsIndex,r.valueExpression):r.field&&Ru(t,e.fieldsIndex,r.field))}function sxt(t){if(!t)return[];const e="editFieldsInfo"in t&&t.editFieldsInfo;return e?$de(t.fieldsIndex,[e&&e.creatorField,e&&e.creationDateField,e&&e.editorField,e&&e.editDateField]):[]}async function nxt(t,e){const{labelingInfo:r,fieldsIndex:i}=e;r&&r.length&&await Promise.all(r.map(s=>EIe(t,i,s)))}async function EIe(t,e,r){if(!r)return;const i=r.getLabelExpression(),s=r.where;if(i.type==="arcade")await Hl(t,e,i.expression);else{const n=i.expression.match(/{[^}]*}/g);n&&n.forEach(o=>{Ru(t,e,o.slice(1,-1))})}await Lde(t,e,s)}function CIe(t){const e=t.defaultValue;return e!==void 0&&Fde(t,e)?e:t.nullable?null:void 0}function Dde(t){return typeof t=="number"&&!isNaN(t)&&isFinite(t)}function AIe(t){return t===null||Dde(t)}const Wq="isInteger"in Number?Number.isInteger:t=>typeof t=="number"&&isFinite(t)&&Math.floor(t)===t;function RIe(t){return t===null||Wq(t)}function Nde(t){return t!=null&&typeof t=="string"}function OIe(t){return t===null||Nde(t)}function MIe(){return!0}function Fde(t,e){let r;switch(t.type){case"date":case"integer":case"long":case"small-integer":case"esriFieldTypeDate":case"esriFieldTypeInteger":case"esriFieldTypeLong":case"esriFieldTypeSmallInteger":r=t.nullable?RIe:Wq;break;case"double":case"single":case"esriFieldTypeSingle":case"esriFieldTypeDouble":r=t.nullable?AIe:Dde;break;case"string":case"esriFieldTypeString":r=t.nullable?OIe:Nde;break;default:r=MIe}return arguments.length===1?r:r(e)}const PIe=["integer","small-integer","single","double"],IIe=new Set([...PIe,"esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"]);function m4(t){return t!=null&&IIe.has(t.type)}function oxt(t){return t!=null&&(t.type==="string"||t.type==="esriFieldTypeString")}var uN,hN;function axt(t){return t==null||typeof t=="number"&&isNaN(t)?null:t}function lxt(t,e){return t==null||t.nullable&&e===null?null:m4(t)&&!$Ie(t.type,Number(e))?uN.OUT_OF_RANGE:Fde(t,e)?t.domain?aIe(t.domain,e):null:hN.INVALID_TYPE}function $Ie(t,e){const r=typeof t=="string"?Ude(t):t;if(!r)return!1;const i=r.min,s=r.max;return r.isInteger?Wq(e)&&e>=i&&e<=s:e>=i&&e<=s}function Ude(t){switch(t){case"esriFieldTypeSmallInteger":case"small-integer":return LIe;case"esriFieldTypeInteger":case"integer":return DIe;case"esriFieldTypeSingle":case"single":return NIe;case"esriFieldTypeDouble":case"double":return FIe}}(function(t){t.OUT_OF_RANGE="numeric-range-validation-error::out-of-range"})(uN||(uN={})),function(t){t.INVALID_TYPE="type-validation-error::invalid-type"}(hN||(hN={}));const LIe={min:-32768,max:32767,isInteger:!0},DIe={min:-2147483648,max:2147483647,isInteger:!0},NIe={min:-34e37,max:12e37,isInteger:!1},FIe={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1};function cxt(t,e,r){switch(t){case OS.INVALID_CODED_VALUE:return`Value ${r} is not in the coded domain - field: ${e.name}, domain: ${JSON.stringify(e.domain)}`;case OS.VALUE_OUT_OF_RANGE:return`Value ${r} is out of the range of valid values - field: ${e.name}, domain: ${JSON.stringify(e.domain)}`;case hN.INVALID_TYPE:return`Value ${r} is not a valid value for the field type - field: ${e.name}, type: ${e.type}, nullable: ${e.nullable}`;case uN.OUT_OF_RANGE:{const{min:i,max:s}=Ude(e.type);return`Value ${r} is out of range for the number type - field: ${e.name}, type: ${e.type}, value range is ${i} to ${s}`}}}function UIe(t,e){return!kIe(t,e,null)}function kIe(t,e,r){if(!e||!e.attributes||!t){if(v(r))for(const n of t??[])r.add(n);return!0}const i=e.attributes;let s=!1;for(const n of t)if(!(n in i)){if(s=!0,!v(r))break;r.add(n)}return s}function kde(t){return!!t&&["raster.itempixelvalue","raster.servicepixelvalue"].some(e=>t.toLowerCase().startsWith(e))}let K$=class extends ve{constructor(e){super(e),this.type=null}};u([d({type:["attachments","custom","fields","media","text","expression","relationship"],readOnly:!0,json:{read:!1,write:!0}})],K$.prototype,"type",void 0),K$=u([I("esri.popup.content.Content")],K$);const fv=K$;var SV;let y1=SV=class extends fv{constructor(t){super(t),this.description=null,this.displayType="auto",this.title=null,this.type="attachments"}clone(){return new SV({description:this.description,displayType:this.displayType,title:this.title})}};u([d({type:String,json:{write:!0}})],y1.prototype,"description",void 0),u([d({type:["auto","preview","list"],json:{write:!0}})],y1.prototype,"displayType",void 0),u([d({type:String,json:{write:!0}})],y1.prototype,"title",void 0),u([d({type:["attachments"],readOnly:!0,json:{read:!1,write:!0}})],y1.prototype,"type",void 0),y1=SV=u([I("esri.popup.content.AttachmentsContent")],y1);const zR=y1;var EV;let _1=EV=class extends fv{constructor(t){super(t),this.creator=null,this.destroyer=null,this.outFields=null,this.type="custom"}clone(){return new EV({creator:this.creator,destroyer:this.destroyer,outFields:Array.isArray(this.outFields)?ne(this.outFields):null})}};u([d()],_1.prototype,"creator",void 0),u([d()],_1.prototype,"destroyer",void 0),u([d()],_1.prototype,"outFields",void 0),u([d({type:["custom"],readOnly:!0})],_1.prototype,"type",void 0),_1=EV=u([I("esri.popup.content.CustomContent")],_1);const VIe=_1;var CV;let _T=CV=class extends ve{constructor(t){super(t),this.title=null,this.expression=null,this.returnType="dictionary"}clone(){return new CV({title:this.title,expression:this.expression})}};u([d({type:String,json:{write:!0}})],_T.prototype,"title",void 0),u([d({type:String,json:{write:!0}})],_T.prototype,"expression",void 0),u([d({type:["dictionary"],readOnly:!0,json:{read:!1,write:!0}})],_T.prototype,"returnType",void 0),_T=CV=u([I("esri.popup.ElementExpressionInfo")],_T);const Vde=_T;var AV;let pA=AV=class extends fv{constructor(t){super(t),this.expressionInfo=null,this.type="expression"}clone(){var t;return new AV({expressionInfo:(t=this.expressionInfo)==null?void 0:t.clone()})}};u([d({type:Vde,json:{write:!0}})],pA.prototype,"expressionInfo",void 0),u([d({type:["expression"],readOnly:!0,json:{read:!1,write:!0}})],pA.prototype,"type",void 0),pA=AV=u([I("esri.popup.content.ExpressionContent")],pA);const Xq=pA,GR=Ta()({shortDate:"short-date",shortDateShortTime:"short-date-short-time",shortDateShortTime24:"short-date-short-time-24",shortDateLongTime:"short-date-long-time",shortDateLongTime24:"short-date-long-time-24",shortDateLE:"short-date-le",shortDateLEShortTime:"short-date-le-short-time",shortDateLEShortTime24:"short-date-le-short-time-24",shortDateLELongTime:"short-date-le-long-time",shortDateLELongTime24:"short-date-le-long-time-24",longMonthDayYear:"long-month-day-year",longMonthDayYearShortTime:"long-month-day-year-short-time",longMonthDayYearShortTime24:"long-month-day-year-short-time-24",longMonthDayYearLongTime:"long-month-day-year-long-time",longMonthDayYearLongTime24:"long-month-day-year-long-time-24",dayShortMonthYear:"day-short-month-year",dayShortMonthYearShortTime:"day-short-month-year-short-time",dayShortMonthYearShortTime24:"day-short-month-year-short-time-24",dayShortMonthYearLongTime:"day-short-month-year-long-time",dayShortMonthYearLongTime24:"day-short-month-year-long-time-24",longDate:"long-date",longDateShortTime:"long-date-short-time",longDateShortTime24:"long-date-short-time-24",longDateLongTime:"long-date-long-time",longDateLongTime24:"long-date-long-time-24",longMonthYear:"long-month-year",shortMonthYear:"short-month-year",year:"year"});GR.toJSON.bind(GR);GR.fromJSON.bind(GR);const Op={year:"numeric",month:"numeric",day:"numeric"},tC={year:"numeric",month:"long",day:"numeric"},rC={year:"numeric",month:"short",day:"numeric"},iC={year:"numeric",month:"long",weekday:"long",day:"numeric"},ih={hour:"numeric",minute:"numeric"},rd={...ih,second:"numeric"},Yq={"short-date":Op,"short-date-short-time":{...Op,...ih},"short-date-short-time-24":{...Op,...ih,hour12:!1},"short-date-long-time":{...Op,...rd},"short-date-long-time-24":{...Op,...rd,hour12:!1},"short-date-le":Op,"short-date-le-short-time":{...Op,...ih},"short-date-le-short-time-24":{...Op,...ih,hour12:!1},"short-date-le-long-time":{...Op,...rd},"short-date-le-long-time-24":{...Op,...rd,hour12:!1},"long-month-day-year":tC,"long-month-day-year-short-time":{...tC,...ih},"long-month-day-year-short-time-24":{...tC,...ih,hour12:!1},"long-month-day-year-long-time":{...tC,...rd},"long-month-day-year-long-time-24":{...tC,...rd,hour12:!1},"day-short-month-year":rC,"day-short-month-year-short-time":{...rC,...ih},"day-short-month-year-short-time-24":{...rC,...ih,hour12:!1},"day-short-month-year-long-time":{...rC,...rd},"day-short-month-year-long-time-24":{...rC,...rd,hour12:!1},"long-date":iC,"long-date-short-time":{...iC,...ih},"long-date-short-time-24":{...iC,...ih,hour12:!1},"long-date-long-time":{...iC,...rd},"long-date-long-time-24":{...iC,...rd,hour12:!1},"long-month-year":{month:"long",year:"numeric"},"short-month-year":{month:"short",year:"numeric"},year:{year:"numeric"},"short-time":ih,"long-time":rd},jR=Ta()({shortDate:"short-date",shortDateShortTime:"short-date-short-time",shortDateShortTime24:"short-date-short-time-24",shortDateLongTime:"short-date-long-time",shortDateLongTime24:"short-date-long-time-24",shortDateLE:"short-date-le",shortDateLEShortTime:"short-date-le-short-time",shortDateLEShortTime24:"short-date-le-short-time-24",shortDateLELongTime:"short-date-le-long-time",shortDateLELongTime24:"short-date-le-long-time-24",longMonthDayYear:"long-month-day-year",longMonthDayYearShortTime:"long-month-day-year-short-time",longMonthDayYearShortTime24:"long-month-day-year-short-time-24",longMonthDayYearLongTime:"long-month-day-year-long-time",longMonthDayYearLongTime24:"long-month-day-year-long-time-24",dayShortMonthYear:"day-short-month-year",dayShortMonthYearShortTime:"day-short-month-year-short-time",dayShortMonthYearShortTime24:"day-short-month-year-short-time-24",dayShortMonthYearLongTime:"day-short-month-year-long-time",dayShortMonthYearLongTime24:"day-short-month-year-long-time-24",longDate:"long-date",longDateShortTime:"long-date-short-time",longDateShortTime24:"long-date-short-time-24",longDateLongTime:"long-date-long-time",longDateLongTime24:"long-date-long-time-24",longMonthYear:"long-month-year",shortMonthYear:"short-month-year",year:"year"});jR.apiValues;jR.toJSON.bind(jR);jR.fromJSON.bind(jR);const BIe={ar:"ar-u-nu-latn-ca-gregory"};let RV=new WeakMap,Bde=Yq["short-date-short-time"];function zIe(t){const e=t||Bde;let r=RV.get(e);if(!r){const i=Ih(),s=BIe[Ih()]||i;r=new Intl.DateTimeFormat(s,e),RV.set(e,r)}return r}function g4(t){return t?Yq[t]:null}function nm(t,e){return zIe(e).format(t)}Sq(()=>{RV=new WeakMap,Bde=Yq["short-date-short-time"]});const GIe={ar:"ar-u-nu-latn"};let Q$=new WeakMap,zde={};function jIe(t){const e=t||zde;if(!Q$.has(e)){const r=Ih(),i=GIe[Ih()]||r;Q$.set(e,new Intl.NumberFormat(i,t))}return Q$.get(e)}function Gde(t={}){const e={};return t.digitSeparator!=null&&(e.useGrouping=t.digitSeparator),t.places!=null&&(e.minimumFractionDigits=e.maximumFractionDigits=t.places),e}function om(t,e){return t===-0&&(t=0),jIe(e).format(t)}Sq(()=>{Q$=new WeakMap,zde={}});var OV;let v1=OV=class extends ve{constructor(t){super(t),this.dateFormat=null,this.dateTimeFormatOptions=null,this.digitSeparator=!1,this.places=null}clone(){return new OV({dateFormat:this.dateFormat,digitSeparator:this.digitSeparator,places:this.places})}format(t){return this.dateFormat?nm(t,{...g4(this.dateFormat),...this.dateTimeFormatOptions}):om(t,Gde(this))}formatRasterPixelValue(t){if(t.includes("-"))return t;let e,r;return t.trim().includes(",")?(e=",",r=e+" ",this._formatDelimitedString(t,e,r,this)):t.trim().includes(";")?(e=";",r=e+" ",this._formatDelimitedString(t,e,r,this)):t.trim().includes(" ")?(e=r=" ",this._formatDelimitedString(t,e,r,this)):this.format(Number(t))}_formatDelimitedString(t,e,r,i){return t&&e&&r&&i?t.trim().split(e).map(s=>this.format(Number(s))).join(r):t}};u([gt(GR)],v1.prototype,"dateFormat",void 0),u([d({type:Object,json:{read:!1}})],v1.prototype,"dateTimeFormatOptions",void 0),u([d({type:Boolean,json:{write:!0}})],v1.prototype,"digitSeparator",void 0),u([d({type:Gi,json:{write:!0}})],v1.prototype,"places",void 0),v1=OV=u([I("esri.popup.support.FieldInfoFormat")],v1);const v2=v1;var MV;let pd=MV=class extends ve{constructor(t){super(t),this.fieldName=null,this.format=null,this.isEditable=!1,this.label=null,this.stringFieldOption="text-box",this.statisticType=null,this.tooltip=null,this.visible=!0}clone(){return new MV({fieldName:this.fieldName,format:this.format?ne(this.format):null,isEditable:this.isEditable,label:this.label,stringFieldOption:this.stringFieldOption,statisticType:this.statisticType,tooltip:this.tooltip,visible:this.visible})}};u([d({type:String,json:{write:!0}})],pd.prototype,"fieldName",void 0),u([d({type:v2,json:{write:!0}})],pd.prototype,"format",void 0),u([d({type:Boolean,json:{write:!0,default:!1}})],pd.prototype,"isEditable",void 0),u([d({type:String,json:{write:!0}})],pd.prototype,"label",void 0),u([gt(new mr({richtext:"rich-text",textarea:"text-area",textbox:"text-box"}),{default:"text-box"})],pd.prototype,"stringFieldOption",void 0),u([d({type:["count","sum","min","max","avg","stddev","var"],json:{write:!0}})],pd.prototype,"statisticType",void 0),u([d({type:String,json:{write:!0}})],pd.prototype,"tooltip",void 0),u([d({type:Boolean,json:{write:!0}})],pd.prototype,"visible",void 0),pd=MV=u([I("esri.popup.FieldInfo")],pd);const tM=pd;var PV;let Km=PV=class extends fv{constructor(t){super(t),this.attributes=null,this.description=null,this.fieldInfos=null,this.title=null,this.type="fields"}writeFieldInfos(t,e){e.fieldInfos=t&&t.map(r=>r.toJSON())}clone(){return new PV(ne({attributes:this.attributes,description:this.description,fieldInfos:this.fieldInfos,title:this.title}))}};u([d({type:Object,json:{write:!0}})],Km.prototype,"attributes",void 0),u([d({type:String,json:{write:!0}})],Km.prototype,"description",void 0),u([d({type:[tM]})],Km.prototype,"fieldInfos",void 0),u([He("fieldInfos")],Km.prototype,"writeFieldInfos",null),u([d({type:String,json:{write:!0}})],Km.prototype,"title",void 0),u([d({type:["fields"],readOnly:!0,json:{read:!1,write:!0}})],Km.prototype,"type",void 0),Km=PV=u([I("esri.popup.content.FieldsContent")],Km);const MS=Km;let b1=class extends ve{constructor(e){super(e),this.altText=null,this.caption="",this.title="",this.type=null}};u([d({type:String,json:{write:!0}})],b1.prototype,"altText",void 0),u([d({type:String,json:{write:!0}})],b1.prototype,"caption",void 0),u([d({type:String,json:{write:!0}})],b1.prototype,"title",void 0),u([d({type:["image","bar-chart","column-chart","line-chart","pie-chart"],readOnly:!0,json:{read:!1,write:!0}})],b1.prototype,"type",void 0),b1=u([I("esri.popup.content.mixins.MediaInfo")],b1);const Zq=b1;var IV;let vT=IV=class extends Te{constructor(t){super(t),this.fieldName=null,this.tooltip=null,this.value=null}clone(){return new IV({fieldName:this.fieldName,tooltip:this.tooltip,value:this.value})}};u([d()],vT.prototype,"fieldName",void 0),u([d()],vT.prototype,"tooltip",void 0),u([d()],vT.prototype,"value",void 0),vT=IV=u([I("esri.popup.content.support.ChartMediaInfoValueSeries")],vT);const jde=vT;var $V;let w1=$V=class extends ve{constructor(t){super(t),this.fields=[],this.normalizeField=null,this.series=[],this.tooltipField=null}clone(){return new $V({fields:ne(this.fields),normalizeField:this.normalizeField,tooltipField:this.tooltipField})}};u([d({type:[String],json:{write:!0}})],w1.prototype,"fields",void 0),u([d({type:String,json:{write:!0}})],w1.prototype,"normalizeField",void 0),u([d({type:[jde],json:{read:!1}})],w1.prototype,"series",void 0),u([d({type:String,json:{write:!0}})],w1.prototype,"tooltipField",void 0),w1=$V=u([I("esri.popup.content.support.ChartMediaInfoValue")],w1);const HIe=w1;let fA=class extends Zq{constructor(e){super(e),this.type=null,this.value=null}};u([d({type:["bar-chart","column-chart","line-chart","pie-chart"],readOnly:!0,json:{read:!1,write:!0}})],fA.prototype,"type",void 0),u([d({type:HIe,json:{write:!0}})],fA.prototype,"value",void 0),fA=u([I("esri.popup.content.mixins.ChartMediaInfo")],fA);const y4=fA,_4=Ta()({barchart:"bar-chart",columnchart:"column-chart",linechart:"line-chart",piechart:"pie-chart"});var LV;let eL=LV=class extends y4{constructor(t){super(t),this.type="bar-chart"}clone(){return new LV({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["bar-chart"],readOnly:!0,json:{type:["barchart"],read:!1,write:_4.write}})],eL.prototype,"type",void 0),eL=LV=u([I("esri.popup.content.BarChartMediaInfo")],eL);const Hde=eL;var DV;let tL=DV=class extends y4{constructor(t){super(t),this.type="column-chart"}clone(){return new DV({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["column-chart"],readOnly:!0,json:{type:["columnchart"],read:!1,write:_4.write}})],tL.prototype,"type",void 0),tL=DV=u([I("esri.popup.content.ColumnChartMediaInfo")],tL);const qde=tL;var NV;let mA=NV=class extends ve{constructor(t){super(t),this.linkURL=null,this.sourceURL=null}clone(){return new NV({linkURL:this.linkURL,sourceURL:this.sourceURL})}};u([d({type:String,json:{write:!0}})],mA.prototype,"linkURL",void 0),u([d({type:String,json:{write:!0}})],mA.prototype,"sourceURL",void 0),mA=NV=u([I("esri.popup.content.support.ImageMediaInfoValue")],mA);const qIe=mA;var FV;let bT=FV=class extends Zq{constructor(t){super(t),this.refreshInterval=null,this.type="image",this.value=null}clone(){return new FV({altText:this.altText,title:this.title,caption:this.caption,refreshInterval:this.refreshInterval,value:this.value?this.value.clone():null})}};u([d({type:Number,json:{write:!0}})],bT.prototype,"refreshInterval",void 0),u([d({type:["image"],readOnly:!0,json:{read:!1,write:!0}})],bT.prototype,"type",void 0),u([d({type:qIe,json:{write:!0}})],bT.prototype,"value",void 0),bT=FV=u([I("esri.popup.content.ImageMediaInfo")],bT);const Wde=bT;var UV;let rL=UV=class extends y4{constructor(t){super(t),this.type="line-chart"}clone(){return new UV({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["line-chart"],readOnly:!0,json:{type:["linechart"],read:!1,write:_4.write}})],rL.prototype,"type",void 0),rL=UV=u([I("esri.popup.content.LineChartMediaInfo")],rL);const Xde=rL;var kV;let iL=kV=class extends y4{constructor(t){super(t),this.type="pie-chart"}clone(){return new kV({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["pie-chart"],readOnly:!0,json:{type:["piechart"],read:!1,write:_4.write}})],iL.prototype,"type",void 0),iL=kV=u([I("esri.popup.content.PieChartMediaInfo")],iL);const Yde=iL,Zde={base:Zq,key:"type",defaultKeyValue:"image",typeMap:{"bar-chart":Hde,"column-chart":qde,"line-chart":Xde,"pie-chart":Yde,image:Wde}};var VV;let fd=VV=class extends fv{constructor(t){super(t),this.activeMediaInfoIndex=null,this.attributes=null,this.description=null,this.mediaInfos=null,this.title=null,this.type="media"}readMediaInfos(t){return t&&t.map(e=>e.type==="image"?Wde.fromJSON(e):e.type==="barchart"?Hde.fromJSON(e):e.type==="columnchart"?qde.fromJSON(e):e.type==="linechart"?Xde.fromJSON(e):e.type==="piechart"?Yde.fromJSON(e):void 0).filter(Boolean)}writeMediaInfos(t,e){e.mediaInfos=t&&t.map(r=>r.toJSON())}clone(){return new VV(ne({activeMediaInfoIndex:this.activeMediaInfoIndex,attributes:this.attributes,description:this.description,mediaInfos:this.mediaInfos,title:this.title}))}};u([d()],fd.prototype,"activeMediaInfoIndex",void 0),u([d({type:Object,json:{write:!0}})],fd.prototype,"attributes",void 0),u([d({type:String,json:{write:!0}})],fd.prototype,"description",void 0),u([d({types:[Zde]})],fd.prototype,"mediaInfos",void 0),u([Fe("mediaInfos")],fd.prototype,"readMediaInfos",null),u([He("mediaInfos")],fd.prototype,"writeMediaInfos",null),u([d({type:String,json:{write:!0}})],fd.prototype,"title",void 0),u([d({type:["media"],readOnly:!0,json:{read:!1,write:!0}})],fd.prototype,"type",void 0),fd=VV=u([I("esri.popup.content.MediaContent")],fd);const HR=fd;var BV;let gA=BV=class extends ve{constructor(t){super(t),this.field=null,this.order=null}clone(){return new BV({field:this.field,order:this.order})}};u([d({type:String,json:{write:!0}})],gA.prototype,"field",void 0),u([d({type:["asc","desc"],json:{write:!0}})],gA.prototype,"order",void 0),gA=BV=u([I("esri.popup.support.RelatedRecordsInfoFieldOrder")],gA);const Jq=gA;let Qp=class extends bs(fv){constructor(e){super(e),this.description=null,this.displayCount=null,this.displayType="list",this.orderByFields=null,this.relationshipId=null,this.title=null,this.type="relationship"}};u([d({type:String,json:{write:!0}})],Qp.prototype,"description",void 0),u([d({type:Number,json:{type:Gi,write:!0}})],Qp.prototype,"displayCount",void 0),u([d({type:["list"],json:{write:!0}})],Qp.prototype,"displayType",void 0),u([d({type:[Jq],json:{write:!0}})],Qp.prototype,"orderByFields",void 0),u([d({type:Number,json:{type:Gi,write:!0}})],Qp.prototype,"relationshipId",void 0),u([d({type:String,json:{write:!0}})],Qp.prototype,"title",void 0),u([d({type:["relationship"],readOnly:!0,json:{read:!1,write:!0}})],Qp.prototype,"type",void 0),Qp=u([I("esri.popup.content.RelationshipContent")],Qp);const dN=Qp;var zV;let yA=zV=class extends fv{constructor(t){super(t),this.text=null,this.type="text"}clone(){return new zV({text:this.text})}};u([d({type:String,json:{write:!0}})],yA.prototype,"text",void 0),u([d({type:["text"],readOnly:!0,json:{read:!1,write:!0}})],yA.prototype,"type",void 0),yA=zV=u([I("esri.popup.content.TextContent")],yA);const PS=yA,WIe={base:null,key:"type",typeMap:{attachment:zR,media:HR,text:PS,expression:Xq,field:MS,relationship:dN}};var GV;let x1=GV=class extends ve{constructor(t){super(t),this.name=null,this.title=null,this.expression=null,this.returnType=null}clone(){return new GV({name:this.name,title:this.title,expression:this.expression,returnType:this.returnType})}};u([d({type:String,json:{write:!0}})],x1.prototype,"name",void 0),u([d({type:String,json:{write:!0}})],x1.prototype,"title",void 0),u([d({type:String,json:{write:!0}})],x1.prototype,"expression",void 0),u([d({type:["string","number"],json:{write:!0}})],x1.prototype,"returnType",void 0),x1=GV=u([I("esri.popup.ExpressionInfo")],x1);const Jde=x1;var jV;let _A=jV=class extends ve{constructor(t){super(t),this.returnTopmostRaster=null,this.showNoDataRecords=null}clone(){return new jV({showNoDataRecords:this.showNoDataRecords,returnTopmostRaster:this.returnTopmostRaster})}};u([d({type:Boolean,json:{write:!0}})],_A.prototype,"returnTopmostRaster",void 0),u([d({type:Boolean,json:{write:!0}})],_A.prototype,"showNoDataRecords",void 0),_A=jV=u([I("esri.popup.LayerOptions")],_A);const XIe=_A;var HV;let vA=HV=class extends ve{constructor(t){super(t),this.showRelatedRecords=null,this.orderByFields=null}clone(){return new HV({showRelatedRecords:this.showRelatedRecords,orderByFields:this.orderByFields?ne(this.orderByFields):null})}};u([d({type:Boolean,json:{write:!0}})],vA.prototype,"showRelatedRecords",void 0),u([d({type:[Jq],json:{write:!0}})],vA.prototype,"orderByFields",void 0),vA=HV=u([I("esri.popup.RelatedRecordsInfo")],vA);const YIe=vA;var qV;let md=qV=class extends eM(Te){constructor(t){super(t),this.active=!1,this.className=null,this.disabled=!1,this.id=null,this.indicator=!1,this.title=null,this.type=null,this.visible=!0}clone(){return new qV({active:this.active,className:this.className,disabled:this.disabled,id:this.id,indicator:this.indicator,title:this.title,visible:this.visible})}};u([d()],md.prototype,"active",void 0),u([d()],md.prototype,"className",void 0),u([d()],md.prototype,"disabled",void 0),u([d()],md.prototype,"id",void 0),u([d()],md.prototype,"indicator",void 0),u([d()],md.prototype,"title",void 0),u([d()],md.prototype,"type",void 0),u([d()],md.prototype,"visible",void 0),md=qV=u([I("esri.support.actions.ActionBase")],md);const v4=md;var WV;let sL=WV=class extends v4{constructor(t){super(t),this.image=null,this.type="button"}clone(){return new WV({active:this.active,className:this.className,disabled:this.disabled,id:this.id,indicator:this.indicator,title:this.title,visible:this.visible,image:this.image})}};u([d()],sL.prototype,"image",void 0),sL=WV=u([I("esri.support.Action.ActionButton")],sL);const bE=sL;var XV;let bA=XV=class extends v4{constructor(t){super(t),this.image=null,this.type="toggle",this.value=!1}clone(){return new XV({active:this.active,className:this.className,disabled:this.disabled,id:this.id,indicator:this.indicator,title:this.title,visible:this.visible,image:this.image,value:this.value})}};u([d()],bA.prototype,"image",void 0),u([d()],bA.prototype,"value",void 0),bA=XV=u([I("esri.support.Action.ActionToggle")],bA);const Kde=bA,ZIe="esri.PopupTemplate",JIe=se.getLogger(ZIe),sC="relationships/",UK="expression/",KIe=Pt.ofType({key:"type",defaultKeyValue:"button",base:v4,typeMap:{button:bE,toggle:Kde}}),QIe={base:fv,key:"type",typeMap:{media:HR,custom:VIe,text:PS,attachments:zR,fields:MS,expression:Xq,relationship:dN}},e$e=["attachments","fields","media","text","expression","relationship"];let fo=class extends bs(ve){constructor(){super(...arguments),this.actions=null,this.content="",this.expressionInfos=null,this.fieldInfos=null,this.layerOptions=null,this.lastEditInfoEnabled=!0,this.outFields=null,this.overwriteActions=!1,this.returnGeometry=!1,this.title=""}castContent(e){return Array.isArray(e)?e.map(r=>up(QIe,r)):typeof e=="string"||typeof e=="function"||e instanceof HTMLElement||Uu(e)?e:(JIe.error("content error","unsupported content value",{value:e}),null)}readContent(e,r){const{popupElements:i}=r;return Array.isArray(i)&&i.length>0?this._readPopupInfoElements(r.description,r.mediaInfos,i):this._readPopupInfo(r)}writeContent(e,r,i,s){typeof e!="string"?Array.isArray(e)&&(r.popupElements=e.filter(n=>e$e.includes(n.type)).map(n=>n&&n.toJSON(s)),r.popupElements.forEach(n=>{n.type==="attachments"?this._writeAttachmentContent(r):n.type==="media"?this._writeMediaContent(n,r):n.type==="text"?this._writeTextContent(n,r):n.type==="relationship"&&this._writeRelationshipContent(n,r)})):r.description=e}writeFieldInfos(e,r,i,s){const{content:n}=this,o=Array.isArray(n)?n:null;if(e){const a=o?o.filter(c=>c.type==="fields"):[],l=a.length&&a.every(c=>{var h;return(h=c.fieldInfos)==null?void 0:h.length});r.fieldInfos=e.filter(Boolean).map(c=>{const h=c.toJSON(s);return l&&(h.visible=!1),h})}if(o)for(const a of o)a.type==="fields"&&this._writeFieldsContent(a,r)}writeLayerOptions(e,r,i,s){r[i]=!e||e.showNoDataRecords===null&&e.returnTopmostRaster===null?null:e.toJSON(s)}writeTitle(e,r){r.title=e||""}async collectRequiredFields(e,r){const i=this.expressionInfos||[];await this._collectExpressionInfoFields(e,r,[...i,...this._getContentExpressionInfos(this.content,i)]),BR(e,r,[...this.outFields||[],...this._getActionsFields(this.actions),...this._getTitleFields(this.title),...this._getContentFields(this.content)])}async getRequiredFields(e){const r=new Set;return await this.collectRequiredFields(r,e),[...r].sort()}_writeFieldsContent(e,r){if(!Array.isArray(e.fieldInfos)||!e.fieldInfos.length)return;const i=ne(e.fieldInfos);Array.isArray(r.fieldInfos)?i.forEach(s=>{const n=r.fieldInfos.find(o=>o.fieldName.toLowerCase()===s.fieldName.toLowerCase());n?n.visible=!0:r.fieldInfos.push(s)}):r.fieldInfos=i}_writeAttachmentContent(e){e.showAttachments||(e.showAttachments=!0)}_writeRelationshipContent(e,r){var n,o;const i=((n=e.orderByFields)==null?void 0:n.map(a=>this._toFieldOrderJSON(a,e.relationshipId)))||[],s=[...((o=r.relatedRecordsInfo)==null?void 0:o.orderByFields)||[],...i];r.relatedRecordsInfo={showRelatedRecords:!0,...(s==null?void 0:s.length)&&{orderByFields:s}}}_writeTextContent(e,r){!r.description&&e.text&&(r.description=e.text)}_writeMediaContent(e,r){if(!Array.isArray(e.mediaInfos)||!e.mediaInfos.length)return;const i=ne(e.mediaInfos);Array.isArray(r.mediaInfos)?r.mediaInfos=[...r.mediaInfos,...i]:r.mediaInfos=i}_readPopupInfoElements(e,r,i){const s={description:!1,mediaInfos:!1};return i.map(n=>n.type==="media"?(n.mediaInfos||!r||s.mediaInfos||(n.mediaInfos=r,s.mediaInfos=!0),HR.fromJSON(n)):n.type==="text"?(n.text||!e||s.description||(n.text=e,s.description=!0),PS.fromJSON(n)):n.type==="attachments"?zR.fromJSON(n):n.type==="fields"?MS.fromJSON(n):n.type==="expression"?Xq.fromJSON(n):n.type==="relationship"?dN.fromJSON(n):void 0).filter(Boolean)}_toRelationshipContent(e){const{field:r,order:i}=e;if(!(r!=null&&r.startsWith(sC)))return null;const s=r.replace(sC,"").split("/");if(s.length!==2)return null;const n=parseInt(s[0],10),o=s[1];return typeof n=="number"&&o?dN.fromJSON({relationshipId:n,orderByFields:[{field:o,order:i}]}):null}_toFieldOrderJSON(e,r){const{order:i,field:s}=e;return{field:`${sC}${r}/${s}`,order:i}}_readPopupInfo({description:e,mediaInfos:r,showAttachments:i,relatedRecordsInfo:s={showRelatedRecords:!1}}){const n=[];e?n.push(new PS({text:e})):n.push(new MS),Array.isArray(r)&&r.length&&n.push(HR.fromJSON({mediaInfos:r})),i&&n.push(zR.fromJSON({displayType:"auto"}));const{showRelatedRecords:o,orderByFields:a}=s;return o&&(a!=null&&a.length)&&a.forEach(l=>{const c=this._toRelationshipContent(l);c&&n.push(c)}),n.length?n:e}_getContentElementFields(e){const r=e==null?void 0:e.type;if(r==="attachments")return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description)];if(r==="custom")return e.outFields||[];if(r==="fields")return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description),...this._getFieldInfoFields(e.fieldInfos??this.fieldInfos)];if(r==="media"){const i=e.mediaInfos||[];return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description),...i.reduce((s,n)=>[...s,...this._getMediaInfoFields(n)],[])]}return r==="text"?this._extractFieldNames(e.text):[]}_getMediaInfoFields(e){const{caption:r,title:i,value:s}=e,n=s||{},{fields:o,normalizeField:a,tooltipField:l,sourceURL:c,linkURL:h}=n,p=[...this._extractFieldNames(i),...this._extractFieldNames(r),...this._extractFieldNames(c),...this._extractFieldNames(h),...o??[]];return a&&p.push(a),l&&p.push(l),p}_getContentExpressionInfos(e,r){return Array.isArray(e)?e.reduce((i,s)=>[...i,...s.type==="expression"&&s.expressionInfo?[s.expressionInfo]:[]],r):[]}_getContentFields(e){return typeof e=="string"?this._extractFieldNames(e):Array.isArray(e)?e.reduce((r,i)=>[...r,...this._getContentElementFields(i)],[]):[]}async _collectExpressionInfoFields(e,r,i){i&&await Promise.all(i.map(s=>Hl(e,r,s.expression)))}_getFieldInfoFields(e){return e?e.filter(r=>r.visible===void 0||!!r.visible).map(r=>r.fieldName).filter(r=>!r.startsWith(sC)&&!r.startsWith(UK)):[]}_getActionsFields(e){return e?e.toArray().reduce((r,i)=>[...r,...this._getActionFields(i)],[]):[]}_getActionFields(e){const{className:r,title:i,type:s}=e,n=s==="button"||s==="toggle"?e.image:"";return[...this._extractFieldNames(i),...this._extractFieldNames(r),...this._extractFieldNames(n)]}_getTitleFields(e){return typeof e=="string"?this._extractFieldNames(e):[]}_extractFieldNames(e){if(!e||typeof e!="string")return[];const r=/{[^}]*}/g,i=e.match(r);if(!i)return[];const s=/\{(\w+):.+\}/,n=i.filter(o=>!(o.indexOf(`{${sC}`)===0||o.indexOf(`{${UK}`)===0)).map(o=>o.replace(s,"{$1}"));return n?n.map(o=>o.slice(1,-1)):[]}};u([d({type:KIe})],fo.prototype,"actions",void 0),u([d()],fo.prototype,"content",void 0),u([cr("content")],fo.prototype,"castContent",null),u([Fe("content",["description","fieldInfos","popupElements","mediaInfos","showAttachments","relatedRecordsInfo"])],fo.prototype,"readContent",null),u([He("content",{popupElements:{type:Pt.ofType(WIe)},showAttachments:{type:Boolean},mediaInfos:{type:Pt.ofType(Zde)},description:{type:String},relatedRecordsInfo:{type:YIe}})],fo.prototype,"writeContent",null),u([d({type:[Jde],json:{write:!0}})],fo.prototype,"expressionInfos",void 0),u([d({type:[tM]})],fo.prototype,"fieldInfos",void 0),u([He("fieldInfos")],fo.prototype,"writeFieldInfos",null),u([d({type:XIe})],fo.prototype,"layerOptions",void 0),u([He("layerOptions")],fo.prototype,"writeLayerOptions",null),u([d({type:Boolean,json:{read:{source:"showLastEditInfo"},write:{target:"showLastEditInfo"},default:!0}})],fo.prototype,"lastEditInfoEnabled",void 0),u([d()],fo.prototype,"outFields",void 0),u([d()],fo.prototype,"overwriteActions",void 0),u([d()],fo.prototype,"returnGeometry",void 0),u([d({json:{type:String}})],fo.prototype,"title",void 0),u([He("title")],fo.prototype,"writeTitle",null),fo=u([I("esri.PopupTemplate")],fo);const rM=fo,kK=new mr({esriSMS:"simple-marker",esriPMS:"picture-marker",esriSLS:"simple-line",esriSFS:"simple-fill",esriPFS:"picture-fill",esriTS:"text",esriSHD:"shield-label-symbol",PointSymbol3D:"point-3d",LineSymbol3D:"line-3d",PolygonSymbol3D:"polygon-3d",WebStyleSymbol:"web-style",MeshSymbol3D:"mesh-3d",LabelSymbol3D:"label-3d",CIMSymbolReference:"cim"});let t$e=0,wT=class extends ve{constructor(e){super(e),this.id="sym"+t$e++,this.type=null,this.color=new Ze([0,0,0,1])}readColor(e){return e&&e[0]!=null?[e[0],e[1],e[2],e[3]/255]:e}async collectRequiredFields(e,r){}hash(){return JSON.stringify(this.toJSON())}clone(){}};u([d({type:kK.apiValues,readOnly:!0,json:{read:!1,write:{ignoreOrigin:!0,writer:kK.write}}})],wT.prototype,"type",void 0),u([d({type:Ze,json:{write:{allowNull:!0}}})],wT.prototype,"color",void 0),u([Fe("color")],wT.prototype,"readColor",null),wT=u([I("esri.symbols.Symbol")],wT);const Uc=wT;var YV;let w0=YV=class extends Uc{constructor(t){super(t),this.data=null,this.type="cim"}readData(t,e){return e}writeData(t,e){if(t)for(const r in t)e[r]=t[r]}async collectRequiredFields(t,e){var r;if(((r=this.data)==null?void 0:r.type)==="CIMSymbolReference"){const i=this.data.primitiveOverrides;if(i){const s=i.map(n=>{const o=n.valueExpressionInfo;return Hl(t,e,o.expression)});await Promise.all(s)}}}clone(){return new YV({data:ne(this.data)})}hash(){return qH(JSON.stringify(this.data)).toString()}};u([d({json:{write:!1}})],w0.prototype,"color",void 0),u([d({json:{write:!0}})],w0.prototype,"data",void 0),u([Fe("data",["symbol"])],w0.prototype,"readData",null),u([He("data",{})],w0.prototype,"writeData",null),u([gt({CIMSymbolReference:"cim"},{readOnly:!0})],w0.prototype,"type",void 0),w0=YV=u([I("esri.symbols.CIMSymbol")],w0);const wE=w0;let xT=class extends ve{constructor(e){super(e),this.enabled=!0,this.type=null}writeEnabled(e,r,i){e||(r[i]=e)}};u([d({type:Boolean,json:{read:{source:"enable"},write:{target:"enable"}}})],xT.prototype,"enabled",void 0),u([He("enabled")],xT.prototype,"writeEnabled",null),u([d({type:["icon","object","line","path","fill","water","extrude","text"],readOnly:!0})],xT.prototype,"type",void 0),xT=u([I("esri.symbols.Symbol3DLayer")],xT);const gm=xT,r$e=/^-?(\d+(\.\d+)?)\s*((px)|(pt))?$/i,i$e="screenUtils.toPt: input not recognized!",Qde=96;function Ao(t){return t?t/72*Qde:0}function Vh(t){return t?72*t/Qde:0}function hi(t){if(typeof t=="string"){const e=t.match(r$e);if(e){const r=Number(e[1]),i=e[3]&&e[3].toLowerCase(),s=t.charAt(0)==="-",n=i==="px"?Vh(r):r;return s?-n:n}return console.warn(i$e),null}return t}function Bh(t=0,e=0){return{x:t,y:e}}function as(t=0,e=0){return[t,e]}function epe(t=0,e=0){return[t,e]}function qo(t=0,e=0,r=0){return[t,e,r]}function yxt(t){return t}function _xt(t){return t}function vxt(t){return t}function Mf(t,e){return e?(e[0]=t.x,e[1]=t.y,e.length>2&&(e[2]=0),e):[t.x,t.y]}function s$e(t,e){const r=e.transparency!=null?kR(e.transparency):1,i=e.color;return i&&Array.isArray(i)?new Ze([i[0]||0,i[1]||0,i[2]||0,r]):null}function n$e(t,e){e.color=t.toJSON().slice(0,3);const r=f4(t.a);r!==0&&(e.transparency=r)}const ly={type:Ze,json:{type:[Gi],default:null,read:{source:["color","transparency"],reader:s$e},write:{target:{color:{type:[Gi]},transparency:{type:Gi}},writer:n$e}}},am={type:Number,cast:hi,json:{write:!0}};let T1=class extends ve{constructor(e){super(e),this.color=new Ze([0,0,0,1]),this.extensionLength=0,this.size=Vh(1)}clone(){}cloneProperties(){return{color:ne(this.color),size:this.size,extensionLength:this.extensionLength}}};u([d({type:["solid","sketch"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],T1.prototype,"type",void 0),u([d(ly)],T1.prototype,"color",void 0),u([d({...am,json:{write:{overridePolicy:t=>({enabled:!!t})}}})],T1.prototype,"extensionLength",void 0),u([d(am)],T1.prototype,"size",void 0),T1=u([I("esri.symbols.edges.Edges3D")],T1);const Kq=T1;var ZV;let nL=ZV=class extends Kq{constructor(t){super(t),this.type="sketch"}clone(){return new ZV(this.cloneProperties())}};u([gt({sketch:"sketch"},{readOnly:!0})],nL.prototype,"type",void 0),nL=ZV=u([I("esri.symbols.edges.SketchEdges3D")],nL);const o$e=nL;var JV;let oL=JV=class extends Kq{constructor(t){super(t),this.type="solid"}clone(){return new JV(this.cloneProperties())}};u([gt({solid:"solid"},{readOnly:!0})],oL.prototype,"type",void 0),oL=JV=u([I("esri.symbols.support.SolidEdges3D")],oL);const a$e=oL,tpe={types:{key:"type",base:Kq,typeMap:{solid:a$e,sketch:o$e}},json:{write:!0}};var KV;let Ou=KV=class extends ve{constructor(t){super(t),this.color=null}clone(){const t={color:v(this.color)?this.color.clone():null};return new KV(t)}};u([d(ly)],Ou.prototype,"color",void 0),Ou=KV=u([I("esri.symbols.support.Symbol3DMaterial")],Ou);var QV;let x0=QV=class extends gm{constructor(t){super(t),this.type="extrude",this.size=1,this.material=null,this.castShadows=!0,this.edges=null}clone(){return new QV({edges:this.edges&&this.edges.clone(),enabled:this.enabled,material:v(this.material)?this.material.clone():null,castShadows:this.castShadows,size:this.size})}};u([gt({Extrude:"extrude"},{readOnly:!0})],x0.prototype,"type",void 0),u([d({type:Number,json:{write:{enabled:!0,isRequired:!0}},nonNullable:!0})],x0.prototype,"size",void 0),u([d({type:Ou,json:{write:!0}})],x0.prototype,"material",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],x0.prototype,"castShadows",void 0),u([d(tpe)],x0.prototype,"edges",void 0),x0=QV=u([I("esri.symbols.ExtrudeSymbol3DLayer")],x0);const rpe=x0;let wA=class extends Uc{constructor(e){super(e),this.type="simple-line",this.width=.75}hash(){return`${this.type}.${this.width}`}};u([gt({esriSLS:"simple-line"},{readOnly:!0})],wA.prototype,"type",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],wA.prototype,"width",void 0),wA=u([I("esri.symbols.LineSymbol")],wA);const l$e=wA,c$e=["begin","end","begin-end"],ipe=["arrow","circle","square","diamond","cross","x"];var eB;let ef=eB=class extends ve{constructor(t){super(t),this.placement="begin-end",this.type="line-marker",this.style="arrow"}writeStyle(t,e,r,i){e[r]=(i==null?void 0:i.origin)==="web-map"?"arrow":t}set color(t){this._set("color",t)}readColor(t){return t&&t[0]!=null?[t[0],t[1],t[2],t[3]/255]:t}writeColor(t,e,r,i){(i==null?void 0:i.origin)==="web-map"||(e[r]=t)}clone(){return new eB({color:ne(this.color),placement:this.placement,style:this.style})}hash(){var t;return`${this.placement}.${(t=this.color)==null?void 0:t.hash()}.${this.style}`}};u([d({type:["begin","end","begin-end"],json:{write:!0}})],ef.prototype,"placement",void 0),u([gt({"line-marker":"line-marker"},{readOnly:!0}),d({json:{origins:{"web-map":{write:!1}}}})],ef.prototype,"type",void 0),u([d({type:ipe})],ef.prototype,"style",void 0),u([He("style")],ef.prototype,"writeStyle",null),u([d({type:Ze,value:null,json:{write:{allowNull:!0}}})],ef.prototype,"color",null),u([Fe("color")],ef.prototype,"readColor",null),u([He("color")],ef.prototype,"writeColor",null),ef=eB=u([I("esri.symbols.LineSymbolMarker")],ef);const u$e=ef;var tB;const V6=new mr({esriSLSSolid:"solid",esriSLSDash:"dash",esriSLSDot:"dot",esriSLSDashDot:"dash-dot",esriSLSDashDotDot:"long-dash-dot-dot",esriSLSNull:"none",esriSLSInsideFrame:"inside-frame",esriSLSShortDash:"short-dash",esriSLSShortDot:"short-dot",esriSLSShortDashDot:"short-dash-dot",esriSLSShortDashDotDot:"short-dash-dot-dot",esriSLSLongDash:"long-dash",esriSLSLongDashDot:"long-dash-dot"});let Qm=tB=class extends l$e{constructor(...t){super(...t),this.type="simple-line",this.style="solid",this.cap="round",this.join="round",this.marker=null,this.miterLimit=2}normalizeCtorArgs(t,e,r,i,s,n){if(t&&typeof t!="string")return t;const o={};return t!=null&&(o.style=t),e!=null&&(o.color=e),r!=null&&(o.width=hi(r)),i!=null&&(o.cap=i),s!=null&&(o.join=s),n!=null&&(o.miterLimit=hi(n)),o}clone(){var t;return new tB({color:ne(this.color),style:this.style,width:this.width,cap:this.cap,join:this.join,miterLimit:this.miterLimit,marker:(t=this.marker)==null?void 0:t.clone()})}hash(){var t,e;return`${super.hash()}.${(t=this.color)==null?void 0:t.hash()}.${this.style}.${this.cap}.${this.join}.${this.miterLimit}.${(e=this.marker)==null?void 0:e.hash()}`}};u([gt({esriSLS:"simple-line"},{readOnly:!0})],Qm.prototype,"type",void 0),u([d({type:V6.apiValues,json:{read:V6.read,write:V6.write}})],Qm.prototype,"style",void 0),u([d({type:["butt","round","square"],json:{write:{overridePolicy:(t,e,r)=>({enabled:t!=="round"&&(r==null||r.origin==null)})}}})],Qm.prototype,"cap",void 0),u([d({type:["miter","round","bevel"],json:{write:{overridePolicy:(t,e,r)=>({enabled:t!=="round"&&(r==null||r.origin==null)})}}})],Qm.prototype,"join",void 0),u([d({types:{key:"type",base:null,defaultKeyValue:"line-marker",typeMap:{"line-marker":u$e}},json:{write:!0,origins:{"web-scene":{write:!1}}}})],Qm.prototype,"marker",void 0),u([d({type:Number,json:{read:!1,write:!1}})],Qm.prototype,"miterLimit",void 0),Qm=tB=u([I("esri.symbols.SimpleLineSymbol")],Qm);const Yh=Qm;let xA=class extends Uc{constructor(e){super(e),this.outline=null,this.type=null}hash(){return`${this.type}.${this.outline&&this.outline.hash()}`}};u([d({types:{key:"type",base:null,defaultKeyValue:"simple-line",typeMap:{"simple-line":Yh}},json:{default:null,write:!0}})],xA.prototype,"outline",void 0),u([d({type:["simple-fill","picture-fill"],readOnly:!0})],xA.prototype,"type",void 0),xA=u([I("esri.symbols.FillSymbol")],xA);const spe=xA;let aL=class extends ve{constructor(e){super(e)}clone(){}};u([d({type:["style"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],aL.prototype,"type",void 0),aL=u([I("esri.symbols.patterns.LinePattern3D")],aL);const npe=aL,h$e=["dash","dash-dot","dot","long-dash","long-dash-dot","long-dash-dot-dot","none","short-dash","short-dash-dot","short-dash-dot-dot","short-dot","solid"];var rB;const d$e=Ta()({dash:"dash","dash-dot":"dash-dot","dash-dot-dot":"long-dash-dot-dot",dot:"dot","long-dash":"long-dash","long-dash-dot":"long-dash-dot",null:"none","short-dash":"short-dash","short-dash-dot":"short-dash-dot","short-dash-dot-dot":"short-dash-dot-dot","short-dot":"short-dot",solid:"solid"});let TA=rB=class extends npe{constructor(t){super(t),this.type="style",this.style="solid"}clone(){const t={style:this.style};return new rB(t)}};u([d({type:["style"]})],TA.prototype,"type",void 0),u([gt(d$e),d({type:h$e})],TA.prototype,"style",void 0),TA=rB=u([I("esri.symbols.patterns.LineStylePattern3D")],TA);const Qq=TA;let lL=class extends ve{constructor(e){super(e)}clone(){}};u([d({type:["style"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],lL.prototype,"type",void 0),lL=u([I("esri.symbols.patterns.Pattern3D")],lL);const ope=lL,p$e=["backward-diagonal","cross","diagonal-cross","forward-diagonal","horizontal","none","solid","vertical"];var iB;let SA=iB=class extends ope{constructor(t){super(t),this.type="style",this.style="solid"}clone(){const t={style:this.style};return new iB(t)}};u([d({type:["style"]})],SA.prototype,"type",void 0),u([d({type:p$e,json:{read:!0,write:!0}})],SA.prototype,"style",void 0),SA=iB=u([I("esri.symbols.patterns.StylePattern3D")],SA);const ape=SA,f$e={types:{key:"type",base:ope,typeMap:{style:ape}},json:{write:!0}},lpe={types:{key:"type",base:npe,typeMap:{style:Qq}},json:{write:!0}},z3=new Ze("white");new Ze("black");const m$e=new Ze([255,255,255,0]);function g$e(t){return t.r===0&&t.g===0&&t.b===0}var sB;let G3=sB=class extends Ou{constructor(t){super(t),this.colorMixMode=null}clone(){const t={color:v(this.color)?this.color.clone():null,colorMixMode:this.colorMixMode};return new sB(t)}};u([gt({multiply:"multiply",replace:"replace",tint:"tint"})],G3.prototype,"colorMixMode",void 0),G3=sB=u([I("esri.symbols.support.Symbol3DFillMaterial")],G3);function ur(t=b$e){return[t[0],t[1],t[2],t[3]]}function Ext(t){return[t[0],t[1],t[2],t[3]]}function Kg(t,e){return t!==e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]),t}function eW(t,e,r,i,s=ur()){return s[0]=t,s[1]=e,s[2]=r,s[3]=i,s}function cpe(t,e=ur()){return e[0]=t.xmin,e[1]=t.ymin,e[2]=t.xmax,e[3]=t.ymax,e}function b4(t,e){return new Zr({xmin:t[0],ymin:t[1],xmax:t[2],ymax:t[3],spatialReference:e})}function tW(t,e){e[0]<t[0]&&(t[0]=e[0]),e[0]>t[2]&&(t[2]=e[0]),e[1]<t[1]&&(t[1]=e[1]),e[1]>t[3]&&(t[3]=e[1])}function L_(t,e,r){if(C(e))Kg(r,t);else if("length"in e)aB(e)?(r[0]=Math.min(t[0],e[0]),r[1]=Math.min(t[1],e[1]),r[2]=Math.max(t[2],e[2]),r[3]=Math.max(t[3],e[3])):e.length!==2&&e.length!==3||(r[0]=Math.min(t[0],e[0]),r[1]=Math.min(t[1],e[1]),r[2]=Math.max(t[2],e[0]),r[3]=Math.max(t[3],e[1]));else switch(e.type){case"extent":r[0]=Math.min(t[0],e.xmin),r[1]=Math.min(t[1],e.ymin),r[2]=Math.max(t[2],e.xmax),r[3]=Math.max(t[3],e.ymax);break;case"point":r[0]=Math.min(t[0],e.x),r[1]=Math.min(t[1],e.y),r[2]=Math.max(t[2],e.x),r[3]=Math.max(t[3],e.y)}}function B6(t,e,r=t){const i=e.length;let s=t[0],n=t[1],o=t[2],a=t[3];for(let l=0;l<i;l++){const c=e[l];s=Math.min(s,c[0]),n=Math.min(n,c[1]),o=Math.max(o,c[0]),a=Math.max(a,c[1])}return r[0]=s,r[1]=n,r[2]=o,r[3]=a,r}function nB(t){for(let e=0;e<4;e++)if(!isFinite(t[e]))return!1;return!0}function xu(t){return C(t)||t[0]>=t[2]?0:t[2]-t[0]}function fp(t){return t[1]>=t[3]?0:t[3]-t[1]}function upe(t){return xu(t)*fp(t)}function rW(t,e=[0,0]){return e[0]=(t[0]+t[2])/2,e[1]=(t[1]+t[3])/2,e}function hpe(t,e){return w4(t,e[0],e[1])}function VK(t,e){const r=e[3],i=.5*(t[0]+t[2]),s=Math.abs(e[0]-i),n=.5*(t[2]-t[0]);if(s>r+n)return!1;const o=.5*(t[1]+t[3]),a=.5*(t[3]-t[1]),l=Math.abs(e[1]-o);if(l>r+a)return!1;if(s<n||l<a)return!0;const c=s-n,h=l-a;return c*c+h*h<=r*r}function Cxt(t,e,r){const i=t[0],s=t[1],n=t[2],o=t[3],{x:a,y:l}=e,{x:c,y:h}=r,p=(b,x)=>(h-l)*b+(a-c)*x+(c*l-a*h)<0,f=p(i,o),m=p(n,o),y=p(n,s),_=p(i,s);return!(f===m&&m===y&&y===_&&_===f||a<i&&c<i||a>n&&c>n||l>o&&h>o||l<s&&h<s)}function Axt(t,e){return w4(t,e.x,e.y)}function w4(t,e,r){return e>=t[0]&&r>=t[1]&&e<=t[2]&&r<=t[3]}function y$e(t,e,r){return e[0]>=t[0]-r&&e[1]>=t[1]-r&&e[0]<=t[2]+r&&e[1]<=t[3]+r}function x4(t,e){return Math.max(e[0],t[0])<=Math.min(e[2],t[2])&&Math.max(e[1],t[1])<=Math.min(e[3],t[3])}function BK(t,e){return e[0]>=t[0]&&e[2]<=t[2]&&e[1]>=t[1]&&e[3]<=t[3]}function oB(t,e,r){if(C(e))return Kg(r,t);const i=e[0],s=e[1],n=e[2],o=e[3];return r[0]=ge(t[0],i,n),r[1]=ge(t[1],s,o),r[2]=ge(t[2],i,n),r[3]=ge(t[3],s,o),r}function _$e(t,e){const r=(t[0]+t[2])/2,i=(t[1]+t[3])/2,s=Math.max(Math.abs(e[0]-r)-xu(t)/2,0),n=Math.max(Math.abs(e[1]-i)-fp(t)/2,0);return Math.sqrt(s*s+n*n)}function pN(t,e,r,i=t){return i[0]=t[0]+e,i[1]=t[1]+r,i[2]=t[2]+e,i[3]=t[3]+r,i}function zh(t){return t?Kg(t,lB):ur(lB)}function aB(t){return t!=null&&t.length===4}function v$e(t){return!(xu(t)!==0&&isFinite(t[0])||fp(t)!==0&&isFinite(t[1]))}function qb(t,e){return aB(t)&&aB(e)?t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]:t===e}const Rxt=[-1/0,-1/0,1/0,1/0],lB=[1/0,1/0,-1/0,-1/0],b$e=[0,0,0,0];function En(t=gpe){return[t[0],t[1],t[2],t[3],t[4],t[5]]}function mw(t,e,r,i,s,n,o=En()){return o[0]=t,o[1]=e,o[2]=r,o[3]=i,o[4]=s,o[5]=n,o}function Oxt(t,e){const r=isFinite(t[2])||isFinite(t[5]);return new Zr(r?{xmin:t[0],xmax:t[3],ymin:t[1],ymax:t[4],zmin:t[2],zmax:t[5],spatialReference:e}:{xmin:t[0],xmax:t[3],ymin:t[1],ymax:t[4],spatialReference:e})}function IS(t,e){t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.min(t[2],e[2]),t[3]=Math.max(t[3],e[3]),t[4]=Math.max(t[4],e[4]),t[5]=Math.max(t[5],e[5])}function w$e(t,e){t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[3]=Math.max(t[3],e[2]),t[4]=Math.max(t[4],e[3])}function lm(t,e){t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.min(t[2],e[2]),t[3]=Math.max(t[3],e[0]),t[4]=Math.max(t[4],e[1]),t[5]=Math.max(t[5],e[2])}function Cu(t,e,r=0,i=e.length/3){let s=t[0],n=t[1],o=t[2],a=t[3],l=t[4],c=t[5];for(let h=0;h<i;h++)s=Math.min(s,e[r+3*h]),n=Math.min(n,e[r+3*h+1]),o=Math.min(o,e[r+3*h+2]),a=Math.max(a,e[r+3*h]),l=Math.max(l,e[r+3*h+1]),c=Math.max(c,e[r+3*h+2]);t[0]=s,t[1]=n,t[2]=o,t[3]=a,t[4]=l,t[5]=c}function z6(t,e,r){const i=e.length;let s=t[0],n=t[1],o=t[2],a=t[3],l=t[4],c=t[5];if(r)for(let h=0;h<i;h++){const p=e[h];s=Math.min(s,p[0]),n=Math.min(n,p[1]),o=Math.min(o,p[2]),a=Math.max(a,p[0]),l=Math.max(l,p[1]),c=Math.max(c,p[2])}else for(let h=0;h<i;h++){const p=e[h];s=Math.min(s,p[0]),n=Math.min(n,p[1]),a=Math.max(a,p[0]),l=Math.max(l,p[1])}t[0]=s,t[1]=n,t[2]=o,t[3]=a,t[4]=l,t[5]=c}function x$e(t){for(let e=0;e<6;e++)if(!isFinite(t[e]))return!1;return!0}function Hw(t){return t[0]>=t[3]?0:t[3]-t[0]}function qw(t){return t[1]>=t[4]?0:t[4]-t[1]}function mv(t){return t[2]>=t[5]?0:t[5]-t[2]}function dpe(t){const e=Hw(t),r=mv(t),i=qw(t);return Math.sqrt(e*e+r*r+i*i)}function Yd(t,e=[0,0,0]){return e[0]=t[0]+Hw(t)/2,e[1]=t[1]+qw(t)/2,e[2]=t[2]+mv(t)/2,e}function iP(t,e=[0,0,0]){return e[0]=Hw(t),e[1]=qw(t),e[2]=mv(t),e}function iW(t,e){return e[0]>=t[0]&&e[1]>=t[1]&&e[2]>=t[2]&&e[0]<=t[3]&&e[1]<=t[4]&&e[2]<=t[5]}function Mxt(t,e){return e[0]>=t[0]&&e[1]>=t[1]&&e[2]>=t[2]&&e[3]<=t[3]&&e[4]<=t[4]&&e[5]<=t[5]}function T$e(t,e){return Math.max(e[0],t[0])<=Math.min(e[3],t[3])&&Math.max(e[1],t[1])<=Math.min(e[4],t[4])&&Math.max(e[2],t[2])<=Math.min(e[5],t[5])}function Zd(t,e){return!!C(e)||T$e(t,e)}function ppe(t,e,r,i,s=t){return s[0]=t[0]+e,s[1]=t[1]+r,s[2]=t[2]+i,s[3]=t[3]+e,s[4]=t[4]+r,s[5]=t[5]+i,s}function Pxt(t,e,r=t){const i=t[0]+Hw(t)/2,s=t[1]+qw(t)/2,n=t[2]+mv(t)/2;return r[0]=i+(t[0]-i)*e,r[1]=s+(t[1]-s)*e,r[2]=n+(t[2]-n)*e,r[3]=i+(t[3]-i)*e,r[4]=s+(t[4]-s)*e,r[5]=n+(t[5]-n)*e,r}function fpe(t,e,r=t){return r[0]=e[0],r[1]=e[1],r[2]=e[2],r!==t&&(r[3]=t[3],r[4]=t[4],r[5]=t[5]),r}function mpe(t,e,r=t){return r[3]=e[0],r[4]=e[1],r[5]=e[2],r!==t&&(r[0]=t[0],r[1]=t[1],r[2]=t[2]),t}function T4(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t}function Ri(t){return t?T4(t,zK):En(zK)}function sW(t,e){return e||(e=ur()),e[0]=t[0],e[1]=t[1],e[2]=t[3],e[3]=t[4],e}function Ixt(t,e){return t[0]=e[0],t[1]=e[1],t[2]=Number.NEGATIVE_INFINITY,t[3]=e[2],t[4]=e[3],t[5]=Number.POSITIVE_INFINITY,t}function S$e(t,e,r,i,s){return t[0]=e,t[1]=r,t[2]=Number.NEGATIVE_INFINITY,t[3]=i,t[4]=s,t[5]=Number.POSITIVE_INFINITY,t}function cB(t){return t.length===6}function nW(t){return Hw(t)===0&&qw(t)===0&&mv(t)===0}function $xt(t,e,r){if(C(t)||C(e))return t===e;if(!cB(t)||!cB(e))return!1;if(r){for(let i=0;i<t.length;i++)if(!r(t[i],e[i]))return!1}else for(let i=0;i<t.length;i++)if(t[i]!==e[i])return!1;return!0}function E$e(t,e,r,i,s,n){return mw(t,e,r,i,s,n,C$e)}const Lxt=[-1/0,-1/0,-1/0,1/0,1/0,1/0],zK=[1/0,1/0,1/0,-1/0,-1/0,-1/0],gpe=[0,0,0,0,0,0],C$e=En();function G6(t,{isPrimitive:e,width:r,depth:i,height:s}){const n=e?10:1;if(r==null&&s==null&&i==null)return[n*t[0],n*t[1],n*t[2]];const o=$e(r,i,s);let a;for(let l=0;l<3;l++){const c=o[l];if(c!=null){a=c/t[l];break}}for(let l=0;l<3;l++)o[l]==null&&(o[l]=t[l]*a);return o}const A$e=mw(-.5,-.5,-.5,.5,.5,.5),R$e=mw(-.5,-.5,0,.5,.5,1),O$e=mw(-.5,-.5,0,.5,.5,.5);function M$e(t){switch(t){case"sphere":case"cube":case"diamond":return A$e;case"cylinder":case"cone":case"inverted-cone":return R$e;case"tetrahedron":return O$e;default:return}}const oW=["butt","square","round"],P$e=[...oW,"none"],ype=["miter","bevel","round"];var uB;let S1=uB=class extends ve{constructor(t){super(t),this.color=new Ze([0,0,0,1]),this.size=Vh(1),this.pattern=null,this.patternCap="butt"}clone(){const t={color:v(this.color)?this.color.clone():null,size:this.size,pattern:v(this.pattern)?this.pattern.clone():null,patternCap:this.patternCap};return new uB(t)}};u([d(ly)],S1.prototype,"color",void 0),u([d(am)],S1.prototype,"size",void 0),u([d(lpe)],S1.prototype,"pattern",void 0),u([d({type:oW,json:{default:"butt",write:{overridePolicy(){return{enabled:v(this.pattern)}}}}})],S1.prototype,"patternCap",void 0),S1=uB=u([I("esri.symbols.support.Symbol3DOutline")],S1);var cL;let eg=cL=class extends gm{constructor(t){super(t),this.type="fill",this.material=null,this.pattern=null,this.castShadows=!0,this.outline=null,this.edges=null}clone(){const t={edges:v(this.edges)?this.edges.clone():null,enabled:this.enabled,material:v(this.material)?this.material.clone():null,pattern:v(this.pattern)?this.pattern.clone():null,castShadows:this.castShadows,outline:v(this.outline)?this.outline.clone():null};return new cL(t)}static fromSimpleFillSymbol(t){var i,s,n;const e=t.outline&&t.outline.style&&t.outline.style!=="inside-frame"&&t.outline.style!=="solid"?new Qq({style:t.outline.style}):null,r={size:((i=t.outline)==null?void 0:i.width)??0,color:(((s=t.outline)==null?void 0:s.color)??z3).clone(),pattern:e};return e&&((n=t.outline)!=null&&n.cap)&&(r.patternCap=t.outline.cap),new cL({material:new G3({color:(t.color??m$e).clone()}),pattern:t.style&&t.style!=="solid"?new ape({style:t.style}):null,outline:r})}};u([gt({Fill:"fill"},{readOnly:!0})],eg.prototype,"type",void 0),u([d({type:G3,json:{write:!0}})],eg.prototype,"material",void 0),u([d(f$e)],eg.prototype,"pattern",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],eg.prototype,"castShadows",void 0),u([d({type:S1,json:{write:!0}})],eg.prototype,"outline",void 0),u([d(tpe)],eg.prototype,"edges",void 0),eg=cL=u([I("esri.symbols.FillSymbol3DLayer")],eg);const iM=eg,I$e=["none","underline","line-through"],$$e=["normal","italic","oblique"],L$e=["normal","lighter","bold","bolder"],_pe={type:Number,cast:t=>{const e=bh(t);return e===0?1:ge(e,.1,4)},nonNullable:!0},D$e=["left","right","center"],N$e=["baseline","top","middle","bottom"],vpe={type:D$e,nonNullable:!0},bpe={type:N$e,nonNullable:!0};var hB;let tg=hB=class extends ve{constructor(t){super(t),this.decoration="none",this.family="sans-serif",this.size=9,this.style="normal",this.weight="normal"}castSize(t){return hi(t)}clone(){return new hB({decoration:this.decoration,family:this.family,size:this.size,style:this.style,weight:this.weight})}hash(){return`${this.decoration}.${this.family}.${this.size}.${this.style}.${this.weight}`}};u([d({type:I$e,json:{default:"none",write:!0}})],tg.prototype,"decoration",void 0),u([d({type:String,json:{write:!0}})],tg.prototype,"family",void 0),u([d({type:Number,json:{write:{overridePolicy:(t,e,r)=>({enabled:!r||!r.textSymbol3D})}}})],tg.prototype,"size",void 0),u([cr("size")],tg.prototype,"castSize",null),u([d({type:$$e,json:{default:"normal",write:!0}})],tg.prototype,"style",void 0),u([d({type:L$e,json:{default:"normal",write:!0}})],tg.prototype,"weight",void 0),tg=hB=u([I("esri.symbols.Font")],tg);const S4=tg;function xE(t,e){const r=e&&e.url&&e.url.path;if(t&&r&&(t=wu(t,r,{preserveProtocolRelative:!0}),e.portalItem&&e.readResourcePaths)){const i=uq(t,e.portalItem.itemUrl);i!=null&&F$e.test(i)&&e.readResourcePaths.push(e.portalItem.resourceFromPath(i).path)}return dB(t,e&&e.portal)}function gw(t,e,r=qR.YES){if(t==null)return t;!Au(t)&&e&&e.blockedRelativeUrls&&e.blockedRelativeUrls.push(t);let i=wu(t);if(e){const s=e.verifyItemRelativeUrls&&e.verifyItemRelativeUrls.rootPath||e.url&&e.url.path;if(s){const n=dB(s,e.portal),o=dB(i,e.portal);i=uq(o,n,n),i!=null&&i!==o&&i!==t&&e.verifyItemRelativeUrls&&e.verifyItemRelativeUrls.writtenUrls.push(i)}}return i=xpe(i,e==null?void 0:e.portal),Au(i)&&(i=ip(i)),e!=null&&e.resources&&(e!=null&&e.portalItem)&&!Au(i)&&!pm(i)&&r===qR.YES&&e.resources.toKeep.push({resource:e.portalItem.resourceFromPath(i),compress:!1}),i}function aW(t,e,r){return xE(t,r)}function Y_(t,e,r,i){const s=gw(t,i);s!==void 0&&(e[r]=s)}const wpe=/\/items\/([^\/]+)\/resources\/(.*)/,F$e=/^\.\/resources\//;function U$e(t){var e;return((e=(t==null?void 0:t.match(wpe))??null)==null?void 0:e[1])??null}function k$e(t){const e=(t==null?void 0:t.match(wpe))??null;if(e==null)return null;const r=e[2],i=r.lastIndexOf("/");if(i===-1){const{path:o,extension:a}=nK(r);return{prefix:null,filename:o,extension:a}}const{path:s,extension:n}=nK(r.slice(i+1));return{prefix:r.slice(0,i),filename:s,extension:n}}function xpe(t,e){return e&&!e.isPortal&&e.urlKey&&e.customBaseUrl?sV(t,`${e.urlKey}.${e.customBaseUrl}`,e.portalHostname):t}function dB(t,e){if(!e||e.isPortal||!e.urlKey||!e.customBaseUrl)return t;const r=`${e.urlKey}.${e.customBaseUrl}`,i=aq();return wS(i,`${i.scheme}://${r}`)?sV(t,e.portalHostname,r):sV(t,r,e.portalHostname)}var qR;(function(t){t[t.YES=0]="YES",t[t.NO=1]="NO"})(qR||(qR={}));const Dxt=Object.freeze(Object.defineProperty({__proto__:null,get MarkKeep(){return qR},ensureMainOnlineDomain:xpe,fromJSON:xE,itemIdFromResourceUrl:U$e,prefixAndFilenameFromResourceUrl:k$e,read:aW,toJSON:gw,write:Y_},Symbol.toStringTag,{value:"Module"}));var pB;const V$e=Ta()({circle:"circle",square:"square",cross:"cross",x:"x",kite:"kite",triangle:"triangle"});let E1=pB=class extends ve{constructor(t){super(t)}readHref(t,e,r){return t?xE(t,r):e.dataURI}writeHref(t,e,r,i){t&&(pm(t)?e.dataURI=t:(e.href=gw(t,i),Au(e.href)&&(e.href=ip(e.href))))}clone(){return new pB({href:this.href,primitive:this.primitive})}};u([d({type:String,json:{write:!0,read:{source:["href","dataURI"]}}})],E1.prototype,"href",void 0),u([Fe("href")],E1.prototype,"readHref",null),u([He("href",{href:{type:String},dataURI:{type:String}})],E1.prototype,"writeHref",null),u([gt(V$e)],E1.prototype,"primitive",void 0),E1=pB=u([I("esri.symbols.support.IconSymbol3DLayerResource")],E1);const B$e="circle";var fB;let b2=fB=class extends Te{constructor(){super(...arguments),this.x=0,this.y=0}clone(){return new fB({x:this.x,y:this.y})}};u([d({type:Number})],b2.prototype,"x",void 0),u([d({type:Number})],b2.prototype,"y",void 0),b2=fB=u([I("esri.symbols.support.Symbol3DAnchorPosition2D")],b2);var mB;let EA=mB=class extends ve{constructor(t){super(t),this.color=new Ze([0,0,0,1]),this.size=Vh(1)}clone(){const t={color:v(this.color)?this.color.clone():null,size:this.size};return new mB(t)}};u([d(ly)],EA.prototype,"color",void 0),u([d(am)],EA.prototype,"size",void 0),EA=mB=u([I("esri.symbols.support.Symbol3DIconOutline")],EA);var TT;const Tpe="esri.symbols.IconSymbol3DLayer";let tf=TT=class extends gm{constructor(t){super(t),this.material=null,this.resource=null,this.type="icon",this.size=12,this.anchor="center",this.anchorPosition=null,this.outline=null}clone(){return new TT({anchor:this.anchor,anchorPosition:this.anchorPosition&&this.anchorPosition.clone(),enabled:this.enabled,material:v(this.material)?this.material.clone():null,outline:v(this.outline)?this.outline.clone():null,resource:this.resource&&this.resource.clone(),size:this.size})}static fromSimpleMarkerSymbol(t){const e=t.color||z3,r=GK(t),i=t.outline&&t.outline.width>0?{size:t.outline.width,color:(t.outline.color||z3).clone()}:null;return new TT({size:t.size,resource:{primitive:G$e(t.style)},material:{color:e},outline:i,anchor:r?"relative":void 0,anchorPosition:r})}static fromPictureMarkerSymbol(t){const e=!t.color||g$e(t.color)?z3:t.color,r=GK(t);return new TT({size:t.width<=t.height?t.height:t.width,resource:{href:t.url},material:{color:e.clone()},anchor:r?"relative":void 0,anchorPosition:r})}static fromCIMSymbol(t){return new TT({resource:{href:ihe({mediaType:"application/json",data:JSON.stringify(t.data)})}})}};function GK(t){const e="width"in t?t.width:t.size,r="height"in t?t.height:t.size,i=jK(t.xoffset),s=jK(t.yoffset);return(i||s)&&e&&r?{x:-i/e,y:s/r}:null}function jK(t){return isFinite(t)?t:0}u([d({type:Ou,json:{write:!0}})],tf.prototype,"material",void 0),u([d({type:E1,json:{write:!0}})],tf.prototype,"resource",void 0),u([gt({Icon:"icon"},{readOnly:!0})],tf.prototype,"type",void 0),u([d(am)],tf.prototype,"size",void 0),u([gt({center:"center",left:"left",right:"right",top:"top",bottom:"bottom",topLeft:"top-left",topRight:"top-right",bottomLeft:"bottom-left",bottomRight:"bottom-right",relative:"relative"}),d({json:{default:"center"}})],tf.prototype,"anchor",void 0),u([d({type:b2,json:{type:[Number],read:{reader:t=>new b2({x:t[0],y:t[1]})},write:{writer:(t,e)=>{e.anchorPosition=[t.x,t.y]},overridePolicy(){return{enabled:this.anchor==="relative"}}}}})],tf.prototype,"anchorPosition",void 0),u([d({type:EA,json:{write:!0}})],tf.prototype,"outline",void 0),tf=TT=u([I(Tpe)],tf);const z$e={circle:"circle",cross:"cross",diamond:"kite",square:"square",x:"x",triangle:"triangle",path:null};function G$e(t){return z$e[t]||(se.getLogger(Tpe).warn(`${t} cannot be mapped to Icon symbol. Fallback to "circle"`),"circle")}const __=tf;let C1=class extends bs(ve){constructor(e){super(e),this.type="style",this.placement="begin-end",this.style="arrow",this.color=null}equals(e){return v(e)&&e.placement===this.placement&&e.style===this.style&&(C(this.color)&&C(e.color)||v(this.color)&&v(e.color)&&this.color.toJSON()===e.color.toJSON())}};u([d({type:["style"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],C1.prototype,"type",void 0),u([d({type:c$e,json:{default:"begin-end",write:!0}})],C1.prototype,"placement",void 0),u([d({type:ipe,json:{default:"arrow",write:!0}})],C1.prototype,"style",void 0),u([d({type:Ze,json:{type:[Gi],default:null,write:!0}})],C1.prototype,"color",void 0),C1=u([I("esri.symbols.LineStyleMarker3D")],C1);const gB=C1;var uL;let rf=uL=class extends gm{constructor(t){super(t),this.material=null,this.type="line",this.join="miter",this.cap="butt",this.size=Vh(1),this.pattern=null,this.marker=null}clone(){const t={enabled:this.enabled,material:v(this.material)?this.material.clone():null,size:this.size,join:this.join,cap:this.cap,pattern:v(this.pattern)?this.pattern.clone():null,marker:v(this.marker)?this.marker.clone():null};return new uL(t)}static fromSimpleLineSymbol(t){var r;const e={enabled:!0,size:t.width??Vh(1),cap:t.cap||"butt",join:t.join||"miter",pattern:t.style&&t.style!=="inside-frame"?new Qq({style:t.style}):null,material:new Ou({color:(t.color||z3).clone()}),marker:t.marker?new gB({placement:t.marker.placement,style:t.marker.style,color:((r=t.marker.color)==null?void 0:r.clone())??null}):null};return new uL(e)}};u([d({type:Ou,json:{write:!0}})],rf.prototype,"material",void 0),u([gt({Line:"line"},{readOnly:!0})],rf.prototype,"type",void 0),u([d({type:ype,json:{write:!0,default:"miter"}})],rf.prototype,"join",void 0),u([d({type:oW,json:{write:!0,default:"butt"}})],rf.prototype,"cap",void 0),u([d(am)],rf.prototype,"size",void 0),u([d(lpe)],rf.prototype,"pattern",void 0),u([d({types:{key:"type",base:gB,typeMap:{style:gB}},json:{write:!0}})],rf.prototype,"marker",void 0),rf=uL=u([I("esri.symbols.LineSymbol3DLayer")],rf);const sM=rf;var yB;const j$e=Ta()({sphere:"sphere",cylinder:"cylinder",cube:"cube",cone:"cone",diamond:"diamond",tetrahedron:"tetrahedron",invertedCone:"inverted-cone"});let CA=yB=class extends ve{clone(){return new yB({href:this.href,primitive:this.primitive})}};u([d({type:String,json:{read:aW,write:Y_}})],CA.prototype,"href",void 0),u([gt(j$e)],CA.prototype,"primitive",void 0),CA=yB=u([I("esri.symbols.support.ObjectSymbol3DLayerResource")],CA);const Spe="sphere";var _B;let gb=_B=class extends Te{constructor(){super(...arguments),this.x=0,this.y=0,this.z=0}clone(){return new _B({x:this.x,y:this.y,z:this.z})}};u([d({type:Number})],gb.prototype,"x",void 0),u([d({type:Number})],gb.prototype,"y",void 0),u([d({type:Number})],gb.prototype,"z",void 0),gb=_B=u([I("esri.symbols.support.Symbol3DAnchorPosition3D")],gb);var vB;let Da=vB=class extends gm{constructor(t){super(t),this.material=null,this.castShadows=!0,this.resource=null,this.type="object",this.width=void 0,this.height=void 0,this.depth=void 0,this.anchor=void 0,this.anchorPosition=void 0,this.heading=void 0,this.tilt=void 0,this.roll=void 0}clone(){return new vB({heading:this.heading,tilt:this.tilt,roll:this.roll,anchor:this.anchor,anchorPosition:this.anchorPosition&&this.anchorPosition.clone(),depth:this.depth,enabled:this.enabled,height:this.height,material:v(this.material)?this.material.clone():null,castShadows:this.castShadows,resource:this.resource&&this.resource.clone(),width:this.width})}get isPrimitive(){return!this.resource||typeof this.resource.href!="string"}};u([d({type:Ou,json:{write:!0}})],Da.prototype,"material",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],Da.prototype,"castShadows",void 0),u([d({type:CA,json:{write:!0}})],Da.prototype,"resource",void 0),u([gt({Object:"object"},{readOnly:!0})],Da.prototype,"type",void 0),u([d({type:Number,json:{write:!0}})],Da.prototype,"width",void 0),u([d({type:Number,json:{write:!0}})],Da.prototype,"height",void 0),u([d({type:Number,json:{write:!0}})],Da.prototype,"depth",void 0),u([gt({center:"center",top:"top",bottom:"bottom",origin:"origin",relative:"relative"}),d({json:{default:"origin"}})],Da.prototype,"anchor",void 0),u([d({type:gb,json:{type:[Number],read:{reader:t=>new gb({x:t[0],y:t[1],z:t[2]})},write:{writer:(t,e)=>{e.anchorPosition=[t.x,t.y,t.z]},overridePolicy(){return{enabled:this.anchor==="relative"}}}}})],Da.prototype,"anchorPosition",void 0),u([d({type:Number,json:{write:!0}})],Da.prototype,"heading",void 0),u([d({type:Number,json:{write:!0}})],Da.prototype,"tilt",void 0),u([d({type:Number,json:{write:!0}})],Da.prototype,"roll",void 0),u([d({readOnly:!0})],Da.prototype,"isPrimitive",null),Da=vB=u([I("esri.symbols.ObjectSymbol3DLayer")],Da);const lW=Da;var bB;let wl=bB=class extends gm{constructor(t){super(t),this.material=null,this.castShadows=!0,this.type="path",this.profile="circle",this.join="miter",this.cap="butt",this.width=void 0,this.height=void 0,this.anchor="center",this.profileRotation="all"}readWidth(t,e){return t??(e.height==null&&e.size!=null?e.size:void 0)}readHeight(t,e){return t??(e.width==null&&e.size!=null?e.size:void 0)}clone(){return new bB({enabled:this.enabled,material:v(this.material)?this.material.clone():null,castShadows:this.castShadows,profile:this.profile,join:this.join,cap:this.cap,width:this.width,height:this.height,profileRotation:this.profileRotation,anchor:this.anchor})}};u([d({type:Ou,json:{write:!0}})],wl.prototype,"material",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],wl.prototype,"castShadows",void 0),u([gt({Path:"path"},{readOnly:!0})],wl.prototype,"type",void 0),u([d({type:["circle","quad"],json:{write:!0,default:"circle"}})],wl.prototype,"profile",void 0),u([d({type:ype,json:{write:!0,default:"miter"}})],wl.prototype,"join",void 0),u([d({type:P$e,json:{write:!0,default:"butt"}})],wl.prototype,"cap",void 0),u([d({type:Number,json:{write:{enabled:!0,target:{width:{type:Number},size:{type:Number}}}}})],wl.prototype,"width",void 0),u([Fe("width",["width","size","height"])],wl.prototype,"readWidth",null),u([d({type:Number,json:{write:!0}})],wl.prototype,"height",void 0),u([Fe("height",["height","size","width"])],wl.prototype,"readHeight",null),u([d({type:["center","bottom","top"],json:{write:!0,default:"center"}})],wl.prototype,"anchor",void 0),u([d({type:["heading","all"],json:{write:!0,default:"all"}})],wl.prototype,"profileRotation",void 0),wl=bB=u([I("esri.symbols.PathSymbol3DLayer")],wl);const cW=wl;var wB;let w2=wB=class extends ve{constructor(){super(...arguments),this.color=new Ze([0,0,0,1]),this.size=0}clone(){const t={color:ne(this.color),size:this.size};return new wB(t)}};u([d(ly)],w2.prototype,"color",void 0),u([d(am)],w2.prototype,"size",void 0),w2=wB=u([I("esri.symbols.support.Symbol3DHalo")],w2);let j3=class extends bs(ve){constructor(e){super(e),this.color=null}};u([d(ly)],j3.prototype,"color",void 0),j3=u([I("esri.symbols.support.Symbol3DTextBackground")],j3);var hL;let rc=hL=class extends gm{constructor(t){super(t),this._userSize=void 0,this.halo=null,this.horizontalAlignment="center",this.lineHeight=1,this.material=null,this.background=null,this.text=null,this.type="text",this.verticalAlignment="baseline"}get font(){return this._get("font")||null}set font(t){v(t)&&v(this._userSize)&&(t.size=this._userSize),this._set("font",t)}writeFont(t,e,r,i){const s={...i,textSymbol3D:!0};e.font=t.write({},s),delete e.font.size}get size(){return v(this._userSize)?this._userSize:v(this.font)&&this.font.size!=null?this.font.size:9}set size(t){this._userSize=t,v(this.font)&&(this.font.size=this._userSize),this.notifyChange("size")}clone(){const t=new hL({enabled:this.enabled,font:this.font&&ne(this.font),halo:this.halo&&ne(this.halo),horizontalAlignment:this.horizontalAlignment,lineHeight:this.lineHeight,material:v(this.material)?this.material.clone():null,text:this.text,verticalAlignment:this.verticalAlignment,background:ne(this.background)});return t._userSize=this._userSize,t}static fromTextSymbol(t){return new hL({font:v(t.font)?t.font.clone():new S4,halo:H$e(t.haloColor,t.haloSize),horizontalAlignment:t.horizontalAlignment,lineHeight:t.lineHeight,material:t.color?new Ou({color:t.color.clone()}):null,text:t.text,verticalAlignment:t.verticalAlignment,background:t.backgroundColor?new j3({color:t.backgroundColor.clone()}):null})}};function H$e(t,e){return t&&e!=null&&e>0?new w2({color:ne(t),size:e}):null}u([d({type:S4,json:{write:!0}})],rc.prototype,"font",null),u([He("font")],rc.prototype,"writeFont",null),u([d({type:w2,json:{write:!0}})],rc.prototype,"halo",void 0),u([d({...vpe,json:{default:"center",write:!0}})],rc.prototype,"horizontalAlignment",void 0),u([d({..._pe,json:{default:1,write:!0}})],rc.prototype,"lineHeight",void 0),u([d({type:Ou,json:{write:!0}})],rc.prototype,"material",void 0),u([d({type:j3,json:{write:!0}})],rc.prototype,"background",void 0),u([d(am)],rc.prototype,"size",null),u([d({type:String,json:{write:!0}})],rc.prototype,"text",void 0),u([gt({Text:"text"},{readOnly:!0})],rc.prototype,"type",void 0),u([d({...bpe,json:{default:"baseline",write:!0}})],rc.prototype,"verticalAlignment",void 0),rc=hL=u([I("esri.symbols.TextSymbol3DLayer")],rc);const Ww=rc;var xB;let T0=xB=class extends gm{constructor(t){super(t),this.color=TB.clone(),this.type="water",this.waterbodySize="medium",this.waveDirection=null,this.waveStrength="moderate"}clone(){return new xB({color:ne(this.color),waterbodySize:this.waterbodySize,waveDirection:this.waveDirection,waveStrength:this.waveStrength})}};u([d({type:Ze,nonNullable:!0,json:{type:[Gi],write:(t,e,r)=>e[r]=t.toArray(Ze.AlphaMode.UNLESS_OPAQUE),default:()=>TB.clone(),defaultEquals:t=>t.toCss(!0)===TB.toCss(!0)}})],T0.prototype,"color",void 0),u([gt({Water:"water"},{readOnly:!0})],T0.prototype,"type",void 0),u([d({type:["small","medium","large"],json:{write:!0,default:"medium"}})],T0.prototype,"waterbodySize",void 0),u([d({type:Number,json:{write:!0,default:null}})],T0.prototype,"waveDirection",void 0),u([d({type:["calm","rippled","slight","moderate"],json:{write:!0,default:"moderate"}})],T0.prototype,"waveStrength",void 0),T0=xB=u([I("esri.symbols.WaterSymbol3DLayer")],T0);const TB=new Ze([0,119,190]),Epe=T0;var SB;let A1=SB=class extends Te{constructor(t){super(t),this.name=null,this.styleUrl=null,this.styleName=null,this.portal=null}clone(){return new SB({name:this.name,styleUrl:this.styleUrl,styleName:this.styleName,portal:this.portal})}};u([d({type:String})],A1.prototype,"name",void 0),u([d({type:String})],A1.prototype,"styleUrl",void 0),u([d({type:String})],A1.prototype,"styleName",void 0),u([d({type:tl})],A1.prototype,"portal",void 0),A1=SB=u([I("esri.symbols.support.StyleOrigin")],A1);const EB=A1;var CB;let H3=CB=class extends Te{constructor(){super(...arguments),this.url=""}clone(){return new CB({url:this.url})}};u([d({type:String})],H3.prototype,"url",void 0),H3=CB=u([I("esri.symbols.support.Thumbnail")],H3);const Cpe={icon:__,object:lW,line:sM,path:cW,fill:iM,extrude:rpe,text:Ww,water:Epe},q$e=Pt.ofType({base:gm,key:"type",typeMap:Cpe,errorContext:"symbol-layer"});let sf=class extends Uc{constructor(e){super(e),this.styleOrigin=null,this.thumbnail=null,this.type=null;const r=this.__accessor__&&this.__accessor__.metadatas&&this.__accessor__.metadatas.symbolLayers,i=r&&r.type||Pt;this._set("symbolLayers",new i)}get color(){return null}set color(e){this.constructed&&se.getLogger(this.declaredClass).error("Symbol3D does not support colors on the symbol level. Colors may be set on individual symbol layer materials instead.")}set symbolLayers(e){aw(e,this._get("symbolLayers"))}readStyleOrigin(e,r,i){if(e.styleUrl&&e.name){const s=xE(e.styleUrl,i);return new EB({styleUrl:s,name:e.name})}if(e.styleName&&e.name)return new EB({portal:i&&i.portal||tl.getDefault(),styleName:e.styleName,name:e.name});i&&i.messages&&i.messages.push(new rm("symbol3d:incomplete-style-origin","Style origin requires either a 'styleUrl' or 'styleName' and a 'name' property",{context:i,definition:e}))}writeStyleOrigin(e,r,i,s){if(e.styleUrl&&e.name){let n=gw(e.styleUrl,s);Au(n)&&(n=ip(n)),r.styleOrigin={styleUrl:n,name:e.name}}else e.styleName&&e.name&&(e.portal&&s&&s.portal&&!the(e.portal.restUrl,s.portal.restUrl)?s&&s.messages&&s.messages.push(new rm("symbol:cross-portal","The symbol style origin cannot be persisted because it refers to an item on a different portal than the one being saved to.",{symbol:this})):r.styleOrigin={styleName:e.styleName,name:e.name})}normalizeCtorArgs(e){return e instanceof gm||e&&Cpe[e.type]?{symbolLayers:[e]}:Array.isArray(e)?{symbolLayers:e}:e}};u([d({json:{read:!1,write:!1}})],sf.prototype,"color",null),u([d({type:q$e,nonNullable:!0,json:{write:!0}}),cr(zue)],sf.prototype,"symbolLayers",null),u([d({type:EB})],sf.prototype,"styleOrigin",void 0),u([Fe("styleOrigin")],sf.prototype,"readStyleOrigin",null),u([He("styleOrigin",{"styleOrigin.styleUrl":{type:String},"styleOrigin.styleName":{type:String},"styleOrigin.name":{type:String}})],sf.prototype,"writeStyleOrigin",null),u([d({type:H3,json:{read:!1}})],sf.prototype,"thumbnail",void 0),u([d({type:["point-3d","line-3d","polygon-3d","mesh-3d","label-3d"],readOnly:!0})],sf.prototype,"type",void 0),sf=u([I("esri.symbols.Symbol3D")],sf);const TE=sf;let AA=class extends ve{constructor(e){super(e),this.visible=!0}clone(){}};u([d({type:["line"],readOnly:!0,json:{read:!1,write:{ignoreOrigin:!0}}})],AA.prototype,"type",void 0),u([d({readOnly:!0})],AA.prototype,"visible",void 0),AA=u([I("esri.symbols.callouts.Callout3D")],AA);const Ape=AA;var AB;let dL=AB=class extends ve{constructor(){super(...arguments),this.color=new Ze("white")}clone(){return new AB({color:ne(this.color)})}};u([d(ly)],dL.prototype,"color",void 0),dL=AB=u([I("esri.symbols.callouts.LineCallout3DBorder")],dL);const Rpe=dL;Object.freeze(Object.defineProperty({__proto__:null,default:Rpe},Symbol.toStringTag,{value:"Module"}));var RB;let S0=RB=class extends Ape{constructor(t){super(t),this.type="line",this.color=new Ze([0,0,0,1]),this.size=Vh(1),this.border=null}get visible(){return this.size>0&&v(this.color)&&this.color.a>0}clone(){return new RB({color:ne(this.color),size:this.size,border:ne(this.border)})}};u([gt({line:"line"},{readOnly:!0})],S0.prototype,"type",void 0),u([d(ly)],S0.prototype,"color",void 0),u([d(am)],S0.prototype,"size",void 0),u([d({type:Rpe,json:{write:!0}})],S0.prototype,"border",void 0),u([d({readOnly:!0})],S0.prototype,"visible",null),S0=RB=u([I("esri.symbols.callouts.LineCallout3D")],S0);const W$e=S0;function uW(t){if(!t)return!1;const e=t.verticalOffset;return!!e&&!(e.screenLength<=0||v(e.maxWorldLength)&&e.maxWorldLength<=0)}function Ope(t){if(!t||!t.supportsCallout||!t.supportsCallout())return!1;const e=t.callout;return!!e&&!!e.visible&&!!uW(t)}function hW(t){return t.type==="point-3d"||t.type==="label-3d"}function Mpe(t){return t.horizontalAlignment==="center"}const Ppe={types:{key:"type",base:Ape,typeMap:{line:W$e}},json:{write:!0}};var OB;let ST=OB=class extends ve{constructor(t){super(t),this.screenLength=0,this.minWorldLength=0,this.maxWorldLength=null}clone(){return new OB({screenLength:this.screenLength,minWorldLength:this.minWorldLength,maxWorldLength:this.maxWorldLength})}};u([d(am)],ST.prototype,"screenLength",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0,default:0}})],ST.prototype,"minWorldLength",void 0),u([d({type:Number,json:{write:!0}})],ST.prototype,"maxWorldLength",void 0),ST=OB=u([I("esri.symbols.support.Symbol3DVerticalOffset")],ST);const Ipe=ST;var pL;const $pe=Pt.ofType({base:null,key:"type",typeMap:{text:Ww}});let E0=pL=class extends TE{constructor(t){super(t),this.verticalOffset=null,this.callout=null,this.styleOrigin=null,this.symbolLayers=new $pe,this.type="label-3d"}supportsCallout(){return!0}hasVisibleCallout(){return Ope(this)}hasVisibleVerticalOffset(){return uW(this)}clone(){return new pL({styleOrigin:ne(this.styleOrigin),symbolLayers:ne(this.symbolLayers),thumbnail:ne(this.thumbnail),callout:ne(this.callout),verticalOffset:ne(this.verticalOffset)})}static fromTextSymbol(t){return new pL({symbolLayers:[Ww.fromTextSymbol(t)]})}};u([d({type:Ipe,json:{write:!0}})],E0.prototype,"verticalOffset",void 0),u([d(Ppe)],E0.prototype,"callout",void 0),u([d({json:{read:!1,write:!1}})],E0.prototype,"styleOrigin",void 0),u([d({type:$pe})],E0.prototype,"symbolLayers",void 0),u([gt({LabelSymbol3D:"label-3d"},{readOnly:!0})],E0.prototype,"type",void 0),E0=pL=u([I("esri.symbols.LabelSymbol3D")],E0);const E4=E0;var fL;const Lpe=Pt.ofType({base:null,key:"type",typeMap:{line:sM,path:cW}}),X$e=Pt.ofType({base:null,key:"type",typeMap:{line:sM,path:cW}});let RA=fL=class extends TE{constructor(t){super(t),this.symbolLayers=new Lpe,this.type="line-3d"}clone(){return new fL({styleOrigin:ne(this.styleOrigin),symbolLayers:ne(this.symbolLayers),thumbnail:ne(this.thumbnail)})}static fromSimpleLineSymbol(t){return new fL({symbolLayers:[sM.fromSimpleLineSymbol(t)]})}};u([d({type:Lpe,json:{type:X$e}})],RA.prototype,"symbolLayers",void 0),u([gt({LineSymbol3D:"line-3d"},{readOnly:!0})],RA.prototype,"type",void 0),RA=fL=u([I("esri.symbols.LineSymbol3D")],RA);const C4=RA;let C0=class extends Uc{constructor(e){super(e),this.angle=0,this.type=null,this.xoffset=0,this.yoffset=0,this.size=9}hash(){return`${this.type}.${this.angle}.${this.size}.${this.xoffset}.${this.yoffset}`}};u([d({type:Number,json:{read:t=>t&&-1*t,write:(t,e)=>e.angle=t&&-1*t}})],C0.prototype,"angle",void 0),u([d({type:["simple-marker","picture-marker"],readOnly:!0})],C0.prototype,"type",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],C0.prototype,"xoffset",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],C0.prototype,"yoffset",void 0),u([d({type:Number,cast:t=>t==="auto"?t:hi(t),json:{write:!0}})],C0.prototype,"size",void 0),C0=u([I("esri.symbols.MarkerSymbol")],C0);const Dpe=C0;var mL;const Npe=Pt.ofType({base:null,key:"type",typeMap:{fill:iM}});let OA=mL=class extends TE{constructor(t){super(t),this.symbolLayers=new Npe,this.type="mesh-3d"}clone(){return new mL({styleOrigin:ne(this.styleOrigin),symbolLayers:ne(this.symbolLayers),thumbnail:ne(this.thumbnail)})}static fromSimpleFillSymbol(t){return new mL({symbolLayers:[iM.fromSimpleFillSymbol(t)]})}};u([d({type:Npe})],OA.prototype,"symbolLayers",void 0),u([gt({MeshSymbol3D:"mesh-3d"},{readOnly:!0})],OA.prototype,"type",void 0),OA=mL=u([I("esri.symbols.MeshSymbol3D")],OA);const A4=OA;function Y$e(t,e,r){return e.imageData?ihe({mediaType:e.contentType||"image/png",isBase64:!0,data:e.imageData}):Fpe(e.url,r)}function Fpe(t,e){var r;return J$e(e)&&!Au(t)&&((r=e==null?void 0:e.layer)!=null&&r.parsedUrl)?lw(e.layer.parsedUrl.path,"images",t):xE(t,e)}function Z$e(t,e,r,i){if(pm(t)){const s=ZO(t);if(!s)return;e.contentType=s.mediaType,e.imageData=s.data,r&&r.imageData===e.imageData&&r.url&&Y_(r.url,e,"url",i)}else Y_(t,e,"url",i)}const Upe={json:{read:{source:["imageData","url"],reader:Y$e},write:{writer(t,e,r,i){Z$e(t,e,this.source,i)}}}},kpe={readOnly:!0,json:{read:{source:["imageData","url"],reader(t,e,r){const i={};return e.imageData&&(i.imageData=e.imageData),e.contentType&&(i.contentType=e.contentType),e.url&&(i.url=Fpe(e.url,r)),i}}}};function J$e(t){var e,r;return!(t==null||t.origin!=="service"&&t.origin!=="portal-item"||((e=t.layer)==null?void 0:e.type)!=="feature"&&((r=t.layer)==null?void 0:r.type)!=="stream")}var MB;let sh=MB=class extends spe{constructor(...t){super(...t),this.type="picture-fill",this.url=null,this.xscale=1,this.yscale=1,this.width=12,this.height=12,this.xoffset=0,this.yoffset=0,this.source=null}normalizeCtorArgs(t,e,r,i){if(t&&typeof t!="string"&&t.imageData==null)return t;const s={};return t&&(s.url=t),e&&(s.outline=e),r!=null&&(s.width=hi(r)),i!=null&&(s.height=hi(i)),s}clone(){const t=new MB({color:ne(this.color),height:this.height,outline:this.outline&&this.outline.clone(),url:this.url,width:this.width,xoffset:this.xoffset,xscale:this.xscale,yoffset:this.yoffset,yscale:this.yscale});return t._set("source",ne(this.source)),t}hash(){var t;return`${super.hash()}.${(t=this.color)==null?void 0:t.hash()}.${this.height}.${this.url}.${this.width}.${this.xoffset}.${this.xscale}.${this.yoffset}.${this.yscale}`}};u([gt({esriPFS:"picture-fill"},{readOnly:!0})],sh.prototype,"type",void 0),u([d(Upe)],sh.prototype,"url",void 0),u([d({type:Number,json:{write:!0}})],sh.prototype,"xscale",void 0),u([d({type:Number,json:{write:!0}})],sh.prototype,"yscale",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],sh.prototype,"width",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],sh.prototype,"height",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],sh.prototype,"xoffset",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],sh.prototype,"yoffset",void 0),u([d(kpe)],sh.prototype,"source",void 0),sh=MB=u([I("esri.symbols.PictureFillSymbol")],sh);const Vpe=sh;var PB;let gd=PB=class extends Dpe{constructor(...t){super(...t),this.color=null,this.type="picture-marker",this.url=null,this.source=null,this.height=12,this.width=12,this.size=null}normalizeCtorArgs(t,e,r){if(t&&typeof t!="string"&&t.imageData==null)return t;const i={};return t&&(i.url=t),e!=null&&(i.width=hi(e)),r!=null&&(i.height=hi(r)),i}readHeight(t,e){return e.size||t}readWidth(t,e){return e.size||t}clone(){const t=new PB({angle:this.angle,height:this.height,url:this.url,width:this.width,xoffset:this.xoffset,yoffset:this.yoffset});return t._set("source",ne(this.source)),t}hash(){return`${super.hash()}.${this.height}.${this.url}.${this.width}`}};u([d({json:{write:!1}})],gd.prototype,"color",void 0),u([gt({esriPMS:"picture-marker"},{readOnly:!0})],gd.prototype,"type",void 0),u([d(Upe)],gd.prototype,"url",void 0),u([d(kpe)],gd.prototype,"source",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],gd.prototype,"height",void 0),u([Fe("height",["height","size"])],gd.prototype,"readHeight",null),u([d({type:Number,cast:hi,json:{write:!0}})],gd.prototype,"width",void 0),u([d({json:{write:!1}})],gd.prototype,"size",void 0),gd=PB=u([I("esri.symbols.PictureMarkerSymbol")],gd);const nM=gd;var R1;const Bpe=Pt.ofType({base:null,key:"type",typeMap:{icon:__,object:lW,text:Ww}});let O1=R1=class extends TE{constructor(t){super(t),this.verticalOffset=null,this.callout=null,this.symbolLayers=new Bpe,this.type="point-3d"}supportsCallout(){if((this.symbolLayers?this.symbolLayers.length:0)<1)return!1;for(const t of this.symbolLayers.items)switch(t.type){case"icon":case"text":case"object":continue;default:return!1}return!0}hasVisibleCallout(){return Ope(this)}hasVisibleVerticalOffset(){return uW(this)}clone(){return new R1({verticalOffset:ne(this.verticalOffset),callout:ne(this.callout),styleOrigin:ne(this.styleOrigin),symbolLayers:ne(this.symbolLayers),thumbnail:ne(this.thumbnail)})}static fromSimpleMarkerSymbol(t){return new R1({symbolLayers:[__.fromSimpleMarkerSymbol(t)]})}static fromPictureMarkerSymbol(t){return new R1({symbolLayers:[__.fromPictureMarkerSymbol(t)]})}static fromCIMSymbol(t){var i,s;if(((s=(i=t.data)==null?void 0:i.symbol)==null?void 0:s.type)!=="CIMPointSymbol")return null;const r=t.data.symbol;return new R1(r!=null&&r.callout?{symbolLayers:[__.fromCIMSymbol(t)],callout:{type:"line",size:.5,color:[0,0,0]},verticalOffset:{screenLength:40}}:{symbolLayers:[__.fromCIMSymbol(t)]})}static fromTextSymbol(t){return new R1({symbolLayers:[Ww.fromTextSymbol(t)]})}};u([d({type:Ipe,json:{write:!0}})],O1.prototype,"verticalOffset",void 0),u([d(Ppe)],O1.prototype,"callout",void 0),u([d({type:Bpe,json:{origins:{"web-scene":{write:!0}}}})],O1.prototype,"symbolLayers",void 0),u([gt({PointSymbol3D:"point-3d"},{readOnly:!0})],O1.prototype,"type",void 0),O1=R1=u([I("esri.symbols.PointSymbol3D")],O1);const v_=O1;var MA;const zpe=Pt.ofType({base:null,key:"type",typeMap:{extrude:rpe,fill:iM,icon:__,line:sM,object:lW,text:Ww,water:Epe}});let PA=MA=class extends TE{constructor(t){super(t),this.symbolLayers=new zpe,this.type="polygon-3d"}clone(){return new MA({styleOrigin:ne(this.styleOrigin),symbolLayers:ne(this.symbolLayers),thumbnail:ne(this.thumbnail)})}static fromJSON(t){const e=new MA;if(e.read(t),e.symbolLayers.length===2&&e.symbolLayers.getItemAt(0).type==="fill"&&e.symbolLayers.getItemAt(1).type==="line"){const r=e.symbolLayers.getItemAt(0),i=e.symbolLayers.getItemAt(1);!i.enabled||t.symbolLayers&&t.symbolLayers[1]&&t.symbolLayers[1].enable===!1||(r.outline={size:i.size,color:v(i.material)?i.material.color:null}),e.symbolLayers.removeAt(1)}return e}static fromSimpleFillSymbol(t){return new MA({symbolLayers:[iM.fromSimpleFillSymbol(t)]})}};u([d({type:zpe,json:{write:!0}})],PA.prototype,"symbolLayers",void 0),u([gt({PolygonSymbol3D:"polygon-3d"},{readOnly:!0})],PA.prototype,"type",void 0),PA=MA=u([I("esri.symbols.PolygonSymbol3D")],PA);const oM=PA;var IB;const j6=new mr({esriSFSSolid:"solid",esriSFSNull:"none",esriSFSHorizontal:"horizontal",esriSFSVertical:"vertical",esriSFSForwardDiagonal:"forward-diagonal",esriSFSBackwardDiagonal:"backward-diagonal",esriSFSCross:"cross",esriSFSDiagonalCross:"diagonal-cross"});let M1=IB=class extends spe{constructor(...t){super(...t),this.color=new Ze([0,0,0,.25]),this.outline=new Yh,this.type="simple-fill",this.style="solid"}normalizeCtorArgs(t,e,r){if(t&&typeof t!="string")return t;const i={};return t&&(i.style=t),e&&(i.outline=e),r&&(i.color=r),i}clone(){return new IB({color:ne(this.color),outline:this.outline&&this.outline.clone(),style:this.style})}hash(){return`${super.hash()}${this.style}.${this.color&&this.color.hash()}`}};u([d()],M1.prototype,"color",void 0),u([d()],M1.prototype,"outline",void 0),u([gt({esriSFS:"simple-fill"},{readOnly:!0})],M1.prototype,"type",void 0),u([d({type:j6.apiValues,json:{read:j6.read,write:j6.write}})],M1.prototype,"style",void 0),M1=IB=u([I("esri.symbols.SimpleFillSymbol")],M1);const gv=M1;var $B;const H6=new mr({esriSMSCircle:"circle",esriSMSSquare:"square",esriSMSCross:"cross",esriSMSX:"x",esriSMSDiamond:"diamond",esriSMSTriangle:"triangle",esriSMSPath:"path"});let nf=$B=class extends Dpe{constructor(...t){super(...t),this.color=new Ze([255,255,255,.25]),this.type="simple-marker",this.size=12,this.style="circle",this.outline=new Yh}normalizeCtorArgs(t,e,r,i){if(t&&typeof t!="string")return t;const s={};return t&&(s.style=t),e!=null&&(s.size=hi(e)),r&&(s.outline=r),i&&(s.color=i),s}writeColor(t,e){t&&this.style!=="x"&&this.style!=="cross"&&(e.color=t.toJSON()),t===null&&(e.color=null)}set path(t){this.style="path",this._set("path",t)}clone(){return new $B({angle:this.angle,color:ne(this.color),outline:this.outline&&this.outline.clone(),path:this.path,size:this.size,style:this.style,xoffset:this.xoffset,yoffset:this.yoffset})}hash(){var t;return`${super.hash()}.${this.color&&this.color.hash()}.${this.path}.${this.style}.${(t=this.outline)==null?void 0:t.hash()}`}};u([d()],nf.prototype,"color",void 0),u([He("color")],nf.prototype,"writeColor",null),u([gt({esriSMS:"simple-marker"},{readOnly:!0})],nf.prototype,"type",void 0),u([d()],nf.prototype,"size",void 0),u([d({type:H6.apiValues,json:{read:H6.read,write:H6.write}})],nf.prototype,"style",void 0),u([d({type:String,json:{write:!0}})],nf.prototype,"path",null),u([d({types:{key:"type",base:null,defaultKeyValue:"simple-line",typeMap:{"simple-line":Yh}},json:{default:null,write:!0}})],nf.prototype,"outline",void 0),nf=$B=u([I("esri.symbols.SimpleMarkerSymbol")],nf);const yv=nf;var LB;let Fs=LB=class extends Uc{constructor(...t){super(...t),this.backgroundColor=null,this.borderLineColor=null,this.borderLineSize=null,this.font=new S4,this.horizontalAlignment="center",this.kerning=!0,this.haloColor=null,this.haloSize=null,this.rightToLeft=null,this.rotated=!1,this.text="",this.type="text",this.verticalAlignment="baseline",this.xoffset=0,this.yoffset=0,this.angle=0,this.width=null,this.lineWidth=192,this.lineHeight=1}normalizeCtorArgs(t,e,r){if(t&&typeof t!="string")return t;const i={};return t&&(i.text=t),e&&(i.font=e),r&&(i.color=r),i}writeLineWidth(t,e,r,i){i&&typeof i!="string"?i.origin:e[r]=t}castLineWidth(t){return hi(t)}writeLineHeight(t,e,r,i){i&&typeof i!="string"?i.origin:e[r]=t}clone(){return new LB({angle:this.angle,backgroundColor:ne(this.backgroundColor),borderLineColor:ne(this.borderLineColor),borderLineSize:this.borderLineSize,color:ne(this.color),font:this.font&&this.font.clone(),haloColor:ne(this.haloColor),haloSize:this.haloSize,horizontalAlignment:this.horizontalAlignment,kerning:this.kerning,lineHeight:this.lineHeight,lineWidth:this.lineWidth,rightToLeft:this.rightToLeft,rotated:this.rotated,text:this.text,verticalAlignment:this.verticalAlignment,width:this.width,xoffset:this.xoffset,yoffset:this.yoffset})}hash(){var t;return`${this.backgroundColor&&this.backgroundColor.hash()}.${this.borderLineColor}.${this.borderLineSize}.${(t=this.color)==null?void 0:t.hash()}.${this.font&&this.font.hash()}.${this.haloColor&&this.haloColor.hash()}.${this.haloSize}.${this.horizontalAlignment}.${this.kerning}.${this.rightToLeft}.${this.rotated}.${this.text}.${this.verticalAlignment}.${this.width}.${this.xoffset}.${this.yoffset}.${this.lineHeight}.${this.lineWidth}.${this.angle}`}};u([d({type:Ze,json:{write:!0}})],Fs.prototype,"backgroundColor",void 0),u([d({type:Ze,json:{write:!0}})],Fs.prototype,"borderLineColor",void 0),u([d({type:Number,json:{write:!0},cast:hi})],Fs.prototype,"borderLineSize",void 0),u([d({type:S4,json:{write:!0}})],Fs.prototype,"font",void 0),u([d({...vpe,json:{write:!0}})],Fs.prototype,"horizontalAlignment",void 0),u([d({type:Boolean,json:{write:!0}})],Fs.prototype,"kerning",void 0),u([d({type:Ze,json:{write:!0}})],Fs.prototype,"haloColor",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],Fs.prototype,"haloSize",void 0),u([d({type:Boolean,json:{write:!0}})],Fs.prototype,"rightToLeft",void 0),u([d({type:Boolean,json:{write:!0}})],Fs.prototype,"rotated",void 0),u([d({type:String,json:{write:!0}})],Fs.prototype,"text",void 0),u([gt({esriTS:"text"},{readOnly:!0})],Fs.prototype,"type",void 0),u([d({...bpe,json:{write:!0}})],Fs.prototype,"verticalAlignment",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],Fs.prototype,"xoffset",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],Fs.prototype,"yoffset",void 0),u([d({type:Number,json:{read:t=>t&&-1*t,write:(t,e)=>e.angle=t&&-1*t}})],Fs.prototype,"angle",void 0),u([d({type:Number,json:{write:!0}})],Fs.prototype,"width",void 0),u([d({type:Number})],Fs.prototype,"lineWidth",void 0),u([He("lineWidth")],Fs.prototype,"writeLineWidth",null),u([cr("lineWidth")],Fs.prototype,"castLineWidth",null),u([d(_pe)],Fs.prototype,"lineHeight",void 0),u([He("lineHeight")],Fs.prototype,"writeLineHeight",null),Fs=LB=u([I("esri.symbols.TextSymbol")],Fs);const SE=Fs;var DB;let yd=DB=class extends Uc{constructor(t){super(t),this.styleName=null,this.portal=null,this.styleUrl=null,this.thumbnail=null,this.name=null,this.type="web-style"}get _fetchCacheKey(){const t=v(this.portal)?this.portal:tl.getDefault(),e=t.user?t.user.username:null;return`${this.styleName}:${this.styleUrl}:${this.name}:${e}:${t.url}`}read(t,e){this.portal=e==null?void 0:e.portal,super.read(t,e)}clone(){return new DB({name:this.name,styleUrl:this.styleUrl,styleName:this.styleName,portal:this.portal})}fetchSymbol(t){return this._fetchSymbol("webRef",t)}fetchCIMSymbol(t){return this._fetchSymbol("cimRef",t)}async _fetchSymbol(t,e){const r=v(e)?e.cache:null,i=r?this._fetchCacheKey:null;if(v(r)){const a=i&&r.get(i);if(a)return a.clone()}const s=await K$e();fr(e);const n=s.resolveWebStyleSymbol(this,{portal:this.portal},t,e);n.catch(a=>{se.getLogger(this.declaredClass).error("#fetchSymbol()","Failed to create symbol from style",a)});const o=await n;return t==="webRef"&&o.type==="point-3d"||t==="cimRef"&&o.type==="cim"?(v(r)&&r.set(i,o.clone()),o):null}};function K$e(){return te(()=>import("./webStyleSymbolUtils-ff0caae8.js"),[])}u([d({json:{write:!1}})],yd.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],yd.prototype,"styleName",void 0),u([d({type:tl,json:{write:!1}})],yd.prototype,"portal",void 0),u([d({type:String,json:{read:aW,write:Y_}})],yd.prototype,"styleUrl",void 0),u([d({type:H3,json:{read:!1}})],yd.prototype,"thumbnail",void 0),u([d({type:String,json:{write:!0}})],yd.prototype,"name",void 0),u([gt({styleSymbolReference:"web-style"},{readOnly:!0})],yd.prototype,"type",void 0),u([d()],yd.prototype,"_fetchCacheKey",null),yd=DB=u([I("esri.symbols.WebStyleSymbol")],yd);const Xw=yd;function R4(t){if(!t)return!1;switch(t.type){case"picture-fill":case"picture-marker":case"simple-fill":case"simple-line":case"simple-marker":case"text":case"cim":return!0;default:return!1}}function $S(t){if(!t)return!1;switch(t.type){case"label-3d":case"line-3d":case"mesh-3d":case"point-3d":case"polygon-3d":return!0;default:return!1}}const Wb={base:Uc,key:"type",typeMap:{"simple-fill":gv,"picture-fill":Vpe,"picture-marker":nM,"simple-line":Yh,"simple-marker":yv,text:SE,"label-3d":E4,"line-3d":C4,"mesh-3d":A4,"point-3d":v_,"polygon-3d":oM,"web-style":Xw,cim:wE},errorContext:"symbol"},Q$e={base:Uc,key:"type",typeMap:{"picture-marker":nM,"simple-marker":yv,text:SE,"web-style":Xw,cim:wE},errorContext:"symbol"},eLe=dv({types:Wb}),O4={base:Uc,key:"type",typeMap:{"simple-fill":gv,"picture-fill":Vpe,"picture-marker":nM,"simple-line":Yh,"simple-marker":yv,text:SE,"line-3d":C4,"mesh-3d":A4,"point-3d":v_,"polygon-3d":oM,"web-style":Xw,cim:wE},errorContext:"symbol"},tLe={base:Uc,key:"type",typeMap:{text:SE,"label-3d":E4},errorContext:"symbol"},HK={base:Uc,key:"type",typeMap:{"line-3d":C4,"mesh-3d":A4,"point-3d":v_,"polygon-3d":oM,"web-style":Xw,cim:wE},errorContext:"symbol"},rLe={base:Uc,key:"type",typeMap:{"label-3d":E4},errorContext:"symbol"},Gpe=up(Wb);function iLe(t){if(!t)return null;const e={};for(const r in t){const i=il(t[r]);i&&(e[r]=i)}return Object.keys(e).length!==0?e:null}function sLe(t){if(!v(t))return null;const e={};for(const r in t){const i=t[r];i&&(e[r]=i.toJSON())}return Object.keys(e).length!==0?e:null}let ic=class extends bs(ve){constructor(...e){super(...e),this.isAggregate=!1,this.layer=null,this.popupTemplate=null,this.sourceLayer=null,Object.defineProperty(this,"uid",{value:Pc(),configurable:!0})}normalizeCtorArgs(e,r,i,s){return e&&!e.declaredClass?e:{geometry:e,symbol:r,attributes:i,popupTemplate:s}}set aggregateGeometries(e){const r=this._get("aggregateGeometries");JSON.stringify(r)!==JSON.stringify(e)&&this._set("aggregateGeometries",e)}set attributes(e){const r=this._get("attributes");r!==e&&(this._set("attributes",e),this._notifyLayer("attributes",r,e))}set geometry(e){const r=this._get("geometry");r!==e&&(this._set("geometry",e),this._notifyLayer("geometry",r,e))}set symbol(e){const r=this._get("symbol");r!==e&&(this._set("symbol",e),this._notifyLayer("symbol",r,e))}set visible(e){const r=this._get("visible");r!==e&&(this._set("visible",e),this._notifyLayer("visible",r,e))}getEffectivePopupTemplate(e=!1){if(this.popupTemplate)return this.popupTemplate;for(const r of[this.sourceLayer,this.layer])if(r){if("popupTemplate"in r&&r.popupTemplate)return r.popupTemplate;if(e&&"defaultPopupTemplate"in r&&v(r.defaultPopupTemplate))return r.defaultPopupTemplate}return null}getAttribute(e){var r;return(r=this.attributes)==null?void 0:r[e]}setAttribute(e,r){if(this.attributes){const i=this.getAttribute(e);this.attributes[e]=r,this._notifyLayer("attributes",i,r,e)}else this.attributes={[e]:r},this._notifyLayer("attributes",void 0,r,e)}getObjectId(){return this.sourceLayer&&"objectIdField"in this.sourceLayer&&this.sourceLayer.objectIdField?this.getAttribute(this.sourceLayer.objectIdField):null}toJSON(){return{aggregateGeometries:sLe(this.aggregateGeometries),geometry:v(this.geometry)?this.geometry.toJSON():null,symbol:v(this.symbol)?this.symbol.toJSON():null,attributes:{...this.attributes},popupTemplate:this.popupTemplate&&this.popupTemplate.toJSON()}}notifyGeometryChanged(){this._notifyLayer("geometry",this.geometry,this.geometry)}notifyMeshTransformChanged(){v(this.geometry)&&this.geometry.type==="mesh"&&this._notifyLayer("transform",this.geometry.transform,this.geometry.transform)}_notifyLayer(e,r,i,s){if(!this.layer||!("graphicChanged"in this.layer))return;const n={graphic:this,property:e,oldValue:r,newValue:i};e==="attributes"&&(n.attributeName=s),this.layer.graphicChanged(n)}};u([d({value:null,json:{read:iLe}})],ic.prototype,"aggregateGeometries",null),u([d({value:null})],ic.prototype,"attributes",null),u([d({value:null,types:jw,json:{read:il}})],ic.prototype,"geometry",null),u([d({type:Boolean})],ic.prototype,"isAggregate",void 0),u([d({clonable:"reference"})],ic.prototype,"layer",void 0),u([d({type:rM})],ic.prototype,"popupTemplate",void 0),u([d({clonable:"reference"})],ic.prototype,"sourceLayer",void 0),u([d({value:null,types:Wb})],ic.prototype,"symbol",null),u([d({type:Boolean,value:!0})],ic.prototype,"visible",null),ic=u([I("esri.Graphic")],ic),function(t){t.generateUID=Pc}(ic||(ic={}));const Io=ic;var NB;let A0=NB=class extends ve{constructor(t){super(t),this.rotation=0,this.scale=0,this.targetGeometry=null,this.camera=null}castRotation(t){return(t%=360)<0&&(t+=360),t}clone(){return new NB({rotation:this.rotation,scale:this.scale,targetGeometry:v(this.targetGeometry)?this.targetGeometry.clone():null,camera:v(this.camera)?this.camera.clone():null})}};function q6(){return{enabled:!this.camera}}u([d({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:q6}}}}})],A0.prototype,"rotation",void 0),u([cr("rotation")],A0.prototype,"castRotation",null),u([d({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:q6}}}}})],A0.prototype,"scale",void 0),u([d({types:jw,json:{read:il,write:!0,origins:{"web-scene":{read:il,write:{overridePolicy:q6}}}}})],A0.prototype,"targetGeometry",void 0),u([d({type:kh,json:{write:!0}})],A0.prototype,"camera",void 0),A0=NB=u([I("esri.Viewpoint")],A0);const mp=A0;function M4(t){return typeof t=="string"?document.getElementById(t):t??null}function jpe(t){for(;t.hasChildNodes();)t.removeChild(t.firstChild)}function qK(t,e){const r=e.parentNode;r&&r.insertBefore(t,e)}function WK(t,e){for(;;){const r=t.firstChild;if(!r)break;e.appendChild(r)}}function ie(t,e,r={}){return dW(t,e,r,Hpe)}function _a(t,e,r={}){return dW(t,e,r,qpe)}function dW(t,e,r={},i){let s=null;const n=r.once?(o,a)=>{i(o)&&(ji(s),e(o,a))}:(o,a)=>{i(o)&&e(o,a)};if(s=w3e(t,n,r.sync,r.equals),r.initial){const o=t();n(o,o)}return s}function sn(t,e,r,i={}){let s=null,n=null,o=null;function a(){var h;s&&n&&(n.remove(),(h=i.onListenerRemove)==null||h.call(i,s),s=null,n=null)}function l(h){i.once&&i.once&&ji(o),r(h)}const c=ie(t,(h,p)=>{var f;a(),i4(h)&&(s=h,n=qO(h,e,l),(f=i.onListenerAdd)==null||f.call(i,h))},{sync:i.sync,initial:!0});return o=cp(()=>{c.remove(),a()}),o}function WR(t,e){return nLe(t,qpe,e)}function nLe(t,e,r){if(Ln(r))return Promise.reject(Hr());const i=t();if(e!=null&&e(i))return Promise.resolve(i);let s=null;function n(){s=ji(s)}return new Promise((o,a)=>{s=yS([fa(r,()=>{n(),a(Hr())}),dW(t,l=>{n(),o(l)},{sync:!1,once:!0},e??Hpe)])})}function Hpe(t){return!0}function qpe(t){return!!t}const ri={sync:!0},Vt={initial:!0},js={sync:!0,initial:!0};let FB=class{constructor(e=r=>r.values().next().value){this._peeker=e,this._items=new Set}get length(){return this._items.size}clear(){this._items.clear()}last(){if(this._items.size===0)return;let e;for(e of this._items);return e}peek(){if(this._items.size!==0)return this._peeker(this._items)}push(e){this.contains(e)||this._items.add(e)}contains(e){return this._items.has(e)}pop(){if(this.length===0)return;const e=this.peek();return this._items.delete(e),e}popLast(){if(this.length===0)return;const e=this.last();return this._items.delete(e),e}remove(e){this._items.delete(e)}filter(e){return this._items.forEach(r=>{e(r)||this._items.delete(r)}),this}};var jo;(function(t){t[t.HANDSHAKE=0]="HANDSHAKE",t[t.OPEN=1]="OPEN",t[t.OPENED=2]="OPENED",t[t.RESPONSE=3]="RESPONSE",t[t.INVOKE=4]="INVOKE",t[t.ABORT=5]="ABORT",t[t.CLOSE=6]="CLOSE",t[t.OPEN_PORT=7]="OPEN_PORT",t[t.ON=8]="ON"})(jo||(jo={}));let oLe=0;function Wpe(){return oLe++}function aLe(t){return t&&typeof t=="object"&&("result"in t||"transferList"in t)}function XR(t){return t?typeof t=="string"?JSON.stringify({name:"message",message:t}):t.toJSON?JSON.stringify(t):JSON.stringify({name:t.name,message:t.message,details:t.details||{stack:t.stack}}):null}function pW(t,e,r,i){if(e.type===jo.OPEN_PORT)return void t.postMessage(e,[e.port]);if(e.type!==jo.INVOKE&&e.type!==jo.RESPONSE)return void t.postMessage(e);let s;if(aLe(r)?(s=XK(r.transferList),e.data=r.result):(s=XK(i),e.data=r),s){if(de("ff")){for(const n of s)if("byteLength"in n&&n.byteLength>267386880){const o="Worker call with large ArrayBuffer would crash Firefox";switch(e.type){case jo.INVOKE:throw o;case jo.RESPONSE:return void pW(t,{type:jo.RESPONSE,jobId:e.jobId,error:XR(o)})}}}t.postMessage(e,s)}else t.postMessage(e)}function YR(t){if(!t)return null;const e=t.data;return e?typeof e=="string"?JSON.parse(e):e:null}function XK(t){if(!t||!t.length)return null;if(de("esri-workers-arraybuffer-transfer"))return t;const e=t.filter(r=>!lLe(r));return e.length?e:null}function lLe(t){return t instanceof ArrayBuffer||t&&t.constructor&&t.constructor.name==="ArrayBuffer"}const cLe={statsWorker:()=>te(()=>import("./statsWorker-91764c0b.js"),["assets/statsWorker-91764c0b.js","assets/utils-a8845e41.js","assets/generateRendererUtils-f1e35d90.js"]),geometryEngineWorker:()=>te(()=>import("./geometryEngineWorker-8a57eda3.js"),["assets/geometryEngineWorker-8a57eda3.js","assets/geometryEngineJSON-3f330436.js","assets/geometryEngineBase-e1a33b0a.js","assets/json-48e3ea08.js"]),CSVSourceWorker:()=>te(()=>import("./CSVSourceWorker-e2060b89.js"),["assets/CSVSourceWorker-e2060b89.js","assets/json-48e3ea08.js","assets/FeatureStore-418dd9e9.js","assets/BoundsStore-968ad8c4.js","assets/PooledRBush-47b3e53d.js","assets/quickselect-56c5966e.js","assets/optimizedFeatureQueryEngineAdapter-9cf4c9eb.js","assets/centroid-0a3057d6.js","assets/QueryEngineResult-a75eda3b.js","assets/WhereClause-2e7ef2fe.js","assets/executionError-fb3f283a.js","assets/utils-a8845e41.js","assets/generateRendererUtils-f1e35d90.js","assets/QueryEngine-311866fa.js","assets/QueryEngineCapabilities-42e44ded.js","assets/number-cd7d5381.js","assets/clientSideDefaults-5e9f56ed.js"]),EdgeProcessingWorker:()=>te(()=>import("./EdgeProcessingWorker-a8c39cfa.js"),[]),ElevationSamplerWorker:()=>te(()=>import("./ElevationSamplerWorker-81eed6d3.js"),["assets/ElevationSamplerWorker-81eed6d3.js","assets/PooledRBush-47b3e53d.js","assets/quickselect-56c5966e.js","assets/georeference-01f27902.js"]),FeatureServiceSnappingSourceWorker:()=>te(()=>import("./FeatureServiceSnappingSourceWorker-1c84a35c.js"),["assets/FeatureServiceSnappingSourceWorker-1c84a35c.js","assets/FeatureStore-418dd9e9.js","assets/BoundsStore-968ad8c4.js","assets/PooledRBush-47b3e53d.js","assets/quickselect-56c5966e.js","assets/optimizedFeatureQueryEngineAdapter-9cf4c9eb.js","assets/centroid-0a3057d6.js","assets/QueryEngineResult-a75eda3b.js","assets/WhereClause-2e7ef2fe.js","assets/executionError-fb3f283a.js","assets/utils-a8845e41.js","assets/generateRendererUtils-f1e35d90.js","assets/json-48e3ea08.js","assets/QueryEngine-311866fa.js","assets/QueryEngineCapabilities-42e44ded.js","assets/symbologySnappingCandidates-f885f78f.js"]),GeoJSONSourceWorker:()=>te(()=>import("./GeoJSONSourceWorker-904157a8.js"),["assets/GeoJSONSourceWorker-904157a8.js","assets/FeatureStore-418dd9e9.js","assets/BoundsStore-968ad8c4.js","assets/PooledRBush-47b3e53d.js","assets/quickselect-56c5966e.js","assets/optimizedFeatureQueryEngineAdapter-9cf4c9eb.js","assets/centroid-0a3057d6.js","assets/QueryEngineResult-a75eda3b.js","assets/WhereClause-2e7ef2fe.js","assets/executionError-fb3f283a.js","assets/utils-a8845e41.js","assets/generateRendererUtils-f1e35d90.js","assets/json-48e3ea08.js","assets/QueryEngine-311866fa.js","assets/QueryEngineCapabilities-42e44ded.js","assets/geojson-e13f734b.js","assets/clientSideDefaults-5e9f56ed.js","assets/sourceUtils-a5e142b7.js"]),LercWorker:()=>te(()=>import("./LercWorker-cd49bc6a.js"),[]),MemorySourceWorker:()=>te(()=>import("./MemorySourceWorker-282716c8.js"),["assets/MemorySourceWorker-282716c8.js","assets/objectIdUtils-789e911a.js","assets/FeatureStore-418dd9e9.js","assets/BoundsStore-968ad8c4.js","assets/PooledRBush-47b3e53d.js","assets/quickselect-56c5966e.js","assets/optimizedFeatureQueryEngineAdapter-9cf4c9eb.js","assets/centroid-0a3057d6.js","assets/QueryEngineResult-a75eda3b.js","assets/WhereClause-2e7ef2fe.js","assets/executionError-fb3f283a.js","assets/utils-a8845e41.js","assets/generateRendererUtils-f1e35d90.js","assets/json-48e3ea08.js","assets/QueryEngine-311866fa.js","assets/QueryEngineCapabilities-42e44ded.js","assets/clientSideDefaults-5e9f56ed.js","assets/sourceUtils-a5e142b7.js"]),PBFDecoderWorker:()=>te(()=>import("./PBFDecoderWorker-2cd81485.js"),[]),Pipeline:()=>te(()=>import("./Pipeline-40ecdda3.js").then(t=>t.P),["assets/Pipeline-40ecdda3.js","assets/QueryEngine-311866fa.js","assets/QueryEngineResult-a75eda3b.js","assets/WhereClause-2e7ef2fe.js","assets/executionError-fb3f283a.js","assets/utils-a8845e41.js","assets/generateRendererUtils-f1e35d90.js","assets/json-48e3ea08.js","assets/QueryEngineCapabilities-42e44ded.js","assets/StreamFeatureManager-b41ee58c.js","assets/quickselect-56c5966e.js","assets/arcadeTimeUtils-8aa77359.js","assets/centroid-0a3057d6.js","assets/ogcFeatureUtils-bdeff7e8.js","assets/geojson-e13f734b.js","assets/clientSideDefaults-5e9f56ed.js","assets/createConnection-ea8ef70b.js","assets/enums-c655c737.js","assets/TileInfoView-c864a057.js","assets/number-b10bd8f5.js"]),PointCloudWorker:()=>te(()=>import("./PointCloudWorker-1293e5c6.js"),["assets/PointCloudWorker-1293e5c6.js","assets/PointCloudWorkerUtil-a711fd67.js","assets/PointCloudUniqueValueRenderer-91a80d2e.js","assets/I3SBinaryReader-a96fa99c.js"]),RasterWorker:()=>te(()=>import("./RasterWorker-d75869ad.js"),["assets/RasterWorker-d75869ad.js","assets/dataUtils-9d851346.js","assets/colorUtils-c0f43caf.js","assets/utils-6ca01b1e.js","assets/rasterProjectionHelper-816895fe.js"]),SceneLayerSnappingSourceWorker:()=>te(()=>import("./SceneLayerSnappingSourceWorker-55d75014.js"),["assets/SceneLayerSnappingSourceWorker-55d75014.js","assets/QueryEngineResult-a75eda3b.js","assets/WhereClause-2e7ef2fe.js","assets/executionError-fb3f283a.js","assets/utils-a8845e41.js","assets/generateRendererUtils-f1e35d90.js","assets/json-48e3ea08.js"]),SceneLayerWorker:()=>te(()=>import("./SceneLayerWorker-85ab02d4.js").then(t=>t.S),["assets/SceneLayerWorker-85ab02d4.js","assets/I3SNode-8868b8e2.js"]),WFSSourceWorker:()=>te(()=>import("./WFSSourceWorker-4847b9d9.js"),["assets/WFSSourceWorker-4847b9d9.js","assets/FeatureStore-418dd9e9.js","assets/BoundsStore-968ad8c4.js","assets/PooledRBush-47b3e53d.js","assets/quickselect-56c5966e.js","assets/optimizedFeatureQueryEngineAdapter-9cf4c9eb.js","assets/centroid-0a3057d6.js","assets/QueryEngineResult-a75eda3b.js","assets/WhereClause-2e7ef2fe.js","assets/executionError-fb3f283a.js","assets/utils-a8845e41.js","assets/generateRendererUtils-f1e35d90.js","assets/json-48e3ea08.js","assets/QueryEngine-311866fa.js","assets/QueryEngineCapabilities-42e44ded.js","assets/geojson-e13f734b.js","assets/sourceUtils-a5e142b7.js","assets/wfsUtils-7e5a5daf.js","assets/xmlUtils-444cb4c0.js"]),WorkerTileHandler:()=>te(()=>import("./WorkerTileHandler-d48ba3b0.js"),["assets/WorkerTileHandler-d48ba3b0.js","assets/TileClipper-ae6eca9e.js","assets/StyleRepository-099a12b6.js","assets/enums-c655c737.js","assets/colorUtils-c0f43caf.js","assets/Rect-98da58d6.js","assets/TurboLine-4561bd71.js","assets/BidiEngine-836b7ef6.js"])},{CLOSE:YK,ABORT:ZK,INVOKE:JK,RESPONSE:nC,OPEN_PORT:KK,ON:uLe}=jo,hLe=2;let dLe=class{constructor(e){this._timer=null,this._cancelledJobIds=new Set,this._invokeMessages=[],this._invoke=e,this._timer=null,this._process=this._process.bind(this)}push(e){e.type===jo.ABORT?this._cancelledJobIds.add(e.jobId):(this._invokeMessages.push(e),this._timer===null&&(this._timer=setTimeout(this._process,0)))}clear(){this._invokeMessages.length=0,this._cancelledJobIds.clear(),this._timer=null}_process(){this._timer=null;for(const e of this._invokeMessages)this._cancelledJobIds.has(e.jobId)||this._invoke(e);this._cancelledJobIds.clear(),this._invokeMessages.length=0}},Z_=class ET{static connect(e){const r=new MessageChannel;let i;i=typeof e=="function"?new e:"default"in e&&typeof e.default=="function"?new e.default:e;const s=new ET(r.port1,{channel:r,client:i},()=>null);return typeof i=="object"&&"remoteClient"in i&&(i.remoteClient=s),ET.clients.set(s,i),r.port2}static loadWorker(e){const r=cLe[e];return r?r():Promise.resolve(null)}constructor(e,r,i){this._port=e,this._getNextJob=i,this._outJobs=new Map,this._inJobs=new Map,this._invokeQueue=new dLe(s=>this._onInvokeMessage(s)),this._client=r.client,this._onMessage=this._onMessage.bind(this),this._channel=r.channel,this._schedule=r.schedule,this._port.addEventListener("message",this._onMessage),this._port.start()}close(){this._post({type:YK}),this._close()}isBusy(){return this._outJobs.size>0}invoke(e,r,i){const s=i&&i.signal,n=i&&i.transferList;if(!this._port)return Promise.reject(new q("worker:port-closed",`Cannot call invoke('${e}'), port is closed`,{methodName:e,data:r}));const o=Wpe();return new Promise((a,l)=>{if(Ln(s))return this._processWork(),void l(Hr());const c=fa(s,()=>{const p=this._outJobs.get(o);p&&(this._outJobs.delete(o),this._processWork(),ji(p.abortHandle),this._post({type:ZK,jobId:o}),l(Hr()))}),h={resolve:a,reject:l,abortHandle:c,debugInfo:e};this._outJobs.set(o,h),this._post({type:JK,jobId:o,methodName:e,abortable:s!=null},r,n)})}on(e,r){const i=new MessageChannel;function s(n){r(n.data)}return this._port.postMessage({type:jo.ON,eventType:e,port:i.port2},[i.port2]),i.port1.addEventListener("message",s),i.port1.start(),{remove(){i.port1.postMessage({type:jo.CLOSE}),i.port1.close(),i.port1.removeEventListener("message",s)}}}jobAdded(){this._processWork()}openPort(){const e=new MessageChannel;return this._post({type:KK,port:e.port2}),e.port1}_processWork(){if(this._outJobs.size>=hLe)return;const e=this._getNextJob();if(!e)return;const{methodName:r,data:i,invokeOptions:s,deferred:n}=e;this.invoke(r,i,s).then(o=>n.resolve(o)).catch(o=>n.reject(o))}_close(){this._channel&&(this._channel=void 0),this._port.removeEventListener("message",this._onMessage),this._port.close(),this._outJobs.forEach(e=>{ji(e.abortHandle),e.reject(Hr(`Worker closing, aborting job calling '${e.debugInfo}'`))}),this._inJobs.clear(),this._outJobs.clear(),this._invokeQueue.clear(),this._port=this._client=this._schedule=null}_onMessage(e){v(this._schedule)?this._schedule(()=>this._processMessage(e)):this._processMessage(e)}_processMessage(e){const r=YR(e);if(r)switch(r.type){case nC:this._onResponseMessage(r);break;case JK:this._invokeQueue.push(r);break;case ZK:this._onAbortMessage(r);break;case YK:this._onCloseMessage();break;case KK:this._onOpenPortMessage(r);break;case uLe:this._onOnMessage(r)}}_onAbortMessage(e){const r=this._inJobs,i=e.jobId,s=r.get(i);this._invokeQueue.push(e),s&&(s.controller&&s.controller.abort(),r.delete(i))}_onCloseMessage(){const e=this._client;this._close(),e&&"destroy"in e&&ET.clients.get(this)===e&&e.destroy(),ET.clients.delete(this),e&&e.remoteClient&&(e.remoteClient=null)}_onInvokeMessage(e){const{methodName:r,jobId:i,data:s,abortable:n}=e,o=n?new AbortController:null,a=this._inJobs;let l,c=this._client,h=c[r];try{if(!h&&r&&r.includes(".")){const p=r.split(".");for(let f=0;f<p.length-1;f++)c=c[p[f]],h=c[p[f+1]]}if(typeof h!="function")throw new TypeError(`${r} is not a function`);l=h.call(c,s,{client:this,signal:o?o.signal:null})}catch(p){return void this._post({type:nC,jobId:i,error:XR(p)})}Uu(l)?(a.set(i,{controller:o,promise:l}),l.then(p=>{a.has(i)&&(a.delete(i),this._post({type:nC,jobId:i},p))},p=>{a.has(i)&&(a.delete(i),Qs(p)||this._post({type:nC,jobId:i,error:XR(p||{message:`Error encountered at method ${r}`})}))})):this._post({type:nC,jobId:i},l)}_onOpenPortMessage(e){new ET(e.port,{client:this._client},()=>null)}_onOnMessage(e){const{port:r}=e,i=this._client.on(e.eventType,n=>{r.postMessage(n)}),s=qO(e.port,"message",n=>{var o;((o=YR(n))==null?void 0:o.type)===jo.CLOSE&&(s.remove(),i.remove(),r.close())})}_onResponseMessage(e){const{jobId:r,error:i,data:s}=e,n=this._outJobs;if(!n.has(r))return;const o=n.get(r);n.delete(r),this._processWork(),ji(o.abortHandle),i?o.reject(q.fromJSON(JSON.parse(i))):o.resolve(s)}_post(e,r,i){return pW(this._port,e,r,i)}};Z_.kernelInfo={revision:Ehe,version:Che,buildDate:She},Z_.clients=new Map;let pLe=class{constructor(){this._inUseClients=new Array,this._clients=new Array,this._clientPromises=new Array,this._ongoingJobsQueue=new FB}destroy(){this.close()}get closed(){return!this._clients||!this._clients.length}open(e,r){return new Promise((i,s)=>{let n=!0;const o=a=>{fr(r.signal),n&&(n=!1,a())};this._clients.length=e.length,this._clientPromises.length=e.length,this._inUseClients.length=e.length;for(let a=0;a<e.length;++a){const l=e[a];Uu(l)?this._clientPromises[a]=l.then(c=>(this._clients[a]=new Z_(c,r,()=>this._ongoingJobsQueue.pop()??null),o(i),this._clients[a]),()=>(o(s),null)):(this._clients[a]=new Z_(l,r,()=>this._ongoingJobsQueue.pop()??null),this._clientPromises[a]=Promise.resolve(this._clients[a]),o(i))}})}broadcast(e,r,i){const s=new Array(this._clientPromises.length);for(let n=0;n<this._clientPromises.length;++n){const o=this._clientPromises[n];s[n]=o.then(a=>a==null?void 0:a.invoke(e,r,i))}return s}close(){let e;for(;e=this._ongoingJobsQueue.pop();)e.deferred.reject(Hr(`Worker closing, aborting job calling '${e.methodName}'`));for(const r of this._clientPromises)r.then(i=>i==null?void 0:i.close());this._clients.length=0,this._clientPromises.length=0}invoke(e,r,i){let s;Array.isArray(i)?(se.getLogger("esri.core.workers.Connection").warn("invoke()","The transferList parameter is deprecated, use the options object instead"),s={transferList:i}):s=i;const n=j_();this._ongoingJobsQueue.push({methodName:e,data:r,invokeOptions:s,deferred:n});for(let o=0;o<this._clientPromises.length;o++){const a=this._clients[o];a?a.jobAdded():this._clientPromises[o].then(l=>l==null?void 0:l.jobAdded())}return n.promise}on(e,r){return Promise.all(this._clientPromises).then(()=>yS(this._clients.map(i=>i.on(e,r))))}openPorts(){return new Promise(e=>{const r=new Array(this._clientPromises.length);let i=r.length;for(let s=0;s<this._clientPromises.length;++s)this._clientPromises[s].then(n=>{n&&(r[s]=n.openPort()),--i==0&&e(r)})})}get test(){return{numClients:this._clients.length}}};const Xpe=se.getLogger("esri.intl.substitute");function Tf(t,e,r={}){const{format:i={}}=r;return tm(t,s=>fLe(s,e,i))}function fLe(t,e,r){let i,s;const n=t.indexOf(":");if(n===-1?i=t.trim():(i=t.slice(0,n).trim(),s=t.slice(n+1).trim()),!i)return"";const o=HO(i,e);if(o==null)return"";const a=(s?r==null?void 0:r[s]:null)??(r==null?void 0:r[i]);return a?mLe(o,a):s?gLe(o,s):fW(o)}function mLe(t,e){switch(e.type){case"date":return nm(t,e.intlOptions);case"number":return om(t,e.intlOptions);default:return Xpe.warn("missing format descriptor for key {key}"),fW(t)}}function gLe(t,e){switch(e.toLowerCase()){case"dateformat":return nm(t);case"numberformat":return om(t);default:return Xpe.warn(`inline format is unsupported since 4.12: ${e}`),/^(dateformat|datestring)/i.test(e)?nm(t):/^numberformat/i.test(e)?om(t):fW(t)}}function fW(t){switch(typeof t){case"string":return t;case"number":return om(t);case"boolean":return""+t;default:return t instanceof Date?nm(t):""}}async function yLe(t,e,r,i){const s=e.exec(r);if(!s)throw new q("esri-intl:invalid-bundle",`Bundle id "${r}" is not compatible with the pattern "${e}"`);const n=s[1]?`${s[1]}/`:"",o=s[2],a=wMe(i),l=`${n}${o}.json`,c=a?`${n}${o}_${a}.json`:l;let h;try{h=await QK(t(c))}catch(p){if(c===l)throw new q("intl:unknown-bundle",`Bundle "${r}" cannot be loaded`,{error:p});try{h=await QK(t(l))}catch(f){throw new q("intl:unknown-bundle",`Bundle "${r}" cannot be loaded`,{error:f})}}return h}async function QK(t){if(v(eQ.fetchBundleAsset))return eQ.fetchBundleAsset(t);const e=await Ni(t,{responseType:"text"});return JSON.parse(e.data)}let _Le=class{constructor({base:e="",pattern:r,location:i=new URL(window.location.href)}){let s;s=typeof i=="string"?n=>new URL(n,new URL(i,window.location.href)).href:i instanceof URL?n=>new URL(n,i).href:i,this.pattern=typeof r=="string"?new RegExp(`^${r}`):r,this.getAssetUrl=s,e=e?e.endsWith("/")?e:e+"/":"",this.matcher=new RegExp(`^${e}(?:(.*)/)?(.*)$`)}fetchMessageBundle(e,r){return yLe(this.getAssetUrl,this.matcher,e,r)}};function vLe(t){return new _Le(t)}const eQ={};bMe(vLe({pattern:"esri/",location:Wr}));const bLe={};function wLe(t){const e={async:t.async,isDebug:t.isDebug,locale:t.locale,baseUrl:t.baseUrl,has:{...t.has},map:{...t.map},packages:t.packages&&t.packages.concat()||[],paths:{...t.paths}};return t.hasOwnProperty("async")||(e.async=!0),t.hasOwnProperty("isDebug")||(e.isDebug=!1),t.baseUrl||(e.baseUrl=bLe.baseUrl),e}let xLe=class{constructor(){const e=document.createDocumentFragment();["addEventListener","dispatchEvent","removeEventListener"].forEach(r=>{this[r]=(...i)=>e[r](...i)})}},gL=class{constructor(){this._dispatcher=new xLe,this._workerPostMessage({type:jo.HANDSHAKE})}terminate(){}get onmessage(){return this._onmessageHandler}set onmessage(e){this._onmessageHandler&&this.removeEventListener("message",this._onmessageHandler),this._onmessageHandler=e,e&&this.addEventListener("message",e)}get onmessageerror(){return this._onmessageerrorHandler}set onmessageerror(e){this._onmessageerrorHandler&&this.removeEventListener("messageerror",this._onmessageerrorHandler),this._onmessageerrorHandler=e,e&&this.addEventListener("messageerror",e)}get onerror(){return this._onerrorHandler}set onerror(e){this._onerrorHandler&&this.removeEventListener("error",this._onerrorHandler),this._onerrorHandler=e,e&&this.addEventListener("error",e)}postMessage(e){_S(()=>{this._workerMessageHandler(new MessageEvent("message",{data:e}))})}dispatchEvent(e){return this._dispatcher.dispatchEvent(e)}addEventListener(e,r,i){this._dispatcher.addEventListener(e,r,i)}removeEventListener(e,r,i){this._dispatcher.removeEventListener(e,r,i)}_workerPostMessage(e){_S(()=>{this.dispatchEvent(new MessageEvent("message",{data:e}))})}async _workerMessageHandler(e){const r=YR(e);if(r&&r.type===jo.OPEN){const{modulePath:i,jobId:s}=r;let n=await Z_.loadWorker(i);n||(n=await te(()=>import(i),[]));const o=Z_.connect(n);this._workerPostMessage({type:jo.OPENED,jobId:s,data:o})}}};const UB=se.getLogger("esri.core.workers.workerFactory"),{HANDSHAKE:TLe}=jo,SLe='let globalId=0;const outgoing=new Map,configuration=JSON.parse("{CONFIGURATION}");self.esriConfig=configuration.esriConfig;const workerPath=self.esriConfig.workers.workerPath,HANDSHAKE=0,OPEN=1,OPENED=2,RESPONSE=3,INVOKE=4,ABORT=5;function createAbortError(){const e=new Error("Aborted");return e.name="AbortError",e}function receiveMessage(e){return e&&e.data?"string"==typeof e.data?JSON.parse(e.data):e.data:null}function invokeStaticMessage(e,o,r){const t=r&&r.signal,n=globalId++;return new Promise(((r,i)=>{if(t){if(t.aborted)return i(createAbortError());t.addEventListener("abort",(()=>{outgoing.get(n)&&(outgoing.delete(n),self.postMessage({type:5,jobId:n}),i(createAbortError()))}))}outgoing.set(n,{resolve:r,reject:i}),self.postMessage({type:4,jobId:n,methodName:e,abortable:null!=t,data:o})}))}let workerRevisionChecked=!1;function checkWorkerRevision(e){if(!workerRevisionChecked&&e.kernelInfo){workerRevisionChecked=!0;const{revision:o,version:r}=configuration.kernelInfo,{revision:t,version:n}=e.kernelInfo;esriConfig.assetsPath!==esriConfig.defaultAssetsPath&&o!==t&&console.warn(`Version mismatch detected between ArcGIS API for JavaScript modules and assets. For more information visit https://bit.ly/3QnsuSo.\\nModules version: ${r}\\nAssets version: ${n}`)}}function messageHandler(e){const o=receiveMessage(e);if(!o)return;const r=o.jobId;switch(o.type){case 1:let n;function t(e){const o=n.connect(e);self.postMessage({type:2,jobId:r,data:o},[o])}"function"==typeof define&&define.amd?require([workerPath],(e=>{n=e.default||e,checkWorkerRevision(n),n.loadWorker(o.modulePath).then((e=>e||new Promise((e=>{require([o.modulePath],e)})))).then(t)})):"System"in self&&"function"==typeof System.import?System.import(workerPath).then((e=>(n=e.default,checkWorkerRevision(n),n.loadWorker(o.modulePath)))).then((e=>e||System.import(o.modulePath))).then(t):esriConfig.workers.useDynamicImport?import(workerPath).then((e=>{n=e.default||e,checkWorkerRevision(n),n.loadWorker(o.modulePath).then((e=>e||import(o.modulePath))).then(t)})):(self.RemoteClient||importScripts(workerPath),n=self.RemoteClient.default||self.RemoteClient,checkWorkerRevision(n),n.loadWorker(o.modulePath).then(t));break;case 3:if(outgoing.has(r)){const i=outgoing.get(r);outgoing.delete(r),o.error?i.reject(JSON.parse(o.error)):i.resolve(o.data)}}}self.dojoConfig=configuration.loaderConfig,esriConfig.workers.loaderUrl&&(self.importScripts(esriConfig.workers.loaderUrl),"function"==typeof require&&"function"==typeof require.config&&require.config(configuration.loaderConfig)),self.addEventListener("message",messageHandler),self.postMessage({type:0});';let sP,nP;const tQ="Failed to create Worker. Fallback to execute module in main thread";async function ELe(){if(!de("esri-workers")||(de("mozilla"),0))return rQ(new gL);if(!sP&&!nP)try{const e=SLe.split('"{CONFIGURATION}"').join(`'${CLe()}'`);sP=URL.createObjectURL(new Blob([e],{type:"text/javascript"}))}catch(e){nP=e||{}}let t;if(sP)try{t=new Worker(sP,{name:"esri-worker-"+ALe++})}catch{UB.warn(tQ,nP),t=new gL}else UB.warn(tQ,nP),t=new gL;return rQ(t)}async function rQ(t){return new Promise(e=>{function r(s){const n=YR(s);n&&n.type===TLe&&(t.removeEventListener("message",r),t.removeEventListener("error",i),e(t))}function i(s){s.preventDefault(),t.removeEventListener("message",r),t.removeEventListener("error",i),UB.warn("Failed to create Worker. Fallback to execute module in main thread",s),(t=new gL).addEventListener("message",r),t.addEventListener("error",i)}t.addEventListener("message",r),t.addEventListener("error",i)})}function CLe(){let t;if(Yr.default!=null){const s={...Yr};delete s.default,t=JSON.parse(JSON.stringify(s))}else t=JSON.parse(JSON.stringify(Yr));t.assetsPath=wu(t.assetsPath),t.defaultAssetsPath=t.defaultAssetsPath?wu(t.defaultAssetsPath):void 0,t.request.interceptors=[],t.log.interceptors=[],t.locale=Ih(),t.has={"esri-csp-restrictions":de("esri-csp-restrictions"),"esri-2d-debug":!1,"esri-2d-update-debug":de("esri-2d-update-debug"),"featurelayer-pbf":de("featurelayer-pbf"),"featurelayer-simplify-thresholds":de("featurelayer-simplify-thresholds"),"featurelayer-simplify-payload-size-factors":de("featurelayer-simplify-payload-size-factors"),"featurelayer-simplify-mobile-factor":de("featurelayer-simplify-mobile-factor"),"esri-atomics":de("esri-atomics"),"esri-shared-array-buffer":de("esri-shared-array-buffer"),"esri-tiles-debug":de("esri-tiles-debug"),"esri-workers-arraybuffer-transfer":de("esri-workers-arraybuffer-transfer"),"feature-polyline-generalization-factor":de("feature-polyline-generalization-factor"),"host-webworker":1,"polylabel-placement-enabled":de("polylabel-placement-enabled")},t.workers.loaderUrl&&(t.workers.loaderUrl=wu(t.workers.loaderUrl)),t.workers.workerPath?t.workers.workerPath=wu(t.workers.workerPath):t.workers.workerPath=wu(Wr("esri/core/workers/RemoteClient.js")),t.workers.useDynamicImport=!1;const e=Yr.workers.loaderConfig,r=wLe({baseUrl:e==null?void 0:e.baseUrl,locale:Ih(),has:{"csp-restrictions":1,"dojo-test-sniff":0,"host-webworker":1,...e==null?void 0:e.has},map:{...e==null?void 0:e.map},paths:{...e==null?void 0:e.paths},packages:(e==null?void 0:e.packages)||[]});return JSON.stringify({esriConfig:t,loaderConfig:r,kernelInfo:{version:Che,buildDate:She,revision:Ehe}})}let ALe=0;const{ABORT:iQ,INVOKE:RLe,OPEN:OLe,OPENED:MLe,RESPONSE:oC}=jo;let PLe=class Ype{static async create(e){const r=await ELe();return new Ype(r,e)}constructor(e,r){this._outJobs=new Map,this._inJobs=new Map,this.worker=e,this.id=r,e.addEventListener("message",this._onMessage.bind(this)),e.addEventListener("error",i=>{i.preventDefault(),se.getLogger("esri.core.workers.WorkerOwner").error(i)})}terminate(){this.worker.terminate()}async open(e,r={}){const{signal:i}=r,s=Wpe();return new Promise((n,o)=>{const a={resolve:n,reject:o,abortHandle:XH(i,()=>{this._outJobs.delete(s),this._post({type:iQ,jobId:s})})};this._outJobs.set(s,a),this._post({type:OLe,jobId:s,modulePath:e})})}_onMessage(e){const r=YR(e);if(r)switch(r.type){case MLe:this._onOpenedMessage(r);break;case oC:this._onResponseMessage(r);break;case iQ:this._onAbortMessage(r);break;case RLe:this._onInvokeMessage(r)}}_onAbortMessage(e){const r=this._inJobs,i=e.jobId,s=r.get(i);s&&(s.controller&&s.controller.abort(),r.delete(i))}_onInvokeMessage(e){const{methodName:r,jobId:i,data:s,abortable:n}=e,o=n?new AbortController:null,a=this._inJobs,l=xOe[r];let c;try{if(typeof l!="function")throw new TypeError(`${r} is not a function`);c=l.call(null,s,{signal:o?o.signal:null})}catch(h){return void this._post({type:oC,jobId:i,error:XR(h)})}Uu(c)?(a.set(i,{controller:o,promise:c}),c.then(h=>{a.has(i)&&(a.delete(i),this._post({type:oC,jobId:i},h))},h=>{a.has(i)&&(a.delete(i),h||(h={message:"Error encountered at method"+r}),Qs(h)||this._post({type:oC,jobId:i,error:XR(h||{message:`Error encountered at method ${r}`})}))})):this._post({type:oC,jobId:i},c)}_onOpenedMessage(e){const{jobId:r,data:i}=e,s=this._outJobs.get(r);s&&(this._outJobs.delete(r),ji(s.abortHandle),s.resolve(i))}_onResponseMessage(e){const{jobId:r,error:i,data:s}=e,n=this._outJobs.get(r);n&&(this._outJobs.delete(r),ji(n.abortHandle),i?n.reject(q.fromJSON(JSON.parse(i))):n.resolve(s))}_post(e,r,i){return pW(this.worker,e,r,i)}},Ib=de("esri-workers-debug")?1:de("esri-mobile")?Math.min(navigator.hardwareConcurrency-1,3):de("host-browser")?navigator.hardwareConcurrency-1:0;Ib||(Ib=de("safari")&&de("mac")?7:2);let sQ=0;const yL=[];function ILe(){Jpe()}async function oP(t,e){const r=new pLe;return await r.open(t,e),r}async function Zpe(t,e={}){if(typeof t!="string")throw new q("workers:undefined-module","modulePath is missing");let r=e.strategy||"distributed";if(de("host-webworker")&&!de("esri-workers")&&(r="local"),r==="local"){let i=await Z_.loadWorker(t);i||(i=await te(()=>import(t),[])),fr(e.signal);const s=e.client||i;return oP([Z_.connect(i)],{...e,client:s})}if(await Jpe(),fr(e.signal),r==="dedicated"){const i=sQ++%Ib;return oP([await yL[i].open(t,e)],e)}if(e.maxNumWorkers&&e.maxNumWorkers>0){const i=Math.min(e.maxNumWorkers,Ib);if(i<Ib){const s=new Array(i);for(let n=0;n<i;++n){const o=sQ++%Ib;s[n]=yL[o].open(t,e)}return oP(s,e)}}return oP(yL.map(i=>i.open(t,e)),e)}let aP=null;async function Jpe(){if(aP)return aP;new AbortController;const t=[];for(let e=0;e<Ib;e++){const r=PLe.create(e).then(i=>(yL[e]=i,i));t.push(r)}return aP=Promise.all(t),aP}let Hf=class extends Te{constructor(){super(...arguments),this.updating=!1,this._handleId=0,this._handles=new ei,this._scheduleHandleId=0,this._pendingPromises=new Set}destroy(){this.removeAll(),this._handles.destroy()}add(e,r,i={}){return this._installWatch(e,r,i,ie)}addWhen(e,r,i={}){return this._installWatch(e,r,i,_a)}addOnCollectionChange(e,r,{initial:i=!1,final:s=!1}={}){const n=++this._handleId;return this._handles.add([sn(e,"after-changes",this._createSyncUpdatingCallback(),ri),sn(e,"change",r,{onListenerAdd:i?o=>r({added:o.toArray(),removed:[]}):void 0,onListenerRemove:s?o=>r({added:[],removed:o.toArray()}):void 0})],n),{remove:()=>this._handles.remove(n)}}addPromise(e){if(C(e))return e;const r=++this._handleId;this._handles.add({remove:()=>{this._pendingPromises.delete(e)&&(this._pendingPromises.size!==0||this._handles.has(lP)||this._set("updating",!1))}},r),this._pendingPromises.add(e),this._set("updating",!0);const i=()=>this._handles.remove(r);return e.then(i,i),e}removeAll(){this._pendingPromises.clear(),this._handles.removeAll(),this._set("updating",!1)}_installWatch(e,r,i={},s){const n=++this._handleId;i.sync||this._installSyncUpdatingWatch(e,n);const o=s(e,r,i);return this._handles.add(o,n),{remove:()=>this._handles.remove(n)}}_installSyncUpdatingWatch(e,r){const i=this._createSyncUpdatingCallback(),s=ie(e,i,{sync:!0,equals:()=>!1});return this._handles.add(s,r),s}_createSyncUpdatingCallback(){return()=>{this._handles.remove(lP),++this._scheduleHandleId;const e=this._scheduleHandleId;this._get("updating")||this._set("updating",!0),this._handles.add(gE(()=>{e===this._scheduleHandleId&&(this._set("updating",this._pendingPromises.size>0),this._handles.remove(lP))}),lP)}}};u([d({readOnly:!0})],Hf.prototype,"updating",void 0),Hf=u([I("esri.core.support.WatchUpdatingTracking")],Hf);const lP=-42,Yw=t=>{let e=class extends t{destroy(){var r,i;this.destroyed||((r=this._get("handles"))==null||r.destroy(),(i=this._get("updatingHandles"))==null||i.destroy())}get handles(){return this._get("handles")||new ei}get updatingHandles(){return this._get("updatingHandles")||new Hf}};return u([d({readOnly:!0})],e.prototype,"handles",null),u([d({readOnly:!0})],e.prototype,"updatingHandles",null),e=u([I("esri.core.HandleOwner")],e),e};let ZR=class extends Yw(Te){};ZR=u([I("esri.core.HandleOwner")],ZR);let q3=class extends Yw(Pt){constructor(e){super(e),this.handles.add([this.on("before-add",r=>{C(r.item)&&r.preventDefault()}),this.on("after-add",r=>this._own(r.item)),this.on("after-remove",r=>this._release(r.item))])}get owner(){return this._get("owner")}set owner(e){e!==this._get("owner")&&(this._releaseAll(),this._set("owner",e),this._ownAll())}_ownAll(){for(const e of this.items)this._own(e)}_releaseAll(){for(const e of this.items)this._release(e)}_createNewInstance(e){return this.itemType?new(Pt.ofType(this.itemType.Type))(e):new Pt(e)}};function kB(t,e){return{type:t,cast:zue,set(r){const i=aw(r,this._get(e),t);i.owner=this,this._set(e,i)}}}u([d()],q3.prototype,"owner",null),q3=u([I("esri.core.support.OwningCollection")],q3);var IA;const fN=Ta()({orthometric:"gravity-related-height",gravity_related_height:"gravity-related-height",ellipsoidal:"ellipsoidal"}),Kpe=fN.jsonValues.slice();PR(Kpe,"orthometric");const W3=Ta()({meter:"meters",foot:"feet","us-foot":"us-feet","clarke-foot":"clarke-feet","clarke-yard":"clarke-yards","clarke-link":"clarke-links","sears-yard":"sears-yards","sears-foot":"sears-feet","sears-chain":"sears-chains","benoit-1895-b-chain":"benoit-1895-b-chains","indian-yard":"indian-yards","indian-1937-yard":"indian-1937-yards","gold-coast-foot":"gold-coast-feet","sears-1922-truncated-chain":"sears-1922-truncated-chains","50-kilometers":"50-kilometers","150-kilometers":"150-kilometers"});let _d=IA=class extends ve{constructor(t){super(t),this.heightModel="gravity-related-height",this.heightUnit="meters",this.vertCRS=null}writeHeightModel(t,e,r){return fN.write(t,e,r)}readHeightModel(t,e,r){return fN.read(t)||(r&&r.messages&&r.messages.push($Le(t,{context:r})),null)}readHeightUnit(t,e,r){return W3.read(t)||(r&&r.messages&&r.messages.push(nQ(t,{context:r})),null)}readHeightUnitService(t,e,r){return bhe(t)||W3.read(t)||(r&&r.messages&&r.messages.push(nQ(t,{context:r})),null)}readVertCRS(t,e){return e.vertCRS||e.ellipsoid||e.geoid}clone(){return new IA({heightModel:this.heightModel,heightUnit:this.heightUnit,vertCRS:this.vertCRS})}equals(t){return!!t&&(this===t||this.heightModel===t.heightModel&&this.heightUnit===t.heightUnit&&this.vertCRS===t.vertCRS)}static deriveUnitFromSR(t,e){const r=pOe(e);return new IA({heightModel:t.heightModel,heightUnit:r,vertCRS:t.vertCRS})}write(t,e){return e={origin:"web-scene",...e},super.write(t,e)}static fromJSON(t){if(!t)return null;const e=new IA;return e.read(t,{origin:"web-scene"}),e}};function nQ(t,e){return new rm("height-unit:unsupported",`Height unit of value '${t}' is not supported`,e)}function $Le(t,e){return new rm("height-model:unsupported",`Height model of value '${t}' is not supported`,e)}u([d({type:fN.apiValues,constructOnly:!0,json:{origins:{"web-scene":{type:Kpe,default:"ellipsoidal"}}}})],_d.prototype,"heightModel",void 0),u([He("web-scene","heightModel")],_d.prototype,"writeHeightModel",null),u([Fe(["web-scene","service"],"heightModel")],_d.prototype,"readHeightModel",null),u([d({type:W3.apiValues,constructOnly:!0,json:{origins:{"web-scene":{type:W3.jsonValues,write:W3.write}}}})],_d.prototype,"heightUnit",void 0),u([Fe("web-scene","heightUnit")],_d.prototype,"readHeightUnit",null),u([Fe("service","heightUnit")],_d.prototype,"readHeightUnitService",null),u([d({type:String,constructOnly:!0,json:{origins:{"web-scene":{write:!0}}}})],_d.prototype,"vertCRS",void 0),u([Fe("service","vertCRS",["vertCRS","ellipsoid","geoid"])],_d.prototype,"readVertCRS",null),_d=IA=u([I("esri.geometry.HeightModelInfo")],_d);const EE=_d;function Fn(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function ym(t,e,r,i,s,n,o,a,l,c,h,p,f,m,y,_,b){return t[0]=e,t[1]=r,t[2]=i,t[3]=s,t[4]=n,t[5]=o,t[6]=a,t[7]=l,t[8]=c,t[9]=h,t[10]=p,t[11]=f,t[12]=m,t[13]=y,t[14]=_,t[15]=b,t}function Gh(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Dc(t,e){if(t===e){const r=e[1],i=e[2],s=e[3],n=e[6],o=e[7],a=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=r,t[6]=e[9],t[7]=e[13],t[8]=i,t[9]=n,t[11]=e[14],t[12]=s,t[13]=o,t[14]=a}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t}function CE(t,e){return Oo(t,e)||Gh(t),t}function Oo(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],p=e[9],f=e[10],m=e[11],y=e[12],_=e[13],b=e[14],x=e[15],T=r*a-i*o,S=r*l-s*o,E=r*c-n*o,O=i*l-s*a,R=i*c-n*a,L=s*c-n*l,P=h*_-p*y,U=h*b-f*y,B=h*x-m*y,z=p*b-f*_,G=p*x-m*_,K=f*x-m*b;let ee=T*K-S*G+E*z+O*B-R*U+L*P;return ee?(ee=1/ee,t[0]=(a*K-l*G+c*z)*ee,t[1]=(s*G-i*K-n*z)*ee,t[2]=(_*L-b*R+x*O)*ee,t[3]=(f*R-p*L-m*O)*ee,t[4]=(l*B-o*K-c*U)*ee,t[5]=(r*K-s*B+n*U)*ee,t[6]=(b*E-y*L-x*S)*ee,t[7]=(h*L-f*E+m*S)*ee,t[8]=(o*G-a*B+c*P)*ee,t[9]=(i*B-r*G-n*P)*ee,t[10]=(y*R-_*E+x*T)*ee,t[11]=(p*E-h*R-m*T)*ee,t[12]=(a*U-o*z-l*P)*ee,t[13]=(r*z-i*U+s*P)*ee,t[14]=(_*S-y*O-b*T)*ee,t[15]=(h*O-p*S+f*T)*ee,t):null}function LLe(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],p=e[9],f=e[10],m=e[11],y=e[12],_=e[13],b=e[14],x=e[15];return t[0]=a*(f*x-m*b)-p*(l*x-c*b)+_*(l*m-c*f),t[1]=-(i*(f*x-m*b)-p*(s*x-n*b)+_*(s*m-n*f)),t[2]=i*(l*x-c*b)-a*(s*x-n*b)+_*(s*c-n*l),t[3]=-(i*(l*m-c*f)-a*(s*m-n*f)+p*(s*c-n*l)),t[4]=-(o*(f*x-m*b)-h*(l*x-c*b)+y*(l*m-c*f)),t[5]=r*(f*x-m*b)-h*(s*x-n*b)+y*(s*m-n*f),t[6]=-(r*(l*x-c*b)-o*(s*x-n*b)+y*(s*c-n*l)),t[7]=r*(l*m-c*f)-o*(s*m-n*f)+h*(s*c-n*l),t[8]=o*(p*x-m*_)-h*(a*x-c*_)+y*(a*m-c*p),t[9]=-(r*(p*x-m*_)-h*(i*x-n*_)+y*(i*m-n*p)),t[10]=r*(a*x-c*_)-o*(i*x-n*_)+y*(i*c-n*a),t[11]=-(r*(a*m-c*p)-o*(i*m-n*p)+h*(i*c-n*a)),t[12]=-(o*(p*b-f*_)-h*(a*b-l*_)+y*(a*f-l*p)),t[13]=r*(p*b-f*_)-h*(i*b-s*_)+y*(i*f-s*p),t[14]=-(r*(a*b-l*_)-o*(i*b-s*_)+y*(i*l-s*a)),t[15]=r*(a*f-l*p)-o*(i*f-s*p)+h*(i*l-s*a),t}function DLe(t){const e=t[0],r=t[1],i=t[2],s=t[3],n=t[4],o=t[5],a=t[6],l=t[7],c=t[8],h=t[9],p=t[10],f=t[11],m=t[12],y=t[13],_=t[14],b=t[15];return(e*o-r*n)*(p*b-f*_)-(e*a-i*n)*(h*b-f*y)+(e*l-s*n)*(h*_-p*y)+(r*a-i*o)*(c*b-f*m)-(r*l-s*o)*(c*_-p*m)+(i*l-s*a)*(c*y-h*m)}function gs(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],p=e[8],f=e[9],m=e[10],y=e[11],_=e[12],b=e[13],x=e[14],T=e[15];let S=r[0],E=r[1],O=r[2],R=r[3];return t[0]=S*i+E*a+O*p+R*_,t[1]=S*s+E*l+O*f+R*b,t[2]=S*n+E*c+O*m+R*x,t[3]=S*o+E*h+O*y+R*T,S=r[4],E=r[5],O=r[6],R=r[7],t[4]=S*i+E*a+O*p+R*_,t[5]=S*s+E*l+O*f+R*b,t[6]=S*n+E*c+O*m+R*x,t[7]=S*o+E*h+O*y+R*T,S=r[8],E=r[9],O=r[10],R=r[11],t[8]=S*i+E*a+O*p+R*_,t[9]=S*s+E*l+O*f+R*b,t[10]=S*n+E*c+O*m+R*x,t[11]=S*o+E*h+O*y+R*T,S=r[12],E=r[13],O=r[14],R=r[15],t[12]=S*i+E*a+O*p+R*_,t[13]=S*s+E*l+O*f+R*b,t[14]=S*n+E*c+O*m+R*x,t[15]=S*o+E*h+O*y+R*T,t}function ql(t,e,r){const i=r[0],s=r[1],n=r[2];if(e===t)t[12]=e[0]*i+e[4]*s+e[8]*n+e[12],t[13]=e[1]*i+e[5]*s+e[9]*n+e[13],t[14]=e[2]*i+e[6]*s+e[10]*n+e[14],t[15]=e[3]*i+e[7]*s+e[11]*n+e[15];else{const o=e[0],a=e[1],l=e[2],c=e[3],h=e[4],p=e[5],f=e[6],m=e[7],y=e[8],_=e[9],b=e[10],x=e[11];t[0]=o,t[1]=a,t[2]=l,t[3]=c,t[4]=h,t[5]=p,t[6]=f,t[7]=m,t[8]=y,t[9]=_,t[10]=b,t[11]=x,t[12]=o*i+h*s+y*n+e[12],t[13]=a*i+p*s+_*n+e[13],t[14]=l*i+f*s+b*n+e[14],t[15]=c*i+m*s+x*n+e[15]}return t}function P4(t,e,r){const i=r[0],s=r[1],n=r[2];return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*s,t[5]=e[5]*s,t[6]=e[6]*s,t[7]=e[7]*s,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function Rc(t,e,r,i){let s,n,o,a,l,c,h,p,f,m,y,_,b,x,T,S,E,O,R,L,P,U,B,z,G=i[0],K=i[1],ee=i[2],Q=Math.sqrt(G*G+K*K+ee*ee);return Q<Sa()?null:(Q=1/Q,G*=Q,K*=Q,ee*=Q,s=Math.sin(r),n=Math.cos(r),o=1-n,a=e[0],l=e[1],c=e[2],h=e[3],p=e[4],f=e[5],m=e[6],y=e[7],_=e[8],b=e[9],x=e[10],T=e[11],S=G*G*o+n,E=K*G*o+ee*s,O=ee*G*o-K*s,R=G*K*o-ee*s,L=K*K*o+n,P=ee*K*o+G*s,U=G*ee*o+K*s,B=K*ee*o-G*s,z=ee*ee*o+n,t[0]=a*S+p*E+_*O,t[1]=l*S+f*E+b*O,t[2]=c*S+m*E+x*O,t[3]=h*S+y*E+T*O,t[4]=a*R+p*L+_*P,t[5]=l*R+f*L+b*P,t[6]=c*R+m*L+x*P,t[7]=h*R+y*L+T*P,t[8]=a*U+p*B+_*z,t[9]=l*U+f*B+b*z,t[10]=c*U+m*B+x*z,t[11]=h*U+y*B+T*z,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)}function LS(t,e,r){const i=Math.sin(r),s=Math.cos(r),n=e[4],o=e[5],a=e[6],l=e[7],c=e[8],h=e[9],p=e[10],f=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=n*s+c*i,t[5]=o*s+h*i,t[6]=a*s+p*i,t[7]=l*s+f*i,t[8]=c*s-n*i,t[9]=h*s-o*i,t[10]=p*s-a*i,t[11]=f*s-l*i,t}function I4(t,e,r){const i=Math.sin(r),s=Math.cos(r),n=e[0],o=e[1],a=e[2],l=e[3],c=e[8],h=e[9],p=e[10],f=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*s-c*i,t[1]=o*s-h*i,t[2]=a*s-p*i,t[3]=l*s-f*i,t[8]=n*i+c*s,t[9]=o*i+h*s,t[10]=a*i+p*s,t[11]=l*i+f*s,t}function DS(t,e,r){const i=Math.sin(r),s=Math.cos(r),n=e[0],o=e[1],a=e[2],l=e[3],c=e[4],h=e[5],p=e[6],f=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*s+c*i,t[1]=o*s+h*i,t[2]=a*s+p*i,t[3]=l*s+f*i,t[4]=c*s-n*i,t[5]=h*s-o*i,t[6]=p*s-a*i,t[7]=f*s-l*i,t}function $4(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}function NLe(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function $u(t,e,r){if(e===0)return Gh(t);let i,s,n,o=r[0],a=r[1],l=r[2],c=Math.sqrt(o*o+a*a+l*l);return c<Sa()?null:(c=1/c,o*=c,a*=c,l*=c,i=Math.sin(e),s=Math.cos(e),n=1-s,t[0]=o*o*n+s,t[1]=a*o*n+l*i,t[2]=l*o*n-a*i,t[3]=0,t[4]=o*a*n-l*i,t[5]=a*a*n+s,t[6]=l*a*n+o*i,t[7]=0,t[8]=o*l*n+a*i,t[9]=a*l*n-o*i,t[10]=l*l*n+s,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)}function Qpe(t,e){const r=Math.sin(e),i=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=i,t[6]=r,t[7]=0,t[8]=0,t[9]=-r,t[10]=i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function FLe(t,e){const r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=0,t[2]=-r,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=r,t[9]=0,t[10]=i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function efe(t,e){const r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=r,t[2]=0,t[3]=0,t[4]=-r,t[5]=i,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function tfe(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=i+i,l=s+s,c=n+n,h=i*a,p=i*l,f=i*c,m=s*l,y=s*c,_=n*c,b=o*a,x=o*l,T=o*c;return t[0]=1-(m+_),t[1]=p+T,t[2]=f-x,t[3]=0,t[4]=p-T,t[5]=1-(h+_),t[6]=y+b,t[7]=0,t[8]=f+x,t[9]=y-b,t[10]=1-(h+m),t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t}function ULe(t,e){const r=kLe,i=-e[0],s=-e[1],n=-e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],p=i*i+s*s+n*n+o*o;return p>0?(r[0]=2*(a*o+h*i+l*n-c*s)/p,r[1]=2*(l*o+h*s+c*i-a*n)/p,r[2]=2*(c*o+h*n+a*s-l*i)/p):(r[0]=2*(a*o+h*i+l*n-c*s),r[1]=2*(l*o+h*s+c*i-a*n),r[2]=2*(c*o+h*n+a*s-l*i)),tfe(t,e,r),t}const kLe=M();function VLe(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t}function rfe(t,e){const r=e[0],i=e[1],s=e[2],n=e[4],o=e[5],a=e[6],l=e[8],c=e[9],h=e[10];return t[0]=Math.sqrt(r*r+i*i+s*s),t[1]=Math.sqrt(n*n+o*o+a*a),t[2]=Math.sqrt(l*l+c*c+h*h),t}function BLe(t,e){const r=e[0]+e[5]+e[10];let i=0;return r>0?(i=2*Math.sqrt(r+1),t[3]=.25*i,t[0]=(e[6]-e[9])/i,t[1]=(e[8]-e[2])/i,t[2]=(e[1]-e[4])/i):e[0]>e[5]&&e[0]>e[10]?(i=2*Math.sqrt(1+e[0]-e[5]-e[10]),t[3]=(e[6]-e[9])/i,t[0]=.25*i,t[1]=(e[1]+e[4])/i,t[2]=(e[8]+e[2])/i):e[5]>e[10]?(i=2*Math.sqrt(1+e[5]-e[0]-e[10]),t[3]=(e[8]-e[2])/i,t[0]=(e[1]+e[4])/i,t[1]=.25*i,t[2]=(e[6]+e[9])/i):(i=2*Math.sqrt(1+e[10]-e[0]-e[5]),t[3]=(e[1]-e[4])/i,t[0]=(e[8]+e[2])/i,t[1]=(e[6]+e[9])/i,t[2]=.25*i),t}function zLe(t,e,r,i){const s=e[0],n=e[1],o=e[2],a=e[3],l=s+s,c=n+n,h=o+o,p=s*l,f=s*c,m=s*h,y=n*c,_=n*h,b=o*h,x=a*l,T=a*c,S=a*h,E=i[0],O=i[1],R=i[2];return t[0]=(1-(y+b))*E,t[1]=(f+S)*E,t[2]=(m-T)*E,t[3]=0,t[4]=(f-S)*O,t[5]=(1-(p+b))*O,t[6]=(_+x)*O,t[7]=0,t[8]=(m+T)*R,t[9]=(_-x)*R,t[10]=(1-(p+y))*R,t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t}function GLe(t,e,r,i,s){const n=e[0],o=e[1],a=e[2],l=e[3],c=n+n,h=o+o,p=a+a,f=n*c,m=n*h,y=n*p,_=o*h,b=o*p,x=a*p,T=l*c,S=l*h,E=l*p,O=i[0],R=i[1],L=i[2],P=s[0],U=s[1],B=s[2],z=(1-(_+x))*O,G=(m+E)*O,K=(y-S)*O,ee=(m-E)*R,Q=(1-(f+x))*R,H=(b+T)*R,$=(y+S)*L,N=(b-T)*L,F=(1-(f+_))*L;return t[0]=z,t[1]=G,t[2]=K,t[3]=0,t[4]=ee,t[5]=Q,t[6]=H,t[7]=0,t[8]=$,t[9]=N,t[10]=F,t[11]=0,t[12]=r[0]+P-(z*P+ee*U+$*B),t[13]=r[1]+U-(G*P+Q*U+N*B),t[14]=r[2]+B-(K*P+H*U+F*B),t[15]=1,t}function jLe(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=r+r,a=i+i,l=s+s,c=r*o,h=i*o,p=i*a,f=s*o,m=s*a,y=s*l,_=n*o,b=n*a,x=n*l;return t[0]=1-p-y,t[1]=h+x,t[2]=f-b,t[3]=0,t[4]=h-x,t[5]=1-c-y,t[6]=m+_,t[7]=0,t[8]=f+b,t[9]=m-_,t[10]=1-c-p,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function ife(t,e,r,i,s,n,o){const a=1/(r-e),l=1/(s-i),c=1/(n-o);return t[0]=2*n*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*n*l,t[6]=0,t[7]=0,t[8]=(r+e)*a,t[9]=(s+i)*l,t[10]=(o+n)*c,t[11]=-1,t[12]=0,t[13]=0,t[14]=o*n*2*c,t[15]=0,t}function HLe(t,e,r,i,s){const n=1/Math.tan(e/2);let o;return t[0]=n/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,s!=null&&s!==1/0?(o=1/(i-s),t[10]=(s+i)*o,t[14]=2*s*i*o):(t[10]=-1,t[14]=-2*i),t}function qLe(t,e,r,i){const s=Math.tan(e.upDegrees*Math.PI/180),n=Math.tan(e.downDegrees*Math.PI/180),o=Math.tan(e.leftDegrees*Math.PI/180),a=Math.tan(e.rightDegrees*Math.PI/180),l=2/(o+a),c=2/(s+n);return t[0]=l,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=c,t[6]=0,t[7]=0,t[8]=-(o-a)*l*.5,t[9]=(s-n)*c*.5,t[10]=i/(r-i),t[11]=-1,t[12]=0,t[13]=0,t[14]=i*r/(r-i),t[15]=0,t}function sfe(t,e,r,i,s,n,o){const a=1/(e-r),l=1/(i-s),c=1/(n-o);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+r)*a,t[13]=(s+i)*l,t[14]=(o+n)*c,t[15]=1,t}function L4(t,e,r,i){let s,n,o,a,l,c,h,p,f,m;const y=e[0],_=e[1],b=e[2],x=i[0],T=i[1],S=i[2],E=r[0],O=r[1],R=r[2],L=Sa();return Math.abs(y-E)<L&&Math.abs(_-O)<L&&Math.abs(b-R)<L?Gh(t):(h=y-E,p=_-O,f=b-R,m=1/Math.sqrt(h*h+p*p+f*f),h*=m,p*=m,f*=m,s=T*f-S*p,n=S*h-x*f,o=x*p-T*h,m=Math.sqrt(s*s+n*n+o*o),m?(m=1/m,s*=m,n*=m,o*=m):(s=0,n=0,o=0),a=p*o-f*n,l=f*s-h*o,c=h*n-p*s,m=Math.sqrt(a*a+l*l+c*c),m?(m=1/m,a*=m,l*=m,c*=m):(a=0,l=0,c=0),t[0]=s,t[1]=a,t[2]=h,t[3]=0,t[4]=n,t[5]=l,t[6]=p,t[7]=0,t[8]=o,t[9]=c,t[10]=f,t[11]=0,t[12]=-(s*y+n*_+o*b),t[13]=-(a*y+l*_+c*b),t[14]=-(h*y+p*_+f*b),t[15]=1,t)}function nfe(t,e,r,i){const s=e[0],n=e[1],o=e[2],a=i[0],l=i[1],c=i[2];let h=s-r[0],p=n-r[1],f=o-r[2],m=h*h+p*p+f*f;m>0&&(m=1/Math.sqrt(m),h*=m,p*=m,f*=m);let y=l*f-c*p,_=c*h-a*f,b=a*p-l*h;return m=y*y+_*_+b*b,m>0&&(m=1/Math.sqrt(m),y*=m,_*=m,b*=m),t[0]=y,t[1]=_,t[2]=b,t[3]=0,t[4]=p*b-f*_,t[5]=f*y-h*b,t[6]=h*_-p*y,t[7]=0,t[8]=h,t[9]=p,t[10]=f,t[11]=0,t[12]=s,t[13]=n,t[14]=o,t[15]=1,t}function WLe(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"}function XLe(t){return Math.sqrt(t[0]**2+t[1]**2+t[2]**2+t[3]**2+t[4]**2+t[5]**2+t[6]**2+t[7]**2+t[8]**2+t[9]**2+t[10]**2+t[11]**2+t[12]**2+t[13]**2+t[14]**2+t[15]**2)}function YLe(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t[6]=e[6]+r[6],t[7]=e[7]+r[7],t[8]=e[8]+r[8],t[9]=e[9]+r[9],t[10]=e[10]+r[10],t[11]=e[11]+r[11],t[12]=e[12]+r[12],t[13]=e[13]+r[13],t[14]=e[14]+r[14],t[15]=e[15]+r[15],t}function ofe(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t[4]=e[4]-r[4],t[5]=e[5]-r[5],t[6]=e[6]-r[6],t[7]=e[7]-r[7],t[8]=e[8]-r[8],t[9]=e[9]-r[9],t[10]=e[10]-r[10],t[11]=e[11]-r[11],t[12]=e[12]-r[12],t[13]=e[13]-r[13],t[14]=e[14]-r[14],t[15]=e[15]-r[15],t}function ZLe(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*r,t[9]=e[9]*r,t[10]=e[10]*r,t[11]=e[11]*r,t[12]=e[12]*r,t[13]=e[13]*r,t[14]=e[14]*r,t[15]=e[15]*r,t}function JLe(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t[4]=e[4]+r[4]*i,t[5]=e[5]+r[5]*i,t[6]=e[6]+r[6]*i,t[7]=e[7]+r[7]*i,t[8]=e[8]+r[8]*i,t[9]=e[9]+r[9]*i,t[10]=e[10]+r[10]*i,t[11]=e[11]+r[11]*i,t[12]=e[12]+r[12]*i,t[13]=e[13]+r[13]*i,t[14]=e[14]+r[14]*i,t[15]=e[15]+r[15]*i,t}function afe(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]}function mW(t,e){if(t===e)return!0;const r=t[0],i=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8],p=t[9],f=t[10],m=t[11],y=t[12],_=t[13],b=t[14],x=t[15],T=e[0],S=e[1],E=e[2],O=e[3],R=e[4],L=e[5],P=e[6],U=e[7],B=e[8],z=e[9],G=e[10],K=e[11],ee=e[12],Q=e[13],H=e[14],$=e[15],N=Sa();return Math.abs(r-T)<=N*Math.max(1,Math.abs(r),Math.abs(T))&&Math.abs(i-S)<=N*Math.max(1,Math.abs(i),Math.abs(S))&&Math.abs(s-E)<=N*Math.max(1,Math.abs(s),Math.abs(E))&&Math.abs(n-O)<=N*Math.max(1,Math.abs(n),Math.abs(O))&&Math.abs(o-R)<=N*Math.max(1,Math.abs(o),Math.abs(R))&&Math.abs(a-L)<=N*Math.max(1,Math.abs(a),Math.abs(L))&&Math.abs(l-P)<=N*Math.max(1,Math.abs(l),Math.abs(P))&&Math.abs(c-U)<=N*Math.max(1,Math.abs(c),Math.abs(U))&&Math.abs(h-B)<=N*Math.max(1,Math.abs(h),Math.abs(B))&&Math.abs(p-z)<=N*Math.max(1,Math.abs(p),Math.abs(z))&&Math.abs(f-G)<=N*Math.max(1,Math.abs(f),Math.abs(G))&&Math.abs(m-K)<=N*Math.max(1,Math.abs(m),Math.abs(K))&&Math.abs(y-ee)<=N*Math.max(1,Math.abs(y),Math.abs(ee))&&Math.abs(_-Q)<=N*Math.max(1,Math.abs(_),Math.abs(Q))&&Math.abs(b-H)<=N*Math.max(1,Math.abs(b),Math.abs(H))&&Math.abs(x-$)<=N*Math.max(1,Math.abs(x),Math.abs($))}function gW(t){const e=Sa(),r=t[0],i=t[1],s=t[2],n=t[4],o=t[5],a=t[6],l=t[8],c=t[9],h=t[10];return Math.abs(1-(r*r+n*n+l*l))<=e&&Math.abs(1-(i*i+o*o+c*c))<=e&&Math.abs(1-(s*s+a*a+h*h))<=e}function D4(t){return t[0]===1&&t[1]===0&&t[2]===0&&t[4]===0&&t[5]===1&&t[6]===0&&t[8]===0&&t[9]===0&&t[10]===1}const KLe=gs,QLe=ofe;Object.freeze(Object.defineProperty({__proto__:null,add:YLe,adjoint:LLe,copy:Fn,determinant:DLe,equals:mW,exactEquals:afe,frob:XLe,fromQuat:jLe,fromQuat2:ULe,fromRotation:$u,fromRotationTranslation:tfe,fromRotationTranslationScale:zLe,fromRotationTranslationScaleOrigin:GLe,fromScaling:NLe,fromTranslation:$4,fromXRotation:Qpe,fromYRotation:FLe,fromZRotation:efe,frustum:ife,getRotation:BLe,getScaling:rfe,getTranslation:VLe,hasIdentityRotation:D4,identity:Gh,invert:Oo,invertOrIdentity:CE,isOrthoNormal:gW,lookAt:L4,mul:KLe,multiply:gs,multiplyScalar:ZLe,multiplyScalarAndAdd:JLe,ortho:sfe,perspective:HLe,perspectiveFromFieldOfView:qLe,rotate:Rc,rotateX:LS,rotateY:I4,rotateZ:DS,scale:P4,set:ym,str:WLe,sub:QLe,subtract:ofe,targetTo:nfe,translate:ql,transpose:Dc},Symbol.toStringTag,{value:"Module"}));let W6,oe=null;function lfe(){return!!oe}function eDe(){return!!de("esri-wasm")}function cfe(){return W6||(W6=te(()=>import("./pe-wasm-67793c2f.js"),[]).then(t=>t.p).then(({default:t})=>t({locateFile:e=>Wr(`esri/geometry/support/${e}`)})).then(t=>{hfe(t)}),W6)}var VB,Vs,BB;(function(t){function e(n,o,a){oe.ensureCache.prepare();const l=yb(a),c=a===l,h=oe.ensureFloat64(l),p=oe._pe_geog_to_proj(oe.getPointer(n),o,h);return p&&o_(a,o,h,c),p}function r(n,o,a,l){switch(l){case Vs.PE_TRANSFORM_P_TO_G:return i(n,o,a);case Vs.PE_TRANSFORM_G_TO_P:return e(n,o,a)}return 0}function i(n,o,a){return s(n,o,a,0)}function s(n,o,a,l){oe.ensureCache.prepare();const c=yb(a),h=a===c,p=oe.ensureFloat64(c),f=oe._pe_proj_to_geog_center(oe.getPointer(n),o,p,l);return f&&o_(a,o,p,h),f}t.geogToProj=e,t.projGeog=r,t.projToGeog=i,t.projToGeogCenter=s})(VB||(VB={})),function(t){function e(){t.PE_BUFFER_MAX=oe.PeDefs.prototype.PE_BUFFER_MAX,t.PE_NAME_MAX=oe.PeDefs.prototype.PE_NAME_MAX,t.PE_MGRS_MAX=oe.PeDefs.prototype.PE_MGRS_MAX,t.PE_USNG_MAX=oe.PeDefs.prototype.PE_USNG_MAX,t.PE_DD_MAX=oe.PeDefs.prototype.PE_DD_MAX,t.PE_DDM_MAX=oe.PeDefs.prototype.PE_DDM_MAX,t.PE_DMS_MAX=oe.PeDefs.prototype.PE_DMS_MAX,t.PE_UTM_MAX=oe.PeDefs.prototype.PE_UTM_MAX,t.PE_PARM_MAX=oe.PeDefs.prototype.PE_PARM_MAX,t.PE_TYPE_NONE=oe.PeDefs.prototype.PE_TYPE_NONE,t.PE_TYPE_GEOGCS=oe.PeDefs.prototype.PE_TYPE_GEOGCS,t.PE_TYPE_PROJCS=oe.PeDefs.prototype.PE_TYPE_PROJCS,t.PE_TYPE_GEOGTRAN=oe.PeDefs.prototype.PE_TYPE_GEOGTRAN,t.PE_TYPE_COORDSYS=oe.PeDefs.prototype.PE_TYPE_COORDSYS,t.PE_TYPE_UNIT=oe.PeDefs.prototype.PE_TYPE_UNIT,t.PE_TYPE_LINUNIT=oe.PeDefs.prototype.PE_TYPE_LINUNIT,t.PE_STR_OPTS_NONE=oe.PeDefs.prototype.PE_STR_OPTS_NONE,t.PE_STR_AUTH_NONE=oe.PeDefs.prototype.PE_STR_AUTH_NONE,t.PE_STR_AUTH_TOP=oe.PeDefs.prototype.PE_STR_AUTH_TOP,t.PE_STR_NAME_CANON=oe.PeDefs.prototype.PE_STR_NAME_CANON,t.PE_PARM_X0=oe.PeDefs.prototype.PE_PARM_X0,t.PE_PARM_ND=oe.PeDefs.prototype.PE_PARM_ND,t.PE_TRANSFORM_1_TO_2=oe.PeDefs.prototype.PE_TRANSFORM_1_TO_2,t.PE_TRANSFORM_2_TO_1=oe.PeDefs.prototype.PE_TRANSFORM_2_TO_1,t.PE_TRANSFORM_P_TO_G=oe.PeDefs.prototype.PE_TRANSFORM_P_TO_G,t.PE_TRANSFORM_G_TO_P=oe.PeDefs.prototype.PE_TRANSFORM_G_TO_P,t.PE_HORIZON_RECT=oe.PeDefs.prototype.PE_HORIZON_RECT,t.PE_HORIZON_POLY=oe.PeDefs.prototype.PE_HORIZON_POLY,t.PE_HORIZON_LINE=oe.PeDefs.prototype.PE_HORIZON_LINE,t.PE_HORIZON_DELTA=oe.PeDefs.prototype.PE_HORIZON_DELTA}t.init=e}(Vs||(Vs={})),function(t){const e={},r={},i=m=>{if(m){const y=m.getType();switch(y){case Vs.PE_TYPE_GEOGCS:m=oe.castObject(m,oe.PeGeogcs);break;case Vs.PE_TYPE_PROJCS:m=oe.castObject(m,oe.PeProjcs);break;case Vs.PE_TYPE_GEOGTRAN:m=oe.castObject(m,oe.PeGeogtran);break;default:y&Vs.PE_TYPE_UNIT&&(m=oe.castObject(m,oe.PeUnit))}}return m};function s(){oe.PeFactory.prototype.initialize(null)}function n(m){return o(Vs.PE_TYPE_COORDSYS,m)}function o(m,y){let _=null,b=e[m];if(b||(b={},e[m]=b),b.hasOwnProperty(String(y)))_=b[y];else{const x=oe.PeFactory.prototype.factoryByType(m,y);oe.compare(x,oe.NULL)||(_=x,b[y]=_)}return _=i(_),_}function a(m,y){let _=null,b=r[m];if(b||(b={},r[m]=b),b.hasOwnProperty(y))_=b[y];else{const x=oe.PeFactory.prototype.fromString(m,y);oe.compare(x,oe.NULL)||(_=x,b[y]=_)}return _=i(_),_}function l(m){return o(Vs.PE_TYPE_GEOGCS,m)}function c(m){return o(Vs.PE_TYPE_GEOGTRAN,m)}function h(m){return oe.PeFactory.prototype.getCode(m)}function p(m){return o(Vs.PE_TYPE_PROJCS,m)}function f(m){return o(Vs.PE_TYPE_UNIT,m)}t.initialize=s,t.coordsys=n,t.factoryByType=o,t.fromString=a,t.geogcs=l,t.geogtran=c,t.getCode=h,t.projcs=p,t.unit=f}(BB||(BB={}));let ufe=null;var mN,zB,GB,jB,gN,HB,yN,_N,qB;function hfe(t){function e(n,o,a){n[o]=a(n[o])}oe=t,Vs.init(),mN.init(),gN.init(),yN.init(),_N.init(),ufe=class extends oe.PeGCSExtent{destroy(){oe.destroy(this)}};const r=[oe.PeDatum,oe.PeGeogcs,oe.PeGeogtran,oe.PeObject,oe.PeParameter,oe.PePrimem,oe.PeProjcs,oe.PeSpheroid,oe.PeUnit];for(const n of r)e(n.prototype,"getName",o=>function(){return o.call(this,new Array(Vs.PE_NAME_MAX))});for(const n of[oe.PeGeogtran,oe.PeProjcs])e(n.prototype,"getParameters",o=>function(){const a=new Array(Vs.PE_PARM_MAX);let l=o.call(this);for(let c=0;c<a.length;c++){const h=oe.getValue(l,"*");a[c]=h?oe.wrapPointer(h,oe.PeParameter):null,l+=Int32Array.BYTES_PER_ELEMENT}return a});e(oe.PeHorizon.prototype,"getCoord",n=>function(){const o=this.getSize();if(!o)return null;const a=[];return o_(a,o,n.call(this)),a}),e(oe.PeGTlistExtendedEntry.prototype,"getEntries",n=>{const o=oe._pe_getPeGTlistExtendedGTsSize();return function(){let a=null;const l=n.call(this);if(!oe.compare(l,oe.NULL)){a=[l];const c=this.getSteps();if(c>1){const h=oe.getPointer(l);for(let p=1;p<c;p++)a.push(oe.wrapPointer(h+o*p,oe.PeGTlistExtendedGTs))}}return a}});const i=oe._pe_getPeHorizonSize(),s=n=>function(){let o=this._cache;if(o||(o=new Map,this._cache=o),o.has(n))return o.get(n);let a=null;const l=n.call(this);if(!oe.compare(l,oe.NULL)){a=[l];const c=l.getNump();if(c>1){const h=oe.getPointer(l);for(let p=1;p<c;p++)a.push(oe.wrapPointer(h+i*p,oe.PeHorizon))}}return o.set(n,a),a};e(oe.PeProjcs.prototype,"horizonGcsGenerate",s),e(oe.PeProjcs.prototype,"horizonPcsGenerate",s),oe.PeObject.prototype.toString=function(n=Vs.PE_STR_OPTS_NONE){oe.ensureCache.prepare();const o=oe.getPointer(this),a=oe.ensureInt8(new Array(Vs.PE_BUFFER_MAX));return oe.UTF8ToString(oe._pe_object_to_string_ext(o,n,a))}}function Rm(t){if(!t)return;const e=oe.getClass(t);if(!e)return;const r=oe.getCache(e);if(!r)return;const i=oe.getPointer(t);i&&delete r[i]}function cP(t,e){const r=[],i=new Array(e);for(let s=0;s<t;s++)r.push(oe.ensureInt8(i));return r}function yb(t){let e;return Array.isArray(t[0])?(e=[],t.forEach(r=>{e.push(r[0],r[1])})):e=t,e}function o_(t,e,r,i=!1){if(i)for(let s=0;s<2*e;s++)t[s]=oe.getValue(r+s*Float64Array.BYTES_PER_ELEMENT,"double");else{const s=t.length===0;for(let n=0;n<e;n++)s&&(t[n]=new Array(2)),t[n][0]=oe.getValue(r,"double"),t[n][1]=oe.getValue(r+Float64Array.BYTES_PER_ELEMENT,"double"),r+=2*Float64Array.BYTES_PER_ELEMENT}}(function(t){let e;function r(){t.PE_GTLIST_OPTS_COMMON=oe.PeGTlistExtended.prototype.PE_GTLIST_OPTS_COMMON,e=oe._pe_getPeGTlistExtendedEntrySize()}function i(s,n,o,a,l,c){let h=null;const p=new oe.PeInteger(c);try{const f=oe.PeGTlistExtended.prototype.getGTlist(s,n,o,a,l,p);if((c=p.val)&&(h=[f],c>1)){const m=oe.getPointer(f);for(let y=1;y<c;y++)h.push(oe.wrapPointer(m+e*y,oe.PeGTlistExtendedEntry))}}finally{oe.destroy(p)}return h}t.init=r,t.getGTlist=i})(mN||(mN={})),function(t){function e(r){if(r&&r.length){for(const i of r)Rm(i),i.getEntries().forEach(s=>{Rm(s);const n=s.getGeogtran();Rm(n),n.getParameters().forEach(Rm),[n.getGeogcs1(),n.getGeogcs2()].forEach(o=>{Rm(o);const a=o.getDatum();Rm(a),Rm(a.getSpheroid()),Rm(o.getPrimem()),Rm(o.getUnit())})});oe.PeGTlistExtendedEntry.prototype.Delete(r[0])}}t.destroy=e}(zB||(zB={})),function(t){function e(r,i,s,n,o){oe.ensureCache.prepare();const a=yb(s),l=s===a,c=oe.ensureFloat64(a);let h=0;n&&(h=oe.ensureFloat64(n));const p=oe._pe_geog_to_geog(oe.getPointer(r),i,c,h,o);return p&&o_(s,i,c,l),p}t.geogToGeog=e}(GB||(GB={})),function(t){const e=(c,h,p,f,m,y)=>{let _,b;switch(oe.ensureCache.prepare(),c){case"dd":_=oe._pe_geog_to_dd,b=Vs.PE_DD_MAX;break;case"ddm":_=oe._pe_geog_to_ddm,b=Vs.PE_DDM_MAX;break;case"dms":_=oe._pe_geog_to_dms,b=Vs.PE_DMS_MAX}let x=0;h&&(x=oe.getPointer(h));const T=yb(f),S=oe.ensureFloat64(T),E=cP(p,b),O=_(x,p,S,m,oe.ensureInt32(E));if(O)for(let R=0;R<p;R++)y[R]=oe.UTF8ToString(E[R]);return O},r=(c,h,p,f,m)=>{let y;switch(oe.ensureCache.prepare(),c){case"dd":y=oe._pe_dd_to_geog;break;case"ddm":y=oe._pe_ddm_to_geog;break;case"dms":y=oe._pe_dms_to_geog}let _=0;h&&(_=oe.getPointer(h));const b=f.map(E=>oe.ensureString(E)),x=oe.ensureInt32(b),T=oe.ensureFloat64(new Array(2*p)),S=y(_,p,x,T);return S&&o_(m,p,T),S};function i(c,h,p,f,m){return e("dms",c,h,p,f,m)}function s(c,h,p,f){return r("dms",c,h,p,f)}function n(c,h,p,f,m){return e("ddm",c,h,p,f,m)}function o(c,h,p,f){return r("ddm",c,h,p,f)}function a(c,h,p,f,m){return e("dd",c,h,p,f,m)}function l(c,h,p,f){return r("dd",c,h,p,f)}t.geogToDms=i,t.dmsToGeog=s,t.geogToDdm=n,t.ddmToGeog=o,t.geogToDd=a,t.ddToGeog=l}(jB||(jB={})),function(t){function e(){t.PE_MGRS_STYLE_NEW=oe.PeNotationMgrs.prototype.PE_MGRS_STYLE_NEW,t.PE_MGRS_STYLE_OLD=oe.PeNotationMgrs.prototype.PE_MGRS_STYLE_OLD,t.PE_MGRS_STYLE_AUTO=oe.PeNotationMgrs.prototype.PE_MGRS_STYLE_AUTO,t.PE_MGRS_180_ZONE_1_PLUS=oe.PeNotationMgrs.prototype.PE_MGRS_180_ZONE_1_PLUS,t.PE_MGRS_ADD_SPACES=oe.PeNotationMgrs.prototype.PE_MGRS_ADD_SPACES}function r(s,n,o,a,l,c,h){oe.ensureCache.prepare();let p=0;s&&(p=oe.getPointer(s));const f=yb(o),m=oe.ensureFloat64(f),y=cP(n,Vs.PE_MGRS_MAX),_=oe.ensureInt32(y),b=oe._pe_geog_to_mgrs_extended(p,n,m,a,l,c,_);if(b)for(let x=0;x<n;x++)h[x]=oe.UTF8ToString(y[x]);return b}function i(s,n,o,a,l){oe.ensureCache.prepare();let c=0;s&&(c=oe.getPointer(s));const h=o.map(y=>oe.ensureString(y)),p=oe.ensureInt32(h),f=oe.ensureFloat64(new Array(2*n)),m=oe._pe_mgrs_to_geog_extended(c,n,p,a,f);return m&&o_(l,n,f),m}t.init=e,t.geogToMgrsExtended=r,t.mgrsToGeogExtended=i}(gN||(gN={})),function(t){function e(i,s,n,o,a,l,c){oe.ensureCache.prepare();let h=0;i&&(h=oe.getPointer(i));const p=yb(n),f=oe.ensureFloat64(p),m=cP(s,Vs.PE_MGRS_MAX),y=oe.ensureInt32(m),_=oe._pe_geog_to_usng(h,s,f,o,a,l,y);if(_)for(let b=0;b<s;b++)c[b]=oe.UTF8ToString(m[b]);return _}function r(i,s,n,o){oe.ensureCache.prepare();let a=0;i&&(a=oe.getPointer(i));const l=n.map(f=>oe.ensureString(f)),c=oe.ensureInt32(l),h=oe.ensureFloat64(new Array(2*s)),p=oe._pe_usng_to_geog(a,s,c,h);return p&&o_(o,s,h),p}t.geogToUsng=e,t.usngToGeog=r}(HB||(HB={})),function(t){function e(){t.PE_UTM_OPTS_NONE=oe.PeNotationUtm.prototype.PE_UTM_OPTS_NONE,t.PE_UTM_OPTS_ADD_SPACES=oe.PeNotationUtm.prototype.PE_UTM_OPTS_ADD_SPACES,t.PE_UTM_OPTS_NS=oe.PeNotationUtm.prototype.PE_UTM_OPTS_NS}function r(s,n,o,a,l){oe.ensureCache.prepare();let c=0;s&&(c=oe.getPointer(s));const h=yb(o),p=oe.ensureFloat64(h),f=cP(n,Vs.PE_UTM_MAX),m=oe.ensureInt32(f),y=oe._pe_geog_to_utm(c,n,p,a,m);if(y)for(let _=0;_<n;_++)l[_]=oe.UTF8ToString(f[_]);return y}function i(s,n,o,a,l){oe.ensureCache.prepare();let c=0;s&&(c=oe.getPointer(s));const h=o.map(y=>oe.ensureString(y)),p=oe.ensureInt32(h),f=oe.ensureFloat64(new Array(2*n)),m=oe._pe_utm_to_geog(c,n,p,a,f);return m&&o_(l,n,f),m}t.init=e,t.geogToUtm=r,t.utmToGeog=i}(yN||(yN={})),function(t){const e=new Map;function r(){t.PE_PCSINFO_OPTION_NONE=oe.PePCSInfo.prototype.PE_PCSINFO_OPTION_NONE,t.PE_PCSINFO_OPTION_DOMAIN=oe.PePCSInfo.prototype.PE_PCSINFO_OPTION_DOMAIN,t.PE_POLE_OUTSIDE_BOUNDARY=oe.PePCSInfo.prototype.PE_POLE_OUTSIDE_BOUNDARY,t.PE_POLE_POINT=oe.PePCSInfo.prototype.PE_POLE_POINT}function i(s,n=t.PE_PCSINFO_OPTION_DOMAIN){let o=null,a=null;return e.has(s)&&(a=e.get(s),a[n]&&(o=a[n])),o||(o=oe.PePCSInfo.prototype.generate(s,n),a||(a=[],e.set(s,a)),a[n]=o),o}t.init=r,t.generate=i}(_N||(_N={})),function(t){function e(){return oe.PeVersion.prototype.version_string()}t.versionString=e}(qB||(qB={}));const tDe=Object.freeze(Object.defineProperty({__proto__:null,get PeCSTransformations(){return VB},get PeDefs(){return Vs},get PeFactory(){return BB},get PeGCSExtent(){return ufe},get PeGTTransformations(){return GB},get PeGTlistExtended(){return mN},get PeGTlistExtendedEntry(){return zB},get PeNotationDms(){return jB},get PeNotationMgrs(){return gN},get PeNotationUsng(){return HB},get PeNotationUtm(){return yN},get PePCSInfo(){return _N},get PeVersion(){return qB},_init:hfe,get _pe(){return oe},isLoaded:lfe,isSupported:eDe,load:cfe},Symbol.toStringTag,{value:"Module"})),Jxt=Math.PI/180,Kxt=/SPHEROID\[([^\]]+)]/i,Ly=wr.radius,id=wr.eccentricitySquared,rDe={a1:Ly*id,a2:Ly*id*Ly*id,a3:Ly*id*id/2,a4:Ly*id*Ly*id*2.5,a5:Ly*id+Ly*id*id/2,a6:1-id},Qxt={4267:{a:63782064e-1,f:1/294.9786982},4269:{a:6378137,f:1/298.257222101},4326:{a:wr.radius,f:wr.flattening},104900:{a:2439700,f:0},104901:{a:6051e3,f:0},104902:{a:6051800,f:0},104903:{a:Jg.radius,f:Jg.flattening},104904:{a:3393400,f:1/192.0430107526882},104905:{a:Gf.radius,f:Gf.flattening},104906:{a:6200,f:0},104907:{a:11100,f:0},104908:{a:71492e3,f:.06487439154031222},104909:{a:8200,f:0},104910:{a:83500,f:0},104911:{a:1e4,f:0},104912:{a:2409300,f:0},104913:{a:15e3,f:0},104914:{a:4e4,f:0},104915:{a:1562090,f:0},104916:{a:2632345,f:0},104917:{a:85e3,f:0},104918:{a:1821460,f:0},104919:{a:5e3,f:0},104920:{a:12e3,f:0},104921:{a:3e4,f:3},104922:{a:18e3,f:0},104923:{a:14e3,f:0},104924:{a:49300,f:0},104925:{a:60268e3,f:1/10.2079945799458},104926:{a:16e3,f:0},104927:{a:9500,f:0},104928:{a:56e4,f:0},104929:{a:249400,f:0},104930:{a:59500,f:0},104931:{a:16e3,f:0},104932:{a:133e3,f:0},104933:{a:718e3,f:0},104934:{a:888e3,f:0},104935:{a:1986300,f:0},104936:{a:1e4,f:0},104937:{a:41900,f:0},104938:{a:11e4,f:0},104939:{a:50100,f:0},104940:{a:764e3,f:0},104941:{a:11e3,f:0},104942:{a:529800,f:0},104943:{a:2575e3,f:0},104944:{a:25559e3,f:1/43.61604095563141},104945:{a:578900,f:0},104946:{a:33e3,f:0},104947:{a:21e3,f:0},104948:{a:13e3,f:0},104949:{a:31e3,f:0},104950:{a:27e3,f:0},104951:{a:42e3,f:0},104952:{a:235800,f:0},104953:{a:761400,f:0},104954:{a:15e3,f:0},104955:{a:54e3,f:0},104956:{a:77e3,f:0},104957:{a:27e3,f:0},104958:{a:788900,f:0},104959:{a:584700,f:0},104960:{a:24764e3,f:.01708124697141011},104961:{a:74e3,f:0},104962:{a:79e3,f:0},104963:{a:104e3,f:.14423076923076922},104964:{a:29e3,f:0},104965:{a:17e4,f:0},104966:{a:208e3,f:0},104967:{a:4e4,f:0},104968:{a:1352600,f:0},104969:{a:1195e3,f:0},104970:{a:593e3,f:0},104971:{a:Gf.radius,f:0},104972:{a:47e4,f:0},104973:{a:255e3,f:0},104974:{a:2439400,f:0}};let uP=0,X6=class WB{static fromGE(e){const r=new WB;return r._wkt=e.wkt,r._wkid=e.wkid,r._isInverse=e.isInverse,r}constructor(e){this.uid=uP++,e?(this._wkt=e.wkt!=null?e.wkt:null,this._wkid=e.wkid!=null?e.wkid:-1,this._isInverse=e.isInverse!=null&&e.isInverse===!0):(this._wkt=null,this._wkid=-1,this._isInverse=!1)}get wkt(){return this._wkt}set wkt(e){this._wkt=e,this.uid=uP++}get wkid(){return this._wkid}set wkid(e){this._wkid=e,this.uid=uP++}get isInverse(){return this._isInverse}set isInverse(e){this._isInverse=e,this.uid=uP++}getInverse(){const e=new WB;return e._wkt=this.wkt,e._wkid=this._wkid,e._isInverse=!this.isInverse,e}},XB=class $A{static cacheKey(e,r){return[e.wkid!==void 0&&e.wkid!==null?e.wkid.toString():"-1",e.wkt!==void 0&&e.wkt!==null?e.wkt.toString():"",r.wkid!==void 0&&r.wkid!==null?r.wkid.toString():"-1",r.wkt!==void 0&&r.wkt!==null?r.wkt.toString():""].join(",")}static fromGE(e){const r=new $A;let i="";for(const s of e.steps){const n=X6.fromGE(s);r.steps.push(n),i+=n.uid.toString()+","}return r._cachedProjection={},r._gtlistentry=null,r._chain=i,r}constructor(e){if(this.steps=[],this._cachedProjection={},this._chain="",this._gtlistentry=null,e&&e.steps)for(const r of e.steps)r instanceof X6?this.steps.push(r):this.steps.push(new X6({wkid:r.wkid,wkt:r.wkt,isInverse:r.isInverse}))}getInverse(){const e=new $A;e.steps=[];for(let r=this.steps.length-1;r>=0;r--){const i=this.steps[r];e.steps.push(i.getInverse())}return e}getGTListEntry(){let e="";for(const r of this.steps)e+=r.uid.toString()+",";return e!==this._chain&&(this._gtlistentry=null,this._cachedProjection={},this._chain=e),this._gtlistentry}assignCachedGe(e,r,i){this._cachedProjection[$A.cacheKey(e,r)]=i}getCachedGeTransformation(e,r){let i="";for(const n of this.steps)i+=n.uid.toString()+",";i!==this._chain&&(this._gtlistentry=null,this._cachedProjection={},this._chain=i);const s=this._cachedProjection[$A.cacheKey(e,r)];return s===void 0?null:s}};function dfe(t,e,r){if(C(e)||C(r)||r.vcsWkid||Tn(e,r))return null;const i=uw(e)/uw(r);if(i===1)return null;switch(t){case"point":case"esriGeometryPoint":return s=>iDe(s,i);case"polyline":case"esriGeometryPolyline":return s=>nDe(s,i);case"polygon":case"esriGeometryPolygon":return s=>sDe(s,i);case"multipoint":case"esriGeometryMultipoint":return s=>oDe(s,i);case"extent":case"esriGeometryExtent":return s=>aDe(s,i);default:return null}}function iDe(t,e){t&&t.z!=null&&(t.z*=e)}function sDe(t,e){if(t)for(const r of t.rings)for(const i of r)i.length>2&&(i[2]*=e)}function nDe(t,e){if(t)for(const r of t.paths)for(const i of r)i.length>2&&(i[2]*=e)}function oDe(t,e){if(t)for(const r of t.points)r.length>2&&(r[2]*=e)}function aDe(t,e){t&&t.zmin!=null&&t.zmax!=null&&(t.zmin*=e,t.zmax*=e)}let D_=null,JR=null,Y6=null,Z6={};const pfe=new iq;function yW(){return!!D_&&lfe()}function vN(t){return C(Y6)&&(Y6=Promise.all([cfe(),te(()=>import("./geometryEngineBase-e1a33b0a.js"),[]).then(e=>e.g),te(()=>import("./hydrated-69b3d367.js"),[])])),Y6.then(([,e,{hydratedAdapter:r}])=>{fr(t),JR=r,D_=e.default,D_._enableProjection(tDe),pfe.notify()})}function AE(t,e,r=null,i=null){return Array.isArray(t)?t.length===0?[]:oQ(JR,t,t[0].spatialReference,e,r,i):oQ(JR,[t],t.spatialReference,e,r,i)[0]}function oQ(t,e,r,i,s=null,n=null){if(C(r)||C(i))return e;if(yw(r,i,s))return e.map(o=>ffe(o,r,i));if(C(s)){const o=XB.cacheKey(r,i);Z6[o]!==void 0?s=Z6[o]:(s=cDe(r,i,void 0),C(s)&&(s=new XB),Z6[o]=s)}if(C(D_)||C(t))throw new _W;return v(n)?D_._project(t,e,r,i,s,n):D_._project(t,e,r,i,s)}function eTt(t,e){const r=lDe([t],e);return v(r.pending)?{pending:r.pending,geometry:null}:v(r.geometries)?{pending:null,geometry:r.geometries[0]}:{pending:null,geometry:null}}function lDe(t,e){if(!yW()){for(const r of t)if(v(r)&&!Tn(r.spatialReference,e)&&pa(r.spatialReference)&&pa(e)&&!yw(r.spatialReference,e))return br(pfe),{pending:vN(),geometries:null}}return{pending:null,geometries:t.map(r=>C(r)?null:Tn(r.spatialReference,e)?r:pa(r.spatialReference)&&pa(e)?uDe(r,e):null)}}function cDe(t,e,r=null){if(C(t)||C(e))return null;if(C(D_)||C(JR))throw new _W;const i=D_._getTransformation(JR,t,e,r,r==null?void 0:r.spatialReference);return i!==null?XB.fromGE(i):null}class _W extends q{constructor(){super("projection:not-loaded","projection engine not fully loaded yet, please call load()")}}var Z;(function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.SPHERICAL_ECEF=1]="SPHERICAL_ECEF",t[t.WGS84=2]="WGS84",t[t.WEB_MERCATOR=3]="WEB_MERCATOR",t[t.WGS84_ECEF=4]="WGS84_ECEF",t[t.CGCS2000=5]="CGCS2000",t[t.WGS84_COMPARABLE_LON_LAT=6]="WGS84_COMPARABLE_LON_LAT",t[t.SPHERICAL_MARS_PCPF=7]="SPHERICAL_MARS_PCPF",t[t.GCSMARS2000=8]="GCSMARS2000",t[t.SPHERICAL_MOON_PCPF=9]="SPHERICAL_MOON_PCPF",t[t.GCSMOON2000=10]="GCSMOON2000",t[t.LON_LAT=11]="LON_LAT",t[t.PLATE_CARREE=12]="PLATE_CARREE"})(Z||(Z={}));function uDe(t,e){try{const r=AE(t,e);if(r==null)return null;"xmin"in t&&"xmin"in r&&(r.zmin=t.zmin,r.zmax=t.zmax);const i=dfe(r.type,t.spatialReference,e);return v(i)&&i(r),r}catch(r){if(!(r instanceof _W))throw r;return null}}function yw(t,e,r){return!r&&(!!Tn(t,e)||pa(t)&&pa(e)&&!!xW(t,e,SW))}async function hDe(t,e,r,i){if(yW())return HJ(i);if(Array.isArray(t)){for(const{source:s,dest:n,geographicTransformation:o}of t)if(!yw(s,n,o))return vN(i)}else if(!yw(t,e,r))return vN(i);return HJ(i)}function tTt(t,e){switch(xW(t,e,SW)){case Ii:return"copy3";case w_:return"wgs84ToSphericalECEF";case _w:return"wgs84ToWebMercator";case b_:return"wgs84ToPlateCarree";case T_:return"wgs84ToWGS84ECEF";case Xb:return"webMercatorToWGS84";case bfe:return"webMercatorToSphericalECEF";case wfe:return"webMercatorToWGS84ECEF";case xfe:return"webMercatorToPlateCarree";case S_:return"wgs84ECEFToWGS84";case Efe:return"wgs84ECEFToSphericalECEF";case Cfe:return"wgs84ECEFToWebMercator";case x_:return"sphericalECEFToWGS84";case Tfe:return"sphericalECEFToWebMercator";case KB:return"sphericalMarsPCPFToMars2000";case JB:return"sphericalMoonPCPFToMoon2000";case Sfe:return"sphericalECEFToWGS84ECEF";case ZB:return"mars2000ToSphericalPCPF";case YB:return"moon2000ToSphericalPCPF";default:return null}}function ffe(t,e,r){return t?"x"in t?mfe(t,e,new mt,r,0):"xmin"in t?mDe(t,e,new Zr,r,0):"rings"in t?gfe(t,e,new pp,r,0):"paths"in t?fDe(t,e,new Eu,r,0):"points"in t?pDe(t,e,new QO,r,0):null:null}function dDe(t,e,r=e.spatialReference,i=0){return v(r)&&v(t.spatialReference)&&v(mfe(t,t.spatialReference,e,r,i))}function mfe(t,e,r,i,s){ii[0]=t.x,ii[1]=t.y;const n=t.z;return ii[2]=n!==void 0?n:s,_s(ii,e,0,ii,i,0,1)?(r.x=ii[0],r.y=ii[1],r.spatialReference=i,n===void 0?(r.z=void 0,r.hasZ=!1):(r.z=ii[2],r.hasZ=!0),t.m===void 0?(r.m=void 0,r.hasM=!1):(r.m=t.m,r.hasM=!0),r):null}function pDe(t,e,r,i,s){const{points:n,hasZ:o,hasM:a}=t,l=[],c=n.length,h=[];for(const p of n)h.push(p[0],p[1],o?p[2]:s);if(!_s(h,e,0,h,i,0,c))return null;for(let p=0;p<c;++p){const f=3*p,m=h[f],y=h[f+1];o&&a?l.push([m,y,h[f+2],n[p][3]]):o?l.push([m,y,h[f+2]]):a?l.push([m,y,n[p][2]]):l.push([m,y])}return r.points=l,r.spatialReference=i,r.hasZ=o,r.hasM=a,r}function fDe(t,e,r,i,s){const{paths:n,hasZ:o,hasM:a}=t,l=[];return _fe(n,o??!1,a??!1,e,l,i,s)?(r.paths=l,r.spatialReference=i,r.hasZ=o,r.hasM=a,r):null}function rTt(t,e,r=e.spatialReference,i=0){return v(t.spatialReference)&&v(r)&&v(gfe(t,t.spatialReference,e,r,i))}function gfe(t,e,r,i,s){const{rings:n,hasZ:o,hasM:a}=t,l=[];return _fe(n,o??!1,a??!1,e,l,i,s)?(r.rings=l,r.spatialReference=i,r.hasZ=o,r.hasM=a,r):null}function mDe(t,e,r,i,s){const{xmin:n,ymin:o,xmax:a,ymax:l,hasZ:c,hasM:h}=t;return aQ(n,o,c?t.zmin:s,e,ii,i)?(r.xmin=ii[0],r.ymin=ii[1],c&&(r.zmin=ii[2]),aQ(a,l,c?t.zmax:s,e,ii,i)?(r.xmax=ii[0],r.ymax=ii[1],c&&(r.zmax=ii[2]),h&&(r.mmin=t.mmin,r.mmax=t.mmax),r.spatialReference=i,r):null):null}function J_(t,e,r){if(C(e)||C(r))return null;const i=new mt({spatialReference:r});return _s(t,e,0,ii,r,0,1)?(i.x=ii[0],i.y=ii[1],i.z=ii[2],i):null}function yfe(t,e,r){return _s(t,e,0,ii,r.spatialReference,0,1)?(r.x=ii[0],r.y=ii[1],r.z=ii[2],r):null}function Jo(t,e,r,i=0){ii[0]=t.x,ii[1]=t.y;const s=t.z;return ii[2]=s!==void 0?s:i,_s(ii,t.spatialReference,0,e,r,0,1)}function aQ(t,e,r,i,s,n){return ps[0]=t,ps[1]=e,ps[2]=r,_s(ps,i,0,s,n,0,1)}function no(t,e,r,i){return!(C(e)||C(i)||t.length<2)&&(t.length===2&&(ps[0]=t[0],ps[1]=t[1],ps[2]=0,t=ps),_s(t,e,0,r,i,0,1))}function gDe(t,e){ii[0]=t.x,ii[1]=t.y;const r=t.z;return ii[2]=r!==void 0?r:0,yDe(ii,t.spatialReference,e)}function yDe(t,e,r){return _De(t,e,r)}function _De(t,e,r){if(C(e))return!1;const i=K_(e,F4),s=Ff[i][Z.WGS84_COMPARABLE_LON_LAT];return!C(s)&&(s(t,0,ps,0),r!==ps&&(r[0]=ps[0],r[1]=ps[1],r.length>2&&(r[2]=ps[2])),!0)}function _s(t,e,r,i,s,n,o=1){const a=xW(e,s,SW);if(C(a))return!1;if(a===Ii){if(t===i&&r===n)return!0;const c=r+3*o;for(let h=r,p=n;h<c;h++,p++)i[p]=t[h];return!0}const l=r+3*o;for(let c=r,h=n;c<l;c+=3,h+=3)a(t,c,i,h);return!0}function iTt(t,e,r,i,s){le(ii,t),fe(hP,t,e),no(ii,r,ii,s),no(hP,r,hP,s),me(i,hP,ii),_e(i,i)}function _fe(t,e,r,i,s,n,o=0){const a=new Array;for(const c of t)for(const h of c)a.push(h[0],h[1],e?h[2]:o);if(!_s(a,i,0,a,n,0,a.length/3))return!1;let l=0;s.length=0;for(const c of t){const h=new Array;for(const p of c)e&&r?h.push([a[l++],a[l++],a[l++],p[3]]):e?h.push([a[l++],a[l++],a[l++]]):r?(h.push([a[l++],a[l++],p[2]]),l++):(h.push([a[l++],a[l++]]),l++);s.push(h)}return!0}function sTt(t,e,r,i){if(C(e)||C(i))return!1;const s=Afe(e,i,ADe);if(s.projector===Ii)return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],!0;if(C(s.projector))return!1;const{source:n,dest:o}=s;if(o.spatialReferenceId===Z.WEB_MERCATOR){const a=Ff[n.spatialReferenceId][Z.WGS84];return!C(a)&&(a(t,0,Dd,0),_w(Dd,0,r,0),r[3]=lQ(Dd[1],t[2],t[3],wr.radius),!0)}if(n.spatialReferenceId!==Z.WGS84&&n.spatialReferenceId!==Z.CGCS2000||o.spatialReferenceId!==Z.PLATE_CARREE){s.projector(t,0,r,0);const a=n.metersPerUnit??1,l=o.metersPerUnit??1;r[3]=t[3]*a/l}else{const a=Ff[n.spatialReferenceId][Z.SPHERICAL_ECEF],l=Ff[Z.SPHERICAL_ECEF][Z.PLATE_CARREE];let c=t[3];v(a)&&v(l)&&(c=lQ(t[1],t[2],t[3],wr.radius)),s.projector(t,0,r,0),r[3]=c}return!0}function lQ(t,e,r,i){const s=i+e;if(s<i/2||r>s)return Number.MAX_VALUE;const n=Math.abs(Jd*t)+Math.asin(r/s);return n>=Math.PI/2?Number.MAX_VALUE:r/Math.cos(n)}function N4(t,e,r,i){return t!=null&&(Tn(e,i)?(Kg(r,t),!0):(ps[0]=t[0],ps[1]=t[1],ps[2]=0,!!_s(ps,e,0,ps,i,0,1)&&(r[0]=ps[0],r[1]=ps[1],ps[0]=t[2],ps[1]=t[3],ps[2]=0,!!_s(ps,e,0,ps,i,0,1)&&(r[2]=ps[0],r[3]=ps[1],!0))))}function nTt(t,e,r,i){if(C(e)||C(i))return!1;const s=K_(e,F4),n=K_(i,Rfe);if(s===n&&s!==Z.UNKNOWN||Tn(e,i))return r[0]=1,r[1]=1,r[2]=1,!0;if(s===Z.SPHERICAL_ECEF){const o=Me(t),a=o/Math.sqrt(t[0]*t[0]+t[1]*t[1]),l=o/wr.radius;if(n===Z.WEB_MERCATOR)return r[0]=a*l,r[1]=a*l,r[2]=1,!0;if(n===Z.WGS84||n===Z.CGCS2000){const c=X3;return r[0]=c*a*l,r[1]=c*l,r[2]=1,!0}}else if(s===Z.PLATE_CARREE){if(n===Z.WGS84||n===Z.CGCS2000)return r[0]=X3,r[1]=X3,r[2]=1,!0;if(n===Z.WEB_MERCATOR){const o=t[1]/wr.radius;return r[0]=1,r[1]=1/Math.cos(o),r[2]=1,!0}}return!1}function gp(t,e,r,i){if(C(t)||C(i))return!1;const s=K_(t,F4),n=K_(i,Rfe);if(s===n&&!cQ(n)&&(s!==Z.UNKNOWN||Tn(t,i)))return $4(r,e),!0;if(cQ(n)){const o=Ff[s][Z.LON_LAT],a=Ff[Z.LON_LAT][n];return!C(o)&&!C(a)&&(o(e,0,Dd,0),a(Dd,0,Dy,0),vfe(Jd*Dd[0],Jd*Dd[1],r),r[12]=Dy[0],r[13]=Dy[1],r[14]=Dy[2],!0)}if((n===Z.WEB_MERCATOR||n===Z.PLATE_CARREE)&&(s===Z.WGS84||s===Z.CGCS2000&&n===Z.PLATE_CARREE||s===Z.SPHERICAL_ECEF||s===Z.WEB_MERCATOR)){const o=Ff[s][Z.LON_LAT],a=Ff[Z.LON_LAT][n];return!C(o)&&!C(a)&&(o(e,0,Dd,0),a(Dd,0,Dy,0),s===Z.SPHERICAL_ECEF?vDe(Jd*Dd[0],Jd*Dd[1],r):Gh(r),r[12]=Dy[0],r[13]=Dy[1],r[14]=Dy[2],!0)}return!1}function cQ(t){return t===Z.SPHERICAL_ECEF||t===Z.SPHERICAL_MARS_PCPF||t===Z.SPHERICAL_MOON_PCPF}function vfe(t,e,r){const i=Math.sin(t),s=Math.cos(t),n=Math.sin(e),o=Math.cos(e),a=r;return a[0]=-i,a[4]=-n*s,a[8]=o*s,a[12]=0,a[1]=s,a[5]=-n*i,a[9]=o*i,a[13]=0,a[2]=0,a[6]=o,a[10]=n,a[14]=0,a[3]=0,a[7]=0,a[11]=0,a[15]=1,a}function vDe(t,e,r){return vfe(t,e,r),Dc(r,r),r}function K_(t,e){return t?e.spatialReference===t?e.spatialReferenceId:(e.spatialReference=t,"metersPerUnit"in e&&(e.metersPerUnit=nl(t,1)),t.wkt===dhe.wkt?e.spatialReferenceId=Z.SPHERICAL_ECEF:FR(t)?e.spatialReferenceId=Z.WGS84:cw(t)?e.spatialReferenceId=Z.WEB_MERCATOR:mq(t)?e.spatialReferenceId=Z.PLATE_CARREE:t.wkt===phe.wkt?e.spatialReferenceId=Z.WGS84_ECEF:t.wkid===Ah.CGCS2000?e.spatialReferenceId=Z.CGCS2000:t.wkt===vq.wkt?e.spatialReferenceId=Z.SPHERICAL_MARS_PCPF:t.wkt===bq.wkt?e.spatialReferenceId=Z.SPHERICAL_MOON_PCPF:fm(t)?e.spatialReferenceId=Z.GCSMARS2000:mm(t)?e.spatialReferenceId=Z.GCSMOON2000:e.spatialReferenceId=Z.UNKNOWN):Z.UNKNOWN}function Ii(t,e,r,i){t!==r&&(r[i++]=t[e++],r[i++]=t[e++],r[i]=t[e])}function Xb(t,e,r,i){r[i++]=NS*(t[e++]/wr.radius),r[i++]=NS*(Math.PI/2-2*Math.atan(Math.exp(-t[e++]/wr.radius))),r[i]=t[e]}function bfe(t,e,r,i){Xb(t,e,r,i),w_(r,i,r,i)}function wfe(t,e,r,i){Xb(t,e,r,i),T_(r,i,r,i)}function vW(t,e,r,i,s){const n=.4999999*Math.PI,o=ge(Jd*t[e+1],-n,n),a=Math.sin(o);r[i++]=Jd*t[e]*s.radius,r[i++]=s.halfSemiMajorAxis*Math.log((1+a)/(1-a)),r[i]=t[e+2]}function _w(t,e,r,i){vW(t,e,r,i,wr)}const uQ=wr.radius*Math.PI/180,X3=180/(wr.radius*Math.PI);function b_(t,e,r,i){r[i]=t[e]*uQ,r[i+1]=t[e+1]*uQ,r[i+2]=t[e+2]}function $b(t,e,r,i){r[i]=t[e]*X3,r[i+1]=t[e+1]*X3,r[i+2]=t[e+2]}function xfe(t,e,r,i){Xb(t,e,r,i),b_(r,i,r,i)}function bDe(t,e,r,i){S_(t,e,r,i),b_(r,i,r,i)}function wDe(t,e,r,i){x_(t,e,r,i),b_(r,i,r,i)}function xDe(t,e,r,i){$b(t,e,r,i),w_(r,i,r,i)}function TDe(t,e,r,i){$b(t,e,r,i),_w(r,i,r,i)}function SDe(t,e,r,i){$b(t,e,r,i),T_(r,i,r,i)}function vw(t){if(C(t))return!1;const e=K_(t,F4);return!!Ff[e][Z.WGS84_COMPARABLE_LON_LAT]}function EDe(t,e,r,i){const s=Math.cos(r);t[0]=Math.cos(e)*s*i,t[1]=Math.sin(e)*s*i,t[2]=Math.sin(r)*i}function bW(t,e,r,i,s){const n=s+t[e+2],o=Jd*t[e+1],a=Jd*t[e],l=Math.cos(o);r[i++]=Math.cos(a)*l*n,r[i++]=Math.sin(a)*l*n,r[i]=Math.sin(o)*n}function YB(t,e,r,i){bW(t,e,r,i,Jg.radius)}function ZB(t,e,r,i){bW(t,e,r,i,Gf.radius)}function w_(t,e,r,i){bW(t,e,r,i,wr.radius)}function wW(t,e,r,i,s){const n=t[e],o=t[e+1],a=t[e+2],l=Math.sqrt(n*n+o*o+a*a),c=Uh(a/(l===0?1:l)),h=Math.atan2(o,n);r[i++]=NS*h,r[i++]=NS*c,r[i]=l-s}function JB(t,e,r,i){wW(t,e,r,i,Jg.radius)}function KB(t,e,r,i){wW(t,e,r,i,Gf.radius)}function x_(t,e,r,i){wW(t,e,r,i,wr.radius)}function Tfe(t,e,r,i){x_(t,e,r,i),_w(r,i,r,i)}function Sfe(t,e,r,i){x_(t,e,r,i),T_(r,i,r,i)}function CDe(t,e,r,i,s){const n=Jd*t[e],o=Jd*t[e+1],a=t[e+2],l=Math.sin(o),c=Math.cos(o),h=s.radius/Math.sqrt(1-s.eccentricitySquared*l*l);r[i++]=(h+a)*c*Math.cos(n),r[i++]=(h+a)*c*Math.sin(n),r[i++]=(h*(1-s.eccentricitySquared)+a)*l}function T_(t,e,r,i){CDe(t,e,r,i,wr)}function S_(t,e,r,i){const s=rDe,n=t[e],o=t[e+1],a=t[e+2];let l,c,h,p,f,m,y,_,b,x,T,S,E,O,R,L,P,U,B,z,G;l=Math.abs(a),c=n*n+o*o,h=Math.sqrt(c),p=c+a*a,f=Math.sqrt(p),z=Math.atan2(o,n),m=a*a/p,y=c/p,O=s.a2/f,R=s.a3-s.a4/f,y>.3?(_=l/f*(1+y*(s.a1+O+m*R)/f),B=Math.asin(_),x=_*_,b=Math.sqrt(1-x)):(b=h/f*(1-m*(s.a5-O-y*R)/f),B=Math.acos(b),x=1-b*b,_=Math.sqrt(x)),T=1-wr.eccentricitySquared*x,S=wr.radius/Math.sqrt(T),E=s.a6*S,O=h-S*b,R=l-E*_,P=b*O+_*R,L=b*R-_*O,U=L/(E/T+P),B+=U,G=P+L*U/2,a<0&&(B=-B),r[i++]=NS*z,r[i++]=NS*B,r[i]=G}function Efe(t,e,r,i){S_(t,e,r,i),w_(r,i,r,i)}function Cfe(t,e,r,i){S_(t,e,r,i),_w(r,i,r,i)}const Ff={[Z.WGS84]:{[Z.CGCS2000]:null,[Z.GCSMARS2000]:null,[Z.GCSMOON2000]:null,[Z.LON_LAT]:Ii,[Z.WGS84_COMPARABLE_LON_LAT]:Ii,[Z.SPHERICAL_ECEF]:w_,[Z.SPHERICAL_MARS_PCPF]:null,[Z.SPHERICAL_MOON_PCPF]:null,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:_w,[Z.PLATE_CARREE]:b_,[Z.WGS84]:Ii,[Z.WGS84_ECEF]:T_},[Z.CGCS2000]:{[Z.CGCS2000]:Ii,[Z.GCSMARS2000]:null,[Z.GCSMOON2000]:null,[Z.LON_LAT]:Ii,[Z.WGS84_COMPARABLE_LON_LAT]:Ii,[Z.SPHERICAL_ECEF]:w_,[Z.SPHERICAL_MARS_PCPF]:null,[Z.SPHERICAL_MOON_PCPF]:null,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:null,[Z.PLATE_CARREE]:b_,[Z.WGS84]:null,[Z.WGS84_ECEF]:T_},[Z.GCSMARS2000]:{[Z.CGCS2000]:null,[Z.GCSMARS2000]:Ii,[Z.GCSMOON2000]:null,[Z.LON_LAT]:Ii,[Z.WGS84_COMPARABLE_LON_LAT]:null,[Z.SPHERICAL_ECEF]:null,[Z.SPHERICAL_MARS_PCPF]:ZB,[Z.SPHERICAL_MOON_PCPF]:null,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:null,[Z.PLATE_CARREE]:null,[Z.WGS84]:null,[Z.WGS84_ECEF]:null},[Z.GCSMOON2000]:{[Z.CGCS2000]:null,[Z.GCSMARS2000]:null,[Z.GCSMOON2000]:Ii,[Z.LON_LAT]:Ii,[Z.WGS84_COMPARABLE_LON_LAT]:null,[Z.SPHERICAL_ECEF]:null,[Z.SPHERICAL_MARS_PCPF]:null,[Z.SPHERICAL_MOON_PCPF]:YB,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:null,[Z.PLATE_CARREE]:null,[Z.WGS84]:null,[Z.WGS84_ECEF]:null},[Z.WEB_MERCATOR]:{[Z.CGCS2000]:null,[Z.GCSMARS2000]:null,[Z.GCSMOON2000]:null,[Z.LON_LAT]:Xb,[Z.WGS84_COMPARABLE_LON_LAT]:Xb,[Z.SPHERICAL_ECEF]:bfe,[Z.SPHERICAL_MARS_PCPF]:null,[Z.SPHERICAL_MOON_PCPF]:null,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:Ii,[Z.PLATE_CARREE]:xfe,[Z.WGS84]:Xb,[Z.WGS84_ECEF]:wfe},[Z.WGS84_ECEF]:{[Z.CGCS2000]:S_,[Z.GCSMARS2000]:null,[Z.GCSMOON2000]:null,[Z.LON_LAT]:S_,[Z.WGS84_COMPARABLE_LON_LAT]:S_,[Z.SPHERICAL_ECEF]:Efe,[Z.SPHERICAL_MARS_PCPF]:null,[Z.SPHERICAL_MOON_PCPF]:null,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:Cfe,[Z.PLATE_CARREE]:bDe,[Z.WGS84]:S_,[Z.WGS84_ECEF]:Ii},[Z.SPHERICAL_ECEF]:{[Z.CGCS2000]:x_,[Z.GCSMARS2000]:null,[Z.GCSMOON2000]:null,[Z.LON_LAT]:x_,[Z.WGS84_COMPARABLE_LON_LAT]:x_,[Z.SPHERICAL_ECEF]:Ii,[Z.SPHERICAL_MARS_PCPF]:null,[Z.SPHERICAL_MOON_PCPF]:null,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:Tfe,[Z.PLATE_CARREE]:wDe,[Z.WGS84]:x_,[Z.WGS84_ECEF]:Sfe},[Z.SPHERICAL_MARS_PCPF]:{[Z.CGCS2000]:null,[Z.GCSMARS2000]:KB,[Z.GCSMOON2000]:null,[Z.LON_LAT]:KB,[Z.WGS84_COMPARABLE_LON_LAT]:null,[Z.SPHERICAL_ECEF]:null,[Z.SPHERICAL_MARS_PCPF]:Ii,[Z.SPHERICAL_MOON_PCPF]:null,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:null,[Z.PLATE_CARREE]:null,[Z.WGS84]:null,[Z.WGS84_ECEF]:null},[Z.SPHERICAL_MOON_PCPF]:{[Z.CGCS2000]:null,[Z.GCSMARS2000]:null,[Z.GCSMOON2000]:JB,[Z.LON_LAT]:JB,[Z.WGS84_COMPARABLE_LON_LAT]:null,[Z.SPHERICAL_ECEF]:null,[Z.SPHERICAL_MARS_PCPF]:null,[Z.SPHERICAL_MOON_PCPF]:Ii,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:null,[Z.PLATE_CARREE]:null,[Z.WGS84]:null,[Z.WGS84_ECEF]:null},[Z.UNKNOWN]:{[Z.CGCS2000]:null,[Z.GCSMARS2000]:null,[Z.GCSMOON2000]:null,[Z.LON_LAT]:null,[Z.WGS84_COMPARABLE_LON_LAT]:null,[Z.SPHERICAL_ECEF]:null,[Z.SPHERICAL_MARS_PCPF]:null,[Z.SPHERICAL_MOON_PCPF]:null,[Z.UNKNOWN]:Ii,[Z.WEB_MERCATOR]:null,[Z.PLATE_CARREE]:null,[Z.WGS84]:null,[Z.WGS84_ECEF]:null},[Z.LON_LAT]:{[Z.CGCS2000]:Ii,[Z.GCSMARS2000]:Ii,[Z.GCSMOON2000]:Ii,[Z.LON_LAT]:Ii,[Z.WGS84_COMPARABLE_LON_LAT]:Ii,[Z.SPHERICAL_ECEF]:w_,[Z.SPHERICAL_MARS_PCPF]:ZB,[Z.SPHERICAL_MOON_PCPF]:YB,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:_w,[Z.PLATE_CARREE]:b_,[Z.WGS84]:Ii,[Z.WGS84_ECEF]:T_},[Z.WGS84_COMPARABLE_LON_LAT]:{[Z.CGCS2000]:null,[Z.GCSMARS2000]:null,[Z.GCSMOON2000]:null,[Z.LON_LAT]:Ii,[Z.WGS84_COMPARABLE_LON_LAT]:Ii,[Z.SPHERICAL_ECEF]:w_,[Z.SPHERICAL_MARS_PCPF]:null,[Z.SPHERICAL_MOON_PCPF]:null,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:null,[Z.PLATE_CARREE]:b_,[Z.WGS84]:Ii,[Z.WGS84_ECEF]:T_},[Z.PLATE_CARREE]:{[Z.CGCS2000]:$b,[Z.GCSMARS2000]:null,[Z.GCSMOON2000]:null,[Z.LON_LAT]:$b,[Z.WGS84_COMPARABLE_LON_LAT]:$b,[Z.SPHERICAL_ECEF]:xDe,[Z.SPHERICAL_MARS_PCPF]:null,[Z.SPHERICAL_MOON_PCPF]:null,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:TDe,[Z.PLATE_CARREE]:Ii,[Z.WGS84]:$b,[Z.WGS84_ECEF]:SDe}};function xW(t,e,r=TW()){return C(t)||C(e)?null:Afe(t,e,r).projector}function Afe(t,e,r){if(C(t)||C(e)||r.source.spatialReference===t&&r.dest.spatialReference===e)return r;const i=K_(t,r.source),s=K_(e,r.dest);return i===Z.UNKNOWN&&s===Z.UNKNOWN?Tn(t,e)?r.projector=Ii:r.projector=null:r.projector=Ff[i][s],r}function TW(){return{source:{spatialReference:null,spatialReferenceId:Z.UNKNOWN,metersPerUnit:1},dest:{spatialReference:null,spatialReferenceId:Z.UNKNOWN,metersPerUnit:1},projector:Ii}}const F4={spatialReference:null,spatialReferenceId:Z.UNKNOWN},Rfe={spatialReference:null,spatialReferenceId:Z.UNKNOWN},SW=TW(),ADe=TW(),Jd=Gt(1),NS=rl(1),ps=M(),Dd=M(),Dy=M(),ii=M(),hP=M();let cy=class{constructor(e){this._allocator=e,this._items=[],this._itemsPtr=0,this._grow()}get(){return this._itemsPtr===0&&_S(()=>this._reset()),this._itemsPtr===this._items.length&&this._grow(),this._items[this._itemsPtr++]}_reset(){const e=Math.min(3*Math.max(8,this._itemsPtr),this._itemsPtr+3*hQ);this._items.length=Math.min(e,this._items.length),this._itemsPtr=0}_grow(){for(let e=0;e<Math.max(8,Math.min(this._items.length,hQ));e++)this._items.push(this._allocator())}};const hQ=1024;function Ie(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function FS(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]]}function EW(t,e,r,i,s,n,o,a,l,c,h,p,f,m,y,_){return[t,e,r,i,s,n,o,a,l,c,h,p,f,m,y,_]}function Ofe(t,e){return new Float64Array(t,e,16)}const Lu=Ie();Object.freeze(Object.defineProperty({__proto__:null,IDENTITY:Lu,clone:FS,create:Ie,createView:Ofe,fromValues:EW},Symbol.toStringTag,{value:"Module"}));var Oc;(function(t){t[t.X=0]="X",t[t.Y=1]="Y",t[t.Z=2]="Z"})(Oc||(Oc={}));function Mfe(t){return 32+t.length}function Pfe(t){return 16}function Ife(t){if(!t)return 0;let e=Dfe;for(const r in t)if(t.hasOwnProperty(r)){const i=t[r];switch(typeof i){case"string":e+=Mfe(i);break;case"number":e+=Pfe();break;case"boolean":e+=4}}return e}function $fe(t){if(!t)return 0;if(Array.isArray(t))return RDe(t);let e=Dfe;for(const r in t)t.hasOwnProperty(r)&&(e+=Lfe(t[r]));return e}function RDe(t){const e=t.length;if(e===0||typeof t[0]=="number")return 32+8*e;let r=Nfe;for(let i=0;i<e;i++)r+=Lfe(t[i]);return r}function Lfe(t){switch(typeof t){case"object":return $fe(t);case"string":return Mfe(t);case"number":return Pfe();case"boolean":return 4;default:return 8}}function aTt(t,e){return Nfe+t.length*e}const Dfe=32,Nfe=32;var US;(function(t){t[t.KILOBYTES=1024]="KILOBYTES",t[t.MEGABYTES=1048576]="MEGABYTES",t[t.GIGABYTES=1073741824]="GIGABYTES"})(US||(US={}));function es(){return[1,0,0,0,1,0,0,0,1]}function ODe(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]]}function MDe(t,e,r,i,s,n,o,a,l){return[t,e,r,i,s,n,o,a,l]}function Ffe(t,e){return new Float64Array(t,e,9)}Object.freeze(Object.defineProperty({__proto__:null,clone:ODe,create:es,createView:Ffe,fromValues:MDe},Symbol.toStringTag,{value:"Module"}));function Zh(){return[0,0,0,1]}function PDe(t){return[t[0],t[1],t[2],t[3]]}function IDe(t,e,r,i){return[t,e,r,i]}function Ufe(t,e){return new Float64Array(t,e,4)}const $De=Zh();Object.freeze(Object.defineProperty({__proto__:null,IDENTITY:$De,clone:PDe,create:Zh,createView:Ufe,fromValues:IDe},Symbol.toStringTag,{value:"Module"}));function Je(){return[0,0]}function LA(t){return[t[0],t[1]]}function Ur(t,e){return[t,e]}function kfe(t){const e=Je(),r=Math.min(2,t.length);for(let i=0;i<r;++i)e[i]=t[i];return e}function Vfe(t,e){return new Float64Array(t,e,2)}function Bfe(){return Je()}function zfe(){return Ur(1,1)}function Gfe(){return Ur(1,0)}function jfe(){return Ur(0,1)}const Wl=Bfe(),Hfe=zfe(),LDe=Gfe(),DDe=jfe();Object.freeze(Object.defineProperty({__proto__:null,ONES:Hfe,UNIT_X:LDe,UNIT_Y:DDe,ZEROS:Wl,clone:LA,create:Je,createView:Vfe,fromArray:kfe,fromValues:Ur,ones:zfe,unitX:Gfe,unitY:jfe,zeros:Bfe},Symbol.toStringTag,{value:"Module"}));function sr(){return[0,0,0,0]}function aM(t){return[t[0],t[1],t[2],t[3]]}function Ht(t,e,r,i){return[t,e,r,i]}function CW(t){const e=sr(),r=Math.min(4,t.length);for(let i=0;i<r;++i)e[i]=t[i];return e}function qfe(t,e){return new Float64Array(t,e,4)}function Wfe(){return sr()}function Xfe(){return Ht(1,1,1,1)}function Yfe(){return Ht(1,0,0,0)}function Zfe(){return Ht(0,1,0,0)}function Jfe(){return Ht(0,0,1,0)}function Kfe(){return Ht(0,0,0,1)}const qf=Wfe(),Rh=Xfe(),NDe=Yfe(),FDe=Zfe(),UDe=Jfe(),kDe=Kfe();Object.freeze(Object.defineProperty({__proto__:null,ONES:Rh,UNIT_W:kDe,UNIT_X:NDe,UNIT_Y:FDe,UNIT_Z:UDe,ZEROS:qf,clone:aM,create:sr,createView:qfe,fromArray:CW,fromValues:Ht,ones:Xfe,unitW:Kfe,unitX:Yfe,unitY:Zfe,unitZ:Jfe,zeros:Wfe},Symbol.toStringTag,{value:"Module"}));let RE=class P1{constructor(e,r,i){this._itemByteSize=e,this._itemCreate=r,this._buffers=new Array,this._items=new Array,this._itemsPtr=0,this._itemsPerBuffer=Math.ceil(i/this._itemByteSize)}get(){this._itemsPtr===0&&_S(()=>this._reset());const e=Math.floor(this._itemsPtr/this._itemsPerBuffer);for(;this._buffers.length<=e;){const r=new ArrayBuffer(this._itemsPerBuffer*this._itemByteSize);for(let i=0;i<this._itemsPerBuffer;++i)this._items.push(this._itemCreate(r,i*this._itemByteSize));this._buffers.push(r)}return this._items[this._itemsPtr++]}_reset(){const e=2*(Math.floor(this._itemsPtr/this._itemsPerBuffer)+1);for(;this._buffers.length>e;)this._buffers.pop(),this._items.length=this._buffers.length*this._itemsPerBuffer;this._itemsPtr=0}static createVec2f64(e=ax){return new P1(16,Vfe,e)}static createVec3f64(e=ax){return new P1(24,Rq,e)}static createVec4f64(e=ax){return new P1(32,qfe,e)}static createMat3f64(e=ax){return new P1(72,Ffe,e)}static createMat4f64(e=ax){return new P1(128,Ofe,e)}static createQuatf64(e=ax){return new P1(32,Ufe,e)}get test(){return{size:this._buffers.length*this._itemsPerBuffer*this._itemByteSize}}};const ax=4*US.KILOBYTES,lTt=RE.createVec2f64(),je=RE.createVec3f64(),AW=RE.createVec4f64();RE.createMat3f64();const RW=RE.createMat4f64(),cTt=RE.createQuatf64();function xp(t){return t?{origin:ms(t.origin),vector:ms(t.vector)}:{origin:M(),vector:M()}}function VDe(t,e){const r=zDe.get();return r.origin=t,r.vector=e,r}function uTt(t,e=xp()){return BDe(t.origin,t.vector,e)}function BDe(t,e,r=xp()){return le(r.origin,t),le(r.vector,e),r}function Yb(t,e,r=xp()){return le(r.origin,t),me(r.vector,e,t),r}function OW(t,e){const r=me(je.get(),e,t.origin),i=ye(t.vector,r),s=ye(t.vector,t.vector),n=ge(i/s,0,1),o=me(je.get(),ae(je.get(),t.vector,n),r);return ye(o,o)}function hTt(t,e,r){return QB(t,e,0,1,r)}function dTt(t,e,r){return fe(r,t.origin,ae(r,t.vector,e))}function QB(t,e,r,i,s){const{vector:n,origin:o}=t,a=me(je.get(),e,o),l=ye(n,a)/ua(n);return ae(s,n,ge(l,r,i)),fe(s,s,t.origin)}function pTt(t,e){if(eme(t,VDe(e.origin,e.direction),!1,bN)){const{tA:r,pB:i,distance2:s}=bN;if(r>=0&&r<=1)return s;if(r<0)return Ro(t.origin,i);if(r>1)return Ro(fe(je.get(),t.origin,t.vector),i)}return null}function Qfe(t,e,r){return!!eme(t,e,!0,bN)&&(le(r,bN.pA),!0)}function eme(t,e,r,i){const n=t.origin,o=fe(je.get(),n,t.vector),a=e.origin,l=fe(je.get(),a,e.vector),c=je.get(),h=je.get();if(c[0]=n[0]-a[0],c[1]=n[1]-a[1],c[2]=n[2]-a[2],h[0]=l[0]-a[0],h[1]=l[1]-a[1],h[2]=l[2]-a[2],Math.abs(h[0])<1e-6&&Math.abs(h[1])<1e-6&&Math.abs(h[2])<1e-6)return!1;const p=je.get();if(p[0]=o[0]-n[0],p[1]=o[1]-n[1],p[2]=o[2]-n[2],Math.abs(p[0])<1e-6&&Math.abs(p[1])<1e-6&&Math.abs(p[2])<1e-6)return!1;const f=c[0]*h[0]+c[1]*h[1]+c[2]*h[2],m=h[0]*p[0]+h[1]*p[1]+h[2]*p[2],y=c[0]*p[0]+c[1]*p[1]+c[2]*p[2],_=h[0]*h[0]+h[1]*h[1]+h[2]*h[2],b=(p[0]*p[0]+p[1]*p[1]+p[2]*p[2])*_-m*m;if(Math.abs(b)<1e-6)return!1;let x=(f*m-y*_)/b,T=(f+m*x)/_;r&&(x=ge(x,0,1),T=ge(T,0,1));const S=je.get(),E=je.get();return S[0]=n[0]+x*p[0],S[1]=n[1]+x*p[1],S[2]=n[2]+x*p[2],E[0]=a[0]+T*h[0],E[1]=a[1]+T*h[1],E[2]=a[2]+T*h[2],i.tA=x,i.tB=T,i.pA=S,i.pB=E,i.distance2=Ro(S,E),!0}const bN={tA:0,tB:0,pA:M(),pB:M(),distance2:0},zDe=new cy(()=>xp());function ro(t){return t?dQ(ms(t.origin),ms(t.direction)):dQ(M(),M())}function dQ(t,e){return{origin:t,direction:e}}function fTt(t,e){return Xg(t.origin,e.origin)&&Xg(t.direction,e.direction)}function Du(t,e){const r=qDe.get();return r.origin=t,r.direction=e,r}function wN(t,e=ro()){return tme(t.origin,t.direction,e)}function GDe(t,e,r=ro()){return le(r.origin,t),me(r.direction,e,t),r}function tme(t,e,r=ro()){return le(r.origin,t),le(r.direction,e),r}function jDe(t,e){const r=pt(je.get(),_e(je.get(),t.direction),me(je.get(),e,t.origin));return ye(r,r)}function HDe(t,e,r){const i=ye(t.direction,me(r,e,t.origin));return fe(r,t.origin,ae(r,t.direction,i)),r}const qDe=new cy(()=>ro());function Y3(t,e){return ye(t,e)/Me(t)}function MW(t,e){const r=ye(t,e)/(Me(t)*Me(e));return-Sn(r)}function rme(t,e,r){_e(dP,t),_e(J6,e);const i=ye(dP,J6),s=Sn(i),n=pt(dP,dP,J6);return ye(n,r)<0?2*Math.PI-s:s}const dP=M(),J6=M();function on(){return sr()}function kS(t,e=on()){return Xd(e,t)}function ime(t,e){return Ht(t[0],t[1],t[2],e)}function WDe(t){return t}function sme(t){t[0]=t[1]=t[2]=t[3]=0}function U4(t,e){return t[0]=t[1]=t[2]=0,t[3]=e,t}function Fg(t){return t[3]}function XDe(t){return t}function nme(t,e,r,i){return Ht(t,e,r,i)}function YDe(t,e,r){return t!==r&&le(r,t),r[3]=t[3]+e,r}function ZDe(t,e,r){return se.getLogger("esri.geometry.support.sphere").error("sphere.setExtent is not yet supported"),t===r?r:kS(t,r)}function _v(t,e,r){if(C(e))return!1;const{origin:i,direction:s}=e,n=JDe;n[0]=i[0]-t[0],n[1]=i[1]-t[1],n[2]=i[2]-t[2];const o=s[0]*s[0]+s[1]*s[1]+s[2]*s[2];if(o===0)return!1;const a=2*(s[0]*n[0]+s[1]*n[1]+s[2]*n[2]),l=a*a-4*o*(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]-t[3]*t[3]);if(l<0)return!1;const c=Math.sqrt(l);let h=(-a-c)/(2*o);const p=(-a+c)/(2*o);return(h<0||p<h&&p>0)&&(h=p),!(h<0)&&(r&&(r[0]=i[0]+s[0]*h,r[1]=i[1]+s[1]*h,r[2]=i[2]+s[2]*h),!0)}const JDe=M();function ez(t,e){return _v(t,e,null)}function KDe(t,e,r){if(_v(t,e,r))return r;const i=OE(t,e,je.get());return fe(r,e.origin,ae(je.get(),e.direction,xi(e.origin,i)/Me(e.direction))),r}function OE(t,e,r){const i=je.get(),s=RW.get();pt(i,e.origin,e.direction);const n=Fg(t);pt(r,i,e.origin),ae(r,r,1/Me(r)*n);const o=lme(t,e.origin),a=MW(e.origin,r);return $u(s,a+o,i),We(r,r,s),r}function QDe(t,e,r){return _v(t,e,r)?r:(HDe(e,t,r),ome(t,r,r))}function ome(t,e,r){const i=me(je.get(),e,t),s=ae(je.get(),i,t[3]/Me(i));return fe(r,s,t)}function ame(t,e){const r=me(je.get(),e,t),i=ua(r),s=t[3]*t[3];return Math.sqrt(Math.abs(i-s))}function lme(t,e){const r=me(je.get(),e,t),i=Me(r),s=Fg(t),n=s+Math.abs(s-i);return Sn(s/n)}const K6=M();function cme(t,e,r,i){const s=me(K6,e,t);switch(r){case Oc.X:{const n=AK(s,K6)[2];return ce(i,-Math.sin(n),Math.cos(n),0)}case Oc.Y:{const n=AK(s,K6),o=n[1],a=n[2],l=Math.sin(o);return ce(i,-l*Math.cos(a),-l*Math.sin(a),Math.cos(o))}case Oc.Z:return _e(i,s);default:return}}function ume(t,e){const r=me(tz,e,t);return Me(r)-t[3]}function eNe(t,e,r,i){const s=ume(t,e),n=cme(t,e,Oc.Z,tz),o=ae(tz,n,r-s);return fe(i,e,o)}function tNe(t,e){const r=Ro(t,e),i=Fg(t);return r<=i*i}const tz=M(),k4=on(),rNe=Object.freeze(Object.defineProperty({__proto__:null,altitudeAt:ume,angleToSilhouette:lme,axisAt:cme,clear:sme,closestPoint:QDe,closestPointOnSilhouette:OE,containsPoint:tNe,copy:kS,create:on,distanceToSilhouette:ame,elevate:YDe,fromCenterAndRadius:ime,fromRadius:U4,fromValues:nme,getCenter:XDe,getRadius:Fg,intersectRay:_v,intersectRayClosestSilhouette:KDe,intersectsRay:ez,projectPoint:ome,setAltitudeAt:eNe,setExtent:ZDe,tmpSphere:k4,wrap:WDe},Symbol.toStringTag,{value:"Module"}));function bw(t){const e=t[0]*t[0]+t[4]*t[4]+t[8]*t[8],r=t[1]*t[1]+t[5]*t[5]+t[9]*t[9],i=t[2]*t[2]+t[6]*t[6]+t[10]*t[10];return Math.sqrt(Math.max(e,r,i))}function iNe(t,e){const r=Math.sqrt(e[0]*e[0]+e[4]*e[4]+e[8]*e[8]),i=Math.sqrt(e[1]*e[1]+e[5]*e[5]+e[9]*e[9]),s=Math.sqrt(e[2]*e[2]+e[6]*e[6]+e[10]*e[10]);return ce(t,r,i,s),t}function mTt(t,e,r){r=r||t;const i=ye(t,e);ce(r,t[0]-i*e[0],t[1]-i*e[1],t[2]-i*e[2]),_e(r,r)}function gTt(t,e,r){Math.abs(t[0])>Math.abs(t[1])?ce(e,0,1,0):ce(e,1,0,0),pt(r,t,e),_e(e,e),pt(e,r,t),_e(r,r)}function pP(t,e,r,i,s,n){const o=t+(e-t)*s;return o+(r+(i-r)*s-o)*n}function sNe(t,e,r,i=M()){const s=Me(t),n=Me(e),o=ye(t,e)/(s*n);if(o<.9999999999999999){const a=Math.acos(o),l=((1-r)*s+r*n)/Math.sin(a),c=l/s*Math.sin((1-r)*a),h=l/n*Math.sin(r*a);return ae(Lb,t,c),ae(Db,e,h),fe(i,Lb,Db)}return Ys(i,t,e,r)}function yTt(t,e,r,i=M(),s=M()){const n=Me(t),o=Me(e),a=ye(t,e)/(n*o);if(a<.9999999999999999){const l=Math.acos(a),c=Math.sin(l),h=Math.sin(r*l),p=Math.sin((1-r)*l),f=(1-r)*n+r*o;{const m=f/c,y=m/o*h;ae(Lb,t,m/n*p),ae(Db,e,y),fe(i,Lb,Db)}{const m=1/n*(-Math.cos((1-r)*l)*l*f+p*(-n+o));ae(Lb,t,m);const y=1/o*(Math.cos(r*l)*l*f+h*(-n+o));ae(Db,e,y),fe(s,Lb,Db),ae(s,s,1/c)}return s}return Ys(i,t,e,r),me(s,e,t),_e(s,s),s}function _L(t,e,r){t=_e(Lb,t),e=_e(Db,e);const i=Sn(ye(t,e));if(r){const s=pt(nNe,t,e);if(ye(s,r)<0)return-i}return i}function vL(t){const e=t.length;return r=>{if(r<=t[0][0])return t[0][1];if(r>=t[e-1][0])return t[e-1][1];let i=1;for(;r>t[i][0];)i++;const s=t[i-1][0],n=t[i][0],o=(n-r)/(n-s);return o*t[i-1][1]+(1-o)*t[i][1]}}function _Tt(t,e,r,i){me(pQ,e,t),me(fQ,r,t),pt(i,pQ,fQ),_e(i,i),i[3]=-ye(t,i)}const pQ=M(),fQ=M(),nNe=M(),Lb=M(),Db=M();function zr(t=DA){return[t[0],t[1],t[2],t[3]]}function oNe(t=DA[0],e=DA[1],r=DA[2],i=DA[3]){return PW(t,e,r,i,AW.get())}function V4(t,e){return PW(e[0],e[1],e[2],e[3],t)}function PW(t,e,r,i,s=zr()){return s[0]=t,s[1]=e,s[2]=r,s[3]=i,s}function hme(t,e,r){return le(r,t),r[3]=e,r}function lM(t,e,r){const i=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],s=Math.abs(i-1)>1e-5&&i>1e-12?1/Math.sqrt(i):1;return r[0]=e[0]*s,r[1]=e[1]*s,r[2]=e[2]*s,r[3]=-(r[0]*t[0]+r[1]*t[1]+r[2]*t[2]),r}function la(t,e,r,i=zr()){const s=r[0]-e[0],n=r[1]-e[1],o=r[2]-e[2],a=t[0]-e[0],l=t[1]-e[1],c=t[2]-e[2],h=n*c-o*l,p=o*a-s*c,f=s*l-n*a,m=h*h+p*p+f*f,y=Math.abs(m-1)>1e-5&&m>1e-12?1/Math.sqrt(m):1;return i[0]=h*y,i[1]=p*y,i[2]=f*y,i[3]=-(i[0]*t[0]+i[1]*t[1]+i[2]*t[2]),i}function dme(t,e,r,i,s){const n=t.length/3;if(n<3)return!1;ce(aC,t[3*r],t[3*r+1],t[3*r+2]);let o=i,a=!1;for(;o<n-1&&!a;){const l=3*o;ce(lx,t[l],t[l+1],t[l+2]),o++,a=!Ya(aC,lx)}if(!a)return!1;for(o=Math.max(o,s),a=!1;o<n&&!a;){const l=3*o;ce(_b,t[l],t[l+1],t[l+2]),o++,me(fP,aC,lx),_e(fP,fP),me(mP,lx,_b),_e(mP,mP),a=!Ya(aC,_b)&&!Ya(lx,_b)&&Math.abs(ye(fP,mP))<aNe}return a?(la(aC,lx,_b,e),!0):(r!==0||i!==1||s!==2)&&dme(t,e,0,1,2)}const aNe=.99619469809,aC=M(),lx=M(),_b=M(),fP=M(),mP=M();function rz(t,e,r){return e!==t&&V4(t,e),t[3]=-ye(t,r),t}function iz(t,e){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e}function KR(t,e,r,i){return pt(_b,e,t),lM(r,_b,i)}function vTt(t,e,r,i){return B4(t,e,me(je.get(),r,e),pNe,i)}function Zw(t,e,r){return!!v(e)&&B4(t,e.origin,e.direction,fNe,r)}function lNe(t,e,r){return B4(t,e.origin,e.vector,Wf.NONE,r)}function cNe(t,e,r){return B4(t,e.origin,e.vector,Wf.CLAMP,r)}function pme(t,e){return bi(t,e)>=0}function uNe(t,e){const r=ye(t,e.ray.direction),i=-bi(t,e.ray.origin);if(i<0&&r>=0)return!1;if(r>-1e-6&&r<1e-6)return i>0;if((i<0||r<0)&&!(i<0&&r<0))return!0;const s=i/r;return r>0?s<e.c1&&(e.c1=s):s>e.c0&&(e.c0=s),e.c0<=e.c1}function hNe(t,e){const r=ye(t,e.ray.direction),i=-bi(t,e.ray.origin);if(r>-1e-6&&r<1e-6)return i>0;const s=i/r;return r>0?s<e.c1&&(e.c1=s):s>e.c0&&(e.c0=s),e.c0<=e.c1}function dNe(t,e,r){const i=ae(je.get(),t,-t[3]),s=sz(t,me(je.get(),e,i),je.get());return fe(r,s,i),r}function sz(t,e,r){const i=ae(je.get(),t,ye(t,e));return me(r,e,i),r}function bi(t,e){return ye(t,e)+t[3]}function B4(t,e,r,i,s){const n=ye(t,r);if(n===0)return!1;let o=-(ye(t,e)+t[3])/n;return i&Wf.CLAMP&&(o=ge(o,0,1)),!(!(i&Wf.INFINITE_MIN)&&o<0||!(i&Wf.INFINITE_MAX)&&o>1)&&(fe(s,e,ae(s,r,o)),!0)}function bTt(t){return t}const DA=[0,0,1,0];var Wf;(function(t){t[t.NONE=0]="NONE",t[t.CLAMP=1]="CLAMP",t[t.INFINITE_MIN=4]="INFINITE_MIN",t[t.INFINITE_MAX=8]="INFINITE_MAX"})(Wf||(Wf={}));const pNe=Wf.INFINITE_MIN|Wf.INFINITE_MAX,fNe=Wf.INFINITE_MAX,Q6=se.getLogger("esri.views.3d.support.geometryUtils.boundedPlane");let mNe=class{constructor(){this.plane=zr(),this.origin=M(),this.basis1=M(),this.basis2=M()}};const fme=mNe;function uy(t=Eme){return{plane:zr(t.plane),origin:ms(t.origin),basis1:ms(t.basis1),basis2:ms(t.basis2)}}function gNe(t,e,r){const i=RNe.get();return i.origin=t,i.basis1=e,i.basis2=r,i.plane=oNe(0,0,0,0),z4(i),i}function Jw(t,e=uy()){return IW(t.origin,t.basis1,t.basis2,e)}function yNe(t,e){le(e.origin,t.origin),le(e.basis1,t.basis1),le(e.basis2,t.basis2),V4(e.plane,t.plane)}function IW(t,e,r,i=uy()){return le(i.origin,t),le(i.basis1,e),le(i.basis2,r),z4(i),CNe(i,"fromValues()"),i}function z4(t){KR(t.basis2,t.basis1,t.origin,t.plane)}function mme(t,e,r){t!==r&&Jw(t,r);const i=ae(je.get(),Qg(t),e);return fe(r.origin,r.origin,i),r.plane[3]-=e,r}function _Ne(t,e,r){return gme(e,r),mme(r,NW(t,t.origin),r),r}function gme(t,e=uy()){const r=(t[2]-t[0])/2,i=(t[3]-t[1])/2;return ce(e.origin,t[0]+r,t[1]+i,0),ce(e.basis1,r,0,0),ce(e.basis2,0,i,0),PW(0,0,1,0,e.plane),e}function $W(t,e,r){return!!Zw(t.plane,e,r)&&Tme(t,r)}function vNe(t,e,r){if($W(t,e,r))return r;const i=yme(t,e,je.get());return fe(r,e.origin,ae(je.get(),e.direction,xi(e.origin,i)/Me(e.direction))),r}function yme(t,e,r){const i=xN.get();Sme(t,e,i,xN.get());let s=Number.POSITIVE_INFINITY;for(const n of UW){const o=FW(t,n,G4.get()),a=je.get();if(lNe(i,o,a)){const l=ay(je.get(),e.origin,a),c=Math.abs(Sn(ye(e.direction,l)));c<s&&(s=c,le(r,a))}}return s===Number.POSITIVE_INFINITY?_me(t,e,r):r}function _me(t,e,r){if($W(t,e,r))return r;const i=xN.get(),s=xN.get();Sme(t,e,i,s);let n=Number.POSITIVE_INFINITY;for(const o of UW){const a=FW(t,o,G4.get()),l=je.get();if(cNe(i,a,l)){const c=jDe(e,l);if(!pme(s,l))continue;c<n&&(n=c,le(r,l))}}return LW(t,e.origin)<n&&vme(t,e.origin,r),r}function vme(t,e,r){const i=dNe(t.plane,e,je.get()),s=QB(mQ(t,t.basis1),i,-1,1,je.get()),n=QB(mQ(t,t.basis2),i,-1,1,je.get());return me(r,fe(je.get(),s,n),t.origin),r}function bme(t,e,r){const{origin:i,basis1:s,basis2:n}=t,o=me(je.get(),e,i),a=Y3(s,o),l=Y3(n,o),c=Y3(Qg(t),o);return ce(r,a,l,c)}function LW(t,e){const r=bme(t,e,je.get()),{basis1:i,basis2:s}=t,n=Me(i),o=Me(s),a=Math.max(Math.abs(r[0])-n,0),l=Math.max(Math.abs(r[1])-o,0),c=r[2];return a*a+l*l+c*c}function bNe(t,e){return Math.sqrt(LW(t,e))}function wNe(t,e){let r=Number.NEGATIVE_INFINITY;for(const i of UW){const s=FW(t,i,G4.get()),n=OW(s,e);n>r&&(r=n)}return Math.sqrt(r)}function DW(t,e){return pme(t.plane,e)&&Tme(t,e)}function xNe(t,e,r,i){return ENe(t,r,i)}function NW(t,e){const r=-t.plane[3];return Y3(Qg(t),e)-r}function TNe(t,e,r,i){const s=NW(t,e),n=ae(ANe,Qg(t),r-s);return fe(i,e,n),i}function wme(t,e){return Ya(t.basis1,e.basis1)&&Ya(t.basis2,e.basis2)&&Ya(t.origin,e.origin)}function xme(t,e,r){return t!==r&&Jw(t,r),Oo(cx,e),Dc(cx,cx),We(r.basis1,t.basis1,cx),We(r.basis2,t.basis2,cx),We(r.plane,t.plane,cx),We(r.origin,t.origin,e),rz(r.plane,r.plane,r.origin),r}function SNe(t,e,r,i){return t!==i&&Jw(t,i),$u(eU,e,r),We(i.basis1,t.basis1,eU),We(i.basis2,t.basis2,eU),z4(i),i}function Qg(t){return t.plane}function ENe(t,e,r){switch(e){case Oc.X:le(r,t.basis1),_e(r,r);break;case Oc.Y:le(r,t.basis2),_e(r,r);break;case Oc.Z:le(r,Qg(t))}return r}function Tme(t,e){const r=me(je.get(),e,t.origin),i=ua(t.basis1),s=ua(t.basis2),n=ye(t.basis1,r),o=ye(t.basis2,r);return-n-i<0&&n-i<0&&-o-s<0&&o-s<0}function mQ(t,e){const r=G4.get();return le(r.origin,t.origin),le(r.vector,e),r}function FW(t,e,r){const{basis1:i,basis2:s,origin:n}=t,o=ae(je.get(),i,e.origin[0]),a=ae(je.get(),s,e.origin[1]);fe(r.origin,o,a),fe(r.origin,r.origin,n);const l=ae(je.get(),i,e.direction[0]),c=ae(je.get(),s,e.direction[1]);return ae(r.vector,fe(l,l,c),2),r}function CNe(t,e){Math.abs(ye(t.basis1,t.basis2)/(Me(t.basis1)*Me(t.basis2)))>1e-6&&Q6.warn(e,"Provided basis vectors are not perpendicular"),Math.abs(ye(t.basis1,Qg(t)))>1e-6&&Q6.warn(e,"Basis vectors and plane normal are not perpendicular"),Math.abs(-ye(Qg(t),t.origin)-t.plane[3])>1e-6&&Q6.warn(e,"Plane offset is not consistent with plane origin")}function Sme(t,e,r,i){const s=Qg(t);KR(s,e.direction,e.origin,r),KR(r,s,e.origin,i)}const Eme={plane:zr(),origin:$e(0,0,0),basis1:$e(1,0,0),basis2:$e(0,1,0)},xN=new cy(zr),G4=new cy(xp),ANe=M(),RNe=new cy(()=>uy()),UW=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],cx=Ie(),eU=Ie(),ONe=Object.freeze(Object.defineProperty({__proto__:null,BoundedPlaneClass:fme,UP:Eme,altitudeAt:NW,axisAt:xNe,closestPoint:_me,closestPointOnSilhouette:yme,copy:Jw,copyWithoutVerify:yNe,create:uy,distance:bNe,distance2:LW,distanceToSilhouette:wNe,elevate:mme,equals:wme,extrusionContainsPoint:DW,fromAABoundingRect:gme,fromValues:IW,intersectRay:$W,intersectRayClosestSilhouette:vNe,normal:Qg,projectPoint:vme,projectPointLocal:bme,rotate:SNe,setAltitudeAt:TNe,setExtent:_Ne,transform:xme,updateUnboundedPlane:z4,wrap:gNe},Symbol.toStringTag,{value:"Module"})),MNe=new et(dhe),gQ=new et(vq),yQ=new et(bq),xTt=new et(phe);function j4(t){return t&&(fm(t)||Tn(t,gQ))?gQ:t&&(mm(t)||Tn(t,yQ))?yQ:MNe}function PNe(t){const{value:e,operations:r}=t;return{operations:r,value:r.create(e)}}function INe(t,e,r){return t.operations.setExtent(t.value,e,r.value),r}function $Ne(t){return{operations:t,value:t.create()}}function Cme(t,e,r=$Ne(t)){return r.operations=t,t.copy(e,r.value),r}function LNe(t){return Cme(rNe,nme(0,0,0,Jr(t).radius))}const _Q=2**50;function DNe(){return Cme(ONe,IW([0,0,0],[_Q,0,0],[0,_Q,0]))}function NNe(t,e,r){return t.operations.axisAt(t.value,e,Oc.Z,r)}function FNe(t,e,r,i){return t.operations.axisAt(t.value,e,r,i)}function UNe(t,e,r){return t.operations.intersectRay(t.value,e,r)}function kNe(t,e,r){return t.operations.intersectRayClosestSilhouette(t.value,e,r)}function VNe(t,e){return t.operations.altitudeAt(t.value,e)}function Ame(t,e,r,i){return t.operations.setAltitudeAt(t.value,e,r,i)}function BNe(t,e,r,i){return e!==i&&Fn(i,e),ce(ux,i[12],i[13],i[14]),Ame(t,ux,r,ux),i[12]=ux[0],i[13]=ux[1],i[14]=ux[2],i}function tU(t,e,r){return t.operations.elevate(t.value,e,r.value)}const ux=M();function vQ(t,e,r,i,s){return s[0]=ye(t,e),s[1]=ye(t,r),s[2]=ye(t,i),s}function nz(t,e,r,i,s){le(r,t),le(gP,e),_e(gP,gP),pt(i,gP,r),pt(s,i,r)}function Rme(t,e){return t?j4(e):e.isGeographic?et.PlateCarree:e}const gP=M(),kW=96;function TTt(t,e){const r=e||t.extent,i=t.width,s=nl(r&&r.spatialReference);return r&&i?r.width/i*s*wq*kW:0}function zNe(t,e){return t/(nl(e)*wq*kW)}function GNe(t){return t/(wq*kW)}const Ome="OBJECTID";let VS=class extends q3{constructor(e){super(e),this.handles.add(this.on("before-add",r=>{C(r.item)||r.item.parent===this.owner&&(se.getLogger(this.declaredClass).warn("Analysis inside the collection must be unique. Not adding this element again."),r.preventDefault())}))}_own(e){e.parent=this.owner}_release(e){e.parent=null}};VS=u([I("esri.support.AnalysesCollection")],VS);const bL={widthBreakpoint:{getValue(t){const e=t.viewSize[0],r=t.breakpoints,i=this.values;return e<=r.xsmall?i.xsmall:e<=r.small?i.small:e<=r.medium?i.medium:e<=r.large?i.large:i.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-width-xsmall esri-view-width-less-than-small esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",small:"esri-view-width-small esri-view-width-greater-than-xsmall esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",medium:"esri-view-width-medium esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-less-than-large esri-view-width-less-than-xlarge",large:"esri-view-width-large esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-less-than-xlarge",xlarge:"esri-view-width-xlarge esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-greater-than-large"}},heightBreakpoint:{getValue(t){const e=t.viewSize[1],r=t.breakpoints,i=this.values;return e<=r.xsmall?i.xsmall:e<=r.small?i.small:e<=r.medium?i.medium:e<=r.large?i.large:i.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-height-xsmall esri-view-height-less-than-small esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",small:"esri-view-height-small esri-view-height-greater-than-xsmall esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",medium:"esri-view-height-medium esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-less-than-large esri-view-height-less-than-xlarge",large:"esri-view-height-large esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-less-than-xlarge",xlarge:"esri-view-height-xlarge esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-greater-than-large"}},orientation:{getValue(t){const e=t.viewSize,r=e[0],i=e[1],s=this.values;return i>=r?s.portrait:s.landscape},values:{portrait:"portrait",landscape:"landscape"},valueToClassName:{portrait:"esri-view-orientation-portrait",landscape:"esri-view-orientation-landscape"}}},rU={xsmall:544,small:768,medium:992,large:1200};function jNe(t){const e=t;return e&&e.xsmall<e.small&&e.small<e.medium&&e.medium<e.large}function iU(t,e){return e?bL[t].valueToClassName[e].split(" "):[]}const HNe=t=>{let e=class extends t{constructor(...r){super(...r),this._breakpointsHandles=new ei,this.orientation=null,this.widthBreakpoint=null,this.heightBreakpoint=null,this.breakpoints=rU}initialize(){this._breakpointsHandles.add(ie(()=>[this.breakpoints,this.size],()=>this._updateClassNames(),Vt))}destroy(){this.destroyed||(this._removeActiveClassNames(),this._breakpointsHandles=ke(this._breakpointsHandles))}set breakpoints(r){if(r===this._get("breakpoints"))return;const i=jNe(r);if(!i){const s=JSON.stringify(rU,null,2);console.warn("provided breakpoints are not valid, using defaults:"+s)}r=i?r:rU,this._set("breakpoints",{...r})}_updateClassNames(){if(!this.container)return;const r=wc.acquire(),i=wc.acquire();let s,n=!1;for(s in bL){const o=this[s],a=bL[s].getValue({viewSize:this.size,breakpoints:this.breakpoints});o!==a&&(n=!0,this[s]=a,iU(s,o).forEach(l=>i.push(l)),iU(s,a).forEach(l=>r.push(l)))}n&&(this._applyClassNameChanges(r,i),wc.release(r),wc.release(i))}_applyClassNameChanges(r,i){const s=this.container;s&&(i.forEach(n=>s.classList.remove(n)),r.forEach(n=>s.classList.add(n)))}_removeActiveClassNames(){const r=this.container;if(!r)return;let i;for(i in bL)iU(i,this[i]).forEach(s=>r.classList.remove(s))}};return u([d()],e.prototype,"breakpoints",null),u([d()],e.prototype,"orientation",void 0),u([d()],e.prototype,"widthBreakpoint",void 0),u([d()],e.prototype,"heightBreakpoint",void 0),e=u([I("esri.views.BreakpointsOwner")],e),e};/*!
 * @esri/arcgis-html-sanitizer - v3.0.1 - Tue Nov 15 2022 09:46:54 GMT-0800 (Pacific Standard Time)
 * Copyright (c) 2022 - Environmental Systems Research Institute, Inc.
 * Apache-2.0
 * 
 * js-xss
 * Copyright (c) 2012-2018 Zongmin Lei(雷宗民) <leizongmin@gmail.com>
 * http://ucdok.com
 * MIT License, see https://github.com/leizongmin/js-xss/blob/master/LICENSE for details
 */var qNe=function(t){if(typeof t!="object"||t===null||Object.prototype.toString.call(t)!=="[object Object]")return!1;var e=Object.getPrototypeOf(t);if(e===null)return!0;for(;Object.getPrototypeOf(e)!==null;)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(t)===e},vb={exports:{}},an={},QR={exports:{}},Kw={};function Mme(){var t={};return t["align-content"]=!1,t["align-items"]=!1,t["align-self"]=!1,t["alignment-adjust"]=!1,t["alignment-baseline"]=!1,t.all=!1,t["anchor-point"]=!1,t.animation=!1,t["animation-delay"]=!1,t["animation-direction"]=!1,t["animation-duration"]=!1,t["animation-fill-mode"]=!1,t["animation-iteration-count"]=!1,t["animation-name"]=!1,t["animation-play-state"]=!1,t["animation-timing-function"]=!1,t.azimuth=!1,t["backface-visibility"]=!1,t.background=!0,t["background-attachment"]=!0,t["background-clip"]=!0,t["background-color"]=!0,t["background-image"]=!0,t["background-origin"]=!0,t["background-position"]=!0,t["background-repeat"]=!0,t["background-size"]=!0,t["baseline-shift"]=!1,t.binding=!1,t.bleed=!1,t["bookmark-label"]=!1,t["bookmark-level"]=!1,t["bookmark-state"]=!1,t.border=!0,t["border-bottom"]=!0,t["border-bottom-color"]=!0,t["border-bottom-left-radius"]=!0,t["border-bottom-right-radius"]=!0,t["border-bottom-style"]=!0,t["border-bottom-width"]=!0,t["border-collapse"]=!0,t["border-color"]=!0,t["border-image"]=!0,t["border-image-outset"]=!0,t["border-image-repeat"]=!0,t["border-image-slice"]=!0,t["border-image-source"]=!0,t["border-image-width"]=!0,t["border-left"]=!0,t["border-left-color"]=!0,t["border-left-style"]=!0,t["border-left-width"]=!0,t["border-radius"]=!0,t["border-right"]=!0,t["border-right-color"]=!0,t["border-right-style"]=!0,t["border-right-width"]=!0,t["border-spacing"]=!0,t["border-style"]=!0,t["border-top"]=!0,t["border-top-color"]=!0,t["border-top-left-radius"]=!0,t["border-top-right-radius"]=!0,t["border-top-style"]=!0,t["border-top-width"]=!0,t["border-width"]=!0,t.bottom=!1,t["box-decoration-break"]=!0,t["box-shadow"]=!0,t["box-sizing"]=!0,t["box-snap"]=!0,t["box-suppress"]=!0,t["break-after"]=!0,t["break-before"]=!0,t["break-inside"]=!0,t["caption-side"]=!1,t.chains=!1,t.clear=!0,t.clip=!1,t["clip-path"]=!1,t["clip-rule"]=!1,t.color=!0,t["color-interpolation-filters"]=!0,t["column-count"]=!1,t["column-fill"]=!1,t["column-gap"]=!1,t["column-rule"]=!1,t["column-rule-color"]=!1,t["column-rule-style"]=!1,t["column-rule-width"]=!1,t["column-span"]=!1,t["column-width"]=!1,t.columns=!1,t.contain=!1,t.content=!1,t["counter-increment"]=!1,t["counter-reset"]=!1,t["counter-set"]=!1,t.crop=!1,t.cue=!1,t["cue-after"]=!1,t["cue-before"]=!1,t.cursor=!1,t.direction=!1,t.display=!0,t["display-inside"]=!0,t["display-list"]=!0,t["display-outside"]=!0,t["dominant-baseline"]=!1,t.elevation=!1,t["empty-cells"]=!1,t.filter=!1,t.flex=!1,t["flex-basis"]=!1,t["flex-direction"]=!1,t["flex-flow"]=!1,t["flex-grow"]=!1,t["flex-shrink"]=!1,t["flex-wrap"]=!1,t.float=!1,t["float-offset"]=!1,t["flood-color"]=!1,t["flood-opacity"]=!1,t["flow-from"]=!1,t["flow-into"]=!1,t.font=!0,t["font-family"]=!0,t["font-feature-settings"]=!0,t["font-kerning"]=!0,t["font-language-override"]=!0,t["font-size"]=!0,t["font-size-adjust"]=!0,t["font-stretch"]=!0,t["font-style"]=!0,t["font-synthesis"]=!0,t["font-variant"]=!0,t["font-variant-alternates"]=!0,t["font-variant-caps"]=!0,t["font-variant-east-asian"]=!0,t["font-variant-ligatures"]=!0,t["font-variant-numeric"]=!0,t["font-variant-position"]=!0,t["font-weight"]=!0,t.grid=!1,t["grid-area"]=!1,t["grid-auto-columns"]=!1,t["grid-auto-flow"]=!1,t["grid-auto-rows"]=!1,t["grid-column"]=!1,t["grid-column-end"]=!1,t["grid-column-start"]=!1,t["grid-row"]=!1,t["grid-row-end"]=!1,t["grid-row-start"]=!1,t["grid-template"]=!1,t["grid-template-areas"]=!1,t["grid-template-columns"]=!1,t["grid-template-rows"]=!1,t["hanging-punctuation"]=!1,t.height=!0,t.hyphens=!1,t.icon=!1,t["image-orientation"]=!1,t["image-resolution"]=!1,t["ime-mode"]=!1,t["initial-letters"]=!1,t["inline-box-align"]=!1,t["justify-content"]=!1,t["justify-items"]=!1,t["justify-self"]=!1,t.left=!1,t["letter-spacing"]=!0,t["lighting-color"]=!0,t["line-box-contain"]=!1,t["line-break"]=!1,t["line-grid"]=!1,t["line-height"]=!1,t["line-snap"]=!1,t["line-stacking"]=!1,t["line-stacking-ruby"]=!1,t["line-stacking-shift"]=!1,t["line-stacking-strategy"]=!1,t["list-style"]=!0,t["list-style-image"]=!0,t["list-style-position"]=!0,t["list-style-type"]=!0,t.margin=!0,t["margin-bottom"]=!0,t["margin-left"]=!0,t["margin-right"]=!0,t["margin-top"]=!0,t["marker-offset"]=!1,t["marker-side"]=!1,t.marks=!1,t.mask=!1,t["mask-box"]=!1,t["mask-box-outset"]=!1,t["mask-box-repeat"]=!1,t["mask-box-slice"]=!1,t["mask-box-source"]=!1,t["mask-box-width"]=!1,t["mask-clip"]=!1,t["mask-image"]=!1,t["mask-origin"]=!1,t["mask-position"]=!1,t["mask-repeat"]=!1,t["mask-size"]=!1,t["mask-source-type"]=!1,t["mask-type"]=!1,t["max-height"]=!0,t["max-lines"]=!1,t["max-width"]=!0,t["min-height"]=!0,t["min-width"]=!0,t["move-to"]=!1,t["nav-down"]=!1,t["nav-index"]=!1,t["nav-left"]=!1,t["nav-right"]=!1,t["nav-up"]=!1,t["object-fit"]=!1,t["object-position"]=!1,t.opacity=!1,t.order=!1,t.orphans=!1,t.outline=!1,t["outline-color"]=!1,t["outline-offset"]=!1,t["outline-style"]=!1,t["outline-width"]=!1,t.overflow=!1,t["overflow-wrap"]=!1,t["overflow-x"]=!1,t["overflow-y"]=!1,t.padding=!0,t["padding-bottom"]=!0,t["padding-left"]=!0,t["padding-right"]=!0,t["padding-top"]=!0,t.page=!1,t["page-break-after"]=!1,t["page-break-before"]=!1,t["page-break-inside"]=!1,t["page-policy"]=!1,t.pause=!1,t["pause-after"]=!1,t["pause-before"]=!1,t.perspective=!1,t["perspective-origin"]=!1,t.pitch=!1,t["pitch-range"]=!1,t["play-during"]=!1,t.position=!1,t["presentation-level"]=!1,t.quotes=!1,t["region-fragment"]=!1,t.resize=!1,t.rest=!1,t["rest-after"]=!1,t["rest-before"]=!1,t.richness=!1,t.right=!1,t.rotation=!1,t["rotation-point"]=!1,t["ruby-align"]=!1,t["ruby-merge"]=!1,t["ruby-position"]=!1,t["shape-image-threshold"]=!1,t["shape-outside"]=!1,t["shape-margin"]=!1,t.size=!1,t.speak=!1,t["speak-as"]=!1,t["speak-header"]=!1,t["speak-numeral"]=!1,t["speak-punctuation"]=!1,t["speech-rate"]=!1,t.stress=!1,t["string-set"]=!1,t["tab-size"]=!1,t["table-layout"]=!1,t["text-align"]=!0,t["text-align-last"]=!0,t["text-combine-upright"]=!0,t["text-decoration"]=!0,t["text-decoration-color"]=!0,t["text-decoration-line"]=!0,t["text-decoration-skip"]=!0,t["text-decoration-style"]=!0,t["text-emphasis"]=!0,t["text-emphasis-color"]=!0,t["text-emphasis-position"]=!0,t["text-emphasis-style"]=!0,t["text-height"]=!0,t["text-indent"]=!0,t["text-justify"]=!0,t["text-orientation"]=!0,t["text-overflow"]=!0,t["text-shadow"]=!0,t["text-space-collapse"]=!0,t["text-transform"]=!0,t["text-underline-position"]=!0,t["text-wrap"]=!0,t.top=!1,t.transform=!1,t["transform-origin"]=!1,t["transform-style"]=!1,t.transition=!1,t["transition-delay"]=!1,t["transition-duration"]=!1,t["transition-property"]=!1,t["transition-timing-function"]=!1,t["unicode-bidi"]=!1,t["vertical-align"]=!1,t.visibility=!1,t["voice-balance"]=!1,t["voice-duration"]=!1,t["voice-family"]=!1,t["voice-pitch"]=!1,t["voice-range"]=!1,t["voice-rate"]=!1,t["voice-stress"]=!1,t["voice-volume"]=!1,t.volume=!1,t["white-space"]=!1,t.widows=!1,t.width=!0,t["will-change"]=!1,t["word-break"]=!0,t["word-spacing"]=!0,t["word-wrap"]=!0,t["wrap-flow"]=!1,t["wrap-through"]=!1,t["writing-mode"]=!1,t["z-index"]=!1,t}function WNe(t,e,r){}function XNe(t,e,r){}var YNe=/javascript\s*\:/img;function ZNe(t,e){return YNe.test(e)?"":e}Kw.whiteList=Mme();Kw.getDefaultWhiteList=Mme;Kw.onAttr=WNe;Kw.onIgnoreAttr=XNe;Kw.safeAttrValue=ZNe;var JNe={indexOf:function(t,e){var r,i;if(Array.prototype.indexOf)return t.indexOf(e);for(r=0,i=t.length;r<i;r++)if(t[r]===e)return r;return-1},forEach:function(t,e,r){var i,s;if(Array.prototype.forEach)return t.forEach(e,r);for(i=0,s=t.length;i<s;i++)e.call(r,t[i],i,t)},trim:function(t){return String.prototype.trim?t.trim():t.replace(/(^\s*)|(\s*$)/g,"")},trimRight:function(t){return String.prototype.trimRight?t.trimRight():t.replace(/(\s*$)/g,"")}},lC=JNe;function KNe(t,e){t=lC.trimRight(t),t[t.length-1]!==";"&&(t+=";");var r=t.length,i=!1,s=0,n=0,o="";function a(){if(!i){var h=lC.trim(t.slice(s,n)),p=h.indexOf(":");if(p!==-1){var f=lC.trim(h.slice(0,p)),m=lC.trim(h.slice(p+1));if(f){var y=e(s,o.length,f,m,h);y&&(o+=y+"; ")}}}s=n+1}for(;n<r;n++){var l=t[n];if(l==="/"&&t[n+1]==="*"){var c=t.indexOf("*/",n+2);if(c===-1)break;n=c+1,s=n+1,i=!1}else l==="("?i=!0:l===")"?i=!1:l===";"?i||a():l===`
`&&a()}return lC.trim(o)}var QNe=KNe,yP=Kw,eFe=QNe;function bQ(t){return t==null}function tFe(t){var e={};for(var r in t)e[r]=t[r];return e}function Pme(t){t=tFe(t||{}),t.whiteList=t.whiteList||yP.whiteList,t.onAttr=t.onAttr||yP.onAttr,t.onIgnoreAttr=t.onIgnoreAttr||yP.onIgnoreAttr,t.safeAttrValue=t.safeAttrValue||yP.safeAttrValue,this.options=t}Pme.prototype.process=function(t){if(t=t||"",t=t.toString(),!t)return"";var e=this,r=e.options,i=r.whiteList,s=r.onAttr,n=r.onIgnoreAttr,o=r.safeAttrValue,a=eFe(t,function(l,c,h,p,f){var m=i[h],y=!1;if(m===!0?y=m:typeof m=="function"?y=m(p):m instanceof RegExp&&(y=m.test(p)),y!==!0&&(y=!1),p=o(h,p),!!p){var _={position:c,sourcePosition:l,source:f,isWhite:y};if(y){var b=s(h,p,_);return bQ(b)?h+":"+p:b}else{var b=n(h,p,_);if(!bQ(b))return b}}});return a};var rFe=Pme;(function(t,e){var r=Kw,i=rFe;function s(o,a){var l=new i(a);return l.process(o)}e=t.exports=s,e.FilterCSS=i;for(var n in r)e[n]=r[n]})(QR,QR.exports);var VW={indexOf:function(t,e){var r,i;if(Array.prototype.indexOf)return t.indexOf(e);for(r=0,i=t.length;r<i;r++)if(t[r]===e)return r;return-1},forEach:function(t,e,r){var i,s;if(Array.prototype.forEach)return t.forEach(e,r);for(i=0,s=t.length;i<s;i++)e.call(r,t[i],i,t)},trim:function(t){return String.prototype.trim?t.trim():t.replace(/(^\s*)|(\s*$)/g,"")},spaceIndex:function(t){var e=/\s|\n|\t/,r=e.exec(t);return r?r.index:-1}},iFe=QR.exports.FilterCSS,sFe=QR.exports.getDefaultWhiteList,TN=VW;function Ime(){return{a:["target","href","title"],abbr:["title"],address:[],area:["shape","coords","href","alt"],article:[],aside:[],audio:["autoplay","controls","crossorigin","loop","muted","preload","src"],b:[],bdi:["dir"],bdo:["dir"],big:[],blockquote:["cite"],br:[],caption:[],center:[],cite:[],code:[],col:["align","valign","span","width"],colgroup:["align","valign","span","width"],dd:[],del:["datetime"],details:["open"],div:[],dl:[],dt:[],em:[],figcaption:[],figure:[],font:["color","size","face"],footer:[],h1:[],h2:[],h3:[],h4:[],h5:[],h6:[],header:[],hr:[],i:[],img:["src","alt","title","width","height"],ins:["datetime"],li:[],mark:[],nav:[],ol:[],p:[],pre:[],s:[],section:[],small:[],span:[],sub:[],summary:[],sup:[],strong:[],strike:[],table:["width","border","align","valign"],tbody:["align","valign"],td:["width","rowspan","colspan","align","valign"],tfoot:["align","valign"],th:["width","rowspan","colspan","align","valign"],thead:["align","valign"],tr:["rowspan","align","valign"],tt:[],u:[],ul:[],video:["autoplay","controls","crossorigin","loop","muted","playsinline","poster","preload","src","height","width"]}}var $me=new iFe;function nFe(t,e,r){}function oFe(t,e,r){}function aFe(t,e,r){}function lFe(t,e,r){}function Lme(t){return t.replace(uFe,"&lt;").replace(hFe,"&gt;")}function cFe(t,e,r,i){if(r=Vme(r),e==="href"||e==="src"){if(r=TN.trim(r),r==="#")return"#";if(!(r.substr(0,7)==="http://"||r.substr(0,8)==="https://"||r.substr(0,7)==="mailto:"||r.substr(0,4)==="tel:"||r.substr(0,11)==="data:image/"||r.substr(0,6)==="ftp://"||r.substr(0,2)==="./"||r.substr(0,3)==="../"||r[0]==="#"||r[0]==="/"))return""}else if(e==="background"){if(_P.lastIndex=0,_P.test(r))return""}else if(e==="style"){if(wQ.lastIndex=0,wQ.test(r)||(xQ.lastIndex=0,xQ.test(r)&&(_P.lastIndex=0,_P.test(r))))return"";i!==!1&&(i=i||$me,r=i.process(r))}return r=Bme(r),r}var uFe=/</g,hFe=/>/g,dFe=/"/g,pFe=/&quot;/g,fFe=/&#([a-zA-Z0-9]*);?/gim,mFe=/&colon;?/gim,gFe=/&newline;?/gim,_P=/((j\s*a\s*v\s*a|v\s*b|l\s*i\s*v\s*e)\s*s\s*c\s*r\s*i\s*p\s*t\s*|m\s*o\s*c\s*h\s*a):/gi,wQ=/e\s*x\s*p\s*r\s*e\s*s\s*s\s*i\s*o\s*n\s*\(.*/gi,xQ=/u\s*r\s*l\s*\(.*/gi;function Dme(t){return t.replace(dFe,"&quot;")}function Nme(t){return t.replace(pFe,'"')}function Fme(t){return t.replace(fFe,function(r,i){return i[0]==="x"||i[0]==="X"?String.fromCharCode(parseInt(i.substr(1),16)):String.fromCharCode(parseInt(i,10))})}function Ume(t){return t.replace(mFe,":").replace(gFe," ")}function kme(t){for(var e="",r=0,i=t.length;r<i;r++)e+=t.charCodeAt(r)<32?" ":t.charAt(r);return TN.trim(e)}function Vme(t){return t=Nme(t),t=Fme(t),t=Ume(t),t=kme(t),t}function Bme(t){return t=Dme(t),t=Lme(t),t}function yFe(){return""}function _Fe(t,e){typeof e!="function"&&(e=function(){});var r=!Array.isArray(t);function i(o){return r?!0:TN.indexOf(t,o)!==-1}var s=[],n=!1;return{onIgnoreTag:function(o,a,l){if(i(o))if(l.isClosing){var c="[/removed]",h=l.position+c.length;return s.push([n!==!1?n:l.position,h]),n=!1,c}else return n||(n=l.position),"[removed]";else return e(o,a,l)},remove:function(o){var a="",l=0;return TN.forEach(s,function(c){a+=o.slice(l,c[0]),l=c[1]}),a+=o.slice(l),a}}}function vFe(t){for(var e="",r=0;r<t.length;){var i=t.indexOf("<!--",r);if(i===-1){e+=t.slice(r);break}e+=t.slice(r,i);var s=t.indexOf("-->",i);if(s===-1)break;r=s+3}return e}function bFe(t){var e=t.split("");return e=e.filter(function(r){var i=r.charCodeAt(0);return i===127?!1:i<=31?i===10||i===13:!0}),e.join("")}an.whiteList=Ime();an.getDefaultWhiteList=Ime;an.onTag=nFe;an.onIgnoreTag=oFe;an.onTagAttr=aFe;an.onIgnoreTagAttr=lFe;an.safeAttrValue=cFe;an.escapeHtml=Lme;an.escapeQuote=Dme;an.unescapeQuote=Nme;an.escapeHtmlEntities=Fme;an.escapeDangerHtml5Entities=Ume;an.clearNonPrintableCharacter=kme;an.friendlyAttrValue=Vme;an.escapeAttrValue=Bme;an.onIgnoreTagStripAll=yFe;an.StripTagBody=_Fe;an.stripCommentTag=vFe;an.stripBlankChar=bFe;an.cssFilter=$me;an.getDefaultCSSWhiteList=sFe;var H4={},Z0=VW;function wFe(t){var e=Z0.spaceIndex(t),r;return e===-1?r=t.slice(1,-1):r=t.slice(1,e+1),r=Z0.trim(r).toLowerCase(),r.slice(0,1)==="/"&&(r=r.slice(1)),r.slice(-1)==="/"&&(r=r.slice(0,-1)),r}function xFe(t){return t.slice(0,2)==="</"}function TFe(t,e,r){var i="",s=0,n=!1,o=!1,a=0,l=t.length,c="",h="";e:for(a=0;a<l;a++){var p=t.charAt(a);if(n===!1){if(p==="<"){n=a;continue}}else if(o===!1){if(p==="<"){i+=r(t.slice(s,a)),n=a,s=a;continue}if(p===">"){i+=r(t.slice(s,n)),h=t.slice(n,a+1),c=wFe(h),i+=e(n,i.length,c,h,xFe(h)),s=a+1,n=!1;continue}if(p==='"'||p==="'")for(var f=1,m=t.charAt(a-f);m.trim()===""||m==="=";){if(m==="="){o=p;continue e}m=t.charAt(a-++f)}}else if(p===o){o=!1;continue}}return s<t.length&&(i+=r(t.substr(s))),i}var SFe=/[^a-zA-Z0-9\\_:.-]/gim;function EFe(t,e){var r=0,i=0,s=[],n=!1,o=t.length;function a(f,m){if(f=Z0.trim(f),f=f.replace(SFe,"").toLowerCase(),!(f.length<1)){var y=e(f,m||"");y&&s.push(y)}}for(var l=0;l<o;l++){var c=t.charAt(l),h,p;if(n===!1&&c==="="){n=t.slice(r,l),r=l+1,i=t.charAt(r)==='"'||t.charAt(r)==="'"?r:AFe(t,l+1);continue}if(n!==!1&&l===i){if(p=t.indexOf(c,l+1),p===-1)break;h=Z0.trim(t.slice(i+1,p)),a(n,h),n=!1,l=p,r=l+1;continue}if(/\s|\n|\t/.test(c))if(t=t.replace(/\s|\n|\t/g," "),n===!1)if(p=CFe(t,l),p===-1){h=Z0.trim(t.slice(r,l)),a(h),n=!1,r=l+1;continue}else{l=p-1;continue}else if(p=RFe(t,l-1),p===-1){h=Z0.trim(t.slice(r,l)),h=TQ(h),a(n,h),n=!1,r=l+1;continue}else continue}return r<t.length&&(n===!1?a(t.slice(r)):a(n,TQ(Z0.trim(t.slice(r))))),Z0.trim(s.join(" "))}function CFe(t,e){for(;e<t.length;e++){var r=t[e];if(r!==" ")return r==="="?e:-1}}function AFe(t,e){for(;e<t.length;e++){var r=t[e];if(r!==" ")return r==="'"||r==='"'?e:-1}}function RFe(t,e){for(;e>0;e--){var r=t[e];if(r!==" ")return r==="="?e:-1}}function OFe(t){return t[0]==='"'&&t[t.length-1]==='"'||t[0]==="'"&&t[t.length-1]==="'"}function TQ(t){return OFe(t)?t.substr(1,t.length-2):t}H4.parseTag=TFe;H4.parseAttr=EFe;var MFe=QR.exports.FilterCSS,Nd=an,zme=H4,PFe=zme.parseTag,IFe=zme.parseAttr,wL=VW;function vP(t){return t==null}function $Fe(t){var e=wL.spaceIndex(t);if(e===-1)return{html:"",closing:t[t.length-2]==="/"};t=wL.trim(t.slice(e+1,-1));var r=t[t.length-1]==="/";return r&&(t=wL.trim(t.slice(0,-1))),{html:t,closing:r}}function LFe(t){var e={};for(var r in t)e[r]=t[r];return e}function DFe(t){var e={};for(var r in t)Array.isArray(t[r])?e[r.toLowerCase()]=t[r].map(function(i){return i.toLowerCase()}):e[r.toLowerCase()]=t[r];return e}function Gme(t){t=LFe(t||{}),t.stripIgnoreTag&&(t.onIgnoreTag&&console.error('Notes: cannot use these two options "stripIgnoreTag" and "onIgnoreTag" at the same time'),t.onIgnoreTag=Nd.onIgnoreTagStripAll),t.whiteList||t.allowList?t.whiteList=DFe(t.whiteList||t.allowList):t.whiteList=Nd.whiteList,t.onTag=t.onTag||Nd.onTag,t.onTagAttr=t.onTagAttr||Nd.onTagAttr,t.onIgnoreTag=t.onIgnoreTag||Nd.onIgnoreTag,t.onIgnoreTagAttr=t.onIgnoreTagAttr||Nd.onIgnoreTagAttr,t.safeAttrValue=t.safeAttrValue||Nd.safeAttrValue,t.escapeHtml=t.escapeHtml||Nd.escapeHtml,this.options=t,t.css===!1?this.cssFilter=!1:(t.css=t.css||{},this.cssFilter=new MFe(t.css))}Gme.prototype.process=function(t){if(t=t||"",t=t.toString(),!t)return"";var e=this,r=e.options,i=r.whiteList,s=r.onTag,n=r.onIgnoreTag,o=r.onTagAttr,a=r.onIgnoreTagAttr,l=r.safeAttrValue,c=r.escapeHtml,h=e.cssFilter;r.stripBlankChar&&(t=Nd.stripBlankChar(t)),r.allowCommentTag||(t=Nd.stripCommentTag(t));var p=!1;r.stripIgnoreTagBody&&(p=Nd.StripTagBody(r.stripIgnoreTagBody,n),n=p.onIgnoreTag);var f=PFe(t,function(m,y,_,b,x){var T={sourcePosition:m,position:y,isClosing:x,isWhite:Object.prototype.hasOwnProperty.call(i,_)},S=s(_,b,T);if(!vP(S))return S;if(T.isWhite){if(T.isClosing)return"</"+_+">";var E=$Fe(b),O=i[_],R=IFe(E.html,function(L,P){var U=wL.indexOf(O,L)!==-1,B=o(_,L,P,U);return vP(B)?U?(P=l(_,L,P,h),P?L+'="'+P+'"':L):(B=a(_,L,P,U),vP(B)?void 0:B):B});return b="<"+_,R&&(b+=" "+R),E.closing&&(b+=" /"),b+=">",b}else return S=n(_,b,T),vP(S)?c(b):S},c);return p&&(f=p.remove(f)),f};var NFe=Gme;(function(t,e){var r=an,i=H4,s=NFe;function n(a,l){var c=new s(l);return c.process(a)}e=t.exports=n,e.filterXSS=n,e.FilterXSS=s,function(){for(var a in r)e[a]=r[a];for(var l in i)e[l]=i[l]}();function o(){return typeof self<"u"&&typeof DedicatedWorkerGlobalScope<"u"&&self instanceof DedicatedWorkerGlobalScope}o()&&(self.filterXSS=t.exports)})(vb,vb.exports);var FFe=function(){function t(e,r){var i=this;this.arcgisWhiteList={a:["href","style","target"],abbr:["title"],audio:["autoplay","controls","loop","muted","preload"],b:[],br:[],dd:["style"],div:["align","style"],dl:["style"],dt:["style"],em:[],figcaption:["style"],figure:["style"],font:["color","face","size","style"],h1:["style"],h2:["style"],h3:["style"],h4:["style"],h5:["style"],h6:["style"],hr:[],i:[],img:["alt","border","height","src","style","width"],li:[],ol:[],p:["style"],source:["media","src","type"],span:["style"],strong:[],sub:["style"],sup:["style"],table:["border","cellpadding","cellspacing","height","style","width"],tbody:[],tr:["align","height","style","valign"],td:["align","colspan","height","nowrap","rowspan","style","valign","width"],th:["align","colspan","height","nowrap","rowspan","style","valign","width"],u:[],ul:[],video:["autoplay","controls","height","loop","muted","poster","preload","width"]},this.allowedProtocols=["http","https","mailto","iform","tel","flow","lfmobile","arcgis-navigator","arcgis-appstudio-player","arcgis-survey123","arcgis-collector","arcgis-workforce","arcgis-explorer","arcgis-trek2there","arcgis-quickcapture","mspbi","comgooglemaps","pdfefile","pdfehttp","pdfehttps","boxapp","boxemm","awb","awbs","gropen","radarscope"],this.arcgisFilterOptions={allowCommentTag:!0,safeAttrValue:function(n,o,a,l){return n==="a"&&o==="href"||(n==="img"||n==="source")&&o==="src"?i.sanitizeUrl(a):vb.exports.safeAttrValue(n,o,a,l)}},this._entityMap={"&":"&#x38;","<":"&#x3C;",">":"&#x3E;",'"':"&#x22;","'":"&#x27;","/":"&#x2F;"};var s;e&&!r?s=e:e&&r?(s=Object.create(this.arcgisFilterOptions),Object.keys(e).forEach(function(n){n==="whiteList"?s.whiteList=i._extendObjectOfArrays([i.arcgisWhiteList,e.whiteList||{}]):s[n]=e[n]})):(s=Object.create(this.arcgisFilterOptions),s.whiteList=this.arcgisWhiteList),this.xssFilterOptions=s,this._xssFilter=new vb.exports.FilterXSS(s)}return t.prototype.sanitize=function(e,r){switch(r===void 0&&(r={}),typeof e){case"number":return isNaN(e)||!isFinite(e)?null:e;case"boolean":return e;case"string":return this._xssFilter.process(e);case"object":return this._iterateOverObject(e,r);default:return r.allowUndefined&&typeof e>"u"?void 0:null}},t.prototype.sanitizeUrl=function(e,r){var i=(r??{}).isProtocolRequired,s=i===void 0?!0:i,n=this._trim(e.substring(0,e.indexOf(":"))),o=e==="/",a=/^#/.test(e),l=n&&this.allowedProtocols.indexOf(n.toLowerCase())>-1;return o||a||l?vb.exports.escapeAttrValue(e):!n&&!s?vb.exports.escapeAttrValue("https://".concat(e)):""},t.prototype.sanitizeHTMLAttribute=function(e,r,i,s){return typeof this.xssFilterOptions.safeAttrValue=="function"?this.xssFilterOptions.safeAttrValue(e,r,i,s):vb.exports.safeAttrValue(e,r,i,s)},t.prototype.validate=function(e,r){r===void 0&&(r={});var i=this.sanitize(e,r);return{isValid:e===i,sanitized:i}},t.prototype.encodeHTML=function(e){var r=this;return String(e).replace(/[&<>"'\/]/g,function(i){return r._entityMap[i]})},t.prototype.encodeAttrValue=function(e){var r=/^[a-zA-Z0-9]$/;return String(e).replace(/[\x00-\xFF]/g,function(i,s){return r.test(i)?i:"&#x".concat(Number(e.charCodeAt(s)).toString(16),";")})},t.prototype._extendObjectOfArrays=function(e){var r={};return e.forEach(function(i){Object.keys(i).forEach(function(s){Array.isArray(i[s])&&Array.isArray(r[s])?r[s]=r[s].concat(i[s]):r[s]=i[s]})}),r},t.prototype._iterateOverObject=function(e,r){var i=this;r===void 0&&(r={});try{var s=!1,n=void 0;if(Array.isArray(e))n=e.reduce(function(a,l){var c=i.validate(l,r);return c.isValid?a.concat([l]):(s=!0,a.concat([c.sanitized]))},[]);else if(qNe(e)){var o=Object.keys(e);n=o.reduce(function(a,l){var c=e[l],h=i.validate(c,r);return h.isValid?a[l]=c:(s=!0,a[l]=h.sanitized),a},{})}else return r.allowUndefined&&typeof e>"u"?void 0:null;return s?n:e}catch{return null}},t.prototype._trim=function(e){return String.prototype.trim?e.trim():e.replace(/(^\s*)|(\s*$)/g,"")},t}();const q4=new Map;function jme(){q4.clear()}function UFe(t){return q4.get(t)}function kFe(t,e){q4.set(t,e)}function sU(t){q4.delete(t)}var ww,BS,VFe=function(t){if("WebkitTransition"in t.style)ww="webkitTransitionEnd",BS="webkitAnimationEnd";else{if(!("transition"in t.style))throw new Error("Your browser is not supported!");ww="transitionend",BS="animationend"}},Hme=function(t){ww||VFe(t)},BFe=function(t,e){return e===void 0&&(e=t+"-active"),function(r){Hme(r);var i=!1,s=function(n){i||(i=!0,r.removeEventListener(ww,s),r.removeEventListener(BS,s),r.classList.remove(t),r.classList.remove(e))};r.classList.add(t),r.addEventListener(ww,s),r.addEventListener(BS,s),requestAnimationFrame(function(){r.classList.add(e)})}},zFe=function(t,e){return e===void 0&&(e=t+"-active"),function(r,i){Hme(r);var s=!1,n=function(o){s||(s=!0,r.removeEventListener(ww,n),r.removeEventListener(BS,n),i())};r.classList.add(t),r.addEventListener(ww,n),r.addEventListener(BS,n),requestAnimationFrame(function(){r.classList.add(e)})}};const GFe=se.getLogger("esri.widgets.support.widgetUtils");function qme(t){const e=wc.acquire();for(let i=0;i<arguments.length;i++){const s=arguments[i],n=typeof s;if(n==="string")e.push(s);else if(Array.isArray(s))e.push.apply(e,s);else if(n==="object")for(const o in s)s[o]&&e.push(o)}const r=e.join(" ");return wc.release(e),r}(()=>{const t=new Map,e=new ResizeObserver(r=>{var i;jme();for(const s of r)(i=t.get(s.target))==null||i(s)});return(r,i,s)=>(t.has(r)&&GFe.error("Already observing element",r),t.set(r,i),e.observe(r,s),cp(()=>{e.unobserve(r),t.delete(r)}))})();function Uf(t){const e=t==null?void 0:t.closest("[dir]");return e!==null&&e instanceof HTMLElement&&e.dir==="rtl"||document.dir==="rtl"}function SQ(t){const e="data-node-ref";this[t.getAttribute(e)]=null}function SN(t){const e="data-node-ref";this[t.getAttribute(e)]=t}function jFe(t,e){return(t==="enter"?BFe:zFe)(e)}const HFe=["dd","dl","dt","h1","h2","h3","h4","h5","h6","sub","sup","animate","animatetransform","circle","clippath","defs","ellipse","g","image","line","lineargradient","marker","mask","path","pattern","polygon","polyline","radialgradient","rect","stop","svg","switch","symbol","text","textpath","tspan","use"],qFe=HFe.reduce((t,e)=>(t[e]=[],t),{}),WFe=["align","alink","alt","bgcolor","border","cellpadding","cellspacing","class","color","cols","colspan","coords","d","dir","face","height","hspace","ismap","lang","marginheight","marginwidth","multiple","nohref","noresize","noshade","nowrap","ref","rel","rev","rows","rowspan","scrolling","shape","span","summary","tabindex","title","usemap","valign","value","vlink","vspace","width"],Wme=new FFe({whiteList:qFe,onTagAttr:(t,e,r)=>{const i=`${e}="${r}"`;if(WFe.includes(e))return i},stripIgnoreTag:!0,stripIgnoreTagBody:["script","style"]},!0);function XFe(t){return t==="Enter"||t===" "}const Xme="http://www.w3.org/",W4=`${Xme}2000/svg`,Yme=`${Xme}1999/xlink`;let EQ=[],BW=(t,e)=>{let r={};return Object.keys(t).forEach(i=>{r[i]=t[i]}),e&&Object.keys(e).forEach(i=>{r[i]=e[i]}),r},zW=(t,e)=>t.vnodeSelector===e.vnodeSelector&&(t.properties&&e.properties?t.properties.key===e.properties.key&&t.properties.bind===e.properties.bind:!t.properties&&!e.properties),Zme=t=>{if(typeof t!="string")throw new Error("Style values must be strings")},YFe=(t,e,r)=>{if(e.vnodeSelector!==""){for(let i=r;i<t.length;i++)if(zW(t[i],e))return i}return-1},nU=(t,e,r,i)=>{let s=t[e];if(s.vnodeSelector==="")return;let n=s.properties;if(!(n&&(n.key===void 0?n.bind:n.key))){for(let o=0;o<t.length;o++)if(o!==e){let a=t[o];if(zW(a,s))throw new Error(`${r.vnodeSelector} had a ${s.vnodeSelector} child ${i==="added"?i:"removed"}, but there is now more than one. You must add unique key properties to make them distinguishable.`)}}},ZFe=t=>{if(t.properties){let e=t.properties.enterAnimation;e&&e(t.domNode,t.properties)}},oz=[],az=!1,Jme=t=>{(t.children||[]).forEach(Jme),t.properties&&t.properties.afterRemoved&&t.properties.afterRemoved.apply(t.properties.bind||t.properties,[t.domNode])},CQ=()=>{az=!1,oz.forEach(Jme),oz.length=0},AQ=t=>{oz.push(t),az||(az=!0,typeof window<"u"&&"requestIdleCallback"in window?window.requestIdleCallback(CQ,{timeout:16}):setTimeout(CQ,16))},RQ=t=>{let e=t.domNode;if(t.properties){let r=t.properties.exitAnimation;if(r)return e.style.pointerEvents="none",void r(e,()=>{e.parentNode&&(e.parentNode.removeChild(e),AQ(t))},t.properties)}e.parentNode&&(e.parentNode.removeChild(e),AQ(t))},JFe=(t,e,r)=>{if(!e)return;let i=r.eventHandlerInterceptor,s=Object.keys(e),n=s.length;for(let o=0;o<n;o++){let a=s[o],l=e[a];if(a==="className")throw new Error('Property "className" is not supported, use "class".');if(a==="class")lz(t,l,!0);else if(a==="classes"){let c=Object.keys(l),h=c.length;for(let p=0;p<h;p++){let f=c[p];l[f]&&t.classList.add(f)}}else if(a==="styles"){let c=Object.keys(l),h=c.length;for(let p=0;p<h;p++){let f=c[p],m=l[f];m&&(Zme(m),r.styleApplyer(t,f,m))}}else if(a!=="key"&&l!=null){let c=typeof l;c==="function"?(a.lastIndexOf("on",0)===0&&(i&&(l=i(a,l,t,e)),a==="oninput"&&function(){let h=l;l=function(p){h.apply(this,[p]),p.target["oninput-value"]=p.target.value}}()),t[a]=l):r.namespace===W4?a==="href"?t.setAttributeNS(Yme,a,l):t.setAttribute(a,l):c==="string"&&a!=="value"?a==="innerHTML"?t[a]=Wme.sanitize(l):Kme(t)&&a in t?t[a]=l:t.setAttribute(a,l):t[a]=l}}};function Kme(t){if(!(t instanceof Element&&t.tagName.includes("-")))return!1;const e=window.customElements.get(t.tagName.toLowerCase());return!!e&&t instanceof e}let EN,KFe=(t,e,r)=>{if(e)for(let i of e)x2(i,t,void 0,r)},Qme=(t,e,r)=>{KFe(t,e.children,r),e.text&&(t.textContent=e.text),JFe(t,e.properties,r),e.properties&&e.properties.afterCreate&&e.properties.afterCreate.apply(e.properties.bind||e.properties,[t,r,e.vnodeSelector,e.properties,e.children])},x2=(t,e,r,i)=>{let s,n=0,o=t.vnodeSelector,a=e.ownerDocument;if(o==="")s=t.domNode=a.createTextNode(t.text),r!==void 0?e.insertBefore(s,r):e.appendChild(s);else{for(let l=0;l<=o.length;++l){let c=o.charAt(l);if(l===o.length||c==="."||c==="#"){let h=o.charAt(n-1),p=o.slice(n,l);h==="."?s.classList.add(p):h==="#"?s.id=p:(p==="svg"&&(i=BW(i,{namespace:W4})),i.namespace!==void 0?s=t.domNode=a.createElementNS(i.namespace,p):(s=t.domNode=t.domNode||a.createElement(p),p==="input"&&t.properties&&t.properties.type!==void 0&&s.setAttribute("type",t.properties.type)),r!==void 0?e.insertBefore(s,r):s.parentNode!==e&&e.appendChild(s)),n=l+1}}Qme(s,t,i)}},lz=(t,e,r)=>{e&&e.split(" ").forEach(i=>{i&&t.classList.toggle(i,r)})},QFe=(t,e,r,i)=>{if(!r)return;let s=!1,n=Object.keys(r),o=n.length;for(let a=0;a<o;a++){let l=n[a],c=r[l],h=e[l];if(l==="class")h!==c&&(lz(t,h,!1),lz(t,c,!0));else if(l==="classes"){let p=t.classList,f=Object.keys(c),m=f.length;for(let y=0;y<m;y++){let _=f[y],b=!!c[_];b!==!!h[_]&&(s=!0,b?p.add(_):p.remove(_))}}else if(l==="styles"){let p=Object.keys(c),f=p.length;for(let m=0;m<f;m++){let y=p[m],_=c[y];_!==h[y]&&(s=!0,_?(Zme(_),i.styleApplyer(t,y,_)):i.styleApplyer(t,y,""))}}else if(c||typeof h!="string"||(c=""),l==="value"){let p=t[l];p!==c&&(t["oninput-value"]?p===t["oninput-value"]:c!==h)&&(t[l]=c,t["oninput-value"]=void 0),c!==h&&(s=!0)}else if(c!==h){let p=typeof c;p==="function"&&i.eventHandlerInterceptor||(i.namespace===W4?l==="href"?t.setAttributeNS(Yme,l,c):t.setAttribute(l,c):p==="string"?l==="innerHTML"?t[l]=Wme.sanitize(c):l==="role"&&c===""?t.removeAttribute(l):Kme(t)&&l in t?t[l]=c:t.setAttribute(l,c):t[l]!==c&&(t[l]=c),s=!0)}}return s},e4e=(t,e,r,i,s)=>{if(r===i)return!1;i=i||EQ;let n,o=(r=r||EQ).length,a=i.length,l=0,c=0,h=!1;for(;c<a;){let p=l<o?r[l]:void 0,f=i[c];if(p!==void 0&&zW(p,f))h=EN(p,f,s)||h,l++;else{let m=YFe(r,f,l+1);if(m>=0){for(n=l;n<m;n++)RQ(r[n]),nU(r,n,t,"removed");h=EN(r[m],f,s)||h,l=m+1}else x2(f,e,l<o?r[l].domNode:void 0,s),ZFe(f),nU(i,c,t,"added")}c++}if(o>l)for(n=l;n<o;n++)RQ(r[n]),nU(r,n,t,"removed");return h};EN=(t,e,r)=>{let i=t.domNode,s=!1;if(t===e)return!1;let n=!1;if(e.vnodeSelector===""){if(e.text!==t.text){let o=i.ownerDocument.createTextNode(e.text);return i.parentNode.replaceChild(o,i),e.domNode=o,s=!0,s}e.domNode=i}else e.vnodeSelector.lastIndexOf("svg",0)===0&&(r=BW(r,{namespace:W4})),t.text!==e.text&&(n=!0,e.text===void 0?i.removeChild(i.firstChild):i.textContent=e.text),e.domNode=i,n=e4e(e,i,t.children,e.children,r)||n,n=QFe(i,t.properties,e.properties,r)||n,e.properties&&e.properties.afterUpdate&&e.properties.afterUpdate.apply(e.properties.bind||e.properties,[i,r,e.vnodeSelector,e.properties,e.children]);return n&&e.properties&&e.properties.updateAnimation&&e.properties.updateAnimation(i,e.properties,t.properties),s};let cC=(t,e)=>({getLastRender:()=>t,update:r=>{if(t.vnodeSelector!==r.vnodeSelector)throw new Error("The selector for the root VNode may not be changed. (consider using dom.merge and add one extra level to the virtual DOM)");let i=t;t=r,EN(i,r,e)},domNode:t.domNode});const t4e={namespace:void 0,performanceLogger:()=>{},eventHandlerInterceptor:void 0,styleApplyer:(t,e,r)=>{e.charAt(0)==="-"?t.style.setProperty(e,r):t.style[e]=r}};let CT=t=>BW(t4e,t),E_={create:(t,e)=>(e=CT(e),x2(t,document.createElement("div"),void 0,e),cC(t,e)),append:(t,e,r)=>(r=CT(r),x2(e,t,void 0,r),cC(e,r)),insertBefore:(t,e,r)=>(r=CT(r),x2(e,t.parentNode,t,r),cC(e,r)),merge:(t,e,r)=>(r=CT(r),e.domNode=t,Qme(t,e,r),cC(e,r)),replace:(t,e,r)=>(r=CT(r),x2(e,t.parentNode,t,r),t.parentNode.removeChild(t),cC(e,r))},ege,r4e=(t,e)=>{let r=[];for(;t&&t!==e;)r.push(t),t=t.parentNode;return r};ege=Array.prototype.find?(t,e)=>t.find(e):(t,e)=>t.filter(e)[0];let i4e=(t,e)=>{let r=t;return e.forEach(i=>{r=r&&r.children?ege(r.children,s=>s.domNode===i):void 0}),r},s4e=(t,e,r)=>{let i=function(s){r("domEvent",s);let n=e(),o=r4e(s.currentTarget,n.domNode);o.reverse();let a,l=i4e(n.getLastRender(),o);return t.scheduleRender(),l&&(a=l.properties[`on${s.type}`].apply(l.properties.bind||this,arguments)),r("domEventProcessed",s),a};return(s,n,o,a)=>i},cz=t=>{let e,r,i=CT(t),s=i.performanceLogger,n=!0,o=!1,a=[],l=[],c=(p,f,m)=>{let y,_=()=>y;i.eventHandlerInterceptor=s4e(e,_,s),y=p(f,m(),i),a.push(y),l.push(m)},h=()=>{if(r=void 0,n){n=!1,s("renderStart",void 0);for(let p=0;p<a.length;p++){let f=l[p]();s("rendered",void 0),a[p].update(f),s("patched",void 0)}s("renderDone",void 0),n=!0}};return e={renderNow:h,scheduleRender:()=>{r||o||(r=requestAnimationFrame(h))},stop:()=>{r&&(cancelAnimationFrame(r),r=void 0),o=!0},resume:()=>{o=!1,n=!0,e.scheduleRender()},append:(p,f)=>{c(E_.append,p,f)},insertBefore:(p,f)=>{c(E_.insertBefore,p,f)},merge:(p,f)=>{c(E_.merge,p,f)},replace:(p,f)=>{c(E_.replace,p,f)},detach:p=>{for(let f=0;f<l.length;f++)if(l[f]===p)return l.splice(f,1),a.splice(f,1)[0];throw new Error("renderFunction was not found")}},e},R0=class extends Te{constructor(){super(...arguments),this.items=new Pt,this._watchUpdatingTracking=new Hf,this._callbacks=new Map,this._projector=cz(),this._hiddenProjector=cz()}get needsRender(){return this.items.length>0}get updating(){var e;return((e=this._watchUpdatingTracking)==null?void 0:e.updating)??!1}initialize(){const e=document.createElement("div");e.className="esri-overlay-surface",this._set("surface",e),this._hiddenSurface=document.createElement("div"),this._hiddenSurface.setAttribute("style","visibility: hidden;"),e.appendChild(this._hiddenSurface),this._watchUpdatingTracking.addOnCollectionChange(()=>this.items,r=>{for(const i of r.added){const s=()=>i.render();this._callbacks.set(i,s),this._projector.append(this.surface,s)}for(const i of r.removed){const s=this._projector.detach(this._callbacks.get(i));this.surface.removeChild(s.domNode),this._callbacks.delete(i)}})}addItem(e){this.items.add(e)}removeItem(e){this.items.remove(e)}destroy(){this.items.removeAll(),this._callbacks.forEach(e=>this._projector.detach(e)),this._callbacks=null,this._projector=null,this._watchUpdatingTracking.destroy()}render(){this._projector.renderNow()}computeBoundingRect(e){const r=this._hiddenSurface,i=this._hiddenProjector;let s;const n=()=>(s=e.render(),s);i.append(r,n),i.renderNow();const o={left:0,top:0,right:0,bottom:0};if(s&&s.domNode){const a=s.domNode.getBoundingClientRect();o.left=a.left,o.top=a.top,o.right=a.right,o.bottom=a.bottom}for(i.detach(n);r.firstChild;)r.removeChild(r.firstChild);return o}overlaps(e,r){const i=this.computeBoundingRect(e),s=this.computeBoundingRect(r);return Math.max(i.left,s.left)<=Math.min(i.right,s.right)&&Math.max(i.top,s.top)<=Math.min(i.bottom,s.bottom)}get hasVisibleItems(){return this.items.some(e=>e.visible)}async prepare(){await document.fonts.load(this._fontString()).catch(()=>{})}renderCanvas(e){if(!this.items.some(i=>i.visible))return;const r=e.getContext("2d");r.save(),r.font=this._fontString(),this.items.forEach(i=>{r.save(),i.renderCanvas(r),r.restore()}),r.restore()}_fontString(){return`10px ${getComputedStyle(this.surface).fontFamily}`}};u([d({readOnly:!0})],R0.prototype,"surface",void 0),u([d({readOnly:!0})],R0.prototype,"items",void 0),u([d({readOnly:!0})],R0.prototype,"needsRender",null),u([d({readOnly:!0})],R0.prototype,"_watchUpdatingTracking",void 0),u([d({readOnly:!0})],R0.prototype,"updating",null),R0=u([I("esri.views.overlay.ViewOverlay")],R0);const OQ=R0;function q2(t,e,r,i){let s=null,n=1e3;typeof e=="number"?(n=e,i=r):(s=e??null,n=r);let o,a=0;const l=()=>{a=0,t.apply(i,o)},c=(...h)=>{s&&s.apply(i,h),o=h,n?a||(a=setTimeout(l,n)):l()};return c.remove=()=>{a&&(clearTimeout(a),a=0)},c.forceUpdate=()=>{a&&(clearTimeout(a),l())},c.hasPendingUpdates=()=>!!a,c}const n4e="randomUUID"in crypto;function o4e(){if(n4e)return crypto.randomUUID();const t=crypto.getRandomValues(new Uint16Array(8));t[3]=4095&t[3]|16384,t[4]=16383&t[4]|32768;const e=r=>t[r].toString(16).padStart(4,"0");return e(0)+e(1)+"-"+e(2)+"-"+e(3)+"-"+e(4)+"-"+e(5)+e(6)+e(7)}const a4e={handleInterceptedEvent:(t,e,r,i)=>(t.scheduleRender(),e.properties[`on${i.type}`].apply(e.properties.bind||r,[i]))},l4e={namespace:void 0,performanceLogger:()=>{},eventHandlerInterceptor:void 0,styleApplyer:(t,e,r)=>{t.style[e]=r}},c4e=t=>({...l4e,...t}),u4e=(t,e)=>{const r=[];for(;t&&t!==e;)r.push(t),t=t.parentNode;return r},h4e=(t,e)=>t.find(e),MQ=(t,e,r=!1)=>{let i=t;return e.forEach((s,n)=>{const o=i!=null&&i.children?h4e(i.children,a=>a.domNode===s):void 0;r&&!o&&n!==e.length-1||(i=o)}),i},d4e=t=>{let e;const r={...a4e,...t},i=c4e(r),s=i.performanceLogger;let n,o=!0,a=!1;const l=[],c=[],h=(f,m,y)=>{var x;let _;i.eventHandlerInterceptor=(T,S,E,O)=>function(R){let L;s("domEvent",R);const P=u4e(R.currentTarget,_.domNode),U=P.some(z=>{var G;return customElements.get((G=z==null?void 0:z.tagName)==null?void 0:G.toLowerCase())});if(R.eventPhase===Event.CAPTURING_PHASE||!U)P.reverse(),L=MQ(_.getLastRender(),P);else{const z=R.composedPath(),G=z.slice(z.indexOf(R.currentTarget),z.indexOf(_.domNode)).filter(K=>K.getRootNode()===K.ownerDocument).reverse();L=MQ(_.getLastRender(),G,!0)}let B;return L&&(B=r.handleInterceptedEvent(e,L,this,R)),s("domEventProcessed",R),B},(x=r.postProcessProjectionOptions)==null||x.call(r,i);const b=y();_=f(m,b,i),l.push(_),c.push(y),r.afterFirstVNodeRendered&&r.afterFirstVNodeRendered(_,b)};let p=()=>{if(n=void 0,o){o=!1,s("renderStart",void 0);for(let f=0;f<l.length;f++){const m=c[f]();s("rendered",void 0),l[f].update(m),s("patched",void 0)}s("renderDone",void 0),o=!0}};return r.modifyDoRenderImplementation&&(p=r.modifyDoRenderImplementation(p,l,c)),e={renderNow:p,scheduleRender:()=>{n||a||(n=requestAnimationFrame(p))},stop:()=>{n&&(cancelAnimationFrame(n),n=void 0),a=!0},resume:()=>{a=!1,o=!0,e.scheduleRender()},append:(f,m)=>{h(E_.append,f,m)},insertBefore:(f,m)=>{h(E_.insertBefore,f,m)},merge:(f,m)=>{h(E_.merge,f,m)},replace:(f,m)=>{h(E_.replace,f,m)},detach:f=>{for(let m=0;m<c.length;m++)if(c[m]===f)return c.splice(m,1),l.splice(m,1)[0];throw new Error("renderFunction was not found")}},e},AT={allRenderFn:!1,cmpDidLoad:!0,cmpDidUnload:!1,cmpDidUpdate:!0,cmpDidRender:!0,cmpWillLoad:!0,cmpWillUpdate:!0,cmpWillRender:!0,connectedCallback:!0,disconnectedCallback:!0,element:!0,event:!0,hasRenderFn:!0,lifecycle:!0,hostListener:!0,hostListenerTargetWindow:!0,hostListenerTargetDocument:!0,hostListenerTargetBody:!0,hostListenerTargetParent:!1,hostListenerTarget:!0,member:!0,method:!0,mode:!0,observeAttribute:!0,prop:!0,propMutable:!0,reflect:!0,scoped:!0,shadowDom:!0,slot:!0,cssAnnotations:!0,state:!0,style:!0,svg:!0,updatable:!0,vdomAttribute:!0,vdomXlink:!0,vdomClass:!0,vdomFunctional:!0,vdomKey:!0,vdomListener:!0,vdomRef:!0,vdomPropOrAttr:!0,vdomRender:!0,vdomStyle:!0,vdomText:!0,watchCallback:!0,taskQueue:!0,hotModuleReplacement:!1,isDebug:!1,isDev:!1,isTesting:!1,hydrateServerSide:!1,hydrateClientSide:!1,lifecycleDOMEvents:!1,lazyLoad:!1,profile:!1,slotRelocation:!0,appendChildSlotFix:!1,cloneNodeFix:!1,hydratedAttribute:!1,hydratedClass:!0,safari10:!1,scriptDataOpts:!1,scopedSlotTextContentFix:!1,shadowDomShim:!1,slotChildNodesFix:!1,invisiblePrehydration:!0,propBoolean:!0,propNumber:!0,propString:!0,cssVarShim:!1,constructableCSS:!0,cmpShouldUpdate:!0,devTools:!1,dynamicImportShim:!1,shadowDelegatesFocus:!0,initializeNextTick:!1,asyncLoading:!1,asyncQueue:!1,transformTagName:!1,attachStyles:!0};let RT,tge,X4,rge=!1,CN=!1,GW=!1,uu=!1,PQ=null,uz=!1;const CTt=t=>{const e=new URL(t,va.$resourcesUrl$);return e.origin!==hM.location.origin?e.href:e.pathname},p4e=t=>va.$resourcesUrl$=t,xw=(t,e="")=>()=>{},IQ="http://www.w3.org/1999/xlink",$Q={},f4e="http://www.w3.org/2000/svg",m4e="http://www.w3.org/1999/xhtml",g4e=t=>t!=null,jW=t=>(t=typeof t,t==="object"||t==="function"),ige=(t,e,...r)=>{let i=null,s=null,n=null,o=!1,a=!1;const l=[],c=p=>{for(let f=0;f<p.length;f++)i=p[f],Array.isArray(i)?c(i):i!=null&&typeof i!="boolean"&&((o=typeof t!="function"&&!jW(i))&&(i=String(i)),o&&a?l[l.length-1].$text$+=i:l.push(o?AN(null,i):i),a=o)};if(c(r),e){e.key&&(s=e.key),e.name&&(n=e.name);{const p=e.className||e.class;p&&(e.class=typeof p!="object"?p:Object.keys(p).filter(f=>p[f]).join(" "))}}if(typeof t=="function")return t(e===null?{}:e,l,v4e);const h=AN(t,null);return h.$attrs$=e,l.length>0&&(h.$children$=l),h.$key$=s,h.$name$=n,h},AN=(t,e)=>{const r={$flags$:0,$tag$:t,$text$:e,$elm$:null,$children$:null};return r.$attrs$=null,r.$key$=null,r.$name$=null,r},y4e={},_4e=t=>t&&t.$tag$===y4e,v4e={forEach:(t,e)=>t.map(LQ).forEach(e),map:(t,e)=>t.map(LQ).map(e).map(b4e)},LQ=t=>({vattrs:t.$attrs$,vchildren:t.$children$,vkey:t.$key$,vname:t.$name$,vtag:t.$tag$,vtext:t.$text$}),b4e=t=>{if(typeof t.vtag=="function"){const r=Object.assign({},t.vattrs);return t.vkey&&(r.key=t.vkey),t.vname&&(r.name=t.vname),ige(t.vtag,r,...t.vchildren||[])}const e=AN(t.vtag,t.vtext);return e.$attrs$=t.vattrs,e.$children$=t.vchildren,e.$key$=t.vkey,e.$name$=t.vname,e},w4e=t=>X4e.map(e=>e(t)).find(e=>!!e),x4e=(t,e)=>t!=null&&!jW(t)?e&4?t==="false"?!1:t===""||!!t:e&2?parseFloat(t):e&1?String(t):t:t,T4e=t=>t,ATt=(t,e,r)=>{const i=T4e(t);return{emit:s=>S4e(i,e,{bubbles:!!(r&4),composed:!!(r&2),cancelable:!!(r&1),detail:s})}},S4e=(t,e,r)=>{const i=va.ce(e,r);return t.dispatchEvent(i),i},DQ=new WeakMap,E4e=(t,e,r)=>{let i=ON.get(t);J4e&&r?(i=i||new CSSStyleSheet,typeof i=="string"?i=e:i.replaceSync(e)):i=e,ON.set(t,i)},C4e=(t,e,r,i)=>{let s=sge(e,r);const n=ON.get(s);if(t=t.nodeType===11?t:Xf,n)if(typeof n=="string"){t=t.head||t;let o=DQ.get(t),a;o||DQ.set(t,o=new Set),o.has(s)||(a=Xf.createElement("style"),a.innerHTML=n,t.insertBefore(a,t.querySelector("link")),o&&o.add(s))}else t.adoptedStyleSheets.includes(n)||(t.adoptedStyleSheets=[...t.adoptedStyleSheets,n]);return s},A4e=t=>{const e=t.$cmpMeta$,r=t.$hostElement$,i=e.$flags$,s=xw("attachStyles",e.$tagName$),n=C4e(r.shadowRoot?r.shadowRoot:r.getRootNode(),e,t.$modeName$);i&10&&(r["s-sc"]=n,r.classList.add(n+"-h"),i&2&&r.classList.add(n+"-s")),s()},sge=(t,e)=>"sc-"+(e&&t.$flags$&32?t.$tagName$+"-"+e:t.$tagName$),NQ=(t,e,r,i,s,n)=>{if(r!==i){let o=VQ(t,e),a=e.toLowerCase();if(e==="class"){const l=t.classList,c=FQ(r),h=FQ(i);l.remove(...c.filter(p=>p&&!h.includes(p))),l.add(...h.filter(p=>p&&!c.includes(p)))}else if(e==="style"){for(const l in r)(!i||i[l]==null)&&(l.includes("-")?t.style.removeProperty(l):t.style[l]="");for(const l in i)(!r||i[l]!==r[l])&&(l.includes("-")?t.style.setProperty(l,i[l]):t.style[l]=i[l])}else if(e!=="key")if(e==="ref")i&&i(t);else if(!t.__lookupSetter__(e)&&e[0]==="o"&&e[1]==="n")e[2]==="-"?e=e.slice(3):VQ(hM,a)?e=a.slice(2):e=a[2]+e.slice(3),r&&va.rel(t,e,r,!1),i&&va.ael(t,e,i,!1);else{const l=jW(i);if((o||l&&i!==null)&&!s)try{if(t.tagName.includes("-"))t[e]=i;else{const h=i??"";e==="list"?o=!1:(r==null||t[e]!=h)&&(t[e]=h)}}catch{}let c=!1;a!==(a=a.replace(/^xlink\:?/,""))&&(e=a,c=!0),i==null||i===!1?(i!==!1||t.getAttribute(e)==="")&&(c?t.removeAttributeNS(IQ,e):t.removeAttribute(e)):(!o||n&4||s)&&!l&&(i=i===!0?"":i,c?t.setAttributeNS(IQ,e,i):t.setAttribute(e,i))}}},R4e=/\s/,FQ=t=>t?t.split(R4e):[],nge=(t,e,r,i)=>{const s=e.$elm$.nodeType===11&&e.$elm$.host?e.$elm$.host:e.$elm$,n=t&&t.$attrs$||$Q,o=e.$attrs$||$Q;for(i in n)i in o||NQ(s,i,n[i],void 0,r,e.$flags$);for(i in o)NQ(s,i,n[i],o[i],r,e.$flags$)},RN=(t,e,r,i)=>{const s=e.$children$[r];let n=0,o,a,l;if(rge||(GW=!0,s.$tag$==="slot"&&(RT&&i.classList.add(RT+"-s"),s.$flags$|=s.$children$?2:1)),s.$text$!==null)o=s.$elm$=Xf.createTextNode(s.$text$);else if(s.$flags$&1)o=s.$elm$=Xf.createTextNode("");else{if(uu||(uu=s.$tag$==="svg"),o=s.$elm$=Xf.createElementNS(uu?f4e:m4e,s.$flags$&2?"slot-fb":s.$tag$),uu&&s.$tag$==="foreignObject"&&(uu=!1),nge(null,s,uu),g4e(RT)&&o["s-si"]!==RT&&o.classList.add(o["s-si"]=RT),s.$children$)for(n=0;n<s.$children$.length;++n)a=RN(t,s,n,o),a&&o.appendChild(a);s.$tag$==="svg"?uu=!1:o.tagName==="foreignObject"&&(uu=!0)}return o["s-hn"]=X4,s.$flags$&3&&(o["s-sr"]=!0,o["s-cr"]=tge,o["s-sn"]=s.$name$||"",l=t&&t.$children$&&t.$children$[r],l&&l.$tag$===s.$tag$&&t.$elm$&&eO(t.$elm$,!1)),o},eO=(t,e)=>{va.$flags$|=1;const r=t.childNodes;for(let i=r.length-1;i>=0;i--){const s=r[i];s["s-hn"]!==X4&&s["s-ol"]&&(lge(s).insertBefore(s,HW(s)),s["s-ol"].remove(),s["s-ol"]=void 0,GW=!0),e&&eO(s,e)}va.$flags$&=-2},oge=(t,e,r,i,s,n)=>{let o=t["s-cr"]&&t["s-cr"].parentNode||t,a;for(o.shadowRoot&&o.tagName===X4&&(o=o.shadowRoot);s<=n;++s)i[s]&&(a=RN(null,r,s,t),a&&(i[s].$elm$=a,o.insertBefore(a,HW(e))))},age=(t,e,r,i,s)=>{for(;e<=r;++e)(i=t[e])&&(s=i.$elm$,hge(i),CN=!0,s["s-ol"]?s["s-ol"].remove():eO(s,!0),s.remove())},O4e=(t,e,r,i)=>{let s=0,n=0,o=0,a=0,l=e.length-1,c=e[0],h=e[l],p=i.length-1,f=i[0],m=i[p],y,_;for(;s<=l&&n<=p;)if(c==null)c=e[++s];else if(h==null)h=e[--l];else if(f==null)f=i[++n];else if(m==null)m=i[--p];else if(bP(c,f))OT(c,f),c=e[++s],f=i[++n];else if(bP(h,m))OT(h,m),h=e[--l],m=i[--p];else if(bP(c,m))(c.$tag$==="slot"||m.$tag$==="slot")&&eO(c.$elm$.parentNode,!1),OT(c,m),t.insertBefore(c.$elm$,h.$elm$.nextSibling),c=e[++s],m=i[--p];else if(bP(h,f))(c.$tag$==="slot"||m.$tag$==="slot")&&eO(h.$elm$.parentNode,!1),OT(h,f),t.insertBefore(h.$elm$,c.$elm$),h=e[--l],f=i[++n];else{for(o=-1,a=s;a<=l;++a)if(e[a]&&e[a].$key$!==null&&e[a].$key$===f.$key$){o=a;break}o>=0?(_=e[o],_.$tag$!==f.$tag$?y=RN(e&&e[n],r,o,t):(OT(_,f),e[o]=void 0,y=_.$elm$),f=i[++n]):(y=RN(e&&e[n],r,n,t),f=i[++n]),y&&lge(c.$elm$).insertBefore(y,HW(c.$elm$))}s>l?oge(t,i[p+1]==null?null:i[p+1].$elm$,r,i,n,p):n>p&&age(e,s,l)},bP=(t,e)=>t.$tag$===e.$tag$?t.$tag$==="slot"?t.$name$===e.$name$:t.$key$===e.$key$:!1,HW=t=>t&&t["s-ol"]||t,lge=t=>(t["s-ol"]?t["s-ol"]:t).parentNode,OT=(t,e)=>{const r=e.$elm$=t.$elm$,i=t.$children$,s=e.$children$,n=e.$tag$,o=e.$text$;let a;o===null?(uu=n==="svg"?!0:n==="foreignObject"?!1:uu,n==="slot"||nge(t,e,uu),i!==null&&s!==null?O4e(r,i,e,s):s!==null?(t.$text$!==null&&(r.textContent=""),oge(r,null,e,s,0,s.length-1)):i!==null&&age(i,0,i.length-1),uu&&n==="svg"&&(uu=!1)):(a=r["s-cr"])?a.parentNode.textContent=o:t.$text$!==o&&(r.data=o)},cge=t=>{const e=t.childNodes;let r,i,s,n,o,a;for(i=0,s=e.length;i<s;i++)if(r=e[i],r.nodeType===1){if(r["s-sr"]){for(o=r["s-sn"],r.hidden=!1,n=0;n<s;n++)if(a=e[n].nodeType,e[n]["s-hn"]!==r["s-hn"]||o!==""){if(a===1&&o===e[n].getAttribute("slot")){r.hidden=!0;break}}else if(a===1||a===3&&e[n].textContent.trim()!==""){r.hidden=!0;break}}cge(r)}},zd=[],uge=t=>{let e,r,i,s,n,o,a=0;const l=t.childNodes,c=l.length;for(;a<c;a++){if(e=l[a],e["s-sr"]&&(r=e["s-cr"])&&r.parentNode)for(i=r.parentNode.childNodes,s=e["s-sn"],o=i.length-1;o>=0;o--)r=i[o],!r["s-cn"]&&!r["s-nr"]&&r["s-hn"]!==e["s-hn"]&&(UQ(r,s)?(n=zd.find(h=>h.$nodeToRelocate$===r),CN=!0,r["s-sn"]=r["s-sn"]||s,n?n.$slotRefNode$=e:zd.push({$slotRefNode$:e,$nodeToRelocate$:r}),r["s-sr"]&&zd.map(h=>{UQ(h.$nodeToRelocate$,r["s-sn"])&&(n=zd.find(p=>p.$nodeToRelocate$===r),n&&!h.$slotRefNode$&&(h.$slotRefNode$=n.$slotRefNode$))})):zd.some(h=>h.$nodeToRelocate$===r)||zd.push({$nodeToRelocate$:r}));e.nodeType===1&&uge(e)}},UQ=(t,e)=>t.nodeType===1?t.getAttribute("slot")===null&&e===""||t.getAttribute("slot")===e:t["s-sn"]===e?!0:e==="",hge=t=>{t.$attrs$&&t.$attrs$.ref&&t.$attrs$.ref(null),t.$children$&&t.$children$.map(hge)},M4e=(t,e)=>{const r=t.$hostElement$,i=t.$cmpMeta$,s=t.$vnode$||AN(null,null),n=_4e(e)?e:ige(null,null,e);X4=r.tagName,i.$attrsToReflect$&&(n.$attrs$=n.$attrs$||{},i.$attrsToReflect$.map(([o,a])=>n.$attrs$[a]=r[o])),n.$tag$=null,n.$flags$|=4,t.$vnode$=n,n.$elm$=s.$elm$=r.shadowRoot||r,RT=r["s-sc"],tge=r["s-cr"],rge=(i.$flags$&1)!==0,CN=!1,OT(s,n);{if(va.$flags$|=1,GW){uge(n.$elm$);let o,a,l,c,h,p,f=0;for(;f<zd.length;f++)o=zd[f],a=o.$nodeToRelocate$,a["s-ol"]||(l=Xf.createTextNode(""),l["s-nr"]=a,a.parentNode.insertBefore(a["s-ol"]=l,a));for(f=0;f<zd.length;f++)if(o=zd[f],a=o.$nodeToRelocate$,o.$slotRefNode$){for(c=o.$slotRefNode$.parentNode,h=o.$slotRefNode$.nextSibling,l=a["s-ol"];l=l.previousSibling;)if(p=l["s-nr"],p&&p["s-sn"]===a["s-sn"]&&c===p.parentNode&&(p=p.nextSibling,!p||!p["s-nr"])){h=p;break}(!h&&c!==a.parentNode||a.nextSibling!==h)&&a!==h&&(!a["s-hn"]&&a["s-ol"]&&(a["s-hn"]=a["s-ol"].parentNode.nodeName),c.insertBefore(a,h))}else a.nodeType===1&&(a.hidden=!0)}CN&&cge(n.$elm$),va.$flags$&=-2,zd.length=0}},P4e=(t,e)=>{},qW=(t,e)=>(t.$flags$|=16,P4e(t,t.$ancestorComponent$),e5e(()=>I4e(t,e))),I4e=(t,e)=>{const r=t.$hostElement$,i=xw("scheduleUpdate",t.$cmpMeta$.$tagName$),s=r;let n;return e?n=W2(s,"componentWillLoad"):n=W2(s,"componentWillUpdate"),n=kQ(n,()=>W2(s,"componentWillRender")),i(),kQ(n,()=>$4e(t,s,e))},$4e=async(t,e,r)=>{const i=t.$hostElement$,s=xw("update",t.$cmpMeta$.$tagName$);i["s-rc"],r&&A4e(t);const n=xw("render",t.$cmpMeta$.$tagName$);L4e(t,e,i),n(),s(),D4e(t)},L4e=(t,e,r)=>{try{PQ=e,e=e.render&&e.render(),t.$flags$&=-17,t.$flags$|=2,(AT.hasRenderFn||AT.reflect)&&(AT.vdomRender||AT.reflect)&&(AT.hydrateServerSide||M4e(t,e))}catch(a){uM(a,t.$hostElement$)}return PQ=null,null},D4e=t=>{const e=t.$cmpMeta$.$tagName$,r=t.$hostElement$,i=xw("postUpdate",e),s=r;t.$ancestorComponent$,W2(s,"componentDidRender"),t.$flags$&64?(W2(s,"componentDidUpdate"),i()):(t.$flags$|=64,W2(s,"componentDidLoad"),i())},RTt=t=>{{const e=cM(t),r=e.$hostElement$.isConnected;return r&&(e.$flags$&18)===2&&qW(e,!1),r}},W2=(t,e,r)=>{if(t&&t[e])try{return t[e](r)}catch(i){uM(i)}},kQ=(t,e)=>t&&t.then?t.then(e):e(),N4e=(t,e)=>cM(t).$instanceValues$.get(e),F4e=(t,e,r,i)=>{const s=cM(t),n=t,o=s.$instanceValues$.get(e),a=s.$flags$,l=n;r=x4e(r,i.$members$[e][0]);const c=Number.isNaN(o)&&Number.isNaN(r);if(r!==o&&!c){s.$instanceValues$.set(e,r);{if(i.$watchers$&&a&128){const p=i.$watchers$[e];p&&p.map(f=>{try{l[f](r,o,e)}catch(m){uM(m,n)}})}if((a&18)===2){if(l.componentShouldUpdate&&l.componentShouldUpdate(r,o,e)===!1)return;qW(s,!1)}}}},U4e=(t,e,r)=>{if(e.$members$){t.watchers&&(e.$watchers$=t.watchers);const i=Object.entries(e.$members$),s=t.prototype;i.map(([n,[o]])=>{(o&31||o&32)&&Object.defineProperty(s,n,{get(){return N4e(this,n)},set(a){F4e(this,n,a,e)},configurable:!0,enumerable:!0})});{const n=new Map;s.attributeChangedCallback=function(o,a,l){va.jmp(()=>{const c=n.get(o);if(this.hasOwnProperty(c))l=this[c],delete this[c];else if(s.hasOwnProperty(c)&&typeof this[c]=="number"&&this[c]==l)return;this[c]=l===null&&typeof this[c]=="boolean"?!1:l})},t.observedAttributes=i.filter(([o,a])=>a[0]&15).map(([o,a])=>{const l=a[1]||o;return n.set(l,o),a[0]&512&&e.$attrsToReflect$.push([o,l]),l})}}return t},k4e=async(t,e,r,i,s)=>{if(!(e.$flags$&32)&&(s=t.constructor,e.$flags$|=32,customElements.whenDefined(r.$tagName$).then(()=>e.$flags$|=128),s.style)){let o=s.style;typeof o!="string"&&(o=o[e.$modeName$=w4e(t)]);const a=sge(r,e.$modeName$);if(!ON.has(a)){const l=xw("registerStyles",r.$tagName$);E4e(a,o,!!(r.$flags$&1)),l()}}e.$ancestorComponent$,(()=>qW(e,!0))()},V4e=t=>{},B4e=t=>{if(!(va.$flags$&1)){const e=cM(t),r=e.$cmpMeta$,i=xw("connectedCallback",r.$tagName$);e.$flags$&1?(dge(t,e,r.$listeners$),V4e(e.$lazyInstance$)):(e.$flags$|=1,r.$flags$&12&&z4e(t),r.$members$&&Object.entries(r.$members$).map(([s,[n]])=>{if(n&31&&t.hasOwnProperty(s)){const o=t[s];delete t[s],t[s]=o}}),k4e(t,e,r)),i()}},z4e=t=>{const e=t["s-cr"]=Xf.createComment("");e["s-cn"]=!0,t.insertBefore(e,t.firstChild)},G4e=t=>{if(!(va.$flags$&1)){const e=cM(t);e.$rmListeners$&&(e.$rmListeners$.map(r=>r()),e.$rmListeners$=void 0)}},OTt=(t,e)=>{const r={$flags$:e[0],$tagName$:e[1]};r.$members$=e[2],r.$listeners$=e[3],r.$watchers$=t.$watchers$,r.$attrsToReflect$=[];const i=t.prototype.connectedCallback,s=t.prototype.disconnectedCallback;return Object.assign(t.prototype,{__registerHost(){W4e(this,r)},connectedCallback(){B4e(this),i&&i.call(this)},disconnectedCallback(){G4e(this),s&&s.call(this)},__attachShadow(){this.attachShadow({mode:"open",delegatesFocus:!!(r.$flags$&16)})}}),t.is=r.$tagName$,U4e(t,r)},MTt=(t,e)=>e,dge=(t,e,r,i)=>{r&&r.map(([s,n,o])=>{const a=H4e(t,s),l=j4e(e,o),c=q4e(s);va.ael(a,n,l,c),(e.$rmListeners$=e.$rmListeners$||[]).push(()=>va.rel(a,n,l,c))})},j4e=(t,e)=>r=>{try{AT.lazyLoad||t.$hostElement$[e](r)}catch(i){uM(i)}},H4e=(t,e)=>e&4?Xf:e&8?hM:e&16?Xf.body:t,q4e=t=>Y4e?{passive:(t&1)!==0,capture:(t&2)!==0}:(t&2)!==0,pge=new WeakMap,cM=t=>pge.get(t),W4e=(t,e)=>{const r={$flags$:0,$hostElement$:t,$cmpMeta$:e,$instanceValues$:new Map};return dge(t,r,e.$listeners$),pge.set(t,r)},VQ=(t,e)=>e in t,uM=(t,e)=>(0,console.error)(t,e),ON=new Map,X4e=[],hM=typeof window<"u"?window:{},Xf=hM.document||{head:{}},PTt=hM.HTMLElement||class{},va={$flags$:0,$resourcesUrl$:"",jmp:t=>t(),raf:t=>requestAnimationFrame(t),ael:(t,e,r,i)=>t.addEventListener(e,r,i),rel:(t,e,r,i)=>t.removeEventListener(e,r,i),ce:(t,e)=>new CustomEvent(t,e)},Y4e=(()=>{let t=!1;try{Xf.addEventListener("e",null,Object.defineProperty({},"passive",{get(){t=!0}}))}catch{}return t})(),Z4e=t=>Promise.resolve(t),J4e=(()=>{try{return new CSSStyleSheet,typeof new CSSStyleSheet().replaceSync=="function"}catch{}return!1})(),BQ=[],fge=[],K4e=(t,e)=>r=>{t.push(r),uz||(uz=!0,e&&va.$flags$&4?Q4e(hz):va.raf(hz))},zQ=t=>{for(let e=0;e<t.length;e++)try{t[e](performance.now())}catch(r){uM(r)}t.length=0},hz=()=>{zQ(BQ),zQ(fge),(uz=BQ.length>0)&&va.raf(hz)},Q4e=t=>Z4e().then(t),e5e=K4e(fge,!0);/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * See https://github.com/Esri/calcite-components/blob/master/LICENSE.md for details.
 * v1.0.8-next.4
 */const mge="calcite-mode-auto",gge="calcite-mode-dark",t5e="calcite-mode-light",ITt={autoMode:mge,darkMode:gge,lightMode:t5e,rtl:"calcite--rtl"};/*!
* tabbable 6.0.1
* @license MIT, https://github.com/focus-trap/tabbable/blob/master/LICENSE
*/var yge=["input","select","textarea","a[href]","button","[tabindex]:not(slot)","audio[controls]","video[controls]",'[contenteditable]:not([contenteditable="false"])',"details>summary:first-of-type","details"],MN=yge.join(","),_ge=typeof Element>"u",Tw=_ge?function(){}:Element.prototype.matches||Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector,PN=!_ge&&Element.prototype.getRootNode?function(t){return t.getRootNode()}:function(t){return t.ownerDocument},vge=function(e,r,i){var s=Array.prototype.slice.apply(e.querySelectorAll(MN));return r&&Tw.call(e,MN)&&s.unshift(e),s=s.filter(i),s},bge=function t(e,r,i){for(var s=[],n=Array.from(e);n.length;){var o=n.shift();if(o.tagName==="SLOT"){var a=o.assignedElements(),l=a.length?a:o.children,c=t(l,!0,i);i.flatten?s.push.apply(s,c):s.push({scopeParent:o,candidates:c})}else{var h=Tw.call(o,MN);h&&i.filter(o)&&(r||!e.includes(o))&&s.push(o);var p=o.shadowRoot||typeof i.getShadowRoot=="function"&&i.getShadowRoot(o),f=!i.shadowRootFilter||i.shadowRootFilter(o);if(p&&f){var m=t(p===!0?o.children:p.children,!0,i);i.flatten?s.push.apply(s,m):s.push({scopeParent:o,candidates:m})}else n.unshift.apply(n,o.children)}}return s},wge=function(e,r){return e.tabIndex<0&&(r||/^(AUDIO|VIDEO|DETAILS)$/.test(e.tagName)||e.isContentEditable)&&isNaN(parseInt(e.getAttribute("tabindex"),10))?0:e.tabIndex},r5e=function(e,r){return e.tabIndex===r.tabIndex?e.documentOrder-r.documentOrder:e.tabIndex-r.tabIndex},xge=function(e){return e.tagName==="INPUT"},i5e=function(e){return xge(e)&&e.type==="hidden"},s5e=function(e){var r=e.tagName==="DETAILS"&&Array.prototype.slice.apply(e.children).some(function(i){return i.tagName==="SUMMARY"});return r},n5e=function(e,r){for(var i=0;i<e.length;i++)if(e[i].checked&&e[i].form===r)return e[i]},o5e=function(e){if(!e.name)return!0;var r=e.form||PN(e),i=function(a){return r.querySelectorAll('input[type="radio"][name="'+a+'"]')},s;if(typeof window<"u"&&typeof window.CSS<"u"&&typeof window.CSS.escape=="function")s=i(window.CSS.escape(e.name));else try{s=i(e.name)}catch(o){return console.error("Looks like you have a radio button with a name attribute containing invalid CSS selector characters and need the CSS.escape polyfill: %s",o.message),!1}var n=n5e(s,e.form);return!n||n===e},a5e=function(e){return xge(e)&&e.type==="radio"},l5e=function(e){return a5e(e)&&!o5e(e)},c5e=function(e){for(var r,i=PN(e).host,s=!!((r=i)!==null&&r!==void 0&&r.ownerDocument.contains(i)||e.ownerDocument.contains(e));!s&&i;){var n;i=PN(i).host,s=!!((n=i)!==null&&n!==void 0&&n.ownerDocument.contains(i))}return s},GQ=function(e){var r=e.getBoundingClientRect(),i=r.width,s=r.height;return i===0&&s===0},u5e=function(e,r){var i=r.displayCheck,s=r.getShadowRoot;if(getComputedStyle(e).visibility==="hidden")return!0;var n=Tw.call(e,"details>summary:first-of-type"),o=n?e.parentElement:e;if(Tw.call(o,"details:not([open]) *"))return!0;if(!i||i==="full"||i==="legacy-full"){if(typeof s=="function"){for(var a=e;e;){var l=e.parentElement,c=PN(e);if(l&&!l.shadowRoot&&s(l)===!0)return GQ(e);e.assignedSlot?e=e.assignedSlot:!l&&c!==e.ownerDocument?e=c.host:e=l}e=a}if(c5e(e))return!e.getClientRects().length;if(i!=="legacy-full")return!0}else if(i==="non-zero-area")return GQ(e);return!1},h5e=function(e){if(/^(INPUT|BUTTON|SELECT|TEXTAREA)$/.test(e.tagName))for(var r=e.parentElement;r;){if(r.tagName==="FIELDSET"&&r.disabled){for(var i=0;i<r.children.length;i++){var s=r.children.item(i);if(s.tagName==="LEGEND")return Tw.call(r,"fieldset[disabled] *")?!0:!s.contains(e)}return!0}r=r.parentElement}return!1},IN=function(e,r){return!(r.disabled||i5e(r)||u5e(r,e)||s5e(r)||h5e(r))},dz=function(e,r){return!(l5e(r)||wge(r)<0||!IN(e,r))},d5e=function(e){var r=parseInt(e.getAttribute("tabindex"),10);return!!(isNaN(r)||r>=0)},p5e=function t(e){var r=[],i=[];return e.forEach(function(s,n){var o=!!s.scopeParent,a=o?s.scopeParent:s,l=wge(a,o),c=o?t(s.candidates):a;l===0?o?r.push.apply(r,c):r.push(a):i.push({documentOrder:n,tabIndex:l,item:s,isScope:o,content:c})}),i.sort(r5e).reduce(function(s,n){return n.isScope?s.push.apply(s,n.content):s.push(n.content),s},[]).concat(r)},f5e=function(e,r){r=r||{};var i;return r.getShadowRoot?i=bge([e],r.includeContainer,{filter:dz.bind(null,r),flatten:!1,getShadowRoot:r.getShadowRoot,shadowRootFilter:d5e}):i=vge(e,r.includeContainer,dz.bind(null,r)),p5e(i)},$Tt=function(e,r){r=r||{};var i;return r.getShadowRoot?i=bge([e],r.includeContainer,{filter:IN.bind(null,r),flatten:!0,getShadowRoot:r.getShadowRoot}):i=vge(e,r.includeContainer,IN.bind(null,r)),i},LTt=function(e,r){if(r=r||{},!e)throw new Error("No node provided");return Tw.call(e,MN)===!1?!1:dz(r,e)},m5e=yge.concat("iframe").join(","),DTt=function(e,r){if(r=r||{},!e)throw new Error("No node provided");return Tw.call(e,m5e)===!1?!1:IN(r,e)};const g5e={getShadowRoot:!0};function NTt(t){const e="dir",r=`[${e}]`,i=y5e(t,r);return i?i.getAttribute(e):"ltr"}function FTt(t,e,r){const i=`[${e}]`,s=t.closest(i);return s?s.getAttribute(e):r}function Tge(t){return t.getRootNode()}function Sge(t){return t.host||null}function UTt(t,{selector:e,id:r}){function i(s){if(!s)return null;s.assignedSlot&&(s=s.assignedSlot);const n=Tge(s),o=r?"getElementById"in n?n.getElementById(r):null:e?n.querySelector(e):null,a=Sge(n);return o||(a?i(a):null)}return i(t)}function y5e(t,e){function r(i){return i?i.closest(e)||r(Sge(Tge(i))):null}return r(t)}function _5e(t,e){return Ege(t,e)}function Ege(t,e){if(!t)return;const r=e(t);if(r!==void 0)return r;const{parentNode:i}=t;return Ege(i instanceof ShadowRoot?i.host:i,e)}function kTt(t,e){return!!_5e(e,r=>r===t?!0:void 0)}function v5e(t){return typeof(t==null?void 0:t.setFocus)=="function"}async function VTt(t){if(t)return v5e(t)?t.setFocus():t.focus()}function BTt(t){(f5e(t,g5e)[0]||t).focus()}const tO=":not([slot])";function zTt(t,e,r){e&&!Array.isArray(e)&&typeof e!="string"&&(r=e,e=null);const i=e?Array.isArray(e)?e.map(s=>`[slot="${s}"]`).join(","):`[slot="${e}"]`:tO;return r!=null&&r.all?b5e(t,i,r):w5e(t,i,r)}function Cge(t,e){return t?Array.from(t.children||[]).filter(r=>r==null?void 0:r.matches(e)):[]}function b5e(t,e,r){let i=e===tO?Cge(t,tO):Array.from(t.querySelectorAll(e));i=r&&r.direct===!1?i:i.filter(n=>n.parentElement===t),i=r!=null&&r.matches?i.filter(n=>n==null?void 0:n.matches(r.matches)):i;const s=r==null?void 0:r.selector;return s?i.map(n=>Array.from(n.querySelectorAll(s))).reduce((n,o)=>[...n,...o],[]).filter(n=>!!n):i}function w5e(t,e,r){let i=e===tO?Cge(t,tO)[0]||null:t.querySelector(e);i=r&&r.direct===!1||(i==null?void 0:i.parentElement)===t?i:null,i=r!=null&&r.matches?i!=null&&i.matches(r.matches)?i:null:i;const s=r==null?void 0:r.selector;return s?i==null?void 0:i.querySelector(s):i}function GTt(t,e,r){if(typeof e=="string"&&e!=="")return e;if(e==="")return t[r]}function jTt(t){return(!!t).toString()}function HTt(t){return!!x5e(t).length}function x5e(t){return t.target.assignedElements({flatten:!0})}function qTt(t){return!!(t.isPrimary&&t.button===0)}/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * See https://github.com/Esri/calcite-components/blob/master/LICENSE.md for details.
 * v1.0.8-next.4
 */function jQ(){const{classList:t}=document.body,e=window.matchMedia("(prefers-color-scheme: dark)").matches,r=()=>t.contains(gge)||t.contains(mge)&&e?"dark":"light",i=o=>document.body.dispatchEvent(new CustomEvent("calciteModeChange",{bubbles:!0,detail:{mode:o}})),s=o=>{n!==o&&i(o),n=o};let n=r();i(n),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",o=>s(o.matches?"dark":"light")),new MutationObserver(()=>s(r())).observe(document.body,{attributes:!0,attributeFilter:["class"]})}function T5e(){typeof window<"u"&&typeof location<"u"&&typeof document<"u"&&window.location===location&&window.document===document&&(document.readyState==="interactive"?jQ():document.addEventListener("DOMContentLoaded",()=>jQ(),{once:!0}))}const S5e=T5e;S5e();let Age;function E5e(){p4e(wu(Wr(Age)))}Age="components/assets";const Rge=Symbol("widget"),C5e=Symbol("widget-test-data"),A5e=[],R5e={},$N=new WeakMap;function Oge(t,e){let r=e.children;if(r&&r.length)for(let s=0;s<r.length;++s)r[s]=Oge(t,r[s]);else r=A5e;const i=e.vnodeSelector;if(WW(i)){const s=e.properties||R5e,n=s.key||i;return{vnodeSelector:"div",properties:{key:n,afterCreate:O5e,afterUpdate:M5e,afterRemoved:Mge,parentWidget:t,widgetConstructor:i,widgetProperties:{...s,key:n,children:r}},children:void 0,text:void 0,domNode:null}}return e}function O5e(t,e,r,{parentWidget:i,widgetConstructor:s,widgetProperties:n}){var a;const o=new s(n);o.container=t,$N.set(t,o),(a=o.afterCreate)==null||a.call(o,o,t),i._internalHandles.add(cp(()=>Mge(t)))}function M5e(t,e,r,{widgetProperties:i}){var n;const s=$N.get(t);s&&(s.set(i),(n=s.afterUpdate)==null||n.call(s,s,t))}function Mge(t){var r;const e=$N.get(t);e&&((r=e.afterRemoved)==null||r.call(e,e,t),e.destroy(),$N.delete(t))}function WW(t){return typeof t=="function"&&t[Rge]}const HQ=new Set;function P5e(t){HQ.add(t),t.finally(()=>HQ.delete(t))}var Pge;const I5e="esri.widgets.Widget";let $5e=0;const L5e={widgetIcon:"esri-icon-checkbox-unchecked"};function Ige(t,e){for(const r in e)t[r]!=null&&(typeof t[r]=="object"&&typeof e[r]=="object"?Ige(t[r],e==null?void 0:e[r]):t[r]=e[r]);return t}const D5e=d4e({postProcessProjectionOptions(t){const e=t.eventHandlerInterceptor,r=/capture$/i;t.eventHandlerInterceptor=(i,s,n,o)=>{const a=e==null?void 0:e(i,s,n,o),l=r.test(i);if(!((i=i.replace(r,"")).toLowerCase()in n)||l){const c=i[2].toLowerCase()+i.slice(3),h=m=>a==null?void 0:a.call(n,m);n.addEventListener(c,h,l);const p=()=>n.removeEventListener(c,h,l),f=o.afterRemoved;o.afterRemoved=m=>{f==null||f(m),p()}}return a}},handleInterceptedEvent(t,e,r,i){const{eventPhase:s,type:n}=i,o=s===Event.CAPTURING_PHASE;let a=`on${n}${o?"capture":""}`;const l=e.properties;(l&&a in l||(a=`on${n[0].toUpperCase()}${n.slice(1)}${o?"Capture":""}`,l&&a in l))&&(jme(),t.scheduleRender(),l[a].call(l.bind||r,i))}});let oU=!1,mo=class extends a4(vs.EventedAccessor){constructor(e,r){super(e,r),this._attached=!1,this._internalHandles=new ei,this._projector=D5e,this._readyForTrueRender=!1,this.iconClass=L5e.widgetIcon,this.key=this,this._loadLocale=due(async()=>{if(this._messageBundleProps&&this._messageBundleProps.length){const o=await jl(this._messageBundleProps.map(async({bundlePath:a,propertyName:l})=>{let c=await Fhe(a);this.uiStrings&&Object.keys(this.uiStrings)&&(c=Ige(ne(c),this.uiStrings)),this[l]=c}));for(const a of o)a.error&&se.getLogger(this.declaredClass).error("widget-intl:locale-error",this.declaredClass,a.error)}await this.loadLocale()}),E5e();const i="esri-widget-uid-"+o4e(),s=this.render.bind(this);this._trackingTarget=new n4(()=>this.scheduleRender());const n=()=>{var p;if(!this._readyForTrueRender||this.destroyed)return null;if(!this.visible)return{vnodeSelector:"div",properties:{key:i,class:"",styles:{display:"none"}},domNode:null,children:void 0,text:void 0};const o=s();let{properties:a}=o;a||(o.properties=a={});let{key:l,styles:c}=a;l||(a.key=i),c||(a.styles=c={}),c.display||(c.display="");let h=0;return(p=o.children)==null||p.forEach(f=>{if(WW(f.vnodeSelector))return;let{properties:m}=f;m||(f.properties=m={}),m.key||(m.key=`${this.id}--${h++}`)}),Oge(this,o)};this.render=()=>{if(oU)return n();let o=UFe(this)??null;if(o)return o;this._trackingTarget.clear(),oU=!0;try{o=Yg(this._trackingTarget,n)}catch(a){throw console.error(a),a}finally{oU=!1}return o&&kFe(this,o),o},this.addResolvingPromise(this._resourcesFetch=this.beforeFirstRender().then(()=>{this._readyForTrueRender=!0,this._postInitialize()})),P5e(this._resourcesFetch)}normalizeCtorArgs(e,r){const i={...e};return r&&(i.container=r),i}postInitialize(){}beforeFirstRender(){return Promise.all([this.loadDependencies(),this._loadLocale()]).then(()=>{}).catch(Vk)}async loadDependencies(){}async loadLocale(){}destroy(){this.destroyed||(ke(this._trackingTarget),ke(this.viewModel),this._detach(this.container),this._set("container",null),this._internalHandles.destroy(),this._emitter.clear(),this.render=()=>null,this._projector=null,sU(this))}set container(e){this._get("container")||this._set("container",e)}castContainer(e){return M4(e)}get domNode(){return this.container}set domNode(e){this.container=e}get id(){return this._get("id")||this.get("container.id")||Date.now().toString(16)+"-widget-"+$5e++}set id(e){e&&this._set("id",e)}get label(){return this.declaredClass.split(".").pop()}set label(e){this._overrideIfSome("label",e)}get renderable(){return this._resourcesFetch}get visible(){return this._get("visible")}set visible(e){this._set("visible",e)}get[(Pge=Rge,C5e)](){return{projector:this._projector}}render(){throw new Error("not implemented")}scheduleRender(){this.destroyed||(sU(this),this._projector.scheduleRender())}classes(...e){return qme.apply(this,e)}renderNow(){sU(this),this._projector.renderNow()}_postInitialize(){var r;if(this.destroyed)return;this.scheduleRender(),(r=this._delegatedEventNames)!=null&&r.length&&this._internalHandles.add(ie(()=>this.viewModel,(i,s)=>{s&&this._internalHandles.remove("delegated-events"),i&&i4(i)&&this._internalHandles.add(this._delegatedEventNames.map(n=>qO(i,n,o=>{this.emit(n,o)})),"delegated-events")},Vt)),this.postInitialize();const e=async()=>{await this._loadLocale().catch(Vk),this.scheduleRender()};this._internalHandles.add([Dhe(e),ie(()=>this.uiStrings,e),_a(()=>this.container,i=>{this.destroyed||this._attach(i)},{initial:!0,once:!0})])}_attach(e){e&&(this._projector.merge(e,this.render),this._attached=!0)}_detach(e){var r;this._attached&&(this._projector.detach(this.render),this._attached=!1),(r=e==null?void 0:e.parentNode)==null||r.removeChild(e)}};mo[Pge]=!0,u([d()],mo.prototype,"_readyForTrueRender",void 0),u([d({value:null})],mo.prototype,"container",null),u([cr("container")],mo.prototype,"castContainer",null),u([d()],mo.prototype,"iconClass",void 0),u([d()],mo.prototype,"id",null),u([d()],mo.prototype,"label",null),u([d()],mo.prototype,"renderable",null),u([d()],mo.prototype,"uiStrings",void 0),u([d()],mo.prototype,"viewModel",void 0),u([d({value:!0})],mo.prototype,"visible",null),u([d()],mo.prototype,"key",void 0),u([d()],mo.prototype,"children",void 0),u([d()],mo.prototype,"afterCreate",void 0),u([d()],mo.prototype,"afterUpdate",void 0),u([d()],mo.prototype,"afterRemoved",void 0),mo=u([I(I5e)],mo);const Ea=mo;function N5e(t,e,r){return t.units[e][r]}function Y4(t,e,r,i=2,s="abbr"){return`${om(e,{minimumFractionDigits:i,maximumFractionDigits:i,signDisplay:e>0?"never":"exceptZero"})} ${N5e(t,r,s)}`}function XTt(t,e,r,i=2,s="abbr"){const n=ghe(e,r);return Y4(t,gn(e,r,n),n,i,s)}function YTt(t,e,r,i=2,s="abbr"){const n=yhe(e,r);return Y4(t,gn(e,r,n),n,i,s)}function ZTt(t,e,r,i=2,s="abbr"){const n=_he(e,r);return Y4(t,gn(e,r,n),n,i,s)}function JTt(t,e,r,i=2,s="abbr"){const n=vhe(e,r);return Y4(t,gn(e,r,n),n,i,s)}const qQ=["B","kB","MB","GB","TB"];function F5e(t,e){let r=e===0?0:Math.floor(Math.log(e)/Math.log(US.KILOBYTES));r=ge(r,0,qQ.length-1);const i=om(e/US.KILOBYTES**r,{maximumFractionDigits:2});return tm(t.units.bytes[qQ[r]],{fileSize:i})}function U5e(t){const{exifInfo:e,exifName:r,tagName:i}=t;if(!e||!r||!i)return null;const s=e.find(n=>n.name===r);return s?k5e({tagName:i,tags:s.tags}):null}function k5e(t){const{tagName:e,tags:r}=t;if(!r||!e)return null;const i=r.find(s=>s.name===e);return i&&i.value||null}var pz;const V5e={1:{id:1,rotation:0,mirrored:!1},2:{id:2,rotation:0,mirrored:!0},3:{id:3,rotation:180,mirrored:!1},4:{id:4,rotation:180,mirrored:!0},5:{id:5,rotation:-90,mirrored:!0},6:{id:6,rotation:90,mirrored:!1},7:{id:7,rotation:90,mirrored:!0},8:{id:8,rotation:-90,mirrored:!1}};let sc=pz=class extends ve{constructor(t){super(t),this.contentType=null,this.exifInfo=null,this.id=null,this.globalId=null,this.keywords=null,this.name=null,this.parentGlobalId=null,this.parentObjectId=null,this.size=null,this.url=null}get orientationInfo(){const{exifInfo:t}=this,e=U5e({exifName:"Exif IFD0",tagName:"Orientation",exifInfo:t});return V5e[e]||null}clone(){return new pz({contentType:this.contentType,exifInfo:this.exifInfo,id:this.id,globalId:this.globalId,keywords:this.keywords,name:this.name,parentGlobalId:this.parentGlobalId,parentObjectId:this.parentObjectId,size:this.size,url:this.url})}};u([d({type:String})],sc.prototype,"contentType",void 0),u([d()],sc.prototype,"exifInfo",void 0),u([d({readOnly:!0})],sc.prototype,"orientationInfo",null),u([d({type:Gi})],sc.prototype,"id",void 0),u([d({type:String})],sc.prototype,"globalId",void 0),u([d({type:String})],sc.prototype,"keywords",void 0),u([d({type:String})],sc.prototype,"name",void 0),u([d({json:{read:!1}})],sc.prototype,"parentGlobalId",void 0),u([d({json:{read:!1}})],sc.prototype,"parentObjectId",void 0),u([d({type:Gi})],sc.prototype,"size",void 0),u([d({json:{read:!1}})],sc.prototype,"url",void 0),sc=pz=u([I("esri.layers.support.AttachmentInfo")],sc);const B5e=sc;var fz;let ko=fz=class extends ve{constructor(t){super(t),this.attachmentTypes=null,this.attachmentsWhere=null,this.cacheHint=void 0,this.keywords=null,this.globalIds=null,this.name=null,this.num=null,this.objectIds=null,this.returnMetadata=!1,this.size=null,this.start=null,this.where=null}writeStart(t,e){e.resultOffset=this.start,e.resultRecordCount=this.num||10}clone(){return new fz(ne({attachmentTypes:this.attachmentTypes,attachmentsWhere:this.attachmentsWhere,cacheHint:this.cacheHint,keywords:this.keywords,where:this.where,globalIds:this.globalIds,name:this.name,num:this.num,objectIds:this.objectIds,returnMetadata:this.returnMetadata,size:this.size,start:this.start}))}};u([d({type:[String],json:{write:!0}})],ko.prototype,"attachmentTypes",void 0),u([d({type:String,json:{read:{source:"attachmentsDefinitionExpression"},write:{target:"attachmentsDefinitionExpression"}}})],ko.prototype,"attachmentsWhere",void 0),u([d({type:Boolean,json:{write:!0}})],ko.prototype,"cacheHint",void 0),u([d({type:[String],json:{write:!0}})],ko.prototype,"keywords",void 0),u([d({type:[Number],json:{write:!0}})],ko.prototype,"globalIds",void 0),u([d({json:{write:!0}})],ko.prototype,"name",void 0),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],ko.prototype,"num",void 0),u([d({type:[Number],json:{write:!0}})],ko.prototype,"objectIds",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],ko.prototype,"returnMetadata",void 0),u([d({type:[Number],json:{write:!0}})],ko.prototype,"size",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],ko.prototype,"start",void 0),u([He("start"),He("num")],ko.prototype,"writeStart",null),u([d({type:String,json:{read:{source:"definitionExpression"},write:{target:"definitionExpression"}}})],ko.prototype,"where",void 0),ko=fz=u([I("esri.rest.support.AttachmentQuery")],ko),ko.from=us(ko);const mz=ko,z5e="esri.widgets.Feature.support.featureUtils",WQ=se.getLogger(z5e),G5e=/href=(""|'')/gi,j5e=/(\{([^\{\r\n]+)\})/g,H5e=/\'/g,$ge=/^\s*expression\//i,q5e=/(\n)/gi,W5e=/[\u00A0-\u9999<>\&]/gim,X5e=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,Y5e=/^(?:mailto:|tel:)/,Lge="relationships/",gz=g4("short-date-short-time");function Dge(t){if(!C(t))return t.get("sourceLayer")||t.get("layer")}async function LN(t,e){return typeof t=="function"?t.call(null,e):t}function Nge(t=""){if(t)return!Y5e.test(t.trim().toLowerCase())}function XW(t){return!!t&&$ge.test(t)}function Z5e(t,e){if(!XW(e)||!t)return null;const r=e.replace($ge,"").toLowerCase();let i=null;return t.some(s=>s.name.toLowerCase()===r&&(i=s,!0)),i}function Fge(t,e){const r=Z5e(e,t==null?void 0:t.fieldName);return r?r.title||null:t?t.label||t.fieldName:null}function J5e(t,e){const r=e.get(t.toLowerCase());return`{${r&&r.fieldName||t}}`}function K5e(t){return t.replace(G5e,"")}function rO(t,e){const r=YW(e,t);return r?r.name:t}function Q5e(t,e){return t&&t.map(r=>rO(r,e))}function YW(t,e){return t&&typeof t.getField=="function"&&e?t.getField(e)??null:null}function Uge(t){return`${t}`.trim()}function Nb({attributes:t,globalAttributes:e,layer:r,text:i,expressionAttributes:s,fieldInfoMap:n}){return i?yz({formattedAttributes:e,template:i6e(i,{...e,...s,...t},r),fieldInfoMap:n}):""}function yz({formattedAttributes:t,template:e,fieldInfoMap:r}){return Uge(K5e(tm(tm(e,i=>J5e(i,r)),t)))}function e6e(t,e,r=!1){const i=e[t];if(typeof i=="string"){const s="%27",n=(r?encodeURIComponent(i):i).replace(H5e,s);e[t]=n}}function t6e(t,e=!1){const r={...t};return Object.keys(r).forEach(i=>e6e(i,r,e)),r}function r6e(t,e,r){const i=(e=Uge(e))&&e[0]!=="{";return tm(t,t6e(r,i||!1))}function _z(t,e){return t.replace(j5e,(r,i,s)=>{const n=YW(e,s);return n?`{${n.name}}`:i})}function i6e(t,e,r){const i=_z(t,r);return i&&i.replace(X5e,(s,n,o)=>r6e(s,n||o,e))}function s6e(t,e){if(typeof t=="string"&&e&&e.dateFormat==null&&(e.places!=null||e.digitSeparator!=null)){const r=Number(t);if(!isNaN(r))return r}return t}function n6e(t){return(t==null?void 0:t.type)==="feature"}function XQ(t){return!!(t!=null&&t.layer)}function o6e(t){return(t==null?void 0:t.type)==="map-image"}function a6e(t,e){var c;const r=e.fieldInfos,i=e.fieldName,s=(c=kge(r,i))==null?void 0:c.clone(),n=e.preventPlacesFormatting,o=e.layer,a=YW(o,i);if(s&&(a==null?void 0:a.type)==="date"){const h=s.format||new v2;h.dateFormat=h.dateFormat||"short-date-short-time",h.dateTimeFormatOptions=!XQ(o)&&n6e(o)&&o.datesInUnknownTimezone||XQ(o)&&o6e(o.layer)&&o.layer.datesInUnknownTimezone?{timeZone:"UTC"}:null,s.format=h}const l=s&&s.format;return typeof t=="string"&&kde(i)&&l?l.formatRasterPixelValue(t):typeof(t=s6e(t,l))=="string"||t==null||l==null?dM(t):n?om(t,{...Gde(l),minimumFractionDigits:0,maximumFractionDigits:20}):l.format(t)}function kge(t,e){if(!t||!t.length||!e)return;const r=e.toLowerCase();let i;return t.some(s=>!(!s.fieldName||s.fieldName.toLowerCase()!==r)&&(i=s,!0)),i}function l6e({fieldName:t,graphic:e,layer:r}){if($g(t)||!r||typeof r.getFeatureType!="function")return null;const{typeIdField:i}=r;if(!i||t!==i)return null;const s=r.getFeatureType(e);return s?s.name:null}function c6e({fieldName:t,value:e,graphic:r,layer:i}){if($g(t)||!i||typeof i.getFieldDomain!="function")return null;const s=r&&i.getFieldDomain(t,{feature:r});return s&&s.type==="coded-value"?s.getName(e):null}function u6e(t,e){const{creatorField:r,creationDateField:i,editorField:s,editDateField:n}=t;if(!e)return;const o=e[n];if(typeof o=="number"){const l=e[s];return{type:"edit",date:nm(o,gz),user:l}}const a=e[i];if(typeof a=="number"){const l=e[r];return{type:"create",date:nm(a,gz),user:l}}return null}function h6e(t,e){const r=new Map;return t&&t.forEach(i=>{const s=rO(i.fieldName,e);i.fieldName=s,r.set(s.toLowerCase(),i)}),r}function YQ(t){const e=[];if(!t)return e;const{fieldInfos:r,content:i}=t;return r&&e.push(...r),i&&Array.isArray(i)&&i.forEach(s=>{if(s.type==="fields"){const n=s&&s.fieldInfos;n&&e.push(...n)}}),e}function ZW(t){return t.replace(W5e,e=>`&#${e.charCodeAt(0)};`)}function dM(t){return typeof t=="string"?t.replace(q5e,'<br class="esri-text-new-line" />'):t}function Vge(t){const{value:e,fieldName:r,fieldInfos:i,fieldInfoMap:s,layer:n,graphic:o}=t;if(e==null)return"";const a=c6e({fieldName:r,value:e,graphic:o,layer:n});if(a)return a;const l=l6e({fieldName:r,graphic:o,layer:n});if(l)return l;if(s.get(r.toLowerCase()))return a6e(e,{fieldInfos:i||Array.from(s.values()),fieldName:r,layer:n});const c=n&&n.fieldsIndex;return c&&c.isDateField(r)?nm(e,gz):dM(e)}function aU({fieldInfos:t,attributes:e,layer:r,graphic:i,fieldInfoMap:s,relatedInfos:n}){const o={};return n==null||n.forEach(a=>m6e({attributes:o,relatedInfo:a,fieldInfoMap:s,fieldInfos:t,layer:r})),e&&Object.keys(e).forEach(a=>{const l=e[a];o[a]=Vge({fieldName:a,fieldInfos:t,fieldInfoMap:s,layer:r,value:l,graphic:i})}),o}async function Bge(t,e){var h,p;const{layer:r,graphic:i,outFields:s,objectIds:n,returnGeometry:o,spatialReference:a}=t,l=n[0];if(typeof l!="number"&&typeof l!="string"){const f="Could not query required fields for the specified feature. The feature's ID is invalid.",m={layer:r,graphic:i,objectId:l,requiredFields:s};return WQ.warn(f,m),null}if(!((p=(h=zhe(r))==null?void 0:h.operations)!=null&&p.supportsQuery)){const f="The specified layer cannot be queried. The following fields will not be available.",m={layer:r,graphic:i,requiredFields:s,returnGeometry:o};return WQ.warn(f,m),null}const c=r.createQuery();return c.objectIds=n,c.outFields=s!=null&&s.length?s:[r.objectIdField],c.returnGeometry=!!o,c.returnZ=!!o,c.returnM=!!o,c.outSpatialReference=a,(await r.queryFeatures(c,e)).features[0]}async function d6e(t){var i;if(!((i=t.expressionInfos)!=null&&i.length))return!1;const e=await sm(),{arcadeUtils:{hasGeometryFunctions:r}}=e;return r(t)}async function p6e({graphic:t,popupTemplate:e,layer:r,spatialReference:i},s){if(!r||!e||(typeof r.load=="function"&&await r.load(s),!t.attributes))return;const n=t.attributes[r.objectIdField];if(n==null)return;const o=[n],a=await e.getRequiredFields(r.fieldsIndex),l=UIe(a,t),c=l?[]:a,h=e.returnGeometry||await d6e(e);if(l&&!h)return;const p=await Bge({layer:r,graphic:t,outFields:c,objectIds:o,returnGeometry:h,spatialReference:i},s);p&&(p.geometry&&(t.geometry=p.geometry),p.attributes&&(t.attributes={...t.attributes,...p.attributes}))}function $g(t=""){return!!t&&t.includes(Lge)}function f6e(t){return t?`${Lge}${t.layerId}/${t.fieldName}`:""}function ZQ({attributes:t,graphic:e,relatedInfo:r,fieldInfos:i,fieldInfoMap:s,layer:n}){t&&e&&r&&Object.keys(e.attributes).forEach(o=>{const a=f6e({layerId:r.relation.id.toString(),fieldName:o}),l=e.attributes[o];t[a]=Vge({fieldName:a,fieldInfos:i,fieldInfoMap:s,layer:n,value:l,graphic:e})})}function m6e({attributes:t,relatedInfo:e,fieldInfoMap:r,fieldInfos:i,layer:s}){t&&e&&(e.relatedFeatures&&e.relatedFeatures&&e.relatedFeatures.forEach(n=>ZQ({attributes:t,graphic:n,relatedInfo:e,fieldInfoMap:r,fieldInfos:i,layer:s})),e.relatedStatsFeatures&&e.relatedStatsFeatures&&e.relatedStatsFeatures.forEach(n=>ZQ({attributes:t,graphic:n,relatedInfo:e,fieldInfoMap:r,fieldInfos:i,layer:s})))}const JQ=t=>{if(!t)return!1;const e=t.toUpperCase();return e.includes("CURRENT_TIMESTAMP")||e.includes("CURRENT_DATE")||e.includes("CURRENT_TIME")},zge=({layer:t,method:e,query:r,definitionExpression:i})=>{var o,a;if(!((a=(o=t.capabilities)==null?void 0:o.query)!=null&&a.supportsCacheHint)||e==="attachments")return;const s=v(r.where)?r.where:null,n=v(r.geometry)?r.geometry:null;JQ(i)||JQ(s)||(n==null?void 0:n.type)==="extent"||r.resultType==="tile"||(r.cacheHint=!0)},g6e=({query:t,layer:e,method:r})=>{zge({layer:e,method:r,query:t,definitionExpression:`${e.definitionExpression} ${e.serviceDefinitionExpression}`})},y6e=({queryPayload:t,layer:e,method:r})=>{zge({layer:e,method:r,query:t,definitionExpression:`${e.definitionExpression} ${e.serviceDefinitionExpression}`})};function _6e(t,e,r){return t&&e&&r?KQ(t.allLayers,e,r)||KQ(t.allTables,e,r):null}function KQ(t,e,r){return t.find(i=>i!==e&&i.type==="feature"&&i.url===e.url&&i.layerId===r.relatedTableId)}const QQ={editing:!1,operations:{add:!0,update:!0,delete:!0}},Gge=Pt.ofType(B5e);let nc=class extends Te{constructor(e){super(e),this._getAttachmentsPromise=null,this._attachmentLayer=null,this.abilities={...QQ},this.activeAttachmentInfo=null,this.activeFileInfo=null,this.attachmentInfos=new Gge,this.fileInfos=new Pt,this.graphic=null,this.mode="view",this.filesEnabled=!1,this.addHandles(ie(()=>this.graphic,()=>this._graphicChanged(),Vt))}destroy(){this._attachmentLayer=null,this.graphic=null}castAbilities(e){return{...QQ,...e}}get state(){return this._getAttachmentsPromise?"loading":this.graphic?"ready":"disabled"}get supportsResizeAttachments(){const{graphic:e}=this;if(!e)return!1;const r=e.layer||e.sourceLayer;return(r==null?void 0:r.loaded)&&"capabilities"in r&&r.capabilities&&"operations"in r.capabilities&&"supportsResizeAttachments"in r.capabilities.operations&&r.capabilities.operations.supportsResizeAttachments||!1}async getAttachments(){const{_attachmentLayer:e,attachmentInfos:r}=this;if(!e||typeof e.queryAttachments!="function")throw new q("invalid-layer","getAttachments(): A valid layer is required.");const i=this._getObjectId(),s=new mz({objectIds:[i],returnMetadata:!0}),n=[],o=e.queryAttachments(s).then(l=>l[i]||n).catch(()=>n);this._getAttachmentsPromise=o,this.notifyChange("state");const a=await o;return r.removeAll(),a.length&&r.addMany(a),this._getAttachmentsPromise=null,this.notifyChange("state"),a}async addAttachment(e,r=this.graphic){var l;const{_attachmentLayer:i,attachmentInfos:s,abilities:n}=this;if(!r)throw new q("invalid-graphic","addAttachment(): A valid graphic is required.",{graphic:r});if(!e)throw new q("invalid-attachment","addAttachment(): An attachment is required.",{attachment:e});if(!((l=n.operations)!=null&&l.add))throw new q("invalid-abilities","addAttachment(): add abilities are required.");if(!i||typeof i.addAttachment!="function")throw new q("invalid-layer","addAttachment(): A valid layer is required.");const o=i.addAttachment(r,e).then(c=>this._queryAttachment(c.objectId,r)),a=await o;return s.add(a),a}async deleteAttachment(e){var l;const{_attachmentLayer:r,attachmentInfos:i,graphic:s,abilities:n}=this;if(!e)throw new q("invalid-attachment-info","deleteAttachment(): An attachmentInfo is required.",{attachmentInfo:e});if(!((l=n.operations)!=null&&l.delete))throw new q("invalid-abilities","deleteAttachment(): delete abilities are required.");if(!r||typeof r.deleteAttachments!="function")throw new q("invalid-layer","deleteAttachment(): A valid layer is required.");if(!s)throw new q("invalid-graphic","deleteAttachment(): A graphic is required.");const o=r.deleteAttachments(s,[e.id]).then(()=>e),a=await o;return i.remove(a),a}async updateAttachment(e,r=this.activeAttachmentInfo){var h;const{_attachmentLayer:i,attachmentInfos:s,graphic:n,abilities:o}=this;if(!e)throw new q("invalid-attachment","updateAttachment(): An attachment is required.",{attachment:e});if(!r)throw new q("invalid-attachment-info","updateAttachment(): An attachmentInfo is required.",{attachmentInfo:r});if(!((h=o.operations)!=null&&h.update))throw new q("invalid-abilities","updateAttachment(): Update abilities are required.");const a=s.findIndex(p=>p===r);if(!i||typeof i.updateAttachment!="function")throw new q("invalid-layer","updateAttachment(): A valid layer is required.");if(!n)throw new q("invalid-graphic","updateAttachment(): A graphic is required.");const l=i.updateAttachment(n,r.id,e).then(p=>this._queryAttachment(p.objectId)),c=await l;return s.splice(a,1,c),c}async commitFiles(){return await Promise.all(this.fileInfos.items.map(e=>this.addAttachment(e.form))),this.fileInfos.removeAll(),this.getAttachments()}addFile(e,r){if(!e||!r)return null;const i={file:e,form:r};return this.fileInfos.add(i),i}updateFile(e,r,i=this.activeFileInfo){if(!e||!r||!i)return null;const s=this.fileInfos.findIndex(n=>i===n);return s>-1&&this.fileInfos.splice(s,1,{file:e,form:r}),this.fileInfos.items[s]}deleteFile(e){const r=this.fileInfos.find(i=>i.file===e);return r?(this.fileInfos.remove(r),r):null}async _queryAttachment(e,r){const{_attachmentLayer:i}=this;if(!e||!(i!=null&&i.queryAttachments))throw new q("invalid-attachment-id","Could not query attachment.");const s=this._getObjectId(r),n=new mz({objectIds:[s],attachmentsWhere:`AttachmentId=${e}`,returnMetadata:!0});return i.queryAttachments(n).then(o=>o[s][0])}_getObjectId(e=this.graphic){return(e==null?void 0:e.getObjectId())??null}_graphicChanged(){this.graphic&&(this._setAttachmentLayer(),this.getAttachments().catch(()=>{}))}_setAttachmentLayer(){const{graphic:e}=this,r=Dge(e);this._attachmentLayer=r?r.type==="scene"&&v(r.associatedLayer)?r.associatedLayer:r:null}};u([d()],nc.prototype,"abilities",void 0),u([cr("abilities")],nc.prototype,"castAbilities",null),u([d()],nc.prototype,"activeAttachmentInfo",void 0),u([d()],nc.prototype,"activeFileInfo",void 0),u([d({readOnly:!0,type:Gge})],nc.prototype,"attachmentInfos",void 0),u([d()],nc.prototype,"fileInfos",void 0),u([d({type:Io})],nc.prototype,"graphic",void 0),u([d()],nc.prototype,"mode",void 0),u([d({readOnly:!0})],nc.prototype,"state",null),u([d()],nc.prototype,"filesEnabled",void 0),u([d({readOnly:!0})],nc.prototype,"supportsResizeAttachments",null),nc=u([I("esri.widgets.Attachments.AttachmentsViewModel")],nc);const JW=nc;function eee(t){const e=t.toLowerCase();return e==="image/bmp"||e==="image/emf"||e==="image/exif"||e==="image/gif"||e==="image/x-icon"||e==="image/jpeg"||e==="image/png"||e==="image/tiff"||e==="image/x-wmf"}function v6e(t){const e=Wr("esri/themes/base/images/files/");return t?t==="text/plain"?`${e}text-32.svg`:t==="application/pdf"?`${e}pdf-32.svg`:t==="text/csv"?`${e}csv-32.svg`:t==="application/gpx+xml"?`${e}gpx-32.svg`:t==="application/x-dwf"?`${e}cad-32.svg`:t==="application/postscript"||t==="application/json"||t==="text/xml"||t==="model/vrml"?`${e}code-32.svg`:t==="application/x-zip-compressed"||t==="application/x-7z-compressed"||t==="application/x-gzip"||t==="application/x-tar"||t==="application/x-gtar"||t==="application/x-bzip2"||t==="application/gzip"||t==="application/x-compress"||t==="application/x-apple-diskimage"||t==="application/x-rar-compressed"||t==="application/zip"?`${e}zip-32.svg`:t.includes("image/")?`${e}image-32.svg`:t.includes("audio/")?`${e}sound-32.svg`:t.includes("video/")?`${e}video-32.svg`:t.includes("msexcel")||t.includes("ms-excel")||t.includes("spreadsheetml")?`${e}excel-32.svg`:t.includes("msword")||t.includes("ms-word")||t.includes("wordprocessingml")?`${e}word-32.svg`:t.includes("powerpoint")||t.includes("presentationml")?`${e}report-32.svg`:`${e}generic-32.svg`:`${e}generic-32.svg`}function ya(t){return(e,r)=>{e.hasOwnProperty("_messageBundleProps")||(e._messageBundleProps=e._messageBundleProps?e._messageBundleProps.slice():[]),e._messageBundleProps.push({bundlePath:t,propertyName:r})}}var b6e=function(t){return{vnodeSelector:"",properties:void 0,children:void 0,text:t.toString(),domNode:null}},jge=function(t,e){for(var r=0,i=t.length;r<i;r++){var s=t[r];Array.isArray(s)?jge(s,e):s!=null&&s!==!1&&(s.hasOwnProperty("vnodeSelector")||(s=b6e(s)),e.push(s))}},w6e=function(t,e){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];if(r.length===1&&typeof r[0]=="string")return{vnodeSelector:t,properties:e||void 0,children:void 0,text:r[0],domNode:null};var s=[];return jge(r,s),{vnodeSelector:t,properties:e||void 0,children:s,text:void 0,domNode:null}};function re(t,e,...r){return typeof t!="function"||WW(t)?w6e(t,e,...r):t(e,...r)}const tee={addButton:!0,addSubmitButton:!0,cancelAddButton:!0,cancelUpdateButton:!0,deleteButton:!0,errorMessage:!0,progressBar:!0,updateButton:!0},li="esri-attachments",Av="esri-button",qe={base:li,loaderContainer:`${li}__loader-container`,loader:`${li}__loader`,fadeIn:`${li}--fade-in`,container:`${li}__container`,containerList:`${li}__container--list`,containerPreview:`${li}__container--preview`,actions:`${li}__actions`,deleteButton:`${li}__delete-button`,addAttachmentButton:`${li}__add-attachment-button`,errorMessage:`${li}__error-message`,items:`${li}__items`,item:`${li}__item`,itemButton:`${li}__item-button`,itemMask:`${li}__item-mask`,itemMaskIcon:`${li}__item-mask--icon`,itemImage:`${li}__image`,itemImageResizable:`${li}__image--resizable`,itemLabel:`${li}__label`,itemFilename:`${li}__filename`,itemChevronIcon:`${li}__item-chevron-icon`,itemLink:`${li}__item-link`,itemLinkOverlay:`${li}__item-link-overlay`,itemLinkOverlayIcon:`${li}__item-link-overlay-icon`,itemEditIcon:`${li}__item-edit-icon`,itemAddIcon:`${li}__item-add-icon`,itemAddButton:`${li}__item-add-button`,formNode:`${li}__form-node`,fileFieldset:`${li}__file-fieldset`,fileLabel:`${li}__file-label`,fileName:`${li}__file-name`,fileInput:`${li}__file-input`,metadata:`${li}__metadata`,metadataFieldset:`${li}__metadata-fieldset`,progressBar:`${li}__progress-bar`,esriWidget:"esri-widget",esriButton:Av,buttonDisabled:`${Av}--disabled`,esriButtonSecondary:`${Av}--secondary`,esriButtonTertiary:`${Av}--tertiary`,esriButtonThird:`${Av}--third`,esriButtonSmall:`${Av}--small`,esriButtonHalf:`${Av}--half`,empty:"esri-widget__content--empty",iconExternalLink:"esri-icon-link-external",iconEdit:"esri-icon-edit",iconRight:"esri-icon-right",iconLeft:"esri-icon-left",iconPlus:"esri-icon-plus"},lU=window.CSS;let Na=class extends Ea{constructor(e,r){super(e,r),this.displayType="auto",this.messages=null,this.messagesUnits=null,this.selectedFile=null,this.submitting=!1,this.viewModel=null,this.visibleElements={...tee},this._supportsImageOrientation=lU&&lU.supports&&lU.supports("image-orientation","from-image"),this._addAttachmentForm=null,this._updateAttachmentForm=null}initialize(){this.viewModel||(this.viewModel=new JW),this.addHandles([sn(()=>{var e;return(e=this.viewModel)==null?void 0:e.attachmentInfos},"change",()=>this.scheduleRender()),sn(()=>{var e;return(e=this.viewModel)==null?void 0:e.fileInfos},"change",()=>this.scheduleRender()),ie(()=>{var e;return(e=this.viewModel)==null?void 0:e.mode},()=>this._modeChanged(),Vt)])}loadDependencies(){return Promise.all([te(()=>import("./calcite-icon-0839c644.js"),["assets/calcite-icon-0839c644.js","assets/icon-31e4ed97.js","assets/observers-2e8584e1.js"])])}get abilities(){return this.viewModel.abilities}set abilities(e){this.viewModel.abilities=e}get effectiveDisplayType(){const{displayType:e}=this;return e&&e!=="auto"?e:this.viewModel.supportsResizeAttachments?"preview":"list"}get graphic(){return this.viewModel.graphic}set graphic(e){this.viewModel.graphic=e}get label(){var e;return((e=this.messages)==null?void 0:e.widgetLabel)??""}set label(e){this._overrideIfSome("label",e)}castVisibleElements(e){return{...tee,...e}}addAttachment(){const{_addAttachmentForm:e,viewModel:r}=this;return this._set("submitting",!0),this._set("error",null),r.addAttachment(e).then(i=>(this._set("submitting",!1),this._set("error",null),r.mode="view",i)).catch(i=>{throw this._set("submitting",!1),this._set("error",new q("attachments:add-attachment",this.messages.addErrorMessage,i)),i})}deleteAttachment(e){const{viewModel:r}=this;return this._set("submitting",!0),this._set("error",null),r.deleteAttachment(e).then(i=>(this._set("submitting",!1),this._set("error",null),r.mode="view",i)).catch(i=>{throw this._set("submitting",!1),this._set("error",new q("attachments:delete-attachment",this.messages.deleteErrorMessage,i)),i})}updateAttachment(){const{viewModel:e}=this,{_updateAttachmentForm:r}=this;return this._set("submitting",!0),this._set("error",null),e.updateAttachment(r).then(i=>(this._set("submitting",!1),this._set("error",null),e.mode="view",i)).catch(i=>{throw this._set("submitting",!1),this._set("error",new q("attachments:update-attachment",this.messages.updateErrorMessage,i)),i})}addFile(){const e=this.viewModel.addFile(this.selectedFile,this._addAttachmentForm);return this.viewModel.mode="view",e}updateFile(){const{viewModel:e}=this,r=e.updateFile(this.selectedFile,this._updateAttachmentForm,e.activeFileInfo);return e.mode="view",r}deleteFile(e){var i;const r=this.viewModel.deleteFile(e||((i=this.viewModel.activeFileInfo)==null?void 0:i.file));return this.viewModel.mode="view",r}render(){const{submitting:e,viewModel:r}=this,{state:i}=r;return re("div",{class:this.classes(qe.base,qe.esriWidget)},e?this.renderProgressBar():null,i==="loading"?this.renderLoading():this.renderAttachments(),this.renderErrorMessage())}renderErrorMessage(){const{error:e,visibleElements:r}=this;return e&&r.errorMessage?re("div",{key:"error-message",class:qe.errorMessage},e.message):null}renderAttachments(){const{activeFileInfo:e,mode:r,activeAttachmentInfo:i}=this.viewModel;return r==="add"?this.renderAddForm():r==="edit"?this.renderDetailsForm(i||e):this.renderAttachmentContainer()}renderLoading(){return re("div",{class:qe.loaderContainer,key:"loader"},re("div",{class:qe.loader}))}renderProgressBar(){return this.visibleElements.progressBar?re("div",{class:qe.progressBar,key:"progress-bar"}):null}renderAddForm(){const{submitting:e,selectedFile:r}=this,i=e||!r,s=this.visibleElements.cancelAddButton?re("button",{type:"button",bind:this,disabled:e,onclick:this._cancelForm,class:this.classes(qe.esriButton,qe.esriButtonTertiary,qe.esriButtonSmall,qe.esriButtonHalf,e&&qe.buttonDisabled)},this.messages.cancel):null,n=this.visibleElements.addSubmitButton?re("button",{type:"submit",disabled:i,class:this.classes(qe.esriButton,qe.esriButtonSecondary,qe.esriButtonSmall,qe.esriButtonHalf,{[qe.buttonDisabled]:i})},this.messages.add):null,o=r?re("span",{key:"file-name",class:qe.fileName},r.name):null,a=re("form",{bind:this,afterCreate:SN,afterRemoved:SQ,"data-node-ref":"_addAttachmentForm",onsubmit:this._submitAddAttachment},re("fieldset",{class:qe.fileFieldset},o,re("label",{class:this.classes(qe.fileLabel,qe.esriButton,qe.esriButtonSecondary)},r?this.messages.changeFile:this.messages.selectFile,re("input",{class:qe.fileInput,type:"file",name:"attachment",bind:this,onchange:this._handleFileInputChange}))),n,s);return re("div",{key:"add-form-container",class:qe.formNode},a)}renderDetailsForm(e){var E,O,R;const{visibleElements:r,viewModel:i,selectedFile:s,submitting:n}=this,{abilities:o}=i,a=n||!s;let l,c,h,p;s?(l=s.type,c=s.name,h=s.size):e&&"file"in e?(l=e.file.type,c=e.file.name,h=e.file.size):e&&"contentType"in e&&(l=e.contentType,c=e.name,h=e.size,p=e.url);const f=o.editing&&((E=o.operations)!=null&&E.delete)&&r.deleteButton?re("button",{key:"delete-button",type:"button",disabled:n,bind:this,onclick:L=>this._submitDeleteAttachment(L,e),class:this.classes(qe.esriButton,qe.esriButtonSmall,qe.esriButtonTertiary,qe.deleteButton,{[qe.buttonDisabled]:n})},this.messages.delete):void 0,m=o.editing&&((O=o.operations)!=null&&O.update)&&r.updateButton?re("button",{disabled:a,key:"update-button",type:"submit",class:this.classes(qe.esriButton,qe.esriButtonSmall,qe.esriButtonThird,{[qe.buttonDisabled]:a})},this.messages.update):void 0,y=this.visibleElements.cancelUpdateButton?re("button",{disabled:n,key:"cancel-button",type:"button",bind:this,onclick:this._cancelForm,class:this.classes(qe.esriButton,qe.esriButtonSmall,qe.esriButtonTertiary,qe.esriButtonThird,{[qe.buttonDisabled]:n})},this.messages.cancel):void 0,_=o.editing&&((R=o.operations)!=null&&R.update)?re("fieldset",{key:"file",class:qe.fileFieldset},re("span",{key:"file-name",class:qe.fileName},c),re("label",{class:this.classes(qe.fileLabel,qe.esriButton,qe.esriButtonSecondary)},this.messages.changeFile,re("input",{class:qe.fileInput,type:"file",name:"attachment",bind:this,onchange:this._handleFileInputChange}))):void 0,b=re("fieldset",{key:"size",class:qe.metadataFieldset},re("label",null,F5e(this.messagesUnits,h??0))),x=re("fieldset",{key:"content-type",class:qe.metadataFieldset},re("label",null,l)),T=v(p)?re("a",{class:qe.itemLink,href:p,rel:"noreferrer",target:"_blank"},this.renderImageMask(e,400),re("div",{class:qe.itemLinkOverlay},re("span",{class:qe.itemLinkOverlayIcon},re("calcite-icon",{icon:"launch"})))):this.renderImageMask(e,400),S=re("form",{bind:this,afterCreate:SN,afterRemoved:SQ,"data-node-ref":"_updateAttachmentForm",onsubmit:L=>this._submitUpdateAttachment(L,e)},re("div",{class:qe.metadata},b,x),_,re("div",{class:qe.actions},f,y,m));return re("div",{key:"edit-form-container",class:qe.formNode},T,S)}renderImageMask(e,r){return e?"file"in e?this.renderGenericImageMask(e.file.name,e.file.type):this.renderImageMaskForAttachment(e,r):null}renderGenericImageMask(e,r){const{supportsResizeAttachments:i}=this.viewModel,s=v6e(r),n={[qe.itemImageResizable]:i};return re("div",{class:this.classes(qe.itemMaskIcon,qe.itemMask)},re("img",{title:e,alt:e,src:s,class:this.classes(n,qe.itemImage)}))}renderImageMaskForAttachment(e,r){const{supportsResizeAttachments:i}=this.viewModel;if(!e)return null;const{contentType:s,name:n,url:o}=e;if(!i||!eee(s))return this.renderGenericImageMask(n,s);const a=this._getCSSTransform(e),l=a?{transform:a,"image-orientation":"none"}:{},c=`${o}${o!=null&&o.includes("?")?"&":"?"}w=${r}`,h={[qe.itemImageResizable]:i};return re("div",{class:this.classes(qe.itemMask)},re("img",{styles:l,alt:n,title:n,src:c,class:this.classes(h,qe.itemImage)}))}renderFile(e){const{file:r}=e;return re("li",{class:qe.item,key:r},re("button",{key:"details-button",bind:this,class:qe.itemButton,title:this.messages.attachmentDetails,"aria-label":this.messages.attachmentDetails,onclick:()=>this._startEditFile(e),type:"button"},this.renderImageMask(e),re("label",{class:qe.itemLabel},re("span",{class:qe.itemFilename},r.name||this.messages.noTitle),re("span",{"aria-hidden":"true",class:this.classes(qe.itemChevronIcon,Uf(this.container)?qe.iconLeft:qe.iconRight)}))))}renderAttachmentInfo({attachmentInfo:e,displayType:r}){const{viewModel:i,effectiveDisplayType:s}=this,{abilities:n,supportsResizeAttachments:o}=i,{contentType:a,name:l,url:c}=e,h=this.renderImageMask(e,r==="list"?48:400),p=n.editing?re("span",{"aria-hidden":"true",class:this.classes(qe.itemChevronIcon,Uf(this.container)?qe.iconLeft:qe.iconRight)}):null,f=[h,s==="preview"&&o&&eee(a)?null:re("label",{class:qe.itemLabel},re("span",{class:qe.itemFilename},l||this.messages.noTitle),p)],m=n.editing?re("button",{key:"details-button",bind:this,class:qe.itemButton,title:this.messages.attachmentDetails,"aria-label":this.messages.attachmentDetails,"data-attachment-info-id":e.id,onclick:()=>this._startEditAttachment(e),type:"button"},f):re("a",{key:"details-link",class:qe.itemButton,href:c??void 0,target:"_blank"},f);return re("li",{class:qe.item,key:e},m)}renderAttachmentContainer(){var y;const{effectiveDisplayType:e,viewModel:r,visibleElements:i}=this,{attachmentInfos:s,abilities:n,fileInfos:o}=r,a=!!(s!=null&&s.length),l=!!(o!=null&&o.length),c={[qe.containerList]:e!=="preview",[qe.containerPreview]:e==="preview"},h=n.editing&&((y=n.operations)!=null&&y.add)&&i.addButton?re("button",{bind:this,onclick:()=>this._startAddAttachment(),class:this.classes(qe.esriButton,qe.esriButtonTertiary,qe.addAttachmentButton),type:"button"},re("span",{"aria-hidden":"true",class:this.classes(qe.itemAddIcon,qe.iconPlus)}),this.messages.add):void 0,p=a?re("ul",{key:"attachments-list",class:qe.items},s.toArray().map(_=>this.renderAttachmentInfo({attachmentInfo:_,displayType:e}))):void 0,f=l?re("ul",{key:"file-list",class:qe.items},o.toArray().map(_=>this.renderFile(_))):void 0,m=l||a?void 0:re("div",{class:qe.empty},this.messages.noAttachments);return re("div",{key:"attachments-container",class:this.classes(qe.container,c)},p,f,m,h)}_modeChanged(){this._set("error",null),this._set("selectedFile",null)}_handleFileInputChange(e){const r=e.target,i=r&&r.files&&r.files.item(0);this._set("selectedFile",i)}_submitDeleteAttachment(e,r){e.preventDefault(),r&&("file"in r?this.deleteFile(r.file):r&&this.deleteAttachment(r))}_submitAddAttachment(e){e.preventDefault(),this.viewModel.filesEnabled?this.addFile():this.addAttachment()}_submitUpdateAttachment(e,r){e.preventDefault(),r&&"file"in r?this.updateFile():this.updateAttachment()}_startEditAttachment(e){const{viewModel:r}=this;r.activeFileInfo=null,r.activeAttachmentInfo=e,r.mode="edit"}_startEditFile(e){const{viewModel:r}=this;r.activeAttachmentInfo=null,r.activeFileInfo=e,r.mode="edit"}_startAddAttachment(){this.viewModel.mode="add"}_cancelForm(e){e.preventDefault(),this.viewModel.mode="view"}_getCSSTransform(e){const{orientationInfo:r}=e;return!this._supportsImageOrientation&&r?[r.rotation?`rotate(${r.rotation}deg)`:"",r.mirrored?"scaleX(-1)":""].join(" "):""}};u([d()],Na.prototype,"abilities",null),u([d()],Na.prototype,"displayType",void 0),u([d({readOnly:!0})],Na.prototype,"effectiveDisplayType",null),u([d()],Na.prototype,"graphic",null),u([d()],Na.prototype,"label",null),u([d(),ya("esri/widgets/Attachments/t9n/Attachments")],Na.prototype,"messages",void 0),u([d(),ya("esri/core/t9n/Units")],Na.prototype,"messagesUnits",void 0),u([d({readOnly:!0})],Na.prototype,"selectedFile",void 0),u([d({readOnly:!0})],Na.prototype,"submitting",void 0),u([d({readOnly:!0})],Na.prototype,"error",void 0),u([d({type:JW})],Na.prototype,"viewModel",void 0),u([d()],Na.prototype,"visibleElements",void 0),u([cr("visibleElements")],Na.prototype,"castVisibleElements",null),Na=u([I("esri.widgets.Attachments")],Na);const x6e=Na;let NA=class extends JW{constructor(e){super(e),this.description=null,this.title=null}};u([d()],NA.prototype,"description",void 0),u([d()],NA.prototype,"title",void 0),NA=u([I("esri.widgets.Feature.FeatureAttachments.FeatureAttachmentsViewModel")],NA);const KW=NA,T6e={heading:"esri-widget__heading"};function QW({level:t,class:e,...r},i){const s=S6e(t);return re(`h${s}`,{...r,class:qme(T6e.heading,e),role:"heading","aria-level":String(s)},i)}function S6e(t){return ge(Math.ceil(t),1,6)}const cU="esri-feature-element-info",uU={base:cU,title:`${cU}__title`,description:`${cU}__description`};let MT=class extends Ea{constructor(e,r){super(e,r),this.description=null,this.headingLevel=2,this.title=null}render(){return re("div",{class:uU.base},this.renderTitle(),this.renderDescription())}renderTitle(){const{title:e}=this;return e?re(QW,{level:this.headingLevel,class:uU.title},e):null}renderDescription(){const{description:e}=this;return e?re("div",{key:"description",class:uU.description},e):null}};u([d()],MT.prototype,"description",void 0),u([d()],MT.prototype,"headingLevel",void 0),u([d()],MT.prototype,"title",void 0),MT=u([I("esri.widgets.Feature.support.FeatureElementInfo")],MT);const Z4=MT,E6e={base:"esri-feature-attachments"};let of=class extends Ea{constructor(e,r){super(e,r),this._featureElementInfo=null,this.attachmentsWidget=new x6e,this.headingLevel=2,this.viewModel=new KW}initialize(){this._featureElementInfo=new Z4,this.addHandles([ie(()=>{var e,r;return[(e=this.viewModel)==null?void 0:e.description,(r=this.viewModel)==null?void 0:r.title,this.headingLevel]},()=>this._setupFeatureElementInfo(),Vt),ie(()=>this.viewModel,e=>this.attachmentsWidget.viewModel=e,Vt)])}destroy(){var e;this.attachmentsWidget.destroy(),(e=this._featureElementInfo)==null||e.destroy()}get description(){return this.viewModel.description}set description(e){this.viewModel.description=e}get displayType(){return this.attachmentsWidget.displayType}set displayType(e){this.attachmentsWidget.displayType=e}get graphic(){return this.viewModel.graphic}set graphic(e){this.viewModel.graphic=e}get title(){return this.viewModel.title}set title(e){this.viewModel.title=e}render(){var r;const{attachmentsWidget:e}=this;return re("div",{class:E6e.base},(r=this._featureElementInfo)==null?void 0:r.render(),e==null?void 0:e.render())}_setupFeatureElementInfo(){var s;const{description:e,title:r,headingLevel:i}=this;(s=this._featureElementInfo)==null||s.set({description:e,title:r,headingLevel:i})}};u([d({readOnly:!0})],of.prototype,"attachmentsWidget",void 0),u([d()],of.prototype,"description",null),u([d()],of.prototype,"displayType",null),u([d()],of.prototype,"graphic",null),u([d()],of.prototype,"headingLevel",void 0),u([d()],of.prototype,"title",null),u([d({type:KW})],of.prototype,"viewModel",void 0),of=u([I("esri.widgets.Feature.FeatureAttachments")],of);const C6e=of;let O0=class extends Yw(Te){constructor(e){super(e),this._loadingPromise=null,this.created=null,this.creator=null,this.destroyer=null,this.graphic=null,this.handles.add(ie(()=>this.creator,r=>{this._destroyContent(),this._createContent(r)},Vt))}destroy(){this._destroyContent()}get state(){return this._loadingPromise?"loading":"ready"}_destroyContent(){const{created:e,graphic:r,destroyer:i}=this;e&&r&&(LN(i,{graphic:r}).catch(()=>null),this._set("created",null))}async _createContent(e){const r=this.graphic;if(!r||!e)return;const i=LN(e,{graphic:r}).catch(()=>null);this._loadingPromise=i,this.notifyChange("state");const s=await i;i===this._loadingPromise&&(this._loadingPromise=null,this.notifyChange("state"),this._set("created",s))}};u([d({readOnly:!0})],O0.prototype,"created",void 0),u([d()],O0.prototype,"creator",void 0),u([d()],O0.prototype,"destroyer",void 0),u([d({type:Io})],O0.prototype,"graphic",void 0),u([d({readOnly:!0})],O0.prototype,"state",null),O0=u([I("esri.widgets.Feature.FeatureContent.FeatureContentViewModel")],O0);const DN=O0;function hu(){return function(t,e){if(!t[e])throw new TypeError(`Cannot auto bind undefined function '${e}'`);return{value:R6e(t[e])}}}function A6e(t){const e=t==null?void 0:t.type;return t instanceof KeyboardEvent||e==="keyup"||e==="keydown"||e==="keypress"}function R6e(t){return function(e,...r){A6e(e)?XFe(e.key)&&(e.preventDefault(),e.stopPropagation(),e.target.click()):t.call(this,e,...r)}}function Hge(t){return e=>{e.hasOwnProperty("_delegatedEventNames")||(e._delegatedEventNames=e._delegatedEventNames?e._delegatedEventNames.slice():[]);const r=e._delegatedEventNames,i=Array.isArray(t)?t:O6e(t);r.push(...i)}}function O6e(t){return t.split(",").map(e=>e.trim())}const qge="calcite-mode-";function M6e(){return getComputedStyle(document.body).getPropertyValue("--esri-calcite-mode-name").replace(/\s|'|"/g,"")}function NN(){return M6e().startsWith("dark")}function P6e(){return`${qge}${NN()?"dark":"light"}`}function I6e(t){$6e(t),t.classList.add(P6e())}function $6e(t){Array.from(t.classList).forEach(e=>{e.startsWith(qge)&&t.classList.remove(e)})}function Wge(t){return t&&typeof t.render=="function"}function L6e(t){return t&&typeof t.postMixInProperties=="function"&&typeof t.buildRendering=="function"&&typeof t.postCreate=="function"&&typeof t.startup=="function"}const hU="esri-feature-content",dU={base:hU,loaderContainer:`${hU}__loader-container`,loader:`${hU}__loader`};let PT=class extends Ea{constructor(e,r){super(e,r),this.viewModel=null,this._addTargetToAnchors=i=>{Array.from(i.querySelectorAll("a")).forEach(s=>{Nge(s.href)&&!s.hasAttribute("target")&&s.setAttribute("target","_blank")})}}get creator(){var e;return(e=this.viewModel)==null?void 0:e.creator}set creator(e){this.viewModel&&(this.viewModel.creator=e)}get graphic(){var e;return(e=this.viewModel)==null?void 0:e.graphic}set graphic(e){this.viewModel&&(this.viewModel.graphic=e)}renderLoading(){return re("div",{class:dU.loaderContainer,key:"loader"},re("div",{class:dU.loader}))}renderCreated(){var r;const e=(r=this.viewModel)==null?void 0:r.created;return e?e instanceof HTMLElement?re("div",{key:e,bind:e,afterCreate:this._attachToNode}):Wge(e)?re("div",{key:e},!e.destroyed&&e.render()):re("div",{key:e,innerHTML:e,afterCreate:this._addTargetToAnchors}):null}render(){var r;const e=(r=this.viewModel)==null?void 0:r.state;return re("div",{class:dU.base},e==="loading"?this.renderLoading():this.renderCreated())}_attachToNode(e){const r=this;e.appendChild(r)}};u([d()],PT.prototype,"creator",null),u([d()],PT.prototype,"graphic",null),u([d({type:DN})],PT.prototype,"viewModel",void 0),PT=u([I("esri.widgets.Feature.FeatureContent")],PT);const xL=PT;let rg=class extends Te{constructor(e){super(e),this.attributes=null,this.expressionInfos=null,this.description=null,this.fieldInfos=null,this.title=null}get formattedFieldInfos(){const{expressionInfos:e,fieldInfos:r}=this,i=[];return r==null||r.forEach(s=>{if(!(!s.hasOwnProperty("visible")||s.visible))return;const n=s.clone();n.label=Fge(n,e),i.push(n)}),i}};u([d()],rg.prototype,"attributes",void 0),u([d({type:[Jde]})],rg.prototype,"expressionInfos",void 0),u([d()],rg.prototype,"description",void 0),u([d({type:[tM]})],rg.prototype,"fieldInfos",void 0),u([d({readOnly:!0})],rg.prototype,"formattedFieldInfos",null),u([d()],rg.prototype,"title",void 0),rg=u([I("esri.widgets.Feature.FeatureFields.FeatureFieldsViewModel")],rg);const J4=rg,D6e=[{pattern:/^\s*(https?:\/\/([^\s]+))\s*$/i,target:"_blank",label:"{messages.view}"},{pattern:/^\s*(tel:([^\s]+))\s*$/i,label:"{hierPart}"},{pattern:/^\s*(mailto:([^\s]+))\s*$/i,label:"{hierPart}"},{pattern:/^\s*(arcgis-appstudio-player:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"App Studio Player"},{pattern:/^\s*(arcgis-collector:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Collector"},{pattern:/^\s*(arcgis-explorer:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Explorer"},{pattern:/^\s*(arcgis-navigator:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Navigator"},{pattern:/^\s*(arcgis-survey123:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Survey123"},{pattern:/^\s*(arcgis-trek2there:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Trek2There"},{pattern:/^\s*(arcgis-workforce:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Workforce"},{pattern:/^\s*(iform:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"iForm"},{pattern:/^\s*(flow:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"FlowFinity"},{pattern:/^\s*(lfmobile:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Laserfische"},{pattern:/^\s*(mspbi:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Microsoft Power Bi"}];function N6e(t){let e=null;return D6e.some(r=>(r.pattern.test(t)&&(e=r),!!e)),e}function F6e(t,e){if(typeof e!="string"||!e)return e;const r=N6e(e);if(!r)return e;const i=e.match(r.pattern),s=i&&i[2],n=tm(tm(r.label,{messages:t,hierPart:s}),{appName:r.appName}),o=r.target?` target="${r.target}"`:"",a=r.target==="_blank"?' rel="noreferrer"':"";return e.replace(r.pattern,`<a${o} href="$1"${a}>${n}</a>`)}const wP="esri-feature-fields",uC={base:wP,fieldHeader:`${wP}__field-header`,fieldData:`${wP}__field-data`,fieldDataDate:`${wP}__field-data--date`,esriTable:"esri-widget__table"};let vd=class extends Ea{constructor(e,r){super(e,r),this._featureElementInfo=null,this.viewModel=new J4,this.messages=null,this.messagesURIUtils=null}initialize(){this._featureElementInfo=new Z4,this.addHandles(ie(()=>{var e,r;return[(e=this.viewModel)==null?void 0:e.description,(r=this.viewModel)==null?void 0:r.title]},()=>this._setupFeatureElementInfo(),Vt))}destroy(){var e;(e=this._featureElementInfo)==null||e.destroy()}get attributes(){return this.viewModel.attributes}set attributes(e){this.viewModel.attributes=e}get description(){return this.viewModel.description}set description(e){this.viewModel.description=e}get expressionInfos(){return this.viewModel.expressionInfos}set expressionInfos(e){this.viewModel.expressionInfos=e}get fieldInfos(){return this.viewModel.fieldInfos}set fieldInfos(e){this.viewModel.fieldInfos=e}get title(){return this.viewModel.title}set title(e){this.viewModel.title=e}renderFieldInfo(e,r){const{attributes:i}=this.viewModel,s=e.fieldName,n=e.label||s,o=i?i[s]==null?"":i[s]:"",a=!(!e.format||!e.format.dateFormat),l=typeof o=="number"&&!a?this._forceLTR(o):F6e(this.messagesURIUtils,o),c={[uC.fieldDataDate]:a};return re("tr",{key:`fields-element-info-row-${s}-${r}`},re("th",{key:`fields-element-info-row-header-${s}-${r}`,class:uC.fieldHeader,innerHTML:n}),re("td",{key:`fields-element-info-row-data-${s}-${r}`,class:this.classes(uC.fieldData,c),innerHTML:l}))}renderFields(){const{formattedFieldInfos:e}=this.viewModel;return e!=null&&e.length?re("table",{class:uC.esriTable,summary:this.messages.fieldsSummary},re("tbody",null,e.map((r,i)=>this.renderFieldInfo(r,i)))):null}render(){var e;return re("div",{class:uC.base},(e=this._featureElementInfo)==null?void 0:e.render(),this.renderFields())}_setupFeatureElementInfo(){var i;const{description:e,title:r}=this;(i=this._featureElementInfo)==null||i.set({description:e,title:r})}_forceLTR(e){return`&lrm;${e}`}};u([d()],vd.prototype,"attributes",null),u([d()],vd.prototype,"description",null),u([d()],vd.prototype,"expressionInfos",null),u([d()],vd.prototype,"fieldInfos",null),u([d()],vd.prototype,"title",null),u([d({type:J4,nonNullable:!0})],vd.prototype,"viewModel",void 0),u([d(),ya("esri/widgets/Feature/t9n/Feature")],vd.prototype,"messages",void 0),u([d(),ya("esri/widgets/support/t9n/uriUtils")],vd.prototype,"messagesURIUtils",void 0),vd=u([I("esri.widgets.Feature.FeatureFields")],vd);const Xge=vd,U6e={maximumFractionDigits:20};function k6e(t){return om(t,U6e)}var vz;let I1=vz=class extends ve{constructor(t){super(t),this.color=null,this.label=null,this.value=null}writeValue(t,e,r){e[r]=t??0}clone(){return new vz({color:this.color&&this.color.clone(),label:this.label,value:this.value})}};u([d({type:Ze,json:{type:[Gi],write:!0}})],I1.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],I1.prototype,"label",void 0),u([d({type:Number,json:{write:{writerEnsuresNonNull:!0}}})],I1.prototype,"value",void 0),u([He("value")],I1.prototype,"writeValue",null),I1=vz=u([I("esri.renderers.visualVariables.support.ColorStop")],I1);const V6e=I1;function pM(){const t=new Float32Array(16);return t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function B6e(t){const e=new Float32Array(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function z6e(t,e,r,i,s,n,o,a,l,c,h,p,f,m,y,_){const b=new Float32Array(16);return b[0]=t,b[1]=e,b[2]=r,b[3]=i,b[4]=s,b[5]=n,b[6]=o,b[7]=a,b[8]=l,b[9]=c,b[10]=h,b[11]=p,b[12]=f,b[13]=m,b[14]=y,b[15]=_,b}function G6e(t,e){return new Float32Array(t,e,16)}const j6e=pM();Object.freeze(Object.defineProperty({__proto__:null,IDENTITY:j6e,clone:B6e,create:pM,createView:G6e,fromValues:z6e},Symbol.toStringTag,{value:"Module"}));const H6e=(t,e)=>{const r=ym(t,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1);return Dc(r,r)},q6e=(t,e)=>{const r=ym(t,e,0,0,.5-.5*e,0,e,0,.5-.5*e,0,0,e,.5-.5*e,0,0,0,1);return Dc(r,r)},W6e=(t,e)=>{const r=1-e,i=ym(t,.2126+.7874*r,.7152-.7152*r,.0722-.0722*r,0,.2126-.2126*r,.7152+.2848*r,.0722-.0722*r,0,.2126-.2126*r,.7152-.7152*r,.0722+.9278*r,0,0,0,0,1);return Dc(i,i)},X6e=(t,e)=>{const r=Math.sin(e*Math.PI/180),i=Math.cos(e*Math.PI/180),s=ym(t,.213+.787*i-.213*r,.715-.715*i-.715*r,.072-.072*i+.928*r,0,.213-.213*i+.143*r,.715+.285*i+.14*r,.072-.072*i-.283*r,0,.213-.213*i-.787*r,.715-.715*i+.715*r,.072+.928*i+.072*r,0,0,0,0,1);return Dc(s,s)},Y6e=(t,e)=>{const r=1-2*e,i=ym(t,r,0,0,e,0,r,0,e,0,0,r,e,0,0,0,1);return Dc(i,i)},Z6e=(t,e)=>{const r=ym(t,.213+.787*e,.715-.715*e,.072-.072*e,0,.213-.213*e,.715+.285*e,.072-.072*e,0,.213-.213*e,.715-.715*e,.072+.928*e,0,0,0,0,1);return Dc(r,r)},J6e=(t,e)=>{const r=1-e,i=ym(t,.393+.607*r,.769-.769*r,.189-.189*r,0,.349-.349*r,.686+.314*r,.168-.168*r,0,.272-.272*r,.534-.534*r,.131+.869*r,0,0,0,0,1);return Dc(i,i)};let Yge=class Zge{constructor(e,r,i){this.strength=e,this.radius=r,this.threshold=i,this.type="bloom"}interpolate(e,r,i){this.strength=_c(e.strength,r.strength,i),this.radius=_c(e.radius,r.radius,i),this.threshold=_c(e.threshold,r.threshold,i)}clone(){return new Zge(this.strength,this.radius,this.threshold)}toJSON(){return{type:"bloom",radius:Z3(this.radius),strength:this.strength,threshold:this.threshold}}},Jge=class Kge{constructor(e){this.radius=e,this.type="blur"}interpolate(e,r,i){this.radius=Math.round(_c(e.radius,r.radius,i))}clone(){return new Kge(this.radius)}toJSON(){return{type:"blur",radius:Z3(this.radius)}}},bz=class Qge{constructor(e,r){this.type=e,this.amount=r,this.type!=="invert"&&this.type!=="grayscale"&&this.type!=="sepia"||(this.amount=Math.min(this.amount,1))}get colorMatrix(){return this._colorMatrix||this._updateMatrix(),this._colorMatrix}interpolate(e,r,i){this.amount=_c(e.amount,r.amount,i),this._updateMatrix()}clone(){return new Qge(this.type,this.amount)}toJSON(){return{type:this.type,amount:this.amount}}_updateMatrix(){const e=this._colorMatrix||pM();switch(this.type){case"brightness":this._colorMatrix=H6e(e,this.amount);break;case"contrast":this._colorMatrix=q6e(e,this.amount);break;case"grayscale":this._colorMatrix=W6e(e,this.amount);break;case"invert":this._colorMatrix=Y6e(e,this.amount);break;case"saturate":this._colorMatrix=Z6e(e,this.amount);break;case"sepia":this._colorMatrix=J6e(e,this.amount)}}},eye=class tye{constructor(e,r,i,s){this.offsetX=e,this.offsetY=r,this.blurRadius=i,this.color=s,this.type="drop-shadow"}interpolate(e,r,i){this.offsetX=_c(e.offsetX,r.offsetX,i),this.offsetY=_c(e.offsetY,r.offsetY,i),this.blurRadius=_c(e.blurRadius,r.blurRadius,i),this.color[0]=Math.round(_c(e.color[0],r.color[0],i)),this.color[1]=Math.round(_c(e.color[1],r.color[1],i)),this.color[2]=Math.round(_c(e.color[2],r.color[2],i)),this.color[3]=_c(e.color[3],r.color[3],i)}clone(){return new tye(this.offsetX,this.offsetY,this.blurRadius,[...this.color])}toJSON(){const e=[...this.color];return e[3]*=255,{type:"drop-shadow",xoffset:Z3(this.offsetX),yoffset:Z3(this.offsetY),blurRadius:Z3(this.blurRadius),color:e}}},rye=class iye{constructor(e){this.angle=e,this.type="hue-rotate"}get colorMatrix(){return this._colorMatrix||this._updateMatrix(),this._colorMatrix}interpolate(e,r,i){this.angle=_c(e.angle,r.angle,i),this._updateMatrix()}clone(){return new iye(this.angle)}toJSON(){return{type:"hue-rotate",angle:this.angle}}_updateMatrix(){const e=this._colorMatrix||pM();this._colorMatrix=X6e(e,this.angle)}},sye=class nye{constructor(e){this.amount=e,this.type="opacity",this.amount=Math.min(this.amount,1)}interpolate(e,r,i){this.amount=_c(e.amount,r.amount,i)}clone(){return new nye(this.amount)}toJSON(){return{type:"opacity",amount:this.amount}}};function _c(t,e,r){return t+(e-t)*r}function Z3(t){return Math.round(1e3*Vh(t))/1e3}function K6e(t){switch(t.type){case"grayscale":case"sepia":case"invert":return new bz(t.type,0);case"saturate":case"brightness":case"contrast":return new bz(t.type,1);case"opacity":return new sye(1);case"hue-rotate":return new rye(0);case"blur":return new Jge(0);case"drop-shadow":return new eye(0,0,0,[...Aq("transparent")]);case"bloom":return new Yge(0,0,1)}}function Q6e(t,e){const r=t.length>e.length?t:e;return(t.length>e.length?e:t).every((i,s)=>i.type===r[s].type)}function eUe(t,e){const r=t.length>e.length?t:e,i=t.length>e.length?e:t;for(let s=i.length;s<r.length;s++)i.push(K6e(r[s]))}function tUe(t){const e=t[0];return!!e&&"type"in e}var ree,iee,wz={};function oye(t){if(!t||t.length===0)return null;if(typeof t=="string"){const r=see(t);return r&&r.length!==0?r:null}const e=t.map(r=>{if(!Number.isFinite(r.scale)||r.scale<=0)throw new q("effect:invalid-scale","scale must be finite and greater than 0",{stop:r});return{scale:r.scale,effects:see(r.value)}});e.sort((r,i)=>i.effects.length-r.effects.length);for(let r=0;r<e.length-1;r++){if(!Q6e(e[r].effects,e[r+1].effects))throw new q("effect:interpolation-impossible","Cannot interpolate by scale between 2 lists of mixed effects",{a:e[r].effects,b:e[r+1].effects});eUe(e[r].effects,e[r+1].effects)}return e.sort((r,i)=>i.scale-r.scale),e}function see(t){let e;if(!t)return[];try{e=wz.parse(t)}catch(r){throw new q("effect:invalid-syntax","Invalid effect syntax",{value:t,error:r})}return e.map(r=>rUe(r))}function rUe(t){try{switch(t.name){case"grayscale":case"sepia":case"saturate":case"invert":case"brightness":case"contrast":return iUe(t);case"opacity":return sUe(t);case"hue-rotate":return nUe(t);case"blur":return oUe(t);case"drop-shadow":return aUe(t);case"bloom":return lUe(t)}}catch(e){throw e.details.filter=t,e}throw new q("effect:unknown-effect",`Effect '${t.name}' is not supported`,{effect:t})}function iUe(t){let e=1;return ME(t.parameters,1),t.parameters.length===1&&(e=Ud(t.parameters[0])),new bz(t.name,e)}function sUe(t){let e=1;return ME(t.parameters,1),t.parameters.length===1&&(e=Ud(t.parameters[0])),new sye(e)}function nUe(t){let e=0;return ME(t.parameters,1),t.parameters.length===1&&(e=fUe(t.parameters[0])),new rye(e)}function oUe(t){let e=0;return ME(t.parameters,1),t.parameters.length===1&&(e=rX(t.parameters[0]),fM(e,t.parameters[0])),new Jge(e)}function aUe(t){const e=[];let r=null;for(const i of t.parameters)if(i.type==="color"){if(e.length&&Object.freeze(e),r)throw new q("effect:type-error","Accepts only one color",{});r=mUe(i)}else{const s=rX(i);if(Object.isFrozen(e))throw new q("effect:type-error","<length> parameters not consecutive",{lengths:e});e.push(s),e.length===3&&fM(s,i)}if(e.length<2||e.length>3)throw new q("effect:type-error",`Expected <length>{2,3}, Actual: <length>{${e.length}}`,{lengths:e});return new eye(e[0],e[1],e[2]||0,r||aye("black"))}function lUe(t){let e=1,r=0,i=0;return ME(t.parameters,3),t.parameters[0]&&(e=Ud(t.parameters[0])),t.parameters[1]&&(r=rX(t.parameters[1]),fM(r,t.parameters[1])),t.parameters[2]&&(i=Ud(t.parameters[2])),new Yge(e,r,i)}function ME(t,e){if(t.length>e)throw new q("effect:type-error",`Function supports up to ${e} parameters, Actual: ${t.length}`,{parameters:t})}function K4(t){if(t.type==="color")return"<color>";if(t.unit){if(tX[t.unit])return"<length>";if(eX[t.unit])return"<angle>";if(t.unit==="%")return"<percentage>"}return"<double>"}function fM(t,e){if(t<0)throw new q("effect:type-error",`Negative values are not allowed, Actual: ${t}`,{term:e})}function cUe(t){if(t.type!=="quantity"||t.unit!==null)throw new q("effect:type-error",`Expected <double>, Actual: ${K4(t)}`,{term:t})}function uUe(t){if(t.type!=="quantity"||t.unit!==null&&t.unit!=="%")throw new q("effect:type-error",`Expected <double> or <percentage>, Actual: ${K4(t)}`,{term:t})}iee=function(){function t(s,n){function o(){this.constructor=s}o.prototype=n.prototype,s.prototype=new o}function e(s,n,o,a){var l=Error.call(this,s);return Object.setPrototypeOf&&Object.setPrototypeOf(l,e.prototype),l.expected=n,l.found=o,l.location=a,l.name="SyntaxError",l}function r(s,n,o){return o=o||" ",s.length>n?s:(n-=s.length,s+(o+=o.repeat(n)).slice(0,n))}function i(s,n){var o,a={},l=(n=n!==void 0?n:{}).grammarSource,c={start:Cm},h=Cm,p="none",f=")",m=",",y="(",_="%",b="px",x="cm",T="mm",S="in",E="pt",O="pc",R="deg",L="rad",P="grad",U="turn",B="#",z=".",G="e",K=/^[ \t\n\r]/,ee=/^[a-z\-]/,Q=/^[0-9a-fA-F]/,H=/^[+\-]/,$=/^[0-9]/,N=al("none"),F=rs("none",!1),j=rs(")",!1),X=rs(",",!1),J=al("whitespace"),W=Sv([" ","	",`
`,"\r"],!1,!1),ue=al("function"),pe=rs("(",!1),we=al("identifier"),Ce=Sv([["a","z"],"-"],!1,!1),Ge=al("percentage"),Le=rs("%",!1),xe=al("length"),De=rs("px",!1),Ue=rs("cm",!1),wt=rs("mm",!1),Ke=rs("in",!1),Ut=rs("pt",!1),Wt=rs("pc",!1),Qt=al("angle"),Xt=rs("deg",!1),gr=rs("rad",!1),Kr=rs("grad",!1),Er=rs("turn",!1),Tr=al("number"),it=al("color"),Ye=rs("#",!1),at=Sv([["0","9"],["a","f"],["A","F"]],!1,!1),ut=Sv(["+","-"],!1,!1),Tt=Sv([["0","9"]],!1,!1),jt=rs(".",!1),Or=rs("e",!1),Mr=function(){return[]},Pr=function(Y,be){return{type:"function",name:Y,parameters:be||[]}},Ir=function(Y,be){return be.length>0?ZE(Y,be,3):[Y]},Si=function(Y){return{type:"quantity",value:Y.value,unit:Y.unit}},ir=function(Y){return{type:"color",colorType:Y.type,value:Y.value}},xr=function(Y){return Y},yr=function(){return Yl()},xs=function(Y){return{value:Y,unit:"%"}},ni=function(Y){return{value:Y,unit:"px"}},qi=function(Y){return{value:Y,unit:"cm"}},Ei=function(Y){return{value:Y,unit:"mm"}},Fi=function(Y){return{value:Y,unit:"in"}},hs=function(Y){return{value:Y,unit:"pt"}},Ns=function(Y){return{value:Y,unit:"pc"}},ao=function(Y){return{value:Y,unit:"deg"}},Vn=function(Y){return{value:Y,unit:"rad"}},Ts=function(Y){return{value:Y,unit:"grad"}},Wi=function(Y){return{value:Y,unit:"turn"}},Xi=function(Y){return{value:Y,unit:null}},Ss=function(){return{type:"hex",value:Yl()}},oi=function(Y){return{type:"function",value:Y}},Lo=function(){return{type:"named",value:Yl()}},ol=function(){return parseFloat(Yl())},he=0,gi=0,ed=[{line:1,column:1}],Ko=0,Bc=[],ht=0;if("startRule"in n){if(!(n.startRule in c))throw new Error(`Can't start parsing from rule "`+n.startRule+'".');h=c[n.startRule]}function Yl(){return s.substring(gi,he)}function rs(Y,be){return{type:"literal",text:Y,ignoreCase:be}}function Sv(Y,be,Oe){return{type:"class",parts:Y,inverted:be,ignoreCase:Oe}}function v6(){return{type:"end"}}function al(Y){return{type:"other",description:Y}}function Sy(Y){var be,Oe=ed[Y];if(Oe)return Oe;for(be=Y-1;!ed[be];)be--;for(Oe={line:(Oe=ed[be]).line,column:Oe.column};be<Y;)s.charCodeAt(be)===10?(Oe.line++,Oe.column=1):Oe.column++,be++;return ed[Y]=Oe,Oe}function Em(Y,be){var Oe=Sy(Y),hr=Sy(be);return{source:l,start:{offset:Y,line:Oe.line,column:Oe.column},end:{offset:be,line:hr.line,column:hr.column}}}function er(Y){he<Ko||(he>Ko&&(Ko=he,Bc=[]),Bc.push(Y))}function jM(Y,be,Oe){return new e(e.buildMessage(Y,be),Y,be,Oe)}function Cm(){var Y;return(Y=Ey())===a&&(Y=Cy()),Y}function Ey(){var Y,be;return ht++,Y=he,ai(),s.substr(he,4)===p?(be=p,he+=4):(be=a,ht===0&&er(F)),be!==a?(ai(),gi=Y,Y=Mr()):(he=Y,Y=a),ht--,Y===a&&ht===0&&er(N),Y}function Cy(){var Y,be;if(Y=[],(be=Do())!==a)for(;be!==a;)Y.push(be),be=Do();else Y=a;return Y}function Do(){var Y,be,Oe,hr;return Y=he,ai(),(be=Ap())!==a?(ai(),(Oe=ku())===a&&(Oe=null),ai(),s.charCodeAt(he)===41?(hr=f,he++):(hr=a,ht===0&&er(j)),hr!==a?(ai(),gi=Y,Y=Pr(be,Oe)):(he=Y,Y=a)):(he=Y,Y=a),Y}function ku(){var Y,be,Oe,hr,Bn,Es,cl,Ry;if(Y=he,(be=Vu())!==a){for(Oe=[],hr=he,Bn=ai(),s.charCodeAt(he)===44?(Es=m,he++):(Es=a,ht===0&&er(X)),Es===a&&(Es=null),cl=ai(),(Ry=Vu())!==a?hr=Bn=[Bn,Es,cl,Ry]:(he=hr,hr=a);hr!==a;)Oe.push(hr),hr=he,Bn=ai(),s.charCodeAt(he)===44?(Es=m,he++):(Es=a,ht===0&&er(X)),Es===a&&(Es=null),cl=ai(),(Ry=Vu())!==a?hr=Bn=[Bn,Es,cl,Ry]:(he=hr,hr=a);gi=Y,Y=Ir(be,Oe)}else he=Y,Y=a;return Y}function Vu(){var Y,be;return Y=he,(be=nx())===a&&(be=Ev())===a&&(be=ox())===a&&(be=Cv()),be!==a&&(gi=Y,be=Si(be)),(Y=be)===a&&(Y=he,(be=Ay())!==a&&(gi=Y,be=ir(be)),Y=be),Y}function ai(){var Y,be;for(ht++,Y=[],K.test(s.charAt(he))?(be=s.charAt(he),he++):(be=a,ht===0&&er(W));be!==a;)Y.push(be),K.test(s.charAt(he))?(be=s.charAt(he),he++):(be=a,ht===0&&er(W));return ht--,be=a,ht===0&&er(J),Y}function Ap(){var Y,be,Oe;return ht++,Y=he,(be=Am())!==a?(s.charCodeAt(he)===40?(Oe=y,he++):(Oe=a,ht===0&&er(pe)),Oe!==a?(gi=Y,Y=xr(be)):(he=Y,Y=a)):(he=Y,Y=a),ht--,Y===a&&(be=a,ht===0&&er(ue)),Y}function Am(){var Y,be,Oe;if(ht++,Y=he,be=[],ee.test(s.charAt(he))?(Oe=s.charAt(he),he++):(Oe=a,ht===0&&er(Ce)),Oe!==a)for(;Oe!==a;)be.push(Oe),ee.test(s.charAt(he))?(Oe=s.charAt(he),he++):(Oe=a,ht===0&&er(Ce));else be=a;return be!==a&&(gi=Y,be=yr()),ht--,(Y=be)===a&&(be=a,ht===0&&er(we)),Y}function nx(){var Y,be,Oe;return ht++,Y=he,ai(),(be=ll())!==a?(s.charCodeAt(he)===37?(Oe=_,he++):(Oe=a,ht===0&&er(Le)),Oe!==a?(gi=Y,Y=xs(be)):(he=Y,Y=a)):(he=Y,Y=a),ht--,Y===a&&ht===0&&er(Ge),Y}function Ev(){var Y,be,Oe;return ht++,Y=he,ai(),(be=ll())!==a?(s.substr(he,2)===b?(Oe=b,he+=2):(Oe=a,ht===0&&er(De)),Oe!==a?(gi=Y,Y=ni(be)):(he=Y,Y=a)):(he=Y,Y=a),Y===a&&(Y=he,ai(),(be=ll())!==a?(s.substr(he,2)===x?(Oe=x,he+=2):(Oe=a,ht===0&&er(Ue)),Oe!==a?(gi=Y,Y=qi(be)):(he=Y,Y=a)):(he=Y,Y=a),Y===a&&(Y=he,ai(),(be=ll())!==a?(s.substr(he,2)===T?(Oe=T,he+=2):(Oe=a,ht===0&&er(wt)),Oe!==a?(gi=Y,Y=Ei(be)):(he=Y,Y=a)):(he=Y,Y=a),Y===a&&(Y=he,ai(),(be=ll())!==a?(s.substr(he,2)===S?(Oe=S,he+=2):(Oe=a,ht===0&&er(Ke)),Oe!==a?(gi=Y,Y=Fi(be)):(he=Y,Y=a)):(he=Y,Y=a),Y===a&&(Y=he,ai(),(be=ll())!==a?(s.substr(he,2)===E?(Oe=E,he+=2):(Oe=a,ht===0&&er(Ut)),Oe!==a?(gi=Y,Y=hs(be)):(he=Y,Y=a)):(he=Y,Y=a),Y===a&&(Y=he,ai(),(be=ll())!==a?(s.substr(he,2)===O?(Oe=O,he+=2):(Oe=a,ht===0&&er(Wt)),Oe!==a?(gi=Y,Y=Ns(be)):(he=Y,Y=a)):(he=Y,Y=a)))))),ht--,Y===a&&ht===0&&er(xe),Y}function ox(){var Y,be,Oe;return ht++,Y=he,(be=ll())!==a?(s.substr(he,3)===R?(Oe=R,he+=3):(Oe=a,ht===0&&er(Xt)),Oe!==a?(gi=Y,Y=ao(be)):(he=Y,Y=a)):(he=Y,Y=a),Y===a&&(Y=he,(be=ll())!==a?(s.substr(he,3)===L?(Oe=L,he+=3):(Oe=a,ht===0&&er(gr)),Oe!==a?(gi=Y,Y=Vn(be)):(he=Y,Y=a)):(he=Y,Y=a),Y===a&&(Y=he,(be=ll())!==a?(s.substr(he,4)===P?(Oe=P,he+=4):(Oe=a,ht===0&&er(Kr)),Oe!==a?(gi=Y,Y=Ts(be)):(he=Y,Y=a)):(he=Y,Y=a),Y===a&&(Y=he,(be=ll())!==a?(s.substr(he,4)===U?(Oe=U,he+=4):(Oe=a,ht===0&&er(Er)),Oe!==a?(gi=Y,Y=Wi(be)):(he=Y,Y=a)):(he=Y,Y=a)))),ht--,Y===a&&(be=a,ht===0&&er(Qt)),Y}function Cv(){var Y,be;return ht++,Y=he,ai(),(be=ll())!==a?(gi=Y,Y=Xi(be)):(he=Y,Y=a),ht--,Y===a&&ht===0&&er(Tr),Y}function Ay(){var Y,be,Oe,hr;if(ht++,Y=he,s.charCodeAt(he)===35?(be=B,he++):(be=a,ht===0&&er(Ye)),be!==a){if(Oe=[],Q.test(s.charAt(he))?(hr=s.charAt(he),he++):(hr=a,ht===0&&er(at)),hr!==a)for(;hr!==a;)Oe.push(hr),Q.test(s.charAt(he))?(hr=s.charAt(he),he++):(hr=a,ht===0&&er(at));else Oe=a;Oe!==a?(gi=Y,Y=Ss()):(he=Y,Y=a)}else he=Y,Y=a;return Y===a&&(Y=he,(be=Do())!==a&&(gi=Y,be=oi(be)),(Y=be)===a&&(Y=he,(be=Am())!==a&&(gi=Y,be=Lo()),Y=be)),ht--,Y===a&&(be=a,ht===0&&er(it)),Y}function ll(){var Y,be,Oe,hr,Bn,Es,cl;for(Y=he,H.test(s.charAt(he))?(s.charAt(he),he++):ht===0&&er(ut),be=he,Oe=[],$.test(s.charAt(he))?(hr=s.charAt(he),he++):(hr=a,ht===0&&er(Tt));hr!==a;)Oe.push(hr),$.test(s.charAt(he))?(hr=s.charAt(he),he++):(hr=a,ht===0&&er(Tt));if(s.charCodeAt(he)===46?(hr=z,he++):(hr=a,ht===0&&er(jt)),hr!==a){if(Bn=[],$.test(s.charAt(he))?(Es=s.charAt(he),he++):(Es=a,ht===0&&er(Tt)),Es!==a)for(;Es!==a;)Bn.push(Es),$.test(s.charAt(he))?(Es=s.charAt(he),he++):(Es=a,ht===0&&er(Tt));else Bn=a;Bn!==a?be=Oe=[Oe,hr,Bn]:(he=be,be=a)}else he=be,be=a;if(be===a)if(be=[],$.test(s.charAt(he))?(Oe=s.charAt(he),he++):(Oe=a,ht===0&&er(Tt)),Oe!==a)for(;Oe!==a;)be.push(Oe),$.test(s.charAt(he))?(Oe=s.charAt(he),he++):(Oe=a,ht===0&&er(Tt));else be=a;if(be!==a){if(Oe=he,s.charCodeAt(he)===101?(hr=G,he++):(hr=a,ht===0&&er(Or)),hr!==a){if(H.test(s.charAt(he))?(Bn=s.charAt(he),he++):(Bn=a,ht===0&&er(ut)),Bn===a&&(Bn=null),Es=[],$.test(s.charAt(he))?(cl=s.charAt(he),he++):(cl=a,ht===0&&er(Tt)),cl!==a)for(;cl!==a;)Es.push(cl),$.test(s.charAt(he))?(cl=s.charAt(he),he++):(cl=a,ht===0&&er(Tt));else Es=a;Es!==a?Oe=hr=[hr,Bn,Es]:(he=Oe,Oe=a)}else he=Oe,Oe=a;Oe===a&&(Oe=null),gi=Y,Y=ol()}else he=Y,Y=a;return Y}function HM(Y,be){return Y.map(function(Oe){return Oe[be]})}function ZE(Y,be,Oe){return[Y].concat(HM(be,Oe))}if((o=h())!==a&&he===s.length)return o;throw o!==a&&he<s.length&&er(v6()),jM(Bc,Ko<s.length?s.charAt(Ko):null,Ko<s.length?Em(Ko,Ko+1):Em(Ko,Ko))}return t(e,Error),e.prototype.format=function(s){var n="Error: "+this.message;if(this.location){var o,a=null;for(o=0;o<s.length;o++)if(s[o].source===this.location.source){a=s[o].text.split(/\r\n|\n|\r/g);break}var l=this.location.start,c=this.location.source+":"+l.line+":"+l.column;if(a){var h=this.location.end,p=r("",l.line.toString().length," "),f=a[l.line-1],m=(l.line===h.line?h.column:f.length+1)-l.column||1;n+=`
 --> `+c+`
`+p+` |
`+l.line+" | "+f+`
`+p+" | "+r("",l.column-1," ")+r("",m,"^")}else n+=`
 at `+c}return n},e.buildMessage=function(s,n){var o={literal:function(m){return'"'+l(m.text)+'"'},class:function(m){var y=m.parts.map(function(_){return Array.isArray(_)?c(_[0])+"-"+c(_[1]):c(_)});return"["+(m.inverted?"^":"")+y.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(m){return m.description}};function a(m){return m.charCodeAt(0).toString(16).toUpperCase()}function l(m){return m.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(y){return"\\x0"+a(y)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(y){return"\\x"+a(y)})}function c(m){return m.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(y){return"\\x0"+a(y)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(y){return"\\x"+a(y)})}function h(m){return o[m.type](m)}function p(m){var y,_,b=m.map(h);if(b.sort(),b.length>0){for(y=1,_=1;y<b.length;y++)b[y-1]!==b[y]&&(b[_]=b[y],_++);b.length=_}switch(b.length){case 1:return b[0];case 2:return b[0]+" or "+b[1];default:return b.slice(0,-1).join(", ")+", or "+b[b.length-1]}}function f(m){return m?'"'+l(m)+'"':"end of input"}return"Expected "+p(s)+" but "+f(n)+" found."},{SyntaxError:e,parse:i}},(ree={get exports(){return wz},set exports(t){wz=t}}).exports&&(ree.exports=iee());const eX={deg:1,grad:.9,rad:180/Math.PI,turn:360};function hUe(t){if(t.type!=="quantity"||!(t.value===0&&t.unit===null||t.unit&&eX[t.unit]!=null))throw new q("effect:type-error",`Expected <angle>, Actual: ${K4(t)}`,{term:t})}const tX={px:1,cm:96/2.54,mm:96/2.54/10,in:96,pc:16,pt:96/72};function dUe(t){if(t.type!=="quantity"||!(t.value===0&&t.unit===null||t.unit&&tX[t.unit]!=null))throw new q("effect:type-error",`Expected <length>, Actual: ${K4(t)}`,{term:t})}function Ud(t){uUe(t);const e=t.value;return fM(e,t),t.unit==="%"?.01*e:e}function pUe(t){return cUe(t),fM(t.value,t),t.value}function fUe(t){return hUe(t),t.value*eX[t.unit]||0}function rX(t){return dUe(t),t.value*tX[t.unit]||0}function mUe(t){switch(t.colorType){case"hex":return UMe(t.value);case"named":return aye(t.value);case"function":return _Ue(t.value)}}function aye(t){if(!jhe(t))throw new q("effect:unknown-color",`color '${t}' isn't valid`,{namedColor:t});return FMe(t)}const gUe=/^rgba?/i,yUe=/^hsla?/i;function _Ue(t){if(ME(t.parameters,4),gUe.test(t.name))return[Ud(t.parameters[0]),Ud(t.parameters[1]),Ud(t.parameters[2]),t.parameters[3]?Ud(t.parameters[3]):1];if(yUe.test(t.name))return Hhe(pUe(t.parameters[0]),Ud(t.parameters[1]),Ud(t.parameters[2]),t.parameters[3]?Ud(t.parameters[3]):1);throw new q("effect:syntax-error",`Invalid color function '${t.name}'`,{colorFunction:t})}function iX(t,e,r){var i;try{return bUe(t)}catch(s){(i=r==null?void 0:r.messages)==null||i.push(s)}return null}function sX(t,e,r,i){try{const s=vUe(t);el(r,s,e)}catch(s){i.messages&&i.messages.push(s)}}function vUe(t){const e=oye(t);return e?tUe(e)?e.map(r=>r.toJSON()):e.map(({scale:r,effects:i})=>({scale:r,value:i.map(s=>s.toJSON())})):null}function bUe(t){if(!t||t.length===0)return null;if(wUe(t)){const e=[];for(const r of t)e.push({scale:r.scale,value:nee(r.value)});return e}return nee(t)}function wUe(t){const e=t[0];return!!e&&"scale"in e}function nee(t){if(!t||!t.length)return"";const e=[];for(const r of t){let i=[];switch(r.type){case"grayscale":case"sepia":case"saturate":case"invert":case"brightness":case"contrast":case"opacity":i=[Om(r,"amount")];break;case"blur":i=[Om(r,"radius","pt")];break;case"hue-rotate":i=[Om(r,"angle","deg")];break;case"drop-shadow":i=[Om(r,"xoffset","pt"),Om(r,"yoffset","pt"),Om(r,"blurRadius","pt"),xUe(r,"color")];break;case"bloom":i=[Om(r,"strength"),Om(r,"radius","pt"),Om(r,"threshold")]}const s=`${r.type}(${i.filter(Boolean).join(" ")})`;oye(s),e.push(s)}return e.join(" ")}function Om(t,e,r){if(t[e]==null)throw new q("effect:missing-parameter",`Missing parameter '${e}' in ${t.type} effect`,{effect:t});return r?t[e]+r:""+t[e]}function xUe(t,e){if(t[e]==null)throw new q("effect:missing-parameter",`Missing parameter '${e}' in ${t.type} effect`,{effect:t});const r=t[e];return`rgba(${r[0]||0}, ${r[1]||0}, ${r[2]||0}, ${r[3]/255||0})`}const TL=-3;var Eg;(function(t){t[t.ALL=0]="ALL",t[t.SOME=1]="SOME"})(Eg||(Eg={}));let TUe=class{constructor(e,r,i){this._namespace=e,this._storage=r,this._removeFunc=!1,this._hit=0,this._miss=0,this._storage.register(this),this._namespace+=":",i&&(this._storage.registerRemoveFunc(this._namespace,i),this._removeFunc=!0)}destroy(){this._storage.clear(this._namespace),this._removeFunc&&this._storage.deregisterRemoveFunc(this._namespace),this._storage.deregister(this),this._storage=null}get namespace(){return this._namespace.slice(0,-1)}get hitRate(){return this._hit/(this._hit+this._miss)}get size(){return this._storage.size}get maxSize(){return this._storage.maxSize}resetHitRate(){this._hit=this._miss=0}put(e,r,i,s=0){this._storage.put(this._namespace+e,r,i,s)}get(e){const r=this._storage.get(this._namespace+e);return r===void 0?++this._miss:++this._hit,r}pop(e){const r=this._storage.pop(this._namespace+e);return r===void 0?++this._miss:++this._hit,r}updateSize(e,r,i){this._storage.updateSize(this._namespace+e,r,i)}clear(){this._storage.clear(this._namespace)}clearAll(){this._storage.clearAll()}getStats(){return this._storage.getStats()}resetStats(){this._storage.resetStats()}},nX=class{constructor(e=10485760){this._maxSize=e,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=new Jt,this._users=new Jt}destroy(){this.clearAll(),this._removeFuncs.clear(),this._users.clear(),this._db=null}register(e){this._users.push(e)}deregister(e){this._users.removeUnordered(e)}registerRemoveFunc(e,r){this._removeFuncs.push([e,r])}deregisterRemoveFunc(e){this._removeFuncs.filterInPlace(r=>r[0]!==e)}get size(){return this._size}get maxSize(){return this._maxSize}set maxSize(e){this._maxSize=Math.max(e,0),this._checkSizeLimit()}put(e,r,i,s){const n=this._db.get(e);if(n&&(this._size-=n.size,this._db.delete(e),n.entry!==r&&this._notifyRemove(e,n.entry,Eg.ALL)),i>this._maxSize)return void this._notifyRemove(e,r,Eg.ALL);if(r===void 0)return void console.warn("Refusing to cache undefined entry ");if(!i||i<0)return void console.warn("Refusing to cache entry with invalid size "+i);const o=1+Math.max(s,TL)-TL;this._db.set(e,{entry:r,size:i,lifetime:o,lives:o}),this._size+=i,this._checkSizeLimit()}updateSize(e,r,i){const s=this._db.get(e);if(s&&s.entry===r){for(this._size-=s.size;i>this._maxSize;){const n=this._notifyRemove(e,r,Eg.SOME);if(!(v(n)&&n>0))return void this._db.delete(e);i=n}s.size=i,this._size+=i,this._checkSizeLimit()}}pop(e){const r=this._db.get(e);if(r)return this._size-=r.size,this._db.delete(e),++this._hit,r.entry;++this._miss}get(e){const r=this._db.get(e);if(r!==void 0)return this._db.delete(e),r.lives=r.lifetime,this._db.set(e,r),++this._hit,r.entry;++this._miss}getStats(){const e={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},r={},i=new Array;this._db.forEach((o,a)=>{const l=o.lifetime;i[l]=(i[l]||0)+o.size,this._users.forAll(c=>{const h=c.namespace;if(a.startsWith(h)){const p=r[h]||0;r[h]=p+o.size}})});const s={};this._users.forAll(o=>{const a=o.namespace;if(!isNaN(o.hitRate)&&o.hitRate>0){const l=r[a]||0;r[a]=l,s[a]=Math.round(100*o.hitRate)+"%"}else s[a]="0%"});const n=Object.keys(r);n.sort((o,a)=>r[a]-r[o]),n.forEach(o=>e[o]=Math.round(r[o]/2**20)+"MB / "+s[o]);for(let o=i.length-1;o>=0;--o){const a=i[o];a&&(e["Priority "+(o+TL-1)]=Math.round(a/this.size*100)+"%")}return e}resetStats(){this._hit=this._miss=0,this._users.forAll(e=>e.resetHitRate())}clear(e){this._db.forEach((r,i)=>{i.startsWith(e)&&(this._size-=r.size,this._db.delete(i),this._notifyRemove(i,r.entry,Eg.ALL))})}clearAll(){this._db.forEach((e,r)=>this._notifyRemove(r,e.entry,Eg.ALL)),this._size=0,this._db.clear()}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(e,r,i){let s;return this._removeFuncs.some(n=>{if(e.startsWith(n[0])){const o=n[1](r,i);return typeof o=="number"&&(s=o),!0}return!1}),s}_checkSizeLimit(){if(!(this._size<=this._maxSize))for(const[e,r]of this._db){if(this._db.delete(e),r.lives<=1){this._size-=r.size;const i=this._notifyRemove(e,r.entry,Eg.SOME);v(i)&&i>0&&(this._size+=i,r.lives=r.lifetime,r.size=i,this._db.set(e,r))}else--r.lives,this._db.set(e,r);if(this._size<=.9*this.maxSize)return}}},SUe=class{constructor(e,r){this._storage=new nX,this._storage.maxSize=e,r&&this._storage.registerRemoveFunc("",r)}put(e,r){this._storage.put(e,r,1,1)}pop(e){return this._storage.pop(e)}get(e){return this._storage.get(e)}clear(){this._storage.clearAll()}destroy(){this._storage.destroy()}};new SUe(1e3);new Ze([128,128,128]);const EUe=new Ze("white");function CUe(t){return Dl(t.resource).href}function hx(t,e){if(!t)return null;let r=null;return $S(t)?r=AUe(t):R4(t)&&(r=t.color?new Ze(t.color):null),r?iO(r,e):null}function AUe(t){const e=t.symbolLayers;if(!e)return null;let r=null;return e.forEach(i=>{var s;i.type==="object"&&((s=i.resource)==null?void 0:s.href)!=null||(r=i.type==="water"?i.color:v(i.material)?i.material.color:null)}),r?new Ze(r):null}function iO(t,e){if(e==null||t==null)return t;const r=t.toRgba();return r[3]=r[3]*e,new Ze(r)}function RUe(t,e,r){const i=t.symbolLayers;if(!i)return;const s=n=>{const o=v(n)?n:null;return iO(e=e??o??(r!=null?EUe:null),r)};i.forEach(n=>{var o;if(n.type!=="object"||((o=n.resource)==null?void 0:o.href)==null||e)if(n.type==="water")n.color=s(n.color);else{const a=v(n.material)?n.material.color:null,l=s(a);C(n.material)?n.material=new Ou({color:l}):n.material.color=l,r!=null&&"outline"in n&&v(n.outline)&&v(n.outline.color)&&(n.outline.color=iO(n.outline.color,r))}})}function OUe(t,e,r){(e=e??t.color)&&(t.color=iO(e,r)),r!=null&&"outline"in t&&t.outline&&t.outline.color&&(t.outline.color=iO(t.outline.color,r))}function pU(t,e,r){t&&(e||r!=null)&&(e&&(e=new Ze(e)),$S(t)?RUe(t,e,r):R4(t)&&OUe(t,e,r))}async function MUe(t,e){const r=t.symbolLayers;r&&await l4(r,async i=>PUe(i,e))}async function PUe(t,e){switch(t.type){case"extrude":$Ue(t,e);break;case"icon":case"line":case"text":IUe(t,e);break;case"path":DUe(t,e);break;case"object":await LUe(t,e)}}function IUe(t,e){const r=lye(e);v(r)&&(t.size=r)}function lye(t){for(const e of t)if(typeof e=="number")return e;return null}function $Ue(t,e){t.size=typeof e[2]=="number"?e[2]:0}async function LUe(t,e){const{resourceSize:r,symbolSize:i}=await NUe(t),s=cye(e,r,i);t.width=J3(e[0],i[0],r[0],s),t.depth=J3(e[1],i[1],r[1],s),t.height=J3(e[2],i[2],r[2],s)}function DUe(t,e){const r=cye(e,Nf,[t.width,void 0,t.height]);t.width=J3(e[0],t.width,1,r),t.height=J3(e[2],t.height,1,r)}function cye(t,e,r){for(let i=0;i<3;i++){const s=t[i];switch(s){case"symbol-value":{const n=r[i];return n!=null?n/e[i]:1}case"proportional":break;default:if(s&&e[i])return s/e[i]}}return 1}async function NUe(t){const e=await te(()=>import("./symbolLayerUtils-9a4eaf91.js"),[]),r=await e.computeObjectLayerResourceSize(t,10),{width:i,height:s,depth:n}=t,o=[i,n,s];let a=1;for(let l=0;l<3;l++){const c=o[l];if(c!=null){a=c/r[l];break}}for(let l=0;l<3;l++)o[l]==null&&(o[l]=r[l]*a);return{resourceSize:r,symbolSize:o}}function J3(t,e,r,i){switch(t){case"proportional":return r*i;case"symbol-value":return e??r;default:return t}}function FUe(t,e){const r=lye(e);if(!C(r))switch(t.type){case"simple-marker":t.size=r;break;case"picture-marker":{const i=t.width/t.height;i>1?(t.width=r,t.height=r*i):(t.width=r*i,t.height=r);break}case"simple-line":t.width=r;break;case"text":t.font.size=r}}async function UUe(t,e){if(t&&e)return $S(t)?MUe(t,e):void(R4(t)&&FUe(t,e))}function kUe(t,e,r){if(t&&e!=null)if($S(t)){const i=t.symbolLayers;i&&i.forEach(s=>{if(s&&s.type==="object")switch(r){case"tilt":s.tilt=e;break;case"roll":s.roll=e;break;default:s.heading=e}})}else R4(t)&&(t.type!=="simple-marker"&&t.type!=="picture-marker"&&t.type!=="text"||(t.angle=e))}function u2t(t){return v(t)&&t.type==="polygon-3d"&&t.symbolLayers.some(e=>e.type==="extrude")}async function VUe(t,e){return await t.fetchSymbol(e)||t.fetchCIMSymbol(e)}const BUe="<",zUe=">",GUe=g4("short-date");function jUe(t,e,r,i){let s="";e===0?s=`${BUe} `:e===r&&(s=`${zUe} `);let n=null;return n=i?nm(t,GUe):k6e(t),s+n}const HUe=new Ze([64,64,64]);function qUe(t,e){const r=[],i=t.length-1;return t.length===5?r.push(0,2,4):r.push(0,i),t.map((s,n)=>r.includes(n)?jUe(s,n,i,e):null)}async function WUe(t,e,r){let i=!1,s=[],n=[];if(t.stops){const c=t.stops;s=c.map(h=>h.value),i=c.some(h=>!!h.label),i&&(n=c.map(h=>h.label))}const o=s[0],a=s[s.length-1];if(o==null&&a==null)return null;const l=i?null:qUe(s,r??!1);return(await Promise.all(s.map(async(c,h)=>({value:c,color:t.type==="opacity"?await XUe(c,t,e):(await te(()=>Promise.resolve().then(()=>bX),void 0)).getColor(t,c),label:i?n[h]:(l==null?void 0:l[h])??""})))).reverse()}async function XUe(t,e,r=HUe){const i=new Ze(r),s=(await te(()=>Promise.resolve().then(()=>bX),void 0)).getOpacity(e,t);return s!=null&&(i.a=s),i}var xz;let FA=xz=class extends ve{constructor(t){super(t),this.color=null,this.ratio=null}clone(){return new xz({color:this.color,ratio:this.ratio})}};u([d({type:Ze,json:{type:[Gi],default:null,write:!0}})],FA.prototype,"color",void 0),u([d({type:Number,json:{write:!0}})],FA.prototype,"ratio",void 0),FA=xz=u([I("esri.renderers.support.HeatmapColorStop")],FA);const K3=FA;function YUe(t){if(!t.colorStops)return[];const e=[...t.colorStops].filter(i=>{var s;return((s=i.color)==null?void 0:s.a)>0});let r=e.length-1;if(e&&e[0]){const i=e[r];i&&i.ratio!==1&&(e.push(new K3({ratio:1,color:i.color})),r++)}return e.map((i,s)=>{var o,a;let n="";return s===0?n=((o=t.legendOptions)==null?void 0:o.minLabel)||"low":s===r&&(n=((a=t.legendOptions)==null?void 0:a.maxLabel)||"high"),{color:i.color,label:n,ratio:i.ratio}}).reverse()}se.getLogger("esri.renderers.support.utils");async function zc(t,e,r){JH(t,e,()=>[]).push(...r)}async function ZUe(t){var r,i;const e=new Map;if(!t)return e;if("visualVariables"in t&&t.visualVariables){const s=t.visualVariables.filter(n=>n.type==="color");for(const n of s){const o=(await WUe(n)??[]).map(a=>a.color);await zc(e,n.field||n.valueExpression,o)}}if(t.type==="heatmap"){const s=YUe(t).map(n=>n.color);await zc(e,t.field||t.valueExpression,s)}else if(t.type==="pie-chart"){for(const s of t.attributes)await zc(e,s.field||s.valueExpression,[s.color]);await zc(e,"default",[(r=t==null?void 0:t.othersCategory)==null?void 0:r.color,hx(t.backgroundFillSymbol,null)])}else if(t.type==="dot-density"){for(const s of t.attributes)await zc(e,s.field||s.valueExpression,[s.color]);await zc(e,"default",[t.backgroundColor])}else if(t.type==="unique-value")if(((i=t.authoringInfo)==null?void 0:i.type)==="predominance")for(const s of t.uniqueValueInfos??[])await zc(e,s.value.toString(),[hx(s.symbol,null)]);else{const s=(t.uniqueValueInfos??[]).map(c=>hx(c.symbol,null)),{field:n,field2:o,field3:a,valueExpression:l}=t;(n||l)&&await zc(e,n||l,s),o&&await zc(e,o,s),a&&await zc(e,a,s)}else if(t.type==="class-breaks"){const s=t.classBreakInfos.map(a=>hx(a.symbol,null)),{field:n,valueExpression:o}=t;await zc(e,n??o,s)}else t.type==="simple"&&await zc(e,"default",[hx(t.symbol,null)]);return"defaultSymbol"in t&&t.defaultSymbol&&await zc(e,"default",[hx(t.defaultSymbol,null)]),e.forEach((s,n)=>{const o=zO(s.filter(Boolean),(a,l)=>JSON.stringify(a)===JSON.stringify(l));e.set(n,o)}),e}var Tz;let UA=Tz=class extends ve{constructor(t){super(t),this.name=null,this.code=null}clone(){return new Tz({name:this.name,code:this.code})}};u([d({type:String,json:{write:!0}})],UA.prototype,"name",void 0),u([d({type:[String,Number],json:{write:!0}})],UA.prototype,"code",void 0),UA=Tz=u([I("esri.layers.support.CodedValue")],UA);const JUe=new mr({inherited:"inherited",codedValue:"coded-value",range:"range"});let kA=class extends ve{constructor(e){super(e),this.name=null,this.type=null}};u([d({type:String,json:{write:!0}})],kA.prototype,"name",void 0),u([gt(JUe)],kA.prototype,"type",void 0),kA=u([I("esri.layers.support.Domain")],kA);const Q4=kA;var Sz;let VA=Sz=class extends Q4{constructor(t){super(t),this.codedValues=null,this.type="coded-value"}getName(t){let e=null;if(this.codedValues){const r=String(t);this.codedValues.some(i=>(String(i.code)===r&&(e=i.name),!!e))}return e}clone(){return new Sz({codedValues:ne(this.codedValues),name:this.name})}};u([d({type:[UA],json:{write:!0}})],VA.prototype,"codedValues",void 0),u([gt({codedValue:"coded-value"})],VA.prototype,"type",void 0),VA=Sz=u([I("esri.layers.support.CodedValueDomain")],VA);const uye=VA;var Ez;let SL=Ez=class extends Q4{constructor(t){super(t),this.type="inherited"}clone(){return new Ez}};u([gt({inherited:"inherited"})],SL.prototype,"type",void 0),SL=Ez=u([I("esri.layers.support.InheritedDomain")],SL);const hye=SL;var Cz;let IT=Cz=class extends Q4{constructor(t){super(t),this.maxValue=null,this.minValue=null,this.type="range"}clone(){return new Cz({maxValue:this.maxValue,minValue:this.minValue,name:this.name})}};u([d({type:Number,json:{type:[Number],read:{source:"range",reader:(t,e)=>e.range&&e.range[1]},write:{enabled:!1,overridePolicy(){return{enabled:this.maxValue!=null&&this.minValue==null}},target:"range",writer(t,e,r){e[r]=[this.minValue||0,t]}}}})],IT.prototype,"maxValue",void 0),u([d({type:Number,json:{type:[Number],read:{source:"range",reader:(t,e)=>e.range&&e.range[0]},write:{target:"range",writer(t,e,r){e[r]=[t,this.maxValue||0]}}}})],IT.prototype,"minValue",void 0),u([gt({range:"range"})],IT.prototype,"type",void 0),IT=Cz=u([I("esri.layers.support.RangeDomain")],IT);const dye=IT,pye={key:"type",base:Q4,typeMap:{range:dye,"coded-value":uye,inherited:hye}};function oX(t){if(!t||!t.type)return null;switch(t.type){case"range":return dye.fromJSON(t);case"codedValue":return uye.fromJSON(t);case"inherited":return hye.fromJSON(t)}return null}const KUe=new mr({esriFieldTypeSmallInteger:"small-integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"single",esriFieldTypeDouble:"double",esriFieldTypeLong:"long",esriFieldTypeString:"string",esriFieldTypeDate:"date",esriFieldTypeOID:"oid",esriFieldTypeGeometry:"geometry",esriFieldTypeBlob:"blob",esriFieldTypeRaster:"raster",esriFieldTypeGUID:"guid",esriFieldTypeGlobalID:"global-id",esriFieldTypeXML:"xml"});var Az;const QUe=new mr({binary:"binary",coordinate:"coordinate",countOrAmount:"count-or-amount",dateAndTime:"date-and-time",description:"description",locationOrPlaceName:"location-or-place-name",measurement:"measurement",nameOrTitle:"name-or-title",none:"none",orderedOrRanked:"ordered-or-ranked",percentageOrRatio:"percentage-or-ratio",typeOrCategory:"type-or-category",uniqueIdentifier:"unique-identifier"});let Fa=Az=class extends ve{constructor(t){super(t),this.alias=null,this.defaultValue=void 0,this.description=null,this.domain=null,this.editable=!0,this.length=-1,this.name=null,this.nullable=!0,this.type=null,this.valueType=null,this.visible=!0}readDescription(t,{description:e}){let r=null;try{r=e?JSON.parse(e):null}catch{}return(r==null?void 0:r.value)??null}readValueType(t,{description:e}){let r=null;try{r=e?JSON.parse(e):null}catch{}return r?QUe.fromJSON(r.fieldValueType):null}clone(){return new Az({alias:this.alias,defaultValue:this.defaultValue,description:this.description,domain:this.domain&&this.domain.clone()||null,editable:this.editable,length:this.length,name:this.name,nullable:this.nullable,type:this.type,valueType:this.valueType,visible:this.visible})}};u([d({type:String,json:{write:!0}})],Fa.prototype,"alias",void 0),u([d({type:[String,Number],json:{write:{allowNull:!0}}})],Fa.prototype,"defaultValue",void 0),u([d()],Fa.prototype,"description",void 0),u([Fe("description")],Fa.prototype,"readDescription",null),u([d({types:pye,json:{read:{reader:oX},write:!0}})],Fa.prototype,"domain",void 0),u([d({type:Boolean,json:{write:!0}})],Fa.prototype,"editable",void 0),u([d({type:Gi,json:{write:!0}})],Fa.prototype,"length",void 0),u([d({type:String,json:{write:!0}})],Fa.prototype,"name",void 0),u([d({type:Boolean,json:{write:!0}})],Fa.prototype,"nullable",void 0),u([gt(KUe)],Fa.prototype,"type",void 0),u([d()],Fa.prototype,"valueType",void 0),u([Fe("valueType",["description"])],Fa.prototype,"readValueType",null),u([d({type:Boolean,json:{read:!1}})],Fa.prototype,"visible",void 0),Fa=Az=u([I("esri.layers.support.Field")],Fa);const e5=Fa;var Rz;let $T=Rz=class extends ve{constructor(t){super(t),this.type="map-layer"}clone(){const{mapLayerId:t,gdbVersion:e}=this;return new Rz({mapLayerId:t,gdbVersion:e})}};u([gt({mapLayer:"map-layer"})],$T.prototype,"type",void 0),u([d({type:Gi,json:{write:!0}})],$T.prototype,"mapLayerId",void 0),u([d({type:String,json:{write:!0}})],$T.prototype,"gdbVersion",void 0),$T=Rz=u([I("esri.layers.support.source.MapLayerSource")],$T);var Oz;let ig=Oz=class extends ve{constructor(t){super(t),this.type="query-table"}clone(){const{workspaceId:t,query:e,oidFields:r,spatialReference:i,geometryType:s}=this,n={workspaceId:t,query:e,oidFields:r,spatialReference:(i==null?void 0:i.clone())??void 0,geometryType:s};return new Oz(n)}};u([gt({queryTable:"query-table"})],ig.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],ig.prototype,"workspaceId",void 0),u([d({type:String,json:{write:!0}})],ig.prototype,"query",void 0),u([d({type:String,json:{write:!0}})],ig.prototype,"oidFields",void 0),u([d({type:et,json:{write:!0}})],ig.prototype,"spatialReference",void 0),u([gt(Ade)],ig.prototype,"geometryType",void 0),ig=Oz=u([I("esri.layers.support.source.QueryTableDataSource")],ig);var Mz;let LT=Mz=class extends ve{constructor(t){super(t),this.type="raster"}clone(){const{workspaceId:t,dataSourceName:e}=this;return new Mz({workspaceId:t,dataSourceName:e})}};u([gt({raster:"raster"})],LT.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],LT.prototype,"dataSourceName",void 0),u([d({type:String,json:{write:!0}})],LT.prototype,"workspaceId",void 0),LT=Mz=u([I("esri.layers.support.source.RasterDataSource")],LT);var Pz;let $1=Pz=class extends ve{constructor(t){super(t),this.type="table"}clone(){const{workspaceId:t,gdbVersion:e,dataSourceName:r}=this;return new Pz({workspaceId:t,gdbVersion:e,dataSourceName:r})}};u([gt({table:"table"})],$1.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],$1.prototype,"workspaceId",void 0),u([d({type:String,json:{write:!0}})],$1.prototype,"gdbVersion",void 0),u([d({type:String,json:{write:!0}})],$1.prototype,"dataSourceName",void 0),$1=Pz=u([I("esri.layers.support.source.TableDataSource")],$1);var Iz,$z;const e8e=Ta()({esriLeftInnerJoin:"left-inner-join",esriLeftOuterJoin:"left-outer-join"});let Kc=Iz=class extends ve{constructor(t){super(t),this.type="join-table"}readLeftTableSource(t,e,r){return oee()(t,e,r)}castLeftTableSource(t){return up(Lz(),t)}readRightTableSource(t,e,r){return oee()(t,e,r)}castRightTableSource(t){return up(Lz(),t)}clone(){const{leftTableKey:t,rightTableKey:e,leftTableSource:r,rightTableSource:i,joinType:s}=this,n={leftTableKey:t,rightTableKey:e,leftTableSource:(r==null?void 0:r.clone())??void 0,rightTableSource:(i==null?void 0:i.clone())??void 0,joinType:s};return new Iz(n)}};u([gt({joinTable:"join-table"})],Kc.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Kc.prototype,"leftTableKey",void 0),u([d({type:String,json:{write:!0}})],Kc.prototype,"rightTableKey",void 0),u([d({json:{write:!0}})],Kc.prototype,"leftTableSource",void 0),u([Fe("leftTableSource")],Kc.prototype,"readLeftTableSource",null),u([cr("leftTableSource")],Kc.prototype,"castLeftTableSource",null),u([d({json:{write:!0}})],Kc.prototype,"rightTableSource",void 0),u([Fe("rightTableSource")],Kc.prototype,"readRightTableSource",null),u([cr("rightTableSource")],Kc.prototype,"castRightTableSource",null),u([gt(e8e)],Kc.prototype,"joinType",void 0),Kc=Iz=u([I("esri.layers.support.source.JoinTableDataSource")],Kc);let fU=null;function oee(){return fU||(fU=dv({types:Lz()})),fU}let mU=null;function Lz(){return mU||(mU={key:"type",base:null,typeMap:{"data-layer":kd,"map-layer":$T}}),mU}const t8e={key:"type",base:null,typeMap:{"join-table":Kc,"query-table":ig,raster:LT,table:$1}};let kd=$z=class extends ve{constructor(t){super(t),this.type="data-layer"}clone(){const{fields:t,dataSource:e}=this;return new $z({fields:t,dataSource:e})}};u([gt({dataLayer:"data-layer"})],kd.prototype,"type",void 0),u([d({type:[e5],json:{write:!0}})],kd.prototype,"fields",void 0),u([d({types:t8e,json:{write:!0}})],kd.prototype,"dataSource",void 0),kd=$z=u([I("esri.layers.support.source.DataLayerSource")],kd),kd.from=us(kd);function r8e(t,e){return e?{...e,query:{...t??{},...e.query}}:{query:t}}function aX(t){return typeof t=="string"?sl(t):ne(t)}function i8e(t,e,r){const i={};for(const s in t){if(s==="declaredClass")continue;const n=t[s];if(n!=null&&typeof n!="function")if(Array.isArray(n)){i[s]=[];for(let o=0;o<n.length;o++)i[s][o]=i8e(n[o])}else if(typeof n=="object")if(n.toJSON){const o=n.toJSON(r&&r[s]);i[s]=e?o:JSON.stringify(o)}else i[s]=e?n:JSON.stringify(n);else i[s]=n}return i}const xP={102100:{maxX:20037508342788905e-9,minX:-20037508342788905e-9,plus180Line:new Eu({paths:[[[20037508342788905e-9,-20037508342788905e-9],[20037508342788905e-9,20037508342788905e-9]]],spatialReference:et.WebMercator}),minus180Line:new Eu({paths:[[[-20037508342788905e-9,-20037508342788905e-9],[-20037508342788905e-9,20037508342788905e-9]]],spatialReference:et.WebMercator})},4326:{maxX:180,minX:-180,plus180Line:new Eu({paths:[[[180,-180],[180,180]]],spatialReference:et.WGS84}),minus180Line:new Eu({paths:[[[-180,-180],[-180,180]]],spatialReference:et.WGS84})}};function Fb(t,e){return Math.ceil((t-e)/(2*e))}function fye(t,e){const r=Q3(t);for(const i of r)for(const s of i)s[0]+=e;return t}function Q3(t){return Hb(t)?t.rings:t.paths}async function s8e(t,e,r,i){const s=aX(t),n=e[0].spatialReference,o={...i,query:{...s.query,f:"json",sr:JSON.stringify(n),target:JSON.stringify({geometryType:vE(e[0]),geometries:e}),cutter:JSON.stringify(r)}},a=await Ni(s.path+"/cut",o),{cutIndexes:l,geometries:c=[]}=a.data;return{cutIndexes:l,geometries:c.map(h=>{const p=il(h);return p.spatialReference=n,p})}}function n8e(t){return{geometryType:vE(t[0]),geometries:t.map(e=>e.toJSON())}}function mye(t,e,r){const i=tIe(e);return t.map(s=>{const n=i.fromJSON(s);return n.spatialReference=r,n})}async function o8e(t,e,r){const i=typeof t=="string"?sl(t):t,s=e[0].spatialReference,n=vE(e[0]),o={...r,query:{...i.query,f:"json",sr:s.wkid?s.wkid:JSON.stringify(s),geometries:JSON.stringify(n8e(e))}},{data:a}=await Ni(i.path+"/simplify",o);return mye(a.geometries,n,s)}const gye=se.getLogger("esri.geometry.support.normalizeUtils");function a8e(t){return t.type==="polygon"}function l8e(t){return t[0].type==="polygon"}function c8e(t){return t[0].type==="polyline"}function u8e(t,e){if(!(t instanceof Eu||t instanceof pp)){const s="straightLineDensify: the input geometry is neither polyline nor polygon";throw gye.error(s),new q(s)}const r=Q3(t),i=[];for(const s of r){const n=[];i.push(n),n.push([s[0][0],s[0][1]]);for(let o=0;o<s.length-1;o++){const a=s[o][0],l=s[o][1],c=s[o+1][0],h=s[o+1][1],p=Math.sqrt((c-a)*(c-a)+(h-l)*(h-l)),f=(h-l)/p,m=(c-a)/p,y=p/e;if(y>1){for(let T=1;T<=y-1;T++){const S=T*e,E=m*S+a,O=f*S+l;n.push([E,O])}const _=(p+Math.floor(y-1)*e)/2,b=m*_+a,x=f*_+l;n.push([b,x])}n.push([c,h])}}return a8e(t)?new pp({rings:i,spatialReference:t.spatialReference}):new Eu({paths:i,spatialReference:t.spatialReference})}function aee(t,e,r){if(e){const i=u8e(t,1e6);t=_2(i,!0)}return r&&(t=fye(t,r)),t}function lee(t,e,r){if(Array.isArray(t)){const i=t[0];if(i>e){const s=Fb(i,e);t[0]=i+s*(-2*e)}else if(i<r){const s=Fb(i,r);t[0]=i+s*(-2*r)}}else{const i=t.x;if(i>e){const s=Fb(i,e);t=t.clone().offset(s*(-2*e),0)}else if(i<r){const s=Fb(i,r);t=t.clone().offset(s*(-2*r),0)}}return t}function h8e(t,e){let r=-1;for(let i=0;i<e.cutIndexes.length;i++){const s=e.cutIndexes[i],n=e.geometries[i],o=Q3(n);for(let a=0;a<o.length;a++){const l=o[a];l.some(c=>{if(c[0]<180)return!0;{let h=0;for(let f=0;f<l.length;f++){const m=l[f][0];h=m>h?m:h}h=Number(h.toFixed(9));const p=-360*Fb(h,180);for(let f=0;f<l.length;f++){const m=n.getPoint(a,f);n.setPoint(a,f,m.clone().offset(p,0))}return!0}})}if(s===r){if(l8e(t))for(const a of Q3(n))t[s]=t[s].addRing(a);else if(c8e(t))for(const a of Q3(n))t[s]=t[s].addPath(a)}else r=s,t[s]=n}return t}async function yye(t,e,r){if(!Array.isArray(t))return yye([t],e);e&&typeof e!="string"&&gye.warn("normalizeCentralMeridian()","The url object is deprecated, use the url string instead");const i=typeof e=="string"?e:(e==null?void 0:e.url)??Yr.geometryServiceUrl;let s,n,o,a,l,c,h,p,f=0;const m=[],y=[];for(const E of t)if(C(E))y.push(E);else if(s||(s=E.spatialReference,n=I_(s),o=s.isWebMercator,c=o?102100:4326,a=xP[c].maxX,l=xP[c].minX,h=xP[c].plus180Line,p=xP[c].minus180Line),n)if(E.type==="mesh")y.push(E);else if(E.type==="point")y.push(lee(E.clone(),a,l));else if(E.type==="multipoint"){const O=E.clone();O.points=O.points.map(R=>lee(R,a,l)),y.push(O)}else if(E.type==="extent"){const O=E.clone()._normalize(!1,!1,n);y.push(O.rings?new pp(O):O)}else if(E.extent){const O=E.extent,R=Fb(O.xmin,l)*(2*a);let L=R===0?E.clone():fye(E.clone(),R);O.offset(R,0),O.intersects(h)&&O.xmax!==a?(f=O.xmax>f?O.xmax:f,L=aee(L,o),m.push(L),y.push("cut")):O.intersects(p)&&O.xmin!==l?(f=O.xmax*(2*a)>f?O.xmax*(2*a):f,L=aee(L,o,360),m.push(L),y.push("cut")):y.push(L)}else y.push(E.clone());else y.push(E);let _=Fb(f,a),b=-90;const x=_,T=new Eu;for(;_>0;){const E=360*_-180;T.addPath([[E,b],[E,-1*b]]),b*=-1,_--}if(m.length>0&&x>0){const E=h8e(m,await s8e(i,m,T,r)),O=[],R=[];for(let U=0;U<y.length;U++){const B=y[U];if(B!=="cut")R.push(B);else{const z=E.shift(),G=t[U];v(G)&&G.type==="polygon"&&G.rings&&G.rings.length>1&&z.rings.length>=G.rings.length?(O.push(z),R.push("simplify")):R.push(o?jf(z):z)}}if(!O.length)return R;const L=await o8e(i,O,r),P=[];for(let U=0;U<R.length;U++){const B=R[U];B!=="simplify"?P.push(B):P.push(o?jf(L.shift()):L.shift())}return P}const S=[];for(let E=0;E<y.length;E++){const O=y[E];if(O!=="cut")S.push(O);else{const R=m.shift();S.push(o===!0?jf(R):R)}}return S}function _ye(t){const e={};for(const r in t){if(r==="declaredClass")continue;const i=t[r];if(i!=null&&typeof i!="function")if(Array.isArray(i)){e[r]=[];for(let s=0;s<i.length;s++)e[r][s]=_ye(i[s])}else typeof i=="object"?i.toJSON&&(e[r]=JSON.stringify(i)):e[r]=i}return e}var J0;(function(t){t[t.varint=0]="varint",t[t.fixed64=1]="fixed64",t[t.delimited=2]="delimited",t[t.fixed32=5]="fixed32",t[t.unknown=99]="unknown"})(J0||(J0={}));const cee=4294967296,d8e=new TextDecoder("utf-8"),p8e=de("safari")||de("ios")?6:de("ff")?12:32;let Dz=class EL{constructor(e,r,i=0,s=e?e.byteLength:0){this._tag=0,this._dataType=J0.unknown,this._init(e,r,i,s)}_init(e,r,i,s){this._data=e,this._dataView=r,this._pos=i,this._end=s}asUnsafe(){return this}clone(){return new EL(this._data,this._dataView,this._pos,this._end)}pos(){return this._pos}move(e){this._pos=e}nextTag(e){for(;;){if(this._pos===this._end)return!1;const r=this._decodeVarint();if(this._tag=r>>3,this._dataType=7&r,!e||e===this._tag)break;this.skip()}return!0}next(){if(this._pos===this._end)return!1;const e=this._decodeVarint();return this._tag=e>>3,this._dataType=7&e,!0}empty(){return this._pos>=this._end}tag(){return this._tag}getInt32(){return this._decodeVarint()}getInt64(){return this._decodeVarint()}getUInt32(){let e=4294967295;return e=(127&this._data[this._pos])>>>0,this._data[this._pos++]<128?e:(e=(e|(127&this._data[this._pos])<<7)>>>0,this._data[this._pos++]<128?e:(e=(e|(127&this._data[this._pos])<<14)>>>0,this._data[this._pos++]<128?e:(e=(e|(127&this._data[this._pos])<<21)>>>0,this._data[this._pos++]<128?e:(e=(e|(15&this._data[this._pos])<<28)>>>0,this._data[this._pos++]<128?e:void 0))))}getUInt64(){return this._decodeVarint()}getSInt32(){const e=this.getUInt32();if(e!==void 0)return e>>>1^-(1&e)|0}getSInt64(){return this._decodeSVarint()}getBool(){const e=this._data[this._pos]!==0;return this._skip(1),e}getEnum(){return this._decodeVarint()}getFixed64(){const e=this._dataView,r=this._pos,i=e.getUint32(r,!0)+e.getUint32(r+4,!0)*cee;return this._skip(8),i}getSFixed64(){const e=this._dataView,r=this._pos,i=e.getUint32(r,!0)+e.getInt32(r+4,!0)*cee;return this._skip(8),i}getDouble(){const e=this._dataView.getFloat64(this._pos,!0);return this._skip(8),e}getFixed32(){const e=this._dataView.getUint32(this._pos,!0);return this._skip(4),e}getSFixed32(){const e=this._dataView.getInt32(this._pos,!0);return this._skip(4),e}getFloat(){const e=this._dataView.getFloat32(this._pos,!0);return this._skip(4),e}getString(){const e=this._getLength(),r=this._pos,i=this._toString(this._data,r,r+e);return this._skip(e),i}getBytes(){const e=this._getLength(),r=this._pos,i=this._toBytes(this._data,r,r+e);return this._skip(e),i}getLength(){return this._getLengthUnsafe()}processMessageWithArgs(e,r,i,s){const n=this.getMessage(),o=e(n,r,i,s);return n.release(),o}processMessage(e){const r=this.getMessage(),i=e(r);return r.release(),i}getMessage(){const e=this._getLength(),r=EL.pool.acquire();return r._init(this._data,this._dataView,this._pos,this._pos+e),this._skip(e),r}release(){EL.pool.release(this)}dataType(){return this._dataType}skip(){switch(this._dataType){case J0.varint:this._decodeVarint();break;case J0.fixed64:this._skip(8);break;case J0.delimited:this._skip(this._getLength());break;case J0.fixed32:this._skip(4);break;default:throw new Error("Invalid data type!")}}skipLen(e){this._skip(e)}_skip(e){if(this._pos+e>this._end)throw new Error("Attempt to skip past the end of buffer!");this._pos+=e}_decodeVarint(){const e=this._data;let r=this._pos,i=0,s=0;if(this._end-r>=10)do{if(s=e[r++],i|=127&s,(128&s)==0||(s=e[r++],i|=(127&s)<<7,(128&s)==0)||(s=e[r++],i|=(127&s)<<14,(128&s)==0)||(s=e[r++],i|=(127&s)<<21,(128&s)==0)||(s=e[r++],i+=268435456*(127&s),(128&s)==0)||(s=e[r++],i+=34359738368*(127&s),(128&s)==0)||(s=e[r++],i+=4398046511104*(127&s),(128&s)==0)||(s=e[r++],i+=562949953421312*(127&s),(128&s)==0)||(s=e[r++],i+=72057594037927940*(127&s),(128&s)==0)||(s=e[r++],i+=9223372036854776e3*(127&s),(128&s)==0))break;throw new Error("Varint too long!")}while(0);else{let n=1;for(;r!==this._end&&(s=e[r],(128&s)!=0);)++r,i+=(127&s)*n,n*=128;if(r===this._end)throw new Error("Varint overrun!");++r,i+=s*n}return this._pos=r,i}_decodeSVarint(){const e=this._data;let r=this._pos,i=0,s=0;const n=1&e[r];if(this._end-r>=10)do{if(s=e[r++],i|=127&s,(128&s)==0||(s=e[r++],i|=(127&s)<<7,(128&s)==0)||(s=e[r++],i|=(127&s)<<14,(128&s)==0)||(s=e[r++],i|=(127&s)<<21,(128&s)==0)||(s=e[r++],i+=268435456*(127&s),(128&s)==0)||(s=e[r++],i+=34359738368*(127&s),(128&s)==0)||(s=e[r++],i+=4398046511104*(127&s),(128&s)==0)||(s=e[r++],i+=562949953421312*(127&s),(128&s)==0)||(s=e[r++],i+=72057594037927940*(127&s),(128&s)==0)||(s=e[r++],i+=9223372036854776e3*(127&s),(128&s)==0))break;throw new Error("Varint too long!")}while(0);else{let o=1;for(;r!==this._end&&(s=e[r],(128&s)!=0);)++r,i+=(127&s)*o,o*=128;if(r===this._end)throw new Error("Varint overrun!");++r,i+=s*o}return this._pos=r,n?-(i+1)/2:i/2}_getLength(){if(this._dataType!==J0.delimited)throw new Error("Not a delimited data type!");return this._decodeVarint()}_getLengthUnsafe(){return this.getUInt32()}_toString(e,r,i){if((i=Math.min(this._end,i))-r>p8e){const o=e.subarray(r,i);return d8e.decode(o)}let s="",n="";for(let o=r;o<i;++o){const a=e[o];128&a?n+="%"+a.toString(16):(s+=decodeURIComponent(n)+String.fromCharCode(a),n="")}return n.length&&(s+=decodeURIComponent(n)),s}_toBytes(e,r,i){return i=Math.min(this._end,i),new Uint8Array(e.buffer,r,i-r)}};Dz.pool=new Co(Dz,void 0,t=>{t._data=null,t._dataView=null});let yp=class CL{constructor(e=[],r=[],i=!1){this.lengths=e??[],this.coords=r??[],this.hasIndeterminateRingOrder=i}static fromRect(e){const[r,i,s,n]=e,o=s-r,a=n-i;return new CL([5],[r,i,o,0,0,a,-o,0,0,-a])}get isPoint(){return this.lengths.length===0}get maxLength(){return Math.max(...this.lengths)}get size(){return this.lengths.reduce((e,r)=>e+r)}forEachVertex(e){let r=0;this.lengths.length||e(this.coords[0],this.coords[1]);for(let i=0;i<this.lengths.length;i++){const s=this.lengths[i];for(let n=0;n<s;n++)e(this.coords[2*(n+r)],this.coords[2*(n+r)+1]);r+=s}}clone(e){return e?(e.set(this.coords),new CL(this.lengths.slice(),e,this.hasIndeterminateRingOrder)):new CL(this.lengths.slice(),this.coords.slice(),this.hasIndeterminateRingOrder)}},Q_=class vye{constructor(e=null,r={},i,s){this.geometry=e,this.attributes=r,this.centroid=i,this.objectId=s,this.displayId=0,this.geohashX=0,this.geohashY=0}weakClone(){const e=new vye(this.geometry,this.attributes,this.centroid,this.objectId);return e.displayId=this.displayId,e.geohashX=this.geohashX,e.geohashY=this.geohashY,e}};function f8e(t){return!(C(t.geometry)||!t.geometry.coords||!t.geometry.coords.length)}let d2t=class extends Q_{},bye=class wye{constructor(){this.objectIdFieldName=null,this.globalIdFieldName=null,this.geohashFieldName=null,this.geometryProperties=null,this.geometryType=null,this.spatialReference=null,this.hasZ=!1,this.hasM=!1,this.features=[],this.fields=[],this.transform=null,this.exceededTransferLimit=!1,this.uniqueIdField=null,this.queryGeometryType=null,this.queryGeometry=null}weakClone(){const e=new wye;return e.objectIdFieldName=this.objectIdFieldName,e.globalIdFieldName=this.globalIdFieldName,e.geohashFieldName=this.geohashFieldName,e.geometryProperties=this.geometryProperties,e.geometryType=this.geometryType,e.spatialReference=this.spatialReference,e.hasZ=this.hasZ,e.hasM=this.hasM,e.features=this.features,e.fields=this.fields,e.transform=this.transform,e.exceededTransferLimit=this.exceededTransferLimit,e.uniqueIdField=this.uniqueIdField,e.queryGeometry=this.queryGeometry,e.queryGeometryType=this.queryGeometryType,e}};const xye=["esriGeometryPoint","esriGeometryMultipoint","esriGeometryPolyline","esriGeometryPolygon"];let f2t=class{constructor(e){this._options=e,this.geometryTypes=xye,this._coordinatePtr=0,this._vertexDimension=0}createFeatureResult(){return new bye}prepareFeatures(e){this._vertexDimension=2,e.hasZ&&this._vertexDimension++,e.hasM&&this._vertexDimension++}finishFeatureResult(e){if(!e||!e.features||!e.hasZ||!this._options.sourceSpatialReference||!e.spatialReference||Tn(e.spatialReference,this._options.sourceSpatialReference)||e.spatialReference.vcsWkid)return;const r=uw(this._options.sourceSpatialReference)/uw(e.spatialReference);if(r!==1)for(const i of e.features){if(!f8e(i))continue;const s=i.geometry.coords;for(let n=2;n<s.length;n+=3)s[n]*=r}}addFeature(e,r){e.features.push(r)}createFeature(){return new Q_}createSpatialReference(){return{wkid:0}}createGeometry(){return new yp}addField(e,r){e.fields.push(r)}allocateCoordinates(e){e.coords.length=e.lengths.reduce((r,i)=>r+i,0)*this._vertexDimension,this._coordinatePtr=0}addCoordinate(e,r){e.coords[this._coordinatePtr++]=r}addCoordinatePoint(e,r){e.coords.push(r)}addLength(e,r){e.lengths.push(r)}addQueryGeometry(e,r){e.queryGeometry=r.queryGeometry,e.queryGeometryType=r.queryGeometryType}createPointGeometry(){return new yp}};const uee=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeString","esriFieldTypeDate","esriFieldTypeOID","esriFieldTypeGeometry","esriFieldTypeBlob","esriFieldTypeRaster","esriFieldTypeGUID","esriFieldTypeGlobalID","esriFieldTypeXML"],hee=["sqlTypeBigInt","sqlTypeBinary","sqlTypeBit","sqlTypeChar","sqlTypeDate","sqlTypeDecimal","sqlTypeDouble","sqlTypeFloat","sqlTypeGeometry","sqlTypeGUID","sqlTypeInteger","sqlTypeLongNVarchar","sqlTypeLongVarbinary","sqlTypeLongVarchar","sqlTypeNChar","sqlTypeNVarchar","sqlTypeOther","sqlTypeReal","sqlTypeSmallInt","sqlTypeSqlXml","sqlTypeTime","sqlTypeTimestamp","sqlTypeTimestamp2","sqlTypeTinyInt","sqlTypeVarbinary","sqlTypeVarchar"],dee=["upperLeft","lowerLeft"];function pee(t){return t>=uee.length?null:uee[t]}function m8e(t){return t>=hee.length?null:hee[t]}function fee(t){return t>=dee.length?null:dee[t]}function mee(t,e){return e>=t.geometryTypes.length?null:t.geometryTypes[e]}function g8e(t,e,r){const s=t.asUnsafe(),n=e.createPointGeometry(r);for(;s.next();)switch(s.tag()){case 3:{const o=s.getUInt32(),a=s.pos()+o;let l=0;for(;s.pos()<a;)e.addCoordinatePoint(n,s.getSInt64(),l++);break}default:s.skip()}return n}function y8e(t,e,r){const n=t.asUnsafe(),o=e.createGeometry(r),a=2+(r.hasZ?1:0)+(r.hasM?1:0);for(;n.next();)switch(n.tag()){case 2:{const l=n.getUInt32(),c=n.pos()+l;let h=0;for(;n.pos()<c;)e.addLength(o,n.getUInt32(),h++);break}case 3:{const l=n.getUInt32(),c=n.pos()+l;let h=0;for(e.allocateCoordinates(o);n.pos()<c;)e.addCoordinate(o,n.getSInt64(),h),h++,h===a&&(h=0);break}default:n.skip()}return o}function _8e(t){const s=t.asUnsafe(),n=new yp;let o="esriGeometryPoint";for(;s.next();)switch(s.tag()){case 2:{const a=s.getUInt32(),l=s.pos()+a;for(;s.pos()<l;)n.lengths.push(s.getUInt32());break}case 3:{const a=s.getUInt32(),l=s.pos()+a;for(;s.pos()<l;)n.coords.push(s.getSInt64());break}case 1:o=xye[s.getEnum()];break;default:s.skip()}return{queryGeometry:n,queryGeometryType:o}}function v8e(t){const h=t.asUnsafe();for(;h.next();)switch(h.tag()){case 1:return h.getString();case 2:return h.getFloat();case 3:return h.getDouble();case 4:return h.getSInt32();case 5:return h.getUInt32();case 6:return h.getInt64();case 7:return h.getUInt64();case 8:return h.getSInt64();case 9:return h.getBool();default:return h.skip(),null}return null}function b8e(t){const a=t.asUnsafe(),l={type:pee(0)};for(;a.next();)switch(a.tag()){case 1:l.name=a.getString();break;case 2:l.type=pee(a.getEnum());break;case 3:l.alias=a.getString();break;case 4:l.sqlType=m8e(a.getEnum());break;case 5:a.skip();break;case 6:l.defaultValue=a.getString();break;default:a.skip()}return l}function w8e(t){const i={},s=t.asUnsafe();for(;s.next();)switch(s.tag()){case 1:i.name=s.getString();break;case 2:i.isSystemMaintained=s.getBool();break;default:s.skip()}return i}function x8e(t,e,r,i){const a=e.createFeature(r);let l=0;for(;t.next();)switch(t.tag()){case 1:{const c=i[l++].name;a.attributes[c]=t.processMessage(v8e);break}case 2:a.geometry=t.processMessageWithArgs(y8e,e,r);break;case 4:a.centroid=t.processMessageWithArgs(g8e,e,r);break;default:t.skip()}return a}function T8e(t){const n=[1,1,1,1],o=t.asUnsafe();for(;o.next();)switch(o.tag()){case 1:n[0]=o.getDouble();break;case 2:n[1]=o.getDouble();break;case 4:n[2]=o.getDouble();break;case 3:n[3]=o.getDouble();break;default:o.skip()}return n}function S8e(t){const n=[0,0,0,0],o=t.asUnsafe();for(;o.next();)switch(o.tag()){case 1:n[0]=o.getDouble();break;case 2:n[1]=o.getDouble();break;case 4:n[2]=o.getDouble();break;case 3:n[3]=o.getDouble();break;default:o.skip()}return n}function E8e(t){const s={originPosition:fee(0)},n=t.asUnsafe();for(;n.next();)switch(n.tag()){case 1:s.originPosition=fee(n.getEnum());break;case 2:s.scale=n.processMessage(T8e);break;case 3:s.translate=n.processMessage(S8e);break;default:n.skip()}return s}function C8e(t){const s={},n=t.asUnsafe();for(;n.next();)switch(n.tag()){case 1:s.shapeAreaFieldName=n.getString();break;case 2:s.shapeLengthFieldName=n.getString();break;case 3:s.units=n.getString();break;default:n.skip()}return s}function A8e(t,e){const a=e.createSpatialReference();for(;t.next();)switch(t.tag()){case 1:a.wkid=t.getUInt32();break;case 5:a.wkt=t.getString();break;case 2:a.latestWkid=t.getUInt32();break;case 3:a.vcsWkid=t.getUInt32();break;case 4:a.latestVcsWkid=t.getUInt32();break;default:t.skip()}return a}function R8e(t,e){const _=e.createFeatureResult(),b=t.asUnsafe();_.geometryType=mee(e,0);let x=!1;for(;b.next();)switch(b.tag()){case 1:_.objectIdFieldName=b.getString();break;case 3:_.globalIdFieldName=b.getString();break;case 4:_.geohashFieldName=b.getString();break;case 5:_.geometryProperties=b.processMessage(C8e);break;case 7:_.geometryType=mee(e,b.getEnum());break;case 8:_.spatialReference=b.processMessageWithArgs(A8e,e);break;case 10:_.hasZ=b.getBool();break;case 11:_.hasM=b.getBool();break;case 12:_.transform=b.processMessage(E8e);break;case 9:{const T=b.getBool();_.exceededTransferLimit=T;break}case 13:e.addField(_,b.processMessage(b8e));break;case 15:x||(e.prepareFeatures(_),x=!0),e.addFeature(_,b.processMessageWithArgs(x8e,e,_,_.fields));break;case 2:_.uniqueIdField=b.processMessage(w8e);break;default:b.skip()}return e.finishFeatureResult(_),_}function O8e(t,e){const s={};let n=null;for(;t.next();)switch(t.tag()){case 4:n=t.processMessageWithArgs(_8e);break;case 1:s.featureResult=t.processMessageWithArgs(R8e,e);break;default:t.skip()}return v(n)&&s.featureResult&&e.addQueryGeometry(s,n),s}function M8e(t,e){try{const i=new Dz(new Uint8Array(t),new DataView(t)),s={};for(;i.next();)i.tag()===2?s.queryResult=i.processMessageWithArgs(O8e,e):i.skip();return s}catch(r){throw new q("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:r})}}function P8e(t,e){const r=M8e(t,e),i=r.queryResult.featureResult,s=r.queryResult.queryGeometry,n=r.queryResult.queryGeometryType;if(i&&i.features&&i.features.length&&i.objectIdFieldName){const o=i.objectIdFieldName;for(const a of i.features)a.attributes&&(a.objectId=a.attributes[o])}return i&&(i.queryGeometry=s,i.queryGeometryType=n),i}function Nz(t,e,r){if(!r||!r.features||!r.hasZ)return;const i=dfe(r.geometryType,e,t.outSpatialReference);if(!C(i))for(const s of r.features)i(s.geometry)}const gee="Layer does not support extent calculation.";function I8e(t,e){if(e&&t.type==="extent")return`${t.xmin},${t.ymin},${t.xmax},${t.ymax}`;if(e&&t.type==="point")return`${t.x},${t.y}`;const r=t.toJSON();return delete r.spatialReference,JSON.stringify(r)}function $8e(t,e){const r=t.geometry,i=t.toJSON();delete i.compactGeometryEnabled,delete i.defaultSpatialReferenceEnabled;const s=i;let n,o,a;if(v(r)&&(o=r.spatialReference,a=r.spatialReference.wkid||JSON.stringify(r.spatialReference),s.geometryType=vE(r),s.geometry=I8e(r,t.compactGeometryEnabled),s.inSR=a),i.groupByFieldsForStatistics&&(s.groupByFieldsForStatistics=i.groupByFieldsForStatistics.join(",")),i.objectIds&&(s.objectIds=i.objectIds.join(",")),i.orderByFields&&(s.orderByFields=i.orderByFields.join(",")),!i.outFields||!i.returnDistinctValues&&(e!=null&&e.returnCountOnly||e!=null&&e.returnExtentOnly||e!=null&&e.returnIdsOnly)?delete s.outFields:i.outFields.includes("*")?s.outFields="*":s.outFields=i.outFields.join(","),i.outSR?(s.outSR=i.outSR.wkid||JSON.stringify(i.outSR),n=t.outSpatialReference):r&&(i.returnGeometry||i.returnCentroid)&&(s.outSR=s.inSR,n=o),i.returnGeometry&&delete i.returnGeometry,i.outStatistics&&(s.outStatistics=JSON.stringify(i.outStatistics)),i.fullText&&(s.fullText=JSON.stringify(i.fullText)),i.pixelSize&&(s.pixelSize=JSON.stringify(i.pixelSize)),i.quantizationParameters&&(t.defaultSpatialReferenceEnabled&&v(o)&&v(t.quantizationParameters)&&v(t.quantizationParameters.extent)&&o.equals(t.quantizationParameters.extent.spatialReference)&&delete i.quantizationParameters.extent.spatialReference,s.quantizationParameters=JSON.stringify(i.quantizationParameters)),i.parameterValues&&(s.parameterValues=JSON.stringify(i.parameterValues)),i.rangeValues&&(s.rangeValues=JSON.stringify(i.rangeValues)),i.dynamicDataSource&&(s.layer=JSON.stringify({source:i.dynamicDataSource}),delete i.dynamicDataSource),i.timeExtent){const l=i.timeExtent,{start:c,end:h}=l;c==null&&h==null||(s.time=c===h?c:`${c??"null"},${h??"null"}`),delete i.timeExtent}return t.defaultSpatialReferenceEnabled&&v(o)&&v(n)&&o.equals(n)&&(s.defaultSR=s.inSR,delete s.inSR,delete s.outSR),s}async function L8e(t,e,r,i){const s=v(e.timeExtent)&&e.timeExtent.isEmpty?{data:{features:[]}}:await mM(t,e,"json",i);return Nz(e,r,s.data),s}async function g2t(t,e,r,i){if(v(e.timeExtent)&&e.timeExtent.isEmpty)return{data:r.createFeatureResult()};const s=await D8e(t,e,i),n=s;return n.data=P8e(s.data,r),n}function D8e(t,e,r){return mM(t,e,"pbf",r)}function y2t(t,e,r){return v(e.timeExtent)&&e.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):mM(t,e,"json",r,{returnIdsOnly:!0})}function _2t(t,e,r){return v(e.timeExtent)&&e.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):mM(t,e,"json",r,{returnIdsOnly:!0,returnCountOnly:!0})}function v2t(t,e,r){return v(e.timeExtent)&&e.timeExtent.isEmpty?Promise.resolve({data:{count:0,extent:null}}):mM(t,e,"json",r,{returnExtentOnly:!0,returnCountOnly:!0}).then(i=>{const s=i.data;if(s.hasOwnProperty("extent"))return i;if(s.features)throw new Error(gee);if(s.hasOwnProperty("count"))throw new Error(gee);return i})}function mM(t,e,r,i={},s={}){const n=typeof t=="string"?sl(t):t,o=e.geometry?[e.geometry]:[];return i.responseType=r==="pbf"?"array-buffer":"json",yye(o,null,i).then(a=>{const l=a&&a[0];v(l)&&((e=e.clone()).geometry=l);const c=_ye({...n.query,f:r,...s,...$8e(e,s)});return Ni(lw(n.path,"query"),{...i,query:{...c,...i.query}})})}var Fz;const Uz=new mr({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryEnvelope:"extent",mesh:"mesh","":null});let Vo=Fz=class extends ve{constructor(t){super(t),this.displayFieldName=null,this.exceededTransferLimit=!1,this.features=[],this.fields=null,this.geometryType=null,this.hasM=!1,this.hasZ=!1,this.queryGeometry=null,this.spatialReference=null}readFeatures(t,e){var s;const r=et.fromJSON(e.spatialReference),i=[];for(let n=0;n<t.length;n++){const o=t[n],a=Io.fromJSON(o),l=o.geometry&&o.geometry.spatialReference;v(a.geometry)&&!l&&(a.geometry.spatialReference=r);const c=o.aggregateGeometries,h=a.aggregateGeometries;if(c&&v(h))for(const p in h){const f=h[p],m=(s=c[p])==null?void 0:s.spatialReference;v(f)&&!m&&(f.spatialReference=r)}i.push(a)}return i}writeGeometryType(t,e,r,i){if(t)return void Uz.write(t,e,r,i);const{features:s}=this;if(s){for(const n of s)if(n&&v(n.geometry))return void Uz.write(n.geometry.type,e,r,i)}}readQueryGeometry(t,e){if(!t)return null;const r=!!t.spatialReference,i=il(t);return i&&!r&&e.spatialReference&&(i.spatialReference=et.fromJSON(e.spatialReference)),i}writeSpatialReference(t,e){if(t)return void(e.spatialReference=t.toJSON());const{features:r}=this;if(r){for(const i of r)if(i&&v(i.geometry)&&i.geometry.spatialReference)return void(e.spatialReference=i.geometry.spatialReference.toJSON())}}clone(){return new Fz(this.cloneProperties())}cloneProperties(){return ne({displayFieldName:this.displayFieldName,exceededTransferLimit:this.exceededTransferLimit,features:this.features,fields:this.fields,geometryType:this.geometryType,hasM:this.hasM,hasZ:this.hasZ,queryGeometry:this.queryGeometry,spatialReference:this.spatialReference,transform:this.transform})}toJSON(t){const e=this.write();if(e.features&&Array.isArray(t)&&t.length>0)for(let r=0;r<e.features.length;r++){const i=e.features[r];if(i.geometry){const s=t&&t[r];i.geometry=s&&s.toJSON()||i.geometry}}return e}quantize(t){const{scale:[e,r],translate:[i,s]}=t,n=c=>Math.round((c-i)/e),o=c=>Math.round((s-c)/r),a=this.features,l=this._getQuantizationFunction(this.geometryType,n,o);for(let c=0,h=a.length;c<h;c++)l!=null&&l(a[c].geometry)||(a.splice(c,1),c--,h--);return this.transform=t,this}unquantize(){const{geometryType:t,features:e,transform:r}=this;if(!r)return this;const{translate:[i,s],scale:[n,o]}=r,a=h=>h*n+i,l=h=>s-h*o,c=this._getHydrationFunction(t,a,l);for(const{geometry:h}of e)v(h)&&c&&c(h);return this.transform=null,this}_quantizePoints(t,e,r){let i,s;const n=[];for(let o=0,a=t.length;o<a;o++){const l=t[o];if(o>0){const c=e(l[0]),h=r(l[1]);c===i&&h===s||(n.push([c-i,h-s]),i=c,s=h)}else i=e(l[0]),s=r(l[1]),n.push([i,s])}return n.length>0?n:null}_getQuantizationFunction(t,e,r){return t==="point"?i=>(i.x=e(i.x),i.y=r(i.y),i):t==="polyline"||t==="polygon"?i=>{const s=Hb(i)?i.rings:i.paths,n=[];for(let o=0,a=s.length;o<a;o++){const l=s[o],c=this._quantizePoints(l,e,r);c&&n.push(c)}return n.length>0?(Hb(i)?i.rings=n:i.paths=n,i):null}:t==="multipoint"?i=>{const s=this._quantizePoints(i.points,e,r);return s&&s.length>0?(i.points=s,i):null}:t==="extent"?i=>i:null}_getHydrationFunction(t,e,r){return t==="point"?i=>{i.x=e(i.x),i.y=r(i.y)}:t==="polyline"||t==="polygon"?i=>{const s=Hb(i)?i.rings:i.paths;let n,o;for(let a=0,l=s.length;a<l;a++){const c=s[a];for(let h=0,p=c.length;h<p;h++){const f=c[h];h>0?(n+=f[0],o+=f[1]):(n=f[0],o=f[1]),f[0]=e(n),f[1]=r(o)}}}:t==="extent"?i=>{i.xmin=e(i.xmin),i.ymin=r(i.ymin),i.xmax=e(i.xmax),i.ymax=r(i.ymax)}:t==="multipoint"?i=>{const s=i.points;let n,o;for(let a=0,l=s.length;a<l;a++){const c=s[a];a>0?(n+=c[0],o+=c[1]):(n=c[0],o=c[1]),c[0]=e(n),c[1]=r(o)}}:null}};u([d({type:String,json:{write:!0}})],Vo.prototype,"displayFieldName",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],Vo.prototype,"exceededTransferLimit",void 0),u([d({type:[Io],json:{write:!0}})],Vo.prototype,"features",void 0),u([Fe("features")],Vo.prototype,"readFeatures",null),u([d({type:[e5],json:{write:!0}})],Vo.prototype,"fields",void 0),u([d({type:["point","multipoint","polyline","polygon","extent","mesh"],json:{read:{reader:Uz.read}}})],Vo.prototype,"geometryType",void 0),u([He("geometryType")],Vo.prototype,"writeGeometryType",null),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],Vo.prototype,"hasM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],Vo.prototype,"hasZ",void 0),u([d({types:jw,json:{write:!0}})],Vo.prototype,"queryGeometry",void 0),u([Fe("queryGeometry")],Vo.prototype,"readQueryGeometry",null),u([d({type:et,json:{write:!0}})],Vo.prototype,"spatialReference",void 0),u([He("spatialReference")],Vo.prototype,"writeSpatialReference",null),u([d({json:{write:!0}})],Vo.prototype,"transform",void 0),Vo=Fz=u([I("esri.rest.support.FeatureSet")],Vo),Vo.prototype.toJSON.isDefaultToJSON=!0;const lX=Vo,yee={milliseconds:1,seconds:1e3,minutes:6e4,hours:36e5,days:864e5,weeks:6048e5,months:26784e5,years:31536e6,decades:31536e7,centuries:31536e8},N8e={milliseconds:{getter:"getMilliseconds",setter:"setMilliseconds",multiplier:1},seconds:{getter:"getSeconds",setter:"setSeconds",multiplier:1},minutes:{getter:"getMinutes",setter:"setMinutes",multiplier:1},hours:{getter:"getHours",setter:"setHours",multiplier:1},days:{getter:"getDate",setter:"setDate",multiplier:1},weeks:{getter:"getDate",setter:"setDate",multiplier:7},months:{getter:"getMonth",setter:"setMonth",multiplier:1},years:{getter:"getFullYear",setter:"setFullYear",multiplier:1},decades:{getter:"getFullYear",setter:"setFullYear",multiplier:10},centuries:{getter:"getFullYear",setter:"setFullYear",multiplier:100}};function F8e(t,e){const r=new Date(t,e+1,1);return r.setDate(0),r.getDate()}function Zb(t,e,r){const i=new Date(t.getTime());if(e&&r){const s=N8e[r],{getter:n,setter:o,multiplier:a}=s;if(r==="months"){const l=F8e(i.getFullYear(),i.getMonth()+e);i.getDate()>l&&i.setDate(l)}i[o](i[n]()+e*a)}return i}function _ee(t,e){switch(e){case"milliseconds":return new Date(t.getTime());case"seconds":return new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds());case"minutes":return new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes());case"hours":return new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours());case"days":return new Date(t.getFullYear(),t.getMonth(),t.getDate());case"weeks":return new Date(t.getFullYear(),t.getMonth(),t.getDate()-t.getDay());case"months":return new Date(t.getFullYear(),t.getMonth(),1);case"years":return new Date(t.getFullYear(),0,1);case"decades":return new Date(t.getFullYear()-t.getFullYear()%10,0,1);case"centuries":return new Date(t.getFullYear()-t.getFullYear()%100,0,1);default:return new Date}}function U8e(t,e,r){return t===0?0:t*yee[e]/yee[r]}var bd;let au=bd=class extends ve{static get allTime(){return vee}static get empty(){return k8e}constructor(t){super(t),this.end=null,this.start=null}readEnd(t,e){return e.end!=null?new Date(e.end):null}writeEnd(t,e){e.end=t?t.getTime():null}get isAllTime(){return this.equals(bd.allTime)}get isEmpty(){return this.equals(bd.empty)}readStart(t,e){return e.start!=null?new Date(e.start):null}writeStart(t,e){e.start=t?t.getTime():null}clone(){return new bd({end:this.end,start:this.start})}equals(t){if(!t)return!1;const e=v(this.start)?this.start.getTime():this.start,r=v(this.end)?this.end.getTime():this.end,i=v(t.start)?t.start.getTime():t.start,s=v(t.end)?t.end.getTime():t.end;return e===i&&r===s}expandTo(t){if(this.isEmpty||this.isAllTime)return this.clone();const e=so(this.start,i=>_ee(i,t)),r=so(this.end,i=>{const s=_ee(i,t);return i.getTime()===s.getTime()?s:Zb(s,1,t)});return new bd({start:e,end:r})}intersection(t){if(!t)return this.clone();if(this.isEmpty||t.isEmpty)return bd.empty;if(this.isAllTime)return t.clone();if(t.isAllTime)return this.clone();const e=_u(this.start,-1/0,a=>a.getTime()),r=_u(this.end,1/0,a=>a.getTime()),i=_u(t.start,-1/0,a=>a.getTime()),s=_u(t.end,1/0,a=>a.getTime());let n,o;if(i>=e&&i<=r?n=i:e>=i&&e<=s&&(n=e),r>=i&&r<=s?o=r:s>=e&&s<=r&&(o=s),n!=null&&o!=null&&!isNaN(n)&&!isNaN(o)){const a=new bd;return a.start=n===-1/0?null:new Date(n),a.end=o===1/0?null:new Date(o),a}return bd.empty}offset(t,e){if(this.isEmpty||this.isAllTime)return this.clone();const r=new bd,{start:i,end:s}=this;return v(i)&&(r.start=Zb(i,t,e)),v(s)&&(r.end=Zb(s,t,e)),r}union(t){if(!t||t.isEmpty)return this.clone();if(this.isEmpty)return t.clone();if(this.isAllTime||t.isAllTime)return vee.clone();const e=v(this.start)&&v(t.start)?new Date(Math.min(this.start.getTime(),t.start.getTime())):null,r=v(this.end)&&v(t.end)?new Date(Math.max(this.end.getTime(),t.end.getTime())):null;return new bd({start:e,end:r})}};u([d({type:Date,json:{write:{allowNull:!0}}})],au.prototype,"end",void 0),u([Fe("end")],au.prototype,"readEnd",null),u([He("end")],au.prototype,"writeEnd",null),u([d({readOnly:!0,json:{read:!1}})],au.prototype,"isAllTime",null),u([d({readOnly:!0,json:{read:!1}})],au.prototype,"isEmpty",null),u([d({type:Date,json:{write:{allowNull:!0}}})],au.prototype,"start",void 0),u([Fe("start")],au.prototype,"readStart",null),u([He("start")],au.prototype,"writeStart",null),au=bd=u([I("esri.TimeExtent")],au);const vee=new au,k8e=new au({start:void 0,end:void 0}),_m=au;let L1=class extends bs(ve){constructor(e){super(e),this.onFields=null,this.operator=null,this.searchTerm=null,this.searchType=null}};u([d({type:[String],json:{write:{enabled:!0,overridePolicy(){return{enabled:v(this.onFields)&&this.onFields.length>0}}}}})],L1.prototype,"onFields",void 0),u([d({type:String,json:{write:!0}})],L1.prototype,"operator",void 0),u([d({type:String,json:{write:!0}})],L1.prototype,"searchTerm",void 0),u([d({type:String,json:{write:!0}})],L1.prototype,"searchType",void 0),L1=u([I("esri.rest.support.FullTextSearch")],L1);const V8e=L1;var kz;const bee=new mr({upperLeft:"upper-left",lowerLeft:"lower-left"});let D1=kz=class extends ve{constructor(t){super(t),this.extent=null,this.mode="view",this.originPosition="upper-left",this.tolerance=1}clone(){return new kz(ne({extent:this.extent,mode:this.mode,originPosition:this.originPosition,tolerance:this.tolerance}))}};u([d({type:Zr,json:{write:{overridePolicy(){return{enabled:this.mode==="view"}}}}})],D1.prototype,"extent",void 0),u([d({type:["view","edit"],json:{write:!0}})],D1.prototype,"mode",void 0),u([d({type:String,json:{read:bee.read,write:bee.write}})],D1.prototype,"originPosition",void 0),u([d({type:Number,json:{write:{overridePolicy(){return{enabled:this.mode==="view"}}}}})],D1.prototype,"tolerance",void 0),D1=kz=u([I("esri.rest.support.QuantizationParameters")],D1);const B8e=D1;var Vz;const wee=new mr({count:"count",sum:"sum",min:"min",max:"max",avg:"avg",stddev:"stddev",var:"var",exceedslimit:"exceedslimit",percentile_cont:"percentile-continuous",percentile_disc:"percentile-discrete",EnvelopeAggregate:"envelope-aggregate",CentroidAggregate:"centroid-aggregate",ConvexHullAggregate:"convex-hull-aggregate"});let wd=Vz=class extends ve{constructor(t){super(t),this.maxPointCount=void 0,this.maxRecordCount=void 0,this.maxVertexCount=void 0,this.onStatisticField=null,this.outStatisticFieldName=null,this.statisticType=null,this.statisticParameters=null}writeStatisticParameters(t,e){this.statisticType!=="percentile-continuous"&&this.statisticType!=="percentile-discrete"||(e.statisticParameters=ne(t))}clone(){return new Vz({maxPointCount:this.maxPointCount,maxRecordCount:this.maxRecordCount,maxVertexCount:this.maxVertexCount,onStatisticField:this.onStatisticField,outStatisticFieldName:this.outStatisticFieldName,statisticType:this.statisticType,statisticParameters:ne(this.statisticParameters)})}};u([d({type:Number,json:{write:!0}})],wd.prototype,"maxPointCount",void 0),u([d({type:Number,json:{write:!0}})],wd.prototype,"maxRecordCount",void 0),u([d({type:Number,json:{write:!0}})],wd.prototype,"maxVertexCount",void 0),u([d({type:String,json:{write:!0}})],wd.prototype,"onStatisticField",void 0),u([d({type:String,json:{write:!0}})],wd.prototype,"outStatisticFieldName",void 0),u([d({type:String,json:{read:{source:"statisticType",reader:wee.read},write:{target:"statisticType",writer:wee.write}}})],wd.prototype,"statisticType",void 0),u([d({type:Object})],wd.prototype,"statisticParameters",void 0),u([He("statisticParameters")],wd.prototype,"writeStatisticParameters",null),wd=Vz=u([I("esri.rest.support.StatisticDefinition")],wd);const Tye=wd;var X2;const z8e=new mr({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),G8e=new mr({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let zt=X2=class extends ve{static from(t){return bS(X2,t)}constructor(t){super(t),this.aggregateIds=null,this.cacheHint=void 0,this.compactGeometryEnabled=!1,this.datumTransformation=null,this.defaultSpatialReferenceEnabled=!1,this.distance=void 0,this.dynamicDataSource=void 0,this.formatOf3DObjects=null,this.fullText=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=void 0,this.groupByFieldsForStatistics=null,this.having=null,this.historicMoment=null,this.maxAllowableOffset=void 0,this.maxRecordCountFactor=1,this.multipatchOption=null,this.num=void 0,this.objectIds=null,this.orderByFields=null,this.outFields=null,this.outSpatialReference=null,this.outStatistics=null,this.parameterValues=null,this.pixelSize=null,this.quantizationParameters=null,this.rangeValues=null,this.relationParameter=null,this.resultType=null,this.returnCentroid=!1,this.returnDistinctValues=!1,this.returnExceededLimitFeatures=!0,this.returnGeometry=!1,this.returnQueryGeometry=!1,this.returnM=void 0,this.returnZ=void 0,this.sourceSpatialReference=null,this.spatialRelationship="intersects",this.start=void 0,this.sqlFormat=null,this.text=null,this.timeExtent=null,this.timeReferenceUnknownClient=!1,this.units=null,this.where=null}castDatumTransformation(t){return typeof t=="number"||typeof t=="object"?t:null}writeHistoricMoment(t,e){e.historicMoment=t&&t.getTime()}writeParameterValues(t,e){if(t){const r={};for(const i in t){const s=t[i];Array.isArray(s)?r[i]=s.map(n=>n instanceof Date?n.getTime():n):s instanceof Date?r[i]=s.getTime():r[i]=s}e.parameterValues=r}}writeStart(t,e){e.resultOffset=this.start,e.resultRecordCount=this.num||10,e.where="1=1"}writeWhere(t,e){e.where=t||"1=1"}clone(){return new X2(ne({aggregateIds:this.aggregateIds,cacheHint:this.cacheHint,compactGeometryEnabled:this.compactGeometryEnabled,datumTransformation:this.datumTransformation,defaultSpatialReferenceEnabled:this.defaultSpatialReferenceEnabled,distance:this.distance,fullText:this.fullText,gdbVersion:this.gdbVersion,geometry:this.geometry,geometryPrecision:this.geometryPrecision,groupByFieldsForStatistics:this.groupByFieldsForStatistics,having:this.having,historicMoment:v(this.historicMoment)?new Date(this.historicMoment.getTime()):null,maxAllowableOffset:this.maxAllowableOffset,maxRecordCountFactor:this.maxRecordCountFactor,multipatchOption:this.multipatchOption,num:this.num,objectIds:this.objectIds,orderByFields:this.orderByFields,outFields:this.outFields,outSpatialReference:this.outSpatialReference,outStatistics:this.outStatistics,parameterValues:this.parameterValues,pixelSize:this.pixelSize,quantizationParameters:this.quantizationParameters,rangeValues:this.rangeValues,relationParameter:this.relationParameter,resultType:this.resultType,returnDistinctValues:this.returnDistinctValues,returnGeometry:this.returnGeometry,returnCentroid:this.returnCentroid,returnExceededLimitFeatures:this.returnExceededLimitFeatures,returnQueryGeometry:this.returnQueryGeometry,returnM:this.returnM,returnZ:this.returnZ,dynamicDataSource:this.dynamicDataSource,sourceSpatialReference:this.sourceSpatialReference,spatialRelationship:this.spatialRelationship,start:this.start,sqlFormat:this.sqlFormat,text:this.text,timeExtent:this.timeExtent,timeReferenceUnknownClient:this.timeReferenceUnknownClient,units:this.units,where:this.where}))}};zt.MAX_MAX_RECORD_COUNT_FACTOR=5,u([d({json:{write:!0}})],zt.prototype,"aggregateIds",void 0),u([d({type:Boolean,json:{write:!0}})],zt.prototype,"cacheHint",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],zt.prototype,"compactGeometryEnabled",void 0),u([d({json:{write:!0}})],zt.prototype,"datumTransformation",void 0),u([cr("datumTransformation")],zt.prototype,"castDatumTransformation",null),u([d({type:Boolean,json:{default:!1,write:!0}})],zt.prototype,"defaultSpatialReferenceEnabled",void 0),u([d({type:Number,json:{write:{overridePolicy:t=>({enabled:t>0})}}})],zt.prototype,"distance",void 0),u([d({type:kd,json:{write:!0}})],zt.prototype,"dynamicDataSource",void 0),u([d({type:String,json:{write:!0}})],zt.prototype,"formatOf3DObjects",void 0),u([d({type:[V8e],json:{write:{enabled:!0,overridePolicy(){return{enabled:v(this.fullText)&&this.fullText.length>0}}}}})],zt.prototype,"fullText",void 0),u([d({type:String,json:{write:!0}})],zt.prototype,"gdbVersion",void 0),u([d({types:jw,json:{read:il,write:!0}})],zt.prototype,"geometry",void 0),u([d({type:Number,json:{write:!0}})],zt.prototype,"geometryPrecision",void 0),u([d({type:[String],json:{write:!0}})],zt.prototype,"groupByFieldsForStatistics",void 0),u([d({type:String,json:{write:!0}})],zt.prototype,"having",void 0),u([d({type:Date})],zt.prototype,"historicMoment",void 0),u([He("historicMoment")],zt.prototype,"writeHistoricMoment",null),u([d({type:Number,json:{write:!0}})],zt.prototype,"maxAllowableOffset",void 0),u([d({type:Number,cast:t=>t<1?1:t>X2.MAX_MAX_RECORD_COUNT_FACTOR?X2.MAX_MAX_RECORD_COUNT_FACTOR:t,json:{write:{overridePolicy:t=>({enabled:t>1})}}})],zt.prototype,"maxRecordCountFactor",void 0),u([d({type:["xyFootprint"],json:{write:!0}})],zt.prototype,"multipatchOption",void 0),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],zt.prototype,"num",void 0),u([d({json:{write:!0}})],zt.prototype,"objectIds",void 0),u([d({type:[String],json:{write:!0}})],zt.prototype,"orderByFields",void 0),u([d({type:[String],json:{write:!0}})],zt.prototype,"outFields",void 0),u([d({type:et,json:{name:"outSR",write:!0}})],zt.prototype,"outSpatialReference",void 0),u([d({type:[Tye],json:{write:{enabled:!0,overridePolicy(){return{enabled:v(this.outStatistics)&&this.outStatistics.length>0}}}}})],zt.prototype,"outStatistics",void 0),u([d({json:{write:!0}})],zt.prototype,"parameterValues",void 0),u([He("parameterValues")],zt.prototype,"writeParameterValues",null),u([d({type:mt,json:{write:!0}})],zt.prototype,"pixelSize",void 0),u([d({type:B8e,json:{write:!0}})],zt.prototype,"quantizationParameters",void 0),u([d({type:[Object],json:{write:!0}})],zt.prototype,"rangeValues",void 0),u([d({type:String,json:{read:{source:"relationParam"},write:{target:"relationParam",overridePolicy(){return{enabled:this.spatialRelationship==="relation"}}}}})],zt.prototype,"relationParameter",void 0),u([d({type:String,json:{write:!0}})],zt.prototype,"resultType",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],zt.prototype,"returnCentroid",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],zt.prototype,"returnDistinctValues",void 0),u([d({type:Boolean,json:{default:!0,write:!0}})],zt.prototype,"returnExceededLimitFeatures",void 0),u([d({type:Boolean,json:{write:!0}})],zt.prototype,"returnGeometry",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],zt.prototype,"returnQueryGeometry",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],zt.prototype,"returnM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],zt.prototype,"returnZ",void 0),u([d({type:et,json:{write:!0}})],zt.prototype,"sourceSpatialReference",void 0),u([gt(z8e,{ignoreUnknown:!1,name:"spatialRel"})],zt.prototype,"spatialRelationship",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],zt.prototype,"start",void 0),u([He("start"),He("num")],zt.prototype,"writeStart",null),u([d({type:String,json:{write:!0}})],zt.prototype,"sqlFormat",void 0),u([d({type:String,json:{write:!0}})],zt.prototype,"text",void 0),u([d({type:_m,json:{write:!0}})],zt.prototype,"timeExtent",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],zt.prototype,"timeReferenceUnknownClient",void 0),u([gt(G8e,{ignoreUnknown:!1}),d({json:{write:{overridePolicy(t){return{enabled:!!t&&this.distance!=null&&this.distance>0}}}}})],zt.prototype,"units",void 0),u([d({type:String,json:{write:{overridePolicy(t){return{enabled:t!=null||this.start!=null&&this.start>0}}}}})],zt.prototype,"where",void 0),u([He("where")],zt.prototype,"writeWhere",null),zt=X2=u([I("esri.rest.support.Query")],zt);const Yf=zt;async function gU(t,e,r){const i=await j8e(t,e,r);return lX.fromJSON(i)}async function j8e(t,e,r){const i=aX(t),s={...r},n=Yf.from(e),{data:o}=await L8e(i,n,n.sourceSpatialReference,s);return o}function ba(t,e){return t?e?4:3:e?3:2}const gM=se.getLogger("esri.layers.graphics.featureConversionUtils"),Sye={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0},H8e=(t,e,r,i,s,n)=>{t[r]=s,t[r+1]=n},xee=(t,e,r,i,s,n)=>{t[r]=s,t[r+1]=n,t[r+2]=e[i+2]},q8e=(t,e,r,i,s,n)=>{t[r]=s,t[r+1]=n,t[r+2]=e[i+3]},W8e=(t,e,r,i,s,n)=>{t[r]=s,t[r+1]=n,t[r+2]=e[i+2],t[r+3]=e[i+3]};function cX(t,e,r,i){if(t){if(r)return e&&i?W8e:xee;if(e&&i)return q8e}else if(e&&i)return xee;return H8e}function yU({scale:t,translate:e},r){return Math.round((r-e[0])/t[0])}function _U({scale:t,translate:e},r){return Math.round((e[1]-r)/t[1])}function vU({scale:t,translate:e},r,i){return r*t[i]+e[i]}function w2t(t,e,r){return t?e?r?dX(t):uX(t):r?hX(t):t5(t):null}function t5(t){const e=t.coords;return{x:e[0],y:e[1]}}function Eye(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t}function uX(t){const e=t.coords;return{x:e[0],y:e[1],z:e[2]}}function X8e(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t.coords[2]=e.z,t}function hX(t){const e=t.coords;return{x:e[0],y:e[1],m:e[2]}}function Y8e(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t.coords[2]=e.m,t}function dX(t){const e=t.coords;return{x:e[0],y:e[1],z:e[2],m:e[3]}}function Z8e(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t.coords[2]=e.z,t.coords[3]=e.m,t}function J8e(t,e,r,i){let s=t5;r&&i?s=dX:r?s=uX:i&&(s=hX);for(const n of e){const{geometry:o,attributes:a}=n,l=v(o)?s(o):null;t.push({attributes:a,geometry:l})}return t}function pX(t,e){return t&&e?Z8e:t?X8e:e?Y8e:Eye}function K8e(t,e,r,i,s){const n=pX(r,i);for(const{geometry:o,attributes:a}of e){const l=v(o)?n(new yp,o):null;t.push(new Q_(l,a,null,s?a[s]:void 0))}return t}function x2t(t,e,r=pX(e.z!=null,e.m!=null)){return r(t,e)}function Q8e(t,e,r,i){for(const{geometry:s,attributes:n}of e)t.push({attributes:n,geometry:v(s)?Cye(s,r,i):null});return t}function Cye(t,e,r){if(C(t))return null;const i=ba(e,r),s=[];for(let n=0;n<t.coords.length;n+=i){const o=[];for(let a=0;a<i;a++)o.push(t.coords[n+a]);s.push(o)}return e?r?{points:s,hasZ:e,hasM:r}:{points:s,hasZ:e}:r?{points:s,hasM:r}:{points:s}}function e9e(t,e,r,i,s){const n=ba(r,i);for(const{geometry:o,attributes:a}of e){const l=v(o)?Aye(new yp,o,n):null;t.push(new Q_(l,a,null,s?a[s]:void 0))}return t}function Aye(t,e,r=ba(e.hasZ,e.hasM)){t.lengths[0]=e.points.length;const i=t.coords;let s=0;for(const n of e.points)for(let o=0;o<r;o++)i[s++]=n[o];return t}function t9e(t,e,r,i){for(const{geometry:s,attributes:n}of e)t.push({attributes:n,geometry:v(s)?Rye(s,r,i):null});return t}function Rye(t,e,r){if(!t)return null;const i=ba(e,r),{coords:s,lengths:n}=t,o=[];let a=0;for(const l of n){const c=[];for(let h=0;h<l;h++){const p=[];for(let f=0;f<i;f++)p.push(s[a++]);c.push(p)}o.push(c)}return e?r?{paths:o,hasZ:e,hasM:r}:{paths:o,hasZ:e}:r?{paths:o,hasM:r}:{paths:o}}function r9e(t,e,r,i,s){const n=ba(r,i);for(const{geometry:o,attributes:a}of e){const l=v(o)?Oye(new yp,o,n):null;t.push(new Q_(l,a,null,s?a[s]:void 0))}return t}function Oye(t,e,r=ba(e.hasZ,e.hasM)){const{lengths:i,coords:s}=t;let n=0;for(const o of e.paths){for(const a of o)for(let l=0;l<r;l++)s[n++]=a[l];i.push(o.length)}return t}function i9e(t,e,r,i){for(const{geometry:s,attributes:n,centroid:o}of e){const a=v(s)?Mye(s,r,i):null;if(v(o)){const l=t5(o);t.push({attributes:n,centroid:l,geometry:a})}else t.push({attributes:n,geometry:a})}return t}function Mye(t,e,r){if(!t)return null;const i=ba(e,r),{coords:s,lengths:n}=t,o=[];let a=0;for(const l of n){const c=[];for(let h=0;h<l;h++){const p=[];for(let f=0;f<i;f++)p.push(s[a++]);c.push(p)}o.push(c)}return e?r?{rings:o,hasZ:e,hasM:r}:{rings:o,hasZ:e}:r?{rings:o,hasM:r}:{rings:o}}function s9e(t,e,r,i,s){for(const{geometry:n,centroid:o,attributes:a}of e){const l=v(n)?Pye(new yp,n,r,i):null,c=s?a[s]:void 0;v(o)?t.push(new Q_(l,a,Eye(new yp,o),c)):t.push(new Q_(l,a,null,c))}return t}function Pye(t,e,r=e.hasZ,i=e.hasM){return n9e(t,e.rings,r,i),t}function n9e(t,e,r,i){const s=ba(r,i),{lengths:n,coords:o}=t;let a=0;Ug(t);for(const l of e){for(const c of l)for(let h=0;h<s;h++)o[a++]=c[h];n.push(l.length)}return t}const Y2=[],eR=[];function T2t(t,e,r,i,s){Y2[0]=t;const[n]=Iye(eR,Y2,e,r,i,s);return _p(Y2),_p(eR),n}function Iye(t,e,r,i,s,n){if(_p(t),!r){for(const o of e){const a=n?o.attributes[n]:void 0;t.push(new Q_(null,o.attributes,null,a))}return t}switch(r){case"esriGeometryPoint":return K8e(t,e,i,s,n);case"esriGeometryMultipoint":return e9e(t,e,i,s,n);case"esriGeometryPolyline":return r9e(t,e,i,s,n);case"esriGeometryPolygon":return s9e(t,e,i,s,n);default:gM.error("convertToFeatureSet:unknown-geometry",new q(`Unable to parse unknown geometry type '${r}'`)),_p(t)}return t}function S2t(t,e,r,i){eR[0]=t,$ye(Y2,eR,e,r,i);const s=Y2[0];return _p(Y2),_p(eR),s}function o9e(t,e,r){if(C(t))return null;const i=new yp;return"hasZ"in t&&e==null&&(e=t.hasZ),"hasM"in t&&r==null&&(r=t.hasM),zq(t)?pX(e??t.z!=null,r??t.m!=null)(i,t):Hb(t)?Pye(i,t,e,r):Gq(t)?Oye(i,t,ba(e,r)):Bq(t)?Aye(i,t,ba(e,r)):void gM.error("convertFromGeometry:unknown-geometry",new q(`Unable to parse unknown geometry type '${t}'`))}function a9e(t,e,r,i){const s=t&&("coords"in t?t:t.geometry);if(C(s))return null;switch(e){case"esriGeometryPoint":{let n=t5;return r&&i?n=dX:r?n=uX:i&&(n=hX),n(s)}case"esriGeometryMultipoint":return Cye(s,r,i);case"esriGeometryPolyline":return Rye(s,r,i);case"esriGeometryPolygon":return Mye(s,r,i);default:return gM.error("convertToGeometry:unknown-geometry",new q(`Unable to parse unknown geometry type '${e}'`)),null}}function l9e(t,e){for(const r of e)t.push({attributes:r.attributes});return t}function $ye(t,e,r,i,s){if(_p(t),C(r))return l9e(t,e);switch(r){case"esriGeometryPoint":return J8e(t,e,i,s);case"esriGeometryMultipoint":return Q8e(t,e,i,s);case"esriGeometryPolyline":return t9e(t,e,i,s);case"esriGeometryPolygon":return i9e(t,e,i,s);default:gM.error("convertToFeatureSet:unknown-geometry",new q(`Unable to parse unknown geometry type '${r}'`))}return t}function E2t(t){const{objectIdFieldName:e,spatialReference:r,transform:i,fields:s,hasM:n,hasZ:o,features:a,geometryType:l,exceededTransferLimit:c,uniqueIdField:h,queryGeometry:p,queryGeometryType:f}=t,m={features:$ye([],a,l,o,n),fields:s,geometryType:l,objectIdFieldName:e,spatialReference:r,uniqueIdField:h,queryGeometry:a9e(p,f,!1,!1)};return i&&(m.transform=i),c&&(m.exceededTransferLimit=c),n&&(m.hasM=n),o&&(m.hasZ=o),m}function C2t(t,e){const r=new bye,{hasM:i,hasZ:s,features:n,objectIdFieldName:o,spatialReference:a,geometryType:l,exceededTransferLimit:c,transform:h,fields:p}=t;return p&&(r.fields=p),r.geometryType=l??null,r.objectIdFieldName=o??e??null,r.spatialReference=a??null,r.objectIdFieldName?(n&&Iye(r.features,n,l,s,i,r.objectIdFieldName),c&&(r.exceededTransferLimit=c),i&&(r.hasM=i),s&&(r.hasZ=s),h&&(r.transform=h),r):(gM.error(new q("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),r)}function A2t(t){const{transform:e,features:r,hasM:i,hasZ:s}=t;if(!e)return t;for(const n of r)v(n.geometry)&&See(n.geometry,n.geometry,i,s,e),v(n.centroid)&&See(n.centroid,n.centroid,i,s,e);return t.transform=null,t}function R2t(t,e){const{geometryType:r,features:i,hasM:s,hasZ:n}=e;if(!t)return e;for(let o=0;o<i.length;o++){const a=i[o],l=a.weakClone();l.geometry=new yp,Tee(l.geometry,a.geometry,s,n,r,t),a.centroid&&(l.centroid=new yp,Tee(l.centroid,a.centroid,s,n,"esriGeometryPoint",t)),i[o]=l}return e.transform=t,e}function Tee(t,e,r,i,s,n,o=r,a=i){if(Ug(t),C(e)||!e.coords.length)return null;const l=Sye[s],{coords:c,lengths:h}=e,p=ba(r,i),f=ba(r&&o,i&&a),m=cX(r,i,o,a);if(!h.length)return m(t.coords,c,0,0,yU(n,c[0]),_U(n,c[1])),Ug(t,p,0),t;let y,_,b,x,T=0,S=0,E=S;for(const O of h){if(O<l)continue;let R=0;S=E,b=y=yU(n,c[T]),x=_=_U(n,c[T+1]),m(t.coords,c,S,T,b,x),R++,T+=p,S+=f;for(let L=1;L<O;L++,T+=p)b=yU(n,c[T]),x=_U(n,c[T+1]),b===y&&x===_||(m(t.coords,c,S,T,b-y,x-_),S+=f,R++,y=b,_=x);R>=l&&(t.lengths.push(R),E=S)}return _p(t.coords,E),t.coords.length?t:null}function O2t(t,e,r,i,s,n,o=r,a=i){if(Ug(t),!e||!e.coords.length)return null;const l=Sye[s],{coords:c,lengths:h}=e,p=ba(r,i),f=ba(r&&o,i&&a),m=cX(r,i,o,a);if(!h.length)return m(t.coords,c,0,0,c[0],c[1]),Ug(t,p,0),t;let y=0;const _=n*n;for(const b of h){if(b<l){y+=b*p;continue}const x=t.coords.length/f,T=y,S=y+(b-1)*p;m(t.coords,c,t.coords.length,T,c[T],c[T+1]),Bz(t.coords,c,p,_,m,T,S),m(t.coords,c,t.coords.length,S,c[S],c[S+1]);const E=t.coords.length/f-x;E>=l?t.lengths.push(E):_p(t.coords,x*f),y+=b*p}return t.coords.length?t:null}function c9e(t,e,r,i){const s=t[e],n=t[e+1],o=t[r],a=t[r+1],l=t[i],c=t[i+1];let h=o,p=a,f=l-h,m=c-p;if(f!==0||m!==0){const y=((s-h)*f+(n-p)*m)/(f*f+m*m);y>1?(h=l,p=c):y>0&&(h+=f*y,p+=m*y)}return f=s-h,m=n-p,f*f+m*m}function Bz(t,e,r,i,s,n,o){let a,l=i,c=0;for(let h=n+r;h<o;h+=r)a=c9e(e,h,n,o),a>l&&(c=h,l=a);l>i&&(c-n>r&&Bz(t,e,r,i,s,n,c),s(t,e,t.length,c,e[c],e[c+1]),o-c>r&&Bz(t,e,r,i,s,c,o))}function M2t(t,e,r,i){if(C(e)||!e.coords||!e.coords.length)return null;const s=ba(r,i);let n=Number.POSITIVE_INFINITY,o=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY;if(e&&e.coords){const c=e.coords;for(let h=0;h<c.length;h+=s){const p=c[h],f=c[h+1];n=Math.min(n,p),a=Math.max(a,p),o=Math.min(o,f),l=Math.max(l,f)}}return cB(t)?S$e(t,n,o,a,l):eW(n,o,a,l,t),t}function See(t,e,r,i,s){const{coords:n,lengths:o}=e,a=ba(r,i);if(!n.length)return t!==e&&Ug(t),t;e4(s);const{originPosition:l,scale:c,translate:h}=s,p=h9e;p.originPosition=l;const f=p.scale;f[0]=c[0]??1,f[1]=-(c[1]??1),f[2]=c[2]??1,f[3]=c[3]??1;const m=p.translate;if(m[0]=h[0]??0,m[1]=h[1]??0,m[2]=h[2]??0,m[3]=h[3]??0,!o.length){for(let _=0;_<a;++_)t.coords[_]=vU(p,n[_],_);return t!==e&&Ug(t,a,0),t}let y=0;for(let _=0;_<o.length;_++){const b=o[_];t.lengths[_]=b;for(let S=0;S<a;++S)t.coords[y+S]=vU(p,n[y+S],S);let x=t.coords[y],T=t.coords[y+1];y+=a;for(let S=1;S<b;S++,y+=a){x+=n[y]*f[0],T+=n[y+1]*f[1],t.coords[y]=x,t.coords[y+1]=T;for(let E=2;E<a;++E)t.coords[y+E]=vU(p,n[y+E],E)}}return t!==e&&Ug(t,n.length,o.length),t}function P2t(t,e,r,i,s,n){if(Ug(t),t.lengths.push(...e.lengths),r===s&&i===n)for(let o=0;o<e.coords.length;o++)t.coords.push(e.coords[o]);else{const o=ba(r,i),a=cX(r,i,s,n),l=e.coords;for(let c=0;c<l.length;c+=o)a(t.coords,l,t.coords.length,c,l[c],l[c+1])}return t}function u9e(t,e,r,i){let s=0,n=t[i*e],o=t[i*(e+1)];for(let a=1;a<r;a++){const l=n+t[i*(e+a)],c=o+t[i*(e+a)+1],h=(l-n)*(c+o);n=l,o=c,s+=h}return .5*s}function I2t(t,e){const{coords:r,lengths:i}=t;let s=0,n=0;for(let o=0;o<i.length;o++){const a=i[o];n+=u9e(r,s,a,e),s+=a}return Math.abs(n)}function $2t(t,e){if(C(t))return null;const r=t.clone(),i=t.coords,s=t.lengths;let n=0;for(let o=0;o<s.length;o++){const a=s[o];let l=i[e*n],c=i[e*n+1];for(let h=1;h<a;h++){const p=l+i[e*(n+h)],f=c+i[e*(n+h)+1];r.coords[e*(n+h)]=p,r.coords[e*(n+h)+1]=f,l=p,c=f}n+=a}return r}function Ug(t,e=0,r=0){_p(t.lengths,r),_p(t.coords,e)}function _p(t,e=0){t.length!==e&&(t.length=e)}const h9e={originPosition:"lowerLeft",scale:[1,1,1,1],translate:[0,0,0,0]};var zz;let Zs=zz=class extends ve{constructor(t){super(t),this.cacheHint=void 0,this.dynamicDataSource=void 0,this.gdbVersion=null,this.geometryPrecision=void 0,this.historicMoment=null,this.maxAllowableOffset=void 0,this.objectIds=null,this.orderByFields=null,this.outFields=null,this.outSpatialReference=null,this.relationshipId=void 0,this.start=void 0,this.num=void 0,this.returnGeometry=!1,this.returnM=void 0,this.returnZ=void 0,this.where=null}_writeHistoricMoment(t,e){e.historicMoment=t&&t.getTime()}writeStart(t,e){e.resultOffset=this.start,e.resultRecordCount=this.num||10,this.start>0&&this.where==null&&(e.definitionExpression="1=1")}clone(){return new zz(ne({cacheHint:this.cacheHint,dynamicDataSource:this.dynamicDataSource,gdbVersion:this.gdbVersion,geometryPrecision:this.geometryPrecision,historicMoment:this.historicMoment&&new Date(this.historicMoment.getTime()),maxAllowableOffset:this.maxAllowableOffset,objectIds:this.objectIds,orderByFields:this.orderByFields,outFields:this.outFields,outSpatialReference:this.outSpatialReference,relationshipId:this.relationshipId,start:this.start,num:this.num,returnGeometry:this.returnGeometry,where:this.where,returnZ:this.returnZ,returnM:this.returnM}))}};u([d({type:Boolean,json:{write:!0}})],Zs.prototype,"cacheHint",void 0),u([d({type:kd,json:{write:!0}})],Zs.prototype,"dynamicDataSource",void 0),u([d({type:String,json:{write:!0}})],Zs.prototype,"gdbVersion",void 0),u([d({type:Number,json:{write:!0}})],Zs.prototype,"geometryPrecision",void 0),u([d({type:Date})],Zs.prototype,"historicMoment",void 0),u([He("historicMoment")],Zs.prototype,"_writeHistoricMoment",null),u([d({type:Number,json:{write:!0}})],Zs.prototype,"maxAllowableOffset",void 0),u([d({type:[Number],json:{write:!0}})],Zs.prototype,"objectIds",void 0),u([d({type:[String],json:{write:!0}})],Zs.prototype,"orderByFields",void 0),u([d({type:[String],json:{write:!0}})],Zs.prototype,"outFields",void 0),u([d({type:et,json:{read:{source:"outSR"},write:{target:"outSR"}}})],Zs.prototype,"outSpatialReference",void 0),u([d({json:{write:!0}})],Zs.prototype,"relationshipId",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],Zs.prototype,"start",void 0),u([He("start"),He("num")],Zs.prototype,"writeStart",null),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],Zs.prototype,"num",void 0),u([d({json:{write:!0}})],Zs.prototype,"returnGeometry",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],Zs.prototype,"returnM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],Zs.prototype,"returnZ",void 0),u([d({type:String,json:{read:{source:"definitionExpression"},write:{target:"definitionExpression"}}})],Zs.prototype,"where",void 0),Zs=zz=u([I("esri.rest.support.RelationshipQuery")],Zs),Zs.from=us(Zs);const zS=Zs,L2t=Object.freeze(Object.defineProperty({__proto__:null,default:zS},Symbol.toStringTag,{value:"Module"}));var Gz;let DT=Gz=class extends ve{constructor(t){super(t),this.groupByFields=void 0,this.topCount=void 0,this.orderByFields=void 0}clone(){return new Gz({groupByFields:this.groupByFields,topCount:this.topCount,orderByFields:this.orderByFields})}};u([d({type:[String],json:{write:!0}})],DT.prototype,"groupByFields",void 0),u([d({type:Number,json:{write:!0}})],DT.prototype,"topCount",void 0),u([d({type:[String],json:{write:!0}})],DT.prototype,"orderByFields",void 0),DT=Gz=u([I("esri.rest.support.TopFilter")],DT);const d9e=DT;var jz;const Eee=new mr({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),Cee=new mr({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let Rs=jz=class extends ve{constructor(t){super(t),this.cacheHint=void 0,this.distance=void 0,this.geometry=null,this.geometryPrecision=void 0,this.maxAllowableOffset=void 0,this.num=void 0,this.objectIds=null,this.orderByFields=null,this.outFields=null,this.outSpatialReference=null,this.resultType=null,this.returnGeometry=!1,this.returnM=void 0,this.returnZ=void 0,this.start=void 0,this.spatialRelationship="intersects",this.timeExtent=null,this.topFilter=void 0,this.units=null,this.where="1=1"}writeStart(t,e){e.resultOffset=this.start,e.resultRecordCount=this.num||10}clone(){return new jz(ne({cacheHint:this.cacheHint,distance:this.distance,geometry:this.geometry,geometryPrecision:this.geometryPrecision,maxAllowableOffset:this.maxAllowableOffset,num:this.num,objectIds:this.objectIds,orderByFields:this.orderByFields,outFields:this.outFields,outSpatialReference:this.outSpatialReference,resultType:this.resultType,returnGeometry:this.returnGeometry,returnZ:this.returnZ,returnM:this.returnM,start:this.start,spatialRelationship:this.spatialRelationship,timeExtent:this.timeExtent,topFilter:this.topFilter,units:this.units,where:this.where}))}};u([d({type:Boolean,json:{write:!0}})],Rs.prototype,"cacheHint",void 0),u([d({type:Number,json:{write:{overridePolicy:t=>({enabled:t>0})}}})],Rs.prototype,"distance",void 0),u([d({types:jw,json:{read:il,write:!0}})],Rs.prototype,"geometry",void 0),u([d({type:Number,json:{write:!0}})],Rs.prototype,"geometryPrecision",void 0),u([d({type:Number,json:{write:!0}})],Rs.prototype,"maxAllowableOffset",void 0),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],Rs.prototype,"num",void 0),u([d({json:{write:!0}})],Rs.prototype,"objectIds",void 0),u([d({type:[String],json:{write:!0}})],Rs.prototype,"orderByFields",void 0),u([d({type:[String],json:{write:!0}})],Rs.prototype,"outFields",void 0),u([d({type:et,json:{read:{source:"outSR"},write:{target:"outSR"}}})],Rs.prototype,"outSpatialReference",void 0),u([d({type:String,json:{write:!0}})],Rs.prototype,"resultType",void 0),u([d({json:{write:!0}})],Rs.prototype,"returnGeometry",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],Rs.prototype,"returnM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],Rs.prototype,"returnZ",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],Rs.prototype,"start",void 0),u([He("start"),He("num")],Rs.prototype,"writeStart",null),u([d({type:String,json:{read:{source:"spatialRel",reader:Eee.read},write:{target:"spatialRel",writer:Eee.write}}})],Rs.prototype,"spatialRelationship",void 0),u([d({type:_m,json:{write:!0}})],Rs.prototype,"timeExtent",void 0),u([d({type:d9e,json:{write:!0}})],Rs.prototype,"topFilter",void 0),u([d({type:String,json:{read:Cee.read,write:{writer:Cee.write,overridePolicy(t){return{enabled:v(t)&&v(this.distance)&&this.distance>0}}}}})],Rs.prototype,"units",void 0),u([d({type:String,json:{write:!0}})],Rs.prototype,"where",void 0),Rs=jz=u([I("esri.rest.support.TopFeaturesQuery")],Rs),Rs.from=us(Rs);const TP=Rs,p9e="esri.widgets.Feature.support.relatedFeatureUtils",Aee=se.getLogger(p9e),Ree=new Map;function AL(t){if(!$g(t))return null;const[e,r]=t.split("/").slice(1);return{layerId:e,fieldName:r}}function f9e(t,e){if(!e.relationships)return null;let r=null;const{relationships:i}=e;return i.some(s=>s.id===parseInt(t,10)&&(r=s,!0)),r}function m9e({originRelationship:t,relationships:e,layerId:r}){let i=null;return e&&e.some(s=>(`${s.relatedTableId}`===r&&s.id===(t==null?void 0:t.id)&&(i=s),!!i)),i}function g9e(t,e){const r=e.toLowerCase();for(const i in t)if(i.toLowerCase()===r)return t[i];return null}function y9e(t,e){const r=f9e(t,e);if(r)return{url:`${e.url}/${r.relatedTableId}`,sourceSpatialReference:e.spatialReference,relation:r,relatedFields:[],outStatistics:[]}}function _9e(t,e){if(!e||!t)return;const{features:r,statsFeatures:i}=t,s=r&&r.value;e.relatedFeatures=s?s.features:[];const n=i&&i.value;e.relatedStatsFeatures=n?n.features:[]}function v9e(t,e,r,i){var n;const s=new zS;return s.outFields=["*"],s.relationshipId=typeof e.id=="number"?e.id:parseInt(e.id,10),s.objectIds=[t.attributes[r.objectIdField]],((n=r.queryRelatedFeatures)==null?void 0:n.call(r,s,i))??Promise.resolve({})}function b9e(t,e,r){let i=0;const s=[];for(;i<e.length;)s.push(`${t} IN (${e.slice(i,r+i)})`),i+=r;return s.join(" OR ")}async function w9e(t,e,r,i){const s=r.layerId.toString(),{layerInfo:n,relation:o,relatedFields:a,outStatistics:l,url:c,sourceSpatialReference:h}=e;if(!n||!o)return null;const p=m9e({originRelationship:o,relationships:n.relationships,layerId:s});if(p!=null&&p.relationshipTableId&&p.keyFieldInRelationshipTable){const m=(await v9e(t,p,r,i))[t.attributes[r.objectIdField]];if(!m)return null;const y=m.features.map(_=>_.attributes[n.objectIdField]);if(l!=null&&l.length&&n.supportsStatistics){const _=new Yf;_.where=b9e(n.objectIdField,y,1e3),_.outFields=a,_.outStatistics=l,_.sourceSpatialReference=h;const b={features:Promise.resolve(m),statsFeatures:gU(c,_)};return jl(b)}}const f=p==null?void 0:p.keyField;if(f){const m=m4(C9e(n.fields,f)),y=g9e(t.attributes,o.keyField),_=m?`${f}=${y}`:`${f}='${y}'`,b=gU(c,new Yf({where:_,outFields:e.relatedFields,sourceSpatialReference:h}),i),x=e.outStatistics&&e.outStatistics.length>0&&n.supportsStatistics?gU(c,new Yf({where:_,outFields:e.relatedFields,outStatistics:e.outStatistics,sourceSpatialReference:h}),i):null,T={features:b};return x&&(T.statsFeatures=x),jl(T)}return null}function x9e(t,e){return Ni(t,{query:{f:"json"},signal:e&&e.signal})}function T9e({relatedInfos:t,layer:e},r){const i={};return t.forEach((s,n)=>{const{relation:o}=s;if(!o){const p=new q("relation-required","A relation is required on a layer to retrieve related records.");throw Aee.error(p),p}const{relatedTableId:a}=o;if(typeof a!="number"){const p=new q("A related table ID is required on a layer to retrieve related records.");throw Aee.error(p),p}const l=`${e.url}/${a}`,c=Ree.get(l),h=c||x9e(l);c||Ree.set(l,h),i[n]=h}),YH(jl(i),r)}function S9e({graphic:t,relatedInfos:e,layer:r},i){const s={};return e.forEach((n,o)=>{n.layerInfo&&(s[o]=w9e(t,n,r,i))}),jl(s)}function E9e({relatedInfo:t,fieldName:e,fieldInfo:r}){var i,s;if((i=t.relatedFields)==null||i.push(e),r.statisticType){const n=new Tye({statisticType:r.statisticType,onStatisticField:e,outStatisticFieldName:e});(s=t.outStatistics)==null||s.push(n)}}function C9e(t,e){if(t!=null){e=e.toLowerCase();for(const r of t)if(r&&r.name.toLowerCase()===e)return r}return null}const Oee={chartAnimation:!0};let zn=class extends Te{constructor(e){super(e),this.abilities={...Oee},this.activeMediaInfoIndex=0,this.attributes=null,this.description=null,this.fieldInfoMap=null,this.formattedAttributes=null,this.expressionAttributes=null,this.isAggregate=!1,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null}castAbilities(e){return{...Oee,...e}}get activeMediaInfo(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}get formattedMediaInfos(){return this._formatMediaInfos()||[]}get formattedMediaInfoCount(){return this.formattedMediaInfos.length}setActiveMedia(e){this._setContentElementMedia(e)}next(){this._pageContentElementMedia(1)}previous(){this._pageContentElementMedia(-1)}_setContentElementMedia(e){const{formattedMediaInfoCount:r}=this,i=(e+r)%r;this.activeMediaInfoIndex=i}_pageContentElementMedia(e){const{activeMediaInfoIndex:r}=this,i=r+e;this._setContentElementMedia(i)}_formatMediaInfos(){const{mediaInfos:e,layer:r}=this,i=this.attributes??{},s=this.formattedAttributes??{},n=this.expressionAttributes??{},o=this.fieldInfoMap??new Map;return(e==null?void 0:e.map(a=>{const l=a==null?void 0:a.clone();if(!l)return null;if(l.title=Nb({attributes:i,fieldInfoMap:o,globalAttributes:s,expressionAttributes:n,layer:r,text:l.title}),l.caption=Nb({attributes:i,fieldInfoMap:o,globalAttributes:s,expressionAttributes:n,layer:r,text:l.caption}),l.altText=Nb({attributes:i,fieldInfoMap:o,globalAttributes:s,expressionAttributes:n,layer:r,text:l.altText}),l.type==="image"){const{value:c}=l;return this._setImageValue({value:c,formattedAttributes:s,layer:r}),l.value.sourceURL?l:void 0}if(l.type==="pie-chart"||l.type==="line-chart"||l.type==="column-chart"||l.type==="bar-chart"){const{value:c}=l;return this._setChartValue({value:c,chartType:l.type,attributes:i,formattedAttributes:s,layer:r,expressionAttributes:n}),l}return null}).filter(v))??[]}_setImageValue(e){const r=this.fieldInfoMap??new Map,{value:i,formattedAttributes:s,layer:n}=e,{linkURL:o,sourceURL:a}=i;if(a){const l=_z(a,n);i.sourceURL=yz({formattedAttributes:s,template:l,fieldInfoMap:r})}if(o){const l=_z(o,n);i.linkURL=yz({formattedAttributes:s,template:l,fieldInfoMap:r})}}_setChartValue(e){const{value:r,attributes:i,formattedAttributes:s,chartType:n,layer:o,expressionAttributes:a}=e,{popupTemplate:l,relatedInfos:c}=this,{fields:h,normalizeField:p}=r,f=o;if(r.fields=Q5e(h,f),p&&(r.normalizeField=rO(p,f)),!h.some(y=>!!(s[y]!=null||$g(y)&&(c!=null&&c.size))))return;const m=(l==null?void 0:l.fieldInfos)??[];h.forEach(y=>{if($g(y))return void(r.series=[...r.series,...this._getRelatedChartInfos({fieldInfos:m,fieldName:y,formattedAttributes:s,chartType:n,value:r})]);const _=this._getChartOption({value:r,attributes:i,chartType:n,formattedAttributes:s,expressionAttributes:a,fieldName:y,fieldInfos:m});r.series.push(_)})}_getRelatedChartInfos(e){var m;const{fieldInfos:r,fieldName:i,formattedAttributes:s,chartType:n,value:o}=e,a=[],l=AL(i),c=l&&((m=this.relatedInfos)==null?void 0:m.get(l.layerId.toString()));if(!c)return a;const{relatedFeatures:h,relation:p}=c;if(!p||!h)return a;const{cardinality:f}=p;return h.forEach(y=>{const{attributes:_}=y;_&&Object.keys(_).forEach(b=>{b===l.fieldName&&a.push(this._getChartOption({value:o,attributes:_,formattedAttributes:s,fieldName:i,chartType:n,relatedFieldName:b,hasMultipleRelatedFeatures:(h==null?void 0:h.length)>1,fieldInfos:r}))})}),f==="one-to-many"||f==="many-to-many"?a:[a[0]]}_getTooltip({label:e,value:r,chartType:i}){return i==="pie-chart"?`${e}`:`${e}: ${r}`}_getChartOption(e){var R;const{value:r,attributes:i,formattedAttributes:s,expressionAttributes:n,fieldName:o,relatedFieldName:a,fieldInfos:l,chartType:c,hasMultipleRelatedFeatures:h}=e,p=this.layer,f=this.fieldInfoMap??new Map,{normalizeField:m,tooltipField:y}=r,_=m?$g(m)?i[AL(m).fieldName]:i[m]:null,b=XW(o)&&n&&n[o]!==void 0?n[o]:a&&i[a]!==void 0?i[a]:i[o]!==void 0?i[o]:s[o],x=new jde({fieldName:o,value:b===void 0?null:b&&_?b/_:b});if($g(o)){const L=f.get(o.toLowerCase()),P=y&&f.get(y.toLowerCase()),U=(L==null?void 0:L.fieldName)??o,B=h&&y?AL(y).fieldName:(P==null?void 0:P.fieldName)??y,z=h&&B?i[B]:s[B]??(L==null?void 0:L.label)??(L==null?void 0:L.fieldName)??a,G=h&&a?i[a]:s[U];return x.tooltip=this._getTooltip({label:z,value:G,chartType:c}),x}const T=kge(l,o),S=rO(o,p),E=y&&s[y]!==void 0?s[y]:Fge(T||new tM({fieldName:S}),(R=this.popupTemplate)==null?void 0:R.expressionInfos),O=s[S];return x.tooltip=this._getTooltip({label:E,value:O,chartType:c}),x}};u([d()],zn.prototype,"abilities",void 0),u([cr("abilities")],zn.prototype,"castAbilities",null),u([d()],zn.prototype,"activeMediaInfoIndex",void 0),u([d({readOnly:!0})],zn.prototype,"activeMediaInfo",null),u([d()],zn.prototype,"attributes",void 0),u([d()],zn.prototype,"description",void 0),u([d()],zn.prototype,"fieldInfoMap",void 0),u([d()],zn.prototype,"formattedAttributes",void 0),u([d()],zn.prototype,"expressionAttributes",void 0),u([d({readOnly:!0})],zn.prototype,"formattedMediaInfos",null),u([d()],zn.prototype,"isAggregate",void 0),u([d()],zn.prototype,"layer",void 0),u([d({readOnly:!0})],zn.prototype,"formattedMediaInfoCount",null),u([d()],zn.prototype,"mediaInfos",void 0),u([d()],zn.prototype,"popupTemplate",void 0),u([d()],zn.prototype,"relatedInfos",void 0),u([d()],zn.prototype,"title",void 0),zn=u([I("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],zn);const Ub=zn;var Mee=["#ffffff","#858585","#ffbebe","#ffebbe","#ffebaf","#ffffbe","#e9ffbe","#d3ffbe","#beffe8","#bee8ff","#bed2ff","#e8beff","#ffbee8","#ebebeb","#707070","#ff7f7f","#ffa77f","#ffd37f","#ffff73","#d1ff73","#a3ff73","#73ffdf","#73dfff","#73b2ff","#df73ff","#ff73df","#d6d6d6","#5c5c5c","#ff0000","#ff5500","#ffaa00","#ffff00","#aaff00","#55ff00","#00ffc5","#00c5ff","#0070ff","#c500ff","#ff00c5","#c2c2c2","#474747","#e60000","#e64c00","#e69800","#e6e600","#98e600","#4ce600","#00e6a9","#00a9e6","#005ce6","#a900e6","#e600a9","#adadad","#242424","#a80000","#a83800","#a87000","#a8a800","#70a800","#38a800","#00a884","#0084a8","#004da8","#8400a8","#a80084","#999999","#1a1a1a","#730000","#732600","#734c00","#737300","#4c7300","#267300","#00734c","#004c73","#002673","#4c0073","#73004"],A9e=[].concat(Mee.slice(30,39),Mee.slice(28,30).reverse()),R9e=[{name:"default",colors:A9e},{name:"cat-dark",colors:["#ed5151","#149ece","#a7c636","#9e559c","#fc921f","#ffde3e","#f789d8","#b7814a","#3caf99","#6b6bd6","#b54779","#7f7f7f"]},{name:"tropical-bliss",colors:["#fce138","#ff9399","#fcd27e","#f1983c","#a553b7","#b1a9d0","#6ecffc","#4c81cd","#fc6f84","#fc3e5a","#6af689","#48885c"]},{name:"desert-blooms",colors:["#102432","#144d59","#ffc730","#ed9310","#a64f1b","#661510","#d9351a","#b31515","#4a0932","#8c213f","#18382e","#2c6954"]},{name:"under-the-sea",colors:["#bf9727","#607100","#00734c","#704489","#01acca","#024e76","#f09100","#ea311f","#c6004b","#7570b3","#666666","#333333"]},{name:"vibrant-rainbow",colors:["#fffb00","#f5cb11","#9fd40c","#46e39c","#32b8a6","#7ff2fa","#ac08cc","#dd33ff","#eb7200","#e8a784","#bf2e2e","#6c7000"]},{name:"ocean-bay",colors:["#191921","#11495c","#78b1c2","#454f4b","#8f8f82","#9be0c0","#87b051","#f7ec88","#ebdcc1","#dbb658","#c43541","#75351e"]},{name:"prairie-summer",colors:["#332424","#751555","#d47013","#d68989","#211173","#82aad6","#7bfaeb","#6ec9a8","#6b6408","#eada40","#ccc54a","#1fc235"]},{name:"pastel-chalk",colors:["#fffd99","#f5e6a4","#c1d48c","#b8e3d0","#a0b8b5","#cbf7fa","#d791f2","#dfc1eb","#f2b983","#e8c4b2","#bf8e8e","#94995c"]},{name:"seq-yellow-orange-red-bright",colors:["#910000","#b1260b","#c0370f","#e05919","#ef6a1d","#ff7b22","#ffa143","#ffb454","#ffda74","#ffed85"]},{name:"seq-reds-bright",colors:["#57453b","#7b4238","#9f4036","#c23d33","#d7483c","#ec5244","#f3696c","#f9816c","#ffc4ae","#fff0dc"]},{name:"seq-purples-bright",colors:["#4e465c","#5a4a78","#695291","#775baa","#8663c3","#946bdc","#aa89e8","#c1a6f3","#d7c4ff","#e6e1ff"]},{name:"seq-blues-bright",colors:["#404d54","#435c6c","#48799d","#4b88b6","#4d96ce","#50a5e7","#74bbed","#98d0f3","#bce6f9","#e6faff"]},{name:"seq-greens-bright",colors:["#39544c","#386757","#368165","#359b73","#33b581","#4bc392","#64d2a2","#7ce0b3","#cbf6d9","#f4ffea"]},{name:"seq-browns-bright",colors:["#524834","#715b38","#8f6e3c","#ae8140","#cc9444","#eba748","#eeb664","#f0c47f","#f9e0b7","#fff8eb"]}];const Pee="en-us",fX=new Map([["ar",()=>te(()=>import("./ar-bb1fe5ab.js"),["assets/ar-bb1fe5ab.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.a)],["bg-bg",()=>te(()=>import("./bg_BG-184a2bfa.js"),["assets/bg_BG-184a2bfa.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.b)],["bs-ba",()=>te(()=>import("./bs_BA-f32cc344.js"),["assets/bs_BA-f32cc344.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.b)],["ca-es",()=>te(()=>import("./ca_ES-d17ee95b.js"),["assets/ca_ES-d17ee95b.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.c)],["cs-cz",()=>te(()=>import("./cs_CZ-bcd1e782.js"),["assets/cs_CZ-bcd1e782.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.c)],["da-dk",()=>te(()=>import("./da_DK-27b1b06e.js"),["assets/da_DK-27b1b06e.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.d)],["de-de",()=>te(()=>import("./de_DE-c0a1d8dd.js"),["assets/de_DE-c0a1d8dd.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.d)],["de-ch",()=>te(()=>import("./de_CH-be7b4255.js"),["assets/de_CH-be7b4255.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.d)],["el-gr",()=>te(()=>import("./el_GR-05fb9ec0.js"),["assets/el_GR-05fb9ec0.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.e)],["en-us",()=>te(()=>import("./en_US-170979d8.js"),["assets/en_US-170979d8.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.e)],["en-ca",()=>te(()=>import("./en_CA-170979d8.js"),["assets/en_CA-170979d8.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.e)],["es-es",()=>te(()=>import("./es_ES-d0b66640.js"),["assets/es_ES-d0b66640.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.e)],["et-ee",()=>te(()=>import("./et_EE-56dd74d3.js"),["assets/et_EE-56dd74d3.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.e)],["fi-fi",()=>te(()=>import("./fi_FI-91d58cb9.js"),["assets/fi_FI-91d58cb9.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.f)],["fr-fr",()=>te(()=>import("./fr_FR-a11503e0.js"),["assets/fr_FR-a11503e0.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.f)],["he-il",()=>te(()=>import("./he_IL-90db98c4.js"),["assets/he_IL-90db98c4.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.h)],["hr-hr",()=>te(()=>import("./hr_HR-fac8bb29.js"),["assets/hr_HR-fac8bb29.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.h)],["hu-hu",()=>te(()=>import("./hu_HU-e8803856.js"),["assets/hu_HU-e8803856.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.h)],["id-id",()=>te(()=>import("./id_ID-86e57d06.js"),["assets/id_ID-86e57d06.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.i)],["it-it",()=>te(()=>import("./it_IT-2d4485ba.js"),["assets/it_IT-2d4485ba.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.i)],["ja-jp",()=>te(()=>import("./ja_JP-77c6c16d.js"),["assets/ja_JP-77c6c16d.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.j)],["ko-kr",()=>te(()=>import("./ko_KR-e155b9ab.js"),["assets/ko_KR-e155b9ab.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.k)],["lt-lt",()=>te(()=>import("./lt_LT-fde47ae9.js"),["assets/lt_LT-fde47ae9.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.l)],["lv-lv",()=>te(()=>import("./lv_LV-359be050.js"),["assets/lv_LV-359be050.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.l)],["nb-no",()=>te(()=>import("./nb_NO-30d57c1a.js"),["assets/nb_NO-30d57c1a.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.n)],["nl-nl",()=>te(()=>import("./nl_NL-cb904b48.js"),["assets/nl_NL-cb904b48.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.n)],["pl-pl",()=>te(()=>import("./pl_PL-58c54c9f.js"),["assets/pl_PL-58c54c9f.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.p)],["pt-br",()=>te(()=>import("./pt_BR-d2e10248.js"),["assets/pt_BR-d2e10248.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.p)],["pt-pt",()=>te(()=>import("./pt_PT-65a41842.js"),["assets/pt_PT-65a41842.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.p)],["ro-ro",()=>te(()=>import("./ro_RO-15e90e9f.js"),["assets/ro_RO-15e90e9f.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.r)],["ru-ru",()=>te(()=>import("./ru_RU-a74d21e5.js"),["assets/ru_RU-a74d21e5.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.r)],["sk-sk",()=>te(()=>import("./sk_SK-a928dbd1.js"),["assets/sk_SK-a928dbd1.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.s)],["sl-sl",()=>te(()=>import("./sl_SL-1a3c3078.js"),["assets/sl_SL-1a3c3078.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.s)],["sr-rs",()=>te(()=>import("./sr_RS-0b18b911.js"),["assets/sr_RS-0b18b911.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.s)],["sv-se",()=>te(()=>import("./sv_SE-ce7e3f84.js"),["assets/sv_SE-ce7e3f84.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.s)],["th-th",()=>te(()=>import("./th_TH-1448f333.js"),["assets/th_TH-1448f333.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.t)],["tr-tr",()=>te(()=>import("./tr_TR-dd92f630.js"),["assets/tr_TR-dd92f630.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.t)],["uk-ua",()=>te(()=>import("./uk_UA-fe4434ed.js"),["assets/uk_UA-fe4434ed.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.u)],["vi-vn",()=>te(()=>import("./vi_VN-41938633.js"),["assets/vi_VN-41938633.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.v)],["zh-cn",()=>te(()=>import("./zh_Hans-524a1291.js"),["assets/zh_Hans-524a1291.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.z)],["zh-hk",()=>te(()=>import("./zh_Hant-0e1f08e5.js"),["assets/zh_Hant-0e1f08e5.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.z)],["zh-tw",()=>te(()=>import("./zh_Hant-0e1f08e5.js"),["assets/zh_Hant-0e1f08e5.js","assets/_commonjsHelpers-2f3e7994.js","assets/_commonjs-dynamic-modules-42bbacb3.js"]).then(t=>t.z)]]);function O9e(t){const e=t.split("-")[0].toLowerCase();let r=null;for(const i of fX.keys())if(i.startsWith(e)){r=i;break}return r}function M9e(t){return t?fX.has(t.toLowerCase())?t.toLowerCase():O9e(t)||Pee:Pee}let dx=null,hC=null;async function P9e(t=Ih()){if(t=M9e(t),dx&&t===hC)return dx;dx=te(()=>import("./index-a1a574a3.js"),["assets/index-a1a574a3.js","assets/_commonjsHelpers-2f3e7994.js"]).then(e=>e.i),hC=t;try{const[e,r]=await Promise.all([dx,fX.get(hC)()]);hC===t&&(e.am4core.options.defaultLocale=r.default),e.am4core.options.suppressWarnings=!0,e.am4core.options.autoDispose=!0}catch{return dx=null,hC=null,null}return dx}function I9e(t,e="default"){const r=R9e.find(i=>i.name===e);return r?r.colors.map(i=>t.color(i)):null}const ul="esri-feature-media",en={base:ul,mediaContainer:`${ul}__container`,mediaItemContainer:`${ul}__item-container`,mediaItem:`${ul}__item`,mediaItemTitle:`${ul}__item-title`,mediaItemCaption:`${ul}__item-caption`,mediaPrevious:`${ul}__previous`,mediaPreviousIconLTR:`${ul}__previous-icon`,mediaPreviousIconRTL:`${ul}__previous-icon--rtl`,mediaNext:`${ul}__next`,mediaNextIconLTR:`${ul}__next-icon`,mediaNextIconRTL:`${ul}__next-icon--rtl`,mediaChart:`${ul}__chart`,mediaButton:`${ul}__button`,mediaIcon:`${ul}__icon`,iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconRightTriangleArrow:"esri-icon-right-triangle-arrow"},bU=.05,wU=.95,xU=15,Mm="color",Ny="tooltip",dC="value",Iee="default-line-value";let oc=class extends Ea{constructor(e,r){super(e,r),this._refreshTimer=null,this._refreshIntervalInfo=null,this._featureElementInfo=null,this.viewModel=new Ub,this.messages=null,this._getChartDependencies=async i=>{const s=await P9e(),{destroyed:n,viewModel:o}=this;if(n||!o||!i)return;const{activeMediaInfo:a}=o,l=await this._getRendererColors(s);this._renderChart({chartDiv:i,mediaInfo:a,chartsModule:s,colorMap:l})}}initialize(){this._featureElementInfo=new Z4,this.addHandles([ie(()=>{var e,r;return[(e=this.viewModel)==null?void 0:e.activeMediaInfo,(r=this.viewModel)==null?void 0:r.activeMediaInfoIndex]},()=>this._setupMediaRefreshTimer(),Vt),ie(()=>{var e,r;return[(e=this.viewModel)==null?void 0:e.description,(r=this.viewModel)==null?void 0:r.title]},()=>this._setupFeatureElementInfo(),Vt)])}destroy(){var e;this._clearMediaRefreshTimer(),(e=this._featureElementInfo)==null||e.destroy()}get attributes(){return this.viewModel.attributes}set attributes(e){this.viewModel.attributes=e}get activeMediaInfoIndex(){return this.viewModel.activeMediaInfoIndex}set activeMediaInfoIndex(e){this.viewModel.activeMediaInfoIndex=e}get description(){return this.viewModel.description}set description(e){this.viewModel.description=e}get fieldInfoMap(){return this.viewModel.fieldInfoMap}set fieldInfoMap(e){this.viewModel.fieldInfoMap=e}get layer(){return this.viewModel.layer}set layer(e){this.viewModel.layer=e}get mediaInfos(){return this.viewModel.mediaInfos}set mediaInfos(e){this.viewModel.mediaInfos=e}get popupTemplate(){return this.viewModel.popupTemplate}set popupTemplate(e){this.viewModel.popupTemplate=e}get relatedInfos(){return this.viewModel.relatedInfos}set relatedInfos(e){this.viewModel.relatedInfos=e}get title(){return this.viewModel.title}set title(e){this.viewModel.title=e}render(){var e;return re("div",{bind:this,class:en.base,onkeyup:this._handleMediaKeyup},(e=this._featureElementInfo)==null?void 0:e.render(),this.renderMedia())}renderMedia(){const{formattedMediaInfoCount:e}=this.viewModel;return e?re("div",{key:"media-element-container",class:en.mediaContainer},this.renderMediaPageButton("previous"),this.renderMediaInfo(),this.renderMediaPageButton("next")):null}renderImageMediaInfo(e){const{_refreshIntervalInfo:r}=this,{activeMediaInfoIndex:i,formattedMediaInfoCount:s}=this.viewModel,{value:n,refreshInterval:o,altText:a,title:l,type:c}=e,{sourceURL:h,linkURL:p}=n,f=Nge(p??void 0)?"_blank":"_self",m=f==="_blank"?"noreferrer":"",y=o?r:null,_=y?y.timestamp:0,b=y?y.sourceURL:h,x=re("img",{alt:a||l,key:`media-${c}-${i}-${s}-${_}`,src:b??void 0});return(p?re("a",{title:l,href:p,rel:m,target:f},x):null)||x}renderChartMediaInfo(e){const{activeMediaInfoIndex:r,formattedMediaInfoCount:i}=this.viewModel;return re("div",{key:`media-${e.type}-${r}-${i}`,bind:this,class:en.mediaChart,afterCreate:this._getChartDependencies})}renderMediaInfoType(){const{activeMediaInfo:e}=this.viewModel;return e?e.type==="image"?this.renderImageMediaInfo(e):e.type.includes("chart")?this.renderChartMediaInfo(e):null:null}renderMediaInfo(){const{activeMediaInfo:e}=this.viewModel;if(!e)return null;const r=e.title?re("div",{key:"media-title",class:en.mediaItemTitle,innerHTML:e.title}):null,i=e.caption?re("div",{key:"media-caption",class:en.mediaItemCaption,innerHTML:e.caption}):null;return re("div",{key:"media-container",class:en.mediaItemContainer},re("div",{key:"media-item-container",class:en.mediaItem},this.renderMediaInfoType()),r,i)}renderMediaPageButton(e){if(this.viewModel.formattedMediaInfoCount<2)return null;const r=e==="previous",i=r?this.messages.previous:this.messages.next,s=r?this.classes(en.mediaButton,en.mediaPrevious):this.classes(en.mediaButton,en.mediaNext),n=r?this.classes(en.mediaIcon,en.mediaPreviousIconLTR,en.iconLeftTriangleArrow):this.classes(en.mediaIcon,en.mediaNextIconLTR,en.iconRightTriangleArrow),o=r?this.classes(en.mediaIcon,en.mediaPreviousIconRTL,en.iconRightTriangleArrow):this.classes(en.mediaIcon,en.mediaNextIconRTL,en.iconLeftTriangleArrow),a=r?"media-previous":"media-next",l=r?this._previous:this._next;return re("button",{type:"button",key:a,title:i,"aria-label":i,tabIndex:0,class:s,bind:this,onclick:l},re("span",{"aria-hidden":"true",class:n}),re("span",{"aria-hidden":"true",class:o}))}_setupFeatureElementInfo(){var i;const{description:e,title:r}=this;(i=this._featureElementInfo)==null||i.set({description:e,title:r})}_next(){this.viewModel.next()}_previous(){this.viewModel.previous()}_getRenderer(){const{isAggregate:e,layer:r}=this.viewModel;return e&&(r!=null&&r.featureReduction)&&"renderer"in r.featureReduction?r.featureReduction.renderer:r==null?void 0:r.renderer}async _getRendererColors(e){const{am4core:r}=e,i=new Map,s=this._getRenderer(),n="default";if(!s)return i;const o=await ZUe(s);return o.delete(n),Array.from(o.values()).every(a=>(a==null?void 0:a.length)===1)&&(i.set(Iee,r.color({r:50,g:50,b:50,a:1})),Array.from(o.keys()).forEach(a=>{var l;a&&i.set(a,r.color((l=o.get(a))==null?void 0:l[0].toCss(!0)))})),i}_handleMediaKeyup(e){const r=fb(e);r==="ArrowLeft"&&(e.stopPropagation(),this.viewModel.previous()),r==="ArrowRight"&&(e.stopPropagation(),this.viewModel.next())}_renderChart(e){const{abilities:r}=this.viewModel,{chartsModule:i,chartDiv:s,mediaInfo:n,colorMap:o}=e,{value:a,type:l}=n,{am4core:c}=i,h=I9e(c);function p(y){y instanceof c.ColorSet&&h&&(y.list=h)}NN()&&c.useTheme(i.am4themes_dark);const f=window.matchMedia("(prefers-reduced-motion: reduce)");r.chartAnimation&&!f.matches?c.useTheme(i.am4themes_animated):c.unuseTheme(i.am4themes_animated),c.useTheme(p);const m=l==="pie-chart"?this._createPieChart(e):this._createXYChart(e);s.setAttribute("aria-label",n.altText||n.title),m.data=a.series.map(y=>({[Ny]:y.tooltip,[dC]:y.value,[Mm]:o.get(y.fieldName)})).filter(y=>l!=="pie-chart"||y.value!=null&&y.value>0)}_customizeChartTooltip(e,r){e&&(e.label.wrap=!0,e.label.maxWidth=200,e.autoTextColor=!1,e.getFillFromObject=!1,e.label.fill=r.color("#ffffff"),e.background.fill=r.color({r:0,g:0,b:0,a:.7}))}_createPieChart(e){const{chartDiv:r,chartsModule:i}=e,{am4core:s,am4charts:n}=i,o=s.create(r,n.PieChart);o.rtl=Uf(this.container);const a=o.series.push(new n.PieSeries);return a.labels.template.disabled=!0,a.ticks.template.disabled=!0,a.dataFields.value=dC,a.dataFields.category=Ny,this._customizeChartTooltip(a.tooltip,s),a.slices.template.propertyFields.fill=Mm,a.slices.template.propertyFields.stroke=Mm,o}_getMinSeriesValue(e){let r=0;return e.forEach(i=>r=Math.min(i.value,r)),r}_createColumnChart(e,r){const{chartsModule:i,mediaInfo:s}=r,{value:n}=s,{am4core:o,am4charts:a}=i,l=e.xAxes.push(new a.CategoryAxis);l.dataFields.category=Ny,l.renderer.labels.template.disabled=!0;const c=l.tooltip;this._customizeChartTooltip(c,o),c.events.on("sizechanged",()=>{c.dy=-c.contentHeight});const h=e.yAxes.push(new a.ValueAxis),p=h.renderer.labels.template;h.renderer.minLabelPosition=bU,h.renderer.maxLabelPosition=wU,h.min=this._getMinSeriesValue(n.series),this._customizeChartTooltip(h.tooltip,o),p.wrap=!0;const f=e.series.push(new a.ColumnSeries);f.dataFields.valueY=dC,f.dataFields.categoryX=Ny,f.columns.template.propertyFields.fill=Mm,f.columns.template.propertyFields.stroke=Mm,e.cursor=new a.XYCursor,n.series.length>xU&&(e.scrollbarX=new o.Scrollbar)}_createBarChart(e,r){const{chartsModule:i,mediaInfo:s}=r,{value:n}=s,{am4core:o,am4charts:a}=i,l=e.yAxes.push(new a.CategoryAxis);l.dataFields.category=Ny,l.renderer.inversed=!0,l.renderer.labels.template.disabled=!0;const c=l.tooltip;this._customizeChartTooltip(c,o),c.events.on("sizechanged",()=>{c.dx=c.contentWidth});const h=e.xAxes.push(new a.ValueAxis),p=h.renderer.labels.template;h.renderer.minLabelPosition=bU,h.renderer.maxLabelPosition=wU,h.min=this._getMinSeriesValue(n.series),this._customizeChartTooltip(h.tooltip,o),p.wrap=!0;const f=e.series.push(new a.ColumnSeries);f.dataFields.valueX=dC,f.dataFields.categoryY=Ny,f.columns.template.propertyFields.fill=Mm,f.columns.template.propertyFields.stroke=Mm,e.cursor=new a.XYCursor,n.series.length>xU&&(e.scrollbarY=new o.Scrollbar)}_createLineChart(e,r){const{chartsModule:i,mediaInfo:s,colorMap:n}=r,{value:o}=s,{am4core:a,am4charts:l}=i,c=e.xAxes.push(new l.CategoryAxis);c.dataFields.category=Ny,c.renderer.labels.template.disabled=!0;const h=c.tooltip;this._customizeChartTooltip(h,a),h.events.on("sizechanged",()=>{h.dy=-h.contentHeight});const p=e.yAxes.push(new l.ValueAxis),f=p.renderer.labels.template;p.renderer.minLabelPosition=bU,p.renderer.maxLabelPosition=wU,p.min=this._getMinSeriesValue(o.series),this._customizeChartTooltip(p.tooltip,a),f.wrap=!0;const m=e.series.push(new l.LineSeries);m.dataFields.categoryX=Ny,m.dataFields.valueY=dC,m.strokeWidth=1;const y=n.get(Iee);y&&(m.stroke=y);const _=m.bullets.push(new l.CircleBullet);_.propertyFields.fill=Mm,_.propertyFields.stroke=Mm,e.cursor=new l.XYCursor,o.series.length>xU&&(e.scrollbarX=new a.Scrollbar)}_createXYChart(e){const{chartDiv:r,chartsModule:i,mediaInfo:s}=e,{type:n}=s,{am4core:o,am4charts:a}=i,l=o.create(r,a.XYChart);return l.rtl=Uf(this.container),n==="column-chart"&&this._createColumnChart(l,e),n==="bar-chart"&&this._createBarChart(l,e),n==="line-chart"&&this._createLineChart(l,e),l}_clearMediaRefreshTimer(){const{_refreshTimer:e}=this;e&&(clearTimeout(e),this._refreshTimer=null)}_updateMediaInfoTimestamp(e){const r=Date.now();this._refreshIntervalInfo={timestamp:r,sourceURL:e&&this._getImageSource(e,r)},this.scheduleRender()}_setupMediaRefreshTimer(){this._clearMediaRefreshTimer();const{activeMediaInfo:e}=this.viewModel;e&&e.type==="image"&&e.refreshInterval&&this._setRefreshTimeout(e)}_setRefreshTimeout(e){const{refreshInterval:r,value:i}=e;if(!r)return;const s=6e4*r;this._updateMediaInfoTimestamp(i.sourceURL);const n=setInterval(()=>{this._updateMediaInfoTimestamp(i.sourceURL)},s);this._refreshTimer=n}_getImageSource(e,r){const i=e.includes("?")?"&":"?",[s,n=""]=e.split("#");return`${s}${i}timestamp=${r}${n?"#":""}${n}`}};u([d()],oc.prototype,"attributes",null),u([d()],oc.prototype,"activeMediaInfoIndex",null),u([d()],oc.prototype,"description",null),u([d()],oc.prototype,"fieldInfoMap",null),u([d()],oc.prototype,"layer",null),u([d()],oc.prototype,"mediaInfos",null),u([d()],oc.prototype,"popupTemplate",null),u([d()],oc.prototype,"relatedInfos",null),u([d()],oc.prototype,"title",null),u([d({type:Ub})],oc.prototype,"viewModel",void 0),u([d(),ya("esri/widgets/Feature/t9n/Feature")],oc.prototype,"messages",void 0),oc=u([I("esri.widgets.Feature.FeatureMedia")],oc);const Lye=oc;var Hz;let BA=Hz=class extends ve{constructor(t){super(t),this.minValue=0,this.maxValue=0}clone(){return new Hz({minValue:this.minValue,maxValue:this.maxValue})}};u([d({type:Number,json:{write:!0}})],BA.prototype,"minValue",void 0),u([d({type:Number,json:{write:!0}})],BA.prototype,"maxValue",void 0),BA=Hz=u([I("esri.renderer.support.AuthoringInfoClassBreakInfo")],BA);var qz;let K0=qz=class extends ve{constructor(t){super(t),this.field="",this.normalizationField="",this.label="",this.classBreakInfos=[]}clone(){return new qz({field:this.field,normalizationField:this.normalizationField,label:this.label,classBreakInfos:ne(this.classBreakInfos)})}};u([d({type:String,json:{write:!0}})],K0.prototype,"field",void 0),u([d({type:String,json:{write:!0}})],K0.prototype,"normalizationField",void 0),u([d({type:String,json:{write:!0}})],K0.prototype,"label",void 0),u([d({type:[BA],json:{write:!0}})],K0.prototype,"classBreakInfos",void 0),K0=qz=u([I("esri.renderers.support.AuthoringInfoFieldInfo")],K0);var Wz;const SP=new mr({percentTotal:"percent-of-total",ratio:"ratio",percent:"percent"}),EP=new mr({sizeInfo:"size",colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation"}),$ee={key:t=>typeof t=="number"?"number":"string",typeMap:{number:Number,string:String},base:null},Lee=["high-to-low","above-and-below","centered-on","extremes"],Dee=[...new Set(["high-to-low","above-and-below","centered-on","extremes","90-10","above","below","high-to-low","above-and-below","90-10","above","below"])],Nee=["seconds","minutes","hours","days","months","years"];let ac=Wz=class extends ve{constructor(t){super(t),this.endTime=null,this.field=null,this.maxSliderValue=null,this.minSliderValue=null,this.startTime=null,this.type=null,this.units=null}castEndTime(t){return typeof t=="string"||typeof t=="number"?t:null}castStartTime(t){return typeof t=="string"||typeof t=="number"?t:null}get style(){return this.type==="color"?this._get("style"):null}set style(t){this._set("style",t)}get theme(){return this.type==="color"||this.type==="size"?this._get("theme")||"high-to-low":null}set theme(t){this._set("theme",t)}clone(){return new Wz({endTime:this.endTime,field:this.field,maxSliderValue:this.maxSliderValue,minSliderValue:this.minSliderValue,startTime:this.startTime,style:this.style,theme:this.theme,type:this.type,units:this.units})}};u([d({types:$ee,json:{write:!0}})],ac.prototype,"endTime",void 0),u([cr("endTime")],ac.prototype,"castEndTime",null),u([d({type:String,json:{write:!0}})],ac.prototype,"field",void 0),u([d({type:Number,json:{write:!0}})],ac.prototype,"maxSliderValue",void 0),u([d({type:Number,json:{write:!0}})],ac.prototype,"minSliderValue",void 0),u([d({types:$ee,json:{write:!0}})],ac.prototype,"startTime",void 0),u([cr("startTime")],ac.prototype,"castStartTime",null),u([d({type:SP.apiValues,value:null,json:{type:SP.jsonValues,read:SP.read,write:SP.write}})],ac.prototype,"style",null),u([d({type:Dee,value:null,json:{type:Dee,origins:{"web-scene":{type:Lee,write:{writer:(t,e)=>{Lee.includes(t)&&(e.theme=t)}}}},write:!0}})],ac.prototype,"theme",null),u([d({type:EP.apiValues,json:{type:EP.jsonValues,read:EP.read,write:EP.write}})],ac.prototype,"type",void 0),u([d({type:Nee,json:{type:Nee,write:!0}})],ac.prototype,"units",void 0),ac=Wz=u([I("esri.renderers.support.AuthoringInfoVisualVariable")],ac);const $9e=ac;let RL=class extends ve{constructor(e){super(e),this.type=null}};u([d({readOnly:!0,json:{read:!1,write:!0}})],RL.prototype,"type",void 0),RL=u([I("esri.rest.support.ColorRamp")],RL);const mX=RL;var Xz;let N1=Xz=class extends mX{constructor(t){super(t),this.algorithm=null,this.fromColor=null,this.toColor=null,this.type="algorithmic"}clone(){return new Xz({fromColor:ne(this.fromColor),toColor:ne(this.toColor),algorithm:this.algorithm})}};u([gt({esriCIELabAlgorithm:"cie-lab",esriHSVAlgorithm:"hsv",esriLabLChAlgorithm:"lab-lch"})],N1.prototype,"algorithm",void 0),u([d({type:Ze,json:{type:[Gi],write:!0}})],N1.prototype,"fromColor",void 0),u([d({type:Ze,json:{type:[Gi],write:!0}})],N1.prototype,"toColor",void 0),u([d({type:["algorithmic"]})],N1.prototype,"type",void 0),N1=Xz=u([I("esri.rest.support.AlgorithmicColorRamp")],N1);const gX=N1;var Yz;let zA=Yz=class extends mX{constructor(t){super(t),this.colorRamps=null,this.type="multipart"}clone(){return new Yz({colorRamps:ne(this.colorRamps)})}};u([d({type:[gX],json:{write:!0}})],zA.prototype,"colorRamps",void 0),u([d({type:["multipart"]})],zA.prototype,"type",void 0),zA=Yz=u([I("esri.rest.support.MultipartColorRamp")],zA);const Dye=zA,L9e={key:"type",base:mX,typeMap:{algorithmic:gX,multipart:Dye}};function D9e(t){return t&&t.type?t.type==="algorithmic"?gX.fromJSON(t):t.type==="multipart"?Dye.fromJSON(t):null:null}var Zz;const Rv=new mr({esriClassifyDefinedInterval:"defined-interval",esriClassifyEqualInterval:"equal-interval",esriClassifyManual:"manual",esriClassifyNaturalBreaks:"natural-breaks",esriClassifyQuantile:"quantile",esriClassifyStandardDeviation:"standard-deviation"}),CP=new mr({pieChart:"pie-chart",classedSize:"class-breaks-size",classedColor:"class-breaks-color",univariateColorSize:"univariate-color-size",relationship:"relationship",predominance:"predominance",dotDensity:"dot-density",flow:"flow"}),Fee=new mr({classedSize:"class-breaks-size",classedColor:"class-breaks-color",univariateColorSize:"univariate-color-size",relationship:"relationship",predominance:"predominance",dotDensity:"dot-density"}),Uee=["inches","feet","yards","miles","nautical-miles","millimeters","centimeters","decimeters","meters","kilometers","decimal-degrees"],N9e=["high-to-low","above-and-below","above","below","90-10"],F9e=["flow-line","wave-front"],U9e=["caret","circle-caret","arrow","circle-arrow","plus-minus","circle-plus-minus","square","circle","triangle","happy-sad","thumb","custom"];let tn=Zz=class extends ve{constructor(t){super(t),this.colorRamp=null,this.fadeRatio=null,this.isAutoGenerated=!1,this.lengthUnit=null,this.maxSliderValue=null,this.minSliderValue=null,this.visualVariables=null}get classificationMethod(){const t=this._get("classificationMethod"),e=this.type;return e&&e!=="relationship"?e==="class-breaks-size"||e==="class-breaks-color"?t||"manual":null:t}set classificationMethod(t){this._set("classificationMethod",t)}readColorRamp(t){return t?D9e(t):void 0}get fields(){return this.type&&this.type!=="predominance"?null:this._get("fields")}set fields(t){this._set("fields",t)}get field1(){return this.type&&this.type!=="relationship"?null:this._get("field1")}set field1(t){this._set("field1",t)}get field2(){return this.type&&this.type!=="relationship"?null:this._get("field2")}set field2(t){this._set("field2",t)}get flowTheme(){return this.type==="flow"?this._get("flowTheme"):null}set flowTheme(t){this._set("flowTheme",t)}get focus(){return this.type&&this.type!=="relationship"?null:this._get("focus")}set focus(t){this._set("focus",t)}get numClasses(){return this.type&&this.type!=="relationship"?null:this._get("numClasses")}set numClasses(t){this._set("numClasses",t)}get statistics(){return this.type==="univariate-color-size"&&this.univariateTheme==="above-and-below"?this._get("statistics"):null}set statistics(t){this._set("statistics",t)}get standardDeviationInterval(){const t=this.type;return t&&t!=="relationship"&&t!=="class-breaks-size"&&t!=="class-breaks-color"||this.classificationMethod&&this.classificationMethod!=="standard-deviation"?null:this._get("standardDeviationInterval")}set standardDeviationInterval(t){this._set("standardDeviationInterval",t)}get type(){return this._get("type")}set type(t){let e=t;t==="classed-size"?e="class-breaks-size":t==="classed-color"&&(e="class-breaks-color"),this._set("type",e)}get univariateSymbolStyle(){return this.type==="univariate-color-size"&&this.univariateTheme==="above-and-below"?this._get("univariateSymbolStyle"):null}set univariateSymbolStyle(t){this._set("univariateSymbolStyle",t)}get univariateTheme(){return this.type==="univariate-color-size"?this._get("univariateTheme"):null}set univariateTheme(t){this._set("univariateTheme",t)}clone(){return new Zz({classificationMethod:this.classificationMethod,colorRamp:ne(this.colorRamp),fadeRatio:ne(this.fadeRatio),fields:this.fields&&this.fields.slice(0),field1:ne(this.field1),field2:ne(this.field2),isAutoGenerated:this.isAutoGenerated,focus:this.focus,numClasses:this.numClasses,maxSliderValue:this.maxSliderValue,minSliderValue:this.minSliderValue,lengthUnit:this.lengthUnit,statistics:this.statistics,standardDeviationInterval:this.standardDeviationInterval,type:this.type,visualVariables:this.visualVariables&&this.visualVariables.map(t=>t.clone()),univariateSymbolStyle:this.univariateSymbolStyle,univariateTheme:this.univariateTheme,flowTheme:this.flowTheme})}};u([d({type:Rv.apiValues,value:null,json:{type:Rv.jsonValues,read:Rv.read,write:Rv.write,origins:{"web-document":{default:"manual",type:Rv.jsonValues,read:Rv.read,write:Rv.write}}}})],tn.prototype,"classificationMethod",null),u([d({types:L9e,json:{write:!0}})],tn.prototype,"colorRamp",void 0),u([Fe("colorRamp")],tn.prototype,"readColorRamp",null),u([d({json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],tn.prototype,"fadeRatio",void 0),u([d({type:[String],value:null,json:{write:!0}})],tn.prototype,"fields",null),u([d({type:K0,value:null,json:{write:!0}})],tn.prototype,"field1",null),u([d({type:K0,value:null,json:{write:!0}})],tn.prototype,"field2",null),u([d({type:F9e,value:null,json:{write:!0,origins:{"web-scene":{write:!1}}}})],tn.prototype,"flowTheme",null),u([d({type:["HH","HL","LH","LL"],value:null,json:{write:!0}})],tn.prototype,"focus",null),u([d({type:Boolean,json:{write:!0,default:!1,origins:{"web-scene":{write:!1}}}})],tn.prototype,"isAutoGenerated",void 0),u([d({type:Number,value:null,json:{type:Gi,write:!0}})],tn.prototype,"numClasses",null),u([d({type:Uee,json:{type:Uee,read:!1,write:!1,origins:{"web-scene":{read:!0,write:!0}}}})],tn.prototype,"lengthUnit",void 0),u([d({type:Number,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],tn.prototype,"maxSliderValue",void 0),u([d({type:Number,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],tn.prototype,"minSliderValue",void 0),u([d({type:Object,value:null,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],tn.prototype,"statistics",null),u([d({type:[.25,.33,.5,1],value:null,json:{type:[.25,.33,.5,1],write:!0}})],tn.prototype,"standardDeviationInterval",null),u([d({type:CP.apiValues,value:null,json:{type:CP.jsonValues,read:CP.read,write:CP.write,origins:{"web-scene":{type:Fee.jsonValues,write:{writer:Fee.write,overridePolicy:t=>({enabled:t!=="flow"})}}}}})],tn.prototype,"type",null),u([d({type:[$9e],json:{write:!0}})],tn.prototype,"visualVariables",void 0),u([d({type:U9e,value:null,json:{write:!0,origins:{"web-scene":{write:!1}}}})],tn.prototype,"univariateSymbolStyle",null),u([d({type:N9e,value:null,json:{write:!0,origins:{"web-scene":{write:!1}}}})],tn.prototype,"univariateTheme",null),tn=Zz=u([I("esri.renderers.support.AuthoringInfo")],tn);const yX=tn,TU=new mr({simple:"simple",uniqueValue:"unique-value",classBreaks:"class-breaks",heatmap:"heatmap",dotDensity:"dot-density",dictionary:"dictionary",pieChart:"pie-chart"},{ignoreUnknown:!0});let GA=class extends ve{constructor(e){super(e),this.authoringInfo=null,this.type=null}async getRequiredFields(e){if(!this.collectRequiredFields)return[];const r=new Set;return await this.collectRequiredFields(r,e),Array.from(r).sort()}getSymbol(e,r){}async getSymbolAsync(e,r){}getSymbols(){return[]}getAttributeHash(){return JSON.stringify(this)}getMeshHash(){return JSON.stringify(this)}};u([d({type:yX,json:{write:!0}})],GA.prototype,"authoringInfo",void 0),u([d({type:TU.apiValues,readOnly:!0,json:{type:TU.jsonValues,read:!1,write:{writer:TU.write,ignoreOrigin:!0}}})],GA.prototype,"type",void 0),GA=u([I("esri.renderers.Renderer")],GA);const hy=GA;function k9e(t){var e,r;return((r=(e=t.match(V9e))==null?void 0:e[1])==null?void 0:r.replace(/\\'/g,"'"))??null}const V9e=/^hash\(\$feature\['((\\'|[^'])+)'\]\) \* 8\.381e-8$/;var Jz;let Z2=Jz=class extends ve{constructor(){super(...arguments),this.title=null}clone(){return new Jz({title:this.title})}};u([d({type:String,json:{write:!0}})],Z2.prototype,"title",void 0),Z2=Jz=u([I("esri.renderers.support.LegendOptions")],Z2);var Kz;let OL=Kz=class extends Z2{constructor(){super(...arguments),this.showLegend=null}clone(){return new Kz({title:this.title,showLegend:this.showLegend})}};u([d({type:Boolean,json:{write:!0}})],OL.prototype,"showLegend",void 0),OL=Kz=u([I("esri.renderers.visualVariables.support.VisualVariableLegendOptions")],OL);const Nye=OL,SU=new mr({colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation",sizeInfo:"size"});let xd=class extends ve{constructor(e){super(e),this.index=null,this.type=null,this.field=null,this.valueExpression=null,this.valueExpressionTitle=null,this.legendOptions=null}castField(e){return e==null?e:typeof e=="function"?(se.getLogger(this.declaredClass).error(".field: field must be a string value"),null):WO(e)}get arcadeRequired(){return!!this.valueExpression}clone(){}getAttributeHash(){return`${this.type}-${this.field}-${this.valueExpression}`}};u([d()],xd.prototype,"index",void 0),u([d({type:SU.apiValues,readOnly:!0,json:{read:SU.read,write:SU.write}})],xd.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],xd.prototype,"field",void 0),u([cr("field")],xd.prototype,"castField",null),u([d({type:String,json:{write:!0}})],xd.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],xd.prototype,"valueExpressionTitle",void 0),u([d({readOnly:!0})],xd.prototype,"arcadeRequired",null),u([d({type:Nye,json:{write:!0}})],xd.prototype,"legendOptions",void 0),xd=u([I("esri.renderers.visualVariables.VisualVariable")],xd);const yM=xd;var Qz;let F1=Qz=class extends yM{constructor(t){super(t),this.type="color",this.normalizationField=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null}}set stops(t){t&&Array.isArray(t)&&(t=t.filter(e=>!!e)).sort((e,r)=>e.value-r.value),this._set("stops",t)}clone(){return new Qz({field:this.field,normalizationField:this.normalizationField,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,stops:this.stops&&this.stops.map(t=>t.clone()),legendOptions:this.legendOptions&&this.legendOptions.clone()})}getAttributeHash(){return`${super.getAttributeHash()}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(t=>t.value||0)}};u([d({readOnly:!0})],F1.prototype,"cache",null),u([d({type:["color"],json:{type:["colorInfo"]}})],F1.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],F1.prototype,"normalizationField",void 0),u([d({type:[V6e],json:{write:!0}})],F1.prototype,"stops",null),F1=Qz=u([I("esri.renderers.visualVariables.ColorVariable")],F1);const Fye=F1;var e7;let M0=e7=class extends ve{constructor(t){super(t),this.label=null,this.opacity=null,this.value=null}readOpacity(t,e){return kR(e.transparency)}writeOpacity(t,e,r){e[r]=f4(t)}clone(){return new e7({label:this.label,opacity:this.opacity,value:this.value})}};u([d({type:String,json:{write:!0}})],M0.prototype,"label",void 0),u([d({type:Number,json:{type:Gi,write:{target:"transparency"}}})],M0.prototype,"opacity",void 0),u([Fe("opacity",["transparency"])],M0.prototype,"readOpacity",null),u([He("opacity")],M0.prototype,"writeOpacity",null),u([d({type:Number,json:{write:!0}})],M0.prototype,"value",void 0),M0=e7=u([I("esri.renderers.visualVariables.support.OpacityStop")],M0);const B9e=M0;var t7;let U1=t7=class extends yM{constructor(t){super(t),this.type="opacity",this.normalizationField=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null}}set stops(t){t&&Array.isArray(t)&&(t=t.filter(e=>!!e)).sort((e,r)=>e.value-r.value),this._set("stops",t)}clone(){return new t7({field:this.field,normalizationField:this.normalizationField,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,stops:this.stops&&this.stops.map(t=>t.clone()),legendOptions:this.legendOptions&&this.legendOptions.clone()})}getAttributeHash(){return`${super.getAttributeHash()}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(t=>t.value||0)}};u([d({readOnly:!0})],U1.prototype,"cache",null),u([d({type:["opacity"],json:{type:["transparencyInfo"]}})],U1.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],U1.prototype,"normalizationField",void 0),u([d({type:[B9e],json:{write:!0}})],U1.prototype,"stops",null),U1=t7=u([I("esri.renderers.visualVariables.OpacityVariable")],U1);const Uye=U1;var r7;let sg=r7=class extends yM{constructor(t){super(t),this.axis=null,this.type="rotation",this.rotationType="geographic",this.valueExpressionTitle=null}get cache(){return{hasExpression:!!this.valueExpression,compiledFunc:null}}writeValueExpressionTitleWebScene(t,e,r,i){if(i&&i.messages){const s=`visualVariables[${this.index}]`;i.messages.push(new q("property:unsupported",this.type+"VisualVariable.valueExpressionTitle is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:s+".valueExpressionTitle",context:i}))}}clone(){return new r7({axis:this.axis,rotationType:this.rotationType,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,legendOptions:this.legendOptions&&this.legendOptions.clone()})}};u([d({readOnly:!0})],sg.prototype,"cache",null),u([d({type:["heading","tilt","roll"],json:{origins:{"web-scene":{default:"heading",write:!0}}}})],sg.prototype,"axis",void 0),u([d({type:["rotation"],json:{type:["rotationInfo"]}})],sg.prototype,"type",void 0),u([d({type:["geographic","arithmetic"],json:{write:!0,origins:{"web-document":{write:!0,default:"geographic"}}}})],sg.prototype,"rotationType",void 0),u([d({type:String,json:{write:!0}})],sg.prototype,"valueExpressionTitle",void 0),u([He("web-scene","valueExpressionTitle")],sg.prototype,"writeValueExpressionTitleWebScene",null),sg=r7=u([I("esri.renderers.visualVariables.RotationVariable")],sg);const kye=sg;var i7;let NT=i7=class extends ve{constructor(t){super(t),this.label=null,this.size=null,this.value=null}clone(){return new i7({label:this.label,size:this.size,value:this.value})}};u([d({type:String,json:{write:!0}})],NT.prototype,"label",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],NT.prototype,"size",void 0),u([d({type:Number,json:{write:!0}})],NT.prototype,"value",void 0),NT=i7=u([I("esri.renderers.visualVariables.support.SizeStop")],NT);const FT=NT;var s7;let ML=s7=class extends Nye{constructor(){super(...arguments),this.customValues=null}clone(){return new s7({title:this.title,showLegend:this.showLegend,customValues:this.customValues&&this.customValues.slice(0)})}};u([d({type:[Number],json:{write:!0}})],ML.prototype,"customValues",void 0),ML=s7=u([I("esri.renderers.visualVariables.support.SizeVariableLegendOptions")],ML);const z9e=ML;var kg,To;function C_(t){return t&&t.declaredClass==="esri.renderers.visualVariables.SizeVariable"}function sO(t){return t!=null&&!isNaN(t)&&isFinite(t)}function Vye(t){return t.valueExpression?kg.Expression:t.field&&typeof t.field=="string"?kg.Field:kg.Unknown}function G9e(t,e){const r=e||Vye(t),i=t.valueUnit||"unknown";return r===kg.Unknown?To.Constant:t.stops?To.Stops:t.minSize!=null&&t.maxSize!=null&&t.minDataValue!=null&&t.maxDataValue!=null?To.ClampedLinear:i==="unknown"?t.minSize!=null&&t.minDataValue!=null?t.minSize&&t.minDataValue?To.Proportional:To.Additive:To.Identity:To.RealWorldSize}(function(t){t.Unknown="unknown",t.Expression="expression",t.Field="field"})(kg||(kg={})),function(t){t.Unknown="unknown",t.Stops="stops",t.ClampedLinear="clamped-linear",t.Proportional="proportional",t.Additive="additive",t.Constant="constant",t.Identity="identity",t.RealWorldSize="real-world-size"}(To||(To={}));const GS={inches:gn(1,"meters","inches"),feet:gn(1,"meters","feet"),"us-feet":gn(1,"meters","us-feet"),yards:gn(1,"meters","yards"),miles:gn(1,"meters","miles"),"nautical-miles":gn(1,"meters","nautical-miles"),millimeters:gn(1,"meters","millimeters"),centimeters:gn(1,"meters","centimeters"),decimeters:gn(1,"meters","decimeters"),meters:gn(1,"meters","meters"),kilometers:gn(1,"meters","kilometers"),"decimal-degrees":1/dOe(1,"meters",wr.radius)},ev=se.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),kee=new Io,PL=Math.PI,Bye=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;function zye(t,e,r){const i="visualVariables"in t&&t.visualVariables?t.visualVariables.find(y=>y.type==="color"):t;if(!i)return;if(i.declaredClass!=="esri.renderers.visualVariables.ColorVariable")return void ev.warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable");const s=typeof e=="number",n=s?null:e,o=n&&n.attributes;let a=s?e:null;const l=i.field,{ipData:c,hasExpression:h}=i.cache;let p=i.cache.compiledFunc;if(!l&&!h){const y=i.stops;return y&&y[0]&&y[0].color}if(typeof a!="number")if(h){if(C(r)||C(r.arcade))return void ev.error("Use of arcade expressions requires an arcade context");const y={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},_=r.arcade.arcadeUtils,b=_.getViewInfo(y),x=_.createExecContext(n,b);if(!p){const T=_.createSyntaxTree(i.valueExpression);p=_.createFunction(T),i.cache.compiledFunc=p}a=_.executeFunction(p,x)}else o&&(a=o[l]);const f=i.normalizationField,m=o!=null&&f!=null?parseFloat(o[f]):void 0;if(a!=null&&(!f||s||!isNaN(m)&&m!==0)){isNaN(m)||s||(a/=m);const y=vX(a,c);if(y){const _=y[0],b=y[1],x=_===b?i.stops[_].color:Ze.blendColors(i.stops[_].color,i.stops[b].color,y[2],v(r)?r.color:void 0);return new Ze(x)}}}function Gye(t,e,r){const i="visualVariables"in t&&t.visualVariables?t.visualVariables.find(y=>y.type==="opacity"):t;if(!i)return;if(i.declaredClass!=="esri.renderers.visualVariables.OpacityVariable")return void ev.warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable");const s=typeof e=="number",n=s?null:e,o=n&&n.attributes;let a=s?e:null;const l=i.field,{ipData:c,hasExpression:h}=i.cache;let p=i.cache.compiledFunc;if(!l&&!h){const y=i.stops;return y&&y[0]&&y[0].opacity}if(typeof a!="number")if(h){if(C(r)||C(r.arcade))return void ev.error("Use of arcade expressions requires an arcade context");const y={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},_=r.arcade.arcadeUtils,b=_.getViewInfo(y),x=_.createExecContext(n,b);if(!p){const T=_.createSyntaxTree(i.valueExpression);p=_.createFunction(T),i.cache.compiledFunc=p}a=_.executeFunction(p,x)}else o&&(a=o[l]);const f=i.normalizationField,m=o!=null&&f!=null?parseFloat(o[f]):void 0;if(a!=null&&(!f||s||!isNaN(m)&&m!==0)){isNaN(m)||s||(a/=m);const y=vX(a,c);if(y){const _=y[0],b=y[1];if(_===b)return i.stops[_].opacity;{const x=i.stops[_].opacity;return x+(i.stops[b].opacity-x)*y[2]}}}}function jye(t,e,r){const i="visualVariables"in t&&t.visualVariables?t.visualVariables.find(m=>m.type==="rotation"):t;if(!i)return;if(i.declaredClass!=="esri.renderers.visualVariables.RotationVariable")return void ev.warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable");const s=i.axis||"heading",n=s==="heading"&&i.rotationType==="arithmetic"?90:0,o=s==="heading"&&i.rotationType==="arithmetic"?-1:1,a=typeof e=="number"?null:e,l=a&&a.attributes,c=i.field,{hasExpression:h}=i.cache;let p=i.cache.compiledFunc,f=0;if(!c&&!h)return f;if(h){if(C(r)||C(r.arcade))return void ev.error("Use of arcade expressions requires an arcade context");const m={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},y=r.arcade.arcadeUtils,_=y.getViewInfo(m),b=y.createExecContext(a,_);if(!p){const x=y.createSyntaxTree(i.valueExpression);p=y.createFunction(x),i.cache.compiledFunc=p}f=y.executeFunction(p,b)}else l&&(f=l[c]||0);return f=typeof f!="number"||isNaN(f)?null:n+o*f,f}function j9e(t,e,r){const i=typeof e=="number",s=i?null:e,n=s&&s.attributes;let o=i?e:null;const{isScaleDriven:a}=t.cache;let l=t.cache.compiledFunc;if(a){const h=v(r)?r.scale:void 0,p=v(r)?r.view:void 0;o=h==null||p==="3d"?H9e(t):h}else if(!i)switch(t.inputValueType){case kg.Expression:{if(C(r)||C(r.arcade))return void ev.error("Use of arcade expressions requires an arcade context");const h={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},p=r.arcade.arcadeUtils,f=p.getViewInfo(h),m=p.createExecContext(s,f);if(!l){const y=p.createSyntaxTree(t.valueExpression);l=p.createFunction(y),t.cache.compiledFunc=l}o=p.executeFunction(l,m);break}case kg.Field:n&&(o=n[t.field]);break;case kg.Unknown:o=null}if(!sO(o))return null;if(i||!t.normalizationField)return o;const c=n?parseFloat(n[t.normalizationField]):null;return sO(c)&&c!==0?o/c:null}function H9e(t){let e=null,r=null;const i=t.stops;return i?(e=i[0].value,r=i[i.length-1].value):(e=t.minDataValue||0,r=t.maxDataValue||0),(e+r)/2}function r5(t,e,r){const i="visualVariables"in t&&t.visualVariables?t.visualVariables.find(n=>n.type==="size"):t;if(!i)return;if(i.declaredClass!=="esri.renderers.visualVariables.SizeVariable")return void ev.warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable");const s=qye(j9e(i,e,r),i,e,r,i.cache.ipData);return s==null||isNaN(s)?0:s}function Ic(t,e,r){return t==null?null:C_(t)?r5(t,e,r):sO(t)?t:null}function Hye(t,e,r){return sO(r)&&t>r?r:sO(e)&&t<e?e:t}function q9e(t,e,r,i){return t+((Ic(e.minSize,r,i)||e.minDataValue)??0)}function W9e(t,e,r){const i=t.stops;let s=i&&i.length&&i[0].size;return s==null&&(s=t.minSize),Ic(s,e,r)}function X9e(t,e,r,i){const s=(t-e.minDataValue)/(e.maxDataValue-e.minDataValue),n=Ic(e.minSize,r,i),o=Ic(e.maxSize,r,i),a=v(i)?i.shape:void 0;if(t<=e.minDataValue)return n;if(t>=e.maxDataValue)return o;if(n==null||o==null)return null;if(e.scaleBy==="area"&&a){const l=a==="circle",c=l?PL*(n/2)**2:n*n,h=c+s*((l?PL*(o/2)**2:o*o)-c);return l?2*Math.sqrt(h/PL):Math.sqrt(h)}return n+s*(o-n)}function Y9e(t,e,r,i){const s=v(i)?i.shape:void 0,n=t/e.minDataValue,o=Ic(e.minSize,r,i),a=Ic(e.maxSize,r,i);let l=null;return l=s==="circle"?2*Math.sqrt(n*(o/2)**2):s==="square"||s==="diamond"||s==="image"?Math.sqrt(n*o**2):n*o,Hye(l,o,a)}function Z9e(t,e,r,i,s){var l,c,h;const[n,o,a]=vX(t,s);if(n===o)return Ic((l=e.stops)==null?void 0:l[n].size,r,i);{const p=Ic((c=e.stops)==null?void 0:c[n].size,r,i);return p+(Ic((h=e.stops)==null?void 0:h[o].size,r,i)-p)*a}}function J9e(t,e,r,i){const s=(v(i)&&i.resolution?i.resolution:1)*GS[e.valueUnit],n=Ic(e.minSize,r,i),o=Ic(e.maxSize,r,i),{valueRepresentation:a}=e;let l=null;return l=a==="area"?2*Math.sqrt(t/PL)/s:a==="radius"||a==="distance"?2*t/s:t/s,Hye(l,n,o)}function qye(t,e,r,i,s){switch(e.transformationType){case To.Additive:return q9e(t,e,r,i);case To.Constant:return W9e(e,r,i);case To.ClampedLinear:return X9e(t,e,r,i);case To.Proportional:return Y9e(t,e,r,i);case To.Stops:return Z9e(t,e,r,i,s);case To.RealWorldSize:return J9e(t,e,r,i);case To.Identity:return t;case To.Unknown:return null}}function K9e(t,e,r){const{isScaleDriven:i}=t.cache;if(!(i&&r==="3d"||e))return null;const s={scale:e,view:r};let n=Ic(t.minSize,kee,s),o=Ic(t.maxSize,kee,s);if(n!=null||o!=null){if(n>o){const a=o;o=n,n=a}return{minSize:n,maxSize:o}}}function _X(t,e,r){if(!t.visualVariables)return;const i=[],s=[],n=[],o=[],a=[];for(const l of t.visualVariables)switch(l.type){case"color":s.push(l);break;case"opacity":n.push(l);break;case"rotation":a.push(l);break;case"size":o.push(l)}return s.forEach(l=>{const c=zye(l,e,r);i.push({variable:l,value:c})}),n.forEach(l=>{const c=Gye(l,e,r);i.push({variable:l,value:c})}),a.forEach(l=>{const c=jye(l,e,r);i.push({variable:l,value:c})}),o.forEach(l=>{const c=r5(l,e,r);i.push({variable:l,value:c})}),i.filter(l=>l.value!=null)}function vX(t,e){if(!e)return;let r=0,i=e.length-1;return e.some((s,n)=>t<s?(i=n,!0):(r=n,!1)),[r,i,(t-e[r])/(e[i]-e[r])]}function Q9e(t,e,r){const i=["proportional","proportional","proportional"];for(const s of t){const n=s.useSymbolValue?"symbol-value":r5(s,e,r);switch(s.axis){case"width":i[0]=n;break;case"depth":i[1]=n;break;case"height":i[2]=n;break;case"width-and-depth":i[0]=n,i[1]=n;break;case"all":case void 0:case null:i[0]=n,i[1]=n,i[2]=n;break;default:s.axis}}return i}const bX=Object.freeze(Object.defineProperty({__proto__:null,getAllSizes:Q9e,getColor:zye,getOpacity:Gye,getRotationAngle:jye,getSize:r5,getSizeForValue:qye,getSizeFromNumberOrVariable:Ic,getSizeRangeAtScale:K9e,getVisualVariableValues:_X,viewScaleRE:Bye},Symbol.toStringTag,{value:"Module"}));var n7;const AP=new mr({width:"width",depth:"depth",height:"height",widthAndDepth:"width-and-depth",all:"all"}),o7=new mr({unknown:"unknown",inch:"inches",foot:"feet",yard:"yards",mile:"miles","nautical-mile":"nautical-miles",millimeter:"millimeters",centimeter:"centimeters",decimeter:"decimeters",meter:"meters",kilometer:"kilometers","decimal-degree":"decimal-degrees"});function Vee(t){if(t!=null)return typeof t=="string"||typeof t=="number"?hi(t):t.type==="size"?C_(t)?t:(delete(t={...t}).type,new yi(t)):void 0}function Bee(t,e,r){if(typeof t!="object")return t;const i=new yi;return i.read(t,r),i}let yi=n7=class extends yM{constructor(t){super(t),this.axis=null,this.legendOptions=null,this.normalizationField=null,this.scaleBy=null,this.target=null,this.type="size",this.useSymbolValue=null,this.valueExpression=null,this.valueRepresentation=null,this.valueUnit=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null,isScaleDriven:this.valueExpression!=null&&Bye.test(this.valueExpression)}}set expression(t){se.getLogger(this.declaredClass).warn("'expression' is deprecated since version 4.2. Use 'valueExpression' instead. The only supported expression is 'view.scale'."),t==="view.scale"?(this.valueExpression="$view.scale",this._set("expression",t)):this._set("expression",null)}set index(t){C_(this.maxSize)&&(this.maxSize.index=`visualVariables[${t}].maxSize`),C_(this.minSize)&&(this.minSize.index=`visualVariables[${t}].minSize`),this._set("index",t)}get inputValueType(){return Vye(this)}set maxDataValue(t){t&&this.stops&&(se.getLogger(this.declaredClass).warn("cannot set maxDataValue when stops is not null."),t=null),this._set("maxDataValue",t)}set maxSize(t){t&&this.stops&&(se.getLogger(this.declaredClass).warn("cannot set maxSize when stops is not null."),t=null),this._set("maxSize",t)}castMaxSize(t){return Vee(t)}readMaxSize(t,e,r){return Bee(t,e,r)}set minDataValue(t){t&&this.stops&&(se.getLogger(this.declaredClass).warn("cannot set minDataValue when stops is not null."),t=null),this._set("minDataValue",t)}set minSize(t){t&&this.stops&&(se.getLogger(this.declaredClass).warn("cannot set minSize when stops is not null."),t=null),this._set("minSize",t)}castMinSize(t){return Vee(t)}readMinSize(t,e,r){return Bee(t,e,r)}get arcadeRequired(){return!!this.valueExpression||this.minSize!=null&&typeof this.minSize=="object"&&this.minSize.arcadeRequired||this.maxSize!=null&&typeof this.maxSize=="object"&&this.maxSize.arcadeRequired}set stops(t){this.minDataValue==null&&this.maxDataValue==null&&this.minSize==null&&this.maxSize==null?t&&Array.isArray(t)&&(t=t.filter(e=>!!e)).sort((e,r)=>e.value-r.value):t&&(se.getLogger(this.declaredClass).warn("cannot set stops when one of minDataValue, maxDataValue, minSize or maxSize is not null."),t=null),this._set("stops",t)}get transformationType(){return G9e(this,this.inputValueType)}readValueExpression(t,e){return t||e.expression&&"$view.scale"}writeValueExpressionWebScene(t,e,r,i){if(t==="$view.scale"){if(i&&i.messages){const s=this.index,n=typeof s=="string"?s:`visualVariables[${s}]`;i.messages.push(new q("property:unsupported",this.type+"VisualVariable.valueExpression = '$view.scale' is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:n+".valueExpression",context:i}))}}else e[r]=t}readValueUnit(t){return t?o7.read(t):null}clone(){return new n7({axis:this.axis,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,maxDataValue:this.maxDataValue,maxSize:C_(this.maxSize)?this.maxSize.clone():this.maxSize,minDataValue:this.minDataValue,minSize:C_(this.minSize)?this.minSize.clone():this.minSize,normalizationField:this.normalizationField,stops:this.stops&&this.stops.map(t=>t.clone()),target:this.target,useSymbolValue:this.useSymbolValue,valueRepresentation:this.valueRepresentation,valueUnit:this.valueUnit,legendOptions:this.legendOptions&&this.legendOptions.clone()})}flipSizes(){if(this.transformationType===To.ClampedLinear){const{minSize:t,maxSize:e}=this;return this.minSize=e,this.maxSize=t,this}if(this.transformationType===To.Stops){const t=this.stops;if(!t)return this;const e=t.map(i=>i.size).reverse(),r=t.length;for(let i=0;i<r;i++)t[i].size=e[i];return this}return this}getAttributeHash(){return`${super.getAttributeHash()}-${this.target}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(t=>t.value||0)}};u([d({readOnly:!0})],yi.prototype,"cache",null),u([d({type:AP.apiValues,json:{type:AP.jsonValues,origins:{"web-map":{read:!1}},read:AP.read,write:AP.write}})],yi.prototype,"axis",void 0),u([d({type:String,value:null,json:{read:!1}})],yi.prototype,"expression",null),u([d()],yi.prototype,"index",null),u([d({type:String,readOnly:!0})],yi.prototype,"inputValueType",null),u([d({type:z9e,json:{write:!0}})],yi.prototype,"legendOptions",void 0),u([d({type:Number,value:null,json:{write:!0}})],yi.prototype,"maxDataValue",null),u([d({type:Number,value:null,json:{write:!0}})],yi.prototype,"maxSize",null),u([cr("maxSize")],yi.prototype,"castMaxSize",null),u([Fe("maxSize")],yi.prototype,"readMaxSize",null),u([d({type:Number,value:null,json:{write:!0}})],yi.prototype,"minDataValue",null),u([d({type:Number,value:null,json:{write:!0}})],yi.prototype,"minSize",null),u([cr("minSize")],yi.prototype,"castMinSize",null),u([Fe("minSize")],yi.prototype,"readMinSize",null),u([d({type:String,json:{write:!0}})],yi.prototype,"normalizationField",void 0),u([d({readOnly:!0})],yi.prototype,"arcadeRequired",null),u([d({type:String})],yi.prototype,"scaleBy",void 0),u([d({type:[FT],value:null,json:{write:!0}})],yi.prototype,"stops",null),u([d({type:["outline"],json:{write:!0}})],yi.prototype,"target",void 0),u([d({type:String,readOnly:!0})],yi.prototype,"transformationType",null),u([d({type:["size"],json:{type:["sizeInfo"]}})],yi.prototype,"type",void 0),u([d({type:Boolean,json:{write:!0,origins:{"web-map":{read:!1}}}})],yi.prototype,"useSymbolValue",void 0),u([d({type:String,json:{write:!0}})],yi.prototype,"valueExpression",void 0),u([Fe("valueExpression",["valueExpression","expression"])],yi.prototype,"readValueExpression",null),u([He("web-scene","valueExpression")],yi.prototype,"writeValueExpressionWebScene",null),u([d({type:["radius","diameter","area","width","distance"],json:{write:!0}})],yi.prototype,"valueRepresentation",void 0),u([d({type:o7.apiValues,json:{write:o7.write,origins:{"web-map":{read:!1},"web-scene":{write:!0},"portal-item":{write:!0}}}})],yi.prototype,"valueUnit",void 0),u([Fe("valueUnit")],yi.prototype,"readValueUnit",null),yi=n7=u([I("esri.renderers.visualVariables.SizeVariable")],yi);const i5=yi,eke={color:Fye,size:i5,opacity:Uye,rotation:kye},tke=new mr({colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation",sizeInfo:"size"}),rke=/^\[([^\]]+)\]$/i;let IL=class extends Te{constructor(){super(...arguments),this.colorVariables=null,this.opacityVariables=null,this.rotationVariables=null,this.sizeVariables=null}set visualVariables(e){if(this._resetVariables(),(e=e&&e.filter(r=>!!r))&&e.length){for(const r of e)switch(r.type){case"color":this.colorVariables.push(r);break;case"opacity":this.opacityVariables.push(r);break;case"rotation":this.rotationVariables.push(r);break;case"size":this.sizeVariables.push(r)}this.sizeVariables.length&&this.sizeVariables.some(r=>!!r.target)&&e.sort((r,i)=>{let s=null;return s=r.target===i.target?0:r.target?1:-1,s});for(let r=0;r<e.length;r++)e[r].index=r;this._set("visualVariables",e)}else this._set("visualVariables",e)}readVariables(e,r,i){const{rotationExpression:s,rotationType:n}=r,o=s&&s.match(rke),a=o&&o[1];if(a&&(e||(e=[]),e.push({type:"rotationInfo",rotationType:n,field:a})),e)return e.map(l=>{const c=tke.read(l.type),h=eke[c];h||(se.getLogger(this.declaredClass).warn(`Unknown variable type: ${c}`),i&&i.messages&&i.messages.push(new rm("visual-variable:unsupported",`visualVariable of type '${c}' is not supported`,{definition:l,context:i})));const p=new h;return p.read(l,i),p})}writeVariables(e,r){const i=[];for(const s of e){const n=s.toJSON(r);n&&i.push(n)}return i}_resetVariables(){this.colorVariables=[],this.opacityVariables=[],this.rotationVariables=[],this.sizeVariables=[]}};u([d()],IL.prototype,"visualVariables",null),IL=u([I("esri.renderers.visualVariables.VisualVariableFactory")],IL);const ike=IL,ske={base:yM,key:"type",typeMap:{opacity:Uye,color:Fye,rotation:kye,size:i5}},PE=t=>{let e=class extends t{constructor(){super(...arguments),this._vvFactory=new ike}set visualVariables(r){this._vvFactory.visualVariables=r,this._set("visualVariables",this._vvFactory.visualVariables)}readVisualVariables(r,i,s){return this._vvFactory.readVariables(r,i,s)}writeVisualVariables(r,i,s,n){i[s]=this._vvFactory.writeVariables(r,n)}get arcadeRequiredForVisualVariables(){if(!this.visualVariables)return!1;for(const r of this.visualVariables)if(r.arcadeRequired)return!0;return!1}hasVisualVariables(r,i){return r?this.getVisualVariablesForType(r,i).length>0:this.getVisualVariablesForType("size",i).length>0||this.getVisualVariablesForType("color",i).length>0||this.getVisualVariablesForType("opacity",i).length>0||this.getVisualVariablesForType("rotation",i).length>0}getVisualVariablesForType(r,i){const s=this.visualVariables;return s?s.filter(n=>n.type===r&&(typeof i=="string"?n.target===i:i!==!1||!n.target)):[]}async collectVVRequiredFields(r,i){let s=[];this.visualVariables&&(s=s.concat(this.visualVariables));for(const n of s)n&&(n.field&&Ru(r,i,n.field),n.normalizationField&&Ru(r,i,n.normalizationField),n.valueExpression&&(nke(n.valueExpression,r,i)||await Hl(r,i,n.valueExpression)))}};return u([d({types:[ske],value:null,json:{write:!0}})],e.prototype,"visualVariables",null),u([Fe("visualVariables",["visualVariables","rotationType","rotationExpression"])],e.prototype,"readVisualVariables",null),u([He("visualVariables")],e.prototype,"writeVisualVariables",null),e=u([I("esri.renderers.mixins.VisualVariablesMixin")],e),e};function nke(t,e,r){const i=k9e(t);return!!v(i)&&(Ru(e,r,i),!0)}const pC={retainId:!1,ignoreDrivers:!1,hasLabelingContext:!0};function oke(t,e=pC){var a,l;if(!t)return{symbol:null};const{retainId:r=pC.retainId,ignoreDrivers:i=pC.ignoreDrivers,hasLabelingContext:s=pC.hasLabelingContext,retainCIM:n=pC.retainCIM}=e;let o=null;if($S(t)||t instanceof Xw)o=t.clone();else if(t.type==="cim"){const c=(l=(a=t.data)==null?void 0:a.symbol)==null?void 0:l.type;if(c!=="CIMPointSymbol")return{error:new q("symbol-conversion:unsupported-cim-symbol",`CIM symbol of type '${c||"unknown"}' is unsupported in 3D`,{symbol:t})};o=n?t.clone():v_.fromCIMSymbol(t)}else if(t instanceof Yh)o=C4.fromSimpleLineSymbol(t);else if(t instanceof yv)o=v_.fromSimpleMarkerSymbol(t);else if(t instanceof nM)o=v_.fromPictureMarkerSymbol(t);else if(t instanceof gv)o=e.geometryType&&e.geometryType==="mesh"?A4.fromSimpleFillSymbol(t):oM.fromSimpleFillSymbol(t);else{if(!(t instanceof SE))return{error:new q("symbol-conversion:unsupported-2d-symbol",`2D symbol of type '${t.type||t.declaredClass}' is unsupported in 3D`,{symbol:t})};o=s?E4.fromTextSymbol(t):v_.fromTextSymbol(t)}if(r&&o&&o.type!=="cim"&&(o.id=t.id),i&&$S(o))for(let c=0;c<o.symbolLayers.length;++c)o.symbolLayers.getItemAt(c)._ignoreDrivers=!0;return{symbol:o}}function FN(t,e,r,i){const s=Wye(t,{},{context:i,isLabelSymbol:!1});v(s)&&(e[r]=s)}function zee(t,e,r,i){const s=Wye(t,{},{context:i,isLabelSymbol:!0});v(s)&&(e[r]=s)}function Gee(t){return t instanceof TE||t instanceof Xw}function Wye(t,e,r){if(C(t))return null;const{context:i,isLabelSymbol:s}=r,n=i==null?void 0:i.origin,o=i==null?void 0:i.messages;if(n==="web-scene"&&!Gee(t)){const a=oke(t,{retainCIM:!0,hasLabelingContext:s});return v(a.symbol)?a.symbol.write(e,i):(o==null||o.push(new q("symbol:unsupported",`Symbols of type '${t.declaredClass}' are not supported in scenes. Use 3D symbology instead when working with WebScene and SceneView`,{symbol:t,context:i,error:a.error})),null)}return(n==="web-map"||n==="portal-item"&&!khe(i==null?void 0:i.layer))&&Gee(t)?(o==null||o.push(new q("symbol:unsupported",`Symbols of type '${t.declaredClass}' are not supported in web maps and portal items. Use 2D symbology and CIMSymbol instead when working with MapView`,{symbol:t,context:i})),null):t.write(e,i)}function B2t(t,e){return eLe(t,null,e)}const IE={types:O4,json:{write:{writer:FN},origins:{"web-scene":{types:HK,write:{writer:FN},read:{reader:dv({types:HK})}}}}},Xye={types:{base:Uc,key:"type",typeMap:{"simple-fill":Wb.typeMap["simple-fill"],"picture-fill":Wb.typeMap["picture-fill"],"polygon-3d":Wb.typeMap["polygon-3d"]}},json:{write:{writer:FN},origins:{"web-scene":{type:oM,write:{writer:FN}}}}},$L={cast:t=>t==null||typeof t=="string"||typeof t=="number"?t:`${t}`,json:{type:String,write:{writer:(t,e)=>{e.value=t==null?void 0:t.toString()}}}};var a7;let P0=a7=class extends ve{constructor(t){super(t),this.description=null,this.label=null,this.minValue=null,this.maxValue=0,this.symbol=null}clone(){return new a7({description:this.description,label:this.label,minValue:this.minValue,maxValue:this.maxValue,symbol:this.symbol?this.symbol.clone():null})}getMeshHash(){const t=JSON.stringify(this.symbol);return`${this.minValue}.${this.maxValue}.${t}`}};u([d({type:String,json:{write:!0}})],P0.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],P0.prototype,"label",void 0),u([d({type:Number,json:{read:{source:"classMinValue"},write:{target:"classMinValue"}}})],P0.prototype,"minValue",void 0),u([d({type:Number,json:{read:{source:"classMaxValue"},write:{target:"classMaxValue"}}})],P0.prototype,"maxValue",void 0),u([d(IE)],P0.prototype,"symbol",void 0),P0=a7=u([I("esri.renderers.support.ClassBreakInfo")],P0);const UN=P0;var l7;const Yye="log",LL="percent-of-total",DL="field",RP=new mr({esriNormalizeByLog:Yye,esriNormalizeByPercentOfTotal:LL,esriNormalizeByField:DL}),ake=us(UN);let Gn=l7=class extends PE(hy){constructor(t){super(t),this._compiledValueExpression={valueExpression:null,compiledFunction:null},this.backgroundFillSymbol=null,this.classBreakInfos=null,this.defaultLabel=null,this.defaultSymbol=null,this.field=null,this.isMaxInclusive=!0,this.legendOptions=null,this.normalizationField=null,this.normalizationTotal=null,this.type="class-breaks",this.valueExpression=null,this.valueExpressionTitle=null,this._set("classBreakInfos",[])}readClassBreakInfos(t,e,r){if(!Array.isArray(t))return;let i=e.minValue;return t.map(s=>{const n=new UN;return n.read(s,r),n.minValue==null&&(n.minValue=i),n.maxValue==null&&(n.maxValue=n.minValue),i=n.maxValue,n})}writeClassBreakInfos(t,e,r,i){const s=t.map(n=>n.write({},i));this._areClassBreaksConsecutive()&&s.forEach(n=>delete n.classMinValue),e[r]=s}castField(t){return t==null?t:typeof t=="function"?(se.getLogger(this.declaredClass).error(".field: field must be a string value"),null):WO(t)}get minValue(){return this.classBreakInfos&&this.classBreakInfos[0]&&this.classBreakInfos[0].minValue||0}get normalizationType(){let t=this._get("normalizationType");const e=!!this.normalizationField,r=this.normalizationTotal!=null;return e||r?(t=e&&DL||r&&LL||null,e&&r&&se.getLogger(this.declaredClass).warn("warning: both normalizationField and normalizationTotal are set!")):t!==DL&&t!==LL||(t=null),t}set normalizationType(t){this._set("normalizationType",t)}addClassBreakInfo(t,e,r){let i=null;i=typeof t=="number"?new UN({minValue:t,maxValue:e,symbol:Gpe(r)}):ake(ne(t)),this.classBreakInfos.push(i),this.classBreakInfos.length===1&&this.notifyChange("minValue")}removeClassBreakInfo(t,e){const r=this.classBreakInfos.length;for(let i=0;i<r;i++){const s=[this.classBreakInfos[i].minValue,this.classBreakInfos[i].maxValue];if(s[0]===t&&s[1]===e){this.classBreakInfos.splice(i,1);break}}}getBreakIndex(t,e){return this.valueExpression&&(C(e)||C(e.arcade))&&se.getLogger(this.declaredClass).warn(""),this.valueExpression?this._getBreakIndexForExpression(t,e):this._getBreakIndexForField(t)}async getClassBreakInfo(t,e){let r=e;this.valueExpression&&(C(e)||C(e.arcade))&&(r={...r,arcade:await sm()});const i=this.getBreakIndex(t,r);return i!==-1?this.classBreakInfos[i]:null}getSymbol(t,e){if(this.valueExpression&&(C(e)||C(e.arcade)))return void se.getLogger(this.declaredClass).error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const r=this.getBreakIndex(t,e);return r>-1?this.classBreakInfos[r].symbol:this.defaultSymbol}async getSymbolAsync(t,e){let r=e;if(this.valueExpression&&(C(e)||C(e.arcade))){const s=await sm(),{arcadeUtils:n}=s;n.hasGeometryOperations(this.valueExpression)&&await n.enableGeometryOperations(),r={...r,arcade:s}}const i=this.getBreakIndex(t,r);return i>-1?this.classBreakInfos[i].symbol:this.defaultSymbol}getSymbols(){const t=[];return this.classBreakInfos.forEach(e=>{e.symbol&&t.push(e.symbol)}),this.defaultSymbol&&t.push(this.defaultSymbol),t}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((t,e)=>t+e.getAttributeHash(),"")}getMeshHash(){const t=JSON.stringify(this.backgroundFillSymbol),e=JSON.stringify(this.defaultSymbol),r=`${this.normalizationField}.${this.normalizationType}.${this.normalizationTotal}`;return`${t}.${e}.${this.classBreakInfos.reduce((i,s)=>i+s.getMeshHash(),"")}.${r}.${this.field}.${this.valueExpression}`}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}clone(){return new l7({field:this.field,backgroundFillSymbol:this.backgroundFillSymbol&&this.backgroundFillSymbol.clone(),defaultLabel:this.defaultLabel,defaultSymbol:this.defaultSymbol&&this.defaultSymbol.clone(),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,classBreakInfos:ne(this.classBreakInfos),isMaxInclusive:this.isMaxInclusive,normalizationField:this.normalizationField,normalizationTotal:this.normalizationTotal,normalizationType:this.normalizationType,visualVariables:ne(this.visualVariables),legendOptions:ne(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}async collectRequiredFields(t,e){const r=[this.collectVVRequiredFields(t,e),this.collectSymbolFields(t,e)];await Promise.all(r)}async collectSymbolFields(t,e){const r=[...this.getSymbols().map(i=>i.collectRequiredFields(t,e)),Hl(t,e,this.valueExpression)];Ru(t,e,this.field),Ru(t,e,this.normalizationField),await Promise.all(r)}_getBreakIndexForExpression(t,e){const{viewingMode:r,scale:i,spatialReference:s,arcade:n}=It(e,{}),{valueExpression:o}=this;let a=this._compiledValueExpression.valueExpression===o?this._compiledValueExpression.compiledFunction:null;const l=n.arcadeUtils;if(!a){const h=l.createSyntaxTree(o);a=l.createFunction(h),this._compiledValueExpression.compiledFunction=a}this._compiledValueExpression.valueExpression=o;const c=l.executeFunction(a,l.createExecContext(t,l.getViewInfo({viewingMode:r,scale:i,spatialReference:s})));return this._getBreakIndexfromInfos(c)}_getBreakIndexForField(t){const e=this.field,r=t.attributes,i=this.normalizationType;let s=parseFloat(r[e]);if(i){const n=this.normalizationTotal,o=parseFloat(this.normalizationField?r[this.normalizationField]:void 0);if(i===Yye)s=Math.log(s)*Math.LOG10E;else if(i!==LL||n==null||isNaN(n)){if(i===DL&&!isNaN(o)){if(isNaN(s)||isNaN(o))return-1;s/=o}}else s=s/n*100}return this._getBreakIndexfromInfos(s)}_getBreakIndexfromInfos(t){const e=this.isMaxInclusive;if(t!=null&&typeof t=="number"&&!isNaN(t))for(let r=0;r<this.classBreakInfos.length;r++){const i=[this.classBreakInfos[r].minValue,this.classBreakInfos[r].maxValue];if(i[0]<=t&&(e?t<=i[1]:t<i[1]))return r}return-1}_areClassBreaksConsecutive(){const t=this.classBreakInfos,e=t.length;for(let r=1;r<e;r++)if(t[r-1].maxValue!==t[r].minValue)return!1;return!0}};u([d(Xye)],Gn.prototype,"backgroundFillSymbol",void 0),u([d({type:[UN]})],Gn.prototype,"classBreakInfos",void 0),u([Fe("classBreakInfos")],Gn.prototype,"readClassBreakInfos",null),u([He("classBreakInfos")],Gn.prototype,"writeClassBreakInfos",null),u([d({type:String,json:{write:!0}})],Gn.prototype,"defaultLabel",void 0),u([d(IE)],Gn.prototype,"defaultSymbol",void 0),u([d({type:String,json:{write:!0}})],Gn.prototype,"field",void 0),u([cr("field")],Gn.prototype,"castField",null),u([d({type:Boolean})],Gn.prototype,"isMaxInclusive",void 0),u([d({type:Z2,json:{write:!0}})],Gn.prototype,"legendOptions",void 0),u([d({type:Number,readOnly:!0,value:null,json:{read:!1,write:{overridePolicy(){return this.classBreakInfos.length!==0&&this._areClassBreaksConsecutive()?{enabled:!0}:{enabled:!1}}}}})],Gn.prototype,"minValue",null),u([d({type:String,json:{write:!0}})],Gn.prototype,"normalizationField",void 0),u([d({type:Number,cast:t=>bh(t),json:{write:!0}})],Gn.prototype,"normalizationTotal",void 0),u([d({type:RP.apiValues,value:null,json:{type:RP.jsonValues,read:RP.read,write:RP.write}})],Gn.prototype,"normalizationType",null),u([gt({classBreaks:"class-breaks"})],Gn.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Gn.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],Gn.prototype,"valueExpressionTitle",void 0),Gn=l7=u([I("esri.renderers.ClassBreaksRenderer")],Gn);const Zye=Gn;let lke=class{constructor(e,r){this._storage=new nX,this._storage.maxSize=e,r&&this._storage.registerRemoveFunc("",r)}put(e,r,i){this._storage.put(e,r,i,1)}pop(e){return this._storage.pop(e)}get(e){return this._storage.get(e)}clear(){this._storage.clearAll()}destroy(){this._storage.destroy()}get maxSize(){return this._storage.maxSize}set maxSize(e){this._storage.maxSize=e}};const jee="esri.renderers.support.DictionaryLoader",cke={type:"CIMSimpleLineCallout",lineSymbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",width:.5,color:[0,0,0,255]}]}};let wX=class{constructor(e,r,i){this.config=null,this.fieldMap=null,this.url=null,this._ongoingRequests=new Map,this._symbolCache=new lke(100),this._dictionaryPromise=null,this.url=e,this.config=r,this.fieldMap=i}getSymbolFields(){return this._symbolFields}async getSymbolAsync(e,r){let i;this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(r));try{i=await this._dictionaryPromise}catch(m){if(Qs(m))return this._dictionaryPromise=null,null}const s={};if(this.fieldMap)for(const m of this._symbolFields){const y=this.fieldMap[m];if(y&&e.attributes[y]!=null){const _=""+e.attributes[y];s[m]=_}else s[m]=""}const n=i==null?void 0:i(s,r);if(!n||typeof n!="string")return null;const o=qH(n).toString(),a=this._symbolCache.get(o);if(a)return a.catch(()=>{this._symbolCache.pop(o)}),a;const l=n.split(";"),c=[],h=[];for(const m of l)if(m)if(m.includes("po:")){const y=m.substr(3).split("|");if(y.length===3){const _=y[0],b=y[1];let x=y[2];if(b==="DashTemplate")x=x.split(" ").map(T=>Number(T));else if(b==="Color"){const T=new Ze(x).toRgba();x=[T[0],T[1],T[2],255*T[3]]}else x=Number(x);h.push({primitiveName:_,propertyName:b,value:x})}}else if(m.includes("|")){for(const y of m.split("|"))if(this._itemNames.has(y)){c.push(y);break}}else this._itemNames.has(m)&&c.push(m);const p=!v(e.geometry)||!e.geometry.hasZ&&e.geometry.type==="point",f=this._cimPartsToCIMSymbol(c,h,p,r);return this._symbolCache.put(o,f,1),f}async fetchResources(e){if(this._dictionaryPromise)return this._dictionaryPromise;if(!this.url)return void se.getLogger(jee).error("no valid URL!");const r=Ni(this.url+"/resources/styles/dictionary-info.json",{responseType:"json",query:{f:"json"},signal:v(e)?e.signal:null}),[{data:i}]=await Promise.all([r,sm()]);if(!i)throw this._dictionaryPromise=null,new q("esri.renderers.DictionaryRenderer","Bad dictionary data!");const s=i.expression,n=i.authoringInfo;this._refSymbolUrlTemplate=this.url+"/"+i.cimRefTemplateUrl,this._itemNames=new Set(i.itemsNames),this._symbolFields=n.symbol;const o={};if(this.config){const c=this.config;for(const h in c)o[h]=c[h]}if(n.configuration)for(const c of n.configuration)o.hasOwnProperty(c.name)||(o[c.name]=c.value);const a=[];if(v(e)&&e.fields&&this.fieldMap)for(const c of this._symbolFields){const h=this.fieldMap[c],p=e.fields.filter(f=>f.name===h);p.length>0&&a.push({...p[0],name:c})}const l=hIe(s,v(e)?e.spatialReference:null,a,o).then(c=>{const h={scale:0};return(p,f)=>{if(C(c))return null;const m=c.repurposeFeature({geometry:null,attributes:p});return h.scale=v(f)?f.scale??void 0:void 0,c.evaluate({$feature:m,$view:h})}}).catch(c=>(se.getLogger(jee).error("Creating dictinoary expression failed:",c),null));return this._dictionaryPromise=l,l}async _cimPartsToCIMSymbol(e,r,i,s){const n=new Array(e.length);for(let l=0;l<e.length;l++)n[l]=this._getSymbolPart(e[l],s);const o=await Promise.all(n),a=this.fieldMap;if(a)for(const l of o)Jye(l,a);return new wE({data:this._combineSymbolParts(o,r,i)})}async _getSymbolPart(e,r){if(this._ongoingRequests.has(e))return this._ongoingRequests.get(e).then(n=>n.data);const i=this._refSymbolUrlTemplate.replace(/\{itemName\}/gi,e),s=Ni(i,{responseType:"json",query:{f:"json"},...r});this._ongoingRequests.set(e,s);try{return(await s).data}catch(n){throw this._ongoingRequests.delete(e),n}}_combineSymbolParts(e,r,i){if(!e||e.length===0)return null;const s={...e[0]};if(e.length>1){s.symbolLayers=[];for(const n of e){const o=n;s.symbolLayers.unshift(...o.symbolLayers)}}return i&&(s.callout=cke),{type:"CIMSymbolReference",symbol:s,primitiveOverrides:r}}};function Jye(t,e){if(!t)return;const r=t.symbolLayers;if(!r)return;let i=r.length;for(;i--;){const s=r[i];s&&s.enable!==!1&&s.type==="CIMVectorMarker"&&uke(s,e)}}function uke(t,e){const r=t.markerGraphics;if(r)for(const i of r){if(!i)continue;const s=i.symbol;if(s)switch(s.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":Jye(s,e);break;case"CIMTextSymbol":s.fieldMap=e}}}const j2t=Object.freeze(Object.defineProperty({__proto__:null,DictionaryLoader:wX},Symbol.toStringTag,{value:"Module"}));var c7;let Td=c7=class extends PE(hy){constructor(t){super(t),this.config=null,this.fieldMap=null,this.scaleExpression=null,this.scaleExpressionTitle=null,this.url=null,this.type="dictionary"}get _loader(){return new wX(this.url,this.config,this.fieldMap)}writeData(t,e){t&&(e.scalingExpressionInfo={expression:t,returnType:"number"})}writeVisualVariables(t,e,r,i){i!=null&&i.origin||super.writeVisualVariables(t,e,r,i)}clone(){return new c7({config:ne(this.config),scaleExpression:this.scaleExpression,scaleExpressionTitle:this.scaleExpressionTitle,fieldMap:ne(this.fieldMap),url:ne(this.url),visualVariables:ne(this.visualVariables)})}async getSymbolAsync(t,e){return this._loader.getSymbolAsync(t,e)}async collectRequiredFields(t,e){await this.collectVVRequiredFields(t,e),this.scaleExpression&&await Hl(t,e,this.scaleExpression);for(const r in this.fieldMap){const i=this.fieldMap[r];e.has(i)&&t.add(i)}}get arcadeRequired(){return!0}getSymbol(){return null}getSymbols(){return[]}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((t,e)=>t+e.getAttributeHash(),"")}getMeshHash(){return`${this.url}-${JSON.stringify(this.fieldMap)}`}getSymbolFields(){return this._loader.getSymbolFields()}};u([d({type:wX})],Td.prototype,"_loader",null),u([d({type:Object,json:{read:{source:"configuration"},write:{target:"configuration"}}})],Td.prototype,"config",void 0),u([d({type:Object,json:{write:!0}})],Td.prototype,"fieldMap",void 0),u([d({type:String,json:{read:{source:"scalingExpressionInfo.expression"},write:!0}})],Td.prototype,"scaleExpression",void 0),u([He("scaleExpression")],Td.prototype,"writeData",null),u([d({type:String,json:{read:{source:"scalingExpressionInfo.title"},write:{target:"scalingExpressionInfo.title",overridePolicy(t){return{enabled:!!t&&!!this.scaleExpression}}}}})],Td.prototype,"scaleExpressionTitle",void 0),u([d({type:String,json:{write:!0}})],Td.prototype,"url",void 0),u([He("visualVariables")],Td.prototype,"writeVisualVariables",null),Td=c7=u([I("esri.renderers.DictionaryRenderer")],Td);const hke=Td;var u7;let ng=u7=class extends ve{constructor(t){super(t),this.color=null,this.field=null,this.label=null,this.valueExpression=null,this.valueExpressionTitle=null}castField(t){return t==null?t:typeof t=="function"?(se.getLogger(this.declaredClass).error(".field: field must be a string value"),null):WO(t)}getAttributeHash(){return`${this.field}-${this.valueExpression}`}clone(){return new u7({color:this.color&&this.color.clone(),field:this.field,label:this.label,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle})}};u([d({type:Ze,json:{type:[Number],write:!0}})],ng.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],ng.prototype,"field",void 0),u([cr("field")],ng.prototype,"castField",null),u([d({type:String,json:{write:!0}})],ng.prototype,"label",void 0),u([d({type:String,json:{write:!0}})],ng.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],ng.prototype,"valueExpressionTitle",void 0),ng=u7=u([I("esri.renderers.support.AttributeColorInfo")],ng);const Kye=ng;var h7;let NL=h7=class extends ve{constructor(){super(...arguments),this.unit=null}clone(){return new h7({unit:this.unit})}};u([d({type:String,json:{write:!0}})],NL.prototype,"unit",void 0),NL=h7=u([I("esri.renderers.support.DotDensityLegendOptions")],NL);const dke=NL;var d7;let lc=d7=class extends PE(hy){constructor(t){super(t),this.attributes=null,this.backgroundColor=new Ze([0,0,0,0]),this.dotBlendingEnabled=!0,this.dotShape="square",this.dotSize=1,this.legendOptions=null,this.outline=new Yh,this.dotValue=null,this.referenceScale=null,this.seed=1,this.type="dot-density"}calculateDotValue(t){if(this.referenceScale==null)return this.dotValue;const e=t/this.referenceScale*this.dotValue;return e<1?1:e}getSymbol(){return new gv({outline:this.outline})}async getSymbolAsync(){return this.getSymbol()}getSymbols(){return[this.getSymbol()]}getAttributeHash(){var t;return((t=this.attributes)==null?void 0:t.reduce((e,r)=>e+r.getAttributeHash(),""))??""}getMeshHash(){return JSON.stringify(this.outline)}clone(){return new d7({attributes:ne(this.attributes),backgroundColor:ne(this.backgroundColor),dotBlendingEnabled:ne(this.dotBlendingEnabled),dotShape:ne(this.dotShape),dotSize:ne(this.dotSize),dotValue:ne(this.dotValue),legendOptions:ne(this.legendOptions),outline:ne(this.outline),referenceScale:ne(this.referenceScale),visualVariables:ne(this.visualVariables),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}getControllerHash(){var e;return`${(e=this.attributes)==null?void 0:e.map(r=>r.field||r.valueExpression||"")}-${this.outline&&JSON.stringify(this.outline.toJSON())||""}`}async collectRequiredFields(t,e){await this.collectVVRequiredFields(t,e);for(const r of this.attributes??[])r.valueExpression&&await Hl(t,e,r.valueExpression),r.field&&t.add(r.field)}};u([d({type:[Kye],json:{write:!0}})],lc.prototype,"attributes",void 0),u([d({type:Ze,json:{write:!0}})],lc.prototype,"backgroundColor",void 0),u([d({type:Boolean,json:{write:!0}})],lc.prototype,"dotBlendingEnabled",void 0),u([d({type:String,json:{write:!1}})],lc.prototype,"dotShape",void 0),u([d({type:Number,json:{write:!0}})],lc.prototype,"dotSize",void 0),u([d({type:dke,json:{write:!0}})],lc.prototype,"legendOptions",void 0),u([d({type:Yh,json:{default:null,write:!0}})],lc.prototype,"outline",void 0),u([d({type:Number,json:{write:!0}})],lc.prototype,"dotValue",void 0),u([d({type:Number,json:{write:!0}})],lc.prototype,"referenceScale",void 0),u([d({type:Number,json:{write:!0}})],lc.prototype,"seed",void 0),u([gt({dotDensity:"dot-density"})],lc.prototype,"type",void 0),lc=d7=u([I("esri.renderers.DotDensityRenderer")],lc);const pke=lc;let UT=class extends bs(ve){constructor(){super(...arguments),this.minLabel=null,this.maxLabel=null,this.title=null}};u([d({type:String,json:{write:!0}})],UT.prototype,"minLabel",void 0),u([d({type:String,json:{write:!0}})],UT.prototype,"maxLabel",void 0),u([d({type:String,json:{write:!0}})],UT.prototype,"title",void 0),UT=u([I("esri.renderers.support.HeatmapLegendOptions")],UT);const xX=2.4;function fke(t){return Vh(t*xX)}function mke(t){return Ao(t)/xX}function gke(t,e,r,i){let{color:s,ratio:n}=e,{color:o,ratio:a}=r;a===n&&(a===1?n-=1e-6:a+=1e-6);const l=ge((i-n)/(a-n),0,1);p4(t,s.toArray(),o.toArray(),l)}function q2t(t){const r=new Uint8ClampedArray(2048);if(t=t.filter(({ratio:a})=>a>=0&&a<=1).sort((a,l)=>a.ratio-l.ratio).map(({color:a,ratio:l})=>({color:a,ratio:Math.max(l,.001)})),t.length<1)return r;let i=t[0],s=t[0],n=1;const o=sr();for(let a=0;a<512;a++){const l=(a+.5)/512;for(;l>s.ratio&&n<t.length;)i=s,s=t[n++];gke(o,i,s,l),r.set(o,4*a)}return r}function W2t(t,e,r,i){const{radius:s,fieldOffset:n,field:o}=e,a=Math.round(Ao(s)),l=new Float64Array(r*i);let c,h=Number.NEGATIVE_INFINITY;const p=_ke(o,n),f=new Set;for(const m of t){const y=m.getCursor();for(;y.next();){const _=y.getObjectId();if(f.has(_))continue;f.add(_);const b=y.readLegacyPointGeometry(),x=128;if(b.x<-x||b.x>=r+x||b.y<-x||b.y>i+x)continue;const T=+p(y),S=Math.max(0,Math.round(b.x)-a),E=Math.max(0,Math.round(b.y)-a),O=Math.min(i,Math.round(b.y)+a),R=Math.min(r,Math.round(b.x)+a);for(let L=E;L<O;L++)for(let P=S;P<R;P++){const U=L*r+P,B=yke(b.x-P,b.y-L,a);c=l[U]+=B*T,c>h&&(h=c)}}}return{matrix:l.buffer,max:h}}function yke(t,e,r){const i=Math.sqrt(t**2+e**2)/r;return i>1?0:3/(Math.PI*r**2)*(1-i**2)**2}function X2t(t,e){return typeof t=="function"?t:t?typeof e=="string"?r=>-1*+r[t]:r=>+r[t]+e:()=>1}function _ke(t,e){return t!=null?typeof e=="string"?r=>-1*+r.readAttribute(t):r=>+r.readAttribute(t)+e:r=>1}var p7;const Qye="esri.renderers.HeatmapRenderer",vke=se.getLogger(Qye);function Hee(t){if(t!=null){const{maxDensity:e,minDensity:r,radius:i}=t;if(e!=null||r!=null||i!=null){const{blurRadius:s,maxPixelIntensity:n,minPixelIntensity:o,...a}=t;return a}}return t}let go=p7=class extends hy{constructor(t){super(t),this.authoringInfo=null,this.colorStops=[new K3({ratio:0,color:new Ze("rgba(255, 140, 0, 0)")}),new K3({ratio:.75,color:new Ze("rgba(255, 140, 0, 1)")}),new K3({ratio:.9,color:new Ze("rgba(255, 0,   0, 1)")})],this.field=null,this.fieldOffset=0,this.legendOptions=null,this.maxDensity=.04,this.minDensity=0,this.radius=18,this.referenceScale=0,this.type="heatmap",this.valueExpression=null,this.valueExpressionTitle=null,this._warnedProps={blurRadius:!1,maxPixelIntensity:!1,minPixelIntensity:!1}}normalizeCtorArgs(t){return Hee(t)}get blurRadius(){return mke(this.radius)}set blurRadius(t){const e=this.maxPixelIntensity,r=this.minPixelIntensity;this._set("radius",fke(t)),this._warnAboutDeprecatedGaussianBlurProp("blurRadius","radius"),this._set("maxDensity",e*this._pixelIntensityToDensity),this._set("minDensity",r*this._pixelIntensityToDensity)}get maxPixelIntensity(){return this.maxDensity/this._pixelIntensityToDensity}set maxPixelIntensity(t){this._set("maxDensity",t*this._pixelIntensityToDensity),this._warnAboutDeprecatedGaussianBlurProp("maxPixelIntensity","maxDensity")}get minPixelIntensity(){return this.minDensity/this._pixelIntensityToDensity}set minPixelIntensity(t){this._set("minDensity",t*this._pixelIntensityToDensity),this._warnAboutDeprecatedGaussianBlurProp("minPixelIntensity","minDensity")}get _pixelIntensityToDensity(){return 24/(xX**2*this.blurRadius**4)}_warnAboutDeprecatedGaussianBlurProp(t,e){this._warnedProps[t]||Qa(this).getDefaultOrigin()==="user"&&(this._warnedProps[t]=!0,gE(()=>{kk(vke,t,{replacement:`${String(e)} (suggested value: ${this._get(e)})`,version:"4.24"})}))}read(t,e){t=Hee(t),super.read(t,e)}getSymbol(){return new yv}async getSymbolAsync(){return this.getSymbol()}getSymbols(){return[this.getSymbol()]}async collectRequiredFields(t,e){const r=this.field,i=this.valueExpression;r&&typeof r=="string"&&await Ru(t,e,r),i&&typeof i=="string"&&await Hl(t,e,i)}getAttributeHash(){return null}getMeshHash(){return`${JSON.stringify(this.colorStops)}.${this.blurRadius}.${this.field}`}clone(){return new p7({authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),colorStops:ne(this.colorStops),field:this.field,legendOptions:ne(this.legendOptions),maxDensity:this.maxDensity,minDensity:this.minDensity,radius:this.radius,referenceScale:this.referenceScale,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle})}};u([d({type:yX,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],go.prototype,"authoringInfo",void 0),u([d({type:Number,json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],go.prototype,"blurRadius",null),u([d({type:[K3],json:{write:!0}})],go.prototype,"colorStops",void 0),u([d({type:String,json:{write:!0}})],go.prototype,"field",void 0),u([d({type:Number,json:{write:{overridePolicy:(t,e,r)=>({enabled:r==null})},origins:{"web-scene":{write:!1}}}})],go.prototype,"fieldOffset",void 0),u([d({type:UT,json:{write:!0}})],go.prototype,"legendOptions",void 0),u([d({type:Number,json:{write:!0}})],go.prototype,"maxDensity",void 0),u([d({type:Number,json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],go.prototype,"maxPixelIntensity",null),u([d({type:Number,json:{write:!0}})],go.prototype,"minDensity",void 0),u([d({type:Number,json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],go.prototype,"minPixelIntensity",null),u([d({type:Number,cast:hi,json:{write:!0}})],go.prototype,"radius",void 0),u([d({type:Number,range:{min:0},json:{default:0,write:!0}})],go.prototype,"referenceScale",void 0),u([gt({heatmap:"heatmap"})],go.prototype,"type",void 0),u([d({type:String,json:{write:!0,origins:{"web-document":{write:!1},"portal-item":{write:!1}}}})],go.prototype,"valueExpression",void 0),u([d({type:String})],go.prototype,"valueExpressionTitle",void 0),u([d({readOnly:!0})],go.prototype,"_pixelIntensityToDensity",null),go=p7=u([I(Qye)],go);const e0e=go;let bb=class extends bs(ve){constructor(){super(...arguments),this.color=new Ze([0,0,0,0]),this.label=null,this.threshold=0}};u([d({type:Ze,json:{write:!0}})],bb.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],bb.prototype,"label",void 0),u([d({type:Number,range:{min:0,max:1},json:{write:!0}})],bb.prototype,"threshold",void 0),bb=u([I("esri.renderers.support.OthersCategory")],bb);let FL=class extends bs(ve){constructor(){super(...arguments),this.title=null}};u([d({type:String,json:{write:!0}})],FL.prototype,"title",void 0),FL=u([I("esri.renderers.support.PieChartLegendOptions")],FL);let Qc=class extends PE(bs(hy)){constructor(e){super(e),this.attributes=null,this.backgroundFillSymbol=null,this.defaultColor=new Ze([0,0,0,0]),this.defaultLabel=null,this.holePercentage=0,this.othersCategory=new bb,this.legendOptions=null,this.outline=null,this.size=12,this.type="pie-chart"}getSymbol(){var e;return new yv({size:this.size?this.size/2+(((e=this.outline)==null?void 0:e.width)||0):0})}async getSymbolAsync(){return this.getSymbol()}getSymbols(){return[this.getSymbol(),this.backgroundFillSymbol].filter(v)}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((e,r)=>e+r.getAttributeHash(),"")}getMeshHash(){return this.getSymbols().reduce((e,r)=>e+JSON.stringify(r),"")}async collectRequiredFields(e,r){await this.collectVVRequiredFields(e,r);for(const i of this.attributes)i.valueExpression&&await Hl(e,r,i.valueExpression),i.field&&e.add(i.field)}};u([d({type:[Kye],json:{write:!0}})],Qc.prototype,"attributes",void 0),u([d({type:gv,json:{default:null,write:!0}})],Qc.prototype,"backgroundFillSymbol",void 0),u([d({type:Ze,json:{write:!0}})],Qc.prototype,"defaultColor",void 0),u([d({type:String,json:{write:!0}})],Qc.prototype,"defaultLabel",void 0),u([d({type:Number,range:{min:0,max:1},json:{write:!0}})],Qc.prototype,"holePercentage",void 0),u([d({type:bb,json:{write:!0}})],Qc.prototype,"othersCategory",void 0),u([d({type:FL,json:{write:!0}})],Qc.prototype,"legendOptions",void 0),u([d({type:Yh,json:{default:null,write:!0}})],Qc.prototype,"outline",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],Qc.prototype,"size",void 0),u([gt({pieChart:"pie-chart"})],Qc.prototype,"type",void 0),Qc=u([I("esri.renderers.PieChartRenderer")],Qc);const bke=Qc;var f7;let k1=f7=class extends PE(hy){constructor(t){super(t),this.description=null,this.label=null,this.symbol=null,this.type="simple"}async collectRequiredFields(t,e){await Promise.all([this.collectSymbolFields(t,e),this.collectVVRequiredFields(t,e)])}async collectSymbolFields(t,e){await Promise.all(this.getSymbols().map(r=>r.collectRequiredFields(t,e)))}getSymbol(t,e){return this.symbol}async getSymbolAsync(t,e){return this.symbol}getSymbols(){return this.symbol?[this.symbol]:[]}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((t,e)=>t+e.getAttributeHash(),"")}getMeshHash(){return this.getSymbols().reduce((t,e)=>t+JSON.stringify(e),"")}get arcadeRequired(){return this.arcadeRequiredForVisualVariables}clone(){return new f7({description:this.description,label:this.label,symbol:this.symbol&&this.symbol.clone(),visualVariables:ne(this.visualVariables),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}};u([d({type:String,json:{write:!0}})],k1.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],k1.prototype,"label",void 0),u([d(IE)],k1.prototype,"symbol",void 0),u([gt({simple:"simple"})],k1.prototype,"type",void 0),k1=f7=u([I("esri.renderers.SimpleRenderer")],k1);const jS=k1,wke=["esri.Color","esri.portal.Portal","esri.symbols.support.Symbol3DAnchorPosition2D","esri.symbols.support.Symbol3DAnchorPosition3D"];function m7(t){return t instanceof Te}function qee(t){return t instanceof Pt?Object.keys(t.items):m7(t)?Qa(t).keys():t?Object.keys(t):[]}function OP(t,e){return t instanceof Pt?t.items[e]:t[e]}function xke(t,e){return!(!Array.isArray(t)||!Array.isArray(e))&&t.length!==e.length}function tR(t){return t?t.declaredClass:null}function t0e(t,e){const r=t.diff;if(r&&typeof r=="function")return r(t,e);const i=qee(t),s=qee(e);if(i.length===0&&s.length===0)return;if(!i.length||!s.length||xke(t,e))return{type:"complete",oldValue:t,newValue:e};const n=s.filter(p=>!i.includes(p)),o=i.filter(p=>!s.includes(p)),a=i.filter(p=>s.includes(p)&&OP(t,p)!==OP(e,p)).concat(n,o).sort(),l=tR(t);if(l&&wke.includes(l)&&a.length)return{type:"complete",oldValue:t,newValue:e};let c;const h=m7(t)&&m7(e);for(const p of a){const f=OP(t,p),m=OP(e,p);let y;if((h||typeof f!="function"&&typeof m!="function")&&f!==m&&(f!=null||m!=null)){if(r&&r[p]&&typeof r[p]=="function")y=r[p](f,m);else if(f instanceof Date&&m instanceof Date){if(f.getTime()===m.getTime())continue;y={type:"complete",oldValue:f,newValue:m}}else y=typeof f=="object"&&typeof m=="object"&&tR(f)===tR(m)?t0e(f,m):{type:"complete",oldValue:f,newValue:m};v(y)&&(v(c)?c.diff[p]=y:c={type:"partial",diff:{[p]:y}})}}return c}function Tke(t,e){if(C(t))return!1;const r=e.split(".");let i=t;for(const s of r){if(i.type==="complete")return!0;if(i.type!=="partial")return!1;{const n=i.diff[s];if(!n)return!1;i=n}}return!0}function K2t(t,e){for(const r of e)if(Tke(t,r))return!0;return!1}function Ske(t,e){if(!(typeof t=="function"||typeof e=="function"||C(t)&&C(e)))return C(t)||C(e)||typeof t=="object"&&typeof e=="object"&&tR(t)!==tR(e)?{type:"complete",oldValue:t,newValue:e}:t0e(t,e)}function MP(t){if(C(t))return!0;switch(t.type){case"complete":return!1;case"collection":{const e=t;for(const r of e.added)if(!MP(r))return!1;for(const r of e.removed)if(!MP(r))return!1;for(const r of e.changed)if(!MP(r))return!1;return!0}case"partial":for(const e in t.diff)if(!MP(t.diff[e]))return!1;return!0}}let kT=class extends bs(ve){constructor(e){super(e),this.value=null,this.value2=null,this.value3=null}};u([d($L)],kT.prototype,"value",void 0),u([d($L)],kT.prototype,"value2",void 0),u([d($L)],kT.prototype,"value3",void 0),kT=u([I("esri.renderers.support.UniqueValue")],kT);const J2=kT;let I0=class extends bs(ve){constructor(e){super(e),this.description=null,this.label=null,this.symbol=null,this.values=null}castValues(e){if(e==null)return null;const r=typeof(e=Array.isArray(e)?e:[e])[0];return r==="string"||r==="number"?e.map(i=>new J2({value:i})):r==="object"?e[0]instanceof J2?e:e.map(i=>new J2(i)):null}};u([d({type:String,json:{write:!0}})],I0.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],I0.prototype,"label",void 0),u([d(IE)],I0.prototype,"symbol",void 0),u([d({type:[J2],json:{type:[[String]],read:{reader:t=>t?t.map(e=>new J2({value:e[0],value2:e[1],value3:e[2]})):null},write:{writer:(t,e)=>{const r=[];for(const i of t){const s=[i.value,i.value2,i.value3].filter(v).map(n=>n.toString());r.push(s)}e.values=r}}}})],I0.prototype,"values",void 0),u([cr("values")],I0.prototype,"castValues",null),I0=u([I("esri.renderers.support.UniqueValueClass")],I0);const r0e=I0;let jA=class extends bs(ve){constructor(e){super(e),this.heading=null,this.classes=null}};u([d({type:String,json:{write:!0}})],jA.prototype,"heading",void 0),u([d({type:[r0e],json:{write:!0}})],jA.prototype,"classes",void 0),jA=u([I("esri.renderers.support.UniqueValueGroup")],jA);const g7=jA;var y7;let V1=y7=class extends ve{constructor(t){super(t),this.description=null,this.label=null,this.symbol=null,this.value=null}clone(){return new y7({value:this.value,description:this.description,label:this.label,symbol:this.symbol?this.symbol.clone():null})}getMeshHash(){const t=JSON.stringify(this.symbol&&this.symbol.toJSON());return`${this.value}.${t}`}};u([d({type:String,json:{write:!0}})],V1.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],V1.prototype,"label",void 0),u([d(IE)],V1.prototype,"symbol",void 0),u([d($L)],V1.prototype,"value",void 0),V1=y7=u([I("esri.renderers.support.UniqueValueInfo")],V1);const rR=V1,Eke=()=>!!de("enable-feature:force-wosr"),rSt=()=>!!de("enable-feature:direct-3d-object-feature-layer-display"),iSt=()=>!!de("enable-feature:SceneLayer-editing");let EU={};async function Cke(t,e){try{return{data:(await Mke(t,e)).data,baseUrl:WRe(t),styleUrl:t}}catch(r){return xc(r),null}}function Ake(t,e,r){const i=v(e.portal)?e.portal:tl.getDefault();let s;const n=`${i.url} - ${i.user&&i.user.username} - ${t}`;return EU[n]||(EU[n]=Rke(t,i,r).then(o=>(s=o,o.fetchData())).then(o=>({data:o,baseUrl:s.itemUrl??"",styleName:t}))),EU[n]}function Rke(t,e,r){return e.load(r).then(()=>{const i=new Rg({disableExtraQuery:!0,query:`owner:${Wee} AND type:${Xee} AND typekeywords:"${t}"`});return e.queryItems(i,r)}).then(({results:i})=>{var o;let s=null;const n=t.toLowerCase();if(i&&Array.isArray(i)){for(const a of i)if(((o=a.typeKeywords)==null?void 0:o.some(c=>c.toLowerCase()===n))&&a.type===Xee&&a.owner===Wee){s=a;break}}if(!s)throw new q("symbolstyleutils:style-not-found",`The style '${t}' could not be found`,{styleName:t});return s.load(r)})}function Oke(t,e,r){return t&&v(t.styleUrl)?Cke(t.styleUrl,r):t&&v(t.styleName)?Ake(t.styleName,e,r):Promise.reject(new q("symbolstyleutils:style-url-and-name-missing","Either styleUrl or styleName is required to resolve a style"))}function sSt(t){return t===null||t.type==="CIMSymbolReference"?t:{type:"CIMSymbolReference",symbol:t}}function nSt(t,e){if(e==="cimRef")return t.cimRef;if(t.formatInfos&&!Eke()){for(const r of t.formatInfos)if(r.type==="gltf")return r.href}return t.webRef}function Mke(t,e){const r={responseType:"json",query:{f:"json"},...e};return Ni(ip(t),r)}const Wee="esri_en",Xee="Style",oSt="https://cdn.arcgis.com/sharing/rest/content/items/220936cc6ed342c9937abd8f180e7d1e/resources/styles/cim/{SymbolName}.json?f=json";var HA;const i0e="esri.renderers.UniqueValueRenderer",Fy=se.getLogger(i0e),Yee="uvInfos-watcher",Zee="uvGroups-watcher",Pke=",",Ike=us(rR);function $ke(t){const{field1:e,field2:r,field3:i,fieldDelimiter:s,uniqueValueInfos:n,valueExpression:o}=t,a=!(!e||!r);return[{classes:(n??[]).map(l=>{var x;const{symbol:c,label:h,value:p,description:f}=l,[m,y,_]=a?((x=p==null?void 0:p.toString())==null?void 0:x.split(s||""))||[]:[p],b=[];return(e||o)&&b.push(m),r&&b.push(y),i&&b.push(_),{symbol:c,label:h,values:[b],description:f}})}]}let Us=HA=class extends PE(hy){constructor(t){super(t),this._valueInfoMap={},this._isDefaultSymbolDerived=!1,this._isInfosSource=null,this.type="unique-value",this.backgroundFillSymbol=null,this.orderByClassesEnabled=!1,this.valueExpressionTitle=null,this.legendOptions=null,this.defaultLabel=null,this.portal=null,this.styleOrigin=null,this.diff={uniqueValueInfos(e,r){if(!e&&!r)return;if(!e||!r)return{type:"complete",oldValue:e,newValue:r};let i=!1;const s={type:"collection",added:[],removed:[],changed:[],unchanged:[]};for(let n=0;n<r.length;n++){const o=e.find(a=>a.value===r[n].value);o?Ske(o,r[n])?(s.changed.push({type:"complete",oldValue:o,newValue:r[n]}),i=!0):s.unchanged.push({oldValue:o,newValue:r[n]}):(s.added.push(r[n]),i=!0)}for(let n=0;n<e.length;n++)r.find(o=>o.value===e[n].value)||(s.removed.push(e[n]),i=!0);return i?s:void 0}},this._set("uniqueValueInfos",[]),this._set("uniqueValueGroups",[])}get _cache(){return{compiledFunc:null}}set field(t){this._set("field",t),this._updateFieldDelimiter(),this._updateUniqueValues()}castField(t){return t==null||typeof t=="function"?t:WO(t)}writeField(t,e,r,i){typeof t=="string"?e[r]=t:i&&i.messages?i.messages.push(new q("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):Fy.error(".field: cannot write field to JSON since it's not a string value")}set field2(t){this._set("field2",t),this._updateFieldDelimiter(),this._updateUniqueValues()}set field3(t){this._set("field3",t),this._updateUniqueValues()}set valueExpression(t){this._set("valueExpression",t),this._updateUniqueValues()}set defaultSymbol(t){this._isDefaultSymbolDerived=!1,this._set("defaultSymbol",t)}set fieldDelimiter(t){this._set("fieldDelimiter",t),this._updateUniqueValues()}readPortal(t,e,r){return r.portal||tl.getDefault()}readStyleOrigin(t,e,r){if(e.styleName)return Object.freeze({styleName:e.styleName});if(e.styleUrl){const i=xE(e.styleUrl,r);return Object.freeze({styleUrl:i})}}writeStyleOrigin(t,e,r,i){t.styleName?e.styleName=t.styleName:t.styleUrl&&(e.styleUrl=gw(t.styleUrl,i))}set uniqueValueGroups(t){this.styleOrigin?Fy.error("#uniqueValueGroups=","Cannot modify unique value groups of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueGroups",t),this._updateInfosFromGroups(),this._isInfosSource=!1,this._watchUniqueValueGroups())}set uniqueValueInfos(t){this.styleOrigin?Fy.error("#uniqueValueInfos=","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",t),this._updateValueInfoMap(),this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos())}addUniqueValueInfo(t,e){var i;if(this.styleOrigin)return void Fy.error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");let r;r=typeof t=="object"?Ike(t):new rR({value:t,symbol:Gpe(e)}),(i=this.uniqueValueInfos)==null||i.push(r),this._valueInfoMap[r.value]=r,this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()}removeUniqueValueInfo(t){if(this.styleOrigin)return void Fy.error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");const e=this.uniqueValueInfos;if(e){for(let r=0;r<e.length;r++)if(e[r].value===t+""){delete this._valueInfoMap[t],e.splice(r,1);break}}this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()}async getUniqueValueInfo(t,e){let r=e;return this.valueExpression&&(C(e)||C(e.arcade))&&(r={...r,arcade:await sm()}),this._getUniqueValueInfo(t,r)}getSymbol(t,e){if(this.valueExpression&&(C(e)||C(e.arcade)))return void Fy.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const r=this._getUniqueValueInfo(t,e);return r&&r.symbol||this.defaultSymbol}async getSymbolAsync(t,e){let r=e;if(this.valueExpression&&(C(r)||C(r.arcade))){const s=await sm(),{arcadeUtils:n}=s;n.hasGeometryOperations(this.valueExpression)&&await n.enableGeometryOperations(),r={...r,arcade:s}}const i=this._getUniqueValueInfo(t,r);return i&&i.symbol||this.defaultSymbol}getSymbols(){const t=[];for(const e of this.uniqueValueInfos??[])e.symbol&&t.push(e.symbol);return this.defaultSymbol&&t.push(this.defaultSymbol),t}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((t,e)=>t+e.getAttributeHash(),"")}getMeshHash(){var i;const t=JSON.stringify(this.backgroundFillSymbol),e=JSON.stringify(this.defaultSymbol),r=(i=this.uniqueValueInfos)==null?void 0:i.reduce((s,n)=>s+n.getMeshHash(),"");return`${t}.${e}.${r}.${`${this.field}.${this.field2}.${this.field3}.${this.fieldDelimiter}`}.${this.valueExpression}`}clone(){const t=new HA({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:ne(this.defaultSymbol),orderByClassesEnabled:this.orderByClassesEnabled,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:ne(this.visualVariables),legendOptions:ne(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),backgroundFillSymbol:ne(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(t._isDefaultSymbolDerived=!0),t._set("portal",this.portal);const e=ne(this.uniqueValueInfos),r=ne(this.uniqueValueGroups);return this.styleOrigin&&(t._set("styleOrigin",Object.freeze(ne(this.styleOrigin))),Object.freeze(e),Object.freeze(r)),t._set("uniqueValueInfos",e),t._updateValueInfoMap(),t._set("uniqueValueGroups",r),t._isInfosSource=this._isInfosSource,t._watchUniqueValueInfosAndGroups(),t}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}async collectRequiredFields(t,e){const r=[this.collectVVRequiredFields(t,e),this.collectSymbolFields(t,e)];await Promise.all(r)}async collectSymbolFields(t,e){const r=[...this.getSymbols().map(i=>i.collectRequiredFields(t,e)),Hl(t,e,this.valueExpression)];Ru(t,e,this.field),Ru(t,e,this.field2),Ru(t,e,this.field3),await Promise.all(r)}populateFromStyle(){return Oke(this.styleOrigin,{portal:this.portal}).then(t=>{var r;const e=[];return this._valueInfoMap={},t&&t.data&&Array.isArray(t.data.items)&&t.data.items.forEach(i=>{const s=new Xw({styleUrl:t.styleUrl,styleName:t.styleName,portal:this.portal,name:i.name});this.defaultSymbol||i.name!==t.data.defaultItem||(this.defaultSymbol=s,this._isDefaultSymbolDerived=!0);const n=new rR({value:i.name,symbol:s});e.push(n),this._valueInfoMap[i.name]=n}),this._set("uniqueValueInfos",Object.freeze(e)),this._updateGroupsFromInfos(!0),this._isInfosSource=null,this._watchUniqueValueInfos(),!this.defaultSymbol&&((r=this.uniqueValueInfos)!=null&&r.length)&&(this.defaultSymbol=this.uniqueValueInfos[0].symbol,this._isDefaultSymbolDerived=!0),this})}_updateFieldDelimiter(){this.field&&this.field2&&!this.fieldDelimiter&&this._set("fieldDelimiter",Pke)}_updateUniqueValues(){this._isInfosSource!=null&&(this._isInfosSource?this._updateGroupsFromInfos():this._updateInfosFromGroups())}_updateValueInfoMap(){this._valueInfoMap={};const{uniqueValueInfos:t}=this;if(t)for(const e of t)this._valueInfoMap[e.value+""]=e}_watchUniqueValueInfosAndGroups(){this._watchUniqueValueInfos(),this._watchUniqueValueGroups()}_watchUniqueValueInfos(){this.removeHandles(Yee);const{uniqueValueInfos:t}=this;if(t){const e=[];for(const r of t)e.push(ie(()=>({symbol:r.symbol,value:r.value,label:r.label,description:r.description}),(i,s)=>{i!==s&&(this._updateGroupsFromInfos(),this._isInfosSource=!0)},{sync:!0}));this.addHandles(e,Yee)}}_watchUniqueValueGroups(){this.removeHandles(Zee);const{uniqueValueGroups:t}=this;if(t){const e=[];for(const r of t){e.push(ie(()=>({classes:r.classes}),(i,s)=>{i!==s&&(this._updateInfosFromGroups(),this._isInfosSource=!1)},{sync:!0}));for(const i of r.classes??[])e.push(ie(()=>({symbol:i.symbol,values:i.values,label:i.label,description:i.description}),(s,n)=>{s!==n&&(this._updateInfosFromGroups(),this._isInfosSource=!1)},{sync:!0}))}this.addHandles(e,Zee)}}_updateInfosFromGroups(){if(!this.uniqueValueGroups)return this._set("uniqueValueInfos",null),this._updateValueInfoMap(),void this._watchUniqueValueInfos();const t=[],{field:e,field2:r,field3:i,fieldDelimiter:s,uniqueValueGroups:n,valueExpression:o}=this;if(!e&&!o)return this._set("uniqueValueInfos",t),this._updateValueInfoMap(),void this._watchUniqueValueInfos();const a=!(!e||!r);for(const l of n)for(const c of l.classes??[]){const{symbol:h,label:p,values:f,description:m}=c;for(const y of f??[]){const{value:_,value2:b,value3:x}=y,T=[_];r&&T.push(b),i&&T.push(x);const S=a?T.join(s||""):T[0];t.push(new rR({symbol:h,label:p,value:S,description:m}))}}this._set("uniqueValueInfos",t),this._updateValueInfoMap(),this._watchUniqueValueInfos()}_updateGroupsFromInfos(t=!1){if(!this.uniqueValueInfos)return this._set("uniqueValueGroups",null),void this._watchUniqueValueGroups();const{field:e,field2:r,valueExpression:i,fieldDelimiter:s,uniqueValueInfos:n}=this;if(!e&&!i||!n.length)return this._set("uniqueValueGroups",[]),void this._watchUniqueValueGroups();const o=!(!e||!r),a=n.map(c=>{var x;const{symbol:h,label:p,value:f,description:m}=c,[y,_,b]=o?((x=f==null?void 0:f.toString())==null?void 0:x.split(s||""))||[]:[f];return new r0e({symbol:h,label:p,description:m,values:[new J2({value:y,value2:_,value3:b})]})}),l=[new g7({classes:a})];t&&Object.freeze(l),this._set("uniqueValueGroups",l),this._watchUniqueValueGroups()}_getUniqueValueInfo(t,e){return this.valueExpression?this._getUnqiueValueInfoForExpression(t,e):this._getUnqiueValueInfoForFields(t)}_getUnqiueValueInfoForExpression(t,e){const{viewingMode:r,scale:i,spatialReference:s,arcade:n}=It(e,{});let o=this._cache.compiledFunc;const a=n.arcadeUtils;if(!o){const c=a.createSyntaxTree(this.valueExpression);o=a.createFunction(c),this._cache.compiledFunc=o}const l=a.executeFunction(o,a.createExecContext(t,a.getViewInfo({viewingMode:r,scale:i,spatialReference:s})));return this._valueInfoMap[l+""]}_getUnqiueValueInfoForFields(t){const e=this.field,r=t.attributes;let i;if(typeof e!="function"&&this.field2){const s=this.field2,n=this.field3,o=[];e&&o.push(r[e]),s&&o.push(r[s]),n&&o.push(r[n]),i=o.join(this.fieldDelimiter||"")}else typeof e=="function"?i=e(t):e&&(i=r[e]);return this._valueInfoMap[i+""]}static fromPortalStyle(t,e){const r=new HA(e&&e.properties);r._set("styleOrigin",Object.freeze({styleName:t})),r._set("portal",e&&e.portal||tl.getDefault());const i=r.populateFromStyle();return i.catch(s=>{Fy.error(`#fromPortalStyle('${t}'[, ...])`,"Failed to create unique value renderer from style name",s)}),i}static fromStyleUrl(t,e){const r=new HA(e&&e.properties);r._set("styleOrigin",Object.freeze({styleUrl:t}));const i=r.populateFromStyle();return i.catch(s=>{Fy.error(`#fromStyleUrl('${t}'[, ...])`,"Failed to create unique value renderer from style URL",s)}),i}};u([d({readOnly:!0})],Us.prototype,"_cache",null),u([gt({uniqueValue:"unique-value"})],Us.prototype,"type",void 0),u([d(Xye)],Us.prototype,"backgroundFillSymbol",void 0),u([d({value:null,json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],Us.prototype,"field",null),u([cr("field")],Us.prototype,"castField",null),u([He("field")],Us.prototype,"writeField",null),u([d({type:String,value:null,json:{write:!0}})],Us.prototype,"field2",null),u([d({type:String,value:null,json:{write:!0}})],Us.prototype,"field3",null),u([d({type:Boolean,json:{name:"drawInClassOrder",default:!1,write:!0,origins:{"web-scene":{write:!1}}}})],Us.prototype,"orderByClassesEnabled",void 0),u([d({type:String,value:null,json:{write:!0}})],Us.prototype,"valueExpression",null),u([d({type:String,json:{write:!0}})],Us.prototype,"valueExpressionTitle",void 0),u([d({type:Z2,json:{write:!0}})],Us.prototype,"legendOptions",void 0),u([d({type:String,json:{write:!0}})],Us.prototype,"defaultLabel",void 0),u([d(Kce({...IE},{json:{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}},origins:{"web-scene":{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],Us.prototype,"defaultSymbol",null),u([d({type:String,value:null,json:{write:!0}})],Us.prototype,"fieldDelimiter",null),u([d({type:tl,readOnly:!0})],Us.prototype,"portal",void 0),u([Fe("portal",["styleName"])],Us.prototype,"readPortal",null),u([d({readOnly:!0,json:{write:{enabled:!1,overridePolicy:()=>({enabled:!0})}}})],Us.prototype,"styleOrigin",void 0),u([Fe("styleOrigin",["styleName","styleUrl"])],Us.prototype,"readStyleOrigin",null),u([He("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],Us.prototype,"writeStyleOrigin",null),u([d({type:[g7],json:{read:{source:["uniqueValueGroups","uniqueValueInfos"],reader:(t,e,r)=>(e.uniqueValueGroups||$ke(e)).map(i=>g7.fromJSON(i,r))},write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],Us.prototype,"uniqueValueGroups",null),u([d({type:[rR],json:{read:!1,write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],Us.prototype,"uniqueValueInfos",null),Us=HA=u([I(i0e)],Us);const _M=Us,s5={key:"type",base:hy,typeMap:{heatmap:e0e,simple:jS,"unique-value":_M,"class-breaks":Zye,"dot-density":pke,dictionary:hke,"pie-chart":bke},errorContext:"renderer"},Lke={key:"type",base:hy,typeMap:{simple:jS,"unique-value":_M,"class-breaks":Zye,heatmap:e0e},errorContext:"renderer"},Dke=dv({types:s5});function kN(t,e,r){return t?t&&(t.styleName||t.styleUrl)&&t.type!=="uniqueValue"?(r&&r.messages&&r.messages.push(new rm("renderer:unsupported","Only UniqueValueRenderer can be referenced from a web style, but found '"+t.type+"'",{definition:t,context:r})),null):Dke(t,e,r):null}let Nke=class s0e{constructor(){this._propertyOriginMap=new Map,this._originStores=new Array(Fk),this._values=new Map,this.multipleOriginsSupported=!0}clone(e){const r=new s0e,i=this._originStores[Gr.DEFAULTS];i&&i.forEach((s,n)=>{r.set(n,ne(s),Gr.DEFAULTS)});for(let s=Gr.SERVICE;s<Fk;s++){const n=this._originStores[s];n&&n.forEach((o,a)=>{e&&e.has(a)||r.set(a,ne(o),s)})}return r}get(e,r){const i=r===void 0?this._values:this._originStores[r];return i?i.get(e):void 0}keys(e){const r=e==null?this._values:this._originStores[e];return r?[...r.keys()]:[]}set(e,r,i=Gr.USER){let s=this._originStores[i];if(s||(s=new Map,this._originStores[i]=s),s.set(e,r),!this._values.has(e)||this._propertyOriginMap.get(e)<=i){const n=this._values.get(e);return this._values.set(e,r),this._propertyOriginMap.set(e,i),n!==r}return!1}delete(e,r=Gr.USER){const i=this._originStores[r];if(!i)return;const s=i.get(e);if(i.delete(e),this._values.has(e)&&this._propertyOriginMap.get(e)===r){this._values.delete(e);for(let n=r-1;n>=0;n--){const o=this._originStores[n];if(o&&o.has(e)){this._values.set(e,o.get(e)),this._propertyOriginMap.set(e,n);break}}}return s}has(e,r){const i=r===void 0?this._values:this._originStores[r];return!!i&&i.has(e)}revert(e,r){for(;r>0&&!this.has(e,r);)--r;const i=this._originStores[r],s=i&&i.get(e),n=this._values.get(e);return this._values.set(e,s),this._propertyOriginMap.set(e,r),n!==s}originOf(e){return this._propertyOriginMap.get(e)||Gr.DEFAULTS}forEach(e){this._values.forEach(e)}};const n0e=t=>{let e=class extends t{constructor(...r){super(...r);const i=Qa(this),s=i.store,n=new Nke;i.store=n,jue(i,s,n)}read(r,i){que(this,r,i)}getAtOrigin(r,i){const s=CU(this),n=m_(i);if(typeof r=="string")return s.get(r,n);const o={};return r.forEach(a=>{o[a]=s.get(a,n)}),o}originOf(r){return UD(this.originIdOf(r))}originIdOf(r){return CU(this).originOf(r)}revert(r,i){const s=CU(this),n=m_(i),o=Qa(this);let a;a=typeof r=="string"?r==="*"?s.keys(n):[r]:r,a.forEach(l=>{o.invalidate(l),s.revert(l,n),o.commit(l)})}};return e=u([I("esri.core.ReadOnlyMultiOriginJSONSupport")],e),e};function CU(t){return Qa(t).store}let Jee=class extends n0e(Te){};Jee=u([I("esri.core.ReadOnlyMultiOriginJSONSupport")],Jee);const Fke=t=>{let e=class extends t{constructor(...r){super(...r)}clear(r,i="user"){return AU(this).delete(r,m_(i))}write(r={},i){return Xue(this,r=r||{},i),r}setAtOrigin(r,i,s){Qa(this).setAtOrigin(r,i,m_(s))}removeOrigin(r){const i=AU(this),s=m_(r),n=i.keys(s);for(const o of n)i.originOf(o)===s&&i.set(o,i.get(o,s),Gr.USER)}updateOrigin(r,i){const s=AU(this),n=m_(i),o=this.get(r);for(let a=n+1;a<Fk;++a)s.delete(r,a);s.set(r,o,n)}toJSON(r){return this.write({},r)}};return e=u([I("esri.core.WriteableMultiOriginJSONSupport")],e),e.prototype.toJSON.isDefaultToJSON=!0,e};function AU(t){return Qa(t).store}const o0e=t=>{let e=class extends Fke(n0e(t)){constructor(...r){super(...r)}};return e=u([I("esri.core.MultiOriginJSONSupport")],e),e};let Kee=class extends o0e(Te){};Kee=u([I("esri.core.MultiOriginJSONSupport")],Kee);async function Uke(t,e){const{WhereClause:r}=await te(()=>import("./WhereClause-2e7ef2fe.js").then(i=>i.W),["assets/WhereClause-2e7ef2fe.js","assets/executionError-fb3f283a.js"]);return r.create(t,e)}function kke(t,e){return v(t)?v(e)?`(${t}) AND (${e})`:t:e}var _7;let B1=_7=class extends ve{constructor(t){super(t),this.expression=null,this.name=null,this.returnType="boolean",this.title=null}clone(){return new _7({name:this.name,title:this.title,expression:this.expression,returnType:this.returnType})}};u([d({type:String,json:{write:!0}})],B1.prototype,"expression",void 0),u([d({type:String,json:{write:!0}})],B1.prototype,"name",void 0),u([d({type:["boolean","date","number","string"],json:{write:!0}})],B1.prototype,"returnType",void 0),u([d({type:String,json:{write:!0}})],B1.prototype,"title",void 0),B1=_7=u([I("esri.form.ExpressionInfo")],B1);const Vke=B1;let z1=class extends ve{constructor(e){super(e),this.description=null,this.label=null,this.type=null,this.visibilityExpression=null}};u([d({type:String,json:{write:!0}})],z1.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],z1.prototype,"label",void 0),u([d()],z1.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],z1.prototype,"visibilityExpression",void 0),z1=u([I("esri.form.elements.Element")],z1);const HS=z1;var v7;let UL=v7=class extends ve{constructor(t){super(t),this.type=null}clone(){return new v7({type:this.type})}};u([d({type:["attachment","audio","document","image","signature","video"],json:{write:!0}})],UL.prototype,"type",void 0),UL=v7=u([I("esri.form.elements.inputs.AttachmentInput")],UL);const Bke=UL;var b7;let G1=b7=class extends HS{constructor(t){super(t),this.attachmentKeyword=null,this.editable=!0,this.input=null,this.type="attachment"}clone(){return new b7({attachmentKeyword:this.attachmentKeyword,description:this.description,editable:this.editable,input:this.input,label:this.label,visibilityExpression:this.visibilityExpression})}};u([d({type:String,json:{write:!0}})],G1.prototype,"attachmentKeyword",void 0),u([d({type:Boolean,json:{write:!0}})],G1.prototype,"editable",void 0),u([d({type:Bke,json:{read:{source:"inputType"},write:{target:"inputType"}}})],G1.prototype,"input",void 0),u([d({type:["attachment"],json:{read:!1,write:!0}})],G1.prototype,"type",void 0),G1=b7=u([I("esri.form.elements.AttachmentElement")],G1);const Qee=G1;let kL=class extends ve{constructor(e){super(e),this.type=null}};u([d()],kL.prototype,"type",void 0),kL=u([I("esri.form.elements.inputs.Input")],kL);const $E=kL;let qA=class extends $E{constructor(e){super(e),this.maxLength=null,this.minLength=0}};u([d({type:Number,json:{write:!0}})],qA.prototype,"maxLength",void 0),u([d({type:Number,json:{write:!0}})],qA.prototype,"minLength",void 0),qA=u([I("esri.form.elements.inputs.TextInput")],qA);const TX=qA;var w7;let VL=w7=class extends TX{constructor(t){super(t),this.type="barcode-scanner"}clone(){return new w7({maxLength:this.maxLength,minLength:this.minLength})}};u([d({type:["barcode-scanner"],json:{read:!1,write:!0}})],VL.prototype,"type",void 0),VL=w7=u([I("esri.form.elements.inputs.BarcodeScannerInput")],VL);const zke=VL;var x7;let VT=x7=class extends $E{constructor(t){super(t),this.noValueOptionLabel=null,this.showNoValueOption=!0,this.type="combo-box"}clone(){return new x7({showNoValueOption:this.showNoValueOption,noValueOptionLabel:this.noValueOptionLabel})}};u([d({type:String,json:{write:!0}})],VT.prototype,"noValueOptionLabel",void 0),u([d({type:Boolean,json:{write:!0}})],VT.prototype,"showNoValueOption",void 0),u([d({type:["combo-box"],json:{read:!1,write:!0}})],VT.prototype,"type",void 0),VT=x7=u([I("esri.form.elements.inputs.ComboBoxInput")],VT);const Gke=VT;var T7;function ete(t){return t!=null?new Date(t):null}function tte(t){return t?t.getTime():null}let Sd=T7=class extends $E{constructor(t){super(t),this.includeTime=!1,this.max=null,this.min=null,this.type="datetime-picker"}readMax(t,e){return ete(e.max)}writeMax(t,e){e.max=tte(t)}readMin(t,e){return ete(e.min)}writeMin(t,e){e.min=tte(t)}clone(){return new T7({includeTime:this.includeTime,max:this.max,min:this.min})}};u([d({type:Boolean,json:{write:!0}})],Sd.prototype,"includeTime",void 0),u([d({type:Date,json:{type:Number,write:!0}})],Sd.prototype,"max",void 0),u([Fe("max")],Sd.prototype,"readMax",null),u([He("max")],Sd.prototype,"writeMax",null),u([d({type:Date,json:{type:Number,write:!0}})],Sd.prototype,"min",void 0),u([Fe("min")],Sd.prototype,"readMin",null),u([He("min")],Sd.prototype,"writeMin",null),u([d({type:["datetime-picker"],json:{read:!1,write:!0}})],Sd.prototype,"type",void 0),Sd=T7=u([I("esri.form.elements.inputs.DateTimePickerInput")],Sd);const jke=Sd;var S7;let BT=S7=class extends $E{constructor(t){super(t),this.noValueOptionLabel=null,this.showNoValueOption=!0,this.type="radio-buttons"}clone(){return new S7({noValueOptionLabel:this.noValueOptionLabel,showNoValueOption:this.showNoValueOption})}};u([d({type:String,json:{write:!0}})],BT.prototype,"noValueOptionLabel",void 0),u([d({type:Boolean,json:{write:!0}})],BT.prototype,"showNoValueOption",void 0),u([d({type:["radio-buttons"],json:{read:!1,write:!0}})],BT.prototype,"type",void 0),BT=S7=u([I("esri.form.elements.inputs.RadioButtonsInput")],BT);const Hke=BT;var E7;let zT=E7=class extends $E{constructor(t){super(t),this.offValue=null,this.onValue=null,this.type="switch"}clone(){return new E7({offValue:this.offValue,onValue:this.onValue})}};u([d({type:[String,Number],json:{write:!0}})],zT.prototype,"offValue",void 0),u([d({type:[String,Number],json:{write:!0}})],zT.prototype,"onValue",void 0),u([d({type:["switch"],json:{read:!1,write:!0}})],zT.prototype,"type",void 0),zT=E7=u([I("esri.form.elements.inputs.SwitchInput")],zT);const qke=zT;var C7;let BL=C7=class extends TX{constructor(t){super(t),this.type="text-area"}clone(){return new C7({maxLength:this.maxLength,minLength:this.minLength})}};u([d({type:["text-area"],json:{read:!1,write:!0}})],BL.prototype,"type",void 0),BL=C7=u([I("esri.form.elements.inputs.TextAreaInput")],BL);const Wke=BL;var A7;let zL=A7=class extends TX{constructor(t){super(t),this.type="text-box"}clone(){return new A7({maxLength:this.maxLength,minLength:this.minLength})}};u([d({type:["text-box"],json:{read:!1,write:!0}})],zL.prototype,"type",void 0),zL=A7=u([I("esri.form.elements.inputs.TextBoxInput")],zL);const Xke=zL,Yke={base:$E,key:"type",typeMap:{"barcode-scanner":zke,"combo-box":Gke,"datetime-picker":jke,"radio-buttons":Hke,switch:qke,"text-area":Wke,"text-box":Xke}};var R7;const a0e="esri.form.elements.FieldElement",rte=se.getLogger(a0e);let nh=R7=class extends HS{constructor(t){super(t),this.domain=null,this.editableExpression=null,this.fieldName=null,this.hint=null,this.input=null,this.requiredExpression=null,this.type="field",this.valueExpression=null}get editable(){return kk(rte,"editable",{replacement:"editableExpression",version:"4.26",warnOnce:!0}),this._get("editable")??!0}set editable(t){kk(rte,"editable",{replacement:"editableExpression",version:"4.26",warnOnce:!0}),this._set("editable",t)}clone(){return new R7({description:this.description,domain:this.domain,editable:this.editable,editableExpression:this.editableExpression,fieldName:this.fieldName,hint:this.hint,input:this.input,label:this.label,requiredExpression:this.requiredExpression,valueExpression:this.valueExpression,visibilityExpression:this.visibilityExpression})}};u([d({types:pye,json:{read:{reader:oX},write:!0}})],nh.prototype,"domain",void 0),u([d({type:Boolean,json:{write:!0}})],nh.prototype,"editable",null),u([d({type:String,json:{write:!0}})],nh.prototype,"editableExpression",void 0),u([d({type:String,json:{write:!0}})],nh.prototype,"fieldName",void 0),u([d({type:String,json:{write:!0}})],nh.prototype,"hint",void 0),u([d({types:Yke,json:{read:{source:"inputType"},write:{target:"inputType"}}})],nh.prototype,"input",void 0),u([d({type:String,json:{write:!0}})],nh.prototype,"requiredExpression",void 0),u([d({type:String,json:{read:!1,write:!0}})],nh.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],nh.prototype,"valueExpression",void 0),nh=R7=u([I(a0e)],nh);const ite=nh;var O7;let og=O7=class extends HS{constructor(t){super(t),this.displayCount=null,this.displayType="list",this.editable=!0,this.orderByFields=null,this.relationshipId=null,this.type="relationship"}clone(){return new O7({description:this.description,displayCount:this.displayCount,displayType:this.displayType,editable:this.editable,label:this.label,orderByFields:ne(this.orderByFields),relationshipId:this.relationshipId,visibilityExpression:this.visibilityExpression})}};u([d({type:Number,json:{write:!0}})],og.prototype,"displayCount",void 0),u([d({type:["list"],json:{write:!0}})],og.prototype,"displayType",void 0),u([d({type:Boolean,json:{write:!0}})],og.prototype,"editable",void 0),u([d({type:[Jq],json:{write:!0}})],og.prototype,"orderByFields",void 0),u([d({type:Number,json:{write:!0}})],og.prototype,"relationshipId",void 0),u([d({type:["relationship"],json:{read:!1,write:!0}})],og.prototype,"type",void 0),og=O7=u([I("esri.form.elements.RelationshipElement")],og);const ste=og;function l0e(t){return{typesWithGroup:{base:HS,key:"type",typeMap:{attachment:Qee,field:ite,group:t,relationship:ste}},typesWithoutGroup:{base:HS,key:"type",typeMap:{attachment:Qee,field:ite,relationship:ste}}}}function c0e(t,e,r=!0){if(!t)return null;const i=r?e.typesWithGroup.typeMap:e.typesWithoutGroup.typeMap;return t.filter(s=>i[s.type]).map(s=>i[s.type].fromJSON(s))}function u0e(t,e,r=!0){if(!t)return null;const i=r?e.typesWithGroup.typeMap:e.typesWithoutGroup.typeMap;return t.filter(s=>i[s.type]).map(s=>s.toJSON())}function h0e(t,e,r=!0){return t?t.map(i=>up(r?e.typesWithGroup:e.typesWithoutGroup,i)):null}var M7;let Sf=M7=class extends HS{constructor(t){super(t),this.elements=null,this.initialState="expanded",this.type="group"}castElements(t){return h0e(t,RU,!1)}readElements(t,e){return c0e(e.formElements,RU,!1)}writeElements(t,e){e.formElements=u0e(t,RU,!1)}clone(){return new M7({description:this.description,elements:ne(this.elements),initialState:this.initialState,label:this.label,visibilityExpression:this.visibilityExpression})}};u([d({json:{write:!0}})],Sf.prototype,"elements",void 0),u([cr("elements")],Sf.prototype,"castElements",null),u([Fe("elements",["formElements"])],Sf.prototype,"readElements",null),u([He("elements")],Sf.prototype,"writeElements",null),u([d({type:["collapsed","expanded"],json:{write:!0}})],Sf.prototype,"initialState",void 0),u([d({type:String,json:{read:!1,write:!0}})],Sf.prototype,"type",void 0),Sf=M7=u([I("esri.form.elements.GroupElement")],Sf);const RU=l0e(Sf),Zke=Sf;var P7;const OU=l0e(Zke);let Ed=P7=class extends ve{constructor(t){super(t),this.description=null,this.elements=null,this.expressionInfos=null,this.preserveFieldValuesWhenHidden=!1,this.title=null}castElements(t){return h0e(t,OU)}readElements(t,e){return c0e(e.formElements,OU)}writeElements(t,e){e.formElements=u0e(t,OU)}clone(){return new P7({description:this.description,expressionInfos:ne(this.expressionInfos),elements:ne(this.elements),title:this.title,preserveFieldValuesWhenHidden:this.preserveFieldValuesWhenHidden})}};u([d({type:String,json:{write:!0}})],Ed.prototype,"description",void 0),u([d({json:{write:!0}})],Ed.prototype,"elements",void 0),u([cr("elements")],Ed.prototype,"castElements",null),u([Fe("elements",["formElements"])],Ed.prototype,"readElements",null),u([He("elements")],Ed.prototype,"writeElements",null),u([d({type:[Vke],json:{write:!0}})],Ed.prototype,"expressionInfos",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],Ed.prototype,"preserveFieldValuesWhenHidden",void 0),u([d({type:String,json:{write:!0}})],Ed.prototype,"title",void 0),Ed=P7=u([I("esri.form.FormTemplate")],Ed);const Jke=Ed;function nte(t,e,r){if(t.hasM==null||t.hasZ)for(const i of e)for(const s of i)s.length>2&&(s[2]*=r)}function Kke(t,e,r){if(!t&&!e||!r)return;const i=uw(r);ote(t,r,i),ote(e,r,i)}function ote(t,e,r){if(t)for(const i of t)Qke(i.geometry,e,r)}function Qke(t,e,r){if(C(t)||!t.spatialReference||Tn(t.spatialReference,e))return;const i=uw(t.spatialReference)/r;if(i!==1){if("x"in t)t.z!=null&&(t.z*=i);else if("rings"in t)nte(t,t.rings,i);else if("paths"in t)nte(t,t.paths,i);else if("points"in t&&(t.hasM==null||t.hasZ))for(const s of t.points)s.length>2&&(s[2]*=i)}}let eVe=0;const d0e="esri.layers.graphics.sources.MemorySource",MU=se.getLogger(d0e);let bg=class extends Zg.LoadableMixin(a4(Yw(Pt))){constructor(e){super(e),this._idToClientGraphic=null,this.type="memory"}load(e){const r=v(e)?e.signal:null;return this.addResolvingPromise(this._startWorker(r)),Promise.resolve(this)}destroy(){var e;(e=this._connection)==null||e.close(),this._connection=null}get _workerGeometryType(){var r;const e=(r=this.layer)==null?void 0:r.geometryType;return e?this._geometryTypeRequiresClientGraphicMapping(e)?"polygon":e:null}applyEdits(e){return this.load().then(()=>this._applyEdits(e))}openPorts(){return this.load().then(()=>this._connection.openPorts())}async queryFeatures(e,r={}){await this.load(r);const i=await this._connection.invoke("queryFeatures",e?e.toJSON():null,r);Nz(e,this.layer.spatialReference,i);const s=lX.fromJSON(i);if(!this._requiresClientGraphicMapping())return s;const n=this.layer.objectIdField;for(const o of s.features){const a=o.attributes[n],l=this._idToClientGraphic.get(a);l&&(o.geometry=l.geometry)}return s.geometryType=this.layer.geometryType,s}async queryFeaturesJSON(e,r={}){if(this._requiresClientGraphicMapping())throw new q("query-features-json:unsupported","Cannot query in JSON format for client only geometry types (mesh and extent)");await this.load(r);const i=await this._connection.invoke("queryFeatures",e?e.toJSON():null,r);return Nz(e,this.layer.spatialReference,i),i}queryFeatureCount(e,r={}){return this.load(r).then(()=>this._connection.invoke("queryFeatureCount",e?e.toJSON():null,r))}queryObjectIds(e,r={}){return this.load(r).then(()=>this._connection.invoke("queryObjectIds",e?e.toJSON():null,r))}queryExtent(e,r={}){return this.load(r).then(()=>this._connection.invoke("queryExtent",e?e.toJSON():null,r)).then(i=>({count:i.count,extent:Zr.fromJSON(i.extent)}))}querySnapping(e,r={}){return this.load(r).then(()=>this._connection.invoke("querySnapping",e,r))}async _applyEdits(e){if(!this._connection)throw new q("feature-layer-source:edit-failure","Memory source not loaded");const r=this.layer.objectIdField;let i=null;const s=[],n=[];await Promise.all([this._prepareClientMapping(e.addFeatures,null),this._prepareClientMapping(e.updateFeatures,null)]);const o=h=>"objectId"in h&&h.objectId!=null?h.objectId:"attributes"in h&&h.attributes[r]!=null?h.attributes[r]:null;if(e.addFeatures&&(i=this._prepareAddFeatures(e.addFeatures)),e.deleteFeatures)for(const h of e.deleteFeatures){const p=o(h);p!=null&&s.push(p)}const a=e.updateFeatures&&this._idToClientGraphic?new Map:null;if(e.updateFeatures){for(const h of e.updateFeatures)if(n.push(this._serializeFeature(h)),a){const p=o(h);p!=null&&a.set(p,h)}}Kke(i?i.features:null,n,this.layer.spatialReference);const{fullExtent:l,featureEditResults:c}=await this._connection.invoke("applyEdits",{adds:i?i.features:[],updates:n,deletes:s});return this.fullExtent=l,i&&i.finish(c.uidToObjectId),this._updateClientGraphicIds(a,c),this._createEditsResult(c)}async _prepareClientMapping(e,r){if(this._layerOrSourceGeometryType!=="mesh"||C(e))return;const i=[];for(const{geometry:s}of e)!v(s)||s.type!=="mesh"||s.hasExtent||s.loaded||i.push(s.load({signal:r}));i.length&&await Promise.all(i)}_updateClientGraphicIds(e,r){if(this._idToClientGraphic){if(e)for(const i of r.updateResults){if(!i.success)continue;const s=e.get(i.objectId);s!=null&&this._addIdToClientGraphic(s)}for(const i of r.deleteResults)i.success&&this._idToClientGraphic.delete(i.objectId)}}_createEditsResult(e){return{addFeatureResults:e.addResults?e.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:e.updateResults?e.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:e.deleteResults?e.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]}}_createFeatureEditResult(e){const r=e.success===!0?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:r?new q("feature-layer-source:edit-failure",r.description,{code:r.code}):null}}_prepareAddFeatures(e){const r=new Map,i=new Array(e.length);let s=null;for(let o=0;o<e.length;o++){const a=e[o],l=this._serializeFeature(a);!s&&v(a.geometry)&&(s=a.geometry.type),i[o]=l,r.set(`${l.uid}`,a)}const n=this;return{features:i,inferredGeometryType:s,finish(o){const a=n.sourceJSON.objectIdField;for(const l in o){const c=o[l],h=r.get(l);h&&(h.attributes||(h.attributes={}),c===-1?delete h.attributes[a]:h.attributes[a]=c,n._addIdToClientGraphic(h))}}}}_addIdToClientGraphic(e){if(!this._idToClientGraphic)return;const r=this.sourceJSON.objectIdField,i=e.attributes&&e.attributes[r];i!=null&&this._idToClientGraphic.set(i,e)}get _layerOrSourceGeometryType(){var e,r;return((e=this.layer)==null?void 0:e.geometryType)??((r=this.sourceJSON)==null?void 0:r.geometryType)}_requiresClientGraphicMapping(){return this._geometryTypeRequiresClientGraphicMapping(this._layerOrSourceGeometryType)}_geometryRequiresClientGraphicMapping(e){return this._geometryTypeRequiresClientGraphicMapping(e.type)}_geometryTypeRequiresClientGraphicMapping(e){return e==="mesh"||e==="multipatch"||e==="extent"}_serializeFeature(e){const{attributes:r}=e,i=this._geometryForSerialization(e),s=(eVe++).toString();return i?{uid:s,geometry:i.toJSON(),attributes:r}:{uid:s,attributes:r}}_geometryForSerialization(e){const{geometry:r}=e;return C(r)?null:this._geometryRequiresClientGraphicMapping(r)?r.extent?pp.fromExtent(r.extent):null:r}async _startWorker(e){this._connection=await Zpe("MemorySourceWorker",{strategy:de("feature-layers-workers")?"dedicated":"local",signal:e});const{fields:r,spatialReference:i,objectIdField:s,hasM:n,hasZ:o,timeInfo:a}=this.layer,l=this.layer.originOf("spatialReference")==="defaults";await this._prepareClientMapping(this.items,e);const c=this._prepareAddFeatures(this.items);this.handles.add(this.on("before-changes",m=>{MU.error("Source modifications will not propagate after layer has been loaded. Please use .applyEdits() instead"),m.preventDefault()}));const h={features:c.features,fields:r&&r.map(m=>m.toJSON()),geometryType:$K.toJSON(this._workerGeometryType),hasM:this._layerOrSourceGeometryType!=="mesh"&&n,hasZ:this._layerOrSourceGeometryType==="mesh"||o,objectIdField:s,spatialReference:l?null:i&&i.toJSON(),timeInfo:a?a.toJSON():null},p=await this._connection.invoke("load",h,{signal:e});for(const m of p.warnings)MU.warn(m.message,{layer:this.layer,warning:m});p.featureErrors.length&&MU.warn(`Encountered ${p.featureErrors.length} validation errors while loading features`,p.featureErrors);const f=p.layerDefinition;this._geometryTypeRequiresClientGraphicMapping(c.inferredGeometryType)&&(f.geometryType=$K.toJSON(c.inferredGeometryType)),this.sourceJSON=f,this._requiresClientGraphicMapping()&&(this._idToClientGraphic=new Map),c.finish(p.assignedObjectIds)}};u([rq({Type:Io,ensureType:us(Io)})],bg.prototype,"itemType",void 0),u([d()],bg.prototype,"type",void 0),u([d({constructOnly:!0})],bg.prototype,"layer",void 0),u([d({readOnly:!0})],bg.prototype,"_workerGeometryType",null),u([d()],bg.prototype,"sourceJSON",void 0),bg=u([I(d0e)],bg);function tVe(t){return"portalItem"in t}const rVe=t=>{let e=class extends t{get apiKey(){var r;return this._isOverridden("apiKey")?this._get("apiKey"):tVe(this)?(r=this.portalItem)==null?void 0:r.apiKey:null}set apiKey(r){r!=null?this._override("apiKey",r):(this._clearOverride("apiKey"),this.clear("apiKey","user"))}};return u([d({type:String})],e.prototype,"apiKey",null),e=u([I("esri.layers.mixins.APIKeyMixin")],e),e},p0e={mapserver:"MapServer",imageserver:"ImageServer",featureserver:"FeatureServer",sceneserver:"SceneServer",streamserver:"StreamServer",vectortileserver:"VectorTileServer"},f0e=Object.values(p0e),m0e=new RegExp(`^((?:https?:)?\\/\\/\\S+?\\/rest\\/services\\/(.+?)\\/(${f0e.join("|")}))(?:\\/(?:layers\\/)?(\\d+))?`,"i"),iVe=new RegExp(`^((?:https?:)?\\/\\/\\S+?\\/([^\\/\\n]+)\\/(${f0e.join("|")}))(?:\\/(?:layers\\/)?(\\d+))?`,"i"),sVe=/(.*?)\/(?:layers\/)?(\d+)\/?$/i;function pSt(t){return!!m0e.test(t)}function LE(t){if(C(t))return null;const e=sl(t),r=e.path.match(m0e)||e.path.match(iVe);if(!r)return null;const[,i,s,n,o]=r,a=s.indexOf("/");return{title:SX(a!==-1?s.slice(a+1):s),serverType:p0e[n.toLowerCase()],sublayer:o!=null&&o!==""?parseInt(o,10):null,url:{path:i}}}function nVe(t){const e=sl(t).path.match(sVe);return e?{serviceUrl:e[1],sublayerId:Number(e[2])}:null}function SX(t){return(t=t.replace(/\s*[/_]+\s*/g," "))[0].toUpperCase()+t.slice(1)}function oVe(t,e){const r=[];if(t){const i=LE(t);v(i)&&i.title&&r.push(i.title)}if(e){const i=SX(e);r.push(i)}if(r.length===2){if(r[0].toLowerCase().includes(r[1].toLowerCase()))return r[0];if(r[1].toLowerCase().includes(r[0].toLowerCase()))return r[1]}return r.join(" - ")}function g0e(t){if(!t)return!1;const e=".arcgis.com/",r="//services",i="//tiles",s="//features",n=(t=t.toLowerCase()).includes(e),o=t.includes(r)||t.includes(i)||t.includes(s);return n&&o}function aVe(t,e){return t&&she(ohe(t,e))}function lVe(t){let{url:e}=t;if(!e)return{url:e};e=ohe(e,t.logger);const r=sl(e),i=LE(r.path);let s;if(v(i))i.sublayer!=null&&t.layer.layerId==null&&(s=i.sublayer),e=i.url.path;else if(t.nonStandardUrlAllowed){const n=nVe(r.path);v(n)&&(e=n.serviceUrl,s=n.sublayerId)}return{url:she(e),layerId:s}}function cVe(t,e,r,i,s){Y_(e,i,"url",s),i.url&&t.layerId!=null&&(i.url=lw(i.url,r,t.layerId.toString()))}function fSt(t){if(!t)return!1;const e=t.toLowerCase(),r=e.includes("/services/"),i=e.includes("/mapserver/wmsserver"),s=e.includes("/imageserver/wmsserver"),n=e.includes("/wmsserver");return r&&(i||s||n)}const uVe=t=>{let e=class extends t{get title(){if(this._get("title")&&this.originOf("title")!=="defaults")return this._get("title");if(this.url){const r=LE(this.url);if(v(r)&&r.title)return r.title}return this._get("title")||""}set title(r){this._set("title",r)}set url(r){this._set("url",aVe(r,se.getLogger(this.declaredClass)))}};return u([d()],e.prototype,"title",null),u([d({type:String})],e.prototype,"url",null),e=u([I("esri.layers.mixins.ArcGISService")],e),e},ate={read:{reader:iX},write:{allowNull:!0,writer:sX}},hVe=t=>{let e=class extends t{constructor(){super(...arguments),this.blendMode="normal",this.effect=null}};return u([d({type:["average","color-burn","color-dodge","color","darken","destination-atop","destination-in","destination-out","destination-over","difference","exclusion","hard-light","hue","invert","lighten","lighter","luminosity","minus","multiply","normal","overlay","plus","reflect","saturation","screen","soft-light","source-atop","source-in","source-out","vivid-light","xor"],nonNullable:!0,json:{read:!1,write:!1,origins:{"web-map":{read:!0,write:!0},"portal-item":{read:!0,write:!0}}}})],e.prototype,"blendMode",void 0),u([d({json:{read:!1,write:!1,origins:{"web-map":ate,"portal-item":ate}}})],e.prototype,"effect",void 0),e=u([I("esri.layers.mixins.BlendLayer")],e),e},dVe=t=>{let e=class extends t{constructor(){super(...arguments),this.customParameters=null}};return u([d({type:Object,json:{write:{overridePolicy:r=>({enabled:!!(r&&Object.keys(r).length>0)})}}})],e.prototype,"customParameters",void 0),e=u([I("esri.layers.mixins.CustomParametersMixin")],e),e},pVe=new vs.EventEmitter,y0e="esri.layers.mixins.EditBusLayer",_0e=Symbol(y0e);function mSt(t){return t!=null&&typeof t=="object"&&_0e in t}const fVe=t=>{var e;let r=class extends t{constructor(...i){super(...i),this[e]=!0,this.when().then(()=>{this.own([pVe.on("edits",s=>{var h,p,f;const n="layer"in s?s.layer:null,o="layer"in s?(h=s.layer)==null?void 0:h.url:s.serviceUrl,a="layer"in s?(p=s.layer)==null?void 0:p.layerId:s.layerId,l=s.event;if(n===this||o!==this.url)return;if(a!=null&&this.layerId!=null&&a===this.layerId)return void this.emit("edits",ne(l));const c=(f=l.editedFeatures)==null?void 0:f.find(({layerId:m})=>m===this.layerId);if(c){const{adds:m,updates:y,deletes:_}=c.editedFeatures,b={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:m?m.map(({attributes:x})=>({objectId:this.objectIdField&&x[this.objectIdField],globalId:this.globalIdField&&x[this.globalIdField]})):[],deletedFeatures:_?_.map(({attributes:x})=>({objectId:this.objectIdField&&x[this.objectIdField],globalId:this.globalIdField&&x[this.globalIdField]})):[],updatedFeatures:y?y.map(({current:{attributes:x}})=>({objectId:this.objectIdField&&x[this.objectIdField],globalId:this.globalIdField&&x[this.globalIdField]})):[],editedFeatures:ne(l.editedFeatures),exceededTransferLimit:!1};this.emit("edits",b)}})])},()=>{})}};return e=_0e,r=u([I(y0e)],r),r};var I7;const PU=new mr({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),IU=new mr({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let af=I7=class extends ve{constructor(t){super(t),this.where=null,this.geometry=null,this.spatialRelationship="intersects",this.distance=void 0,this.objectIds=null,this.units=null,this.timeExtent=null}createQuery(t={}){const{where:e,geometry:r,spatialRelationship:i,timeExtent:s,objectIds:n,units:o,distance:a}=this;return new Yf({geometry:ne(r),objectIds:ne(n),spatialRelationship:i,timeExtent:ne(s),where:e,units:o,distance:a,...t})}clone(){const{where:t,geometry:e,spatialRelationship:r,timeExtent:i,objectIds:s,units:n,distance:o}=this;return new I7({geometry:ne(e),objectIds:ne(s),spatialRelationship:r,timeExtent:ne(i),where:t,units:n,distance:o})}};u([d({type:String,json:{write:!0}})],af.prototype,"where",void 0),u([d({types:jw,json:{write:!0}})],af.prototype,"geometry",void 0),u([d({type:PU.apiValues,json:{name:"spatialRel",read:{reader:PU.read},write:{allowNull:!1,writer:PU.write,overridePolicy(){return{enabled:v(this.geometry)}}}}})],af.prototype,"spatialRelationship",void 0),u([d({type:Number,json:{write:{overridePolicy(t){return{enabled:t!=null&&this.geometry!=null}}}}})],af.prototype,"distance",void 0),u([d({type:[Number],json:{write:!0}})],af.prototype,"objectIds",void 0),u([d({type:IU.apiValues,json:{read:IU.read,write:{writer:IU.write,overridePolicy(t){return{enabled:t!=null&&this.geometry!=null}}}}})],af.prototype,"units",void 0),u([d({type:_m,json:{write:!0}})],af.prototype,"timeExtent",void 0),af=I7=u([I("esri.layers.support.FeatureFilter")],af);const mVe=af;var $7;const lte={read:{reader:iX},write:{writer:sX,overridePolicy(){return{allowNull:this.excludedEffect!=null,isRequired:this.excludedEffect==null}}}},cte={read:{reader:iX},write:{writer:sX,overridePolicy(){return{allowNull:this.includedEffect!=null,isRequired:this.includedEffect==null}}}},ute={name:"showExcludedLabels",default:!0};let j1=$7=class extends ve{constructor(t){super(t),this.filter=null,this.includedEffect=null,this.excludedEffect=null,this.excludedLabelsVisible=!1}write(t,e){var i,s;const r=super.write(t,e);if(e!=null&&e.origin){if(r.filter){const n=Object.keys(r.filter);if(n.length>1||n[0]!=="where")return(i=e.messages)==null||i.push(new q("web-document-write:unsupported-feature-effect","Invalid feature effect 'filter'. A filter can only contain a 'where' property",{layer:e.layer,effect:this})),null}if("showExcludedLabels"in r)return(s=e.messages)==null||s.push(new q("web-document-write:unsupported-feature-effect","Invalid value for property 'excludedLabelsVisible' which should always be 'true'",{layer:e.layer,effect:this})),null}return r}clone(){return new $7({filter:v(this.filter)?this.filter.clone():null,includedEffect:this.includedEffect,excludedEffect:this.excludedEffect,excludedLabelsVisible:this.excludedLabelsVisible})}};u([d({type:mVe,json:{write:{allowNull:!0,writer(t,e,r,i){const s=t==null?void 0:t.write({},i);s&&Object.keys(s).length!==0?el(r,s,e):el(r,null,e)}}}})],j1.prototype,"filter",void 0),u([d({json:{write:!0,origins:{"web-map":lte,"portal-item":lte}}})],j1.prototype,"includedEffect",void 0),u([d({json:{write:!0,origins:{"web-map":cte,"portal-item":cte}}})],j1.prototype,"excludedEffect",void 0),u([d({type:Boolean,json:{write:!0,name:"showExcludedLabels",origins:{"web-map":ute,"portal-item":ute}}})],j1.prototype,"excludedLabelsVisible",void 0),j1=$7=u([I("esri.layers.support.FeatureEffect")],j1);const gVe=j1,hte={write:{allowNull:!0}},yVe=t=>{let e=class extends t{constructor(){super(...arguments),this.featureEffect=null}};return u([d({type:gVe,json:{origins:{"web-map":hte,"portal-item":hte}}})],e.prototype,"featureEffect",void 0),e=u([I("esri.layers.mixins.FeatureEffectLayer")],e),e};function _Ve(t){if(!t)return t;const{start:e,end:r}=t;return new _m({start:v(e)?Zb(e,-e.getTimezoneOffset(),"minutes"):e,end:v(r)?Zb(r,-r.getTimezoneOffset(),"minutes"):r})}function vVe(t){if(!t)return t;const{start:e,end:r}=t;return new _m({start:v(e)?Zb(e,e.getTimezoneOffset(),"minutes"):e,end:v(r)?Zb(r,r.getTimezoneOffset(),"minutes"):r})}var L7;let WA=L7=class extends ve{constructor(t){super(t)}async collectRequiredFields(t,e){return Hl(t,e,this.expression)}clone(){return new L7({expression:this.expression,title:this.title})}equals(t){return this.expression===t.expression&&this.title===t.title}};u([d({type:String,json:{write:!0}})],WA.prototype,"expression",void 0),u([d({type:String,json:{write:!0}})],WA.prototype,"title",void 0),WA=L7=u([I("esri.layers.support.FeatureExpressionInfo")],WA);const dte=WA;function bVe(t){return!!t&&GS[t]!=null}function wVe(t){return 1/(GS[t]||1)}function xVe(){const t=Object.keys(GS);return t.sort(),t}const TVe=xVe();var D7;const PP=Ta()({onTheGround:"on-the-ground",relativeToGround:"relative-to-ground",relativeToScene:"relative-to-scene",absoluteHeight:"absolute-height"}),pte=new mr({foot:"feet",kilometer:"kilometers",meter:"meters",mile:"miles","us-foot":"us-feet",yard:"yards"});let ag=D7=class extends ve{constructor(t){super(t),this.offset=null}readFeatureExpressionInfo(t,e){return t??(e.featureExpression&&e.featureExpression.value===0?{expression:"0"}:void 0)}writeFeatureExpressionInfo(t,e,r,i){e[r]=t.write({},i),t.expression==="0"&&(e.featureExpression={value:0})}get mode(){const{offset:t,featureExpressionInfo:e}=this;return this._isOverridden("mode")?this._get("mode"):v(t)||e?"relative-to-ground":"on-the-ground"}set mode(t){this._override("mode",t)}set unit(t){this._set("unit",t)}write(t,e){return this.offset||this.mode||this.featureExpressionInfo||this.unit?super.write(t,e):null}clone(){return new D7({mode:this.mode,offset:this.offset,featureExpressionInfo:this.featureExpressionInfo?this.featureExpressionInfo.clone():void 0,unit:this.unit})}equals(t){return this.mode===t.mode&&this.offset===t.offset&&this.unit===t.unit&&dAe(this.featureExpressionInfo,t.featureExpressionInfo)}};u([d({type:dte,json:{write:!0}})],ag.prototype,"featureExpressionInfo",void 0),u([Fe("featureExpressionInfo",["featureExpressionInfo","featureExpression"])],ag.prototype,"readFeatureExpressionInfo",null),u([He("featureExpressionInfo",{featureExpressionInfo:{type:dte},"featureExpression.value":{type:[0]}})],ag.prototype,"writeFeatureExpressionInfo",null),u([d({type:PP.apiValues,nonNullable:!0,json:{type:PP.jsonValues,read:PP.read,write:{writer:PP.write,isRequired:!0}}})],ag.prototype,"mode",null),u([d({type:Number,json:{write:!0}})],ag.prototype,"offset",void 0),u([d({type:TVe,json:{type:String,read:pte.read,write:pte.write}})],ag.prototype,"unit",null),ag=D7=u([I("esri.layers.support.ElevationInfo")],ag);const SVe=ag,EVe={type:Boolean,value:!0,json:{origins:{service:{read:!1,write:!1},"web-map":{read:!1,write:!1}},name:"screenSizePerspective",write:!0}},EX={type:Boolean,value:!0,json:{name:"disablePopup",read:{reader:(t,e)=>!e.disablePopup},write:{enabled:!0,writer(t,e,r){e[r]=!t}}}},CX={type:Boolean,value:!0,nonNullable:!0,json:{name:"showLabels",write:!0}},CVe={type:String,json:{origins:{"portal-item":{write:!1}},write:{isRequired:!0,ignoreOrigin:!0,writer:Y_}}},AVe={type:Boolean,value:!0,nonNullable:!0,json:{origins:{service:{read:{enabled:!1}}},name:"showLegend",write:!0}},RVe={value:null,type:SVe,json:{origins:{service:{name:"elevationInfo",write:!0}},name:"layerDefinition.elevationInfo",write:!0}};function gSt(t){return{type:t,readOnly:!0,json:{origins:{service:{read:!0}},read:!1}}}const v0e={write:!0,read:!0},N7={type:Number,json:{origins:{"web-document":v0e,"portal-item":{write:!0}}}},OVe={...N7,json:{...N7.json,origins:{"web-document":{...v0e,write:{enabled:!0,target:{opacity:{type:Number},"layerDefinition.drawingInfo.transparency":{type:Number}}}}},read:{source:["layerDefinition.drawingInfo.transparency","drawingInfo.transparency"],reader:(t,e,r)=>r&&r.origin!=="service"||!e.drawingInfo||e.drawingInfo.transparency===void 0?e.layerDefinition&&e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.transparency!==void 0?kR(e.layerDefinition.drawingInfo.transparency):void 0:kR(e.drawingInfo.transparency)}}},ySt={type:_m,readOnly:!0,get(){var a,l;if(!((a=this.layer)!=null&&a.timeInfo))return null;const{datesInUnknownTimezone:t,timeOffset:e,useViewTime:r}=this.layer,i=(l=this.view)==null?void 0:l.timeExtent;let s=this.layer.timeExtent;t&&(s=vVe(s));let n=r?i&&s?i.intersection(s):i||s:s;if(!n||n.isEmpty||n.isAllTime)return n;e&&(n=n.offset(-e.value,e.unit)),t&&(n=_Ve(n));const o=this._get("timeExtent");return n.equals(o)?o:n}},_St={type:Zr,readOnly:!0,json:{origins:{service:{read:{source:["fullExtent","spatialReference"],reader:(t,e)=>{const r=Zr.fromJSON(t);return e.spatialReference!=null&&typeof e.spatialReference=="object"&&(r.spatialReference=et.fromJSON(e.spatialReference)),r}}}},read:!1}},MVe={type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}}}},PVe={type:Number,json:{origins:{service:{write:{enabled:!1}}},read:{source:"layerDefinition.minScale"},write:{target:"layerDefinition.minScale"}}},IVe={type:Number,json:{origins:{service:{write:{enabled:!1}}},read:{source:"layerDefinition.maxScale"},write:{target:"layerDefinition.maxScale"}}},b0e={json:{write:{ignoreOrigin:!0},origins:{"web-map":{read:!1,write:!1}}}},fte=new Map([["AUS Central Standard Time","Australia/Darwin"],["AUS Eastern Standard Time","Australia/Sydney"],["Afghanistan Standard Time","Asia/Kabul"],["Alaskan Standard Time","America/Anchorage"],["Aleutian Standard Time","America/Adak"],["Altai Standard Time","Asia/Barnaul"],["Arab Standard Time","Asia/Riyadh"],["Arabian Standard Time","Asia/Dubai"],["Arabic Standard Time","Asia/Baghdad"],["Argentina Standard Time","America/Buenos_Aires"],["Astrakhan Standard Time","Europe/Astrakhan"],["Atlantic Standard Time","America/Halifax"],["Aus Central W. Standard Time","Australia/Eucla"],["Azerbaijan Standard Time","Asia/Baku"],["Azores Standard Time","Atlantic/Azores"],["Bahia Standard Time","America/Bahia"],["Bangladesh Standard Time","Asia/Dhaka"],["Belarus Standard Time","Europe/Minsk"],["Bougainville Standard Time","Pacific/Bougainville"],["Canada Central Standard Time","America/Regina"],["Cape Verde Standard Time","Atlantic/Cape_Verde"],["Caucasus Standard Time","Asia/Yerevan"],["Cen. Australia Standard Time","Australia/Adelaide"],["Central America Standard Time","America/Guatemala"],["Central Asia Standard Time","Asia/Almaty"],["Central Brazilian Standard Time","America/Cuiaba"],["Central Europe Standard Time","Europe/Budapest"],["Central European Standard Time","Europe/Warsaw"],["Central Pacific Standard Time","Pacific/Guadalcanal"],["Central Standard Time","America/Chicago"],["Central Standard Time (Mexico)","America/Mexico_City"],["Chatham Islands Standard Time","Pacific/Chatham"],["China Standard Time","Asia/Shanghai"],["Cuba Standard Time","America/Havana"],["Dateline Standard Time","Etc/GMT+12"],["E. Africa Standard Time","Africa/Nairobi"],["E. Australia Standard Time","Australia/Brisbane"],["E. Europe Standard Time","Europe/Chisinau"],["E. South America Standard Time","America/Sao_Paulo"],["Easter Island Standard Time","Pacific/Easter"],["Eastern Standard Time","America/New_York"],["Eastern Standard Time (Mexico)","America/Cancun"],["Egypt Standard Time","Africa/Cairo"],["Ekaterinburg Standard Time","Asia/Yekaterinburg"],["FLE Standard Time","Europe/Kiev"],["Fiji Standard Time","Pacific/Fiji"],["GMT Standard Time","Europe/London"],["GTB Standard Time","Europe/Bucharest"],["Georgian Standard Time","Asia/Tbilisi"],["Greenland Standard Time","America/Godthab"],["Greenwich Standard Time","Atlantic/Reykjavik"],["Haiti Standard Time","America/Port-au-Prince"],["Hawaiian Standard Time","Pacific/Honolulu"],["India Standard Time","Asia/Calcutta"],["Iran Standard Time","Asia/Tehran"],["Israel Standard Time","Asia/Jerusalem"],["Jordan Standard Time","Asia/Amman"],["Kaliningrad Standard Time","Europe/Kaliningrad"],["Korea Standard Time","Asia/Seoul"],["Libya Standard Time","Africa/Tripoli"],["Line Islands Standard Time","Pacific/Kiritimati"],["Lord Howe Standard Time","Australia/Lord_Howe"],["Magadan Standard Time","Asia/Magadan"],["Magallanes Standard Time","America/Punta_Arenas"],["Marquesas Standard Time","Pacific/Marquesas"],["Mauritius Standard Time","Indian/Mauritius"],["Middle East Standard Time","Asia/Beirut"],["Montevideo Standard Time","America/Montevideo"],["Morocco Standard Time","Africa/Casablanca"],["Mountain Standard Time","America/Denver"],["Mountain Standard Time (Mexico)","America/Chihuahua"],["Myanmar Standard Time","Asia/Rangoon"],["N. Central Asia Standard Time","Asia/Novosibirsk"],["Namibia Standard Time","Africa/Windhoek"],["Nepal Standard Time","Asia/Katmandu"],["New Zealand Standard Time","Pacific/Auckland"],["Newfoundland Standard Time","America/St_Johns"],["Norfolk Standard Time","Pacific/Norfolk"],["North Asia East Standard Time","Asia/Irkutsk"],["North Asia Standard Time","Asia/Krasnoyarsk"],["North Korea Standard Time","Asia/Pyongyang"],["Omsk Standard Time","Asia/Omsk"],["Pacific SA Standard Time","America/Santiago"],["Pacific Standard Time","America/Los_Angeles"],["Pacific Standard Time (Mexico)","America/Tijuana"],["Pakistan Standard Time","Asia/Karachi"],["Paraguay Standard Time","America/Asuncion"],["Qyzylorda Standard Time","Asia/Qyzylorda"],["Romance Standard Time","Europe/Paris"],["Russia Time Zone 10","Asia/Srednekolymsk"],["Russia Time Zone 11","Asia/Kamchatka"],["Russia Time Zone 3","Europe/Samara"],["Russian Standard Time","Europe/Moscow"],["SA Eastern Standard Time","America/Cayenne"],["SA Pacific Standard Time","America/Bogota"],["SA Western Standard Time","America/La_Paz"],["SE Asia Standard Time","Asia/Bangkok"],["Saint Pierre Standard Time","America/Miquelon"],["Sakhalin Standard Time","Asia/Sakhalin"],["Samoa Standard Time","Pacific/Apia"],["Sao Tome Standard Time","Africa/Sao_Tome"],["Saratov Standard Time","Europe/Saratov"],["Singapore Standard Time","Asia/Singapore"],["South Africa Standard Time","Africa/Johannesburg"],["South Sudan Standard Time","Africa/Juba"],["Sri Lanka Standard Time","Asia/Colombo"],["Sudan Standard Time","Africa/Khartoum"],["Syria Standard Time","Asia/Damascus"],["Taipei Standard Time","Asia/Taipei"],["Tasmania Standard Time","Australia/Hobart"],["Tocantins Standard Time","America/Araguaina"],["Tokyo Standard Time","Asia/Tokyo"],["Tomsk Standard Time","Asia/Tomsk"],["Tonga Standard Time","Pacific/Tongatapu"],["Transbaikal Standard Time","Asia/Chita"],["Turkey Standard Time","Europe/Istanbul"],["Turks And Caicos Standard Time","America/Grand_Turk"],["US Eastern Standard Time","America/Indianapolis"],["US Mountain Standard Time","America/Phoenix"],["UTC","Etc/GMT"],["UTC+01","Etc/GMT-1"],["UTC+02","Etc/GMT-2"],["UTC+03","Etc/GMT-3"],["UTC+04","Etc/GMT-4"],["UTC+05","Etc/GMT-5"],["UTC+06","Etc/GMT-6"],["UTC+07","Etc/GMT-7"],["UTC+08","Etc/GMT-8"],["UTC+09","Etc/GMT-9"],["UTC+10","Etc/GMT-10"],["UTC+11","Etc/GMT-11"],["UTC+12","Etc/GMT-12"],["UTC+13","Etc/GMT-13"],["UTC+14","Etc/GMT-14"],["UTC-01","Etc/GMT+1"],["UTC-02","Etc/GMT+2"],["UTC-03","Etc/GMT+3"],["UTC-04","Etc/GMT+4"],["UTC-05","Etc/GMT+5"],["UTC-06","Etc/GMT+6"],["UTC-07","Etc/GMT+7"],["UTC-08","Etc/GMT+8"],["UTC-09","Etc/GMT+9"],["UTC-10","Etc/GMT+10"],["UTC-11","Etc/GMT+11"],["UTC-12","Etc/GMT+12"],["Ulaanbaatar Standard Time","Asia/Ulaanbaatar"],["Venezuela Standard Time","America/Caracas"],["Vladivostok Standard Time","Asia/Vladivostok"],["Volgograd Standard Time","Europe/Volgograd"],["W. Australia Standard Time","Australia/Perth"],["W. Central Africa Standard Time","Africa/Lagos"],["W. Europe Standard Time","Europe/Berlin"],["W. Mongolia Standard Time","Asia/Hovd"],["West Asia Standard Time","Asia/Tashkent"],["West Bank Standard Time","Asia/Hebron"],["West Pacific Standard Time","Pacific/Port_Moresby"],["Yakutsk Standard Time","Asia/Yakutsk"],["Yukon Standard Time","America/Whitehorse"]]);class Qw extends Error{}class $Ve extends Qw{constructor(e){super(`Invalid DateTime: ${e.toMessage()}`)}}class LVe extends Qw{constructor(e){super(`Invalid Interval: ${e.toMessage()}`)}}class DVe extends Qw{constructor(e){super(`Invalid Duration: ${e.toMessage()}`)}}class XA extends Qw{}class w0e extends Qw{constructor(e){super(`Invalid unit ${e}`)}}class wh extends Qw{}class Uy extends Qw{constructor(){super("Zone is an abstract class")}}const rt="numeric",vp="short",Mu="long",VN={year:rt,month:rt,day:rt},x0e={year:rt,month:vp,day:rt},NVe={year:rt,month:vp,day:rt,weekday:vp},T0e={year:rt,month:Mu,day:rt},S0e={year:rt,month:Mu,day:rt,weekday:Mu},E0e={hour:rt,minute:rt},C0e={hour:rt,minute:rt,second:rt},A0e={hour:rt,minute:rt,second:rt,timeZoneName:vp},R0e={hour:rt,minute:rt,second:rt,timeZoneName:Mu},O0e={hour:rt,minute:rt,hourCycle:"h23"},M0e={hour:rt,minute:rt,second:rt,hourCycle:"h23"},P0e={hour:rt,minute:rt,second:rt,hourCycle:"h23",timeZoneName:vp},I0e={hour:rt,minute:rt,second:rt,hourCycle:"h23",timeZoneName:Mu},$0e={year:rt,month:rt,day:rt,hour:rt,minute:rt},L0e={year:rt,month:rt,day:rt,hour:rt,minute:rt,second:rt},D0e={year:rt,month:vp,day:rt,hour:rt,minute:rt},N0e={year:rt,month:vp,day:rt,hour:rt,minute:rt,second:rt},FVe={year:rt,month:vp,day:rt,weekday:vp,hour:rt,minute:rt},F0e={year:rt,month:Mu,day:rt,hour:rt,minute:rt,timeZoneName:vp},U0e={year:rt,month:Mu,day:rt,hour:rt,minute:rt,second:rt,timeZoneName:vp},k0e={year:rt,month:Mu,day:rt,weekday:Mu,hour:rt,minute:rt,timeZoneName:Mu},V0e={year:rt,month:Mu,day:rt,weekday:Mu,hour:rt,minute:rt,second:rt,timeZoneName:Mu};class vM{get type(){throw new Uy}get name(){throw new Uy}get ianaName(){return this.name}get isUniversal(){throw new Uy}offsetName(e,r){throw new Uy}formatOffset(e,r){throw new Uy}offset(e){throw new Uy}equals(e){throw new Uy}get isValid(){throw new Uy}}let $U=null;class n5 extends vM{static get instance(){return $U===null&&($U=new n5),$U}get type(){return"system"}get name(){return new Intl.DateTimeFormat().resolvedOptions().timeZone}get isUniversal(){return!1}offsetName(e,{format:r,locale:i}){return z0e(e,r,i)}formatOffset(e,r){return sR(this.offset(e),r)}offset(e){return-new Date(e).getTimezoneOffset()}equals(e){return e.type==="system"}get isValid(){return!0}}let GL={};function UVe(t){return GL[t]||(GL[t]=new Intl.DateTimeFormat("en-US",{hour12:!1,timeZone:t,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",era:"short"})),GL[t]}const kVe={year:0,month:1,day:2,era:3,hour:4,minute:5,second:6};function VVe(t,e){const r=t.format(e).replace(/\u200E/g,""),i=/(\d+)\/(\d+)\/(\d+) (AD|BC),? (\d+):(\d+):(\d+)/.exec(r),[,s,n,o,a,l,c,h]=i;return[o,s,n,a,l,c,h]}function BVe(t,e){const r=t.formatToParts(e),i=[];for(let s=0;s<r.length;s++){const{type:n,value:o}=r[s],a=kVe[n];n==="era"?i[a]=o:mi(a)||(i[a]=parseInt(o,10))}return i}let IP={};class ey extends vM{static create(e){return IP[e]||(IP[e]=new ey(e)),IP[e]}static resetCache(){IP={},GL={}}static isValidSpecifier(e){return this.isValidZone(e)}static isValidZone(e){if(!e)return!1;try{return new Intl.DateTimeFormat("en-US",{timeZone:e}).format(),!0}catch{return!1}}constructor(e){super(),this.zoneName=e,this.valid=ey.isValidZone(e)}get type(){return"iana"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(e,{format:r,locale:i}){return z0e(e,r,i,this.name)}formatOffset(e,r){return sR(this.offset(e),r)}offset(e){const r=new Date(e);if(isNaN(r))return NaN;const i=UVe(this.name);let[s,n,o,a,l,c,h]=i.formatToParts?BVe(i,r):VVe(i,r);a==="BC"&&(s=-Math.abs(s)+1);const f=OX({year:s,month:n,day:o,hour:l===24?0:l,minute:c,second:h,millisecond:0});let m=+r;const y=m%1e3;return m-=y>=0?y:1e3+y,(f-m)/(60*1e3)}equals(e){return e.type==="iana"&&e.name===this.name}get isValid(){return this.valid}}let mte={};function zVe(t,e={}){const r=JSON.stringify([t,e]);let i=mte[r];return i||(i=new Intl.ListFormat(t,e),mte[r]=i),i}let F7={};function U7(t,e={}){const r=JSON.stringify([t,e]);let i=F7[r];return i||(i=new Intl.DateTimeFormat(t,e),F7[r]=i),i}let k7={};function GVe(t,e={}){const r=JSON.stringify([t,e]);let i=k7[r];return i||(i=new Intl.NumberFormat(t,e),k7[r]=i),i}let V7={};function jVe(t,e={}){const{base:r,...i}=e,s=JSON.stringify([t,i]);let n=V7[s];return n||(n=new Intl.RelativeTimeFormat(t,e),V7[s]=n),n}let YA=null;function HVe(){return YA||(YA=new Intl.DateTimeFormat().resolvedOptions().locale,YA)}function qVe(t){const e=t.indexOf("-x-");e!==-1&&(t=t.substring(0,e));const r=t.indexOf("-u-");if(r===-1)return[t];{let i,s;try{i=U7(t).resolvedOptions(),s=t}catch{const l=t.substring(0,r);i=U7(l).resolvedOptions(),s=l}const{numberingSystem:n,calendar:o}=i;return[s,n,o]}}function WVe(t,e,r){return(r||e)&&(t.includes("-u-")||(t+="-u"),r&&(t+=`-ca-${r}`),e&&(t+=`-nu-${e}`)),t}function XVe(t){const e=[];for(let r=1;r<=12;r++){const i=Ar.utc(2016,r,1);e.push(t(i))}return e}function YVe(t){const e=[];for(let r=1;r<=7;r++){const i=Ar.utc(2016,11,13+r);e.push(t(i))}return e}function $P(t,e,r,i,s){const n=t.listingMode(r);return n==="error"?null:n==="en"?i(e):s(e)}function ZVe(t){return t.numberingSystem&&t.numberingSystem!=="latn"?!1:t.numberingSystem==="latn"||!t.locale||t.locale.startsWith("en")||new Intl.DateTimeFormat(t.intl).resolvedOptions().numberingSystem==="latn"}class JVe{constructor(e,r,i){this.padTo=i.padTo||0,this.floor=i.floor||!1;const{padTo:s,floor:n,...o}=i;if(!r||Object.keys(o).length>0){const a={useGrouping:!1,...i};i.padTo>0&&(a.minimumIntegerDigits=i.padTo),this.inf=GVe(e,a)}}format(e){if(this.inf){const r=this.floor?Math.floor(e):e;return this.inf.format(r)}else{const r=this.floor?Math.floor(e):RX(e,3);return Qn(r,this.padTo)}}}class KVe{constructor(e,r,i){this.opts=i;let s;if(e.zone.isUniversal){const o=-1*(e.offset/60),a=o>=0?`Etc/GMT+${o}`:`Etc/GMT${o}`;e.offset!==0&&ey.create(a).valid?(s=a,this.dt=e):(s="UTC",i.timeZoneName?this.dt=e:this.dt=e.offset===0?e:Ar.fromMillis(e.ts+e.offset*60*1e3))}else e.zone.type==="system"?this.dt=e:(this.dt=e,s=e.zone.name);const n={...this.opts};n.timeZone=n.timeZone||s,this.dtf=U7(r,n)}format(){return this.dtf.format(this.dt.toJSDate())}formatToParts(){return this.dtf.formatToParts(this.dt.toJSDate())}resolvedOptions(){return this.dtf.resolvedOptions()}}class QVe{constructor(e,r,i){this.opts={style:"long",...i},!r&&B0e()&&(this.rtf=jVe(e,i))}format(e,r){return this.rtf?this.rtf.format(e,r):gBe(r,e,this.opts.numeric,this.opts.style!=="long")}formatToParts(e,r){return this.rtf?this.rtf.formatToParts(e,r):[]}}class zs{static fromOpts(e){return zs.create(e.locale,e.numberingSystem,e.outputCalendar,e.defaultToEN)}static create(e,r,i,s=!1){const n=e||Jn.defaultLocale,o=n||(s?"en-US":HVe()),a=r||Jn.defaultNumberingSystem,l=i||Jn.defaultOutputCalendar;return new zs(o,a,l,n)}static resetCache(){YA=null,F7={},k7={},V7={}}static fromObject({locale:e,numberingSystem:r,outputCalendar:i}={}){return zs.create(e,r,i)}constructor(e,r,i,s){const[n,o,a]=qVe(e);this.locale=n,this.numberingSystem=r||o||null,this.outputCalendar=i||a||null,this.intl=WVe(this.locale,this.numberingSystem,this.outputCalendar),this.weekdaysCache={format:{},standalone:{}},this.monthsCache={format:{},standalone:{}},this.meridiemCache=null,this.eraCache={},this.specifiedLocale=s,this.fastNumbersCached=null}get fastNumbers(){return this.fastNumbersCached==null&&(this.fastNumbersCached=ZVe(this)),this.fastNumbersCached}listingMode(){const e=this.isEnglish(),r=(this.numberingSystem===null||this.numberingSystem==="latn")&&(this.outputCalendar===null||this.outputCalendar==="gregory");return e&&r?"en":"intl"}clone(e){return!e||Object.getOwnPropertyNames(e).length===0?this:zs.create(e.locale||this.specifiedLocale,e.numberingSystem||this.numberingSystem,e.outputCalendar||this.outputCalendar,e.defaultToEN||!1)}redefaultToEN(e={}){return this.clone({...e,defaultToEN:!0})}redefaultToSystem(e={}){return this.clone({...e,defaultToEN:!1})}months(e,r=!1,i=!0){return $P(this,e,i,H0e,()=>{const s=r?{month:e,day:"numeric"}:{month:e},n=r?"format":"standalone";return this.monthsCache[n][e]||(this.monthsCache[n][e]=XVe(o=>this.extract(o,s,"month"))),this.monthsCache[n][e]})}weekdays(e,r=!1,i=!0){return $P(this,e,i,X0e,()=>{const s=r?{weekday:e,year:"numeric",month:"long",day:"numeric"}:{weekday:e},n=r?"format":"standalone";return this.weekdaysCache[n][e]||(this.weekdaysCache[n][e]=YVe(o=>this.extract(o,s,"weekday"))),this.weekdaysCache[n][e]})}meridiems(e=!0){return $P(this,void 0,e,()=>Y0e,()=>{if(!this.meridiemCache){const r={hour:"numeric",hourCycle:"h12"};this.meridiemCache=[Ar.utc(2016,11,13,9),Ar.utc(2016,11,13,19)].map(i=>this.extract(i,r,"dayperiod"))}return this.meridiemCache})}eras(e,r=!0){return $P(this,e,r,Z0e,()=>{const i={era:e};return this.eraCache[e]||(this.eraCache[e]=[Ar.utc(-40,1,1),Ar.utc(2017,1,1)].map(s=>this.extract(s,i,"era"))),this.eraCache[e]})}extract(e,r,i){const s=this.dtFormatter(e,r),n=s.formatToParts(),o=n.find(a=>a.type.toLowerCase()===i);return o?o.value:null}numberFormatter(e={}){return new JVe(this.intl,e.forceSimple||this.fastNumbers,e)}dtFormatter(e,r={}){return new KVe(e,this.intl,r)}relFormatter(e={}){return new QVe(this.intl,this.isEnglish(),e)}listFormatter(e={}){return zVe(this.intl,e)}isEnglish(){return this.locale==="en"||this.locale.toLowerCase()==="en-us"||new Intl.DateTimeFormat(this.intl).resolvedOptions().locale.startsWith("en-us")}equals(e){return this.locale===e.locale&&this.numberingSystem===e.numberingSystem&&this.outputCalendar===e.outputCalendar}}let LU=null;class Za extends vM{static get utcInstance(){return LU===null&&(LU=new Za(0)),LU}static instance(e){return e===0?Za.utcInstance:new Za(e)}static parseSpecifier(e){if(e){const r=e.match(/^utc(?:([+-]\d{1,2})(?::(\d{2}))?)?$/i);if(r)return new Za(a5(r[1],r[2]))}return null}constructor(e){super(),this.fixed=e}get type(){return"fixed"}get name(){return this.fixed===0?"UTC":`UTC${sR(this.fixed,"narrow")}`}get ianaName(){return this.fixed===0?"Etc/UTC":`Etc/GMT${sR(-this.fixed,"narrow")}`}offsetName(){return this.name}formatOffset(e,r){return sR(this.fixed,r)}get isUniversal(){return!0}offset(){return this.fixed}equals(e){return e.type==="fixed"&&e.fixed===this.fixed}get isValid(){return!0}}class eBe extends vM{constructor(e){super(),this.zoneName=e}get type(){return"invalid"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(){return null}formatOffset(){return""}offset(){return NaN}equals(){return!1}get isValid(){return!1}}function a_(t,e){if(mi(t)||t===null)return e;if(t instanceof vM)return t;if(tBe(t)){const r=t.toLowerCase();return r==="default"?e:r==="local"||r==="system"?n5.instance:r==="utc"||r==="gmt"?Za.utcInstance:Za.parseSpecifier(r)||ey.create(t)}else return Jb(t)?Za.instance(t):typeof t=="object"&&t.offset&&typeof t.offset=="number"?t:new eBe(t)}let gte=()=>Date.now(),yte="system",_te=null,vte=null,bte=null,wte=60,xte;class Jn{static get now(){return gte}static set now(e){gte=e}static set defaultZone(e){yte=e}static get defaultZone(){return a_(yte,n5.instance)}static get defaultLocale(){return _te}static set defaultLocale(e){_te=e}static get defaultNumberingSystem(){return vte}static set defaultNumberingSystem(e){vte=e}static get defaultOutputCalendar(){return bte}static set defaultOutputCalendar(e){bte=e}static get twoDigitCutoffYear(){return wte}static set twoDigitCutoffYear(e){wte=e%100}static get throwOnInvalid(){return xte}static set throwOnInvalid(e){xte=e}static resetCaches(){zs.resetCache(),ey.resetCache()}}function mi(t){return typeof t>"u"}function Jb(t){return typeof t=="number"}function o5(t){return typeof t=="number"&&t%1===0}function tBe(t){return typeof t=="string"}function rBe(t){return Object.prototype.toString.call(t)==="[object Date]"}function B0e(){try{return typeof Intl<"u"&&!!Intl.RelativeTimeFormat}catch{return!1}}function iBe(t){return Array.isArray(t)?t:[t]}function Tte(t,e,r){if(t.length!==0)return t.reduce((i,s)=>{const n=[e(s),s];return i&&r(i[0],n[0])===i[0]?i:n},null)[1]}function sBe(t,e){return e.reduce((r,i)=>(r[i]=t[i],r),{})}function qS(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function Lg(t,e,r){return o5(t)&&t>=e&&t<=r}function nBe(t,e){return t-e*Math.floor(t/e)}function Qn(t,e=2){const r=t<0;let i;return r?i="-"+(""+-t).padStart(e,"0"):i=(""+t).padStart(e,"0"),i}function Q0(t){if(!(mi(t)||t===null||t===""))return parseInt(t,10)}function Ov(t){if(!(mi(t)||t===null||t===""))return parseFloat(t)}function AX(t){if(!(mi(t)||t===null||t==="")){const e=parseFloat("0."+t)*1e3;return Math.floor(e)}}function RX(t,e,r=!1){const i=10**e;return(r?Math.trunc:Math.round)(t*i)/i}function bM(t){return t%4===0&&(t%100!==0||t%400===0)}function iR(t){return bM(t)?366:365}function BN(t,e){const r=nBe(e-1,12)+1,i=t+(e-r)/12;return r===2?bM(i)?29:28:[31,null,31,30,31,30,31,31,30,31,30,31][r-1]}function OX(t){let e=Date.UTC(t.year,t.month-1,t.day,t.hour,t.minute,t.second,t.millisecond);return t.year<100&&t.year>=0&&(e=new Date(e),e.setUTCFullYear(e.getUTCFullYear()-1900)),+e}function zN(t){const e=(t+Math.floor(t/4)-Math.floor(t/100)+Math.floor(t/400))%7,r=t-1,i=(r+Math.floor(r/4)-Math.floor(r/100)+Math.floor(r/400))%7;return e===4||i===3?53:52}function B7(t){return t>99?t:t>Jn.twoDigitCutoffYear?1900+t:2e3+t}function z0e(t,e,r,i=null){const s=new Date(t),n={hourCycle:"h23",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"};i&&(n.timeZone=i);const o={timeZoneName:e,...n},a=new Intl.DateTimeFormat(r,o).formatToParts(s).find(l=>l.type.toLowerCase()==="timezonename");return a?a.value:null}function a5(t,e){let r=parseInt(t,10);Number.isNaN(r)&&(r=0);const i=parseInt(e,10)||0,s=r<0||Object.is(r,-0)?-i:i;return r*60+s}function G0e(t){const e=Number(t);if(typeof t=="boolean"||t===""||Number.isNaN(e))throw new wh(`Invalid unit value ${t}`);return e}function GN(t,e){const r={};for(const i in t)if(qS(t,i)){const s=t[i];if(s==null)continue;r[e(i)]=G0e(s)}return r}function sR(t,e){const r=Math.trunc(Math.abs(t/60)),i=Math.trunc(Math.abs(t%60)),s=t>=0?"+":"-";switch(e){case"short":return`${s}${Qn(r,2)}:${Qn(i,2)}`;case"narrow":return`${s}${r}${i>0?`:${i}`:""}`;case"techie":return`${s}${Qn(r,2)}${Qn(i,2)}`;default:throw new RangeError(`Value format ${e} is out of range for property format`)}}function l5(t){return sBe(t,["hour","minute","second","millisecond"])}const oBe=["January","February","March","April","May","June","July","August","September","October","November","December"],j0e=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],aBe=["J","F","M","A","M","J","J","A","S","O","N","D"];function H0e(t){switch(t){case"narrow":return[...aBe];case"short":return[...j0e];case"long":return[...oBe];case"numeric":return["1","2","3","4","5","6","7","8","9","10","11","12"];case"2-digit":return["01","02","03","04","05","06","07","08","09","10","11","12"];default:return null}}const q0e=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],W0e=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],lBe=["M","T","W","T","F","S","S"];function X0e(t){switch(t){case"narrow":return[...lBe];case"short":return[...W0e];case"long":return[...q0e];case"numeric":return["1","2","3","4","5","6","7"];default:return null}}const Y0e=["AM","PM"],cBe=["Before Christ","Anno Domini"],uBe=["BC","AD"],hBe=["B","A"];function Z0e(t){switch(t){case"narrow":return[...hBe];case"short":return[...uBe];case"long":return[...cBe];default:return null}}function dBe(t){return Y0e[t.hour<12?0:1]}function pBe(t,e){return X0e(e)[t.weekday-1]}function fBe(t,e){return H0e(e)[t.month-1]}function mBe(t,e){return Z0e(e)[t.year<0?0:1]}function gBe(t,e,r="always",i=!1){const s={years:["year","yr."],quarters:["quarter","qtr."],months:["month","mo."],weeks:["week","wk."],days:["day","day","days"],hours:["hour","hr."],minutes:["minute","min."],seconds:["second","sec."]},n=["hours","minutes","seconds"].indexOf(t)===-1;if(r==="auto"&&n){const p=t==="days";switch(e){case 1:return p?"tomorrow":`next ${s[t][0]}`;case-1:return p?"yesterday":`last ${s[t][0]}`;case 0:return p?"today":`this ${s[t][0]}`}}const o=Object.is(e,-0)||e<0,a=Math.abs(e),l=a===1,c=s[t],h=i?l?c[1]:c[2]||c[1]:l?s[t][0]:t;return o?`${a} ${h} ago`:`in ${a} ${h}`}function Ste(t,e){let r="";for(const i of t)i.literal?r+=i.val:r+=e(i.val);return r}const yBe={D:VN,DD:x0e,DDD:T0e,DDDD:S0e,t:E0e,tt:C0e,ttt:A0e,tttt:R0e,T:O0e,TT:M0e,TTT:P0e,TTTT:I0e,f:$0e,ff:D0e,fff:F0e,ffff:k0e,F:L0e,FF:N0e,FFF:U0e,FFFF:V0e};class Wa{static create(e,r={}){return new Wa(e,r)}static parseFormat(e){let r=null,i="",s=!1;const n=[];for(let o=0;o<e.length;o++){const a=e.charAt(o);a==="'"?(i.length>0&&n.push({literal:s,val:i}),r=null,i="",s=!s):s||a===r?i+=a:(i.length>0&&n.push({literal:!1,val:i}),i=a,r=a)}return i.length>0&&n.push({literal:s,val:i}),n}static macroTokenToFormatOpts(e){return yBe[e]}constructor(e,r){this.opts=r,this.loc=e,this.systemLoc=null}formatWithSystemDefault(e,r){return this.systemLoc===null&&(this.systemLoc=this.loc.redefaultToSystem()),this.systemLoc.dtFormatter(e,{...this.opts,...r}).format()}formatDateTime(e,r={}){return this.loc.dtFormatter(e,{...this.opts,...r}).format()}formatDateTimeParts(e,r={}){return this.loc.dtFormatter(e,{...this.opts,...r}).formatToParts()}formatInterval(e,r={}){return this.loc.dtFormatter(e.start,{...this.opts,...r}).dtf.formatRange(e.start.toJSDate(),e.end.toJSDate())}resolvedOptions(e,r={}){return this.loc.dtFormatter(e,{...this.opts,...r}).resolvedOptions()}num(e,r=0){if(this.opts.forceSimple)return Qn(e,r);const i={...this.opts};return r>0&&(i.padTo=r),this.loc.numberFormatter(i).format(e)}formatDateTimeFromString(e,r){const i=this.loc.listingMode()==="en",s=this.loc.outputCalendar&&this.loc.outputCalendar!=="gregory",n=(m,y)=>this.loc.extract(e,m,y),o=m=>e.isOffsetFixed&&e.offset===0&&m.allowZ?"Z":e.isValid?e.zone.formatOffset(e.ts,m.format):"",a=()=>i?dBe(e):n({hour:"numeric",hourCycle:"h12"},"dayperiod"),l=(m,y)=>i?fBe(e,m):n(y?{month:m}:{month:m,day:"numeric"},"month"),c=(m,y)=>i?pBe(e,m):n(y?{weekday:m}:{weekday:m,month:"long",day:"numeric"},"weekday"),h=m=>{const y=Wa.macroTokenToFormatOpts(m);return y?this.formatWithSystemDefault(e,y):m},p=m=>i?mBe(e,m):n({era:m},"era"),f=m=>{switch(m){case"S":return this.num(e.millisecond);case"u":case"SSS":return this.num(e.millisecond,3);case"s":return this.num(e.second);case"ss":return this.num(e.second,2);case"uu":return this.num(Math.floor(e.millisecond/10),2);case"uuu":return this.num(Math.floor(e.millisecond/100));case"m":return this.num(e.minute);case"mm":return this.num(e.minute,2);case"h":return this.num(e.hour%12===0?12:e.hour%12);case"hh":return this.num(e.hour%12===0?12:e.hour%12,2);case"H":return this.num(e.hour);case"HH":return this.num(e.hour,2);case"Z":return o({format:"narrow",allowZ:this.opts.allowZ});case"ZZ":return o({format:"short",allowZ:this.opts.allowZ});case"ZZZ":return o({format:"techie",allowZ:this.opts.allowZ});case"ZZZZ":return e.zone.offsetName(e.ts,{format:"short",locale:this.loc.locale});case"ZZZZZ":return e.zone.offsetName(e.ts,{format:"long",locale:this.loc.locale});case"z":return e.zoneName;case"a":return a();case"d":return s?n({day:"numeric"},"day"):this.num(e.day);case"dd":return s?n({day:"2-digit"},"day"):this.num(e.day,2);case"c":return this.num(e.weekday);case"ccc":return c("short",!0);case"cccc":return c("long",!0);case"ccccc":return c("narrow",!0);case"E":return this.num(e.weekday);case"EEE":return c("short",!1);case"EEEE":return c("long",!1);case"EEEEE":return c("narrow",!1);case"L":return s?n({month:"numeric",day:"numeric"},"month"):this.num(e.month);case"LL":return s?n({month:"2-digit",day:"numeric"},"month"):this.num(e.month,2);case"LLL":return l("short",!0);case"LLLL":return l("long",!0);case"LLLLL":return l("narrow",!0);case"M":return s?n({month:"numeric"},"month"):this.num(e.month);case"MM":return s?n({month:"2-digit"},"month"):this.num(e.month,2);case"MMM":return l("short",!1);case"MMMM":return l("long",!1);case"MMMMM":return l("narrow",!1);case"y":return s?n({year:"numeric"},"year"):this.num(e.year);case"yy":return s?n({year:"2-digit"},"year"):this.num(e.year.toString().slice(-2),2);case"yyyy":return s?n({year:"numeric"},"year"):this.num(e.year,4);case"yyyyyy":return s?n({year:"numeric"},"year"):this.num(e.year,6);case"G":return p("short");case"GG":return p("long");case"GGGGG":return p("narrow");case"kk":return this.num(e.weekYear.toString().slice(-2),2);case"kkkk":return this.num(e.weekYear,4);case"W":return this.num(e.weekNumber);case"WW":return this.num(e.weekNumber,2);case"o":return this.num(e.ordinal);case"ooo":return this.num(e.ordinal,3);case"q":return this.num(e.quarter);case"qq":return this.num(e.quarter,2);case"X":return this.num(Math.floor(e.ts/1e3));case"x":return this.num(e.ts);default:return h(m)}};return Ste(Wa.parseFormat(r),f)}formatDurationFromString(e,r){const i=l=>{switch(l[0]){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":return"hour";case"d":return"day";case"w":return"week";case"M":return"month";case"y":return"year";default:return null}},s=l=>c=>{const h=i(c);return h?this.num(l.get(h),c.length):c},n=Wa.parseFormat(r),o=n.reduce((l,{literal:c,val:h})=>c?l:l.concat(h),[]),a=e.shiftTo(...o.map(i).filter(l=>l));return Ste(n,s(a))}}class Kd{constructor(e,r){this.reason=e,this.explanation=r}toMessage(){return this.explanation?`${this.reason}: ${this.explanation}`:this.reason}}const J0e=/[A-Za-z_+-]{1,256}(?::?\/[A-Za-z0-9_+-]{1,256}(?:\/[A-Za-z0-9_+-]{1,256})?)?/;function DE(...t){const e=t.reduce((r,i)=>r+i.source,"");return RegExp(`^${e}$`)}function NE(...t){return e=>t.reduce(([r,i,s],n)=>{const[o,a,l]=n(e,s);return[{...r,...o},a||i,l]},[{},null,1]).slice(0,2)}function FE(t,...e){if(t==null)return[null,null];for(const[r,i]of e){const s=r.exec(t);if(s)return i(s)}return[null,null]}function K0e(...t){return(e,r)=>{const i={};let s;for(s=0;s<t.length;s++)i[t[s]]=Q0(e[r+s]);return[i,null,r+s]}}const Q0e=/(?:(Z)|([+-]\d\d)(?::?(\d\d))?)/,_Be=`(?:${Q0e.source}?(?:\\[(${J0e.source})\\])?)?`,MX=/(\d\d)(?::?(\d\d)(?::?(\d\d)(?:[.,](\d{1,30}))?)?)?/,e_e=RegExp(`${MX.source}${_Be}`),PX=RegExp(`(?:T${e_e.source})?`),vBe=/([+-]\d{6}|\d{4})(?:-?(\d\d)(?:-?(\d\d))?)?/,bBe=/(\d{4})-?W(\d\d)(?:-?(\d))?/,wBe=/(\d{4})-?(\d{3})/,xBe=K0e("weekYear","weekNumber","weekDay"),TBe=K0e("year","ordinal"),SBe=/(\d{4})-(\d\d)-(\d\d)/,t_e=RegExp(`${MX.source} ?(?:${Q0e.source}|(${J0e.source}))?`),EBe=RegExp(`(?: ${t_e.source})?`);function K2(t,e,r){const i=t[e];return mi(i)?r:Q0(i)}function CBe(t,e){return[{year:K2(t,e),month:K2(t,e+1,1),day:K2(t,e+2,1)},null,e+3]}function UE(t,e){return[{hours:K2(t,e,0),minutes:K2(t,e+1,0),seconds:K2(t,e+2,0),milliseconds:AX(t[e+3])},null,e+4]}function wM(t,e){const r=!t[e]&&!t[e+1],i=a5(t[e+1],t[e+2]),s=r?null:Za.instance(i);return[{},s,e+3]}function xM(t,e){const r=t[e]?ey.create(t[e]):null;return[{},r,e+1]}const ABe=RegExp(`^T?${MX.source}$`),RBe=/^-?P(?:(?:(-?\d{1,20}(?:\.\d{1,20})?)Y)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20}(?:\.\d{1,20})?)W)?(?:(-?\d{1,20}(?:\.\d{1,20})?)D)?(?:T(?:(-?\d{1,20}(?:\.\d{1,20})?)H)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20})(?:[.,](-?\d{1,20}))?S)?)?)$/;function OBe(t){const[e,r,i,s,n,o,a,l,c]=t,h=e[0]==="-",p=l&&l[0]==="-",f=(m,y=!1)=>m!==void 0&&(y||m&&h)?-m:m;return[{years:f(Ov(r)),months:f(Ov(i)),weeks:f(Ov(s)),days:f(Ov(n)),hours:f(Ov(o)),minutes:f(Ov(a)),seconds:f(Ov(l),l==="-0"),milliseconds:f(AX(c),p)}]}const MBe={GMT:0,EDT:-4*60,EST:-5*60,CDT:-5*60,CST:-6*60,MDT:-6*60,MST:-7*60,PDT:-7*60,PST:-8*60};function IX(t,e,r,i,s,n,o){const a={year:e.length===2?B7(Q0(e)):Q0(e),month:j0e.indexOf(r)+1,day:Q0(i),hour:Q0(s),minute:Q0(n)};return o&&(a.second=Q0(o)),t&&(a.weekday=t.length>3?q0e.indexOf(t)+1:W0e.indexOf(t)+1),a}const PBe=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|(?:([+-]\d\d)(\d\d)))$/;function IBe(t){const[,e,r,i,s,n,o,a,l,c,h,p]=t,f=IX(e,s,i,r,n,o,a);let m;return l?m=MBe[l]:c?m=0:m=a5(h,p),[f,new Za(m)]}function $Be(t){return t.replace(/\([^()]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").trim()}const LBe=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun), (\d\d) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d{4}) (\d\d):(\d\d):(\d\d) GMT$/,DBe=/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday), (\d\d)-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d\d) (\d\d):(\d\d):(\d\d) GMT$/,NBe=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ( \d|\d\d) (\d\d):(\d\d):(\d\d) (\d{4})$/;function Ete(t){const[,e,r,i,s,n,o,a]=t;return[IX(e,s,i,r,n,o,a),Za.utcInstance]}function FBe(t){const[,e,r,i,s,n,o,a]=t;return[IX(e,a,r,i,s,n,o),Za.utcInstance]}const UBe=DE(vBe,PX),kBe=DE(bBe,PX),VBe=DE(wBe,PX),BBe=DE(e_e),r_e=NE(CBe,UE,wM,xM),zBe=NE(xBe,UE,wM,xM),GBe=NE(TBe,UE,wM,xM),jBe=NE(UE,wM,xM);function HBe(t){return FE(t,[UBe,r_e],[kBe,zBe],[VBe,GBe],[BBe,jBe])}function qBe(t){return FE($Be(t),[PBe,IBe])}function WBe(t){return FE(t,[LBe,Ete],[DBe,Ete],[NBe,FBe])}function XBe(t){return FE(t,[RBe,OBe])}const YBe=NE(UE);function ZBe(t){return FE(t,[ABe,YBe])}const JBe=DE(SBe,EBe),KBe=DE(t_e),QBe=NE(UE,wM,xM);function eze(t){return FE(t,[JBe,r_e],[KBe,QBe])}const tze="Invalid Duration",i_e={weeks:{days:7,hours:7*24,minutes:7*24*60,seconds:7*24*60*60,milliseconds:7*24*60*60*1e3},days:{hours:24,minutes:24*60,seconds:24*60*60,milliseconds:24*60*60*1e3},hours:{minutes:60,seconds:60*60,milliseconds:60*60*1e3},minutes:{seconds:60,milliseconds:60*1e3},seconds:{milliseconds:1e3}},rze={years:{quarters:4,months:12,weeks:52,days:365,hours:365*24,minutes:365*24*60,seconds:365*24*60*60,milliseconds:365*24*60*60*1e3},quarters:{months:3,weeks:13,days:91,hours:91*24,minutes:91*24*60,seconds:91*24*60*60,milliseconds:91*24*60*60*1e3},months:{weeks:4,days:30,hours:30*24,minutes:30*24*60,seconds:30*24*60*60,milliseconds:30*24*60*60*1e3},...i_e},zu=146097/400,px=146097/4800,ize={years:{quarters:4,months:12,weeks:zu/7,days:zu,hours:zu*24,minutes:zu*24*60,seconds:zu*24*60*60,milliseconds:zu*24*60*60*1e3},quarters:{months:3,weeks:zu/28,days:zu/4,hours:zu*24/4,minutes:zu*24*60/4,seconds:zu*24*60*60/4,milliseconds:zu*24*60*60*1e3/4},months:{weeks:px/7,days:px,hours:px*24,minutes:px*24*60,seconds:px*24*60*60,milliseconds:px*24*60*60*1e3},...i_e},H1=["years","quarters","months","weeks","days","hours","minutes","seconds","milliseconds"],sze=H1.slice(0).reverse();function ky(t,e,r=!1){const i={values:r?e.values:{...t.values,...e.values||{}},loc:t.loc.clone(e.loc),conversionAccuracy:e.conversionAccuracy||t.conversionAccuracy,matrix:e.matrix||t.matrix};return new _i(i)}function nze(t){return t<0?Math.floor(t):Math.ceil(t)}function s_e(t,e,r,i,s){const n=t[s][r],o=e[r]/n,a=Math.sign(o)===Math.sign(i[s]),l=!a&&i[s]!==0&&Math.abs(o)<=1?nze(o):Math.trunc(o);i[s]+=l,e[r]-=l*n}function oze(t,e){sze.reduce((r,i)=>mi(e[i])?r:(r&&s_e(t,e,r,e,i),i),null)}function aze(t){const e={};for(const[r,i]of Object.entries(t))i!==0&&(e[r]=i);return e}class _i{constructor(e){const r=e.conversionAccuracy==="longterm"||!1;let i=r?ize:rze;e.matrix&&(i=e.matrix),this.values=e.values,this.loc=e.loc||zs.create(),this.conversionAccuracy=r?"longterm":"casual",this.invalid=e.invalid||null,this.matrix=i,this.isLuxonDuration=!0}static fromMillis(e,r){return _i.fromObject({milliseconds:e},r)}static fromObject(e,r={}){if(e==null||typeof e!="object")throw new wh(`Duration.fromObject: argument expected to be an object, got ${e===null?"null":typeof e}`);return new _i({values:GN(e,_i.normalizeUnit),loc:zs.fromObject(r),conversionAccuracy:r.conversionAccuracy,matrix:r.matrix})}static fromDurationLike(e){if(Jb(e))return _i.fromMillis(e);if(_i.isDuration(e))return e;if(typeof e=="object")return _i.fromObject(e);throw new wh(`Unknown duration argument ${e} of type ${typeof e}`)}static fromISO(e,r){const[i]=XBe(e);return i?_i.fromObject(i,r):_i.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static fromISOTime(e,r){const[i]=ZBe(e);return i?_i.fromObject(i,r):_i.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static invalid(e,r=null){if(!e)throw new wh("need to specify a reason the Duration is invalid");const i=e instanceof Kd?e:new Kd(e,r);if(Jn.throwOnInvalid)throw new DVe(i);return new _i({invalid:i})}static normalizeUnit(e){const r={year:"years",years:"years",quarter:"quarters",quarters:"quarters",month:"months",months:"months",week:"weeks",weeks:"weeks",day:"days",days:"days",hour:"hours",hours:"hours",minute:"minutes",minutes:"minutes",second:"seconds",seconds:"seconds",millisecond:"milliseconds",milliseconds:"milliseconds"}[e&&e.toLowerCase()];if(!r)throw new w0e(e);return r}static isDuration(e){return e&&e.isLuxonDuration||!1}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}toFormat(e,r={}){const i={...r,floor:r.round!==!1&&r.floor!==!1};return this.isValid?Wa.create(this.loc,i).formatDurationFromString(this,e):tze}toHuman(e={}){const r=H1.map(i=>{const s=this.values[i];return mi(s)?null:this.loc.numberFormatter({style:"unit",unitDisplay:"long",...e,unit:i.slice(0,-1)}).format(s)}).filter(i=>i);return this.loc.listFormatter({type:"conjunction",style:e.listStyle||"narrow",...e}).format(r)}toObject(){return this.isValid?{...this.values}:{}}toISO(){if(!this.isValid)return null;let e="P";return this.years!==0&&(e+=this.years+"Y"),(this.months!==0||this.quarters!==0)&&(e+=this.months+this.quarters*3+"M"),this.weeks!==0&&(e+=this.weeks+"W"),this.days!==0&&(e+=this.days+"D"),(this.hours!==0||this.minutes!==0||this.seconds!==0||this.milliseconds!==0)&&(e+="T"),this.hours!==0&&(e+=this.hours+"H"),this.minutes!==0&&(e+=this.minutes+"M"),(this.seconds!==0||this.milliseconds!==0)&&(e+=RX(this.seconds+this.milliseconds/1e3,3)+"S"),e==="P"&&(e+="T0S"),e}toISOTime(e={}){if(!this.isValid)return null;const r=this.toMillis();if(r<0||r>=864e5)return null;e={suppressMilliseconds:!1,suppressSeconds:!1,includePrefix:!1,format:"extended",...e};const i=this.shiftTo("hours","minutes","seconds","milliseconds");let s=e.format==="basic"?"hhmm":"hh:mm";(!e.suppressSeconds||i.seconds!==0||i.milliseconds!==0)&&(s+=e.format==="basic"?"ss":":ss",(!e.suppressMilliseconds||i.milliseconds!==0)&&(s+=".SSS"));let n=i.toFormat(s);return e.includePrefix&&(n="T"+n),n}toJSON(){return this.toISO()}toString(){return this.toISO()}toMillis(){return this.as("milliseconds")}valueOf(){return this.toMillis()}plus(e){if(!this.isValid)return this;const r=_i.fromDurationLike(e),i={};for(const s of H1)(qS(r.values,s)||qS(this.values,s))&&(i[s]=r.get(s)+this.get(s));return ky(this,{values:i},!0)}minus(e){if(!this.isValid)return this;const r=_i.fromDurationLike(e);return this.plus(r.negate())}mapUnits(e){if(!this.isValid)return this;const r={};for(const i of Object.keys(this.values))r[i]=G0e(e(this.values[i],i));return ky(this,{values:r},!0)}get(e){return this[_i.normalizeUnit(e)]}set(e){if(!this.isValid)return this;const r={...this.values,...GN(e,_i.normalizeUnit)};return ky(this,{values:r})}reconfigure({locale:e,numberingSystem:r,conversionAccuracy:i,matrix:s}={}){const o={loc:this.loc.clone({locale:e,numberingSystem:r}),matrix:s,conversionAccuracy:i};return ky(this,o)}as(e){return this.isValid?this.shiftTo(e).get(e):NaN}normalize(){if(!this.isValid)return this;const e=this.toObject();return oze(this.matrix,e),ky(this,{values:e},!0)}rescale(){if(!this.isValid)return this;const e=aze(this.normalize().shiftToAll().toObject());return ky(this,{values:e},!0)}shiftTo(...e){if(!this.isValid)return this;if(e.length===0)return this;e=e.map(o=>_i.normalizeUnit(o));const r={},i={},s=this.toObject();let n;for(const o of H1)if(e.indexOf(o)>=0){n=o;let a=0;for(const c in i)a+=this.matrix[c][o]*i[c],i[c]=0;Jb(s[o])&&(a+=s[o]);const l=Math.trunc(a);r[o]=l,i[o]=(a*1e3-l*1e3)/1e3;for(const c in s)H1.indexOf(c)>H1.indexOf(o)&&s_e(this.matrix,s,c,r,o)}else Jb(s[o])&&(i[o]=s[o]);for(const o in i)i[o]!==0&&(r[n]+=o===n?i[o]:i[o]/this.matrix[n][o]);return ky(this,{values:r},!0).normalize()}shiftToAll(){return this.isValid?this.shiftTo("years","months","weeks","days","hours","minutes","seconds","milliseconds"):this}negate(){if(!this.isValid)return this;const e={};for(const r of Object.keys(this.values))e[r]=this.values[r]===0?0:-this.values[r];return ky(this,{values:e},!0)}get years(){return this.isValid?this.values.years||0:NaN}get quarters(){return this.isValid?this.values.quarters||0:NaN}get months(){return this.isValid?this.values.months||0:NaN}get weeks(){return this.isValid?this.values.weeks||0:NaN}get days(){return this.isValid?this.values.days||0:NaN}get hours(){return this.isValid?this.values.hours||0:NaN}get minutes(){return this.isValid?this.values.minutes||0:NaN}get seconds(){return this.isValid?this.values.seconds||0:NaN}get milliseconds(){return this.isValid?this.values.milliseconds||0:NaN}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}equals(e){if(!this.isValid||!e.isValid||!this.loc.equals(e.loc))return!1;function r(i,s){return i===void 0||i===0?s===void 0||s===0:i===s}for(const i of H1)if(!r(this.values[i],e.values[i]))return!1;return!0}}const fx="Invalid Interval";function lze(t,e){return!t||!t.isValid?dn.invalid("missing or invalid start"):!e||!e.isValid?dn.invalid("missing or invalid end"):e<t?dn.invalid("end before start",`The end of an interval must be after its start, but you had start=${t.toISO()} and end=${e.toISO()}`):null}class dn{constructor(e){this.s=e.start,this.e=e.end,this.invalid=e.invalid||null,this.isLuxonInterval=!0}static invalid(e,r=null){if(!e)throw new wh("need to specify a reason the Interval is invalid");const i=e instanceof Kd?e:new Kd(e,r);if(Jn.throwOnInvalid)throw new LVe(i);return new dn({invalid:i})}static fromDateTimes(e,r){const i=gC(e),s=gC(r),n=lze(i,s);return n??new dn({start:i,end:s})}static after(e,r){const i=_i.fromDurationLike(r),s=gC(e);return dn.fromDateTimes(s,s.plus(i))}static before(e,r){const i=_i.fromDurationLike(r),s=gC(e);return dn.fromDateTimes(s.minus(i),s)}static fromISO(e,r){const[i,s]=(e||"").split("/",2);if(i&&s){let n,o;try{n=Ar.fromISO(i,r),o=n.isValid}catch{o=!1}let a,l;try{a=Ar.fromISO(s,r),l=a.isValid}catch{l=!1}if(o&&l)return dn.fromDateTimes(n,a);if(o){const c=_i.fromISO(s,r);if(c.isValid)return dn.after(n,c)}else if(l){const c=_i.fromISO(i,r);if(c.isValid)return dn.before(a,c)}}return dn.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static isInterval(e){return e&&e.isLuxonInterval||!1}get start(){return this.isValid?this.s:null}get end(){return this.isValid?this.e:null}get isValid(){return this.invalidReason===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}length(e="milliseconds"){return this.isValid?this.toDuration(e).get(e):NaN}count(e="milliseconds"){if(!this.isValid)return NaN;const r=this.start.startOf(e),i=this.end.startOf(e);return Math.floor(i.diff(r,e).get(e))+1}hasSame(e){return this.isValid?this.isEmpty()||this.e.minus(1).hasSame(this.s,e):!1}isEmpty(){return this.s.valueOf()===this.e.valueOf()}isAfter(e){return this.isValid?this.s>e:!1}isBefore(e){return this.isValid?this.e<=e:!1}contains(e){return this.isValid?this.s<=e&&this.e>e:!1}set({start:e,end:r}={}){return this.isValid?dn.fromDateTimes(e||this.s,r||this.e):this}splitAt(...e){if(!this.isValid)return[];const r=e.map(gC).filter(o=>this.contains(o)).sort(),i=[];let{s}=this,n=0;for(;s<this.e;){const o=r[n]||this.e,a=+o>+this.e?this.e:o;i.push(dn.fromDateTimes(s,a)),s=a,n+=1}return i}splitBy(e){const r=_i.fromDurationLike(e);if(!this.isValid||!r.isValid||r.as("milliseconds")===0)return[];let{s:i}=this,s=1,n;const o=[];for(;i<this.e;){const a=this.start.plus(r.mapUnits(l=>l*s));n=+a>+this.e?this.e:a,o.push(dn.fromDateTimes(i,n)),i=n,s+=1}return o}divideEqually(e){return this.isValid?this.splitBy(this.length()/e).slice(0,e):[]}overlaps(e){return this.e>e.s&&this.s<e.e}abutsStart(e){return this.isValid?+this.e==+e.s:!1}abutsEnd(e){return this.isValid?+e.e==+this.s:!1}engulfs(e){return this.isValid?this.s<=e.s&&this.e>=e.e:!1}equals(e){return!this.isValid||!e.isValid?!1:this.s.equals(e.s)&&this.e.equals(e.e)}intersection(e){if(!this.isValid)return this;const r=this.s>e.s?this.s:e.s,i=this.e<e.e?this.e:e.e;return r>=i?null:dn.fromDateTimes(r,i)}union(e){if(!this.isValid)return this;const r=this.s<e.s?this.s:e.s,i=this.e>e.e?this.e:e.e;return dn.fromDateTimes(r,i)}static merge(e){const[r,i]=e.sort((s,n)=>s.s-n.s).reduce(([s,n],o)=>n?n.overlaps(o)||n.abutsStart(o)?[s,n.union(o)]:[s.concat([n]),o]:[s,o],[[],null]);return i&&r.push(i),r}static xor(e){let r=null,i=0;const s=[],n=e.map(l=>[{time:l.s,type:"s"},{time:l.e,type:"e"}]),o=Array.prototype.concat(...n),a=o.sort((l,c)=>l.time-c.time);for(const l of a)i+=l.type==="s"?1:-1,i===1?r=l.time:(r&&+r!=+l.time&&s.push(dn.fromDateTimes(r,l.time)),r=null);return dn.merge(s)}difference(...e){return dn.xor([this].concat(e)).map(r=>this.intersection(r)).filter(r=>r&&!r.isEmpty())}toString(){return this.isValid?`[${this.s.toISO()} – ${this.e.toISO()})`:fx}toLocaleString(e=VN,r={}){return this.isValid?Wa.create(this.s.loc.clone(r),e).formatInterval(this):fx}toISO(e){return this.isValid?`${this.s.toISO(e)}/${this.e.toISO(e)}`:fx}toISODate(){return this.isValid?`${this.s.toISODate()}/${this.e.toISODate()}`:fx}toISOTime(e){return this.isValid?`${this.s.toISOTime(e)}/${this.e.toISOTime(e)}`:fx}toFormat(e,{separator:r=" – "}={}){return this.isValid?`${this.s.toFormat(e)}${r}${this.e.toFormat(e)}`:fx}toDuration(e,r){return this.isValid?this.e.diff(this.s,e,r):_i.invalid(this.invalidReason)}mapEndpoints(e){return dn.fromDateTimes(e(this.s),e(this.e))}}class LP{static hasDST(e=Jn.defaultZone){const r=Ar.now().setZone(e).set({month:12});return!e.isUniversal&&r.offset!==r.set({month:6}).offset}static isValidIANAZone(e){return ey.isValidZone(e)}static normalizeZone(e){return a_(e,Jn.defaultZone)}static months(e="long",{locale:r=null,numberingSystem:i=null,locObj:s=null,outputCalendar:n="gregory"}={}){return(s||zs.create(r,i,n)).months(e)}static monthsFormat(e="long",{locale:r=null,numberingSystem:i=null,locObj:s=null,outputCalendar:n="gregory"}={}){return(s||zs.create(r,i,n)).months(e,!0)}static weekdays(e="long",{locale:r=null,numberingSystem:i=null,locObj:s=null}={}){return(s||zs.create(r,i,null)).weekdays(e)}static weekdaysFormat(e="long",{locale:r=null,numberingSystem:i=null,locObj:s=null}={}){return(s||zs.create(r,i,null)).weekdays(e,!0)}static meridiems({locale:e=null}={}){return zs.create(e).meridiems()}static eras(e="short",{locale:r=null}={}){return zs.create(r,null,"gregory").eras(e)}static features(){return{relative:B0e()}}}function Cte(t,e){const r=s=>s.toUTC(0,{keepLocalTime:!0}).startOf("day").valueOf(),i=r(e)-r(t);return Math.floor(_i.fromMillis(i).as("days"))}function cze(t,e,r){const i=[["years",(l,c)=>c.year-l.year],["quarters",(l,c)=>c.quarter-l.quarter+(c.year-l.year)*4],["months",(l,c)=>c.month-l.month+(c.year-l.year)*12],["weeks",(l,c)=>{const h=Cte(l,c);return(h-h%7)/7}],["days",Cte]],s={},n=t;let o,a;for(const[l,c]of i)r.indexOf(l)>=0&&(o=l,s[l]=c(t,e),a=n.plus(s),a>e?(s[l]--,t=n.plus(s)):t=a);return[t,s,a,o]}function uze(t,e,r,i){let[s,n,o,a]=cze(t,e,r);const l=e-s,c=r.filter(p=>["hours","minutes","seconds","milliseconds"].indexOf(p)>=0);c.length===0&&(o<e&&(o=s.plus({[a]:1})),o!==s&&(n[a]=(n[a]||0)+l/(o-s)));const h=_i.fromObject(n,i);return c.length>0?_i.fromMillis(l,i).shiftTo(...c).plus(h):h}const $X={arab:"[٠-٩]",arabext:"[۰-۹]",bali:"[᭐-᭙]",beng:"[০-৯]",deva:"[०-९]",fullwide:"[０-９]",gujr:"[૦-૯]",hanidec:"[〇|一|二|三|四|五|六|七|八|九]",khmr:"[០-៩]",knda:"[೦-೯]",laoo:"[໐-໙]",limb:"[᥆-᥏]",mlym:"[൦-൯]",mong:"[᠐-᠙]",mymr:"[၀-၉]",orya:"[୦-୯]",tamldec:"[௦-௯]",telu:"[౦-౯]",thai:"[๐-๙]",tibt:"[༠-༩]",latn:"\\d"},Ate={arab:[1632,1641],arabext:[1776,1785],bali:[6992,7001],beng:[2534,2543],deva:[2406,2415],fullwide:[65296,65303],gujr:[2790,2799],khmr:[6112,6121],knda:[3302,3311],laoo:[3792,3801],limb:[6470,6479],mlym:[3430,3439],mong:[6160,6169],mymr:[4160,4169],orya:[2918,2927],tamldec:[3046,3055],telu:[3174,3183],thai:[3664,3673],tibt:[3872,3881]},hze=$X.hanidec.replace(/[\[|\]]/g,"").split("");function dze(t){let e=parseInt(t,10);if(isNaN(e)){e="";for(let r=0;r<t.length;r++){const i=t.charCodeAt(r);if(t[r].search($X.hanidec)!==-1)e+=hze.indexOf(t[r]);else for(const s in Ate){const[n,o]=Ate[s];i>=n&&i<=o&&(e+=i-n)}}return parseInt(e,10)}else return e}function sd({numberingSystem:t},e=""){return new RegExp(`${$X[t||"latn"]}${e}`)}const pze="missing Intl.DateTimeFormat.formatToParts support";function Pi(t,e=r=>r){return{regex:t,deser:([r])=>e(dze(r))}}const fze=String.fromCharCode(160),n_e=`[ ${fze}]`,o_e=new RegExp(n_e,"g");function mze(t){return t.replace(/\./g,"\\.?").replace(o_e,n_e)}function Rte(t){return t.replace(/\./g,"").replace(o_e," ").toLowerCase()}function nd(t,e){return t===null?null:{regex:RegExp(t.map(mze).join("|")),deser:([r])=>t.findIndex(i=>Rte(r)===Rte(i))+e}}function Ote(t,e){return{regex:t,deser:([,r,i])=>a5(r,i),groups:e}}function DU(t){return{regex:t,deser:([e])=>e}}function gze(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function yze(t,e){const r=sd(e),i=sd(e,"{2}"),s=sd(e,"{3}"),n=sd(e,"{4}"),o=sd(e,"{6}"),a=sd(e,"{1,2}"),l=sd(e,"{1,3}"),c=sd(e,"{1,6}"),h=sd(e,"{1,9}"),p=sd(e,"{2,4}"),f=sd(e,"{4,6}"),m=b=>({regex:RegExp(gze(b.val)),deser:([x])=>x,literal:!0}),_=(b=>{if(t.literal)return m(b);switch(b.val){case"G":return nd(e.eras("short",!1),0);case"GG":return nd(e.eras("long",!1),0);case"y":return Pi(c);case"yy":return Pi(p,B7);case"yyyy":return Pi(n);case"yyyyy":return Pi(f);case"yyyyyy":return Pi(o);case"M":return Pi(a);case"MM":return Pi(i);case"MMM":return nd(e.months("short",!0,!1),1);case"MMMM":return nd(e.months("long",!0,!1),1);case"L":return Pi(a);case"LL":return Pi(i);case"LLL":return nd(e.months("short",!1,!1),1);case"LLLL":return nd(e.months("long",!1,!1),1);case"d":return Pi(a);case"dd":return Pi(i);case"o":return Pi(l);case"ooo":return Pi(s);case"HH":return Pi(i);case"H":return Pi(a);case"hh":return Pi(i);case"h":return Pi(a);case"mm":return Pi(i);case"m":return Pi(a);case"q":return Pi(a);case"qq":return Pi(i);case"s":return Pi(a);case"ss":return Pi(i);case"S":return Pi(l);case"SSS":return Pi(s);case"u":return DU(h);case"uu":return DU(a);case"uuu":return Pi(r);case"a":return nd(e.meridiems(),0);case"kkkk":return Pi(n);case"kk":return Pi(p,B7);case"W":return Pi(a);case"WW":return Pi(i);case"E":case"c":return Pi(r);case"EEE":return nd(e.weekdays("short",!1,!1),1);case"EEEE":return nd(e.weekdays("long",!1,!1),1);case"ccc":return nd(e.weekdays("short",!0,!1),1);case"cccc":return nd(e.weekdays("long",!0,!1),1);case"Z":case"ZZ":return Ote(new RegExp(`([+-]${a.source})(?::(${i.source}))?`),2);case"ZZZ":return Ote(new RegExp(`([+-]${a.source})(${i.source})?`),2);case"z":return DU(/[a-z_+-/]{1,256}?/i);default:return m(b)}})(t)||{invalidReason:pze};return _.token=t,_}const _ze={year:{"2-digit":"yy",numeric:"yyyyy"},month:{numeric:"M","2-digit":"MM",short:"MMM",long:"MMMM"},day:{numeric:"d","2-digit":"dd"},weekday:{short:"EEE",long:"EEEE"},dayperiod:"a",dayPeriod:"a",hour:{numeric:"h","2-digit":"hh"},minute:{numeric:"m","2-digit":"mm"},second:{numeric:"s","2-digit":"ss"},timeZoneName:{long:"ZZZZZ",short:"ZZZ"}};function vze(t,e){const{type:r,value:i}=t;if(r==="literal")return{literal:!0,val:i};const s=e[r];let n=_ze[r];if(typeof n=="object"&&(n=n[s]),n)return{literal:!1,val:n}}function bze(t){return[`^${t.map(r=>r.regex).reduce((r,i)=>`${r}(${i.source})`,"")}$`,t]}function wze(t,e,r){const i=t.match(e);if(i){const s={};let n=1;for(const o in r)if(qS(r,o)){const a=r[o],l=a.groups?a.groups+1:1;!a.literal&&a.token&&(s[a.token.val[0]]=a.deser(i.slice(n,n+l))),n+=l}return[i,s]}else return[i,{}]}function xze(t){const e=n=>{switch(n){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":case"H":return"hour";case"d":return"day";case"o":return"ordinal";case"L":case"M":return"month";case"y":return"year";case"E":case"c":return"weekday";case"W":return"weekNumber";case"k":return"weekYear";case"q":return"quarter";default:return null}};let r=null,i;return mi(t.z)||(r=ey.create(t.z)),mi(t.Z)||(r||(r=new Za(t.Z)),i=t.Z),mi(t.q)||(t.M=(t.q-1)*3+1),mi(t.h)||(t.h<12&&t.a===1?t.h+=12:t.h===12&&t.a===0&&(t.h=0)),t.G===0&&t.y&&(t.y=-t.y),mi(t.u)||(t.S=AX(t.u)),[Object.keys(t).reduce((n,o)=>{const a=e(o);return a&&(n[a]=t[o]),n},{}),r,i]}let NU=null;function Tze(){return NU||(NU=Ar.fromMillis(1555555555555)),NU}function Sze(t,e){if(t.literal)return t;const r=Wa.macroTokenToFormatOpts(t.val),i=c_e(r,e);return i==null||i.includes(void 0)?t:i}function a_e(t,e){return Array.prototype.concat(...t.map(r=>Sze(r,e)))}function l_e(t,e,r){const i=a_e(Wa.parseFormat(r),t),s=i.map(o=>yze(o,t)),n=s.find(o=>o.invalidReason);if(n)return{input:e,tokens:i,invalidReason:n.invalidReason};{const[o,a]=bze(s),l=RegExp(o,"i"),[c,h]=wze(e,l,a),[p,f,m]=h?xze(h):[null,null,void 0];if(qS(h,"a")&&qS(h,"H"))throw new XA("Can't include meridiem when specifying 24-hour format");return{input:e,tokens:i,regex:l,rawMatches:c,matches:h,result:p,zone:f,specificOffset:m}}}function Eze(t,e,r){const{result:i,zone:s,specificOffset:n,invalidReason:o}=l_e(t,e,r);return[i,s,n,o]}function c_e(t,e){return t?Wa.create(e,t).formatDateTimeParts(Tze()).map(s=>vze(s,t)):null}const u_e=[0,31,59,90,120,151,181,212,243,273,304,334],h_e=[0,31,60,91,121,152,182,213,244,274,305,335];function Mh(t,e){return new Kd("unit out of range",`you specified ${e} (of type ${typeof e}) as a ${t}, which is invalid`)}function d_e(t,e,r){const i=new Date(Date.UTC(t,e-1,r));t<100&&t>=0&&i.setUTCFullYear(i.getUTCFullYear()-1900);const s=i.getUTCDay();return s===0?7:s}function p_e(t,e,r){return r+(bM(t)?h_e:u_e)[e-1]}function f_e(t,e){const r=bM(t)?h_e:u_e,i=r.findIndex(n=>n<e),s=e-r[i];return{month:i+1,day:s}}function z7(t){const{year:e,month:r,day:i}=t,s=p_e(e,r,i),n=d_e(e,r,i);let o=Math.floor((s-n+10)/7),a;return o<1?(a=e-1,o=zN(a)):o>zN(e)?(a=e+1,o=1):a=e,{weekYear:a,weekNumber:o,weekday:n,...l5(t)}}function Mte(t){const{weekYear:e,weekNumber:r,weekday:i}=t,s=d_e(e,1,4),n=iR(e);let o=r*7+i-s-3,a;o<1?(a=e-1,o+=iR(a)):o>n?(a=e+1,o-=iR(e)):a=e;const{month:l,day:c}=f_e(a,o);return{year:a,month:l,day:c,...l5(t)}}function FU(t){const{year:e,month:r,day:i}=t,s=p_e(e,r,i);return{year:e,ordinal:s,...l5(t)}}function Pte(t){const{year:e,ordinal:r}=t,{month:i,day:s}=f_e(e,r);return{year:e,month:i,day:s,...l5(t)}}function Cze(t){const e=o5(t.weekYear),r=Lg(t.weekNumber,1,zN(t.weekYear)),i=Lg(t.weekday,1,7);return e?r?i?!1:Mh("weekday",t.weekday):Mh("week",t.week):Mh("weekYear",t.weekYear)}function Aze(t){const e=o5(t.year),r=Lg(t.ordinal,1,iR(t.year));return e?r?!1:Mh("ordinal",t.ordinal):Mh("year",t.year)}function m_e(t){const e=o5(t.year),r=Lg(t.month,1,12),i=Lg(t.day,1,BN(t.year,t.month));return e?r?i?!1:Mh("day",t.day):Mh("month",t.month):Mh("year",t.year)}function g_e(t){const{hour:e,minute:r,second:i,millisecond:s}=t,n=Lg(e,0,23)||e===24&&r===0&&i===0&&s===0,o=Lg(r,0,59),a=Lg(i,0,59),l=Lg(s,0,999);return n?o?a?l?!1:Mh("millisecond",s):Mh("second",i):Mh("minute",r):Mh("hour",e)}const UU="Invalid DateTime",Ite=864e13;function DP(t){return new Kd("unsupported zone",`the zone "${t.name}" is not supported`)}function kU(t){return t.weekData===null&&(t.weekData=z7(t.c)),t.weekData}function fC(t,e){const r={ts:t.ts,zone:t.zone,c:t.c,o:t.o,loc:t.loc,invalid:t.invalid};return new Ar({...r,...e,old:r})}function y_e(t,e,r){let i=t-e*60*1e3;const s=r.offset(i);if(e===s)return[i,e];i-=(s-e)*60*1e3;const n=r.offset(i);return s===n?[i,s]:[t-Math.min(s,n)*60*1e3,Math.max(s,n)]}function $te(t,e){t+=e*60*1e3;const r=new Date(t);return{year:r.getUTCFullYear(),month:r.getUTCMonth()+1,day:r.getUTCDate(),hour:r.getUTCHours(),minute:r.getUTCMinutes(),second:r.getUTCSeconds(),millisecond:r.getUTCMilliseconds()}}function jL(t,e,r){return y_e(OX(t),e,r)}function Lte(t,e){const r=t.o,i=t.c.year+Math.trunc(e.years),s=t.c.month+Math.trunc(e.months)+Math.trunc(e.quarters)*3,n={...t.c,year:i,month:s,day:Math.min(t.c.day,BN(i,s))+Math.trunc(e.days)+Math.trunc(e.weeks)*7},o=_i.fromObject({years:e.years-Math.trunc(e.years),quarters:e.quarters-Math.trunc(e.quarters),months:e.months-Math.trunc(e.months),weeks:e.weeks-Math.trunc(e.weeks),days:e.days-Math.trunc(e.days),hours:e.hours,minutes:e.minutes,seconds:e.seconds,milliseconds:e.milliseconds}).as("milliseconds"),a=OX(n);let[l,c]=y_e(a,r,t.zone);return o!==0&&(l+=o,c=t.zone.offset(l)),{ts:l,o:c}}function mC(t,e,r,i,s,n){const{setZone:o,zone:a}=r;if(t&&Object.keys(t).length!==0){const l=e||a,c=Ar.fromObject(t,{...r,zone:l,specificOffset:n});return o?c:c.setZone(a)}else return Ar.invalid(new Kd("unparsable",`the input "${s}" can't be parsed as ${i}`))}function NP(t,e,r=!0){return t.isValid?Wa.create(zs.create("en-US"),{allowZ:r,forceSimple:!0}).formatDateTimeFromString(t,e):null}function VU(t,e){const r=t.c.year>9999||t.c.year<0;let i="";return r&&t.c.year>=0&&(i+="+"),i+=Qn(t.c.year,r?6:4),e?(i+="-",i+=Qn(t.c.month),i+="-",i+=Qn(t.c.day)):(i+=Qn(t.c.month),i+=Qn(t.c.day)),i}function Dte(t,e,r,i,s,n){let o=Qn(t.c.hour);return e?(o+=":",o+=Qn(t.c.minute),(t.c.second!==0||!r)&&(o+=":")):o+=Qn(t.c.minute),(t.c.second!==0||!r)&&(o+=Qn(t.c.second),(t.c.millisecond!==0||!i)&&(o+=".",o+=Qn(t.c.millisecond,3))),s&&(t.isOffsetFixed&&t.offset===0&&!n?o+="Z":t.o<0?(o+="-",o+=Qn(Math.trunc(-t.o/60)),o+=":",o+=Qn(Math.trunc(-t.o%60))):(o+="+",o+=Qn(Math.trunc(t.o/60)),o+=":",o+=Qn(Math.trunc(t.o%60)))),n&&(o+="["+t.zone.ianaName+"]"),o}const __e={month:1,day:1,hour:0,minute:0,second:0,millisecond:0},Rze={weekNumber:1,weekday:1,hour:0,minute:0,second:0,millisecond:0},Oze={ordinal:1,hour:0,minute:0,second:0,millisecond:0},v_e=["year","month","day","hour","minute","second","millisecond"],Mze=["weekYear","weekNumber","weekday","hour","minute","second","millisecond"],Pze=["year","ordinal","hour","minute","second","millisecond"];function Nte(t){const e={year:"year",years:"year",month:"month",months:"month",day:"day",days:"day",hour:"hour",hours:"hour",minute:"minute",minutes:"minute",quarter:"quarter",quarters:"quarter",second:"second",seconds:"second",millisecond:"millisecond",milliseconds:"millisecond",weekday:"weekday",weekdays:"weekday",weeknumber:"weekNumber",weeksnumber:"weekNumber",weeknumbers:"weekNumber",weekyear:"weekYear",weekyears:"weekYear",ordinal:"ordinal"}[t.toLowerCase()];if(!e)throw new w0e(t);return e}function Fte(t,e){const r=a_(e.zone,Jn.defaultZone),i=zs.fromObject(e),s=Jn.now();let n,o;if(mi(t.year))n=s;else{for(const c of v_e)mi(t[c])&&(t[c]=__e[c]);const a=m_e(t)||g_e(t);if(a)return Ar.invalid(a);const l=r.offset(s);[n,o]=jL(t,l,r)}return new Ar({ts:n,zone:r,loc:i,o})}function Ute(t,e,r){const i=mi(r.round)?!0:r.round,s=(o,a)=>(o=RX(o,i||r.calendary?0:2,!0),e.loc.clone(r).relFormatter(r).format(o,a)),n=o=>r.calendary?e.hasSame(t,o)?0:e.startOf(o).diff(t.startOf(o),o).get(o):e.diff(t,o).get(o);if(r.unit)return s(n(r.unit),r.unit);for(const o of r.units){const a=n(o);if(Math.abs(a)>=1)return s(a,o)}return s(t>e?-0:0,r.units[r.units.length-1])}function kte(t){let e={},r;return t.length>0&&typeof t[t.length-1]=="object"?(e=t[t.length-1],r=Array.from(t).slice(0,t.length-1)):r=Array.from(t),[e,r]}class Ar{constructor(e){const r=e.zone||Jn.defaultZone;let i=e.invalid||(Number.isNaN(e.ts)?new Kd("invalid input"):null)||(r.isValid?null:DP(r));this.ts=mi(e.ts)?Jn.now():e.ts;let s=null,n=null;if(!i)if(e.old&&e.old.ts===this.ts&&e.old.zone.equals(r))[s,n]=[e.old.c,e.old.o];else{const a=r.offset(this.ts);s=$te(this.ts,a),i=Number.isNaN(s.year)?new Kd("invalid input"):null,s=i?null:s,n=i?null:a}this._zone=r,this.loc=e.loc||zs.create(),this.invalid=i,this.weekData=null,this.c=s,this.o=n,this.isLuxonDateTime=!0}static now(){return new Ar({})}static local(){const[e,r]=kte(arguments),[i,s,n,o,a,l,c]=r;return Fte({year:i,month:s,day:n,hour:o,minute:a,second:l,millisecond:c},e)}static utc(){const[e,r]=kte(arguments),[i,s,n,o,a,l,c]=r;return e.zone=Za.utcInstance,Fte({year:i,month:s,day:n,hour:o,minute:a,second:l,millisecond:c},e)}static fromJSDate(e,r={}){const i=rBe(e)?e.valueOf():NaN;if(Number.isNaN(i))return Ar.invalid("invalid input");const s=a_(r.zone,Jn.defaultZone);return s.isValid?new Ar({ts:i,zone:s,loc:zs.fromObject(r)}):Ar.invalid(DP(s))}static fromMillis(e,r={}){if(Jb(e))return e<-Ite||e>Ite?Ar.invalid("Timestamp out of range"):new Ar({ts:e,zone:a_(r.zone,Jn.defaultZone),loc:zs.fromObject(r)});throw new wh(`fromMillis requires a numerical input, but received a ${typeof e} with value ${e}`)}static fromSeconds(e,r={}){if(Jb(e))return new Ar({ts:e*1e3,zone:a_(r.zone,Jn.defaultZone),loc:zs.fromObject(r)});throw new wh("fromSeconds requires a numerical input")}static fromObject(e,r={}){e=e||{};const i=a_(r.zone,Jn.defaultZone);if(!i.isValid)return Ar.invalid(DP(i));const s=Jn.now(),n=mi(r.specificOffset)?i.offset(s):r.specificOffset,o=GN(e,Nte),a=!mi(o.ordinal),l=!mi(o.year),c=!mi(o.month)||!mi(o.day),h=l||c,p=o.weekYear||o.weekNumber,f=zs.fromObject(r);if((h||a)&&p)throw new XA("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(c&&a)throw new XA("Can't mix ordinal dates with month/day");const m=p||o.weekday&&!h;let y,_,b=$te(s,n);m?(y=Mze,_=Rze,b=z7(b)):a?(y=Pze,_=Oze,b=FU(b)):(y=v_e,_=__e);let x=!1;for(const P of y){const U=o[P];mi(U)?x?o[P]=_[P]:o[P]=b[P]:x=!0}const T=m?Cze(o):a?Aze(o):m_e(o),S=T||g_e(o);if(S)return Ar.invalid(S);const E=m?Mte(o):a?Pte(o):o,[O,R]=jL(E,n,i),L=new Ar({ts:O,zone:i,o:R,loc:f});return o.weekday&&h&&e.weekday!==L.weekday?Ar.invalid("mismatched weekday",`you can't specify both a weekday of ${o.weekday} and a date of ${L.toISO()}`):L}static fromISO(e,r={}){const[i,s]=HBe(e);return mC(i,s,r,"ISO 8601",e)}static fromRFC2822(e,r={}){const[i,s]=qBe(e);return mC(i,s,r,"RFC 2822",e)}static fromHTTP(e,r={}){const[i,s]=WBe(e);return mC(i,s,r,"HTTP",r)}static fromFormat(e,r,i={}){if(mi(e)||mi(r))throw new wh("fromFormat requires an input string and a format");const{locale:s=null,numberingSystem:n=null}=i,o=zs.fromOpts({locale:s,numberingSystem:n,defaultToEN:!0}),[a,l,c,h]=Eze(o,e,r);return h?Ar.invalid(h):mC(a,l,i,`format ${r}`,e,c)}static fromString(e,r,i={}){return Ar.fromFormat(e,r,i)}static fromSQL(e,r={}){const[i,s]=eze(e);return mC(i,s,r,"SQL",e)}static invalid(e,r=null){if(!e)throw new wh("need to specify a reason the DateTime is invalid");const i=e instanceof Kd?e:new Kd(e,r);if(Jn.throwOnInvalid)throw new $Ve(i);return new Ar({invalid:i})}static isDateTime(e){return e&&e.isLuxonDateTime||!1}static parseFormatForOpts(e,r={}){const i=c_e(e,zs.fromObject(r));return i?i.map(s=>s?s.val:null).join(""):null}static expandFormat(e,r={}){return a_e(Wa.parseFormat(e),zs.fromObject(r)).map(s=>s.val).join("")}get(e){return this[e]}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}get outputCalendar(){return this.isValid?this.loc.outputCalendar:null}get zone(){return this._zone}get zoneName(){return this.isValid?this.zone.name:null}get year(){return this.isValid?this.c.year:NaN}get quarter(){return this.isValid?Math.ceil(this.c.month/3):NaN}get month(){return this.isValid?this.c.month:NaN}get day(){return this.isValid?this.c.day:NaN}get hour(){return this.isValid?this.c.hour:NaN}get minute(){return this.isValid?this.c.minute:NaN}get second(){return this.isValid?this.c.second:NaN}get millisecond(){return this.isValid?this.c.millisecond:NaN}get weekYear(){return this.isValid?kU(this).weekYear:NaN}get weekNumber(){return this.isValid?kU(this).weekNumber:NaN}get weekday(){return this.isValid?kU(this).weekday:NaN}get ordinal(){return this.isValid?FU(this.c).ordinal:NaN}get monthShort(){return this.isValid?LP.months("short",{locObj:this.loc})[this.month-1]:null}get monthLong(){return this.isValid?LP.months("long",{locObj:this.loc})[this.month-1]:null}get weekdayShort(){return this.isValid?LP.weekdays("short",{locObj:this.loc})[this.weekday-1]:null}get weekdayLong(){return this.isValid?LP.weekdays("long",{locObj:this.loc})[this.weekday-1]:null}get offset(){return this.isValid?+this.o:NaN}get offsetNameShort(){return this.isValid?this.zone.offsetName(this.ts,{format:"short",locale:this.locale}):null}get offsetNameLong(){return this.isValid?this.zone.offsetName(this.ts,{format:"long",locale:this.locale}):null}get isOffsetFixed(){return this.isValid?this.zone.isUniversal:null}get isInDST(){return this.isOffsetFixed?!1:this.offset>this.set({month:1,day:1}).offset||this.offset>this.set({month:5}).offset}get isInLeapYear(){return bM(this.year)}get daysInMonth(){return BN(this.year,this.month)}get daysInYear(){return this.isValid?iR(this.year):NaN}get weeksInWeekYear(){return this.isValid?zN(this.weekYear):NaN}resolvedLocaleOptions(e={}){const{locale:r,numberingSystem:i,calendar:s}=Wa.create(this.loc.clone(e),e).resolvedOptions(this);return{locale:r,numberingSystem:i,outputCalendar:s}}toUTC(e=0,r={}){return this.setZone(Za.instance(e),r)}toLocal(){return this.setZone(Jn.defaultZone)}setZone(e,{keepLocalTime:r=!1,keepCalendarTime:i=!1}={}){if(e=a_(e,Jn.defaultZone),e.equals(this.zone))return this;if(e.isValid){let s=this.ts;if(r||i){const n=e.offset(this.ts),o=this.toObject();[s]=jL(o,n,e)}return fC(this,{ts:s,zone:e})}else return Ar.invalid(DP(e))}reconfigure({locale:e,numberingSystem:r,outputCalendar:i}={}){const s=this.loc.clone({locale:e,numberingSystem:r,outputCalendar:i});return fC(this,{loc:s})}setLocale(e){return this.reconfigure({locale:e})}set(e){if(!this.isValid)return this;const r=GN(e,Nte),i=!mi(r.weekYear)||!mi(r.weekNumber)||!mi(r.weekday),s=!mi(r.ordinal),n=!mi(r.year),o=!mi(r.month)||!mi(r.day),a=n||o,l=r.weekYear||r.weekNumber;if((a||s)&&l)throw new XA("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(o&&s)throw new XA("Can't mix ordinal dates with month/day");let c;i?c=Mte({...z7(this.c),...r}):mi(r.ordinal)?(c={...this.toObject(),...r},mi(r.day)&&(c.day=Math.min(BN(c.year,c.month),c.day))):c=Pte({...FU(this.c),...r});const[h,p]=jL(c,this.o,this.zone);return fC(this,{ts:h,o:p})}plus(e){if(!this.isValid)return this;const r=_i.fromDurationLike(e);return fC(this,Lte(this,r))}minus(e){if(!this.isValid)return this;const r=_i.fromDurationLike(e).negate();return fC(this,Lte(this,r))}startOf(e){if(!this.isValid)return this;const r={},i=_i.normalizeUnit(e);switch(i){case"years":r.month=1;case"quarters":case"months":r.day=1;case"weeks":case"days":r.hour=0;case"hours":r.minute=0;case"minutes":r.second=0;case"seconds":r.millisecond=0;break}if(i==="weeks"&&(r.weekday=1),i==="quarters"){const s=Math.ceil(this.month/3);r.month=(s-1)*3+1}return this.set(r)}endOf(e){return this.isValid?this.plus({[e]:1}).startOf(e).minus(1):this}toFormat(e,r={}){return this.isValid?Wa.create(this.loc.redefaultToEN(r)).formatDateTimeFromString(this,e):UU}toLocaleString(e=VN,r={}){return this.isValid?Wa.create(this.loc.clone(r),e).formatDateTime(this):UU}toLocaleParts(e={}){return this.isValid?Wa.create(this.loc.clone(e),e).formatDateTimeParts(this):[]}toISO({format:e="extended",suppressSeconds:r=!1,suppressMilliseconds:i=!1,includeOffset:s=!0,extendedZone:n=!1}={}){if(!this.isValid)return null;const o=e==="extended";let a=VU(this,o);return a+="T",a+=Dte(this,o,r,i,s,n),a}toISODate({format:e="extended"}={}){return this.isValid?VU(this,e==="extended"):null}toISOWeekDate(){return NP(this,"kkkk-'W'WW-c")}toISOTime({suppressMilliseconds:e=!1,suppressSeconds:r=!1,includeOffset:i=!0,includePrefix:s=!1,extendedZone:n=!1,format:o="extended"}={}){return this.isValid?(s?"T":"")+Dte(this,o==="extended",r,e,i,n):null}toRFC2822(){return NP(this,"EEE, dd LLL yyyy HH:mm:ss ZZZ",!1)}toHTTP(){return NP(this.toUTC(),"EEE, dd LLL yyyy HH:mm:ss 'GMT'")}toSQLDate(){return this.isValid?VU(this,!0):null}toSQLTime({includeOffset:e=!0,includeZone:r=!1,includeOffsetSpace:i=!0}={}){let s="HH:mm:ss.SSS";return(r||e)&&(i&&(s+=" "),r?s+="z":e&&(s+="ZZ")),NP(this,s,!0)}toSQL(e={}){return this.isValid?`${this.toSQLDate()} ${this.toSQLTime(e)}`:null}toString(){return this.isValid?this.toISO():UU}valueOf(){return this.toMillis()}toMillis(){return this.isValid?this.ts:NaN}toSeconds(){return this.isValid?this.ts/1e3:NaN}toUnixInteger(){return this.isValid?Math.floor(this.ts/1e3):NaN}toJSON(){return this.toISO()}toBSON(){return this.toJSDate()}toObject(e={}){if(!this.isValid)return{};const r={...this.c};return e.includeConfig&&(r.outputCalendar=this.outputCalendar,r.numberingSystem=this.loc.numberingSystem,r.locale=this.loc.locale),r}toJSDate(){return new Date(this.isValid?this.ts:NaN)}diff(e,r="milliseconds",i={}){if(!this.isValid||!e.isValid)return _i.invalid("created by diffing an invalid DateTime");const s={locale:this.locale,numberingSystem:this.numberingSystem,...i},n=iBe(r).map(_i.normalizeUnit),o=e.valueOf()>this.valueOf(),a=o?this:e,l=o?e:this,c=uze(a,l,n,s);return o?c.negate():c}diffNow(e="milliseconds",r={}){return this.diff(Ar.now(),e,r)}until(e){return this.isValid?dn.fromDateTimes(this,e):this}hasSame(e,r){if(!this.isValid)return!1;const i=e.valueOf(),s=this.setZone(e.zone,{keepLocalTime:!0});return s.startOf(r)<=i&&i<=s.endOf(r)}equals(e){return this.isValid&&e.isValid&&this.valueOf()===e.valueOf()&&this.zone.equals(e.zone)&&this.loc.equals(e.loc)}toRelative(e={}){if(!this.isValid)return null;const r=e.base||Ar.fromObject({},{zone:this.zone}),i=e.padding?this<r?-e.padding:e.padding:0;let s=["years","months","days","hours","minutes","seconds"],n=e.unit;return Array.isArray(e.unit)&&(s=e.unit,n=void 0),Ute(r,this.plus(i),{...e,numeric:"always",units:s,unit:n})}toRelativeCalendar(e={}){return this.isValid?Ute(e.base||Ar.fromObject({},{zone:this.zone}),this,{...e,numeric:"auto",units:["years","months","days"],calendary:!0}):null}static min(...e){if(!e.every(Ar.isDateTime))throw new wh("min requires all arguments be DateTimes");return Tte(e,r=>r.valueOf(),Math.min)}static max(...e){if(!e.every(Ar.isDateTime))throw new wh("max requires all arguments be DateTimes");return Tte(e,r=>r.valueOf(),Math.max)}static fromFormatExplain(e,r,i={}){const{locale:s=null,numberingSystem:n=null}=i,o=zs.fromOpts({locale:s,numberingSystem:n,defaultToEN:!0});return l_e(o,e,r)}static fromStringExplain(e,r,i={}){return Ar.fromFormatExplain(e,r,i)}static get DATE_SHORT(){return VN}static get DATE_MED(){return x0e}static get DATE_MED_WITH_WEEKDAY(){return NVe}static get DATE_FULL(){return T0e}static get DATE_HUGE(){return S0e}static get TIME_SIMPLE(){return E0e}static get TIME_WITH_SECONDS(){return C0e}static get TIME_WITH_SHORT_OFFSET(){return A0e}static get TIME_WITH_LONG_OFFSET(){return R0e}static get TIME_24_SIMPLE(){return O0e}static get TIME_24_WITH_SECONDS(){return M0e}static get TIME_24_WITH_SHORT_OFFSET(){return P0e}static get TIME_24_WITH_LONG_OFFSET(){return I0e}static get DATETIME_SHORT(){return $0e}static get DATETIME_SHORT_WITH_SECONDS(){return L0e}static get DATETIME_MED(){return D0e}static get DATETIME_MED_WITH_SECONDS(){return N0e}static get DATETIME_MED_WITH_WEEKDAY(){return FVe}static get DATETIME_FULL(){return F0e}static get DATETIME_FULL_WITH_SECONDS(){return U0e}static get DATETIME_HUGE(){return k0e}static get DATETIME_HUGE_WITH_SECONDS(){return V0e}}function gC(t){if(Ar.isDateTime(t))return t;if(t&&t.valueOf&&Jb(t.valueOf()))return Ar.fromJSDate(t);if(t&&typeof t=="object")return Ar.fromObject(t);throw new wh(`Unknown datetime argument: ${t}, of type ${typeof t}`)}function Ize(t,e="system"){if(!t||!fte.has(t.timeZone))return e;const r=fte.get(t.timeZone);return Lze(t.timeZone)||t.respectsDaylightSaving?r:$ze(r)}function $ze(t){const e=Ar.local().setZone(t),r=Math.min(e.set({month:1,day:1}).offset,e.set({month:5}).offset);return r===0?"Etc/UTC":`Etc/GMT${Za.instance(-r).formatOffset(0,"narrow")}`}function Lze(t){return t.startsWith("UTC")}let $0=class extends bs(ve){constructor(e){super(e),this.legacy=null,this.timeZone="system"}readLegacy(e,r){const{timeZone:i,respectsDaylightSaving:s}=r;return{timeZone:i,respectsDaylightSaving:s}}readTimeZone(e,r){return"timeZoneIANA"in r?r.timeZoneIANA:Ize(r)}writeTimeZone(e,r){r.timeZoneIANA=e}equals(e){return!(C(e)||C(this.timeZone)||C(e.timeZone))&&this.timeZone===e.timeZone}};u([d()],$0.prototype,"legacy",void 0),u([Fe("legacy",["timeZone"])],$0.prototype,"readLegacy",null),u([d({type:String,nonNullable:!0})],$0.prototype,"timeZone",void 0),u([Fe("timeZone",["timeZone","timeZoneIANA","respectsDaylightSaving"])],$0.prototype,"readTimeZone",null),u([He("timeZone")],$0.prototype,"writeTimeZone",null),$0=u([I("esri.time.TimeReference")],$0);const WS=$0;let lg=class extends bs(ve){constructor(e){super(e),this.creatorField=null,this.creationDateField=null,this.editorField=null,this.editDateField=null,this.realm=null,this.dateFieldsTimeReference=null}};u([d()],lg.prototype,"creatorField",void 0),u([d()],lg.prototype,"creationDateField",void 0),u([d()],lg.prototype,"editorField",void 0),u([d()],lg.prototype,"editDateField",void 0),u([d()],lg.prototype,"realm",void 0),u([d({type:WS})],lg.prototype,"dateFieldsTimeReference",void 0),lg=u([I("esri.layers.support.EditFieldsInfo")],lg);const Dze=lg;let Ef=class extends bs(ve){constructor(e){super(e)}};u([d({constructOnly:!0,json:{write:!0}})],Ef.prototype,"name",void 0),u([d({constructOnly:!0,json:{write:!0}})],Ef.prototype,"fields",void 0),u([d({constructOnly:!0,json:{write:!0}})],Ef.prototype,"isAscending",void 0),u([d({constructOnly:!0,json:{write:!0}})],Ef.prototype,"indexType",void 0),u([d({constructOnly:!0,json:{write:!0}})],Ef.prototype,"isUnique",void 0),u([d({constructOnly:!0,json:{write:!0}})],Ef.prototype,"description",void 0),Ef=u([I("esri.layers.support.FeatureIndex")],Ef);const G7=new mr({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"});async function Nze(t,e,r,i){const s=await vv(t);if(await LX(t,e,i),!s.addAttachment)throw new q(i,"Layer source does not support addAttachment capability");return s.addAttachment(e,r)}function LX(t,e,r){const{attributes:i}=e,{objectIdField:s}=t;return t.get("capabilities.data.supportsAttachment")?e?i?s&&i[s]?Promise.resolve():Promise.reject(new q(r,`feature is missing the identifying attribute ${s}`)):Promise.reject(new q(r,"'attributes' are required on a feature to query attachments")):Promise.reject(new q(r,"A feature is required to add/delete/update attachments")):Promise.reject(new q(r,"this layer doesn't support attachments"))}async function Fze(t,e,r,i,s){const n=await vv(t);if(await LX(t,e,s),!n.updateAttachment)throw new q(s,"Layer source does not support updateAttachment capability");return n.updateAttachment(e,r,i)}async function Uze(t,e,r){const i=await te(()=>import("./editingSupport-8be1e15d.js"),["assets/editingSupport-8be1e15d.js","assets/assetEditingSupport-2cebf928.js"]),s=await t.load();return i.applyEdits(s,s.source,e,r)}async function kze(t,e,r,i){const s=await vv(t);if(await LX(t,e,i),!s.deleteAttachments)throw new q(i,"Layer source does not support deleteAttachments capability");return s.deleteAttachments(e,r)}async function Vze(t,e,r){const i=(await t.load({signal:e==null?void 0:e.signal})).source;if(!i.fetchRecomputedExtents)throw new q(r,"Layer source does not support fetchUpdates capability");return i.fetchRecomputedExtents(e)}async function Bze(t,e,r,i){var m,y;e=mz.from(e),await t.load();const s=t.source,n=t.capabilities;if(!((m=n==null?void 0:n.data)!=null&&m.supportsAttachment))throw new q(i,"this layer doesn't support attachments");const{attachmentTypes:o,objectIds:a,globalIds:l,num:c,size:h,start:p,where:f}=e;if(!((y=n==null?void 0:n.operations)!=null&&y.supportsQueryAttachments)&&((o==null?void 0:o.length)>0||(l==null?void 0:l.length)>0||(h==null?void 0:h.length)>0||c||p||f))throw new q(i,"when 'capabilities.operations.supportsQueryAttachments' is false, only objectIds is supported",e);if(!(a!=null&&a.length||l!=null&&l.length||f))throw new q(i,"'objectIds', 'globalIds', or 'where' are required to perform attachment query",e);if(!s.queryAttachments)throw new q(i,"Layer source does not support queryAttachments capability",e);return s.queryAttachments(e)}async function zze(t,e,r,i){const s=await vv(t);if(!s.queryObjectIds)throw new q(i,"Layer source does not support queryObjectIds capability");return s.queryObjectIds(Yf.from(e)??t.createQuery(),r)}async function Gze(t,e,r,i){const s=await vv(t);if(!s.queryFeatureCount)throw new q(i,"Layer source does not support queryFeatureCount capability");return s.queryFeatureCount(Yf.from(e)??t.createQuery(),r)}async function jze(t,e,r,i){const s=await vv(t);if(!s.queryExtent)throw new q(i,"Layer source does not support queryExtent capability");return s.queryExtent(Yf.from(e)??t.createQuery(),r)}async function Hze(t,e,r,i){const s=await vv(t);if(!s.queryRelatedFeatures)throw new q(i,"Layer source does not support queryRelatedFeatures capability");return s.queryRelatedFeatures(zS.from(e),r)}async function qze(t,e,r,i){const s=await vv(t);if(!s.queryRelatedFeaturesCount)throw new q(i,"Layer source does not support queryRelatedFeaturesCount capability");return s.queryRelatedFeaturesCount(zS.from(e),r)}async function Wze(t){const e=t.source;if(e!=null&&e.refresh)try{const{dataChanged:r,updates:i}=await e.refresh();if(v(i)&&(t.sourceJSON={...t.sourceJSON,...i},t.read(i,{origin:"service",url:t.parsedUrl})),r)return!0}catch{}if(t.definitionExpression)try{return(await Uke(t.definitionExpression,t.fieldsIndex)).hasDateFunctions}catch{}return!1}function Xze(t){const e=new Yf,r=t.get("capabilities.data"),i=t.get("capabilities.query");e.historicMoment=t.historicMoment,e.gdbVersion=t.gdbVersion,e.returnGeometry=!0,i&&(e.compactGeometryEnabled=i.supportsCompactGeometry,e.defaultSpatialReferenceEnabled=i.supportsDefaultSpatialReference),r&&(r.supportsZ&&t.returnZ!=null&&(e.returnZ=t.returnZ),r.supportsM&&t.returnM!=null&&(e.returnM=t.returnM)),e.outFields=["*"];const{timeOffset:s,timeExtent:n}=t;return e.timeExtent=s!=null&&n!=null?n.offset(-s.value,s.unit):n||null,e.multipatchOption=t.geometryType==="multipatch"?"xyFootprint":null,e}function b_e(t){const{globalIdField:e,fields:r}=t;if(e)return e;if(r){for(const i of r)if(i.type==="esriFieldTypeGlobalID")return i.name}}function w_e(t){const{objectIdField:e,fields:r}=t;if(e)return e;if(r){for(const i of r)if(i.type==="esriFieldTypeOID")return i.name}}function Yze(t){return t.currentVersion?t.currentVersion:t.hasOwnProperty("capabilities")||t.hasOwnProperty("drawingInfo")||t.hasOwnProperty("hasAttachments")||t.hasOwnProperty("htmlPopupType")||t.hasOwnProperty("relationships")||t.hasOwnProperty("timeInfo")||t.hasOwnProperty("typeIdField")||t.hasOwnProperty("types")?10:9.3}async function vv(t){return(await t.load()).source}async function Zze(t,e){if(!wi||wi.findCredential(t))return;let r;try{const i=await Bhe(t,e);i&&(r=await wi.checkSignInStatus(`${i}/sharing`))}catch{}if(r)try{const i=v(e)?e.signal:null;await wi.getCredential(t,{signal:i})}catch{}}async function Jze(t,e){var s;const r=(s=t.parsedUrl)==null?void 0:s.path;if(!r)return;const i=t.editFieldsInfo;(t.userHasUpdateItemPrivileges||t.userHasFullEditingPrivileges&&t.capabilities.operations.supportsEditing||i!=null&&i.creatorField||i!=null&&i.editorField)&&await Zze(r,e)}function Kze(t){var e;return!((e=t.sourceJSON)!=null&&e.isMultiServicesView)&&(t.userHasUpdateItemPrivileges||t.editingEnabled)}let GT=class extends bs(ve){constructor(e){super(e),this.shapeAreaField=null,this.shapeLengthField=null,this.units=null}};u([d({type:String,json:{read:{source:"shapeAreaFieldName"}}})],GT.prototype,"shapeAreaField",void 0),u([d({type:String,json:{read:{source:"shapeLengthFieldName"}}})],GT.prototype,"shapeLengthField",void 0),u([d({type:String,json:{read:t=>bOe.read(t)||wOe.read(t)}})],GT.prototype,"units",void 0),GT=u([I("esri.layers.support.GeometryFieldsInfo")],GT);const Qze=GT;var j7;let jT=j7=class extends ve{constructor(t){super(t),this.floorField=null,this.viewAllMode=!1,this.viewAllLevelIds=new Pt}clone(){return new j7({floorField:this.floorField,viewAllMode:this.viewAllMode,viewAllLevelIds:this.viewAllLevelIds})}};u([d({type:String,json:{write:!0}})],jT.prototype,"floorField",void 0),u([d({json:{read:!1,write:!1}})],jT.prototype,"viewAllMode",void 0),u([d({json:{read:!1,write:!1}})],jT.prototype,"viewAllLevelIds",void 0),jT=j7=u([I("esri.layers.support.LayerFloorInfo")],jT);const e7e=jT,Vte=new mr({esriRelCardinalityOneToOne:"one-to-one",esriRelCardinalityOneToMany:"one-to-many",esriRelCardinalityManyToMany:"many-to-many"}),Bte=new mr({esriRelRoleOrigin:"origin",esriRelRoleDestination:"destination"});let oh=class extends bs(ve){constructor(e){super(e),this.cardinality=null,this.composite=null,this.id=null,this.keyField=null,this.keyFieldInRelationshipTable=null,this.name=null,this.relatedTableId=null,this.relationshipTableId=null,this.role=null}};u([d({json:{read:Vte.read,write:Vte.write}})],oh.prototype,"cardinality",void 0),u([d({json:{read:!0,write:!0}})],oh.prototype,"composite",void 0),u([d({json:{read:!0,write:!0}})],oh.prototype,"id",void 0),u([d({json:{read:!0,write:!0}})],oh.prototype,"keyField",void 0),u([d({json:{read:!0,write:!0}})],oh.prototype,"keyFieldInRelationshipTable",void 0),u([d({json:{read:!0,write:!0}})],oh.prototype,"name",void 0),u([d({json:{read:!0,write:!0}})],oh.prototype,"relatedTableId",void 0),u([d({json:{read:!0,write:!0}})],oh.prototype,"relationshipTableId",void 0),u([d({json:{read:Bte.read,write:Bte.write}})],oh.prototype,"role",void 0),oh=u([I("esri.layers.support.Relationship")],oh);const t7e=oh,r7e={name:"supportsName",size:"supportsSize",contentType:"supportsContentType",keywords:"supportsKeywords",exifInfo:"supportsExifInfo"};function Zt(t,e,r){return!!(t&&t.hasOwnProperty(e)?t[e]:r)}function FP(t,e,r){return t&&t.hasOwnProperty(e)?t[e]:r}function i7e(t){var r;const e=(r=t==null?void 0:t.supportedSpatialAggregationStatistics)==null?void 0:r.map(i=>i.toLowerCase());return{envelope:!!(e!=null&&e.includes("envelopeaggregate")),centroid:!!(e!=null&&e.includes("centroidaggregate")),convexHull:!!(e!=null&&e.includes("convexhullaggregate"))}}function TM(t,e){var i;const r=(i=t==null?void 0:t.supportedOperationsWithCacheHint)==null?void 0:i.map(s=>s.toLowerCase());return!!(r!=null&&r.includes(e.toLowerCase()))}function x_e(t,e){return{analytics:s7e(t),attachment:n7e(t),data:o7e(t),metadata:a7e(t),operations:l7e(t.capabilities,t,e),query:c7e(t,e),queryRelated:u7e(t),queryTopFeatures:h7e(t),editing:d7e(t)}}function s7e(t){return{supportsCacheHint:TM(t.advancedQueryCapabilities,"queryAnalytics")}}function n7e(t){const e=t.attachmentProperties,r={supportsName:!1,supportsSize:!1,supportsContentType:!1,supportsKeywords:!1,supportsExifInfo:!1,supportsCacheHint:TM(t.advancedQueryCapabilities,"queryAttachments"),supportsResize:Zt(t,"supportsAttachmentsResizing",!1)};return e&&Array.isArray(e)&&e.forEach(i=>{const s=r7e[i.name];s&&(r[s]=!!i.isEnabled)}),r}function o7e(t){return{isVersioned:Zt(t,"isDataVersioned",!1),supportsAttachment:Zt(t,"hasAttachments",!1),supportsM:Zt(t,"hasM",!1),supportsZ:Zt(t,"hasZ",!1)}}function a7e(t){return{supportsAdvancedFieldProperties:Zt(t,"supportsFieldDescriptionProperty",!1)}}function l7e(t,e,r){const i=t?t.toLowerCase().split(",").map(f=>f.trim()):[],s=r?LE(r):null,n=i.includes(v(s)&&s.serverType==="MapServer"?"data":"query"),o=i.includes("editing")&&!e.datesInUnknownTimezone;let a=o&&i.includes("create"),l=o&&i.includes("delete"),c=o&&i.includes("update");const h=i.includes("changetracking"),p=e.advancedQueryCapabilities;return o&&!(a||l||c)&&(a=l=c=!0),{supportsCalculate:Zt(e,"supportsCalculate",!1),supportsTruncate:Zt(e,"supportsTruncate",!1),supportsValidateSql:Zt(e,"supportsValidateSql",!1),supportsAdd:a,supportsDelete:l,supportsEditing:o,supportsChangeTracking:h,supportsQuery:n,supportsQueryAnalytics:Zt(p,"supportsQueryAnalytic",!1),supportsQueryAttachments:Zt(p,"supportsQueryAttachments",!1),supportsQueryTopFeatures:Zt(p,"supportsTopFeaturesQuery",!1),supportsResizeAttachments:Zt(e,"supportsAttachmentsResizing",!1),supportsSync:i.includes("sync"),supportsUpdate:c,supportsExceedsLimitStatistics:Zt(e,"supportsExceedsLimitStatistics",!1)}}function c7e(t,e){const r=t.advancedQueryCapabilities,i=t.ownershipBasedAccessControlForFeatures,s=t.archivingInfo,n=t.currentVersion,o=e==null?void 0:e.includes("MapServer"),a=!o||n>=de("mapserver-pbf-version-support"),l=g0e(e),c=new Set((t.supportedQueryFormats??"").split(",").map(h=>h.toLowerCase().trim()));return{supportsStatistics:Zt(r,"supportsStatistics",t.supportsStatistics),supportsPercentileStatistics:Zt(r,"supportsPercentileStatistics",!1),supportsSpatialAggregationStatistics:Zt(r,"supportsSpatialAggregationStatistics",!1),supportedSpatialAggregationStatistics:i7e(r),supportsCentroid:Zt(r,"supportsReturningGeometryCentroid",!1),supportsDistance:Zt(r,"supportsQueryWithDistance",!1),supportsDistinct:Zt(r,"supportsDistinct",t.supportsAdvancedQueries),supportsExtent:Zt(r,"supportsReturningQueryExtent",!1),supportsGeometryProperties:Zt(r,"supportsReturningGeometryProperties",!1),supportsHavingClause:Zt(r,"supportsHavingClause",!1),supportsOrderBy:Zt(r,"supportsOrderBy",t.supportsAdvancedQueries),supportsPagination:Zt(r,"supportsPagination",!1),supportsQuantization:Zt(t,"supportsCoordinatesQuantization",!1),supportsQuantizationEditMode:Zt(t,"supportsQuantizationEditMode",!1),supportsQueryGeometry:Zt(t,"supportsReturningQueryGeometry",!1),supportsResultType:Zt(r,"supportsQueryWithResultType",!1),supportsMaxRecordCountFactor:Zt(r,"supportsMaxRecordCountFactor",!1),supportsSqlExpression:Zt(r,"supportsSqlExpression",!1),supportsStandardizedQueriesOnly:Zt(t,"useStandardizedQueries",!1),supportsTopFeaturesQuery:Zt(r,"supportsTopFeaturesQuery",!1),supportsQueryByOthers:Zt(i,"allowOthersToQuery",!0),supportsHistoricMoment:Zt(s,"supportsQueryWithHistoricMoment",!1),supportsFormatPBF:a&&c.has("pbf"),supportsDisjointSpatialRelationship:Zt(r,"supportsDisjointSpatialRel",!1),supportsCacheHint:Zt(r,"supportsQueryWithCacheHint",!1)||TM(r,"query"),supportsDefaultSpatialReference:Zt(r,"supportsDefaultSR",!1),supportsCompactGeometry:l,supportsFullTextSearch:Zt(r,"supportsFullTextSearch",!1),maxRecordCountFactor:FP(t,"maxRecordCountFactor",void 0),maxRecordCount:FP(t,"maxRecordCount",void 0),standardMaxRecordCount:FP(t,"standardMaxRecordCount",void 0),tileMaxRecordCount:FP(t,"tileMaxRecordCount",void 0)}}function u7e(t){const e=t.advancedQueryCapabilities,r=Zt(e,"supportsAdvancedQueryRelated",!1);return{supportsPagination:Zt(e,"supportsQueryRelatedPagination",!1),supportsCount:r,supportsOrderBy:r,supportsCacheHint:TM(e,"queryRelated")}}function h7e(t){return{supportsCacheHint:TM(t.advancedQueryCapabilities,"queryTopFilter")}}function d7e(t){const e=t.ownershipBasedAccessControlForFeatures;return{supportsGeometryUpdate:Zt(t,"allowGeometryUpdates",!0),supportsGlobalId:Zt(t,"supportsApplyEditsWithGlobalIds",!1),supportsReturnServiceEditsInSourceSpatialReference:Zt(t,"supportsReturnServiceEditsInSourceSR",!1),supportsRollbackOnFailure:Zt(t,"supportsRollbackOnFailureParameter",!1),supportsUpdateWithoutM:Zt(t,"allowUpdateWithoutMValues",!1),supportsUploadWithItemId:Zt(t,"supportsAttachmentsByUploadId",!1),supportsDeleteByAnonymous:Zt(e,"allowAnonymousToDelete",!0),supportsDeleteByOthers:Zt(e,"allowOthersToDelete",!0),supportsUpdateByAnonymous:Zt(e,"allowAnonymousToUpdate",!0),supportsUpdateByOthers:Zt(e,"allowOthersToUpdate",!0)}}const p7e=t=>{let e=class extends t{constructor(){super(...arguments),this.capabilities=null,this.copyright=null,this.dateFieldsTimeReference=null,this.datesInUnknownTimezone=!1,this.displayField=null,this.definitionExpression=null,this.editFieldsInfo=null,this.editingInfo=null,this.elevationInfo=null,this.floorInfo=null,this.fullExtent=null,this.gdbVersion=null,this.geometryFieldsInfo=null,this.geometryType=null,this.hasM=void 0,this.hasZ=void 0,this.heightModelInfo=null,this.historicMoment=null,this.isTable=!1,this.layerId=void 0,this.minScale=0,this.maxScale=0,this.globalIdField=null,this.objectIdField=null,this.preferredTimeReference=null,this.relationships=null,this.sourceJSON=null,this.returnM=void 0,this.returnZ=void 0,this.serviceDefinitionExpression=null,this.serviceItemId=null,this.spatialReference=et.WGS84,this.subtypeField=null,this.trackIdField=null,this.indexes=new(Pt.ofType(Ef)),this.version=void 0}readCapabilitiesFromService(r,i){return x_e(i,this.url)}get effectiveCapabilities(){var o;const r=this.capabilities;if(!r)return null;const i=ne(r),{operations:s,editing:n}=i;return(o=this.sourceJSON)!=null&&o.isMultiServicesView?(this.userHasUpdateItemPrivileges&&(s.supportsQuery=!0),i):this.userHasUpdateItemPrivileges?(s.supportsAdd=s.supportsDelete=s.supportsEditing=s.supportsQuery=s.supportsUpdate=n.supportsDeleteByOthers=n.supportsGeometryUpdate=n.supportsUpdateByOthers=!0,i):(this.userHasFullEditingPrivileges&&s.supportsEditing&&(s.supportsAdd=s.supportsDelete=s.supportsUpdate=n.supportsGeometryUpdate=!0),i)}readEditingInfo(r,i){const{editingInfo:s}=i;return s?{lastEditDate:s.lastEditDate!=null?new Date(s.lastEditDate):null}:null}readIsTableFromService(r,i){return i.type==="Table"}readMinScale(r,i){return i.effectiveMinScale||r||0}readMaxScale(r,i){return i.effectiveMaxScale||r||0}readGlobalIdFieldFromService(r,i){return b_e(i)}readObjectIdFieldFromService(r,i){return w_e(i)}readServiceDefinitionExpression(r,i){return i.definitionQuery||i.definitionExpression}set url(r){const i=lVe({layer:this,url:r,nonStandardUrlAllowed:!0,logger:se.getLogger(this.declaredClass)});this._set("url",i.url),i.layerId!=null&&this._set("layerId",i.layerId)}writeUrl(r,i,s,n){cVe(this,r,null,i,n)}readVersion(r,i){return Yze(i)}};return u([d({readOnly:!0,json:{read:!1,origins:{service:{read:{source:["advancedQueryCapabilities","allowGeometryUpdates","allowUpdateWithoutMValues","archivingInfo","capabilities","datesInUnknownTimezone","hasAttachments","hasM","hasZ","maxRecordCount","maxRecordCountFactor","ownershipBasedAccessControlForFeatures","standardMaxRecordCount","supportedQueryFormats","supportsAdvancedQueries","supportsApplyEditsWithGlobalIds","supportsAttachmentsByUploadId","supportsAttachmentsResizing","supportsCalculate","supportsCoordinatesQuantization","supportsExceedsLimitStatistics","supportsFieldDescriptionProperty","supportsQuantizationEditMode","supportsRollbackOnFailureParameter","supportsStatistics","supportsTruncate","supportsValidateSql","tileMaxRecordCount","useStandardizedQueries"]}}}}})],e.prototype,"capabilities",void 0),u([Fe("service","capabilities")],e.prototype,"readCapabilitiesFromService",null),u([d({readOnly:!0})],e.prototype,"effectiveCapabilities",null),u([d({type:String,json:{origins:{service:{read:{source:"copyrightText"}}}}})],e.prototype,"copyright",void 0),u([d({type:WS})],e.prototype,"dateFieldsTimeReference",void 0),u([d({type:Boolean})],e.prototype,"datesInUnknownTimezone",void 0),u([d({type:String,json:{origins:{service:{read:{source:"displayField"}}}}})],e.prototype,"displayField",void 0),u([d({type:String,json:{origins:{service:{read:!1,write:!1}},name:"layerDefinition.definitionExpression",write:{enabled:!0,allowNull:!0}}})],e.prototype,"definitionExpression",void 0),u([d({readOnly:!0,type:Dze})],e.prototype,"editFieldsInfo",void 0),u([d({readOnly:!0})],e.prototype,"editingInfo",void 0),u([Fe("editingInfo")],e.prototype,"readEditingInfo",null),u([d((()=>{const r=ne(RVe),i=r.json.origins;return i["web-map"]={read:!1,write:!1},i["portal-item"]={read:!1,write:!1},r})())],e.prototype,"elevationInfo",void 0),u([d({type:e7e,json:{read:{source:"layerDefinition.floorInfo"},write:{target:"layerDefinition.floorInfo"}}})],e.prototype,"floorInfo",void 0),u([d({type:Zr,json:{origins:{service:{read:{source:"extent"}}}}})],e.prototype,"fullExtent",void 0),u([d()],e.prototype,"gdbVersion",void 0),u([d({readOnly:!0,type:Qze,json:{read:{source:"geometryProperties"}}})],e.prototype,"geometryFieldsInfo",void 0),u([d({type:["point","polygon","polyline","multipoint","multipatch","mesh"],json:{origins:{service:{read:G7.read}}}})],e.prototype,"geometryType",void 0),u([d({type:Boolean,json:{origins:{service:{read:!0}}}})],e.prototype,"hasM",void 0),u([d({type:Boolean,json:{origins:{service:{read:!0}}}})],e.prototype,"hasZ",void 0),u([d({readOnly:!0,type:EE})],e.prototype,"heightModelInfo",void 0),u([d({type:Date})],e.prototype,"historicMoment",void 0),u([d({readOnly:!0})],e.prototype,"isTable",void 0),u([Fe("service","isTable",["type"])],e.prototype,"readIsTableFromService",null),u([d({type:Number,json:{origins:{service:{read:{source:"id"}},"portal-item":{read:!1,write:{target:"id"}}},read:!1}})],e.prototype,"layerId",void 0),u([d(PVe)],e.prototype,"minScale",void 0),u([Fe("service","minScale",["minScale","effectiveMinScale"])],e.prototype,"readMinScale",null),u([d(IVe)],e.prototype,"maxScale",void 0),u([Fe("service","maxScale",["maxScale","effectiveMaxScale"])],e.prototype,"readMaxScale",null),u([d({type:String})],e.prototype,"globalIdField",void 0),u([Fe("service","globalIdField",["globalIdField","fields"])],e.prototype,"readGlobalIdFieldFromService",null),u([d({type:String})],e.prototype,"objectIdField",void 0),u([Fe("service","objectIdField",["objectIdField","fields"])],e.prototype,"readObjectIdFieldFromService",null),u([d({type:WS})],e.prototype,"preferredTimeReference",void 0),u([d({type:[t7e],readOnly:!0})],e.prototype,"relationships",void 0),u([d()],e.prototype,"sourceJSON",void 0),u([d({type:Boolean})],e.prototype,"returnM",void 0),u([d({type:Boolean})],e.prototype,"returnZ",void 0),u([d({readOnly:!0})],e.prototype,"serviceDefinitionExpression",void 0),u([Fe("service","serviceDefinitionExpression",["definitionQuery","definitionExpression"])],e.prototype,"readServiceDefinitionExpression",null),u([d({type:String,readOnly:!0,json:{read:!1,origins:{service:{read:!0}}}})],e.prototype,"serviceItemId",void 0),u([d({type:et,json:{origins:{service:{read:{source:"extent.spatialReference"}}}}})],e.prototype,"spatialReference",void 0),u([d({type:String,readOnly:!0,json:{origins:{service:{read:!0}}}})],e.prototype,"subtypeField",void 0),u([d({type:String,json:{read:{source:"timeInfo.trackIdField"}}})],e.prototype,"trackIdField",void 0),u([d({readOnly:!0,json:{write:!1}})],e.prototype,"serverGens",void 0),u([d({type:Pt.ofType(Ef),readOnly:!0})],e.prototype,"indexes",void 0),u([d(CVe)],e.prototype,"url",null),u([He("url")],e.prototype,"writeUrl",null),u([d({json:{origins:{service:{read:!0}},read:!1}})],e.prototype,"version",void 0),u([Fe("service","version",["currentVersion","capabilities","drawingInfo","hasAttachments","htmlPopupType","relationships","timeInfo","typeIdField","types"])],e.prototype,"readVersion",null),e=u([I("esri.layers.mixins.FeatureLayerBase")],e),e};let HT=class extends bs(ve){constructor(e){super(e),this.expression=null,this.title=null,this.returnType=null}};u([d({type:String,json:{write:!0}})],HT.prototype,"expression",void 0),u([d({type:String,json:{write:!0}})],HT.prototype,"title",void 0),u([d({type:String,json:{write:!0}})],HT.prototype,"returnType",void 0),HT=u([I("esri.layers.support.ExpressionInfo")],HT);const DX=HT;var H7;let cg=H7=class extends ve{constructor(t){super(t),this.isAutoGenerated=!1,this.name=null,this.alias=null,this.onStatisticField=null,this.onStatisticExpression=null,this.statisticType=null}clone(){return new H7({name:this.name,alias:this.alias,isAutoGenerated:this.isAutoGenerated,onStatisticExpression:ne(this.onStatisticExpression),onStatisticField:this.onStatisticField,statisticType:this.statisticType})}};u([d({type:Boolean,json:{write:!0}})],cg.prototype,"isAutoGenerated",void 0),u([d({type:String,json:{write:!0}})],cg.prototype,"name",void 0),u([d({type:String,json:{write:!0}})],cg.prototype,"alias",void 0),u([d({type:String,json:{write:!0}})],cg.prototype,"onStatisticField",void 0),u([d({type:DX,json:{write:!0}})],cg.prototype,"onStatisticExpression",void 0),u([d({type:String,json:{write:!0}})],cg.prototype,"statisticType",void 0),cg=H7=u([I("esri.layers.support.AggregateField")],cg);const Sw=cg;let N_=class extends ve{constructor(){super(...arguments),this.type=null}};u([d({type:["selection","cluster","binning"],readOnly:!0,json:{read:!1,write:!0}})],N_.prototype,"type",void 0),N_=u([I("esri.layers.support.FeatureReduction")],N_);const NX="__begin__",FX="__end__",f7e=new RegExp(NX,"ig"),m7e=new RegExp(FX,"ig"),zte=new RegExp("^"+NX,"i"),Gte=new RegExp(FX+"$","i"),jN='"',g7e=jN+" + ",y7e=" + "+jN;function _7e(t){return t.replace(new RegExp("\\[","g"),"{").replace(new RegExp("\\]","g"),"}")}function v7e(t){return t.replace(new RegExp("\\{","g"),"[").replace(new RegExp("\\}","g"),"]")}function c5(t){const e={expression:"",type:"none"};return t.labelExpressionInfo?t.labelExpressionInfo.value?(e.expression=t.labelExpressionInfo.value,e.type="conventional"):t.labelExpressionInfo.expression&&(e.expression=t.labelExpressionInfo.expression,e.type="arcade"):t.labelExpression!=null&&(e.expression=_7e(t.labelExpression),e.type="conventional"),e}function b7e(t){const e=c5(t);if(!e)return null;switch(e.type){case"conventional":return q7(e.expression);case"arcade":return e.expression}return null}function w7e(t){const e=c5(t);if(!e)return null;switch(e.type){case"conventional":return T7e(e.expression);case"arcade":return UX(e.expression)}return null}function q7(t){let e;return t?(e=tm(t,r=>NX+'$feature["'+r+'"]'+FX),e=zte.test(e)?e.replace(zte,""):jN+e,e=Gte.test(e)?e.replace(Gte,""):e+jN,e=e.replace(f7e,g7e).replace(m7e,y7e)):e='""',e}const x7e=/^\s*\{([^}]+)\}\s*$/i;function T7e(t){const e=t==null?void 0:t.match(x7e);return e&&e[1].trim()||null}const S7e=/^\s*(?:(?:\$feature\.(\w+))|(?:\$feature\[(["'])([\w\s]+)(\2)\]));?\s*$/i,E7e=/^\s*(?:(?:\$feature\.(\w+))|(?:\$feature\[(["'])([\w\s]+)(\2)\]));?\s*(?:DomainName\(\s*\$feature\s*,\s*(["'])(\1|\3)(\5)\s*\));?\s*$/i,C7e=/^\s*(?:DomainName\(\s*\$feature\s*,\s*(["'])([\w\s]+)(\1)\s*\));?\s*$/i;function UX(t){if(!t)return null;let e=S7e.exec(t)||E7e.exec(t);return e?e[1]||e[3]:(e=C7e.exec(t),e?e[2]:null)}var W7;let L0=W7=class extends ve{constructor(){super(...arguments),this.expression=null,this.title=null,this.value=null}readExpression(t,e){return e.value?q7(e.value):t}writeExpression(t,e,r){this.value!=null&&(t=q7(this.value)),t!=null&&(e[r]=t)}clone(){return new W7({expression:this.expression,title:this.title,value:this.value})}};u([d({type:String,json:{write:{writerEnsuresNonNull:!0}}})],L0.prototype,"expression",void 0),u([Fe("expression",["expression","value"])],L0.prototype,"readExpression",null),u([He("expression")],L0.prototype,"writeExpression",null),u([d({type:String,json:{write:!0,origins:{"web-scene":{write:!1}}}})],L0.prototype,"title",void 0),u([d({json:{read:!1,write:!1}})],L0.prototype,"value",void 0),L0=W7=u([I("esri.layers.support.LabelExpressionInfo")],L0);const T_e=L0,S_e=[252,146,31,255],CSt=[153,153,153,255],A7e={type:"esriSMS",style:"esriSMSCircle",size:6,color:S_e,outline:{type:"esriSLS",style:"esriSLSSolid",width:.75,color:[153,153,153,255]}},R7e={type:"esriSLS",style:"esriSLSSolid",width:.75,color:S_e},O7e={type:"esriSFS",style:"esriSFSSolid",color:[252,146,31,196],outline:{type:"esriSLS",style:"esriSLSSolid",width:.75,color:[255,255,255,191]}},M7e={type:"esriTS",color:[255,255,255,255],font:{family:"arial-unicode-ms",size:10,weight:"bold"},horizontalAlignment:"center",kerning:!0,haloColor:[0,0,0,255],haloSize:1,rotated:!1,text:"",xoffset:0,yoffset:0,angle:0},P7e={type:"esriSMS",style:"esriSMSCircle",color:[0,0,0,255],outline:null,size:10.5},I7e={type:"esriSLS",style:"esriSLSSolid",color:[0,0,0,255],width:1.5},$7e={type:"esriSFS",style:"esriSFSSolid",color:[0,0,0,255],outline:null},ASt=yv.fromJSON(A7e),RSt=Yh.fromJSON(R7e),OSt=gv.fromJSON(O7e),L7e=SE.fromJSON(M7e);yv.fromJSON(P7e);Yh.fromJSON(I7e);gv.fromJSON($7e);var X7;const UP=new mr({esriServerPointLabelPlacementAboveCenter:"above-center",esriServerPointLabelPlacementAboveLeft:"above-left",esriServerPointLabelPlacementAboveRight:"above-right",esriServerPointLabelPlacementBelowCenter:"below-center",esriServerPointLabelPlacementBelowLeft:"below-left",esriServerPointLabelPlacementBelowRight:"below-right",esriServerPointLabelPlacementCenterCenter:"center-center",esriServerPointLabelPlacementCenterLeft:"center-left",esriServerPointLabelPlacementCenterRight:"center-right",esriServerLinePlacementAboveAfter:"above-after",esriServerLinePlacementAboveAlong:"above-along",esriServerLinePlacementAboveBefore:"above-before",esriServerLinePlacementAboveStart:"above-start",esriServerLinePlacementAboveEnd:"above-end",esriServerLinePlacementBelowAfter:"below-after",esriServerLinePlacementBelowAlong:"below-along",esriServerLinePlacementBelowBefore:"below-before",esriServerLinePlacementBelowStart:"below-start",esriServerLinePlacementBelowEnd:"below-end",esriServerLinePlacementCenterAfter:"center-after",esriServerLinePlacementCenterAlong:"center-along",esriServerLinePlacementCenterBefore:"center-before",esriServerLinePlacementCenterStart:"center-start",esriServerLinePlacementCenterEnd:"center-end",esriServerPolygonPlacementAlwaysHorizontal:"always-horizontal"},{ignoreUnknown:!0});function kP(t,e,r){return{enabled:!khe(r==null?void 0:r.layer)}}function E_e(t){var e;return!t||t.origin!=="service"&&((e=t.layer)==null?void 0:e.type)!=="map-image"}function D7e(t){return(t==null?void 0:t.type)==="map-image"}function C_e(t){var e,r;return!!D7e(t)&&!!((r=(e=t.capabilities)==null?void 0:e.exportMap)!=null&&r.supportsArcadeExpressionForLabeling)}function N7e(t){return E_e(t)||C_e(t==null?void 0:t.layer)}let ln=X7=class extends ve{static evaluateWhere(t,e){const r=(i,s,n)=>{switch(s){case"=":return i==n;case"<>":return i!=n;case">":return i>n;case">=":return i>=n;case"<":return i<n;case"<=":return i<=n}return!1};try{if(t==null)return!0;const i=t.split(" ");if(i.length===3)return r(e[i[0]],i[1],i[2]);if(i.length===7){const s=r(e[i[0]],i[1],i[2]),n=i[3],o=r(e[i[4]],i[5],i[6]);switch(n){case"AND":return s&&o;case"OR":return s||o}}return!1}catch{console.log("Error.: can't parse = "+t)}}constructor(t){super(t),this.type="label",this.name=null,this.allowOverrun=!1,this.deconflictionStrategy="static",this.labelExpression=null,this.labelExpressionInfo=null,this.labelPlacement=null,this.labelPosition="curved",this.maxScale=0,this.minScale=0,this.repeatLabel=!0,this.repeatLabelDistance=null,this.symbol=L7e,this.useCodedValues=void 0,this.where=null}readLabelExpression(t,e){const r=e.labelExpressionInfo;if(!r||!r.value&&!r.expression)return t}writeLabelExpression(t,e,r){if(this.labelExpressionInfo){if(this.labelExpressionInfo.value!=null)t=v7e(this.labelExpressionInfo.value);else if(this.labelExpressionInfo.expression!=null){const i=UX(this.labelExpressionInfo.expression);i&&(t="["+i+"]")}}t!=null&&(e[r]=t)}writeLabelExpressionInfo(t,e,r,i){if(t==null&&this.labelExpression!=null&&E_e(i))t=new T_e({expression:this.getLabelExpressionArcade()});else if(!t)return;const s=t.toJSON(i);s.expression&&(e[r]=s)}writeMaxScale(t,e){(t||this.minScale)&&(e.maxScale=t)}writeMinScale(t,e){(t||this.maxScale)&&(e.minScale=t)}getLabelExpression(){return c5(this)}getLabelExpressionArcade(){return b7e(this)}getLabelExpressionSingleField(){return w7e(this)}hash(){return JSON.stringify(this)}clone(){return new X7({allowOverrun:this.allowOverrun,deconflictionStrategy:this.deconflictionStrategy,labelExpression:this.labelExpression,labelExpressionInfo:ne(this.labelExpressionInfo),labelPosition:this.labelPosition,labelPlacement:this.labelPlacement,maxScale:this.maxScale,minScale:this.minScale,name:this.name,repeatLabel:this.repeatLabel,repeatLabelDistance:this.repeatLabelDistance,symbol:ne(this.symbol),where:this.where,useCodedValues:this.useCodedValues})}};u([d({type:String,json:{write:!0}})],ln.prototype,"name",void 0),u([d({type:Boolean,json:{write:!0,default:!1,origins:{"web-scene":{write:!1},"portal-item":{default:!1,write:{overridePolicy:kP}}}}})],ln.prototype,"allowOverrun",void 0),u([d({type:String,json:{write:!0,default:"static",origins:{"web-scene":{write:!1},"portal-item":{default:"static",write:{overridePolicy:kP}}}}})],ln.prototype,"deconflictionStrategy",void 0),u([d({type:String,json:{write:{overridePolicy(t,e,r){return this.labelExpressionInfo&&(r==null?void 0:r.origin)==="service"&&C_e(r.layer)?{enabled:!1}:{allowNull:!0}}}}})],ln.prototype,"labelExpression",void 0),u([Fe("labelExpression")],ln.prototype,"readLabelExpression",null),u([He("labelExpression")],ln.prototype,"writeLabelExpression",null),u([d({type:T_e,json:{write:{overridePolicy:(t,e,r)=>N7e(r)?{allowNull:!0}:{enabled:!1}}}})],ln.prototype,"labelExpressionInfo",void 0),u([He("labelExpressionInfo")],ln.prototype,"writeLabelExpressionInfo",null),u([d({type:UP.apiValues,json:{type:UP.jsonValues,read:UP.read,write:UP.write}})],ln.prototype,"labelPlacement",void 0),u([d({type:["curved","parallel"],json:{write:!0,origins:{"web-map":{write:!1},"web-scene":{write:!1},"portal-item":{write:!1}}}})],ln.prototype,"labelPosition",void 0),u([d({type:Number})],ln.prototype,"maxScale",void 0),u([He("maxScale")],ln.prototype,"writeMaxScale",null),u([d({type:Number})],ln.prototype,"minScale",void 0),u([He("minScale")],ln.prototype,"writeMinScale",null),u([d({type:Boolean,json:{write:!0,origins:{"web-scene":{write:!1},"portal-item":{write:{overridePolicy:kP}}}}})],ln.prototype,"repeatLabel",void 0),u([d({type:Number,cast:hi,json:{write:!0,origins:{"web-scene":{write:!1},"portal-item":{write:{overridePolicy:kP}}}}})],ln.prototype,"repeatLabelDistance",void 0),u([d({types:tLe,json:{origins:{"web-scene":{types:rLe,write:zee,default:null}},write:zee,default:null}})],ln.prototype,"symbol",void 0),u([d({type:Boolean,json:{write:!0}})],ln.prototype,"useCodedValues",void 0),u([d({type:String,json:{write:!0}})],ln.prototype,"where",void 0),ln=X7=u([I("esri.layers.support.LabelClass")],ln);const u5=ln;var Y7;const BU=dv({types:O4}),F7e="esri.layers.support.FeatureReductionBinning";let xl=Y7=class extends N_{constructor(t){super(t),this.type="binning",this.binType="geohash",this.fixedBinLevel=3,this.labelingInfo=null,this.labelsVisible=!0,this.maxScale=0,this.popupEnabled=!0,this.popupTemplate=null,this.fields=[],this.renderer=null}writeFields(t,e,r){const i=t.filter(s=>s.statisticType!=="avg_angle").map(s=>s.toJSON());el(r,i,e)}readRenderer(t,e,r){var s;const i=(s=e.drawingInfo)==null?void 0:s.renderer;return i?kN(i,e,r)??void 0:e.defaultSymbol?e.types&&e.types.length?new _M({defaultSymbol:BU(e.defaultSymbol,e,r),field:e.typeIdField,uniqueValueInfos:e.types.map(n=>({id:n.id,symbol:BU(n.symbol,n,r)}))}):new jS({symbol:BU(e.defaultSymbol,e,r)}):null}clone(){return new Y7({fields:ne(this.fields),fixedBinLevel:this.fixedBinLevel,labelingInfo:ne(this.labelingInfo),labelsVisible:this.labelsVisible,maxScale:this.maxScale,popupEnabled:this.popupEnabled,popupTemplate:ne(this.popupTemplate),renderer:ne(this.renderer)})}};u([gt({binning:"binning"})],xl.prototype,"type",void 0),u([gt({geohash:"geohash"})],xl.prototype,"binType",void 0),u([d({type:Number,range:{min:1,max:9},json:{write:!0}})],xl.prototype,"fixedBinLevel",void 0),u([d({type:[u5],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],xl.prototype,"labelingInfo",void 0),u([d(CX)],xl.prototype,"labelsVisible",void 0),u([d({type:Number,json:{default:0,name:"visibilityInfo.maxScale"}})],xl.prototype,"maxScale",void 0),u([d(EX)],xl.prototype,"popupEnabled",void 0),u([d({type:rM,json:{name:"popupInfo",write:!0}})],xl.prototype,"popupTemplate",void 0),u([d({type:[Sw],json:{write:!0}})],xl.prototype,"fields",void 0),u([He("fields")],xl.prototype,"writeFields",null),u([d({types:s5,json:{write:{target:"drawingInfo.renderer"}}})],xl.prototype,"renderer",void 0),u([Fe("renderer",["drawingInfo.renderer"])],xl.prototype,"readRenderer",null),xl=Y7=u([I(F7e)],xl);const A_e=xl;var Z7;const zU=dv({types:O4}),U7e="esri.layers.support.FeatureReductionCluster";function jte(t){var e;return t.type==="simple"&&!((e=t.visualVariables)!=null&&e.length)}let jn=Z7=class extends ve{constructor(t){super(t),this.type="cluster",this.clusterRadius=hi("80px"),this.clusterMinSize=hi("12px"),this.clusterMaxSize=hi("50px"),this.maxScale=0,this.popupEnabled=!0,this.popupTemplate=null,this.renderer=null,this.symbol=null,this.labelingInfo=null,this.labelsVisible=!0,this.fields=null}readRenderer(t,e,r){var s,n;const i=(s=e.drawingInfo)==null?void 0:s.renderer;return(n=i==null?void 0:i.authoringInfo)!=null&&n.isAutoGenerated?null:i?jte(i)?null:kN(i,e,r)??void 0:e.defaultSymbol?e.types&&e.types.length?new _M({defaultSymbol:zU(e.defaultSymbol,e,r),field:e.typeIdField,uniqueValueInfos:e.types.map(o=>({id:o.id,symbol:zU(o.symbol,o,r)}))}):new jS({symbol:zU(e.defaultSymbol,e,r)}):null}readSymbol(t,e,r){var s,n,o;const i=(s=e.drawingInfo)==null?void 0:s.renderer;return(n=i==null?void 0:i.authoringInfo)!=null&&n.isAutoGenerated?null:i&&jte(i)?(o=kN(i,e,r))==null?void 0:o.symbol:null}writeSymbol(t,e,r,i){var n,o;const s=(o=(n=this.renderer)==null?void 0:n.authoringInfo)==null?void 0:o.isAutoGenerated;if(!this.renderer||s){const a=new jS({symbol:t});e.drawingInfo={renderer:a.write({},i)}}}writeFields(t,e,r){const i=t.filter(s=>s.statisticType!=="avg_angle").map(s=>s.toJSON());el(r,i,e)}readFields(t,e,r){return t.filter(i=>!i.isAutoGenerated).map(i=>Sw.fromJSON(i))}clone(){return new Z7({clusterRadius:this.clusterRadius,clusterMinSize:this.clusterMinSize,clusterMaxSize:this.clusterMaxSize,labelingInfo:ne(this.labelingInfo),labelsVisible:this.labelsVisible,fields:ne(this.fields),maxScale:this.maxScale,renderer:ne(this.renderer),symbol:ne(this.symbol),popupEnabled:this.popupEnabled,popupTemplate:ne(this.popupTemplate)})}};u([d({type:["cluster"],readOnly:!0,json:{write:!0}})],jn.prototype,"type",void 0),u([d({type:Number,cast:t=>t==="auto"?t:hi(t),json:{write:!0}})],jn.prototype,"clusterRadius",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],jn.prototype,"clusterMinSize",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],jn.prototype,"clusterMaxSize",void 0),u([d({type:Number,json:{default:0,name:"visibilityInfo.maxScale"}})],jn.prototype,"maxScale",void 0),u([d(EX)],jn.prototype,"popupEnabled",void 0),u([d({type:rM,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],jn.prototype,"popupTemplate",void 0),u([d({types:s5,json:{write:{target:"drawingInfo.renderer"}}})],jn.prototype,"renderer",void 0),u([Fe("renderer",["drawingInfo.renderer"])],jn.prototype,"readRenderer",null),u([d({types:Q$e})],jn.prototype,"symbol",void 0),u([Fe("symbol",["drawingInfo.renderer"])],jn.prototype,"readSymbol",null),u([He("symbol")],jn.prototype,"writeSymbol",null),u([d({type:[u5],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],jn.prototype,"labelingInfo",void 0),u([d(CX)],jn.prototype,"labelsVisible",void 0),u([d({type:[Sw],json:{write:!0}})],jn.prototype,"fields",void 0),u([He("fields")],jn.prototype,"writeFields",null),u([Fe("fields")],jn.prototype,"readFields",null),jn=Z7=u([I(U7e)],jn);const R_e=jn;var J7;let HL=J7=class extends N_{constructor(t){super(t),this.type="selection"}clone(){return new J7}};u([d({type:["selection"]})],HL.prototype,"type",void 0),HL=J7=u([I("esri.layers.support.FeatureReductionSelection")],HL);const Hte=HL,qte={key:"type",base:N_,typeMap:{cluster:R_e,binning:A_e}},k7e={types:{key:"type",base:N_,typeMap:{selection:Hte,cluster:R_e,binning:A_e}},json:{name:"layerDefinition.featureReduction",write:{allowNull:!0},origins:{"web-map":{types:qte},"portal-item":{types:qte},"web-scene":{types:{key:"type",base:N_,typeMap:{selection:Hte}}}}}},mx={Base64:0,Hex:1,String:2,Raw:3},Q2=8,O_e=(1<<Q2)-1;function A_(t,e){const r=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(r>>16)<<16|65535&r}function V7e(t){const e=[];for(let r=0,i=t.length*Q2;r<i;r+=Q2)e[r>>5]|=(t.charCodeAt(r/Q2)&O_e)<<r%32;return e}function B7e(t){const e=[];for(let r=0,i=32*t.length;r<i;r+=Q2)e.push(String.fromCharCode(t[r>>5]>>>r%32&O_e));return e.join("")}function z7e(t){const e="0123456789abcdef",r=[];for(let i=0,s=4*t.length;i<s;i++)r.push(e.charAt(t[i>>2]>>i%4*8+4&15)+e.charAt(t[i>>2]>>i%4*8&15));return r.join("")}function G7e(t){const e="=",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=[];for(let s=0,n=4*t.length;s<n;s+=3){const o=(t[s>>2]>>s%4*8&255)<<16|(t[s+1>>2]>>(s+1)%4*8&255)<<8|t[s+2>>2]>>(s+2)%4*8&255;for(let a=0;a<4;a++)8*s+6*a>32*t.length?i.push(e):i.push(r.charAt(o>>6*(3-a)&63))}return i.join("")}function j7e(t,e){return t<<e|t>>>32-e}function h5(t,e,r,i,s,n){return A_(j7e(A_(A_(e,t),A_(i,n)),s),r)}function Ra(t,e,r,i,s,n,o){return h5(e&r|~e&i,t,e,s,n,o)}function Oa(t,e,r,i,s,n,o){return h5(e&i|r&~i,t,e,s,n,o)}function Ma(t,e,r,i,s,n,o){return h5(e^r^i,t,e,s,n,o)}function Pa(t,e,r,i,s,n,o){return h5(r^(e|~i),t,e,s,n,o)}function H7e(t,e){t[e>>5]|=128<<e%32,t[14+(e+64>>>9<<4)]=e;let r=1732584193,i=-271733879,s=-1732584194,n=271733878;for(let o=0;o<t.length;o+=16){const a=r,l=i,c=s,h=n;r=Ra(r,i,s,n,t[o+0],7,-680876936),n=Ra(n,r,i,s,t[o+1],12,-389564586),s=Ra(s,n,r,i,t[o+2],17,606105819),i=Ra(i,s,n,r,t[o+3],22,-1044525330),r=Ra(r,i,s,n,t[o+4],7,-176418897),n=Ra(n,r,i,s,t[o+5],12,1200080426),s=Ra(s,n,r,i,t[o+6],17,-1473231341),i=Ra(i,s,n,r,t[o+7],22,-45705983),r=Ra(r,i,s,n,t[o+8],7,1770035416),n=Ra(n,r,i,s,t[o+9],12,-1958414417),s=Ra(s,n,r,i,t[o+10],17,-42063),i=Ra(i,s,n,r,t[o+11],22,-1990404162),r=Ra(r,i,s,n,t[o+12],7,1804603682),n=Ra(n,r,i,s,t[o+13],12,-40341101),s=Ra(s,n,r,i,t[o+14],17,-1502002290),i=Ra(i,s,n,r,t[o+15],22,1236535329),r=Oa(r,i,s,n,t[o+1],5,-165796510),n=Oa(n,r,i,s,t[o+6],9,-1069501632),s=Oa(s,n,r,i,t[o+11],14,643717713),i=Oa(i,s,n,r,t[o+0],20,-373897302),r=Oa(r,i,s,n,t[o+5],5,-701558691),n=Oa(n,r,i,s,t[o+10],9,38016083),s=Oa(s,n,r,i,t[o+15],14,-660478335),i=Oa(i,s,n,r,t[o+4],20,-405537848),r=Oa(r,i,s,n,t[o+9],5,568446438),n=Oa(n,r,i,s,t[o+14],9,-1019803690),s=Oa(s,n,r,i,t[o+3],14,-187363961),i=Oa(i,s,n,r,t[o+8],20,1163531501),r=Oa(r,i,s,n,t[o+13],5,-1444681467),n=Oa(n,r,i,s,t[o+2],9,-51403784),s=Oa(s,n,r,i,t[o+7],14,1735328473),i=Oa(i,s,n,r,t[o+12],20,-1926607734),r=Ma(r,i,s,n,t[o+5],4,-378558),n=Ma(n,r,i,s,t[o+8],11,-2022574463),s=Ma(s,n,r,i,t[o+11],16,1839030562),i=Ma(i,s,n,r,t[o+14],23,-35309556),r=Ma(r,i,s,n,t[o+1],4,-1530992060),n=Ma(n,r,i,s,t[o+4],11,1272893353),s=Ma(s,n,r,i,t[o+7],16,-155497632),i=Ma(i,s,n,r,t[o+10],23,-1094730640),r=Ma(r,i,s,n,t[o+13],4,681279174),n=Ma(n,r,i,s,t[o+0],11,-358537222),s=Ma(s,n,r,i,t[o+3],16,-722521979),i=Ma(i,s,n,r,t[o+6],23,76029189),r=Ma(r,i,s,n,t[o+9],4,-640364487),n=Ma(n,r,i,s,t[o+12],11,-421815835),s=Ma(s,n,r,i,t[o+15],16,530742520),i=Ma(i,s,n,r,t[o+2],23,-995338651),r=Pa(r,i,s,n,t[o+0],6,-198630844),n=Pa(n,r,i,s,t[o+7],10,1126891415),s=Pa(s,n,r,i,t[o+14],15,-1416354905),i=Pa(i,s,n,r,t[o+5],21,-57434055),r=Pa(r,i,s,n,t[o+12],6,1700485571),n=Pa(n,r,i,s,t[o+3],10,-1894986606),s=Pa(s,n,r,i,t[o+10],15,-1051523),i=Pa(i,s,n,r,t[o+1],21,-2054922799),r=Pa(r,i,s,n,t[o+8],6,1873313359),n=Pa(n,r,i,s,t[o+15],10,-30611744),s=Pa(s,n,r,i,t[o+6],15,-1560198380),i=Pa(i,s,n,r,t[o+13],21,1309151649),r=Pa(r,i,s,n,t[o+4],6,-145523070),n=Pa(n,r,i,s,t[o+11],10,-1120210379),s=Pa(s,n,r,i,t[o+2],15,718787259),i=Pa(i,s,n,r,t[o+9],21,-343485551),r=A_(r,a),i=A_(i,l),s=A_(s,c),n=A_(n,h)}return[r,i,s,n]}function M_e(t,e=mx.Hex){const r=e||mx.Base64,i=H7e(V7e(t),t.length*Q2);switch(r){case mx.Raw:return i;case mx.Hex:return z7e(i);case mx.String:return B7e(i);case mx.Base64:return G7e(i)}}var K7;let ZA=K7=class extends i5{writeLevels(t,e,r){for(const i in t){const s=this.levels[i];return void(e.stops=s)}}clone(){return new K7({axis:this.axis,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,maxDataValue:this.maxDataValue,maxSize:C_(this.maxSize)?this.maxSize.clone():this.maxSize,minDataValue:this.minDataValue,minSize:C_(this.minSize)?this.minSize.clone():this.minSize,normalizationField:this.normalizationField,stops:this.stops&&this.stops.map(t=>t.clone()),target:this.target,useSymbolValue:this.useSymbolValue,valueRepresentation:this.valueRepresentation,valueUnit:this.valueUnit,legendOptions:this.legendOptions&&this.legendOptions.clone(),levels:ne(this.levels)})}};u([d()],ZA.prototype,"levels",void 0),u([He("levels")],ZA.prototype,"writeLevels",null),ZA=K7=u([I("esri.views.2d.engine.LevelDependentSizeVariable")],ZA);const q7e=se.getLogger("esri.views.2d.layers.support.clusterUtils");de.add("esri-cluster-arcade-enabled",!0);const W7e=de("esri-cluster-arcade-enabled"),X7e=(t,e,r,i,s)=>{const n=e.clone();if(!K7e(n))return n;if(n.authoringInfo||(n.authoringInfo=new yX),n.authoringInfo.isAutoGenerated=!0,"visualVariables"in n){const o=(n.visualVariables||[]).filter(l=>l.valueExpression!=="$view.scale"),a=Y7e(o);o.forEach(l=>{l.type==="rotation"?l.field?l.field=Mv(t,l.field,"avg_angle","number"):l.valueExpression&&(l.field=yC(t,l.valueExpression,"avg_angle","number"),l.valueExpression=null):l.normalizationField?(l.field=Mv(t,l.field,"avg_norm","number",l.normalizationField),l.normalizationField=null):l.field?l.field=Mv(t,l.field,"avg","number"):l.valueExpression&&(l.field=yC(t,l.valueExpression,"avg","number"),l.valueExpression=null)}),C(a)&&!Z7e(o)&&s&&(o.push(J7e(r,i)),n.dynamicClusterSize=!0),n.visualVariables=o}switch(n.type){case"simple":break;case"pie-chart":for(const o of n.attributes)o.field?o.field=Mv(t,o.field,"sum","number"):o.valueExpression&&(o.field=yC(t,o.valueExpression,"sum","number"),o.valueExpression=null);break;case"unique-value":n.field?n.field=Mv(t,n.field,"mode","string"):n.valueExpression&&(n.field=yC(t,n.valueExpression,"mode","string"),n.valueExpression=null);break;case"class-breaks":n.normalizationField?(n.field=Mv(t,n.field,"avg_norm","number",n.normalizationField),n.normalizationField=null):n.field?n.field=Mv(t,n.field,"avg","number"):n.valueExpression&&(n.field=yC(t,n.valueExpression,"avg","number"),n.valueExpression=null)}return n},Y7e=t=>{for(const e of t)if(e.type==="size")return e;return null},Z7e=t=>{for(const e of t)if(e.field==="cluster_count")return!0;return!1},J7e=(t,e)=>{const r=[new FT({value:0,size:0}),new FT({value:1})];if(C(e))return new i5({field:"cluster_count",stops:[...r,new FT({value:2,size:0})]});const i=Object.keys(e).reduce((s,n)=>({...s,[n]:[...r,new FT({value:Math.max(2,e[n].minValue),size:t.clusterMinSize}),new FT({value:Math.max(3,e[n].maxValue),size:t.clusterMaxSize})]}),{});return new ZA({field:"cluster_count",levels:i})},K7e=t=>{const e=r=>q7e.error(new q("Unsupported-renderer",r,{renderer:t}));switch(t.type){case"unique-value":if(t.field2||t.field3)return e("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1;break;case"class-breaks":if(t.normalizationField){const r=t.normalizationType;if(r!=="field")return e(`FeatureReductionCluster does not support a normalizationType of ${r}`),!1}break;case"simple":case"pie-chart":break;default:return e(`FeatureReductionCluster does not support renderers of type ${t.type}`),!1}if(!W7e){if("valueExpression"in t&&t.valueExpression)return e("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in t&&t.visualVariables||[]).some(r=>!(!("valueExpression"in r)||!r.valueExpression)))return e("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),!1}return!0};function Q7e(t,e,r){switch(t){case"sum":return`cluster_sum_${e}`;case"avg":case"avg_angle":return`cluster_avg_${e}`;case"mode":return`cluster_type_${e}`;case"avg_norm":{const i=r,s="field",n=e.toLowerCase()+",norm:"+s+","+i.toLowerCase();return"cluster_avg_"+M_e(n)}}}function yC(t,e,r,i){const s=M_e(e),n=r==="mode"?`cluster_type_${s}`:r==="sum"?`cluster_sum_${s}`:`cluster_avg_${s}`;return t.some(o=>o.name===n)||t.push(new Sw({name:n,isAutoGenerated:!0,onStatisticExpression:new DX({expression:e,returnType:i}),statisticType:r})),n}function Mv(t,e,r,i,s){if(e==="cluster_count"||t.some(o=>o.name===e))return e;const n=Q7e(r,e,s);return t.some(o=>o.name===n)||(r==="avg_norm"?t.push(new Sw({name:n,isAutoGenerated:!0,onStatisticExpression:new DX({expression:`$feature.${e} / $feature.${s}`,returnType:i}),statisticType:"avg"})):t.push(new Sw({name:n,isAutoGenerated:!0,onStatisticField:e,statisticType:r}))),n}const eGe=t=>{let e=class extends t{constructor(...r){super(...r),this.own(this.watch("renderer",()=>{if(this.featureReduction){const i=this._normalizeFeatureReduction(this.featureReduction);this._set("featureReduction",i)}},!0))}set featureReduction(r){const i=this._normalizeFeatureReduction(r);this._set("featureReduction",i)}set renderer(r){}_normalizeFeatureReduction(r){var a;if((r==null?void 0:r.type)!=="cluster")return r;const i=r.clone(),s=[new Sw({name:"cluster_count",isAutoGenerated:!0,statisticType:"count"})],n=(i.fields??[]).filter(l=>!l.isAutoGenerated);if(r.renderer&&!((a=r.renderer.authoringInfo)!=null&&a.isAutoGenerated))return i.fields=[...s,...n],i;if(r.symbol)return i.fields=[...s,...n],i.renderer=null,i;if(!this.renderer)return r;const o=X7e(s,this.renderer,r,null,!1);return i.fields=[...s,...n],i.renderer=o,i}};return u([d(k7e)],e.prototype,"featureReduction",null),e=u([I("esri.layers.mixins.FeatureReductionLayer")],e),e},tGe={"web-scene/operational-layers":{ArcGISDimensionLayer:!0,ArcGISFeatureLayer:!0,ArcGISImageServiceLayer:!0,ArcGISMapServiceLayer:!0,ArcGISSceneServiceLayer:!0,ArcGISTiledElevationServiceLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,BuildingSceneLayer:!0,GroupLayer:!0,IntegratedMeshLayer:!0,OGCFeatureLayer:!0,PointCloudLayer:!0,WebTiledLayer:!0,CSV:!0,GeoJSON:!0,VectorTileLayer:!0,WFS:!0,WMS:!0,KML:!0,RasterDataLayer:!0,Voxel:!0,LineOfSightLayer:!0},"web-scene/basemap":{ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,WebTiledLayer:!0,OpenStreetMap:!0,VectorTileLayer:!0,ArcGISImageServiceLayer:!0,WMS:!0,ArcGISMapServiceLayer:!0,ArcGISSceneServiceLayer:!0},"web-scene/ground":{ArcGISTiledElevationServiceLayer:!0,RasterDataElevationLayer:!0},"web-map/operational-layers":{ArcGISAnnotationLayer:!0,ArcGISDimensionLayer:!0,ArcGISFeatureLayer:!0,ArcGISImageServiceLayer:!0,ArcGISImageServiceVectorLayer:!0,ArcGISMapServiceLayer:!0,ArcGISStreamLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,BingMapsAerial:!0,BingMapsHybrid:!0,BingMapsRoad:!0,CSV:!0,GeoRSS:!0,GeoJSON:!0,GroupLayer:!0,KML:!0,MediaLayer:!0,OGCFeatureLayer:!0,OrientedImageryLayer:!0,SubtypeGroupLayer:!0,VectorTileLayer:!0,WFS:!0,WMS:!0,WebTiledLayer:!0},"web-map/basemap":{ArcGISImageServiceLayer:!0,ArcGISImageServiceVectorLayer:!0,ArcGISMapServiceLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,OpenStreetMap:!0,VectorTileLayer:!0,WMS:!0,WebTiledLayer:!0,BingMapsAerial:!0,BingMapsRoad:!0,BingMapsHybrid:!0},"web-map/tables":{ArcGISFeatureLayer:!0},"portal-item/operational-layers":{ArcGISFeatureLayer:!0,ArcGISSceneServiceLayer:!0,PointCloudLayer:!0,BuildingSceneLayer:!0,IntegratedMeshLayer:!0,OrientedImageryLayer:!0}},rGe=t=>{let e=class extends t{constructor(){super(...arguments),this.title=null}writeListMode(r,i,s,n){(n&&n.layerContainerType==="ground"||r&&hRe(this,s,{},n))&&(i[s]=r)}writeOperationalLayerType(r,i,s,n){!r||n&&n.layerContainerType==="tables"||(i.layerType=r)}writeTitle(r,i){i.title=r??"Layer"}read(r,i){i&&(i.layer=this),lRe(this,r,s=>super.read(r,s),i)}write(r,i){var o,a;if(i!=null&&i.origin){const l=`${i.origin}/${i.layerContainerType||"operational-layers"}`,c=tGe[l];let h=c&&c[this.operationalLayerType];if(this.operationalLayerType==="ArcGISTiledElevationServiceLayer"&&l==="web-scene/operational-layers"&&(h=!1),this.operationalLayerType==="ArcGISDimensionLayer"&&l==="web-map/operational-layers"&&(h=!1),!h)return(o=i.messages)==null||o.push(new q("layer:unsupported",`Layers (${this.title}, ${this.id}) of type '${this.declaredClass}' are not supported in the context of '${l}'`,{layer:this})),null}const s=super.write(r,{...i,layer:this}),n=!!i&&!!i.messages&&!!i.messages.filter(l=>l instanceof q&&l.name==="web-document-write:property-required").length;return xS(s==null?void 0:s.url)?((a=i==null?void 0:i.messages)==null||a.push(new q("layer:invalid-url",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' using a Blob URL cannot be written to web scenes and web maps`,{layer:this})),null):!this.url&&n?null:s}beforeSave(){}};return u([d({type:String,json:{write:{ignoreOrigin:!0},origins:{"web-scene":{write:{isRequired:!0,ignoreOrigin:!0}},"portal-item":{write:!1}}}})],e.prototype,"id",void 0),u([d(b0e)],e.prototype,"listMode",void 0),u([He("listMode")],e.prototype,"writeListMode",null),u([d({type:String,readOnly:!0,json:{read:!1,write:{target:"layerType",ignoreOrigin:!0},origins:{"portal-item":{write:!1}}}})],e.prototype,"operationalLayerType",void 0),u([He("operationalLayerType")],e.prototype,"writeOperationalLayerType",null),u([d(N7)],e.prototype,"opacity",void 0),u([d({type:String,json:{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0},origins:{"web-scene":{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}},"portal-item":{write:!1}}},value:"Layer"})],e.prototype,"title",void 0),u([He("title"),He(["web-scene"],"title")],e.prototype,"writeTitle",null),u([d({type:Boolean,json:{name:"visibility"}})],e.prototype,"visible",void 0),e=u([I("esri.layers.mixins.OperationalLayer")],e),e};var Q7;const GU=new mr({asc:"ascending",desc:"descending"});let qT=Q7=class extends ve{constructor(t){super(t),this.field=null,this.valueExpression=null,this.order="ascending"}clone(){return new Q7({field:this.field,valueExpression:this.valueExpression,order:this.order})}};u([d({type:String,json:{write:!0}})],qT.prototype,"field",void 0),u([d({type:String,json:{write:!0}})],qT.prototype,"valueExpression",void 0),u([d({type:GU.apiValues,json:{read:GU.read,write:GU.write}})],qT.prototype,"order",void 0),qT=Q7=u([I("esri.layers.support.OrderByInfo")],qT);const P_e=qT;function iGe(t,e,r){if(!t)return null;const i=t.find(n=>!!n.field);if(!i)return null;const s=new P_e;return s.read(i,r),[s]}function sGe(t,e,r,i){const s=t.find(n=>!!n.field);s&&el(r,[s.toJSON()],e)}const nGe=t=>{let e=class extends t{constructor(){super(...arguments),this.orderBy=null}};return u([d({type:[P_e],json:{origins:{"web-scene":{write:!1,read:!1}},read:{source:"layerDefinition.orderBy",reader:iGe},write:{target:"layerDefinition.orderBy",writer:sGe}}})],e.prototype,"orderBy",void 0),e=u([I("esri.layers.mixins.OrderedLayer")],e),e};async function oGe(t){const e=t.spatialReference;if(e.isWGS84)return t.clone();if(e.isWebMercator)return _2(t);const r=et.WGS84;return await hDe(e,r),AE(t,r)}function MSt(t,e){if(!aGe(t,e)){const r=t.typeKeywords;r?r.push(e):t.typeKeywords=[e]}}function aGe(t,e){var r;return!!((r=t.typeKeywords)!=null&&r.includes(e))}function PSt(t,e){const r=t.typeKeywords;if(r){const i=r.indexOf(e);i>-1&&r.splice(i,1)}}async function ISt(t){const e=t.clone().normalize();let r;if(e.length>1)for(const i of e)r?i.width>r.width&&(r=i):r=i;else r=e[0];return oGe(r)}const $St={DEVELOPER_BASEMAP:"DeveloperBasemap",JSAPI:"ArcGIS API for JavaScript",METADATA:"Metadata",MULTI_LAYER:"Multilayer",SINGLE_LAYER:"Singlelayer",TABLE:"Table"};function Wte(t){var l;const{portal:e,isOrgItem:r,itemControl:i}=t,s=(l=e.user)==null?void 0:l.privileges;let n=!s||s.includes("features:user:edit"),o=!!r&&!!(s!=null&&s.includes("features:user:fullEdit"));const a=i==="update"||i==="admin";return a?o=n=!0:o&&(n=!0),{features:{edit:n,fullEdit:o},content:{updateItem:a}}}const lGe=t=>{let e=class extends t{constructor(){super(...arguments),this.resourceReferences={portalItem:null,paths:[]},this.userHasEditingPrivileges=!0,this.userHasFullEditingPrivileges=!1,this.userHasUpdateItemPrivileges=!1}destroy(){this.portalItem=ke(this.portalItem)}set portalItem(r){r!==this._get("portalItem")&&(this.removeOrigin("portal-item"),this._set("portalItem",r))}readPortalItem(r,i,s){if(i.itemId)return new V3({id:i.itemId,portal:s&&s.portal})}writePortalItem(r,i){r&&r.id&&(i.itemId=r.id)}async loadFromPortal(r,i){if(this.portalItem&&this.portalItem.id)try{const s=await te(()=>import("./layersLoader-c65033be.js"),["assets/layersLoader-c65033be.js","assets/fetchService-d31d8618.js","assets/jsonContext-999facfa.js"]);return fr(i),await s.load({instance:this,supportedTypes:r.supportedTypes,validateItem:r.validateItem,supportsData:r.supportsData,layerModuleTypeMap:r.layerModuleTypeMap},i)}catch(s){throw Qs(s)||se.getLogger(this.declaredClass).warn(`Failed to load layer (${this.title}, ${this.id}) portal item (${this.portalItem.id})
  ${s}`),s}}async finishLoadEditablePortalLayer(r){this._set("userHasEditingPrivileges",await this._fetchUserHasEditingPrivileges(r).catch(i=>(xc(i),!0)))}async _setUserPrivileges(r,i){if(!Yr.userPrivilegesApplied)return this.finishLoadEditablePortalLayer(i);if(this.url)try{const{features:{edit:s,fullEdit:n},content:{updateItem:o}}=await this._fetchUserPrivileges(r,i);this._set("userHasEditingPrivileges",s),this._set("userHasFullEditingPrivileges",n),this._set("userHasUpdateItemPrivileges",o)}catch(s){xc(s)}}async _fetchUserPrivileges(r,i){let s=this.portalItem;if(!r||!s||!s.loaded||s.sourceUrl)return this._fetchFallbackUserPrivileges(i);const n=r===s.id;if(n&&s.portal.user)return Wte(s);let o,a;if(n)o=s.portal.url;else try{o=await Bhe(this.url,i)}catch(p){xc(p)}if(!o||!FRe(o,s.portal.url))return this._fetchFallbackUserPrivileges(i);try{const p=v(i)?i.signal:null;a=await(wi==null?void 0:wi.getCredential(`${o}/sharing`,{prompt:!1,signal:p}))}catch(p){xc(p)}const l=!0,c=!1,h=!1;if(!a)return{features:{edit:l,fullEdit:c},content:{updateItem:h}};try{if(n?await s.reload():(s=new V3({id:r,portal:{url:o}}),await s.load(i)),s.portal.user)return Wte(s)}catch(p){xc(p)}return{features:{edit:l,fullEdit:c},content:{updateItem:h}}}async _fetchFallbackUserPrivileges(r){let i=!0;try{i=await this._fetchUserHasEditingPrivileges(r)}catch(s){xc(s)}return{features:{edit:i,fullEdit:!1},content:{updateItem:!1}}}async _fetchUserHasEditingPrivileges(r){const i=this.url?wi==null?void 0:wi.findCredential(this.url):null;if(!i)return!0;const s=VP.credential===i?VP.user:await this._fetchEditingUser(r);return VP.credential=i,VP.user=s,C(s)||s.privileges==null||s.privileges.includes("features:user:edit")}async _fetchEditingUser(r){var h,p;const i=(p=(h=this.portalItem)==null?void 0:h.portal)==null?void 0:p.user;if(i)return i;const s=wi.findServerInfo(this.url??"");if(!(s!=null&&s.owningSystemUrl))return null;const n=`${s.owningSystemUrl}/sharing/rest`,o=tl.getDefault();if(o&&o.loaded&&ip(o.restUrl)===ip(n))return o.user;const a=`${n}/community/self`,l=v(r)?r.signal:null,c=await hp(Ni(a,{authMode:"no-prompt",query:{f:"json"},signal:l}));return c.ok?Eq.fromJSON(c.value.data):null}read(r,i){i&&(i.layer=this),super.read(r,i)}write(r,i){const s=i&&i.portal,n=this.portalItem&&this.portalItem.id&&(this.portalItem.portal||tl.getDefault());return s&&n&&!the(n.restUrl,s.restUrl)?(i.messages&&i.messages.push(new q("layer:cross-portal",`The layer '${this.title} (${this.id})' cannot be persisted because it refers to an item on a different portal than the one being saved to. To save, set layer.portalItem to null or save to the same portal as the item associated with the layer`,{layer:this})),null):super.write(r,{...i,layer:this})}};return u([d({type:V3})],e.prototype,"portalItem",null),u([Fe("web-document","portalItem",["itemId"])],e.prototype,"readPortalItem",null),u([He("web-document","portalItem",{itemId:{type:String}})],e.prototype,"writePortalItem",null),u([d({clonable:!1})],e.prototype,"resourceReferences",void 0),u([d({type:Boolean,readOnly:!0})],e.prototype,"userHasEditingPrivileges",void 0),u([d({type:Boolean,readOnly:!0})],e.prototype,"userHasFullEditingPrivileges",void 0),u([d({type:Boolean,readOnly:!0})],e.prototype,"userHasUpdateItemPrivileges",void 0),e=u([I("esri.layers.mixins.PortalLayer")],e),e},VP={credential:null,user:null};let JA=class extends Te{constructor(){super(...arguments),this.updating=!1,this.status="unknown"}};u([d()],JA.prototype,"updating",void 0),u([d()],JA.prototype,"status",void 0),JA=u([I("esri.layers.support.PublishingInfo")],JA);const cGe=JA,I_e="esri.layers.mixins.PublishableLayer",uGe=Symbol(I_e),hGe=t=>{var e;let r=class extends t{constructor(){super(...arguments),this[e]=!0}get publishingInfo(){if(this.destroyed)return null;const i=this._get("publishingInfo");if(i)return i;const s=new cGe;return this._checkPublishingStatus(s),s}_checkPublishingStatus(i){let o=0;const a=async c=>{let h;i.updating=!0;try{h=await this.fetchPublishingStatus()}catch{h="unavailable"}h!=="published"&&h!=="unavailable"||(i.status==="publishing"&&this.refresh(),l.remove()),i.status=h,i.updating=!1,l.removed||(o=setTimeout(a,c,c+125))},l={removed:!1,remove(){this.removed=!0,clearTimeout(o)}};this.when().catch(()=>l.remove()),a(250),this.own(l)}};return e=uGe,u([d({readOnly:!0,clonable:!1})],r.prototype,"publishingInfo",null),r=u([I(I_e)],r),r},nO=new Pt,nR=new WeakMap;function dGe(t){$_e(t)&&nO.push(t)}function pGe(t){$_e(t)&&nO.includes(t)&&nO.remove(t)}function $_e(t){return t!=null&&typeof t=="object"&&"refreshInterval"in t&&"refresh"in t}function L_e(t,e){return Number.isFinite(t)&&Number.isFinite(e)?e<=0?t:L_e(e,t%e):0}let jU=0,BP=0;function fGe(){const t=Date.now();for(const e of nO)e.refreshInterval&&t-(nR.get(e)??0)+5>=6e4*e.refreshInterval&&(nR.set(e,t),e.refresh(t))}vue(()=>{const t=Date.now();let e=0;for(const r of nO)e=L_e(Math.round(6e4*r.refreshInterval),e),r.refreshInterval?nR.get(r)||nR.set(r,t):nR.delete(r);if(e!==BP){if(BP=e,clearInterval(jU),BP===0)return void(jU=0);jU=setInterval(fGe,BP)}});function mGe(t){return t!=null&&typeof t=="object"&&"refreshTimestamp"in t&&"refresh"in t}const gGe=t=>{let e=class extends t{constructor(...r){super(...r),this.refreshInterval=0,this.refreshTimestamp=0,this._debounceHasDataChanged=due(()=>this.hasDataChanged()),this.when().then(()=>{dGe(this)},()=>{})}destroy(){pGe(this)}get refreshParameters(){return{_ts:this.refreshTimestamp||null}}refresh(r=Date.now()){k2(this._debounceHasDataChanged()).then(i=>{i&&this._set("refreshTimestamp",r),this.emit("refresh",{dataChanged:i})},i=>{se.getLogger(this.declaredClass).error(i),this.emit("refresh",{dataChanged:!1,error:i})})}async hasDataChanged(){return!0}};return u([d({type:Number,cast:r=>r>=.1?r:r<=0?0:.1,json:{write:!0}})],e.prototype,"refreshInterval",void 0),u([d({readOnly:!0})],e.prototype,"refreshTimestamp",void 0),u([d()],e.prototype,"refreshParameters",null),e=u([I("esri.layers.mixins.RefreshableLayer")],e),e},yGe=t=>{let e=class extends t{constructor(){super(...arguments),this.minScale=0,this.maxScale=0}get effectiveScaleRange(){const r={minScale:this.minScale,maxScale:this.maxScale},i=this.parent;i&&"effectiveScaleRange"in i&&_Ge(r,i.effectiveScaleRange);const s=this._get("effectiveScaleRange");return s&&s.minScale===r.minScale&&s.maxScale===r.maxScale?s:r}};return u([d({type:Number,nonNullable:!0,json:{write:!0}})],e.prototype,"minScale",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0}})],e.prototype,"maxScale",void 0),u([d({readOnly:!0})],e.prototype,"effectiveScaleRange",null),e=u([I("esri.layers.mixins.ScaleRangeLayer")],e),e};function _Ge(t,e){return t.minScale=t.minScale>0?e.minScale>0?Math.min(t.minScale,e.minScale):t.minScale:e.minScale,t.maxScale=t.maxScale>0?e.maxScale>0?Math.max(t.maxScale,e.maxScale):t.maxScale:e.maxScale,t}const D_e=Ta()({esriTimeUnitsMilliseconds:"milliseconds",esriTimeUnitsSeconds:"seconds",esriTimeUnitsMinutes:"minutes",esriTimeUnitsHours:"hours",esriTimeUnitsDays:"days",esriTimeUnitsWeeks:"weeks",esriTimeUnitsMonths:"months",esriTimeUnitsYears:"years",esriTimeUnitsDecades:"decades",esriTimeUnitsCenturies:"centuries",esriTimeUnitsUnknown:void 0});let KA=class extends bs(ve){constructor(e){super(e),this.unit="milliseconds",this.value=0}toMilliseconds(){return U8e(this.value,this.unit,"milliseconds")}};u([gt(D_e,{nonNullable:!0})],KA.prototype,"unit",void 0),u([d({type:Number,json:{write:!0},nonNullable:!0})],KA.prototype,"value",void 0),KA=u([I("esri.TimeInterval")],KA);const HN=KA;function Xte(t,e){return HN.fromJSON({value:t,unit:e})}let Ua=class extends bs(ve){constructor(e){super(e),this.cumulative=!1,this.endField=null,this.fullTimeExtent=null,this.hasLiveData=!1,this.interval=null,this.startField=null,this.timeReference=null,this.trackIdField=null,this.useTime=!0}readFullTimeExtent(e,r){if(!r.timeExtent||!Array.isArray(r.timeExtent)||r.timeExtent.length!==2)return null;const i=new Date(r.timeExtent[0]),s=new Date(r.timeExtent[1]);return new _m({start:i,end:s})}writeFullTimeExtent(e,r){e&&v(e.start)&&v(e.end)?r.timeExtent=[e.start.getTime(),e.end.getTime()]:r.timeExtent=null}readInterval(e,r){return r.timeInterval&&r.timeIntervalUnits?Xte(r.timeInterval,r.timeIntervalUnits):r.defaultTimeInterval&&r.defaultTimeIntervalUnits?Xte(r.defaultTimeInterval,r.defaultTimeIntervalUnits):null}writeInterval(e,r){r.timeInterval=(e==null?void 0:e.toJSON().value)??null,r.timeIntervalUnits=(e==null?void 0:e.toJSON().unit)??null}};u([d({type:Boolean,json:{name:"exportOptions.timeDataCumulative",write:!0}})],Ua.prototype,"cumulative",void 0),u([d({type:String,json:{name:"endTimeField",write:{enabled:!0,allowNull:!0}}})],Ua.prototype,"endField",void 0),u([d({type:_m,json:{write:{enabled:!0,allowNull:!0}}})],Ua.prototype,"fullTimeExtent",void 0),u([Fe("fullTimeExtent",["timeExtent"])],Ua.prototype,"readFullTimeExtent",null),u([He("fullTimeExtent")],Ua.prototype,"writeFullTimeExtent",null),u([d({type:Boolean,json:{write:!0}})],Ua.prototype,"hasLiveData",void 0),u([d({type:HN,json:{write:{enabled:!0,allowNull:!0}}})],Ua.prototype,"interval",void 0),u([Fe("interval",["timeInterval","timeIntervalUnits","defaultTimeInterval","defaultTimeIntervalUnits"])],Ua.prototype,"readInterval",null),u([He("interval")],Ua.prototype,"writeInterval",null),u([d({type:String,json:{name:"startTimeField",write:{enabled:!0,allowNull:!0}}})],Ua.prototype,"startField",void 0),u([d({type:WS,json:{write:{enabled:!0,allowNull:!0}}})],Ua.prototype,"timeReference",void 0),u([d({type:String,json:{write:{enabled:!0,allowNull:!0}}})],Ua.prototype,"trackIdField",void 0),u([d({type:Boolean,json:{name:"exportOptions.useTime",write:!0}})],Ua.prototype,"useTime",void 0),Ua=u([I("esri.layers.support.TimeInfo")],Ua);const N_e=Ua,vGe=t=>{let e=class extends t{constructor(){super(...arguments),this.timeExtent=null,this.timeOffset=null,this.useViewTime=!0}readOffset(r,i){const s=i.timeInfo.exportOptions;if(!s)return null;const n=s.timeOffset,o=D_e.fromJSON(s.timeOffsetUnits);return n&&o?new HN({value:n,unit:o}):null}set timeInfo(r){Ide(r,this.fieldsIndex),this._set("timeInfo",r)}};return u([d({type:_m,json:{write:!1}})],e.prototype,"timeExtent",void 0),u([d({type:HN})],e.prototype,"timeOffset",void 0),u([Fe("service","timeOffset",["timeInfo.exportOptions"])],e.prototype,"readOffset",null),u([d({value:null,type:N_e,json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],e.prototype,"timeInfo",null),u([d({type:Boolean,json:{read:{source:"timeAnimation"},write:{target:"timeAnimation"},origins:{"web-scene":{read:!1,write:!1}}}})],e.prototype,"useViewTime",void 0),e=u([I("esri.layers.mixins.TemporalLayer")],e),e},Yte=new mr({esriFeatureEditToolAutoCompletePolygon:"auto-complete-polygon",esriFeatureEditToolCircle:"circle",esriFeatureEditToolEllipse:"ellipse",esriFeatureEditToolFreehand:"freehand",esriFeatureEditToolLine:"line",esriFeatureEditToolNone:"none",esriFeatureEditToolPoint:"point",esriFeatureEditToolPolygon:"polygon",esriFeatureEditToolRectangle:"rectangle",esriFeatureEditToolArrow:"arrow",esriFeatureEditToolTriangle:"triangle",esriFeatureEditToolLeftArrow:"left-arrow",esriFeatureEditToolRightArrow:"right-arrow",esriFeatureEditToolUpArrow:"up-arrow",esriFeatureEditToolDownArrow:"down-arrow"});let D0=class extends bs(ve){constructor(e){super(e),this.name=null,this.description=null,this.drawingTool=null,this.prototype=null,this.thumbnail=null}};u([d({json:{write:!0}})],D0.prototype,"name",void 0),u([d({json:{write:!0}})],D0.prototype,"description",void 0),u([d({json:{read:Yte.read,write:Yte.write}})],D0.prototype,"drawingTool",void 0),u([d({json:{write:!0}})],D0.prototype,"prototype",void 0),u([d({json:{write:!0}})],D0.prototype,"thumbnail",void 0),D0=u([I("esri.layers.support.FeatureTemplate")],D0);const kX=D0;let ug=class extends bs(ve){constructor(e){super(e),this.id=null,this.name=null,this.domains=null,this.templates=null}readDomains(e){const r={};for(const i of Object.keys(e))r[i]=oX(e[i]);return r}writeDomains(e,r){var s;const i={};for(const n of Object.keys(e))e[n]&&(i[n]=(s=e[n])==null?void 0:s.toJSON());r.domains=i}};u([d({json:{write:!0}})],ug.prototype,"id",void 0),u([d({json:{write:!0}})],ug.prototype,"name",void 0),u([d({json:{write:!0}})],ug.prototype,"domains",void 0),u([Fe("domains")],ug.prototype,"readDomains",null),u([He("domains")],ug.prototype,"writeDomains",null),u([d({type:[kX],json:{write:!0}})],ug.prototype,"templates",void 0),ug=u([I("esri.layers.support.FeatureType")],ug);const F_e=ug;function bGe(t){return t.type==="date"||t.type==="esriFieldTypeDate"}function Zte(t){return t.type==="oid"||t.type==="esriFieldTypeOID"}function Jte(t){return t.type==="global-id"||t.type==="esriFieldTypeGlobalID"}let wGe=class{constructor(e=[]){if(this.fields=[],this._fieldsMap=new Map,this._normalizedFieldsMap=new Map,this._dateFieldsSet=new Set,this._numericFieldsSet=new Set,this.dateFields=[],this.numericFields=[],this._requiredFields=null,!e)return;this.fields=e;const r=[];for(const i of e){const s=i==null?void 0:i.name,n=Qte(i==null?void 0:i.name);if(s&&n){const o=Kte(s);this._fieldsMap.set(s,i),this._fieldsMap.set(o,i),this._normalizedFieldsMap.set(n,i),r.push(o),bGe(i)?(this.dateFields.push(i),this._dateFieldsSet.add(i)):m4(i)&&(this._numericFieldsSet.add(i),this.numericFields.push(i)),Zte(i)||Jte(i)||(i.editable=i.editable==null||!!i.editable,i.nullable=i.nullable==null||!!i.nullable)}}r.sort(),this.uid=r.join(",")}destroy(){this._fieldsMap.clear()}get requiredFields(){if(!this._requiredFields){this._requiredFields=[];for(const e of this.fields)Zte(e)||Jte(e)||e.nullable||CIe(e)!==void 0||this._requiredFields.push(e)}return this._requiredFields}has(e){return this.get(e)!=null}get(e){if(!e)return;let r=this._fieldsMap.get(e);return r||(r=this._fieldsMap.get(Kte(e))??this._normalizedFieldsMap.get(Qte(e)),r&&this._fieldsMap.set(e,r),r)}isDateField(e){return this._dateFieldsSet.has(this.get(e))}isNumericField(e){return this._numericFieldsSet.has(this.get(e))}normalizeFieldName(e){const r=this.get(e);if(r)return r.name??void 0}};function Kte(t){return t.trim().toLowerCase()}function Qte(t){var e;return((e=yIe(t))==null?void 0:e.toLowerCase())??""}function xGe(){return{fields:{type:[e5],value:null},fieldsIndex:{readOnly:!0,get(){return new wGe(this.fields||[])}},outFields:{type:[String],json:{read:!1},set:function(t){this._userOutFields=t,this.notifyChange("outFields")},get:function(){var e;const t=this._userOutFields;if(!t||!t.length)return null;if(t.includes("*"))return["*"];if(!this.fields)return t;for(const r of t)((e=this.fieldsIndex)==null?void 0:e.has(r))||se.getLogger("esri.layers.support.fieldProperties").error("field-attributes-layer:invalid-field",`Invalid field ${r} found in outFields`,{layer:this,outFields:t});return $de(this.fieldsIndex,t)}}}}const HU=se.getLogger("esri.layers.support.labelingInfo"),TGe=/\[([^\[\]]+)\]/gi;function ere(t,e,r){return t?t.map(i=>{const s=new u5;if(s.read(i,r),s.labelExpression){const n=e.fields||e.layerDefinition&&e.layerDefinition.fields||this.fields;s.labelExpression=s.labelExpression.replace(TGe,(o,a)=>`[${SGe(a,n)}]`)}return s}):null}function SGe(t,e){if(!e)return t;const r=t.toLowerCase();for(let i=0;i<e.length;i++){const s=e[i].name;if(s.toLowerCase()===r)return s}return t}const EGe={esriGeometryPoint:["above-right","above-center","above-left","center-center","center-left","center-right","below-center","below-left","below-right"],esriGeometryPolygon:["always-horizontal"],esriGeometryPolyline:["center-along"],esriGeometryMultipoint:null};function VSt(t,e){const r=ne(t);return r.some(i=>CGe(i,e))?[]:r}function CGe(t,e){const r=t.labelPlacement,i=EGe[e];if(!t.symbol)return HU.warn("No ILabelClass symbol specified."),!0;if(!i)return HU.error(new q("labeling:unsupported-geometry-type",`Unable to create labels for layer, geometry type '${e}' is not supported`)),!0;if(!i.includes(r)){const s=i[0];r&&HU.warn(`Found invalid label placement type ${r} for ${e}. Defaulting to ${s}`),t.labelPlacement=s}return!1}const Cd=[];function AGe(t,e){if(g0e(t.url??""))return!0;const{wkid:r}=e;for(const i of Cd){if((t.version??0)>=i[0])return!0;if(typeof i[1]=="function"&&(i[1]=i[1]()),i[1].has(r))return!1}return!0}Cd.push([10.91,()=>{const t=new Set([9709,9716,9741,9761,9766]);for(let e=9712;e<=9713;e++)t.add(e);for(let e=9748;e<=9749;e++)t.add(e);for(let e=20904;e<=20932;e++)t.add(e);for(let e=21004;e<=21032;e++)t.add(e);for(let e=21207;e<=21264;e++)t.add(e);for(let e=21307;e<=21364;e++)t.add(e);for(let e=102759;e<=102760;e++)t.add(e);for(let e=102901;e<=102955;e++)t.add(e);return t}]),Cd.push([10.9,()=>{const t=new Set([9300,9354,9364,9367,9373,9377,9387,9456,9473,9498,9678,9680,29874,103599,103872,104028]);for(let e=9356;e<=9360;e++)t.add(e);for(let e=9404;e<=9407;e++)t.add(e);for(let e=9476;e<=9482;e++)t.add(e);for(let e=9487;e<=9494;e++)t.add(e);for(let e=9697;e<=9699;e++)t.add(e);return t}]),Cd.push([10.81,()=>{const t=new Set([9265,9333,103598,103699]);for(let e=9248;e<=9254;e++)t.add(e);for(let e=9271;e<=9273;e++)t.add(e);for(let e=9284;e<=9285;e++)t.add(e);for(let e=21453;e<=21463;e++)t.add(e);return t}]),Cd.push([10.8,()=>{const t=new Set([8088,8395,8428,8433,8531,8687,8692,8694,8699,8900,9003,9006,9009,9012,9017,9191]);for(let e=8035;e<=8036;e++)t.add(e);for(let e=8455;e<=8456;e++)t.add(e);for(let e=8518;e<=8529;e++)t.add(e);for(let e=8533;e<=8536;e++)t.add(e);for(let e=8538;e<=8540;e++)t.add(e);for(let e=8677;e<=8679;e++)t.add(e);for(let e=8902;e<=8903;e++)t.add(e);for(let e=8907;e<=8910;e++)t.add(e);for(let e=8949;e<=8951;e++)t.add(e);for(let e=8972;e<=8987;e++)t.add(e);for(let e=9039;e<=9040;e++)t.add(e);for(let e=9068;e<=9069;e++)t.add(e);for(let e=9140;e<=9141;e++)t.add(e);for(let e=9148;e<=9150;e++)t.add(e);for(let e=9153;e<=9159;e++)t.add(e);for(let e=9205;e<=9218;e++)t.add(e);for(let e=9221;e<=9222;e++)t.add(e);for(let e=54098;e<=54101;e++)t.add(e);return t}]),Cd.push([10.71,()=>{const t=new Set([6316]);for(let e=8351;e<=8353;e++)t.add(e);for(let e=9294;e<=9297;e++)t.add(e);for(let e=22619;e<=22621;e++)t.add(e);for(let e=103586;e<=103594;e++)t.add(e);return t}]),Cd.push([10.7,()=>{const t=new Set([8387,8391,8427,8545,8682,8685,8818,31370,104022,104024,104975]);for(let e=8065;e<=8068;e++)t.add(e);for(let e=8082;e<=8083;e++)t.add(e);for(let e=8379;e<=8385;e++)t.add(e);for(let e=8836;e<=8840;e++)t.add(e);for(let e=8857;e<=8860;e++)t.add(e);for(let e=53035;e<=53037;e++)t.add(e);for(let e=54090;e<=54091;e++)t.add(e);for(let e=102498;e<=102499;e++)t.add(e);return t}]),Cd.push([10.61,()=>new Set([102497])]),Cd.push([10.6,()=>{const t=new Set([7803,7805,7887,8086,8232,8237,8240,8246,8249,8252,8255,9019,9391]);for(let e=7755;e<=7787;e++)t.add(e);for(let e=7791;e<=7795;e++)t.add(e);for(let e=7799;e<=7801;e++)t.add(e);for(let e=7825;e<=7831;e++)t.add(e);for(let e=7877;e<=7878;e++)t.add(e);for(let e=7882;e<=7883;e++)t.add(e);for(let e=7991;e<=7992;e++)t.add(e);for(let e=8042;e<=8043;e++)t.add(e);for(let e=8058;e<=8059;e++)t.add(e);for(let e=8311;e<=8348;e++)t.add(e);for(let e=9060;e<=9067;e++)t.add(e);for(let e=102562;e<=102568;e++)t.add(e);for(let e=102799;e<=102900;e++)t.add(e);return t}]),Cd.push([10.51,()=>{const t=new Set([7683,7881,7886,7899,8888,9e3]);for(let e=8013;e<=8032;e++)t.add(e);for(let e=9053;e<=9057;e++)t.add(e);for(let e=104017;e<=104018;e++)t.add(e);for(let e=104971;e<=104974;e++)t.add(e);return t}]),Cd.push([10.5,()=>{const t=new Set([6962,7035,7037,7039,7041,7084,7086,7133,7798,102399]);for(let e=4087;e<=4088;e++)t.add(e);for(let e=5896;e<=5899;e++)t.add(e);for(let e=7005;e<=7007;e++)t.add(e);for(let e=7057;e<=7070;e++)t.add(e);for(let e=7073;e<=7082;e++)t.add(e);for(let e=7109;e<=7128;e++)t.add(e);for(let e=7844;e<=7859;e++)t.add(e);return t}]);async function RGe(t,e,r){const i=t&&t.getAtOrigin&&t.getAtOrigin("renderer",e.origin);if(i&&i.type==="unique-value"&&i.styleOrigin){const s=await hp(i.populateFromStyle());if(fr(r),s.ok===!1){const n=s.error;e&&e.messages&&e.messages.push(new rm("renderer:style-reference",`Failed to create unique value renderer from style reference: ${n.message}`,{error:n,context:e})),t.clear("renderer",e==null?void 0:e.origin)}}}const OGe=["oid","global-id"],MGe=["oid","global-id","guid"];function PGe({displayField:t,editFieldsInfo:e,fields:r,objectIdField:i,title:s},n){if(!r)return null;const o=FGe({editFieldsInfo:e,fields:r,objectIdField:i},n);if(!o.length)return null;const a=VGe({titleBase:s,fields:r,displayField:t}),l=kGe();return new rM({title:a,content:l,fieldInfos:o})}const IGe=[/^fnode_$/i,/^tnode_$/i,/^lpoly_$/i,/^rpoly_$/i,/^poly_$/i,/^subclass$/i,/^subclass_$/i,/^rings_ok$/i,/^rings_nok$/i,/shape/i,/perimeter/i,/objectid/i,/_i$/i],$Ge=(t,{editFieldsInfo:e,objectIdField:r,visibleFieldNames:i})=>i?i.has(t.name):!U_e(t.name,e)&&(!r||t.name!==r)&&!OGe.includes(t.type)&&!IGe.some(s=>s.test(t.name));function LGe(t,e){const r=t;return e&&(t=t.filter(i=>!e.includes(i.type))),t===r&&(t=t.slice()),t.sort(DGe),t}function DGe(t,e){return t.type==="oid"?-1:e.type==="oid"?1:tre(t)?-1:tre(e)?1:(t.alias||t.name).toLocaleLowerCase().localeCompare((e.alias||e.name).toLocaleLowerCase())}function U_e(t,e){if(!t||!e)return!1;const{creationDateField:r,creatorField:i,editDateField:s,editorField:n}=e;return[r&&r.toLowerCase(),i&&i.toLowerCase(),s&&s.toLowerCase(),n&&n.toLowerCase()].includes(t.toLowerCase())}function NGe(t,e){return t.editable&&!MGe.includes(t.type)&&!U_e(t.name,e)}function FGe({editFieldsInfo:t,fields:e,objectIdField:r},i){return LGe(e??[],(i==null?void 0:i.ignoreFieldTypes)||BGe).map(s=>new tM({fieldName:s.name,isEditable:NGe(s,t),label:s.alias,format:UGe(s),visible:$Ge(s,{editFieldsInfo:t,objectIdField:r,visibleFieldNames:i==null?void 0:i.visibleFieldNames})}))}function UGe(t){switch(t.type){case"small-integer":case"integer":case"single":return new v2({digitSeparator:!0,places:0});case"double":return new v2({digitSeparator:!0,places:2});case"date":return new v2({dateFormat:"long-month-day-year"});default:return t.type==="string"&&kde(t.name)?new v2({digitSeparator:!0,places:0}):null}}function kGe(){return[new MS,new zR]}function VGe(t){const e=bIe(t),{titleBase:r}=t;return e?`${r}: {${e.trim()}}`:r??""}function tre(t){return(t.name&&t.name.toLowerCase())==="name"?!0:(t.alias&&t.alias.toLowerCase())==="name"}const BGe=["geometry","blob","raster","guid","xml"],hl="FeatureLayer",k_e="esri.layers.FeatureLayer",zGe=se.getLogger(k_e);function zP(t,e){return new q("layer:unsupported",`Layer (${t.title}, ${t.id}) of type '${t.declaredClass}' ${e}`,{layer:t})}function rre(t){return t&&t instanceof Pt}const qU=xGe();function WU(t,e,r){const i=!!(r!=null&&r.writeLayerSchema);return{enabled:i,ignoreOrigin:i}}let yt=class extends p7e(eGe(yVe(hGe(fVe(hVe(nGe(vGe(yGe(gGe(uVe(rGe(lGe(o0e(dVe(rVe(bs(cN))))))))))))))))){constructor(...e){super(...e),this._handles=new ei,this.charts=null,this.copyright=null,this.displayField=null,this.dynamicDataSource=null,this.fields=null,this.fieldsIndex=null,this.formTemplate=null,this.fullExtent=null,this.geometryType=null,this.hasM=void 0,this.hasZ=void 0,this.infoFor3D=null,this.isTable=!1,this.labelsVisible=!0,this.labelingInfo=null,this.legendEnabled=!0,this.objectIdField=null,this.outFields=null,this.path=null,this.popupEnabled=!0,this.popupTemplate=null,this.screenSizePerspectiveEnabled=!0,this.spatialReference=et.WGS84,this.subtypeCode=null,this.templates=null,this.timeInfo=null,this.title=null,this.sublayerTitleMode="item-title",this.type="feature",this.typeIdField=null,this.types=null,this.visible=!0}destroy(){var e;(e=this.source)==null||e.destroy(),this._handles=ke(this._handles)}normalizeCtorArgs(e,r){return typeof e=="string"?{url:e,...r}:e}load(e){var s;const r=v(e)?e.signal:null;if((s=this.portalItem)!=null&&s.loaded&&this.source)return this.addResolvingPromise(this.createGraphicsSource(r).then(n=>this.initLayerProperties(n))),Promise.resolve(this);const i=this.loadFromPortal({supportedTypes:["Feature Service","Feature Collection"]},e).catch(xc).then(async()=>{if(this.url&&this.layerId==null&&/FeatureServer|MapServer\/*$/i.test(this.url)){const n=await this._fetchFirstLayerId(r);n!=null&&(this.layerId=n)}if(!this.url&&!this._hasMemorySource())throw new q("feature-layer:missing-url-or-source","Feature layer must be created with either a url or a source");return this.initLayerProperties(await this.createGraphicsSource(r))}).then(()=>this._setUserPrivileges(this.serviceItemId,e)).then(()=>Jze(this,e));return this.addResolvingPromise(i),Promise.resolve(this)}readCapabilities(e,r){return r=r.layerDefinition||r,x_e(r,this.url)}get createQueryVersion(){return this.commitProperty("definitionExpression"),this.commitProperty("dynamicDataSource"),this.commitProperty("timeExtent"),this.commitProperty("timeOffset"),this.commitProperty("geometryType"),this.commitProperty("gdbVersion"),this.commitProperty("historicMoment"),this.commitProperty("returnZ"),this.commitProperty("capabilities"),this.commitProperty("returnM"),(this._get("createQueryVersion")??0)+1}get editingEnabled(){var e;return!(this.loaded&&!((e=this.capabilities)!=null&&e.operations.supportsEditing))&&(this._isOverridden("editingEnabled")?this._get("editingEnabled"):this._hasMemorySource()||this.userHasEditingPrivileges)}set editingEnabled(e){this._overrideIfSome("editingEnabled",e)}readEditingEnabled(e,r){return this._readEditingEnabled(r,!1)}readEditingEnabledFromWebMap(e,r,i){return this._readEditingEnabled(r,!0,i)}writeEditingEnabled(e,r){this._writeEditingEnabled(e,r,!1)}writeEditingEnabledToWebMap(e,r,i,s){this._writeEditingEnabled(e,r,!0,s)}get effectiveEditingEnabled(){return Kze(this)}readIsTable(e,r){return(r=(r==null?void 0:r.layerDefinition)??r).type==="Table"||!r.geometryType}writeIsTable(e,r,i,s){s!=null&&s.writeLayerSchema&&el(i,e?"Table":"Feature Layer",r)}readGlobalIdField(e,r){return b_e(r.layerDefinition||r)}readObjectIdField(e,r){return w_e(r.layerDefinition||r)}get parsedUrl(){const e=sl(this.url);return e!=null&&(this.dynamicDataSource!=null?e.path=lw(e.path,"dynamicLayer"):this.layerId!=null&&(e.path=lw(e.path,this.layerId.toString()))),e}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){NK(e,this.fieldsIndex),this._set("renderer",e)}readRenderer(e,r,i){var n;const s=(n=(r=r.layerDefinition||r).drawingInfo)==null?void 0:n.renderer;if(s){const o=kN(s,r,i)??void 0;return o||zGe.error("Failed to create renderer",{rendererDefinition:r.drawingInfo.renderer,layer:this,context:i}),o}if(r.defaultSymbol)return r.types&&r.types.length?new _M({defaultSymbol:XU(r.defaultSymbol,r,i),field:r.typeIdField,uniqueValueInfos:r.types.map(o=>({id:o.id,symbol:XU(o.symbol,o,i)}))}):new jS({symbol:XU(r.defaultSymbol,r,i)})}set source(e){const r=this._get("source");r!==e&&(rre(r)&&this._resetMemorySource(r),rre(e)&&this._initMemorySource(e),this._set("source",e))}castSource(e){return e?Array.isArray(e)||e instanceof Pt?new bg({layer:this,items:e}):e:null}readSource(e,r){const i=lX.fromJSON(r.featureSet);return new bg({layer:this,items:(i==null?void 0:i.features)??[]})}readTemplates(e,r){const i=r.editFieldsInfo,s=i&&i.creatorField,n=i&&i.editorField;return e=e&&e.map(o=>kX.fromJSON(o)),this._fixTemplates(e,s),this._fixTemplates(e,n),e}readTitle(e,r){var n;const i=((n=r.layerDefinition)==null?void 0:n.name)??r.name,s=r.title||r.layerDefinition&&r.layerDefinition.title;if(i){const o=this.portalItem&&this.portalItem.title;if(this.sublayerTitleMode==="item-title")return this.url?oVe(this.url,i):i;let a=i;if(!a&&this.url){const l=LE(this.url);v(l)&&(a=l.title)}return a?(this.sublayerTitleMode==="item-title-and-service-name"&&o&&o!==a&&(a=o+" - "+a),SX(a)):void 0}if(this.sublayerTitleMode==="item-title"&&s)return s}readTitleFromWebMap(e,r){return r.title||r.layerDefinition&&r.layerDefinition.name}readTypeIdField(e,r){let i=(r=r.layerDefinition||r).typeIdField;if(i&&r.fields){i=i.toLowerCase();const s=r.fields.find(n=>n.name.toLowerCase()===i);s&&(i=s.name)}return i}readTypes(e,r){e=(r=r.layerDefinition||r).types;const i=r.editFieldsInfo,s=i&&i.creatorField,n=i&&i.editorField;return e&&e.map(o=>(o=F_e.fromJSON(o),this._fixTemplates(o.templates,s),this._fixTemplates(o.templates,n),o))}readVisible(e,r){return r.layerDefinition&&r.layerDefinition.defaultVisibility!=null?!!r.layerDefinition.defaultVisibility:r.visibility!=null?!!r.visibility:void 0}async addAttachment(e,r){return Nze(this,e,r,hl)}async updateAttachment(e,r,i){return Fze(this,e,r,i,hl)}async applyEdits(e,r){return Uze(this,e,r)}on(e,r){return super.on(e,r)}createPopupTemplate(e){return PGe(this,e)}async createGraphicsSource(e){if(this._hasMemorySource()&&this.source)return this.source.load({signal:e});const{default:r}=await YH(te(()=>import("./FeatureLayerSource-da38f0a0.js"),["assets/FeatureLayerSource-da38f0a0.js","assets/assetEditingSupport-2cebf928.js","assets/clientSideDefaults-5e9f56ed.js","assets/QueryEngineCapabilities-42e44ded.js","assets/QueryTask-bfee9c10.js","assets/executeForIds-257a163a.js"]),e);return new r({layer:this}).load({signal:e})}createQuery(){const e=Xze(this);e.dynamicDataSource=this.dynamicDataSource;const r=v(this.subtypeCode)?`${this.subtypeField} = ${this.subtypeCode}`:null,i=kke(this.definitionExpression,r);return e.where=i||"1=1",e}async deleteAttachments(e,r){return kze(this,e,r,hl)}async fetchRecomputedExtents(e){return Vze(this,e,hl)}getFeatureType(e){const{typeIdField:r,types:i}=this;if(!r||!e)return null;const s=e.attributes?e.attributes[r]:void 0;if(s==null)return null;let n=null;return i==null||i.some(o=>{const{id:a}=o;return a!=null&&(a.toString()===s.toString()&&(n=o),!!n)}),n}getFieldDomain(e,r){const i=r&&r.feature,s=this.getFeatureType(i);if(s){const n=s.domains&&s.domains[e];if(n&&n.type!=="inherited")return n}return this._getLayerDomain(e)}getField(e){return this.fieldsIndex.get(e)}async queryAttachments(e,r){return Bze(this,e,r,hl)}async queryFeatures(e,r){const i=await this.load(),s=await i.source.queryFeatures(Yf.from(e)??i.createQuery(),r);if(s!=null&&s.features)for(const n of s.features)n.layer=n.sourceLayer=i;return s}async queryObjectIds(e,r){return zze(this,e,r,hl)}async queryFeatureCount(e,r){return Gze(this,e,r,hl)}async queryExtent(e,r){return jze(this,e,r,hl)}async queryRelatedFeatures(e,r){return Hze(this,e,r,hl)}async queryRelatedFeaturesCount(e,r){return qze(this,e,r,hl)}async queryTopFeatures(e,r){var o;const{source:i,capabilities:s}=await this.load();if(!i.queryTopFeatures||!((o=s==null?void 0:s.query)!=null&&o.supportsTopFeaturesQuery))throw new q(hl,"Layer source does not support queryTopFeatures capability");const n=await i.queryTopFeatures(TP.from(e),r);if(n!=null&&n.features)for(const a of n.features)a.layer=a.sourceLayer=this;return n}async queryTopObjectIds(e,r){const{source:i,capabilities:s}=await this.load();if(!i.queryTopObjectIds||!(s!=null&&s.query.supportsTopFeaturesQuery))throw new q(hl,"Layer source does not support queryTopObjectIds capability");return i.queryTopObjectIds(TP.from(e),r)}async queryTopFeaturesExtent(e,r){var n;const{source:i,capabilities:s}=await this.load();if(!i.queryTopExtents||!((n=s==null?void 0:s.query)!=null&&n.supportsTopFeaturesQuery))throw new q(hl,"Layer source does not support queryTopExtents capability");return i.queryTopExtents(TP.from(e),r)}async queryTopFeatureCount(e,r){var n;const{source:i,capabilities:s}=await this.load();if(!i.queryTopCount||!((n=s==null?void 0:s.query)!=null&&n.supportsTopFeaturesQuery))throw new q(hl,"Layer source does not support queryFeatureCount capability");return i.queryTopCount(TP.from(e),r)}read(e,r){const i=e.featureCollection;if(i){const s=i.layers;s&&s.length===1&&(super.read(s[0],r),i.showLegend!=null&&super.read({showLegend:i.showLegend},r))}super.read(e,r),r&&r.origin==="service"&&(this.revert(["objectIdField","fields","timeInfo"],"service"),this.spatialReference||this.revert(["spatialReference"],"service"))}write(e,r){r={...r,origin:(r==null?void 0:r.origin)??void 0,writeLayerSchema:(r==null?void 0:r.writeLayerSchema)??this._hasMemorySource()};const{origin:i,layerContainerType:s,messages:n}=r;if(this.dynamicDataSource)return n==null||n.push(zP(this,"using a dynamic data source cannot be written to web scenes, web maps and feature service items")),null;if(this.isTable){if(i==="web-scene"||i==="web-map"&&s!=="tables")return n==null||n.push(zP(this,"using a table source cannot be written to web scenes and web maps")),null;if(this._hasMemorySource())return n==null||n.push(zP(this,"using an in-memory table source cannot be written to web scenes and web maps")),null}else if(this.loaded&&i==="web-map"&&s==="tables")return n==null||n.push(zP(this,"using a non-table source cannot be written to tables in web maps")),null;return super.write(e,r)}clone(){if(this._hasMemorySource())throw new q(hl,`FeatureLayer (title: ${this.title}, id: ${this.id}) created using in-memory source cannot be cloned`);return super.clone()}serviceSupportsSpatialReference(e){var r;return!!this.loaded&&(((r=this.source)==null?void 0:r.type)==="memory"||AGe(this,e))}async save(e){return(await te(()=>import("./featureLayerUtils-5c9c7cbe.js"),["assets/featureLayerUtils-5c9c7cbe.js","assets/originUtils-1469eeaf.js","assets/multiOriginJSONSupportUtils-c978f4c3.js","assets/fetchService-d31d8618.js","assets/jsonContext-999facfa.js"])).save(this,e)}async saveAs(e,r){return(await te(()=>import("./featureLayerUtils-5c9c7cbe.js"),["assets/featureLayerUtils-5c9c7cbe.js","assets/originUtils-1469eeaf.js","assets/multiOriginJSONSupportUtils-c978f4c3.js","assets/fetchService-d31d8618.js","assets/jsonContext-999facfa.js"])).saveAs(this,e,r)}_readEditingEnabled(e,r,i){var n;let s=(n=e.layerDefinition)==null?void 0:n.capabilities;return s?this._hasEditingCapability(s):(s=e.capabilities,r&&(i==null?void 0:i.origin)==="web-map"&&!this._hasMemorySource()&&s?this._hasEditingCapability(s):void 0)}_hasEditingCapability(e){return e.toLowerCase().split(",").map(r=>r.trim()).includes("editing")}_writeEditingEnabled(e,r,i,s){var n,o;if(!e){const a=(o=(n=this.capabilities)==null?void 0:n.operations)!=null&&o.supportsSync?"Query,Sync":"Query";el("layerDefinition.capabilities",a,r),i&&!(s!=null&&s.writeLayerSchema)&&(r.capabilities=a)}}_getLayerDomain(e){const r=this.fieldsIndex.get(e);return r?r.domain:null}_fetchFirstLayerId(e){return Ni(this.url,{query:{f:"json",...this.customParameters,token:this.apiKey},responseType:"json",signal:e}).then(r=>{const i=r.data;if(i)return Array.isArray(i.layers)&&i.layers.length>0?i.layers[0].id:Array.isArray(i.tables)&&i.tables.length>0?i.tables[0].id:void 0})}async initLayerProperties(e){var r;return this._set("source",e),e.sourceJSON&&(this.sourceJSON=e.sourceJSON,this.read(e.sourceJSON,{origin:"service",portalItem:this.portalItem,portal:(r=this.portalItem)==null?void 0:r.portal,url:this.parsedUrl})),this._verifySource(),this._verifyFields(),NK(this.renderer,this.fieldsIndex),Ide(this.timeInfo,this.fieldsIndex),RGe(this,{origin:"service"})}async hasDataChanged(){return Wze(this)}async fetchPublishingStatus(){const e=this.source;return e!=null&&e.fetchPublishingStatus?e.fetchPublishingStatus():"unavailable"}_verifyFields(){var r,i;const e=((r=this.parsedUrl)==null?void 0:r.path)??"undefined";this.objectIdField||console.log("FeatureLayer: 'objectIdField' property is not defined (url: "+e+")"),this.isTable||this._hasMemorySource()||e.search(/\/FeatureServer\//i)!==-1||(i=this.fields)!=null&&i.some(s=>s.type==="geometry")||console.log("FeatureLayer: unable to find field of type 'geometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+e+")")}_fixTemplates(e,r){e&&e.forEach(i=>{const s=i.prototype&&i.prototype.attributes;s&&r&&delete s[r]})}_verifySource(){if(this._hasMemorySource()){if(this.url)throw new q("feature-layer:mixed-source-and-url","FeatureLayer cannot be created with both an in-memory source and a url")}else if(!this.url)throw new q("feature-layer:source-or-url-required","FeatureLayer requires either a url, a valid portal item or a source")}_initMemorySource(e){e.forEach(r=>{r.layer=this,r.sourceLayer=this}),this._handles.add([e.on("after-add",r=>{r.item.layer=this,r.item.sourceLayer=this}),e.on("after-remove",r=>{r.item.layer=null,r.item.sourceLayer=null})],"fl-source")}_resetMemorySource(e){e.forEach(r=>{r.layer=null,r.sourceLayer=null}),this._handles.remove("fl-source")}_hasMemorySource(){return!(this.url||!this.source)}};u([Fe("service","capabilities")],yt.prototype,"readCapabilities",null),u([d({json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],yt.prototype,"charts",void 0),u([d({readOnly:!0})],yt.prototype,"createQueryVersion",null),u([d({json:{read:{source:"layerDefinition.copyrightText"}}})],yt.prototype,"copyright",void 0),u([d({json:{read:{source:"layerDefinition.displayField"}}})],yt.prototype,"displayField",void 0),u([d({types:Wb,readOnly:!0})],yt.prototype,"defaultSymbol",void 0),u([d({type:kd})],yt.prototype,"dynamicDataSource",void 0),u([d({type:Boolean})],yt.prototype,"editingEnabled",null),u([Fe(["portal-item","web-scene"],"editingEnabled",["layerDefinition.capabilities"])],yt.prototype,"readEditingEnabled",null),u([Fe("web-map","editingEnabled",["capabilities","layerDefinition.capabilities"])],yt.prototype,"readEditingEnabledFromWebMap",null),u([He(["portal-item","web-scene"],"editingEnabled",{"layerDefinition.capabilities":{type:String}})],yt.prototype,"writeEditingEnabled",null),u([He("web-map","editingEnabled",{capabilities:{type:String},"layerDefinition.capabilities":{type:String}})],yt.prototype,"writeEditingEnabledToWebMap",null),u([d({readOnly:!0})],yt.prototype,"effectiveEditingEnabled",null),u([d({...qU.fields,json:{read:{source:"layerDefinition.fields"},origins:{service:{name:"fields"},"web-map":{write:{target:"layerDefinition.fields",overridePolicy:WU}}}}})],yt.prototype,"fields",void 0),u([d(qU.fieldsIndex)],yt.prototype,"fieldsIndex",void 0),u([d({type:Jke,json:{name:"formInfo",write:!0,origins:{"web-scene":{read:!1,write:!1}}}})],yt.prototype,"formTemplate",void 0),u([d({json:{read:{source:"layerDefinition.extent"}}})],yt.prototype,"fullExtent",void 0),u([d({json:{origins:{"web-map":{write:{target:"layerDefinition.geometryType",overridePolicy:WU,writer(t,e,r){const i=t?G7.toJSON(t):null;i&&el(r,i,e)}}}},read:{source:"layerDefinition.geometryType",reader:G7.read}}})],yt.prototype,"geometryType",void 0),u([d({json:{read:{source:"layerDefinition.hasM"}}})],yt.prototype,"hasM",void 0),u([d({json:{read:{source:"layerDefinition.hasZ"}}})],yt.prototype,"hasZ",void 0),u([d(MVe)],yt.prototype,"id",void 0),u([d({readOnly:!0,json:{origins:{service:{read:!0}},read:!1}})],yt.prototype,"infoFor3D",void 0),u([d({json:{origins:{"web-map":{write:{target:"layerDefinition.type"}}}}})],yt.prototype,"isTable",void 0),u([Fe("service","isTable",["type","geometryType"]),Fe("isTable",["layerDefinition.type","layerDefinition.geometryType"])],yt.prototype,"readIsTable",null),u([He("web-map","isTable")],yt.prototype,"writeIsTable",null),u([d(CX)],yt.prototype,"labelsVisible",void 0),u([d({type:[u5],json:{origins:{service:{read:{source:"drawingInfo.labelingInfo",reader:ere},write:{target:"drawingInfo.labelingInfo",enabled:!1}}},read:{source:"layerDefinition.drawingInfo.labelingInfo",reader:ere},write:{target:"layerDefinition.drawingInfo.labelingInfo"}}})],yt.prototype,"labelingInfo",void 0),u([d((()=>{const t=ne(OVe);return t.json.origins["portal-item"]={write:{target:"layerDefinition.drawingInfo.transparency",writer(e,r,i){el(i,f4(e),r)}}},t})())],yt.prototype,"opacity",void 0),u([d(AVe)],yt.prototype,"legendEnabled",void 0),u([d({type:["show","hide"],json:(()=>{const t=ne(b0e.json);return t.origins["portal-item"]={read:!1,write:!1},t})()})],yt.prototype,"listMode",void 0),u([Fe("globalIdField",["layerDefinition.globalIdField","layerDefinition.fields"])],yt.prototype,"readGlobalIdField",null),u([d({json:{origins:{"web-map":{write:{target:"layerDefinition.objectIdField",overridePolicy:WU}}}}})],yt.prototype,"objectIdField",void 0),u([Fe("objectIdField",["layerDefinition.objectIdField","layerDefinition.fields"])],yt.prototype,"readObjectIdField",null),u([d({value:"ArcGISFeatureLayer",type:["ArcGISFeatureLayer"]})],yt.prototype,"operationalLayerType",void 0),u([d(qU.outFields)],yt.prototype,"outFields",void 0),u([d({readOnly:!0})],yt.prototype,"parsedUrl",null),u([d({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],yt.prototype,"path",void 0),u([d(EX)],yt.prototype,"popupEnabled",void 0),u([d({type:rM,json:{name:"popupInfo",write:!0}})],yt.prototype,"popupTemplate",void 0),u([d({readOnly:!0})],yt.prototype,"defaultPopupTemplate",null),u([d({types:s5,json:{origins:{service:{write:{target:"drawingInfo.renderer",enabled:!1}},"web-scene":{types:Lke,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:(t,e,r)=>({ignoreOrigin:r==null?void 0:r.writeLayerSchema})}}},write:{target:"layerDefinition.drawingInfo.renderer",overridePolicy:(t,e,r)=>({ignoreOrigin:r==null?void 0:r.writeLayerSchema})}}})],yt.prototype,"renderer",null),u([Fe("service","renderer",["drawingInfo.renderer","defaultSymbol"]),Fe("renderer",["layerDefinition.drawingInfo.renderer","layerDefinition.defaultSymbol"])],yt.prototype,"readRenderer",null),u([d((()=>{const t=ne(EVe);return t.json.origins["portal-item"]={read:!1,write:!1},t})())],yt.prototype,"screenSizePerspectiveEnabled",void 0),u([d({clonable:!1})],yt.prototype,"source",null),u([cr("source")],yt.prototype,"castSource",null),u([Fe("portal-item","source",["featureSet"]),Fe("web-map","source",["featureSet"])],yt.prototype,"readSource",null),u([d({json:{read:{source:"layerDefinition.extent.spatialReference"}}})],yt.prototype,"spatialReference",void 0),u([d({type:Number})],yt.prototype,"subtypeCode",void 0),u([d({type:[kX]})],yt.prototype,"templates",void 0),u([Fe("templates",["editFieldsInfo","creatorField","editorField","templates"])],yt.prototype,"readTemplates",null),u([d({type:N_e})],yt.prototype,"timeInfo",void 0),u([d()],yt.prototype,"title",void 0),u([Fe("service","title",["name"]),Fe("portal-item","title",["layerDefinition.title","layerDefinition.name","title"])],yt.prototype,"readTitle",null),u([Fe("web-map","title",["layerDefinition.name","title"])],yt.prototype,"readTitleFromWebMap",null),u([d({type:String})],yt.prototype,"sublayerTitleMode",void 0),u([d({json:{read:!1}})],yt.prototype,"type",void 0),u([d({type:String})],yt.prototype,"typeIdField",void 0),u([Fe("service","typeIdField"),Fe("typeIdField",["layerDefinition.typeIdField"])],yt.prototype,"readTypeIdField",null),u([d({type:[F_e]})],yt.prototype,"types",void 0),u([Fe("service","types",["types"]),Fe("types",["layerDefinition.types"])],yt.prototype,"readTypes",null),u([d({type:Boolean,json:{origins:{"portal-item":{write:{target:"layerDefinition.defaultVisibility"}}}}})],yt.prototype,"visible",void 0),u([Fe("portal-item","visible",["visibility","layerDefinition.defaultVisibility"])],yt.prototype,"readVisible",null),yt=u([I(k_e)],yt);const XU=dv({types:O4}),V_e=yt,zSt=Object.freeze(Object.defineProperty({__proto__:null,default:V_e},Symbol.toStringTag,{value:"Module"})),GGe=["$datastore","$map","$layer","$aggregatedfeatures"],jGe="esri.widgets.Feature.support.arcadeFeatureUtils",HGe=se.getLogger(jGe);function qGe(t){return typeof t=="string"?dM(ZW(t)):Array.isArray(t)?WGe(t):(t==null?void 0:t.declaredClass)==="esri.arcade.Dictionary"?XGe(t):t}function WGe(t){return`<ul class="esri-widget__list">${t.map(e=>`<li>${typeof e=="string"?dM(ZW(e)):e}</li>`).join("")}</ul>`}function XGe(t){return`<table class="esri-widget__table">${t.keys().map(e=>{const r=t.field(e);return`<tr><th>${e}</th><td>${typeof r=="string"?dM(ZW(r)):r}</td></tr>`}).join("")}</table>`}function YGe({aggregatedFeatures:t,arcadeUtils:e,featureSetVars:r,context:i,viewInfo:s,map:n,graphic:o,interceptor:a}){r.forEach(l=>{const c=l.toLowerCase(),h=s.sr,p={map:n,spatialReference:h,interceptor:a};if(c==="$map"&&(i.vars[c]=e.convertMapToFeatureSetCollection(p)),c==="$layer"&&(i.vars[c]=e.convertFeatureLayerToFeatureSet({layer:o.sourceLayer,spatialReference:h,interceptor:a})),c==="$datastore"&&(i.vars[c]=e.convertServiceUrlToWorkspace({url:o.sourceLayer.url,spatialReference:h,interceptor:a})),c==="$aggregatedfeatures"){const f=o.layer,{fields:m,objectIdField:y,geometryType:_,spatialReference:b,displayField:x}=f,T=new V_e({fields:m,objectIdField:y,geometryType:_,spatialReference:b,displayField:x,...f.type==="feature"?{templates:f.templates,typeIdField:f.typeIdField,types:f.types}:null,source:t});i.vars[c]=e.convertFeatureLayerToFeatureSet({layer:T,spatialReference:b,interceptor:a})}})}function B_e(){return te(()=>import("./arcadeUtils-58980892.js").then(t=>t.ax),["assets/arcadeUtils-58980892.js","assets/arcadeTimeUtils-8aa77359.js","assets/executionError-fb3f283a.js","assets/number-cd7d5381.js","assets/hash-0ddfbf4b.js"])}function ZGe(t){return"createQuery"in t&&"queryFeatures"in t}async function JGe({graphic:t,view:e}){const{isAggregate:r,layer:i}=t;if(!r||!i||(e==null?void 0:e.type)!=="2d")return[];const s=await e.whenLayerView(i);if(!ZGe(s))return[];const n=s.createQuery(),o=t.getObjectId();n.aggregateIds=o!=null?[o]:[];const{features:a}=await s.queryFeatures(n);return a}async function z_e({expressionInfo:t,arcadeUtils:e,interceptor:r,spatialReference:i,map:s,graphic:n,view:o}){if(!t||!t.expression)return null;const a=e.createSyntaxTree(t.expression),l=GGe.filter(m=>e.hasVariable(a,m)),[c]=await Promise.all([JGe({graphic:n,view:o}),e.loadScriptDependencies(a,!0,l)]),h=e.getViewInfo({spatialReference:i}),p=e.createExecContext(n,h);p.interceptor=r,p.useAsync=!0,YGe({aggregatedFeatures:c,arcadeUtils:e,featureSetVars:l,context:p,viewInfo:h,map:s,graphic:n,interceptor:r});const f=e.createFunction(a,p);return e.executeAsyncFunction(f,p).catch(m=>HGe.error("arcade-execution-error",{error:m,graphic:n,expressionInfo:t}))}async function KGe({expressionInfos:t,spatialReference:e,graphic:r,interceptor:i,map:s,view:n}){if(!t||!t.length)return{};const o=await B_e(),a={};for(const h of t)a[`expression/${h.name}`]=z_e({expressionInfo:h,arcadeUtils:o,interceptor:i,spatialReference:e,map:s,graphic:r,view:n});const l=await jl(a),c={};for(const h in l)c[h]=qGe(l[h].value);return c}const QGe=1;let eu=class extends Yw(Te){constructor(e){super(e),this._abortController=null,this.expressionInfo=null,this.graphic=null,this.contentElement=null,this.contentElementViewModel=null,this.interceptor=null,this.view=null,this._cancelQuery=()=>{const{_abortController:r}=this;r&&r.abort(),this._abortController=null},this._createVM=()=>{var s,n;const r=(s=this.contentElement)==null?void 0:s.type;(n=this.contentElementViewModel)==null||n.destroy();const i=r==="fields"?new J4:r==="media"?new Ub:r==="text"?new DN:null;this._set("contentElementViewModel",i)},this._compile=async()=>{this._cancelQuery();const r=new AbortController;this._abortController=r,await this._compileExpression(),this._abortController===r&&(this._abortController=null)},this._compileThrottled=q2(this._compile,QGe,this),this._compileExpression=async()=>{const{expressionInfo:r,graphic:i,interceptor:s,spatialReference:n,map:o,view:a,_abortController:l}=this;if(!(r&&i&&n&&o))return void this._set("contentElement",null);const c=await B_e();if(l!==this._abortController)return;const h=await z_e({arcadeUtils:c,expressionInfo:r,graphic:i,interceptor:s,map:o,spatialReference:n,view:a});if(!h||h.declaredClass!=="esri.arcade.Dictionary")return void this._set("contentElement",null);const p=await h.castAsJsonAsync(l==null?void 0:l.signal),f=p==null?void 0:p.type,m=f==="media"?HR.fromJSON(p):f==="text"?PS.fromJSON(p):f==="fields"?MS.fromJSON(p):null;this._set("contentElement",m)},this.handles.add([ie(()=>[this.expressionInfo,this.graphic,this.map,this.spatialReference,this.view],()=>this._compileThrottled(),Vt),ie(()=>[this.contentElement],()=>this._createVM(),Vt)])}destroy(){var e;this._cancelQuery(),(e=this.contentElementViewModel)==null||e.destroy(),this._set("contentElementViewModel",null),this._set("contentElement",null)}get spatialReference(){var e;return((e=this.view)==null?void 0:e.spatialReference)??null}set spatialReference(e){this._override("spatialReference",e)}get state(){const{_abortController:e,contentElement:r,contentElementViewModel:i}=this;return e?"loading":r||i?"ready":"disabled"}get map(){var e;return((e=this.view)==null?void 0:e.map)??null}set map(e){this._override("map",e)}};u([d()],eu.prototype,"_abortController",void 0),u([d({type:Vde})],eu.prototype,"expressionInfo",void 0),u([d({type:Io})],eu.prototype,"graphic",void 0),u([d({readOnly:!0})],eu.prototype,"contentElement",void 0),u([d({readOnly:!0})],eu.prototype,"contentElementViewModel",void 0),u([d()],eu.prototype,"interceptor",void 0),u([d()],eu.prototype,"spatialReference",null),u([d({readOnly:!0})],eu.prototype,"state",null),u([d()],eu.prototype,"map",null),u([d()],eu.prototype,"view",void 0),eu=u([I("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],eu);const VX=eu,GP={iconLoading:"esri-icon-loading-indicator esri-rotating",base:"esri-feature-expression",loadingSpinnerContainer:"esri-feature__loading-container",spinner:"esri-feature__loading-spinner"};let qL=class extends Ea{constructor(e,r){super(e,r),this._contentWidget=null,this.viewModel=new VX}initialize(){this.addHandles(ie(()=>{var e;return(e=this.viewModel)==null?void 0:e.contentElementViewModel},()=>this._setupExpressionWidget(),Vt))}destroy(){this._destroyContentWidget()}renderLoading(){return re("div",{key:"loading-container",class:GP.loadingSpinnerContainer},re("span",{class:this.classes(GP.iconLoading,GP.spinner)}))}render(){var r;const{state:e}=this.viewModel;return re("div",{class:GP.base},e==="loading"?this.renderLoading():e==="disabled"?null:(r=this._contentWidget)==null?void 0:r.render())}_destroyContentWidget(){const{_contentWidget:e}=this;e&&(e.viewModel=null,e.destroy()),this._contentWidget=null}_setupExpressionWidget(){const{contentElementViewModel:e,contentElement:r}=this.viewModel,i=r==null?void 0:r.type;this._destroyContentWidget();const s=e?i==="fields"?new Xge({viewModel:e}):i==="media"?new Lye({viewModel:e}):i==="text"?new xL({viewModel:e}):null:null;this._contentWidget=s,this.scheduleRender()}};u([d({type:VX})],qL.prototype,"viewModel",void 0),qL=u([I("esri.widgets.Feature.FeatureExpression")],qL);const eje=qL,YU=100;let Yi=class extends bs(eM(Yw(Te))){constructor(e){super(e),this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.featuresPerPage=10,this.description=null,this.graphic=null,this.layer=null,this.map=null,this.orderByFields=null,this.featureCount=0,this.relationshipId=null,this.showAllEnabled=!1,this.title=null,this._cancelQuery=()=>{const{_queryAbortController:r}=this;r&&r.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:r}=this;r&&r.abort(),this._queryFeatureCountAbortController=null},this._cancelQueryPage=()=>{const{_queryPageAbortController:r}=this;r&&r.abort(),this._queryPageAbortController=null},this._queryController=async()=>{this._cancelQuery();const r=new AbortController;this._queryAbortController=r,await k2(this._query()),this._queryAbortController===r&&(this._queryAbortController=null)},this._queryFeatureCountController=async()=>{this._cancelQueryFeatureCount();const r=new AbortController;this._queryFeatureCountAbortController=r,await k2(this._queryFeatureCount()),this._queryFeatureCountAbortController===r&&(this._queryFeatureCountAbortController=null)},this._queryPageController=async()=>{const r=new AbortController;this._queryPageAbortController=r,await k2(this._queryPage()),this._queryPageAbortController===r&&(this._queryPageAbortController=null)},this._queryThrottled=q2(this._queryController,YU,this),this._queryFeatureCountThrottled=q2(this._queryFeatureCountController,YU,this),this._queryPageThrottled=q2(this._queryPageController,YU,this),this._query=async()=>{const{_queryAbortController:r,relatedFeatures:i}=this;this._destroyRelatedFeatureViewModels(),this.featurePage=1,i.removeAll(),i.addMany(this._sliceFeatures(await this._queryRelatedFeatures({signal:r==null?void 0:r.signal})))},this.handles.add([ie(()=>[this.displayCount,this.graphic,this.layer,this.map,this.orderByFieldsFixedCasing,this.relationshipId,this.featuresPerPage,this.showAllEnabled,this.canQuery,this.featureCount],()=>this._queryThrottled(),Vt),ie(()=>[this.featurePage,this.showAllEnabled],()=>this._queryPageThrottled()),ie(()=>[this.layer,this.relationshipId,this.objectId,this.canQuery],()=>this._queryFeatureCountThrottled())])}destroy(){this._destroyRelatedFeatureViewModels(),this.relatedFeatures.removeAll(),this._cancelQuery(),this._cancelQueryFeatureCount(),this._cancelQueryPage()}set featurePage(e){const{featuresPerPage:r,featureCount:i}=this,s=1,n=Math.ceil(i/r)||1;this._set("featurePage",Math.min(Math.max(e,s),n))}get featurePage(){return this._get("featurePage")}get orderByFieldsFixedCasing(){const{orderByFields:e,relatedLayer:r}=this;return e&&(r!=null&&r.loaded)?e.map(i=>{const s=i.clone(),n=rO(i.field,r);return s.field=n,s}):e??[]}get supportsCacheHint(){var e,r,i;return!!((i=(r=(e=this.layer)==null?void 0:e.capabilities)==null?void 0:r.queryRelated)!=null&&i.supportsCacheHint)}get canQuery(){var r,i;const e=(i=(r=this.layer)==null?void 0:r.capabilities)==null?void 0:i.queryRelated;return!!(this.relatedLayer&&this.relationship&&typeof this.relationshipId=="number"&&typeof this.objectId=="number"&&(e!=null&&e.supportsCount)&&(e!=null&&e.supportsPagination))}get itemDescriptionFieldName(){var e,r;return((r=(e=this.orderByFieldsFixedCasing)==null?void 0:e[0])==null?void 0:r.field)||null}set displayCount(e){this._set("displayCount",Math.min(Math.max(e,0),10))}get displayCount(){return this._get("displayCount")}get objectId(){var e,r;return(this.objectIdField&&((r=(e=this.graphic)==null?void 0:e.attributes)==null?void 0:r[this.objectIdField]))??null}get objectIdField(){var e;return((e=this.layer)==null?void 0:e.objectIdField)||null}get relatedFeatures(){return this._get("relatedFeatures")||new Pt}get relatedLayer(){const{layer:e,map:r,relationship:i}=this;return e!=null&&e.loaded&&r&&i?_6e(r,e,i)??null:null}get relationship(){var i;const{relationshipId:e,layer:r}=this;return typeof e=="number"?((i=r==null?void 0:r.relationships)==null?void 0:i.find(({id:s})=>s===e))??null:null}get relatedFeatureViewModels(){return this._get("relatedFeatureViewModels")||new Pt}get state(){const{_queryAbortController:e,_queryFeatureCountAbortController:r,_queryPageAbortController:i,canQuery:s}=this;return r?"loading":e||i?"querying":s?"ready":"disabled"}_destroyRelatedFeatureViewModels(){var e;(e=this.relatedFeatureViewModels)==null||e.forEach(r=>!r.destroyed&&r.destroy()),this.relatedFeatureViewModels.removeAll()}async _queryFeatureCount(){const{layer:e,relatedLayer:r,relationshipId:i,objectId:s,_queryFeatureCountAbortController:n,canQuery:o,supportsCacheHint:a}=this;if(await(e==null?void 0:e.load()),await(r==null?void 0:r.load()),!o||!e||!r)return void this._set("featureCount",0);const l=r.createQuery(),c=new zS({cacheHint:a,relationshipId:i,returnGeometry:!1,objectIds:[s],where:PJ(l.where,void 0)}),h=await e.queryRelatedFeaturesCount(c,{signal:n==null?void 0:n.signal});this._set("featureCount",h[s]||0)}_sliceFeatures(e){const{showAllEnabled:r,displayCount:i}=this;return r?e:i?e.slice(0,i):[]}async _queryPage(){const{relatedFeatures:e,featurePage:r,showAllEnabled:i,_queryPageAbortController:s}=this;!i||r<2||e.addMany(await this._queryRelatedFeatures({signal:s==null?void 0:s.signal}))}async _queryRelatedFeatures(e){var R;const{orderByFieldsFixedCasing:r,showAllEnabled:i,featuresPerPage:s,displayCount:n,layer:o,relationshipId:a,featurePage:l,featureCount:c,relatedLayer:h,supportsCacheHint:p}=this,{canQuery:f,objectId:m}=this;if(!f||!o||!h)return[];const y=i?((l-1)*s+c)%c:0,_=i?s:n,b=h.objectIdField,x=[...r==null?void 0:r.map(L=>L.field),b].filter(v),T=r==null?void 0:r.map(L=>`${L.field} ${L.order}`),S=h.createQuery(),E=new zS({orderByFields:T,start:y,num:_,outFields:x,cacheHint:p,relationshipId:a,returnGeometry:!1,objectIds:[m],where:PJ(S.where,void 0)}),O=((R=(await o.queryRelatedFeatures(E,{signal:e==null?void 0:e.signal}))[m])==null?void 0:R.features)||[];return O.forEach(L=>{L.sourceLayer=h,L.layer=h}),O}};u([d()],Yi.prototype,"_queryAbortController",void 0),u([d()],Yi.prototype,"_queryPageAbortController",void 0),u([d()],Yi.prototype,"_queryFeatureCountAbortController",void 0),u([d({value:1})],Yi.prototype,"featurePage",null),u([d()],Yi.prototype,"featuresPerPage",void 0),u([d({readOnly:!0})],Yi.prototype,"orderByFieldsFixedCasing",null),u([d({readOnly:!0})],Yi.prototype,"supportsCacheHint",null),u([d({readOnly:!0})],Yi.prototype,"canQuery",null),u([d()],Yi.prototype,"description",void 0),u([d({readOnly:!0})],Yi.prototype,"itemDescriptionFieldName",null),u([d({value:3})],Yi.prototype,"displayCount",null),u([d({type:Io})],Yi.prototype,"graphic",void 0),u([d()],Yi.prototype,"layer",void 0),u([d()],Yi.prototype,"map",void 0),u([d({readOnly:!0})],Yi.prototype,"objectId",null),u([d({readOnly:!0})],Yi.prototype,"objectIdField",null),u([d()],Yi.prototype,"orderByFields",void 0),u([d({readOnly:!0})],Yi.prototype,"relatedFeatures",null),u([d({readOnly:!0})],Yi.prototype,"relatedLayer",null),u([d({readOnly:!0})],Yi.prototype,"relationship",null),u([d()],Yi.prototype,"featureCount",void 0),u([d({readOnly:!0})],Yi.prototype,"relatedFeatureViewModels",null),u([d()],Yi.prototype,"relationshipId",void 0),u([d()],Yi.prototype,"showAllEnabled",void 0),u([d()],Yi.prototype,"state",null),u([d()],Yi.prototype,"title",void 0),Yi=u([I("esri.widgets.Feature.FeatureRelationship.FeatureRelationshipViewModel")],Yi);const BX=Yi,QA="esri-feature",ZU=`${QA}-relationship`,Pm={base:ZU,esriWidget:"esri-widget",listContainer:`${ZU}__list`,listContainerQuerying:`${ZU}__list--querying`,featureObserver:`${QA}__feature-observer`,stickySpinnerContainer:`${QA}__sticky-loading-container`,loadingSpinnerContainer:`${QA}__loading-container`,spinner:`${QA}__loading-spinner`,iconLoading:"esri-icon-loading-indicator esri-rotating"},ire={title:!0,description:!0};let Tl=class extends Ea{constructor(e,r){super(e,r),this._featureElementInfo=null,this._relatedFeatureIntersectionObserverNode=null,this._relatedFeatureIntersectionObserver=new IntersectionObserver(([i])=>{i!=null&&i.isIntersecting&&this._increaseFeaturePage()},{root:window.document}),this.headingLevel=2,this.viewModel=new BX,this.messages=null,this.messagesCommon=null,this.visibleElements={...ire},this._increaseFeaturePage=()=>{const{state:i,showAllEnabled:s,relatedFeatures:n,featuresPerPage:o,featurePage:a}=this.viewModel;i==="ready"&&s&&n.length>=o*a&&this.viewModel.featurePage++}}initialize(){this._featureElementInfo=new Z4,this.addHandles([ie(()=>[this.viewModel.description,this.viewModel.title,this.headingLevel],()=>this._setupFeatureElementInfo(),Vt),ie(()=>[this.viewModel.state,this.viewModel.showAllEnabled,this._relatedFeatureIntersectionObserverNode],()=>this._handleRelatedFeatureObserverChange()),sn(()=>this.viewModel.relatedFeatureViewModels,"change",()=>this._setupRelatedFeatureViewModels())])}loadDependencies(){return Promise.all([te(()=>import("./calcite-list-9ac3378b.js"),["assets/calcite-list-9ac3378b.js","assets/interactive-573cbe88.js","assets/observers-2e8584e1.js","assets/utils3-afa3723b.js","assets/loadable-25ad9e4e.js","assets/debounce-31e0cfcc.js","assets/t9n-83b3e707.js","assets/icon-31e4ed97.js","assets/loader-2f409f99.js","assets/guid-9426053f.js","assets/scrim-fabf9087.js"]),te(()=>import("./calcite-list-item-7c67cc60.js"),["assets/calcite-list-item-7c67cc60.js","assets/interactive-573cbe88.js","assets/utils3-afa3723b.js","assets/loadable-25ad9e4e.js","assets/icon-31e4ed97.js","assets/observers-2e8584e1.js"]),te(()=>import("./calcite-icon-0839c644.js"),["assets/calcite-icon-0839c644.js","assets/icon-31e4ed97.js","assets/observers-2e8584e1.js"]),te(()=>import("./calcite-notice-5594bffb.js"),["assets/calcite-notice-5594bffb.js","assets/observers-2e8584e1.js","assets/loadable-25ad9e4e.js","assets/t9n-83b3e707.js","assets/icon-31e4ed97.js"])])}destroy(){this._unobserveRelatedFeatureObserver(),this._featureElementInfo=ke(this._featureElementInfo)}get displayShowAllButton(){const{showAllEnabled:e,featureCount:r,displayCount:i}=this.viewModel;return!e&&!!r&&(r>i||i===0)}get displayListItems(){return this.displayShowAllButton||this.viewModel.relatedFeatureViewModels.length>0}get description(){return this.viewModel.description}set description(e){this.viewModel.description=e}get featureCountDescription(){const{messages:e}=this,{featureCount:r}=this.viewModel;return Tf(r===1?e==null?void 0:e.numberRecord:e==null?void 0:e.numberRecords,{number:r})}get title(){return this.viewModel.title}set title(e){this.viewModel.title=e}castVisibleElements(e){return{...ire,...e}}renderStickyLoading(){return this.viewModel.state==="querying"?re("div",{key:"sticky-loader",class:Pm.stickySpinnerContainer},this.renderLoadingIcon()):null}renderLoadingIcon(){return re("span",{class:this.classes(Pm.iconLoading,Pm.spinner)})}renderLoading(){return re("div",{key:"loading-container",class:Pm.loadingSpinnerContainer},this.renderLoadingIcon())}renderShowAllIconNode(){return re("calcite-icon",{scale:"s",icon:"list",slot:"content-end"})}renderChevronIconNode(){const e=Uf(this.container)?"chevron-left":"chevron-right";return re("calcite-icon",{scale:"s",icon:e,slot:"content-end"})}renderRelatedFeature(e){var n,o;const{itemDescriptionFieldName:r}=this.viewModel,i=e.title;e.description=r&&((n=e.formattedAttributes)==null?void 0:n.global[r]);const s=e.state==="loading";return re("calcite-list-item",{key:e.uid,label:s?`${(o=this.messagesCommon)==null?void 0:o.loading}…`:i,description:s?"…":e.description??"",onCalciteListItemSelect:()=>this.emit("select-record",{featureViewModel:e})},this.renderChevronIconNode())}renderShowAllListItem(){var e;return this.displayShowAllButton?re("calcite-list-item",{key:"show-all-item",label:(e=this.messages)==null?void 0:e.showAll,description:this.featureCountDescription,onCalciteListItemSelect:()=>this.emit("show-all-records")},this.renderShowAllIconNode()):null}renderNoRelatedFeaturesMessage(){var e;return re("calcite-notice",{key:"no-related-features-message",icon:"information",open:!0,kind:"brand",scale:"s",width:"full"},re("div",{slot:"message"},(e=this.messages)==null?void 0:e.noRelatedFeatures))}renderFeatureObserver(){return re("div",{key:"feature-observer",class:Pm.featureObserver,bind:this,afterCreate:this._relatedFeatureIntersectionObserverCreated})}renderList(){const{relatedFeatureViewModels:e}=this.viewModel;return re("calcite-list",null,e.toArray().map(r=>this.renderRelatedFeature(r)),this.renderShowAllListItem())}renderRelatedFeatures(){const{displayListItems:e}=this,{state:r}=this.viewModel;return re("div",{key:"list-container",class:this.classes(Pm.listContainer,{[Pm.listContainerQuerying]:r==="querying"})},e?this.renderList():r==="ready"?this.renderNoRelatedFeaturesMessage():null,this.renderStickyLoading(),this.renderFeatureObserver())}renderRelationshipNotFound(){var e;return re("calcite-notice",{key:"relationship-not-found",icon:"exclamation-mark-triangle",open:!0,kind:"danger",scale:"s",width:"full"},re("div",{slot:"message"},(e=this.messages)==null?void 0:e.relationshipNotFound))}render(){var r;const{state:e}=this.viewModel;return re("div",{class:this.classes(Pm.base,Pm.esriWidget)},(r=this._featureElementInfo)==null?void 0:r.render(),e==="loading"?this.renderLoading():e==="disabled"?this.renderRelationshipNotFound():this.renderRelatedFeatures())}_setupRelatedFeatureViewModels(){const{relatedFeatureViewModels:e}=this.viewModel,r="related-feature-viewmodels";this.removeHandles(r),e==null||e.forEach(i=>{this.addHandles(ie(()=>[i.title,i.state],()=>this.scheduleRender(),Vt),r)}),this.scheduleRender()}_setupFeatureElementInfo(){var n;const{headingLevel:e,visibleElements:r}=this,i=r.description&&this.description,s=r.title&&this.title;(n=this._featureElementInfo)==null||n.set({description:i,title:s,headingLevel:e})}async _handleRelatedFeatureObserverChange(){this._unobserveRelatedFeatureObserver();const{state:e,showAllEnabled:r}=this.viewModel;await nw(0),this._relatedFeatureIntersectionObserverNode&&e==="ready"&&r&&this._relatedFeatureIntersectionObserver.observe(this._relatedFeatureIntersectionObserverNode)}_relatedFeatureIntersectionObserverCreated(e){this._relatedFeatureIntersectionObserverNode=e}_unobserveRelatedFeatureObserver(){this._relatedFeatureIntersectionObserverNode&&this._relatedFeatureIntersectionObserver.unobserve(this._relatedFeatureIntersectionObserverNode)}};u([d()],Tl.prototype,"_relatedFeatureIntersectionObserverNode",void 0),u([d({readOnly:!0})],Tl.prototype,"displayShowAllButton",null),u([d({readOnly:!0})],Tl.prototype,"displayListItems",null),u([d()],Tl.prototype,"description",null),u([d({readOnly:!0})],Tl.prototype,"featureCountDescription",null),u([d()],Tl.prototype,"headingLevel",void 0),u([d()],Tl.prototype,"title",null),u([d({type:BX})],Tl.prototype,"viewModel",void 0),u([d(),ya("esri/widgets/Feature/t9n/Feature")],Tl.prototype,"messages",void 0),u([d(),ya("esri/t9n/common")],Tl.prototype,"messagesCommon",void 0),u([d()],Tl.prototype,"visibleElements",void 0),u([cr("visibleElements")],Tl.prototype,"castVisibleElements",null),Tl=u([I("esri.widgets.Feature.FeatureRelationship")],Tl);const sre=Tl;let tje=class{constructor(e,r){this.preLayerQueryCallback=e,this.preRequestCallback=r,this.preLayerQueryCallback||(this.preLayerQueryCallback=i=>{}),this.preRequestCallback||(this.preLayerQueryCallback=i=>{})}};var e3;const rje=1,nre="content-view-models",ore="relationship-view-models",are={attachmentsContent:!0,chartAnimation:!0,customContent:!0,expressionContent:!0,fieldsContent:!0,mediaContent:!0,textContent:!0,relationshipContent:!0};let Os=e3=class extends eM(Te){constructor(t){super(t),this._handles=new ei,this._error=null,this._featureAbortController=null,this._graphicChangedThrottled=q2(this._graphicChanged,rje,this),this._expressionAttributes=null,this._graphicExpressionAttributes=null,this.abilities={...are},this.content=null,this.contentViewModels=[],this.description=null,this.defaultPopupTemplateEnabled=!1,this.formattedAttributes=null,this.lastEditInfo=null,this.relatedInfos=new Map,this.title="",this.view=null,this._isAllowedContentType=e=>{const{abilities:r}=this;return e.type==="attachments"&&!!r.attachmentsContent||e.type==="custom"&&!!r.customContent||e.type==="fields"&&!!r.fieldsContent||e.type==="media"&&!!r.mediaContent||e.type==="text"&&!!r.textContent||e.type==="expression"&&!!r.expressionContent||e.type==="relationship"&&!!r.relationshipContent},this._handles.add(ie(()=>[this.graphic,this._effectivePopupTemplate,this.abilities],()=>this._graphicChangedThrottled(),Vt))}destroy(){this._clear(),this._cancelFeatureQuery(),this._error=null,this._handles.destroy(),this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()}get _effectivePopupTemplate(){return v(this.graphic)?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}get _fieldInfoMap(){return h6e(YQ(this._effectivePopupTemplate),this._sourceLayer)}get _sourceLayer(){return Dge(this.graphic)}castAbilities(t){return{...are,...t}}get isTable(){var t;return((t=this._sourceLayer)==null?void 0:t.isTable)||!1}get state(){return this.graphic?this._error?"error":this.waitingForContent?"loading":"ready":"disabled"}set graphic(t){this._set("graphic",t?t.clone():null)}get spatialReference(){var t;return((t=this.view)==null?void 0:t.spatialReference)??null}set spatialReference(t){this._override("spatialReference",t)}get map(){var t;return((t=this.view)==null?void 0:t.map)||null}set map(t){this._override("map",t)}get waitingForContent(){return!!this._featureAbortController}setActiveMedia(t,e){const r=this.contentViewModels[t];r instanceof Ub&&r.setActiveMedia(e)}nextMedia(t){const e=this.contentViewModels[t];e instanceof Ub&&e.next()}previousMedia(t){const e=this.contentViewModels[t];e instanceof Ub&&e.previous()}async updateGeometry(){var o,a;const{graphic:t,spatialReference:e,_sourceLayer:r}=this;await(r==null?void 0:r.load());const i=r==null?void 0:r.objectIdField;if(!i||!t||!r)return;const s=(o=t==null?void 0:t.attributes)==null?void 0:o[i];if(s==null)return;const n=[s];if(!t.geometry){const l=(a=await Bge({layer:r,graphic:t,outFields:[],objectIds:n,returnGeometry:!0,spatialReference:e}))==null?void 0:a.geometry;l&&(t.geometry=l)}}_clear(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)}async _graphicChanged(){this._cancelFeatureQuery(),this._error=null,this._clear();const{graphic:t}=this;if(!t)return;const e=new AbortController;this._featureAbortController=e;try{await this._queryFeature({signal:e.signal})}catch(r){Qs(r)||(this._error=r,se.getLogger(this.declaredClass).error("error","The popupTemplate could not be displayed for this feature.",{error:r,graphic:t,popupTemplate:this._effectivePopupTemplate}))}this._featureAbortController===e&&(this._featureAbortController=null)}_cancelFeatureQuery(){const{_featureAbortController:t}=this;t&&t.abort(),this._featureAbortController=null}_compileContentElement(t,e){return t.type==="attachments"?this._compileAttachments(t,e):t.type==="custom"?this._compileCustom(t,e):t.type==="fields"?this._compileFields(t,e):t.type==="media"?this._compileMedia(t,e):t.type==="text"?this._compileText(t,e):t.type==="expression"?this._compileExpression(t,e):t.type==="relationship"?this._compileRelationship(t,e):void 0}_compileContent(t){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(t)?t.filter(this._isAllowedContentType).map((e,r)=>this._compileContentElement(e,r)).filter(v):typeof t=="string"?this._compileText(new PS({text:t}),0).text:t}_destroyContentViewModels(){var t,e;(t=this._handles)==null||t.remove(ore),(e=this._handles)==null||e.remove(nre),this.contentViewModels.forEach(r=>r&&!r.destroyed&&r.destroy()),this._set("contentViewModels",[])}_matchesFeature(t,e){var s;const r=(s=t==null?void 0:t.graphic)==null?void 0:s.getObjectId(),i=e==null?void 0:e.getObjectId();return v(r)&&v(i)&&r===i}_setRelatedFeaturesViewModels({relatedFeatureViewModels:t,relatedFeatures:e,map:r}){const{view:i,spatialReference:s}=this;e==null||e.filter(Boolean).forEach(n=>{t.find(o=>this._matchesFeature(o,n))||t.add(new e3({abilities:{relationshipContent:!1},map:r,view:i,spatialReference:s,graphic:n}))}),t.forEach(n=>{(e==null?void 0:e.find(a=>this._matchesFeature(n,a)))||t.remove(n)})}_setExpressionContentVM(t,e){const r=this.formattedAttributes,{contentElement:i,contentElementViewModel:s}=t,n=i==null?void 0:i.type;s&&n&&(n==="fields"&&(this._createFieldsFormattedAttributes({contentElement:i,contentElementIndex:e,formattedAttributes:r}),s.set(this._createFieldsVMParams(i,e))),n==="media"&&(this._createMediaFormattedAttributes({contentElement:i,contentElementIndex:e,formattedAttributes:r}),s.set(this._createMediaVMParams(i,e))),n==="text"&&s.set(this._createTextVMParams(i)))}_compileRelationship(t,e){const{displayCount:r,orderByFields:i,relationshipId:s,title:n,description:o}=t,{_sourceLayer:a,graphic:l,map:c}=this,h=new BX({displayCount:r,graphic:l,orderByFields:i,relationshipId:s,layer:a,map:c,...this._compileTitleAndDesc({title:n,description:o})});return this.contentViewModels[e]=h,this._handles.add(sn(()=>h.relatedFeatures,"change",()=>this._setRelatedFeaturesViewModels(h)),ore),t}_compileExpression(t,e){const{expressionInfo:r}=t,{graphic:i,map:s,spatialReference:n,view:o}=this,a=new VX({expressionInfo:r,graphic:i,interceptor:e3.interceptor,map:s,spatialReference:n,view:o});return this.contentViewModels[e]=a,this._handles.add(ie(()=>a.contentElementViewModel,()=>this._setExpressionContentVM(a,e),Vt),nre),t}_compileAttachments(t,e){const{graphic:r}=this,{description:i,title:s}=t;return this.contentViewModels[e]=new KW({graphic:r,...this._compileTitleAndDesc({title:s,description:i})}),t}_compileCustom(t,e){const{graphic:r}=this,{creator:i,destroyer:s}=t;return this.contentViewModels[e]=new DN({graphic:r,creator:i,destroyer:s}),t}_compileTitleAndDesc({title:t,description:e}){const{_fieldInfoMap:r,_sourceLayer:i,graphic:s,formattedAttributes:n}=this,o=s==null?void 0:s.attributes,a=this._expressionAttributes,l=n.global;return{title:Nb({attributes:o,fieldInfoMap:r,globalAttributes:l,expressionAttributes:a,layer:i,text:t}),description:Nb({attributes:o,fieldInfoMap:r,globalAttributes:l,expressionAttributes:a,layer:i,text:e})}}_createFieldsVMParams(t,e){var c;const r=this._effectivePopupTemplate,i=this.formattedAttributes,s={...i==null?void 0:i.global,...i==null?void 0:i.content[e]},n=(c=(t==null?void 0:t.fieldInfos)||(r==null?void 0:r.fieldInfos))==null?void 0:c.filter(({fieldName:h})=>XW(h)||$g(h)||s.hasOwnProperty(h)),o=r==null?void 0:r.expressionInfos,{description:a,title:l}=t;return{attributes:s,expressionInfos:o,fieldInfos:n,...this._compileTitleAndDesc({title:l,description:a})}}_compileFields(t,e){const r=t.clone(),i=new J4(this._createFieldsVMParams(t,e));return this.contentViewModels[e]=i,r.fieldInfos=i.formattedFieldInfos.slice(0),r}_createMediaVMParams(t,e){const{abilities:r,graphic:i,_fieldInfoMap:s,_effectivePopupTemplate:n,relatedInfos:o,_sourceLayer:a,_expressionAttributes:l}=this,c=this.formattedAttributes,h=(i==null?void 0:i.attributes)??{},{description:p,mediaInfos:f,title:m}=t;return{abilities:{chartAnimation:r.chartAnimation},activeMediaInfoIndex:t.activeMediaInfoIndex||0,attributes:h,isAggregate:i==null?void 0:i.isAggregate,layer:a,fieldInfoMap:s,formattedAttributes:{...c==null?void 0:c.global,...c==null?void 0:c.content[e]},expressionAttributes:l,mediaInfos:f,popupTemplate:n,relatedInfos:o,...this._compileTitleAndDesc({title:m,description:p})}}_compileMedia(t,e){const r=t.clone(),i=new Ub(this._createMediaVMParams(t,e));return r.mediaInfos=i.formattedMediaInfos.slice(0),this.contentViewModels[e]=i,r}_createTextVMParams(t){var n;const{graphic:e,_fieldInfoMap:r,_sourceLayer:i,_expressionAttributes:s}=this;if(t&&t.text){const o=(e==null?void 0:e.attributes)??{},a=((n=this.formattedAttributes)==null?void 0:n.global)??{};t.text=Nb({attributes:o,fieldInfoMap:r,globalAttributes:a,expressionAttributes:s,layer:i,text:t.text})}return{graphic:e,creator:t.text}}_compileText(t,e){const r=t.clone();return this.contentViewModels[e]=new DN(this._createTextVMParams(r)),r}_compileLastEditInfo(){const{_effectivePopupTemplate:t,_sourceLayer:e,graphic:r}=this;if(!t)return;const{lastEditInfoEnabled:i}=t,s=e==null?void 0:e.editFieldsInfo;return i&&s?u6e(s,r==null?void 0:r.attributes):void 0}_compileTitle(t){var a;const{_fieldInfoMap:e,_sourceLayer:r,graphic:i,_expressionAttributes:s}=this,n=(i==null?void 0:i.attributes)??{},o=((a=this.formattedAttributes)==null?void 0:a.global)??{};return Nb({attributes:n,fieldInfoMap:e,globalAttributes:o,expressionAttributes:s,layer:r,text:t})}async _getTitle(){const{_effectivePopupTemplate:t,graphic:e}=this;if(!e)return null;const r=t==null?void 0:t.title;return LN(r,{graphic:e})}async _getContent(){const{_effectivePopupTemplate:t,graphic:e}=this;if(!e)return null;const r=t==null?void 0:t.content;return LN(r,{graphic:e})}async _queryFeature(t){const{_featureAbortController:e,_sourceLayer:r,graphic:i,_effectivePopupTemplate:s}=this,n=this.map,o=this.view,a=this.spatialReference;if(e!==this._featureAbortController||!i)return;await p6e({graphic:i,popupTemplate:s,layer:r,spatialReference:a},t);const{content:{value:l},title:{value:c}}=await jl({content:this._getContent(),title:this._getTitle()}),{expressionAttributes:{value:h}}=await jl({checkForRelatedFeatures:this._checkForRelatedFeatures(t),expressionAttributes:KGe({expressionInfos:s==null?void 0:s.expressionInfos,spatialReference:a,graphic:i,map:n,interceptor:e3.interceptor,view:o})});e===this._featureAbortController&&i&&(this._expressionAttributes=h,this._graphicExpressionAttributes={...i.attributes,...h},this._set("formattedAttributes",this._createFormattedAttributes(l)),this._set("title",this._compileTitle(c)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(l)||null))}_createMediaFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:r}){const{_effectivePopupTemplate:i,graphic:s,relatedInfos:n,_sourceLayer:o,_fieldInfoMap:a,_graphicExpressionAttributes:l}=this;r.content[e]=aU({fieldInfos:i==null?void 0:i.fieldInfos,graphic:s,attributes:{...l,...t.attributes},layer:o,fieldInfoMap:a,relatedInfos:n})}_createFieldsFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:r}){if(t.fieldInfos){const{graphic:i,relatedInfos:s,_sourceLayer:n,_fieldInfoMap:o,_graphicExpressionAttributes:a}=this;r.content[e]=aU({fieldInfos:t.fieldInfos,graphic:i,attributes:{...a,...t.attributes},layer:n,fieldInfoMap:o,relatedInfos:s})}}_createFormattedAttributes(t){const{_effectivePopupTemplate:e,graphic:r,relatedInfos:i,_sourceLayer:s,_fieldInfoMap:n,_graphicExpressionAttributes:o}=this,a=e==null?void 0:e.fieldInfos,l={global:aU({fieldInfos:a,graphic:r,attributes:o,layer:s,fieldInfoMap:n,relatedInfos:i}),content:[]};return Array.isArray(t)&&t.forEach((c,h)=>{c.type==="fields"&&this._createFieldsFormattedAttributes({contentElement:c,contentElementIndex:h,formattedAttributes:l}),c.type==="media"&&this._createMediaFormattedAttributes({contentElement:c,contentElementIndex:h,formattedAttributes:l})}),l}_checkForRelatedFeatures(t){const{graphic:e,_effectivePopupTemplate:r}=this;return this._queryRelatedInfos(e,YQ(r),t)}async _queryRelatedInfos(t,e,r){const{relatedInfos:i,_sourceLayer:s}=this;i.clear();const n=v(s==null?void 0:s.associatedLayer)?await(s==null?void 0:s.associatedLayer.load(r)):s;if(!n||!t)return;const o=e.filter(c=>c&&$g(c.fieldName));if(!o||!o.length)return;e.forEach(c=>this._configureRelatedInfo(c,n));const a=await T9e({relatedInfos:i,layer:n},r);Object.keys(a).forEach(c=>{var f;const h=i.get(c.toString()),p=(f=a[c])==null?void 0:f.value;h&&p&&(h.layerInfo=p.data)});const l=await S9e({graphic:t,relatedInfos:i,layer:n},r);Object.keys(l).forEach(c=>{var h;_9e((h=l[c])==null?void 0:h.value,i.get(c.toString()))})}_configureRelatedInfo(t,e){const{relatedInfos:r}=this,i=AL(t.fieldName);if(!i)return;const{layerId:s,fieldName:n}=i;if(!s)return;const o=r.get(s.toString())||y9e(s,e);o&&(E9e({relatedInfo:o,fieldName:n,fieldInfo:t}),this.relatedInfos.set(s,o))}};Os.interceptor=new tje(g6e,y6e),u([d()],Os.prototype,"_error",void 0),u([d()],Os.prototype,"_featureAbortController",void 0),u([d({readOnly:!0})],Os.prototype,"_effectivePopupTemplate",null),u([d({readOnly:!0})],Os.prototype,"_fieldInfoMap",null),u([d({readOnly:!0})],Os.prototype,"_sourceLayer",null),u([d()],Os.prototype,"abilities",void 0),u([cr("abilities")],Os.prototype,"castAbilities",null),u([d({readOnly:!0})],Os.prototype,"content",void 0),u([d({readOnly:!0})],Os.prototype,"contentViewModels",void 0),u([d()],Os.prototype,"description",void 0),u([d({type:Boolean})],Os.prototype,"defaultPopupTemplateEnabled",void 0),u([d({readOnly:!0})],Os.prototype,"isTable",null),u([d({readOnly:!0})],Os.prototype,"state",null),u([d({readOnly:!0})],Os.prototype,"formattedAttributes",void 0),u([d({type:Io,value:null})],Os.prototype,"graphic",null),u([d({readOnly:!0})],Os.prototype,"lastEditInfo",void 0),u([d({readOnly:!0})],Os.prototype,"relatedInfos",void 0),u([d()],Os.prototype,"spatialReference",null),u([d({readOnly:!0})],Os.prototype,"title",void 0),u([d()],Os.prototype,"map",null),u([d({readOnly:!0})],Os.prototype,"waitingForContent",null),u([d()],Os.prototype,"view",void 0),Os=e3=u([I("esri.widgets.FeatureViewModel")],Os);const zX=Os,Qo="esri-feature",Js={iconText:"esri-icon-font-fallback-text",iconLoading:"esri-icon-loading-indicator esri-rotating",esriTable:"esri-widget__table",esriWidget:"esri-widget",base:Qo,container:`${Qo}__size-container`,title:`${Qo}__title`,main:`${Qo}__main-container`,btn:`${Qo}__button`,icon:`${Qo}__icon`,content:`${Qo}__content`,contentNode:`${Qo}__content-node`,contentElement:`${Qo}__content-element`,text:`${Qo}__text`,lastEditedInfo:`${Qo}__last-edited-info`,fields:`${Qo}__fields`,fieldHeader:`${Qo}__field-header`,fieldData:`${Qo}__field-data`,fieldDataDate:`${Qo}__field-data--date`,loadingSpinnerContainer:`${Qo}__loading-container`,spinner:`${Qo}__loading-spinner`},G_e=t=>{let e=class extends t{constructor(){super(...arguments),this.renderNodeContent=r=>Wge(r)&&!r.destroyed?re("div",{class:Js.contentNode,key:r},r.render()):r instanceof HTMLElement?re("div",{class:Js.contentNode,key:r,bind:r,afterCreate:this._attachToNode}):L6e(r)?re("div",{class:Js.contentNode,key:r,bind:r.domNode,afterCreate:this._attachToNode}):null}_attachToNode(r){const i=this;r.appendChild(i)}};return e=u([I("esri.widgets.Feature.ContentMixin")],e),e};var eG;const lre={title:!0,content:!0,lastEditedInfo:!0},cre="relationship-handles";let yo=eG=class extends G_e(Ea){constructor(t,e){super(t,e),this._contentWidgets=[],this.flowItems=null,this.headingLevel=2,this.messages=null,this.messagesCommon=null,this.messagesURIUtils=null,this.visibleElements={...lre},this.viewModel=new zX}initialize(){this.addHandles(ie(()=>{var t;return(t=this.viewModel)==null?void 0:t.contentViewModels},()=>this._setupContentWidgets(),Vt))}loadDependencies(){return te(()=>import("./calcite-notice-5594bffb.js"),["assets/calcite-notice-5594bffb.js","assets/observers-2e8584e1.js","assets/loadable-25ad9e4e.js","assets/t9n-83b3e707.js","assets/icon-31e4ed97.js"])}destroy(){this._destroyContentWidgets()}get graphic(){return this.viewModel.graphic}set graphic(t){this.viewModel.graphic=t}get defaultPopupTemplateEnabled(){return this.viewModel.defaultPopupTemplateEnabled}set defaultPopupTemplateEnabled(t){this.viewModel.defaultPopupTemplateEnabled=t}get isTable(){return this.viewModel.isTable}get label(){var t;return((t=this.messages)==null?void 0:t.widgetLabel)??""}set label(t){this._overrideIfSome("label",t)}get spatialReference(){return this.viewModel.spatialReference}set spatialReference(t){this.viewModel.spatialReference=t}get title(){return this.viewModel.title}castVisibleElements(t){return{...lre,...t}}get map(){return this.viewModel.map}set map(t){this.viewModel.map=t}get view(){return this.viewModel.view}set view(t){this.viewModel.view=t}render(){const{state:t}=this.viewModel,e=re("div",{class:Js.container,key:"container"},this.renderTitle(),t==="error"?this.renderError():t==="loading"?this.renderLoading():this.renderContentContainer());return re("div",{class:this.classes(Js.base,Js.esriWidget)},e)}setActiveMedia(t,e){return this.viewModel.setActiveMedia(t,e)}nextMedia(t){return this.viewModel.nextMedia(t)}previousMedia(t){return this.viewModel.previousMedia(t)}renderError(){const{messagesCommon:t,messages:e,visibleElements:r}=this;return re("calcite-notice",{open:!0,kind:"danger",icon:"exclamation-mark-circle",scale:"s"},r.title?re("div",{key:"error-title",slot:"title"},t.errorMessage):null,re("div",{key:"error-message",slot:"message"},e.loadingError))}renderLoading(){return re("div",{key:"loading-container",class:Js.loadingSpinnerContainer},re("span",{class:this.classes(Js.iconLoading,Js.spinner)}))}renderContentContainer(){const{visibleElements:t}=this;return t.content?re("div",{class:Js.main},[this.renderContent(),this.renderLastEditInfo()]):null}renderTitle(){const{visibleElements:t,title:e}=this;return t.title?re(QW,{level:this.headingLevel,class:Js.title,innerHTML:e}):null}renderContent(){const t=this.viewModel.content,e="content";if(!t)return null;if(Array.isArray(t))return t.length?re("div",{class:Js.contentNode,key:`${e}-content-elements`},t.map(this.renderContentElement,this)):null;if(typeof t=="string"){const r=this._contentWidgets[0];return!r||r.destroyed?null:re("div",{class:Js.contentNode,key:`${e}-content`},r.render())}return this.renderNodeContent(t)}renderContentElement(t,e){var i;const{visibleElements:r}=this;if(typeof r.content!="boolean"&&!((i=r.content)!=null&&i[t.type]))return null;switch(t.type){case"attachments":return this.renderAttachments(e);case"custom":return this.renderCustom(t,e);case"fields":return this.renderFields(e);case"media":return this.renderMedia(e);case"text":return this.renderText(t,e);case"expression":return this.renderExpression(e);case"relationship":return this.renderRelationship(e);default:return null}}renderAttachments(t){const e=this._contentWidgets[t];if(!e||e.destroyed)return null;const{state:r,attachmentInfos:i}=e.viewModel;return r==="loading"||i.length>0?re("div",{key:this._buildKey("attachments-element",t),class:this.classes(Js.contentElement)},e.render()):null}renderRelationship(t){const e=this._contentWidgets[t];return e&&!e.destroyed&&this.flowItems?re("div",{key:this._buildKey("relationship-element",t),class:Js.contentElement},e.render()):null}renderExpression(t){const e=this._contentWidgets[t];return!e||e.destroyed?null:re("div",{key:this._buildKey("expression-element",t),class:Js.contentElement},e.render())}renderCustom(t,e){const{creator:r}=t,i=this._contentWidgets[e];return!i||i.destroyed?null:r?re("div",{key:this._buildKey("custom-element",e),class:Js.contentElement},i.render()):null}renderFields(t){const e=this._contentWidgets[t];return!e||e.destroyed?null:re("div",{key:this._buildKey("fields-element",t),class:Js.contentElement},e.render())}renderMedia(t){const e=this._contentWidgets[t];return!e||e.destroyed?null:re("div",{key:this._buildKey("media-element",t),class:Js.contentElement},e.render())}renderLastEditInfo(){const{visibleElements:t,messages:e}=this,{lastEditInfo:r}=this.viewModel;if(!r||!t.lastEditedInfo)return null;const{date:i,user:s}=r,n=r.type==="edit"?s?e.lastEditedByUser:e.lastEdited:s?e.lastCreatedByUser:e.lastCreated,o=Tf(n,{date:i,user:s});return re("div",{key:"edit-info-element",class:this.classes(Js.lastEditedInfo,Js.contentElement)},o)}renderText(t,e){const r=t.text,i=this._contentWidgets[e];return!i||i.destroyed?null:r?re("div",{key:this._buildKey("text-element",e),class:this.classes(Js.contentElement,Js.text)},i.render()):null}_buildKey(t,...e){return`${t}__${this.get("viewModel.graphic.uid")||"0"}-${e.join("-")}`}_destroyContentWidget(t){t&&(t.viewModel=null,!t.destroyed&&t.destroy())}_destroyContentWidgets(){this.removeHandles(cre),this._contentWidgets.forEach(t=>this._destroyContentWidget(t)),this._contentWidgets=[]}_addFeatureRelationshipHandles(t){const{flowItems:e,visibleElements:r}=this;this.addHandles([sn(()=>t,"select-record",({featureViewModel:i})=>{e&&(i.abilities={relationshipContent:!0},e.push(new eG({flowItems:e,viewModel:i,visibleElements:r})))}),sn(()=>t,"show-all-records",()=>{if(!e)return;const{viewModel:i}=t;i.showAllEnabled=!0;const s=new sre({visibleElements:{title:!1,description:!1},viewModel:i});this._addFeatureRelationshipHandles(s),e.push(s)})],cre)}_setupContentWidgets(){this._destroyContentWidgets();const{headingLevel:t,visibleElements:e}=this,r=this.get("viewModel.content"),{contentViewModels:i}=this.viewModel;if(Array.isArray(r))r.forEach((s,n)=>{if(s.type==="attachments"&&(this._contentWidgets[n]=new C6e({displayType:s.displayType,headingLevel:e.title?t+1:t,viewModel:i[n]})),s.type==="fields"&&(this._contentWidgets[n]=new Xge({viewModel:i[n]})),s.type==="media"&&(this._contentWidgets[n]=new Lye({viewModel:i[n]})),s.type==="text"&&(this._contentWidgets[n]=new xL({viewModel:i[n]})),s.type==="custom"&&(this._contentWidgets[n]=new xL({viewModel:i[n]})),s.type==="expression"&&(this._contentWidgets[n]=new eje({viewModel:i[n]})),s.type==="relationship"){const o=new sre({viewModel:i[n]});this._addFeatureRelationshipHandles(o),this._contentWidgets[n]=o}},this);else{const s=i[0];s&&!s.destroyed&&(this._contentWidgets[0]=new xL({viewModel:s}))}this.scheduleRender()}};u([d()],yo.prototype,"graphic",null),u([d()],yo.prototype,"defaultPopupTemplateEnabled",null),u([d()],yo.prototype,"flowItems",void 0),u([d()],yo.prototype,"headingLevel",void 0),u([d({readOnly:!0})],yo.prototype,"isTable",null),u([d()],yo.prototype,"label",null),u([d(),ya("esri/widgets/Feature/t9n/Feature")],yo.prototype,"messages",void 0),u([d(),ya("esri/t9n/common")],yo.prototype,"messagesCommon",void 0),u([d(),ya("esri/widgets/support/t9n/uriUtils")],yo.prototype,"messagesURIUtils",void 0),u([d()],yo.prototype,"spatialReference",null),u([d({readOnly:!0})],yo.prototype,"title",null),u([d()],yo.prototype,"visibleElements",void 0),u([cr("visibleElements")],yo.prototype,"castVisibleElements",null),u([d()],yo.prototype,"map",null),u([d()],yo.prototype,"view",null),u([d({type:zX})],yo.prototype,"viewModel",void 0),yo=eG=u([I("esri.widgets.Feature")],yo);const ije=yo;var j_e;const WL=Symbol("anchorHandles");let q1=class extends vs.EventedAccessor{constructor(e){super(e),this[j_e]=new ei,this.location=null,this.screenLocationEnabled=!1,this.view=null,this[WL].add([_a(()=>so(this.screenLocationEnabled?this.view:null,r=>[r.size,r.type==="3d"?r.camera:r.viewpoint]),()=>this.notifyChange("screenLocation")),ie(()=>this.screenLocation,(r,i)=>{v(r)&&v(i)&&this.emit("view-change")})])}destroy(){this.view=null,this[WL]=ke(this[WL])}get screenLocation(){var s;const{location:e,view:r,screenLocationEnabled:i}=this;return i&&v(e)&&v(r)&&r.ready?(s=r.toScreen)==null?void 0:s.call(r,e):null}};j_e=WL,u([d()],q1.prototype,"location",void 0),u([d()],q1.prototype,"screenLocation",null),u([d()],q1.prototype,"screenLocationEnabled",void 0),u([d()],q1.prototype,"view",void 0),q1=u([I("esri.widgets.support.AnchorElementViewModel")],q1);const H_e=q1,sje="esri.widgets.CompassViewModel";let XL=class extends H_e{constructor(e){super(e),this.visible=!1}};u([d()],XL.prototype,"visible",void 0),XL=u([I(sje)],XL);const q_e=XL,JU="esri-spinner",KU={base:JU,spinnerStart:`${JU}--start`,spinnerFinish:`${JU}--finish`};let W1=class extends Ea{constructor(e,r){super(e,r),this._animationDelay=500,this._animationPromise=null,this.viewModel=new q_e}initialize(){this.addHandles(ie(()=>this.visible,e=>this._visibleChange(e)))}destroy(){this._animationPromise=null}get location(){return this.viewModel.location}set location(e){this.viewModel.location=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}get visible(){return this.viewModel.visible}set visible(e){this.viewModel.visible=e}show(e){const{location:r,promise:i}=e??{};r&&(this.viewModel.location=r),this.visible=!0;const s=()=>this.hide();i&&i.catch(()=>{}).then(s)}hide(){this.visible=!1}render(){const{visible:e}=this,{screenLocation:r}=this.viewModel,i=!!r,s=e&&i,n=!e&&i,o={[KU.spinnerStart]:s,[KU.spinnerFinish]:n},a=this._getPositionStyles();return re("div",{class:this.classes(KU.base,o),styles:a})}_visibleChange(e){if(e)return void(this.viewModel.screenLocationEnabled=!0);const r=nw(this._animationDelay);this._animationPromise=r,r.catch(()=>{}).then(()=>{this._animationPromise===r&&(this.viewModel.screenLocationEnabled=!1,this._animationPromise=null)})}_getPositionStyles(){const{screenLocation:e,view:r}=this.viewModel;if(C(r)||C(e))return{};const{padding:i}=r;return{left:e.x-i.left+"px",top:e.y-i.top+"px"}}};u([d()],W1.prototype,"location",null),u([d()],W1.prototype,"view",null),u([d({type:q_e})],W1.prototype,"viewModel",void 0),u([d()],W1.prototype,"visible",null),W1=u([I("esri.widgets.Spinner")],W1);const nje=W1,d5={iconZoom:"esri-icon-zoom-in-magnifying-glass",iconTrash:"esri-icon-trash",iconBrowseClusteredFeatures:"esri-icon-table"},kb=new bE({id:"zoom-to-feature",title:"{messages.zoom}",className:d5.iconZoom}),ure=new bE({id:"remove-selected-feature",title:"{messages.remove}",className:d5.iconTrash}),T2=new bE({id:"zoom-to-clustered-features",title:"{messages.zoom}",className:d5.iconZoom}),S2=new bE({id:"browse-clustered-features",title:"{messages.browseClusteredFeatures}",className:d5.iconBrowseClusteredFeatures}),oje="esri.widgets.Popup.PopupViewModel",qN=se.getLogger(oje),aje=t=>{const{event:e,view:r}=t,{action:i}=e,s=r&&r.popup;if(!i)return Promise.reject(new q("trigger-action:missing-arguments","Event has no action"));if(!s)return Promise.reject(new q("trigger-action:missing-arguments","view.popup is missing"));const{disabled:n,id:o}=i;if(!o)return Promise.reject(new q("trigger-action:invalid-action","action.id is missing"));if(n)return Promise.reject(new q("trigger-action:invalid-action","Action is disabled"));if(o===kb.id)return cje(s.viewModel).catch(Vk);if(o===T2.id)return uje(s.viewModel);if(o===S2.id)return s.featureMenuOpen=!s.featureMenuOpen,s.viewModel.browseClusterEnabled=!s.viewModel.browseClusterEnabled,Promise.resolve();if(s.viewModel.browseClusterEnabled=!1,o===ure.id){s.close();const{selectedFeature:a}=s;if(!a)return Promise.reject(new q(`trigger-action:${ure.id}`,"selectedFeature is required",{selectedFeature:a}));const{sourceLayer:l}=a;return l?l.remove(a):r.graphics.remove(a),Promise.resolve()}return Promise.resolve()};function W_e(t){const{selectedFeature:e,location:r,view:i}=t;return i?i.type==="3d"?e??r??null:t.get("selectedFeature.geometry")||r:null}function wb(t){var e,r;return!!t&&t.isAggregate&&((r=(e=t.sourceLayer)==null?void 0:e.featureReduction)==null?void 0:r.type)==="cluster"}async function lje(t,e){if((e==null?void 0:e.type)!=="3d"||!t||t.declaredClass!=="esri.Graphic")return!0;const r=e.getViewForGraphic(t);if(r&&"whenGraphicBounds"in r){let i;try{i=await r.whenGraphicBounds(t,{useViewElevation:!0})}catch{}return!i||!i.boundingBox||i.boundingBox[0]===i.boundingBox[3]&&i.boundingBox[1]===i.boundingBox[4]&&i.boundingBox[2]===i.boundingBox[5]}return!0}async function cje(t){var h;const{location:e,selectedFeature:r,view:i,zoomFactor:s}=t,n=W_e(t);if(!i||!n){const p=new q("zoom-to:invalid-target-or-view","Cannot zoom to location without a target and view.",{target:n,view:i});throw qN.error(p),p}const o=i.scale/s,a=(h=t.selectedFeature)==null?void 0:h.geometry,l=a??e,c=v(l)&&l.type==="point"&&await lje(r,i);kb.active=!0,kb.disabled=!0;try{await t.zoomTo({target:{target:n,scale:c?o:void 0}})}catch{const f=new q("zoom-to:invalid-graphic","Could not zoom to the location of the graphic.",{graphic:r});qN.error(f)}finally{kb.active=!1,kb.disabled=!1,t.zoomToLocation=null,c&&(t.location=l)}}async function uje(t){const{selectedFeature:e,view:r}=t;if((r==null?void 0:r.type)!=="2d"){const o=new q("zoomToCluster:invalid-view","View must be 2d MapView.",{view:r});throw qN.error(o),o}if(!e||!wb(e)){const o=new q("zoomToCluster:invalid-selectedFeature","Selected feature must represent an aggregate/cluster graphic.",{selectedFeature:e});throw qN.error(o),o}const[i,s]=await GX(r,e);T2.active=!0,T2.disabled=!0;const{extent:n}=await i.queryExtent(s);await t.zoomTo({target:n}),T2.active=!1,T2.disabled=!1}async function hje(t){const{view:e,selectedFeature:r}=t;if(!e||!r)return;const[i,s]=await GX(e,r),{extent:n}=await i.queryExtent(s);t.selectedClusterBoundaryFeature.geometry=n,e.graphics.add(t.selectedClusterBoundaryFeature)}async function dje(t){var o;const{selectedFeature:e,view:r}=t;if(!r||!e)return;const[i,s]=await GX(r,e);S2.active=!0,S2.disabled=!0;const{features:n}=await i.queryFeatures(s);S2.active=!1,S2.disabled=!1,(o=r.popup)==null||o.open({features:[e].concat(n),featureMenuOpen:!0})}async function GX(t,e){const r=await t.whenLayerView(e.sourceLayer),i=r.createQuery(),s=e.getObjectId();return i.aggregateIds=s!=null?[s]:[],[r,i]}function pje(t){const e=t.features.filter(r=>wb(r));e.length&&(t.features=e)}function X_e(t){var e;if(C(t))return null;switch(t.type){case"point":return t;case"extent":return t.center;case"polygon":return t.centroid;case"multipoint":case"polyline":return(e=t.extent)==null?void 0:e.center;default:return null}}const Nt="esri-popup",_C=`${Nt}__header`,Pv=`${Nt}--is-docked`,Ae={calciteThemeLight:"calcite-mode-light",calciteThemeDark:"calcite-mode-dark",iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconRightTriangleArrow:"esri-icon-right-triangle-arrow",iconDockToTop:"esri-icon-maximize",iconDockToBottom:"esri-icon-dock-bottom",iconDockToLeft:"esri-icon-dock-left",iconDockToRight:"esri-icon-dock-right",iconClose:"esri-icon-close",iconUndock:"esri-icon-minimize",iconCheckMark:"esri-icon-check-mark",iconLoading:"esri-icon-loading-indicator",iconDefaultAction:"esri-icon-default-action",iconActionsMenu:"esri-icon-handle-horizontal",rotating:"esri-rotating",base:Nt,widget:"esri-widget",main:`${Nt}__main-container`,loadingContainer:`${Nt}__loading-container`,isCollapsible:`${Nt}--is-collapsible`,isCollapsed:`${Nt}--is-collapsed`,shadow:`${Nt}--shadow`,isDocked:Pv,isDockedTopLeft:`${Pv}-top-left`,isDockedTopCenter:`${Pv}-top-center`,isDockedTopRight:`${Pv}-top-right`,isDockedBottomLeft:`${Pv}-bottom-left`,isDockedBottomCenter:`${Pv}-bottom-center`,isDockedBottomRight:`${Pv}-bottom-right`,alignTopCenter:`${Nt}--aligned-top-center`,alignBottomCenter:`${Nt}--aligned-bottom-center`,alignTopLeft:`${Nt}--aligned-top-left`,alignBottomLeft:`${Nt}--aligned-bottom-left`,alignTopRight:`${Nt}--aligned-top-right`,alignBottomRight:`${Nt}--aligned-bottom-right`,isFeatureMenuOpen:`${Nt}--feature-menu-open`,isActionsMenuOpen:`${Nt}--actions-menu-open`,hasFeatureUpdated:`${Nt}--feature-updated`,header:_C,headerButtons:`${_C}-buttons`,headerContainer:`${_C}-container`,headerContainerButton:`${_C}-container--button`,headerTitle:`${_C}-title`,content:`${Nt}__content`,contentHasFlows:"esri-content--has-flows",contentFlowItem:"esri-content__flow-item",footer:`${Nt}__footer`,footerHasPagination:`${Nt}__footer--has-pagination`,footerHasActions:`${Nt}__footer--has-actions`,footerHasActionsMenu:`${Nt}__footer--has-actions-menu`,button:`${Nt}__button`,buttonDisabled:`${Nt}__button--disabled`,buttonDock:`${Nt}__button--dock`,icon:`${Nt}__icon`,iconDock:`${Nt}__icon--dock-icon`,inlineActionsContainer:`${Nt}__inline-actions-container`,actionsMenuButton:`${Nt}__actions-menu-button`,actions:`${Nt}__actions`,action:`${Nt}__action`,actionImage:`${Nt}__action-image`,actionText:`${Nt}__action-text`,actionToggle:`${Nt}__action-toggle`,actionToggleOn:`${Nt}__action-toggle--on`,actionExit:`${Nt}__action--exit`,actionSelectFeature:`${Nt}__action--select-feature`,pointer:`${Nt}__pointer`,pointerDirection:`${Nt}__pointer-direction`,navigation:`${Nt}__navigation`,paginationPrevious:`${Nt}__pagination-previous`,paginationNext:`${Nt}__pagination-next`,paginationPreviousIconLTR:`${Nt}__pagination-previous-icon`,paginationPreviousIconRTL:`${Nt}__pagination-previous-icon--rtl`,paginationNextIconLTR:`${Nt}__pagination-next-icon`,paginationNextIconRTL:`${Nt}__pagination-next-icon--rtl`,featureMenu:`${Nt}__feature-menu`,featureMenuList:`${Nt}__feature-menu-list`,featureMenuItem:`${Nt}__feature-menu-item`,featureMenuViewport:`${Nt}__feature-menu-viewport`,featureMenuHeader:`${Nt}__feature-menu-header`,featureMenuNote:`${Nt}__feature-menu-note`,featureMenuSelected:`${Nt}__feature-menu-item--selected`,featureMenuButton:`${Nt}__feature-menu-button`,featureMenuTitle:`${Nt}__feature-menu-title`,featureMenuObserver:`${Nt}__feature-menu-observer`,featureMenuLoader:`${Nt}__feature-menu-loader`,collapseButton:`${Nt}__collapse-button`,collapseIcon:`${Nt}__collapse-icon`};var Ew;(function(t){t[t.size=22]="size",t[t.lineWidth=50]="lineWidth",t[t.maxSize=120]="maxSize",t[t.maxOutlineSize=80]="maxOutlineSize",t[t.tallSymbolWidth=20]="tallSymbolWidth"})(Ew||(Ew={}));function Y_e(){const t=new Float32Array(6);return t[0]=1,t[3]=1,t}function fje(t){const e=new Float32Array(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e}function mje(t,e,r,i,s,n){const o=new Float32Array(6);return o[0]=t,o[1]=e,o[2]=r,o[3]=i,o[4]=s,o[5]=n,o}function gje(t,e){return new Float32Array(t,e,6)}function Z_e(t,e,r,i){const s=e[i],n=e[i+1];t[i]=r[0]*s+r[2]*n+r[4],t[i+1]=r[1]*s+r[3]*n+r[5]}function yje(t,e,r,i=0,s=0,n=2){const o=s||e.length/n;for(let a=i;a<o;a++)Z_e(t,e,r,a*n)}Object.freeze(Object.defineProperty({__proto__:null,clone:fje,create:Y_e,createView:gje,fromValues:mje,transform:Z_e,transformMany:yje},Symbol.toStringTag,{value:"Module"}));function _je(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t}function vje(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t}function bje(t,e,r,i,s,n,o){return t[0]=e,t[1]=r,t[2]=i,t[3]=s,t[4]=n,t[5]=o,t}function J_e(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=e[4],a=e[5];let l=r*n-i*s;return l?(l=1/l,t[0]=n*l,t[1]=-i*l,t[2]=-s*l,t[3]=r*l,t[4]=(s*a-n*o)*l,t[5]=(i*o-r*a)*l,t):null}function wje(t){return t[0]*t[3]-t[1]*t[2]}function K_e(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=r[0],h=r[1],p=r[2],f=r[3],m=r[4],y=r[5];return t[0]=i*c+n*h,t[1]=s*c+o*h,t[2]=i*p+n*f,t[3]=s*p+o*f,t[4]=i*m+n*y+a,t[5]=s*m+o*y+l,t}function jX(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=Math.sin(r),h=Math.cos(r);return t[0]=i*h+n*c,t[1]=s*h+o*c,t[2]=i*-c+n*h,t[3]=s*-c+o*h,t[4]=a,t[5]=l,t}function Q_e(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=r[0],h=r[1];return t[0]=i*c,t[1]=s*c,t[2]=n*h,t[3]=o*h,t[4]=a,t[5]=l,t}function HX(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=r[0],h=r[1];return t[0]=i,t[1]=s,t[2]=n,t[3]=o,t[4]=i*c+n*h+a,t[5]=s*c+o*h+l,t}function xje(t,e){const r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=r,t[2]=-r,t[3]=i,t[4]=0,t[5]=0,t}function Tje(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t[4]=0,t[5]=0,t}function qX(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=e[0],t[5]=e[1],t}function Sje(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"}function Eje(t){return Math.sqrt(t[0]**2+t[1]**2+t[2]**2+t[3]**2+t[4]**2+t[5]**2+1)}function Cje(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t}function eve(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t[4]=e[4]-r[4],t[5]=e[5]-r[5],t}function Aje(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t}function Rje(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t[4]=e[4]+r[4]*i,t[5]=e[5]+r[5]*i,t}function Oje(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]}function Mje(t,e){const r=t[0],i=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=e[0],c=e[1],h=e[2],p=e[3],f=e[4],m=e[5],y=Sa();return Math.abs(r-l)<=y*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(i-c)<=y*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(s-h)<=y*Math.max(1,Math.abs(s),Math.abs(h))&&Math.abs(n-p)<=y*Math.max(1,Math.abs(n),Math.abs(p))&&Math.abs(o-f)<=y*Math.max(1,Math.abs(o),Math.abs(f))&&Math.abs(a-m)<=y*Math.max(1,Math.abs(a),Math.abs(m))}const Pje=K_e,Ije=eve;Object.freeze(Object.defineProperty({__proto__:null,add:Cje,copy:_je,determinant:wje,equals:Mje,exactEquals:Oje,frob:Eje,fromRotation:xje,fromScaling:Tje,fromTranslation:qX,identity:vje,invert:J_e,mul:Pje,multiply:K_e,multiplyScalar:Aje,multiplyScalarAndAdd:Rje,rotate:jX,scale:Q_e,set:bje,str:Sje,sub:Ije,subtract:eve,translate:HX},Symbol.toStringTag,{value:"Module"}));const hre=de("android");de("chrome")||hre&&hre>=4;cz();function JSt(t){return t=t||globalThis.location.hostname,Lje.some(e=>(t==null?void 0:t.match(e))!=null)}function $je(t,e){return t&&(e=e||globalThis.location.hostname)?e.match(tve)!=null||e.match(ive)!=null?t.replace("static.arcgis.com","staticdev.arcgis.com"):e.match(rve)!=null||e.match(sve)!=null?t.replace("static.arcgis.com","staticqa.arcgis.com"):t:t}const tve=/^devext.arcgis.com$/,rve=/^qaext.arcgis.com$/,ive=/^[\w-]*\.mapsdevext.arcgis.com$/,sve=/^[\w-]*\.mapsqa.arcgis.com$/,Lje=[/^([\w-]*\.)?[\w-]*\.zrh-dev-local.esri.com$/,tve,rve,/^jsapps.esri.com$/,ive,sve];Ew.size;Ew.maxSize;Ew.maxOutlineSize;Ew.lineWidth;Ew.tallSymbolWidth;function nve(t){return t&&"opacity"in t?t.opacity*nve(t.parent):1}async function Dje(t,e){if(!t)return;const r=t.sourceLayer,i=(v(e)&&e.useSourceLayer?r:t.layer)??r,s=nve(i);if(v(t.symbol)&&(!v(e)||e.ignoreGraphicSymbol!==!0)){const b=t.symbol.type==="web-style"?await VUe(t.symbol,{...e,cache:v(e)?e.webStyleCache:null}):t.symbol.clone();return pU(b,null,s),b}const n=(v(e)?e.renderer:null)??(i&&"renderer"in i?i.renderer:null);let o=n&&"getSymbolAsync"in n?await n.getSymbolAsync(t,e):null;if(!o)return;if(o=o.type==="web-style"?await o.fetchSymbol({...e,cache:v(e)?e.webStyleCache:null}):o.clone(),!(n&&"visualVariables"in n&&n.visualVariables&&n.visualVariables.length))return pU(o,null,s),o;if("arcadeRequiredForVisualVariables"in n&&n.arcadeRequiredForVisualVariables&&(C(e)||C(e.arcade))){const b={...e};b.arcade=await sm(),e=b}const a=await te(()=>Promise.resolve().then(()=>bX),void 0),l=[],c=[],h=[],p=[];for(const b of n.visualVariables)switch(b.type){case"color":l.push(b);break;case"opacity":c.push(b);break;case"rotation":p.push(b);break;case"size":b.target||h.push(b)}const f=!!l.length&&l[l.length-1],m=f?a.getColor(f,t,e):null,y=!!c.length&&c[c.length-1];let _=y?a.getOpacity(y,t,e):null;if(s!=null&&(_=_!=null?_*s:s),pU(o,m,_),h.length){const b=a.getAllSizes(h,t,e);await UUe(o,b)}for(const b of p)kUe(o,a.getRotationAngle(b,t,e),b.axis);return o}let ty=class{constructor(e,r){this._owner=r,this._properties={},this._afterDispatchHandle=null;for(const i in e){const s=e[i],n=new cue(s,void 0,void 0,2,2);this._properties[i]={pool:n,acquired:[]}}this._afterDispatchHandle=xue(()=>this._release())}destroy(){this._afterDispatchHandle&&(this._afterDispatchHandle.remove(),this._afterDispatchHandle=null);for(const e in this._properties){const r=this._properties[e];for(const i of r.acquired)WJ(i)||r.pool.release(i);r.pool.destroy(),r.pool=null,r.acquired=null}this._properties=null,this._owner=null}get(e){const r=this._owner._get(e),i=this._properties[e];let s=i.pool.acquire();for(i.acquired.push(s);s===r;)i.acquired.push(s),s=i.pool.acquire();return s}_release(){for(const e in this._properties){const r=this._properties[e];let i=0;for(const s of r.acquired)WJ(s)?r.acquired[i++]=s:r.pool.release(s);r.acquired.length=i}}};const Nje=de("mac")?"Meta":"Ctrl",p5={8:"Backspace",9:"Tab",13:"Enter",27:"Escape",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete"};for(let t=48;t<58;t++)p5[t]=String.fromCharCode(t);for(let t=1;t<25;t++)p5[111+t]=`F${t}`;for(let t=65;t<91;t++)p5[t]=[String.fromCharCode(t+32),String.fromCharCode(t)];function Fje(t){if(t.key!==void 0)return fb(t);const e=p5[t.keyCode];return Array.isArray(e)?t.shiftKey?e[1]:e[0]:e}function Uje(t){switch(t){case"Ctrl":case"Alt":case"Shift":case"Meta":case"Primary":return!0}return!1}let kje=class{constructor(e,r=[]){this.eventType=e,this.keyModifiers=r}matches(e){if(e.type!==this.eventType)return!1;if(this.keyModifiers.length===0)return!0;const r=e.modifiers;for(const i of this.keyModifiers)if(!r.has(i))return!1;return!0}};const dre=se.getLogger("esri.views.input.InputHandler");let $o=class{constructor(e){this._manager=null,this._incoming={},this._outgoing={},this._incomingEventMatches=null,this._incomingEventTypes=null,this._outgoingEventTypes=null,this._hasSideEffects=e}get incomingEventMatches(){if(!this._incomingEventMatches){this._incomingEventMatches=[];for(const e in this._incoming){const r=this._incoming[e];for(const i of r)this._incomingEventMatches.push(i.match)}}return this._incomingEventMatches}get incomingEventTypes(){return this._incomingEventTypes||(this._incomingEventTypes=this.incomingEventMatches.map(e=>e.eventType)),this._incomingEventTypes}get outgoingEventTypes(){return this._outgoingEventTypes||(this._outgoingEventTypes=Object.keys(this._outgoing)),this._outgoingEventTypes}get hasSideEffects(){return this._hasSideEffects}get hasPendingInputs(){return!1}onInstall(e){this._manager?dre.error("This InputHandler has already been registered with an InputManager"):(e.setEventCallback(r=>this._handleEvent(r)),e.setUninstallCallback(()=>this._onUninstall()),this._manager=e)}onUninstall(){}registerIncoming(e,r,i){let s;typeof r=="function"?(i=r,s=[]):s=r||[];const n=typeof e=="string"?new kje(e,s):e,o=()=>{this._incomingEventTypes=null,this._incomingEventMatches=null},a=h=>{const p=this._incoming[h.match.eventType];if(p){const f=p.indexOf(h);p.splice(f,1),o(),this._manager&&this._manager.updateDependencies()}},l=new Vje(n,i,{onPause:a,onRemove:a,onResume:h=>{const p=this._incoming[h.match.eventType];p&&!p.includes(h)&&(p.push(h),o(),this._manager&&this._manager.updateDependencies())}});let c=this._incoming[n.eventType];return c||(c=[],this._incoming[n.eventType]=c),c.push(l),o(),this._manager&&this._manager.updateDependencies(),l}registerOutgoing(e){if(this._outgoing[e])throw new Error("There is already a callback registered for this outgoing InputEvent: "+e);const r=new Bje(e,{onEmit:(i,s,n,o)=>{var a;(a=this._manager)==null||a.emit(i.eventType,s,n,o)},onRemove:i=>{var s;delete this._outgoing[i.eventType],(s=this._manager)==null||s.updateDependencies()}});return this._outgoing[e]=r,this._outgoingEventTypes=null,this._manager&&this._manager.updateDependencies(),r}startCapturingPointer(e){var r;(r=this._manager)==null||r.setPointerCapture(e,!0)}stopCapturingPointer(e){var r;(r=this._manager)==null||r.setPointerCapture(e,!1)}refreshHasPendingInputs(){var e;(e=this._manager)==null||e.refreshHasPendingInputs()}_onUninstall(){this._manager?(this.onUninstall(),this._manager=null):dre.error("This InputHandler is not registered with an InputManager")}_handleEvent(e){var i;const r=this._incoming[e.type];if(r){for(const s of r)if(s.match.matches(e)&&((i=s.callback)==null||i.call(s,e),e.shouldStopPropagation()))break}}},Vje=class{constructor(e,r,i){this.match=e,this._callback=r,this._handler=i}pause(){this._handler.onPause(this)}resume(){this._handler.onResume(this)}remove(){this._handler.onRemove(this)}get callback(){return this._callback}},Bje=class{constructor(e,r){this.eventType=e,this._removed=!1,this._handler=r}emit(e,r,i){this._removed||this._handler.onEmit(this,e,r,i)}remove(){this._removed=!0,this._handler.onRemove(this)}},zje=class extends $o{constructor(e){super(!0),this._onChange=e,this._value="mouse",this._x=null,this._y=null,this.registerIncoming("pointer-move",r=>{this._update(r.data)})}_update(e){const r=e.native.pointerType==="touch"?"touch":"mouse",{x:i,y:s}=e;r===this._value&&this._x===i&&this._y===s||(this._value=r,this._x=i,this._y=s,this._onChange(r,i,s))}},WN=class{constructor(e){this._observable=new iq,this._value=e}get(){return br(this._observable),this._value}set(e){e!==this._value&&(this._value=e,this._observable.notify())}},Gje=class extends $o{get multiTouchActive(){return this._multiTouchActive.get()}constructor(){super(!0),this._activeTouchPointerIds=new Set,this._multiTouchActive=new WN(!1),this._onPointerAdd=({data:e})=>{e.pointerType==="touch"&&(this._activeTouchPointerIds.add(e.native.pointerId),this._update())},this._onPointerRemove=({data:e})=>{e.pointerType==="touch"&&(this._activeTouchPointerIds.delete(e.native.pointerId),this._update())},this.registerIncoming("pointer-down",this._onPointerAdd),this.registerIncoming("pointer-up",this._onPointerRemove),this.registerIncoming("pointer-capture-lost",this._onPointerRemove),this.registerIncoming("pointer-cancel",this._onPointerRemove)}_update(){this._multiTouchActive.set(this._activeTouchPointerIds.size>1)}},lf=class extends Te{constructor(e){super(e),this._pointerCaptures=new Map,this._nameToGroup={},this._handlers=[],this._handlersPriority=[],this._currentPropagation=null,this._updateDependenciesAfterPropagation=!1,this._sourceEvents=new Set,this._keyModifiers=new Set,this._activeKeyModifiers=new Set,this._stoppedPropagationEventIds=new Set,this.primaryKey=Nje,this._latestPointerType="mouse",this._propertiesPool=new ty({latestPointerLocation:qje},this),this.latestPointerLocation=null,this.test={timestamp:void 0,hasCurrentPropagation:()=>!!this._currentPropagation}}initialize(){this.eventSource.onEventReceived=this._onEventReceived.bind(this),this._installRecognizers()}destroy(){const e=Object.keys(this._nameToGroup);for(const r of e)this.uninstallHandlers(r);this.eventSource.destroy(),this._currentPropagation=null,this._propertiesPool.destroy()}get hasPendingInputs(){return this._handlers.some(e=>e.handler.hasPendingInputs)}get latestPointerType(){return this._latestPointerType}get multiTouchActive(){return this._multiTouchHandler.multiTouchActive}installHandlers(e,r,i=F_.INTERNAL){if(this._nameToGroup[e])return void se.getLogger(this.declaredClass).error("There is already an InputHandler group registered under the name `"+e+"`");if(r.length===0)return void se.getLogger(this.declaredClass).error("Can't register a group of zero handlers");const s={name:e,handlers:r.map(n=>({handler:n,active:!0,removed:!1,priorityIndex:0,groupPriority:i,eventCallback:null,uninstallCallback:null}))};this._nameToGroup[e]=s;for(let n=s.handlers.length-1;n>=0;n--){const o=s.handlers[n];this._handlers.push(o),o.handler.onInstall({updateDependencies:()=>{this.updateDependencies()},emit:(a,l,c,h,p)=>{this._emitInputEvent(o.priorityIndex+1,a,l,c,p,h)},setPointerCapture:(a,l)=>{this._setPointerCapture(s,o,a,l)},setEventCallback:a=>{o.eventCallback=a},setUninstallCallback:a=>{o.uninstallCallback=a},refreshHasPendingInputs:()=>{this.notifyChange("hasPendingInputs")}})}this.updateDependencies()}uninstallHandlers(e){const r=this._nameToGroup[e];r?(r.handlers.forEach(i=>{var s;i.removed=!0,(s=i.uninstallCallback)==null||s.call(i)}),delete this._nameToGroup[e],this._currentPropagation?this._currentPropagation.needsHandlerGarbageCollect=!0:this._garbageCollectRemovedHandlers()):se.getLogger(this.declaredClass).error("There is no InputHandler group registered under the name `"+e+"`")}hasHandlers(e){return this._nameToGroup[e]!==void 0}updateDependencies(){if(this._currentPropagation)return void(this._updateDependenciesAfterPropagation=!0);this._updateDependenciesAfterPropagation=!1;const e=new Set,r=new Set;this._handlersPriority=[];for(let i=this._handlers.length-1;i>=0;i--){const s=this._handlers[i];s.priorityIndex=i,this._handlersPriority.push(s)}this._handlersPriority=this._sortHandlersPriority(this._handlersPriority);for(let i=this._handlersPriority.length-1;i>=0;i--){const s=this._handlersPriority[i];s.priorityIndex=i;let n=s.handler.hasSideEffects;if(!n){for(const o of s.handler.outgoingEventTypes)if(e.has(o)){n=!0;break}}if(n)for(const o of s.handler.incomingEventMatches){e.add(o.eventType);for(const a of o.keyModifiers)Uje(a)||r.add(a)}s.active=n}this._sourceEvents=e,this._keyModifiers=r,this._pointerCaptures.size>0&&this._sourceEvents.add("pointer-capture-lost"),this._keyModifiers.size>0&&(this._sourceEvents.add("key-down"),this._sourceEvents.add("key-up")),this.eventSource&&(this.eventSource.activeEvents=this._sourceEvents)}_setLatestPointer(e,r,i){this._latestPointerType=e;const s=this._get("latestPointerLocation");if(C(s)||s.x!==r||s.y!==i){const n=this._propertiesPool.get("latestPointerLocation");n.x=r,n.y=i,this._set("latestPointerLocation",n)}}_onEventReceived(e,r){if(e==="pointer-capture-lost"){const n=r;this._pointerCaptures.delete(n.native.pointerId)}this._updateKeyModifiers(e,r);const i=this.test.timestamp!=null?this.test.timestamp:r.native?r.native.timestamp:void 0,s=r.native?r.native.cancelable:void 0;this._emitInputEventFromSource(e,r,i,s)}_updateKeyModifiers(e,r){if(!r)return;let i=!1;const s=()=>{if(!i){const a=new Set;this._activeKeyModifiers.forEach(l=>{a.add(l)}),this._activeKeyModifiers=a,i=!0}},n=(a,l)=>{l&&!this._activeKeyModifiers.has(a)?(s(),this._activeKeyModifiers.add(a)):!l&&this._activeKeyModifiers.has(a)&&(s(),this._activeKeyModifiers.delete(a))};if(e==="key-down"||e==="key-up"){const a=r.key;this._keyModifiers.has(a)&&n(a,e==="key-down")}const o=r.native;n("Alt",!(!o||!o.altKey)),n("Ctrl",!(!o||!o.ctrlKey)),n("Shift",!(!o||!o.shiftKey)),n("Meta",!(!o||!o.metaKey)),n("Primary",this._activeKeyModifiers.has(this.primaryKey))}_installRecognizers(){this._latestPointerHandler=new zje((e,r,i)=>this._setLatestPointer(e,r,i)),this._multiTouchHandler=new Gje,this.installHandlers("input-manager-logic",[this._latestPointerHandler,this._multiTouchHandler],F_.ALWAYS),this.recognizers.length>0&&this.installHandlers("default",this.recognizers,F_.INTERNAL)}_setPointerCapture(e,r,i,s){const n=e.name+"-"+r.priorityIndex,o=this._pointerCaptures.get(i.pointerId)||new Set;this._pointerCaptures.set(i.pointerId,o),s?(o.add(n),o.size===1&&this.eventSource&&this.eventSource.setPointerCapture(i,!0)):o.has(n)&&(o.delete(n),o.size===0&&(this._pointerCaptures.delete(i.pointerId),this.eventSource&&this.eventSource.setPointerCapture(i,!1)))}_garbageCollectRemovedHandlers(){this._handlers=this._handlers.filter(e=>!e.removed),this.updateDependencies()}_emitInputEventFromSource(e,r,i,s){this._emitInputEvent(0,e,r,i,s)}_emitInputEvent(e,r,i,s,n,o){const a=s!==void 0?s:this._currentPropagation?this._currentPropagation.timestamp:performance.now(),l=n!==void 0&&n,c={event:new jje(r,i,a,o||this._activeKeyModifiers,l),priorityIndex:e};this._currentPropagation?this._currentPropagation.events.push(c):this._doNewPropagation(c)}_doNewPropagation(e){this._currentPropagation={events:new FB,currentHandler:null,needsHandlerGarbageCollect:!1,timestamp:e.event.timestamp},this._currentPropagation.events.push(e),this._continuePropagation()}_continuePropagation(){var r,i;const e=Dl(this._currentPropagation);for(;e.events.length>0;){const{event:s,priorityIndex:n}=e.events.pop(),o=s.data&&s.data.eventId;if(!(o!=null&&this._stoppedPropagationEventIds.has(o)))for(e.currentHandler=this._handlersPriority[n];e.currentHandler;){if(e.currentHandler.removed)e.needsHandlerGarbageCollect=!0;else{if(e.currentHandler.active&&!s.shouldStopPropagation()&&((i=(r=e.currentHandler).eventCallback)==null||i.call(r,s)),s.shouldStopPropagation()){o!=null&&this._stoppedPropagationEventIds.add(o);break}if(s.shouldPausePropagation(()=>this._continuePropagation()))return void this._pausePropagation({event:s,priorityIndex:e.currentHandler.priorityIndex+1})}e.currentHandler=this._handlersPriority[e.currentHandler.priorityIndex+1]}}e.needsHandlerGarbageCollect&&this._garbageCollectRemovedHandlers(),this.hasPendingInputs||this._stoppedPropagationEventIds.clear(),this._currentPropagation=null,this._updateDependenciesAfterPropagation&&this.updateDependencies()}_pausePropagation(e){const r=new FB;r.push(e);const i=this._currentPropagation;if(i){for(;i.events.length;)r.push(i.events.pop());i.events=r,i.currentHandler=null}}_compareHandlerPriority(e,r){if(e.handler.hasSideEffects!==r.handler.hasSideEffects)return e.handler.hasSideEffects?1:-1;if(e.groupPriority!==r.groupPriority)return e.groupPriority>r.groupPriority?-1:1;for(const i of e.handler.incomingEventMatches)for(const s of r.handler.incomingEventMatches){if(i.eventType!==s.eventType)continue;const n=i.keyModifiers.filter(o=>s.keyModifiers.includes(o));if(n.length===i.keyModifiers.length!=(n.length===s.keyModifiers.length))return i.keyModifiers.length>s.keyModifiers.length?-1:1}return e.priorityIndex>r.priorityIndex?-1:1}_sortHandlersPriority(e){const r=[];for(const i of e){let s=0;for(;s<r.length&&this._compareHandlerPriority(i,r[s])>=0;)s++;r.splice(s,0,i)}return r}get debug(){const e=r=>{const i=this._setPointerCapture;this._setPointerCapture=()=>{},r(),this._setPointerCapture=i};return{injectEvent:(r,i)=>{e(()=>{this._onEventReceived(r,i)})},disablePointerCapture:e}}};u([d({readOnly:!0})],lf.prototype,"hasPendingInputs",null),u([d({constructOnly:!0})],lf.prototype,"eventSource",void 0),u([d({constructOnly:!0})],lf.prototype,"recognizers",void 0),u([d()],lf.prototype,"_latestPointerType",void 0),u([d()],lf.prototype,"latestPointerType",null),u([d()],lf.prototype,"multiTouchActive",null),u([d({readOnly:!0})],lf.prototype,"latestPointerLocation",void 0),lf=u([I("esri.views.input.InputManager")],lf);let jje=class{constructor(e,r,i,s,n){this.type=e,this.data=r,this.timestamp=i,this.modifiers=s,this.cancelable=n,this._propagationState=e_.NONE,this._resumeCallback=null}stopPropagation(){this._propagationState|=e_.STOPPED}shouldStopPropagation(){return(this._propagationState&e_.STOPPED)!=0}async(e){this._propagationState|=e_.PAUSED;const r=(i,s)=>{this._propagationState&=~e_.PAUSED;const n=this._resumeCallback;if(this._resumeCallback=null,n&&n(),s)throw i;return i};return(typeof e=="function"?e():e).then(i=>r(i,!1),i=>r(i,!0))}shouldPausePropagation(e){return!!(this._propagationState&e_.PAUSED)&&(this._resumeCallback=e,!0)}preventDefault(){this.data.native.preventDefault()}};var e_;(function(t){t[t.NONE=0]="NONE",t[t.STOPPED=1]="STOPPED",t[t.PAUSED=2]="PAUSED"})(e_||(e_={}));const F_={ALWAYS:1,DEFAULT:0,TOOL:-1,WIDGET:-2,INTERNAL:-3};let Hje=class{};const qje=Hje;function pre(t){return t&&typeof t.highlight=="function"}function Wje(t){return t&&typeof t.maskOccludee=="function"}function cEt(t,e,r){return C(t)||t>r&&(e===0||t<e)}function uEt(t,e){return v(t)&&t>0||v(e)&&e>0}function hEt(t){const e=t.effectiveScaleRange;return{minScale:(e==null?void 0:e.minScale)??0,maxScale:(e==null?void 0:e.maxScale)??0}}const WX=t=>{let e=class extends t{constructor(...r){super(...r),this.goToOverride=null,this.view=null}callGoTo(r){const{view:i}=this;return e4(i),this.goToOverride?this.goToOverride(i,r):i.goTo(r.target,r.options)}};return u([d()],e.prototype,"goToOverride",void 0),u([d()],e.prototype,"view",void 0),e=u([I("esri.widgets.support.GoTo")],e),e},oR=Pt.ofType({key:"type",defaultKeyValue:"button",base:v4,typeMap:{button:bE,toggle:Kde}}),Xje=()=>[kb.clone()],Yje=()=>[T2.clone(),S2.clone()];let Br=class extends WX(H_e){get isLoadingFeature(){return this.featureViewModels.some(e=>e.waitingForContent)}constructor(e){super(e),this._handles=new ei,this._pendingPromises=new Set,this._fetchFeaturesController=null,this._highlightSelectedFeaturePromise=null,this._highlightActiveFeaturePromise=null,this._selectedClusterFeature=null,this.featurePage=null,this.actions=new oR,this.activeFeature=null,this.defaultPopupTemplateEnabled=!1,this.autoCloseEnabled=!1,this.autoOpenEnabled=!0,this.browseClusterEnabled=!1,this.content=null,this.featuresPerPage=20,this.featureViewModelAbilities=null,this.featureViewModels=[],this.highlightEnabled=!0,this.includeDefaultActions=!0,this.selectedClusterBoundaryFeature=new Io({symbol:new gv({outline:{width:1.5,color:"cyan"},style:"none"})}),this.title=null,this.updateLocationEnabled=!1,this.view=null,this.visible=!1,this.zoomFactor=4,this.zoomToLocation=null}initialize(){this._handles.add([ie(()=>[this.autoOpenEnabled,this.view],()=>this._autoOpenEnabledChange()),this.on("view-change",()=>this._autoClose()),ie(()=>[this.highlightEnabled,this.selectedFeature,this.visible,this.view],()=>this._highlightSelectedFeature()),ie(()=>[this.highlightEnabled,this.activeFeature,this.visible,this.view],()=>this._highlightActiveFeature()),ie(()=>{var e,r;return(r=(e=this.view)==null?void 0:e.animation)==null?void 0:r.state},e=>this._animationStateChange(e)),ie(()=>this.location,e=>this._locationChange(e)),ie(()=>this.selectedFeature,e=>this._selectedFeatureChange(e)),ie(()=>[this.selectedFeatureIndex,this.featureCount,this.featuresPerPage],()=>this._selectedFeatureIndexChange()),ie(()=>[this.featurePage,this.selectedFeatureIndex,this.featureCount,this.featuresPerPage,this.featureViewModels],()=>this._setGraphicOnFeatureViewModels()),ie(()=>this.featureViewModels,()=>this._featureViewModelsChange()),this.on("trigger-action",e=>aje({event:e,view:this.view})),_a(()=>!this.waitingForResult,()=>this._waitingForResultChange(),ri),ie(()=>{var e,r;return[this.features,(e=this.view)==null?void 0:e.map,(r=this.view)==null?void 0:r.spatialReference]},()=>this._updateFeatureVMs()),ie(()=>{var e;return(e=this.view)==null?void 0:e.scale},()=>this._viewScaleChange()),_a(()=>!this.visible,()=>this.browseClusterEnabled=!1),ie(()=>this.browseClusterEnabled,e=>e?this.enableClusterBrowsing():this.disableClusterBrowsing())])}destroy(){this._cancelFetchingFeatures(),this._handles.destroy(),this._pendingPromises.clear(),this.browseClusterEnabled=!1,this.view=null}get active(){return!(!this.visible||this.waitingForResult)}get allActions(){const e=this._get("allActions")||new oR;e.removeAll();const{actions:r,defaultActions:i,defaultPopupTemplateEnabled:s,includeDefaultActions:n,selectedFeature:o}=this,a=n?i.concat(r):r,l=o&&(typeof o.getEffectivePopupTemplate=="function"&&o.getEffectivePopupTemplate(s)||o.popupTemplate),c=l&&l.actions,h=l&&l.overwriteActions?c:c?c.concat(a):a;return h&&h.filter(Boolean).forEach(p=>e.add(p)),e}get defaultActions(){const e=this._get("defaultActions")||new oR;return e.removeAll(),e.addMany(wb(this.selectedFeature)?Yje():Xje()),e}get featureCount(){return this.features.length}get features(){return this._get("features")||[]}set features(e){const r=e||[];this._set("features",r);const{pendingPromisesCount:i,promiseCount:s,selectedFeatureIndex:n}=this,o=s&&r.length;o&&i&&n===-1?this.selectedFeatureIndex=0:o&&n!==-1||(this.selectedFeatureIndex=r.length?0:-1)}get location(){return this._get("location")||null}set location(e){var s,n,o;let r=e;const i=(n=(s=this.view)==null?void 0:s.spatialReference)==null?void 0:n.isWebMercator;e&&((o=e==null?void 0:e.spatialReference)!=null&&o.isWGS84)&&i&&(r=jf(e)),this._set("location",r)}get pendingPromisesCount(){return this._pendingPromises.size}get waitingForResult(){return!(!(this._fetchFeaturesController||this.pendingPromisesCount>0)||this.featureCount!==0)}get promiseCount(){return this.promises.length}get promises(){return this._get("promises")||[]}set promises(e){if(this._pendingPromises.clear(),this.features=[],!Array.isArray(e)||!e.length)return this._set("promises",[]),void this.notifyChange("pendingPromisesCount");this._set("promises",e),(e=e.slice(0)).forEach(r=>{this._pendingPromises.add(r);const i=n=>{this._pendingPromises.has(r)&&this._updateFeatures(n),this._updatePendingPromises(r)},s=()=>this._updatePendingPromises(r);r.then(i,s)}),this.notifyChange("pendingPromisesCount")}get selectedFeature(){const{features:e,selectedFeatureIndex:r}=this;return r===-1?null:e[r]||null}get selectedFeatureIndex(){const e=this._get("selectedFeatureIndex");return typeof e=="number"?e:-1}set selectedFeatureIndex(e){const{featureCount:r}=this;e=isNaN(e)||e<-1||!r?-1:(e+r)%r,this.activeFeature=null,this._set("selectedFeatureIndex",e)}get selectedFeatureViewModel(){return this.featureViewModels[this.selectedFeatureIndex]||null}get state(){return this.get("view.ready")?"ready":"disabled"}centerAtLocation(){const{view:e}=this,r=W_e(this);return r&&e?this.callGoTo({target:{target:r,scale:e.scale}}):Promise.reject(new q("center-at-location:invalid-target-or-view","Cannot center at a location without a target and view.",{target:r,view:e}))}zoomTo(e){return this.callGoTo(e)}clear(){this.set({promises:[],features:[],content:null,title:null,location:null,activeFeature:null})}fetchFeatures(e,r){const{view:i}=this;if(!i||!e)throw new q("fetch-features:invalid-screenpoint-or-view","Cannot fetch features without a screenPoint and view.",{screenPoint:e,view:i});return i.fetchPopupFeatures(e,{event:r&&r.event,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,signal:r&&r.signal})}open(e){const r={updateLocationEnabled:!1,promises:[],fetchFeatures:!1,...e,visible:!0},{fetchFeatures:i}=r;delete r.fetchFeatures,i&&this._setFetchFeaturesPromises(r.location);const s=["actionsMenuOpen","collapsed","featureMenuOpen"];for(const n of s)delete r[n];this.set(r)}triggerAction(e){const r=this.allActions.getItemAt(e);r&&!r.disabled&&this.emit("trigger-action",{action:r})}next(){return this.selectedFeatureIndex=this.selectedFeatureIndex+1,this}previous(){return this.selectedFeatureIndex=this.selectedFeatureIndex-1,this}disableClusterBrowsing(){pje(this),this._clearBrowsedClusterGraphics()}async enableClusterBrowsing(){const{view:e,selectedFeature:r}=this;(e==null?void 0:e.type)==="2d"?wb(r)?(await hje(this),await dje(this)):se.getLogger(this.declaredClass).warn("enableClusterBrowsing:invalid-selectedFeature: Selected feature must represent an aggregate/cluster graphic.",r):se.getLogger(this.declaredClass).warn("enableClusterBrowsing:invalid-view: View must be 2d MapView.",r)}_animationStateChange(e){this.zoomToLocation||(kb.disabled=e==="waiting-for-target")}_clearBrowsedClusterGraphics(){var r;const e=(r=this.view)==null?void 0:r.graphics;e&&(e.remove(this.selectedClusterBoundaryFeature),this._selectedClusterFeature&&e.remove(this._selectedClusterFeature)),this._selectedClusterFeature=null,this.selectedClusterBoundaryFeature.geometry=null}_viewScaleChange(){if(wb(this.selectedFeature))return this.browseClusterEnabled=!1,this.visible=!1,void this.clear();this.browseClusterEnabled&&(this.features=this.selectedFeature?[this.selectedFeature]:[])}_locationChange(e){const{selectedFeature:r,updateLocationEnabled:i}=this;i&&e&&(!r||r.geometry)&&this.centerAtLocation()}_selectedFeatureIndexChange(){this.featurePage=this.featureCount>1?Math.floor(this.selectedFeatureIndex/this.featuresPerPage)+1:null}_featureViewModelsChange(){this.featurePage=this.featureCount>1?1:null}_setGraphicOnFeatureViewModels(){const{features:e,featureCount:r,featurePage:i,featuresPerPage:s,featureViewModels:n}=this;if(i===null)return;const o=((i-1)*s+r)%r,a=o+s;n.slice(o,a).forEach((l,c)=>{l&&!l.graphic&&(l.graphic=e[o+c])})}async _selectedFeatureChange(e){const{location:r,updateLocationEnabled:i,view:s}=this;if(e&&s){if(this.browseClusterEnabled)return this._selectedClusterFeature&&(s.graphics.remove(this._selectedClusterFeature),this._selectedClusterFeature=null),wb(e)?void 0:(e.symbol=await Dje(e),this._selectedClusterFeature=e,void s.graphics.add(this._selectedClusterFeature));!i&&r||!e.geometry?i&&!e.geometry&&this.centerAtLocation().then(()=>{var o;const n=(o=s.center)==null?void 0:o.clone();n&&(this.location=n)}):this.location=X_e(e.geometry)}}_waitingForResultChange(){!this.featureCount&&this.promises&&(this.visible=!1)}_setFetchFeaturesPromises(e){return this._fetchFeaturesWithController(this._getScreenPoint(e||this.location)).then(r=>{const{clientOnlyGraphics:i,promisesPerLayerView:s}=r,n=Promise.resolve(i),o=s.map(a=>a.promise);this.promises=[n,...o]})}_destroyFeatureVMs(){this.featureViewModels.forEach(e=>e&&!e.destroyed&&e.destroy()),this._set("featureViewModels",[])}_updateFeatureVMs(){const{selectedFeature:e,features:r,featureViewModels:i}=this;if(wb(e)||(this.browseClusterEnabled=!1),this._destroyFeatureVMs(),!r||!r.length)return;const s=i.slice(0),n=[];r.forEach((o,a)=>{var c,h;if(!o)return;let l=null;if(s.some((p,f)=>(p&&p.graphic===o&&(l=p,s.splice(f,1)),!!l)),l)n[a]=l;else{const p=new zX({abilities:this.featureViewModelAbilities,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,spatialReference:(c=this.view)==null?void 0:c.spatialReference,graphic:o===e?o:null,map:(h=this.view)==null?void 0:h.map,view:this.view});n[a]=p}}),s.forEach(o=>o&&!o.destroyed&&o.destroy()),this._set("featureViewModels",n)}_getScreenPoint(e){const{view:r}=this;return r&&e&&typeof r.toScreen=="function"?r.toScreen(e):null}_autoOpenEnabledChange(){const e="auto-fetch-features",{_handles:r,autoOpenEnabled:i}=this;if(r.remove(e),i&&this.view){const s=this.view.on("click",n=>{n.pointerType==="mouse"&&n.button!==0||this._fetchFeaturesAndOpen(n)},F_.WIDGET);r.add(s,e)}}_cancelFetchingFeatures(){const e=this._fetchFeaturesController;e&&e.abort(),this._fetchFeaturesController=null,this.notifyChange("waitingForResult")}_fetchFeaturesWithController(e,r){this._cancelFetchingFeatures();const i=new AbortController,{signal:s}=i;this._fetchFeaturesController=i,this.notifyChange("waitingForResult");const n=this.fetchFeatures(e,{signal:s,event:r});return n.catch(()=>{}).then(()=>{this._fetchFeaturesController=null,this.notifyChange("waitingForResult")}),n}_fetchFeaturesAndOpen(e){const{screenPoint:r,mapPoint:i}=e,{view:s}=this;this._fetchFeaturesWithController(r,e).then(n=>{var h;const{clientOnlyGraphics:o,promisesPerLayerView:a,location:l}=n,c=[Promise.resolve(o),...a.map(p=>p.promise)];return(h=s==null?void 0:s.popup)==null||h.open({location:l||i,promises:c}),n})}_updatePendingPromises(e){e&&this._pendingPromises.has(e)&&(this._pendingPromises.delete(e),this.notifyChange("pendingPromisesCount"))}_autoClose(){this.autoCloseEnabled&&(this.visible=!1)}async _getLayerView(e,r){return await e.when(),e.whenLayerView(r)}_getHighlightLayer(e){const{layer:r,sourceLayer:i}=e;return i&&"layer"in i&&i.layer?i.layer:(i==null?void 0:i.type)==="map-notes"||(i==null?void 0:i.type)==="subtype-group"?i:r}_getHighlightTarget(e,r){const i=r.type==="imagery"?void 0:"objectIdField"in r?r.objectIdField||Ome:null,s=e.attributes;return s&&i&&s[i]||e}async _highlightActiveFeature(){const e="highlight-active-feature";this._handles.remove(e);const{highlightEnabled:r,view:i,activeFeature:s,visible:n}=this;if(!(s&&i&&r&&n))return;const o=this._getHighlightLayer(s);if(!(o&&o instanceof cN))return;const a=this._getLayerView(i,o);this._highlightActiveFeaturePromise=a;const l=await a;if(!(l&&pre(l)&&this._highlightActiveFeaturePromise===a&&this.activeFeature&&this.highlightEnabled))return;const c=l.highlight(this._getHighlightTarget(s,o));this._handles.add(c,e)}async _highlightSelectedFeature(){const e="highlight-selected-feature";this._handles.remove(e);const{selectedFeature:r,highlightEnabled:i,view:s,visible:n}=this;if(!(r&&s&&i&&n))return;const o=this._getHighlightLayer(r);if(!(o&&o instanceof cN))return;const a=this._getLayerView(s,o);this._highlightSelectedFeaturePromise=a;const l=await a;if(!(l&&pre(l)&&this._highlightSelectedFeaturePromise===a&&this.selectedFeature&&this.highlightEnabled&&this.visible))return;const c=l.highlight(this._getHighlightTarget(r,o));this._handles.add(c,e)}_updateFeatures(e){const{features:r}=this;if(!e||!e.length)return;if(!r.length)return void(this.features=e);const i=e.filter(s=>!r.includes(s));this.features=r.concat(i)}};u([d()],Br.prototype,"featurePage",void 0),u([d()],Br.prototype,"isLoadingFeature",null),u([d({type:oR})],Br.prototype,"actions",void 0),u([d({readOnly:!0})],Br.prototype,"active",null),u([d()],Br.prototype,"activeFeature",void 0),u([d({readOnly:!0})],Br.prototype,"allActions",null),u([d({type:Boolean})],Br.prototype,"defaultPopupTemplateEnabled",void 0),u([d()],Br.prototype,"autoCloseEnabled",void 0),u([d()],Br.prototype,"autoOpenEnabled",void 0),u([d()],Br.prototype,"browseClusterEnabled",void 0),u([d()],Br.prototype,"content",void 0),u([d({type:oR,readOnly:!0})],Br.prototype,"defaultActions",null),u([d({readOnly:!0})],Br.prototype,"featureCount",null),u([d()],Br.prototype,"features",null),u([d()],Br.prototype,"featuresPerPage",void 0),u([d()],Br.prototype,"featureViewModelAbilities",void 0),u([d({readOnly:!0})],Br.prototype,"featureViewModels",void 0),u([d()],Br.prototype,"highlightEnabled",void 0),u([d()],Br.prototype,"includeDefaultActions",void 0),u([d({type:mt})],Br.prototype,"location",null),u([d({readOnly:!0})],Br.prototype,"pendingPromisesCount",null),u([d({readOnly:!0})],Br.prototype,"selectedClusterBoundaryFeature",void 0),u([d({readOnly:!0})],Br.prototype,"waitingForResult",null),u([d({readOnly:!0})],Br.prototype,"promiseCount",null),u([d()],Br.prototype,"promises",null),u([d({value:null,readOnly:!0})],Br.prototype,"selectedFeature",null),u([d({value:-1})],Br.prototype,"selectedFeatureIndex",null),u([d({readOnly:!0})],Br.prototype,"selectedFeatureViewModel",null),u([d({readOnly:!0})],Br.prototype,"state",null),u([d()],Br.prototype,"title",void 0),u([d()],Br.prototype,"updateLocationEnabled",void 0),u([d()],Br.prototype,"view",void 0),u([d()],Br.prototype,"visible",void 0),u([d()],Br.prototype,"zoomFactor",void 0),u([d()],Br.prototype,"zoomToLocation",void 0),u([d()],Br.prototype,"centerAtLocation",null),Br=u([I("esri.widgets.Popup.PopupViewModel")],Br);const ove=Br,fre="selected-index",Zje=0,mre="popup-spinner",gre={buttonEnabled:!0,position:"auto",breakpoint:{width:544}},yre="esri-popup";function Im(t,e){return e===void 0?`${yre}__${t}`:`${yre}__${t}-${e}`}const _re={closeButton:!0,featureNavigation:!0};let Dt=class extends G_e(Ea){constructor(e,r){super(e,r),this._blurClose=!1,this._blurContainer=!1,this._containerNode=null,this._mainContainerNode=null,this._featureMenuNode=null,this._actionsMenuNode=null,this._focusClose=!1,this._focusContainer=!1,this._focusDockButton=!1,this._focusFeatureMenuButton=!1,this._focusActionsMenuButton=!1,this._focusFirstFeature=!1,this._focusFirstAction=!1,this._handles=new ei,this._pointerOffsetInPx=16,this._spinner=null,this._feature=null,this._featureMenuIntersectionObserverNode=null,this._featureMenuViewportNode=null,this._rootFlowItemNode=null,this._featureMenuIntersectionObserverCallback=([i])=>{i!=null&&i.isIntersecting&&this.viewModel.featurePage!=null&&this.viewModel.featurePage++},this._featureMenuIntersectionObserver=new IntersectionObserver(this._featureMenuIntersectionObserverCallback,{root:window.document}),this._displaySpinnerThrottled=q2(()=>this._displaySpinner(),Zje),this._exitRelatedRecordsActions=new WeakMap,this._featureSelectionActions=new WeakMap,this._flowItems=new Pt,this.alignment="auto",this.collapsed=!1,this.collapseEnabled=!0,this.dockEnabled=!1,this.featureMenuOpen=!1,this.headingLevel=2,this.maxInlineActions=3,this.messages=null,this.messagesCommon=null,this.spinnerEnabled=!0,this.viewModel=new ove,this.visibleElements={..._re},this._handleOpenRelatedFeature=i=>{this._openRelatedFeature(i)},this._addSelectedFeatureIndexHandle(),this.addHandles([ie(()=>{var i;return(i=this.viewModel)==null?void 0:i.screenLocation},()=>this._positionContainer()),ie(()=>{var i;return[(i=this.viewModel)==null?void 0:i.active,this.dockEnabled]},()=>this._toggleScreenLocationEnabled()),ie(()=>{var i;return(i=this.viewModel)==null?void 0:i.screenLocation},(i,s)=>{!!i!=!!s&&this.reposition()}),ie(()=>{var i,s,n,o,a,l;return[(s=(i=this.viewModel)==null?void 0:i.view)==null?void 0:s.padding,(o=(n=this.viewModel)==null?void 0:n.view)==null?void 0:o.size,(a=this.viewModel)==null?void 0:a.active,(l=this.viewModel)==null?void 0:l.location,this.alignment]},()=>this.reposition()),ie(()=>this.spinnerEnabled,i=>this._spinnerEnabledChange(i)),ie(()=>{var i,s;return(s=(i=this.viewModel)==null?void 0:i.view)==null?void 0:s.size},(i,s)=>this._updateDockEnabledForViewSize(i,s)),ie(()=>{var i;return(i=this.viewModel)==null?void 0:i.view},(i,s)=>this._viewChange(i,s)),ie(()=>{var i,s;return(s=(i=this.viewModel)==null?void 0:i.view)==null?void 0:s.ready},(i,s)=>this._viewReadyChange(i??!1,s??!1)),ie(()=>{var i,s;return[(i=this.viewModel)==null?void 0:i.waitingForResult,(s=this.viewModel)==null?void 0:s.location]},()=>{this._hideSpinner(),this._displaySpinnerThrottled()}),ie(()=>this.selectedFeatureWidget,()=>this._destroyFlowItemWidgets()),ie(()=>{var i,s,n,o;return[(s=(i=this.selectedFeatureWidget)==null?void 0:i.viewModel)==null?void 0:s.title,(o=(n=this.selectedFeatureWidget)==null?void 0:n.viewModel)==null?void 0:o.state]},()=>this._setTitleFromFeatureWidget()),ie(()=>{var i,s,n,o;return[(s=(i=this.selectedFeatureWidget)==null?void 0:i.viewModel)==null?void 0:s.content,(o=(n=this.selectedFeatureWidget)==null?void 0:n.viewModel)==null?void 0:o.state]},()=>this._setContentFromFeatureWidget()),_a(()=>!this.collapsed,()=>{var i,s;((s=(i=this.viewModel)==null?void 0:i.view)==null?void 0:s.widthBreakpoint)==="xsmall"&&this.viewModel.active&&this.collapseEnabled&&this.viewModel.centerAtLocation()}),sn(()=>{var i;return(i=this.viewModel)==null?void 0:i.allActions},"change",()=>this._watchActions()),ie(()=>{var i;return(i=this.viewModel)==null?void 0:i.allActions},()=>this._watchActions(),Vt),ie(()=>{var i;return(i=this.viewModel)==null?void 0:i.featureViewModels},()=>this._featureMenuViewportScrollTop()),sn(()=>this._flowItems,"change",()=>{this.notifyChange("_activeFlowItemWidget"),this.scheduleRender()}),ie(()=>{var i,s,n,o;return[(s=(i=this._activeFlowItemWidget)==null?void 0:i.viewModel)==null?void 0:s.state,(o=(n=this._activeFlowItemWidget)==null?void 0:n.viewModel)==null?void 0:o.title]},()=>this.scheduleRender())])}loadDependencies(){return Promise.all([te(()=>import("./calcite-flow-9854152e.js"),["assets/calcite-flow-9854152e.js","assets/observers-2e8584e1.js"]),te(()=>import("./calcite-flow-item-a235bdf3.js"),["assets/calcite-flow-item-a235bdf3.js","assets/interactive-573cbe88.js","assets/loadable-25ad9e4e.js","assets/t9n-83b3e707.js","assets/observers-2e8584e1.js","assets/guid-9426053f.js","assets/action-a2b2c8ab.js","assets/icon-31e4ed97.js","assets/loader-2f409f99.js","assets/tooltip-6ef27501.js","assets/debounce-31e0cfcc.js","assets/scrim-fabf9087.js"]),te(()=>import("./calcite-action-6997d814.js"),["assets/calcite-action-6997d814.js","assets/action-a2b2c8ab.js","assets/guid-9426053f.js","assets/interactive-573cbe88.js","assets/loadable-25ad9e4e.js","assets/t9n-83b3e707.js","assets/observers-2e8584e1.js","assets/icon-31e4ed97.js","assets/loader-2f409f99.js"]),te(()=>import("./calcite-tooltip-608efa88.js"),["assets/calcite-tooltip-608efa88.js","assets/tooltip-6ef27501.js","assets/debounce-31e0cfcc.js","assets/guid-9426053f.js"]),te(()=>import("./calcite-icon-0839c644.js"),["assets/calcite-icon-0839c644.js","assets/icon-31e4ed97.js","assets/observers-2e8584e1.js"])])}destroy(){var e,r;this._destroyFlowItemWidgets(),this._destroySelectedFeatureWidget(),this._destroySpinner(),(e=this._handles)==null||e.destroy(),this._unobserveFeatureMenuObserver(),(r=this._featureMenuIntersectionObserver)==null||r.disconnect()}get actionsMenuId(){return`${this.id}-actions-menu`}get actionsMenuButtonId(){return`${this.id}-actions-menu-button`}get featureMenuId(){return`${this.id}-feature-menu`}get titleId(){return`${this.id}-popup-title`}get contentId(){return`${this.id}-popup-content`}get hasContent(){const{selectedFeatureWidget:e,viewModel:r}=this;if(!e)return!!(r!=null&&r.content);const i=e.viewModel;if(i!=null&&i.waitingForContent||(i==null?void 0:i.state)==="error")return!0;const s=i==null?void 0:i.content;return Array.isArray(s)?!!s.length:!!s}get featureNavigationVisible(){return this.viewModel.active&&this.viewModel.featureCount>1&&this.visibleElements.featureNavigation!=null}get collapsible(){return!!(this.collapseEnabled&&this.viewModel.title&&this.hasContent)}get featureMenuVisible(){return this.featureNavigationVisible&&this.featureMenuOpen}get contentCollapsed(){return this.collapsible&&!this.featureMenuVisible&&this.collapsed}get dividedActions(){return this._divideActions()}get _activeFlowItemWidget(){const{_flowItems:e}=this;return e.getItemAt(e.length-1)||null}get actions(){return this.viewModel.actions}set actions(e){this.viewModel.actions=e}set actionsMenuOpen(e){this._set("actionsMenuOpen",!!e)}get actionsMenuOpen(){return!!this.viewModel.active&&this._get("actionsMenuOpen")}get autoCloseEnabled(){return this.viewModel.autoCloseEnabled}set autoCloseEnabled(e){this.viewModel.autoCloseEnabled=e}get autoOpenEnabled(){return this.viewModel.autoOpenEnabled}set autoOpenEnabled(e){this.viewModel.autoOpenEnabled=e}get defaultPopupTemplateEnabled(){return this.viewModel.defaultPopupTemplateEnabled}set defaultPopupTemplateEnabled(e){this.viewModel.defaultPopupTemplateEnabled=e}get content(){return this.viewModel.content}set content(e){this.viewModel.content=e}get currentAlignment(){return this._getCurrentAlignment()}get currentDockPosition(){return this._getCurrentDockPosition()}get dockOptions(){return this._get("dockOptions")||gre}set dockOptions(e){var l,c;const r={...gre},i=(c=(l=this.viewModel)==null?void 0:l.view)==null?void 0:c.breakpoints,s={};i&&(s.width=i.xsmall,s.height=i.xsmall);const n={...r,...e},o={...r.breakpoint,...s},{breakpoint:a}=n;typeof a=="object"?n.breakpoint={...o,...a}:a&&(n.breakpoint=o),this._set("dockOptions",n),this._setCurrentDockPosition(),this.reposition()}get featureCount(){return this.viewModel.featureCount}get features(){return this.viewModel.features}set features(e){this.viewModel.features=e}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(e){this.viewModel.goToOverride=e}get highlightEnabled(){return this.viewModel.highlightEnabled}set highlightEnabled(e){this.viewModel.highlightEnabled=e}get location(){return this.viewModel.location}set location(e){this.viewModel.location=e}get label(){var e;return((e=this.messages)==null?void 0:e.widgetLabel)??""}set label(e){this._overrideIfSome("label",e)}get promises(){return this.viewModel.promises}set promises(e){this.viewModel.promises=e}get selectedFeature(){return this.viewModel.selectedFeature}get selectedFeatureIndex(){return this.viewModel.selectedFeatureIndex}set selectedFeatureIndex(e){this.viewModel.selectedFeatureIndex=e}get selectedFeatureWidget(){const{_feature:e,visibleElements:r,headingLevel:i,_flowItems:s}=this,{selectedFeatureViewModel:n}=this.viewModel,o={...r,title:!1};return n?(e?(e.viewModel=n,e.visibleElements=o):this._feature=new ije({flowItems:s,headingLevel:i+1,viewModel:n,visibleElements:o}),this._feature):null}get title(){return this.viewModel.title}set title(e){this.viewModel.title=e}get updateLocationEnabled(){return this.viewModel.updateLocationEnabled}set updateLocationEnabled(e){this.viewModel.updateLocationEnabled=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}get visible(){return this.viewModel.visible}set visible(e){this.viewModel.visible=e}castVisibleElements(e){return{..._re,...e}}blur(){const{active:e}=this.viewModel;e||se.getLogger(this.declaredClass).warn("Popup can only be blurred when currently active."),this.visibleElements.closeButton?this._blurClose=!0:this._blurContainer=!0,this.scheduleRender()}clear(){return this.viewModel.clear()}close(){this.visible=!1}fetchFeatures(e,r){return this.viewModel.fetchFeatures(e,r)}focus(){const{active:e}=this.viewModel;e||se.getLogger(this.declaredClass).warn("Popup can only be focused when currently active."),this.visibleElements.closeButton?this._focusClose=!0:this._focusContainer=!0,this.scheduleRender()}next(){return this.viewModel.next()}open(e){var n,o;this._handles.remove(fre);const r=!!e&&!!e.featureMenuOpen,i=!!e&&!!e.actionsMenuOpen,s={collapsed:!!e&&!!e.collapsed,actionsMenuOpen:i,featureMenuOpen:r};((o=(n=this.viewModel)==null?void 0:n.view)==null?void 0:o.widthBreakpoint)==="xsmall"&&(s.collapsed=!0),this.set(s),this.viewModel.open(e),this._shouldFocus(e),this._addSelectedFeatureIndexHandle()}previous(){return this.viewModel.previous()}reposition(){this.renderNow(),this._positionContainer(),this._setCurrentAlignment()}triggerAction(e){return this.viewModel.triggerAction(e)}render(){var _,b,x,T;const{actionsMenuOpen:e,dockEnabled:r,featureMenuVisible:i,dividedActions:s,currentAlignment:n,currentDockPosition:o}=this,{active:a}=this.viewModel,{menuActions:l}=s,c=a&&l.length>1&&e,h=a&&r,p=a&&!r,f=(b=(_=this.selectedFeature)==null?void 0:_.layer)==null?void 0:b.title,m=(T=(x=this.selectedFeature)==null?void 0:x.layer)==null?void 0:T.id,y={[Ae.alignTopCenter]:n==="top-center",[Ae.alignBottomCenter]:n==="bottom-center",[Ae.alignTopLeft]:n==="top-left",[Ae.alignBottomLeft]:n==="bottom-left",[Ae.alignTopRight]:n==="top-right",[Ae.alignBottomRight]:n==="bottom-right",[Ae.isDocked]:h,[Ae.shadow]:p,[Ae.isDockedTopLeft]:o==="top-left",[Ae.isDockedTopCenter]:o==="top-center",[Ae.isDockedTopRight]:o==="top-right",[Ae.isDockedBottomLeft]:o==="bottom-left",[Ae.isDockedBottomCenter]:o==="bottom-center",[Ae.isDockedBottomRight]:o==="bottom-right",[Ae.isFeatureMenuOpen]:i,[Ae.isActionsMenuOpen]:c};return re("div",{class:this.classes(Ae.base,y),role:"presentation","data-layer-title":f,"data-layer-id":m,bind:this,afterCreate:this._positionContainer,afterUpdate:this._positionContainer},a?[this.renderMainContainer(),this.renderPointer()]:null)}renderLoadingIcon(){return re("span",{"aria-hidden":"true",class:this.classes(Ae.icon,Ae.iconLoading,Ae.rotating)})}renderNavigationLoading(){const{messagesCommon:e}=this;return this.viewModel.pendingPromisesCount?re("div",{key:Im("loading-container"),role:"presentation",class:Ae.loadingContainer,"aria-label":e.loading,title:e.loading},this.renderLoadingIcon()):null}renderPreviousIcon(){const e=Uf(this.container),r={[Ae.iconRightTriangleArrow]:e,[Ae.paginationPreviousIconRTL]:e,[Ae.iconLeftTriangleArrow]:!e,[Ae.paginationPreviousIconLTR]:!e};return re("span",{"aria-hidden":"true",class:this.classes(Ae.icon,r)})}renderPreviousButton(){const{messages:e}=this;return re("div",{role:"button",tabIndex:0,bind:this,onclick:this._previous,onkeydown:this._previous,class:this.classes(Ae.button,Ae.paginationPrevious),"aria-label":e.previous,title:e.previous},this.renderPreviousIcon())}renderNextIcon(){const e=Uf(this.container),r={[Ae.iconLeftTriangleArrow]:e,[Ae.paginationNextIconRTL]:e,[Ae.iconRightTriangleArrow]:!e,[Ae.paginationNextIconLTR]:!e};return re("span",{"aria-hidden":"true",class:this.classes(Ae.icon,r)})}renderNextButton(){const{messages:e}=this;return re("div",{role:"button",tabIndex:0,bind:this,onclick:this._next,onkeydown:this._next,class:this.classes(Ae.button,Ae.paginationNext),"aria-label":e.next,title:e.next},this.renderNextIcon())}renderFeatureMenuButton(){const{featureMenuOpen:e,featureMenuId:r,messagesCommon:i}=this,{featureCount:s,selectedFeatureIndex:n}=this.viewModel;return re("div",{role:"button",tabIndex:0,bind:this,onclick:this._toggleFeatureMenu,onkeydown:this._toggleFeatureMenu,afterCreate:this._focusFeatureMenuButtonNode,afterUpdate:this._focusFeatureMenuButtonNode,class:this.classes(Ae.button,Ae.featureMenuButton),"aria-haspopup":"true","aria-controls":r,"aria-expanded":e.toString(),"aria-label":i.menu,title:i.menu},this._getPageText(s,n))}renderNavigationButtons(){return this.featureNavigationVisible?[this.renderPreviousButton(),this.renderNavigationLoading()||this.renderFeatureMenuButton(),this.renderNextButton()]:[]}renderDockIcon(){const{dockEnabled:e}=this,r=this._wouldDockTo(),i={[Ae.iconUndock]:e,[Ae.iconDock]:!e,[Ae.iconDockToRight]:!e&&(r==="top-right"||r==="bottom-right"),[Ae.iconDockToLeft]:!e&&(r==="top-left"||r==="bottom-left"),[Ae.iconDockToTop]:!e&&r==="top-center",[Ae.iconDockToBottom]:!e&&r==="bottom-center"};return re("span",{"aria-hidden":"true",class:this.classes(i,Ae.icon)})}renderDockButton(){var n,o,a;const{dockEnabled:e,messages:r}=this,i=(o=(n=this.viewModel)==null?void 0:n.view)==null?void 0:o.widthBreakpoint,s=e?r.undock:r.dock;return i!=="xsmall"&&((a=this.dockOptions)!=null&&a.buttonEnabled)?re("div",{role:"button","aria-label":s,title:s,tabIndex:0,bind:this,onclick:this._toggleDockEnabled,onkeydown:this._toggleDockEnabled,afterCreate:this._focusDockButtonNode,afterUpdate:this._focusDockButtonNode,class:this.classes(Ae.button,Ae.buttonDock)},this.renderDockIcon()):null}renderTitle(){const{title:e}=this.viewModel,{titleId:r,collapsible:i,contentCollapsed:s,messagesCommon:n}=this,o={[Ae.headerContainerButton]:i},a=re(QW,{level:this.headingLevel,class:Ae.headerTitle,innerHTML:e??""}),l=i?re("button",{key:`${e}--collapsible`,id:r,title:s?n.expand:n.collapse,bind:this,enterAnimation:this._createFeatureUpdatedAnimation(),class:this.classes(Ae.headerContainer,o),"aria-expanded":s?"false":"true",onclick:this._toggleCollapsed,type:"button"},a,re("calcite-icon",{class:Ae.collapseIcon,key:"collapse-icon",icon:s?"chevron-down":"chevron-up",scale:"m"})):re("div",{key:e??"title",id:r,bind:this,enterAnimation:this._createFeatureUpdatedAnimation(),class:this.classes(Ae.headerContainer,o)},a);return e?l:null}renderCloseIcon(){return re("span",{"aria-hidden":"true",class:this.classes(Ae.icon,Ae.iconClose)})}renderCloseButton(){const{visibleElements:e,messagesCommon:r}=this;return e.closeButton?re("div",{role:"button",tabIndex:0,bind:this,onclick:this._close,onkeydown:this._close,class:Ae.button,"aria-label":r.close,title:r.close,afterCreate:this._closeButtonNodeUpdated,afterUpdate:this._closeButtonNodeUpdated},this.renderCloseIcon()):null}renderHeader(){return re("header",{class:Ae.header},this.renderTitle(),re("div",{class:Ae.headerButtons},this.renderDockButton(),this.renderCloseButton()))}renderContentContainer(){const{contentId:e,hasContent:r,contentCollapsed:i,_flowItems:s}=this,{content:n}=this.viewModel,o=s.toArray(),a={[Ae.contentHasFlows]:!!o.length};return r&&!i?re("div",{key:n??"content",enterAnimation:this._createFeatureUpdatedAnimation(),id:e,class:this.classes(Ae.content,a)},re("calcite-flow",{bind:this},re("calcite-flow-item",{bind:this,"data-node-ref":"_rootFlowItemNode",afterCreate:SN,key:"root-flow-item",onCalciteFlowItemBack:this._handleBackClick},this.renderContent()),o.map(l=>this.renderFlowItem(l))),o.map(l=>this.renderFlowItemTooltips(l))):null}renderFlowItem(e){const{messages:r}=this,i=NN(),s="graphic"in e&&!e.isTable;return re("calcite-flow-item",{bind:this,class:this.classes({[Ae.calciteThemeDark]:!i,[Ae.calciteThemeLight]:i}),heading:e.title??"",description:this._getFlowItemDescription(e),onCalciteFlowItemBack:this._handleBackClick,key:`flow-item-${e.viewModel.uid}`},re("calcite-action",{class:Ae.actionExit,icon:"move-up",label:r==null?void 0:r.exitRelatedRecords,text:r==null?void 0:r.exitRelatedRecords,slot:"header-actions-start",bind:this,afterCreate:n=>this._storeExitRelatedRecordsAction(e,n),onclick:this._destroyFlowItemWidgets}),s?re("calcite-action",{class:Ae.actionSelectFeature,icon:"zoom-to-object",label:r==null?void 0:r.selectFeature,text:r==null?void 0:r.selectFeature,slot:"header-actions-end",bind:this,afterCreate:n=>this._storeFeatureSelectionAction(e,n),onclick:()=>this._handleOpenRelatedFeature(e)}):null,re("div",{class:this.classes(Ae.contentFlowItem,{[Ae.calciteThemeDark]:i,[Ae.calciteThemeLight]:!i})},e.render()))}renderFlowItemTooltips(e){const{messages:r,_exitRelatedRecordsActions:i,_featureSelectionActions:s}=this,n=NN(),o=s.get(e);return[re("calcite-tooltip",{class:this.classes({[Ae.calciteThemeDark]:!n,[Ae.calciteThemeLight]:n}),key:`exit-related-records-tooltip-${e.viewModel.uid}`,label:r==null?void 0:r.exitRelatedRecords,overlayPositioning:"fixed",referenceElement:i.get(e),placement:"top"},r==null?void 0:r.exitRelatedRecords),o?re("calcite-tooltip",{class:this.classes({[Ae.calciteThemeDark]:!n,[Ae.calciteThemeLight]:n}),key:`select-related-record-tooltip-${e.viewModel.uid}`,label:r==null?void 0:r.selectFeature,overlayPositioning:"fixed",referenceElement:o,placement:"top"},r==null?void 0:r.selectFeature):null]}renderActionsMenuButton(){const{actionsMenuId:e,actionsMenuButtonId:r,actionsMenuOpen:i,dividedActions:s,messagesCommon:n}=this,o=i?n.close:n.open,{menuActions:a}=s;return a.length?re("div",{key:Im("actions-menu-button"),class:this.classes(Ae.button,Ae.actionsMenuButton),role:"button",id:r,"aria-haspopup":"true","aria-controls":i?e:null,tabIndex:0,bind:this,onclick:this._toggleActionsMenu,onkeydown:this._toggleActionsMenu,afterCreate:this._focusActionsMenuButtonNode,afterUpdate:this._focusActionsMenuButtonNode,"aria-label":o,title:o},re("span",{"aria-hidden":"true",class:Ae.iconActionsMenu})):null}renderMenuActions(){const{actionsMenuId:e,actionsMenuButtonId:r,actionsMenuOpen:i,dividedActions:s}=this,{menuActions:n}=s;return n.length&&i?re("ul",{id:e,role:"menu","aria-labelledby":r,key:Im("actions"),class:Ae.actions,bind:this,onkeyup:this._handleActionMenuKeyup,afterCreate:this._actionsMenuNodeUpdated,afterUpdate:this._actionsMenuNodeUpdated},n.toArray().map(o=>this.renderAction({action:o,type:"menu-item"}))):null}renderInlineActions(){const{inlineActions:e}=this.dividedActions;return e.length?e.toArray().map(r=>this.renderAction({action:r,type:"inline"})):[]}renderInlineActionsContainer(){const{inlineActions:e,menuActions:r}=this.dividedActions,i=!!e.length,s=!!r.length;return i||s?re("div",{key:"inline-actions-container","data-inline-actions":i.toString(),"data-menu-actions":s.toString(),class:Ae.inlineActionsContainer},this.renderInlineActions(),this.renderActionsMenuButton(),this.renderMenuActions()):null}renderNavigation(){return this.featureNavigationVisible?re("section",{key:Im("navigation"),class:this.classes(Ae.navigation)},this.renderNavigationButtons()):null}renderFooter(){const{featureNavigationVisible:e,dividedActions:r}=this,{inlineActions:i,menuActions:s}=r,n=!!i.length,o=!!s.length,a={[Ae.footerHasPagination]:e,[Ae.footerHasActions]:n,[Ae.footerHasActionsMenu]:o};return e||n?re("div",{key:Im("feature-buttons"),class:this.classes(Ae.footer,a)},this.renderInlineActionsContainer(),this.renderNavigation()):null}renderFeatureMenuContainer(){const{messages:e}=this,{featureViewModels:r,isLoadingFeature:i}=this.viewModel,s=Tf(e.selectedFeatures,{total:r.length});return re("section",{key:Im("menu"),class:Ae.featureMenu},re("strong",{class:Ae.featureMenuHeader},s),re("nav",{bind:this,class:Ae.featureMenuViewport,"data-node-ref":"_featureMenuViewportNode",afterCreate:SN},this.renderFeatureMenu(),re("div",{class:Ae.featureMenuObserver,bind:this,afterCreate:this._featureMenuIntersectionObserverCreated}),i?re("div",{class:Ae.featureMenuLoader},this.renderLoadingIcon()):null))}renderPointer(){return this.dockEnabled?null:re("div",{key:Im("pointer"),class:Ae.pointer,role:"presentation"},re("div",{class:this.classes(Ae.pointerDirection,Ae.shadow)}))}renderMainContainer(){const{dockEnabled:e,currentAlignment:r,currentDockPosition:i,titleId:s,contentId:n,collapsible:o,hasContent:a,contentCollapsed:l,visibleElements:c}=this,{title:h}=this.viewModel,p=r==="bottom-left"||r==="bottom-center"||r==="bottom-right"||i==="top-left"||i==="top-center"||i==="top-right",f=r==="top-left"||r==="top-center"||r==="top-right"||i==="bottom-left"||i==="bottom-center"||i==="bottom-right",m={[Ae.shadow]:e,[Ae.isCollapsible]:o,[Ae.isCollapsed]:l};return re("div",{class:this.classes(Ae.main,Ae.widget,m),tabIndex:c.closeButton?void 0:-1,role:"dialog","aria-labelledby":h?s:"","aria-describedby":a&&!l?n:"",bind:this,onkeyup:this._handleMainKeyup,afterCreate:this._mainContainerNodeUpdated,afterUpdate:this._mainContainerNodeUpdated},p?this.renderFooter():null,p?this.renderFeatureMenuContainer():null,this.renderHeader(),this.renderContentContainer(),f?this.renderFooter():null,f?this.renderFeatureMenuContainer():null)}renderContent(){var r;const e=(r=this.viewModel)==null?void 0:r.content;return e?typeof e=="string"?re("div",{class:Js.contentNode,key:e,innerHTML:e}):this.renderNodeContent(e):null}renderActionText(e){return re("span",{key:"text",class:Ae.actionText},e)}renderActionIcon(e){const r=this._getActionClass(e),i=this._getActionImage(e),s={[Ae.iconLoading]:e.active,[Ae.rotating]:e.active,[Ae.icon]:!!r,[Ae.actionImage]:!e.active&&!!i};return r&&(s[r]=!e.active),re("span",{key:"icon","aria-hidden":"true",class:this.classes(Ae.icon,s),styles:this._getIconStyles(i)})}renderAction(e){const{action:r,type:i}=e,s=this._getActionTitle(r),n={[Ae.action]:r.type!=="toggle",[Ae.actionToggle]:r.type==="toggle",[Ae.actionToggleOn]:r.type==="toggle"&&r.value,[Ae.buttonDisabled]:r.disabled},o=[this.renderActionIcon(r),this.renderActionText(s)],a=i==="menu-item"?re("li",{key:r.uid,role:"menuitem",tabIndex:0,title:s,"aria-label":s,class:this.classes(Ae.button,n),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-uid":r.uid,onclick:this._triggerAction,onkeydown:this._triggerAction},o):re("div",{key:r.uid,role:"button",tabIndex:0,title:s,"aria-label":s,class:this.classes(Ae.button,n),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-uid":r.uid,onclick:this._triggerAction,onkeydown:this._triggerAction},o);return r.visible?a:null}renderFeatureMenuItem(e,r){const{messages:i,messagesCommon:s}=this,{selectedFeatureIndex:n,selectedFeatureViewModel:o}=this.viewModel,a=e===o,l={[Ae.featureMenuSelected]:a},c=a?re("span",{key:Im(`feature-menu-selected-feature-${n}`),title:i.selectedFeature,"aria-label":i.selectedFeature,class:Ae.iconCheckMark}):null,h=re("span",{innerHTML:e.title||s.untitled});return re("li",{role:"menuitem",tabIndex:-1,key:Im(`feature-menu-feature-${n}`),class:this.classes(l,Ae.featureMenuItem),bind:this,"data-feature-index":r,onblur:this._removeActiveFeature,onfocus:this._setActiveFeature,onkeyup:this._handleFeatureMenuItemKeyup,onclick:this._selectFeature,onkeydown:this._selectFeature,onmouseover:this._setActiveFeature,onmouseleave:this._removeActiveFeature},re("span",{class:Ae.featureMenuTitle},h,c))}renderFeatureMenu(){const{featureMenuId:e}=this,{featureViewModels:r}=this.viewModel;return r.length>1?re("ol",{class:Ae.featureMenuList,id:e,bind:this,afterCreate:this._featureMenuNodeUpdated,afterUpdate:this._featureMenuNodeUpdated,onkeyup:this._handleFeatureMenuKeyup,role:"menu"},r.filter(i=>!!i.graphic).map((i,s)=>this.renderFeatureMenuItem(i,s))):null}_storeFeatureSelectionAction(e,r){this._featureSelectionActions.set(e,r),this.scheduleRender()}_storeExitRelatedRecordsAction(e,r){this._exitRelatedRecordsActions.set(e,r),this.scheduleRender()}_getFlowItemDescription(e){return"featureCountDescription"in e?e.featureCountDescription:e.viewModel.description??""}async _openRelatedFeature(e){await e.viewModel.updateGeometry();const r=e.graphic,i=r==null?void 0:r.geometry;if(C(i)||C(r))return;this._destroyFlowItemWidgets(),await this.viewModel.zoomTo({target:i});const s=X_e(i);this.open({features:[r],location:v(s)?s:void 0})}_destroyFlowItemWidgets(){this._flowItems.removeAll().forEach(e=>{"showAllEnabled"in e.viewModel&&(e.viewModel.showAllEnabled=!1),e.viewModel=null,e.destroy()})}_handleBackClick(){const e=this._flowItems.pop();e&&(this._exitRelatedRecordsActions.delete(e),this._featureSelectionActions.delete(e),"showAllEnabled"in e.viewModel&&(e.viewModel.showAllEnabled=!1),e&&(e.viewModel=null,e.destroy()))}_getActionTitle(e){const{messages:r,selectedFeature:i,messagesCommon:s}=this,{id:n}=e,o=i==null?void 0:i.attributes,a=e.title??"",l=n==="zoom-to-feature"?Tf(a,{messages:r}):n==="remove-selected-feature"?Tf(a,{messages:s}):n==="zoom-to-clustered-features"||n==="browse-clustered-features"?Tf(a,{messages:r}):e.title;return l&&o?Tf(l,o):l??""}_getActionClass(e){const{selectedFeature:r}=this,i=r==null?void 0:r.attributes,{className:s,image:n}=e,o=n||s?s:Ae.iconDefaultAction;return o&&i?Tf(o,i):o??""}_getActionImage(e){const{selectedFeature:r}=this,i=r==null?void 0:r.attributes,{image:s}=e;return s&&i?Tf(s,i):s??""}_createFeatureUpdatedAnimation(){return jFe("enter",Ae.hasFeatureUpdated)}_getInlineActionCount(){const{maxInlineActions:e,featureNavigationVisible:r}=this;if(typeof e!="number")return null;const i=Math.round(e);return Math.max(r?i-1:i,0)}_watchActions(){const{allActions:e}=this.viewModel;this.notifyChange("dividedActions");const r="actions";this._handles.remove(r),e&&e.forEach(i=>{this._handles.add(ie(()=>[i.uid,i.active,i.className,i.disabled,i.id,i.title,i.image,i.visible],()=>this.scheduleRender()),r)})}_divideActions(){const{allActions:e}=this.viewModel,r=e.filter(o=>o.visible),i=this._getInlineActionCount(),s=i===null,n=i===0;return{inlineActions:s?r.slice(0):n?new Pt:r.slice(0,i),menuActions:s?new Pt:n?r.slice(0):r.slice(i)}}_featureMenuOpenChanged(e){e?this._focusFirstFeature=!0:this._focusFeatureMenuButton=!0}_actionsMenuOpenChanged(e){e?this._focusFirstAction=!0:this._focusActionsMenuButton=!0}_setTitleFromFeatureWidget(){var i,s;const{selectedFeatureWidget:e,messagesCommon:r}=this;e&&(this.viewModel.title=((i=e.viewModel)==null?void 0:i.state)==="error"?r.errorMessage:((s=e.viewModel)==null?void 0:s.title)||"")}_setContentFromFeatureWidget(){const{selectedFeatureWidget:e}=this;e&&(this.viewModel.content=e)}_unobserveFeatureMenuObserver(){this._featureMenuIntersectionObserverNode&&this._featureMenuIntersectionObserver.unobserve(this._featureMenuIntersectionObserverNode)}_featureMenuIntersectionObserverCreated(e){this._unobserveFeatureMenuObserver(),this._featureMenuIntersectionObserver.observe(e),this._featureMenuIntersectionObserverNode=e}_handleFeatureMenuKeyup(e){fb(e)==="Escape"&&(e.stopPropagation(),this._focusFeatureMenuButton=!0,this.featureMenuOpen=!1,this.scheduleRender())}_handleActionMenuKeyup(e){fb(e)==="Escape"&&(e.stopPropagation(),this._focusActionsMenuButton=!0,this.actionsMenuOpen=!1,this.scheduleRender())}_setActiveFeature(e){const{viewModel:r}=this,i=e.currentTarget["data-feature-index"];r.activeFeature=r.features[i]||null}_removeActiveFeature(){this.viewModel.activeFeature=null}_handleFeatureMenuItemKeyup(e){const r=fb(e),{_featureMenuNode:i}=this,s=e.currentTarget["data-feature-index"];if(!i)return;const n=i.querySelectorAll("li"),o=n.length;r!=="ArrowUp"?r!=="ArrowDown"?r!=="Home"?r!=="End"||(e.stopPropagation(),n[n.length-1].focus()):(e.stopPropagation(),n[0].focus()):(e.stopPropagation(),n[(s+1+o)%o].focus()):(e.stopPropagation(),n[(s-1+o)%o].focus())}_handleActionMenuItemKeyup(e){const r=fb(e),{_actionsMenuNode:i}=this,s=e.currentTarget.dataset.actionUid,{menuActions:n}=this.dividedActions,o=n.findIndex(c=>c.uid===s);if(!i)return;const a=i.querySelectorAll("li"),l=a.length;r!=="ArrowUp"?r!=="ArrowDown"?r!=="Home"?r!=="End"||(e.stopPropagation(),a[a.length-1].focus()):(e.stopPropagation(),a[0].focus()):(e.stopPropagation(),a[(o+1+l)%l].focus()):(e.stopPropagation(),a[(o-1+l)%l].focus())}_handleMainKeyup(e){const r=fb(e);r==="ArrowLeft"&&(e.stopPropagation(),this.previous()),r==="ArrowRight"&&(e.stopPropagation(),this.next())}_spinnerEnabledChange(e){if(this._destroySpinner(),!e)return;const r=this.get("viewModel.view");this._createSpinner(r)}_hideSpinner(){const{_spinner:e}=this;e&&(e.location=null,e.hide())}_displaySpinner(){const{_spinner:e}=this;if(!e)return;const{location:r,waitingForResult:i}=this.viewModel;i&&r?e.show({location:r}):e.hide()}_getIconStyles(e){return{"background-image":e?`url(${e})`:""}}async _shouldFocus(e){e!=null&&e.shouldFocus&&(await WR(()=>{var r;return((r=this.viewModel)==null?void 0:r.active)===!0}),this.focus())}_addSelectedFeatureIndexHandle(){const e=ie(()=>{var r;return(r=this.viewModel)==null?void 0:r.selectedFeatureIndex},(r,i)=>this._selectedFeatureIndexUpdated(r,i));this._handles.add(e,fre)}_selectedFeatureIndexUpdated(e,r){const{featureCount:i}=this;i&&e!==r&&e!==-1&&(this._destroyFlowItemWidgets(),this.actionsMenuOpen=!1,this.featureMenuOpen=!1,this._mainContainerNode&&(this._mainContainerNode.scrollTop=0),this._rootFlowItemNode&&this._rootFlowItemNode.scrollContentTo({top:0}))}_destroySelectedFeatureWidget(){const{_feature:e}=this;e&&(e.viewModel=null,e&&!e.destroyed&&e.destroy()),this._feature=null}_isScreenLocationWithinView(e,r){return e.x>-1&&e.y>-1&&e.x<=r.width&&e.y<=r.height}_isOutsideView(e){const{popupHeight:r,popupWidth:i,screenLocation:s,side:n,view:o}=e;if(isNaN(i)||isNaN(r)||!o||!s)return!1;const a=o.padding;return n==="right"&&s.x+i/2>o.width-a.right||n==="left"&&s.x-i/2<a.left||n==="top"&&s.y-r<a.top||n==="bottom"&&s.y+r>o.height-a.bottom}_calculateAutoAlignment(e){if(e!=="auto")return e;const{_pointerOffsetInPx:r,_containerNode:i,_mainContainerNode:s,viewModel:n}=this,{screenLocation:o,view:a}=n;if(C(o)||!a||!i)return"top-center";if(!this._isScreenLocationWithinView(o,a))return this._get("currentAlignment")||"top-center";function l(E){return parseInt(E.replace(/[^-\d\.]/g,""),10)}const c=s?window.getComputedStyle(s,null):null,h=c?l(c.getPropertyValue("max-height")):0,p=c?l(c.getPropertyValue("height")):0,{height:f,width:m}=i.getBoundingClientRect(),y=m+r,_=Math.max(f,h,p)+r,b=this._isOutsideView({popupHeight:_,popupWidth:y,screenLocation:o,side:"right",view:a}),x=this._isOutsideView({popupHeight:_,popupWidth:y,screenLocation:o,side:"left",view:a}),T=this._isOutsideView({popupHeight:_,popupWidth:y,screenLocation:o,side:"top",view:a}),S=this._isOutsideView({popupHeight:_,popupWidth:y,screenLocation:o,side:"bottom",view:a});return x?T?"bottom-right":"top-right":b?T?"bottom-left":"top-left":T?S?"top-center":"bottom-center":"top-center"}_callCurrentAlignment(e){return typeof e=="function"?e.call(this):e}_getCurrentAlignment(){const{alignment:e,dockEnabled:r}=this;return r||!this.viewModel.active?null:this._calculatePositionResult(this._calculateAutoAlignment(this._callCurrentAlignment(e)))}_setCurrentAlignment(){this._set("currentAlignment",this._getCurrentAlignment())}_setCurrentDockPosition(){this._set("currentDockPosition",this._getCurrentDockPosition())}_calculatePositionResult(e){const r=["left","right"];return Uf(this.container)&&r.reverse(),e.replace(/leading/gi,r[0]).replace(/trailing/gi,r[1])}_callDockPosition(e){return typeof e=="function"?e.call(this):e}_getDockPosition(){var e;return this._calculatePositionResult(this._calculateAutoDockPosition(this._callDockPosition((e=this.dockOptions)==null?void 0:e.position)))}_getCurrentDockPosition(){return this.dockEnabled&&this.viewModel.active?this._getDockPosition():null}_wouldDockTo(){return this.dockEnabled?null:this._getDockPosition()}_calculateAutoDockPosition(e){var a;if(e!=="auto")return e;const r=(a=this.viewModel)==null?void 0:a.view,i=Uf(this.container)?"top-left":"top-right";if(!r)return i;const s=r.padding||{left:0,right:0,top:0,bottom:0},n=r.width-s.left-s.right,{breakpoints:o}=r;return o&&n<=o.xsmall?"bottom-center":i}_positionContainer(e=this._containerNode){if(e&&(this._containerNode=e),!this._containerNode)return;const{screenLocation:r}=this.viewModel,{width:i}=this._containerNode.getBoundingClientRect(),s=this._calculatePositionStyle(r,i);s&&Object.assign(this._containerNode.style,s)}_calculateFullWidth(e){const{currentAlignment:r,_pointerOffsetInPx:i}=this;return r==="top-left"||r==="bottom-left"||r==="top-right"||r==="bottom-right"?e+i:e}_calculateAlignmentPosition(e,r,i,s){const{currentAlignment:n,_pointerOffsetInPx:o}=this;if(!i)return;const{padding:a}=i,l=s/2,c=i.height-r,h=i.width-e;return n==="bottom-center"?{top:r+o-a.top,left:e-l-a.left}:n==="top-left"?{bottom:c+o-a.bottom,right:h+o-a.right}:n==="bottom-left"?{top:r+o-a.top,right:h+o-a.right}:n==="top-right"?{bottom:c+o-a.bottom,left:e+o-a.left}:n==="bottom-right"?{top:r+o-a.top,left:e+o-a.left}:n==="top-center"?{bottom:c+o-a.bottom,left:e-l-a.left}:void 0}_calculatePositionStyle(e,r){const{dockEnabled:i,view:s}=this;if(!s)return;if(i)return{left:"",top:"",right:"",bottom:""};if(C(e)||!r)return;const n=this._calculateFullWidth(r),o=this._calculateAlignmentPosition(e.x,e.y,s,n);return o?{top:o.top!==void 0?`${o.top}px`:"auto",left:o.left!==void 0?`${o.left}px`:"auto",bottom:o.bottom!==void 0?`${o.bottom}px`:"auto",right:o.right!==void 0?`${o.right}px`:"auto"}:void 0}_viewChange(e,r){e&&r&&(this.close(),this.clear())}_viewReadyChange(e,r){if(e){const i=this.get("viewModel.view");this._wireUpView(i)}else r&&(this.close(),this.clear())}_wireUpView(e){if(this._destroySpinner(),!e)return;const{spinnerEnabled:r}=this;r&&this._createSpinner(e),this._setDockEnabledForViewSize(this.dockOptions)}_dockingThresholdCrossed(e,r,i){const[s,n]=e,[o,a]=r,{width:l=0,height:c=0}=i??{};return s<=l&&o>l||s>l&&o<=l||n<=c&&a>c||n>c&&a<=c}_updateDockEnabledForViewSize(e,r){if(!e||!r)return;const i=this.get("viewModel.view.padding")||{left:0,right:0,top:0,bottom:0},s=i.left+i.right,n=i.top+i.bottom,o=[],a=[];o[0]=e[0]-s,o[1]=e[1]-n,a[0]=r[0]-s,a[1]=r[1]-n;const{dockOptions:l}=this,c=l.breakpoint;this._dockingThresholdCrossed(o,a,c)&&this._setDockEnabledForViewSize(l),this._setCurrentDockPosition()}_focusDockButtonNode(e){this._focusDockButton&&(this._focusDockButton=!1,e.focus())}_closeButtonNodeUpdated(e){return this._focusClose?(this._focusClose=!1,void e.focus()):this._blurClose?(this._blurClose=!1,void e.blur()):void 0}_mainContainerNodeUpdated(e){return this._mainContainerNode=e,this._focusContainer?(this._focusContainer=!1,void e.focus()):this._blurContainer?(this._blurContainer=!1,void e.blur()):void 0}_featureMenuNodeUpdated(e){if(this._featureMenuNode=e,!e||!this._focusFirstFeature)return;this._focusFirstFeature=!1;const r=e.querySelectorAll("li");r.length&&r[0].focus()}_actionsMenuNodeUpdated(e){if(this._actionsMenuNode=e,!e||!this._focusFirstAction)return;this._focusFirstAction=!1;const r=e.querySelectorAll("li");r.length&&r[0].focus()}_focusFeatureMenuButtonNode(e){this._focusFeatureMenuButton&&(this._focusFeatureMenuButton=!1,e.focus())}_focusActionsMenuButtonNode(e){this._focusActionsMenuButton&&(this._focusActionsMenuButton=!1,e.focus())}_featureMenuViewportScrollTop(){this._featureMenuViewportNode&&(this._featureMenuViewportNode.scrollTop=0)}_toggleScreenLocationEnabled(){const{dockEnabled:e,viewModel:r}=this;if(!r)return;const i=r.active&&!e;r.screenLocationEnabled=i}_shouldDockAtCurrentViewSize(e){var l,c;const r=e.breakpoint,i=(c=(l=this.viewModel)==null?void 0:l.view)==null?void 0:c.ui;if(!i)return!1;const{width:s,height:n}=i;if(isNaN(s)||isNaN(n)||!r)return!1;const o=r.hasOwnProperty("width")&&s<=(r.width??0),a=r.hasOwnProperty("height")&&n<=(r.height??0);return o||a}_setDockEnabledForViewSize(e){e.breakpoint&&(this.dockEnabled=this._shouldDockAtCurrentViewSize(e))}_getPageText(e,r){return this.featureNavigationVisible?Tf(this.messages.pageText,{index:r+1,total:e}):null}_destroySpinner(){const{_spinner:e,view:r}=this;e&&(r&&r.ui&&r.ui.remove(e,mre),e.destroy(),this._spinner=null)}_createSpinner(e){e&&(this._spinner=new nje({view:e}),e.ui.add(this._spinner,{key:mre,position:"manual"}))}_toggleCollapsed(){this.collapsed=!this.collapsed}_close(){this.close(),this.view&&this.view.focus()}_toggleDockEnabled(){this.dockEnabled=!this.dockEnabled,this._focusDockButton=!0,this.scheduleRender()}_toggleFeatureMenu(){const e=!this.featureMenuOpen;this._featureMenuOpenChanged(e),this.actionsMenuOpen=!1,this.featureMenuOpen=e}_toggleActionsMenu(){const e=!this.actionsMenuOpen;this._actionsMenuOpenChanged(e),this.featureMenuOpen=!1,this.actionsMenuOpen=e}_triggerAction(e){const r=e.currentTarget.dataset.actionUid,{allActions:i}=this.viewModel,s=i.findIndex(o=>o.uid===r),n=i.getItemAt(s);n&&n.type==="toggle"&&(n.value=!n.value),this.actionsMenuOpen=!1,this.viewModel.triggerAction(s)}_selectFeature(e){const r=e.currentTarget["data-feature-index"];isNaN(r)||(this.viewModel.selectedFeatureIndex=r),this.featureMenuOpen=!1,this._focusFeatureMenuButton=!0,this.scheduleRender()}_next(){this.next()}_previous(){this.previous()}};u([d({readOnly:!0})],Dt.prototype,"actionsMenuId",null),u([d({readOnly:!0})],Dt.prototype,"actionsMenuButtonId",null),u([d({readOnly:!0})],Dt.prototype,"featureMenuId",null),u([d({readOnly:!0})],Dt.prototype,"titleId",null),u([d({readOnly:!0})],Dt.prototype,"contentId",null),u([d({readOnly:!0})],Dt.prototype,"hasContent",null),u([d({readOnly:!0})],Dt.prototype,"featureNavigationVisible",null),u([d({readOnly:!0})],Dt.prototype,"collapsible",null),u([d({readOnly:!0})],Dt.prototype,"featureMenuVisible",null),u([d({readOnly:!0})],Dt.prototype,"contentCollapsed",null),u([d({readOnly:!0})],Dt.prototype,"dividedActions",null),u([d({readOnly:!0,dependsOn:["_flowItems.length"]})],Dt.prototype,"_activeFlowItemWidget",null),u([d()],Dt.prototype,"actions",null),u([d()],Dt.prototype,"actionsMenuOpen",null),u([d()],Dt.prototype,"alignment",void 0),u([d()],Dt.prototype,"autoCloseEnabled",null),u([d()],Dt.prototype,"autoOpenEnabled",null),u([d()],Dt.prototype,"defaultPopupTemplateEnabled",null),u([d()],Dt.prototype,"content",null),u([d()],Dt.prototype,"collapsed",void 0),u([d()],Dt.prototype,"collapseEnabled",void 0),u([d({readOnly:!0})],Dt.prototype,"currentAlignment",null),u([d({readOnly:!0})],Dt.prototype,"currentDockPosition",null),u([d()],Dt.prototype,"dockOptions",null),u([d()],Dt.prototype,"dockEnabled",void 0),u([d({readOnly:!0})],Dt.prototype,"featureCount",null),u([d()],Dt.prototype,"featureMenuOpen",void 0),u([d()],Dt.prototype,"features",null),u([d()],Dt.prototype,"goToOverride",null),u([d()],Dt.prototype,"headingLevel",void 0),u([d()],Dt.prototype,"highlightEnabled",null),u([d()],Dt.prototype,"location",null),u([d()],Dt.prototype,"label",null),u([d()],Dt.prototype,"maxInlineActions",void 0),u([d(),ya("esri/widgets/Popup/t9n/Popup")],Dt.prototype,"messages",void 0),u([d(),ya("esri/t9n/common")],Dt.prototype,"messagesCommon",void 0),u([d()],Dt.prototype,"promises",null),u([d({readOnly:!0})],Dt.prototype,"selectedFeature",null),u([d()],Dt.prototype,"selectedFeatureIndex",null),u([d({readOnly:!0})],Dt.prototype,"selectedFeatureWidget",null),u([d()],Dt.prototype,"spinnerEnabled",void 0),u([d()],Dt.prototype,"title",null),u([d()],Dt.prototype,"updateLocationEnabled",null),u([d()],Dt.prototype,"view",null),u([d({type:ove}),Hge(["triggerAction","trigger-action"])],Dt.prototype,"viewModel",void 0),u([d()],Dt.prototype,"visible",null),u([d()],Dt.prototype,"visibleElements",void 0),u([cr("visibleElements")],Dt.prototype,"castVisibleElements",null),u([hu()],Dt.prototype,"_close",null),u([hu()],Dt.prototype,"_toggleDockEnabled",null),u([hu()],Dt.prototype,"_toggleFeatureMenu",null),u([hu()],Dt.prototype,"_toggleActionsMenu",null),u([hu()],Dt.prototype,"_triggerAction",null),u([hu()],Dt.prototype,"_selectFeature",null),u([hu()],Dt.prototype,"_next",null),u([hu()],Dt.prototype,"_previous",null),Dt=u([I("esri.widgets.Popup")],Dt);const vre=Dt,QU=[0,0];function Jje(t){const e=(t.ownerDocument||window.document).defaultView,r=t.getBoundingClientRect();return QU[0]=r.left+((e==null?void 0:e.pageXOffset)??0),QU[1]=r.top+((e==null?void 0:e.pageYOffset)??0),QU}function bre(t){t&&(jpe(t),t.parentNode&&t.parentNode.removeChild(t))}function Kje(t){const e=document.createElement("div");return t.appendChild(e),e}const vC=16,jP=750,Qje=512,eHe=2,tHe=t=>{let e=class extends t{constructor(...r){var i;super(...r),this._freqInfo={freq:vC,time:jP},this._overlayRenderTaskHandle=null,this.height=0,this.overlay=null,this.position=null,this.resizing=!1,this.root=null,this.surface=null,this.suspended=!0,this.ui=null,this.userContent=null,this.width=0,this.widthBreakpoint=null,r.length!==0&&((i=r[0])==null?void 0:i.popup)!==void 0||(this.popup=new vre({view:this})),this.handles.add([ie(()=>this.cursor,s=>{const{surface:n}=this;n&&n.setAttribute("data-cursor",s)}),ie(()=>this.interacting,s=>{const{surface:n}=this;n&&n.setAttribute("data-interacting",s.toString())})])}initialize(){this.handles.add(ie(()=>this.ui,(r,i)=>this._handleUIChange(r,i))),this._wireUI(this.ui),this.handles.add([this.on("focus",()=>this.notifyChange("focused")),this.on("blur",()=>this.notifyChange("focused"))])}destroy(){this.destroyed||(this.ui=ke(this.ui),this.popup&&!this.popup.destroyed&&this.popup.destroy(),this.container=null)}get container(){return this._get("container")??null}set container(r){const i=this._get("container"),s=M4(r);if(s||typeof r!="string"||se.getLogger(this.declaredClass).error("#container",`element with id '${r}' not found`),i===s)return;const n="dom-size";if(this.handles.remove(n),this._stopMeasuring(),i&&(i.classList.remove("esri-view"),this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null),this.overlay&&(this.overlay.destroy(),this._set("overlay",null)),this.root&&(bre(this.root),this._set("root",null)),this.userContent&&(WK(this.userContent,i),bre(this.userContent),this._set("userContent",null))),!s)return this._set("width",0),this._set("height",0),this._set("position",null),this._set("suspended",!0),this._set("surface",null),void this._set("container",null);s.classList.add("esri-view");const o=document.createElement("div");o.className="esri-view-user-storage",WK(s,o),s.appendChild(o),this._set("userContent",o);const a=document.createElement("div");a.className="esri-view-root",s.insertBefore(a,s.firstChild),this._set("root",a);const l=document.createElement("div");l.className="esri-view-surface",l.setAttribute("role","application"),l.tabIndex=0,a.appendChild(l),this._set("surface",l);const c=new OQ;a.appendChild(c.surface),this._set("overlay",c),ie(()=>c.needsRender,h=>{h&&!this._overlayRenderTaskHandle?this._overlayRenderTaskHandle=vS({render:()=>{var p;return(p=this.overlay)==null?void 0:p.render()}}):this._overlayRenderTaskHandle=ji(this._overlayRenderTaskHandle)}),this.forceDOMReadyCycle(),this.handles.add(ie(()=>this.size,h=>{const[p,f]=h,m="esri-view-surface--inset-outline";p>=document.body.clientWidth||f>=document.body.clientHeight?l.classList.add(m):l.classList.remove(m)},Vt),n),this._set("container",s),this._startMeasuring()}get focused(){const r=document.activeElement===this.surface;return document.hasFocus()&&r}set popup(r){const i=this._get("popup");i&&i!==r&&i.destroy(),this._set("popup",r)}get size(){return[this.width,this.height]}blur(){this.surface&&this.surface.blur()}focus(){this.surface&&this.surface.focus()}pageToContainer(r,i,s){const n=this.position;return r-=n?n[0]:0,i-=n?n[1]:0,s?(s[0]=r,s[1]=i):s=[r,i],s}containerToPage(r,i,s){const n=this.position;return r+=n?n[0]:0,i+=n?n[1]:0,s?(s[0]=r,s[1]=i):s=[r,i],s}_handleUIChange(r,i){i&&(this.handles.remove("ui"),i.destroy()),r&&this._wireUI(r),this._set("ui",r)}_wireUI(r){this.handles.remove("ui"),r&&(r.view=this,this.handles.add([ie(()=>this.root,i=>{r.container=i?Kje(i):null},Vt),ie(()=>this.popup,(i,s)=>{const n="popup",o="manual";s&&r.remove(s,n),i&&(i.view=r.view,r.add(i,{key:n,position:o}))},Vt)],"ui"))}_stopMeasuring(){this.handles.remove("measuring"),this._get("resizing")&&this._set("resizing",!1)}_startMeasuring(){const r=this._freqInfo;r.freq=vC,r.time=jP,this.handles.add([(()=>{const i=()=>{r.freq=vC,r.time=jP};return window.addEventListener("resize",i),{remove(){window.removeEventListener("resize",i)}}})(),vS({prepare:i=>{const s=this._measure(),n=this._freqInfo;if(n.time+=i.deltaTime,s&&(n.freq=vC,this._get("resizing")||this._set("resizing",!0)),n.time<n.freq)return;n.time=0;const o=this._position();n.freq=o||s?vC:Math.min(jP,n.freq*eHe),!s&&n.freq>=Qje&&this._get("resizing")&&this._set("resizing",!1)}})],"measuring"),this._measure(),this._position()}_measure(){const r=this.container,i=r?r.clientWidth:0,s=r?r.clientHeight:0;if(i===0||s===0)return this.suspended||this._set("suspended",!0),!1;const n=this.width,o=this.height;return i===n&&s===o?(this.suspended&&this._set("suspended",!1),!1):(this._set("width",i),this._set("height",s),this.suspended&&this._set("suspended",!1),this.emit("resize",{oldWidth:n,oldHeight:o,width:i,height:s}),!0)}_position(){const r=this.container,i=this.position,s=r&&Jje(r);return!!s&&(!i||s[0]!==i[0]||s[1]!==i[1])&&(this._set("position",[s[0],s[1]]),!0)}forceDOMReadyCycle(){}};return u([d()],e.prototype,"container",null),u([d({readOnly:!0})],e.prototype,"focused",null),u([d({readOnly:!0})],e.prototype,"height",void 0),u([d({type:vre})],e.prototype,"popup",null),u([d({type:OQ})],e.prototype,"overlay",void 0),u([d({readOnly:!0})],e.prototype,"position",void 0),u([d({readOnly:!0})],e.prototype,"resizing",void 0),u([d({readOnly:!0})],e.prototype,"root",void 0),u([d({value:null,readOnly:!0})],e.prototype,"size",null),u([d({readOnly:!0})],e.prototype,"surface",void 0),u([d({readOnly:!0})],e.prototype,"suspended",void 0),u([d()],e.prototype,"ui",void 0),u([d({readOnly:!0})],e.prototype,"userContent",void 0),u([d({readOnly:!0})],e.prototype,"width",void 0),u([d()],e.prototype,"widthBreakpoint",void 0),e=u([I("esri.views.DOMContainer")],e),e},XX=se.getLogger("esri.layers.support.ElevationSampler");let ave=class{queryElevation(e){return lve(e.clone(),this)}on(){return oHe}projectIfRequired(e,r){return cve(e,r)}},rHe=class extends ave{get spatialReference(){return this.extent.spatialReference}constructor(e,r,i){super(),this.tile=e,this.noDataValue=i;const s=e.tile.extent;this.extent=b4(s,r.spatialReference),this.extent.zmin=e.zmin,this.extent.zmax=e.zmax,this._aaExtent=s;const n=nl(r.spatialReference),o=r.lodAt(e.tile.level).resolution*n;this.demResolution={min:o,max:o}}contains(e){const r=this.projectIfRequired(e,this.spatialReference);return!C(r)&&this.containsAt(r.x,r.y)}containsAt(e,r){return w4(this._aaExtent,e,r)}elevationAt(e,r){if(!this.containsAt(e,r)){const i=this.extent,s=`${i.xmin}, ${i.ymin}, ${i.xmax}, ${i.ymax}`;return XX.warn("#elevationAt()",`Point used to sample elevation (${e}, ${r}) is outside of the sampler extent (${s})`),this.noDataValue}return It(this.tile.sample(e,r),this.noDataValue)}},gEt=class extends ave{get spatialReference(){return this.extent.spatialReference}constructor(e,r,i){let s;super(),typeof r=="number"?(this.noDataValue=r,s=null):(s=r,this.noDataValue=i),this.samplers=s?e.map(o=>new rHe(o,s,this.noDataValue)):e;const n=this.samplers[0];if(n){this.extent=n.extent.clone();const{min:o,max:a}=n.demResolution;this.demResolution={min:o,max:a};for(let l=1;l<this.samplers.length;l++){const c=this.samplers[l];this.extent.union(c.extent),this.demResolution.min=Math.min(this.demResolution.min,c.demResolution.min),this.demResolution.max=Math.max(this.demResolution.max,c.demResolution.max)}}else this.extent=b4(ur(),s.spatialReference),this.demResolution={min:0,max:0}}elevationAt(e,r){for(const i of this.samplers)if(i.containsAt(e,r))return i.elevationAt(e,r);return XX.warn("#elevationAt()",`Point used to sample elevation (${e}, ${r}) is outside of the sampler`),this.noDataValue}};function lve(t,e){const r=cve(t,e.spatialReference);if(!r)return null;switch(t.type){case"point":iHe(t,r,e);break;case"polyline":sHe(t,r,e);break;case"multipoint":nHe(t,r,e)}return t}function cve(t,e){if(C(t))return null;const r=t.spatialReference;if(r.equals(e))return t;const i=Gw(t,e);return i||XX.error(`Cannot project geometry spatial reference (wkid:${r.wkid}) to elevation sampler spatial reference (wkid:${e.wkid})`),i}function iHe(t,e,r){t.z=r.elevationAt(e.x,e.y)}function sHe(t,e,r){Pf.spatialReference=e.spatialReference;const i=t.hasM&&!t.hasZ;for(let s=0;s<t.paths.length;s++){const n=t.paths[s],o=e.paths[s];for(let a=0;a<n.length;a++){const l=n[a],c=o[a];Pf.x=c[0],Pf.y=c[1],i&&(l[3]=l[2]),l[2]=r.elevationAt(Pf.x,Pf.y)}}t.hasZ=!0}function nHe(t,e,r){Pf.spatialReference=e.spatialReference;const i=t.hasM&&!t.hasZ;for(let s=0;s<t.points.length;s++){const n=t.points[s],o=e.points[s];Pf.x=o[0],Pf.y=o[1],i&&(n[3]=n[2]),n[2]=r.elevationAt(Pf.x,Pf.y)}t.hasZ=!0}const Pf=new mt,oHe={remove(){}};var tG;let cf=tG=class extends ve{constructor(t){super(t),this.cols=null,this.level=0,this.levelValue=null,this.origin=null,this.resolution=0,this.rows=null,this.scale=0}clone(){return new tG({cols:this.cols,level:this.level,levelValue:this.levelValue,resolution:this.resolution,rows:this.rows,scale:this.scale})}};u([d({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],cf.prototype,"cols",void 0),u([d({type:Gi,json:{write:!0}})],cf.prototype,"level",void 0),u([d({type:String,json:{write:!0}})],cf.prototype,"levelValue",void 0),u([d({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],cf.prototype,"origin",void 0),u([d({type:Number,json:{write:!0}})],cf.prototype,"resolution",void 0),u([d({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],cf.prototype,"rows",void 0),u([d({type:Number,json:{write:!0}})],cf.prototype,"scale",void 0),cf=tG=u([I("esri.layers.support.LOD")],cf);const Gd=cf;let aHe=class{constructor(e,r,i,s,n){this.id=e,this.level=r,this.row=i,this.col=s,this.extent=n}};var N0;const wre=new mr({PNG:"png",PNG8:"png8",PNG24:"png24",PNG32:"png32",JPEG:"jpg",JPG:"jpg",DIB:"dib",TIFF:"tiff",EMF:"emf",PS:"ps",PDF:"pdf",GIF:"gif",SVG:"svg",SVGZ:"svgz",Mixed:"mixed",MIXED:"mixed",LERC:"lerc",LERC2D:"lerc2d",RAW:"raw",pbf:"pbf"});let _o=N0=class extends ve{static create(t={}){const{resolutionFactor:e=1,scales:r,size:i=256,spatialReference:s=et.WebMercator,numLODs:n=24}=t;if(!pa(s)){const p=[];if(r)for(let f=0;f<r.length;f++){const m=r[f];p.push(new Gd({level:f,scale:m,resolution:m}))}else{let f=5e-4;for(let m=n-1;m>=0;m--)p.unshift(new Gd({level:m,scale:f,resolution:f})),f*=2}return new N0({dpi:96,lods:p,origin:new mt(0,0,s),size:[i,i],spatialReference:s})}const o=I_(s),a=t.origin?new mt({x:t.origin.x,y:t.origin.y,spatialReference:s}):new mt(o?{x:o.origin[0],y:o.origin[1],spatialReference:s}:{x:0,y:0,spatialReference:s}),l=96,c=1/(nl(s)*39.37*l),h=[];if(r)for(let p=0;p<r.length;p++){const f=r[p],m=f*c;h.push(new Gd({level:p,scale:f,resolution:m}))}else{let p=uhe(s)?512/i*5916575275917094e-7:256/i*591657527591555e-6;const f=Math.ceil(n/e);h.push(new Gd({level:0,scale:p,resolution:p*c}));for(let m=1;m<f;m++){const y=p/2**e,_=y*c;h.push(new Gd({level:m,scale:y,resolution:_})),p=y}}return new N0({dpi:l,lods:h,origin:a,size:[i,i],spatialReference:s})}constructor(t){super(t),this.dpi=96,this.format=null,this.origin=null,this.minScale=0,this.maxScale=0,this.size=null,this.spatialReference=null}get isWrappable(){const{spatialReference:t,origin:e}=this;if(t&&e){const r=I_(t);return t.isWrappable&&!!r&&Math.abs(r.origin[0]-e.x)<=r.dx}return!1}readOrigin(t,e){return mt.fromJSON({spatialReference:e.spatialReference,...t})}set lods(t){let e=0,r=0;const i=[],s=this._levelToLOD={};t&&(e=-1/0,r=1/0,t.forEach(n=>{i.push(n.scale),e=n.scale>e?n.scale:e,r=n.scale<r?n.scale:r,s[n.level]=n})),this._set("scales",i),this._set("minScale",e),this._set("maxScale",r),this._set("lods",t),this._initializeUpsampleLevels()}readSize(t,e){return[e.cols,e.rows]}writeSize(t,e){e.cols=t[0],e.rows=t[1]}zoomToScale(t){const e=this.scales;if(t<=0)return e[0];if(t>=e.length-1)return e[e.length-1];const r=Math.floor(t),i=r+1;return e[r]/(e[r]/e[i])**(t-r)}scaleToZoom(t){const e=this.scales,r=e.length-1;let i=0;for(;i<r;i++){const s=e[i],n=e[i+1];if(s<=t)return i;if(n===t)return i+1;if(s>t&&n<t)return i+Math.log(s/t)/Math.log(s/n)}return i}snapScale(t,e=.95){const r=this.scaleToZoom(t);return r%Math.floor(r)>=e?this.zoomToScale(Math.ceil(r)):this.zoomToScale(Math.floor(r))}tileAt(t,e,r,i){const s=this.lodAt(t);if(!s)return null;let n,o;if(typeof e=="number")n=e,o=r;else if(Tn(e.spatialReference,this.spatialReference))n=e.x,o=e.y,i=r;else{const c=Gw(e,this.spatialReference);if(C(c))return null;n=c.x,o=c.y,i=r}const a=s.resolution*this.size[0],l=s.resolution*this.size[1];return i||(i=new aHe(null,0,0,0,ur())),i.level=t,i.row=Math.floor((this.origin.y-o)/l+.001),i.col=Math.floor((n-this.origin.x)/a+.001),this.updateTileInfo(i),i}updateTileInfo(t,e=N0.ExtrapolateOptions.NONE){let r=this.lodAt(t.level);if(!r&&e===N0.ExtrapolateOptions.POWER_OF_TWO){const o=this.lods[this.lods.length-1];o.level<t.level&&(r=o)}if(!r)return;const i=t.level-r.level,s=r.resolution*this.size[0]/2**i,n=r.resolution*this.size[1]/2**i;t.id=`${t.level}/${t.row}/${t.col}`,t.extent||(t.extent=ur()),t.extent[0]=this.origin.x+t.col*s,t.extent[1]=this.origin.y-(t.row+1)*n,t.extent[2]=t.extent[0]+s,t.extent[3]=t.extent[1]+n}upsampleTile(t){const e=this._upsampleLevels[t.level];return!(!e||e.parentLevel===-1)&&(t.level=e.parentLevel,t.row=Math.floor(t.row/e.factor+.001),t.col=Math.floor(t.col/e.factor+.001),this.updateTileInfo(t),!0)}getTileBounds(t,e){const r=this.lodAt(e.level);if(r==null)return null;const{resolution:i}=r,s=i*this.size[0],n=i*this.size[1];return t[0]=this.origin.x+e.col*s,t[1]=this.origin.y-(e.row+1)*n,t[2]=t[0]+s,t[3]=t[1]+n,t}lodAt(t){var e;return((e=this._levelToLOD)==null?void 0:e[t])??null}clone(){return N0.fromJSON(this.write({}))}getOrCreateCompatible(t,e){if(this.size[0]===256&&this.size[1]===256)return t===256?this:null;const r=[],i=this.lods.length;for(let s=0;s<i;s++){const n=this.lods[s],o=n.resolution*e;r.push(new Gd({level:n.level,scale:n.scale,resolution:o}))}return new N0({size:[t,t],dpi:this.dpi,format:this.format,compressionQuality:this.compressionQuality,origin:this.origin,spatialReference:this.spatialReference,lods:r})}_initializeUpsampleLevels(){const t=this.lods;this._upsampleLevels=[];let e=null;for(let r=0;r<t.length;r++){const i=t[r];this._upsampleLevels[i.level]={parentLevel:e?e.level:-1,factor:e?e.resolution/i.resolution:0},e=i}}};u([d({type:Number,json:{write:!0}})],_o.prototype,"compressionQuality",void 0),u([d({type:Number,json:{write:!0}})],_o.prototype,"dpi",void 0),u([d({type:String,json:{read:wre.read,write:wre.write,origins:{"web-scene":{read:!1,write:!1}}}})],_o.prototype,"format",void 0),u([d({readOnly:!0})],_o.prototype,"isWrappable",null),u([d({type:mt,json:{write:!0}})],_o.prototype,"origin",void 0),u([Fe("origin")],_o.prototype,"readOrigin",null),u([d({type:[Gd],value:null,json:{write:!0}})],_o.prototype,"lods",null),u([d({readOnly:!0})],_o.prototype,"minScale",void 0),u([d({readOnly:!0})],_o.prototype,"maxScale",void 0),u([d({readOnly:!0})],_o.prototype,"scales",void 0),u([d({cast:t=>Array.isArray(t)?t:typeof t=="number"?[t,t]:[256,256]})],_o.prototype,"size",void 0),u([Fe("size",["rows","cols"])],_o.prototype,"readSize",null),u([He("size",{cols:{type:Gi},rows:{type:Gi}})],_o.prototype,"writeSize",null),u([d({type:et,json:{write:!0}})],_o.prototype,"spatialReference",void 0),_o=N0=u([I("esri.layers.support.TileInfo")],_o),function(t){var e;(e=t.ExtrapolateOptions||(t.ExtrapolateOptions={}))[e.NONE=0]="NONE",e[e.POWER_OF_TWO=1]="POWER_OF_TWO"}(_o||(_o={}));const YL=_o,lHe=12;let Tc=class Sl{constructor(e){const r=Sl.checkUnsupported(e);if(v(r))throw r;const i=e;this.spatialReference=i.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=vw(this.spatialReference)||fm(this.spatialReference)||mm(this.spatialReference),this.origin=[i.origin.x,i.origin.y],this.pixelSize=i.size[0],this.dpi=i.dpi;const s=i.lods.reduce((c,h,p)=>(h.level<c.min&&(c.min=h.level,c.minIndex=p),c.max=Math.max(c.max,h.level),c),{min:1/0,minIndex:0,max:-1/0}),n=i.lods[s.minIndex],o=2**n.level;let a=n.resolution*o,l=n.scale*o;this.levels=new Array(s.max+1);for(let c=0;c<this.levels.length;c++)this.levels[c]={resolution:a,scale:l,tileSize:[a*i.size[0],a*i.size[1]]},a/=2,l/=2}clone(){return new Sl(this.toTileInfo())}toTileInfo(){return new YL({dpi:this.dpi,origin:new mt({x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference}),size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map((e,r)=>new Gd({level:r,scale:e.scale,resolution:e.resolution}))})}getExtent(e,r,i,s){const n=this.levels[e],o=n.tileSize[0],a=n.tileSize[1];s[0]=this.origin[0]+i*o,s[2]=this.origin[0]+(i+1)*o,s[3]=this.origin[1]-r*a,s[1]=this.origin[1]-(r+1)*a}convertExtentToRadians(e,r){this._isWebMercator?(r[0]=mK(e[0]),r[1]=tN(e[1]),r[2]=mK(e[2]),r[3]=tN(e[3])):this._isGCS&&(r[0]=Gt(e[0]),r[1]=Gt(e[1]),r[2]=Gt(e[2]),r[3]=Gt(e[3]))}getExtentGeometry(e,r,i,s=new Zr){return this.getExtent(e,r,i,Mp),s.spatialReference=this.spatialReference,s.xmin=Mp[0],s.ymin=Mp[1],s.xmax=Mp[2],s.ymax=Mp[3],s.zmin=void 0,s.zmax=void 0,s}ensureMaxLod(e){if(e==null)return!1;let r=!1;for(;this.levels.length<=e;){const i=this.levels[this.levels.length-1],s=i.resolution/2;this.levels.push({resolution:s,scale:i.scale/2,tileSize:[s*this.pixelSize,s*this.pixelSize]}),r=!0}return r}capMaxLod(e){this.levels.length>e+1&&(this.levels.length=e+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(e){return this.levels[0].scale/2**e}levelAtScale(e){const r=this.levels[0].scale;return e>=r?0:Math.log(r/e)*Math.LOG2E}resolutionAtLevel(e){return this.levels[0].resolution/2**e}compatibleWith(e){if(!(e instanceof Sl)){if(Sl.checkUnsupported(e))return!1;e=new Sl(e)}if(!e.spatialReference.equals(this.spatialReference)||e.pixelSize!==this.pixelSize)return!1;const r=Math.min(this.levels.length,e.levels.length)-1,i=this.levels[r].resolution;let s=.5*i;return!H2(e.origin[0],this.origin[0],s)||!H2(e.origin[1],this.origin[1],s)?!1:(s=.5*i/2**r/this.pixelSize*lHe,H2(i,e.levels[r].resolution,s))}rootTilesInExtent(e,r=null,i=1/0){const s=new Array,n=this.levels[0].tileSize;if(C(e)||n[0]===0||n[1]===0)return s;Sl.computeRowColExtent(e,n,this.origin,Mp);let o=Mp[1],a=Mp[3],l=Mp[0],c=Mp[2];const h=c-l,p=a-o;if(h*p>i){const f=Math.floor(Math.sqrt(i));p>f&&(o=o+Math.floor(.5*p)-Math.floor(.5*f),a=o+f),h>f&&(l=l+Math.floor(.5*h)-Math.floor(.5*f),c=l+f)}for(let f=o;f<a;f++)for(let m=l;m<c;m++)s.push([0,f,m]);return v(r)&&(r[0]=this.origin[0]+l*n[0],r[1]=this.origin[1]-a*n[1],r[2]=this.origin[0]+c*n[0],r[3]=this.origin[1]-o*n[1]),s}static computeRowColExtent(e,r,i,s){const n=.001*(e[2]-e[0]+(e[3]-e[1]));s[0]=Math.max(0,Math.floor((e[0]+n-i[0])/r[0])),s[2]=Math.max(0,Math.ceil((e[2]-n-i[0])/r[0])),s[1]=Math.max(0,Math.floor((i[1]-e[3]+n)/r[1])),s[3]=Math.max(0,Math.ceil((i[1]-e[1]-n)/r[1]))}static isPowerOfTwo(e){const r=e.lods,i=r[0].resolution*2**r[0].level;return!r.some(s=>!CPe(s.resolution,i/2**s.level))}static hasGapInLevels(e){const r=e.lods.map(i=>i.level);r.sort((i,s)=>i-s);for(let i=1;i<r.length;i++)if(r[i]!==r[0]+i)return!0;return!1}static tileSizeSupported(e){const r=e.size[1];return r===e.size[0]&&(r&r-1)==0&&r>=128&&r<=512}static hasOriginPerLODs(e){const r=e.origin;return e.lods.some(i=>i.origin!=null&&(i.origin[0]!==r.x||i.origin[1]!==r.y))}static getMissingTileInfoError(){return new q("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static checkUnsupported(e){return C(e)?YX():e.lods.length<1?new q("tilingscheme:generic","Tiling scheme must have at least one level"):Sl.isPowerOfTwo(e)?Sl.hasGapInLevels(e)?new q("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):Sl.tileSizeSupported(e)?Sl.hasOriginPerLODs(e)?new q("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new q("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new q("tilingscheme:power-of-two","Tiling scheme must be power of two")}static fromExtent(e,r){const i=e[2]-e[0],s=e[3]-e[1],n=nl(r),o=1.2*Math.max(i,s),a=256,l=96,c=.0254,h=new Sl(new YL({size:[a,a],origin:new mt({x:e[0]-.5*(o-i),y:e[3]+.5*(o-s)}),lods:[new Gd({level:0,resolution:o/a,scale:1/(a/l*c/(o*n))})],spatialReference:r}));return h.ensureMaxLod(20),h}static makeWebMercatorAuxiliarySphere(e){const r=new Sl(Sl.WebMercatorAuxiliarySphereTileInfo);return r.ensureMaxLod(e),r}static makeGCSWithTileSize(e,r=256,i=16){const s=256/r,n=new Sl(new YL({size:[r,r],origin:new mt({x:-180,y:90,spatialReference:e}),spatialReference:e,lods:[new Gd({level:0,resolution:.703125*s,scale:295497598570834e-6*s})]}));return n.ensureMaxLod(i),n}get test(){return{isWebMercator:this._isWebMercator,isGCS:this._isGCS}}};function YX(){return new q("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}Tc.WebMercatorAuxiliarySphereTileInfo=new YL({size:[256,256],origin:new mt({x:-20037508342787e-6,y:20037508342787e-6,spatialReference:et.WebMercator}),spatialReference:et.WebMercator,lods:[new Gd({level:0,resolution:156543.03392800014,scale:591657527591555e-6})]}),Tc.WebMercatorAuxiliarySphere=Tc.makeWebMercatorAuxiliarySphere(19);const Mp=ur(),E2=64,t3=512,cHe=2.5,oO=APe(yV/10),uve=2,hve=ur();Tc.WebMercatorAuxiliarySphere.getExtent(0,0,0,hve);const uHe=ur([-180,-90,180,90]),hHe="Cannot extend surface to encompass all layers because it would result in too many root tiles.",dHe="Surface extent is too large for tile resolution at level 0.",pHe=3;let fHe=pHe;function rG(t){return t<4?3:fHe}let F0=class extends vs.EventedAccessor{constructor(e){super(e),this.demResolution={min:-1,max:-1},this.noDataValue=oO}initialize(){this.view.basemapTerrain.on("elevation-change",()=>this.emit("changed",{}))}get extent(){const e=this.view.basemapTerrain;if(e==null||C(e.extent)||C(e.spatialReference))return null;const r=b4(e.extent,e.spatialReference);return r.zmin=e.visibleElevationBounds.min,r.zmax=e.visibleElevationBounds.max,r}get spatialReference(){var e;return It((e=this.view.basemapTerrain)==null?void 0:e.spatialReference,et.WGS84)}elevationAt(e,r){var i;if(C(this.extent)||!ja(this.extent,e,r)){const s=v(this.extent)?`${this.extent.xmin}, ${this.extent.ymin}, ${this.extent.xmax}, ${this.extent.ymax}`:null;return se.getLogger(this.declaredClass).warn("#elevationAt()",`Point used to sample elevation (${e}, ${r}) is outside of the sampler extent (${s})`),this.noDataValue}return It((i=this.view.elevationProvider)==null?void 0:i.getElevation(e,r,0,this.spatialReference,"ground"),this.noDataValue)}queryElevation(e){return lve(e.clone(),this)}};u([d({readOnly:!0})],F0.prototype,"demResolution",void 0),u([d({readOnly:!0})],F0.prototype,"extent",null),u([d({readOnly:!0})],F0.prototype,"noDataValue",void 0),u([d()],F0.prototype,"spatialReference",null),u([d({constructOnly:!0})],F0.prototype,"view",void 0),F0=u([I("esri.views.support.GroundViewElevationSampler")],F0);const mHe=F0;let U0=class extends Te{constructor(e){super(e),this._handles=new ei,this.view=null,this.layerViews=new Pt}initialize(){this._handles.add(_a(()=>{var e,r;return(r=(e=this.view)==null?void 0:e.map)==null?void 0:r.ground},e=>e.load())),this._handles.add(this.layerViews.on("after-changes",()=>this._layerViewsAfterChangesHandler()))}destroy(){this._set("view",null),this._handles&&(this._handles.destroy(),this._handles=null)}get elevationSampler(){return this.view?this.view.type==="2d"?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new mHe({view:this.view}):null:null}get updating(){return!this.suspended&&this.layerViews.some(e=>e.updating)}get suspended(){return!this.view||this.view.suspended}_layerViewsAfterChangesHandler(){this._handles.remove("updating"),this._handles.add(this.layerViews.map(e=>ie(()=>e.updating,()=>this._updateUpdating(),ri)).toArray(),"updating"),this._updateUpdating()}_updateUpdating(){this.notifyChange("updating")}};u([d({readOnly:!0})],U0.prototype,"elevationSampler",null),u([d({type:Boolean,readOnly:!0})],U0.prototype,"updating",null),u([d({constructOnly:!0})],U0.prototype,"view",void 0),u([d({type:Pt,readOnly:!0})],U0.prototype,"layerViews",void 0),u([d({readOnly:!0})],U0.prototype,"suspended",null),U0=u([I("esri.views.GroundView")],U0);const gHe=U0,yHe=t=>{let e=class extends t{async fetchPopupFeatures(r,i){await this.when();const{location:s,queryArea:n,layerViewsAndGraphics:o,clientOnlyGraphics:a}=await this._prepareFetchPopupFeatures(r,i),l=Promise.resolve(a),c=this._queryLayerPopupFeatures(n,o,i),h=c.map(p=>p.promise);return{location:s,clientOnlyGraphics:a,allGraphicsPromise:Bk([l,...h]).then(p=>Array.from(new Set(p.flat()))),promisesPerLayerView:c}}_queryLayerPopupFeatures(r,i,s){return i.map(({layerView:n,graphics:o})=>{const a={clientGraphics:o,event:v(s)?s.event:void 0,signal:v(s)?s.signal:void 0,defaultPopupTemplateEnabled:!!v(s)&&!!s.defaultPopupTemplateEnabled},l=n.fetchPopupFeatures(r,a);return{layerView:n,promise:l}})}_isValidPopupGraphic(r,i){return r&&!!r.getEffectivePopupTemplate(v(i)&&i.defaultPopupTemplateEnabled)}async _prepareFetchPopupFeatures(r,i){const{clientGraphics:s,queryArea:n,location:o}=await this._popupHitTestGraphics(r,i),a=this._getFetchPopupLayerViews(),{layerViewsAndGraphics:l,clientOnlyGraphics:c}=this._graphicsPerFetchPopupLayerView(s,a);return{clientOnlyGraphics:c,layerViewsAndGraphics:l,queryArea:n,location:o}}async _popupHitTestGraphics(r,i){const s=await this.popupHitTest(r),n=s.results,o=s.mapPoint,a=n.filter(c=>c.type==="graphic"&&this._isValidPopupGraphic(c.graphic,i)),l=a.length?a[0].mapPoint:null;return{clientGraphics:a.map(c=>c.graphic),queryArea:o,location:o||l}}_getFetchPopupLayerViews(){const r=[];return this.allLayerViews.forEach(i=>{this._isValidPopupLayerView(i)&&r.push(i)}),v(this.graphicsView)&&this._isValidPopupLayerView(this.graphicsView)&&r.push(this.graphicsView),r.reverse()}_isValidPopupLayerView(r){return v(r)&&(!("layer"in r)||!r.suspended)&&"fetchPopupFeatures"in r}_graphicsPerFetchPopupLayerView(r,i){const s=[],n=new Map,o=i.map(a=>{const l=[];return"layer"in a?n.set(a.layer,l):n.set(a.graphics,l),{layerView:a,graphics:l}});for(const a of r){const l=n.get(a.layer)||n.get(a.sourceLayer)||null;l?l.push(a):s.push(a)}return{layerViewsAndGraphics:o,clientOnlyGraphics:s}}};return e=u([I("esri.views.PopupView")],e),e};let aR=class extends q3{_own(e){e.layer&&"remove"in e.layer&&e.layer!==this.owner&&e.layer.remove(e),e.layer=this.owner}_release(e){e.layer===this.owner&&(e.layer=null)}};u([rq({Type:Io,ensureType:us(Io)})],aR.prototype,"itemType",void 0),aR=u([I("esri.support.GraphicsCollection")],aR);let k0=class extends Te{constructor(e){super(e),this.view=null,this.baseLayerViews=new Pt,this.referenceLayerViews=new Pt,this._loadingHandle=ie(()=>{var r,i;return(i=(r=this.view)==null?void 0:r.map)==null?void 0:i.basemap},r=>{r&&r.load().catch(()=>{})},Vt)}destroy(){this._set("view",null),this._loadingHandle&&(this._loadingHandle.remove(),this._loadingHandle=null)}get suspended(){return!this.view||this.view.suspended}get updating(){var r,i;if(this.view&&this.view.suspended)return!1;const e=(i=(r=this.view)==null?void 0:r.map)==null?void 0:i.basemap;return!!e&&!!e.loaded&&(this.baseLayerViews.some(s=>s.updating)||this.referenceLayerViews.some(s=>s.updating))}};u([d({constructOnly:!0})],k0.prototype,"view",void 0),u([d({readOnly:!0})],k0.prototype,"baseLayerViews",void 0),u([d({readOnly:!0})],k0.prototype,"referenceLayerViews",void 0),u([d({readOnly:!0})],k0.prototype,"suspended",null),u([d({type:Boolean,readOnly:!0})],k0.prototype,"updating",null),k0=u([I("esri.views.BasemapView")],k0);function _He(t){return"tryRecycleWith"in t}let vHe=class{constructor(e,r,i){this.layer=e,this.view=r,this.layerViewImporter=i,this._controller=new AbortController,this._deferred=j_(),this._started=!1,this.done=!1,this.promise=this._deferred.promise,fa(this._controller.signal,()=>{const s=new q("cancelled:layerview-create","layerview creation cancelled",{layer:e});this._deferred.reject(s)})}tryRecycle(e){if(!this.done||!this.layerView||!_He(this.layerView))return null;const r=this.layer.type,i=this._controller.signal;for(let s=0;s<e.length;s++){const n=e[s];if(n.type!==r)continue;const o=this.layerView.tryRecycleWith(n,{signal:i});if(o){e.splice(s,1),this.layer=n;const a=this.layerView,l=a.view;return this.promise=Promise.race([o.then(()=>(fr(this._controller.signal),n.emit("layerview-destroy",{view:l,layerView:a}),l.emit("layerview-destroy",{view:l,layerView:a}),n.emit("layerview-create",{view:l,layerView:a}),l.emit("layerview-create",{view:l,layerView:a}),a)),new Promise((c,h)=>fa(this._controller.signal,()=>h(Hr())))]),this.promise}}return null}destroy(){this._controller.abort();const{layerView:e}=this;if(!e)return;const{layer:r,view:i}=this;r.emit("layerview-destroy",{view:i,layerView:e}),i.emit("layerview-destroy",{layer:r,layerView:e}),this.done=!0,this.layer=null,this.layerView=null,this.view=null,this.layerViewImporter=null}async start(){var s,n,o;if(this._started)return;this._started=!0;const{_controller:{signal:e},layer:r,view:i}=this;this._map=i.map;try{let a,l;if(await r.load({signal:e}),"prefetchResources"in r&&await((s=r.prefetchResources)==null?void 0:s.call(r,{signal:e})),wHe(r))a=await r.createLayerView(i,{signal:e});else{if(!this.layerViewImporter.hasLayerViewModule(r))throw new q("layer:view-not-supported","No layerview implementation was found");const p=await this.layerViewImporter.importLayerView(r);fr(e),a="default"in p?new p.default({layer:r,view:i}):new p({layer:r,view:i})}const c=()=>{l=ji(l),a.destroyed||a.destroy(),a.layer=null,a.parent=null,a.view=null,this.done=!0};l=fa(e,c),fr(e);try{await a.when()}catch(p){throw c(),p}if(!((o=(n=this._map)==null?void 0:n.allLayers)==null?void 0:o.includes(r)))return c(),void this._deferred.reject(new q("view:no-layerview-for-layer","The layer has been removed from the map",{layer:r}));this.layerView=a,r.emit("layerview-create",{view:i,layerView:a}),i.emit("layerview-create",{layer:r,layerView:a}),this.done=!0,this._deferred.resolve(a)}catch(a){r.emit("layerview-create-error",{view:i,error:a}),i.emit("layerview-create-error",{layer:r,error:a}),this.done=!0,this._deferred.reject(new q("layerview:create-error","layerview creation failed",{layer:r,error:a}))}}},ah=class extends Te{constructor(e){super(e),this._layerLayerViewInfoMap=new Map,this._recyclingInfoMap=new Map,this._watchUpdatingTracking=new Hf,this.supportsGround=!0,this._preloadLayerViewModules=()=>{var i;const r=(i=this.view.map)==null?void 0:i.allLayers;if(r)for(const s of r)this.layerViewImporter.hasLayerViewModule(s)&&this.layerViewImporter.importLayerView(s)},this._reschedule=()=>(C(this._workPromise)&&(this._workPromise=j_(),this._workPromise.promise.catch(()=>{})),this.removeHandles("reschedule"),this.addHandles(gE(this._doWork),"reschedule"),this._workPromise.promise),this._doWork=()=>{var l,c,h;const r=this.view.map;if(this._map!==r&&(this.clear(),this._map=r),C(this._workPromise))return void this.notifyChange("updating");this.removeHandles("reschedule"),this.removeHandles("collection-change");const i=new Set,s=[],n=this.view.ready,o=p=>{if(!C(p)){for(const f of p)if(f){i.add(f);const m=this._layerLayerViewInfoMap.get(f);m&&n?m.start():m||this._recyclingInfoMap.has(f)||s.push(f),"layers"in f&&f.layers&&o(f.layers)}}};for(const p of this._rootCollectionNames)o(this.get(p));for(const[p,f]of this._layerLayerViewInfoMap)if(!i.has(p)){this._layerLayerViewInfoMap.delete(f.layer);const m=f.tryRecycle(s);m?(this._recyclingInfoMap.set(f.layer,f),m.then(()=>{this._recyclingInfoMap.delete(f.layer),this._layerLayerViewInfoMap.set(f.layer,f),this._reschedule()}).catch(()=>{this._recyclingInfoMap.delete(f.layer),f.destroy(),this._reschedule()})):f.destroy()}for(const[p,f]of this._recyclingInfoMap)i.has(p)||(this._recyclingInfoMap.delete(f.layer),f.destroy());for(const p of s)this._createLayerView(p);this._refreshCollections();const a=[(l=r==null?void 0:r.ground)==null?void 0:l.layers,(c=r==null?void 0:r.basemap)==null?void 0:c.baseLayers,(h=r==null?void 0:r.basemap)==null?void 0:h.referenceLayers,r==null?void 0:r.layers].filter(p=>!!p);i.forEach(p=>"layers"in p&&a.push(p.layers)),this.addHandles(a.map(p=>this._watchUpdatingTracking.addOnCollectionChange(()=>p,this._reschedule)),"collection-change"),this._workPromise.resolve(),this._workPromise=null}}initialize(){this.own([sn(()=>{var e,r;return(r=(e=this.view)==null?void 0:e.map)==null?void 0:r.allLayers},"change",this._preloadLayerViewModules,{onListenerAdd:this._preloadLayerViewModules}),ie(()=>{const e=this.view,r=e==null?void 0:e.map;return[r==null?void 0:r.basemap,r==null?void 0:r.ground,r==null?void 0:r.layers,e==null?void 0:e.ready]},()=>this._reschedule(),js)]),this._preloadLayerViewModules(),this._reschedule()}destroy(){this.clear(),this._watchUpdatingTracking.destroy(),this._map=null,v(this._workPromise)&&(this._workPromise.reject(Hr()),this._workPromise=null)}get _layersToLayerViews(){const e=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.layers","view.layerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"]];return this.supportsGround&&e.push(["view.map.ground.layers","view.groundView.layerViews"]),new Map(e)}get _rootCollectionNames(){return Array.from(this._layersToLayerViews.keys())}get updating(){return v(this._workPromise)||this._watchUpdatingTracking.updating||Ho(this._layerLayerViewInfoMap,e=>!e.done)}get updatingRemaining(){let e=0;for(const r of this._layerLayerViewInfoMap.values())r.done||++e;return e}clear(){if(!this.destroyed){for(const e of this._layerLayerViewInfoMap.values())e.destroy();this._layerLayerViewInfoMap.clear(),this._refreshCollections()}}async whenLayerView(e){if(await this._reschedule(),!this._layerLayerViewInfoMap.has(e)){if(this._recyclingInfoMap.has(e))return this._recyclingInfoMap.get(e).promise;throw new q("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:e})}return this._layerLayerViewInfoMap.get(e).promise}_refreshCollections(){for(const[e,r]of this._layersToLayerViews)this._populateLayerViewsOwners(this.get(e),this.get(r),this.view);this.notifyChange("updating"),this.notifyChange("updatingRemaining")}_populateLayerViewsOwners(e,r,i){if(!e||!r)return void(r&&r.removeAll());let s=0;for(const n of e){const o=this._layerLayerViewInfoMap.get(n);if(!o||!o.layerView)continue;const a=o.layerView;a.layer=n,a.parent=i,r.getItemAt(s)!==a&&r.splice(s,0,a),n.layers&&this._populateLayerViewsOwners(n.layers,a.layerViews,a),s+=1}s<r.length&&r.splice(s,r.length)}_createLayerView(e){e.load().catch(()=>{}),this.layerViewImporter.hasLayerViewModule(e)&&this.layerViewImporter.importLayerView(e);const r=new vHe(e,this.view,this.layerViewImporter);r.promise.then(()=>this._refreshCollections(),i=>{i&&(Qs(i)||i.name==="cancelled:layerview-create")||se.getLogger(this.declaredClass).error(`Failed to create layerview for layer title:'${e.title??"no title"}', id:'${e.id??"no id"}' of type '${e.type}'.`,{layer:e,error:i}),this._refreshCollections()}),this._layerLayerViewInfoMap.set(e,r),this.view.ready&&r.start(),this.notifyChange("updating"),this.notifyChange("updatingRemaining")}};u([d()],ah.prototype,"_workPromise",void 0),u([d({readOnly:!0})],ah.prototype,"_watchUpdatingTracking",void 0),u([d({readOnly:!0})],ah.prototype,"_layersToLayerViews",null),u([d({readOnly:!0})],ah.prototype,"_rootCollectionNames",null),u([d()],ah.prototype,"layerViewImporter",void 0),u([d()],ah.prototype,"supportsGround",void 0),u([d({readOnly:!0})],ah.prototype,"updating",null),u([d({readOnly:!0})],ah.prototype,"updatingRemaining",null),u([d({constructOnly:!0})],ah.prototype,"view",void 0),ah=u([I("esri.views.LayerViewManager")],ah);const bHe=ah;function wHe(t){return"createLayerView"in t&&t.createLayerView!=null}let tu=class extends Te{constructor(e){super(e),this.factor=1.5,this.offset=Bh(0,0),this.position=null,this.size=120,this.maskUrl=null,this.maskEnabled=!0,this.overlayUrl=null,this.overlayEnabled=!0,this.visible=!0}get version(){return this.commitProperty("factor"),this.commitProperty("offset"),this.commitProperty("position"),this.commitProperty("visible"),this.commitProperty("size"),this.commitProperty("maskUrl"),this.commitProperty("maskEnabled"),this.commitProperty("overlayUrl"),this.commitProperty("overlayEnabled"),(this._get("version")||0)+1}};u([d({type:Number})],tu.prototype,"factor",void 0),u([d({nonNullable:!0})],tu.prototype,"offset",void 0),u([d()],tu.prototype,"position",void 0),u([d({type:Number,range:{min:0}})],tu.prototype,"size",void 0),u([d()],tu.prototype,"maskUrl",void 0),u([d()],tu.prototype,"maskEnabled",void 0),u([d()],tu.prototype,"overlayUrl",void 0),u([d()],tu.prototype,"overlayEnabled",void 0),u([d({readOnly:!0})],tu.prototype,"version",null),u([d({type:Boolean})],tu.prototype,"visible",void 0),tu=u([I("esri.views.Magnifier")],tu);const dve=tu;let xHe=class{constructor(){this._tasks=new Array,this._running=new WN(!1)}get length(){return this._tasks.length}get running(){return this._running.get()}destroy(){this.cancelAll()}runTask(e){for(;!e.done&&this._process(e);)e.madeProgress()}push(e,r,i){return this._running.set(!0),new Promise((s,n)=>this._tasks.push(new xre(s,n,e,r,i)))}unshift(e,r,i){return this._running.set(!0),new Promise((s,n)=>this._tasks.unshift(new xre(s,n,e,r,i)))}_process(e){var i;if(this._tasks.length===0)return!1;const r=this._tasks.shift();try{const s=Ln(r.signal);if(s&&!r.abortCallback)r.reject(Hr());else{const n=s?(i=r.abortCallback)==null?void 0:i.call(r,Hr()):r.callback(e);Uu(n)?n.then(r.resolve,r.reject):r.resolve(n)}}catch(s){r.reject(s)}return this._running.set(this._tasks.length>0),!0}cancelAll(){const e=Hr();for(const r of this._tasks)if(r.abortCallback){const i=r.abortCallback(e);r.resolve(i)}else r.reject(e);this._tasks.length=0,this._running.set(!1)}},xre=class{constructor(e,r,i,s,n){this.resolve=e,this.reject=r,this.callback=i,this.signal=s,this.abortCallback=n}},r3=class extends Te{constructor(){super(...arguments),this.SCHEDULER_LOG_SLOW_TASKS=!1,this.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES=!1}};u([d()],r3.prototype,"SCHEDULER_LOG_SLOW_TASKS",void 0),u([d()],r3.prototype,"FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES",void 0),r3=u([I("esri.views.support.DebugFlags")],r3);const THe=new r3;var Sr;(function(t){t[t.ANIMATING=0]="ANIMATING",t[t.INTERACTING=1]="INTERACTING",t[t.IDLE=2]="IDLE"})(Sr||(Sr={}));function SHe(){return new XN.Scheduler}var Zo,_t;(function(t){t[t.YIELD=1]="YIELD"})(Zo||(Zo={})),function(t){t.RESOURCE_CONTROLLER_IMMEDIATE="immediate",t.RESOURCE_CONTROLLER="schedule",t.SLIDE="slide",t.STREAM_DATA_LOADER="stream loader",t.ELEVATION_QUERY="elevation query",t.TERRAIN_SURFACE="terrain",t.SURFACE_GEOMETRY_UPDATES="surface geometry updates",t.LOD_RENDERER="LoD renderer",t.GRAPHICS_CORE="Graphics3D",t.I3S_CONTROLLER="I3S",t.POINT_CLOUD_LAYER="point cloud",t.FEATURE_TILE_FETCHER="feature fetcher",t.OVERLAY="overlay",t.STAGE="stage",t.GRAPHICS_DECONFLICTOR="graphics deconflictor",t.FILTER_VISIBILITY="Graphics3D filter visibility",t.SCALE_VISIBILITY="Graphics3D scale visibility",t.FRUSTUM_VISIBILITY="Graphics3D frustum visibility",t.POINT_OF_INTEREST_FREQUENT="POI frequent",t.POINT_OF_INTEREST_INFREQUENT="POI infrequent",t.LABELER="labeler",t.FEATURE_QUERY_ENGINE="feature query",t.FEATURE_TILE_TREE="feature tile tree",t.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree",t.ELEVATION_ALIGNMENT="elevation alignment",t.TEXT_TEXTURE_ATLAS="text texture atlas",t.TEXTURE_UNLOAD="texture unload",t.LINE_OF_SIGHT_TOOL="line of sight tool",t.LINE_OF_SIGHT_TOOL_INTERACTIVE="interactive line of sight tool",t.ELEVATION_PROFILE="elevation profile",t.SNAPPING="snapping",t.SHADOW_ACCUMULATOR="shadow accumulator",t.CLOUDS_GENERATOR="clouds generator",t[t.TEST_PRIO=1]="TEST_PRIO"}(_t||(_t={}));const Af=0,Tre=new Map([[_t.RESOURCE_CONTROLLER_IMMEDIATE,Af],[_t.RESOURCE_CONTROLLER,4],[_t.SLIDE,Af],[_t.STREAM_DATA_LOADER,Af],[_t.ELEVATION_QUERY,Af],[_t.TERRAIN_SURFACE,1],[_t.SURFACE_GEOMETRY_UPDATES,1],[_t.LOD_RENDERER,2],[_t.GRAPHICS_CORE,2],[_t.I3S_CONTROLLER,2],[_t.POINT_CLOUD_LAYER,2],[_t.FEATURE_TILE_FETCHER,2],[_t.OVERLAY,4],[_t.STAGE,4],[_t.GRAPHICS_DECONFLICTOR,4],[_t.FILTER_VISIBILITY,4],[_t.SCALE_VISIBILITY,4],[_t.FRUSTUM_VISIBILITY,4],[_t.CLOUDS_GENERATOR,4],[_t.POINT_OF_INTEREST_FREQUENT,6],[_t.POINT_OF_INTEREST_INFREQUENT,30],[_t.LABELER,8],[_t.FEATURE_QUERY_ENGINE,8],[_t.FEATURE_TILE_TREE,16],[_t.FEATURE_TILE_TREE_ACTIVE,Af],[_t.ELEVATION_ALIGNMENT,12],[_t.TEXT_TEXTURE_ATLAS,12],[_t.TEXTURE_UNLOAD,12],[_t.LINE_OF_SIGHT_TOOL,16],[_t.LINE_OF_SIGHT_TOOL_INTERACTIVE,Af],[_t.SNAPPING,Af],[_t.SHADOW_ACCUMULATOR,30]]);function Sre(t){return Tre.has(t)?Tre.get(t):typeof t=="number"?t:1}const Ere=6.5,Cre=1,EHe=30,Are=1e3/30,Rre=100,Ore=.9;var XN,Iv;(function(t){class e{get updating(){return this._updating.get()}_updatingChanged(){this._updating.set(this._tasks.some(n=>n.needsUpdate))}constructor(){this._updating=new WN(!0),this._microTaskQueued=!1,this._frameNumber=0,this.performanceInfo={total:new Ig("total"),tasks:new Map},this._frameTaskTimes=new Map,this._budget=new i,this._state=Sr.INTERACTING,this._tasks=new Jt,this._runQueue=new Jt,this._load=0,this._idleStateCallbacks=new Jt,this._idleUpdatesStartFired=!1,this._forceTask=!1,this._debug=!1,this._debugHandle=ie(()=>THe.SCHEDULER_LOG_SLOW_TASKS,o=>this._debug=o,Vt);for(const o of Object.keys(_t))this.performanceInfo.tasks.set(_t[o],new Ig(_t[o]));const n=this;this._test={FRAME_SAFETY_BUDGET:Ere,INTERACTING_BUDGET:Are,IDLE_BUDGET:Rre,get availableBudget(){return n._budget.budget},usedBudget:0,getBudget:()=>n._budget,setBudget:o=>n._budget=o,updateTask:o=>this._updateTask(o),getState:o=>this._getState(o),getRuntime:o=>this._getRuntime(o),frameTaskTimes:this._frameTaskTimes,resetRuntimes:()=>this._resetRuntimes(),getRunning:()=>this._getRunning()}}destroy(){this._tasks.toArray().forEach(n=>n.remove()),this._tasks.clear(),ji(this._debugHandle),this._microTaskQueued=!1,this._updatingChanged()}taskRunningChanged(n){this._updatingChanged(),n&&this._budget.remaining>0&&!this._microTaskQueued&&(this._microTaskQueued=!0,queueMicrotask(()=>{this._microTaskQueued&&(this._microTaskQueued=!1,this._budget.remaining>0&&this._schedule()&&this.frame())}))}registerTask(n,o){const a=Sre(n),l=new r(this,n,o,a);return this._tasks.push(l),this._updatingChanged(),this.performanceInfo.tasks.has(n)||this.performanceInfo.tasks.set(n,new Ig(n)),l}registerIdleStateCallbacks(n,o){const a={idleBegin:n,idleEnd:o};this._idleStateCallbacks.push(a),this.state===Sr.IDLE&&this._idleUpdatesStartFired&&a.idleBegin();const l=this;return{remove:()=>this._removeIdleStateCallbacks(a),set idleBegin(c){l._idleUpdatesStartFired&&(a.idleEnd(),l._state===Sr.IDLE&&c()),a.idleBegin=c},set idleEnd(c){a.idleEnd=c}}}get load(){return this._load}set state(n){this._state!==n&&(this._state=n,this.state!==Sr.IDLE&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forAll(o=>o.idleEnd())))}get state(){return this._state}updateBudget(n){this._test.usedBudget=0,++this._frameNumber;let o=Ere,a=n.frameDuration,l=Cre;switch(this.state){case Sr.IDLE:o=0,a=Math.max(Rre,n.frameDuration),l=EHe;break;case Sr.INTERACTING:a=Math.max(Are,n.frameDuration);case Sr.ANIMATING:}return a=a-n.elapsedFrameTime-o,this.state!==Sr.IDLE&&a<Cre&&!this._forceTask?(this._forceTask=!0,!1):(a=Math.max(a,l),this._budget.reset(a,this.state),this._updateLoad(),this._schedule())}frame(){switch(this._forceTask=!1,this._microTaskQueued=!1,this.state){case Sr.IDLE:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forAll(n=>n.idleBegin())),this._runIdle();break;case Sr.INTERACTING:this._runInteracting();break;default:this._runAnimating()}this._test.usedBudget=this._budget.elapsed}stopFrame(){this._budget.reset(0,this._state),this._budget.madeProgress()}_removeIdleStateCallbacks(n){this._idleUpdatesStartFired&&n.idleEnd(),this._idleStateCallbacks.removeUnordered(n)}removeTask(n){this._tasks.removeUnordered(n),this._runQueue.removeUnordered(n),this._updatingChanged()}_updateTask(n){this._tasks.forAll(o=>{o.name===n&&o.setPriority(n)})}_getState(n){if(this._runQueue.some(a=>a.name===n))return Iv.SCHEDULED;let o=Iv.IDLE;return this._tasks.forAll(a=>{a.name===n&&a.needsUpdate&&(a.schedulePriority<=1?o=Iv.READY:o!==Iv.READY&&(o=Iv.WAITING))}),o}_getRuntime(n){let o=0;return this._tasks.forAll(a=>{a.name===n&&(o+=a.runtime)}),o}_resetRuntimes(){this._tasks.forAll(n=>n.runtime=0)}_getRunning(){const n=new Map;if(this._tasks.forAll(a=>{a.needsUpdate&&n.set(a.name,(n.get(a.name)||0)+1)}),n.size===0)return null;let o="";return n.forEach((a,l)=>{o+=a>1?` ${a}x ${l}`:` ${l}`}),o}_runIdle(){this._run()}_runInteracting(){this._run()}_runAnimating(){this._run()}_updateLoad(){const n=this._tasks.reduce((o,a)=>a.needsUpdate?++o:o,0);this._load=this._load*Ore+n*(1-Ore)}_schedule(){for(this._runQueue.filterInPlace(n=>!!n.needsUpdate||(n.schedulePriority=n.basePriority,!1)),this._tasks.forAll(n=>{n.basePriority===Af&&n.needsUpdate&&!this._runQueue.includes(n)&&n.blockFrame!==this._frameNumber&&this._runQueue.unshift(n)});this._runQueue.length===0;){let n=!1,o=0;if(this._tasks.forAll(a=>{a.needsUpdate&&a.schedulePriority!==0&&a.basePriority!==Af&&a.blockFrame!==this._frameNumber&&(n=!0,o=Math.max(o,a.basePriority),a.schedulePriority===1?(a.schedulePriority=0,this._runQueue.push(a)):--a.schedulePriority)}),!n)return this._updatingChanged(),!1}return this._updatingChanged(),!0}_run(){const n=this._budget.now();this._startFrameTaskTimes();do for(;this._runQueue.length>0;){const o=this._budget.now(),a=this._runQueue.pop();this._budget.resetProgress();try{a.task.runTask(this._budget)===Zo.YIELD&&(a.blockFrame=this._frameNumber)}catch(c){se.getLogger("esri.views.support.Scheduler").error(`Exception in task "${a.name}"`,c)}!this._budget.hasProgressed&&a.blockFrame!==this._frameNumber&&a.needsUpdate&&(a.name,_t.I3S_CONTROLLER,a.blockFrame=this._frameNumber),a.schedulePriority=a.basePriority;const l=this._budget.now()-o;if(a.runtime+=l,this._frameTaskTimes.set(a.priority,this._frameTaskTimes.get(a.priority)+l),this._debug&&l>2*this._budget.budget&&console.log("Task",a.name,"used",l,"of max",this._budget.budget,"ms"),this._budget.remaining<=0)return this._updatingChanged(),void this._recordFrameTaskTimes(this._budget.now()-n)}while(this._schedule());this._updatingChanged(),this._recordFrameTaskTimes(this._budget.now()-n)}_startFrameTaskTimes(){for(const n of Object.keys(_t))this._frameTaskTimes.set(_t[n],0)}_recordFrameTaskTimes(n){this._frameTaskTimes.forEach((o,a)=>this.performanceInfo.tasks.get(a).record(o)),this.performanceInfo.total.record(n)}get test(){return this._test}}t.Scheduler=e;class r{get task(){return this._task.get()}get updating(){return this._queue.running}constructor(n,o,a,l){this._scheduler=n,this.name=o,this._basePriority=l,this.blockFrame=0,this.runtime=0,this._queue=new xHe,this._handles=new ei,this.schedulePriority=this._basePriority,this._task=new WN(v(a)?a:this._queue),this._handles.add(_a(()=>this.task.running,c=>n.taskRunningChanged(c)))}remove(){this.processQueue(Xa),this._scheduler.removeTask(this),this.schedule=XS.schedule,this.reschedule=XS.reschedule,this._handles.destroy()}get basePriority(){return this._basePriority}setPriority(n){this.name=n;const o=Sre(n);this._basePriority!==Af&&this.schedulePriority===0||(this.schedulePriority=o),this._basePriority=o}get priority(){return this.name}set priority(n){this.setPriority(n)}get needsUpdate(){return this.updating||this.task.running}schedule(n,o,a){return this._queue.push(n,o,a)}reschedule(n,o,a){return this._queue.unshift(n,o,a)}processQueue(n){this._queue.runTask(n)}}class i{constructor(){this._begin=typeof performance<"u"?performance.now():0,this._budget=0,this._state=Sr.IDLE,this._done=!1,this._progressed=!1,this._enabled=!0}run(n){return!this.done&&(n()===!0&&this.madeProgress(),!0)}get done(){return this._done}get budget(){return this._budget}madeProgress(){return this._progressed=!0,this._done=this.elapsed>=this._budget&&this._enabled,this._done}get state(){return this._state}get enabled(){return this._enabled}set enabled(n){this._enabled=n}reset(n,o){this._begin=this.now(),this._budget=n,this._state=o,this.resetProgress()}get remaining(){return Math.max(this._budget-this.elapsed,0)}now(){return performance.now()}get elapsed(){return performance.now()-this._begin}resetProgress(){this._progressed=!1,this._done=!1}get hasProgressed(){return this._progressed}}t.Budget=i})(XN||(XN={})),function(t){t.SCHEDULED="s",t.READY="r",t.WAITING="w",t.IDLE="i"}(Iv||(Iv={}));const Xa=(()=>{const t=new XN.Budget;return t.enabled=!1,t})();let CHe=class{remove(){}processQueue(){}schedule(e,r,i){try{if(Ln(r)){const s=Hr();return i?Promise.resolve(i(s)):Promise.reject(s)}return zk(e(Xa))}catch(s){return Promise.reject(s)}}reschedule(e,r,i){return this.schedule(e,r,i)}};const XS=new CHe;let C2=class extends Te{constructor(e,r){super({}),this._stage=e,this._textureRequests=new Map,this._frameTask=(r==null?void 0:r.registerTask(_t.TEXTURE_UNLOAD))??XS}normalizeCtorArgs(){return{}}destroy(){super.destroy(),this._frameTask.remove(),this._textureRequests.forEach(e=>this._releaseTextureRequest(e)),this._textureRequests.clear()}get updating(){return this._frameTask.updating}fromData(e,r,i){const s=this.makeUid(e);let n=this._textureRequests.get(s);if(!n){const o=r();n={referenceCount:0,texture:o,textureAsync:null,abortController:null,onRemove:i},this._stage&&(this._stage.add(o),this._stage.loadImmediate(o)),this._textureRequests.set(s,n)}return n.referenceCount++,{uid:s,texture:n.texture,release:()=>this._release(s)}}_release(e){const r=this._textureRequests.get(e);r?(r.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),r.referenceCount--,r.referenceCount<1&&this._frameTask.schedule(()=>this._releaseNow(e))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){return{textureRequests:this._textureRequests}}_releaseNow(e){if(!this._textureRequests)return;const r=this._textureRequests.get(e);!r||r.referenceCount>0||(this._releaseTextureRequest(r),this._textureRequests.delete(e))}_releaseTextureRequest(e){var r;e.onRemove&&e.onRemove(),e.texture?(r=this._stage)==null||r.remove(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e,r=null){return v(r)?`${e}.${r}px`:e}};u([d()],C2.prototype,"_frameTask",void 0),u([d()],C2.prototype,"updating",null),C2=u([I("esri.views.3d.support.TextureCollection")],C2);var Mre;(function(t){t[t.Left=0]="Left",t[t.Middle=1]="Middle",t[t.Right=2]="Right"})(Mre||(Mre={}));const pve=["click","double-click","immediate-click","immediate-double-click","hold","drag","key-down","key-up","pointer-down","pointer-move","pointer-up","pointer-drag","mouse-wheel","pointer-enter","pointer-leave","gamepad","focus","blur"],fve={};function mve(t){return!!fve[t]}function AHe(t){for(const e of t)if(!mve(e))return!1;return!0}pve.forEach(t=>{fve[t]=!0});let RHe=class{constructor(e){this._handlers=new Map,this._counter=0,this._handlerCounts=new Map,this.view=e,this.inputManager=null}connect(e){e&&this.disconnect(),this.inputManager=e,this._handlers.forEach(({handler:r,priority:i},s)=>{var n;return(n=this.inputManager)==null?void 0:n.installHandlers(s,[r],i)})}disconnect(){this.inputManager&&this._handlers.forEach((e,r)=>{var i;return(i=this.inputManager)==null?void 0:i.uninstallHandlers(r)}),this.inputManager=null}destroy(){this.disconnect(),this._handlers.clear(),this.view=null}on(e,r,i,s){const n=Array.isArray(e)?e:e.split(",");if(!AHe(n))return n.some(mve)&&console.error("Error: registering input events and other events on the view at the same time is not supported."),null;let o,a;Array.isArray(r)?a=r:(o=r,a=[]),typeof i=="function"?o=i:s=i,s=s??F_.DEFAULT;const l=this._createUniqueGroupName(),c=new OHe(this.view,n,a,o);this._handlers.set(l,{handler:c,priority:s});for(const h of n){const p=this._handlerCounts.get(h)||0;this._handlerCounts.set(h,p+1)}return this.inputManager&&this.inputManager.installHandlers(l,[c],s),{remove:()=>this._removeHandler(l,n)}}hasHandler(e){return!!this._handlerCounts.get(e)}_removeHandler(e,r){if(this._handlers.has(e)){this._handlers.delete(e);for(const i of r){const s=this._handlerCounts.get(i);s===void 0?console.error("Trying to remove handler for event that has no handlers registered: ",i):s===1?this._handlerCounts.delete(i):this._handlerCounts.set(i,s-1)}}this.inputManager&&this.inputManager.uninstallHandlers(e)}_createUniqueGroupName(){return this._counter+=1,`viewEvents_${this._counter}`}},OHe=class extends $o{constructor(e,r,i,s){super(!0),this._latestDragStart=void 0,this.view=e;for(const n of r)switch(n){case"click":this.registerIncoming("click",i,o=>s(this._wrapClick(o)));break;case"double-click":this.registerIncoming("double-click",i,o=>s(this._wrapDoubleClick(o)));break;case"immediate-click":this.registerIncoming("immediate-click",i,o=>s(this._wrapImmediateClick(o)));break;case"immediate-double-click":this.registerIncoming("immediate-double-click",i,o=>s(this._wrapImmediateDoubleClick(o)));break;case"hold":this.registerIncoming("hold",i,o=>s(this._wrapHold(o)));break;case"drag":this.registerIncoming("drag",i,o=>{const a=this._wrapDrag(o);a&&s(a)});break;case"key-down":this.registerIncoming("key-down",i,o=>s(this._wrapKeyDown(o)));break;case"key-up":this.registerIncoming("key-up",i,o=>s(this._wrapKeyUp(o)));break;case"pointer-down":this.registerIncoming("pointer-down",i,o=>s(this._wrapPointer(o,"pointer-down")));break;case"pointer-move":this.registerIncoming("pointer-move",i,o=>s(this._wrapPointer(o,"pointer-move")));break;case"pointer-up":this.registerIncoming("pointer-up",i,o=>s(this._wrapPointer(o,"pointer-up")));break;case"pointer-drag":this.registerIncoming("pointer-drag",i,o=>s(this._wrapPointerDrag(o)));break;case"mouse-wheel":this.registerIncoming("mouse-wheel",i,o=>s(this._wrapMouseWheel(o)));break;case"pointer-enter":this.registerIncoming("pointer-enter",i,o=>s(this._wrapPointer(o,"pointer-enter")));break;case"pointer-leave":this.registerIncoming("pointer-leave",i,o=>s(this._wrapPointer(o,"pointer-leave")));break;case"gamepad":this.registerIncoming("gamepad",i,o=>{s(this._wrapGamepad(o))});break;case"focus":this.registerIncoming("focus",i,o=>{s(this._wrapFocus(o))});break;case"blur":this.registerIncoming("blur",i,o=>{s(this._wrapBlur(o))})}}_wrapFocus(e){return{type:"focus",timestamp:e.timestamp,native:e.data.native,cancelable:e.cancelable,stopPropagation:()=>e.stopPropagation(),async:r=>e.async(r),preventDefault:()=>e.preventDefault()}}_wrapBlur(e){return{type:"blur",timestamp:e.timestamp,native:e.data.native,cancelable:e.cancelable,stopPropagation:()=>e.stopPropagation(),async:r=>e.async(r),preventDefault:()=>e.preventDefault()}}_wrapClick(e){const{pointerType:r,button:i,buttons:s,x:n,y:o,native:a,eventId:l}=e.data,{cancelable:c,timestamp:h}=e;return{type:"click",pointerType:r,button:i,buttons:s,x:n,y:o,native:a,timestamp:h,screenPoint:Bh(n,o),mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:c,stopPropagation:()=>e.stopPropagation(),async:p=>e.async(p),preventDefault:()=>e.preventDefault()}}_wrapDoubleClick(e){const{pointerType:r,button:i,buttons:s,x:n,y:o,native:a,eventId:l}=e.data,{cancelable:c,timestamp:h}=e;return{type:"double-click",pointerType:r,button:i,buttons:s,x:n,y:o,native:a,timestamp:h,mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:c,stopPropagation:()=>e.stopPropagation(),async:p=>e.async(p),preventDefault:()=>e.preventDefault()}}_wrapImmediateClick(e){const{pointerType:r,button:i,buttons:s,x:n,y:o,native:a,eventId:l}=e.data,c=a.pointerId,{cancelable:h,timestamp:p}=e;return{type:"immediate-click",pointerId:c,pointerType:r,button:i,buttons:s,x:n,y:o,native:a,timestamp:p,mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:h,stopPropagation:()=>e.stopPropagation(),async:f=>e.async(f),preventDefault:()=>e.preventDefault()}}_wrapImmediateDoubleClick(e){const{pointerType:r,button:i,buttons:s,x:n,y:o,native:a,eventId:l}=e.data,c=a.pointerId,{cancelable:h,timestamp:p}=e;return{type:"immediate-double-click",pointerId:c,pointerType:r,button:i,buttons:s,x:n,y:o,native:a,timestamp:p,mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:h,stopPropagation:()=>e.stopPropagation(),async:f=>e.async(f),preventDefault:()=>e.preventDefault()}}_wrapHold(e){const{pointerType:r,button:i,buttons:s,x:n,y:o,native:a}=e.data,{cancelable:l,timestamp:c}=e;return{type:"hold",pointerType:r,button:i,buttons:s,x:n,y:o,native:a,timestamp:c,mapPoint:this._getMapPoint(n,o),cancelable:l,stopPropagation:()=>e.stopPropagation(),async:h=>e.async(h),preventDefault:()=>e.preventDefault()}}_getMapPoint(e,r){return this.view.toMap(Bh(e,r),{exclude:[]})}_wrapDrag(e){const r=e.data,{x:i,y:s}=r.center,{action:n,pointerType:o,button:a}=r;if(n==="start"&&(this._latestDragStart=r),!this._latestDragStart)return;const l=r.pointer.native,c=r.buttons,{cancelable:h,timestamp:p}=e,f={x:this._latestDragStart.center.x,y:this._latestDragStart.center.y};return n==="end"&&(this._latestDragStart=void 0),{type:"drag",action:n,x:i,y:s,origin:f,pointerType:o,button:a,buttons:c,radius:r.radius,angle:rl(r.angle),native:l,timestamp:p,cancelable:h,stopPropagation:()=>e.stopPropagation(),async:m=>e.async(m),preventDefault:()=>e.preventDefault()}}_wrapKeyDown(e){const{key:r,repeat:i,native:s}=e.data,{cancelable:n,timestamp:o}=e;return{type:"key-down",key:r,repeat:i,native:s,timestamp:o,cancelable:n,stopPropagation:()=>e.stopPropagation(),async:a=>e.async(a),preventDefault:()=>e.preventDefault()}}_wrapKeyUp(e){const{key:r,native:i}=e.data,{cancelable:s,timestamp:n}=e;return{type:"key-up",key:r,native:i,timestamp:n,cancelable:s,stopPropagation:()=>e.stopPropagation(),async:o=>e.async(o),preventDefault:()=>e.preventDefault()}}_wrapPointer(e,r){const{x:i,y:s,button:n,buttons:o,native:a,eventId:l}=e.data,c=a.pointerId,h=a.pointerType,{cancelable:p,timestamp:f}=e;return{type:r,x:i,y:s,pointerId:c,pointerType:h,button:n,buttons:o,native:a,timestamp:f,eventId:l,cancelable:p,stopPropagation:()=>e.stopPropagation(),async:m=>e.async(m),preventDefault:()=>e.preventDefault()}}_wrapPointerDrag(e){const{x:r,y:i,buttons:s,native:n,eventId:o}=e.data.currentEvent,{button:a}=e.data.startEvent,l=e.data.startEvent.native.pointerId,c=e.data.startEvent.native.pointerType,h=e.data.action,p={x:e.data.startEvent.x,y:e.data.startEvent.y},{cancelable:f,timestamp:m}=e;return{type:"pointer-drag",x:r,y:i,pointerId:l,pointerType:c,button:a,buttons:s,action:h,origin:p,native:n,timestamp:m,eventId:o,cancelable:f,stopPropagation:()=>e.stopPropagation(),async:y=>e.async(y),preventDefault:()=>e.preventDefault()}}_wrapMouseWheel(e){const{cancelable:r,data:i,timestamp:s}=e,{x:n,y:o,deltaY:a,native:l}=i;return{type:"mouse-wheel",x:n,y:o,deltaY:a,native:l,timestamp:s,cancelable:r,stopPropagation:()=>e.stopPropagation(),async:c=>e.async(c),preventDefault:()=>e.preventDefault()}}_wrapGamepad(e){const{action:r,state:i,device:s}=e.data,{cancelable:n,timestamp:o}=e,{buttons:a,axes:l}=i;return{type:"gamepad",device:s,timestamp:o,action:r,buttons:a,axes:l,cancelable:n,stopPropagation:()=>e.stopPropagation(),async:c=>e.async(c),preventDefault:()=>e.preventDefault()}}};var aO,Pre,Ire;(function(t){t[t.USER=0]="USER",t[t.MANAGER=1]="MANAGER"})(aO||(aO={})),function(t){t[t.None=0]="None",t[t.Unfocused=1]="Unfocused",t[t.Focused=2]="Focused",t[t.Unselected=4]="Unselected",t[t.Selected=8]="Selected",t[t.All=15]="All"}(Pre||(Pre={})),function(t){t[t.None=0]="None",t[t.Custom1=16]="Custom1",t[t.Custom2=32]="Custom2",t[t.Custom3=64]="Custom3",t[t.Custom4=128]="Custom4",t[t.Custom5=256]="Custom5",t[t.Custom6=512]="Custom6",t[t.Custom7=1024]="Custom7",t[t.Custom8=2048]="Custom8",t[t.Custom9=4096]="Custom9",t[t.Custom10=8192]="Custom10",t[t.Custom11=16384]="Custom11",t[t.Custom12=32768]="Custom12",t[t.All=65520]="All"}(Ire||(Ire={}));function MHe(t){return[t.on("before-add",e=>{const r=e.item;if(r==null||t.includes(r))return se.getLogger("esri.views.interactive.interactiveToolUtils").warn("Tool is either already in the list of tools or tool is `null`. Not adding tool."),void e.preventDefault();r.onAdd()}),t.on("after-remove",e=>{const r=e.item;r.active&&(r.view.activeTool=null),r.destroy()})]}function iG(t){return t.visible&&t.getEditableFlag!=null&&t.getEditableFlag(aO.USER)&&t.getEditableFlag(aO.MANAGER)}function uf(t){return Bh(t.x,t.y)}function $Et(t){return as(t.x,t.y)}function gve(t,e){var i;const r=(i=t instanceof HTMLElement?t:t.surface)==null?void 0:i.getBoundingClientRect();return r?Bh(e.clientX-r.left,e.clientY-r.top):Bh(0,0)}function $re(t,e){return e instanceof Event?gve(t,e):uf(e)}function Lre(t){if(t instanceof Event)return!0;if(typeof t=="object"&&"type"in t)switch(t.type){case"click":case"double-click":case"pointer-down":case"pointer-drag":case"pointer-enter":case"pointer-leave":case"pointer-up":case"pointer-move":case"immediate-click":case"immediate-double-click":case"hold":case"drag":case"mouse-wheel":return!0;default:return!1}return!1}let PHe=class{constructor(){this._pointerLocations=new Map,this._hoveredManipulators=new Map,this._grabbedManipulators=new Map,this._draggedManipulators=new Map,this._stopDrag=!1,this._revertToNullActiveTool=!1,this._cursor=null}get cursor(){return this._cursor}handleInputEvent(e,r){const i=()=>e.stopPropagation();switch(e.type){case"pointer-move":Dre(e.pointerType)&&this._pointerLocations.set(e.pointerId,{x:e.x,y:e.y,pointerType:e.pointerType});break;case"drag":this._grabbedManipulators.size>0&&(this._stopDrag=!0),this._stopDrag&&(i(),e.action==="end"&&(this._stopDrag=!1));break;case"pointer-down":{if(!Nre(e))break;const s=uf(e),n=this._intersect(s,e.pointerType,r.forEachTool);if(C(n))break;const o=n.manipulator,a=n.tool;!(v(o)&&v(a)&&o.interactive)||o.grabbable&&o.grabbableForEvent(e)||!o.grabbing||o.dragging||this._ungrabManipulatorBeforeDragging(o,e,r),v(o)&&v(a)&&o.interactive&&o.grabbable&&o.grabbableForEvent(e)&&!o.grabbing&&(this._grabbedManipulators.set(e.pointerId,{manipulator:o,tool:a,start:s,pointerType:e.pointerType}),this._grabbedManipulators.size===1&&C(r.activeTool)&&(this._revertToNullActiveTool=!0,r.setActiveTool(n.tool)),o.grabbing=!0,o.events.emit("grab-changed",{action:"start",pointerType:e.pointerType,screenPoint:s}),i());break}case"pointer-up":this._draggedManipulators.has(e.pointerId)||this._handlePointerEnd(e,r);break;case"pointer-drag":{if(!Nre(e))break;const s=this._grabbedManipulators.get(e.pointerId),n=so(s,({manipulator:h})=>h),o=so(s,({tool:h})=>h);if(C(n)||C(o))break;const a=uf(e);a.x=ge(a.x,0,r.view.width),a.y=ge(a.y,0,r.view.height);const l=s.start,c=this._draggedManipulators.get(e.pointerId);switch(e.action){case"start":case"update":e.action!=="update"&&this._grabbedManipulators.size!==1||(n.dragging=!0,c?n.events.emit("drag",{action:"update",start:l,screenPoint:a}):n.events.emit("drag",{action:"start",start:l,screenPoint:a,pointerType:e.pointerType}),this._draggedManipulators.set(e.pointerId,{tool:o,manipulator:n,start:l}));break;case"end":n.dragging=!1,c&&n.events.emit("drag",{action:"end",start:l,screenPoint:a}),this._draggedManipulators.delete(e.pointerId),this._handlePointerEnd(e,r)}i();break}case"immediate-click":{const s=uf(e),n=this._intersect(s,e.pointerType,r.forEachTool);if(IHe(e)||r.forEachTool(c=>{if((!v(n)||n.tool!==c||c.automaticManipulatorSelection)&&c.manipulators){let h=!1;c.manipulators.forEach(({manipulator:p})=>{p.selected&&(p.selected=!1,h=!0)}),h&&c.onManipulatorSelectionChanged&&c.onManipulatorSelectionChanged()}}),C(n))break;const{manipulator:o,tool:a}=n;if(!o.interactive)break;o.selectable&&a.automaticManipulatorSelection&&(o.selected=!o.selected,a.onManipulatorSelectionChanged&&a.onManipulatorSelectionChanged());const l=e.native.shiftKey;o.events.emit("immediate-click",{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:l,stopPropagation:i});break}case"click":{const s=uf(e),n=this._intersect(s,e.pointerType,r.forEachTool),o=v(n)?n.manipulator:null;if(C(o)||!o.interactive)break;const a=e.native.shiftKey;o.events.emit(e.type,{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:a}),i();break}case"double-click":{const s=uf(e),n=this._intersect(s,e.pointerType,r.forEachTool),o=v(n)?n.manipulator:null;if(C(o)||!o.interactive)break;const a=e.native.shiftKey;o.events.emit("double-click",{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:a,stopPropagation:i});break}case"immediate-double-click":{const s=uf(e),n=this._intersect(s,e.pointerType,r.forEachTool),o=v(n)?n.manipulator:null;if(C(o)||!o.interactive)break;const a=e.native.shiftKey;o.events.emit("immediate-double-click",{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:a,stopPropagation:i});break}}this._onFocusChange(r.forEachTool)}_ungrabManipulatorBeforeDragging(e,r,i){e.grabbing=!1,e.events.emit("grab-changed",{action:"end",pointerType:r.pointerType,screenPoint:uf(r)}),this._grabbedManipulators.forEach(({manipulator:s},n)=>{s===e&&this._grabbedManipulators.delete(n)}),this._afterManipulatorUngrab(i.setActiveTool)}_handlePointerEnd(e,r){const i=so(this._grabbedManipulators.get(e.pointerId),({manipulator:s})=>s);C(i)||i.grabbing&&(i.grabbing=!1,i.events.emit("grab-changed",{action:"end",pointerType:e.pointerType,screenPoint:uf(e)}),this._grabbedManipulators.delete(e.pointerId),this._afterManipulatorUngrab(r.setActiveTool))}_cursorFromMap(e){let r=null;return Ho(e,({manipulator:i})=>!(C(i)||!i.interactive)&&(i.grabbing&&i.grabCursor?(r=i.grabCursor,!0):!!i.cursor&&(r=i.cursor,!0))),r}_onFocusChange(e){this._updateCursor(),this._updateFocusedManipulatorTools(e)}_updateCursor(){this._grabbedManipulators.size>0?this._cursor=this._cursorFromMap(this._grabbedManipulators)||"grabbing":this._hoveredManipulators.size>0?this._cursor=this._cursorFromMap(this._hoveredManipulators)||"pointer":this._cursor=null}_updateFocusedManipulatorTools(e){const r=new Set,i=new Set;this._grabbedManipulators.forEach(({tool:s})=>{r.add(s)}),this._hoveredManipulators.forEach(({tool:s})=>{i.add(s)}),e(s=>{s.hasGrabbedManipulators=r.has(s),s.hasHoveredManipulators=i.has(s);const n=this._grabbedManipulators.values(),o=hAe(n,({tool:a})=>a===s);s.firstGrabbedManipulator=v(o)?o.manipulator:null})}clearPointers(e,{forEachTool:r,setActiveTool:i},s=!0,n){const o=(a,l)=>a===e&&(C(n)||n===l);this._grabbedManipulators.forEach(({tool:a,manipulator:l,pointerType:c},h)=>{o(a,l)&&(this._grabbedManipulators.delete(h),l.grabbing=!1,l.events.emit("grab-changed",{action:"end",screenPoint:null,pointerType:c}))}),this._draggedManipulators.forEach(({tool:a,manipulator:l},c)=>{o(a,l)&&(this._draggedManipulators.delete(c),l.dragging=!1,l.events.emit("drag",{action:"cancel"}))}),s&&this._hoveredManipulators.forEach(({tool:a,manipulator:l},c)=>{o(a,l)&&(this._hoveredManipulators.delete(c),l.hovering=!1)}),this._afterManipulatorUngrab(i),this._onFocusChange(r)}_intersect(e,r,i){let s=null;return i(n=>{if(n.manipulators==null||!iG(n))return!1;const o=n.manipulators.intersect(e,r);return!C(o)&&(s={tool:n,manipulator:o},!0)}),s}updateHoveredStateFromKnownPointers(e){this._pointerLocations.forEach((r,i)=>{this._updateHoveredStateForPointerAtScreenPosition(Bh(r.x,r.y),i,r.pointerType,e)})}handleHoverEvent(e,r){e.type!=="pointer-up"&&e.type!=="immediate-click"&&e.type!=="pointer-move"||!Dre(e.pointerType)||this._updateHoveredStateForPointerAtScreenPosition(uf(e),e.pointerId,e.pointerType,r)}_updateHoveredStateForPointerAtScreenPosition(e,r,i,s){let n=this._intersect(e,i,s);const o=so(this._hoveredManipulators.get(r),({manipulator:a})=>a);v(n)&&!n.manipulator.interactive&&(n=null),v(n)&&o===n.manipulator||(v(o)&&(o.hovering=!1),v(n)?(n.manipulator.hovering=!0,this._hoveredManipulators.set(r,n)):this._hoveredManipulators.delete(r),this._onFocusChange(s))}_afterManipulatorUngrab(e){this._grabbedManipulators.size===0&&this._revertToNullActiveTool&&(e(null),this._revertToNullActiveTool=!1)}};function Dre(t){return t==="mouse"}function Nre(t){return t.pointerType!=="mouse"||t.button===0}function IHe(t){return!!t.native.shiftKey}const Fre="attached",e8="tools";let hg=class extends ZR{constructor(e){super(e),this._manipulatorState=new PHe,this.tools=new Pt,this.cursor=null,this._forEachTool=r=>{for(const i of this.tools.items)if(r(i))return}}initialize(){this.handles.add([this.view.on(pve,e=>{this._handleInputEvent(e)},F_.TOOL),...MHe(this.tools),this.tools.on("before-add",({item:e})=>{this._updateToolEditableFlag(e)}),this.tools.on("before-remove",({item:e})=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs),this._updateCursor()}),this.tools.on("change",()=>{this._refreshToolWatchers()})])}destroy(){this.detach(),this.handles.removeAll()}get _manipulatorStateEventArgs(){return{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:e=>{this.activeTool=e},view:this.view}}set activeTool(e){if(v(e)&&!this.view.ready)return void se.getLogger(this.declaredClass).error("Cannot set active tool while view is not ready.");if(e===this.activeTool)return;const r=this.activeTool;this._set("activeTool",e),v(r)&&r.deactivate(),v(e)&&e.activate(),this._removeIncompleteTools(e);for(const i of this.tools){this._updateToolEditableFlag(i);const s=iG(i);!C(this.activeTool)&&s||this._manipulatorState.clearPointers(i,this._manipulatorStateEventArgs,!s)}this._updateCursor()}get updating(){var e;return this.updatingHandles.updating||this.tools.some(r=>r.updating)||(((e=this.textures)==null?void 0:e.updating)??!1)}attach(){var e;this.view.type==="3d"?(this._set("textures",new C2(this.view._stage,this.view.resourceController.scheduler)),this.handles.add([ie(()=>{const{state:r}=this.view;return"camera"in r&&r.camera},()=>this._forEachManipulator(r=>r.onViewChange())),(e=this.view.elevationProvider)==null?void 0:e.on("elevation-change",r=>this._forEachManipulator(i=>i.onElevationChange(r))),cp(()=>this._set("textures",ke(this.textures)))],Fre)):this.handles.add(ie(()=>this.view.extent,()=>this._forEachManipulator(r=>r.onViewChange())))}detach(){v(this.activeTool)&&(this.activeTool=null),this.tools.removeAll(),this.handles.remove(Fre)}_forEachManipulator(e){this._forEachTool(r=>{r.manipulators&&r.manipulators.forEach(({manipulator:i})=>e(i,r))})}_handleInputEvent(e){let r=!1;const i={...e,stopPropagation:()=>{r=!0,e.stopPropagation()}};v(this.activeTool)?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(i):this._forEachTool(s=>{!r&&s.visible&&s.handleInputEvent(i)}),!r&&e.type==="key-down"&&e.key==="Escape"&&this.activeTool&&(e.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(i,this._manipulatorStateEventArgs),!r&&v(this.activeTool)&&this.activeTool.handleInputEventAfter(i),this._manipulatorState.handleHoverEvent(i,this._forEachTool),this._updateCursor()}_refreshToolWatchers(){this.handles.remove(e8),this._forEachTool(e=>{if(e instanceof Te){const r=ie(()=>[e.cursor,e.visible,e.editable],()=>{iG(e)||this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs),this._updateCursor()});this.handles.add(r,e8)}e.manipulators&&this.handles.add([e.manipulators.on("after-remove",r=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs,!0,r.item.manipulator)}),e.manipulators.on("change",()=>{this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()})],e8)}),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}_updateToolEditableFlag(e){var r;(r=e.setEditableFlag)==null||r.call(e,aO.MANAGER,C(this.activeTool)||e===this.activeTool)}_updateCursor(){let e=this._manipulatorState.cursor;C(e)&&this._forEachTool(r=>!(!v(r.cursor)||!r.visible)&&(e=r.cursor,!0)),this._get("cursor")!==e&&this._set("cursor",e)}_removeIncompleteTools(e){this.tools.filter(r=>(C(e)||r!==e)&&!r.created&&r.removeIncompleteOnCancel).forEach(r=>{this.tools.remove(r)})}};u([d({constructOnly:!0,nonNullable:!0})],hg.prototype,"view",void 0),u([d({readOnly:!0,nonNullable:!0})],hg.prototype,"textures",void 0),u([d({value:null})],hg.prototype,"activeTool",null),u([d({readOnly:!0,type:Pt})],hg.prototype,"tools",void 0),u([d({readOnly:!0})],hg.prototype,"cursor",void 0),u([d({readOnly:!0})],hg.prototype,"updating",null),hg=u([I("esri.views.ToolViewManager")],hg);const $He=hg;let WT=class extends Te{constructor(e){super(),this.nativeIndex=null,this._detectedDeviceType="unknown",e.mapping==="standard"?this._detectedDeviceType="standard":LHe.test(e.id)?this._detectedDeviceType="spacemouse":this._detectedDeviceType="unknown",this.nativeIndex=e.index}get native(){const e=navigator.getGamepads?navigator.getGamepads():[];return this.nativeIndex!=null&&this.nativeIndex<e.length?e[this.nativeIndex]:null}get deviceType(){return this._detectedDeviceType}get axisThreshold(){return DHe[this.deviceType]}};u([d({nonNullable:!0,readOnly:!0})],WT.prototype,"nativeIndex",void 0),u([d({type:String,readOnly:!0})],WT.prototype,"deviceType",null),u([d({type:Number,readOnly:!0})],WT.prototype,"axisThreshold",null),WT=u([I("esri.views.input.gamepad.GamepadInputDevice")],WT);const LHe=new RegExp("^(3dconnexion|space(mouse|navigator|pilot|explorer))","i"),DHe={standard:.15,spacemouse:.025,unknown:0},ZX=WT;let i3=class extends Te{constructor(...e){super(...e),this.devices=new Pt,this.enabledFocusMode="document"}};u([d({type:Pt.ofType(ZX),readOnly:!0})],i3.prototype,"devices",void 0),u([d({type:["document","view","none"]})],i3.prototype,"enabledFocusMode",void 0),i3=u([I("esri.views.input.gamepad.GamepadSettings")],i3);const NHe=i3;let ZL=class extends Te{constructor(){super(...arguments),this.gamepad=new NHe}};u([d({readOnly:!0})],ZL.prototype,"gamepad",void 0),ZL=u([I("esri.views.input.Input")],ZL);const FHe=ZL;let V0=class extends Te{constructor(e){super(e),this.enabled=!0,this.device=null,this.mode="pan",this.tiltDirection="forward-down",this.velocityFactor=1}};u([d({type:Boolean,nonNullable:!0})],V0.prototype,"enabled",void 0),u([d({type:ZX})],V0.prototype,"device",void 0),u([d({type:["pan","zoom"],nonNullable:!0})],V0.prototype,"mode",void 0),u([d({type:["forward-down","forward-up"],nonNullable:!0})],V0.prototype,"tiltDirection",void 0),u([d({type:Number,nonNullable:!0})],V0.prototype,"velocityFactor",void 0),V0=u([I("esri.views.navigation.gamepad.GamepadSettings")],V0);const yve=V0;let X1=class extends Te{constructor(e){super(e),this.browserTouchPanEnabled=!0,this.gamepad=new yve,this.momentumEnabled=!0,this.mouseWheelZoomEnabled=!0}};u([d({type:Boolean})],X1.prototype,"browserTouchPanEnabled",void 0),u([d({type:yve,nonNullable:!0})],X1.prototype,"gamepad",void 0),u([d({type:Boolean})],X1.prototype,"momentumEnabled",void 0),u([d({type:Boolean})],X1.prototype,"mouseWheelZoomEnabled",void 0),X1=u([I("esri.views.navigation.Navigation")],X1);const _ve=X1;function BEt(t,e,r){const i=vve(t),s=e,n=UHe(i,s,r);if(i){const o=EE.deriveUnitFromSR(i,t.spatialReference).heightUnit;if(!r&&o!==i.heightUnit){const a=new q("layerview:unmatched-height-unit",`The vertical units of the layer must match the horizontal units (${o})`,{horizontalUnit:o});return new q("layerview:unsupported-height-model-info","The vertical coordinate system of the layer is not supported",{heightModelInfo:i,error:a})}}if(!kHe(t)||n===gc.Unsupported)return new q("layerview:unsupported-height-model-info","The vertical coordinate system of the layer is not supported",{heightModelInfo:i});switch(n){case gc.Units:{const o=(i==null?void 0:i.heightUnit)||"unknown",a=(s==null?void 0:s.heightUnit)||"unknown",l=new q("layerview:incompatible-height-unit",`The vertical units of the layer (${o}) must match the vertical units of the scene (${a})`,{layerUnit:o,sceneUnit:a});return new q("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:i,sceneHeightModelInfo:s,error:l})}case gc.HeightModel:{const o=(i==null?void 0:i.heightModel)||"unknown",a=(s==null?void 0:s.heightModel)||"unknown",l=new q("layerview:incompatible-height-model",`The height model of the layer (${o}) must match the height model of the scene (${a})`,{layerHeightModel:o,sceneHeightModel:a});return new q("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:i,sceneHeightModelInfo:s,error:l})}case gc.CRS:{const o=(i==null?void 0:i.vertCRS)||"unknown",a=(s==null?void 0:s.vertCRS)||"unknown",l=new q("layerview:incompatible-vertical-datum",`The vertical datum of the layer (${o}) must match the vertical datum of the scene (${a})`,{layerDatum:o,sceneDatum:a});return new q("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:i,sceneHeightModelInfo:s,error:l})}}return null}function UHe(t,e,r){if(!Ure(t)||!Ure(e))return gc.Unsupported;if(t==null||e==null)return gc.Ok;if(!r&&t.heightUnit!==e.heightUnit)return gc.Units;if(t.heightModel!==e.heightModel)return gc.HeightModel;switch(t.heightModel){case"gravity-related-height":return gc.Ok;case"ellipsoidal":return t.vertCRS===e.vertCRS?gc.Ok:gc.CRS;default:return gc.Unsupported}}var gc;function Ure(t){return t==null||t.heightModel!=null&&t.heightUnit!=null}function kHe(t){return"heightModelInfo"in t&&t.heightModelInfo!=null||t.spatialReference!=null||!xve(t)}function vve(t){var i;const e=t.url?LE(t.url):void 0;return!(((i=t.spatialReference)==null?void 0:i.vcsWkid)==null&&v(e)&&e.serverType==="ImageServer")&&bve(t)&&t.heightModelInfo?t.heightModelInfo:xve(t)?EE.deriveUnitFromSR(BHe,t.spatialReference):null}function bve(t){return"heightModelInfo"in t}function wve(t){if(t.type==="unknown"||!("capabilities"in t))return!1;switch(t.type){case"csv":case"feature":case"geojson":case"subtype-group":case"ogc-feature":case"oriented-imagery":case"wfs":case"knowledge-graph-sublayer":return!0;default:return!1}}function xve(t){return wve(t)?!!(t.capabilities&&t.capabilities.data&&t.capabilities.data.supportsZ):Tve(t)}function VHe(t){return t.layers!=null||Tve(t)||wve(t)||bve(t)}function Tve(t){switch(t.type){case"building-scene":case"elevation":case"integrated-mesh":case"point-cloud":case"scene":case"voxel":return!0;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"csv":case"dimension":case"geojson":case"feature":case"subtype-group":case"geo-rss":case"graphics":case"group":case"imagery":case"imagery-tile":case"kml":case"knowledge-graph":case"link-chart":case"knowledge-graph-sublayer":case"line-of-sight":case"map-image":case"map-notes":case"media":case"ogc-feature":case"open-street-map":case"oriented-imagery":case"route":case"stream":case"tile":case"unknown":case"unsupported":case"vector-tile":case"wcs":case"web-tile":case"wfs":case"wms":case"wmts":case null:return!1}return!1}(function(t){t[t.Ok=0]="Ok",t[t.Units=1]="Units",t[t.HeightModel=2]="HeightModel",t[t.CRS=3]="CRS",t[t.Unsupported=4]="Unsupported"})(gc||(gc={}));const BHe=new EE({heightModel:"gravity-related-height"});var Be;function kre(t){return t==="global"?Be.Global:Be.Local}function t8(t){return t===Be.Global?"global":"local"}(function(t){t[t.Global=1]="Global",t[t.Local=2]="Local"})(Be||(Be={}));let sG,r8=null;async function zHe(t){r8||(r8=te(()=>Promise.resolve().then(()=>cdt),void 0).then(e=>sG=e)),await r8,fr(t)}async function Sve(t,e,r,i){if(!t)return null;const s=t.spatialReference;return yW()||yw(s,e)?AE(t,e):sG?sG.projectGeometry(t,e,r,i):(await Promise.race([zHe(i),vN(i)]),Sve(t,e,r,i))}let Zi=class extends Te{constructor(e){super(e),this.required={tileInfo:!1,heightModelInfo:!1,extent:!1},this.defaultSpatialReference=null,this.userSpatialReference=null,this.sourcePreloadCount=10,this.priorityCollection=null,this.requiresExtentInSpatialReference=!0,this.suspended=!1,this._projectExtentTask={task:null,input:null,output:null,spatialReference:null}}destroy(){this._projectExtentTask.task&&(this._projectExtentTask.task=Fh(this._projectExtentTask.task)),this._set("map",null)}get ready(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}get heightModelInfoReady(){return!this._heightModelInfoTask.updating}get spatialReference(){return v(this.userSpatialReference)?this.userSpatialReference:this._spatialReferenceTask.spatialReference}get extent(){return this._extentTask.extent}get heightModelInfo(){return this._heightModelInfoTask.heightModelInfo}get vcsWkid(){return this._heightModelInfoTask.vcsWkid}get latestVcsWkid(){return this._heightModelInfoTask.latestVcsWkid}get viewingMode(){return C(this.userSpatialReference)||this.userSpatialReference.equals(this._spatialReferenceTask.spatialReference)?this._spatialReferenceTask.viewingMode:null}get tileInfo(){return this._tileInfoTask.tileInfo}get mapCollections(){var i,s,n,o;const e=(i=this.map)==null?void 0:i.call(this),r=[];return v(this.priorityCollection)&&r.push(this.priorityCollection),r.push({parent:e==null?void 0:e.basemap,layers:(s=e==null?void 0:e.basemap)==null?void 0:s.baseLayers},{layers:e==null?void 0:e.layers},{parent:e==null?void 0:e.ground,layers:(n=e==null?void 0:e.ground)==null?void 0:n.layers},{parent:e==null?void 0:e.basemap,layers:(o=e==null?void 0:e.basemap)==null?void 0:o.referenceLayers}),r}get _allLayers(){return this._collectLayers(this.mapCollections)}get _spatialReferenceTask(){if(this.suspended)return this._get("_spatialReferenceTask")??{updating:!1};const{layers:e,updating:r}=this._allLayers;let i=null;for(const n of e){const o=this._getSupportedSpatialReferences(n);if(o.length>0){const a=this._narrowDownSpatialReferenceCandidates(i,o);v(a)&&(i=a)}if(v(i)&&i.length===1)break}if(r&&(C(i)||i.length!==1))return{updating:!0};const s=this._pickSpatialReferenceCandidate(i);return{spatialReference:v(s)?s.spatialReference:null,viewingMode:v(s)?s.viewingMode:null,updating:!1}}get _tileInfoTask(){var i,s,n,o,a,l,c;if(!this.required.tileInfo)return this._get("_tileInfoTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const{layers:e,updating:r}=this._collectLayers([{parent:(s=(i=this.map)==null?void 0:i.call(this))==null?void 0:s.basemap,layers:(a=(o=(n=this.map)==null?void 0:n.call(this))==null?void 0:o.basemap)==null?void 0:a.baseLayers},{layers:(c=(l=this.map)==null?void 0:l.call(this))==null?void 0:c.layers}]);if(e&&e.length>0&&"tileInfo"in e[0]){const h=e[0].tileInfo;return{tileInfo:h&&h.spatialReference.equals(this.spatialReference)?h:null,updating:!1}}return{updating:r}}get _heightModelInfoTask(){var i,s,n;if(!this.required.heightModelInfo||this.suspended&&((i=this._get("_heightModelInfoTask"))!=null&&i.heightModelInfo))return this._get("_heightModelInfoTask")??{updating:!1};const{layers:e,updating:r}=this._allLayers;for(const o of e)if(VHe(o)){const a=vve(o);if(a)return{heightModelInfo:a,vcsWkid:(s=o.spatialReference)==null?void 0:s.vcsWkid,latestVcsWkid:(n=o.spatialReference)==null?void 0:n.latestVcsWkid,updating:!1}}return{updating:r}}get _extentCandidatesTask(){if(this.suspended||!this.required.extent)return this._get("_extentCandidatesTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const e=this._allLayers,r=e.updating,i=[];for(const s of e.layers){const n="fullExtents"in s&&s.fullExtents||(v(s.fullExtent)?[s.fullExtent]:[]),o=this.requiresExtentInSpatialReference?null:n[0],a=n.find(l=>l.spatialReference.equals(this.spatialReference))??o;if(a)return{candidates:[{extent:a,layer:s}],updating:!1};if(this._getSupportedSpatialReferences(s).length>0)for(const l of n)i.push({extent:l,layer:s})}return{candidates:i,updating:r}}get _extentTask(){const{candidates:e,updating:r}=this._extentCandidatesTask;if(r)return{updating:r};if(C(e)||e.length===0)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const i=this._pickExtentCandidate(e),s=this.spatialReference;return i.extent.equals(this._projectExtentTask.input)&&s.equals(this._projectExtentTask.spatialReference)?{extent:this._projectExtentTask.output,updating:v(this._projectExtentTask.task)&&!this._projectExtentTask.task.finished}:(v(this._projectExtentTask.task)&&(this._projectExtentTask.task=Fh(this._projectExtentTask.task)),this._projectExtentTask={input:i.extent.clone(),output:null,spatialReference:s.clone(),task:YO(async n=>{try{const o=await Sve(i.extent,s,i.layer.portalItem,n);this._projectExtentTask={...this._projectExtentTask,task:null,output:o}}catch{if(Ln(n))return;this._projectExtentTask={...this._projectExtentTask,task:null}}})},{updating:!0})}_narrowDownSpatialReferenceCandidates(e,r){if(C(e))return r;const i=[],s=(n,o)=>v(n)?v(o)?n===o&&n:n:o;for(const n of e)for(const o of r){if(!n.spatialReference.equals(o.spatialReference))continue;const a=s(n.viewingMode,o.viewingMode);if(a!==!1){i.push({spatialReference:n.spatialReference,viewingMode:a});break}}return i.length>0?i:null}_pickSpatialReferenceCandidate(e){const r=this.defaultSpatialReference;return C(e)||e.length<1?v(r)?{spatialReference:r,viewingMode:null}:null:(v(r)&&e.length>1&&e.some(({spatialReference:i})=>i.equals(r))&&(e=e.filter(({spatialReference:i})=>i.equals(r))),e.length>1&&e.some(({viewingMode:i})=>i!==Be.Local)&&(e=e.filter(({viewingMode:i})=>i!==Be.Local)),e[0])}_getSupportedSpatialReferences(e){const r="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(r.length===0)return[];const i=[];for(const s of r){const n=this.getSpatialReferenceSupport({spatialReference:s,layer:e});if(v(n)){const o=v(n.constraints)?n.constraints:[{spatialReference:s,viewingMode:null}];for(const{spatialReference:a,viewingMode:l}of o)(!this.requiresExtentInSpatialReference||C(this.userSpatialReference)||a.equals(this.userSpatialReference))&&i.push({spatialReference:a,viewingMode:l})}}return i}_pickExtentCandidate(e){const r=this.spatialReference;return e.find(({extent:i})=>r.equals(i.spatialReference))||e[0]}_collectLayers(e){var i;if(this._loadMaybe((i=this.map)==null?void 0:i.call(this))!=="loaded")return{layers:[],updating:!0};const r={layers:[],preloading:-1,updating:!1};for(const s of e)if(this._collectCollection(s,r),r.preloading===this.sourcePreloadCount)break;return{layers:r.layers,updating:r.updating}}_collectCollection(e,r){if(e.layers){switch(this._loadMaybe(e.parent)){case"loading":return r.updating=!0,void++r.preloading;case"failed":return}for(const i of e.layers){switch(this._loadMaybe(i)){case"failed":continue;case"loading":r.updating=!0,++r.preloading;break;case"loaded":r.updating||r.layers.push(i),"layers"in i&&this._collectCollection({layers:i.layers},r)}if(r.preloading===this.sourcePreloadCount)break}}}_loadMaybe(e){return e&&"loadStatus"in e&&e.loadStatus!=null?e.loadStatus==="not-loaded"?(e.load().catch(()=>{}),"loading"):e.loadStatus:"loaded"}};u([d()],Zi.prototype,"required",void 0),u([d({constructOnly:!0})],Zi.prototype,"map",void 0),u([d({constructOnly:!0})],Zi.prototype,"getSpatialReferenceSupport",void 0),u([d()],Zi.prototype,"defaultSpatialReference",void 0),u([d()],Zi.prototype,"userSpatialReference",void 0),u([d()],Zi.prototype,"sourcePreloadCount",void 0),u([d()],Zi.prototype,"priorityCollection",void 0),u([d()],Zi.prototype,"requiresExtentInSpatialReference",void 0),u([d()],Zi.prototype,"suspended",void 0),u([d({readOnly:!0})],Zi.prototype,"ready",null),u([d({readOnly:!0})],Zi.prototype,"heightModelInfoReady",null),u([d({readOnly:!0})],Zi.prototype,"spatialReference",null),u([d({readOnly:!0})],Zi.prototype,"extent",null),u([d({readOnly:!0})],Zi.prototype,"heightModelInfo",null),u([d({readOnly:!0})],Zi.prototype,"vcsWkid",null),u([d({readOnly:!0})],Zi.prototype,"latestVcsWkid",null),u([d({readOnly:!0})],Zi.prototype,"viewingMode",null),u([d({readOnly:!0})],Zi.prototype,"tileInfo",null),u([d({readOnly:!0})],Zi.prototype,"mapCollections",null),u([d({readOnly:!0})],Zi.prototype,"_allLayers",null),u([d({readOnly:!0})],Zi.prototype,"_spatialReferenceTask",null),u([d({readOnly:!0})],Zi.prototype,"_tileInfoTask",null),u([d({readOnly:!0})],Zi.prototype,"_heightModelInfoTask",null),u([d({readOnly:!0})],Zi.prototype,"_extentCandidatesTask",null),u([d()],Zi.prototype,"_extentTask",null),u([d()],Zi.prototype,"_projectExtentTask",void 0),Zi=u([I("esri.views.support.DefaultsFromMap")],Zi);var JL;let kt=JL=class extends Yw(vs.EventedMixin(a4(Te))){constructor(t){super(t),this._userSpatialReference=null,this._cursor=null,this.allLayerViews=new VR({getCollections:()=>{var e,r,i;return[(e=this.basemapView)==null?void 0:e.baseLayerViews,(r=this.groundView)==null?void 0:r.layerViews,this.layerViews,(i=this.basemapView)==null?void 0:i.referenceLayerViews]},getChildrenFunction:e=>e.layerViews}),this.groundView=null,this.basemapView=null,this.fatalError=null,this.graphics=new aR,this.analyses=new VS,this.typeSpecificPreconditionsReady=!0,this.layerViews=new Pt,this.magnifier=new dve,this.padding={left:0,top:0,right:0,bottom:0},this.ready=!1,this.spatialReferenceWarningDelay=1e3,this.supportsGround=!0,this.timeExtent=null,this.timeReference=new WS,this.type=null,this.scale=null,this.updating=!1,this.initialExtentRequired=!0,this.input=new FHe,this.navigation=new _ve,this.layerViewManager=null,this.analysisViewManager=null,this.isHeightModelInfoRequired=!1,this.width=null,this.height=null,this.resizing=!1,this.suspended=!1,this.viewEvents=new RHe(this),this.persistableViewModels=new Pt,this._isValid=!1,this._readyCycleForced=!1,this._currentSpatialReference=null,this.handles.add(ie(()=>this.preconditionsReady,e=>{var r,i;e?(this._currentSpatialReference=this.spatialReference,JL.views.add(this)):(this._currentSpatialReference=null,JL.views.remove(this)),this.notifyChange("spatialReference"),!e&&this.ready?((r=this.toolViewManager)==null||r.detach(),v(this.analysisViewManager)&&this.analysisViewManager.detach(),(i=this.layerViewManager)==null||i.clear(),this._teardown()):e&&!this.ready&&(this._startup(),v(this.analysisViewManager)&&this.analysisViewManager.attach(),this.toolViewManager.attach())},ri))}initialize(){this.addResolvingPromise(this.validate().then(()=>(this._isValid=!0,WR(()=>this.ready)))),this.basemapView=new k0({view:this}),this.layerViewManager=new bHe({view:this,layerViewImporter:{importLayerView:t=>this.importLayerView(t),hasLayerViewModule:t=>this.hasLayerViewModule(t)},supportsGround:this.supportsGround}),this.toolViewManager=new $He({view:this}),this._setupSpatialReferenceLogger(),this.handles.add([ie(()=>this.initialExtentRequired,t=>this.defaultsFromMap.required={...this.defaultsFromMap.required,extent:t},{sync:!0,initial:!0}),ie(()=>this.ready,t=>{this.defaultsFromMap&&(this.defaultsFromMap.suspended=t,this.defaultsFromMap.userSpatialReference=t?this.spatialReference:this._userSpatialReference)},{sync:!0}),ie(()=>this._userSpatialReference,t=>{this.defaultsFromMap&&(this.defaultsFromMap.userSpatialReference=t)},{sync:!0,initial:!0})])}_setupSpatialReferenceLogger(){let t=null;this.handles.add([ie(()=>{var e;return(e=this.defaultsFromMap)==null?void 0:e.ready},e=>{var i;const r=((i=this.map)==null?void 0:i.allLayers.length)>0;if(e&&!this.spatialReference&&r){if(v(t))return;const s=cp(()=>t=Fh(t));t=YO(async n=>{try{await nw(this.spatialReferenceWarningDelay,null,n)}catch{return}finally{t=null}se.getLogger(this.declaredClass).warn("#spatialReference","no spatial reference could be derived from the currently added map layers")}),this.handles.add(s,"spatial-reference-logger-task")}else this.handles.remove("spatial-reference-logger-task")},{sync:!0})])}destroy(){if(this.destroyed)return;this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics=ke(this.graphics),this.analyses=ke(this.analyses),this.handles.remove("defaultsFromMap"),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),ke(this.analysisViewManager),this.toolViewManager=ke(this.toolViewManager),this.layerViewManager=ke(this.layerViewManager),this.basemapView=ke(this.basemapView),this.invalidate(),this._emitter.clear(),this.handles.removeAll();const t=this.map;this.map=null,t==null||t.destroy()}_startup(){this._set("ready",!0)}_teardown(){this._set("ready",!1)}whenReady(){return Promise.resolve(this)}toMap(){return se.getLogger(this.declaredClass).error("#toMap()","Not implemented on this instance of View"),null}get activeTool(){var t;return(t=this.toolViewManager)==null?void 0:t.activeTool}set activeTool(t){this.toolViewManager&&(this.toolViewManager.activeTool=t)}get animation(){return this._get("animation")}set animation(t){this._set("animation",t)}get center(){return null}get _defaultsFromMapSettings(){return{}}get defaultsFromMap(){return new Zi({required:{tileInfo:!1,heightModelInfo:!1,extent:!1},map:()=>this.map,getSpatialReferenceSupport:t=>this.getSpatialReferenceSupport(t),...this._defaultsFromMapSettings})}get extent(){return this._get("extent")}set extent(t){this._set("extent",t)}get heightModelInfo(){return this.getDefaultHeightModelInfo()}get interacting(){return this.navigating}get navigating(){return!1}get preconditionsReady(){var t;return!(this.fatalError||!this._isValid||this._readyCycleForced||!this.map||Zg.isLoadable(this.map)&&!this.map.loaded||this.width===0||this.height===0||!this.spatialReference||!this._validateSpatialReference(this.spatialReference)||!this._currentSpatialReference&&!((t=this.defaultsFromMap)!=null&&t.ready)||!this.typeSpecificPreconditionsReady)}get resolution(){return 0}set map(t){t!==this._get("map")&&(t!=null&&t.destroyed&&(se.getLogger(this.declaredClass).warn("#map","The provided map is already destroyed",{map:t}),t=null),Zg.isLoadable(t)&&t.load().catch(()=>{}),this.constructed&&(this.forceReadyCycle(),this._currentSpatialReference=null),this._set("map",t))}get spatialReference(){var e,r;let t=this._userSpatialReference||this._currentSpatialReference||this.getDefaultSpatialReference()||null;return t&&((r=(e=this.defaultsFromMap)==null?void 0:e.required)!=null&&r.heightModelInfo)&&(t=t.clone(),t.vcsWkid=this.defaultsFromMap.vcsWkid,t.latestVcsWkid=this.defaultsFromMap.latestVcsWkid),t}set spatialReference(t){const e=!Tn(t,this._get("spatialReference"));this._set("_userSpatialReference",t),e&&(this._set("spatialReference",t),this._spatialReferenceChanged(t))}_spatialReferenceChanged(t){}get stationary(){return!this.animation&&!this.navigating&&!this.resizing}get tools(){var t;return(t=this.toolViewManager)==null?void 0:t.tools}get initialExtent(){var t;return(t=this.defaultsFromMap)==null?void 0:t.extent}get cursor(){const t=this.toolViewManager?this.toolViewManager.cursor:null;return v(t)?t:this._cursor||"default"}set cursor(t){this._cursor=t,this.notifyChange("cursor")}get size(){return[this.width,this.height]}whenLayerView(t){return this.layerViewManager.whenLayerView(t)}getDefaultSpatialReference(){var t;return(t=this.defaultsFromMap)==null?void 0:t.spatialReference}getDefaultHeightModelInfo(){var t;return(this.map&&"heightModelInfo"in this.map?this.map.heightModelInfo:void 0)??((t=this.defaultsFromMap)==null?void 0:t.heightModelInfo)??null}importLayerView(t){throw new q("importLayerView() not implemented")}hasLayerViewModule(t){return!1}async validate(){}invalidate(){this._isValid=!1}getSpatialReferenceSupport(){return{constraints:null}}_validateSpatialReference(t){return v(this.getSpatialReferenceSupport({spatialReference:t}))}when(t,e){return this.isResolved()&&!this.ready&&se.getLogger(this.declaredClass).warn("#when()","Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use reactiveUtils.whenOnce(() => view.ready).then(...) instead."),super.when(t,e)}forceReadyCycle(){this.ready&&(_a(()=>this.preconditionsReady===!1,()=>this._readyCycleForced=!1,{once:!0}),this._readyCycleForced=!0)}addAndActivateTool(t){this.toolViewManager.tools.add(t),this.activeTool=t}tryFatalErrorRecovery(){this.fatalError=null}};kt.views=new Pt,u([d()],kt.prototype,"_userSpatialReference",void 0),u([d()],kt.prototype,"activeTool",null),u([d({readOnly:!0})],kt.prototype,"allLayerViews",void 0),u([d()],kt.prototype,"groundView",void 0),u([d()],kt.prototype,"animation",null),u([d()],kt.prototype,"basemapView",void 0),u([d()],kt.prototype,"center",null),u([d({readOnly:!0})],kt.prototype,"_defaultsFromMapSettings",null),u([d()],kt.prototype,"defaultsFromMap",null),u([d()],kt.prototype,"fatalError",void 0),u([d({type:Zr})],kt.prototype,"extent",null),u([d(kB(aR,"graphics"))],kt.prototype,"graphics",void 0),u([d(kB(VS,"analyses"))],kt.prototype,"analyses",void 0),u([d({readOnly:!0,type:EE})],kt.prototype,"heightModelInfo",null),u([d({readOnly:!0})],kt.prototype,"interacting",null),u([d({readOnly:!0})],kt.prototype,"navigating",null),u([d({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_currentSpatialReference","defaultsFromMap.ready","typeSpecificPreconditionsReady"]})],kt.prototype,"preconditionsReady",null),u([d({readOnly:!0})],kt.prototype,"typeSpecificPreconditionsReady",void 0),u([d({type:Pt,readOnly:!0})],kt.prototype,"layerViews",void 0),u([d()],kt.prototype,"resolution",null),u([d({type:dve})],kt.prototype,"magnifier",void 0),u([d({value:null,type:Mde})],kt.prototype,"map",null),u([d()],kt.prototype,"padding",void 0),u([d({readOnly:!0})],kt.prototype,"ready",void 0),u([d({type:et})],kt.prototype,"spatialReference",null),u([d()],kt.prototype,"spatialReferenceWarningDelay",void 0),u([d()],kt.prototype,"stationary",null),u([d({readOnly:!0})],kt.prototype,"supportsGround",void 0),u([d({type:_m})],kt.prototype,"timeExtent",void 0),u([d({type:WS,nonNullable:!0})],kt.prototype,"timeReference",void 0),u([d()],kt.prototype,"tools",null),u([d()],kt.prototype,"toolViewManager",void 0),u([d({readOnly:!0})],kt.prototype,"type",void 0),u([d({type:Number})],kt.prototype,"scale",void 0),u([d({readOnly:!0})],kt.prototype,"updating",void 0),u([d({readOnly:!0})],kt.prototype,"initialExtentRequired",void 0),u([d({readOnly:!0})],kt.prototype,"initialExtent",null),u([d()],kt.prototype,"cursor",null),u([d({readOnly:!0})],kt.prototype,"input",void 0),u([d({type:_ve,nonNullable:!0})],kt.prototype,"navigation",void 0),u([d()],kt.prototype,"layerViewManager",void 0),u([d()],kt.prototype,"analysisViewManager",void 0),u([d()],kt.prototype,"width",void 0),u([d()],kt.prototype,"height",void 0),u([d({readOnly:!0})],kt.prototype,"resizing",void 0),u([d({value:null,readOnly:!0})],kt.prototype,"size",null),u([d({readOnly:!0})],kt.prototype,"suspended",void 0),u([d({readOnly:!0})],kt.prototype,"viewEvents",void 0),u([d({readOnly:!0})],kt.prototype,"persistableViewModels",void 0),u([d()],kt.prototype,"_isValid",void 0),u([d()],kt.prototype,"_readyCycleForced",void 0),u([d()],kt.prototype,"_currentSpatialReference",void 0),kt=JL=u([I("esri.views.View")],kt);const GHe=kt;let B0=class extends ZD{constructor(e){super(e),this.state="running",this.target=null,this._dfd=null}initialize(){this.addResolvingPromise(new Promise((e,r)=>this._dfd={resolve:e,reject:r}))}get done(){return this.state==="finished"||this.state==="stopped"}stop(){var e;this.state!=="stopped"&&this.state!=="finished"&&(this._set("state","stopped"),(e=this._dfd)==null||e.reject(new q("ViewAnimation stopped")))}finish(){var e;this.state!=="stopped"&&this.state!=="finished"&&(this._set("state","finished"),(e=this._dfd)==null||e.resolve())}update(e,r){r||(r=Uu(e)?"waiting-for-target":"running"),this._set("target",e),this._set("state",r)}};u([d({readOnly:!0})],B0.prototype,"done",null),u([d({readOnly:!0,type:String})],B0.prototype,"state",void 0),u([d()],B0.prototype,"target",void 0),B0=u([I("esri.views.ViewAnimation")],B0),function(t){t.State={RUNNING:"running",STOPPED:"stopped",FINISHED:"finished",WAITING_FOR_TARGET:"waiting-for-target"}}(B0||(B0={}));const YS=B0,bC=()=>te(()=>import("./TileLayerView3D-860c8c3f.js"),["assets/TileLayerView3D-860c8c3f.js","assets/LayerView3D-6a4e3fea.js","assets/TiledLayerView3D-dc51bc1c.js","assets/LayerView-17796f9f.js","assets/RefreshableLayerView-60f1a82b.js","assets/MapServiceLayerViewHelper-fe78a2c0.js","assets/floorFilterUtils-080a7cd2.js","assets/sublayerUtils-7df8f7e7.js","assets/popupUtils-5b2188de.js","assets/drapedUtils-69610748.js"]),Vre=()=>te(()=>import("./ElevationLayerView3D-605d8195.js"),["assets/ElevationLayerView3D-605d8195.js","assets/LayerView3D-6a4e3fea.js","assets/TiledLayerView3D-dc51bc1c.js","assets/LayerView-17796f9f.js"]),Bre={"base-dynamic":()=>te(()=>import("./BaseDynamicLayerView3D-2ec7af6a.js"),["assets/BaseDynamicLayerView3D-2ec7af6a.js","assets/DynamicLayerView3D-8c9c8187.js","assets/LayerView3D-6a4e3fea.js","assets/projectExtentUtils-110dff46.js","assets/ImageMaterial-292dd32e.js","assets/LayerView-17796f9f.js","assets/RefreshableLayerView-60f1a82b.js"]),"base-elevation":Vre,"base-tile":bC,"bing-maps":bC,"building-scene":()=>te(()=>import("./BuildingSceneLayerView3D-298a483d.js"),["assets/BuildingSceneLayerView3D-298a483d.js","assets/BuildingGroupSublayer-dd46b013.js","assets/BuildingComponentSublayer-82b40894.js","assets/capabilities-a18453f6.js","assets/I3SIndexInfo-ae5fb55d.js","assets/I3SLayerDefinitions-c1849b7e.js","assets/I3SUtil-28b9b2cd.js","assets/I3SBinaryReader-a96fa99c.js","assets/popupUtils-5b2188de.js","assets/WhereClause-2e7ef2fe.js","assets/executionError-fb3f283a.js","assets/I3SMeshView3D-15e9825b.js","assets/I3SOverrides-4bf5f5ed.js","assets/I3SNode-8868b8e2.js","assets/RenderTexture-a5186133.js","assets/FeatureLayerView3D-1a876ffa.js","assets/FeatureLayerViewBase3D-bd1b9590.js","assets/FeatureLikeLayerView3D-3d440180.js","assets/dehydratedFeatureComparison-aa5ddb9e.js","assets/queryForSymbologySnapping-5bf81314.js","assets/elevationInfoUtils-10fbf022.js","assets/hash-0ddfbf4b.js","assets/Graphics3DObjectStates-4742e98a.js","assets/optimizedFeatureQueryEngineAdapter-9cf4c9eb.js","assets/centroid-0a3057d6.js","assets/PooledRBush-47b3e53d.js","assets/quickselect-56c5966e.js","assets/floorFilterUtils-080a7cd2.js","assets/QueryEngine-311866fa.js","assets/QueryEngineResult-a75eda3b.js","assets/utils-a8845e41.js","assets/generateRendererUtils-f1e35d90.js","assets/json-48e3ea08.js","assets/QueryEngineCapabilities-42e44ded.js","assets/FeatureStore-418dd9e9.js","assets/BoundsStore-968ad8c4.js","assets/projectExtentUtils-110dff46.js","assets/LayerView3D-6a4e3fea.js","assets/EventedSet-4f1779bb.js","assets/LayerView-17796f9f.js","assets/RefreshableLayerView-60f1a82b.js","assets/SceneModification-02ca2089.js","assets/persistable-04b556ba.js","assets/multiOriginJSONSupportUtils-c978f4c3.js","assets/resourceExtension-e15c22c9.js","assets/SceneLayerWorker-85ab02d4.js","assets/I3SQueryFeatureStore-67766877.js","assets/DefinitionExpressionSceneLayerView-b909bef3.js"]),csv:()=>te(()=>import("./CSVLayerView3D-36c6559b.js"),["assets/CSVLayerView3D-36c6559b.js","assets/FeatureLayerViewBase3D-bd1b9590.js","assets/FeatureLikeLayerView3D-3d440180.js","assets/dehydratedFeatureComparison-aa5ddb9e.js","assets/queryForSymbologySnapping-5bf81314.js","assets/elevationInfoUtils-10fbf022.js","assets/hash-0ddfbf4b.js","assets/Graphics3DObjectStates-4742e98a.js","assets/optimizedFeatureQueryEngineAdapter-9cf4c9eb.js","assets/centroid-0a3057d6.js","assets/PooledRBush-47b3e53d.js","assets/quickselect-56c5966e.js","assets/floorFilterUtils-080a7cd2.js","assets/QueryEngine-311866fa.js","assets/QueryEngineResult-a75eda3b.js","assets/WhereClause-2e7ef2fe.js","assets/executionError-fb3f283a.js","assets/utils-a8845e41.js","assets/generateRendererUtils-f1e35d90.js","assets/json-48e3ea08.js","assets/QueryEngineCapabilities-42e44ded.js","assets/FeatureStore-418dd9e9.js","assets/BoundsStore-968ad8c4.js","assets/projectExtentUtils-110dff46.js","assets/LayerView3D-6a4e3fea.js","assets/EventedSet-4f1779bb.js","assets/popupUtils-5b2188de.js","assets/LayerView-17796f9f.js","assets/RefreshableLayerView-60f1a82b.js"]),dimension:()=>te(()=>import("./DimensionLayerView3D-eb4a22c3.js"),["assets/DimensionLayerView3D-eb4a22c3.js","assets/LayerView3D-6a4e3fea.js","assets/LayerView-17796f9f.js"]),elevation:Vre,feature:()=>te(()=>import("./FeatureLayerView3D-1a876ffa.js"),["assets/FeatureLayerView3D-1a876ffa.js","assets/FeatureLayerViewBase3D-bd1b9590.js","assets/FeatureLikeLayerView3D-3d440180.js","assets/dehydratedFeatureComparison-aa5ddb9e.js","assets/queryForSymbologySnapping-5bf81314.js","assets/elevationInfoUtils-10fbf022.js","assets/hash-0ddfbf4b.js","assets/Graphics3DObjectStates-4742e98a.js","assets/optimizedFeatureQueryEngineAdapter-9cf4c9eb.js","assets/centroid-0a3057d6.js","assets/PooledRBush-47b3e53d.js","assets/quickselect-56c5966e.js","assets/floorFilterUtils-080a7cd2.js","assets/QueryEngine-311866fa.js","assets/QueryEngineResult-a75eda3b.js","assets/WhereClause-2e7ef2fe.js","assets/executionError-fb3f283a.js","assets/utils-a8845e41.js","assets/generateRendererUtils-f1e35d90.js","assets/json-48e3ea08.js","assets/QueryEngineCapabilities-42e44ded.js","assets/FeatureStore-418dd9e9.js","assets/BoundsStore-968ad8c4.js","assets/projectExtentUtils-110dff46.js","assets/LayerView3D-6a4e3fea.js","assets/EventedSet-4f1779bb.js","assets/popupUtils-5b2188de.js","assets/LayerView-17796f9f.js","assets/RefreshableLayerView-60f1a82b.js"]),geojson:()=>te(()=>import("./GeoJSONLayerView3D-d53e802a.js"),["assets/GeoJSONLayerView3D-d53e802a.js","assets/FeatureLayerViewBase3D-bd1b9590.js","assets/FeatureLikeLayerView3D-3d440180.js","assets/dehydratedFeatureComparison-aa5ddb9e.js","assets/queryForSymbologySnapping-5bf81314.js","assets/elevationInfoUtils-10fbf022.js","assets/hash-0ddfbf4b.js","assets/Graphics3DObjectStates-4742e98a.js","assets/optimizedFeatureQueryEngineAdapter-9cf4c9eb.js","assets/centroid-0a3057d6.js","assets/PooledRBush-47b3e53d.js","assets/quickselect-56c5966e.js","assets/floorFilterUtils-080a7cd2.js","assets/QueryEngine-311866fa.js","assets/QueryEngineResult-a75eda3b.js","assets/WhereClause-2e7ef2fe.js","assets/executionError-fb3f283a.js","assets/utils-a8845e41.js","assets/generateRendererUtils-f1e35d90.js","assets/json-48e3ea08.js","assets/QueryEngineCapabilities-42e44ded.js","assets/FeatureStore-418dd9e9.js","assets/BoundsStore-968ad8c4.js","assets/projectExtentUtils-110dff46.js","assets/LayerView3D-6a4e3fea.js","assets/EventedSet-4f1779bb.js","assets/popupUtils-5b2188de.js","assets/LayerView-17796f9f.js","assets/RefreshableLayerView-60f1a82b.js"]),graphics:()=>te(()=>import("./GraphicsLayerView3D-17d8173c.js"),["assets/GraphicsLayerView3D-17d8173c.js","assets/LayerView3D-6a4e3fea.js","assets/queryForSymbologySnapping-5bf81314.js","assets/elevationInfoUtils-10fbf022.js","assets/GraphicsProcessor-5ca4de52.js","assets/Graphics3DObjectStates-4742e98a.js","assets/optimizedFeatureQueryEngineAdapter-9cf4c9eb.js","assets/centroid-0a3057d6.js","assets/PooledRBush-47b3e53d.js","assets/quickselect-56c5966e.js","assets/projectExtentUtils-110dff46.js","assets/LayerView-17796f9f.js"]),group:()=>te(()=>import("./GroupLayerView-4d052070.js"),["assets/GroupLayerView-4d052070.js","assets/LayerView-17796f9f.js"]),imagery:()=>te(()=>import("./ImageryLayerView3D-65a3474c.js"),["assets/ImageryLayerView3D-65a3474c.js","assets/DynamicLayerView3D-8c9c8187.js","assets/LayerView3D-6a4e3fea.js","assets/projectExtentUtils-110dff46.js","assets/ImageMaterial-292dd32e.js","assets/LayerView-17796f9f.js","assets/RefreshableLayerView-60f1a82b.js","assets/popupUtils-5b2188de.js"]),"integrated-mesh":()=>te(()=>import("./IntegratedMeshLayerView3D-b5e694e6.js"),["assets/IntegratedMeshLayerView3D-b5e694e6.js","assets/I3SMeshView3D-15e9825b.js","assets/I3SOverrides-4bf5f5ed.js","assets/I3SNode-8868b8e2.js","assets/I3SUtil-28b9b2cd.js","assets/I3SBinaryReader-a96fa99c.js","assets/RenderTexture-a5186133.js","assets/FeatureLayerView3D-1a876ffa.js","assets/FeatureLayerViewBase3D-bd1b9590.js","assets/FeatureLikeLayerView3D-3d440180.js","assets/dehydratedFeatureComparison-aa5ddb9e.js","assets/queryForSymbologySnapping-5bf81314.js","assets/elevationInfoUtils-10fbf022.js","assets/hash-0ddfbf4b.js","assets/Graphics3DObjectStates-4742e98a.js","assets/optimizedFeatureQueryEngineAdapter-9cf4c9eb.js","assets/centroid-0a3057d6.js","assets/PooledRBush-47b3e53d.js","assets/quickselect-56c5966e.js","assets/floorFilterUtils-080a7cd2.js","assets/QueryEngine-311866fa.js","assets/QueryEngineResult-a75eda3b.js","assets/WhereClause-2e7ef2fe.js","assets/executionError-fb3f283a.js","assets/utils-a8845e41.js","assets/generateRendererUtils-f1e35d90.js","assets/json-48e3ea08.js","assets/QueryEngineCapabilities-42e44ded.js","assets/FeatureStore-418dd9e9.js","assets/BoundsStore-968ad8c4.js","assets/projectExtentUtils-110dff46.js","assets/LayerView3D-6a4e3fea.js","assets/EventedSet-4f1779bb.js","assets/popupUtils-5b2188de.js","assets/LayerView-17796f9f.js","assets/RefreshableLayerView-60f1a82b.js","assets/SceneModification-02ca2089.js","assets/persistable-04b556ba.js","assets/multiOriginJSONSupportUtils-c978f4c3.js","assets/resourceExtension-e15c22c9.js","assets/SceneLayerWorker-85ab02d4.js"]),"line-of-sight":()=>te(()=>import("./LineOfSightLayerView3D-97d4d8b2.js"),["assets/LineOfSightLayerView3D-97d4d8b2.js","assets/LayerView3D-6a4e3fea.js","assets/LayerView-17796f9f.js"]),"map-image":()=>te(()=>import("./MapImageLayerView3D-dd66a4e1.js"),["assets/MapImageLayerView3D-dd66a4e1.js","assets/DynamicLayerView3D-8c9c8187.js","assets/LayerView3D-6a4e3fea.js","assets/projectExtentUtils-110dff46.js","assets/ImageMaterial-292dd32e.js","assets/LayerView-17796f9f.js","assets/RefreshableLayerView-60f1a82b.js","assets/ExportImageParameters-7ae39a47.js","assets/floorFilterUtils-080a7cd2.js","assets/sublayerUtils-7df8f7e7.js","assets/MapServiceLayerViewHelper-fe78a2c0.js","assets/popupUtils-5b2188de.js","assets/drapedUtils-69610748.js"]),media:()=>te(()=>import("./MediaLayerView3D-0c00bcde.js"),["assets/MediaLayerView3D-0c00bcde.js","assets/MediaElementView-555babcb.js","assets/normalizeUtilsSync-7d22b6b0.js","assets/LayerView3D-6a4e3fea.js","assets/ImageMaterial-292dd32e.js","assets/LayerView-17796f9f.js"]),"ogc-feature":()=>te(()=>import("./OGCFeatureLayerView3D-ebcd7074.js"),["assets/OGCFeatureLayerView3D-ebcd7074.js","assets/FeatureLayerViewBase3D-bd1b9590.js","assets/FeatureLikeLayerView3D-3d440180.js","assets/dehydratedFeatureComparison-aa5ddb9e.js","assets/queryForSymbologySnapping-5bf81314.js","assets/elevationInfoUtils-10fbf022.js","assets/hash-0ddfbf4b.js","assets/Graphics3DObjectStates-4742e98a.js","assets/optimizedFeatureQueryEngineAdapter-9cf4c9eb.js","assets/centroid-0a3057d6.js","assets/PooledRBush-47b3e53d.js","assets/quickselect-56c5966e.js","assets/floorFilterUtils-080a7cd2.js","assets/QueryEngine-311866fa.js","assets/QueryEngineResult-a75eda3b.js","assets/WhereClause-2e7ef2fe.js","assets/executionError-fb3f283a.js","assets/utils-a8845e41.js","assets/generateRendererUtils-f1e35d90.js","assets/json-48e3ea08.js","assets/QueryEngineCapabilities-42e44ded.js","assets/FeatureStore-418dd9e9.js","assets/BoundsStore-968ad8c4.js","assets/projectExtentUtils-110dff46.js","assets/LayerView3D-6a4e3fea.js","assets/EventedSet-4f1779bb.js","assets/popupUtils-5b2188de.js","assets/LayerView-17796f9f.js","assets/RefreshableLayerView-60f1a82b.js"]),"open-street-map":bC,"oriented-imagery":()=>te(()=>import("./FeatureLayerView3D-1a876ffa.js"),["assets/FeatureLayerView3D-1a876ffa.js","assets/FeatureLayerViewBase3D-bd1b9590.js","assets/FeatureLikeLayerView3D-3d440180.js","assets/dehydratedFeatureComparison-aa5ddb9e.js","assets/queryForSymbologySnapping-5bf81314.js","assets/elevationInfoUtils-10fbf022.js","assets/hash-0ddfbf4b.js","assets/Graphics3DObjectStates-4742e98a.js","assets/optimizedFeatureQueryEngineAdapter-9cf4c9eb.js","assets/centroid-0a3057d6.js","assets/PooledRBush-47b3e53d.js","assets/quickselect-56c5966e.js","assets/floorFilterUtils-080a7cd2.js","assets/QueryEngine-311866fa.js","assets/QueryEngineResult-a75eda3b.js","assets/WhereClause-2e7ef2fe.js","assets/executionError-fb3f283a.js","assets/utils-a8845e41.js","assets/generateRendererUtils-f1e35d90.js","assets/json-48e3ea08.js","assets/QueryEngineCapabilities-42e44ded.js","assets/FeatureStore-418dd9e9.js","assets/BoundsStore-968ad8c4.js","assets/projectExtentUtils-110dff46.js","assets/LayerView3D-6a4e3fea.js","assets/EventedSet-4f1779bb.js","assets/popupUtils-5b2188de.js","assets/LayerView-17796f9f.js","assets/RefreshableLayerView-60f1a82b.js"]),"point-cloud":()=>te(()=>import("./PointCloudLayerView3D-1332d55b.js").then(t=>t.P),["assets/PointCloudLayerView3D-1332d55b.js","assets/LayerView3D-6a4e3fea.js","assets/I3SUtil-28b9b2cd.js","assets/I3SBinaryReader-a96fa99c.js","assets/PointCloudWorkerUtil-a711fd67.js","assets/PointCloudUniqueValueRenderer-91a80d2e.js","assets/PopupSceneLayerView-f6989764.js","assets/popupUtils-5b2188de.js","assets/LayerView-17796f9f.js"]),voxel:()=>te(()=>import("./VoxelLayerView3D-b3851348.js"),["assets/VoxelLayerView3D-b3851348.js","assets/LayerView3D-6a4e3fea.js","assets/PopupSceneLayerView-f6989764.js","assets/popupUtils-5b2188de.js","assets/LayerView-17796f9f.js"]),route:()=>te(()=>import("./RouteLayerView3D-1ea6b02f.js"),["assets/RouteLayerView3D-1ea6b02f.js","assets/Stop-7ed4c7e2.js","assets/LayerView3D-6a4e3fea.js","assets/GraphicsProcessor-5ca4de52.js","assets/Graphics3DObjectStates-4742e98a.js","assets/optimizedFeatureQueryEngineAdapter-9cf4c9eb.js","assets/centroid-0a3057d6.js","assets/PooledRBush-47b3e53d.js","assets/quickselect-56c5966e.js","assets/projectExtentUtils-110dff46.js","assets/EventedSet-4f1779bb.js","assets/LayerView-17796f9f.js"]),scene:t=>t.profile==null||t.profile==="mesh-pyramids"?te(()=>import("./SceneLayerView3D-345d39ae.js"),["assets/SceneLayerView3D-345d39ae.js","assets/WhereClause-2e7ef2fe.js","assets/executionError-fb3f283a.js","assets/floorFilterUtils-080a7cd2.js","assets/I3SMeshView3D-15e9825b.js","assets/I3SOverrides-4bf5f5ed.js","assets/I3SNode-8868b8e2.js","assets/I3SUtil-28b9b2cd.js","assets/I3SBinaryReader-a96fa99c.js","assets/RenderTexture-a5186133.js","assets/FeatureLayerView3D-1a876ffa.js","assets/FeatureLayerViewBase3D-bd1b9590.js","assets/FeatureLikeLayerView3D-3d440180.js","assets/dehydratedFeatureComparison-aa5ddb9e.js","assets/queryForSymbologySnapping-5bf81314.js","assets/elevationInfoUtils-10fbf022.js","assets/hash-0ddfbf4b.js","assets/Graphics3DObjectStates-4742e98a.js","assets/optimizedFeatureQueryEngineAdapter-9cf4c9eb.js","assets/centroid-0a3057d6.js","assets/PooledRBush-47b3e53d.js","assets/quickselect-56c5966e.js","assets/QueryEngine-311866fa.js","assets/QueryEngineResult-a75eda3b.js","assets/utils-a8845e41.js","assets/generateRendererUtils-f1e35d90.js","assets/json-48e3ea08.js","assets/QueryEngineCapabilities-42e44ded.js","assets/FeatureStore-418dd9e9.js","assets/BoundsStore-968ad8c4.js","assets/projectExtentUtils-110dff46.js","assets/LayerView3D-6a4e3fea.js","assets/EventedSet-4f1779bb.js","assets/popupUtils-5b2188de.js","assets/LayerView-17796f9f.js","assets/RefreshableLayerView-60f1a82b.js","assets/SceneModification-02ca2089.js","assets/persistable-04b556ba.js","assets/multiOriginJSONSupportUtils-c978f4c3.js","assets/resourceExtension-e15c22c9.js","assets/SceneLayerWorker-85ab02d4.js","assets/SceneLayerView-82200245.js","assets/DefinitionExpressionSceneLayerView-b909bef3.js","assets/I3SQueryFeatureStore-67766877.js","assets/PopupSceneLayerView-f6989764.js"]):te(()=>import("./SceneLayerGraphicsView3D-504f746e.js"),["assets/SceneLayerGraphicsView3D-504f746e.js","assets/I3SOverrides-4bf5f5ed.js","assets/I3SNode-8868b8e2.js","assets/I3SUtil-28b9b2cd.js","assets/I3SBinaryReader-a96fa99c.js","assets/RenderTexture-a5186133.js","assets/FeatureLayerView3D-1a876ffa.js","assets/FeatureLayerViewBase3D-bd1b9590.js","assets/FeatureLikeLayerView3D-3d440180.js","assets/dehydratedFeatureComparison-aa5ddb9e.js","assets/queryForSymbologySnapping-5bf81314.js","assets/elevationInfoUtils-10fbf022.js","assets/hash-0ddfbf4b.js","assets/Graphics3DObjectStates-4742e98a.js","assets/optimizedFeatureQueryEngineAdapter-9cf4c9eb.js","assets/centroid-0a3057d6.js","assets/PooledRBush-47b3e53d.js","assets/quickselect-56c5966e.js","assets/floorFilterUtils-080a7cd2.js","assets/QueryEngine-311866fa.js","assets/QueryEngineResult-a75eda3b.js","assets/WhereClause-2e7ef2fe.js","assets/executionError-fb3f283a.js","assets/utils-a8845e41.js","assets/generateRendererUtils-f1e35d90.js","assets/json-48e3ea08.js","assets/QueryEngineCapabilities-42e44ded.js","assets/FeatureStore-418dd9e9.js","assets/BoundsStore-968ad8c4.js","assets/projectExtentUtils-110dff46.js","assets/LayerView3D-6a4e3fea.js","assets/EventedSet-4f1779bb.js","assets/popupUtils-5b2188de.js","assets/LayerView-17796f9f.js","assets/RefreshableLayerView-60f1a82b.js","assets/SceneLayerView-82200245.js","assets/DefinitionExpressionSceneLayerView-b909bef3.js","assets/PopupSceneLayerView-f6989764.js"]),stream:()=>te(()=>import("./StreamLayerView3D-6f58aad9.js"),["assets/StreamLayerView3D-6f58aad9.js","assets/StreamFeatureManager-b41ee58c.js","assets/createConnection-ea8ef70b.js","assets/EventedSet-4f1779bb.js","assets/FeatureLikeLayerView3D-3d440180.js","assets/dehydratedFeatureComparison-aa5ddb9e.js","assets/queryForSymbologySnapping-5bf81314.js","assets/elevationInfoUtils-10fbf022.js","assets/hash-0ddfbf4b.js","assets/Graphics3DObjectStates-4742e98a.js","assets/optimizedFeatureQueryEngineAdapter-9cf4c9eb.js","assets/centroid-0a3057d6.js","assets/PooledRBush-47b3e53d.js","assets/quickselect-56c5966e.js","assets/floorFilterUtils-080a7cd2.js","assets/QueryEngine-311866fa.js","assets/QueryEngineResult-a75eda3b.js","assets/WhereClause-2e7ef2fe.js","assets/executionError-fb3f283a.js","assets/utils-a8845e41.js","assets/generateRendererUtils-f1e35d90.js","assets/json-48e3ea08.js","assets/QueryEngineCapabilities-42e44ded.js","assets/FeatureStore-418dd9e9.js","assets/BoundsStore-968ad8c4.js","assets/projectExtentUtils-110dff46.js","assets/LayerView3D-6a4e3fea.js","assets/LayerView-17796f9f.js"]),tile:bC,"imagery-tile":()=>te(()=>import("./ImageryTileLayerView3D-02e365e2.js"),["assets/ImageryTileLayerView3D-02e365e2.js","assets/LayerView3D-6a4e3fea.js","assets/TiledLayerView3D-dc51bc1c.js","assets/rasterProjectionHelper-816895fe.js","assets/popupUtils-5b2188de.js","assets/LayerView-17796f9f.js","assets/RefreshableLayerView-60f1a82b.js","assets/drapedUtils-69610748.js"]),"vector-tile":()=>te(()=>import("./VectorTileLayerView3D-9632d2f3.js"),["assets/VectorTileLayerView3D-9632d2f3.js","assets/Rect-98da58d6.js","assets/rasterizingUtils-399b821b.js","assets/StyleRepository-099a12b6.js","assets/enums-c655c737.js","assets/colorUtils-c0f43caf.js","assets/TileClipper-ae6eca9e.js","assets/TileInfoView-c864a057.js","assets/number-b10bd8f5.js","assets/GeometryUtils-0258f920.js","assets/LayerView3D-6a4e3fea.js","assets/TiledLayerView3D-dc51bc1c.js","assets/LayerView-17796f9f.js"]),wcs:()=>te(()=>import("./ImageryTileLayerView3D-02e365e2.js"),["assets/ImageryTileLayerView3D-02e365e2.js","assets/LayerView3D-6a4e3fea.js","assets/TiledLayerView3D-dc51bc1c.js","assets/rasterProjectionHelper-816895fe.js","assets/popupUtils-5b2188de.js","assets/LayerView-17796f9f.js","assets/RefreshableLayerView-60f1a82b.js","assets/drapedUtils-69610748.js"]),"web-tile":bC,wfs:()=>te(()=>import("./WFSLayerView3D-39ba3363.js"),["assets/WFSLayerView3D-39ba3363.js","assets/FeatureLayerViewBase3D-bd1b9590.js","assets/FeatureLikeLayerView3D-3d440180.js","assets/dehydratedFeatureComparison-aa5ddb9e.js","assets/queryForSymbologySnapping-5bf81314.js","assets/elevationInfoUtils-10fbf022.js","assets/hash-0ddfbf4b.js","assets/Graphics3DObjectStates-4742e98a.js","assets/optimizedFeatureQueryEngineAdapter-9cf4c9eb.js","assets/centroid-0a3057d6.js","assets/PooledRBush-47b3e53d.js","assets/quickselect-56c5966e.js","assets/floorFilterUtils-080a7cd2.js","assets/QueryEngine-311866fa.js","assets/QueryEngineResult-a75eda3b.js","assets/WhereClause-2e7ef2fe.js","assets/executionError-fb3f283a.js","assets/utils-a8845e41.js","assets/generateRendererUtils-f1e35d90.js","assets/json-48e3ea08.js","assets/QueryEngineCapabilities-42e44ded.js","assets/FeatureStore-418dd9e9.js","assets/BoundsStore-968ad8c4.js","assets/projectExtentUtils-110dff46.js","assets/LayerView3D-6a4e3fea.js","assets/EventedSet-4f1779bb.js","assets/popupUtils-5b2188de.js","assets/LayerView-17796f9f.js","assets/RefreshableLayerView-60f1a82b.js"]),wms:()=>te(()=>import("./WMSLayerView3D-e1f29324.js"),["assets/WMSLayerView3D-e1f29324.js","assets/DynamicLayerView3D-8c9c8187.js","assets/LayerView3D-6a4e3fea.js","assets/projectExtentUtils-110dff46.js","assets/ImageMaterial-292dd32e.js","assets/LayerView-17796f9f.js","assets/RefreshableLayerView-60f1a82b.js","assets/ExportWMSImageParameters-86c17c25.js"]),wmts:()=>te(()=>import("./WMTSLayerView3D-797fd703.js"),["assets/WMTSLayerView3D-797fd703.js","assets/LayerView3D-6a4e3fea.js","assets/TiledLayerView3D-dc51bc1c.js","assets/LayerView-17796f9f.js","assets/RefreshableLayerView-60f1a82b.js"]),"geo-rss":null,kml:null,"knowledge-graph":null,"link-chart":null,"knowledge-graph-sublayer":null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null};function jHe(t){const e=t.declaredClass?t.declaredClass.slice(t.declaredClass.lastIndexOf(".")+1):"Unknown",r=e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new q(`${r}:view-not-supported`,`${e} is not supported in 3D`)}const zre={hasLayerViewModule:t=>v(Bre[t.type]),importLayerView:t=>{const e=Bre[t.type];if(C(e))throw jHe(t);return e(t)}},Gre="analyses-owner-handles";var A2,xb;(function(t){t[t.PENDING=0]="PENDING",t[t.CREATED=1]="CREATED"})(A2||(A2={})),function(t){t[t.ADDED=0]="ADDED",t[t.REMOVED=1]="REMOVED"}(xb||(xb={}));let Y1=class extends ZR{constructor(e){super(e),this._allAnalysisViews=new Pt,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._attachedToViewResolver=jre(),this._analysisModules={"area-measurement":{module:null},dimension:{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null}}}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject(Hr("AnalysisViewManager was destroyed"))}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject(Hr()),this._attachedToViewResolver=jre()}get updating(){return!this.view.ready||this._creatingViewCount!==0||this._allAnalysisViews.some(e=>e.updating)}get testInfo(){return{allAnalysisViews:this._allAnalysisViews}}async whenAnalysisView(e){await this._attachedToViewResolver.promise;const r=this._items.get(e);if(C(r)||r.state.list===xb.REMOVED)throw new q("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return r.createAnalysisViewTask.promise}_connectOwners(){this.handles.add(this._connectAnalysesCollection(this.view.analyses),Gre)}_disconnectOwners(){this.handles.remove(Gre),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(e){for(const s of e)this._addAnalysis(s);const r=e.on("after-add",s=>this._addAnalysis(s.item)),i=e.on("after-remove",s=>this._removeAnalysis(s.item));return{remove:()=>{r.remove(),i.remove();for(const s of e)this._removeAnalysis(s)}}}_addAnalysis(e){const r=this._items.get(e);if(r==null){const i={state:{view:A2.PENDING,list:xb.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,i),i.createAnalysisViewTask=YO(s=>this._createAnalysisViewPromise(i,s))}else r.state.list=xb.ADDED}_removeAnalysis(e){const r=this._items.get(e);r!=null?(r.state.list=xb.REMOVED,this._scheduleUpdate()):se.getLogger(this.declaredClass).error("Trying to remove analysis which was not added")}_scheduleUpdate(){v(this._scheduledUpdateHandle)||(this._scheduledUpdateHandle=gE(()=>this._update()))}_update(){this._scheduledUpdateHandle=ji(this._scheduledUpdateHandle),this._items.forEach(e=>{if(e.state.list===xb.REMOVED)switch(this._items.delete(e.analysis),e.state.view){case A2.PENDING:e.createAnalysisViewTask=Fh(e.createAnalysisViewTask);break;case A2.CREATED:v(e.view)&&(this._allAnalysisViews.remove(e.view),e.view=ke(e.view),e.createAnalysisViewTask=null)}})}async _createAnalysisViewPromise(e,r){const i=e.analysis,s=i.type,n=this._analysisModules[s];if(this._creatingViewCount+=1,C(n.module))try{n.module=await this._loadAnalysisModule(s)}catch(a){throw this._creatingViewCount-=1,a}if(Ln(r))throw this._creatingViewCount-=1,Hr("AnalysisView creation aborted");const o=new n.module.default({analysis:i,view:this.view});try{await o.when()}catch(a){throw this._creatingViewCount-=1,a}if(Ln(r))throw this._creatingViewCount-=1,o.destroy(),Hr("AnalysisView creation aborted");return e.view=o,e.state.view=A2.CREATED,this._allAnalysisViews.add(o),this._creatingViewCount-=1,o}_loadAnalysisModule(e){switch(e){case"area-measurement":return te(()=>import("./AreaMeasurementAnalysisView3D-ceac29ff.js").then(r=>r.A),["assets/AreaMeasurementAnalysisView3D-ceac29ff.js","assets/analysisThemeUtils-649bd6a8.js","assets/Segment-6c61f9bf.js","assets/LineVisualElement-901b3a69.js","assets/elevationInfoUtils-10fbf022.js","assets/geometryEngine-e660e33f.js","assets/geometryEngineBase-e1a33b0a.js","assets/hydrated-69b3d367.js","assets/EditGeometryOperations-0319718a.js"]);case"dimension":return te(()=>import("./DimensionAnalysisView3D-3e1bbd13.js").then(r=>r.D),["assets/DimensionAnalysisView3D-3e1bbd13.js","assets/LineVisualElement-901b3a69.js","assets/LengthDimension-5c564e9a.js","assets/Segment-6c61f9bf.js","assets/elevationInfoUtils-10fbf022.js","assets/analysisViewUtils-40ed6f5d.js","assets/ImageMaterial-292dd32e.js","assets/Factory-8829b7a4.js","assets/RightAngleQuadVisualElement-d6319a8f.js","assets/VisualElementResources-a5b06114.js","assets/PointVisualElement-34f1a7e7.js","assets/colorUtils-c0f43caf.js","assets/EditGeometryOperations-0319718a.js","assets/QueryEngineResult-a75eda3b.js","assets/WhereClause-2e7ef2fe.js","assets/executionError-fb3f283a.js","assets/utils-a8845e41.js","assets/generateRendererUtils-f1e35d90.js","assets/json-48e3ea08.js","assets/dehydratedFeatureComparison-aa5ddb9e.js","assets/RenderTexture-a5186133.js"]);case"direct-line-measurement":return te(()=>import("./DirectLineMeasurementAnalysisView3D-4164e8f1.js").then(r=>r.D),["assets/DirectLineMeasurementAnalysisView3D-4164e8f1.js","assets/analysisThemeUtils-649bd6a8.js","assets/Segment-6c61f9bf.js","assets/LineVisualElement-901b3a69.js","assets/elevationInfoUtils-10fbf022.js","assets/geometryEngine-e660e33f.js","assets/geometryEngineBase-e1a33b0a.js","assets/hydrated-69b3d367.js","assets/RightAngleQuadVisualElement-d6319a8f.js","assets/VisualElementResources-a5b06114.js"]);case"line-of-sight":return te(()=>import("./LineOfSightAnalysisView3D-ccf24e22.js"),["assets/LineOfSightAnalysisView3D-ccf24e22.js","assets/LineVisualElement-901b3a69.js","assets/LineOfSightAnalysisTarget-eed4886f.js","assets/persistable-04b556ba.js","assets/multiOriginJSONSupportUtils-c978f4c3.js","assets/resourceExtension-e15c22c9.js","assets/elevationInfoUtils-10fbf022.js","assets/analysisViewUtils-40ed6f5d.js","assets/ImageMaterial-292dd32e.js","assets/PointVisualElement-34f1a7e7.js","assets/VisualElementResources-a5b06114.js"]);case"slice":return te(()=>import("./SliceAnalysisView3D-c3661603.js").then(r=>r.S),["assets/SliceAnalysisView3D-c3661603.js","assets/LineVisualElement-901b3a69.js","assets/persistable-04b556ba.js","assets/multiOriginJSONSupportUtils-c978f4c3.js","assets/resourceExtension-e15c22c9.js","assets/BuildingComponentSublayer-82b40894.js","assets/capabilities-a18453f6.js","assets/I3SIndexInfo-ae5fb55d.js","assets/I3SLayerDefinitions-c1849b7e.js","assets/I3SUtil-28b9b2cd.js","assets/I3SBinaryReader-a96fa99c.js","assets/popupUtils-5b2188de.js","assets/analysisViewUtils-40ed6f5d.js","assets/ImageMaterial-292dd32e.js","assets/Factory-8829b7a4.js"])}}};function jre(){const t=H_();return t.promise.catch(()=>{}),t}u([d()],Y1.prototype,"updating",null),u([d({constructOnly:!0})],Y1.prototype,"view",void 0),u([d()],Y1.prototype,"_allAnalysisViews",void 0),u([d()],Y1.prototype,"_creatingViewCount",void 0),Y1=u([I("esri.views.3d.analysis.AnalysisViewManager3D")],Y1);const HHe=Y1;let dg=class extends Te{constructor(e){super(e),this.collision=new s3,this.distance=1/0,this.minimumPoiDistance=4,this.tilt=null}get altitude(){return this.mode===Be.Local?null:this._get("altitude")||null}set altitude(e){this.mode!==Be.Local?this._set("altitude",e):se.getLogger(this.declaredClass).warn("Altitude constraint is ignored in local scenes")}clampAltitude(e){return this.altitude?ge(e,this.altitude.min,this.altitude.max):e}clampTilt(e,r){if(!this.tilt)return r;const i=this.tilt(e);return ge(r,i.min,i.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return this.mode===Be.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return(r,i=i8)=>(i.min=Go.min,i.max=e,i)}_createDefaultTiltLocal(){const e=this.collision.enabled?vL([[4e3,Go.max],[1e4,Gt(88)],[6e6,Gt(88)]]):()=>Go.max;return(r,i=i8)=>(i.min=Go.min,i.max=e(r),i)}_createDefaultTiltGlobal(){const e=this.collision.enabled?vL([[4e3,Go.max],[5e4,Gt(88)],[6e6,Gt(88)],[2e7,Go.min]]):vL([[3e5,Go.max],[3e6,Gt(88)],[6e6,Gt(88)],[2e7,Go.min]]);return(r,i=i8)=>(i.min=Go.min,i.max=e(r),i)}};function qHe(t){return{min:-2e5,max:4*t.radius}}u([d()],dg.prototype,"altitude",null),u([d({readOnly:!0})],dg.prototype,"collision",void 0),u([d()],dg.prototype,"distance",void 0),u([d({readOnly:!0})],dg.prototype,"minimumPoiDistance",void 0),u([d()],dg.prototype,"tilt",void 0),u([d({constructOnly:!0})],dg.prototype,"mode",void 0),dg=u([I("esri.views.3d.state.Constraints")],dg);const Hre=qHe(wr),Go={min:Gt(.5),max:Gt(179.5)},i8={min:0,max:0};let s3=class extends Te{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};u([d({type:Boolean})],s3.prototype,"enabled",void 0),u([d({type:Number})],s3.prototype,"elevationMargin",void 0),s3=u([I("esri.views.3d.state.Constraints.CollisionConstraint")],s3);let R2=class extends Te{constructor(){super(...arguments),this.min=Hre.min,this.max=Hre.max}};u([d({type:Number})],R2.prototype,"min",void 0),u([d({type:Number})],R2.prototype,"max",void 0),R2=u([I("esri.views.3d.constraints.AltitudeConstraint")],R2);let wg=class extends Te{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,r){this.mode==="auto"&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==r&&this._set("far",r))}};u([d({type:Number,value:1e-8})],wg.prototype,"near",null),u([cr("near")],wg.prototype,"castNear",null),u([d({type:Number,value:1e-8})],wg.prototype,"far",null),u([cr("far")],wg.prototype,"castFar",null),u([d({type:["auto","manual"]})],wg.prototype,"mode",void 0),wg=u([I("esri.views.3d.constraints.ClipDistanceConstraint")],wg);const nG={min:rl(Go.min),max:rl(Go.max)};let Tb=class extends Te{constructor(){super(...arguments),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return ge(e,nG.min,nG.max)}autoUpdate(e){this.mode==="auto"&&this._get("max")!==e&&this._set("max",e)}};u([d({type:["auto","manual"]})],Tb.prototype,"mode",void 0),u([d({type:Number,value:nG.max})],Tb.prototype,"max",null),u([cr("max")],Tb.prototype,"castMax",null),Tb=u([I("esri.views.3d.constraints.TiltConstraint")],Tb);let Sb=class extends Te{constructor(){super(...arguments),this.tilt=new Tb,this.altitude=new R2,this.clipDistance=new wg}};u([d({type:Tb})],Sb.prototype,"tilt",void 0),u([d({type:R2})],Sb.prototype,"altitude",void 0),u([d({type:wg})],Sb.prototype,"clipDistance",void 0),Sb=u([I("esri.views.3d.constraints.Constraints")],Sb);var oG;let lh=oG=class extends ve{constructor(t){super(t),this.type="sun",this.date=null,this.directShadowsEnabled=!1,this.displayUTCOffset=null}readDate(t,e){return e.datetime!=null&&new Date(e.datetime)||null}writeDate(t,e,r){e[r]=t.getTime()}readDirectShadowsEnabled(t,e){return!!e.directShadows}writedirectShadowsEnabled(t,e,r){t&&(e[r]=t)}writeDisplayUTCOffset(t,e){t!=null&&(e.displayUTCOffset=t)}clone(){return new oG(this.cloneConstructProperties())}cloneConstructProperties(){const t={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:this.displayUTCOffset!=null?this.displayUTCOffset:null};return this.date!=null&&(t.date=new Date(this.date.getTime())),t}};u([d({readOnly:!0,type:["sun"],json:{write:!0}})],lh.prototype,"type",void 0),u([d({type:Date,json:{type:Number,write:{target:"datetime"}}})],lh.prototype,"date",void 0),u([Fe("date",["datetime"])],lh.prototype,"readDate",null),u([He("date")],lh.prototype,"writeDate",null),u([d({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],lh.prototype,"directShadowsEnabled",void 0),u([Fe("directShadowsEnabled",["directShadows"])],lh.prototype,"readDirectShadowsEnabled",null),u([He("directShadowsEnabled")],lh.prototype,"writedirectShadowsEnabled",null),u([d({type:Number,json:{write:!0}})],lh.prototype,"displayUTCOffset",void 0),u([He("displayUTCOffset")],lh.prototype,"writeDisplayUTCOffset",null),lh=oG=u([I("esri.webscene.SunLighting")],lh);const lO=lh;var XT;let hf=XT=class extends vs.EventedMixin(lO){constructor(t){super(t),this.cameraTrackingEnabled=!0,this.ambientOcclusionEnabled=!1,this.waterReflectionEnabled=!1,this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0};const e=new Date().getFullYear(),r=new Date("March 15, "+e+" 12:00:00 UTC");this._set("defaultDate",r),this._set("date",r)}get defaultDate(){return new Date(this._get("defaultDate").getTime())}static fromWebsceneLighting(t){return new XT(t.cloneConstructProperties())}set defaultDate(t){const e=this._get("date")===this._get("defaultDate");t=new Date(t.getTime()),this._set("defaultDate",t),e&&this._set("date",t)}set date(t){t!=null&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(t.getTime())))}autoUpdate(t,e){const r=XT.calculateTimezoneOffset(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=e.hours,this.positionTimezoneInfo.minutes=e.minutes,this.positionTimezoneInfo.seconds=e.seconds;let i=null;v(t)&&(this.positionTimezoneInfo.autoUpdated=!0,isNaN(t.getTime())?(i=this.defaultDate.getTime(),this._set("date",this.defaultDate)):(i=this.date&&this.date.getTime(),this._set("date",new Date(t.getTime()))));const s=XT.calculateTimezoneOffset(this.positionTimezoneInfo);if(r!==s&&(s8.target=this,s8.timezoneOffset=s,this.emit("timezone-will-change",s8)),v(t))return!!isNaN(t.getTime())||i!==t.getTime()}clone(){const t=this._get("date")===this._get("defaultDate"),e=new XT({...this.cloneConstructProperties(),defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled,ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled});return t&&e._set("date",e._get("defaultDate")),e.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,e.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,e.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,e.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,e}cloneWithWebsceneLighting(t){const e=this.clone();return t.date!=null&&(e.date=t.date),e.directShadowsEnabled=t.directShadowsEnabled,e.displayUTCOffset=t.displayUTCOffset,e}cloneNonPersistentConstructProperties(){return{ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled,cameraTrackingEnabled:this.cameraTrackingEnabled}}};u([d({type:Boolean})],hf.prototype,"cameraTrackingEnabled",void 0),u([d({type:Boolean})],hf.prototype,"ambientOcclusionEnabled",void 0),u([d({type:Boolean})],hf.prototype,"waterReflectionEnabled",void 0),u([d({type:Date})],hf.prototype,"defaultDate",null),u([d({type:Date})],hf.prototype,"date",null),hf=XT=u([I("esri.views.3d.environment.SunLighting")],hf),function(t){function e({hours:r,minutes:i,seconds:s}){return Math.round(r+i/60+s/3600)}t.calculateTimezoneOffset=e}(hf||(hf={}));const s8={target:null,timezoneOffset:0},z0=hf;var aG;let n3=aG=class extends ve{constructor(t){super(t),this.type="virtual",this.directShadowsEnabled=!1}clone(){return new aG(this.cloneConstructProperties())}cloneConstructProperties(){return{directShadowsEnabled:this.directShadowsEnabled}}};u([d({readOnly:!0,type:["virtual"],json:{write:!0}})],n3.prototype,"type",void 0),u([d({type:Boolean,json:{default:!1,name:"directShadows",write:!0}})],n3.prototype,"directShadowsEnabled",void 0),n3=aG=u([I("esri.webscene.VirtualLighting")],n3);const f5=n3;var KL;let YT=KL=class extends vs.EventedMixin(f5){constructor(t){super(t),this.ambientOcclusionEnabled=!1,this.waterReflectionEnabled=!1,this.cameraTrackingEnabled=!0}clone(){return new KL({...this.cloneConstructProperties(),ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled,cameraTrackingEnabled:this.cameraTrackingEnabled})}static fromWebsceneLighting(t){return new KL(t.cloneConstructProperties())}cloneWithWebsceneLighting(t){const e=this.clone();return e.directShadowsEnabled=t.directShadowsEnabled,e}cloneNonPersistentConstructProperties(){return{ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled,cameraTrackingEnabled:this.cameraTrackingEnabled}}};u([d({type:Boolean})],YT.prototype,"ambientOcclusionEnabled",void 0),u([d({type:Boolean})],YT.prototype,"waterReflectionEnabled",void 0),u([d({type:Boolean})],YT.prototype,"cameraTrackingEnabled",void 0),YT=KL=u([I("esri.views.3d.environment.VirtualLighting")],YT);const o3=YT,WHe={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:z0,virtual:o3}};var lG;let lR=lG=class extends Te{set quality(t){["low","high"].includes(t)&&this._set("quality",t)}clone(){return new lG({quality:this.quality})}};u([d({type:["low","high"],value:"low"})],lR.prototype,"quality",null),lR=lG=u([I("esri.views.3d.environment.SceneViewAtmosphere")],lR);var cG;let a3=cG=class extends ve{constructor(t){super(t),this.type="sunny",this.cloudCover=.5}clone(){return new cG({cloudCover:this.cloudCover})}};u([gt({sunny:"sunny"})],a3.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],a3.prototype,"cloudCover",void 0),a3=cG=u([I("esri.views.3d.environment.SunnyWeather")],a3);const uG=a3;var hG;let l3=hG=class extends ve{constructor(t){super(t),this.type="cloudy",this.cloudCover=.5}clone(){return new hG({cloudCover:this.cloudCover})}};u([gt({cloudy:"cloudy"})],l3.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],l3.prototype,"cloudCover",void 0),l3=hG=u([I("esri.views.3d.environment.CloudyWeather")],l3);const XHe=l3;var dG;let c3=dG=class extends ve{constructor(t){super(t),this.type="foggy",this.fogStrength=.5}clone(){return new dG({fogStrength:this.fogStrength})}};u([gt({foggy:"foggy"})],c3.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],c3.prototype,"fogStrength",void 0),c3=dG=u([I("esri.views.3d.environment.FoggyWeather")],c3);const YHe=c3;var pG;let ZT=pG=class extends ve{constructor(t){super(t),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new pG({cloudCover:this.cloudCover,precipitation:this.precipitation})}};u([gt({rainy:"rainy"})],ZT.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],ZT.prototype,"cloudCover",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],ZT.prototype,"precipitation",void 0),ZT=pG=u([I("esri.views.3d.environment.RainyWeather")],ZT);const ZHe=ZT;var fG;let Z1=fG=class extends ve{constructor(t){super(t),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new fG({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};u([gt({snowy:"snowy"})],Z1.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Z1.prototype,"cloudCover",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Z1.prototype,"precipitation",void 0),u([d({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],Z1.prototype,"snowCover",void 0),Z1=fG=u([I("esri.views.3d.environment.SnowyWeather")],Z1);const JHe=Z1,Eve={key:"type",base:uG,typeMap:{sunny:uG,cloudy:XHe,rainy:ZHe,snowy:JHe,foggy:YHe}},KHe=Object.keys(Eve.typeMap);function QHe(t,e){return!!KHe.includes(t)||(e.error(`"${t}" is not a valid weather type`),!1)}const _h=1e4,eqe={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:lO,virtual:f5}};let QL=class extends ve{constructor(e){super(e)}clone(){}};u([d({readOnly:!0,json:{read:!1}})],QL.prototype,"type",void 0),QL=u([I("esri.webscene.background.Background")],QL);const Cve=QL;var mG;const tqe={...ly,nonNullable:!0};let u3=mG=class extends Cve{constructor(t){super(t),this.type="color",this.color=new Ze([0,0,0,1])}clone(){return new mG(this.cloneProperties())}cloneProperties(){return{color:this.color.clone()}}};u([gt({color:"color"},{readOnly:!0})],u3.prototype,"type",void 0),u([d(tqe)],u3.prototype,"color",void 0),u3=mG=u([I("esri.webscene.background.ColorBackground")],u3);const Ave=u3,qre={base:Cve,key:"type",typeMap:{color:Ave}};function rqe(t){return(e,r,i)=>{if(!e)return e;for(const s in t.typeMap)if(e.type===s){const n=new t.typeMap[s];return n.read(e,i),n}}}const iqe={types:qre,json:{read:rqe(qre),write:{overridePolicy:(t,e,r)=>({enabled:!r||!r.isPresentation})}}};var gG;const Rve="esri.webscene.Environment",sqe=se.getLogger(Rve),Wre=(t,e,r)=>({enabled:!r||!r.isPresentation});let G0=gG=class extends ve{constructor(t){super(t),this.lighting=new lO,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0}set weather(t){QHe(t==null?void 0:t.type,sqe)&&this._set("weather",t)}clone(){return new gG(this.cloneConstructProperties())}cloneConstructProperties(){return{lighting:this.lighting&&this.lighting.type==="virtual"?f5.prototype.clone.call(this.lighting):lO.prototype.clone.call(this.lighting),background:ne(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,weather:this.weather.clone()}}};u([d({types:eqe,nonNullable:!0,json:{write:!0}})],G0.prototype,"lighting",void 0),u([d(iqe)],G0.prototype,"background",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:Wre}}})],G0.prototype,"atmosphereEnabled",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:Wre}}})],G0.prototype,"starsEnabled",void 0),u([d({types:Eve,nonNullable:!0,json:{write:!0},value:new uG})],G0.prototype,"weather",null),G0=gG=u([I(Rve)],G0);const Ove=G0;var h3;let JT=h3=class extends Ove{constructor(t){super(t),this.atmosphere=new lR,this.lighting=new z0,this.cachedCameraTrackingEnabled=null}static fromWebsceneEnvironment(t){const e=t.cloneConstructProperties();return new h3({...e,lighting:e.lighting?e.lighting.type==="virtual"?o3.fromWebsceneLighting(e.lighting):z0.fromWebsceneLighting(e.lighting):void 0})}castLighting(t){return this._convertLighting(t)}applyLighting(t){this.lighting=this._convertLighting(t)}_convertLighting(t){var e,r;return t?t instanceof z0||t instanceof o3?t:t instanceof lO?this.lighting&&this.lighting.type!=="virtual"?this.lighting.cloneWithWebsceneLighting(t):new z0({...t.cloneConstructProperties(),...(e=this.lighting)==null?void 0:e.cloneNonPersistentConstructProperties()}):t instanceof f5?this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(t):new o3({...t.cloneConstructProperties(),...(r=this.lighting)==null?void 0:r.cloneNonPersistentConstructProperties()}):up(WHe,t):new z0}clone(){return new h3({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:ne(this.background)})}cloneWithWebsceneEnvironment(t){return new h3({atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:ne(this.background),...t.cloneConstructProperties(),lighting:this._getLighting(t)})}_getLighting(t){switch(t.lighting.type){case"sun":return this.lighting&&this.lighting.type==="sun"?this.lighting.cloneWithWebsceneLighting(t.lighting):z0.fromWebsceneLighting(t.lighting);case"virtual":return this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(t.lighting):o3.fromWebsceneLighting(t.lighting);default:return t.lighting,z0.fromWebsceneLighting(t.lighting)}}};u([d({type:lR,json:{read:!1},nonNullable:!0})],JT.prototype,"atmosphere",void 0),u([d({nonNullable:!0})],JT.prototype,"lighting",void 0),u([cr("lighting")],JT.prototype,"castLighting",null),JT=h3=u([I("esri.views.3d.environment.SceneViewEnvironment")],JT);const KT=JT;var An;(function(t){t[t.Simple=0]="Simple",t[t.Realistic=1]="Realistic",t[t.Panoramic=2]="Panoramic",t[t.None=3]="None"})(An||(An={}));function Un(t,e){return t[0]=e[0],t[1]=e[1],t}function or(t,e,r){return t[0]=e,t[1]=r,t}function Vd(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t}function If(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t}function Mve(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t}function Pve(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t}function nqe(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t}function oqe(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t}function aqe(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t}function lqe(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t}function cqe(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t}function Sc(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t}function uqe(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t}function Cw(t,e){const r=e[0]-t[0],i=e[1]-t[1];return Math.sqrt(r*r+i*i)}function YN(t,e){const r=e[0]-t[0],i=e[1]-t[1];return r*r+i*i}function JX(t){const e=t[0],r=t[1];return Math.sqrt(e*e+r*r)}function Ive(t){const e=t[0],r=t[1];return e*e+r*r}function KX(t,e){return t[0]=-e[0],t[1]=-e[1],t}function hqe(t,e){return t[0]=1/e[0],t[1]=1/e[1],t}function cO(t,e){const r=e[0],i=e[1];let s=r*r+i*i;return s>0&&(s=1/Math.sqrt(s),t[0]=e[0]*s,t[1]=e[1]*s),t}function pn(t,e){return t[0]*e[0]+t[1]*e[1]}function dqe(t,e,r){const i=e[0]*r[1]-e[1]*r[0];return t[0]=t[1]=0,t[2]=i,t}function QT(t,e,r,i){const s=e[0],n=e[1];return t[0]=s+i*(r[0]-s),t[1]=n+i*(r[1]-n),t}function pqe(t,e){e=e||1;const r=2*JO()*Math.PI;return t[0]=Math.cos(r)*e,t[1]=Math.sin(r)*e,t}function yG(t,e,r){const i=e[0],s=e[1];return t[0]=r[0]*i+r[2]*s,t[1]=r[1]*i+r[3]*s,t}function J1(t,e,r){const i=e[0],s=e[1];return t[0]=r[0]*i+r[2]*s+r[4],t[1]=r[1]*i+r[3]*s+r[5],t}function fqe(t,e,r){const i=e[0],s=e[1];return t[0]=r[0]*i+r[3]*s+r[6],t[1]=r[1]*i+r[4]*s+r[7],t}function mqe(t,e,r){const i=e[0],s=e[1];return t[0]=r[0]*i+r[4]*s+r[12],t[1]=r[1]*i+r[5]*s+r[13],t}function gqe(t,e,r,i){const s=e[0]-r[0],n=e[1]-r[1],o=Math.sin(i),a=Math.cos(i);return t[0]=s*a-n*o+r[0],t[1]=s*o+n*a+r[1],t}function yqe(t,e){const r=t[0],i=t[1],s=e[0],n=e[1];let o=r*r+i*i;o>0&&(o=1/Math.sqrt(o));let a=s*s+n*n;a>0&&(a=1/Math.sqrt(a));const l=(r*s+i*n)*o*a;return l>1?0:l<-1?Math.PI:Math.acos(l)}function _qe(t){return"vec2("+t[0]+", "+t[1]+")"}function $ve(t,e){return t[0]===e[0]&&t[1]===e[1]}function Lve(t,e){const r=t[0],i=t[1],s=e[0],n=e[1],o=Sa();return Math.abs(r-s)<=o*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(i-n)<=o*Math.max(1,Math.abs(i),Math.abs(n))}function vqe(t,e,r,i,s){let n=e[0]-r[0],o=e[1]-r[1];const a=(i[0]*n+i[1]*o)*(s-1);return n=i[0]*a,o=i[1]*a,t[0]=e[0]+n,t[1]=e[1]+o,t}const bqe=JX,wqe=If,xqe=Mve,Tqe=Pve,Dve=Cw,Sqe=YN,Eqe=Ive;Object.freeze(Object.defineProperty({__proto__:null,add:Vd,angle:yqe,ceil:nqe,copy:Un,cross:dqe,dist:Dve,distance:Cw,div:Tqe,divide:Pve,dot:pn,equals:Lve,exactEquals:$ve,floor:oqe,inverse:hqe,len:bqe,length:JX,lerp:QT,max:lqe,min:aqe,mul:xqe,multiply:Mve,negate:KX,normalize:cO,projectAndScale:vqe,random:pqe,rotate:gqe,round:cqe,scale:Sc,scaleAndAdd:uqe,set:or,sqrDist:Sqe,sqrLen:Eqe,squaredDistance:YN,squaredLength:Ive,str:_qe,sub:wqe,subtract:If,transformMat2:yG,transformMat2d:J1,transformMat3:fqe,transformMat4:mqe},Symbol.toStringTag,{value:"Module"}));function QX(t){return ge((t-1e5)/(1e6-1e5),0,1)}const _G=1e4,Cqe=.085,uO=1e5;let Aqe=class{};const pi=Aqe;function w(t,...e){let r="";for(let i=0;i<e.length;i++)r+=t[i]+e[i];return r+=t[t.length-1],r}(function(t){function e(i){return Math.round(i).toString()}function r(i){return i.toPrecision(8)}t.int=e,t.float=r})(w||(w={}));var A;(function(t){t.POSITION="position",t.NORMAL="normal",t.UV0="uv0",t.AUXPOS1="auxpos1",t.AUXPOS2="auxpos2",t.COLOR="color",t.SYMBOLCOLOR="symbolColor",t.SIZE="size",t.TANGENT="tangent",t.OFFSET="offset",t.SUBDIVISIONFACTOR="subdivisionFactor",t.COLORFEATUREATTRIBUTE="colorFeatureAttribute",t.SIZEFEATUREATTRIBUTE="sizeFeatureAttribute",t.OPACITYFEATUREATTRIBUTE="opacityFeatureAttribute",t.DISTANCETOSTART="distanceToStart",t.UVMAPSPACE="uvMapSpace",t.BOUNDINGRECT="boundingRect",t.UVREGION="uvRegion",t.NORMALCOMPRESSED="normalCompressed",t.PROFILERIGHT="profileRight",t.PROFILEUP="profileUp",t.PROFILEVERTEXANDNORMAL="profileVertexAndNormal",t.FEATUREVALUE="featureValue",t.MODELORIGINHI="modelOriginHi",t.MODELORIGINLO="modelOriginLo",t.MODEL="model",t.MODELNORMAL="modelNormal",t.INSTANCECOLOR="instanceColor",t.INSTANCEFEATUREATTRIBUTE="instanceFeatureAttribute",t.LOCALTRANSFORM="localTransform",t.GLOBALTRANSFORM="globalTransform",t.BOUNDINGSPHERE="boundingSphere",t.MODELORIGIN="modelOrigin",t.MODELSCALEFACTORS="modelScaleFactors",t.FEATUREATTRIBUTE="featureAttribute",t.STATE="state",t.LODLEVEL="lodLevel",t.POSITION0="position0",t.POSITION1="position1",t.NORMALA="normalA",t.NORMALB="normalB",t.COMPONENTINDEX="componentIndex",t.VARIANTOFFSET="variantOffset",t.VARIANTSTROKE="variantStroke",t.VARIANTEXTENSION="variantExtension",t.U8PADDING="u8padding",t.U16PADDING="u16padding",t.SIDENESS="sideness",t.START="start",t.END="end",t.UP="up",t.EXTRUDE="extrude",t.OBJECTANDLAYERIDCOLOR="objectAndLayerIdColor",t.OBJECTANDLAYERIDCOLOR_INSTANCED="objectAndLayerIdColor_instanced"})(A||(A={}));var qs;function Zf(t,e){switch(e.textureCoordinateType){case qs.Default:return t.attributes.add(A.UV0,"vec2"),t.varyings.add("vuv0","vec2"),void t.vertex.code.add(w`void forwardTextureCoordinates() {
vuv0 = uv0;
}`);case qs.Compressed:return t.attributes.add(A.UV0,"vec2"),t.varyings.add("vuv0","vec2"),void t.vertex.code.add(w`vec2 getUV0() {
return uv0 / 16384.0;
}
void forwardTextureCoordinates() {
vuv0 = getUV0();
}`);case qs.Atlas:return t.attributes.add(A.UV0,"vec2"),t.varyings.add("vuv0","vec2"),t.attributes.add(A.UVREGION,"vec4"),t.varyings.add("vuvRegion","vec4"),void t.vertex.code.add(w`void forwardTextureCoordinates() {
vuv0 = uv0;
vuvRegion = uvRegion;
}`);default:e.textureCoordinateType;case qs.None:return void t.vertex.code.add(w`void forwardTextureCoordinates() {}`);case qs.COUNT:return}}(function(t){t[t.None=0]="None",t[t.Default=1]="Default",t[t.Atlas=2]="Atlas",t[t.Compressed=3]="Compressed",t[t.COUNT=4]="COUNT"})(qs||(qs={}));function kc(t){t.code.add(w`const float MAX_RGBA_FLOAT =
255.0 / 256.0 +
255.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 / 256.0;
const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);
vec4 float2rgba(const float value) {
float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);
vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);
const float toU8AsFloat = 1.0 / 255.0;
return fixedPointU8 * toU8AsFloat;
}
const vec4 RGBA_2_FLOAT_FACTORS = vec4(
255.0 / (256.0),
255.0 / (256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0 * 256.0)
);
float rgba2float(vec4 rgba) {
return dot(rgba, RGBA_2_FLOAT_FACTORS);
}`)}function Nu(t){t.include(kc),t.code.add(w`float linearDepthFromFloat(float depth, vec2 nearFar) {
return -(depth * (nearFar[1] - nearFar[0]) + nearFar[0]);
}
float linearDepthFromTexture(sampler2D depthTex, vec2 uv, vec2 nearFar) {
return linearDepthFromFloat(rgba2float(texture2D(depthTex, uv)), nearFar);
}`)}function m5(t){t.fragment.code.add(w`const float GAMMA = 2.2;
const float INV_GAMMA = 0.4545454545;
vec4 delinearizeGamma(vec4 color) {
return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
}
vec3 linearizeGamma(vec3 color) {
return pow(color, vec3(GAMMA));
}`)}var di;(function(t){t[t.Pass=0]="Pass",t[t.Draw=1]="Draw"})(di||(di={}));let ws=class{constructor(e,r,i,s,n=null){this.name=e,this.type=r,this.arraySize=n,this.bind={[di.Pass]:null,[di.Draw]:null},v(i)&&v(s)&&(this.bind[i]=s)}equals(e){return this.type===e.type&&this.name===e.name&&this.arraySize===e.arraySize}},qt=class extends ws{constructor(e,r){super(e,"vec3",di.Pass,(i,s,n)=>i.setUniform3fv(e,r(s,n)))}},Pe=class extends ws{constructor(e,r){super(e,"float",di.Pass,(i,s,n)=>i.setUniform1f(e,r(s,n)))}};function dy(t){t.uniforms.add(new qt("mainLightDirection",(e,r)=>r.lighting.mainLight.direction))}function vm(t){t.uniforms.add(new qt("mainLightIntensity",(e,r)=>r.lighting.mainLight.intensity))}function Rqe(t,e){e.useLegacyTerrainShading?t.uniforms.add(new Pe("lightingFixedFactor",(r,i)=>i.lighting.noonFactor*(1-i.lighting.globalFactor))):t.constants.add("lightingFixedFactor","float",0)}function ZN(t,e){const r=t.fragment;dy(r),vm(r),Rqe(r,e),r.code.add(w`vec3 evaluateMainLighting(vec3 normal_global, float shadowing) {
float dotVal = clamp(dot(normal_global, mainLightDirection), 0.0, 1.0);
dotVal = mix(dotVal, 1.0, lightingFixedFactor);
return mainLightIntensity * ((1.0 - shadowing) * dotVal);
}`)}let kr=class extends ws{constructor(e,r){super(e,"vec2",di.Pass,(i,s,n)=>i.setUniform2fv(e,r(s,n)))}},pr=class extends ws{constructor(e,r){super(e,"vec4",di.Pass,(i,s,n)=>i.setUniform4fv(e,r(s,n)))}},Hi=class extends ws{constructor(e,r){super(e,"mat4",di.Pass,(i,s,n)=>i.setUniformMatrix4fv(e,r(s,n)))}};const Nve=se.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder");let Fve=class{constructor(){this._includedModules=new Map}include(e,r){if(this._includedModules.has(e)){const i=this._includedModules.get(e);if(i!==r){Nve.error("Trying to include shader module multiple times with different sets of options.");const s=new Set;for(const n of Object.keys(i))i[n]!==e[n]&&s.add(n);for(const n of Object.keys(e))i[n]!==e[n]&&s.add(n);s.forEach(n=>console.error(`  ${n}: current ${i[n]} new ${e[n]}`))}}else this._includedModules.set(e,r),e(this.builder,r)}},Dr=class extends Fve{constructor(){super(...arguments),this.vertex=new Xre,this.fragment=new Xre,this.attributes=new Pqe,this.varyings=new Iqe,this.extensions=new vG,this.constants=new Uve}get fragmentUniforms(){return this.fragment.uniforms.entries}get builder(){return this}generate(e){const r=this.extensions.generateSource(e),i=this.attributes.generateSource(e),s=this.varyings.generateSource(),n=e==="vertex"?this.vertex:this.fragment,o=n.uniforms.generateSource(),a=n.code.generateSource(),l=e==="vertex"?Lqe:$qe,c=this.constants.generateSource().concat(n.constants.generateSource());return`
${r.join(`
`)}

${l}

${c.join(`
`)}

${o.join(`
`)}

${i.join(`
`)}

${s.join(`
`)}

${a.join(`
`)}`}generateBind(e,r){const i=new Map;this.vertex.uniforms.entries.forEach(o=>{const a=o.bind[e];v(a)&&i.set(o.name,a)}),this.fragment.uniforms.entries.forEach(o=>{const a=o.bind[e];v(a)&&i.set(o.name,a)});const s=Array.from(i.values()),n=s.length;return(o,a,l)=>{for(let c=0;c<n;++c)s[c](r,o,a,l)}}},Oqe=class{constructor(){this._entries=new Map}add(e){if(!Array.isArray(e))return this._add(e);for(const r of e)this._add(r)}get(e){return this._entries.get(e)}_add(e){if(C(e))Nve.error(`Trying to add null Uniform from ${new Error().stack}.`);else{if(this._entries.has(e.name)&&!this._entries.get(e.name).equals(e))throw new q(`Duplicate uniform name ${e.name} for different uniform type`);this._entries.set(e.name,e)}}generateSource(){return Array.from(this._entries.values()).map(e=>v(e.arraySize)?`uniform ${e.type} ${e.name}[${e.arraySize}];`:`uniform ${e.type} ${e.name};`)}get entries(){return Array.from(this._entries.values())}},Mqe=class{constructor(){this._entries=new Array}add(e){this._entries.push(e)}generateSource(){return this._entries}},Xre=class extends Fve{constructor(){super(...arguments),this.uniforms=new Oqe,this.code=new Mqe,this.constants=new Uve}get builder(){return this}},Pqe=class{constructor(){this._entries=new Array}add(e,r){this._entries.push([e,r])}generateSource(e){return e==="fragment"?[]:this._entries.map(r=>`attribute ${r[1]} ${r[0]};`)}},Iqe=class{constructor(){this._entries=new Array}add(e,r){this._entries.push([e,r])}generateSource(){return this._entries.map(e=>`varying ${e[1]} ${e[0]};`)}},vG=class bG{constructor(){this._entries=new Set}add(e){this._entries.add(e)}generateSource(e){const r=e==="vertex"?bG.ALLOWLIST_VERTEX:bG.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter(i=>r.includes(i)).map(i=>`#extension ${i} : enable`)}};vG.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],vG.ALLOWLIST_VERTEX=[];let Uve=class cn{constructor(){this._entries=new Set}add(e,r,i){let s="ERROR_CONSTRUCTOR_STRING";switch(r){case"float":s=cn._numberToFloatStr(i);break;case"int":s=cn._numberToIntStr(i);break;case"bool":s=i.toString();break;case"vec2":s=`vec2(${cn._numberToFloatStr(i[0])},                            ${cn._numberToFloatStr(i[1])})`;break;case"vec3":s=`vec3(${cn._numberToFloatStr(i[0])},                            ${cn._numberToFloatStr(i[1])},                            ${cn._numberToFloatStr(i[2])})`;break;case"vec4":s=`vec4(${cn._numberToFloatStr(i[0])},                            ${cn._numberToFloatStr(i[1])},                            ${cn._numberToFloatStr(i[2])},                            ${cn._numberToFloatStr(i[3])})`;break;case"ivec2":s=`ivec2(${cn._numberToIntStr(i[0])},                             ${cn._numberToIntStr(i[1])})`;break;case"ivec3":s=`ivec3(${cn._numberToIntStr(i[0])},                             ${cn._numberToIntStr(i[1])},                             ${cn._numberToIntStr(i[2])})`;break;case"ivec4":s=`ivec4(${cn._numberToIntStr(i[0])},                             ${cn._numberToIntStr(i[1])},                             ${cn._numberToIntStr(i[2])},                             ${cn._numberToIntStr(i[3])})`;break;case"mat2":case"mat3":case"mat4":s=`${r}(${Array.prototype.map.call(i,n=>cn._numberToFloatStr(n)).join(", ")})`}return this._entries.add(`const ${r} ${e} = ${s};`),this}static _numberToIntStr(e){return e.toFixed(0)}static _numberToFloatStr(e){return Number.isInteger(e)?e.toFixed(1):e.toString()}generateSource(){return Array.from(this._entries)}};const $qe=`#ifdef GL_FRAGMENT_PRECISION_HIGH
  precision highp float;
  precision highp sampler2D;
#else
  precision mediump float;
  precision mediump sampler2D;
#endif`,Lqe=`precision highp float;
precision highp sampler2D;`,eY="Size",g5="InvSize";function $h(t,e,r=!1,i=0){if(t.hasWebGL2Context){const s=w`vec2(textureSize(${e}, ${w.int(i)}))`;return r?"(1.0 / "+s+")":s}return r?e+g5:e+eY}function Ja(t,e,r,i=null,s=0){if(t.hasWebGL2Context)return w`texelFetch(${e}, ivec2(${r}), ${w.int(s)})`;let n=w`texture2D(${e}, ${r} * `;return n+=i?w`(${i}))`:w`${e+g5})`,n}var Qr;(function(t){t[t.None=0]="None",t[t.Size=1]="Size",t[t.InvSize=2]="InvSize"})(Qr||(Qr={}));let Mt=class extends ws{constructor(e,r){super(e,"sampler2D",di.Pass,(i,s,n)=>i.bindTexture(e,r(s,n)))}};function op(t,e,r=Qr.None){const i=[new Mt(t,e)];if(r&Qr.Size){const s=t+eY;i.push(new kr(s,(n,o)=>{const a=e(n,o);return v(a)?or(Yre,a.descriptor.width,a.descriptor.height):Wl}))}if(r&Qr.InvSize){const s=t+g5;i.push(new kr(s,(n,o)=>{const a=e(n,o);return v(a)?or(Yre,1/a.descriptor.width,1/a.descriptor.height):Wl}))}return i}const Yre=Je(),cR=$e(parseFloat(5802e-9.toFixed(6)),parseFloat(13558e-9.toFixed(6)),parseFloat(331e-7.toFixed(6))),n8=3,o8=$e(n8*parseFloat(65e-8.toFixed(6)),n8*parseFloat(1881e-9.toFixed(6)),n8*parseFloat(85e-9.toFixed(6))),Dqe=3996e-9,Nqe=$e(parseFloat(Number(cR[0]+o8[0]).toFixed(6)),parseFloat(Number(cR[1]+o8[1]).toFixed(6)),parseFloat(Number(cR[2]+o8[2]).toFixed(6)));function Fqe(t){const e=new Dr;e.attributes.add(A.POSITION,"vec2"),e.include(Zf,{textureCoordinateType:qs.Default}),e.varyings.add("worldRay","vec3"),e.varyings.add("eyeDir","vec3");const{vertex:r,fragment:i}=e;return r.uniforms.add([new Hi("inverseProjectionMatrix",(s,n)=>n.camera.inverseProjectionMatrix),new Hi("inverseViewMatrix",(s,n)=>CE(Uqe,n.camera.viewMatrix))]),r.code.add(w`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),i.uniforms.add([new kr("radii",s=>s.radii),new qt("cameraPosition",(s,n)=>n.camera.eye),new pr("heightParameters",s=>s.heightParameters),new Pe("innerFadeDistance",s=>s.innerFadeDistance),new Pe("altitudeFade",s=>s.altitudeFade),new Mt("depthTex",s=>s.depthTex),new Pe("hazeStrength",s=>s.hazeStrength)]),i.constants.add("betaRayleigh","vec3",cR),i.constants.add("betaCombined","vec3",Nqe),i.constants.add("betaMie","float",Dqe),i.constants.add("scaleHeight","float",Cqe*uO),dy(i),e.include(m5),t.haze&&(i.include(Nu),i.uniforms.add(new kr("nearFar",(s,n)=>n.camera.nearFar))),i.code.add(w`vec2 sphereIntersect(vec3 start, vec3 dir, float radius, bool planet) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = planet ? heightParameters[1] - radius * radius : heightParameters[2];
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),i.code.add(w`float chapmanApproximation(float X, float h, float cosZenith) {
float c = sqrt(X + h);
float cExpH = c * exp(-h);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (X + h);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(X - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),i.code.add(w`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),i.code.add(w`
    const int STEPS = 6;

    float getGlow(float dist, float radius, float intensity) {
      return pow(radius / max(dist, 1e-6), intensity);
    }

    vec3 getAtmosphereColour(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      float reducedPlanetRadius = radii[0] - 20000.0;
      vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, reducedPlanetRadius, true);
      vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, radii[1], false);
      bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
      bool insideAtmosphere = heightParameters[0] < radii[1];

      if (!(hitsAtmosphere || insideAtmosphere)) {
        return vec3(0);
      }

      bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;

      float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;

      if (heightParameters[0] < reducedPlanetRadius) {
        // Long light rays from the night side of the planet lead to numerical instability
        // Do not render the atmosphere in such cases
        if (dot(rayDir, normalize(cameraPos)) < -0.025) {
          return vec3(0);
        }
        start = rayPlanetIntersect.y;
      }

      float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
      float maxEnd = end;

      ${t.haze?w`if (terrainDepth != -1.0) { end = terrainDepth; }`:""}

      vec3 samplePoint = cameraPos + rayDir * end;
      float multiplier = hitsPlanet ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (end - start) / float(STEPS);
      for (int i = 0; i < STEPS; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= ${t.haze?w``:" mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0)) * "} exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {

          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);

          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${t.haze?"":w`scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);`}
        }

        lastOpticalDepth = opticalDepth;

      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.0596831 * mumu;

      ${t.haze?w`return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;`:w`
            const float g = 0.8;
            const float gg = g * g;
            float phaseMie = end == maxEnd ? 0.1193662 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg)) : 0.0;
            phaseMie += getGlow(1.0 - mu, 5e-5, 3.0) * smoothstep(0.01, 0.1, length(scattering));
            phaseMie = clamp(phaseMie, 0.0, 128.0);
            return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }

    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
      vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, radii[0], true);
      if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
        return fragColor;
      }

      float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
      vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
      float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
      if (relDist > 1.0) {
        return surfaceColor;
      }

      return mix(gl_FragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${t.haze?w`
          vec4 depthSample = texture2D(depthTex, vuv0).rgba;
          if (depthSample != vec4(0)) {
            vec3 cameraSpaceRay = normalize(eyeDir);
            cameraSpaceRay /= cameraSpaceRay.z;
            cameraSpaceRay *= -linearDepthFromTexture(depthTex, vuv0, nearFar);
            terrainDepth = max(0.0, length(cameraSpaceRay));
          }`:w`
          float depthSample = texture2D(depthTex, vuv0).r;
          if (depthSample != 1.0) {
            gl_FragColor = vec4(0);
            return;
          }`}

      ${t.haze?w`
            vec3 col = vec3(0);
            float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);
            if(depthSample != vec4(0)){
              col = (1.0 - fadeOut) * hazeStrength * getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);
            }
            float alpha = 1.0 - fadeOut;`:w`
            vec3 col = getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);;
            float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));`}
      col = tonemapACES(col);
      gl_FragColor = delinearizeGamma(vec4(col, alpha));
      ${t.haze?"":w`
          if (depthSample == 1.0) {
            gl_FragColor = applyUndergroundAtmosphere(rayDir, mainLightDirection, gl_FragColor);
          }`}
    }
  `),e}const Uqe=Ie(),kqe=Object.freeze(Object.defineProperty({__proto__:null,betaRayleigh:cR,build:Fqe},Symbol.toStringTag,{value:"Module"}));let Nr=class{constructor(e,r){this._module=e,this._loadModule=r}get(){return this._module}async reload(){return this._module=await this._loadModule(),this._module}};var Li,$t,Ee,cm,Ot,Qd,ZS,lt,Mi,Ls,tt,Rt,bt,Ve,St,Lt,Ha,Lr,vu,Zn,ls,$r;(function(t){t[t.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",t[t.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",t[t.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT"})(Li||(Li={})),function(t){t[t.POINTS=0]="POINTS",t[t.LINES=1]="LINES",t[t.LINE_LOOP=2]="LINE_LOOP",t[t.LINE_STRIP=3]="LINE_STRIP",t[t.TRIANGLES=4]="TRIANGLES",t[t.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=6]="TRIANGLE_FAN"}($t||($t={})),function(t){t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SRC_COLOR=768]="SRC_COLOR",t[t.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",t[t.SRC_ALPHA=770]="SRC_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",t[t.DST_ALPHA=772]="DST_ALPHA",t[t.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",t[t.DST_COLOR=774]="DST_COLOR",t[t.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",t[t.CONSTANT_COLOR=32769]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA"}(Ee||(Ee={})),function(t){t[t.ADD=32774]="ADD",t[t.SUBTRACT=32778]="SUBTRACT",t[t.REVERSE_SUBTRACT=32779]="REVERSE_SUBTRACT"}(cm||(cm={})),function(t){t[t.ARRAY_BUFFER=34962]="ARRAY_BUFFER",t[t.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",t[t.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",t[t.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",t[t.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",t[t.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",t[t.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER"}(Ot||(Ot={})),function(t){t[t.FRONT=1028]="FRONT",t[t.BACK=1029]="BACK",t[t.FRONT_AND_BACK=1032]="FRONT_AND_BACK"}(Qd||(Qd={})),function(t){t[t.CW=2304]="CW",t[t.CCW=2305]="CCW"}(ZS||(ZS={})),function(t){t[t.BYTE=5120]="BYTE",t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.SHORT=5122]="SHORT",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.INT=5124]="INT",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.FLOAT=5126]="FLOAT"}(lt||(lt={})),function(t){t[t.NEVER=512]="NEVER",t[t.LESS=513]="LESS",t[t.EQUAL=514]="EQUAL",t[t.LEQUAL=515]="LEQUAL",t[t.GREATER=516]="GREATER",t[t.NOTEQUAL=517]="NOTEQUAL",t[t.GEQUAL=518]="GEQUAL",t[t.ALWAYS=519]="ALWAYS"}(Mi||(Mi={})),function(t){t[t.ZERO=0]="ZERO",t[t.KEEP=7680]="KEEP",t[t.REPLACE=7681]="REPLACE",t[t.INCR=7682]="INCR",t[t.DECR=7683]="DECR",t[t.INVERT=5386]="INVERT",t[t.INCR_WRAP=34055]="INCR_WRAP",t[t.DECR_WRAP=34056]="DECR_WRAP"}(Ls||(Ls={})),function(t){t[t.NEAREST=9728]="NEAREST",t[t.LINEAR=9729]="LINEAR",t[t.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",t[t.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",t[t.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",t[t.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"}(tt||(tt={})),function(t){t[t.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",t[t.REPEAT=10497]="REPEAT",t[t.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT"}(Rt||(Rt={})),function(t){t[t.TEXTURE_2D=3553]="TEXTURE_2D",t[t.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",t[t.TEXTURE_3D=32879]="TEXTURE_3D",t[t.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",t[t.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",t[t.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",t[t.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",t[t.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY"}(bt||(bt={})),function(t){t[t.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",t[t.DEPTH_STENCIL=34041]="DEPTH_STENCIL",t[t.ALPHA=6406]="ALPHA",t[t.RGB=6407]="RGB",t[t.RGBA=6408]="RGBA",t[t.LUMINANCE=6409]="LUMINANCE",t[t.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",t[t.RED=6403]="RED",t[t.RG=33319]="RG",t[t.RED_INTEGER=36244]="RED_INTEGER",t[t.RG_INTEGER=33320]="RG_INTEGER",t[t.RGB_INTEGER=36248]="RGB_INTEGER",t[t.RGBA_INTEGER=36249]="RGBA_INTEGER"}(Ve||(Ve={})),function(t){t[t.RGBA4=32854]="RGBA4",t[t.R16F=33325]="R16F",t[t.RG16F=33327]="RG16F",t[t.RGB32F=34837]="RGB32F",t[t.RGBA16F=34842]="RGBA16F",t[t.R32F=33326]="R32F",t[t.RG32F=33328]="RG32F",t[t.RGBA32F=34836]="RGBA32F",t[t.R11F_G11F_B10F=35898]="R11F_G11F_B10F",t[t.RGB8=32849]="RGB8",t[t.RGBA8=32856]="RGBA8",t[t.RGB5_A1=32855]="RGB5_A1",t[t.R8=33321]="R8",t[t.RG8=33323]="RG8",t[t.R8I=33329]="R8I",t[t.R8UI=33330]="R8UI",t[t.R16I=33331]="R16I",t[t.R16UI=33332]="R16UI",t[t.R32I=33333]="R32I",t[t.R32UI=33334]="R32UI",t[t.RG8I=33335]="RG8I",t[t.RG8UI=33336]="RG8UI",t[t.RG16I=33337]="RG16I",t[t.RG16UI=33338]="RG16UI",t[t.RG32I=33339]="RG32I",t[t.RG32UI=33340]="RG32UI",t[t.RGB16F=34843]="RGB16F",t[t.RGB9_E5=35901]="RGB9_E5",t[t.SRGB8=35905]="SRGB8",t[t.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",t[t.RGB565=36194]="RGB565",t[t.RGBA32UI=36208]="RGBA32UI",t[t.RGB32UI=36209]="RGB32UI",t[t.RGBA16UI=36214]="RGBA16UI",t[t.RGB16UI=36215]="RGB16UI",t[t.RGBA8UI=36220]="RGBA8UI",t[t.RGB8UI=36221]="RGB8UI",t[t.RGBA32I=36226]="RGBA32I",t[t.RGB32I=36227]="RGB32I",t[t.RGBA16I=36232]="RGBA16I",t[t.RGB16I=36233]="RGB16I",t[t.RGBA8I=36238]="RGBA8I",t[t.RGB8I=36239]="RGB8I",t[t.R8_SNORM=36756]="R8_SNORM",t[t.RG8_SNORM=36757]="RG8_SNORM",t[t.RGB8_SNORM=36758]="RGB8_SNORM",t[t.RGBA8_SNORM=36759]="RGBA8_SNORM",t[t.RGB10_A2=32857]="RGB10_A2",t[t.RGB10_A2UI=36975]="RGB10_A2UI"}(St||(St={})),function(t){t[t.FLOAT=5126]="FLOAT",t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",t[t.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",t[t.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",t[t.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",t[t.BYTE=5120]="BYTE",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.SHORT=5122]="SHORT",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.INT=5124]="INT",t[t.HALF_FLOAT=5131]="HALF_FLOAT",t[t.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",t[t.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",t[t.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",t[t.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV"}(Lt||(Lt={})),function(t){t[t.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",t[t.STENCIL_INDEX8=36168]="STENCIL_INDEX8",t[t.DEPTH_STENCIL=34041]="DEPTH_STENCIL",t[t.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",t[t.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",t[t.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",t[t.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8"}(Ha||(Ha={})),function(t){t[t.STATIC_DRAW=35044]="STATIC_DRAW",t[t.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",t[t.STREAM_DRAW=35040]="STREAM_DRAW",t[t.STATIC_READ=35045]="STATIC_READ",t[t.DYNAMIC_READ=35049]="DYNAMIC_READ",t[t.STREAM_READ=35041]="STREAM_READ",t[t.STATIC_COPY=35046]="STATIC_COPY",t[t.DYNAMIC_COPY=35050]="DYNAMIC_COPY",t[t.STREAM_COPY=35042]="STREAM_COPY"}(Lr||(Lr={})),function(t){t[t.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",t[t.VERTEX_SHADER=35633]="VERTEX_SHADER"}(vu||(vu={})),function(t){t[t.FRAMEBUFFER=36160]="FRAMEBUFFER",t[t.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",t[t.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER"}(Zn||(Zn={})),function(t){t[t.TEXTURE=0]="TEXTURE",t[t.RENDER_BUFFER=1]="RENDER_BUFFER",t[t.CUBEMAP=2]="CUBEMAP"}(ls||(ls={})),function(t){t[t.NONE=0]="NONE",t[t.DEPTH_RENDER_BUFFER=1]="DEPTH_RENDER_BUFFER",t[t.STENCIL_RENDER_BUFFER=2]="STENCIL_RENDER_BUFFER",t[t.DEPTH_STENCIL_RENDER_BUFFER=3]="DEPTH_STENCIL_RENDER_BUFFER",t[t.DEPTH_STENCIL_TEXTURE=4]="DEPTH_STENCIL_TEXTURE"}($r||($r={}));const a8=33984;var Nn,lu;(function(t){t[t.Texture=0]="Texture",t[t.BufferObject=1]="BufferObject",t[t.VertexArrayObject=2]="VertexArrayObject",t[t.Shader=3]="Shader",t[t.Program=4]="Program",t[t.FramebufferObject=5]="FramebufferObject",t[t.Renderbuffer=6]="Renderbuffer",t[t.Sync=7]="Sync",t[t.COUNT=8]="COUNT"})(Nn||(Nn={})),function(t){t[t.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",t[t.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",t[t.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",t[t.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",t[t.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",t[t.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",t[t.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",t[t.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",t[t.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",t[t.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",t[t.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",t[t.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",t[t.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",t[t.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",t[t.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",t[t.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15"}(lu||(lu={}));const Zre=33306;var Ms,Jre,Kre,Qre,JN,wG,eie;(function(t){t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC"})(Ms||(Ms={})),function(t){t[t.FLOAT=5126]="FLOAT",t[t.FLOAT_VEC2=35664]="FLOAT_VEC2",t[t.FLOAT_VEC3=35665]="FLOAT_VEC3",t[t.FLOAT_VEC4=35666]="FLOAT_VEC4",t[t.INT=5124]="INT",t[t.INT_VEC2=35667]="INT_VEC2",t[t.INT_VEC3=35668]="INT_VEC3",t[t.INT_VEC4=35669]="INT_VEC4",t[t.BOOL=35670]="BOOL",t[t.BOOL_VEC2=35671]="BOOL_VEC2",t[t.BOOL_VEC3=35672]="BOOL_VEC3",t[t.BOOL_VEC4=35673]="BOOL_VEC4",t[t.FLOAT_MAT2=35674]="FLOAT_MAT2",t[t.FLOAT_MAT3=35675]="FLOAT_MAT3",t[t.FLOAT_MAT4=35676]="FLOAT_MAT4",t[t.SAMPLER_2D=35678]="SAMPLER_2D",t[t.SAMPLER_CUBE=35680]="SAMPLER_CUBE",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",t[t.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",t[t.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",t[t.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",t[t.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",t[t.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",t[t.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",t[t.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",t[t.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",t[t.SAMPLER_3D=35679]="SAMPLER_3D",t[t.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",t[t.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",t[t.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",t[t.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",t[t.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",t[t.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",t[t.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",t[t.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",t[t.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",t[t.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",t[t.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",t[t.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY"}(Jre||(Jre={})),function(t){t[t.OBJECT_TYPE=37138]="OBJECT_TYPE",t[t.SYNC_CONDITION=37139]="SYNC_CONDITION",t[t.SYNC_STATUS=37140]="SYNC_STATUS",t[t.SYNC_FLAGS=37141]="SYNC_FLAGS"}(Kre||(Kre={})),function(t){t[t.UNSIGNALED=37144]="UNSIGNALED",t[t.SIGNALED=37145]="SIGNALED"}(Qre||(Qre={})),function(t){t[t.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",t[t.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",t[t.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",t[t.WAIT_FAILED=37149]="WAIT_FAILED"}(JN||(JN={})),function(t){t[t.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE"}(wG||(wG={})),function(t){t[t.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT"}(eie||(eie={}));let Vr=class{constructor(e,r,i){this.release=i,this.initializeConfiguration(e,r),this._configuration=r.snapshot(),this._program=this.initializeProgram(e),this._pipeline=this.initializePipeline(e.rctx.capabilities)}destroy(){this._program=Qe(this._program),this._pipeline=this._configuration=null}reload(e){Qe(this._program),this._program=this.initializeProgram(e),this._pipeline=this.initializePipeline(e.rctx.capabilities)}get program(){return this._program}get compiled(){return this.program.compiled}get key(){return this._configuration.key}get configuration(){return this._configuration}bindPipelineState(e,r=null,i){e.setPipelineState(this.getPipelineState(r,i))}ensureAttributeLocations(e){this.program.assertCompatibleVertexAttributeLocations(e)}get primitiveType(){return $t.TRIANGLES}getPipelineState(e,r){return this._pipeline}initializeConfiguration(e,r){}};const Rr=new Map([[A.POSITION,0],[A.NORMAL,1],[A.UV0,2],[A.COLOR,3],[A.SIZE,4],[A.TANGENT,4],[A.AUXPOS1,5],[A.SYMBOLCOLOR,5],[A.AUXPOS2,6],[A.FEATUREATTRIBUTE,6],[A.INSTANCEFEATUREATTRIBUTE,6],[A.INSTANCECOLOR,7],[A.OBJECTANDLAYERIDCOLOR,7],[A.OBJECTANDLAYERIDCOLOR_INSTANCED,7],[A.MODEL,8],[A.MODELNORMAL,12],[A.MODELORIGINHI,11],[A.MODELORIGINLO,15]]),Vqe=se.getLogger("esri.views.webgl.checkWebGLError");function Bqe(t,e){switch(e){case t.INVALID_ENUM:return"Invalid Enum. An unacceptable value has been specified for an enumerated argument.";case t.INVALID_VALUE:return"Invalid Value. A numeric argument is out of range.";case t.INVALID_OPERATION:return"Invalid Operation. The specified command is not allowed for the current state.";case t.INVALID_FRAMEBUFFER_OPERATION:return"Invalid Framebuffer operation. The currently bound framebuffer is not framebuffer complete when trying to render to or to read from it.";case t.OUT_OF_MEMORY:return"Out of memory. Not enough memory is left to execute the command.";case t.CONTEXT_LOST_WEBGL:return"WebGL context has been lost";default:return"Unknown error"}}const kve=!!de("enable-feature:webgl-debug");function du(){return kve}function xG(){return kve}function l_(t){if(du()){const e=t.getError();if(e){const r=Bqe(t,e),i=new Error().stack;Vqe.error(new q("webgl-error","WebGL error occured",{message:r,stack:i}))}}}let Fr=class{constructor(e,r,i){this._context=e,this._locations=i,this._textures=new Map,this._freeTextureUnits=new Jt({deallocator:null}),this._glProgram=e.programCache.acquire(r.generate("vertex"),r.generate("fragment"),i),this._glProgram.stop=()=>{throw new Error("Wrapped _glProgram used directly")},this.bindPass=r.generateBind(di.Pass,this),this.bindDraw=r.generateBind(di.Draw,this),this._fragmentUniforms=du()?r.fragmentUniforms:null}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get compiled(){return this._glProgram.compiled}setUniform1b(e,r){this._glProgram.setUniform1i(e,r?1:0)}setUniform1i(e,r){this._glProgram.setUniform1i(e,r)}setUniform1f(e,r){this._glProgram.setUniform1f(e,r)}setUniform2fv(e,r){this._glProgram.setUniform2fv(e,r)}setUniform3fv(e,r){this._glProgram.setUniform3fv(e,r)}setUniform4fv(e,r){this._glProgram.setUniform4fv(e,r)}setUniformMatrix3fv(e,r){this._glProgram.setUniformMatrix3fv(e,r)}setUniformMatrix4fv(e,r){this._glProgram.setUniformMatrix4fv(e,r)}setUniform1fv(e,r){this._glProgram.setUniform1fv(e,r)}setUniform1iv(e,r){this._glProgram.setUniform1iv(e,r)}setUniform2iv(e,r){this._glProgram.setUniform3iv(e,r)}setUniform3iv(e,r){this._glProgram.setUniform3iv(e,r)}setUniform4iv(e,r){this._glProgram.setUniform4iv(e,r)}assertCompatibleVertexAttributeLocations(e){e.locations!==this._locations&&console.error("VertexAttributeLocations are incompatible")}stop(){this._textures.clear(),this._freeTextureUnits.clear()}bindTexture(e,r){if(C(r)||r.glName==null){const s=this._textures.get(e);return s&&(this._context.bindTexture(null,s.unit),this._freeTextureUnit(s),this._textures.delete(e)),null}let i=this._textures.get(e);return i==null?(i=this._allocTextureUnit(r),this._textures.set(e,i)):i.texture=r,this._context.useProgram(this),this.setUniform1i(e,i.unit),this._context.bindTexture(r,i.unit),i.unit}rebindTextures(){this._context.useProgram(this),this._textures.forEach((e,r)=>{this._context.bindTexture(e.texture,e.unit),this.setUniform1i(r,e.unit)}),v(this._fragmentUniforms)&&this._fragmentUniforms.forEach(e=>{e.type!=="sampler2D"&&e.type!=="samplerCube"||this._textures.has(e.name)||console.error(`Texture sampler ${e.name} has no bound texture`)})}_allocTextureUnit(e){return{texture:e,unit:this._freeTextureUnits.length===0?this._textures.size:this._freeTextureUnits.pop()}}_freeTextureUnit(e){this._freeTextureUnits.push(e.unit)}};var Ti,Aw,Ps,Vg,zl,ry,U_,JS,ui,Rw,Og;(function(t){t[t.None=0]="None",t[t.Front=1]="Front",t[t.Back=2]="Back",t[t.COUNT=3]="COUNT"})(Ti||(Ti={})),function(t){t[t.Less=0]="Less",t[t.Lequal=1]="Lequal",t[t.COUNT=2]="COUNT"}(Aw||(Aw={})),function(t){t[t.BACKGROUND=0]="BACKGROUND",t[t.UPDATE=1]="UPDATE"}(Ps||(Ps={})),function(t){t[t.NOT_LOADED=0]="NOT_LOADED",t[t.LOADING=1]="LOADING",t[t.LOADED=2]="LOADED"}(Vg||(Vg={})),function(t){t[t.IntegratedMeshMaskExcluded=1]="IntegratedMeshMaskExcluded",t[t.OutlineVisualElementMask=2]="OutlineVisualElementMask"}(zl||(zl={})),function(t){t[t.Highlight=0]="Highlight",t[t.MaskOccludee=1]="MaskOccludee",t[t.COUNT=2]="COUNT"}(ry||(ry={})),function(t){t[t.STRETCH=1]="STRETCH",t[t.PAD=2]="PAD"}(U_||(U_={})),function(t){t[t.CHANGED=0]="CHANGED",t[t.UNCHANGED=1]="UNCHANGED"}(JS||(JS={})),function(t){t[t.Blend=0]="Blend",t[t.Opaque=1]="Opaque",t[t.Mask=2]="Mask",t[t.MaskBlend=3]="MaskBlend",t[t.COUNT=4]="COUNT"}(ui||(ui={})),function(t){t[t.OFF=0]="OFF",t[t.ON=1]="ON"}(Rw||(Rw={})),function(t){t.DDS_ENCODING="image/vnd-ms.dds",t.KTX2_ENCODING="image/ktx2",t.BASIS_ENCODING="image/x.basis"}(Og||(Og={}));function Tp(t,e,r=cm.ADD,i=[0,0,0,0]){return{srcRgb:t,srcAlpha:t,dstRgb:e,dstAlpha:e,opRgb:r,opAlpha:r,color:{r:i[0],g:i[1],b:i[2],a:i[3]}}}function kn(t,e,r,i,s=cm.ADD,n=cm.ADD,o=[0,0,0,0]){return{srcRgb:t,srcAlpha:e,dstRgb:r,dstAlpha:i,opRgb:s,opAlpha:n,color:{r:o[0],g:o[1],b:o[2],a:o[3]}}}const tY={face:Qd.BACK,mode:ZS.CCW},Vve={face:Qd.FRONT,mode:ZS.CCW},y5=t=>t===Ti.Back?tY:t===Ti.Front?Vve:null,Xl={zNear:0,zFar:1},Kt={r:!0,g:!0,b:!0,a:!0};function zqe(t){return Zqe.intern(t)}function Gqe(t){return Jqe.intern(t)}function jqe(t){return Kqe.intern(t)}function Hqe(t){return Qqe.intern(t)}function qqe(t){return eWe.intern(t)}function Wqe(t){return tWe.intern(t)}function Xqe(t){return rWe.intern(t)}function Yqe(t){return iWe.intern(t)}function Bt(t){return sWe.intern(t)}let py=class{constructor(e,r){this._makeKey=e,this._makeRef=r,this._interns=new Map}intern(e){if(!e)return null;const r=this._makeKey(e),i=this._interns;return i.has(r)||i.set(r,this._makeRef(e)),i.get(r)??null}};function fy(t){return"["+t.join(",")+"]"}const Zqe=new py(Bve,t=>({__tag:"Blending",...t}));function Bve(t){return t?fy([t.srcRgb,t.srcAlpha,t.dstRgb,t.dstAlpha,t.opRgb,t.opAlpha,t.color.r,t.color.g,t.color.b,t.color.a]):null}const Jqe=new py(zve,t=>({__tag:"Culling",...t}));function zve(t){return t?fy([t.face,t.mode]):null}const Kqe=new py(Gve,t=>({__tag:"PolygonOffset",...t}));function Gve(t){return t?fy([t.factor,t.units]):null}const Qqe=new py(jve,t=>({__tag:"DepthTest",...t}));function jve(t){return t?fy([t.func]):null}const eWe=new py(Hve,t=>({__tag:"StencilTest",...t}));function Hve(t){return t?fy([t.function.func,t.function.ref,t.function.mask,t.operation.fail,t.operation.zFail,t.operation.zPass]):null}const tWe=new py(qve,t=>({__tag:"DepthWrite",...t}));function qve(t){return t?fy([t.zNear,t.zFar]):null}const rWe=new py(Wve,t=>({__tag:"ColorWrite",...t}));function Wve(t){return t?fy([t.r,t.g,t.b,t.a]):null}const iWe=new py(Xve,t=>({__tag:"StencilWrite",...t}));function Xve(t){return t?fy([t.mask]):null}const sWe=new py(nWe,t=>({blending:zqe(t.blending),culling:Gqe(t.culling),polygonOffset:jqe(t.polygonOffset),depthTest:Hqe(t.depthTest),stencilTest:qqe(t.stencilTest),depthWrite:Wqe(t.depthWrite),colorWrite:Xqe(t.colorWrite),stencilWrite:Yqe(t.stencilWrite)}));function nWe(t){return t?fy([Bve(t.blending),zve(t.culling),Gve(t.polygonOffset),jve(t.depthTest),Hve(t.stencilTest),qve(t.depthWrite),Wve(t.colorWrite),Xve(t.stencilWrite)]):null}let oWe=class{constructor(e){this._pipelineInvalid=!0,this._blendingInvalid=!0,this._cullingInvalid=!0,this._polygonOffsetInvalid=!0,this._depthTestInvalid=!0,this._stencilTestInvalid=!0,this._depthWriteInvalid=!0,this._colorWriteInvalid=!0,this._stencilWriteInvalid=!0,this._stateSetters=e}setPipeline(e){(this._pipelineInvalid||e!==this._pipeline)&&(this._setBlending(e.blending),this._setCulling(e.culling),this._setPolygonOffset(e.polygonOffset),this._setDepthTest(e.depthTest),this._setStencilTest(e.stencilTest),this._setDepthWrite(e.depthWrite),this._setColorWrite(e.colorWrite),this._setStencilWrite(e.stencilWrite),this._pipeline=e),this._pipelineInvalid=!1}invalidateBlending(){this._blendingInvalid=!0,this._pipelineInvalid=!0}invalidateCulling(){this._cullingInvalid=!0,this._pipelineInvalid=!0}invalidatePolygonOffset(){this._polygonOffsetInvalid=!0,this._pipelineInvalid=!0}invalidateDepthTest(){this._depthTestInvalid=!0,this._pipelineInvalid=!0}invalidateStencilTest(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}invalidateDepthWrite(){this._depthWriteInvalid=!0,this._pipelineInvalid=!0}invalidateColorWrite(){this._colorWriteInvalid=!0,this._pipelineInvalid=!0}invalidateStencilWrite(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}_setBlending(e){this._blending=this._setSubState(e,this._blending,this._blendingInvalid,this._stateSetters.setBlending),this._blendingInvalid=!1}_setCulling(e){this._culling=this._setSubState(e,this._culling,this._cullingInvalid,this._stateSetters.setCulling),this._cullingInvalid=!1}_setPolygonOffset(e){this._polygonOffset=this._setSubState(e,this._polygonOffset,this._polygonOffsetInvalid,this._stateSetters.setPolygonOffset),this._polygonOffsetInvalid=!1}_setDepthTest(e){this._depthTest=this._setSubState(e,this._depthTest,this._depthTestInvalid,this._stateSetters.setDepthTest),this._depthTestInvalid=!1}_setStencilTest(e){this._stencilTest=this._setSubState(e,this._stencilTest,this._stencilTestInvalid,this._stateSetters.setStencilTest),this._stencilTestInvalid=!1}_setDepthWrite(e){this._depthWrite=this._setSubState(e,this._depthWrite,this._depthWriteInvalid,this._stateSetters.setDepthWrite),this._depthWriteInvalid=!1}_setColorWrite(e){this._colorWrite=this._setSubState(e,this._colorWrite,this._colorWriteInvalid,this._stateSetters.setColorWrite),this._colorWriteInvalid=!1}_setStencilWrite(e){this._stencilWrite=this._setSubState(e,this._stencilWrite,this._stencilWriteInvalid,this._stateSetters.setStencilWrite),this._stencilTestInvalid=!1}_setSubState(e,r,i,s){return(i||e!==r)&&(s(e),this._pipelineInvalid=!0),e}},aWe=class extends pi{constructor(){super(...arguments),this.heightParameters=sr(),this.radii=Je(),this.innerFadeDistance=0,this.altitudeFade=0,this.hazeStrength=1}},TG=class Yve extends Vr{initializeProgram(e){return new Fr(e.rctx,Yve.shader.get().build(this.configuration),Rr)}initializePipeline(){return this.configuration.haze?Bt({blending:kn(Ee.ONE,Ee.ZERO,Ee.ONE_MINUS_SRC_COLOR,Ee.ONE),colorWrite:Kt}):Bt({blending:kn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),depthTest:{func:Mi.LEQUAL},colorWrite:Kt})}};TG.shader=new Nr(kqe,()=>te(()=>import("./ChapmanAtmosphere.glsl-4c4916d2.js"),[]));let Ca=class extends pi{constructor(){super(),this._key="",this._keyDirty=!1,this._parameterBits=this._parameterBits?this._parameterBits.map(()=>0):[],this._parameterNames||(this._parameterNames=[])}get key(){return this._keyDirty&&(this._keyDirty=!1,this._key=String.fromCharCode.apply(String,this._parameterBits)),this._key}snapshot(){const e=this._parameterNames,r={key:this.key};for(const i of e)r[i]=this[i];return r}};function V(t={}){return(e,r)=>{if(e._parameterNames=e._parameterNames??[],e._parameterNames.push(r),t.constValue!=null)Object.defineProperty(e,r,{get:()=>t.constValue});else{const i=e._parameterNames.length-1,s=t.count||2,n=Math.ceil(Math.log2(s)),o=e._parameterBits??[0];let a=0;for(;o[a]+n>16;)a++,a>=o.length&&o.push(0);e._parameterBits=o;const l=o[a],c=(1<<n)-1<<l;o[a]+=n,Object.defineProperty(e,r,{get(){return this[i]},set(h){if(this[i]!==h&&(this[i]=h,this._keyDirty=!0,this._parameterBits[a]=this._parameterBits[a]&~c|+h<<l&c,typeof h!="number"&&typeof h!="boolean"))throw new Error("Configuration value for "+r+" must be boolean or number, got "+typeof h)}})}}}let Zve=class extends Ca{constructor(){super(...arguments),this.haze=!1}};u([V()],Zve.prototype,"haze",void 0);let Mo=class{constructor(e,r,i,s,n,o=!1,a=0){this.name=e,this.count=r,this.type=i,this.offset=s,this.stride=n,this.normalized=o,this.divisor=a}};new Mo(A.POSITION,3,lt.FLOAT,0,12);new Mo(A.POSITION,3,lt.FLOAT,0,20),new Mo(A.UV0,2,lt.FLOAT,12,20);new Mo(A.POSITION,3,lt.FLOAT,0,32),new Mo(A.NORMAL,3,lt.FLOAT,12,32),new Mo(A.UV0,2,lt.FLOAT,24,32);new Mo(A.POSITION,3,lt.FLOAT,0,16),new Mo(A.COLOR,4,lt.UNSIGNED_BYTE,12,16);const rY=[new Mo(A.POSITION,2,lt.FLOAT,0,8)],kE=[new Mo(A.POSITION,2,lt.FLOAT,0,16),new Mo(A.UV0,2,lt.FLOAT,8,16)];function tie(t){const e=t.gl;switch(e.getError()){case e.NO_ERROR:return null;case e.INVALID_ENUM:return"An unacceptable value has been specified for an enumerated argument";case e.INVALID_VALUE:return"An unacceptable value has been specified for an argument";case e.INVALID_OPERATION:return"The specified command is not allowed for the current state";case e.INVALID_FRAMEBUFFER_OPERATION:return"The currently bound framebuffer is not framebuffer complete";case e.OUT_OF_MEMORY:return"Not enough memory is left to execute the command";case e.CONTEXT_LOST_WEBGL:return"WebGL context is lost"}return"Unknown error"}function Wo(t,e){return t.vertexBuffers[e].size/lWe(t.layout[e])}function lWe(t){return t[0].stride}function iY(t,e,r,i,s=0){const n=t.gl,o=t.capabilities.instancing;t.bindBuffer(r);for(const a of i){const l=e.get(a.name);l===void 0&&console.error(`There is no location for vertex attribute '${a.name}' defined.`);const c=s*a.stride;if(a.count<=4)n.vertexAttribPointer(l,a.count,a.type,a.normalized,a.stride,a.offset+c),n.enableVertexAttribArray(l),a.divisor>0&&o&&o.vertexAttribDivisor(l,a.divisor);else if(a.count===9)for(let h=0;h<3;h++)n.vertexAttribPointer(l+h,3,a.type,a.normalized,a.stride,a.offset+12*h+c),n.enableVertexAttribArray(l+h),a.divisor>0&&o&&o.vertexAttribDivisor(l+h,a.divisor);else if(a.count===16)for(let h=0;h<4;h++)n.vertexAttribPointer(l+h,4,a.type,a.normalized,a.stride,a.offset+16*h+c),n.enableVertexAttribArray(l+h),a.divisor>0&&o&&o.vertexAttribDivisor(l+h,a.divisor);else console.error("Unsupported vertex attribute element count: "+a.count)}}function sY(t,e,r,i){const s=t.gl,n=t.capabilities.instancing;t.bindBuffer(r);for(const o of i){const a=e.get(o.name);if(o.count<=4)s.disableVertexAttribArray(a),o.divisor&&o.divisor>0&&n&&n.vertexAttribDivisor(a,0);else if(o.count===9)for(let l=0;l<3;l++)s.disableVertexAttribArray(a+l),o.divisor&&o.divisor>0&&n&&n.vertexAttribDivisor(a+l,0);else if(o.count===16)for(let l=0;l<4;l++)s.disableVertexAttribArray(a+l),o.divisor&&o.divisor>0&&n&&n.vertexAttribDivisor(a+l,0);else console.error("Unsupported vertex attribute element count: "+o.count)}t.unbindBuffer(Ot.ARRAY_BUFFER)}function Jve(t){switch(t){case Ve.ALPHA:case Ve.LUMINANCE:case Ve.RED:case Ve.RED_INTEGER:case St.R8:case St.R8I:case St.R8UI:case St.R8_SNORM:case Ha.STENCIL_INDEX8:return 1;case Ve.LUMINANCE_ALPHA:case Ve.RG:case Ve.RG_INTEGER:case St.RGBA4:case St.R16F:case St.R16I:case St.R16UI:case St.RG8:case St.RG8I:case St.RG8UI:case St.RG8_SNORM:case St.RGB565:case St.RGB5_A1:case Ha.DEPTH_COMPONENT16:return 2;case Ve.DEPTH_COMPONENT:case Ve.RGB:case Ve.RGB_INTEGER:case St.RGB8:case St.RGB8I:case St.RGB8UI:case St.RGB8_SNORM:case St.SRGB8:case Ha.DEPTH_COMPONENT24:return 3;case Ve.DEPTH_STENCIL:case Ve.RGBA:case Ve.RGBA_INTEGER:case St.RGBA8:case St.R32F:case St.R11F_G11F_B10F:case St.RG16F:case St.R32I:case St.R32UI:case St.RG16I:case St.RG16UI:case St.RGBA8I:case St.RGBA8UI:case St.RGBA8_SNORM:case St.SRGB8_ALPHA8:case St.RGB9_E5:case St.RGB10_A2UI:case St.RGB10_A2:case Ha.DEPTH_STENCIL:case Ha.DEPTH_COMPONENT32F:case Ha.DEPTH24_STENCIL8:return 4;case Ha.DEPTH32F_STENCIL8:return 5;case St.RGB16F:case St.RGB16I:case St.RGB16UI:return 6;case St.RG32F:case St.RG32I:case St.RG32UI:case St.RGBA16F:case St.RGBA16I:case St.RGBA16UI:return 8;case St.RGB32F:case St.RGB32I:case St.RGB32UI:return 12;case St.RGBA32F:case St.RGBA32I:case St.RGBA32UI:return 16;case Ms.COMPRESSED_RGB_S3TC_DXT1_EXT:case Ms.COMPRESSED_RGBA_S3TC_DXT1_EXT:return .5;case Ms.COMPRESSED_RGBA_S3TC_DXT3_EXT:case Ms.COMPRESSED_RGBA_S3TC_DXT5_EXT:return 1;case Ms.COMPRESSED_R11_EAC:case Ms.COMPRESSED_SIGNED_R11_EAC:case Ms.COMPRESSED_RGB8_ETC2:case Ms.COMPRESSED_SRGB8_ETC2:case Ms.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:case Ms.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:return .5;case Ms.COMPRESSED_RG11_EAC:case Ms.COMPRESSED_SIGNED_RG11_EAC:case Ms.COMPRESSED_RGBA8_ETC2_EAC:case Ms.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:return 1}return 0}function Ow(t){if(C(t))return 0;if("descriptor"in t)return t.glName?Ow(t.descriptor):0;const e=t.internalFormat||"pixelFormat"in t&&t.pixelFormat;if(!e)return 0;const r="hasMipmap"in t&&t.hasMipmap?1.3:1,i=t.width*t.height;return Jve(e)*i*r}const $v=se.getLogger("esri.views.webgl.VertexArrayObject");let jh=class{constructor(e,r,i,s,n=null){this._context=e,this._locations=r,this._layout=i,this._buffers=s,this._indexBuffer=n,this._glName=null,this._initialized=!1,e.instanceCounter.increment(Nn.VertexArrayObject,this)}get glName(){return this._glName}get context(){return this._context}get vertexBuffers(){return this._buffers}get indexBuffer(){return this._indexBuffer}get size(){return Object.keys(this._buffers).reduce((e,r)=>e+this._buffers[r].size,v(this._indexBuffer)?this._indexBuffer.size:0)}get layout(){return this._layout}get locations(){return this._locations}dispose(e=!0){var r,i,s;if(!this._context)return void((this._glName||e&&Object.getOwnPropertyNames(this._buffers).length>0)&&$v.warn("Leaked WebGL VAO"));if(this._glName){const n=(i=(r=this._context)==null?void 0:r.capabilities)==null?void 0:i.vao;n?(n.deleteVertexArray(this._glName),this._glName=null):$v.warn("Leaked WebGL VAO")}if(this._context.getBoundVAO()===this&&this._context.bindVAO(null),e){for(const n in this._buffers)(s=this._buffers[n])==null||s.dispose(),delete this._buffers[n];this._indexBuffer=Qe(this._indexBuffer)}this._context.instanceCounter.decrement(Nn.VertexArrayObject,this),this._context=sw(this._context)}initialize(){if(this._initialized)return;const e=this._context.capabilities.vao;if(e){const r=e.createVertexArray();e.bindVertexArray(r),this._bindLayout(),e.bindVertexArray(null),this._glName=r}this._initialized=!0}bind(){this.initialize();const e=this._context.capabilities.vao;e?e.bindVertexArray(this.glName):(this._context.bindVAO(null),this._bindLayout())}_bindLayout(){const{_buffers:e,_layout:r,_indexBuffer:i}=this;e||$v.error("Vertex buffer dictionary is empty!");const s=this._context.gl;for(const n in e){const o=e[n];o||$v.error("Vertex buffer is uninitialized!");const a=r[n];a||$v.error("Vertex element descriptor is empty!"),iY(this._context,this._locations,o,a)}v(i)&&(this._context.capabilities.vao?s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,i.glName):this._context.bindBuffer(i))}unbind(){this.initialize();const e=this._context.capabilities.vao;e?e.bindVertexArray(null):this._unbindLayout()}_unbindLayout(){const{_buffers:e,_layout:r}=this;e||$v.error("Vertex buffer dictionary is empty!");for(const i in e){const s=e[i];s||$v.error("Vertex buffer is uninitialized!");const n=r[i];sY(this._context,this._locations,s,n)}v(this._indexBuffer)&&this._context.unbindBuffer(this._indexBuffer.bufferType)}},Sp=class extends jh{};var vt;function cWe(t,e,r={}){const i=Kve(t);for(;i.length>1;){const s=KN(e,i.shift(),r);if(v(s))return s}return uWe(e,i.shift(),r)}function Kve(t){const e=de("esri-force-webgl");if(e===vt.WEBGL1||e===vt.WEBGL2)return[e];switch(t){case"2d":return de("mac")&&de("chrome")?[vt.WEBGL1,vt.WEBGL2]:[vt.WEBGL2,vt.WEBGL1];case"3d":return[vt.WEBGL2,vt.WEBGL1]}}function uWe(t,e,r={}){if(!window.WebGLRenderingContext)return rie(t,hWe),null;const i=KN(t,e,r);return C(i)&&rie(t,dWe),i}function KN(t,e,r={}){const i=e===vt.WEBGL1?["webgl","experimental-webgl","webkit-3d","moz-webgl"]:["webgl2"];let s=null;for(const n of i){try{s=t.getContext(n,r)}catch{}if(s)break}return s}function rie(t,e){const r=t.parentNode;r&&(r.innerHTML='<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+e+"</div></div></td></tr></table>")}(function(t){t[t.WEBGL1=1]="WEBGL1",t[t.WEBGL2=2]="WEBGL2"})(vt||(vt={}));const hWe='This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>',dWe=`It doesn't appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>`,Pp=se.getLogger("esri.views.webgl.BufferObject");let jr=class e2{static createIndex(e,r,i){return new e2(e,Ot.ELEMENT_ARRAY_BUFFER,r,i)}static createVertex(e,r,i){return new e2(e,Ot.ARRAY_BUFFER,r,i)}static createUniform(e,r,i){if(e.type!==vt.WEBGL2)throw new Error("Uniform buffers are supported in WebGL2 only!");return new e2(e,Ot.UNIFORM_BUFFER,r,i)}static createPixelPack(e,r=Lr.STREAM_READ,i){if(e.type!==vt.WEBGL2)throw new Error("Pixel pack buffers are supported in WebGL2 only!");const s=new e2(e,Ot.PIXEL_PACK_BUFFER,r);return i&&s.setSize(i),s}static createPixelUnpack(e,r=Lr.STREAM_DRAW,i){if(e.type!==vt.WEBGL2)throw new Error("Pixel unpack buffers are supported in WebGL2 only!");return new e2(e,Ot.PIXEL_UNPACK_BUFFER,r,i)}constructor(e,r,i,s){this._context=e,this.bufferType=r,this.usage=i,this._glName=null,this._size=-1,this._indexType=void 0,e.instanceCounter.increment(Nn.BufferObject,this),this._glName=this._context.gl.createBuffer(),l_(this._context.gl),s&&this.setData(s)}get glName(){return this._glName}get size(){return this._size}get indexType(){return this._indexType}get byteSize(){return this.bufferType===Ot.ELEMENT_ARRAY_BUFFER?this._indexType===lt.UNSIGNED_INT?4*this._size:2*this._size:this._size}get _isVAOAware(){return this.bufferType===Ot.ELEMENT_ARRAY_BUFFER||this.bufferType===Ot.ARRAY_BUFFER}dispose(){var e;(e=this._context)!=null&&e.gl?(this._glName&&(this._context.gl.deleteBuffer(this._glName),this._glName=null),this._context.instanceCounter.decrement(Nn.BufferObject,this),this._context=sw(this._context)):this._glName&&Pp.warn("Leaked WebGL buffer object")}setSize(e,r=null){if(e<=0&&Pp.error("Buffer size needs to be positive!"),this.bufferType===Ot.ELEMENT_ARRAY_BUFFER&&v(r))switch(this._indexType=r,r){case lt.UNSIGNED_SHORT:e*=2;break;case lt.UNSIGNED_INT:e*=4}this._setBufferData(e)}setData(e){if(!e)return;let r=e.byteLength;this.bufferType===Ot.ELEMENT_ARRAY_BUFFER&&(VH(e)&&(r/=2,this._indexType=lt.UNSIGNED_SHORT),BH(e)&&(r/=4,this._indexType=lt.UNSIGNED_INT)),this._setBufferData(r,e)}_setBufferData(e,r=null){this._size=e;const i=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const s=this._context.gl;v(r)?s.bufferData(this.bufferType,r,this.usage):s.bufferData(this.bufferType,e,this.usage),l_(s),this._isVAOAware&&this._context.bindVAO(i)}setSubData(e,r,i,s){if(!e)return;(r<0||r*e.BYTES_PER_ELEMENT>=this.byteSize)&&Pp.error("offset is out of range!"),i>=s&&Pp.error("end must be bigger than start!"),(r+(s-i))*e.BYTES_PER_ELEMENT>this.byteSize&&Pp.error("An attempt to write beyond the end of the buffer!");const n=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const o=this._context.gl;if(this._context.type===vt.WEBGL2)o.bufferSubData(this.bufferType,r*e.BYTES_PER_ELEMENT,e,i,s-i);else{const a=i===0&&s===e.length?e:e.subarray(i,s);o.bufferSubData(this.bufferType,r*e.BYTES_PER_ELEMENT,a)}l_(o),this._isVAOAware&&this._context.bindVAO(n)}getSubData(e,r=0,i,s){if(this._context.type!==vt.WEBGL2)return void Pp.error("Get buffer subdata is supported in WebGL2 only!");if(i<0||s<0)return void Pp.error("Problem getting subdata: offset and length were less than zero!");const n=pWe(e)?e.BYTES_PER_ELEMENT:1;if(n*((i??0)+(s??0))>e.byteLength)return void Pp.error("Problem getting subdata: offset and length exceeded destination size!");r+n*(s??0)>this.byteSize&&Pp.warn("Potential problem getting subdata: requested data exceeds buffer size!");const o=this._context.gl;this._context.bindBuffer(this,Ot.COPY_READ_BUFFER),o.getBufferSubData(Ot.COPY_READ_BUFFER,r,e,i,s),this._context.unbindBuffer(Ot.COPY_READ_BUFFER)}async getSubDataAsync(e,r=0,i,s){this._context.type===vt.WEBGL2?(await this._context.clientWaitAsync(),this.getSubData(e,r,i,s)):Pp.error("Get buffer subdata is supported in WebGL2 only!")}};function pWe(t){return fAe(t)}const l8={target:bt.TEXTURE_2D,samplingMode:tt.LINEAR,wrapMode:Rt.REPEAT,flipped:!1,hasMipmap:!1,isOpaque:!1,unpackAlignment:4,preMultiplyAlpha:!1,isImmutable:!1},iie=4;let ct=class{constructor(e,r,i=null){this._context=e,this.type="texture",this._glName=null,this._samplingModeDirty=!1,this._wrapModeDirty=!1,this._wasImmutablyAllocated=!1,e.instanceCounter.increment(Nn.Texture,this),this._descriptor={...l8,...r};for(const s in l8)this._descriptor[s]===void 0&&(this._descriptor[s]=l8[s]);if(e.type!==vt.WEBGL2&&(this._descriptor.isImmutable&&(this._descriptor.isImmutable=!1),Lv(this._descriptor.target)))throw new Error("3D and array textures are not supported in WebGL1");this._descriptor.target===bt.TEXTURE_CUBE_MAP?this._setDataCubeMap(i):this.setData(i)}get glName(){return this._glName}get descriptor(){return this._descriptor}get isDirty(){return this._samplingModeDirty||this._wrapModeDirty}dispose(){this._context.gl&&this._glName&&(this._context.unbindTexture(this),this._context.gl.deleteTexture(this._glName),this._glName=null,this._context.instanceCounter.decrement(Nn.Texture,this))}release(){this.dispose()}resize(e,r){const i=this._descriptor;if(i.width!==e||i.height!==r){if(this._wasImmutablyAllocated)throw new Error("Immutable textures can't be resized!");i.width=e,i.height=r,this._descriptor.target===bt.TEXTURE_CUBE_MAP?this._setDataCubeMap(null):this.setData(null)}}_setDataCubeMap(e=null){for(let r=bt.TEXTURE_CUBE_MAP_POSITIVE_X;r<=bt.TEXTURE_CUBE_MAP_NEGATIVE_Z;r++)this._setData(e,r)}setData(e){this._setData(e)}_setData(e,r){if(!this._context||!this._context.gl)return;const i=this._context.gl;this._glName||(this._glName=i.createTexture()),e===void 0&&(e=null);const s=this._descriptor,n=r??s.target,o=Lv(n);e===null&&(s.width=s.width||iie,s.height=s.height||iie,o&&(s.depth=s.depth??1));const a=this._context.bindTexture(this,ct.TEXTURE_UNIT_FOR_UPDATES);this._context.setActiveTexture(ct.TEXTURE_UNIT_FOR_UPDATES),ct._validateTexture(this._context,s),this._configurePixelStorage(),l_(i);const l=s.pixelFormat;let c=s.internalFormat??this._deriveInternalFormat(l,s.dataType);if(c8(e)){let h=e.width,p=e.height;const f=1;e instanceof HTMLVideoElement&&(h=e.videoWidth,p=e.videoHeight),s.width&&s.height,o&&s.depth,s.isImmutable&&!this._wasImmutablyAllocated&&this._texStorage(n,c,s.hasMipmap,h,p,f),this._texImage(n,0,c,h,p,f,e),l_(i),s.hasMipmap&&this.generateMipmap(),s.width===void 0&&(s.width=h),s.height===void 0&&(s.height=p),o&&s.depth===void 0&&(s.depth=f)}else{const{width:h,height:p,depth:f}=s;if(h==null||p==null)throw new Error("Width and height must be specified!");if(o&&f==null)throw new Error("Depth must be specified!");if(s.isImmutable&&!this._wasImmutablyAllocated&&this._texStorage(n,c,s.hasMipmap,h,p,f),i.DEPTH24_STENCIL8&&c===i.DEPTH_STENCIL&&(c=i.DEPTH24_STENCIL8),eD(e)){const m=e.levels,y=sie(n,h,p,f),_=Math.min(y-1,m.length-1);v(this._context.gl2)?i.texParameteri(s.target,this._context.gl2.TEXTURE_MAX_LEVEL,_):s.hasMipmap=s.hasMipmap&&y===m.length;const b=c;if(!mWe(b))throw new Error("Attempting to use compressed data with an umcompressed format!");this._forEachMipmapLevel((x,T,S,E)=>{const O=m[Math.min(x,m.length-1)];this._compressedTexImage(n,x,b,T,S,E,O)},_)}else v(e)?(this._texImage(n,0,c,h,p,f,e),l_(i),s.hasMipmap&&this.generateMipmap()):this._forEachMipmapLevel((m,y,_,b)=>{this._texImage(n,m,c,y,_,b,null),l_(i)})}ct._applySamplingMode(i,this._descriptor),ct._applyWrapMode(i,this._descriptor),ct._applyAnisotropicFilteringParameters(this._context,this._descriptor),l_(i),this._context.bindTexture(a,ct.TEXTURE_UNIT_FOR_UPDATES)}updateData(e,r,i,s,n,o,a=0){o||console.error("An attempt to use uninitialized data!"),this._glName||console.error("An attempt to update uninitialized texture!");const l=this._context.gl,c=this._descriptor,{pixelFormat:h,dataType:p,target:f,isImmutable:m}=c,y=c.internalFormat??this._deriveInternalFormat(h,p);if(m&&!this._wasImmutablyAllocated)throw new Error("Cannot update immutable texture before allocation!");const _=this._context.bindTexture(this,ct.TEXTURE_UNIT_FOR_UPDATES,!0);if((r<0||i<0||s>c.width||n>c.height||r+s>c.width||i+n>c.height)&&console.error("An attempt to update out of bounds of the texture!"),this._configurePixelStorage(),a){if(C(this._context.gl2))return void console.error("Webgl2 must be enabled to use dataRowOffset!");l.pixelStorei(this._context.gl2.UNPACK_SKIP_ROWS,a)}if(c8(o)?v(this._context.gl2)?this._context.gl2.texSubImage2D(f,e,r,i,s,n,h,p,o):l.texSubImage2D(f,e,r,i,h,p,o):eD(o)?l.compressedTexSubImage2D(f,e,r,i,s,n,y,o.levels[e]):l.texSubImage2D(f,e,r,i,s,n,h,p,o),a){if(C(this._context.gl2))return void console.error("Webgl2 must be enabled to use dataRowOffset!");l.pixelStorei(this._context.gl2.UNPACK_SKIP_ROWS,0)}this._context.bindTexture(_,ct.TEXTURE_UNIT_FOR_UPDATES)}updateData3D(e,r,i,s,n,o,a,l){l||console.error("An attempt to use uninitialized data!"),this._glName||console.error("An attempt to update uninitialized texture!");const c=this._context.gl2;if(C(c))throw new Error("3D textures are not supported in WebGL1");const h=this._descriptor,{pixelFormat:p,dataType:f,isImmutable:m,target:y}=h,_=h.internalFormat??this._deriveInternalFormat(p,f);if(m&&!this._wasImmutablyAllocated)throw new Error("Cannot update immutable texture before allocation!");Lv(y)||console.warn("Attempting to set 3D texture data on a non-3D texture");const b=this._context.bindTexture(this,ct.TEXTURE_UNIT_FOR_UPDATES);if(this._context.setActiveTexture(ct.TEXTURE_UNIT_FOR_UPDATES),(r<0||i<0||s<0||n>h.width||o>h.height||a>h.depth||r+n>h.width||i+o>h.height||s+a>h.depth)&&console.error("An attempt to update out of bounds of the texture!"),this._configurePixelStorage(),eD(l))l=l.levels[e],c.compressedTexSubImage3D(y,e,r,i,s,n,o,a,_,l);else{const x=l;c.texSubImage3D(y,e,r,i,s,n,o,a,p,f,x)}this._context.bindTexture(b,ct.TEXTURE_UNIT_FOR_UPDATES)}generateMipmap(){const e=this._descriptor;if(!e.hasMipmap){if(this._wasImmutablyAllocated)throw new Error("Cannot add mipmaps to immutable texture after allocation");e.hasMipmap=!0,this._samplingModeDirty=!0,ct._validateTexture(this._context,e)}e.samplingMode===tt.LINEAR?(this._samplingModeDirty=!0,e.samplingMode=tt.LINEAR_MIPMAP_NEAREST):e.samplingMode===tt.NEAREST&&(this._samplingModeDirty=!0,e.samplingMode=tt.NEAREST_MIPMAP_NEAREST);const r=this._context.bindTexture(this,ct.TEXTURE_UNIT_FOR_UPDATES);this._context.setActiveTexture(ct.TEXTURE_UNIT_FOR_UPDATES),this._context.gl.generateMipmap(e.target),this._context.bindTexture(r,ct.TEXTURE_UNIT_FOR_UPDATES)}setSamplingMode(e){e!==this._descriptor.samplingMode&&(this._descriptor.samplingMode=e,this._samplingModeDirty=!0)}setWrapMode(e){e!==this._descriptor.wrapMode&&(this._descriptor.wrapMode=e,ct._validateTexture(this._context,this._descriptor),this._wrapModeDirty=!0)}applyChanges(){const e=this._context.gl,r=this._descriptor;this._samplingModeDirty&&(ct._applySamplingMode(e,r),this._samplingModeDirty=!1),this._wrapModeDirty&&(ct._applyWrapMode(e,r),this._wrapModeDirty=!1)}_deriveInternalFormat(e,r){if(this._context.type===vt.WEBGL1)return e;switch(r){case Lt.FLOAT:switch(e){case Ve.RGBA:return St.RGBA32F;case Ve.RGB:return St.RGB32F;default:throw new Error("Unable to derive format")}case Lt.UNSIGNED_BYTE:switch(e){case Ve.RGBA:return St.RGBA8;case Ve.RGB:return St.RGB8}default:return e}}_configurePixelStorage(){const e=this._context.gl,{unpackAlignment:r,flipped:i,preMultiplyAlpha:s}=this._descriptor;e.pixelStorei(e.UNPACK_ALIGNMENT,r),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,i?1:0),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,s?1:0)}_texStorage(e,r,i,s,n,o){const a=this._context.gl2;if(C(a))throw new Error("Immutable textures are not supported in WebGL1");if(!fWe(r))throw new Error("Immutable textures must have a sized internal format");if(!this._descriptor.isImmutable)return;const l=i?sie(e,s,n,o):1;if(Lv(e)){if(o==null)throw new Error("Missing depth dimension for 3D texture upload");a.texStorage3D(e,l,r,s,n,o)}else a.texStorage2D(e,l,r,s,n);this._wasImmutablyAllocated=!0}_texImage(e,r,i,s,n,o,a){const l=this._context.gl;let c=null;const h=this._context.type===vt.WEBGL2,p=Lv(e),{isImmutable:f,pixelFormat:m,dataType:y}=this._descriptor;if(h&&(c=l),h||!c8(a))if(f){if(v(a)){const _=a;if(p){if(o==null)throw new Error("Missing depth dimension for 3D texture upload");c.texSubImage3D(e,r,0,0,0,s,n,o,m,y,_)}else l.texSubImage2D(e,r,0,0,s,n,m,y,_)}}else{const _=a;if(p){if(o==null)throw new Error("Missing depth dimension for 3D texture upload");c.texImage3D(e,r,i,s,n,o,0,m,y,_)}else l.texImage2D(e,r,i,s,n,0,m,y,_)}else l.texImage2D(e,0,i,m,y,a)}_compressedTexImage(e,r,i,s,n,o,a){const l=this._context.gl;let c=null;const h=Lv(e),p=this._descriptor.isImmutable;if(h){if(this._context.type!==vt.WEBGL2)throw new Error("3D textures are not supported in WebGL1");c=l}if(p){if(v(a))if(h){if(o==null)throw new Error("Missing depth dimension for 3D texture upload");c.compressedTexSubImage3D(e,r,0,0,0,s,n,o,i,a)}else l.compressedTexSubImage2D(e,r,0,0,s,n,i,a)}else if(h){if(o==null)throw new Error("Missing depth dimension for 3D texture upload");c.compressedTexImage3D(e,r,i,s,n,o,0,a)}else l.compressedTexImage2D(e,r,i,s,n,0,a)}_forEachMipmapLevel(e,r=1/0){let{width:i,height:s,depth:n,hasMipmap:o,target:a}=this._descriptor;const l=a===bt.TEXTURE_3D;if(i==null||s==null||l&&n==null)throw new Error("Missing texture dimensions for mipmap calculation");for(let c=0;e(c,i,s,n),o&&(i!==1||s!==1||l&&n!==1)&&!(c>=r);++c)i=Math.max(1,i>>1),s=Math.max(1,s>>1),l&&(n=Math.max(1,n>>1))}static _validateTexture(e,r){(r.width!=null&&r.width<0||r.height!=null&&r.height<0||r.depth!=null&&r.depth<0)&&console.error("Negative dimension parameters are not allowed!");const i=e.type===vt.WEBGL2,s=r.width!=null&&dp(r.width)&&r.height!=null&&dp(r.height);i||!r.isImmutable&&!Lv(r.target)||console.error("Immutable and 3D-like textures are not supported in WebGL1!"),i||s||(typeof r.wrapMode=="number"?r.wrapMode!==Rt.CLAMP_TO_EDGE&&console.error("Non-power-of-two textures must have a wrap mode of CLAMP_TO_EDGE!"):r.wrapMode.s===Rt.CLAMP_TO_EDGE&&r.wrapMode.t===Rt.CLAMP_TO_EDGE||console.error("Non-power-of-two textures must have a wrap mode of CLAMP_TO_EDGE!"),r.hasMipmap&&console.error("Mipmapping requires power-of-two textures!"))}static _applySamplingMode(e,r){let i=r.samplingMode,s=r.samplingMode;i===tt.LINEAR_MIPMAP_NEAREST||i===tt.LINEAR_MIPMAP_LINEAR?(i=tt.LINEAR,r.hasMipmap||(s=tt.LINEAR)):i!==tt.NEAREST_MIPMAP_NEAREST&&i!==tt.NEAREST_MIPMAP_LINEAR||(i=tt.NEAREST,r.hasMipmap||(s=tt.NEAREST)),e.texParameteri(r.target,e.TEXTURE_MAG_FILTER,i),e.texParameteri(r.target,e.TEXTURE_MIN_FILTER,s)}static _applyWrapMode(e,r){typeof r.wrapMode=="number"?(e.texParameteri(r.target,e.TEXTURE_WRAP_S,r.wrapMode),e.texParameteri(r.target,e.TEXTURE_WRAP_T,r.wrapMode)):(e.texParameteri(r.target,e.TEXTURE_WRAP_S,r.wrapMode.s),e.texParameteri(r.target,e.TEXTURE_WRAP_T,r.wrapMode.t))}static _applyAnisotropicFilteringParameters(e,r){const i=e.capabilities.textureFilterAnisotropic;i&&e.gl.texParameterf(r.target,i.TEXTURE_MAX_ANISOTROPY,r.maxAnisotropy??1)}};function fWe(t){return t in St}function mWe(t){return t in Ms}function eD(t){return v(t)&&"type"in t&&t.type==="compressed"}function gWe(t){return v(t)&&"byteLength"in t}function c8(t){return v(t)&&!eD(t)&&!gWe(t)}function Lv(t){return t===bt.TEXTURE_3D||t===bt.TEXTURE_2D_ARRAY}function sie(t,e,r,i=1){let s=Math.max(e,r);return t===bt.TEXTURE_3D&&(s=Math.max(s,i)),Math.round(Math.log(s)/Math.LN2)+1}ct.TEXTURE_UNIT_FOR_UPDATES=0;function Aa(t,e=rY,r=Rr,i=-1,s=1){let n=null;return e===kE?n=new Float32Array([i,i,0,0,s,i,1,0,i,s,0,1,s,s,1,1]):n=new Float32Array([i,i,s,i,i,s,s,s]),new Sp(t,r,{geometry:e},{geometry:jr.createVertex(t,Lr.STATIC_DRAW,n)})}function yWe(t,e=rY,r=Rr){const i=new Float32Array([-1,-1,3,-1,-1,3]);return new Sp(t,r,{geometry:e},{geometry:jr.createVertex(t,Lr.STATIC_DRAW,i)})}const Qve=4;function e1e(t,e=Qve){return new ct(t,{target:bt.TEXTURE_2D,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,width:e,height:e})}function _We(t,e,r=Qve){const i=new Uint8Array(r*r*4);for(let s=0;s<i.length;s+=4)i[s+0]=255*e[0],i[s+1]=255*e[1],i[s+2]=255*e[2],i[s+3]=255*e[3];return new ct(t,{target:bt.TEXTURE_2D,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,width:r,height:r},i)}function t1e(t){return new ct(t,{target:bt.TEXTURE_2D,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,width:1,height:1},new Uint8Array([255,255,255,255]))}let u8=class{constructor(e,r){this._view=e,this.type=An.Realistic,this._handles=new ei,this._passParameters=new aWe,this._rootTileElevationMin=NaN,this._lowerBoundEarthRadius=wr.radius,this._fadeHaze=0,this._updateRadius(wr.radius);const i=r.renderContext.rctx;this._updateRootTileElevationBounds(),this._handles.add([ie(()=>this._view.basemapTerrain.rootTileElevationBounds,()=>this._updateRootTileElevationBounds()),ie(()=>this._view.basemapTerrain.visibleElevationBounds,()=>this._updateVisibleElevationBounds())]);const s=new Zve;s.haze=!1,this._atmosphereTechnique=r.techniqueRepository.acquire(TG,s),s.haze=!0,this._atmosphereHazeTechnique=r.techniqueRepository.acquire(TG,s),this._vao=Aa(i,kE)}destroy(){this._atmosphereTechnique.release(),this._atmosphereHazeTechnique.release(),this._vao.dispose(),this._handles.destroy()}render(e){this._render(e,this._atmosphereTechnique,e.offscreenRenderingHelper.depthTexture)}renderHaze(e,r){this._fadeHaze=r,this._render(e,this._atmosphereHazeTechnique,e.offscreenRenderingHelper.linearDepthTexture)}_render(e,r,i){if(C(i))return;this._update(e.bindParameters.camera),this._passParameters.depthTex=i;const s=e.rctx.bindTechnique(r,this._passParameters,e.bindParameters);e.offscreenRenderingHelper.renderDepthDetached(()=>this._renderCommon(s,e))}_renderCommon(e,r){C(this._vao)||(r.rctx.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),r.rctx.drawArrays($t.TRIANGLE_STRIP,0,4))}_adjustRadiusForTesselation(e){return e*Math.cos(Math.PI/16/16)}_updateRootTileElevationBounds(){const e=this._view.basemapTerrain.rootTileElevationBounds.min;e!==this._rootTileElevationMin&&(this._rootTileElevationMin=e,this._lowerBoundEarthRadius=wr.radius,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const e=this._adjustRadiusForTesselation(wr.radius+this._view.basemapTerrain.visibleElevationBounds.min);e<this._lowerBoundEarthRadius&&this._updateRadius(e)}_updateRadius(e){this._lowerBoundEarthRadius=e,or(this._passParameters.radii,e,e+uO),this._passParameters.innerFadeDistance=2*Math.sqrt((2*e-_G)*_G)}_update(e){if(C(e))return;const r=ua(e.eye),i=Math.sqrt(r),s=r-this._passParameters.radii[1]*this._passParameters.radii[1],n=ge((i-this._passParameters.radii[0])/uO,0,1);ti(this._passParameters.heightParameters,i,r,s,n),this._passParameters.altitudeFade=QX(i-this._lowerBoundEarthRadius),this._passParameters.hazeStrength=Ft(Ft(.6,1,CS(9500,10500,i-wr.radius)),1,this._fadeHaze)}static isSupported(e){return e.renderContext.rctx.capabilities.depthTexture}};function Vi(){return new Float32Array(3)}function QN(t){const e=new Float32Array(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function Xr(t,e,r){const i=new Float32Array(3);return i[0]=t,i[1]=e,i[2]=r,i}function r1e(t,e){return new Float32Array(t,e,3)}function nY(){return Vi()}function i1e(){return Xr(1,1,1)}function s1e(){return Xr(1,0,0)}function n1e(){return Xr(0,1,0)}function o1e(){return Xr(0,0,1)}const vWe=nY(),bWe=i1e(),wWe=s1e(),xWe=n1e(),TWe=o1e();Object.freeze(Object.defineProperty({__proto__:null,ONES:bWe,UNIT_X:wWe,UNIT_Y:xWe,UNIT_Z:TWe,ZEROS:vWe,clone:QN,create:Vi,createView:r1e,fromValues:Xr,ones:i1e,unitX:s1e,unitY:n1e,unitZ:o1e,zeros:nY},Symbol.toStringTag,{value:"Module"}));function a1e(t){t.extensions.add("GL_EXT_shader_texture_lod"),t.extensions.add("GL_OES_standard_derivatives"),t.fragment.code.add(w`#ifndef GL_EXT_shader_texture_lod
float calcMipMapLevel(const vec2 ddx, const vec2 ddy) {
float deltaMaxSqr = max(dot(ddx, ddx), dot(ddy, ddy));
return max(0.0, 0.5 * log2(deltaMaxSqr));
}
#endif
vec4 textureAtlasLookup(sampler2D texture, vec2 textureSize, vec2 textureCoordinates, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(textureCoordinates) * atlasScale + atlasRegion.xy;
float maxdUV = 0.125;
vec2 dUVdx = clamp(dFdx(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
vec2 dUVdy = clamp(dFdy(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
#ifdef GL_EXT_shader_texture_lod
return texture2DGradEXT(texture, uvAtlas, dUVdx, dUVdy);
#else
vec2 dUVdxAuto = dFdx(uvAtlas);
vec2 dUVdyAuto = dFdy(uvAtlas);
float mipMapLevel = calcMipMapLevel(dUVdx * textureSize, dUVdy * textureSize);
float autoMipMapLevel = calcMipMapLevel(dUVdxAuto * textureSize, dUVdyAuto * textureSize);
return texture2D(texture, uvAtlas, mipMapLevel - autoMipMapLevel);
#endif
}`)}function oY(t,e){switch(t.include(Zf,e),t.fragment.code.add(w`
  struct TextureLookupParameter {
    vec2 uv;
    ${e.supportsTextureAtlas?"vec2 size;":""}
  } vtc;
  `),e.textureCoordinateType){case qs.Default:case qs.Compressed:return void t.fragment.code.add(w`vec4 textureLookup(sampler2D texture, TextureLookupParameter params) {
return texture2D(texture, params.uv);
}`);case qs.Atlas:return t.include(a1e),void t.fragment.code.add(w`vec4 textureLookup(sampler2D texture, TextureLookupParameter params) {
return textureAtlasLookup(texture, params.size, params.uv, vuvRegion);
}`);default:e.textureCoordinateType;case qs.None:case qs.COUNT:return}}let Pu=class extends ws{constructor(e,r){super(e,"vec3",di.Draw,(i,s,n,o)=>i.setUniform3fv(e,r(s,n,o)))}},hO=class extends ws{constructor(e,r){super(e,"vec2",di.Draw,(i,s,n,o)=>i.setUniform2fv(e,r(s,n,o)))}},SM=class extends ws{constructor(e,r){super(e,"sampler2D",di.Draw,(i,s,n)=>i.bindTexture(e,r(s,n)))}};function k_(t,e,r=Qr.None){const i=[new SM(t,e)];if(r&Qr.Size){const s=t+eY;i.push(new hO(s,(n,o)=>{const a=e(n,o);return v(a)?or(nie,a.descriptor.width,a.descriptor.height):Wl}))}if(r&Qr.InvSize){const s=t+g5;i.push(new hO(s,(n,o)=>{const a=e(n,o);return v(a)?or(nie,1/a.descriptor.width,1/a.descriptor.height):Wl}))}return i}const nie=Je();let bv=class{constructor(e){this._material=e.material,this._techniqueRepository=e.techniqueRep,this._output=e.output}dispose(){this._techniqueRepository.release(this._technique)}get technique(){return this._technique}get _stippleTextureRepository(){return this._techniqueRepository.constructionContext.stippleTextureRepository}ensureTechnique(e,r){return this._technique=this._techniqueRepository.releaseAndAcquire(e,this._material.getConfiguration(this._output,r),this._technique),this._technique}ensureResources(e){return Vg.LOADED}},aY=class extends bv{constructor(e){super(e),this._numLoading=0,this._disposed=!1,this._textureRepository=e.textureRep,this._textureId=e.textureId,this._acquire(e.textureId,r=>this._texture=r),this._acquire(e.normalTextureId,r=>this._textureNormal=r),this._acquire(e.emissiveTextureId,r=>this._textureEmissive=r),this._acquire(e.occlusionTextureId,r=>this._textureOcclusion=r),this._acquire(e.metallicRoughnessTextureId,r=>this._textureMetallicRoughness=r)}dispose(){this._texture=Bi(this._texture),this._textureNormal=Bi(this._textureNormal),this._textureEmissive=Bi(this._textureEmissive),this._textureOcclusion=Bi(this._textureOcclusion),this._textureMetallicRoughness=Bi(this._textureMetallicRoughness),this._disposed=!0}ensureResources(e){return this._numLoading===0?Vg.LOADED:Vg.LOADING}get textureBindParameters(){return new l1e(v(this._texture)?this._texture.glTexture:null,v(this._textureNormal)?this._textureNormal.glTexture:null,v(this._textureEmissive)?this._textureEmissive.glTexture:null,v(this._textureOcclusion)?this._textureOcclusion.glTexture:null,v(this._textureMetallicRoughness)?this._textureMetallicRoughness.glTexture:null)}updateTexture(e){(C(this._texture)||e!==this._texture.id)&&(this._texture=Bi(this._texture),this._textureId=e,this._acquire(this._textureId,r=>this._texture=r))}_acquire(e,r){if(C(e))return void r(null);const i=this._textureRepository.acquire(e);if(Uu(i))return++this._numLoading,void i.then(s=>{if(this._disposed)return Bi(s),void r(null);r(s)}).finally(()=>--this._numLoading);r(i)}},l1e=class extends pi{constructor(e=null,r=null,i=null,s=null,n=null){super(),this.texture=e,this.textureNormal=r,this.textureEmissive=i,this.textureOcclusion=s,this.textureMetallicRoughness=n}};const ICt=Xr(0,.6,.2);var dt;(function(t){t[t.Disabled=0]="Disabled",t[t.Normal=1]="Normal",t[t.Schematic=2]="Schematic",t[t.Water=3]="Water",t[t.WaterOnIntegratedMesh=4]="WaterOnIntegratedMesh",t[t.Terrain=5]="Terrain",t[t.TerrainWithWater=6]="TerrainWithWater",t[t.COUNT=7]="COUNT"})(dt||(dt={}));function lY(t,e){const r=t.fragment,i=e.hasMetallicRoughnessTexture||e.hasEmissionTexture||e.hasOcclusionTexture;if(e.pbrMode===dt.Normal&&i&&t.include(oY,e),e.pbrMode!==dt.Schematic)if(e.pbrMode!==dt.Disabled){if(e.pbrMode===dt.Normal){r.code.add(w`vec3 mrr;
vec3 emission;
float occlusion;`);const s=e.supportsTextureAtlas?e.hasWebGL2Context?Qr.None:Qr.Size:Qr.None,n=e.pbrTextureBindType;e.hasMetallicRoughnessTexture&&(r.uniforms.add(n===di.Pass?op("texMetallicRoughness",o=>o.textureMetallicRoughness,s):k_("texMetallicRoughness",o=>o.textureMetallicRoughness,s)),r.code.add(w`void applyMetallnessAndRoughness(TextureLookupParameter params) {
vec3 metallicRoughness = textureLookup(texMetallicRoughness, params).rgb;
mrr[0] *= metallicRoughness.b;
mrr[1] *= metallicRoughness.g;
}`)),e.hasEmissionTexture&&(r.uniforms.add(n===di.Pass?op("texEmission",o=>o.textureEmissive,s):k_("texEmission",o=>o.textureEmissive,s)),r.code.add(w`void applyEmission(TextureLookupParameter params) {
emission *= textureLookup(texEmission, params).rgb;
}`)),e.hasOcclusionTexture?(r.uniforms.add(n===di.Pass?op("texOcclusion",o=>o.textureOcclusion,s):k_("texOcclusion",o=>o.textureOcclusion,s)),r.code.add(w`void applyOcclusion(TextureLookupParameter params) {
occlusion *= textureLookup(texOcclusion, params).r;
}
float getBakedOcclusion() {
return occlusion;
}`)):r.code.add(w`float getBakedOcclusion() { return 1.0; }`),r.uniforms.add(n===di.Pass?[new qt("emissionFactor",o=>o.emissiveFactor),new qt("mrrFactors",o=>o.mrrFactors)]:[new Pu("emissionFactor",o=>o.emissiveFactor),new Pu("mrrFactors",o=>o.mrrFactors)]),r.code.add(w`
    void applyPBRFactors() {
      mrr = mrrFactors;
      emission = emissionFactor;
      occlusion = 1.0;
      ${i?w`vtc.uv = vuv0;`:""}
      ${e.hasMetallicRoughnessTextureTransform?w`vtc.uv = metallicRoughnessUV;`:""}
      ${e.hasMetallicRoughnessTexture?e.supportsTextureAtlas?w`
                vtc.size = ${$h(e,"texMetallicRoughness")};
                applyMetallnessAndRoughness(vtc);`:w`applyMetallnessAndRoughness(vtc);`:""}
      ${e.hasEmissiveTextureTransform?w`vtc.uv = emissiveUV;`:""}
      ${e.hasEmissionTexture?e.supportsTextureAtlas?w`
                vtc.size = ${$h(e,"texEmission")};
                applyEmission(vtc);`:w`applyEmission(vtc);`:""}
      ${e.hasOcclusionTextureTransform?w`vtc.uv = occlusionUV;`:""}
      ${e.hasOcclusionTexture?e.supportsTextureAtlas?w`
                vtc.size = ${$h(e,"texOcclusion")};
                applyOcclusion(vtc);`:w`applyOcclusion(vtc);`:""}
    }
  `)}}else r.code.add(w`float getBakedOcclusion() { return 1.0; }`);else r.code.add(w`vec3 mrr = vec3(0.0, 0.6, 0.2);
vec3 emission = vec3(0.0);
float occlusion = 1.0;
void applyPBRFactors() {}
float getBakedOcclusion() { return 1.0; }`)}function cY(t,e){const r=t.fragment,i=e.lightingSphericalHarmonicsOrder!==void 0?e.lightingSphericalHarmonicsOrder:2;i===0?(r.uniforms.add(new qt("lightingAmbientSH0",(s,n)=>ce(oie,n.lighting.sh.r[0],n.lighting.sh.g[0],n.lighting.sh.b[0]))),r.code.add(w`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
return ambientLight * (1.0 - ambientOcclusion);
}`)):i===1?(r.uniforms.add([new pr("lightingAmbientSH_R",(s,n)=>ti($m,n.lighting.sh.r[0],n.lighting.sh.r[1],n.lighting.sh.r[2],n.lighting.sh.r[3])),new pr("lightingAmbientSH_G",(s,n)=>ti($m,n.lighting.sh.g[0],n.lighting.sh.g[1],n.lighting.sh.g[2],n.lighting.sh.g[3])),new pr("lightingAmbientSH_B",(s,n)=>ti($m,n.lighting.sh.b[0],n.lighting.sh.b[1],n.lighting.sh.b[2],n.lighting.sh.b[3]))]),r.code.add(w`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec4 sh0 = vec4(
0.282095,
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y
);
vec3 ambientLight = vec3(
dot(lightingAmbientSH_R, sh0),
dot(lightingAmbientSH_G, sh0),
dot(lightingAmbientSH_B, sh0)
);
return ambientLight * (1.0 - ambientOcclusion);
}`)):i===2&&(r.uniforms.add([new qt("lightingAmbientSH0",(s,n)=>ce(oie,n.lighting.sh.r[0],n.lighting.sh.g[0],n.lighting.sh.b[0])),new pr("lightingAmbientSH_R1",(s,n)=>ti($m,n.lighting.sh.r[1],n.lighting.sh.r[2],n.lighting.sh.r[3],n.lighting.sh.r[4])),new pr("lightingAmbientSH_G1",(s,n)=>ti($m,n.lighting.sh.g[1],n.lighting.sh.g[2],n.lighting.sh.g[3],n.lighting.sh.g[4])),new pr("lightingAmbientSH_B1",(s,n)=>ti($m,n.lighting.sh.b[1],n.lighting.sh.b[2],n.lighting.sh.b[3],n.lighting.sh.b[4])),new pr("lightingAmbientSH_R2",(s,n)=>ti($m,n.lighting.sh.r[5],n.lighting.sh.r[6],n.lighting.sh.r[7],n.lighting.sh.r[8])),new pr("lightingAmbientSH_G2",(s,n)=>ti($m,n.lighting.sh.g[5],n.lighting.sh.g[6],n.lighting.sh.g[7],n.lighting.sh.g[8])),new pr("lightingAmbientSH_B2",(s,n)=>ti($m,n.lighting.sh.b[5],n.lighting.sh.b[6],n.lighting.sh.b[7],n.lighting.sh.b[8]))]),r.code.add(w`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
vec4 sh1 = vec4(
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y,
1.092548 * normal.x * normal.y
);
vec4 sh2 = vec4(
1.092548 * normal.y * normal.z,
0.315392 * (3.0 * normal.z * normal.z - 1.0),
1.092548 * normal.x * normal.z,
0.546274 * (normal.x * normal.x - normal.y * normal.y)
);
ambientLight += vec3(
dot(lightingAmbientSH_R1, sh1),
dot(lightingAmbientSH_G1, sh1),
dot(lightingAmbientSH_B1, sh1)
);
ambientLight += vec3(
dot(lightingAmbientSH_R2, sh2),
dot(lightingAmbientSH_G2, sh2),
dot(lightingAmbientSH_B2, sh2)
);
return ambientLight * (1.0 - ambientOcclusion);
}`),e.pbrMode!==dt.Normal&&e.pbrMode!==dt.Schematic||r.code.add(w`const vec3 skyTransmittance = vec3(0.9, 0.9, 1.0);
vec3 calculateAmbientRadiance(float ambientOcclusion)
{
vec3 ambientLight = 1.2 * (0.282095 * lightingAmbientSH0) - 0.2;
return ambientLight *= (1.0 - ambientOcclusion) * skyTransmittance;
}`))}const oie=M(),$m=sr();function EM(t){t.vertex.code.add(w`const float PI = 3.141592653589793;`),t.fragment.code.add(w`const float PI = 3.141592653589793;
const float LIGHT_NORMALIZATION = 1.0 / PI;
const float INV_PI = 0.3183098861837907;
const float HALF_PI = 1.570796326794897;`)}var Is,Mw;function SWe(t){return v(t)&&v(t.cubeMap)}function uY(t){return v(t)&&!t.running}(function(t){t[t.RENDERING=0]="RENDERING",t[t.FINISHED_RENDERING=1]="FINISHED_RENDERING",t[t.FADING_TEXTURE_CHANNELS=2]="FADING_TEXTURE_CHANNELS",t[t.SWITCH_CHANNELS=3]="SWITCH_CHANNELS",t[t.FINISHED=4]="FINISHED"})(Is||(Is={})),function(t){t[t.RG=0]="RG",t[t.BA=1]="BA"}(Mw||(Mw={}));let EWe=class{constructor(){this.readChannels=Mw.RG,this.renderingStage=Is.FINISHED,this.startTime=0,this.startTimeHeightFade=0,this.cameraPositionLastFrame=M(),this.isCameraPositionFinal=!0,this.parallax=new aie,this.parallaxNew=new aie,this.crossFade={enabled:!1,factor:1,distanceThresholdFactor:.3},this.fadeInOut={stage:Rn.FINISHED,factor:1,distanceThresholdFactor:.6},this.fadeIn={stage:vc.FINISHED,factor:1,distanceThresholdFactor:2},this.fadeInOutHeight={stage:tv.FINISHED,factor:-1}}get isFading(){return this.fadeInOut.stage===Rn.FADE_OUT||this.fadeInOut.stage===Rn.FADE_IN||this.fadeIn.stage===vc.FADE_IN||this.fadeInOutHeight.stage!==tv.FINISHED||this.renderingStage===Is.FADING_TEXTURE_CHANNELS}};var vc,Rn,tv;(function(t){t[t.FINISHED=0]="FINISHED",t[t.CHANGE_ANCHOR=1]="CHANGE_ANCHOR",t[t.FADE_IN=2]="FADE_IN"})(vc||(vc={})),function(t){t[t.FINISHED=0]="FINISHED",t[t.FADE_OUT=1]="FADE_OUT",t[t.SWITCH=2]="SWITCH",t[t.FADE_IN=3]="FADE_IN"}(Rn||(Rn={})),function(t){t[t.FINISHED=0]="FINISHED",t[t.HEIGHT_FADE=1]="HEIGHT_FADE"}(tv||(tv={}));let aie=class{constructor(){this.anchorPointClouds=M(),this.cloudsHeight=1e5,this.radiusCurvatureCorrectionFactor=0,this.transform=Ie()}},Bg=class extends ws{constructor(e,r){super(e,"bool",di.Pass,(i,s,n)=>i.setUniform1b(e,r(s,n)))}},CWe=class extends ws{constructor(e,r){super(e,"samplerCube",di.Pass,(i,s,n)=>i.bindTexture(e,r(s,n)))}};function c1e(t){const e=t.fragment;e.uniforms.add([new Hi("rotationMatrixClouds",(r,i)=>i.cloudsFade.parallax.transform),new Hi("rotationMatrixCloudsCrossFade",(r,i)=>i.cloudsFade.parallaxNew.transform),new qt("anchorPosition",(r,i)=>i.cloudsFade.parallax.anchorPointClouds),new qt("anchorPositionCrossFade",(r,i)=>i.cloudsFade.parallaxNew.anchorPointClouds),new Pe("cloudsHeight",(r,i)=>i.cloudsFade.parallax.cloudsHeight),new Pe("radiusCurvatureCorrectionFactor",(r,i)=>i.cloudsFade.parallax.radiusCurvatureCorrectionFactor),new Pe("totalFadeInOut",(r,i)=>i.cloudsFade.fadeInOut.stage===Rn.FINISHED?i.cloudsFade.fadeInOutHeight.factor+1-i.cloudsFade.fadeIn.factor:i.cloudsFade.fadeInOutHeight.factor+1-i.cloudsFade.fadeInOut.factor),new Pe("crossFadeAnchorFactor",(r,i)=>ge(i.cloudsFade.crossFade.factor,0,1)),new CWe("cubeMap",(r,i)=>v(i.cloudsFade.data)&&v(i.cloudsFade.data.cubeMap)?i.cloudsFade.data.cubeMap.colorTexture:null),new Bg("crossFade",(r,i)=>i.cloudsFade.crossFade.enabled),new Bg("readChannelsRG",(r,i)=>i.cloudsFade.readChannels===Mw.RG),new Bg("fadeTextureChannels",(r,i)=>i.cloudsFade.renderingStage===Is.FADING_TEXTURE_CHANNELS)]),e.constants.add("planetRadius","float",wr.radius),e.code.add(w`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos)
{
float radiusClouds = planetRadius + cloudsHeight;
float B = 2.0 * dot(cameraPosition, dir);
float C = dot(cameraPosition, cameraPosition) - radiusClouds * radiusClouds;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
vec3 intersectionPont = cameraPosition + dir * pointIntDist;
intersectionPont =  intersectionPont - spherePos;
return intersectionPont;
}`),e.code.add(w`vec3 correctForPlanetCurvature(vec3 dir)
{
dir.z = dir.z*(1.-radiusCurvatureCorrectionFactor) + radiusCurvatureCorrectionFactor;
return dir;
}`),e.code.add(w`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec)
{
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),dy(e),vm(e),e.code.add(w`const float SUNSET_TRANSITION_FACTOR = 0.3;
const vec3 RIM_COLOR = vec3(0.28, 0.175, 0.035);
const float RIM_SCATTERING_FACTOR = 140.0;
const float BACKLIGHT_FACTOR = 0.2;
const float BACKLIGHT_SCATTERING_FACTOR = 10.0;
const float BACKLIGHT_TRANSITION_FACTOR = 0.3;
vec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds)
{
float upDotLight = dot(normalize(cameraPosition), normalize(mainLightDirection));
float dirDotLight = max(dot(normalize(-worldSpaceRay), normalize(mainLightDirection)), 0.0);
float sunsetTransition = clamp(pow(max(upDotLight, 0.0), SUNSET_TRANSITION_FACTOR), 0.0, 1.0);
vec3 ambientLight = calculateAmbientIrradiance(normalize(cameraPosition),  0.0);
vec3 mainLight = evaluateMainLighting(normalize(cameraPosition),  0.0);
vec3 combinedLight = clamp((mainLightIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));
float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
float rimLightIntensity = 0.5 + 0.5 *pow(max(upDotLight, 0.0), 0.35);
vec3 directSunScattering = RIM_COLOR * rimLightIntensity * (pow(dirDotLight, RIM_SCATTERING_FACTOR)) * scatteringMod;
float additionalLight = BACKLIGHT_FACTOR * pow(dirDotLight, BACKLIGHT_SCATTERING_FACTOR) * (1. - pow(sunsetTransition, BACKLIGHT_TRANSITION_FACTOR)) ;
return vec3(baseCloudColor * (1. + additionalLight) + directSunScattering);
}`),e.code.add(w`vec4 getCloudData(vec3 rayDir, bool readOtherChannel)
{
vec4 cloudData = textureCube(cubeMap, rayDir);
float mu = dot(rayDir, vec3(0, 0, 1));
bool readChannels = readChannelsRG ^^ readOtherChannel;
if (readChannels) {
cloudData = vec4(vec3(cloudData.r), cloudData.g);
} else {
cloudData = vec4(vec3(cloudData.b), cloudData.a);
}
if (length(cloudData) == 0.0) {
return vec4(cloudData.rgb, 1.0);
}
return cloudData;
}`),e.code.add(w`vec4 renderCloudsNoFade(vec3 worldRay, vec3 cameraPosition)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected, false);
float totalTransmittance = clamp(cloudData.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudData.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), totalTransmittance);
}`),e.code.add(w`vec4 renderCloudsCrossFade(vec3 worldRay, vec3 cameraPosition)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected, false);
vec4 cloudColor = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);
intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPositionCrossFade);
worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixCloudsCrossFade, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = getCloudData(worldRayRotatedCorrected, fadeTextureChannels);
vec4 cloudColorCrossFade = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorCrossFade, crossFadeAnchorFactor);
float totalTransmittance = clamp(cloudColor.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudColor.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(cloudColor.rgb, totalTransmittance);
}`),e.code.add(w`vec4 renderClouds(vec3 worldRay, vec3 cameraPosition)
{
return crossFade ? renderCloudsCrossFade(worldRay, cameraPosition) : renderCloudsNoFade(worldRay, cameraPosition);
}`)}function bm(t){t.code.add(w`vec4 premultiplyAlpha(vec4 v) {
return vec4(v.rgb * v.a, v.a);
}
vec3 rgb2hsv(vec3 c) {
vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
vec4 p = c.g < c.b ? vec4(c.bg, K.wz) : vec4(c.gb, K.xy);
vec4 q = c.r < p.x ? vec4(p.xyw, c.r) : vec4(c.r, p.yzx);
float d = q.x - min(q.w, q.y);
float e = 1.0e-10;
return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), min(d / (q.x + e), 1.0), q.x);
}
vec3 hsv2rgb(vec3 c) {
vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}
float rgb2v(vec3 c) {
return max(c.x, max(c.y, c.z));
}`)}function AWe(){const t=new Dr;t.attributes.add(A.POSITION,"vec2"),t.varyings.add("worldRay","vec3");const{vertex:e,fragment:r}=t;return e.uniforms.add([new Hi("inverseProjectionMatrix",(i,s)=>s.camera.inverseProjectionMatrix),new Hi("inverseViewMatrix",(i,s)=>CE(RWe,s.camera.viewMatrix))]),e.code.add(w`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0.0)).xyz;
gl_Position = vec4(position, 1.0, 1.0);
}`),r.include(bm),r.include(kc),t.include(cY,{pbrMode:dt.Disabled,lightingSphericalHarmonicsOrder:2}),t.include(EM),t.include(m5),t.include(ZN,{useLegacyTerrainShading:!1}),t.include(c1e,{instancedDoublePrecision:!1,useLegacyTerrainShading:!1}),r.uniforms.add([new qt("cameraPosition",(i,s)=>s.camera.eye)]),r.code.add(w`void main() {
vec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);
gl_FragColor = vec4((1.0 - totalFadeInOut) * cloudsColor.rgb, cloudsColor.a);
}`),t}const RWe=Ie(),OWe=Object.freeze(Object.defineProperty({__proto__:null,build:AWe},Symbol.toStringTag,{value:"Module"}));let u1e=class h1e extends Vr{constructor(e){super(e,new Ca,()=>this.destroy())}initializeProgram(e){return new Fr(e.rctx,h1e.shader.get().build(),Rr)}initializePipeline(){return Bt({blending:kn(Ee.ONE,Ee.ZERO,Ee.SRC_ALPHA,Ee.ONE),depthTest:{func:Mi.LEQUAL},colorWrite:Kt})}};u1e.shader=new Nr(OWe,()=>te(()=>import("./CloudsComposition.glsl-2d1e8ed2.js"),[]));let K1=class extends Te{constructor(e){super(e),this._technique=new u1e(e),this._vao=Aa(e.rctx)}destroy(){this._technique=Bi(this._technique),this._vao=Qe(this._vao)}render(e){const r=e.bindParameters.cloudsFade;if(C(this._vao)||C(r.data))return;if(!this._technique.compiled)return void this.requestRender();const i=e.rctx.bindTechnique(this._technique,MWe,e.bindParameters);e.rctx.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),e.rctx.drawArrays($t.TRIANGLE_STRIP,0,4)}};u([d({constructOnly:!0})],K1.prototype,"rctx",void 0),u([d({constructOnly:!0})],K1.prototype,"viewingMode",void 0),u([d({constructOnly:!0})],K1.prototype,"planetRadius",void 0),u([d({constructOnly:!0})],K1.prototype,"requestRender",void 0),K1=u([I("esri.views.3d.environment.CloudsComposition")],K1);const MWe=new pi;function Hh(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t}function PWe(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function hY(t,e,r,i,s,n,o,a,l,c){return t[0]=e,t[1]=r,t[2]=i,t[3]=s,t[4]=n,t[5]=o,t[6]=a,t[7]=l,t[8]=c,t}function dY(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function qh(t,e){if(t===e){const r=e[1],i=e[2],s=e[5];t[1]=e[3],t[2]=e[6],t[3]=r,t[5]=e[7],t[6]=i,t[7]=s}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t}function ex(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],p=h*o-a*c,f=-h*n+a*l,m=c*n-o*l;let y=r*p+i*f+s*m;return y?(y=1/y,t[0]=p*y,t[1]=(-h*i+s*c)*y,t[2]=(a*i-s*o)*y,t[3]=f*y,t[4]=(h*r-s*l)*y,t[5]=(-a*r+s*n)*y,t[6]=m*y,t[7]=(-c*r+i*l)*y,t[8]=(o*r-i*n)*y,t):null}function IWe(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8];return t[0]=o*h-a*c,t[1]=s*c-i*h,t[2]=i*a-s*o,t[3]=a*l-n*h,t[4]=r*h-s*l,t[5]=s*n-r*a,t[6]=n*c-o*l,t[7]=i*l-r*c,t[8]=r*o-i*n,t}function $We(t){const e=t[0],r=t[1],i=t[2],s=t[3],n=t[4],o=t[5],a=t[6],l=t[7],c=t[8];return e*(c*n-o*l)+r*(-c*s+o*a)+i*(l*s-n*a)}function KS(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],p=e[8],f=r[0],m=r[1],y=r[2],_=r[3],b=r[4],x=r[5],T=r[6],S=r[7],E=r[8];return t[0]=f*i+m*o+y*c,t[1]=f*s+m*a+y*h,t[2]=f*n+m*l+y*p,t[3]=_*i+b*o+x*c,t[4]=_*s+b*a+x*h,t[5]=_*n+b*l+x*p,t[6]=T*i+S*o+E*c,t[7]=T*s+S*a+E*h,t[8]=T*n+S*l+E*p,t}function eF(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],p=e[8],f=r[0],m=r[1];return t[0]=i,t[1]=s,t[2]=n,t[3]=o,t[4]=a,t[5]=l,t[6]=f*i+m*o+c,t[7]=f*s+m*a+h,t[8]=f*n+m*l+p,t}function pY(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],p=e[8],f=Math.sin(r),m=Math.cos(r);return t[0]=m*i+f*o,t[1]=m*s+f*a,t[2]=m*n+f*l,t[3]=m*o-f*i,t[4]=m*a-f*s,t[5]=m*l-f*n,t[6]=c,t[7]=h,t[8]=p,t}function fY(t,e,r){const i=r[0],s=r[1],n=r[2];return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=s*e[3],t[4]=s*e[4],t[5]=s*e[5],t[6]=n*e[6],t[7]=n*e[7],t[8]=n*e[8],t}function LWe(t,e,r){const i=r[0],s=r[1];return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=s*e[3],t[4]=s*e[4],t[5]=s*e[5],t}function DWe(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=e[0],t[7]=e[1],t[8]=1,t}function NWe(t,e){const r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=r,t[2]=0,t[3]=-r,t[4]=i,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function FWe(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=e[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function UWe(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t}function mY(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=r+r,a=i+i,l=s+s,c=r*o,h=i*o,p=i*a,f=s*o,m=s*a,y=s*l,_=n*o,b=n*a,x=n*l;return t[0]=1-p-y,t[3]=h-x,t[6]=f+b,t[1]=h+x,t[4]=1-c-y,t[7]=m-_,t[2]=f-b,t[5]=m+_,t[8]=1-c-p,t}function d1e(t,e){const r=e[0],i=e[1],s=e[2],n=e[4],o=e[5],a=e[6],l=e[8],c=e[9],h=e[10],p=h*o-a*c,f=-h*n+a*l,m=c*n-o*l,y=r*p+i*f+s*m;if(!y)return null;const _=1/y;return t[0]=p*_,t[1]=(-h*i+s*c)*_,t[2]=(a*i-s*o)*_,t[3]=f*_,t[4]=(h*r-s*l)*_,t[5]=(-a*r+s*n)*_,t[6]=m*_,t[7]=(-c*r+i*l)*_,t[8]=(o*r-i*n)*_,t}function QS(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],p=e[9],f=e[10],m=e[11],y=e[12],_=e[13],b=e[14],x=e[15],T=r*a-i*o,S=r*l-s*o,E=r*c-n*o,O=i*l-s*a,R=i*c-n*a,L=s*c-n*l,P=h*_-p*y,U=h*b-f*y,B=h*x-m*y,z=p*b-f*_,G=p*x-m*_,K=f*x-m*b;let ee=T*K-S*G+E*z+O*B-R*U+L*P;return ee?(ee=1/ee,t[0]=(a*K-l*G+c*z)*ee,t[1]=(l*B-o*K-c*U)*ee,t[2]=(o*G-a*B+c*P)*ee,t[3]=(s*G-i*K-n*z)*ee,t[4]=(r*K-s*B+n*U)*ee,t[5]=(i*B-r*G-n*P)*ee,t[6]=(_*L-b*R+x*O)*ee,t[7]=(b*E-y*L-x*S)*ee,t[8]=(y*R-_*E+x*T)*ee,t):null}function kWe(t,e,r){return t[0]=2/e,t[1]=0,t[2]=0,t[3]=0,t[4]=-2/r,t[5]=0,t[6]=-1,t[7]=1,t[8]=1,t}function VWe(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"}function BWe(t){return Math.sqrt(t[0]**2+t[1]**2+t[2]**2+t[3]**2+t[4]**2+t[5]**2+t[6]**2+t[7]**2+t[8]**2)}function zWe(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t[6]=e[6]+r[6],t[7]=e[7]+r[7],t[8]=e[8]+r[8],t}function p1e(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t[4]=e[4]-r[4],t[5]=e[5]-r[5],t[6]=e[6]-r[6],t[7]=e[7]-r[7],t[8]=e[8]-r[8],t}function GWe(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*r,t}function jWe(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t[4]=e[4]+r[4]*i,t[5]=e[5]+r[5]*i,t[6]=e[6]+r[6]*i,t[7]=e[7]+r[7]*i,t[8]=e[8]+r[8]*i,t}function HWe(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]}function qWe(t,e){const r=t[0],i=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8],p=e[0],f=e[1],m=e[2],y=e[3],_=e[4],b=e[5],x=e[6],T=e[7],S=e[8],E=Sa();return Math.abs(r-p)<=E*Math.max(1,Math.abs(r),Math.abs(p))&&Math.abs(i-f)<=E*Math.max(1,Math.abs(i),Math.abs(f))&&Math.abs(s-m)<=E*Math.max(1,Math.abs(s),Math.abs(m))&&Math.abs(n-y)<=E*Math.max(1,Math.abs(n),Math.abs(y))&&Math.abs(o-_)<=E*Math.max(1,Math.abs(o),Math.abs(_))&&Math.abs(a-b)<=E*Math.max(1,Math.abs(a),Math.abs(b))&&Math.abs(l-x)<=E*Math.max(1,Math.abs(l),Math.abs(x))&&Math.abs(c-T)<=E*Math.max(1,Math.abs(c),Math.abs(T))&&Math.abs(h-S)<=E*Math.max(1,Math.abs(h),Math.abs(S))}function gY(t){const e=Sa(),r=t[0],i=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8];return Math.abs(1-(r*r+n*n+l*l))<=e&&Math.abs(1-(i*i+o*o+c*c))<=e&&Math.abs(1-(s*s+a*a+h*h))<=e}const WWe=KS,XWe=p1e;Object.freeze(Object.defineProperty({__proto__:null,add:zWe,adjoint:IWe,copy:PWe,determinant:$We,equals:qWe,exactEquals:HWe,frob:BWe,fromMat2d:UWe,fromMat4:Hh,fromQuat:mY,fromRotation:NWe,fromScaling:FWe,fromTranslation:DWe,identity:dY,invert:ex,isOrthoNormal:gY,mul:WWe,multiply:KS,multiplyScalar:GWe,multiplyScalarAndAdd:jWe,normalFromMat4:QS,normalFromMat4Legacy:d1e,projection:kWe,rotate:pY,scale:fY,scaleByVec2:LWe,set:hY,str:VWe,sub:XWe,subtract:p1e,translate:eF,transpose:qh},Symbol.toStringTag,{value:"Module"}));var Vl;(function(t){t[t.SIXTEEN=0]="SIXTEEN",t[t.HUNDRED=1]="HUNDRED",t[t.TWOHUNDRED=2]="TWOHUNDRED",t[t.COUNT=3]="COUNT"})(Vl||(Vl={}));let tD=class extends Ca{constructor(){super(...arguments),this.steps=Vl.SIXTEEN,this.writeTextureChannels=Mw.RG}};u([V({count:Vl.COUNT})],tD.prototype,"steps",void 0),u([V({constValue:de("esri-mobile")?1024:2048})],tD.prototype,"cubeMapSize",void 0),u([V()],tD.prototype,"writeTextureChannels",void 0);let d3=class{constructor(e,r,i,s,n,o,a,l,c=.5){this.coverage=e,this.density=r,this.absorption=i,this.cloudSize=s,this.detailSize=n,this.smoothness=o,this.cloudHeight=a,this.raymarchingSteps=l,this.median=c}};const lie=new d3([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],Vl.SIXTEEN),na={sunny:lie,cloudy:new d3([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],Vl.TWOHUNDRED,.6),rainy:new d3([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],Vl.TWOHUNDRED,.4),snowy:new d3([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],Vl.HUNDRED,.65),foggy:new d3([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],Vl.SIXTEEN),default:lie},vh=de("esri-mobile")?64:128,YWe=vh/128,$d=Math.ceil(Math.sqrt(vh)),jd=(vh+2)*$d,ZWe=1e5,h8=128,JWe=jd/1560;function Jh(t,e=!0){t.attributes.add(A.POSITION,"vec2"),e&&t.varyings.add("uv","vec2"),t.vertex.code.add(w`
    void main(void) {
      gl_Position = vec4(position, 0.0, 1.0);
      ${e?w`uv = position * 0.5 + vec2(0.5);`:""}
    }
  `)}let dO=class extends ws{constructor(e,r){super(e,"mat3",di.Draw,(i,s,n)=>i.setUniformMatrix3fv(e,r(s,n)))}},f1e=class extends pi{constructor(){super(...arguments),this.cloudRadius=0,this.cloudSize=0,this.detailSize=0,this.absorption=0,this.density=0,this.smoothness=0,this.cloudHeight=0,this.coverage=0,this.raymarchingSteps=na.default.raymarchingSteps,this.weatherTile=Je()}},m1e=class extends pi{constructor(){super(...arguments),this.viewMatrix=es()}};function KWe(t){const e=new Dr;e.include(Jh,!1);const r=e.fragment;return r.uniforms.add([new Pe("cloudRadius",i=>i.cloudRadius),new Pe("power",i=>Ft(35,120,i.absorption)),new Pe("sigmaE",i=>1+i.absorption),new Pe("density",i=>Ft(0,.3,i.density)),new Pe("cloudSize",i=>Ft(0,.02,Math.max(.01,1-i.cloudSize))),new Pe("detailSize",i=>Ft(0,.2,Math.max(.01,1-i.detailSize))),new Pe("smoothness",i=>Ft(0,.5,1-i.smoothness)),new Pe("cloudHeight",i=>Ft(0,1500,i.cloudHeight)),new Pe("coverage",i=>i.coverage),new dO("view",i=>i.viewMatrix),new Mt("cloudShapeTexture",i=>v(i.noiseTexture)?i.noiseTexture.textureAtlas:null),new kr("cloudVariables",i=>or(QWe,i.coverage,i.absorption))]),r.constants.add("halfCubeMapSize","float",.5*t.cubeMapSize),r.code.add(w`
    const int STEPS = ${t.steps===Vl.SIXTEEN?w`16`:t.steps===Vl.HUNDRED?w`100`:w`200`};
    const int STEPS_LIGHT = 6;
    const float stepL = 300.0 / float(STEPS_LIGHT);
    const float cloudStart = 1500.0;

    vec3 rayDirection(vec2 fragCoord) {
      vec2 xy = fragCoord - halfCubeMapSize;
      return normalize(vec3(-xy, -halfCubeMapSize));
    }

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }`),r.code.add(w`
    float getCloudShape(vec3 pos, float pOffset) {
      const float textureWidth = ${w.float(jd)};
      const float dataWidth = ${w.float(jd)};
      const float tileRows = ${w.float($d)};
      const vec3 atlasDimensions = vec3(${w.float(vh)}, ${w.float(vh)}, tileRows * tileRows);

      //Change from Y being height to Z being height
      vec3 p = float(${w.float(YWe)}) * pos.xzy;

      //Pixel coordinates of point in the 3D data
      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));
      float f = fract(coord.z);
      float level = floor(coord.z);
      float tileY = floor(level / tileRows);
      float tileX = level - tileY * tileRows;

      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column
      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;
      vec2 pixel = coord.xy + offset;
      vec2 data = texture2D(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;

      return 1.0 - mix(data.x, data.y, f);
    }

    float getCloudMap(vec2 p){
      // Non-power-of-two textures can't be tiled using WebGL1
      // Get fractional part of uv to tile
      // Shift the texture center to origin to avoid seam artifacts
      vec2 uv = fract((${w.float(JWe)} * p) / ${w.float(jd)} + 0.5);

      return texture2D(cloudShapeTexture, uv).a;
    }
    `),r.code.add(w`float clouds(vec3 p) {
float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));
if (cloud <= 0.0) {
return 0.0;
}
float cloudMap = getCloudMap(cloudSize * p.xy);
cloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float shape = getCloudShape(8.0 * cloudSize * p, 0.0);
cloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);
cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);
if (cloud <= 0.0) {
return 0.0;
}
return density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));
}`),r.code.add(w`vec2 sphereIntersections(vec3 start, vec3 dir, float radius) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = dot(start, start) - (radius * radius);
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}
float HenyeyGreenstein(float g, float costh) {
return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));
}`),r.code.add(`
    float multipleOctaves(float extinction, float mu, float stepL) {
      float attenuation = 1.0;
      float contribution = 1.0;
      float phaseAttenuation = 1.0;
      float luminance = 0.0;

      for (int i = 0; i < 4; i++) {
        float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);
        luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);
        attenuation *= 0.2;
        contribution *= 0.6;
        phaseAttenuation *= 0.5;
      }

      return luminance;
    }`),r.code.add(w`float lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {
float lightRayDensity = clouds(p);
lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);
float beersLaw = multipleOctaves(lightRayDensity, mu, stepL);
return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);
}`),r.code.add(w`float mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {
if (dir.z < 0.0) {
return 0.0;
}
totalTransmittance = 1.0;
float stepS = totalDistance / float(STEPS);
float cameraHeight = length(org);
float mu = 0.5 + 0.5 * dot(sunDirection, dir);
float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);
vec3 p = org + distToStart  * dir;
float dist = distToStart;
float shading = 0.0;
for (int i = 0; i < STEPS; i++) {
float sampleDensity = clouds(p);
float sampleSigmaE = sampleDensity * sigmaE;
if (sampleDensity > 0.0 ) {
float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));
float luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));
float transmittance = exp(-sampleSigmaE * stepS);
shading += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;
totalTransmittance *= transmittance;
if (totalTransmittance <= 0.001) {
totalTransmittance = 0.0;
break;
}
}
dist += stepS;
p = org + dir * dist;
}
return shading;
}`),r.code.add(w`void main() {
if (coverage ==  0.0) {
gl_FragColor = vec4(0.0, 1.0, 0.0, 1.0);
return;
}
vec3 rayDir = rayDirection(gl_FragCoord.xy);
rayDir = normalize(view * rayDir);
vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);
bool hitsPlanet = rayDir.z < 0.0;
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(dot(rayDir, vec3(0, 0, 1))));
float totalTransmittance = 1.0;
float shading = 0.0;
if (hitsPlanet) {
shading = clamp(1.0 - cloudVariables.y, 0.6, 1.0) * (1.0 - hazeFactor);
totalTransmittance = hazeFactor;
gl_FragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);
return;
}
vec2 rayStartIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart);
vec2 rayEndIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart + cloudHeight);
float distToStart = rayStartIntersect.y;
float totalDistance = rayEndIntersect.y - distToStart;
vec3 sunDirection = normalize(vec3(0, 0, 1));
shading = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance);
shading = mix(clamp(1.0 - cloudVariables.y, 0.6, 1.0), shading, hazeFactor);
totalTransmittance = mix(0.0, totalTransmittance, hazeFactor);
gl_FragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);
}`),e}const QWe=Je(),eXe=Object.freeze(Object.defineProperty({__proto__:null,CloudsDrawParameters:m1e,CloudsPassParameters:f1e,build:KWe},Symbol.toStringTag,{value:"Module"}));let g1e=class y1e extends Vr{constructor(e,r){super(e,r,()=>this.destroy())}initializeProgram(e){return new Fr(e.rctx,y1e.shader.get().build(this.configuration),Rr)}initializePipeline(){return Bt({blending:Tp(Ee.CONSTANT_COLOR,Ee.ONE_MINUS_CONSTANT_COLOR,cm.ADD,this.configuration.writeTextureChannels===Mw.RG?[1,1,0,0]:[0,0,1,1]),depthTest:{func:Mi.LEQUAL},colorWrite:Kt})}};g1e.shader=new Nr(eXe,()=>te(()=>import("./Clouds.glsl-ecb332f5.js"),[]));var Tu;(function(t){t[t.Full=0]="Full",t[t.WeatherMap=1]="WeatherMap",t[t.COUNT=2]="COUNT"})(Tu||(Tu={}));let SG=class extends Ca{constructor(){super(...arguments),this.mode=Tu.Full}};u([V({count:Tu.COUNT})],SG.prototype,"mode",void 0);let _1e=class extends pi{constructor(){super(...arguments),this.weatherTile=Ur(0,0)}};function tXe(t){const e=new Dr;return e.include(Jh,!1),e.fragment.code.add(w`float remap(float x, float low1, float high1, float low2, float high2) {
return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
}`),t.mode===Tu.Full&&e.fragment.code.add(w`
    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }

    // Safer modulo for positive and negative values
    vec3 modulo(vec3 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec3 hash(vec3 p3, float frequency){
      p3 = modulo(p3, frequency);
      p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yxz + 33.33);
      return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);
    }

    // 5th order polynomial interpolation
    vec3 fade(vec3 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec3 p, float frequency){
      // Cell point is in
      vec3 i = floor(p);

      // Position in the cell in [0, 1]
      vec3 f = fract(p);

      // Interpolation value for gradient mixing
      vec3 u = fade(f);

      // Trilinear interpolation of gradients at cube vertices around point
      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),
                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),
                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),
                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),
                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),
                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );
    }

    float getPerlinNoise(vec3 pos, float frequency) {
      float octaveFrequencyFactor = 2.0;
      float sum = 0.0;
      float weightSum = 0.0;
      float weight = 1.0;

      for (int oct = 0; oct < 3; oct++) {
        vec3 p = pos * frequency;
        float val = 0.5 + 0.5 * gradientNoise(p, frequency);
        sum += val * weight;
        weightSum += weight;
        weight *= 0.5;
        frequency *= octaveFrequencyFactor;
      }

      float noise = (sum / weightSum);
      noise = saturate(noise);
      return noise;
    }

    float worley(vec3 pos, float numCells) {
      vec3 p = pos * numCells;
      float d = 1.0e10;

      for (int x = -1; x <= 1; x++) {
        for (int y = -1; y <= 1; y++) {
          for (int z = -1; z <= 1; z++) {
            vec3 tp = floor(p) + vec3(x, y, z);
            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);
            d = min(d, dot(tp, tp));
          }
        }
      }

      return 1.0 - clamp(d, 0.0, 1.0);
    }

    vec3 get3Dfrom2D(vec2 uv) {
      vec2 tile = floor(uv);
      float z = floor(${w.float($d)} * tile.y + tile.x);
      return vec3(fract(uv), z);
    }

    float getTextureForPointPerlinWorley(vec3 p) {
      float perlinNoise = getPerlinNoise(p, ${w.float(8)});

      float worley0 = worley(p, ${w.float(2)} * 2.0);
      float worley1 = worley(p, ${w.float(2)} * 8.0);
      float worley2 = worley(p, ${w.float(2)} * 14.0);

      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);
    }

    float getTextureForPointWorley(vec3 p) {
      float worley0 = worley(p, ${w.float(2)});
      float worley1 = worley(p, ${w.float(2)} * 2.0);
      float worley2 = worley(p, ${w.float(2)} * 4.0);
      float worley3 = worley(p, ${w.float(2)} * 8.0);

      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;
      float FBM2 = worley2 * 0.75 + worley3 * 0.25;

      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;
    }
  `),e.fragment.uniforms.add(new kr("weatherTile",r=>r.weatherTile)),e.fragment.code.add(w`
    vec2 modulo(vec2 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec2 hash(vec2 p){
      // Get position of p in weather tile
      p = modulo(p, ${w.float(h8)});

      // Get global coordinates of p
      p += weatherTile * ${w.float(h8)};

      // Limit position to avoid numerical instability
      p = modulo(p, ${w.float(ZWe)});

      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;
    }

    vec2 fade(vec2 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec2 p){
      vec2 i = floor( p );
      vec2 f = fract( p );

      vec2 u = fade(f);

      // Bilinear interpolation of gradients at cell vertices around point
      return  mix(
                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),
                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),
                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),
                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),
                u.y);
    }

    float worley(vec2 p){
      float d = 1.0e10;
      for (int x = -1; x <= 1; x++){
        for (int y = -1; y <= 1; y++){
                vec2 tp = floor(p) + vec2(x, y);
                tp = p - tp - (0.5 + 0.5 * hash(tp));
                d = min(d, dot(tp, tp));
            }
        }
      return 1.0 - clamp(d, 0.0, 1.0);
    }
  `),e.fragment.code.add(w`void main() {`),t.mode===Tu.Full&&e.fragment.code.add(w`
        float padWidth = 1.0;
        float paddedSize = ${w.float(vh)} + 2.0 * padWidth;
        float tileCount = ${w.float($d)} * ${w.float($d)};
        vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);

        bool padCell = false;
        if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {
          padCell = true;
        }

        if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {
          padCell = true;
        }

        bool startPadX = false;
        bool startPadY = false;
        bool endPadX = false;
        bool endPadY = false;

        if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {
          startPadX = true;
        }

        if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {
          startPadY = true;
        }

        if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {
          endPadX = true;
        }

        if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {
          endPadY = true;
        }

        vec2 padding = vec2(2.0 * padWidth) * tile;
        vec2 uv;

        if (padCell) {
          vec2 pixel = gl_FragCoord.xy - padWidth - padding;

          if (startPadX) {
            pixel.x += ${w.float(vh)};
          }

          if (startPadY) {
            pixel.y += ${w.float(vh)};
          }

          if (endPadX) {
            pixel.x -= ${w.float(vh)};
          }

          if (endPadY) {
            pixel.y -= ${w.float(vh)};
          }

          uv = vec2(pixel.xy / ${w.float(vh)});
        } else {
          vec2 pixel = gl_FragCoord.xy - padWidth - padding;
          uv = vec2(pixel.xy / ${w.float(vh)});
        }

        vec3 p_ = get3Dfrom2D(uv);
        vec3 p = p_;
        p.z /= (${w.float($d)} * ${w.float($d)});

        float worleyPerlinNoise = getTextureForPointPerlinWorley(p);
        float worleyNoise = getTextureForPointWorley(p);

        gl_FragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

        p_ = mod(p_ + 1.0, ${w.float($d)} * ${w.float($d)});
        p = p_;
        p.z /= (${w.float($d)} * ${w.float($d)});

        worleyPerlinNoise = getTextureForPointPerlinWorley(p);
        worleyNoise = getTextureForPointWorley(p);

        gl_FragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));
      `),e.fragment.code.add(w`
      vec2 mapUV = ${w.float(h8)} * (gl_FragCoord.xy / ${w.float(jd)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);

      ${t.mode===Tu.Full?w`gl_FragColor.ba = vec2(0.0, map);`:w`gl_FragColor = vec4(map);`};
    }
  `),e}const rXe=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:_1e,build:tXe},Symbol.toStringTag,{value:"Module"}));let EG=class v1e extends Vr{initializeProgram(e){return new Fr(e.rctx,v1e.shader.get().build(this.configuration),Rr)}initializePipeline(){return Bt({blending:this.configuration.mode===Tu.Full?Tp(Ee.ONE,Ee.ZERO):kn(Ee.ZERO,Ee.ONE,Ee.ONE,Ee.ZERO),depthTest:{func:Mi.ALWAYS},colorWrite:Kt})}};EG.shader=new Nr(rXe,()=>te(()=>import("./NoiseTextureAtlas.glsl-87db6080.js"),[]));let t2=class{constructor(e,r){this._context=e,this._desc=r,this.type="renderbuffer",this._context.instanceCounter.increment(Nn.Renderbuffer,this);const i=this._context.gl;this.glName=i.createRenderbuffer(),this._context.bindRenderbuffer(this);const{width:s,height:n,internalFormat:o,multisampled:a}=r;if(a){if(this._context.type!==vt.WEBGL2)throw new Error("Multisampled renderbuffers are not supported in WebGL1!");i.renderbufferStorageMultisample(i.RENDERBUFFER,this.samples,o,s,n)}else i.renderbufferStorage(i.RENDERBUFFER,o,s,n)}get descriptor(){return this._desc}get samples(){const e=this._desc.samples,r=this._context.parameters.maxSamples;return e?Math.min(e,r):r}resize(e,r){const i=this._desc;if(i.width===e&&i.height===r)return;i.width=e,i.height=r;const s=this._context.gl;this._context.bindRenderbuffer(this),i.multisampled?s.renderbufferStorageMultisample(s.RENDERBUFFER,this.samples,i.internalFormat,i.width,i.height):s.renderbufferStorage(s.RENDERBUFFER,i.internalFormat,i.width,i.height)}dispose(){this._context&&(this._context.gl.deleteRenderbuffer(this.glName),this._context.instanceCounter.decrement(Nn.Renderbuffer,this),this._context=sw(this._context))}},Ds=class r2{constructor(e,r,i=null,s=null){if(this._context=e,this._glName=null,this._depthAttachment=null,this._stencilAttachment=null,this._colorAttachments=new Map,this._depthStencilTexture=null,this._initialized=!1,this._desc={...r},e.instanceCounter.increment(Nn.FramebufferObject,this),v(i)){Array.isArray(i)||(i=[i]);for(let n=0;n<i.length;++n){const o=i[n],a=lu.COLOR_ATTACHMENT0+n;let l;uie(o)?(pg(o)?(l=o.descriptor,this._colorAttachments.set(a,o)):(l=o,this._colorAttachments.set(a,new ct(this._context,l))),HP(l,this._desc)):(cie(o)?(l=o.descriptor,this._colorAttachments.set(a,o)):(l=o,this._colorAttachments.set(a,new t2(this._context,l))),d8(l,this._desc)),this._validateColorAttachmentPoint(a)}}if(v(s)){let n,o;if(uie(s))this._context.capabilities.depthTexture||console.error("Setting the depth/stencil texture as an attachment requires WEBGL_depth_texture or WebGL2"),pg(s)?(o=s.descriptor,this._depthStencilTexture=s):(o=s,this._depthStencilTexture=new ct(this._context,o)),HP(o,this._desc);else{cie(s)?(o=s.descriptor,n=s):(o=s,n=new t2(this._context,o));const a=this._desc.depthStencilTarget??$r.DEPTH_STENCIL_RENDER_BUFFER;a===$r.STENCIL_RENDER_BUFFER?this._stencilAttachment=n:a===$r.DEPTH_RENDER_BUFFER||a===$r.DEPTH_STENCIL_RENDER_BUFFER?this._depthAttachment=n:console.error('If a Renderbuffer is provided, "depthStencilTarget" must be one of STENCIL_RENDER_BUFFER, DEPTH_RENDER_BUFFER or DEPTH_STENCIL_RENDER_BUFFER'),this._desc.depthStencilTarget=a,d8(o,this._desc)}}}dispose(){if(!this._desc)return;const e=this._context.getBoundFramebufferObject();this._disposeColorAttachments(),this._disposeDepthStencilAttachments(),this._glName&&(this._context.gl.deleteFramebuffer(this._glName),this._glName=null),this._context.bindFramebuffer(e),this._context.instanceCounter.decrement(Nn.FramebufferObject,this),this._desc=null}get glName(){return this._glName}get descriptor(){return this._desc}get colorTexture(){const e=this._colorAttachments.get(lu.COLOR_ATTACHMENT0);return e&&pg(e)?e:null}get colorAttachment(){return this._colorAttachments.get(lu.COLOR_ATTACHMENT0)}get depthStencilAttachment(){return this._depthStencilTexture||this._depthAttachment||this._stencilAttachment}get depthStencilTexture(){return this._depthStencilTexture}get width(){return this._desc.width??0}get height(){return this._desc.height??0}get gpuMemoryUsage(){return[...this._colorAttachments].reduce((e,[r,i])=>e+Ow(i),0)+Ow(this.depthStencilAttachment)}getColorTexture(e){const r=this._colorAttachments.get(e);return r&&pg(r)?r:null}attachColorTexture(e,r=lu.COLOR_ATTACHMENT0){e&&(this._validateColorAttachmentPoint(r),HP(e.descriptor,this._desc),this._disposeColorAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(e.glName,r)),this._colorAttachments.set(r,e))}detachColorTexture(e=lu.COLOR_ATTACHMENT0){const r=this._colorAttachments.get(e);if(pg(r)){const i=r;return this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,e)),this._colorAttachments.delete(e),i}}setColorTextureTarget(e,r=lu.COLOR_ATTACHMENT0){const i=this._colorAttachments.get(r);pg(i)&&this._framebufferTexture2D(i.glName,r,e)}attachDepthStencilTexture(e){if(C(e))return;const r=e.descriptor;r.pixelFormat!==Ve.DEPTH_STENCIL&&console.error("Depth/Stencil texture must have a pixel type of DEPTH_STENCIL!"),r.dataType!==Lt.UNSIGNED_INT_24_8&&console.error("Depth/Stencil texture must have data type of UNSIGNED_INT_24_8!"),this._context.capabilities.depthTexture||console.error("Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture!"),HP(r,this._desc),this._desc.depthStencilTarget&&this._desc.depthStencilTarget!==$r.DEPTH_STENCIL_TEXTURE&&(this._desc.depthStencilTarget=$r.DEPTH_STENCIL_TEXTURE),this._disposeDepthStencilAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(e.glName,Zre)),this._depthStencilTexture=e}detachDepthStencilTexture(){const e=this._depthStencilTexture;return e&&this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,Zre)),this._depthStencilTexture=null,e}attachDepthStencilBuffer(e){if(C(e))return;const r=e.descriptor;if(r.internalFormat!==Ha.DEPTH_STENCIL&&r.internalFormat!==Ha.DEPTH_COMPONENT16&&console.error("Depth/Stencil buffer must have correct internalFormat"),d8(r,this._desc),this._disposeDepthStencilAttachments(),this._desc.depthStencilTarget=r.internalFormat===Ha.DEPTH_STENCIL?$r.DEPTH_STENCIL_RENDER_BUFFER:$r.DEPTH_RENDER_BUFFER,this._initialized){this._context.bindFramebuffer(this);const i=this._context.gl,s=this._desc.depthStencilTarget===$r.DEPTH_RENDER_BUFFER?i.DEPTH_ATTACHMENT:i.DEPTH_STENCIL_ATTACHMENT;i.framebufferRenderbuffer(Zn.FRAMEBUFFER,s,i.RENDERBUFFER,e.glName)}this._depthAttachment=e}detachDepthStencilBuffer(){const e=this._context.gl,r=this._depthAttachment;if(r&&this._initialized){this._context.bindFramebuffer(this);const i=this._desc.depthStencilTarget===$r.DEPTH_RENDER_BUFFER?e.DEPTH_ATTACHMENT:e.DEPTH_STENCIL_ATTACHMENT;e.framebufferRenderbuffer(Zn.FRAMEBUFFER,i,e.RENDERBUFFER,null)}return this._depthAttachment=null,r}detachAll(){this._colorAttachments.forEach((e,r)=>this._detachColorAttachment(r)),this.detachDepthStencilBuffer(),this.detachDepthStencilTexture()}copyToTexture(e,r,i,s,n,o,a){(e<0||r<0||n<0||o<0)&&console.error("Offsets cannot be negative!"),(i<=0||s<=0)&&console.error("Copy width and height must be greater than zero!");const l=this._desc,c=a.descriptor;a.descriptor.target!==bt.TEXTURE_2D&&console.error("Texture target must be TEXTURE_2D!"),((l==null?void 0:l.width)==null||(l==null?void 0:l.height)==null||(c==null?void 0:c.width)==null||(c==null?void 0:c.height)==null||e+i>l.width||r+s>l.height||n+i>c.width||o+s>c.height)&&console.error("Bad dimensions, the current input values will attempt to read or copy out of bounds!");const h=this._context,p=h.bindTexture(a,ct.TEXTURE_UNIT_FOR_UPDATES);h.setActiveTexture(ct.TEXTURE_UNIT_FOR_UPDATES),h.bindFramebuffer(this),h.gl.copyTexSubImage2D(bt.TEXTURE_2D,0,n,o,e,r,i,s),h.bindTexture(p,ct.TEXTURE_UNIT_FOR_UPDATES)}readPixels(e,r,i,s,n,o,a){(i<=0||s<=0)&&console.error("Copy width and height must be greater than zero!"),a||console.error("Target memory is not initialized!"),this._context.bindFramebuffer(this),this._context.gl.readPixels(e,r,i,s,n,o,a)}async readPixelsAsync(e,r,i,s,n,o,a){if(this._context.type!==vt.WEBGL2)return du()&&console.warn("Attempting to read pixels using pixel buffer object without WebGL2"),void this.readPixels(e,r,i,s,n,o,a);const l=this._context.gl,c=jr.createPixelPack(this._context,Lr.STREAM_READ,a.byteLength);this._context.bindBuffer(c),this._context.bindFramebuffer(this),l.readPixels(e,r,i,s,n,o,0),this._context.unbindBuffer(Ot.PIXEL_PACK_BUFFER),await c.getSubDataAsync(a),c.dispose()}resize(e,r){const i=this._desc;if(i.width!==e||i.height!==r){if(i.width=e,i.height=r,!this._initialized)return this._colorAttachments.forEach(s=>{s&&s.resize(e,r)}),void(this._depthStencilTexture&&this._depthStencilTexture.resize(e,r));this._colorAttachments.forEach(s=>{s&&s.resize(e,r)}),this._depthStencilTexture!=null?this._depthStencilTexture.resize(e,r):(this._depthAttachment||this._stencilAttachment)&&(this._depthAttachment&&this._depthAttachment.resize(e,r),this._stencilAttachment&&this._stencilAttachment.resize(e,r)),this._context.getBoundFramebufferObject()===this&&this._context.bindFramebuffer(null),this._initialized=!1}}initializeAndBind(e=Zn.FRAMEBUFFER){const r=this._context.gl;if(this._initialized)return void r.bindFramebuffer(e,this.glName);this._glName&&r.deleteFramebuffer(this._glName);const i=this._context,s=r.createFramebuffer(),n=this._desc,o=n.colorTarget??ls.RENDER_BUFFER,a=n.width??1,l=n.height??1;if(r.bindFramebuffer(e,s),this._colorAttachments.size===0)if(o===ls.TEXTURE||o===ls.CUBEMAP)this._colorAttachments.set(lu.COLOR_ATTACHMENT0,iXe(i,n,this.descriptor.colorTarget===ls.CUBEMAP?bt.TEXTURE_CUBE_MAP:bt.TEXTURE_2D));else{const h=new t2(i,{internalFormat:St.RGBA4,width:a,height:l});this._colorAttachments.set(lu.COLOR_ATTACHMENT0,h)}this._colorAttachments.forEach((h,p)=>{h&&(pg(h)?this._framebufferTexture2D(h.glName,p,hie(h),e):r.framebufferRenderbuffer(e,p,r.RENDERBUFFER,h.glName))});const c=n.depthStencilTarget??$r.NONE;switch(c){case $r.DEPTH_RENDER_BUFFER:case $r.DEPTH_STENCIL_RENDER_BUFFER:{this._depthAttachment||(this._depthAttachment=new t2(i,{internalFormat:n.depthStencilTarget===$r.DEPTH_RENDER_BUFFER?Ha.DEPTH_COMPONENT16:Ha.DEPTH_STENCIL,width:a,height:l}));const h=c===$r.DEPTH_RENDER_BUFFER?r.DEPTH_ATTACHMENT:r.DEPTH_STENCIL_ATTACHMENT;r.framebufferRenderbuffer(e,h,r.RENDERBUFFER,this._depthAttachment.glName);break}case $r.STENCIL_RENDER_BUFFER:this._stencilAttachment||(this._stencilAttachment=new t2(i,{internalFormat:Ha.STENCIL_INDEX8,width:a,height:l})),r.framebufferRenderbuffer(e,r.STENCIL_ATTACHMENT,r.RENDERBUFFER,this._stencilAttachment.glName);break;case $r.DEPTH_STENCIL_TEXTURE:if(!this._depthStencilTexture){i.capabilities.depthTexture||console.error("Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture as an attachment!");const h={target:bt.TEXTURE_2D,pixelFormat:Ve.DEPTH_STENCIL,dataType:Lt.UNSIGNED_INT_24_8,samplingMode:tt.NEAREST,wrapMode:Rt.CLAMP_TO_EDGE,width:a,height:l};this._depthStencilTexture=new ct(i,h)}this._framebufferTexture2D(this._depthStencilTexture.glName,r.DEPTH_STENCIL_ATTACHMENT,hie(this._depthStencilTexture),e)}du()&&r.checkFramebufferStatus(e)!==r.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete!"),this._glName=s,this._initialized=!0}_framebufferTexture2D(e,r=lu.COLOR_ATTACHMENT0,i=bt.TEXTURE_2D,s=Zn.FRAMEBUFFER,n=0){this._context.gl.framebufferTexture2D(s,r,i,e,n)}_detachColorAttachment(e){du()&&console.warn("Detaching an FBO attachment can be a slow due to invalidating framebuffer completeness!");const r=this._context.gl,i=this._colorAttachments.get(e);return pg(i)?this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,e)):this._initialized&&(this._context.bindFramebuffer(this),r.framebufferRenderbuffer(Zn.FRAMEBUFFER,e,r.RENDERBUFFER,null)),this._colorAttachments.delete(e),i}_disposeColorAttachments(){this._colorAttachments.forEach((e,r)=>{this._detachColorAttachment(r),e.dispose()}),this._colorAttachments.clear()}_disposeDepthStencilAttachments(){const e=this._context.gl;if(this._depthAttachment){if(this._initialized){this._context.bindFramebuffer(this);const r=this._desc.depthStencilTarget===$r.DEPTH_RENDER_BUFFER?e.DEPTH_ATTACHMENT:e.DEPTH_STENCIL_ATTACHMENT;e.framebufferRenderbuffer(Zn.FRAMEBUFFER,r,e.RENDERBUFFER,null)}this._depthAttachment.dispose(),this._depthAttachment=null}this._stencilAttachment&&(this._initialized&&(this._context.bindFramebuffer(this),e.framebufferRenderbuffer(Zn.FRAMEBUFFER,e.STENCIL_ATTACHMENT,e.RENDERBUFFER,null)),this._stencilAttachment.dispose(),this._stencilAttachment=null),this._depthStencilTexture&&(this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,e.DEPTH_STENCIL_ATTACHMENT)),this._depthStencilTexture.dispose(),this._depthStencilTexture=null)}_validateColorAttachmentPoint(e){if(r2._MAX_COLOR_ATTACHMENTS===-1){const i=this._context.capabilities.drawBuffers;if(i){const s=this._context.gl;r2._MAX_COLOR_ATTACHMENTS=s.getParameter(i.MAX_COLOR_ATTACHMENTS)}else r2._MAX_COLOR_ATTACHMENTS=1}const r=e-lu.COLOR_ATTACHMENT0;r+1>r2._MAX_COLOR_ATTACHMENTS&&se.getLogger("esri.views.webgl.FrameBufferObject").error("esri.FrameBufferObject",`illegal attachment point for color attachment: ${r+1}. Implementation supports up to ${r2._MAX_COLOR_ATTACHMENTS} color attachments`)}};function pg(t){return t!=null&&"type"in t&&t.type==="texture"}function cie(t){return t!=null&&"type"in t&&t.type==="renderbuffer"}function uie(t){return pg(t)||t!=null&&"pixelFormat"in t}function iXe(t,e,r){return new ct(t,{target:r,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,wrapMode:Rt.CLAMP_TO_EDGE,width:e.width,height:e.height})}function HP(t,e){t.target!==bt.TEXTURE_2D&&t.target!==bt.TEXTURE_CUBE_MAP&&console.error("Texture type must be TEXTURE_2D or TEXTURE_CUBE_MAP!"),e.width!==void 0&&e.width>=0&&e.height!==void 0&&e.height>=0?e.width===t.width&&e.height===t.height||console.error("Color attachment texture must match the framebuffer's!"):(e.width=t.width,e.height=t.height)}function d8(t,e){e.width!==void 0&&e.width>=0&&e.height!==void 0&&e.height>=0?e.width===t.width&&e.height===t.height||console.error("Renderbuffer dimensions must match the framebuffer's!"):(e.width=t.width,e.height=t.height)}function hie(t){return t.descriptor.target===bt.TEXTURE_CUBE_MAP?bt.TEXTURE_CUBE_MAP_POSITIVE_X:bt.TEXTURE_2D}Ds._MAX_COLOR_ATTACHMENTS=-1;let p3=class extends Te{constructor(e){super(e),this._needsRender=!0,this._passParameters=new _1e,this._frameBuffer=new Ds(e.context.renderContext.rctx,{colorTarget:ls.TEXTURE,width:jd,height:jd},{target:bt.TEXTURE_2D,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Rt.CLAMP_TO_EDGE,samplingMode:tt.LINEAR,hasMipmap:!1,width:jd,height:jd}),this._vao=Aa(e.context.renderContext.rctx)}get _techniqueRepository(){return this.context.techniqueRepository}get textureAtlas(){return v(this._texture)?v(this._weatherMapTechnique)&&this._weatherMapTechnique.compiled&&this._needsRender&&(this._texture=this._render(Tu.WeatherMap)):v(this._fullTechnique)&&this._fullTechnique.compiled&&(this._texture=this._render(Tu.Full)),this._texture}_setDirty(){this._needsRender=!0}updateWeatherMap(e){this._passParameters.weatherTile[0]===e[0]&&this._passParameters.weatherTile[1]===e[1]||(Un(this._passParameters.weatherTile,e),this._setDirty())}destroy(){this._fullTechniqueCached=Bi(this._fullTechniqueCached),this._weatherMapTechniqueCached=Bi(this._weatherMapTechniqueCached),this._frameBuffer=Qe(this._frameBuffer),this._vao=Qe(this._vao)}get _fullTechnique(){if(C(this._fullTechniqueCached)){const e=new SG;e.mode=Tu.Full,this._fullTechniqueCached=this._techniqueRepository.acquire(EG,e)}return this._fullTechniqueCached}get _weatherMapTechnique(){if(C(this._weatherMapTechniqueCached)){const e=new SG;e.mode=Tu.WeatherMap,this._weatherMapTechniqueCached=this._techniqueRepository.acquire(EG,e)}return this._weatherMapTechniqueCached}_render(e){if(C(this._vao)||C(this._frameBuffer))return null;const r=e===Tu.Full?this._fullTechnique:this._weatherMapTechnique,i=this.context.renderContext.rctx,s=i.getViewport();i.setViewport(0,0,jd,jd),i.bindFramebuffer(this._frameBuffer);const n=i.bindTechnique(r,this._passParameters,null);return i.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),i.gl.drawArrays(i.gl.TRIANGLE_STRIP,0,4),i.setViewport(s.x,s.y,s.width,s.height),this._needsRender=!1,this._frameBuffer.colorTexture}};u([d({constructOnly:!0})],p3.prototype,"context",void 0),u([d({readOnly:!0})],p3.prototype,"_techniqueRepository",null),p3=u([I("esri.views.3d.environment.NoiseTextureAtlas")],p3);function b1e(t){t.include(Nu),t.uniforms.add([new Mt("geometryDepthTexture",(e,r)=>r.multipassGeometry.linearDepthTexture),new kr("nearFar",(e,r)=>r.camera.nearFar)]),t.code.add(w`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos, nearFar);
return (elementDepth < (geometryDepth - 1.0));
}`)}let sXe=class{constructor(){this.enabled=!1}};function Fu(t,e){e.hasMultipassTerrain&&(t.fragment.include(Nu),t.fragment.uniforms.add(new Mt("terrainDepthTexture",(r,i)=>i.multipassTerrain.linearDepthTexture)),t.fragment.uniforms.add(new kr("nearFar",(r,i)=>i.camera.nearFar)),t.fragment.uniforms.add(new kr("inverseViewport",(r,i)=>i.inverseViewport)),t.fragment.code.add(w`
    void terrainDepthTest(vec4 fragCoord, float fragmentDepth){
      float terrainDepth = linearDepthFromTexture(terrainDepthTexture, fragCoord.xy * inverseViewport, nearFar);
      if(fragmentDepth ${e.cullAboveGround?">":"<="} terrainDepth){
        discard;
      }
    }
  `))}let nXe=class{constructor(){this.enabled=!1,this.cullAboveGround=!1}};function oXe(t,e){const r=t.fragment;r.include(Nu),r.uniforms.add(new kr("nearFar",(i,s)=>s.camera.nearFar)),r.uniforms.add(new Mt("depthMap",(i,s)=>s.linearDepthTexture)),r.uniforms.add(new Hi("proj",(i,s)=>s.ssr.camera.projectionMatrix)),r.uniforms.add(new Pe("invResolutionHeight",(i,s)=>1/s.ssr.camera.height)),r.uniforms.add(new Hi("reprojectionMatrix",(i,s)=>s.ssr.reprojectionMatrix)),r.code.add(w`
  vec2 reprojectionCoordinate(vec3 projectionCoordinate)
  {
    vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
    vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
    reprojectedCoord.xy /= reprojectedCoord.w;
    return reprojectedCoord.xy * 0.5 + 0.5;
  }

  const int maxSteps = ${e.highStepCount?"150":"75"};

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMap, P, nearFar); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
        return vec3(P, depth);
      }

      // continue with ray marching
      P += dP;
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `)}let aXe=class{constructor(){this.enabled=!1,this.fadeFactor=1,this.reprojectionMatrix=Ie()}};function _5(t){return t?{ray:ro(t.ray),c0:t.c0,c1:t.c1}:{ray:ro(),c0:0,c1:Number.MAX_VALUE}}function lXe(t,e=_5()){return wN(t,e.ray),e.c0=0,e.c1=Number.MAX_VALUE,e}function cXe(t,e,r=_5()){const i=Me(t.vector);return tme(t.origin,e,r.ray),r.c0=0,r.c1=i,r}function ZCt(t,e){return w1e(t,t.c0,e)}function JCt(t,e){return w1e(t,t.c1,e)}function w1e(t,e,r){return fe(r,t.ray.origin,ae(r,t.ray.direction,e))}new cy(()=>_5());function pO(t){return t?[zr(t[0]),zr(t[1]),zr(t[2]),zr(t[3]),zr(t[4]),zr(t[5])]:[zr(),zr(),zr(),zr(),zr(),zr()]}function x1e(){return[M(),M(),M(),M(),M(),M(),M(),M()]}function tF(t,e){for(let r=0;r<rv.NUM;r++)V4(t[r],e[r])}function T1e(t,e,r,i=fXe){const s=gs(RW.get(),e,t);Oo(s,s);for(let n=0;n<CG.NUM;++n){const o=Su(AW.get(),pXe[n],s);ce(i[n],o[0]/o[3],o[1]/o[3],o[2]/o[3])}S1e(r,i)}function S1e(t,e){la(e[nt.FAR_BOTTOM_LEFT],e[nt.NEAR_BOTTOM_LEFT],e[nt.NEAR_TOP_LEFT],t[vi.LEFT]),la(e[nt.NEAR_BOTTOM_RIGHT],e[nt.FAR_BOTTOM_RIGHT],e[nt.FAR_TOP_RIGHT],t[vi.RIGHT]),la(e[nt.FAR_BOTTOM_LEFT],e[nt.FAR_BOTTOM_RIGHT],e[nt.NEAR_BOTTOM_RIGHT],t[vi.BOTTOM]),la(e[nt.NEAR_TOP_LEFT],e[nt.NEAR_TOP_RIGHT],e[nt.FAR_TOP_RIGHT],t[vi.TOP]),la(e[nt.NEAR_BOTTOM_LEFT],e[nt.NEAR_BOTTOM_RIGHT],e[nt.NEAR_TOP_RIGHT],t[vi.NEAR]),la(e[nt.FAR_BOTTOM_RIGHT],e[nt.FAR_BOTTOM_LEFT],e[nt.FAR_TOP_LEFT],t[vi.FAR])}function R_(t,e){for(let r=0;r<rv.NUM;r++){const i=t[r];if(i[0]*e[0]+i[1]*e[1]+i[2]*e[2]+i[3]>=e[3])return!1}return!0}function uXe(t,e){return C1e(t,lXe(e,A1e.get()))}function KCt(t,e){for(let r=0;r<rv.NUM;r++){const i=t[r];if(!hNe(i,e))return!1}return!0}function hXe(t,e,r){return C1e(t,cXe(e,r,A1e.get()))}function E1e(t,e){for(let r=0;r<rv.NUM;r++)if(bi(t[r],e)>0)return!1;return!0}function C1e(t,e){for(let r=0;r<rv.NUM;r++)if(!uNe(t[r],e))return!1;return!0}var vi,nt;(function(t){t[t.LEFT=0]="LEFT",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.TOP=3]="TOP",t[t.NEAR=4]="NEAR",t[t.FAR=5]="FAR"})(vi||(vi={})),function(t){t[t.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",t[t.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",t[t.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",t[t.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",t[t.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",t[t.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",t[t.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",t[t.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"}(nt||(nt={}));const dXe={bottom:[nt.FAR_BOTTOM_RIGHT,nt.NEAR_BOTTOM_RIGHT,nt.NEAR_BOTTOM_LEFT,nt.FAR_BOTTOM_LEFT],near:[nt.NEAR_BOTTOM_LEFT,nt.NEAR_BOTTOM_RIGHT,nt.NEAR_TOP_RIGHT,nt.NEAR_TOP_LEFT],far:[nt.FAR_BOTTOM_RIGHT,nt.FAR_BOTTOM_LEFT,nt.FAR_TOP_LEFT,nt.FAR_TOP_RIGHT],right:[nt.NEAR_BOTTOM_RIGHT,nt.FAR_BOTTOM_RIGHT,nt.FAR_TOP_RIGHT,nt.NEAR_TOP_RIGHT],left:[nt.FAR_BOTTOM_LEFT,nt.NEAR_BOTTOM_LEFT,nt.NEAR_TOP_LEFT,nt.FAR_TOP_LEFT],top:[nt.FAR_TOP_LEFT,nt.NEAR_TOP_LEFT,nt.NEAR_TOP_RIGHT,nt.FAR_TOP_RIGHT]};var rv,CG;(function(t){t[t.NUM=6]="NUM"})(rv||(rv={})),function(t){t[t.NUM=8]="NUM"}(CG||(CG={}));const pXe=[Ht(-1,-1,-1,1),Ht(1,-1,-1,1),Ht(1,1,-1,1),Ht(-1,1,-1,1),Ht(-1,-1,1,1),Ht(1,-1,1,1),Ht(1,1,1,1),Ht(-1,1,1,1)],A1e=new cy(_5),fXe=x1e();function mXe(t,e,r){return 2*Math.atan(Math.sqrt(e*e+r*r)*Math.tan(.5*t)/e)}function gXe(t,e,r){return 2*Math.atan(Math.sqrt(e*e+r*r)*Math.tan(.5*t)/r)}function yXe(t,e,r){return 2*Math.atan(e*Math.tan(.5*t)/Math.sqrt(e*e+r*r))}function _Xe(t,e,r){return 2*Math.atan(r*Math.tan(.5*t)/Math.sqrt(e*e+r*r))}var AG;let Ct=AG=class extends Te{constructor(t={}){super(t),this._center=M(),this._up=M(),this._viewUp=M(),this._viewForward=M(),this._viewRight=M(),this._ray=ro(),this._viewport=Ht(0,0,1,1),this._padding=Ht(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=Ur(1,1e3),this._viewDirty=!0,this._viewMatrix=Ie(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=Ie(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=Ie(),this._frustumDirty=!0,this._frustum=pO(),this._fullViewport=sr(),this._pixelRatio=1,this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(t){this._pixelRatio=t>0?t:1}get eye(){return this._ray.origin}set eye(t){this._compareAndSetView(t,this._ray.origin)}get center(){return this._center}set center(t){this._compareAndSetView(t,this._center,"_center")}get ray(){return me(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(t){this._compareAndSetView(t,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(t){Fn(this._viewMatrix,t),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),this._viewForward}get viewUp(){return this._ensureViewClean(),this._viewUp}get viewRight(){return this._ensureViewClean(),this._viewRight}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(t){this._nearFar[0]!==t&&(this._nearFar[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(t){this._nearFar[1]!==t&&(this._nearFar[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(t){this.x=t[0],this.y=t[1],this.width=t[2],this.height=t[3]}get screenViewport(){if(this.pixelRatio===1)return this._viewport;const t=_E(sr(),this._viewport,1/this.pixelRatio),e=this._get("screenViewport");return e&&Dq(t,e)?e:t}get x(){return this._viewport[0]}set x(t){t+=this._padding[lr.LEFT],this._viewport[0]!==t&&(this._viewport[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(t){t+=this._padding[lr.BOTTOM],this._viewport[1]!==t&&(this._viewport[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(t){this._viewport[2]!==t&&(this._viewport[2]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(t){this._viewport[3]!==t&&(this._viewport[3]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[lr.RIGHT]+this._padding[lr.LEFT]}set fullWidth(t){this.width=t-(this._padding[lr.RIGHT]+this._padding[lr.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[lr.TOP]+this._padding[lr.BOTTOM]}set fullHeight(t){this.height=t-(this._padding[lr.TOP]+this._padding[lr.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[lr.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[lr.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(t){j2(this._padding,t)||(this._viewport[0]+=t[lr.LEFT]-this._padding[lr.LEFT],this._viewport[1]+=t[lr.BOTTOM]-this._padding[lr.BOTTOM],this._viewport[2]-=t[lr.RIGHT]+t[lr.LEFT]-(this._padding[lr.RIGHT]+this._padding[lr.LEFT]),this._viewport[3]-=t[lr.TOP]+t[lr.BOTTOM]-(this._padding[lr.TOP]+this._padding[lr.BOTTOM]),Xd(this._padding,t),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&(gs(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){const t=this.width,e=this.height,r=this.near*Math.tan(this.fovY/2),i=r*this._aspect,s=ife(Ie(),-i*(1+2*this._padding[lr.LEFT]/t),i*(1+2*this._padding[lr.RIGHT]/t),-r*(1+2*this._padding[lr.BOTTOM]/e),r*(1+2*this._padding[lr.TOP]/e),this.near,this.far),n=this._get("projectionMatrix");return n&&mW(n,s)?n:s}get inverseProjectionMatrix(){return Oo(Ie(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||Ie()}get fov(){return this._fov}set fov(t){this._fov=t,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return yXe(this._fov,this.width,this.height)}set fovX(t){this._fov=mXe(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return _Xe(this._fov,this.width,this.height)}set fovY(t){this._fov=gXe(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return xi(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(Oo(this._viewInverseTransposeMatrix,this.viewMatrix),Dc(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(t){const e=2*t-1;return 2*this.near*this.far/(this.far+this.near-e*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation!=null&&this.relativeElevation>=0}copyFrom(t){le(this._ray.origin,t.eye),this.center=t.center,this.up=t.up,Xd(this._viewport,t.viewport),this.notifyChange("_viewport"),Xd(this._padding,t.padding),this.notifyChange("_padding"),Un(this._nearFar,t.nearFar),this.notifyChange("_nearFar"),this._fov=t.fov,this.relativeElevation=t.relativeElevation;const e=t;return this._viewDirty=e._viewDirty,this._viewDirty||(Fn(this._viewMatrix,t.viewMatrix),le(this._viewRight,t.viewRight),le(this._viewUp,t.viewUp),le(this._viewForward,t.viewForward)),this._viewProjectionDirty=!0,this._frustumDirty=e._frustumDirty,this._frustumDirty||(tF(this._frustum,t.frustum),this._frustumDirty=!1),e._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(Fn(this._viewInverseTransposeMatrix,t.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),Xd(this._fullViewport,t.fullViewport),this.pixelRatio=t.pixelRatio,this}copyViewFrom(t){this.eye=t.eye,this.center=t.center,this.up=t.up}clone(){return new AG().copyFrom(this)}equals(t){return Ya(this.eye,t.eye)&&Ya(this.center,t.center)&&Ya(this.up,t.up)&&j2(this._viewport,t.viewport)&&j2(this._padding,t.padding)&&$ve(this.nearFar,t.nearFar)&&this._fov===t.fov&&this.pixelRatio===t.pixelRatio&&this.relativeElevation===t.relativeElevation}almostEquals(t){if(Math.abs(t.fov-this._fov)>=.001||oN(t.padding,this._padding)>=.5||oN(this.screenViewport,t.screenViewport)>=.5)return!1;to(ea,t.eye,t.center),to(p8,this.eye,this.center);const e=ye(ea,p8),r=gV(ea),i=gV(p8),s=5e-4;return e*e>=(1-1e-10)*r*i&&Pq(t.eye,this.eye)<Math.max(r,i)*s*s}computeRenderPixelSizeAt(t){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(t))}computeRenderPixelSizeAtDist(t){return t*this.perRenderPixelRatio}computeScreenPixelSizeAt(t){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(t))}_viewDirectionDistance(t){return Math.abs(Y3(this.viewForward,me(ea,t,this.eye)))}computeScreenPixelSizeAtDist(t){return t*this.perScreenPixelRatio}computeDistanceFromRadius(t,e){return t/Math.tan(Math.min(this.fovX,this.fovY)/(2*(e||1)))}getScreenCenter(t=as()){return t[0]=(this.padding[lr.LEFT]+this.width/2)/this.pixelRatio,t[1]=(this.padding[lr.TOP]+this.height/2)/this.pixelRatio,t}getRenderCenter(t,e=.5,r=.5){return t[0]=this.padding[lr.LEFT]+this.width*e,t[1]=this.padding[lr.BOTTOM]+this.height*r,t[2]=.5,t}setGLViewport(t){const e=this.viewport,r=this.padding;t.setViewport(e[0]-r[3],e[1]-r[2],e[2]+r[1]+r[3],e[3]+r[0]+r[2])}applyProjection(t,e){t!==ar&&le(ar,t),ar[3]=1,Su(ar,ar,this.projectionMatrix);const r=Math.abs(ar[3]);ae(ar,ar,1/r);const i=this.fullViewport;e[0]=Ft(0,i[0]+i[2],.5+.5*ar[0]),e[1]=Ft(0,i[1]+i[3],.5+.5*ar[1]),e[2]=.5*(ar[2]+1),e[3]=r}unapplyProjection(t,e){const r=this.fullViewport;ar[0]=(t[0]/(r[0]+r[2])*2-1)*t[3],ar[1]=(t[1]/(r[1]+r[3])*2-1)*t[3],ar[2]=(2*t[2]-1)*t[3],ar[3]=t[3],this.inverseProjectionMatrix!=null&&(Su(ar,ar,this.inverseProjectionMatrix),e[0]=ar[0],e[1]=ar[1],e[2]=ar[2])}projectToScreen(t,e){return this.projectToRenderScreen(t,f8),this.renderToScreen(f8,e),e}projectToRenderScreen(t,e){if(ar[0]=t[0],ar[1]=t[1],ar[2]=t[2],ar[3]=1,Su(ar,ar,this.viewProjectionMatrix),ar[3]===0)return null;ae(ar,ar,1/Math.abs(ar[3]));const r=this.fullViewport;return"x"in e?(e.x=Ft(0,r[0]+r[2],.5+.5*ar[0]),e.y=Ft(0,r[1]+r[3],.5+.5*ar[1])):(e[0]=Ft(0,r[0]+r[2],.5+.5*ar[0]),e[1]=Ft(0,r[1]+r[3],.5+.5*ar[1]),e.length>2&&(e[2]=.5*(ar[2]+1))),e}unprojectFromScreen(t,e){return this.unprojectFromRenderScreen(this.screenToRender(t,f8),e)}unprojectFromRenderScreen(t,e){if(gs(qP,this.projectionMatrix,this.viewMatrix),!Oo(qP,qP))return null;const r=this.fullViewport;return ar[0]=2*(t[0]-r[0])/r[2]-1,ar[1]=2*(t[1]-r[1])/r[3]-1,ar[2]=2*t[2]-1,ar[3]=1,Su(ar,ar,qP),ar[3]===0?null:(e[0]=ar[0]/ar[3],e[1]=ar[1]/ar[3],e[2]=ar[2]/ar[3],e)}constrainWindowSize(t,e,r,i){const s=t*this.pixelRatio,n=e*this.pixelRatio,o=Math.max(s-r/2,0),a=Math.max(this.fullHeight-n-i/2,0),l=-Math.min(s-r/2,0),c=-Math.min(this.fullHeight-n-i/2,0);return[o,a,r-l- -Math.min(this.fullWidth-s-r/2,0),i-c- -Math.min(n-i/2,0)]}computeUp(t){t===Be.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(t,e){const r=t[0]*this.pixelRatio,i=this.fullHeight-t[1]*this.pixelRatio;return e[0]=r,e[1]=i,e}renderToScreen(t,e){const r=t[0]/this.pixelRatio,i=(this.fullHeight-t[1])/this.pixelRatio;e[0]=r,e[1]=i}_computeUpGlobal(){me(ea,this.center,this.eye);const t=Me(this.center);t<1?(ce(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs(ye(ea,this.center))>.9999*Me(ea)*t||(pt(this._up,ea,this.center),pt(this._up,this._up,ea),_e(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){ay(ea,this.eye,this.center),Math.abs(ea[2])<=.9999&&(ae(ea,ea,ea[2]),ce(this._up,-ea[0],-ea[1],1-ea[2]),_e(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(t,e,r=""){typeof t[0]=="number"&&isFinite(t[0])&&typeof t[1]=="number"&&isFinite(t[1])&&typeof t[2]=="number"&&isFinite(t[2])?Ya(t,e)||(le(e,t),this._markViewDirty(),r.length&&this.notifyChange(r)):se.getLogger("esri.views.3d.webgl-engine.lib.Camera").warn("Camera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(T1e(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(L4(this._viewMatrix,this.eye,this.center,this.up),ce(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),ce(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),ce(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};u([d()],Ct.prototype,"_center",void 0),u([d()],Ct.prototype,"_up",void 0),u([d()],Ct.prototype,"_viewport",void 0),u([d()],Ct.prototype,"_padding",void 0),u([d()],Ct.prototype,"_fov",void 0),u([d()],Ct.prototype,"_nearFar",void 0),u([d()],Ct.prototype,"_pixelRatio",void 0),u([d()],Ct.prototype,"pixelRatio",null),u([d()],Ct.prototype,"eye",null),u([d()],Ct.prototype,"center",null),u([d()],Ct.prototype,"up",null),u([d({readOnly:!0})],Ct.prototype,"nearFar",null),u([d()],Ct.prototype,"near",null),u([d()],Ct.prototype,"far",null),u([d()],Ct.prototype,"viewport",null),u([d({readOnly:!0})],Ct.prototype,"screenViewport",null),u([d()],Ct.prototype,"x",null),u([d()],Ct.prototype,"y",null),u([d()],Ct.prototype,"width",null),u([d()],Ct.prototype,"height",null),u([d()],Ct.prototype,"fullWidth",null),u([d()],Ct.prototype,"fullHeight",null),u([d({readOnly:!0})],Ct.prototype,"_aspect",null),u([d()],Ct.prototype,"padding",null),u([d({readOnly:!0})],Ct.prototype,"projectionMatrix",null),u([d({readOnly:!0})],Ct.prototype,"inverseProjectionMatrix",null),u([d()],Ct.prototype,"fov",null),u([d()],Ct.prototype,"fovX",null),u([d()],Ct.prototype,"fovY",null),Ct=AG=u([I("esri.views.3d.webgl-engine.lib.Camera")],Ct);const ar=sr(),qP=Ie(),ea=M(),p8=M(),f8=qo();var lr;(function(t){t[t.TOP=0]="TOP",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.LEFT=3]="LEFT"})(lr||(lr={}));var Se;(function(t){t[t.INTEGRATED_MESH=0]="INTEGRATED_MESH",t[t.OPAQUE_TERRAIN=1]="OPAQUE_TERRAIN",t[t.OPAQUE_MATERIAL=2]="OPAQUE_MATERIAL",t[t.TRANSPARENT_MATERIAL=3]="TRANSPARENT_MATERIAL",t[t.TRANSPARENT_TERRAIN=4]="TRANSPARENT_TERRAIN",t[t.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL=5]="TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL",t[t.OCCLUDED_TERRAIN=6]="OCCLUDED_TERRAIN",t[t.OCCLUDER_MATERIAL=7]="OCCLUDER_MATERIAL",t[t.TRANSPARENT_OCCLUDER_MATERIAL=8]="TRANSPARENT_OCCLUDER_MATERIAL",t[t.OCCLUSION_PIXELS=9]="OCCLUSION_PIXELS",t[t.POSTPROCESSING_ENVIRONMENT_OPAQUE=10]="POSTPROCESSING_ENVIRONMENT_OPAQUE",t[t.POSTPROCESSING_ENVIRONMENT_TRANSPARENT=11]="POSTPROCESSING_ENVIRONMENT_TRANSPARENT",t[t.LASERLINES=12]="LASERLINES",t[t.LASERLINES_CONTRAST_CONTROL=13]="LASERLINES_CONTRAST_CONTROL",t[t.HUD_MATERIAL=14]="HUD_MATERIAL",t[t.LABEL_MATERIAL=15]="LABEL_MATERIAL",t[t.LINE_CALLOUTS=16]="LINE_CALLOUTS",t[t.LINE_CALLOUTS_HUD_DEPTH=17]="LINE_CALLOUTS_HUD_DEPTH",t[t.DRAPED_MATERIAL=18]="DRAPED_MATERIAL",t[t.DRAPED_WATER=19]="DRAPED_WATER",t[t.VOXEL=20]="VOXEL",t[t.MAX_SLOTS=21]="MAX_SLOTS"})(Se||(Se={}));var xt;(function(t){t[t.Color=0]="Color",t[t.Alpha=1]="Alpha",t[t.FrontFace=2]="FrontFace",t[t.NONE=3]="NONE",t[t.COUNT=4]="COUNT"})(xt||(xt={}));let yY=class{constructor(e=M()){this.intensity=e}},R1e=class{constructor(e=M(),r=$e(.57735,.57735,.57735)){this.intensity=e,this.direction=r}},rF=class{constructor(e=M(),r=$e(.57735,.57735,.57735),i=!0,s=1,n=1){this.intensity=e,this.direction=r,this.castShadows=i,this.specularStrength=s,this.environmentStrength=n}},O1e=class{constructor(){this.r=[0],this.g=[0],this.b=[0]}};function vXe(t,e,r){(r=r||t).length=t.length;for(let i=0;i<t.length;i++)r[i]=t[i]*e[i];return r}function m8(t,e,r){(r=r||t).length=t.length;for(let i=0;i<t.length;i++)r[i]=t[i]*e;return r}function eS(t,e,r){(r=r||t).length=t.length;for(let i=0;i<t.length;i++)r[i]=t[i]+e[i];return r}function M1e(t){return(t+1)*(t+1)}function bXe(t){return ge(Math.floor(Math.sqrt(t)-1),0,2)}function P1e(t,e,r){const i=t[0],s=t[1],n=t[2],o=r||[];return o.length=M1e(e),e>=0&&(o[0]=.28209479177),e>=1&&(o[1]=.4886025119*i,o[2]=.4886025119*n,o[3]=.4886025119*s),e>=2&&(o[4]=1.09254843059*i*s,o[5]=1.09254843059*s*n,o[6]=.31539156525*(3*n*n-1),o[7]=1.09254843059*i*n,o[8]=.54627421529*(i*i-s*s)),o}function wXe(t,e){const r=M1e(t),i=e||{r:[],g:[],b:[]};i.r.length=i.g.length=i.b.length=r;for(let s=0;s<r;s++)i.r[s]=i.g[s]=i.b[s]=0;return i}function xXe(t,e){const r=bXe(e.r.length);for(const i of t)ga(RG,i.direction),P1e(RG,r,Mg),vXe(Mg,rD),m8(Mg,i.intensity[0],gx),eS(e.r,gx),m8(Mg,i.intensity[1],gx),eS(e.g,gx),m8(Mg,i.intensity[2],gx),eS(e.b,gx);return e}function TXe(t,e){P1e(RG,0,Mg);for(const r of t)e.r[0]+=Mg[0]*rD[0]*r.intensity[0]*4*Math.PI,e.g[0]+=Mg[0]*rD[0]*r.intensity[1]*4*Math.PI,e.b[0]+=Mg[0]*rD[0]*r.intensity[2]*4*Math.PI;return e}function SXe(t,e,r,i){wXe(e,i),ce(r.intensity,0,0,0);let s=!1;const n=EXe,o=CXe,a=AXe;n.length=0,o.length=0,a.length=0;for(const l of t)l instanceof rF&&!s?(le(r.direction,l.direction),le(r.intensity,l.intensity),r.specularStrength=l.specularStrength,r.environmentStrength=l.environmentStrength,r.castShadows=l.castShadows,s=!0):l instanceof rF||l instanceof R1e?n.push(l):l instanceof yY?o.push(l):l instanceof O1e&&a.push(l);xXe(n,i),TXe(o,i);for(const l of a)eS(i.r,l.r),eS(i.g,l.g),eS(i.b,l.b)}const EXe=[],CXe=[],AXe=[],Mg=[0],gx=[0],RG=M(),rD=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];let die=class{constructor(){this.color=M(),this.intensity=1}},RXe=class{constructor(){this.direction=M(),this.ambient=new die,this.diffuse=new die}};const I1e=.4;let g8=class{constructor(){this._shOrder=2,this._legacy=new RXe,this.globalFactor=.5,this.noonFactor=.5,this._sphericalHarmonics=new O1e,this._mainLight=new rF(M(),$e(1,0,0),!1)}get legacy(){return this._legacy}get sh(){return this._sphericalHarmonics}get mainLight(){return this._mainLight}set(e){SXe(e,this._shOrder,this._mainLight,this._sphericalHarmonics),le(this._legacy.direction,this._mainLight.direction);const r=1/Math.PI;this._legacy.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*r,this._legacy.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*r,this._legacy.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*r,ae(this._legacy.diffuse.color,this._mainLight.intensity,r),le(WP,this._legacy.diffuse.color),ae(WP,WP,I1e*this.globalFactor),fe(this._legacy.ambient.color,this._legacy.ambient.color,WP)}copyFrom(e){this._sphericalHarmonics.r=Array.from(e.sh.r),this._sphericalHarmonics.g=Array.from(e.sh.g),this._sphericalHarmonics.b=Array.from(e.sh.b),this._mainLight.direction=ms(e.mainLight.direction),this._mainLight.intensity=ms(e.mainLight.intensity),this._mainLight.castShadows=e.mainLight.castShadows,this._mainLight.specularStrength=e.mainLight.specularStrength,this._mainLight.environmentStrength=e.mainLight.environmentStrength,this.globalFactor=e.globalFactor,this.noonFactor=e.noonFactor}lerpLighting(e,r,i){if(Ys(this._mainLight.intensity,e.mainLight.intensity,r.mainLight.intensity,i),this._mainLight.environmentStrength=Ft(e.mainLight.environmentStrength,r.mainLight.environmentStrength,i),this._mainLight.specularStrength=Ft(e.mainLight.specularStrength,r.mainLight.specularStrength,i),le(this._mainLight.direction,r.mainLight.direction),this._mainLight.castShadows=r.mainLight.castShadows,this.globalFactor=Ft(e.globalFactor,r.globalFactor,i),this.noonFactor=Ft(e.noonFactor,r.noonFactor,i),e.sh.r.length===r.sh.r.length)for(let s=0;s<r.sh.r.length;s++)this._sphericalHarmonics.r[s]=Ft(e.sh.r[s],r.sh.r[s],i),this._sphericalHarmonics.g[s]=Ft(e.sh.g[s],r.sh.g[s],i),this._sphericalHarmonics.b[s]=Ft(e.sh.b[s],r.sh.b[s],i);else for(let s=0;s<r.sh.r.length;s++)this._sphericalHarmonics.r[s]=r.sh.r[s],this._sphericalHarmonics.g[s]=r.sh.g[s],this._sphericalHarmonics.b[s]=r.sh.b[s]}};const WP=M();let v5=class{constructor(e,r,i){this.shadowMap=e,this.ssaoHelper=r,this.slicePlane=i,this.slot=Se.OPAQUE_MATERIAL,this.hasOccludees=!1,this.enableFillLights=!0,this.transparencyPassType=xt.NONE,this._camera=new Ct,this._inverseViewport=Je(),this.oldLighting=new g8,this.newLighting=new g8,this._fadedLighting=new g8,this._lighting=this.newLighting,this.ssr=new aXe,this.multipassTerrain=new nXe,this.multipassGeometry=new sXe,this.overlays=[],this.cloudsFade=new EWe}get camera(){return this._camera}set camera(e){this._camera=this.ssr.camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}get weatherFading(){return this._lighting===this._fadedLighting}fadeLighting(e){const{oldLighting:r,newLighting:i}=this;e>=1?this._lighting=i:(this._fadedLighting.lerpLighting(r,i,e),this._lighting=this._fadedLighting)}},El=class extends Te{constructor(e){super(e),this._handles=new ei,this._techniques=new Array,this._techniqueConfiguration=new tD,this._bindParameters=new v5(null,null,null),this._passParameters=new f1e,this._drawParameters=new m1e,this._weatherTile=Je(),this._weatherTileCount=128,this._faceIndex=0,this._tileIndex=0,this.coverage=Ft(na.default.coverage[0],na.default.coverage[1],.5),this.density=Ft(na.default.density[0],na.default.density[1],.5),this.absorption=Ft(na.default.absorption[0],na.default.absorption[1],.5),this.cloudSize=Ft(na.default.cloudSize[0],na.default.cloudSize[1],.5),this.detailSize=Ft(na.default.detailSize[0],na.default.detailSize[1],.5),this.smoothness=Ft(na.default.smoothness[0],na.default.smoothness[1],.5),this.cloudHeight=Ft(na.default.cloudHeight[0],na.default.cloudHeight[1],.5),this.raymarchingSteps=na.default.raymarchingSteps,this._viewMatrix=Ie(),this._dirty=!1,this.running=!1}_getTechnique(e){const r=1-this.context.renderContext.bindParameters.cloudsFade.readChannels,i=r===Mw.RG?2*e:2*e+1;return this._techniques[i]||(this._techniqueConfiguration.writeTextureChannels=r,this._techniqueConfiguration.steps=e,this._techniques[i]=new g1e({rctx:this.context.renderContext.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration),this._techniques[i])}updateWeatherTile(){const e=this.view.camera.position.latitude,r=this.view.camera.position.longitude;if(e==null||r==null)return;or(this._weatherTile,(e+90)/180,(r+180)/360);const i=Math.floor(this._weatherTileCount*Math.abs(2*this._weatherTile[0]-1));this._weatherTile[0]=Math.floor(2*this._weatherTileCount*this._weatherTile[0]),this._weatherTile[1]=Math.floor(4*(this._weatherTileCount-i)*this._weatherTile[1]);let s=0,n=0;if(v(this.view.environment)&&this.view.environment.lighting.type!=="virtual"&&v(this.view.environment.lighting.date)){const o=new Date(this.view.environment.lighting.date);o.setUTCHours(this.view.environment.lighting.date.getUTCHours()+(this.view.environment.lighting.displayUTCOffset??0)),s=31*o.getUTCMonth()+o.getUTCDate(),n=o.getUTCFullYear()}this._weatherTile[0]=(this._weatherTile[0]+s)%(2*this._weatherTileCount),this._weatherTile[1]=(this._weatherTile[1]+n%100)%(4*this._weatherTileCount),Lve(this._passParameters.weatherTile,this._weatherTile)||this.setDirty()}initialize(){this._vao=Aa(this.context.renderContext.rctx);const e=Jr(this.view.spatialReference);this._passParameters.cloudRadius=.5*e.radius,this.setDirty(),this.updateWeatherTile(),this._handles.add([this.view.resourceController.scheduler.registerTask(_t.CLOUDS_GENERATOR,this),ie(()=>[this.coverage,this.density,this.absorption,this.cloudSize,this.detailSize,this.smoothness,this.cloudHeight,this.raymarchingSteps],()=>this.setDirty(),Vt)])}destroy(){this._handles.destroy(),this._techniques.forEach(e=>Bi(e)),this._frameBufferCube=Qe(this._frameBufferCube),this._techniques.length=0,this._vao=Qe(this._vao),this._passParameters.noiseTexture=ke(this._passParameters.noiseTexture)}get _tilesPerFace(){switch(this._techniqueConfiguration.steps){case Vl.SIXTEEN:return 1;case Vl.HUNDRED:return 4;case Vl.COUNT:case Vl.TWOHUNDRED:return 8}}_ensureNoiseTexture(){if(v(this._passParameters.noiseTexture))this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile);else{const e=this.context;this._passParameters.noiseTexture=new p3({context:e}),this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile)}return v(this._passParameters.noiseTexture.textureAtlas)}_ensureFrameBufferCube(e){if(C(this._frameBufferCube)){const r={target:bt.TEXTURE_CUBE_MAP,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Rt.CLAMP_TO_EDGE,samplingMode:tt.LINEAR,hasMipmap:!1,width:e,height:e};this._frameBufferCube=new Ds(this.context.renderContext.rctx,{colorTarget:ls.CUBEMAP,width:e,height:e},r)}return this._frameBufferCube}get cubeMap(){return this._frameBufferCube}destroyFrameBufferCube(){this._frameBufferCube=Qe(this._frameBufferCube)}applyPreset(e,r){const i=e.median,s=n=>{const o=Ft(n[0],n[1],i);return r<.5?Ft(n[0],o,2*r):Ft(o,n[1],2*(r-.5))};this.coverage=s(e.coverage),this.density=s(e.density),this.absorption=s(e.absorption),this.cloudSize=s(e.cloudSize),this.detailSize=s(e.detailSize),this.smoothness=s(e.smoothness),this.cloudHeight=s(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps}setDirty(){this._dirty=this.running=!0}runTask(e){if(C(this._vao))return this._dirty=this.running=!1,this.context.renderContext.bindParameters.cloudsFade.renderingStage=Is.FINISHED_RENDERING,void e.madeProgress();this._faceIndex===0&&this._tileIndex===0&&(this._passParameters.raymarchingSteps=this.raymarchingSteps,this.updateWeatherTile(),Un(this._passParameters.weatherTile,this._weatherTile));const r=this._getTechnique(this._passParameters.raymarchingSteps);if(!r.compiled||!this.context.renderContext.bindParameters.cloudsFade.isCameraPositionFinal||this.context.renderContext.bindParameters.cloudsFade.isFading||!this._ensureNoiseTexture())return Zo.YIELD;this._faceIndex===0&&this._tileIndex===0&&(this.context.renderContext.bindParameters.cloudsFade.renderingStage=Is.RENDERING,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._dirty=!1);const i=this.context.renderContext.rctx,s=i.bindTechnique(r,this._passParameters,this._bindParameters);i.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao);const n=i.getViewport(),o=r.configuration.cubeMapSize,a=o/this._tilesPerFace,l=this._tileIndex*a;i.setViewport(0,l,o,a);const c=this._ensureFrameBufferCube(o);i.bindFramebuffer(c);const h=OXe[this._faceIndex],p=MXe[this._faceIndex];nfe(this._viewMatrix,PXe,h,p),Hh(this._drawParameters.viewMatrix,this._viewMatrix);const f=bt.TEXTURE_CUBE_MAP_POSITIVE_X+this._faceIndex;return c.setColorTextureTarget(f),s.bindDraw(this._drawParameters,this._bindParameters,this._passParameters),i.gl.drawArrays(i.gl.TRIANGLE_STRIP,0,4),i.gl.flush(),i.setViewport(n.x,n.y,n.width,n.height),this.requestRender(),++this._tileIndex,this._faceIndex===4&&this._tileIndex===this._tilesPerFace?(this.running=this._dirty,this._faceIndex=0,this._tileIndex=0,this.context.renderContext.bindParameters.cloudsFade.renderingStage=Is.FINISHED_RENDERING):this._tileIndex===this._tilesPerFace&&(++this._faceIndex,this._tileIndex=0),e.madeProgress(),Zo.YIELD}};u([d({constructOnly:!0})],El.prototype,"context",void 0),u([d({constructOnly:!0})],El.prototype,"view",void 0),u([d({constructOnly:!0})],El.prototype,"requestRender",void 0),u([d()],El.prototype,"coverage",void 0),u([d()],El.prototype,"density",void 0),u([d()],El.prototype,"absorption",void 0),u([d()],El.prototype,"cloudSize",void 0),u([d()],El.prototype,"detailSize",void 0),u([d()],El.prototype,"smoothness",void 0),u([d()],El.prototype,"cloudHeight",void 0),u([d()],El.prototype,"raymarchingSteps",void 0),u([d()],El.prototype,"running",void 0),El=u([I("esri.views.3d.environment.CloudsGenerator")],El);const OXe=[Xr(1,0,0),Xr(-1,0,0),Xr(0,1,0),Xr(0,-1,0),Xr(0,0,1)],MXe=[Xr(0,1,0),Xr(0,1,0),Xr(0,0,-1),Xr(0,0,1),Xr(0,1,0)],PXe=nY();let _Y=class extends pi{constructor(){super(...arguments),this.fogColor=M(),this.hazeColor=M(),this.fogStrength=4e-6,this.hazeStrength=4e-6,this.atmosphereC=1,this.fogAmount=0,this.hazeAmount=0}};function IXe(t){const e=new Dr;e.attributes.add(A.POSITION,"vec2"),e.include(Zf,{textureCoordinateType:qs.Default}),e.varyings.add("worldRay","vec3"),e.varyings.add("eyeDir","vec3");const{vertex:r,fragment:i}=e;return r.uniforms.add([new Hi("inverseProjectionMatrix",(s,n)=>n.camera.inverseProjectionMatrix),new Hi("inverseViewMatrix",(s,n)=>CE($Xe,n.camera.viewMatrix))]),r.code.add(w`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),i.uniforms.add(new Pe("atmosphereC",s=>s.atmosphereC)),i.uniforms.add(new qt("cameraPosition",(s,n)=>n.camera.eye)),i.uniforms.add(new kr("nearFar",(s,n)=>n.camera.nearFar)),i.uniforms.add(new Mt("depthTex",s=>s.depthTexture)),i.uniforms.add(new Pe("fogStrength",s=>t.haze?s.hazeStrength:s.fogStrength)),i.uniforms.add(new Pe("fogAmount",s=>t.haze?s.hazeAmount:s.fogAmount)),i.uniforms.add(new qt("fogColor",s=>t.haze?s.hazeColor:s.fogColor)),e.include(m5),i.include(Nu),i.code.add(w`vec2 sphereIntersect(vec3 start, vec3 dir) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float d = (b * b) - 4.0 * a * atmosphereC;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),i.code.add(w`vec4 applyFog(float dist, vec3 rayDir){
if(dist == -1.0){
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPosition, rayDir);
dist = 0.055 * rayAtmosphereIntersect.y;
}
float fogAmount = fogAmount * (1.0 - exp(-dist * fogStrength));
return vec4(fogAmount * fogColor, fogAmount);
}`),i.code.add(w`
    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;

      float depthSample = texture2D(depthTex, vuv0).r;
      float zNorm = 2.0 * depthSample - 1.0;
      float linDepth = 2.0 * nearFar[0] * nearFar[1] / (nearFar[1] + nearFar[0] - zNorm * (nearFar[1] - nearFar[0]));
      if(depthSample < 1.0 && depthSample > 0.0){
        vec3 cameraSpaceRay = normalize(eyeDir);
        cameraSpaceRay /= cameraSpaceRay.z;
        cameraSpaceRay *= linDepth;
        terrainDepth = max(0.0, length(cameraSpaceRay));
      }

      ${t.haze?w`
          if(terrainDepth == -1.0){
            gl_FragColor = vec4(0);
            return;
          }`:""}

      vec4 fog = applyFog(terrainDepth, rayDir);

      gl_FragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));
    }
  `),e}const $Xe=Ie(),$1e=Object.freeze(Object.defineProperty({__proto__:null,FogHazePassParameters:_Y,build:IXe},Symbol.toStringTag,{value:"Module"}));let L1e=class D1e extends Vr{initializeProgram(e){return new Fr(e.rctx,D1e.shader.get().build(this.configuration),Rr)}initializePipeline(){return this.configuration.haze?Bt({blending:kn(Ee.ONE,Ee.ZERO,Ee.ONE_MINUS_SRC_COLOR,Ee.ONE),colorWrite:Kt}):Bt({blending:kn(Ee.SRC_ALPHA,Ee.ZERO,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE),colorWrite:Kt})}};L1e.shader=new Nr($1e,()=>te(()=>import("./FogHaze.glsl-96a47659.js"),[]));let vY=class extends Ca{constructor(){super(...arguments),this.haze=!1}};u([V()],vY.prototype,"haze",void 0);const LXe=.95,DXe=1;let f3=class extends Te{constructor(e){super(e),this._passParameters=new _Y;const r=e.context.renderContext.rctx;this._vao=Aa(r,kE),this._technique=e.context.techniqueRepository.acquire(L1e,new vY);const i=Jr(e.view.spatialReference);this._planetRadius=i.radius,this._atmosphereRadius=i.radius+uO}destroy(){this._technique.release(),this._vao.dispose()}set strength(e){this._passParameters.fogStrength=e}get strength(){return this._passParameters.fogStrength}render(e,r){if(this._update(e,r),this._passParameters.fogAmount<=0)return;const i=this._technique;if(!i.compiled)return void this.context.requestRender();const s=e.offscreenRenderingHelper;s.renderDepthDetached(()=>{this._passParameters.depthTexture=s.depthTexture;const n=e.rctx.bindTechnique(i,this._passParameters,e.bindParameters);this._renderFog(n,e)})}_renderFog(e,r){const i=r.rctx;i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays($t.TRIANGLE_STRIP,0,4)}_update(e,r){const i=e.bindParameters.camera;_e(pie,i.eye);const s=Math.max(0,ye(pie,e.bindParameters.lighting.mainLight.direction)),n=r.color;ae(fie,n,.1),Ys(this._passParameters.fogColor,fie,n,s);const o=Me(i.eye),a=o*o;this._passParameters.atmosphereC=a-this._atmosphereRadius*this._atmosphereRadius,this._passParameters.fogAmount=(1-CS(LXe*_h,DXe*_h,Math.abs(o-this._planetRadius)))*r.amount,this._passParameters.fogStrength=r.strength}static isSupported(e){return e.capabilities.depthTexture}};u([d({constructOnly:!0})],f3.prototype,"context",void 0),u([d({constructOnly:!0})],f3.prototype,"view",void 0),f3=u([I("esri.views.3d.environment.Fog")],f3);let NXe=class{constructor(){this.color=M(),this.strength=0,this.amount=0}};const pie=M(),fie=M();let eo=class extends Ca{constructor(){super(...arguments),this.hasWebGL2Context=!1}};u([V({constValue:!0})],eo.prototype,"hasSliceHighlight",void 0),u([V({constValue:!1})],eo.prototype,"hasSliceInVertexProgram",void 0),u([V({constValue:!1})],eo.prototype,"instancedDoublePrecision",void 0),u([V({constValue:!1})],eo.prototype,"useLegacyTerrainShading",void 0),u([V({constValue:!1})],eo.prototype,"hasModelTransformation",void 0),u([V({constValue:di.Pass})],eo.prototype,"pbrTextureBindType",void 0),u([V()],eo.prototype,"hasWebGL2Context",void 0);var um;(function(t){t[t.Cone=0]="Cone",t[t.Cylinder=1]="Cylinder",t[t.Underground=2]="Underground",t[t.COUNT=3]="COUNT"})(um||(um={}));let bY=class extends eo{constructor(){super(...arguments),this.geometry=um.Cone}};u([V({count:um.COUNT})],bY.prototype,"geometry",void 0);var k;(function(t){t[t.Color=0]="Color",t[t.Depth=1]="Depth",t[t.Normal=2]="Normal",t[t.Shadow=3]="Shadow",t[t.ShadowHighlight=4]="ShadowHighlight",t[t.ShadowExcludeHighlight=5]="ShadowExcludeHighlight",t[t.Highlight=6]="Highlight",t[t.Alpha=7]="Alpha",t[t.ObjectAndLayerIdColor=8]="ObjectAndLayerIdColor",t[t.COUNT=9]="COUNT"})(k||(k={}));function CM(t){t.attributes.add(A.POSITION,"vec3"),t.vertex.code.add(w`vec3 positionModel() { return position; }`)}function iF({code:t},e){e.doublePrecisionRequiresObfuscation?t.add(w`vec3 dpPlusFrc(vec3 a, vec3 b) {
return mix(a, a + b, vec3(notEqual(b, vec3(0))));
}
vec3 dpMinusFrc(vec3 a, vec3 b) {
return mix(vec3(0), a - b, vec3(notEqual(a, b)));
}
vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
vec3 t1 = dpPlusFrc(hiA, hiB);
vec3 e = dpMinusFrc(t1, hiA);
vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;
return t1 + t2;
}`):t.add(w`vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
vec3 t1 = hiA + hiB;
vec3 e = t1 - hiA;
vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;
return t1 + t2;
}`)}let wm=class extends ws{constructor(e,r){super(e,"mat3",di.Pass,(i,s,n)=>i.setUniformMatrix3fv(e,r(s,n)))}};function tS(t,e){t.include(CM);const r=t.vertex;r.include(iF,e),t.varyings.add("vPositionWorldCameraRelative","vec3"),t.varyings.add("vPosition_view","vec3"),r.uniforms.add([new qt("transformWorldFromViewTH",i=>i.transformWorldFromViewTH),new qt("transformWorldFromViewTL",i=>i.transformWorldFromViewTL),new wm("transformViewFromCameraRelativeRS",i=>i.transformViewFromCameraRelativeRS),new Hi("transformProjFromView",i=>i.transformProjFromView),new dO("transformWorldFromModelRS",i=>i.transformWorldFromModelRS),new Pu("transformWorldFromModelTH",i=>i.transformWorldFromModelTH),new Pu("transformWorldFromModelTL",i=>i.transformWorldFromModelTL)]),r.code.add(w`vec3 positionWorldCameraRelative() {
vec3 rotatedModelPosition = transformWorldFromModelRS * positionModel();
vec3 transform_CameraRelativeFromModel = dpAdd(
transformWorldFromModelTL,
transformWorldFromModelTH,
-transformWorldFromViewTL,
-transformWorldFromViewTH
);
return transform_CameraRelativeFromModel + rotatedModelPosition;
}`),r.code.add(w`
    void forwardPosition(float fOffset) {
      vPositionWorldCameraRelative = positionWorldCameraRelative();
      if (fOffset != 0.0) {
        vPositionWorldCameraRelative += fOffset * ${e.spherical?w`normalize(transformWorldFromViewTL + vPositionWorldCameraRelative)`:w`vec3(0.0, 0.0, 1.0)`};
      }

      vPosition_view = transformViewFromCameraRelativeRS * vPositionWorldCameraRelative;
      gl_Position = transformProjFromView * vec4(vPosition_view, 1.0);
    }
  `),t.fragment.uniforms.add(new qt("transformWorldFromViewTL",i=>i.transformWorldFromViewTL)),r.code.add(w`vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`),t.fragment.code.add(w`vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`)}let N1e=class extends pi{constructor(){super(...arguments),this.transformWorldFromViewTH=M(),this.transformWorldFromViewTL=M(),this.transformViewFromCameraRelativeRS=es(),this.transformProjFromView=Ie()}},F1e=class extends pi{constructor(){super(...arguments),this.transformWorldFromModelRS=es(),this.transformWorldFromModelTH=Vi(),this.transformWorldFromModelTL=Vi()}};function iv(t){t.varyings.add("linearDepth","float")}function Pw(t){t.vertex.uniforms.add(new kr("nearFar",(e,r)=>r.camera.nearFar))}function b5(t){t.vertex.code.add(w`float calculateLinearDepth(vec2 nearFar,float z) {
return (-z - nearFar[0]) / (nearFar[1] - nearFar[0]);
}`)}function VE(t,e){const{vertex:r}=t;switch(e.output){case k.Color:if(e.receiveShadows)return iv(t),void r.code.add(w`void forwardLinearDepth() { linearDepth = gl_Position.w; }`);break;case k.Depth:case k.Shadow:case k.ShadowHighlight:case k.ShadowExcludeHighlight:return t.include(tS,e),iv(t),Pw(t),b5(t),void r.code.add(w`void forwardLinearDepth() {
linearDepth = calculateLinearDepth(nearFar, vPosition_view.z);
}`)}r.code.add(w`void forwardLinearDepth() {}`)}function Bl(t,e){if(b5(t),e.hasModelTransformation)return t.vertex.code.add(w`vec4 transformPositionWithDepth(mat4 proj, mat4 view, mat4 model, vec3 pos, vec2 nearFar, out float depth) {
vec4 eye = view * (model * vec4(pos, 1.0));
depth = calculateLinearDepth(nearFar, eye.z);
return proj * eye;
}`),void t.vertex.code.add(w`vec4 transformPosition(mat4 proj, mat4 view, mat4 model, vec3 pos) {
return proj * (view * (model * vec4(pos, 1.0)));
}`);t.vertex.code.add(w`vec4 transformPositionWithDepth(mat4 proj, mat4 view, vec3 pos, vec2 nearFar, out float depth) {
vec4 eye = view * vec4(pos, 1.0);
depth = calculateLinearDepth(nearFar,eye.z);
return proj * eye;
}`),t.vertex.code.add(w`vec4 transformPosition(mat4 proj, mat4 view, vec3 pos) {
return proj * (view * vec4(pos, 1.0));
}`)}let wY=class extends pi{constructor(){super(...arguments),this.texV=Je(),this.altitudeFade=0,this.innerScale=0,this.undergroundFadeAlpha=0,this.silhouette=new U1e}},U1e=class{constructor(){this.center=M(),this.v1=M(),this.v2=M()}};function FXe(t){const e=new Dr,{vertex:r,fragment:i}=e;if(dy(r),t.geometry===um.Underground)e.attributes.add(A.POSITION,"vec2"),e.varyings.add("color","vec4"),r.uniforms.add([new qt("cameraPosition",(s,n)=>n.camera.eye),new Pe("undergroundFadeAlpha",s=>s.undergroundFadeAlpha)]),r.code.add(w`void main(void) {
float ndotl = dot(normalize(cameraPosition), mainLightDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);
}`),i.code.add(w`void main() {
gl_FragColor = color;
}`);else{e.include(Bl,t),e.attributes.add(A.POSITION,"vec3"),e.varyings.add("vtc","vec2"),e.varyings.add("falloff","float");const s=t.geometry===um.Cylinder;r.uniforms.add([new Hi("proj",(a,l)=>l.camera.projectionMatrix),new Hi("view",(a,l)=>l.camera.viewMatrix)]),s||(e.varyings.add("innerFactor","float"),r.uniforms.add(new qt("silCircleCenter",a=>a.silhouette.center)),r.uniforms.add(new qt("silCircleV1",a=>a.silhouette.v1)),r.uniforms.add(new qt("silCircleV2",a=>a.silhouette.v2)),r.uniforms.add(new kr("texV",a=>a.texV)),r.uniforms.add(new Pe("innerScale",a=>a.innerScale)));const n=6.2831853,o=1/128;r.code.add(w`
		void main(void) {
      ${s?w`
      vec3 pos = position;
      float ndotl = mainLightDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:w`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${w.float(n*o)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), mainLightDirection);
      vtc.x = position.x  * ${w.float(o)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
    }
	  `),i.uniforms.add(new Mt("tex",a=>a.texture)),s||i.uniforms.add(new Pe("altitudeFade",a=>a.altitudeFade)),i.code.add(w`
		void main() {
			vec4 atmosphereColor = texture2D(tex, vtc) * falloff;
      ${s?w`gl_FragColor = atmosphereColor;`:w`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			gl_FragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));
      `}
    }`)}return e}const UXe=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:U1e,SimpleAtmospherePassParameters:wY,build:FXe},Symbol.toStringTag,{value:"Module"}));let sF=class k1e extends Vr{initializeProgram(e){return new Fr(e.rctx,k1e.shader.get().build(this.configuration),Rr)}initializePipeline(){return this.configuration.geometry===um.Cylinder?Bt({blending:kn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),culling:tY,depthTest:{func:Mi.LEQUAL},colorWrite:Kt}):Bt({blending:kn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),depthTest:{func:Mi.LEQUAL},colorWrite:Kt})}};sF.shader=new Nr(UXe,()=>te(()=>import("./SimpleAtmosphere.glsl-39b4ea8d.js"),[]));const V1e=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]);function Vc(t,e=0){const r=t.stride;return t.fieldNames.filter(i=>{const s=t.fields.get(i).optional;return!(s&&s.glPadding)}).map(i=>{const s=t.fields.get(i),n=s.constructor.ElementCount,o=kXe(s.constructor.ElementType),a=s.offset,l=!(!s.optional||!s.optional.glNormalized);return new Mo(i,n,o,a,r,l,e)})}function kXe(t){const e=VXe[t];if(e)return e;throw new Error("BufferType not supported in WebGL")}const VXe={u8:lt.UNSIGNED_BYTE,u16:lt.UNSIGNED_SHORT,u32:lt.UNSIGNED_INT,i8:lt.BYTE,i16:lt.SHORT,i32:lt.INT,f32:lt.FLOAT};let xY=class{constructor(e,r,i=0,s,n){this.TypedArrayConstructor=e,this.elementCount=9;const o=this.TypedArrayConstructor;s===void 0&&(s=9*o.BYTES_PER_ELEMENT);const a=r.byteLength===0?0:i;this.typedBuffer=n==null?new o(r,a):new o(r,a,(n-i)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,r,i=this.count-r){const s=this.typedBuffer.byteOffset+r*this.stride;return new e(this.buffer,s,this.stride,s+i*this.stride)}getMat(e,r){let i=e*this.typedBufferStride;for(let s=0;s<9;s++)r[s]=this.typedBuffer[i++];return r}setMat(e,r){let i=e*this.typedBufferStride;for(let s=0;s<9;s++)this.typedBuffer[i++]=r[s]}get(e,r){return this.typedBuffer[e*this.typedBufferStride+r]}set(e,r,i){this.typedBuffer[e*this.typedBufferStride+r]=i}copyFrom(e,r,i){const s=this.typedBuffer,n=r.typedBuffer;let o=e*this.typedBufferStride,a=i*r.typedBufferStride;for(let l=0;l<9;++l)s[o++]=n[a++]}get buffer(){return this.typedBuffer.buffer}};xY.ElementCount=9;let TY=class{constructor(e,r,i=0,s,n){this.TypedArrayConstructor=e,this.elementCount=16;const o=this.TypedArrayConstructor;s===void 0&&(s=16*o.BYTES_PER_ELEMENT);const a=r.byteLength===0?0:i;this.typedBuffer=n==null?new o(r,a):new o(r,a,(n-i)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,r,i=this.count-r){const s=this.typedBuffer.byteOffset+r*this.stride;return new e(this.buffer,s,this.stride,s+i*this.stride)}getMat(e,r){let i=e*this.typedBufferStride;for(let s=0;s<16;s++)r[s]=this.typedBuffer[i++];return r}setMat(e,r){let i=e*this.typedBufferStride;for(let s=0;s<16;s++)this.typedBuffer[i++]=r[s]}get(e,r){return this.typedBuffer[e*this.typedBufferStride+r]}set(e,r,i){this.typedBuffer[e*this.typedBufferStride+r]=i}copyFrom(e,r,i){const s=this.typedBuffer,n=r.typedBuffer;let o=e*this.typedBufferStride,a=i*r.typedBufferStride;for(let l=0;l<16;++l)s[o++]=n[a++]}get buffer(){return this.typedBuffer.buffer}};TY.ElementCount=16;let my=class{constructor(e,r,i=0,s,n){this.TypedArrayConstructor=e,this.elementCount=1;const o=this.TypedArrayConstructor;s===void 0&&(s=o.BYTES_PER_ELEMENT);const a=r.byteLength===0?0:i;this.typedBuffer=n==null?new o(r,a):new o(r,a,(n-i)/o.BYTES_PER_ELEMENT),this.stride=s,this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride)}sliceBuffer(e,r,i=this.count-r){const s=this.typedBuffer.byteOffset+r*this.stride;return new e(this.buffer,s,this.stride,s+i*this.stride)}get(e){return this.typedBuffer[e*this.typedBufferStride]}set(e,r){this.typedBuffer[e*this.typedBufferStride]=r}get buffer(){return this.typedBuffer.buffer}};my.ElementCount=1;let gy=class{constructor(e,r,i=0,s,n){this.TypedArrayConstructor=e,this.elementCount=2;const o=this.TypedArrayConstructor;s===void 0&&(s=2*o.BYTES_PER_ELEMENT);const a=r.byteLength===0?0:i;this.typedBuffer=n==null?new o(r,a):new o(r,a,(n-i)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,r,i=this.count-r){const s=this.typedBuffer.byteOffset+r*this.stride;return new e(this.buffer,s,this.stride,s+i*this.stride)}getVec(e,r){return e*=this.typedBufferStride,or(r,this.typedBuffer[e],this.typedBuffer[e+1])}setVec(e,r){e*=this.typedBufferStride,this.typedBuffer[e++]=r[0],this.typedBuffer[e]=r[1]}get(e,r){return this.typedBuffer[e*this.typedBufferStride+r]}set(e,r,i){this.typedBuffer[e*this.typedBufferStride+r]=i}setValues(e,r,i){e*=this.typedBufferStride,this.typedBuffer[e++]=r,this.typedBuffer[e]=i}copyFrom(e,r,i){const s=this.typedBuffer,n=r.typedBuffer;let o=e*this.typedBufferStride,a=i*r.typedBufferStride;s[o++]=n[a++],s[o]=n[a]}get buffer(){return this.typedBuffer.buffer}};gy.ElementCount=2;let yy=class{constructor(e,r,i=0,s,n){this.TypedArrayConstructor=e,this.elementCount=3;const o=this.TypedArrayConstructor;s===void 0&&(s=3*o.BYTES_PER_ELEMENT);const a=r.byteLength===0?0:i;this.typedBuffer=n==null?new o(r,a):new o(r,a,(n-i)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,r,i=this.count-r){const s=this.typedBuffer.byteOffset+r*this.stride;return new e(this.buffer,s,this.stride,s+i*this.stride)}getVec(e,r){return e*=this.typedBufferStride,ce(r,this.typedBuffer[e],this.typedBuffer[e+1],this.typedBuffer[e+2])}setVec(e,r){e*=this.typedBufferStride,this.typedBuffer[e++]=r[0],this.typedBuffer[e++]=r[1],this.typedBuffer[e]=r[2]}get(e,r){return this.typedBuffer[e*this.typedBufferStride+r]}set(e,r,i){this.typedBuffer[e*this.typedBufferStride+r]=i}setValues(e,r,i,s){e*=this.typedBufferStride,this.typedBuffer[e++]=r,this.typedBuffer[e++]=i,this.typedBuffer[e]=s}copyFrom(e,r,i){const s=this.typedBuffer,n=r.typedBuffer;let o=e*this.typedBufferStride,a=i*r.typedBufferStride;s[o++]=n[a++],s[o++]=n[a++],s[o]=n[a]}get buffer(){return this.typedBuffer.buffer}};yy.ElementCount=3;let _y=class{constructor(e,r,i=0,s,n){this.TypedArrayConstructor=e,this.start=i,this.elementCount=4;const o=this.TypedArrayConstructor;s===void 0&&(s=4*o.BYTES_PER_ELEMENT);const a=r.byteLength===0?0:i;this.typedBuffer=n==null?new o(r,a):new o(r,a,(n-i)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,r,i=this.count-r){const s=this.typedBuffer.byteOffset+r*this.stride;return new e(this.buffer,s,this.stride,s+i*this.stride)}getVec(e,r){return e*=this.typedBufferStride,ti(r,this.typedBuffer[e++],this.typedBuffer[e++],this.typedBuffer[e++],this.typedBuffer[e])}setVec(e,r){e*=this.typedBufferStride,this.typedBuffer[e++]=r[0],this.typedBuffer[e++]=r[1],this.typedBuffer[e++]=r[2],this.typedBuffer[e]=r[3]}get(e,r){return this.typedBuffer[e*this.typedBufferStride+r]}set(e,r,i){this.typedBuffer[e*this.typedBufferStride+r]=i}setValues(e,r,i,s,n){e*=this.typedBufferStride,this.typedBuffer[e++]=r,this.typedBuffer[e++]=i,this.typedBuffer[e++]=s,this.typedBuffer[e]=n}copyFrom(e,r,i){const s=this.typedBuffer,n=r.typedBuffer;let o=e*this.typedBufferStride,a=i*r.typedBufferStride;s[o++]=n[a++],s[o++]=n[a++],s[o++]=n[a++],s[o]=n[a]}get buffer(){return this.typedBuffer.buffer}};_y.ElementCount=4;let SY=class B1e extends my{constructor(e,r=0,i,s){super(Float32Array,e,r,i,s),this.elementType="f32"}static fromTypedArray(e,r){return new B1e(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};SY.ElementType="f32";let vy=class OG extends gy{constructor(e,r=0,i,s){super(Float32Array,e,r,i,s),this.elementType="f32"}slice(e,r){return this.sliceBuffer(OG,e,r)}static fromTypedArray(e,r){return new OG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};vy.ElementType="f32";let Oi=class MG extends yy{constructor(e,r=0,i,s){super(Float32Array,e,r,i,s),this.elementType="f32"}slice(e,r){return this.sliceBuffer(MG,e,r)}static fromTypedArray(e,r){return new MG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};Oi.ElementType="f32";let Nc=class PG extends _y{constructor(e,r=0,i,s){super(Float32Array,e,r,i,s),this.elementType="f32"}slice(e,r){return this.sliceBuffer(PG,e,r)}static fromTypedArray(e,r){return new PG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};Nc.ElementType="f32";let sv=class IG extends xY{constructor(e,r=0,i,s){super(Float32Array,e,r,i,s),this.elementType="f32"}slice(e,r){return this.sliceBuffer(IG,e,r)}static fromTypedArray(e,r){return new IG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};sv.ElementType="f32";let EY=class $G extends xY{constructor(e,r=0,i,s){super(Float64Array,e,r,i,s),this.elementType="f64"}slice(e,r){return this.sliceBuffer($G,e,r)}static fromTypedArray(e,r){return new $G(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};EY.ElementType="f64";let CY=class LG extends TY{constructor(e,r=0,i,s){super(Float32Array,e,r,i,s),this.elementType="f32"}slice(e,r){return this.sliceBuffer(LG,e,r)}static fromTypedArray(e,r){return new LG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};CY.ElementType="f32";let fO=class DG extends TY{constructor(e,r=0,i,s){super(Float64Array,e,r,i,s),this.elementType="f64"}slice(e,r){return this.sliceBuffer(DG,e,r)}static fromTypedArray(e,r){return new DG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};fO.ElementType="f64";let AY=class NG extends my{constructor(e,r=0,i,s){super(Float64Array,e,r,i,s),this.elementType="f64"}slice(e,r){return this.sliceBuffer(NG,e,r)}static fromTypedArray(e,r){return new NG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};AY.ElementType="f64";let RY=class FG extends gy{constructor(e,r=0,i,s){super(Float64Array,e,r,i,s),this.elementType="f64"}slice(e,r){return this.sliceBuffer(FG,e,r)}static fromTypedArray(e,r){return new FG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};RY.ElementType="f64";let wa=class UG extends yy{constructor(e,r=0,i,s){super(Float64Array,e,r,i,s),this.elementType="f64"}slice(e,r){return this.sliceBuffer(UG,e,r)}static fromTypedArray(e,r){return new UG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};wa.ElementType="f64";let w5=class kG extends _y{constructor(e,r=0,i,s){super(Float64Array,e,r,i,s),this.elementType="f64"}slice(e,r){return this.sliceBuffer(kG,e,r)}static fromTypedArray(e,r){return new kG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};w5.ElementType="f64";let eE=class VG extends my{constructor(e,r=0,i,s){super(Uint8Array,e,r,i,s),this.elementType="u8"}slice(e,r){return this.sliceBuffer(VG,e,r)}static fromTypedArray(e,r){return new VG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};eE.ElementType="u8";let x5=class BG extends gy{constructor(e,r=0,i,s){super(Uint8Array,e,r,i,s),this.elementType="u8"}slice(e,r){return this.sliceBuffer(BG,e,r)}static fromTypedArray(e,r){return new BG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};x5.ElementType="u8";let mO=class zG extends yy{constructor(e,r=0,i,s){super(Uint8Array,e,r,i,s),this.elementType="u8"}slice(e,r){return this.sliceBuffer(zG,e,r)}static fromTypedArray(e,r){return new zG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};mO.ElementType="u8";let xa=class GG extends _y{constructor(e,r=0,i,s){super(Uint8Array,e,r,i,s),this.elementType="u8"}slice(e,r){return this.sliceBuffer(GG,e,r)}static fromTypedArray(e,r){return new GG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};xa.ElementType="u8";let T5=class jG extends my{constructor(e,r=0,i,s){super(Uint16Array,e,r,i,s),this.elementType="u16"}slice(e,r){return this.sliceBuffer(jG,e,r)}static fromTypedArray(e,r){return new jG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};T5.ElementType="u16";let OY=class HG extends gy{constructor(e,r=0,i,s){super(Uint16Array,e,r,i,s),this.elementType="u16"}slice(e,r){return this.sliceBuffer(HG,e,r)}static fromTypedArray(e,r){return new HG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};OY.ElementType="u16";let S5=class qG extends yy{constructor(e,r=0,i,s){super(Uint16Array,e,r,i,s),this.elementType="u16"}slice(e,r){return this.sliceBuffer(qG,e,r)}static fromTypedArray(e,r){return new qG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};S5.ElementType="u16";let AM=class WG extends _y{constructor(e,r=0,i,s){super(Uint16Array,e,r,i,s),this.elementType="u16"}slice(e,r){return this.sliceBuffer(WG,e,r)}static fromTypedArray(e,r){return new WG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};AM.ElementType="u16";let E5=class XG extends my{constructor(e,r=0,i,s){super(Uint32Array,e,r,i,s),this.elementType="u32"}slice(e,r){return this.sliceBuffer(XG,e,r)}static fromTypedArray(e,r){return new XG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};E5.ElementType="u32";let MY=class YG extends gy{constructor(e,r=0,i,s){super(Uint32Array,e,r,i,s),this.elementType="u32"}slice(e,r){return this.sliceBuffer(YG,e,r)}static fromTypedArray(e,r){return new YG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};MY.ElementType="u32";let z1e=class ZG extends yy{constructor(e,r=0,i,s){super(Uint32Array,e,r,i,s),this.elementType="u32"}slice(e,r){return this.sliceBuffer(ZG,e,r)}static fromTypedArray(e,r){return new ZG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};z1e.ElementType="u32";let G1e=class JG extends _y{constructor(e,r=0,i,s){super(Uint32Array,e,r,i,s),this.elementType="u32"}slice(e,r){return this.sliceBuffer(JG,e,r)}static fromTypedArray(e,r){return new JG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};G1e.ElementType="u32";let PY=class KG extends my{constructor(e,r=0,i,s){super(Int8Array,e,r,i,s),this.elementType="i8"}slice(e,r){return this.sliceBuffer(KG,e,r)}static fromTypedArray(e,r){return new KG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};PY.ElementType="i8";let C5=class QG extends gy{constructor(e,r=0,i,s){super(Int8Array,e,r,i,s),this.elementType="i8"}slice(e,r){return this.sliceBuffer(QG,e,r)}static fromTypedArray(e,r){return new QG(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};C5.ElementType="i8";let j1e=class ej extends yy{constructor(e,r=0,i,s){super(Int8Array,e,r,i,s),this.elementType="i8"}slice(e,r){return this.sliceBuffer(ej,e,r)}static fromTypedArray(e,r){return new ej(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};j1e.ElementType="i8";let H1e=class tj extends _y{constructor(e,r=0,i,s){super(Int8Array,e,r,i,s),this.elementType="i8"}slice(e,r){return this.sliceBuffer(tj,e,r)}static fromTypedArray(e,r){return new tj(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};H1e.ElementType="i8";let q1e=class rj extends my{constructor(e,r=0,i,s){super(Int16Array,e,r,i,s),this.elementType="i16"}slice(e,r){return this.sliceBuffer(rj,e,r)}static fromTypedArray(e,r){return new rj(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};q1e.ElementType="i16";let A5=class ij extends gy{constructor(e,r=0,i,s){super(Int16Array,e,r,i,s),this.elementType="i16"}slice(e,r){return this.sliceBuffer(ij,e,r)}static fromTypedArray(e,r){return new ij(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};A5.ElementType="i16";let W1e=class sj extends yy{constructor(e,r=0,i,s){super(Int16Array,e,r,i,s),this.elementType="i16"}slice(e,r){return this.sliceBuffer(sj,e,r)}static fromTypedArray(e,r){return new sj(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};W1e.ElementType="i16";let X1e=class nj extends _y{constructor(e,r=0,i,s){super(Int16Array,e,r,i,s),this.elementType="i16"}slice(e,r){return this.sliceBuffer(nj,e,r)}static fromTypedArray(e,r){return new nj(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};X1e.ElementType="i16";let Y1e=class oj extends my{constructor(e,r=0,i,s){super(Int32Array,e,r,i,s),this.elementType="i32"}slice(e,r){return this.sliceBuffer(oj,e,r)}static fromTypedArray(e,r){return new oj(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};Y1e.ElementType="i32";let Z1e=class aj extends gy{constructor(e,r=0,i,s){super(Int32Array,e,r,i,s),this.elementType="i32"}slice(e,r){return this.sliceBuffer(aj,e,r)}static fromTypedArray(e,r){return new aj(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};Z1e.ElementType="i32";let J1e=class lj extends yy{constructor(e,r=0,i,s){super(Int32Array,e,r,i,s),this.elementType="i32"}slice(e,r){return this.sliceBuffer(lj,e,r)}static fromTypedArray(e,r){return new lj(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};J1e.ElementType="i32";let K1e=class cj extends _y{constructor(e,r=0,i,s){super(Int32Array,e,r,i,s),this.elementType="i32"}slice(e,r){return this.sliceBuffer(cj,e,r)}static fromTypedArray(e,r){return new cj(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};K1e.ElementType="i32";function Q1e(t){switch(t){case"u8":case"i8":return 1;case"u16":case"i16":return 2;case"u32":case"i32":case"f32":return 4;case"f64":return 8}}function BXe(t){switch(t){case"u8":case"u16":case"u32":return!1;case"i8":case"i16":case"i32":case"f32":case"f64":return!0}}function zXe(t){switch(t){case"u8":case"u16":case"u32":case"i8":case"i16":case"i32":return!0;case"f32":case"f64":return!1}}function GXe(t){switch(t){case"u8":return 255;case"u16":return 65535;case"u32":return 4294967295;case"i8":return 127;case"i16":return 32767;case"i32":return 2147483647;case"f32":return 3402823e32;case"f64":return 179769e303}}let mie=class ebe{constructor(e,r){this.layout=e,this.buffer=typeof r=="number"?new ArrayBuffer(r*e.stride):r;for(const i of e.fieldNames){const s=e.fields.get(i);this[i]=new s.constructor(this.buffer,s.offset,this.stride)}}get stride(){return this.layout.stride}get count(){return this.buffer.byteLength/this.stride}get byteLength(){return this.buffer.byteLength}getField(e,r){const i=this[e];return i&&i.elementCount===r.ElementCount&&i.elementType===r.ElementType?i:null}slice(e,r){return new ebe(this.layout,this.buffer.slice(e*this.stride,r*this.stride))}copyFrom(e,r,i,s){const n=this.stride;if(n%4==0){const o=new Uint32Array(e.buffer,r*n,s*n/4);new Uint32Array(this.buffer,i*n,s*n/4).set(o)}else{const o=new Uint8Array(e.buffer,r*n,s*n);new Uint8Array(this.buffer,i*n,s*n).set(o)}}},jXe=class tbe{constructor(){this.stride=0,this.fields=new Map,this.fieldNames=[]}vec2f(e,r){return this._appendField(e,vy,r),this}vec2f64(e,r){return this._appendField(e,RY,r),this}vec3f(e,r){return this._appendField(e,Oi,r),this}vec3f64(e,r){return this._appendField(e,wa,r),this}vec4f(e,r){return this._appendField(e,Nc,r),this}vec4f64(e,r){return this._appendField(e,w5,r),this}mat3f(e,r){return this._appendField(e,sv,r),this}mat3f64(e,r){return this._appendField(e,EY,r),this}mat4f(e,r){return this._appendField(e,CY,r),this}mat4f64(e,r){return this._appendField(e,fO,r),this}vec4u8(e,r){return this._appendField(e,xa,r),this}f32(e,r){return this._appendField(e,SY,r),this}f64(e,r){return this._appendField(e,AY,r),this}u8(e,r){return this._appendField(e,eE,r),this}u16(e,r){return this._appendField(e,T5,r),this}i8(e,r){return this._appendField(e,PY,r),this}vec2i8(e,r){return this._appendField(e,C5,r),this}vec2i16(e,r){return this._appendField(e,A5,r),this}vec2u8(e,r){return this._appendField(e,x5,r),this}vec4u16(e,r){return this._appendField(e,AM,r),this}u32(e,r){return this._appendField(e,E5,r),this}_appendField(e,r,i){const s=r.ElementCount*Q1e(r.ElementType),n=this.stride;this.fields.set(e,{size:s,constructor:r,offset:n,optional:i}),this.stride+=s,this.fieldNames.push(e)}alignTo(e){return this.stride=Math.floor((this.stride+e-1)/e)*e,this}hasField(e){return this.fieldNames.includes(e)}createBuffer(e){return new mie(this,e)}createView(e){return new mie(this,e)}clone(){const e=new tbe;return e.stride=this.stride,e.fields=new Map,this.fields.forEach((r,i)=>e.fields.set(i,r)),e.fieldNames=this.fieldNames.slice(),e.BufferType=this.BufferType,e}};function ts(){return new jXe}let Xe=class{constructor(e,r,i=!1,s=r){this.data=e,this.size=r,this.exclusive=i,this.stride=s}};var uj;(function(t){function e(o,a){const l=o[a],c=o[a+1],h=o[a+2];return Math.sqrt(l*l+c*c+h*h)}function r(o,a){const l=o[a],c=o[a+1],h=o[a+2],p=1/Math.sqrt(l*l+c*c+h*h);o[a]*=p,o[a+1]*=p,o[a+2]*=p}function i(o,a,l){o[a]*=l,o[a+1]*=l,o[a+2]*=l}function s(o,a,l,c,h,p=a){(h=h||o)[p]=o[a]+l[c],h[p+1]=o[a+1]+l[c+1],h[p+2]=o[a+2]+l[c+2]}function n(o,a,l,c,h,p=a){(h=h||o)[p]=o[a]-l[c],h[p+1]=o[a+1]-l[c+1],h[p+2]=o[a+2]-l[c+2]}t.length=e,t.normalize=r,t.scale=i,t.add=s,t.subtract=n})(uj||(uj={}));var $s;(function(t){t[t.Layer=0]="Layer",t[t.Object=1]="Object",t[t.Mesh=2]="Mesh",t[t.Line=3]="Line",t[t.Point=4]="Point",t[t.Material=5]="Material",t[t.Texture=6]="Texture",t[t.COUNT=7]="COUNT"})($s||($s={}));function Fc(t,e=!1){return t<=em?e?new Array(t).fill(0):new Array(t):new Float64Array(t)}function HXe(t){return length<=em?Array.from(t):new Float64Array(t)}function Lh(t,e,r){return Array.isArray(t)?t.slice(e,e+r):t.subarray(e,e+r)}function Ws(t,e=!1){return t<=em?e?new Array(t).fill(0):new Array(t):new Float32Array(t)}function gie(t){return length<=em?Array.from(t):new Float32Array(t)}function yie(t,e,r){return Array.isArray(t)?t.slice(e,e+r):t.subarray(e,e+r)}function qXe(t){if(t.length<em)return Array.from(t);if(Array.isArray(t))return Float64Array.from(t);switch(t.BYTES_PER_ELEMENT){case 1:return Uint8Array.from(t);case 2:return Uint16Array.from(t);case 4:return Float32Array.from(t);default:return Float64Array.from(t)}}const Ia=sr();let WXe=class{constructor(e){this.message=e}toString(){return`AssertException: ${this.message}`}};function ft(t,e){if(!t){e=e||"Assertion";const r=new Error(e).stack;throw new WXe(`${e} at ${r}`)}}function yx(t,e){t||(e=e||"",console.warn("Verify failed: "+e+`
`+new Error("verify").stack))}function _ie(t,e,r,i){let s,n=(r[0]-t[0])/e[0],o=(i[0]-t[0])/e[0];n>o&&(s=n,n=o,o=s);let a=(r[1]-t[1])/e[1],l=(i[1]-t[1])/e[1];if(a>l&&(s=a,a=l,l=s),n>l||a>o)return!1;a>n&&(n=a),l<o&&(o=l);let c=(r[2]-t[2])/e[2],h=(i[2]-t[2])/e[2];return c>h&&(s=c,c=h,h=s),!(n>h||c>o)&&(h<o&&(o=h),!(o<0))}function XP(t,e,r,i,s,n=Je()){const o=(i[s]-r[s])*(e[0]-t[0])-(i[0]-r[0])*(e[s]-t[s]),a=(i[0]-r[0])*(t[s]-r[s])-(i[s]-r[s])*(t[0]-r[0]);if(o===0)return!1;const l=a/o;return n[0]=t[0]+l*(e[0]-t[0]),n[1]=t[s]+l*(e[s]-t[s]),!0}function vie(t,e,r,i,s){Ia[0]=t[0],Ia[1]=t[1],Ia[2]=t[2],Ia[3]=1,Su(Ia,Ia,e),s.length>2&&(s[2]=-Ia[2]),Su(Ia,Ia,r),ft(Ia[3]!==0),s[0]=Ia[0]/Ia[3],s[1]=Ia[1]/Ia[3],s[2]=Ia[2]/Ia[3],s[0]=(.5*s[0]+.5)*i[2]+i[0],s[1]=(.5*s[1]+.5)*i[3]+i[1]}function XXe(t,e){return Math.log(t)/Math.log(e)}function YXe(t,e,r,i){t[12]=e,t[13]=r,t[14]=i}function rbe(t){return t[0]===1&&t[1]===0&&t[2]===0&&t[3]===0&&t[4]===0&&t[5]===1&&t[6]===0&&t[7]===0&&t[8]===0&&t[9]===0&&t[10]===1&&t[11]===0&&t[15]===1}let ibe=class sbe{constructor(e,r,i,s){this.primitiveIndices=e,this._numIndexPerPrimitive=r,this.indices=i,this.position=s,this._children=void 0,ft(e.length>=1),ft(i.length%this._numIndexPerPrimitive==0),ft(i.length>=e.length*this._numIndexPerPrimitive),ft(s.size===3||s.size===4);const{data:n,size:o}=s,a=e.length;let l=o*i[this._numIndexPerPrimitive*e[0]];Dv.clear(),Dv.push(l);const c=$e(n[l],n[l+1],n[l+2]),h=ms(c);for(let m=0;m<a;++m){const y=this._numIndexPerPrimitive*e[m];for(let _=0;_<this._numIndexPerPrimitive;++_){l=o*i[y+_],Dv.push(l);let b=n[l];c[0]=Math.min(b,c[0]),h[0]=Math.max(b,h[0]),b=n[l+1],c[1]=Math.min(b,c[1]),h[1]=Math.max(b,h[1]),b=n[l+2],c[2]=Math.min(b,c[2]),h[2]=Math.max(b,h[2])}}this.bbMin=c,this.bbMax=h;const p=Ys(M(),this.bbMin,this.bbMax,.5);this.radius=.5*Math.max(Math.max(h[0]-c[0],h[1]-c[1]),h[2]-c[2]);let f=this.radius*this.radius;for(let m=0;m<Dv.length;++m){l=Dv.getItemAt(m);const y=n[l]-p[0],_=n[l+1]-p[1],b=n[l+2]-p[2],x=y*y+_*_+b*b;if(x<=f)continue;const T=Math.sqrt(x),S=.5*(T-this.radius);this.radius=this.radius+S,f=this.radius*this.radius;const E=S/T;p[0]+=y*E,p[1]+=_*E,p[2]+=b*E}this.center=p,Dv.clear()}getChildren(){if(this._children||Ro(this.bbMin,this.bbMax)<=1)return this._children;const e=Ys(M(),this.bbMin,this.bbMax,.5),r=this.primitiveIndices.length,i=new Uint8Array(r),s=new Array(8);for(let c=0;c<8;++c)s[c]=0;const{data:n,size:o}=this.position;for(let c=0;c<r;++c){let h=0;const p=this._numIndexPerPrimitive*this.primitiveIndices[c];let f=o*this.indices[p],m=n[f],y=n[f+1],_=n[f+2];for(let b=1;b<this._numIndexPerPrimitive;++b){f=o*this.indices[p+b];const x=n[f],T=n[f+1],S=n[f+2];x<m&&(m=x),T<y&&(y=T),S<_&&(_=S)}m<e[0]&&(h|=1),y<e[1]&&(h|=2),_<e[2]&&(h|=4),i[c]=h,++s[h]}let a=0;for(let c=0;c<8;++c)s[c]>0&&++a;if(a<2)return;const l=new Array(8);for(let c=0;c<8;++c)l[c]=s[c]>0?new Uint32Array(s[c]):void 0;for(let c=0;c<8;++c)s[c]=0;for(let c=0;c<r;++c){const h=i[c];l[h][s[h]++]=this.primitiveIndices[c]}this._children=new Array;for(let c=0;c<8;++c)l[c]!==void 0&&this._children.push(new sbe(l[c],this._numIndexPerPrimitive,this.indices,this.position));return this._children}static prune(){Dv.prune()}};const Dv=new Jt({deallocator:null});let RM=class{constructor(){this.id=Pc()}unload(){}};function ZXe(t){return t?{p0:ms(t.p0),p1:ms(t.p1),p2:ms(t.p2)}:{p0:M(),p1:M(),p2:M()}}function bie(t,e,r){const i=e[0]-t[0],s=e[1]-t[1],n=r[0]-t[0],o=r[1]-t[1];return .5*Math.abs(i*o-s*n)}function JXe(t,e,r){return me(y8,e,t),me(wie,r,t),Me(pt(y8,y8,wie))/2}new cy(xp);new cy(()=>ZXe());const y8=M(),wie=M();function KXe(t,e,r){if(!t||!e)return!1;const{size:i,data:s}=t;ce(r,0,0,0),ce(mh,0,0,0);let n=0,o=0;for(let a=0;a<e.length-2;a+=3){const l=e[a+0]*i,c=e[a+1]*i,h=e[a+2]*i;ce(Kn,s[l+0],s[l+1],s[l+2]),ce(Pg,s[c+0],s[c+1],s[c+2]),ce(YP,s[h+0],s[h+1],s[h+2]);const p=JXe(Kn,Pg,YP);p?(fe(Kn,Kn,Pg),fe(Kn,Kn,YP),ae(Kn,Kn,1/3*p),fe(r,r,Kn),n+=p):(fe(mh,mh,Kn),fe(mh,mh,Pg),fe(mh,mh,YP),o+=3)}return(o!==0||n!==0)&&(n!==0?(ae(r,r,1/n),!0):o!==0&&(ae(r,mh,1/o),!0))}function QXe(t,e,r){if(!t||!e)return!1;const{size:i,data:s}=t;ce(r,0,0,0);let n=-1,o=0;for(let a=0;a<e.length;a++){const l=e[a]*i;n!==l&&(r[0]+=s[l+0],r[1]+=s[l+1],r[2]+=s[l+2],o++),n=l}return o>1&&ae(r,r,1/o),o>0}function eYe(t,e,r,i){if(!t)return!1;ce(i,0,0,0),ce(mh,0,0,0);let s=0,n=0;const{size:o,data:a}=t,l=e?e.length-1:a.length/o-1,c=l+(r?2:0);for(let h=0;h<c;h+=2){const p=h<l?h:l,f=h<l?h+1:0,m=(e?e[p]:p)*o,y=(e?e[f]:f)*o;Kn[0]=a[m],Kn[1]=a[m+1],Kn[2]=a[m+2],Pg[0]=a[y],Pg[1]=a[y+1],Pg[2]=a[y+2],ae(Kn,fe(Kn,Kn,Pg),.5);const _=KO(Kn,Pg);_>0?(fe(i,i,ae(Kn,Kn,_)),s+=_):s===0&&(fe(mh,mh,Kn),n++)}return s!==0?(ae(i,i,1/s),!0):n!==0&&(ae(i,mh,1/n),!0)}const Kn=M(),Pg=M(),YP=M(),mh=M();function rS(t){if(Array.isArray(t)){if(t.length<em)return t;for(const e of t)if(e>=65536)return new Uint32Array(t);return new Uint16Array(t)}if(t.length<em)return Array.from(t);if(t.BYTES_PER_ELEMENT===Uint16Array.BYTES_PER_ELEMENT)return t;for(const e of t)if(e>=65536)return t;return new Uint16Array(t)}function nbe(t){const e=3*t;return e<=em?new Array(e):e<=65536?new Uint16Array(e):new Uint32Array(e)}let t_=(()=>{const t=new Uint32Array(131072);for(let e=0;e<t.length;++e)t[e]=e;return t})();const obe=[0],iS=(()=>{const t=new Uint16Array(65536);for(let e=0;e<t.length;++e)t[e]=e;return t})();function tE(t){if(t===1)return obe;if(t<em)return Array.from(new Uint16Array(iS.buffer,0,t));if(t<iS.length)return new Uint16Array(iS.buffer,0,t);if(t>t_.length){const e=Math.max(2*t_.length,t);t_=new Uint32Array(e);for(let r=0;r<t_.length;r++)t_[r]=r}return new Uint32Array(t_.buffer,0,t)}function RAt(t){if(t===1)return obe;if(t<em)return Array.from(new Uint16Array(iS.buffer,0,t));if(t<iS.length)return new Uint16Array(iS.slice(0,t));if(t>t_.length){const e=new Uint32Array(t);for(let r=0;r<e.length;r++)e[r]=r;return e}return new Uint32Array(t_.slice(0,t))}let nF=class{constructor(e){this.channel=e,this.id=Pc()}};function hj(t,e,r){for(let i=0;i<r;++i)e[2*i]=t[i],e[2*i+1]=t[i]-e[2*i]}function tYe(t,e){const r=t.length;for(let i=0;i<r;++i)O2[0]=t[i],e[i]=O2[0];return e}function rYe(t,e){const r=t.length;for(let i=0;i<r;++i)O2[0]=t[i],O2[1]=t[i]-O2[0],e[i]=O2[1];return e}const O2=new Float32Array(2);function dj(t,e){return C(t)&&(t=[]),t.push(e),t}function pj(t,e){if(C(t))return null;const r=t.filter(i=>i!==e);return r.length===0?null:r}function iYe(t,e,r,i,s){ZP[0]=t.get(e,0),ZP[1]=t.get(e,1),ZP[2]=t.get(e,2),hj(ZP,Nv,3),r.set(s,0,Nv[0]),i.set(s,0,Nv[1]),r.set(s,1,Nv[2]),i.set(s,1,Nv[3]),r.set(s,2,Nv[4]),i.set(s,2,Nv[5])}const ZP=M(),Nv=new Float32Array(6);let nn=class abe extends RM{constructor(e,r,i=[],s=null,n=$s.Mesh,o=null,a=-1){super(),this.material=e,this.mapPositions=s,this.type=n,this.objectAndLayerIdColor=o,this.edgeIndicesLength=a,this.visible=!0,this._vertexAttributes=new Map,this._indices=new Map,this._boundingInfo=null;for(const[l,c]of r)c&&this._vertexAttributes.set(l,{...c});if(i==null||i.length===0){const l=sYe(this._vertexAttributes),c=tE(l);this.edgeIndicesLength=this.edgeIndicesLength<0?l:this.edgeIndicesLength;for(const h of this._vertexAttributes.keys())this._indices.set(h,c)}else for(const[l,c]of i)c&&(this._indices.set(l,rS(c)),l===A.POSITION&&(this.edgeIndicesLength=this.edgeIndicesLength<0?this._indices.get(l).length:this.edgeIndicesLength))}instantiate(e={}){const r=new abe(e.material||this.material,[],void 0,this.mapPositions,this.type,this.objectAndLayerIdColor,this.edgeIndicesLength);return this._vertexAttributes.forEach((i,s)=>{i.exclusive=!1,r._vertexAttributes.set(s,i)}),this._indices.forEach((i,s)=>r._indices.set(s,i)),r._boundingInfo=this._boundingInfo,r.transformation=e.transformation||this.transformation,r}get vertexAttributes(){return this._vertexAttributes}getMutableAttribute(e){let r=this._vertexAttributes.get(e);return r&&!r.exclusive&&(r={...r,exclusive:!0,data:qXe(r.data)},this._vertexAttributes.set(e,r)),r}get indices(){return this._indices}get indexCount(){const e=this._indices.values().next().value;return e?e.length:0}get faceCount(){return this.indexCount/3}get boundingInfo(){return C(this._boundingInfo)&&(this._boundingInfo=this._calculateBoundingInfo()),this._boundingInfo}computeAttachmentOrigin(e){return!!(this.type===$s.Mesh?this._computeAttachmentOriginTriangles(e):this.type===$s.Line?this._computeAttachmentOriginLines(e):this._computeAttachmentOriginPoints(e))&&(v(this._transformation)&&We(e,e,this._transformation),!0)}_computeAttachmentOriginTriangles(e){const r=this.indices.get(A.POSITION),i=this.vertexAttributes.get(A.POSITION);return KXe(i,r,e)}_computeAttachmentOriginLines(e){const r=this.vertexAttributes.get(A.POSITION),i=this.indices.get(A.POSITION);return eYe(r,i,i&&nYe(this.material.parameters,r,i),e)}_computeAttachmentOriginPoints(e){const r=this.indices.get(A.POSITION),i=this.vertexAttributes.get(A.POSITION);return QXe(i,r,e)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const e=this.indices.get(A.POSITION),r=this.vertexAttributes.get(A.POSITION);if(!e||e.length===0||!r)return null;const i=this.type===$s.Mesh?3:1;ft(e.length%i==0,"Indexing error: "+e.length+" not divisible by "+i);const s=tE(e.length/i);return new ibe(s,i,e,r)}get transformation(){return It(this._transformation,Lu)}set transformation(e){this._transformation=e&&e!==Lu?FS(e):null}get shaderTransformation(){return v(this._shaderTransformer)?this._shaderTransformer(this.transformation):this.transformation}get shaderTransformer(){return this._shaderTransformer}set shaderTransformer(e){this._shaderTransformer=e}get hasVolatileTransformation(){return v(this._shaderTransformer)}addHighlight(){const e=new nF(ry.Highlight);return this.highlights=dj(this.highlights,e),e}removeHighlight(e){this.highlights=pj(this.highlights,e)}};function sYe(t){const e=t.values().next().value;return e==null?0:e.data.length/e.size}function nYe(t,e,r){return!(!("isClosed"in t)||!t.isClosed)&&(r?r.length>2:e.data.length>6)}const _x=uj,_8=[[-.5,-.5,.5],[.5,-.5,.5],[.5,.5,.5],[-.5,.5,.5],[-.5,-.5,-.5],[.5,-.5,-.5],[.5,.5,-.5],[-.5,.5,-.5]],oYe=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],aYe=[0,0,1,0,1,1,0,1],lYe=[0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5],lbe=new Array(36);for(let t=0;t<6;t++)for(let e=0;e<6;e++)lbe[6*t+e]=t;const Q1=new Array(36);for(let t=0;t<6;t++)Q1[6*t+0]=0,Q1[6*t+1]=1,Q1[6*t+2]=2,Q1[6*t+3]=2,Q1[6*t+4]=3,Q1[6*t+5]=0;function cYe(t,e){Array.isArray(e)||(e=[e,e,e]);const r=new Array(24);for(let i=0;i<8;i++)r[3*i]=_8[i][0]*e[0],r[3*i+1]=_8[i][1]*e[1],r[3*i+2]=_8[i][2]*e[2];return new nn(t,[[A.POSITION,new Xe(r,3,!0)],[A.NORMAL,new Xe(oYe,3)],[A.UV0,new Xe(aYe,2)]],[[A.POSITION,lYe],[A.NORMAL,lbe],[A.UV0,Q1]])}const v8=[[-.5,0,-.5],[.5,0,-.5],[.5,0,.5],[-.5,0,.5],[0,-.5,0],[0,.5,0]],uYe=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],hYe=[5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0],dYe=[0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7];function pYe(t,e){Array.isArray(e)||(e=[e,e,e]);const r=new Array(18);for(let i=0;i<6;i++)r[3*i]=v8[i][0]*e[0],r[3*i+1]=v8[i][1]*e[1],r[3*i+2]=v8[i][2]*e[2];return new nn(t,[[A.POSITION,new Xe(r,3,!0)],[A.NORMAL,new Xe(uYe,3)]],[[A.POSITION,hYe],[A.NORMAL,dYe]])}const iD=Xr(-.5,0,-.5),sD=Xr(.5,0,-.5),nD=Xr(0,0,.5),oD=Xr(0,.5,0),vx=Vi(),bx=Vi(),sS=Vi(),nS=Vi(),oS=Vi();me(vx,iD,oD),me(bx,iD,sD),pt(sS,vx,bx),_e(sS,sS),me(vx,sD,oD),me(bx,sD,nD),pt(nS,vx,bx),_e(nS,nS),me(vx,nD,oD),me(bx,nD,iD),pt(oS,vx,bx),_e(oS,oS);const b8=[iD,sD,nD,oD],fYe=[0,-1,0,sS[0],sS[1],sS[2],nS[0],nS[1],nS[2],oS[0],oS[1],oS[2]],mYe=[0,1,2,3,1,0,3,2,1,3,0,2],gYe=[0,0,0,1,1,1,2,2,2,3,3,3];function yYe(t,e){Array.isArray(e)||(e=[e,e,e]);const r=new Array(12);for(let i=0;i<4;i++)r[3*i]=b8[i][0]*e[0],r[3*i+1]=b8[i][1]*e[1],r[3*i+2]=b8[i][2]*e[2];return new nn(t,[[A.POSITION,new Xe(r,3,!0)],[A.NORMAL,new Xe(fYe,3)]],[[A.POSITION,mYe],[A.NORMAL,gYe]])}function MAt(t,e,r,i,s={uv:!0}){const n=-Math.PI,o=2*Math.PI,a=-Math.PI/2,l=Math.PI,c=Math.max(3,Math.floor(r)),h=Math.max(2,Math.floor(i)),p=(c+1)*(h+1),f=Ws(3*p),m=Ws(3*p),y=Ws(2*p),_=[];let b=0;for(let E=0;E<=h;E++){const O=[],R=E/h,L=a+R*l,P=Math.cos(L);for(let U=0;U<=c;U++){const B=U/c,z=n+B*o,G=Math.cos(z)*P,K=Math.sin(L),ee=-Math.sin(z)*P;f[3*b]=G*e,f[3*b+1]=K*e,f[3*b+2]=ee*e,m[3*b]=G,m[3*b+1]=K,m[3*b+2]=ee,y[2*b]=B,y[2*b+1]=R,O.push(b),++b}_.push(O)}const x=new Array;for(let E=0;E<h;E++)for(let O=0;O<c;O++){const R=_[E][O],L=_[E][O+1],P=_[E+1][O+1],U=_[E+1][O];E===0?(x.push(R),x.push(P),x.push(U)):E===h-1?(x.push(R),x.push(L),x.push(P)):(x.push(R),x.push(L),x.push(P),x.push(P),x.push(U),x.push(R))}const T=[[A.POSITION,x],[A.NORMAL,x]],S=[[A.POSITION,new Xe(f,3,!0)],[A.NORMAL,new Xe(m,3,!0)]];return s.uv&&(S.push([A.UV0,new Xe(y,2,!0)]),T.push([A.UV0,x])),s.offset&&(T[0][0]=A.OFFSET,S[0][0]=A.OFFSET,T.push([A.POSITION,new Array(x.length).fill(0)]),S.push([A.POSITION,new Xe(Float64Array.from(s.offset),3,!0)])),new nn(t,S,T)}function _Ye(t,e,r,i){const{vertexAttributes:s,indices:n}=cbe(e,r,i);return new nn(t,s,n)}function cbe(t,e,r){const i=t;let s,n;if(r)s=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],n=[0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1];else{const h=i*(1+Math.sqrt(5))/2;s=[-i,h,0,i,h,0,-i,-h,0,i,-h,0,0,-i,h,0,i,h,0,-i,-h,0,i,-h,h,0,-i,h,0,i,-h,0,-i,-h,0,i],n=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1]}for(let h=0;h<s.length;h+=3)_x.scale(s,h,t/_x.length(s,h));let o={};function a(h,p){h>p&&([h,p]=[p,h]);const f=h.toString()+"."+p.toString();if(o[f])return o[f];let m=s.length;return s.length+=3,_x.add(s,3*h,s,3*p,s,m),_x.scale(s,m,t/_x.length(s,m)),m/=3,o[f]=m,m}for(let h=0;h<e;h++){const p=n.length,f=new Array(4*p);for(let m=0;m<p;m+=3){const y=n[m],_=n[m+1],b=n[m+2],x=a(y,_),T=a(_,b),S=a(b,y),E=4*m;f[E]=y,f[E+1]=x,f[E+2]=S,f[E+3]=_,f[E+4]=T,f[E+5]=x,f[E+6]=b,f[E+7]=S,f[E+8]=T,f[E+9]=x,f[E+10]=T,f[E+11]=S}n=f,o={}}const l=gie(s);for(let h=0;h<l.length;h+=3)_x.normalize(l,h);const c=[[A.POSITION,n],[A.NORMAL,n]];return{vertexAttributes:[[A.POSITION,new Xe(gie(s),3,!0)],[A.NORMAL,new Xe(l,3,!0)]],indices:c}}function fj(t,e,r,i,s,n,o,a,l=null){const c=r?[r[0],r[1],r[2]]:[0,0,0],h=e?[e[0],e[1],e[2]]:[0,0,1];o=o||[0,0];const p=i?[255*i[0],255*i[1],255*i[2],i.length>3?255*i[3]:255]:[255,255,255,255],f=v(s)&&s.length===2?s:[1,1],m=[[A.POSITION,new Xe(c,3,!0)],[A.NORMAL,new Xe(h,3,!0)],[A.UV0,new Xe(o,o.length)],[A.COLOR,new Xe(p,4,!0)],[A.SIZE,new Xe(f,2)]];if(n!=null){const y=[n[0],n[1],n[2],n[3]];m.push([A.AUXPOS1,new Xe(y,4)])}if(a!=null){const y=[a[0],a[1],a[2],a[3]];m.push([A.AUXPOS2,new Xe(y,4)])}return new nn(t,m,null,null,$s.Point,l)}const vYe=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]];function PAt(t,e=vYe){const r=new Array(12);for(let h=0;h<4;h++)for(let p=0;p<3;p++)r[3*h+p]=e[h][p];const i=[0,1,2,2,3,0],s=[0,0,1],n=[0,0,0,0,0,0],o=[0,0,1,0,1,1,0,1],a=[255,255,255,255],l=[[A.POSITION,i],[A.NORMAL,n],[A.UV0,i],[A.COLOR,n]],c=[[A.POSITION,new Xe(r,3,!0)],[A.NORMAL,new Xe(s,3,!0)],[A.UV0,new Xe(o,2,!0)],[A.COLOR,new Xe(a,4,!0)]];return new nn(t,c,l)}function xie(t,e,r,i,s,n=!0,o=!0){let a=0;const l=r,c=e;let h=Xr(0,a,0),p=Xr(0,a+c,0),f=Xr(0,-1,0),m=Xr(0,1,0);s&&(a=c,p=Xr(0,0,0),h=Xr(0,a,0),f=Xr(0,1,0),m=Xr(0,-1,0));const y=[p,h],_=[f,m],b=i+2,x=Math.sqrt(c*c+l*l);if(s)for(let P=i-1;P>=0;P--){const U=P*(2*Math.PI/i),B=Xr(Math.cos(U)*l,a,Math.sin(U)*l);y.push(B);const z=Xr(c*Math.cos(U)/x,-l/x,c*Math.sin(U)/x);_.push(z)}else for(let P=0;P<i;P++){const U=P*(2*Math.PI/i),B=Xr(Math.cos(U)*l,a,Math.sin(U)*l);y.push(B);const z=Xr(c*Math.cos(U)/x,l/x,c*Math.sin(U)/x);_.push(z)}const T=new Array,S=new Array;if(n){for(let P=3;P<y.length;P++)T.push(1),T.push(P-1),T.push(P),S.push(0),S.push(0),S.push(0);T.push(y.length-1),T.push(2),T.push(1),S.push(0),S.push(0),S.push(0)}if(o){for(let P=3;P<y.length;P++)T.push(P),T.push(P-1),T.push(0),S.push(P),S.push(P-1),S.push(1);T.push(0),T.push(2),T.push(y.length-1),S.push(1),S.push(2),S.push(_.length-1)}const E=Ws(3*b);for(let P=0;P<b;P++)E[3*P]=y[P][0],E[3*P+1]=y[P][1],E[3*P+2]=y[P][2];const O=Ws(3*b);for(let P=0;P<b;P++)O[3*P]=_[P][0],O[3*P+1]=_[P][1],O[3*P+2]=_[P][2];const R=[[A.POSITION,T],[A.NORMAL,S]],L=[[A.POSITION,new Xe(E,3,!0)],[A.NORMAL,new Xe(O,3,!0)]];return new nn(t,L,R)}function bYe(t,e,r,i,s,n,o){const a=s?QN(s):Xr(1,0,0),l=n?QN(n):Xr(0,0,0);o=o??!0;const c=Vi();_e(c,a);const h=Vi();ae(h,c,Math.abs(e));const p=Vi();ae(p,h,-.5),fe(p,p,l);const f=Xr(0,1,0);Math.abs(1-ye(c,f))<.2&&ce(f,0,0,1);const m=Vi();pt(m,c,f),_e(m,m),pt(f,m,c);const y=2*i+(o?2:0),_=i+(o?2:0),b=Ws(3*y),x=Ws(3*_),T=Ws(2*y),S=new Array(3*i*(o?4:2)),E=new Array(3*i*(o?4:2));o&&(b[3*(y-2)+0]=p[0],b[3*(y-2)+1]=p[1],b[3*(y-2)+2]=p[2],T[2*(y-2)]=0,T[2*(y-2)+1]=0,b[3*(y-1)+0]=b[3*(y-2)+0]+h[0],b[3*(y-1)+1]=b[3*(y-2)+1]+h[1],b[3*(y-1)+2]=b[3*(y-2)+2]+h[2],T[2*(y-1)]=1,T[2*(y-1)+1]=1,x[3*(_-2)+0]=-c[0],x[3*(_-2)+1]=-c[1],x[3*(_-2)+2]=-c[2],x[3*(_-1)+0]=c[0],x[3*(_-1)+1]=c[1],x[3*(_-1)+2]=c[2]);const O=(z,G,K)=>{S[z]=G,E[z]=K};let R=0;const L=Vi(),P=Vi();for(let z=0;z<i;z++){const G=z*(2*Math.PI/i);ae(L,f,Math.sin(G)),ae(P,m,Math.cos(G)),fe(L,L,P),x[3*z+0]=L[0],x[3*z+1]=L[1],x[3*z+2]=L[2],ae(L,L,r),fe(L,L,p),b[3*z+0]=L[0],b[3*z+1]=L[1],b[3*z+2]=L[2],T[2*z+0]=z/i,T[2*z+1]=0,b[3*(z+i)+0]=b[3*z+0]+h[0],b[3*(z+i)+1]=b[3*z+1]+h[1],b[3*(z+i)+2]=b[3*z+2]+h[2],T[2*(z+i)+0]=z/i,T[2*z+1]=1;const K=(z+1)%i;O(R++,z,z),O(R++,z+i,z),O(R++,K,K),O(R++,K,K),O(R++,z+i,z),O(R++,K+i,K)}if(o){for(let z=0;z<i;z++){const G=(z+1)%i;O(R++,y-2,_-2),O(R++,z,_-2),O(R++,G,_-2)}for(let z=0;z<i;z++){const G=(z+1)%i;O(R++,z+i,_-1),O(R++,y-1,_-1),O(R++,G+i,_-1)}}const U=[[A.POSITION,S],[A.NORMAL,E],[A.UV0,S]],B=[[A.POSITION,new Xe(b,3,!0)],[A.NORMAL,new Xe(x,3,!0)],[A.UV0,new Xe(T,2,!0)]];return new nn(t,B,U)}function IAt(t,e,r,i,s,n,o=Xr(0,0,0)){const a=e.length,l=Ws(r.length*a*3+(6*i.length||0)),c=Ws(r.length*a*3+(i?6:0)),h=new Array,p=new Array;let f=0,m=0;const y=Vi(),_=Vi(),b=Vi(),x=Vi(),T=Vi(),S=Vi(),E=Vi(),O=M(),R=Vi(),L=Vi(),P=Vi(),U=Vi(),B=Vi(),z=zr();ce(R,0,1,0),me(_,r[1],r[0]),_e(_,_),n?(fe(O,r[0],o),_e(b,O)):ce(b,0,0,1),oF(_,b,R,R,T,b,Tie),le(x,b),le(U,T);for(let F=0;F<i.length;F++)ae(S,T,i[F][0]),ae(O,b,i[F][2]),fe(S,S,O),fe(S,S,r[0]),l[f++]=S[0],l[f++]=S[1],l[f++]=S[2];c[m++]=-_[0],c[m++]=-_[1],c[m++]=-_[2];for(let F=0;F<s.length;F++)h.push(s[F][0]>0?s[F][0]:-s[F][0]-1+i.length),h.push(s[F][1]>0?s[F][1]:-s[F][1]-1+i.length),h.push(s[F][2]>0?s[F][2]:-s[F][2]-1+i.length),p.push(0),p.push(0),p.push(0);let G=i.length;const K=i.length-1;for(let F=0;F<r.length;F++){let j=!1;F>0&&(le(y,_),F<r.length-1?(me(_,r[F+1],r[F]),_e(_,_)):j=!0,fe(L,y,_),_e(L,L),fe(P,r[F-1],x),lM(r[F],L,z),Zw(z,Du(P,y),O)?(me(O,O,r[F]),_e(b,O),pt(T,L,b),_e(T,T)):oF(L,x,U,R,T,b,Tie),le(x,b),le(U,T)),n&&(fe(O,r[F],o),_e(B,O));for(let X=0;X<a;X++)if(ae(S,T,e[X][0]),ae(O,b,e[X][1]),fe(S,S,O),_e(E,S),c[m++]=E[0],c[m++]=E[1],c[m++]=E[2],fe(S,S,r[F]),l[f++]=S[0],l[f++]=S[1],l[f++]=S[2],!j){const J=(X+1)%a;h.push(G+X),h.push(G+a+X),h.push(G+J),h.push(G+J),h.push(G+a+X),h.push(G+a+J);for(let W=0;W<6;W++){const ue=h.length-6;p.push(h[ue+W]-K)}}G+=a}const ee=r[r.length-1];for(let F=0;F<i.length;F++)ae(S,T,i[F][0]),ae(O,b,i[F][1]),fe(S,S,O),fe(S,S,ee),l[f++]=S[0],l[f++]=S[1],l[f++]=S[2];const Q=m/3;c[m++]=_[0],c[m++]=_[1],c[m++]=_[2];const H=G-a;for(let F=0;F<s.length;F++)h.push(s[F][0]>=0?G+s[F][0]:-s[F][0]-1+H),h.push(s[F][2]>=0?G+s[F][2]:-s[F][2]-1+H),h.push(s[F][1]>=0?G+s[F][1]:-s[F][1]-1+H),p.push(Q),p.push(Q),p.push(Q);const $=[[A.POSITION,h],[A.NORMAL,p]],N=[[A.POSITION,new Xe(l,3,!0)],[A.NORMAL,new Xe(c,3,!0)]];return new nn(t,N,$)}function $At(t,e,r,i){ft(e.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),ft(e[0].length===3,"createPolylineGeometry(): malformed vertex"),ft(r==null||r.length===e.length,"createPolylineGeometry: need same number of points and normals"),ft(r==null||r[0].length===3,"createPolylineGeometry(): malformed normal");const s=Fc(3*e.length),n=new Array(2*(e.length-1));let o=0,a=0;for(let h=0;h<e.length;h++){for(let p=0;p<3;p++)s[o++]=e[h][p];h>0&&(n[a++]=h-1,n[a++]=h)}const l=[],c=[];if(l.push([A.POSITION,n]),c.push([A.POSITION,new Xe(s,3,!0)]),r){const h=Ws(3*r.length);let p=0;for(let f=0;f<e.length;f++)for(let m=0;m<3;m++)h[p++]=r[f][m];l.push([A.NORMAL,n]),c.push([A.NORMAL,new Xe(h,3,!0)])}return i&&(c.push([A.COLOR,new Xe(i,4)]),l.push([A.COLOR,tE(i.length/4)])),new nn(t,c,l,null,$s.Line)}function wYe(t,e=t){const r=t.vertexAttributes,i=r.get(A.POSITION).data,s=r.get(A.NORMAL).data;if(s){const n=e.getMutableAttribute(A.NORMAL).data;for(let o=0;o<s.length;o+=3){const a=s[o+1];n[o+1]=-s[o+2],n[o+2]=a}}if(i){const n=e.getMutableAttribute(A.POSITION).data;for(let o=0;o<i.length;o+=3){const a=i[o+1];n[o+1]=-i[o+2],n[o+2]=a}}}function w8(t,e,r,i,s){return!(Math.abs(ye(e,t))>s)&&(pt(r,t,e),_e(r,r),pt(i,r,t),_e(i,i),!0)}function oF(t,e,r,i,s,n,o){return w8(t,e,s,n,o)||w8(t,r,s,n,o)||w8(t,i,s,n,o)}const Tie=.99619469809;let xYe=class{constructor(e,r){this.type=An.Panoramic,this._configuration=new bY,this._passParameters=new wY,this._configuration.geometry=um.Cylinder,this._technique=r.techniqueRepository.acquire(sF,this._configuration);const i=r.renderContext.rctx;this._vao=this._createVertexArrayObject(i),this._vaoCount=Wo(this._vao,"geometry"),this._passParameters.texture=new ct(i,{pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Rt.CLAMP_TO_EDGE,samplingMode:tt.LINEAR,flipped:!0,width:1,height:512},V1e)}destroy(){this._passParameters.texture=Qe(this._passParameters.texture),this._vao.dispose(),this._technique.release()}render(e){const r=e.rctx,i=r.bindTechnique(this._technique,this._passParameters,e.bindParameters);TYe(Sie,e.bindParameters.camera.viewMatrix),i.setUniformMatrix4fv("view",Sie),r.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays($t.TRIANGLES,0,this._vaoCount)}renderHaze(){return!1}_createVertexArrayObject(e){const r=cbe(1,2,!1),i=r.indices[0][1],s=r.vertexAttributes[0][1];for(let l=0;l<i.length;l+=3){const c=i[l];i[l]=i[l+2],i[l+2]=c}const n=s.data,o=Eie.createBuffer(i.length),a=o.position;for(let l=0;l<i.length;++l){const c=3*i[l];a.set(l,0,n[c]),a.set(l,1,n[c+1]),a.set(l,2,n[c+2])}return new Sp(e,Rr,{geometry:Vc(Eie)},{geometry:jr.createVertex(e,Lr.STATIC_DRAW,o.buffer)})}};function TYe(t,e){Fn(t,e),t[12]=0,t[13]=0,t[14]=0,t[15]=1}const Sie=Ie(),Eie=ts().vec3f(A.POSITION);var iy;(function(t){t[t.Rain=0]="Rain",t[t.Snow=1]="Snow",t[t.COUNT=2]="COUNT"})(iy||(iy={}));let mj=class extends Ca{constructor(){super(...arguments),this.type=iy.Rain}};u([V({count:iy.COUNT})],mj.prototype,"type",void 0);function SYe(t){const e=new Dr;return e.attributes.add(A.POSITION,"vec3"),e.attributes.add(A.INSTANCEFEATUREATTRIBUTE,"float"),e.vertex.uniforms.add(new qt("cameraPosition",(r,i)=>i.camera.eye)),e.vertex.uniforms.add(new qt("offset",(r,i)=>EYe(r,i))),e.vertex.uniforms.add(new Pe("width",r=>r.width)),e.vertex.uniforms.add(new Hi("proj",(r,i)=>i.camera.projectionMatrix)),e.vertex.uniforms.add(new Hi("view",(r,i)=>i.camera.viewMatrix)),e.vertex.uniforms.add(new Pe("time",r=>r.time)),e.varyings.add("vUv","vec2"),e.vertex.code.add(w`
    vec3 hash31(float p){
      vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return fract((p3.xxy + p3.yzz) * p3.zyx);
    }

    float hash11(float p){
      p = fract(p * 0.1031);
      p *= p + 33.33;
      p *= p + p;
      return fract(p);
    }

    //https://www.geeks3d.com/20141201/how-to-rotate-a-vertex-by-a-quaternion-in-glsl/
    vec3 rotateVectorByQuaternion(vec3 v, vec4 q){
      return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;
    }

    void main(void) {

      vUv = position.xz;

      vec3 rand = hash31(instanceFeatureAttribute);

      // Set random position for all particles
      // The hash function space is not high resolution so offset particles by an additional random value
      // This creates grids of 1000 particles which are shifted by random hundreths of the tile width
      // overlaying multiple identical but offset grids
      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;

      // Random orientation of rain drops
      float angle = 3.1415 * hash11(instanceFeatureAttribute);

      vec3 up = vec3(0, 0, 1);

      // Gravity and wind direction
      vec3 direction = normalize(cameraPosition);

      vec3 tangent = normalize(cross(direction, up));

      // Gravity
      vec3 animatedPos = randomPosition + direction * -time;

      // Rain particles fall straight down and are randomly oriented
      // Snow particles have random sinusoid trajectories and are rotated to face the camera
      ${t.type===iy.Rain?w`
            // Random rotation for particle
            vec3 rotationAxis = up;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));
            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);

            // Rotate particle to planetary position
            rotationAxis = tangent;
            angle = 0.5 * -acos(dot(direction, up));
            quat = vec4(rotationAxis * sin(angle), cos(angle));
            transformedPos = rotateVectorByQuaternion(transformedPos, quat);

            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * pos;
      `:w`
            vec3 rotationAxis = direction;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));

            tangent = rotateVectorByQuaternion(tangent, quat);
            // Random sinusoid from friction
            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));
            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);
      `}
    }
  `),e.fragment.uniforms.add([new Pe("opacity",r=>r.opacity),new qt("particleColor",(r,i)=>CYe(i,t))]),e.fragment.code.add(w`
    void main() {

      // Cut off corners of the triangle
      if(vUv.x < 0.0 || vUv.y < 0.0){
        discard;
      }

      float d = length(vUv - vec2(0.5));

      ${t.type===iy.Rain?w`d = 0.35 * smoothstep(0.5, 0.0, d);`:w`d = smoothstep(0.5, 0.1, d);`}
      gl_FragColor = opacity * vec4(particleColor * d, d);
    }
  `),e}function EYe(t,e){const r=e.camera.eye,i=.5*t.width,s=1/t.width,n=Jhe(gj,ce(gj,(r[0]+i)*s,(r[1]+i)*s,(r[2]+i)*s));return to(n,r,ae(n,n,t.width))}function CYe(t,e){const r=e.type===iy.Rain?RYe:AYe,i=ae(gj,r,OYe),s=t.camera.eye;_e(Cie,s);const n=Math.max(0,ye(Cie,t.lighting.mainLight.direction));return Ys(i,i,r,n)}const gj=M(),Cie=M(),AYe=$e(1,1,1),RYe=$e(.85,.85,.85),OYe=.7,MYe=Object.freeze(Object.defineProperty({__proto__:null,build:SYe},Symbol.toStringTag,{value:"Module"}));let PYe=class extends pi{constructor(){super(...arguments),this.time=0,this.radius=1,this.width=500,this.opacity=1}},yj=class ube extends Vr{initializeProgram(e){return new Fr(e.rctx,ube.shader.get().build(this.configuration),aD)}initializePipeline(){return Bt({blending:kn(Ee.ONE,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),depthTest:{func:Mi.LEQUAL},colorWrite:Kt})}};yj.shader=new Nr(MYe,()=>te(()=>import("./Precipitation.glsl-67581d56.js"),[]));const aD=new Map([[A.POSITION,0],[A.INSTANCEFEATUREATTRIBUTE,1]]);let hbe=class{constructor(){this.enabled=!0,this._time=0}get time(){return this._time}advance({deltaTime:e,fixedTime:r}){return v(r)?this._time!==r&&(this._time=r,!0):(this._time=this._time+e,e!==0)}},IYe=class{constructor(e,r){this.deltaTime=e,this.fixedTime=r}},eb=class extends Te{constructor(e){super(e),this._numParticles=25e4,this._rainSpeed=.1,this._snowSpeed=.01,this._passParameters=new PYe,this._animation=new hbe,this._updatingTracking=new Hf,this._passParameters.time=0,this._passParameters.radius=Jr(e.view.spatialReference).radius,this._techniqueRepository=e.context.techniqueRepository}destroy(){this._updatingTracking.destroy(),this._numParticles=0,this._snowTechniqueCached=Bi(this._snowTechniqueCached),this._rainTechniqueCached=Bi(this._rainTechniqueCached),this._vao=Qe(this._vao),this._instanceIdBuffer=Qe(this._instanceIdBuffer)}get updating(){return this._updatingTracking.updating}get _rainTechnique(){if(C(this._rainTechniqueCached)){const e=new mj;e.type=iy.Rain,this._rainTechniqueCached=this._techniqueRepository.acquire(yj,e)}return this._rainTechniqueCached}get _snowTechnique(){if(C(this._snowTechniqueCached)){const e=new mj;e.type=iy.Snow,this._snowTechniqueCached=this._techniqueRepository.acquire(yj,e)}return this._snowTechniqueCached}update(e){return this._animation.advance(e)}render(e,r,i){var l;const s=i==="rainy"?this._rainTechnique:this._snowTechnique;if(!s.compiled)return void this.context.requestRender();const n=e.rctx;if(this._ensureResources(n),C(s)||C(this._vao)||C(this._instanceIdBuffer)||(v(e.bindParameters.cloudsFade.data)&&(this._passParameters.opacity=1-e.bindParameters.cloudsFade.fadeInOutHeight.factor),this._passParameters.opacity<=0))return;const o=.35;r=r<.5?Ft(0,o,2*r):Ft(o,1,2*(r-.5)),this._passParameters.time=(i==="rainy"?this._rainSpeed:this._snowSpeed)*ZH(this._animation.time)%1e5;const a=n.bindTechnique(s,this._passParameters,e.bindParameters);n.bindVAO(this._vao),a.assertCompatibleVertexAttributeLocations(this._vao),iY(n,aD,this._instanceIdBuffer,Aie,0),(l=n.capabilities.instancing)==null||l.drawArraysInstanced($t.TRIANGLES,0,3,this._numParticles*r),sY(n,aD,this._instanceIdBuffer,Aie)}_ensureResources(e){C(this._vao)&&(this._vao=this._createVertexArrayObject(e)),C(this._instanceIdBuffer)&&(this._instanceIdBuffer=this._createInstanceIndices(e))}_createInstanceIndices(e){const r=[];for(let i=0;i<this._numParticles;i++)r.push(i);return jr.createVertex(e,Lr.STATIC_DRAW,new Float32Array(r))}_createVertexArrayObject(e){const r=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new Sp(e,aD,{geometry:Vc($Ye)},{geometry:jr.createVertex(e,Lr.STATIC_DRAW,r)})}};u([d({constructOnly:!0})],eb.prototype,"context",void 0),u([d({constructOnly:!0})],eb.prototype,"view",void 0),u([d({readOnly:!0})],eb.prototype,"updating",null),u([d()],eb.prototype,"_updatingTracking",void 0),eb=u([I("esri.views.3d.environment.Precipitation")],eb);const $Ye=ts().vec3f(A.POSITION),Aie=Vc(ts().f32(A.INSTANCEFEATUREATTRIBUTE),1),LYe=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]),JP=128,Rie=-_G,Oie=0,x8=50,DYe=()=>1-511/512,NYe=vL([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);let FYe=class{constructor(e,r){this.view=e,this.type=An.Simple,this._passParameters=new wY,this._vaoCount=0,this._texV1=1,this._isMars=fm(e.spatialReference);const i=Jr(e.spatialReference);this._planetRadius=i.radius,this._outerRimWidth=i.outerAtmosphereRimWidth,this._innerRimFactor=(this._planetRadius+Rie)/this._planetRadius,this._middleRimFactor=(this._planetRadius+Oie)/this._planetRadius,this._outerRimFactor=(this._planetRadius+this._outerRimWidth)/this._planetRadius,this._texV0=Oie/this._outerRimWidth,this._texVScale=this._texV1-this._texV0,this._techniqueRepository=r.techniqueRepository;const s=r.renderContext.rctx;this._cameraChangeHandle=ie(()=>{var a;return(a=this.view.state)==null?void 0:a.camera},()=>r.requestRender(),js),this._vao=this._createRibbon(s),this._vaoCount=Wo(this._vao,"geometry"),this._fadeVao=Aa(s),this._fadeVaoCount=Wo(this._fadeVao,"geometry");const n=this._isMars?LYe:V1e;this._passParameters.texture=new ct(s,{pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Rt.CLAMP_TO_EDGE,samplingMode:tt.LINEAR,flipped:!0,width:1,height:512},n);const o=new bY;o.geometry=um.Cone,this._coneTechnique=this._techniqueRepository.acquire(sF,o),o.geometry=um.Underground,this._undergroundTechnique=this._techniqueRepository.acquire(sF,o)}destroy(){this._coneTechnique.release(),this._undergroundTechnique.release(),this._cameraChangeHandle.remove(),this._passParameters.texture=Qe(this._passParameters.texture),this._fadeVao.dispose(),this._vao.dispose()}render(e){const r=e.bindParameters.camera;this._update(r);const i=e.rctx;this._passParameters.undergroundFadeAlpha<1&&(i.bindTechnique(this._coneTechnique,this._passParameters,e.bindParameters),i.bindVAO(this._vao),i.drawArrays($t.TRIANGLES,0,this._vaoCount)),this._passParameters.undergroundFadeAlpha>0&&(i.bindTechnique(this._undergroundTechnique,this._passParameters,e.bindParameters),i.bindVAO(this._fadeVao),i.drawArrays($t.TRIANGLE_STRIP,0,this._fadeVaoCount))}renderHaze(){}_update(e){const r=M(),i=this._planetRadius,s=Me(e.eye),n=s-i;if(n<0){const m=Math.min(-n/5e3,1);this._passParameters.undergroundFadeAlpha=m}else this._passParameters.undergroundFadeAlpha=0;const o=Math.max(x8,n),a=i+Rie;this._passParameters.innerScale=UYe(i+o,i,a)-1,this._passParameters.altitudeFade=QX(n),ae(r,e.eye,(i+x8)/s),Mie(r,e.center,e.up,i,this._passParameters.silhouette);const l=this._computeScreenRimWidth(e,r,e.up,this._passParameters.silhouette),c=DYe(),h=NYe(n);let p=this._texV0+c*this._texVScale,f=this._texV0+l*h*this._texVScale;if(n>x8){Mie(e.eye,e.center,e.up,i,this._passParameters.silhouette);const m=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),y=ge((m-1.5)/(l-1.5),0,1);p=this._texV0+y*c*this._texVScale,f=this._texV0+Ft(this._texV1,l*h,y)*this._texVScale}or(this._passParameters.texV,p,f)}_createRibbon(e){const r=Ws(3+3*JP*3),i=new Uint32Array(3*JP*5);r[0]=0,r[1]=0,r[2]=-1;for(let o=0;o<JP;o++){const a=9*o+3;r[a+0]=o,r[a+1]=this._innerRimFactor,r[a+2]=-1,r[a+3]=o,r[a+4]=this._middleRimFactor,r[a+5]=0,r[a+6]=o,r[a+7]=this._outerRimFactor,r[a+8]=1;const l=3*o+1,c=o===JP-1?1:l+3,h=15*o;i[h+0]=l,i[h+1]=l+1,i[h+2]=c+1,i[h+3]=c+1,i[h+4]=c,i[h+5]=l,i[h+6]=l+1,i[h+7]=l+2,i[h+8]=c+2,i[h+9]=c+2,i[h+10]=c+1,i[h+11]=l+1,i[h+12]=l,i[h+13]=c,i[h+14]=0}const s=Pie.createBuffer(i.length),n=s.position;for(let o=0;o<i.length;++o){const a=3*i[o];n.set(o,0,r[a]),n.set(o,1,r[a+1]),n.set(o,2,r[a+2])}return new Sp(e,Rr,{geometry:Vc(Pie)},{geometry:jr.createVertex(e,Lr.STATIC_DRAW,s.buffer)})}_computeScreenRimWidth(e,r,i,s){return fe(wx,s.center,s.v2),ae(KP,wx,this._outerRimFactor),L4(T8,r,wx,i),vie(wx,T8,e.projectionMatrix,e.viewport,wx),vie(KP,T8,e.projectionMatrix,e.viewport,KP),xi(wx,KP)/e.height}};function Mie(t,e,r,i,s){const n=Me(t),o=i*Math.sqrt(n*n-i*i)/n,a=Math.sqrt(i*i-o*o),l=s.v1,c=s.v2;return ae(s.center,t,a/n),pt(l,t,e),ua(l)<1&&pt(l,t,r),ae(l,l,o/Me(l)),pt(c,l,t),ae(c,c,o/Me(c)),o}const T8=Ie(),wx=M(),KP=M();function UYe(t,e,r){return t*t/(Math.sqrt(t*t-e*e)*Math.sqrt(t*t-r*r)+e*r)}const Pie=ts().vec3f(A.POSITION);let dbe=class pbe extends Vr{initializeProgram(e){return new Fr(e.rctx,pbe.shader.get().build(this.configuration),Rr)}initializePipeline(){return Bt({blending:kn(Ee.ONE,Ee.ZERO,Ee.ONE_MINUS_SRC_COLOR,Ee.ONE),colorWrite:Kt})}};dbe.shader=new Nr($1e,()=>te(()=>import("./FogHaze.glsl-96a47659.js"),[]));const kYe=.7,VYe=1;let m3=class extends Te{constructor(e){super(e),this._passParameters=new _Y;const r=e.context.renderContext.rctx;this._vao=Aa(r,kE);const i=Jr(e.view.spatialReference);this._planetRadius=i.radius,this._atmosphereRadius=i.radius+uO;const s=new vY;s.haze=!0,this._hazeTechnique=e.context.techniqueRepository.acquire(dbe,s)}destroy(){this._hazeTechnique.release(),this._vao.dispose()}set strength(e){this._passParameters.hazeStrength=e}get strength(){return this._passParameters.hazeStrength}render(e,r){if(this.view.basemapTerrain.baseOpacity===0||(this._update(e,r),this._passParameters.hazeAmount<=0))return;const i=this._hazeTechnique;if(!i.compiled)return void this.context.requestRender();const s=e.offscreenRenderingHelper;s.renderDepthDetached(()=>{this._passParameters.depthTexture=s.depthTexture;const n=e.rctx.bindTechnique(i,this._passParameters,e.bindParameters);this._renderSimpleHaze(n,e)})}_renderSimpleHaze(e,r){const i=r.rctx;i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays($t.TRIANGLE_STRIP,0,4)}_update(e,r){const i=e.bindParameters.camera;_e(Iie,i.eye);const s=Math.max(0,ye(Iie,e.bindParameters.lighting.mainLight.direction)),n=zYe;ae($ie,n,0),Ys(this._passParameters.hazeColor,$ie,n,s);const o=Me(i.eye),a=o*o;this._passParameters.atmosphereC=a-this._atmosphereRadius*this._atmosphereRadius,this._passParameters.hazeAmount=(1-CS(kYe*_h,VYe*_h,Math.abs(o-this._planetRadius)))*r.amount,this._passParameters.fogStrength=r.strength}static isSupported(e){return e.capabilities.depthTexture}};u([d({constructOnly:!0})],m3.prototype,"context",void 0),u([d({constructOnly:!0})],m3.prototype,"view",void 0),m3=u([I("esri.views.3d.environment.SimpleHaze")],m3);let BYe=class{constructor(){this.strength=0,this.amount=0}};const zYe=$e(.24,.44,.8),Iie=M(),$ie=M();function IY(t){const e=w`vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`,r=w`vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`;t.vertex.code.add(e),t.vertex.code.add(r),t.fragment.code.add(e),t.fragment.code.add(r)}function GYe(){const t=new Dr;return t.attributes.add(A.POSITION,"vec3"),t.attributes.add(A.COLOR,"vec4"),t.attributes.add(A.SIZE,"float"),t.varyings.add("vcolor","vec4"),t.varyings.add("vsize","float"),t.vertex.uniforms.add([new Hi("transform",(e,r)=>jYe(e,r)),new pr("viewport",(e,r)=>r.camera.fullViewport),new Pe("pixelRatio",(e,r)=>r.camera.pixelRatio)]),t.include(IY),t.vertex.code.add(w`void main(void) {
vec4 posProj = transform * vec4(position, 0);
gl_Position = alignToPixelCenter(posProj, viewport.zw);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;
}`),t.fragment.code.add(w`void main() {
float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
gl_FragColor = vec4(vcolor.xyz, intensity);
}`),t}function jYe(t,e){return Fn(Vy,e.camera.projectionMatrix),Vy[10]=24e-8-1,Vy[11]=-1,Vy[14]=(24e-8-2)*e.camera.near,gs(Vy,Vy,e.camera.viewMatrix),gs(Vy,Vy,t.modelMatrix)}const Vy=Ie(),HYe=Object.freeze(Object.defineProperty({__proto__:null,build:GYe},Symbol.toStringTag,{value:"Module"}));let qYe=class extends pi{constructor(){super(...arguments),this.modelMatrix=Ie()}},fbe=class mbe extends Vr{constructor(e){super(e,new Ca,()=>this.destroy())}initializeProgram(e){return new Fr(e.rctx,mbe.shader.get().build(),Rr)}initializePipeline(){return Bt({blending:kn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),depthTest:{func:Mi.LEQUAL},colorWrite:Kt})}};fbe.shader=new Nr(HYe,()=>te(()=>import("./Stars.glsl-b2f0c206.js"),[]));let j0=class extends Te{get updating(){return this._updatingTracking.updating||this.loading}get loading(){return v(this._loadDataTask)&&!this._loadDataTask.finished}constructor(e){super(e),this._loadDataTask=null,this._numPoints=0,this._renderParameter=new qYe,this._updatingTracking=new Hf}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){this._loadDataTask=Fh(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=Bi(this._technique),this._vao=Qe(this._vao)}render(e){const{rctx:r}=e;if(this._ensureResources(r),C(this._technique)||C(this._vao))return;if(!this._technique.compiled)return void this.requestRender();const i=r.bindTechnique(this._technique,this._renderParameter,e.bindParameters);r.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays($t.POINTS,0,this._numPoints)}_ensureResources(e){if(v(this._technique)||C(xx))return;this._technique=new fbe({rctx:e,viewingMode:this.view.state.viewingMode}),this._numPoints=xx.byteLength/Lie;const r=new Float32Array(xx,0,2*this._numPoints),i=new Uint8Array(xx,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(e,r,i,this._numPoints),this._updatingTracking.add(()=>this.view.environment.lighting.type!=="virtual"?this.view.environment.lighting.date:null,s=>this._update(s),Vt)}_computeDayDuration(e){const r=e,i=new Date(e.getFullYear(),0,1,11,58,56);return(+r-+i)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+i)}_update(e){if(!e)return;const r=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,i=2*this._computeDayDuration(e),s=Fn(this._renderParameter.modelMatrix,YYe);DS(s,s,-i*Math.PI),gs(s,XYe,s),DS(s,s,-r*Math.PI),this.requestRender()}_hexToRGB(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]}_unpackUint8Attributes(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}_createVertexArrayObject(e,r,i,s){const n=Die.createBuffer(s),o=n.position,a=n.color,l=n.size;for(let c=0;c<s;c++){const h=r[2*c+0],p=r[2*c+1];o.set(c,0,-Math.cos(h)*Math.sin(p)),o.set(c,1,-Math.sin(h)*Math.sin(p)),o.set(c,2,-Math.cos(p));const f=this._unpackUint8Attributes(i[c]),m=this._hexToRGB(WYe[f[1]]);a.set(c,0,255*m[0]),a.set(c,1,255*m[1]),a.set(c,2,255*m[2]),a.set(c,3,255),l.set(c,f[0])}return new Sp(e,Rr,{geometry:Vc(Die)},{geometry:jr.createVertex(e,Lr.STATIC_DRAW,n.buffer)})}_createLoadDataTask(){if(v(xx))return null;const e=YO(async r=>{const{data:i}=await mMe("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:r});this._verifyStarData(i),xx=i});return e.promise.catch(r=>{Qs(r)||se.getLogger(this.declaredClass).error(r)}).then(()=>{this.destroyed||(this.requestRender(),this.notifyChange("updating"))}),e}_verifyStarData(e){if(!e)throw new q("stars:no-data-received","Failed to create stars because star catalogue is missing");const r=e.byteLength/Lie;if(r%1!=0||r>5e4||r<5e3)throw new q("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}};u([d({constructOnly:!0})],j0.prototype,"view",void 0),u([d({constructOnly:!0})],j0.prototype,"requestRender",void 0),u([d({readOnly:!0})],j0.prototype,"updating",null),u([d()],j0.prototype,"_loadDataTask",void 0),u([d()],j0.prototype,"_updatingTracking",void 0),j0=u([I("esri.views.3d.environment.Stars")],j0);const WYe=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],XYe=EW(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),YYe=EW(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),Lie=9,Die=ts().vec3f(A.POSITION).vec4u8(A.COLOR).f32(A.SIZE);let xx=null;function ZYe(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}function aF(t,e,r){r*=.5;const i=Math.sin(r);return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=Math.cos(r),t}function $Y(t,e){const r=2*Math.acos(e[3]),i=Math.sin(r/2);return i>Sa()?(t[0]=e[0]/i,t[1]=e[1]/i,t[2]=e[2]/i):(t[0]=1,t[1]=0,t[2]=0),r}function LY(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=r[0],l=r[1],c=r[2],h=r[3];return t[0]=i*h+o*a+s*c-n*l,t[1]=s*h+o*l+n*a-i*c,t[2]=n*h+o*c+i*l-s*a,t[3]=o*h-i*a-s*l-n*c,t}function JYe(t,e,r){r*=.5;const i=e[0],s=e[1],n=e[2],o=e[3],a=Math.sin(r),l=Math.cos(r);return t[0]=i*l+o*a,t[1]=s*l+n*a,t[2]=n*l-s*a,t[3]=o*l-i*a,t}function KYe(t,e,r){r*=.5;const i=e[0],s=e[1],n=e[2],o=e[3],a=Math.sin(r),l=Math.cos(r);return t[0]=i*l-n*a,t[1]=s*l+o*a,t[2]=n*l+i*a,t[3]=o*l-s*a,t}function QYe(t,e,r){r*=.5;const i=e[0],s=e[1],n=e[2],o=e[3],a=Math.sin(r),l=Math.cos(r);return t[0]=i*l+s*a,t[1]=s*l-i*a,t[2]=n*l+o*a,t[3]=o*l-n*a,t}function eZe(t,e){const r=e[0],i=e[1],s=e[2];return t[0]=r,t[1]=i,t[2]=s,t[3]=Math.sqrt(Math.abs(1-r*r-i*i-s*s)),t}function lD(t,e,r,i){const s=e[0],n=e[1],o=e[2],a=e[3];let l,c,h,p,f,m=r[0],y=r[1],_=r[2],b=r[3];return c=s*m+n*y+o*_+a*b,c<0&&(c=-c,m=-m,y=-y,_=-_,b=-b),1-c>Sa()?(l=Math.acos(c),h=Math.sin(l),p=Math.sin((1-i)*l)/h,f=Math.sin(i*l)/h):(p=1-i,f=i),t[0]=p*s+f*m,t[1]=p*n+f*y,t[2]=p*o+f*_,t[3]=p*a+f*b,t}function tZe(t){const e=JO,r=e(),i=e(),s=e(),n=Math.sqrt(1-r),o=Math.sqrt(r);return t[0]=n*Math.sin(2*Math.PI*i),t[1]=n*Math.cos(2*Math.PI*i),t[2]=o*Math.sin(2*Math.PI*s),t[3]=o*Math.cos(2*Math.PI*s),t}function rZe(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=r*r+i*i+s*s+n*n,a=o?1/o:0;return t[0]=-r*a,t[1]=-i*a,t[2]=-s*a,t[3]=n*a,t}function Iw(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t}function gbe(t,e){const r=e[0]+e[4]+e[8];let i;if(r>0)i=Math.sqrt(r+1),t[3]=.5*i,i=.5/i,t[0]=(e[5]-e[7])*i,t[1]=(e[6]-e[2])*i,t[2]=(e[1]-e[3])*i;else{let s=0;e[4]>e[0]&&(s=1),e[8]>e[3*s+s]&&(s=2);const n=(s+1)%3,o=(s+2)%3;i=Math.sqrt(e[3*s+s]-e[3*n+n]-e[3*o+o]+1),t[s]=.5*i,i=.5/i,t[3]=(e[3*n+o]-e[3*o+n])*i,t[n]=(e[3*n+s]+e[3*s+n])*i,t[o]=(e[3*o+s]+e[3*s+o])*i}return t}function iZe(t,e,r,i){const s=.5*Math.PI/180;e*=s,r*=s,i*=s;const n=Math.sin(e),o=Math.cos(e),a=Math.sin(r),l=Math.cos(r),c=Math.sin(i),h=Math.cos(i);return t[0]=n*l*h-o*a*c,t[1]=o*a*h+n*l*c,t[2]=o*l*c-n*a*h,t[3]=o*l*h+n*a*c,t}function sZe(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}const DY=Xd,nZe=ti,oZe=Iq,aZe=LY,lZe=_E,cZe=ode,uZe=p4,ybe=$q,hZe=ybe,_be=Lq,dZe=_be,NY=nde,pZe=j2,fZe=Dq;function mZe(t,e,r){const i=ye(e,r);return i<-.999999?(pt(Ip,gZe,e),mc(Ip)<1e-6&&pt(Ip,yZe,e),_e(Ip,Ip),aF(t,Ip,Math.PI),t):i>.999999?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(pt(Ip,e,r),t[0]=Ip[0],t[1]=Ip[1],t[2]=Ip[2],t[3]=1+i,NY(t,t))}const Ip=M(),gZe=$e(1,0,0),yZe=$e(0,1,0);function _Ze(t,e,r,i,s,n){return lD(Nie,e,s,n),lD(Fie,r,i,n),lD(t,Nie,Fie,2*n*(1-n)),t}const Nie=Zh(),Fie=Zh();function vZe(t,e,r,i){const s=bZe;return s[0]=r[0],s[3]=r[1],s[6]=r[2],s[1]=i[0],s[4]=i[1],s[7]=i[2],s[2]=-e[0],s[5]=-e[1],s[8]=-e[2],NY(t,gbe(t,s))}const bZe=es();Object.freeze(Object.defineProperty({__proto__:null,add:oZe,calculateW:eZe,conjugate:Iw,copy:DY,dot:cZe,equals:fZe,exactEquals:pZe,fromEuler:iZe,fromMat3:gbe,getAxisAngle:$Y,identity:ZYe,invert:rZe,len:hZe,length:ybe,lerp:uZe,mul:aZe,multiply:LY,normalize:NY,random:tZe,rotateX:JYe,rotateY:KYe,rotateZ:QYe,rotationTo:mZe,scale:lZe,set:nZe,setAxes:vZe,setAxisAngle:aF,slerp:lD,sqlerp:_Ze,sqrLen:dZe,squaredLength:_be,str:sZe},Symbol.toStringTag,{value:"Module"}));function OM(t=xZe){return[t[0],t[1],t[2],t[3]]}function HAt(t,e,r=OM()){return le(r,t),r[3]=e,r}function Uie(t,e,r=OM()){return pt(r,t,e),_e(r,r),r[3]=-ede(t,e),r}function qAt(t,e,r=OM()){return aF(QP,t,kie(t)),aF(Vie,e,kie(e)),LY(QP,Vie,QP),wZe(r,rl($Y(r,QP)))}function WAt(t){return t}function kie(t){return Gt(t[3])}function wZe(t,e){return t[3]=e,t}const xZe=[0,0,1,0],QP=Zh(),Vie=Zh();OM();function TZe(t,e,r){const i=t.parallax.anchorPointClouds;t.fadeIn.stage===vc.FINISHED&&(t.fadeIn.factor=0,le(i,$f),t.fadeIn.stage=vc.CHANGE_ANCHOR,t.crossFade.enabled=!1,t.fadeInOut.stage=Rn.FINISHED),t.fadeIn.stage===vc.CHANGE_ANCHOR&&t.isCameraPositionFinal&&(uY(t.data)&&t.renderingStage!==Is.RENDERING||t.renderingStage===Is.FADING_TEXTURE_CHANNELS)&&(le(i,$f),t.fadeIn.stage=vc.FADE_IN,t.startTime=e,t.renderingStage===Is.FADING_TEXTURE_CHANNELS&&(t.renderingStage=Is.SWITCH_CHANNELS)),t.fadeIn.factor<1&&t.fadeIn.stage===vc.FADE_IN?t.fadeIn.factor=r?ge((e-t.startTime)/(vbe*r),0,1):1:t.fadeIn.factor>=1&&t.fadeIn.stage===vc.FADE_IN&&(t.fadeIn.stage=vc.FINISHED,t.fadeIn.factor=1)}function SZe(t,e,r){const{fadeInOut:i,crossFade:s}=t;i.stage===Rn.FINISHED&&(t.startTime=e,i.factor=1,i.stage=Rn.FADE_OUT),i.factor>0&&i.stage===Rn.FADE_OUT?i.factor=r?1-ge((e-t.startTime)/(OZe*r),0,1):0:(i.factor<=0&&i.stage===Rn.FADE_OUT&&(i.factor=0,le(t.parallax.anchorPointClouds,$f)),i.factor<=0&&i.stage===Rn.FADE_OUT&&t.isCameraPositionFinal&&(i.factor=0,i.stage=Rn.SWITCH,t.crossFade.enabled=!1,s.factor=1),i.stage===Rn.SWITCH&&(uY(t.data)&&t.renderingStage!==Is.RENDERING||t.renderingStage===Is.FADING_TEXTURE_CHANNELS)&&(t.startTime=e,i.factor=0,i.stage=Rn.FADE_IN,le(t.parallax.anchorPointClouds,$f),t.crossFade.enabled=!1,s.factor=1,t.renderingStage===Is.FADING_TEXTURE_CHANNELS&&(t.renderingStage=Is.SWITCH_CHANNELS)),i.factor<1&&i.stage===Rn.FADE_IN?i.factor=r?ge((e-t.startTime)/(vbe*r),0,1):1:i.factor>=1&&i.stage===Rn.FADE_IN&&(i.stage=Rn.FINISHED,i.factor=1))}function EZe(t,e,r,i){const{crossFade:s}=t,n=t.parallax.anchorPointClouds;t.crossFade.enabled&&!i||(le(t.parallaxNew.anchorPointClouds,$f),t.startTime=e,s.factor=0,t.crossFade.enabled=!0),s.factor<1&&t.crossFade.enabled?s.factor=r?ge((e-t.startTime)/(MZe*r),0,1):1:s.factor>=1&&t.crossFade.enabled&&(t.crossFade.enabled=!1,s.factor=1,le(n,t.parallaxNew.anchorPointClouds),t.renderingStage===Is.FADING_TEXTURE_CHANNELS&&(t.renderingStage=Is.SWITCH_CHANNELS))}function Bie(t,e,r,i){const s=t.fadeInOutHeight,n=s.stage===tv.FINISHED?r:t.startTimeHeightFade;if(i!==0){const o=(r-n)/(PZe*i);s.factor+=e?-o:o}else s.factor=e?0:1;t.startTimeHeightFade=r,s.factor=ge(s.factor,0,1),s.stage=tv.HEIGHT_FADE}function CZe(t,e,r,i,s){t.renderingStage===Is.FINISHED_RENDERING&&(t.renderingStage=Is.FADING_TEXTURE_CHANNELS);const n=Me(e.eye);t.fadeInOutHeight.factor<0&&(t.fadeInOutHeight.factor=n-wr.radius>_h?1:0),t.isCameraPositionFinal=q_(t.cameraPositionLastFrame,e.eye),_e($f,e.eye),ae($f,$f,wr.radius);const o=t.parallax;o.anchorPointClouds[0]===0&&o.anchorPointClouds[1]===0&&o.anchorPointClouds[2]===0&&le(o.anchorPointClouds,$f);const a=Me(me(RZe,o.anchorPointClouds,$f));let l=!0;a>t.fadeIn.distanceThresholdFactor*o.cloudsHeight||t.fadeIn.stage!==vc.FINISHED?TZe(t,i,s):a>t.fadeInOut.distanceThresholdFactor*o.cloudsHeight||t.fadeInOut.stage!==Rn.FINISHED?SZe(t,i,s):a>t.crossFade.distanceThresholdFactor*o.cloudsHeight||t.crossFade.enabled||t.renderingStage===Is.FADING_TEXTURE_CHANNELS?EZe(t,i,s,(r!==Sr.IDLE||!uY(t.data))&&t.renderingStage!==Is.FADING_TEXTURE_CHANNELS):l=!1;const c=n-wr.radius;if((c>1.7*_h||c<-_h)&&t.fadeInOutHeight.factor<1?t.fadeInOutHeight.factor=1:(c>_h||c<-.35*_h)&&t.fadeInOutHeight.factor<1?Bie(t,!1,i,s):c<_h&&c>-.35*_h&&t.fadeInOutHeight.factor>0?Bie(t,!0,i,s):t.fadeInOutHeight.stage=tv.FINISHED,t.renderingStage===Is.SWITCH_CHANNELS&&(t.readChannels=1-t.readChannels,t.renderingStage=Is.FINISHED),o.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(n*n-wr.radius*wr.radius,0))/n,Uie(zie,o.anchorPointClouds,Tx),Rc(o.transform,Lu,Tx[3],Tx),l){const{parallaxNew:h}=t;Uie(zie,h.anchorPointClouds,Tx),Rc(h.transform,Lu,Tx[3],Tx)}le(t.cameraPositionLastFrame,e.eye)}function AZe(t){return t.crossFade.enabled||t.fadeInOut.stage!==Rn.FINISHED||t.fadeIn.stage!==vc.FINISHED||t.fadeInOutHeight.stage!==tv.FINISHED||t.renderingStage!==Is.FINISHED}const zie=$e(0,0,1),Tx=OM(),$f=M(),RZe=M(),vbe=1,OZe=.5,MZe=1.3,PZe=1;let BE=class{constructor(){this._outer=new Map}clear(){this._outer.clear()}get empty(){return this._outer.size===0}get(e,r){var i;return(i=this._outer.get(e))==null?void 0:i.get(r)}set(e,r,i){const s=this._outer.get(e);s?s.set(r,i):this._outer.set(e,new Map([[r,i]]))}delete(e,r){const i=this._outer.get(e);i&&(i.delete(r),i.size===0&&this._outer.delete(e))}forEach(e){this._outer.forEach((r,i)=>e(r,i))}};var Bs;function Gie(t=de("enable-feature:high-quality-idle")){const e=new BE;return t&&(e.set(Sr.INTERACTING,Bs.Antialiasing,!0),e.set(Sr.IDLE,Bs.Antialiasing,!0),e.set(Sr.INTERACTING,Bs.HighQualityTransparency,!0),e.set(Sr.IDLE,Bs.HighQualityTransparency,!0),e.set(Sr.INTERACTING,Bs.RealisticAtmosphere,!0),e.set(Sr.IDLE,Bs.RealisticAtmosphere,!0),e.set(Sr.IDLE,Bs.SSAO,!0),e.set(Sr.IDLE,Bs.WaterReflection,!0),e.set(Sr.IDLE,Bs.PhysicalPixelRendering,!0)),e.set(Sr.ANIMATING,Bs.ShadowMapUpdate,!0),e.set(Sr.INTERACTING,Bs.ShadowMapUpdate,!0),e.set(Sr.IDLE,Bs.ShadowMapUpdate,!0),e.set(Sr.IDLE,Bs.HighQualityVoxel,!0),e}(function(t){t[t.Antialiasing=0]="Antialiasing",t[t.HighQualityTransparency=1]="HighQualityTransparency",t[t.HighQualityVoxel=2]="HighQualityVoxel",t[t.RealisticAtmosphere=3]="RealisticAtmosphere",t[t.SSAO=4]="SSAO",t[t.WaterReflection=5]="WaterReflection",t[t.ShadowMapUpdate=6]="ShadowMapUpdate",t[t.PhysicalPixelRendering=7]="PhysicalPixelRendering"})(Bs||(Bs={}));var aS;(function(t){t[t.Immediate=0]="Immediate",t[t.Faded=1]="Faded"})(aS||(aS={}));var g3;const IZe=[Se.POSTPROCESSING_ENVIRONMENT_OPAQUE,Se.POSTPROCESSING_ENVIRONMENT_TRANSPARENT];let Hn=g3=class extends Te{constructor(t){super(t),this._context=null,this._atmosphere=null,this._hqAtmosphere=null,this._oldWeatherParameters=new S8,this._newWeatherParameters=new S8,this._fadedWeatherParameters=new S8,this._weatherParameters=this._newWeatherParameters}initialize(){this.view._stage.addRenderPlugin(IZe,this)}destroy(){var t;this.removeHandles(),((t=this.view)==null?void 0:t._stage)!=null&&this.view._stage.removeRenderPlugin(this),this._set("view",null)}get atmosphere(){return v(this._hqAtmosphere)&&this.view._stage.renderer.isFeatureEnabled(Bs.RealisticAtmosphere)?this._hqAtmosphere:this._atmosphere}get _atmosphereType(){return v(this.atmosphere)?this.atmosphere.type:An.None}get canRender(){var t;return!!((t=this.view.basemapTerrain)!=null&&t.renderer.canRender)||this.view.viewingMode!=="global"}get needsLinearDepth(){return this._atmosphereType===An.Realistic}updateAnimation(t){return!!v(this._precipitation)&&this._precipitation.update(t)}get updating(){return v(this._stars)&&this._stars.updating||v(this._clouds)&&this._clouds.running}get weatherVisible(){return Me(this.view.state.camera.eye)-Jr(this.view.spatialReference).radius<=_h}get _stars(){var i;const t=this.view,e=((i=t.environment)==null?void 0:i.starsEnabled)??!1,r=this._get("_stars");return!e||C(this._context)?(ke(r),null):v(r)?r:new j0({view:t,requestRender:()=>this._setNeedsRender()})}get _precipitation(){const t=this._get("_precipitation");if(!this._precipitationEnabled||C(this._context))return ke(t),null;const e=this.view,r=this._context;return v(t)&&t.context===r?t:(ke(t),new eb({context:r,view:e}))}get _clouds(){const t=this._get("_clouds");if(!this.weatherEnabled||C(this._context))return ke(t),null;if(v(t))return t;const e=this.view,r=this._context;return ke(t),new El({context:r,view:e,requestRender:()=>this._setNeedsRender()})}get _cloudsComposition(){const t=this._get("_cloudsComposition");if(!this.weatherEnabled||C(this._context))return ke(t),null;const e=this.view.state.viewingMode,r=this._context.renderContext.rctx,i=Jr(this.view.spatialReference).radius;return v(t)&&t.viewingMode===e&&t.planetRadius===i?t:(ke(t),new K1({rctx:r,viewingMode:e,planetRadius:i,requestRender:()=>this._setNeedsRender()}))}get _fog(){const t=this._get("_fog");if(!this.weatherEnabled||C(this._context))return ke(t),null;if(v(t))return t;const e=this.view,r=this._context;return new f3({context:r,view:e})}get _simpleHaze(){const t=this._get("_simpleHaze");if(!this.weatherEnabled||C(this._context))return ke(t),null;if(v(t))return t;const e=this.view,r=this._context;return new m3({context:r,view:e})}get weatherEnabled(){var t,e;return!!((e=(t=this.view)==null?void 0:t.environmentManager)!=null&&e.weatherEnabled)}get _precipitationEnabled(){return this.weatherEnabled&&(this.view.environment.weather.type==="rainy"||this.view.environment.weather.type==="snowy")}initializeRenderContext(t=null){this._context=t;const e=()=>this._setNeedsRender();this.addHandles([_a(()=>{var r;return(r=this.view)==null?void 0:r.basemapTerrain},()=>this._updateBasemapTerrain(),js),ie(()=>({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled,quality:this.view.environment.atmosphere.quality}),r=>this._updateAtmosphere(r),js),ie(()=>this._stars,e),ie(()=>this._precipitation,e),ie(()=>this._clouds,()=>this._updateWeather(),Vt),ie(()=>this._fog,()=>this._updateFogHaze(),Vt),ie(()=>this._simpleHaze,()=>this._updateFogHaze(),Vt),ie(()=>this.view.state.mode,()=>{this._setNeedsRender()},ri),ie(()=>this._atmosphereType,()=>this._updateBasemapTerrain(),js),ie(()=>this._weatherUpdateParameters,()=>{this._updateWeather(),this._updateFogHaze()},js)])}uninitializeRenderContext(){this._context=null,this._atmosphere=ke(this._atmosphere),this._hqAtmosphere=ke(this._hqAtmosphere),this._set("_stars",ke(this._stars)),this._set("_precipitation",ke(this._precipitation)),this._set("_clouds",ke(this._clouds)),this._set("_cloudsComposition",ke(this._cloudsComposition)),this._set("_fog",ke(this._fog)),this._set("_simpleHaze",ke(this._simpleHaze))}prepareRender(t){t.bindParameters.cloudsFade.data=SWe(this._clouds)?this._clouds:null,this.view.viewingMode!=="local"&&(CZe(t.bindParameters.cloudsFade,t.bindParameters.camera,this.view.state.mode,t.time,this.view.qualitySettings.fadeDuration),this._updateWeatherFading(t.bindParameters),t.bindParameters.cloudsFade.renderingStage===Is.FINISHED&&v(this._clouds)&&this._clouds.coverage===0&&this._clouds.running===!1&&(this._clouds.destroyFrameBufferCube(),t.bindParameters.cloudsFade.data=null))}render(t){if(t.output===k.Color)switch(t.bindParameters.slot){case Se.POSTPROCESSING_ENVIRONMENT_OPAQUE:v(this._stars)&&this._stars.render(t),v(this.atmosphere)&&(this.atmosphere.render(t),v(this._cloudsComposition)&&v(t.bindParameters.cloudsFade.data)&&(this.weatherVisible&&v(this._clouds)&&this._clouds.updateWeatherTile(),this._cloudsComposition.render(t)),AZe(t.bindParameters.cloudsFade)&&v(this._context)&&this._context.requestRender());break;case Se.POSTPROCESSING_ENVIRONMENT_TRANSPARENT:if(v(this.atmosphere)&&(this.atmosphere.renderHaze(t,this._weatherParameters.haze.amount),this._weatherParameters.haze.amount>0&&this._atmosphereType!==An.Realistic&&v(this._simpleHaze)&&this._simpleHaze.render(t,this._weatherParameters.haze),this._weatherParameters.fog.amount>0&&v(this._fog)&&this._fog.render(t,this._weatherParameters.fog),v(this._precipitation))){const e=this.view.environment.weather;e.type!=="rainy"&&e.type!=="snowy"||this._precipitation.render(t,e.precipitation,e.type)}}}updateLightSources(t,e,r,i){if(v(this._context)){const s=this._context.renderContext;s.bindParameters.oldLighting.copyFrom(s.bindParameters.lighting),s.bindParameters.newLighting.noonFactor=e,s.bindParameters.newLighting.globalFactor=r,s.bindParameters.newLighting.set(t),i===aS.Faded||s.bindParameters.weatherFading?s.bindParameters.fadeLighting(0):s.bindParameters.fadeLighting(1),this._context.requestRender()}}get _weatherUpdateParameters(){const t=this.weatherEnabled?this.view.environment.weather:null;return C(t)?null:t.type==="rainy"||t.type==="snowy"?{type:t.type,weatherAdjustment:t.cloudCover,effect:t.precipitation}:{type:t.type,weatherAdjustment:t.type==="foggy"?t.fogStrength:t.cloudCover}}_updateWeatherFading(t){if(!t.weatherFading)return;const e=t.cloudsFade;return e.fadeIn.stage===vc.FADE_IN?(t.fadeLighting(e.fadeIn.factor),void this._fadeWeather(e.fadeIn.factor)):e.fadeInOut.stage===Rn.FADE_IN?(t.fadeLighting(e.fadeInOut.factor),void this._fadeWeather(e.fadeInOut.factor)):e.crossFade.enabled?(t.fadeLighting(e.crossFade.factor),void this._fadeWeather(e.crossFade.factor)):(t.fadeLighting(0),void this._fadeWeather(0))}_fadeWeather(t){const{_newWeatherParameters:e,_oldWeatherParameters:r}=this;t>=1?this._weatherParameters=e:(this._fadedWeatherParameters.lerp(r,e,t),this._weatherParameters=this._fadedWeatherParameters)}_updateWeather(){const t=this._weatherUpdateParameters;C(t)||C(this._clouds)||(this._clouds.applyPreset(na[t.type],t.weatherAdjustment),this._setNeedsRender())}_setNeedsRender(){v(this._context)&&this._context.requestRender()}_updateFogHaze(){const t=this._weatherUpdateParameters;if(C(this._fog)||C(this._simpleHaze)||C(t)||C(this._context))return;const e=this._context.renderContext.bindParameters;switch(this._oldWeatherParameters.copyFrom(this._weatherParameters),t.type){case"foggy":this._newWeatherParameters.fog.strength=Ft(3e-5,.005,t.weatherAdjustment**3),le(this._newWeatherParameters.fog.color,jie),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=this._atmosphereType===An.Realistic?1:0,this._setNeedsRender();break;case"rainy":this._newWeatherParameters.fog.strength=Ft(4e-6,2e-4,(t.effect??0)**3),le(this._newWeatherParameters.fog.color,$Ze),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=0,this._setNeedsRender();break;case"snowy":this._newWeatherParameters.fog.strength=Ft(4e-6,2e-4,(t.effect??0)**3),le(this._newWeatherParameters.fog.color,jie),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=this._atmosphereType===An.Realistic?1:0,this._setNeedsRender();break;default:this._newWeatherParameters.fog.strength=0,this._newWeatherParameters.fog.amount=0,this._newWeatherParameters.haze.strength=4e-6,this._newWeatherParameters.haze.amount=1,this._setNeedsRender()}e.weatherFading?this._fadeWeather(0):this._fadeWeather(1)}_updateAtmosphere(t){const e=this._selectAtmosphereType(t);if(v(this._atmosphere)?this._atmosphere.type===e:e===An.None)return;this._atmosphere=ke(this._atmosphere),this._hqAtmosphere=ke(this._hqAtmosphere);const r=this._getAtmosphereClass(e);r&&v(this._context)&&(this._atmosphere=new r(this.view,this._context),e===An.Simple&&(this._hqAtmosphere=new u8(this.view,this._context))),this._setNeedsRender(),this._updateBasemapTerrain()}_getAtmosphereClass(t){switch(t){case An.Realistic:return u8;case An.Panoramic:return xYe;case An.Simple:return FYe;default:case An.None:return null}}_selectAtmosphereType(t){const{enabled:e,quality:r,viewingMode:i}=t;return!e||mm(this.view.spatialReference)?An.None:i===Be.Local?An.Panoramic:v(this._context)&&r==="high"&&u8.isSupported(this._context)&&NR(this.view.spatialReference)?An.Realistic:An.Simple}_updateBasemapTerrain(){this.view.basemapTerrain&&(this.view.basemapTerrain.velvetOverground=this._atmosphereType===An.Simple)}get test(){return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:()=>this._selectAtmosphereType({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled,quality:this.view.environment.atmosphere.quality}),stubGetAtmosphereClass:t=>{Hie=g3.prototype._getAtmosphereClass,g3.prototype._getAtmosphereClass=t},restoreGetAtmosphereClass:()=>{g3.prototype._getAtmosphereClass=Hie}}}};u([d({constructOnly:!0})],Hn.prototype,"view",void 0),u([d({readOnly:!0})],Hn.prototype,"atmosphere",null),u([d({readOnly:!0})],Hn.prototype,"_atmosphereType",null),u([d({type:Boolean,readOnly:!0})],Hn.prototype,"updating",null),u([d({readOnly:!0})],Hn.prototype,"weatherVisible",null),u([d()],Hn.prototype,"_context",void 0),u([d()],Hn.prototype,"_atmosphere",void 0),u([d()],Hn.prototype,"_hqAtmosphere",void 0),u([d({readOnly:!0})],Hn.prototype,"_stars",null),u([d({readOnly:!0})],Hn.prototype,"_precipitation",null),u([d({readOnly:!0})],Hn.prototype,"_clouds",null),u([d({readOnly:!0})],Hn.prototype,"_cloudsComposition",null),u([d({readOnly:!0})],Hn.prototype,"_fog",null),u([d({readOnly:!0})],Hn.prototype,"_simpleHaze",null),u([d({readOnly:!0})],Hn.prototype,"weatherEnabled",null),u([d({readOnly:!0})],Hn.prototype,"_precipitationEnabled",null),u([d({readOnly:!0})],Hn.prototype,"_weatherUpdateParameters",null),Hn=g3=u([I("esri.views.3d.environment.EnvironmentRenderer")],Hn);let S8=class{constructor(){this.fog=new NXe,this.haze=new BYe}copyFrom(e){this.fog.amount=e.fog.amount,this.haze.amount=e.haze.amount,this.fog.strength=e.fog.strength,this.haze.strength=e.haze.strength,le(this.fog.color,e.fog.color)}lerp(e,r,i){this.fog.amount=Ft(e.fog.amount,r.fog.amount,i),this.haze.amount=Ft(e.haze.amount,r.haze.amount,i),this.fog.strength=Ft(e.fog.strength,r.fog.strength,i),this.haze.strength=Ft(e.haze.strength,r.haze.strength,i),Ys(this.fog.color,e.fog.color,r.fog.color,i)}};const $Ze=$e(.5,.5,.5),jie=$e(1.5,1.5,1.5);let Hie;function qie(t,e,r){if(C(e.longitude)||C(e.latitude)||C(r.longitude)||C(r.latitude))throw new Error("Invalid points: no lon/lat");return LZe(t,e.longitude,e.latitude,r.longitude,r.latitude)}function LZe(t,e,r,i,s){const n=Gt(r),o=Gt(s),a=n-o,l=Gt(e)-Gt(i),c=Math.sin(a/2),h=Math.sin(l/2),p=2*Uh(Math.sqrt(c*c+Math.cos(n)*Math.cos(o)*h*h))*t;return Math.round(1e4*p)/1e4}function DZe(t,e,r){const i=e.spatialReference,s=Jr(i),n=new mt(e.x,t.y,i),o=new mt(r.x,t.y,i),a=new mt(t.x,e.y,i),l=new mt(t.x,r.y,i);return{lon:qie(s.radius,n,o),lat:qie(s.radius,a,l)}}function NZe(t,e,r){const i=e/r,s=Gt(t),n=Math.sin(i/2),o=Math.cos(s),a=2*Uh(Math.sqrt(n*n/(o*o)));return rl(a)}function FZe(t,e){let r=t/15;return e||(r=Math.round(r)),r}function Wie(t,e){const r=t==null?void 0:t[0];if(r==null)return null;e||(e={hours:0,minutes:0,seconds:0}),e.hours=FZe(r,!0);const i=e.hours%1;e.hours-=i,e.minutes=60*i;const s=e.minutes%1;return e.minutes-=s,e.seconds=Math.round(60*s),e}var Xie,Yie,Zie,_j={},UZe={get exports(){return _j},set exports(t){_j=t}};Xie=UZe,Yie=function(){var t=Math.PI,e=Math.sin,r=Math.cos,i=Math.tan,s=Math.asin,n=Math.atan2,o=Math.acos,a=t/180,l=864e5,c=2440588,h=2451545,p={dec:0,ra:0};function f($){return $.valueOf()/l-.5+c}function m($){return new Date(($+.5-c)*l)}function y($){return f($)-h}var _=23.4397*a;function b($,N){return n(e($)*r(_)-i(N)*e(_),r($))}function x($,N){return s(e(N)*r(_)+r(N)*e(_)*e($))}function T($,N,F){return n(e($),r($)*e(N)-i(F)*r(N))}function S($,N,F){return s(e(N)*e(F)+r(N)*r(F)*r($))}function E($,N){return a*(280.16+360.9856235*$)-N}function O($){return a*(357.5291+.98560028*$)}function R($){return a*(1.9148*e($)+.02*e(2*$)+3e-4*e(3*$))}function L($,N){return $+N+102.9372*a+t}function P($,N){var F=O($),j=L(F,R(F));return N||(N={dec:0,ra:0}),N.dec=x(j,0),N.ra=b(j,0),N}var U={PolarException:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function($,N,F,j){var X=a*-F,J=a*N,W=y($),ue=P(W,p),pe=E(W,X)-ue.ra;return j||(j={azimuth:0,altitude:0}),j.azimuth=T(pe,J,ue.dec),j.altitude=S(pe,J,ue.dec),j}},B=[[-.83,"sunrise","sunset"]];U.addTime=function($,N,F){B.push([$,N,F])};var z=9e-4;function G($,N){return Math.round($-z-N/(2*t))}function K($,N,F){return z+($+N)/(2*t)+F}function ee($,N,F){return h+$+.0053*e(N)-.0069*e(2*F)}function Q($,N,F){return o((e($)-e(N)*e(F))/(r(N)*r(F)))}function H($){var N=a*(134.963+13.064993*$),F=a*(93.272+13.22935*$),j=a*(218.316+13.176396*$)+6.289*a*e(N),X=5.128*a*e(F),J=385001-20905*r(N);return{ra:b(j,X),dec:x(j,X),dist:J}}return U.getTimes=function($,N,F){var j=a*-F,X=a*N,J=G(y($),j),W=K(0,j,J),ue=O(W),pe=R(ue),we=L(ue,pe),Ce=x(we,0),Ge=ee(W,ue,we);function Le(Qt){return ee(K(Q(Qt,X,Ce),j,J),ue,we)}function xe(Qt){var Xt=(e(Qt)-e(X)*e(Ce))/(r(X)*r(Ce));return Xt<-1?U.PolarException.MIDNIGHT_SUN:Xt>1?U.PolarException.POLAR_NIGHT:U.PolarException.NORMAL}var De,Ue,wt,Ke,Ut,Wt={solarNoon:m(Ge),nadir:m(Ge-.5),polarException:U.PolarException.NORMAL};for(De=0,Ue=B.length;De<Ue;De+=1)Ut=Ge-((Ke=Le((wt=B[De])[0]*a))-Ge),Wt[wt[1]]=m(Ut),Wt[wt[2]]=m(Ke);return Wt.polarException=xe(B[0][0]*a),Wt},U.getMoonPosition=function($,N,F){var j=a*-F,X=a*N,J=y($),W=H(J),ue=E(J,j)-W.ra,pe=S(ue,X,W.dec);return pe+=.017*a/i(pe+10.26*a/(pe+5.1*a)),{azimuth:T(ue,X,W.dec),altitude:pe,distance:W.dist}},U.getMoonFraction=function($){var N=y($),F=P(N),j=H(N),X=149598e3,J=o(e(F.dec)*e(j.dec)+r(F.dec)*r(j.dec)*r(F.ra-j.ra)),W=n(X*e(J),j.dist-X*r(J));return(1+r(W))/2},U},(Zie=Yie())!==void 0&&(Xie.exports=Zie);const $w=_j,Rf={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};function kZe(t,e,r,i,s,n){ce(n.ambient.color,1,1,1),n.ambient.intensity=Rf.global.ambient,ce(n.direct.color,1,1,1),n.direct.intensity=Rf.global.direct;const o=e[2],a=ge((Math.abs(o)-Rf.local.altitude)/(Rf.global.altitude-Rf.local.altitude),0,1);let l;if(n.globalFactor=a,v(t)&&(l=$w.getTimes(t,e[1],e[0])),a<1){let c;if(v(t))c=qZe(t,l,i);else{const h=xbe(i);c={direct:{intensity:Rf.local.directAtNoon*h.direct,color:$e(1,1,1)},ambient:{intensity:Rf.local.ambientAtNoon*h.ambient,color:$e(1,1,1)},timeOfDay:"early afternoon"}}Ys(n.ambient.color,c.ambient.color,n.ambient.color,a),n.ambient.intensity=Ft(c.ambient.intensity,n.ambient.intensity,a),Ys(n.direct.color,c.direct.color,n.direct.color,a),n.direct.intensity=Ft(c.direct.intensity,n.direct.intensity,a),n.specularStrength=i==="rainy"||i==="snowy"||i==="foggy"?0:1,n.environmentStrength=i==="rainy"?.7:i==="snowy"||i==="foggy"?.75:1}n.noonFactor=v(t)?HZe(t,l):1,v(t)?VZe(t,e,r,n.direct.directionToLightSource):bbe(s,r,n.direct.directionToLightSource)}function bbe(t,e,r){e===Be.Global?_e(E8,t.eye):ce(E8,0,0,1),ae(C8,t.viewForward,-1);const i=_L(C8,E8),s=Math.max(i-2*A8,0),n=.85*s/(s+1),o=Math.max(A8,i-A8-n);$u(Kie,-o,t.viewRight),We(r,C8,Kie),fe(r,r,ae(WZe,t.viewRight,XZe)),_e(r,r)}function VZe(t,e,r,i){const s=jZe,n=Gh(GZe);if(r===Be.Global)$w.getPosition(t,0,0,s),ce(i,0,0,-1),LS(n,n,-s.azimuth),I4(n,n,-s.altitude),We(i,i,n);else{const o=Rf.planarDirection,a=o.globalAngles,l=e[2];let c=(Math.abs(l)-o.localAltitude)/(o.globalAltitude-o.localAltitude);c=ge(c,0,1),c<1?($w.getPosition(t,e[1],e[0],s),s.azimuth=(1-c)*s.azimuth+c*a.azimuth,s.altitude=(1-c)*s.altitude+c*a.altitude):(s.azimuth=a.azimuth,s.altitude=a.altitude),ce(i,0,-1,0),DS(n,n,-s.azimuth),LS(n,n,-s.altitude),We(i,i,n)}}function BZe(t,e){if(e===Be.Global)return!0;const r=Rf.planarDirection;return Math.abs(t)<r.localAltitude}const zZe=$e(.5773502691896258,-.5773502691896258,.5773502691896258);let wbe=class{constructor(){this.ambient={color:$e(1,1,1),intensity:.55},this.direct={color:$e(1,1,1),intensity:.55,directionToLightSource:ms(zZe)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}};const GZe=Ie(),jZe={azimuth:0,altitude:0};function HZe(t,e){const r=t.valueOf();let i,s;e.polarException===$w.PolarException.MIDNIGHT_SUN?(i=r-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,s=i+432e6):e.polarException===$w.PolarException.POLAR_NIGHT?(i=r-2,s=r-1):(i=e.sunrise.valueOf(),s=e.sunset.valueOf());const n=i+(s-i)/2;return 1-ge(Math.abs(r-n)/432e5,0,1)}function xbe(t){switch(t){case"disabled":case"sunny":case"cloudy":return{direct:1,ambient:1};case"rainy":return{direct:.4,ambient:1.2};case"snowy":return{direct:.5,ambient:1.3};case"foggy":return{direct:.2,ambient:1.6}}}function Jie(t,e){const r=(t[0]+t[1]+t[2])/3;for(let i=0;i<3;i++)t[i]=t[i]+(r-t[i])*e;return t}function qZe(t,e,r){const i=t.valueOf();let s,n;e.polarException===$w.PolarException.MIDNIGHT_SUN?(s=i-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,n=s+432e6):e.polarException===$w.PolarException.POLAR_NIGHT?(s=i-2,n=i-1):(s=e.sunrise.valueOf(),n=e.sunset.valueOf());const o=n-s,a=s+o/2,l=o/4,c=a-l,h=a+l,p=.06*o,f=s-p/2,m=s+p/2,y=n-p/2,_=n+p/2,b=Rf.local,x=[.01,b.ambientAtNight],T=[.8,.8,1],S=[.01,.01,.01],E=[b.directAtTwilight,b.ambientAtTwilight],O=[1,.6,.5],R=[.8,.8,1],L=[.9*b.directAtNoon,b.ambientAtNoon],P=[1,.98,.98],U=[.98,.98,1],B=[b.directAtNoon,b.ambientAtNoon],z=[1,1,1],G=[1,1,1],K=L,ee=P,Q=U,H=E,$=O,N=R;let F,j,X=[0,0],J=[0,0,0],W=[0,0,0];i<f||i>_?(X=x,J=S,W=T,j="night"):i<m?(F=m-f,X=Fo(i-f,F,x,E),J=Fo(i-f,F,S,O),W=Fo(i-f,F,T,R),j="sun rising"):i<c?(F=c-m,X=Fo(i-m,F,E,L),J=Fo(i-m,F,O,P),W=Fo(i-m,F,R,U),j="early morning"):i<a?(F=a-c,X=Fo(i-c,F,L,B),J=Fo(i-c,F,P,z),W=Fo(i-c,F,U,G),j="late morning"):i<h?(F=h-a,X=Fo(i-a,F,B,K),J=Fo(i-a,F,z,ee),W=Fo(i-a,F,G,Q),j="early afternoon"):i<y?(F=y-h,X=Fo(i-h,F,K,H),J=Fo(i-h,F,ee,$),W=Fo(i-h,F,Q,N),j="late afternoon"):i<_&&(F=_-y,X=Fo(i-y,F,H,x),J=Fo(i-y,F,$,S),W=Fo(i-y,F,N,T),j="sun setting");let ue=0;switch(r){case"rainy":case"foggy":case"snowy":ue=.5}ue>0&&(J=Jie(J,ue),W=Jie(W,ue));const pe=$e(J[0],J[1],J[2]),we=$e(W[0],W[1],W[2]),Ce=xbe(r);return{direct:{intensity:X[0]*Ce.direct,color:pe},ambient:{intensity:X[1]*Ce.ambient,color:we},timeOfDay:j}}function Fo(t,e,r,i){const s=[];for(let n=0;n<r.length;n++)s[n]=(i[n]-r[n])*t/e+r[n];return s}const Kie=Ie(),E8=M(),C8=M(),WZe=M(),A8=.25,XZe=.2;let Ad=class extends vs.EventedAccessor{constructor(){super(),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandles=new ei,this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this._referencePosUpdateTimer=null,this._referencePosMapCoords=null,this._mainLight=new rF,this._ambientLight=new yY,this._moonLight=new R1e,this.disableQueries=!1,this._disableWeather=!1,this._renderer=null,this._referencePosWGS84Comparable=null,this._resetReferencePosition()}destroy(){this.disconnectView(),this._viewHandles.destroy()}get _view(){var e;return(e=this._renderer)==null?void 0:e.view}get updating(){var e;return!((this.disableQueries||!this._referencePosUpdateQuery&&!this._referencePosMapCoordsRequested)&&!((e=this._renderer)!=null&&e.updating))}get weatherEnabled(){var e,r,i;return((e=this._view)==null?void 0:e.environment.atmosphereEnabled)&&!this._disableWeather&&((i=(r=this._view)==null?void 0:r.state)==null?void 0:i.viewingMode)===Be.Global&&NR(this._view.spatialReference)}get weatherVisible(){var e;return this.weatherEnabled&&((e=this._renderer)==null?void 0:e.weatherVisible)}get referencePositionWGS84Comparable(){return this._referencePosWGS84Comparable}connectView(e){if(this._renderer)return;this._renderer=new Hn({view:e});const r=()=>this._updateRenderParameters(),i=()=>this._cameraHandler();this._viewHandles.add([ie(()=>e.environment.lighting,s=>this._updateLightingHandler(s),ri),ie(()=>e.environment.lighting.type!=="virtual"?e.environment.lighting.date:null,s=>this._lightingDateHandler(s),ri),ie(()=>e.stationary,()=>this._interactingStationaryHandler()),ie(()=>e.environment.lighting.directShadowsEnabled,r,ri),ie(()=>e.environment.lighting.ambientOcclusionEnabled,r,ri),ie(()=>e.environment.lighting.waterReflectionEnabled,r,ri),ie(()=>{var s;return(s=e.environment.background)==null?void 0:s.color},r,ri),ie(()=>e.spatialReference,()=>this._resetReferencePosition(!0),ri),ie(()=>e.environment.weather.type,()=>this._updateLighting(null,aS.Faded),ri),ie(()=>this.weatherEnabled,()=>this._updateLighting(null,aS.Faded),ri),ie(()=>e.viewingMode,()=>this._resetReferencePosition(!0),js),ie(()=>e.environment.lighting.type!=="virtual"&&e.environment.lighting.cameraTrackingEnabled,s=>this._updateCameraTracking(s),js),ie(()=>e.state.camera,i,js),ie(()=>this.disableQueries,i)]),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer=ke(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking(e.type!=="virtual"&&e.cameraTrackingEnabled),this._lightingDateHandler(e.type!=="virtual"?e.date:null),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const r=this._view.environment.lighting;(r==null?void 0:r.type)!=="virtual"&&(r.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const r=this._view.environment.lighting;if((r==null?void 0:r.type)!=="virtual"){if(e){if(!r.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const i=this._view.spatialReference;if(!vw(i)){const s=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(s))return void this._requestReferencePositionUpdate(s)}if(this._preupdateTracking(e),v(this._referencePosWGS84Comparable)){const s=Wie(this._referencePosWGS84Comparable,Qie);v(s)&&(r.autoUpdate(null,s),this._trackingEnabled&&(r.positionTimezoneInfo.autoUpdated=!0))}}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&this._view.environment.lighting.type!=="virtual"&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){const r=this._view;if(!r.ready)return;const i=r.stateManager.camera;i&&(this._cameraHandlerClientSide(i,e)||this._cameraHandlerServerSide(i))}_cameraHandlerClientSide(e,r){const i=NR(this._view.spatialReference);if(i&&!vw(this._view.spatialReference))return this._view.environment.lighting.type==="virtual"&&this._updateLighting(),!1;const s=e.position;return C(this._referencePosWGS84Comparable)&&(this._referencePosWGS84Comparable=M()),i?gDe(s,this._referencePosWGS84Comparable):ce(this._referencePosWGS84Comparable,s.longitude??0,s.latitude??0,s.z??0),this.notifyChange("referencePositionWGS84Comparable"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,r)||this._updateLighting(r),!0}_cameraHandlerServerSide(e){const r=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(r))&&this._requestReferencePositionUpdate(r,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=(r.z??0)*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate()}_updateLighting(e,r=aS.Immediate){const i=this._view;e=e||(i.environment.lighting.type==="virtual"?null:i.environment.lighting.date);const s=this._referencePosWGS84Comparable,n=v(s)?YZe:ZZe,o=this.weatherVisible?i.environment.weather.type:"disabled";v(s)?kZe(e,s,i.state.viewingMode,o,i.state.camera,n):i.environment.lighting.type==="virtual"&&bbe(i.state.camera,i.state.viewingMode,n.direct.directionToLightSource);const a=this._mainLight,l=n.direct;ae(a.intensity,l.color,l.intensity*Math.PI),le(a.direction,l.directionToLightSource),a.specularStrength=n.specularStrength,a.environmentStrength=n.environmentStrength;const c=this._ambientLight;ae(c.intensity,n.ambient.color,n.ambient.intensity);const h=this._moonLight;Ys(h.intensity,KZe,QZe,n.globalFactor);const p=(1-.5*n.globalFactor)*(1-.4*n.noonFactor*(1-n.globalFactor));ae(h.intensity,h.intensity,p),le(h.direction,l.directionToLightSource),this._renderer.updateLightSources([a,c,h],n.noonFactor,n.globalFactor,r),this._updateRenderParameters()}_autoUpdateTimezone(e,r=null){if(this._view.environment.lighting.type==="virtual"||!this._view.environment.lighting.cameraTrackingEnabled||C(e))return!1;const i=JZe;i.setTime((r||this._view.environment.lighting.date).getTime());const s=Wie(e,Qie);if(C(s))return!1;let n=this._view.environment.lighting.positionTimezoneInfo;if(n.autoUpdated){if(n.hours===s.hours&&n.minutes===s.minutes&&n.seconds===s.seconds)return!1}else n=s;const o=i.getUTCHours()-(s.hours-n.hours),a=i.getUTCMinutes()-(s.minutes-n.minutes),l=i.getUTCSeconds()-(s.seconds-n.seconds);return i.setUTCHours(o),i.setUTCMinutes(a),i.setUTCSeconds(l),!r&&this._view.environment.lighting.autoUpdate(i,s)}_updateRenderParameters(){const e=this._view._stage;if(!e)return;const r=_u(this._referencePosWGS84Comparable,!0,n=>BZe(n[2],this._view.state.viewingMode)),i=this._view.environment.background,s=i instanceof Ave?{type:"color",color:CW(Ze.toUnitRGBA(i.color))}:{type:"color",color:Ht(0,0,0,1)};e.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&r,background:s,environment:this._view.environment,weatherVisible:this._view.environmentManager.weatherVisible})}_resetReferencePosition(e=!1){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),e&&this._cameraHandler()}_requestReferencePositionUpdate(e,r=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!r,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&this._view.stationary)){const i=this._referencePosUpdateQuery=nw(this._referencePointUpdateDelay).then(()=>{if(this._referencePosUpdateQuery===i){const n=()=>this._referencePosUpdateQuery!==i;return this._doReferencePositionUpdateQuery(n)}}).catch(n=>{n.name==="mapcoordshelper:missing-geometry-service"&&(this.disableQueries=!0)}).then(()=>{this._referencePosUpdateQuery===i&&(this._referencePosUpdateQuery=null,this._referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))}),s=this._referencePosUpdateTimer=nw(this._referencePointUpdateInterval).then(()=>{this._referencePosUpdateTimer===s&&(this._referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())});this.notifyChange("updating")}}async _doReferencePositionUpdateQuery(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const r=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(r[0])&&!isNaN(r[1])){const i=(this._referencePosMapCoords.z??0)*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=r[0],this._referencePosWGS84Comparable[1]=r[1],this._referencePosWGS84Comparable[2]=i):this._referencePosWGS84Comparable=[r[0],r[1],i],this._referencePosChanged()}}_executePendingReferencePositionUpdate(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLighting():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLighting(),this.notifyChange("referencePositionWGS84Comparable")}_exceedsReferencePosDistThreshold(e){if(this._referencePosMapCoords){let r=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(r*=this._view.mapCoordsHelper.unitInMeters),r>this._referencePointUpdateDistThreshold}return!0}_cancelReferencePosUpdates(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this._referencePosUpdateTimer=null,e}get test(){const e=this;return{get renderer(){return e._renderer},set referencePointUpdateInterval(r){e._referencePointUpdateInterval=r},set referencePointUpdateDistThreshold(r){e._referencePointUpdateDistThreshold=r},set referencePosUpdateTimer(r){e._referencePosUpdateTimer=r},set referencePointUpdateDelay(r){e._referencePointUpdateDelay=r},set disableWeather(r){e._disableWeather=r}}}};u([d({type:Boolean,readOnly:!0})],Ad.prototype,"updating",null),u([d()],Ad.prototype,"disableQueries",void 0),u([d()],Ad.prototype,"_disableWeather",void 0),u([d()],Ad.prototype,"weatherEnabled",null),u([d()],Ad.prototype,"weatherVisible",null),u([d()],Ad.prototype,"referencePositionWGS84Comparable",null),u([d()],Ad.prototype,"_renderer",void 0),u([d()],Ad.prototype,"_referencePosWGS84Comparable",void 0),Ad=u([I("esri.views.3d.environment.SceneViewEnvironmentManager")],Ad);const YZe=new wbe,ZZe=new wbe,JZe=new Date,Qie={hours:0,minutes:0,seconds:0},KZe=$e(.22,.22,.33),QZe=$e(.22,.22,.22);var Di;(function(t){t[t.NONE=0]="NONE",t[t.TILT=1]="TILT",t[t.ALTITUDE=2]="ALTITUDE",t[t.DISTANCE=4]="DISTANCE",t[t.COLLISION=8]="COLLISION",t[t.ALL=15]="ALL",t[t.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"})(Di||(Di={}));var nr;(function(t){t[t.NONE=0]="NONE",t[t.ZOOM=1]="ZOOM",t[t.TUMBLE=2]="TUMBLE",t[t.LOOK_AROUND=3]="LOOK_AROUND",t[t.PAN=4]="PAN",t[t.ASCEND=5]="ASCEND"})(nr||(nr={}));var oo;(function(t){t[t.TUMBLE=0]="TUMBLE",t[t.LOOK_AROUND=1]="LOOK_AROUND"})(oo||(oo={}));function gO(t,e){return(t&e)!=0}function lF(t,e,r,i,s,n){t!==0&&(r?(n.min=Math.min(n.min,e),n.max=Math.max(n.max,e)):i!=null?(n.min-=Math.max(0,(e-n.min)*(1-i)),n.max+=Math.max(0,(e-n.max)*(1-i))):s&&(n.min-=Math.max(0,e-n.min-s),n.max+=Math.max(0,e-n.max-s)))}const nv={selection:Di.NONE,interactionType:nr.NONE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:oo.TUMBLE};function Tbe(t,e,r,i){return e=e||t.viewForward,le(i,e),ae(i,i,Math.sign(ye(e,r))),i}function eJe(t,e,r,i){return nJe(t,e,r,iJe(i,e,r,!0))}function tJe(t,e,r,i){const s=ye(r,me(t,i,e));return fe(t,e,ae(t,r,s))}const rJe={dir:M(),len:0,clip:Je()};function iJe(t,e,r,i){const s=rJe;return t?(r&&i&&(s.len=xi(e,r)),le(s.dir,t)):i?(s.len=xi(e,r),me(s.dir,r,e),ae(s.dir,s.dir,1/s.len)):(me(s.dir,r,e),_e(s.dir,s.dir)),s}function sJe(t,e,r){const i=ye(t,r.dir),s=-bi(t,e);if(s<0&&i>=0)return!1;if(i>-1e-6&&i<1e-6)return s>0;if((s<0||i<0)&&!(s<0&&i<0))return!0;const n=s/i;return i>0?n<r.clip[1]&&(r.clip[1]=n):n>r.clip[0]&&(r.clip[0]=n),r.clip[0]<=r.clip[1]}function nJe(t,e,r,i){i.clip[0]=0,i.clip[1]=r?i.len:Number.MAX_VALUE;for(let s=0;s<t.length;s++)if(!sJe(t[s],e,i))return!1;return!0}function oJe(t,e,r=nv){const i=FY(t,e,r);if(i===0)return!1;const s=t.renderCoordsHelper,n=s.getAltitude(e.eye)+i,o=Tbe(e,r.interactionDirection,cJe(t,e,Math.sign(i),pJe),dJe),a=le(fJe,e.viewForward),l=s.intersectInfiniteManifold(Du(e.eye,o),n,R8);return e.eye=v(l)?l:s.setAltitude(R8,n,e.eye),e.center=tJe(R8,e.eye,a,e.center),!0}function FY(t,e,r=nv){if(!aJe(t,r)||!t.state.constraints.altitude)return 0;const i=uJe(t.state.constraints.altitude,hJe);lJe(t,r,i);const s=t.renderCoordsHelper.getAltitude(e.eye),n=ge(s,i.min,i.max)-s;return Math.abs(n)<=1e-6?0:n}function aJe(t,e){const r=t.state.constraints.altitude;return!(!t.state.isGlobal||!r)&&(e.interactionType!==nr.TUMBLE||!gO(e.selection,Di.TILT))}function lJe(t,e,r){const i=e.interactionType;if(i===nr.NONE)return;const{min:s,max:n}=r,{interactionStartCamera:o,interactionFactor:a}=e;if(!o)return;const l=i===nr.TUMBLE||i===nr.ZOOM,c=FY(t,o),h=c===0?0:t.renderCoordsHelper.getAltitude(o.eye);r.min=s,r.max=n,lF(c,h,l,a,.05*h,r)}function cJe(t,e,r,i){return t.renderCoordsHelper.worldUpAtPosition(e.eye,i),ae(i,i,r),i}function uJe(t,e){return e.min=t.min,e.max=t.max,e}const hJe={min:0,max:0},dJe=M(),pJe=M(),fJe=M(),R8=M();function UY(t,e,r=nv){if(!t.state.isLocal)return 0;const i=t.state.constraints.distance;if(!t.pointsOfInterest.surfaceOrigin.renderLocation||i===1/0)return 0;eI.min=0,eI.max=i,gJe(t,r,eI);const s=kY(t,e),n=eI.max-s;return n>=-1e-6?0:n}function mJe(t,e,r=nv){const i=UY(t,e,r);if(i===0)return!1;const s=t.pointsOfInterest.surfaceOrigin;if(!s.renderLocation)return!1;const n=kY(t,e)+i,o=le(_Je,e.eye),a=Tbe(e,r.interactionDirection,yJe(e,s.renderLocation,wJe),bJe);if(!_v(ime(s.renderLocation,n),Du(e.eye,a),tI))return!1;e.eye=tI;const l=me(vJe,e.eye,o);e.center=fe(tI,e.center,l);const c=t.renderCoordsHelper.getAltitude(e.center),h=t.renderCoordsHelper.intersectInfiniteManifold(e.ray,c,tI);return v(h)&&(e.center=h),!0}function gJe(t,e,r){const i=e.interactionType;if(i===nr.NONE)return;const{min:s,max:n}=r,{interactionStartCamera:o,interactionFactor:a}=e;if(!o)return;const l=i===nr.ZOOM||i===nr.PAN,c=UY(t,o),h=c===0?0:kY(t,o);r.min=s,r.max=n,lF(c,h,l,a,.05*h,r)}function kY(t,e){const r=t.pointsOfInterest.surfaceOrigin;return r.renderLocation?xi(e.eye,r.renderLocation):0}function yJe(t,e,r){return ay(r,t.eye,e)}const eI={min:0,max:0},_Je=M(),vJe=M(),bJe=M(),wJe=M(),tI=M();var Qi,Po;(function(t){t[t.OBJECT=0]="OBJECT",t[t.HUD=1]="HUD",t[t.TERRAIN=2]="TERRAIN",t[t.OVERLAY=3]="OVERLAY",t[t.I3S=4]="I3S",t[t.PCL=5]="PCL",t[t.LOD=6]="LOD",t[t.VOXEL=7]="VOXEL"})(Qi||(Qi={}));let xJe=class{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.filteredLayerUids=[],this.store=Po.ALL}};(function(t){t[t.MIN=0]="MIN",t[t.MINMAX=1]="MINMAX",t[t.ALL=2]="ALL"})(Po||(Po={}));let TJe=class{constructor(e,r,i){this.object=e,this.geometryId=r,this.triangleNr=i}},SJe=class extends TJe{constructor(e,r,i,s){super(e,r,i),this.center=v(s)?ms(s):null}},Sbe=class{constructor(e){this.layerUid=e}},R5=class extends Sbe{constructor(e,r){super(e),this.graphicUid=r}};function Ep(t){return v(t)&&v(t.dist)}function ese(t){return(e,r,i)=>(Ys(tse,e,r,i),!DW(t,tse))}function O5(t){return Ep(t)&&t.intersector===Qi.OBJECT&&!!t.target}function M5(t){return Ep(t)&&t.intersector===Qi.HUD&&!!t.target&&"center"in t.target&&v(t.target.center)}const tse=M();let EJe=class{constructor(){this._transform=Ie(),this._transformInverse=new rI({value:this._transform},Oo,Ie),this._transformInverseTranspose=new rI(this._transformInverse,Dc,Ie),this._transformTranspose=new rI({value:this._transform},Dc,Ie),this._transformInverseRotation=new rI({value:this._transform},d1e,es)}_invalidateLazyTransforms(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}get transform(){return this._transform}get inverse(){return this._transformInverse.value}get inverseTranspose(){return this._transformInverseTranspose.value}get inverseRotation(){return this._transformInverseRotation.value}get transpose(){return this._transformTranspose.value}setTransformMatrix(e){Fn(this._transform,e)}multiplyTransform(e){gs(this._transform,this._transform,e)}set(e){Fn(this._transform,e),this._invalidateLazyTransforms()}setAndInvalidateLazyTransforms(e,r){this.setTransformMatrix(e),this.multiplyTransform(r),this._invalidateLazyTransforms()}},rI=class{constructor(e,r,i){this._original=e,this._update=r,this._dirty=!0,this._transform=i()}invalidate(){this._dirty=!0}get value(){return this._dirty&&(this._update(this._transform,this._original.value),this._dirty=!1),this._transform}},CJe=class{constructor(e=0){this.offset=e,this.tmpVertex=M()}applyToVertex(e,r,i){const s=e+this.localOrigin[0],n=r+this.localOrigin[1],o=i+this.localOrigin[2],a=this.offset/Math.sqrt(s*s+n*n+o*o);return this.tmpVertex[0]=e+s*a,this.tmpVertex[1]=r+n*a,this.tmpVertex[2]=i+o*a,this.tmpVertex}applyToAabb(e){for(let n=0;n<3;++n)By[n]=e[0+n]+this.localOrigin[n],iI[n]=e[3+n]+this.localOrigin[n],Sx[n]=By[n];const r=this.applyToVertex(By[0],By[1],By[2]);for(let n=0;n<3;++n)e[n]=r[n],e[n+3]=r[n];const i=n=>{const o=this.applyToVertex(n[0],n[1],n[2]);for(let a=0;a<3;++a)e[a+0]=Math.min(e[a+0],o[a]),e[a+3]=Math.max(e[a+3],o[a])};for(let n=1;n<8;++n){for(let o=0;o<3;++o)Sx[o]=n&1<<o?iI[o]:By[o];i(Sx)}let s=0;for(let n=0;n<3;++n)By[n]*iI[n]<0&&(s|=1<<n);if(s!==0&&s!==7){for(let n=0;n<8;++n)if(!(s&n)){for(let o=0;o<3;++o)s[o]?Sx[o]=0:Sx[o]=n&1<<o?By[o]:iI[o];i(Sx)}}for(let n=0;n<3;++n)e[n+0]-=this.localOrigin[n],e[n+3]-=this.localOrigin[n];return e}};const By=M(),iI=M(),Sx=M();let AJe=class{constructor(e=0){this.componentLocalOriginLength=0,this._tmpVertex=M(),this._mbs=on(),this._obb={center:M(),halfSize:Vi(),quaternion:null},this._totalOffset=0,this._offset=0,this._resetOffset(e)}_resetOffset(e){this._offset=e,this._totalOffset=e}set offset(e){this._resetOffset(e)}get offset(){return this._offset}set componentOffset(e){this._totalOffset=this._offset+e}set localOrigin(e){this.componentLocalOriginLength=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])}applyToVertex(e,r,i){const s=e,n=r,o=i+this.componentLocalOriginLength,a=this._totalOffset/Math.sqrt(s*s+n*n+o*o);return this._tmpVertex[0]=e+s*a,this._tmpVertex[1]=r+n*a,this._tmpVertex[2]=i+o*a,this._tmpVertex}applyToAabb(e){const r=e[0],i=e[1],s=e[2]+this.componentLocalOriginLength,n=e[3],o=e[4],a=e[5]+this.componentLocalOriginLength,l=r*n<0?0:Math.min(Math.abs(r),Math.abs(n)),c=i*o<0?0:Math.min(Math.abs(i),Math.abs(o)),h=s*a<0?0:Math.min(Math.abs(s),Math.abs(a)),p=Math.sqrt(l*l+c*c+h*h);if(p<this._totalOffset)return e[0]-=r<0?this._totalOffset:0,e[1]-=i<0?this._totalOffset:0,e[2]-=s<0?this._totalOffset:0,e[3]+=n>0?this._totalOffset:0,e[4]+=o>0?this._totalOffset:0,e[5]+=a>0?this._totalOffset:0,e;const f=Math.max(Math.abs(r),Math.abs(n)),m=Math.max(Math.abs(i),Math.abs(o)),y=Math.max(Math.abs(s),Math.abs(a)),_=Math.sqrt(f*f+m*m+y*y),b=this._totalOffset/_,x=this._totalOffset/p;return e[0]+=r*(r>0?b:x),e[1]+=i*(i>0?b:x),e[2]+=s*(s>0?b:x),e[3]+=n*(n<0?b:x),e[4]+=o*(o<0?b:x),e[5]+=a*(a<0?b:x),e}applyToMbs(e){const r=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),i=this._totalOffset/r;return this._mbs[0]=e[0]+e[0]*i,this._mbs[1]=e[1]+e[1]*i,this._mbs[2]=e[2]+e[2]*i,this._mbs[3]=e[3]+e[3]*this._totalOffset/r,this._mbs}applyToObb(e){const r=e.center,i=this._totalOffset/Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]);this._obb.center[0]=r[0]+r[0]*i,this._obb.center[1]=r[1]+r[1]*i,this._obb.center[2]=r[2]+r[2]*i,np(this._obb.halfSize,e.halfSize,e.quaternion),fe(this._obb.halfSize,this._obb.halfSize,e.center);const s=this._totalOffset/Math.sqrt(this._obb.halfSize[0]*this._obb.halfSize[0]+this._obb.halfSize[1]*this._obb.halfSize[1]+this._obb.halfSize[2]*this._obb.halfSize[2]);return this._obb.halfSize[0]+=this._obb.halfSize[0]*s,this._obb.halfSize[1]+=this._obb.halfSize[1]*s,this._obb.halfSize[2]+=this._obb.halfSize[2]*s,me(this._obb.halfSize,this._obb.halfSize,e.center),Iw(nse,e.quaternion),np(this._obb.halfSize,this._obb.halfSize,nse),this._obb.halfSize[0]*=this._obb.halfSize[0]<0?-1:1,this._obb.halfSize[1]*=this._obb.halfSize[1]<0?-1:1,this._obb.halfSize[2]*=this._obb.halfSize[2]<0?-1:1,this._obb.quaternion=e.quaternion,this._obb}},RJe=class{constructor(e=0){this.offset=e,this.sphere=on(),this.tmpVertex=M()}applyToVertex(e,r,i){const s=this.objectTransform.transform;let n=s[0]*e+s[4]*r+s[8]*i+s[12],o=s[1]*e+s[5]*r+s[9]*i+s[13],a=s[2]*e+s[6]*r+s[10]*i+s[14];const l=this.offset/Math.sqrt(n*n+o*o+a*a);n+=n*l,o+=o*l,a+=a*l;const c=this.objectTransform.inverse;return this.tmpVertex[0]=c[0]*n+c[4]*o+c[8]*a+c[12],this.tmpVertex[1]=c[1]*n+c[5]*o+c[9]*a+c[13],this.tmpVertex[2]=c[2]*n+c[6]*o+c[10]*a+c[14],this.tmpVertex}applyToMinMax(e,r){const i=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*i,e[1]+=e[1]*i,e[2]+=e[2]*i;const s=this.offset/Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]);r[0]+=r[0]*s,r[1]+=r[1]*s,r[2]+=r[2]*s}applyToAabb(e){const r=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*r,e[1]+=e[1]*r,e[2]+=e[2]*r;const i=this.offset/Math.sqrt(e[3]*e[3]+e[4]*e[4]+e[5]*e[5]);return e[3]+=e[3]*i,e[4]+=e[4]*i,e[5]+=e[5]*i,e}applyToBoundingSphere(e){const r=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),i=this.offset/r;return this.sphere[0]=e[0]+e[0]*i,this.sphere[1]=e[1]+e[1]*i,this.sphere[2]=e[2]+e[2]*i,this.sphere[3]=e[3]+e[3]*this.offset/r,this.sphere}};const rse=new RJe;function vj(t){return v(t)?(rse.offset=t,rse):null}const ise=new AJe;function OJe(t){return v(t)?(ise.offset=t,ise):null}const sse=new CJe;function MJe(t){return v(t)?(sse.offset=t,sse):null}const c_="terrain",nse=Zh(),rE=1e-5;let PJe=class{constructor(e){this.options=new xJe,this._results=new IJe,this.transform=new EJe,this.tolerance=rE,this.verticalOffset=null,this._ray=ro(),this._rayEnd=M(),this._rayBeginTransformed=M(),this._rayEndTransformed=M(),this.viewingMode=e??Be.Global}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(e,r,i){this.resetWithRay(GDe(e,r,this._ray),i)}resetWithRay(e,r){this.camera=r,e!==this._ray&&wN(e,this._ray),this.options.verticalOffset!==0?this.viewingMode===Be.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,fe(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(e=null,r,i,s,n){this.point=r,this.filterPredicate=s,this.tolerance=i??rE;const o=vj(this.verticalOffset);if(v(e)&&e.length>0){const a=n?l=>{n(l)&&this.intersectObject(l)}:l=>{this.intersectObject(l)};for(const l of e){const c=l.getSpatialQueryAccelerator&&l.getSpatialQueryAccelerator();v(c)?(v(o)?c.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,a,o):c.forEachAlongRay(this._ray.origin,this._ray.direction,a),this.options.selectionMode&&this.options.hud&&c.forEachDegenerateObject(a)):l.objects.forAll(h=>a(h))}}this.sortResults()}intersectObject(e){const r=e.geometries;if(!r)return;const i=e.transformation,s=vj(this.verticalOffset);for(const n of r){if(!n.visible)continue;const{material:o,id:a}=n;this.transform.setAndInvalidateLazyTransforms(i,n.shaderTransformation),We(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),We(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const l=this.transform.transform;v(s)&&(s.objectTransform=this.transform),o.intersect(n,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(c,h,p,f,m,y)=>{if(c>=0){if(v(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEnd,c))return;const _=f?this._results.hud:this._results,b=f?x=>{const T=new SJe(e,a,p,y);x.set(Qi.HUD,T,c,h,Lu,m)}:x=>x.set(Qi.OBJECT,{object:e,geometryId:a,triangleNr:p},c,h,l,m);if((_.min.drapedLayerOrder==null||m>=_.min.drapedLayerOrder)&&(_.min.dist==null||c<_.min.dist)&&b(_.min),this.options.store!==Po.MIN&&(_.max.drapedLayerOrder==null||m<_.max.drapedLayerOrder)&&(_.max.dist==null||c>_.max.dist)&&b(_.max),this.options.store===Po.ALL)if(f){const x=new bj(this._ray);b(x),this._results.hud.all.push(x)}else{const x=new lS(this._ray);b(x),this._results.all.push(x)}}})}}sortResults(e=this._results.all){e.sort((r,i)=>r.dist!==i.dist?It(r.dist,0)-It(i.dist,0):r.drapedLayerOrder!==i.drapedLayerOrder?It(r.drapedLayerOrder,Number.MAX_VALUE)-It(i.drapedLayerOrder,Number.MAX_VALUE):It(i.drapedLayerGraphicOrder,Number.MIN_VALUE)-It(r.drapedLayerGraphicOrder,Number.MIN_VALUE))}};function Wh(t){return new PJe(t)}let IJe=class{constructor(){this.min=new lS(ro()),this.max=new lS(ro()),this.hud={min:new bj(ro()),max:new bj(ro()),all:new Array},this.ground=new lS(ro()),this.all=[]}init(e){this.min.init(e),this.max.init(e),this.ground.init(e),this.all.length=0,this.hud.min.init(e),this.hud.max.init(e),this.hud.all.length=0}},lS=class{get ray(){return this._ray}get distanceInRenderSpace(){return v(this.dist)?(ae(sI,this.ray.direction,this.dist),Me(sI)):null}getIntersectionPoint(e){return!!Ep(this)&&(ae(sI,this.ray.direction,this.dist),fe(e,this.ray.origin,sI),!0)}getTransformedNormal(e){return le(wC,this.normal),wC[3]=0,Su(wC,wC,this.transformation),le(e,wC),_e(e,e)}constructor(e){this.intersector=Qi.OBJECT,this.normal=M(),this.transformation=Ie(),this._ray=ro(),this.init(e)}init(e){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=Qi.OBJECT,wN(e,this._ray)}set(e,r,i,s,n,o,a){this.intersector=e,this.dist=i,le(this.normal,It(s,Zhe)),Fn(this.transformation,It(n,Lu)),this.target=r,this.drapedLayerOrder=o,this.drapedLayerGraphicOrder=a}copy(e){wN(e.ray,this._ray),this.intersector=e.intersector,this.dist=e.dist,this.target=e.target,this.drapedLayerOrder=e.drapedLayerOrder,this.drapedLayerGraphicOrder=e.drapedLayerGraphicOrder,le(this.normal,e.normal),Fn(this.transformation,e.transformation)}},bj=class extends lS{constructor(){super(...arguments),this.intersector=Qi.HUD}};function VY(t){return new lS(t)}const sI=M(),wC=sr();function Ebe(t,e,r,i){return v(t.renderCoordsHelper.fromRenderCoords(e.eye,cF,i))&&hpe(r,cF)}function P5(t,e){return t.elevationProvider?It(t.elevationProvider.getElevation(e[0],e[1],e[2],t.renderCoordsHelper.spatialReference,"ground"),0):0}function tx(t,e,r,i){const s=t.state.camera.clone();e&&r&&i&&(s.eye=e,s.center=r,s.up=i),$Je(t,s.ray,zy)||le(zy,s.center);const n=t.state.constraints,o=n.minimumPoiDistance;if(Ro(s.eye,zy)<o){const a=n.collision.enabled;le(Fv,s.viewForward),ae(Fv,Fv,o),a?s.eye=me(cF,zy,Fv):fe(zy,s.eye,Fv);const l=t.renderCoordsHelper,c=l.getAltitude(s.eye),h=n.collision.elevationMargin;a&&c<h&&(me(Fv,zy,s.eye),s.eye=l.setAltitude(cF,h,s.eye),fe(zy,s.eye,Fv))}return s.center=zy,s}function ose(t,e,r){if(!t.state.isGlobal||!t.stateManager.constraintsManager)return!1;const i=P5(t,e),s=t.stateManager.constraintsManager.nearFarHeuristic,{far:n}=s.compute(e,r,t.renderDataExtent,i,DJe),o=n*n;return Ro(e,r)>o}function $Je(t,e,r){let i=ase[t.viewingMode];i||(i=Wh(t.state.viewingMode),i.options.backfacesTerrain=!t.state.isGlobal,i.options.invisibleTerrain=!0,ase[t.viewingMode]=i);const{isGlobal:s}=t.state;return!(!t.sceneIntersectionHelper.intersectRay(e,i,r)||ose(t,e.origin,r))||!(!t.renderCoordsHelper.intersectManifold(e,0,r)||ose(t,e.origin,r))||!!s&&LJe(e,r,Jr(t.spatialReference).radius)}function LJe(t,e,r){const i=ye(t.origin,t.origin)-r*r,s=i>0?Math.sqrt(i)/3:1;return ae(e,t.direction,s/Me(t.direction)),fe(e,e,t.origin),!0}const ase={},cF=M(),zy=M(),Fv=M(),DJe={near:0,far:0};function zE(t,e,r=Ph.EYE){const i=t.state.constraints;if(!i.collision.enabled)return!1;const s=P5(t,e.eye),n=t.renderCoordsHelper.getAltitude(e.eye),o=s+i.collision.elevationMargin;if(n>=o)return!1;const a=Me(e.eye);if(me(nI,e.center,e.eye),e.eye=t.renderCoordsHelper.setAltitude(NJe,o,e.eye),r===Ph.EYE_AND_CENTER)e.center=fe(nI,e.eye,nI);else if(r===Ph.EYE_AND_CENTER_SCALE){const l=(a-n+o)/a;e.center=ae(nI,e.center,l)}return!0}var Ph;(function(t){t[t.EYE=0]="EYE",t[t.EYE_AND_CENTER=1]="EYE_AND_CENTER",t[t.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"})(Ph||(Ph={}));const nI=M(),NJe=M();function ov(t,e,r){t.worldUpAtPosition(e,lse),me(O8,r,e);const i=Me(O8);return i===0?0:Sn(ye(O8,lse)/i)}const lse=M(),O8=M();function Cbe(t,e,r=nv,i=!0){xC.eyeCenterDistance=0,xC.requiresTwoSteps=!1;const s=BY(t,e,r,void 0,xC);if(s===0)return!1;switch($u(oI,-s,e.viewRight),r.tiltMode){case oo.LOOK_AROUND:We(Gy,e.viewForward,oI),ae(Gy,Gy,xC.eyeCenterDistance),e.center=fe(u_,e.eye,Gy);break;case oo.TUMBLE:me(Gy,e.center,e.eye),We(Gy,Gy,oI),e.eye=me(u_,e.center,Gy);break;default:r.tiltMode}return e.up=We(u_,e.up,oI),!xC.requiresTwoSteps||!i||Cbe(t,e,r,!1)}function BY(t,e,r=nv,i=nv,s){if(!t.state.constraints.tilt)return 0;const n=e.distance,o=t.state.constraints.tilt(n,qJe);return HJe(t,r,o),i.interactionType===nr.TUMBLE&&gO(i.selection,Di.ALTITUDE)&&Abe(t,i.interactionStartCamera,o),r.tiltMode===oo.LOOK_AROUND||i.tiltMode===oo.LOOK_AROUND?UJe(t,e,o,s):FJe(t,e,o)}function FJe(t,e,r){const i=ov(t.renderCoordsHelper,e.center,e.eye),s=i-ge(i,r.min,r.max);return yO(s)?s:0}function UJe(t,e,r,i){switch(i&&(i.requiresTwoSteps=!1),t.viewingMode){case"global":return VJe(t,e,r,i);case"local":return kJe(t,e,r,i)}}function kJe(t,e,r,i){const s=ov(t.renderCoordsHelper,e.center,e.eye),n=ge(s,r.min,r.max),o=s-n;if(!yO(o))return 0;if(i){const a=t.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,l=t.renderCoordsHelper.getAltitude(e.eye)-a,c=Math.cos(n);Math.abs(c)>1e-4?i.eyeCenterDistance=l/c:i.eyeCenterDistance=e.distance}return o}function VJe(t,e,r,i){const s=BJe(t,e,WJe),n=ge(s.tiltAtCenter,r.min,r.max);if(!yO(s.tiltAtCenter-n))return 0;let o,a;return s.centerIsOnSurface?(o=zJe(s),a=GJe(s,o)):(o=s.constraints.clampTilt(s.eyeCenterDistance,s.tiltAtCenter),i&&o<Math.PI/2&&(i.requiresTwoSteps=!0,o=Math.PI/2-1e-5),a=jJe(s,o)),i&&(i.eyeCenterDistance=wj(s,o)),a}function BJe(t,e,r){const i=t.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=i+Jr(t.spatialReference).radius,n=t.renderCoordsHelper.intersectManifold(e.ray,i,u_);return r.eyeCenterDistance=e.distance,r.centerIsOnSurface=!1,v(n)?(r.eyeCenterDistance=xi(e.eye,n),r.tiltAtCenter=ov(t.renderCoordsHelper,n,e.eye),r.centerIsOnSurface=!0):t.state.isLocal?r.tiltAtCenter=ov(t.renderCoordsHelper,e.center,e.eye):(OE(U4(k4,s),e.ray,u_),r.eyeCenterDistance=xi(e.eye,u_),r.tiltAtCenter=Sn(-ye(e.viewForward,_e(u_,u_)))),r.radius=s,r.eyeRadius=Me(e.eye),r.constraints=t.state.constraints,r}function yO(t){return Math.abs(t)>1e-9}function zJe(t){const{constraints:e,eyeCenterDistance:r,tiltAtCenter:i}=t;let s=i,n=e.clampTilt(r,i);const o=wj(t,n);if(e.clampTilt(o,i)===n)return n;let a=0;for(;a<10&&yO(n-s);){const l=(s+n)/2,c=wj(t,l);yO(e.clampTilt(c,l)-l)?s=l:n=l,a++}return n}function wj(t,e){if(!t.centerIsOnSurface)return t.eyeCenterDistance;const r=Math.PI-ge(e,0,Math.PI),i=Uh(t.radius/t.eyeRadius*Math.sin(r)),s=Math.PI-r-i,n=Math.sin(s)/Math.sin(r);if(t.eyeRadius<t.radius&&n>1){const o=Math.PI-i,a=Math.PI-r-o;return Math.sin(a)/Math.sin(r)*t.eyeRadius}return n*t.eyeRadius}function GJe(t,e){const r=Uh(t.radius/t.eyeRadius*Math.sin(t.tiltAtCenter)),i=Uh(t.radius/t.eyeRadius*Math.sin(e));return t.eyeRadius>t.radius?r-i:i-r}function jJe(t,e){return t.tiltAtCenter-Math.PI/2-(e-Math.PI/2)}function HJe(t,e,r){if(e.interactionType===nr.NONE)return;const{interactionStartCamera:i,interactionFactor:s}=e;if(!i)return;const{min:n,max:o}=r,a=BY(t,i,nv,e),l=a===0?0:ov(t.renderCoordsHelper,i.center,i.eye);r.min=n,r.max=o,e.interactionType===nr.TUMBLE?(gO(e.selection,Di.ALTITUDE)&&Abe(t,i,r),lF(a,l,!0,s,cse,r)):lF(a,l,!1,s,cse,r)}function Abe(t,e,r){const i=t.state.constraints;if(t.state.isLocal||!i.altitude||!e)return;const s=ua(e.center),n=Math.sqrt(s),o=e.distance,a=Jr(t.spatialReference).radius,l=i.altitude.min+a,c=i.altitude.max+a,h=(l*l-o*o-s)/(-2*n*o),p=(c*c-o*o-s)/(-2*n*o);r.min=Math.max(r.min,Math.min(Math.PI-Sn(p),r.max)),r.max=Math.min(r.max,Math.PI-Sn(h))}const Gy=M(),oI=Ie(),u_=M(),cse=Gt(5),qJe={min:0,max:0},WJe={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},xC={eyeCenterDistance:0,requiresTwoSteps:!1};function XJe(t){return t}const I5=t=>t*t,zY=t=>1-I5(1-t),YJe=t=>t<.5?I5(2*t)/2:(zY(2*(t-.5))+1)/2,GY=t=>t*t*t,Rbe=t=>1-GY(1-t),Obe=t=>t<.5?GY(2*t)/2:(Rbe(2*(t-.5))+1)/2,jY=t=>t*t*t*t,Mbe=t=>1-jY(1-t),ZJe=t=>t<.5?jY(2*t)/2:(Mbe(2*(t-.5))+1)/2,HY=t=>t*t*t*t*t,Pbe=t=>1-HY(1-t),JJe=t=>t<.5?HY(2*t)/2:(Pbe(2*(t-.5))+1)/2,qY=t=>1-Math.cos(t*Math.PI/2),Ibe=t=>1-qY(1-t),KJe=t=>t<.5?qY(2*t)/2:(Ibe(2*(t-.5))+1)/2,WY=t=>2**(10*(t-1)),MM=t=>1-WY(1-t),QJe=t=>t<.5?WY(2*t)/2:(MM(2*(t-.5))+1)/2,XY=t=>-(Math.sqrt(1-t*t)-1),$be=t=>1-XY(1-t),eKe=t=>t<.5?XY(2*t)/2:($be(2*(t-.5))+1)/2;function Kh(t){const e=2*(t-Math.sqrt((t-1)*t)),r=e/2/t;return i=>i<r?t*i*i:e*i-e+1}function Qh(t,e){return(r,i)=>r<e?e*t(r/e,i):1-t((1-r)/(1-e),i)*(1-e)}const tKe=Qh(Kh(1),1),rKe=Qh(Kh(1),0),Lbe=Qh(Kh(1),.5),iKe=Qh(Kh(2),1),sKe=Qh(Kh(2),0),nKe=Qh(Kh(2),.5),oKe=Qh(Kh(3),1),aKe=Qh(Kh(3),0),lKe=Qh(Kh(3),.5),cKe=Qh(Kh(4),1),uKe=Qh(Kh(4),0),hKe=Qh(Kh(4),.5),dKe={linear:XJe,"in-quad":I5,"out-quad":zY,"in-out-quad":YJe,"in-coast-quad":tKe,"out-coast-quad":rKe,"in-out-coast-quad":Lbe,"in-cubic":GY,"out-cubic":Rbe,"in-out-cubic":Obe,"in-coast-cubic":iKe,"out-coast-cubic":sKe,"in-out-coast-cubic":nKe,"in-quart":jY,"out-quart":Mbe,"in-out-quart":ZJe,"in-coast-quart":oKe,"out-coast-quart":aKe,"in-out-coast-quart":lKe,"in-quint":HY,"out-quint":Pbe,"in-out-quint":JJe,"in-coast-quint":cKe,"out-coast-quint":uKe,"in-out-coast-quint":hKe,"in-sine":qY,"out-sine":Ibe,"in-out-sine":KJe,"in-expo":WY,"out-expo":MM,"in-out-expo":QJe,"in-circ":XY,"out-circ":$be,"in-out-circ":eKe};function Hs(t,e,r=gKe,i=e){i!==e&&i.copyFrom(e),i.computeUp(t.state.viewingMode);let s=!1;for(let a=0;a<yKe;a++){let l=0;for(const c of mKe)if(gO(r.selection,c.type)){const h=Math.abs(c.error(t,i,r));c.apply(t,i,r)&&(s=!0,l+=h)}if(l===0)break}const n=gO(r.selection,Di.COLLISION),o=pKe(r.interactionType,t);return n&&zE(t,i,o)&&(s=!0),s&&i.computeUp(t.state.viewingMode),s}function pKe(t,e){switch(t){case nr.PAN:return Ph.EYE_AND_CENTER;case nr.ASCEND:return e.state.isGlobal?Ph.EYE_AND_CENTER_SCALE:Ph.EYE_AND_CENTER;default:return Ph.EYE}}function Hd(t){const e=Math.min(1,t/150);return Obe(e)}function fKe(t,e,r){return BY(t,e,r)*e.distance}const mKe=[{type:Di.TILT,error:fKe,apply:Cbe},{type:Di.ALTITUDE,error:FY,apply:oJe},{type:Di.DISTANCE,error:UY,apply:mJe}],gKe={selection:Di.ALL,interactionType:nr.NONE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:oo.TUMBLE},yKe=5,Gc=M(),Zl=M(),jy=M(),ta=M(),Uv=M(),_Ke=M(),jc={upward:$e(0,0,1),forward:$e(0,1,0),sideway:$e(1,0,0)},use=es();let hse=class{constructor(e=Be.Global){this.viewingMode=e,this.center=M(),this.pitch=0,this.yaw=0,this.distance=0,this.lookAtDirection=ms(jc.forward)}pixelsPerPanAtZoom(e){return this.size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this.size/2/(this._zoomToPanScale*e)}pixelsPerRotateAtZoom(){const e=Math.max(Math.cos(Math.abs(this.pitch)),.5);return this.size/2/e}compareTo(e,r){if(r||(r={pan:0,rotate:0,sourceZoom:0,targetZoom:0}),this.viewingMode===Be.Global){const n=(Me(this.center)+Me(e.center))/2;r.pan=_L(this.center,e.center)*n}else r.pan=xi(this.center,e.center);let i=Math.abs(e.yaw-this.yaw);i>=Math.PI&&(i=2*Math.PI-i);const s=Math.abs(e.pitch-this.pitch);return r.rotate=Math.max(i,s),r.sourceZoom=this.distance,r.targetZoom=e.distance,r}interpolate(e,r,i){this.viewingMode===Be.Global?sNe(e.center,r.center,i.pan,this.center):Ys(this.center,e.center,r.center,i.pan),this.distance=isFinite(r.distance)?Ft(e.distance,r.distance,i.zoom):e.distance,this.pitch=Ft(e.pitch,r.pitch,i.rotate);let s=e.yaw;const n=r.yaw;Math.abs(n-s)>=Math.PI&&(s+=2*(s<n?1:-1)*Math.PI),this.yaw=Ft(s,n,i.rotate)}copyFrom(e){le(this.center,e.center),this.pitch=e.pitch,this.yaw=e.yaw,this.distance=e.distance,le(this.lookAtDirection,e.lookAtDirection),this.size=e.size,this.copyFromCommon(e),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const r=this._lookAtOrientation(e.center,use);le(this.center,e.center),me(ta,e.center,e.eye),Ac(ta,ta,r),Ac(Uv,e.up,r),this.distance=Me(ta),this.distance!==0&&(ta[0]/=this.distance,ta[1]/=this.distance,ta[2]/=this.distance),this.pitch=this._eyeUpToPitch(ta),this.yaw=this._eyeUpToYaw(ta,Uv),this.size=Math.sqrt(e.width*e.width+e.height*e.height),this.copyFromCommon(e)}copyFromCommon(e){this.fov=e.fov,this._zoomToPanScale=Math.atan(.5*this.fov)}copyToRenderCamera(e){const r=this._lookAtOrientation(this.center,use);qh(r,r),this._axisAngleVec3(jc.sideway,this.pitch-Math.PI/2,jc.forward,ta),this._axisAngleVec3(jc.upward,this.yaw,ta),this._axisAngleVec3(jc.sideway,this.pitch-Math.PI/2,jc.upward,Uv),this._axisAngleVec3(jc.upward,this.yaw,Uv),ae(ta,ta,this.distance),Ac(ta,ta,r),Ac(Uv,Uv,r),e.center=this.center,e.eye=me(ta,this.center,ta),e.up=Uv}_axisAngleVec3(e,r,i,s=i){const n=Math.cos(r),o=Math.sin(r);return ae(Gc,i,n),pt(Zl,e,i),ae(Zl,Zl,o),ae(jy,e,(1-n)*ye(e,i)),fe(s,fe(s,Gc,Zl),jy)}_lookAtOrientation(e,r=es()){return this._upAtLookAt(e,jy),pt(Gc,this.lookAtDirection,jy),_e(Gc,Gc),Gc[0]===0&&Gc[1]===0&&Gc[2]===0&&le(Gc,jc.sideway),pt(Zl,jy,Gc),_e(Zl,Zl),r[0]=Gc[0],r[1]=Zl[0],r[2]=jy[0],r[3]=Gc[1],r[4]=Zl[1],r[5]=jy[1],r[6]=Gc[2],r[7]=Zl[2],r[8]=jy[2],r}_upAtLookAt(e,r){return this.viewingMode===Be.Local?le(r,jc.upward):_e(r,e)}_eyeUpToPitch(e){return Math.PI-_L(jc.upward,e)}_eyeUpToYaw(e,r){const i=_Ke;return Math.abs(r[2])<.5?(le(i,r),e[2]>0&&ae(i,i,-1)):le(i,e),pt(Zl,i,jc.upward),_e(Zl,Zl),_L(jc.sideway,Zl,jc.upward)}};const uF={desiredScreenFlow:2,minDuration:500,maxDuration:8e3};let vKe=class Dbe{constructor(e){this._createCamera=e,this.compared={sourceZoom:0,targetZoom:0,pan:0,rotate:0},this.settings={desiredScreenFlow:uF.desiredScreenFlow},this.source=e(),this.target=e()}clone(){const e=new Dbe(this._createCamera);return e.copyFrom(this),e}copyFrom(e){this.update(e.source,e.target,e.settings)}update(e,r,i){this.source!==e&&this.source.copyFrom(e),this.target!==r&&this.target.copyFrom(r),this.compared=this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=i.desiredScreenFlow!=null?i.desiredScreenFlow:uF.desiredScreenFlow,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(e){const r=this.target.pixelsPerPanAtZoom(e);return this.halfWindowSize/r}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>1e-9}get hasRotate(){return this.compared.rotate>1e-9}},bKe=class{constructor(){this.segments=[]}get time(){return this.segments.reduce((e,r)=>e+r.time,0)}interpolateComponentsAt(e,r){e=Math.min(Math.max(e,0),1),e*=this.time;let i=0,s=0;const n=this.definition;for(let o=0;o<this.segments.length;o++){const a=this.segments[o],l=a.definition;if(e<=a.time||o===this.segments.length-1){if(r=this.segmentInterpolateComponentsAt(a,a.time===0?0:e/a.time,r),n.hasPan&&!isNaN(r.pan)&&isFinite(n.compared.pan)?r.pan=(i+l.compared.pan*r.pan)/n.compared.pan:r.pan=1,n.hasRotate&&!isNaN(r.rotate)&&isFinite(n.compared.rotate)?r.rotate=(s+l.compared.rotate*r.rotate)/n.compared.rotate:r.rotate=1,n.hasZoom&&!isNaN(r.zoom)&&isFinite(l.compared.targetZoom)){const c=r.zoom*(l.compared.targetZoom-l.compared.sourceZoom)+l.compared.sourceZoom,h=this.segments[0].definition.compared.sourceZoom,p=this.segments[this.segments.length-1].definition.compared.targetZoom;r.zoom=(c-h)/(p-h)}else r.zoom=1;return r}e-=a.time,i+=l.compared.pan,s+=l.compared.rotate}}segmentInterpolateComponentsAt(e,r,i){return e.interpolateComponentsAt(r,i)}},M8=class{get time(){return this._time}constructor(e){e&&this.update(e)}update(e){e&&(this.definition?this.definition.copyFrom(e):this.definition=e.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const e=this.definition,r=e.compared,i=r.sourceZoom,s=r.targetZoom;this._zoomSign=i>s?1:-1,this._panPixelsAtSource=r.pan*e.source.pixelsPerPanAtZoom(i);const n=(e.source.pixelsPerRotateAtZoom(i)+e.target.pixelsPerRotateAtZoom(s))/2;this._rotatePixels=r.rotate*n}_updatePixelFlow(){const e=this.definition.compared.sourceZoom,r=this.definition.compared.targetZoom,{hasZoom:i,hasPan:s,hasRotate:n}=this.definition;let o=0,a=0;i&&(s&&(o=(r/e-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),n&&(a=this._zoomSign*(Math.log(e/r)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const l=this.definition.desiredPixelFlow;if(i&&s&&n){const c=o+a+o*a;this._zoomPixelFlow=o*a/c*l,this._panPixelFlow=a/c*l,this._rotatePixelFlow=o/c*l}else if(i&&s){const c=1+o;this._zoomPixelFlow=o/c*l,this._panPixelFlow=1/c*l}else if(i&&n){const c=1+a;this._zoomPixelFlow=a/c*l,this._rotatePixelFlow=1/c*l}else if(s&&n){const c=this._panPixelsAtSource/this._rotatePixels,h=1+c;this._panPixelFlow=c/h*l,this._rotatePixelFlow=1/h*l}else s?this._panPixelFlow=l:i?this._zoomPixelFlow=l:n&&(this._rotatePixelFlow=l);this._time=n?this.rotateTime:i?this.zoomTime:s?this.panTime:0}get rotateTime(){return this.definition.hasRotate?this._rotatePixels/this._rotatePixelFlow:0}get zoomTime(){return this.definition.hasZoom?this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow:0}get panTime(){if(this.definition.hasPan){if(this.definition.hasZoom){const e=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,r=e*this._panPixelsAtSource;return Math.log(r*(this._zoomPixelFlow/this._panPixelFlow)+1)/(e*this._zoomPixelFlow)}return this._panPixelsAtSource/this._panPixelFlow}return 0}_interpolateComponentsZoom(e){if(e===0||e===1)return e;if(this.definition.hasZoom){const r=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom;return(r*(r/i)**-e-r)/(i-r)}return e}_interpolateComponentsPan(e){if(e===0||e===1)return e;if(this.definition.hasPan&&this.definition.hasZoom){const r=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(r*e*this._time)-1))/(r*Math.LN2)}return e}_interpolateComponentsRotate(e){return e}interpolateComponentsAt(e,r){e=Math.min(Math.max(e,0),1);const i=this._interpolateComponentsZoom(e),s=this._interpolateComponentsPan(e),n=this._interpolateComponentsRotate(e);return r?(r.zoom=i,r.pan=s,r.rotate=n):r={zoom:i,pan:s,rotate:n},r}};function wKe(t,e,r){const i=e-t.compared.sourceZoom,s=t.halfWindowPanAtZoom(i);return-t.halfWindowSize*(r.ascensionFactor*Math.LN2*t.compared.pan+s)*Math.log(t.compared.sourceZoom/e)/(t.desiredPixelFlow*Math.LN2*s)}function xKe(t,e,r){const i=1/e,s=Math.log(t.compared.sourceZoom*i),n=1/t.desiredPixelFlow,o=1/Math.LN2,a=e-t.compared.sourceZoom,l=1/a,c=(r.ascensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(a))/t.halfWindowPanAtZoom(1);return t.halfWindowSize*i*n*o*l*c-t.halfWindowSize*s*n*o*l+t.halfWindowSize*s*n*o*c/(a*a)}function TKe(t,e,r){const i=e-t.compared.sourceZoom,s=1/i,n=1/e,o=Math.log(t.compared.sourceZoom*n),a=(r.ascensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(i))/t.halfWindowPanAtZoom(1);return t.halfWindowSize*s*(-2*s*n*a+2*s*o+2*n-2*o*a/(i*i)-a/(e*e))/(t.desiredPixelFlow*Math.LN2)}function SKe(t,e){return-t.halfWindowSize*Math.log(t.compared.sourceZoom/e)/(t.desiredPixelFlow*Math.LN2)}function EKe(t,e){return t.halfWindowSize/(e*t.desiredPixelFlow*Math.LN2)}function CKe(t,e){return-t.halfWindowSize/(e*e*t.desiredPixelFlow*Math.LN2)}function AKe(t,e,r){return-t.compared.pan*t.halfWindowSize*(r.ascensionFactor+r.descensionFactor-1)/(t.desiredPixelFlow*t.halfWindowPanAtZoom(e))}function RKe(t,e,r){return t.compared.pan*t.halfWindowSize*(r.ascensionFactor+r.descensionFactor-1)/(t.desiredPixelFlow*t.halfWindowPanAtZoom(e*e))}function OKe(t,e,r){return-2*t.compared.pan*t.halfWindowSize*(r.ascensionFactor+r.descensionFactor-1)/(t.desiredPixelFlow*t.halfWindowPanAtZoom(e*e*e))}function MKe(t,e,r){return t.halfWindowSize*(-t.halfWindowPanAtZoom(e)-r.descensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(t.compared.targetZoom))*Math.log(e/t.compared.targetZoom)/(t.desiredPixelFlow*Math.LN2*t.halfWindowPanAtZoom(-e+t.compared.targetZoom))}function PKe(t,e,r){const i=Math.log(e/t.compared.targetZoom),s=1/t.desiredPixelFlow,n=1/Math.LN2,o=-e+t.compared.targetZoom,a=1/o,l=(-t.halfWindowPanAtZoom(e)-r.descensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(t.compared.targetZoom))/t.halfWindowPanAtZoom(1);return-t.halfWindowSize*i*s*n*a+t.halfWindowSize*i*s*n*l/(o*o)+t.halfWindowSize*s*n*a*l/e}function IKe(t,e,r){const i=e-t.compared.targetZoom,s=1/i,n=1/e,o=Math.log(e/t.compared.targetZoom),a=(t.halfWindowPanAtZoom(e)+r.descensionFactor*Math.LN2*t.compared.pan-t.halfWindowPanAtZoom(t.compared.targetZoom))/t.halfWindowPanAtZoom(1);return t.halfWindowSize*s*(-2*s*n*a-2*s*o+2*n+2*o*a/(i*i)-a/(e*e))/(t.desiredPixelFlow*Math.LN2)}function $Ke(t,e){return t.halfWindowSize*Math.log(e/t.compared.targetZoom)/(t.desiredPixelFlow*Math.LN2)}function LKe(t,e){return t.halfWindowSize/(e*t.desiredPixelFlow*Math.LN2)}function DKe(t,e){return-t.halfWindowSize/(e*e*t.desiredPixelFlow*Math.LN2)}function NKe(t){const e=Math.LN2*t.compared.pan,r=t.compared.sourceZoom-t.compared.targetZoom,i=t.halfWindowPanAtZoom(r),s=t.halfWindowSize*Math.log(t.compared.sourceZoom/t.compared.targetZoom)/(t.desiredPixelFlow*Math.LN2*i);return t.compared.sourceZoom<=t.compared.targetZoom?s*(e-i):s*(e+i)}function FKe(t,e){let r=UKe(t,e);const i={ascensionFactor:e.ascensionFactor!=null?e.ascensionFactor:.5,descensionFactor:e.descensionFactor!=null?e.descensionFactor:.5},s=i.ascensionFactor===0,n=i.descensionFactor===0,o=s?SKe:wKe,a=s?EKe:xKe,l=s?CKe:TKe,c=n?$Ke:MKe,h=n?LKe:PKe,p=n?DKe:IKe,f=E=>o(t,E,i)+AKe(t,E,i)+c(t,E,i),m=E=>a(t,E,i)+RKe(t,E,i)+h(t,E,i),y=E=>l(t,E,i)+OKe(t,E,i)+p(t,E,i);let _=f(r);const b=NKe(t);let x;const T=e.maximumIterations||20,S=e.maximumDistance!=null?e.maximumDistance:1/0;for(x=0;x<T;x++){const O=(m(r)+1e-6)/y(r);if(isNaN(O)||r>=S&&O<0){if(!isFinite(S))return null;r=S,_=f(r);break}if(r-=O,r<t.compared.sourceZoom||r<t.compared.targetZoom)return null;const R=f(r);if(Math.abs(R-_)/_<=.005)break;_=R}return _>b*(1-.3)||r<t.compared.sourceZoom||r<t.compared.targetZoom?null:r}function UKe(t,e){const r=Math.max(t.compared.sourceZoom,t.compared.targetZoom),i=t.source.zoomAtPixelsPerPan(t.desiredPixelFlow/t.compared.pan)/2;return i<r?e.maximumDistance!=null?r+(e.maximumDistance-r)/2:1.5*r:e.maximumDistance?Math.min(e.maximumDistance,i):i}let kKe=class extends bKe{constructor(e,r){super(),this._preallocSegments=[new M8,new M8,new M8],this._ascensionSegment=null,this._descensionSegment=null,this.update(e,r)}update(e,r){if(!e)return;this.definition?this.definition.copyFrom(e):this.definition=e.clone();let i=null;r&&r.apex&&(i=FKe(e,r.apex)),this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,i==null?this._updateWithoutApex():this._updateWithApex(i,r==null?void 0:r.apex)}segmentInterpolateComponentsAt(e,r,i){return i=e.interpolateComponentsAt(r,i),e===this._ascensionSegment?i.zoom=zY(i.zoom):e===this._descensionSegment&&(i.zoom=I5(i.zoom)),i}_updateWithApex(e,r){const[i,s,n]=this._preallocSegments,o=(r==null?void 0:r.ascensionFactor)??.5,a=Math.min(1-o,(r==null?void 0:r.ascensionFactor)!=null&&r.descensionFactor!=null?r.descensionFactor:.5),l=1-o-a;i.definition?i.definition.copyFrom(this.definition):i.definition=this.definition.clone(),i.definition.compared.targetZoom=e,i.definition.compared.pan=this.definition.compared.pan*o,i.definition.compared.rotate=this.definition.compared.rotate*o,i.update(),this._ascensionSegment=i,this.segments.push(i),l>0&&(s.definition?s.definition.copyFrom(this.definition):s.definition=this.definition.clone(),s.definition.copyFrom(this.definition),s.definition.compared.sourceZoom=e,s.definition.compared.targetZoom=e,s.definition.compared.pan=this.definition.compared.pan*l,s.definition.compared.rotate=this.definition.compared.rotate*l,s.update(),this.segments.push(s)),n.definition?n.definition.copyFrom(this.definition):n.definition=this.definition.clone(),n.definition.compared.sourceZoom=e,n.definition.compared.pan=this.definition.compared.pan*a,n.definition.compared.rotate=this.definition.compared.rotate*a,n.update(),this._descensionSegment=n,this.segments.push(n)}_updateWithoutApex(){const[e]=this._preallocSegments;e.update(this.definition),this.segments.push(e)}};const VKe={zoom:0,pan:0,rotate:0};let BKe=class{get time(){return this._time}constructor(e){this._createCamera=e,this._time=0,this.definition=new vKe(e),this.path=new kKe}update(e,r,i){this.definition.update(e,r,i),this.path.update(this.definition,i),this._time=this._applyTimeSettings(pue(isFinite(this.path.time)?this.path.time:0),i),this._easing=i.easing?i.easing:this._time>=1e3?Lbe:MM}cameraAt(e,r){r=r||this._createCamera(),e=Math.min(Math.max(0,e),1),e=this._normalizedEasing(e);const i=this.path.interpolateComponentsAt(e,VKe);return r.interpolate(this.definition.source,this.definition.target,i),r}_normalizedEasing(e){const r=this._easing(0,this._time),i=this._easing(1,this._time);return(this._easing(e,this._time)-r)/(i-r)}_applyTimeSettings(e,r){const i=r.speedFactor!=null?r.speedFactor:1;r.duration!=null?e=r.duration:r.speedFactor!=null&&(e=e/i);const s=r.minDuration!=null?r.minDuration:uF.minDuration/i,n=r.maxDuration!=null?r.maxDuration:uF.maxDuration/i;return Math.min(Math.max(s,e),n)}};const zKe=M();let GKe=class{get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}constructor(e){this.currentTime=0,this._animation=new BKe(()=>new hse(e)),this._current=new hse(e)}update(e,r,i){const s=this._animation.definition.source,n=this._animation.definition.target,o=me(zKe,r.center,e.center),a=Me(o);a>=1e-5?(o[0]/=a,o[1]/=a,o[2]/=a):(o[0]=0,o[1]=1,o[0]=0),le(s.lookAtDirection,o),le(n.lookAtDirection,o),s.copyFromRenderCamera(e),n.copyFromRenderCamera(r),this._current.copyFrom(s),this._animation.update(s,n,i),this.currentTime=0,e.almostEquals(r)&&(this.currentTime=this._animation.time)}cameraAt(e,r){return this._animation.cameraAt(e,this._current),r=r||new Ct,this._current.copyToRenderCamera(r),r}step(e,r){return this.finished||(this.currentTime=this.currentTime+pue(e),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,r)}};var os;(function(t){t.Ready="ready",t.Rejected="rejected",t.Running="running",t.Stopped="stopped",t.Finished="finished"})(os||(os={}));let Cg=class extends Te{constructor(e){super(e),this.state=os.Ready}get active(){return this.state===os.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=os.Stopped,!0)}finishController(){this.state=os.Finished}get steppingFinished(){return!1}};u([d({constructOnly:!0})],Cg.prototype,"view",void 0),u([d({readOnly:!0})],Cg.prototype,"active",null),u([d()],Cg.prototype,"state",void 0),u([d({readOnly:!0})],Cg.prototype,"isInteractive",null),Cg=u([I("esri.views.3d.state.controllers.CameraController")],Cg);let _O=class extends Cg{constructor(){super(...arguments),this._asyncResult=null}get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject(Hr()),this._asyncResult=null),this.state===os.Finished||this.state===os.Stopped?(e4(e),this.state===os.Finished?e.resolve():e.reject(Hr())):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=os.Running,v(this.viewAnimation)&&this.viewAnimation.when(()=>this.updateStateFromViewAnimation(),()=>this.updateStateFromViewAnimation())}updateStateFromViewAnimation(){!v(this.viewAnimation)||this.state!==os.Ready&&this.state!==os.Running||(this.viewAnimation.state===YS.State.FINISHED?this.finish():this.viewAnimation.state===YS.State.STOPPED&&(this.state=os.Stopped))}onControllerEnd(){v(this.viewAnimation)&&!this.viewAnimation.done&&(this.state===os.Finished?this.viewAnimation.finish():this.state===os.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===os.Finished?this._asyncResult.resolve():this._asyncResult.reject(Hr()))}finish(){this.finishController()}};_O=u([I("esri.views.3d.state.controllers.AnimationController")],_O);let Dg=class extends _O{get intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.mode="interaction",this._hasTarget=!1}initialize(){this.animation=new GKe(this.view.state.viewingMode),this.viewAnimation=this.mode==="interaction"?null:new YS}get isInteractive(){return this.mode==="interaction"}begin(e,r){this._hasTarget=!0;const i=this.animationSettings(r);aI.copyFrom(this.view.state.camera);const s=Wh(this.view.state.viewingMode);this.intersectionHelper.intersectRay(aI.ray,s,dse)&&(aI.center=dse),this.animation.update(aI,e,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this._hasTarget&&this.animation.finished}stepController(e,r){this._hasTarget&&this.animation.step(e,r)}onControllerEnd(e){this._hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...e,easing:typeof e.easing=="string"?dKe[e.easing]:e.easing}}};u([d({constructOnly:!0})],Dg.prototype,"mode",void 0),u([d({readOnly:!0})],Dg.prototype,"isInteractive",null),Dg=u([I("esri.views.3d.state.controllers.PointToPointAnimationController")],Dg);const aI=new Ct,dse=M();function $5(t=HKe){return[t[0],t[1],t[2],t[3]]}function vO(t,e){return jKe(t[0],t[1],t[2],e,AW.get())}function jKe(t,e,r,i,s=$5()){return s[0]=t,s[1]=e,s[2]=r,s[3]=i,s}function YY(t,e,r){return pt(r,t,e),_e(r,r),r[3]=MW(t,e),r}const HKe=[0,0,1,0];function Nbe(t,e,r){return qKe(t,t.screenToRender(e,je.get()),r)}function qKe(t,e,r){const i=Un(je.get(),e);if(i[2]=0,!t.unprojectFromRenderScreen(i,r.origin))return null;const s=Un(je.get(),e);s[2]=1;const n=t.unprojectFromRenderScreen(s,je.get());return C(n)?null:(me(r.direction,n,r.origin),r)}function GE(t,e,r){return ZY(t,t.screenToRender(e,je.get()),r)}function ZY(t,e,r){le(r.origin,t.eye);const i=ce(je.get(),e[0],e[1],1),s=t.unprojectFromRenderScreen(i,je.get());return C(s)?null:(me(r.direction,s,r.origin),r)}function JY(t,e,r,i){const s=GE(e,r,WKe);return _v(t,s,i)}const WKe=ro();var iE;(function(t){t[t.Ellipsoid=0]="Ellipsoid",t[t.Silhouette=1]="Silhouette"})(iE||(iE={}));const Fbe=30,hF=[1,3e8],L5=80,Ube=8,kbe=200,Vbe=1508e5,Bbe=5,zbe=50,XKe=5,YKe=10,P8=90,rx={exclude:new Set([c_])};function Kb(t,e,r){return r[0]=e[0]/(t.fullWidth/t.pixelRatio),r[1]=e[1]/(t.fullHeight/t.pixelRatio),r}function xj(t){for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;return t}function av(t,e,r){const i=$u(RW.get(),r[3],r);C(i)||afe(i,Lu)||(me(ci,t.eye,e),We(ci,ci,i),t.eye=fe(ci,ci,e),me(ci,t.center,e),We(ci,ci,i),t.center=fe(ci,ci,e),t.up=We(ci,t.up,i))}function ZKe(t,e,r,i){return Zw(t,Nbe(e,r,eZ),i)}function Tj(t,e,r,i){return Zw(t,GE(e,r,eZ),i)}function KY(t,e,r,i){const s=je.get();let n=1-r;me(s,e,t.eye);const o=Me(s);let a=o*(1-n);n>=0&&a<i&&(a=i,n=-(a-o)/o),Math.abs(o-a)<1e-6||(ae(s,s,n),t.eye=fe(ci,t.eye,s),t.center=Ys(ci,t.center,e,n))}function Gbe(t,e,r){e.getScreenCenter(pse),JY(t,e,pse,ci)&&(e.center=ci);const i=e.distance,s=i*r;if(Math.abs(i-s)<1e-6)return;const n=ae(je.get(),e.viewForward,s);e.eye=me(ci,e.center,n)}const pse=as();function I8(t,e){ce(e,0,0,0);for(const r of t)fe(e,e,r);ae(e,e,1/t.length)}function cD(t,e,r,i){return Math.sin(t/Me(e))*(r+i.radius)}function fse(t,e,r,i){return cD(Math.PI/2,e,r,i)+(t-Math.PI/2)}var io;(function(t){t[t.Vertical=0]="Vertical",t[t.Horizontal=1]="Horizontal"})(io||(io={}));const mse={Elevation:3e4,Angle:Gt(16)},lI={Pole:.95,Angle:Gt(18),Tilt:45},jbe=Gt(80);function Hbe(t,e,r,i,s,n){const o=M(),a=on();let l=!0,c=!0;return t.intersectScreen(r,o,n)?a[3]=Me(o):(c=!1,e.aboveGround&&s!==iE.Ellipsoid?a[3]=Math.max(Me(e.center),.9*i.radius):a[3]=Me(e.eye)-e.relativeElevation,s===iE.Silhouette?bO(a,e,r,o):l=JY(a,e,r,o)),{sphere:a,scenePickPoint:l?o:null,hasGeometryIntersection:c}}function D5(t,e,r){return Me(t.eye)-r.radius>mse.Elevation?io.Horizontal:(GE(t,e,Tse),-Math.sign(t.relativeElevation)*(.5*Math.PI+MW(t.eye,Tse.direction))<mse.Angle?io.Vertical:io.Horizontal)}function qbe(t,e,r){me($8,r,e),t.eye=me(ci,t.eye,$8),t.center=me(ci,t.center,$8)}const $8=M();function bO(t,e,r,i){const s=GE(e,r,eZ);return!C(s)&&(OE(t,s,cI),_v(t,s,i)?!(Ro(cI,s.origin)<Ro(i,s.origin))||(le(i,cI),!1):(me(Ex,e.eye,e.center),_e(Ex,Ex),hme(Ex,-ye(_e(Ex,Ex),cI),gse),Zw(gse,s,i),!1))}const cI=M(),Ex=M(),gse=zr();function Wbe(t,e,r,i,s,n){let o=0;if(pt(fF,t,e),me(pI,t,e),Me(t)<=s||!i.aboveGround){pt(r,pI,i.eye);const a=ye(t,e)/(Me(t)*Me(e));if(a<.9999)o=Sn(a);else{const c=Me(pt(M(),t,e))/(Me(t)*Me(e));o=Uh(c)}const l=Math.cos(ge(X_.normalize(Gt(n)),0,jbe));o=-o-Math.max(0,Me(e)-s)/(l*s)}else me(yse,i.eye,i.center),pt(r,pI,yse),o=-Me(pI)/s;return _e(r,r),ae(r,r,Me(fF)),o}const yse=M();function _se(t,e,r,i){let s,n;const o=Math.cos(ge(X_.normalize(Gt(i)),0,jbe));return s=e>r?-(e-r)/(o*r):e<-r?Math.PI-(e+r)/(o*r):Sn(e/r),n=t>r?-(t-r)/(o*r):t<-r?Math.PI-(t+r)/(o*r):Sn(t/r),(n-s)*r}function JKe(t,e,r,i,s,n,o,a,l,c){const h=_se(t[2],e[2],n[3],a),p=l?_se(t[0],e[0],n[3],180):e[0]-t[0],f=Math.sin(o)*p-Math.cos(o)*h,m=Math.cos(o)*p+Math.sin(o)*h;_e(ci,s);const y=l?f/Math.sqrt(Math.abs(n[3]**2-ye(r,ci)**2)):f/n[3],_=m/Math.sqrt(Math.abs(n[3]**2-ye(r,i)**2));or(c,y,_)}function Xbe(t,e,r,i,s,n,o,a,l,c){pt(fF,t,e),nz(n.up,n.eye,uI,hI,dI),nz([0,0,1],n.eye,zg,V_,Kbe),le(r,V_),le(i,zg),_e(r,r),ae(r,r,Me(fF)),vQ(t,_e(hI,hI),_e(dI,dI),_e(uI,uI),vse),vQ(e,hI,dI,uI,bse),JKe(vse,bse,t,zg,V_,o,a,l,c,s)}function KKe(t,e,r,i,s,n,o){$u(dF,s,i),$u(pF,o,n),gs(M2,dF,pF),me(e,t,r),We(e,e,M2),fe(e,e,r)}function Ybe(t,e,r,i,s,n){$u(dF,i,r),$u(pF,n,s),gs(M2,dF,pF),me(ci,t.eye,e),We(ci,ci,M2),t.eye=fe(ci,ci,e),me(ci,t.center,e),We(ci,ci,M2),t.center=fe(ci,ci,e),me(ci,t.up,e),We(ci,ci,M2),t.up=fe(ci,ci,e)}function QY(t,e,r,i,s,n){return(Math.abs(i)>Math.PI-lI.Angle||Math.abs(i)<lI.Angle)&&(Math.abs(t[2])<r*lI.Pole||Math.abs(e)>r)&&n.aboveGround&&s<lI.Tilt}function Zbe(t,e,r,i,s,n){if(n)YY(r,i,wse),av(e,t,wse);else{const o=Wbe(r,i,xse,e,t[3],s);av(e,t,vO(xse,o))}}function Jbe(t,e,r,i,s,n,o){const a=o?20:1,l=1e-12;let c,h;le(kv,i),fI.copyFrom(e);for(let p=0;p<a&&Ro(r,kv)>l&&(c=Ro(r,kv),Xbe(r,kv,V_,zg,TC,fI,t,s,n,o),Ybe(fI,t,zg,TC[1],V_,TC[0]),KKe(kv,kv,t,zg,TC[1],V_,TC[0]),h=Ro(r,kv),h<c||p===0);p++)e.copyFrom(fI)}function QKe(t,e,r,i,s,n,o){QY(r,ye(e.up,r),t[3],-X_.normalize(Gt(s)),n,e)?Jbe(t,e,r,i,-X_.normalize(Gt(s)),n,o):Zbe(t,e,r,i,n,o)}function eQe(t,e,r,i,s,n){const{eye:o}=t;nz([0,0,1],o,zg,V_,Kbe);const a=e.translation[0]*r.pan,l=s.mode==="zoom"?0:e.translation[1]*r.pan,c=Math.max(Math.sqrt(Math.abs(1-ye(t.center,zg)**2/Me(t.center)**2)),.5),h=(Math.sin(n)*l+Math.cos(n)*a)/c,p=-Math.cos(n)*l+Math.sin(n)*a;switch(Rc(i.pan.matrix,i.pan.matrix,h,zg),i.pan.enabled=!0,s.mode){case"pan":Rc(i.pan.matrix,i.pan.matrix,p,V_),i.pan.enabled=!0;break;case"zoom":i.zoom=-e.translation[1]*r.zoom}}function tQe(t,e,r,i,s){const{eye:n,viewRight:o}=t,a=pt(je.get(),o,n),l=e.translation[0]*r.pan;switch(l!==0&&(Rc(i.pan.matrix,i.pan.matrix,-l,a),i.pan.enabled=!0),s.mode){case"pan":{const c=e.translation[1]*r.pan;c!==0&&(Rc(i.pan.matrix,i.pan.matrix,c,o),i.pan.enabled=!0);break}case"zoom":i.zoom=-e.translation[1]*r.zoom}}function rQe(t,e,r,i,s,n,o,a,l){QY(t.center,ye(t.up,t.center),Me(t.center),-X_.normalize(Gt(n)),o,e)?eQe(e,r,i,a,l,-X_.normalize(Gt(s))):tQe(e,r,i,a,l)}const zg=M(),V_=M(),Kbe=M(),uI=M(),hI=M(),dI=M(),vse=M(),bse=M(),TC=Je(),wse=$5(),dF=Ie(),pF=Ie(),M2=Ie(),kv=M(),ci=M(),pI=M(),fI=new Ct,fF=M(),xse=M(),eZ={origin:M(),direction:M()},Tse={origin:M(),direction:M()},Sse=.6,L8=4,iQe=60;let mF=class extends Dg{constructor(){super(...arguments),this._zoomLocation=M(),this._tmpCamera=new Ct,this._tmpViewDir=M(),this._tmpRayDir={origin:M(),direction:M()},this._targetOnSphere=M(),this._tmpCenter=M(),this._constraintOptions={selection:Di.ALL_EXCEPT_COLLISION,interactionType:nr.ZOOM,interactionFactor:null,interactionStartCamera:new Ct,interactionDirection:null,tiltMode:oo.TUMBLE},this._sphere=on()}initialize(){this._intersector=Wh(this.view.state.viewingMode)}zoomStep(e,r){if(!this.active)return;const i=this.view.state,{interactionStartCamera:s}=this._constraintOptions;s&&(this.animation.finished?s.copyFrom(i.camera):this.animation.cameraAt(1,s));let n=!1,o=!1;this.intersectionHelper.intersectScreen(r,this._zoomLocation,this.view.map.ground.opacity===0?rx:{})&&(n=e>0,o=!0),this._tmpCamera.copyFrom(i.camera),n?this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:le(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,this._zoomLocation,r,o),this.begin(this._tmpCamera)}animationSettings(){return{duration:600,easing:MM}}_updateCamera(e,r,i,s,n){const o=Jr(this.view.spatialReference),a=D5(e,s,o),l=Math.abs(this.view.camera.position.z);_e(gI,e.eye),ae(gI,gI,-1),GE(e,s,this._tmpRayDir),_e(this._tmpRayDir.direction,this._tmpRayDir.direction);const c=ge(Math.min(Ube,1/Math.abs(ye(gI,this._tmpRayDir.direction)))*l,kbe,Vbe);if(a===io.Horizontal){let h=Sse**r;this._sphere[3]=Me(i),me(this._tmpViewDir,e.center,e.eye);const p=Math.min(Me(this._tmpViewDir),c);let f=p*h;if(h<=1&&f<L8&&(f=L8,h=f/p),Math.abs(p-f)<1e-6)return;const m=Me(e.center);if(this._sphere[3]!==m){const y=this._sphere[3]+h*(m-this._sphere[3]);e.center=ae(mI,e.center,y/m)}ae(this._tmpViewDir,this._tmpViewDir,-h),e.eye=fe(mI,e.center,this._tmpViewDir),Hs(this.view,e,this._constraintOptions),Ro(i,e.center)>1e-12&&JY(this._sphere,e,s,this._targetOnSphere)&&QKe(this._sphere,e,i,this._targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let h=Sse**Math.abs(r);const p=r>0?1:-1;me(this._tmpViewDir,i,e.eye);const f=Me(this._tmpViewDir),m=this.view._stage.renderView.getMinimalDepthForArea(null,s[0],s[1],this.view.state.camera,iQe);let y=v(m)?m:c;y=n&&r>0?Math.min(y,f):y,ae(this._tmpRayDir.direction,this._tmpRayDir.direction,y),fe(i,this._tmpRayDir.origin,this._tmpRayDir.direction);let _=y*h;const b=Math.max(L8,1.01*e.nearFar[0]);if(r>0&&_<b&&(_=b,h=_/y),Math.abs(y-_)<1e-6)return;ae(this._tmpRayDir.direction,this._tmpRayDir.direction,p*(1-h)),e.eye=fe(mI,e.eye,this._tmpRayDir.direction),e.center=fe(mI,e.center,this._tmpRayDir.direction)}zE(this.view,e)}};mF=u([I("esri.views.3d.state.controllers.global.ZoomStepController")],mF);const mI=M(),gI=M(),sQe=.6,nQe=4,oQe=60;let gF=class extends Dg{constructor(){super(...arguments),this._zoomLocation=M(),this._tmpCamera=new Ct,this._tmpRayDir=M(),this._tmpCenter=M(),this._constraintOptions={selection:Di.ALL,interactionType:nr.ZOOM,interactionFactor:null,interactionStartCamera:new Ct,interactionDirection:null,tiltMode:oo.TUMBLE}}zoomStep(e,r){if(!this.active)return;const i=this.view.state,{interactionStartCamera:s}=this._constraintOptions;s&&(this.animation.finished?s.copyFrom(i.camera):this.animation.cameraAt(1,s)),this._tmpCamera.copyFrom(i.camera);const n=Wh(this.view.state.viewingMode);let o=!1;e>0?(o=this.intersectionHelper.intersectScreenFreePointFallback(r,this._zoomLocation,this.view.map.ground.opacity===0?rx:{}),this.intersectionHelper.intersectRay(this._tmpCamera.ray,n,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this.intersectionHelper.intersectRay(this._tmpCamera.ray,n,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:le(this._zoomLocation,this._tmpCamera.center);const a=sQe**e;let l=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,r[0],r[1],this.view.state.camera,oQe);me(yI,this._tmpCamera.eye,this._zoomLocation),_e(yI,yI);const c=ge(Math.min(Ube,1/Math.abs(ye(aQe,yI)))*Math.abs(this.view.camera.position.z),kbe,Vbe);if(l=v(l)?l:c,l){const h=M();me(h,this._zoomLocation,this._tmpCamera.eye),(l<Me(h)||!o)&&(_e(h,h),fe(this._zoomLocation,this._tmpCamera.eye,ae(h,h,l)))}this._updateCamera(this._tmpCamera,a,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{duration:600,easing:MM}}_updateCamera(e,r,i){me(this._tmpRayDir,i,e.eye);const s=Me(this._tmpRayDir);let n=s*r;const o=r<=1,a=Math.max(nQe,1.01*e.nearFar[0]);n!==0&&(o&&n<a&&(n=a,r=n/s),Math.abs(s-n)<1e-6||(ae(this._tmpRayDir,this._tmpRayDir,r),e.eye=me(Ese,i,this._tmpRayDir),e.center=Ys(Ese,e.center,i,1-r),Hs(this.view,e,this._constraintOptions)))}};gF=u([I("esri.views.3d.state.controllers.local.ZoomStepController")],gF);const Ese=M(),aQe=$e(0,0,1),yI=M();function lQe(t,e){switch(e){case"primary":return t.pointerType==="touch"||t.button===0;case"secondary":return t.pointerType!=="touch"&&t.button===2;case"tertiary":return t.pointerType!=="touch"&&t.button===1}}function tZ(t,e){if(t.pointerType==="touch")return!1;switch(e){case"primary":return t.button===0;case"secondary":return t.button===2;case"tertiary":return t.button===1}}let cQe=class extends $o{constructor(e,r){super(!0),this._view=e,this.registerIncoming("double-click",r,i=>this._handleDoubleClick(i))}_handleDoubleClick(e){const r=e.data;if(lQe(r,"primary")){const i=this._view.state.isGlobal?new mF({view:this._view,mode:"animation"}):new gF({view:this._view,mode:"animation"});this._view.state.switchCameraController(i),i.zoomStep(Math.log(.5)/Math.log(.6),as(r.x,r.y)),e.stopPropagation()}}};function uQe(t,e,r){return t===Be.Global?new dQe(r):new hQe(e,r)}let hQe=class{constructor(e,r){this._elevationProvider=e,this._referenceEllipsoid=Jr(r),this._unitInMeters=nl(r,this._referenceEllipsoid.metersPerDegree)}compute(e,r,i,s,n){var S;n||(n={near:0,far:0});let o=e[2]*this._unitInMeters;const a=o,l=o-s,c=(S=this._elevationProvider)==null?void 0:S.visibleElevationBounds;c&&(o=l>=0?a-this._unitInMeters*c.min:this._unitInMeters*c.max-a);const h={x:(i=v(i)?i:new Zr({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-i.xmin,y:i.ymax-i.ymin,z:4*Math.max(i.xmax-i.xmin,i.ymax-i.ymin)},p=Math.max(h.x,h.y,h.z);me(Vv,r,e),Cx[0]=Vv[0]>0?i.xmax:i.xmin,Cx[1]=Vv[1]>0?i.ymax:i.ymin,Cx[2]=Vv[2]>0?p/2:-p/2,me(Cx,Cx,e),_e(Vv,Vv);const f=1.1*ye(Cx,Vv)*this._unitInMeters,m=Math.sqrt(o*(o+2*this._referenceEllipsoid.radius)),y=Math.max(i.xmax-i.xmin,i.ymax-i.ymin),_=y*mQe*this._unitInMeters,b=y*gQe*this._unitInMeters,x=ge((o-b)/(_-b),0,1)**3,T=Math.min(Ft(m,f,x),m)*Math.max(Math.log(Math.abs(l)),1);return Qbe(Math.min(T,Math.max(34064e4,p))/this._unitInMeters,pQe,this._unitInMeters,n)}},dQe=class{constructor(e){this._referenceEllipsoid=Jr(e)}compute(e,r,i,s,n){n||(n={near:0,far:0});const o=Me(e),a=o-this._referenceEllipsoid.radius,l=this._referenceEllipsoid.radius+Math.min(0,s),c=Math.abs(a-s),h=Math.max(c,Math.abs(a)),p=Math.sqrt(h*(h+2*l)),f=o+this._referenceEllipsoid.radius;return Qbe(1.2*Ft(p,f,QX(h)),ge(2e4-(Math.log(h)-7.983)/9.011*19e3,1e3,2e4),1,n)}};function Qbe(t,e,r,i){const s=fQe/r;return t/e>s?(i.far=t,i.near=i.far/e):(i.near=s,i.far=i.near*e),i}const pQe=2e4,fQe=2,mQe=.001,gQe=1e-4,Cx=M(),Vv=M();let uD=class extends Te{constructor(e){super(e)}initialize(){this.addHandles(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e)))}_handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const r=this.view.state.camera;v(e.spatialReference)&&Ebe(this.view,r,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera(e=>zE(this.view,e,Ph.EYE_AND_CENTER))}};u([d({constructOnly:!0})],uD.prototype,"view",void 0),uD=u([I("esri.views.3d.state.ElevationCollisionConstraint")],uD);let y3=class extends Te{constructor(e){super(e),this.nearFarHeuristic=uQe(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){this.addHandles([ie(()=>{var e,r,i,s;return[(r=(e=this.view.constraints)==null?void 0:e.clipDistance)==null?void 0:r.near,(s=(i=this.view.constraints)==null?void 0:i.clipDistance)==null?void 0:s.far]},()=>this._clipDistanceNearFarChanged()),ie(()=>{var e,r;return(r=(e=this.view.constraints)==null?void 0:e.clipDistance)==null?void 0:r.mode},()=>this._updateNearFar()),this.view.state.events.on("before-camera-change",e=>this._updateCameraNearFar(e)),ie(()=>this.view.renderDataExtent,()=>this._updateNearFar(),ri),ie(()=>{var e,r,i,s;return[(r=(e=this.view.constraints)==null?void 0:e.altitude)==null?void 0:r.min,(s=(i=this.view.constraints)==null?void 0:i.altitude)==null?void 0:s.max]},()=>this._updateAltitude(),ri),ie(()=>{var e,r;return(r=(e=this.view.constraints)==null?void 0:e.tilt)==null?void 0:r.max},()=>this._updateTiltMax(),ri),ie(()=>{var e,r;return(r=(e=this.view.constraints)==null?void 0:e.tilt)==null?void 0:r.mode},()=>this._updateTilt(),ri),ie(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},()=>this._updateTiltAutoMax(),ri),ie(()=>{var e,r,i,s,n,o;return[(i=(r=(e=this.view.map)==null?void 0:e.ground)==null?void 0:r.navigationConstraint)==null?void 0:i.type,(o=(n=(s=this.view.state)==null?void 0:s.constraints)==null?void 0:n.collision)==null?void 0:o.enabled]},()=>this._updateCollision(),ri)]),this.view.state.isLocal&&this.addHandles(ie(()=>this.view.renderDataExtent,e=>this._updateLocalSurfaceDistance(e),Vt)),this._updateNearFar(),this.view.state.viewingMode!==Be.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new uD({view:this.view}))}destroy(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){var r;const e=(r=this.view.constraints)==null?void 0:r.clipDistance;e&&e.mode!=="auto"&&this.view.state.updateCamera(i=>this._updateCameraNearFarManual(i,e))}_updateNearFar(){this.view.state.updateCamera(e=>this._updateCameraNearFar(e))}_updateCameraNearFar(e){const r=this.view.constraints&&this.view.constraints.clipDistance;(r?r.mode:"auto")==="manual"?this._updateCameraNearFarManual(e,r):this._updateCameraNearFarAuto(e,r)}_updateCameraNearFarAuto(e,r){this.nearFarHeuristic.compute(e.eye,e.center,this.view.renderDataExtent,P5(this.view,e.eye),e),r&&r.autoUpdate(e.near,e.far)}_updateCameraNearFarManual(e,r){r&&(e.near=r.near,e.far=r.far)}_updateCollision(){var s,n,o;const e=(o=(n=(s=this.view.map)==null?void 0:s.ground)==null?void 0:n.navigationConstraint)==null?void 0:o.type,r=!e||e==="stay-above",i=this.view.state.constraints.collision;if(r!==i.enabled){i.enabled=r,r&&this._reapplyConstraints(Di.COLLISION);const a=this.view.constraints&&this.view.constraints.tilt;a&&a.mode!=="auto"||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==Be.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&e.mode!=="auto"&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;(e?e.mode:"auto")==="manual"?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const r=this.view.state.constraints;r.tilt=r.createConstantMaxTilt(Gt(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||e.mode!=="auto")return;const r=this.view.state.constraints;if(r.tilt){const i=r.tilt(this.view.state.camera.distance).max;e.autoUpdate(rl(i))}}_updateLocalSurfaceDistance(e){if(C(e))return;let r=Math.max(e.width,e.height);if(r<=0)return;e.zmax!=null&&e.zmin!=null&&(r=Math.max(r,e.zmax-e.zmin));const i=this.view.state,s=3*r/Math.atan(i.camera.fov/2);s!==i.constraints.distance&&(i.constraints.distance=s)}_reapplyConstraints(e=Di.ALL){this.view.state.updateCamera(r=>Hs(this.view,r,{selection:e,interactionType:nr.NONE,interactionFactor:null,interactionStartCamera:null,interactionDirection:null,tiltMode:oo.TUMBLE}))}};u([d({constructOnly:!0})],y3.prototype,"view",void 0),u([d({readOnly:!0})],y3.prototype,"surfaceCollisionConstraint",void 0),y3=u([I("esri.views.3d.state.ConstraintsManager")],y3);let h_=class{get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}constructor(e){this.renderCoordsHelper=e,this.frustum=pO(),this._points=x1e(),this.lines=new Array(12),this._origin=M(),this._direction=M(),this._altitude=null;for(let r=0;r<12;r++)this.lines[r]={origin:null,direction:M(),endpoint:null}}update(e){T1e(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),le(this._origin,e.eye),le(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(e){for(let r=0;r<this._points.length;r++)le(this._points[r],e[r]);S1e(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return R_(this.frustum,e)}intersectsRay(e){return uXe(this.frustum,e)}intersectsLineSegment(e,r){return hXe(this.frustum,e,r)}intersectsPoint(e){return E1e(this.frustum,e)}_updateLines(){const e=this._points;for(let r=0;r<4;r++){const i=r+4;D8(this.lines[r],e[r],e[i]),D8(this.lines[r+4],e[r],r===3?e[0]:e[r+1]),D8(this.lines[r+8],e[i],r===3?e[4]:e[i+1])}}};function D8(t,e,r){t.origin=e,t.endpoint=r,ay(t.direction,e,r)}h_.planePointIndices=dXe,h_.nearFarLineIndices=[[nt.NEAR_BOTTOM_LEFT,nt.FAR_BOTTOM_LEFT],[nt.NEAR_BOTTOM_RIGHT,nt.FAR_BOTTOM_RIGHT],[nt.NEAR_TOP_RIGHT,nt.FAR_TOP_RIGHT],[nt.NEAR_TOP_LEFT,nt.FAR_TOP_LEFT]];let uR=class extends Cg{set desiredCamera(e){this._set("desiredCamera",e.clone())}constructor(e){super(e),this._handles=new ei}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=os.Running,this._handles.add(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e))),this._applyCorrection()}onControllerEnd(){this._handles.removeAll()}stepController(){}_handleElevationChangeEvent(e){v(e.spatialReference)&&!Ebe(this.view,this.desiredCamera,e.extent,e.spatialReference)||this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera(e=>{e.copyViewFrom(this.desiredCamera),zE(this.view,e,Ph.EYE_AND_CENTER)||this.constraintEnabled||(this.state=os.Stopped)})}};u([d({constructOnly:!0})],uR.prototype,"desiredCamera",null),uR=u([I("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],uR);const yQe=M(),_I=M();function rZ(){return{direction:M(),up:M()}}function ewe(t,e,r,i,s){let n=_e(yQe,t),o=ye(n,i);const a=o>0;o=Math.abs(o),o>.99&&(o=Math.abs(ye(e,i)),o<.99?(le(n,e),a&&ae(n,n,-1)):n=null);let l=0;if(n){ae(_I,i,ye(i,n)),me(n,n,_I);const h=ye(n,s)/(Me(n)*Me(s));pt(_I,n,s),l=(ye(_I,i)>0?1:-1)*rl(Sn(h))}const c=rl(Sn(-ye(i,t)/Me(t)));return r?(r.heading=l,r.tilt=c,r):{heading:l,tilt:c}}const twe=$e(0,1,0),rwe=$e(0,0,1),SC=Ie(),Lm=M(),Dm=M();function iwe(t,e,r,i=rZ()){const{direction:s,up:n}=i;return efe(SC,-Gt(e)),LS(SC,SC,Gt(r)),We(s,rwe,SC),ae(s,s,-1),We(n,twe,SC),i}function _Qe(t,e,r,i){return ewe(e,r,i,rwe,twe)}function vQe(t,e,r,i){const s=iwe(t,r,i),n=M();return ae(n,s.direction,-e),fe(n,n,t),{up:s.up,eye:n,heading:r,tilt:i}}function bQe(t){return rl(t)}function wQe(t){return Gt(t)}function swe(t,e,r,i,s){const n=t.renderSpatialReference,o=t.map&&t.spatialReference||e.spatialReference;return Jo(e,Lm,n),Jo(e,Dm,n),Lm[0]-=r/2,Dm[0]+=r/2,Lm[1]-=i/2,Dm[1]+=i/2,no(Lm,n,Lm,o),no(Dm,n,Dm,o),s?(s.xmin=Lm[0],s.ymin=Lm[1],s.xmax=Dm[0],s.ymax=Dm[1],s.spatialReference=o):s=new Zr(Lm[0],Lm[1],Dm[0],Dm[1],o),s}const xQe=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:_Qe,eyeForCenterWithHeadingTilt:vQe,eyeTiltToLookAtTilt:wQe,headingTiltToDirectionUp:iwe,lookAtTiltToEyeTilt:bQe,toExtent:swe},Symbol.toStringTag,{value:"Module"})),nwe=$e(0,0,1),owe=_e(M(),$e(1,1,1)),TQe=new W_(-180,180),EC=Ie(),r_=M(),Ax=M();function awe(t,e,r,i=rZ()){pt(r_,t,nwe),ye(r_,r_)===0&&pt(r_,t,owe),$u(EC,-Gt(e),t),Rc(EC,EC,-Gt(r),r_);const{up:s,direction:n}=i;return pt(s,r_,t),_e(s,s),We(s,s,EC),_e(n,t),ga(n,n),We(n,n,EC),i}function SQe(t,e,r,i){const s=r_,n=Ax;return _e(s,t),pt(Ax,s,nwe),ye(Ax,Ax)===0&&pt(Ax,s,owe),pt(n,Ax,s),ewe(e,r,i,s,n)}function EQe(t,e,r,i){const s={eye:M(),up:null,tilt:i,heading:r},n=r_;n[0]=t[0],n[1]=t[2],n[2]=-t[1];const o=e,a=Gt(r),l=Gt(i),c=Math.sin(a),h=Math.cos(a),p=Math.sin(l),f=Math.cos(l),m=Me(n);let y;if(Math.abs(l)<1e-8)y=o+m;else{const H=m/p,$=Uh(o/H),N=Math.PI-l-$;y=H*Math.sin(N)}const _=f*o,b=o*o*(p*p),x=h*h*b,T=y-_,S=T*T,E=x*(x+S-n[1]*n[1]);if(E<0)return ae(s.eye,n,y/m),s.tilt=0,vI(s,t);const O=Math.sqrt(E),R=n[1]*T,L=x+S;let P;if(P=h>0?-O+R:O+R,Math.abs(L)<1e-8)return m<1e-8?(s.eye[0]=0,s.eye[1]=0,s.eye[2]=o):ae(s.eye,n,y/m),s.tilt=0,N8(s.eye),vI(s,t);s.eye[1]=P/L;const U=c*c*b,B=p*o,z=h*B*s.eye[1],G=s.eye[1]*s.eye[1],K=1-G,ee=Math.sqrt(K),Q=x*G+U-2*z*ee*T+K*S;return Math.abs(Q)<1e-8?(ae(s.eye,n,y/m),s.tilt=0,N8(s.eye),vI(s,t)):(s.eye[0]=(K*(y*n[0]-_*n[0])-B*ee*(n[0]*s.eye[1]*h+n[2]*c))/Q,s.eye[2]=(K*(y*n[2]-_*n[2])-B*ee*(n[2]*s.eye[1]*h-n[0]*c))/Q,ae(s.eye,s.eye,y),N8(s.eye),vI(s,t))}function N8(t){const e=t[1];t[1]=-t[2],t[2]=e}function vI(t,e){const r=awe(e,t.heading,t.tilt);return t.up=r.up,t}function CQe(t,e,r){const i=Me(e),s=Math.sqrt(r*r+i*i-2*r*i*Math.cos(Math.PI-t)),n=Uh(r/(s/Math.sin(t)));return rl(t-n)}function AQe(t,e,r){const i=Gt(t),s=Me(e);return Uh(r/(s/Math.sin(i)))+i}function lwe(t,e,r,i,s){let n,o,a,l;const c=e.latitude,h=Jr(t.spatialReference).radius,p=e.longitude,f=NZe(c,r,h)/2;n=p-f,o=p+f;const m=Gt(c),y=(1+Math.sin(m))/(1-Math.sin(m)),_=(y+1)*Math.tan(i/h/2),b=_*_;function x(S){const E=Math.PI/2;return(S=oIe.normalize(S,-E))>E&&(S=Math.PI-S),S}if(a=1.5*Math.PI-2*Math.atan(.5*(_+Math.sqrt(4*y+b))),l=a+i/h,a=x(a),l=x(l),l<a){const S=l;l=a,a=S}if(a=Math.max(rl(a),-90),l=Math.min(rl(l),90),o=TQe.monotonic(n,o),o-n>180){const S=(o-n-180)/2;n+=S,o-=S}const T=t.spatialReference&&t.spatialReference.isGeographic?t.spatialReference:et.WGS84;return s?(s.xmin=n,s.ymin=a,s.xmax=o,s.ymax=l,s.spatialReference=T):s=new Zr(n,a,o,l,T),t.spatialReference&&t.spatialReference.isWebMercator&&jf(s,!1,s),s}const RQe=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:SQe,eyeForCenterWithHeadingTilt:EQe,eyeTiltToLookAtTilt:AQe,headingTiltToDirectionUp:awe,lookAtTiltToEyeTilt:CQe,toExtent:lwe},Symbol.toStringTag,{value:"Module"}));function yF(t){return t.type==="point"}let cwe=class{constructor(e,r=null,i=0){this.array=e,this.spatialReference=r,this.offset=i}};function uwe(t){return"array"in t}function kf(t,e,r="ground"){if(yF(e))return t.getElevation(e.x,e.y,e.z||0,e.spatialReference,r);if(uwe(e)){let i=e.offset;return t.getElevation(e.array[i++],e.array[i++],e.array[i]||0,It(e.spatialReference,t.spatialReference),r)}return t.getElevation(e[0],e[1],e[2]||0,t.spatialReference,r)}function _F(t,e){return t!=null&&(e==null||(e===Be.Local?!t.isGeographic||t.isWGS84||t.wkid===Ah.CGCS2000:t.isWebMercator||t.isWGS84||t.wkid===Ah.CGCS2000||t.wkid===Ah.GCSMARS2000||t.wkid===Ah.GCSMARS2000_SPHERE||t.wkid===Ah.GCSMOON2000))}const hwe=se.getLogger("esri.views.3d.support.cameraUtils"),dwe=39.37,pwe=96,Sj=1,OQe=8,MQe=5,fwe=1,Cse=M(),PQe={heading:0,tilt:0},d_=new mt,IQe=new W_(-20037508342788905e-9,20037508342788905e-9),$Qe=new W_(-180,180);var Xo;function PM(t){return t.spatialReference||et.WGS84}function jE(t){return t.viewingMode==="global"?RQe:xQe}function LQe(t,e,r,i,s){return jE(t).headingTiltToDirectionUp(e,r,i,s)}function xg(t,e){if(C(e))return null;const r=t.renderSpatialReference,i=jE(t).headingTiltToDirectionUp,s=M();if(!Jo(e.position,s,r))return null;const n=i(s,e.heading,e.tilt);ae(n.direction,n.direction,t.state.camera.distance),fe(n.direction,n.direction,s);const o=tx(t,s,n.direction,n.up);return o.fov=Gt(e.fov),o}(function(t){t[t.LOCKED=0]="LOCKED",t[t.ADJUST=1]="ADJUST"})(Xo||(Xo={}));const Rx=M();function sE(t,e,r){const i=t.renderSpatialReference,s=N5(t,e.eye,e.viewForward,e.up,PQe);let n=PM(t);return no(e.eye,i,Rx,n)||(n=et.WGS84,no(e.eye,i,Rx,n)),C(r)?new kh(new mt(Rx,n),s.heading,s.tilt,rl(e.fov)):(r.position.x=Rx[0],r.position.y=Rx[1],r.position.z=Rx[2],r.position.spatialReference=n,r.heading=s.heading,r.tilt=s.tilt,r.fov=rl(e.fov),r)}function iZ(t,e,r){const i=t.state.camera,s=i.width/2/i.pixelRatio;return t.renderCoordsHelper.viewingMode===Be.Global&&r!=null&&(e*=Math.cos(Gt(r))),e/=t.renderCoordsHelper.unitInMeters,s/(pwe*dwe/e)/Math.tan(i.fovX/2)}function Lw(t,e,r){const i=t.state.camera,s=e*Math.tan(i.fovX/2),n=i.width/2/i.pixelRatio;let o=pwe*dwe/(n/s);return t.renderCoordsHelper.viewingMode===Be.Global&&r!=null&&(o/=Math.cos(Gt(r))),o*=t.renderCoordsHelper.unitInMeters,o}function mwe(t,e,r,i,s,n){return gwe(t,e,iZ(t,r,e.latitude),i,s,n)}function gwe(t,e,r,i,s,n){if(Qb(n)){const a=new HE(n.signal);return wO(t,i.heading,i.tilt,e,r,s,a),void a.resolver.promise.then(l=>{const c=bF(t,l,i.fov);if(!C(c))return n.resolver.resolve(c);n.resolver.reject()},l=>n.resolver.reject(l))}const o=wO(t,i.heading,i.tilt,e,r,s);return bF(t,o,i.fov,n)}function N5(t,e,r,i,s){return jE(t).directionToHeadingTilt(e,r,i,s)}function DQe(t,e){return!!(t.basemapTerrain&&t.renderCoordsHelper.fromRenderCoords(e,d_,t.spatialReference)&&t.elevationProvider&&It(kf(t.elevationProvider,d_),0)>(d_.z??0)-fwe)}async function NQe(t,e,r){if(!t.renderCoordsHelper.fromRenderCoords(e,d_,t.spatialReference)||!t.elevationProvider)return!1;const i=d_.z??0,s=await t.elevationProvider.queryElevation(d_.x,d_.y,i,d_.spatialReference,"ground",r);return It(s,0)>i-fwe}async function FQe(t,e,r){const i=M();if(e)if(e instanceof mt){if(Jo(e,i,t.renderSpatialReference),e.z==null&&t.basemapTerrain!=null&&t.elevationProvider!=null){const s=await t.elevationProvider.queryElevation(e.x,e.y,e.z??0,e.spatialReference,"ground",r);return v(s)&&t.renderCoordsHelper.setAltitude(i,s),i}}else le(i,e);else le(i,t.state.camera.center);return i}function UQe(t,e){const r=M();if(e&&e instanceof mt){if(Jo(e,r,t.renderSpatialReference),e.z==null&&t.basemapTerrain!=null&&t.elevationProvider!=null){const i=kf(t.elevationProvider,e);v(i)&&t.renderCoordsHelper.setAltitude(r,i)}}else le(r,e||t.state.camera.center);return r}function wO(t,e,r,i,s,n,o){const a=i&&i instanceof mt?i:null;if(Qb(o))return FQe(t,i,o.signal).then(c=>{Ej(t,e,r,a,c,s,n,o)},c=>o.resolver.reject(c)),null;const l=UQe(t,i);return Ej(t,e,r,a,l,s,n,o)}function Ej(t,e,r,i,s,n,o,a){if(C(i)){const p=t.renderSpatialReference;if(i=J_(s,p,PM(t)),C(i))return null}n=Math.max(n,t.state.constraints.minimumPoiDistance);const l=BQe(t,e,r,s,n,o),c=(0,jE(t).eyeForCenterWithHeadingTilt)(s,n,l.heading,l.tilt);if(o===Xo.ADJUST&&t.viewingMode==="global"&&r>0){const p=()=>{const m=ywe(t,s,n,GQe(t,n,r,s));return o=r-m<1?Xo.LOCKED:Xo.ADJUST,Ej(t,e,m,i,s,n,o,a)},f=t.map.ground.navigationConstraint;if(!f||f.type==="stay-above"){if(DQe(t,c.eye))return p();if(Qb(a))return NQe(t,c.eye,a.signal).then(m=>m?p():(a.resolver.resolve({eye:c.eye,up:c.up,center:ms(s),heading:c.heading,tilt:c.tilt}),null)),null}}const h=!a||Qb(a)?{center:M(),eye:M(),up:M(),tilt:0,heading:0}:a;return h.eye=c.eye,h.up=c.up,h.center=ms(s),h.heading=c.heading,h.tilt=c.tilt,Qb(a)&&a.resolver.resolve(h),h}function hR(t,e,r,i,s,n=null){let o,a,l;if(t.state.isGlobal){if(!_F(e.spatialReference,Be.Global))return Qb(n)&&n.resolver.reject(),null;const b=new mt(e.xmin,e.ymin,e.spatialReference),x=new mt(e.xmax,e.ymax,e.spatialReference),T=e.spatialReference.isGeographic?$Qe:IQe;o=new mt({x:T.center(b.x,x.x),y:(x.y+b.y)/2,z:e.zmax!=null&&e.zmin!=null?(e.zmax+e.zmin)/2:void 0,spatialReference:e.spatialReference});const S=Jr(e.spatialReference),E=DZe(o,b,x);a=E.lon,l=E.lat,T.diff(b.x,x.x)>T.range/2&&(a+=S.halfCircumference),a=Math.min(a,S.halfCircumference),l=Math.min(l,S.halfCircumference)}else{const b=It(t.renderSpatialReference,e.spatialReference);b.equals(e.spatialReference)||(e=AE(e,b)),a=e.xmax-e.xmin,l=e.ymax-e.ymin;const x=e.zmax!=null&&e.zmin!=null?(e.zmax+e.zmin)/2:void 0;o=new mt({x:e.xmin+.5*a,y:e.ymin+.5*l,z:x,spatialReference:b})}const c=e.zmax!=null&&e.zmin!=null?e.zmax-e.zmin:0,h=t.state.camera,p=1/Math.tan(h.fovX/2),f=1/Math.tan(h.fovY/2),m=1/Math.tan(h.fov/2),y=Math.max(.5*a*p,.5*l*f,.5*c*m)/Sj;if(Qb(n)){const b=new HE(n.signal);return wO(t,r,i,o,y,s,b),void b.resolver.promise.then(x=>{const T=bF(t,x,t.camera.fov);if(!C(T))return n.resolver.resolve(T);n.resolver.reject()},x=>n.resolver.reject(x))}const _=wO(t,r,i,o,y,s);return bF(t,_,t.camera.fov,n)}function kQe(t,e,r){const i=t.renderSpatialReference,s=J_(r,i,PM(t));if(C(s))return null;const n=Math.tan(e.fovX/2),o=Math.tan(e.fovY/2),a=KO(e.eye,r),l=2*a*n*Sj,c=2*a*o*Sj;return t.viewingMode==="global"?lwe(t,s,l,c):swe(t,s,l,c)}function VQe(t,e,r){const i=t.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(r/i)/Math.LN2>OQe)return!0;const s=t.renderSpatialReference,n=PM(t),o=J_(e,s,n),a=J_(t.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s,n);if(C(o)||C(a))return!1;const l=Math.tan(.5*t.state.camera.fov)*i;return a.distance(o)/l>MQe}function BQe(t,e,r,i,s,n){let o=0;return n===Xo.ADJUST&&VQe(t,i,s)?(e=0,o=zQe(t,s,r,i)):o=sZ(t,i,s,r),o=t.state.constraints.clampTilt(s,o),{heading:e,tilt:r=ywe(t,i,s,o)}}const vF=.7;function zQe(t,e,r,i){const s=sZ(t,i,e,r);if(!t.state.constraints.tilt)return s;const n=t.state.constraints.tilt(e);n.max=Math.min(n.max,.5*Math.PI);const o=n.min*(1-vF)+n.max*vF;return Math.min(s,o)}function GQe(t,e,r,i){let s=sZ(t,i,e,r);if(!t.state.constraints.tilt)return s;const n=t.state.constraints.tilt(e);return s=Math.min(s,.5*Math.PI),n.min*(1-vF)+s*vF}function ywe(t,e,r,i){return jE(t).lookAtTiltToEyeTilt(i,e,r)}function sZ(t,e,r,i){return jE(t).eyeTiltToLookAtTilt(i,e,r)}function bF(t,e,r,i){if(C(e))return null;const s=t.renderSpatialReference,n=J_(e.eye,s,PM(t));return C(n)?null:v(i)?(i.position=n,i.heading=e.heading,i.tilt=e.tilt,i.fov=r,i):new kh(n,e.heading,e.tilt,r)}function jQe(t,e){var i;const r=(i=t.basemapTerrain)==null?void 0:i.tilingScheme;if(r)return r.levelAtScale(e);hwe.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function _we(t,e){var i;const r=(i=t.basemapTerrain)==null?void 0:i.tilingScheme;if(r)return r.scaleAtLevel(e);hwe.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function vwe(t,e){return no(e.center,t.renderSpatialReference,Cse,et.WGS84),Lw(t,e.distance,Cse[1])}let HE=class{constructor(e){this.signal=e,this.resolver=H_()}};function Qb(t){return t&&"resolver"in t}const HQe=.66;function bwe(t){return 360-Hq.normalize(t)}function F5(t){return Hq.normalize(360-t)}function CC(t){return v(t)&&t.resolver&&t.resolver.reject(),null}function qQe(t,e){return v(t)&&t.resolver&&t.resolver.resolve(e),e}function wwe(t,e,r,i=null){if(!e)return CC(i);const s=t.spatialReference||et.WGS84;if(v(e.camera)){const c=Gw(e.camera.position,s);if(C(c))return CC(i);const h=e.camera.clone();return h.position=c,qQe(i,h)}if(C(e.targetGeometry))return CC(i);const n=e.get("targetGeometry.spatialReference");if(n&&!$_(n,s))return CC(i);const o=sE(t,t.state.camera);let a=Xo.ADJUST;if(e.rotation!=null&&(o.heading=bwe(e.rotation),a=Xo.LOCKED),r!=null&&(o.tilt=r),e.targetGeometry.type==="point"){const c=e.targetGeometry;let h;const p=e.targetGeometry.clone();return h=e.scale!=null?iZ(t,e.scale,c.latitude):t.state.camera.distance,gwe(t,p,h,o,a,i)}const l=e.targetGeometry.extent;return l?hR(t,l,o.heading,o.tilt,a,i):CC(i)}function WQe(t,e,r=null){return C(r)&&(r=new mp),aZ(t,null,e.clone(),r)}async function XQe(t,e,r){const i=set(t,e);if(!i)throw new q("viewpointutils-create:no-target","Missing target for creating viewpoint");const s=new kh({fov:t.camera.fov}),n=new mp({camera:s});if(i.target instanceof mp)return Bv(await JQe(t,i.target,i,r,n));if(i.target instanceof kh)return Bv(Twe(t,i.target,n));const o=i.scale!=null||i.zoom!=null;if(i.target instanceof Zr){const c=i.target.xmin===i.target.xmax||i.target.ymin===i.target.ymax;return Bv(o||c?await Cj(t,i,i.target.center,s,r,n):await tet(t,i,i.target,s,r,n))}const a={boundingBox:Ri(),hasZ:!1,screenSpaceObjects:[]},l=o?YQe(t,i):void 0;if(await xwe(t,i.target,l,a),isFinite(a.boundingBox[0])){let c;if(Yd(a.boundingBox,Gs),pu.x=Gs[0],pu.y=Gs[1],pu.z=Gs[2],pu.spatialReference=t.spatialReference,isFinite(pu.z)&&a.hasZ?c=nW(a.boundingBox):(pu.z=void 0,c=v$e(sW(a.boundingBox,oet))),o||c)return Bv(await Cj(t,i,pu,s,r,n));const h=net(t,a.screenSpaceObjects);return Bv(await iet(t,i,pu,a.boundingBox,h,s,r,n))}return i.position?Bv(QQe(t,i,s,n)):Bv(await eet(t,i,s,r,n))}function nZ(t,e){return e.scale==null&&e.zoom!=null?_we(t,e.zoom):e.scale}function YQe(t,e){const r=nZ(t,e);return r?GNe(r):void 0}function oZ(t,e){let r=!1;return e.heading!=null?(t.heading=e.heading,r=!0):e.rotation!=null&&(t.heading=bwe(e.rotation),r=!0),e.tilt!=null&&(t.tilt=e.tilt,r=!0),e.fov!=null&&(t.fov=e.fov),r}function aZ(t,e,r,i){const s=t.spatialReference||et.WGS84;return e=v(e)?e:xg(t,r),C(e)||(i.targetGeometry=J_(e.center,t.renderSpatialReference,s),i.scale=vwe(t,e),i.rotation=F5(r.heading),i.camera=r),i}function wF(t,e,r){var a,l;const i=()=>new q("viewpointutils:invalid-geometry","The target is missing a valid geometry");if(!e)throw i();if(!$_(e.spatialReference,t.spatialReference))throw new q("viewpointutils:incompatible-spatialreference",`Spatial reference (${e.spatialReference?e.spatialReference.wkid:"unknown"}) is incompatible with the view (${(a=t.spatialReference)==null?void 0:a.wkid})`,{geometry:e});const s=[];if(!e.hasZ&&t.basemapTerrain){let c;switch(e.type){case"point":c=e;break;case"multipoint":case"polyline":c=(l=e.extent)==null?void 0:l.center;break;case"mesh":c=e.origin;break;case"extent":c=e.center;break;case"polygon":c=e.centroid}c&&v(t.basemapTerrain.spatialReference)&&$_(c,t.basemapTerrain.spatialReference)&&t.elevationProvider?Gs[2]=It(kf(t.elevationProvider,c),0):Gs[2]=0}(0,aet[e.type])(e,c=>{s.push(c[0],c[1],c[2])},Gs);const n=s.length/3;if(n===0)throw i();const o=new Array(s.length);if(_s(s,e.spatialReference,0,o,t.spatialReference,0,n)){e.hasZ&&(r.hasZ=!0);for(let c=0;c<o.length;c+=3)e.hasZ?(Gs[0]=o[c+0],Gs[1]=o[c+1],Gs[2]=o[c+2]):(Gs[0]=o[c+0],Gs[1]=o[c+1]),lm(r.boundingBox,Gs)}}async function ZQe(t,e,r,i){const s=await hp(t.whenViewForGraphic(e));if(s.ok===!1||C(s.value)||!("whenGraphicBounds"in s.value))return void wF(t,e.geometry,i);const n=s.value,o=await hp(n.whenGraphicBounds(e,{minDemResolution:r}));if(o.ok===!1)return void wF(t,e.geometry,i);const{screenSpaceObjects:a,boundingBox:l}=o.value;IS(i.boundingBox,l),a&&a.forEach(c=>{i.screenSpaceObjects.push(c)}),isFinite(l[2])&&(i.hasZ=!0)}async function xwe(t,e,r,i){var s;if(Array.isArray(e)&&e.length===2){const n=e[0],o=e[1];if(typeof n=="number"&&typeof o=="number")return pu.x=n,pu.y=o,pu.z=void 0,pu.spatialReference=(s=t.spatialReference)!=null&&s.isGeographic?t.spatialReference:et.WGS84,void wF(t,pu,i)}e&&typeof e.map=="function"?await jl(e.map(n=>xwe(t,n,r,i))):e instanceof pv?wF(t,e,i):e instanceof Io&&await ZQe(t,e,r,i)}async function JQe(t,e,r,i,s){if(v(e.camera))return Twe(t,e.camera,s);s.scale=e.scale,s.rotation=e.rotation,s.targetGeometry=v(e.targetGeometry)?e.targetGeometry.clone():null,s.camera=null,r.heading!=null?s.rotation=F5(r.heading):r.rotation!=null&&(s.rotation=r.rotation);const n=nZ(t,r);n!=null&&(s.scale=n);const o=new HE(i);return wwe(t,s,r.tilt,o),s.camera=await o.resolver.promise,s}function Twe(t,e,r){const i=t.spatialReference,s=Gw(e.position,i);return C(s)?null:((e=e.clone()).fov=t.camera.fov,e.position=s,aZ(t,null,e,r))}function KQe(t,e,r,i,s,n){const o=t.renderSpatialReference;return Jo(r,wI,o),Jo(e,F8,o),n.targetGeometry=new mt(e),s.position=new mt(r),me(xF,F8,wI),N5(t,wI,xF,i.up,s),n.scale=Lw(t,xi(wI,F8),n.targetGeometry.latitude),n.rotation=F5(s.heading),n.camera=s,n}async function Cj(t,e,r,i,s,n){if(C(r))throw new q("createfromcenter","invalid point");n.targetGeometry=r.clone();const o=tx(t);if(e.position)return KQe(t,n.targetGeometry,e.position,o,i,n);if(e.zoomFactor){const l=o.distance/e.zoomFactor,c=ae(Gs,o.viewForward,-l);o.eye=fe(Gs,o.center,c),n.scale=Lw(t,l,r.latitude)}sE(t,o,i);const a=oZ(i,e)?Xo.LOCKED:Xo.ADJUST;if(!e.zoomFactor){const l=nZ(t,e);l==null?(Jo(r,Gs,t.renderSpatialReference),E1e(o.frustum,Gs)?n.scale=Lw(t,xi(o.eye,Gs),r.latitude):n.scale=vwe(t,o)):n.scale=l;const c=new HE(s);mwe(t,n.targetGeometry,n.scale,i,a,c),n.camera=await c.resolver.promise}return n}function QQe(t,e,r,i){const s=tx(t);return le(xF,s.viewForward),N5(t,s.eye,xF,s.up,U8),r.position=new mt(e.position),r.heading=e.heading!=null?e.heading:U8.heading,r.tilt=e.tilt!=null?e.tilt:U8.tilt,aZ(t,null,r,i)}async function eet(t,e,r,i,s){const n=tx(t);return Cj(t,e,J_(n.center,t.renderSpatialReference,t.spatialReference),r,i,s)}async function tet(t,e,r,i,s,n){n.targetGeometry=r.clone();const o=tx(t);sE(t,o,i);const a=oZ(i,e)?Xo.LOCKED:Xo.ADJUST,l=new HE(s);return hR(t,r,i.heading,i.tilt,a,l),n.camera=await l.resolver.promise,n}function ret(t,e,r,i,s){let n=0;r.z!=null?n=r.z:t.basemapTerrain&&t.elevationProvider&&(n=kf(t.elevationProvider,r)),ce(Gs,r.x,r.y,n),gp(t.spatialReference,Gs,Ase,t.renderSpatialReference),Hh(bI,Ase),qh(bI,bI),Ri(AC);const o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let y=0;y<o.length;y++){const _=o[y];let b=i[_[2]];isFinite(b)||(b=n),ce(Gs,i[_[0]],i[_[1]],b),no(Gs,t.spatialReference,Gs,t.renderSpatialReference),lm(AC,Ac(Gs,Gs,bI))}const a=Hw(AC),l=mv(AC),c=qw(AC),h=1/Math.tan(e.fovX/2),p=1/Math.tan(e.fovY/2),f=.5*Math.sqrt(a*a+c*c)*Math.max(p,h)+.5*l,m=.5*l*p+.5*Math.max(a,c);return Math.max(f,m)/s}async function iet(t,e,r,i,s,n,o,a){a.targetGeometry=r.clone();const l=tx(t),c=ret(t,l,r,i,s);sE(t,l,n);const h=oZ(n,e)?Xo.LOCKED:Xo.ADJUST;a.scale=Lw(t,c,a.targetGeometry.latitude);const p=new HE(o);return mwe(t,a.targetGeometry,a.scale,n,h,p),a.camera=await p.resolver.promise,a}function set(t,e){if(!e||!t.spatialReference)return null;const r={target:void 0};if("declaredClass"in e||Array.isArray(e))r.target=e;else{for(const i in e)r[i]=e[i];e.center&&!r.target&&(r.target=e.center)}return r}function Bv(t){return t&&v(t.camera)&&(t.rotation=F5(t.camera.heading)),t}function net(t,e){const r=HQe;if(!e.length)return r;let i=Number.NEGATIVE_INFINITY;for(let s=0;s<e.length;s++){const n=e[s].screenSpaceBoundingRect;i=Math.max(i,Math.abs(n[0]),Math.abs(n[1]),Math.abs(n[2]),Math.abs(n[3]))}return r-i/Math.min(t.width,t.height)*2}const Gs=M(),Ase=Ie(),bI=es(),AC=En(),oet=ur(),xF=M(),wI=M(),F8=M(),U8={heading:0,tilt:0},pu=new mt,aet={point(t,e,r){r[0]=t.x,r[1]=t.y,t.z!=null&&(r[2]=t.z),e(r)},polygon(t,e,r){const i=t.hasZ;for(let s=0;s<t.rings.length;s++){const n=t.rings[s];for(let o=0;o<n.length;o++)r[0]=n[o][0],r[1]=n[o][1],i&&(r[2]=n[o][2]),e(r)}},polyline(t,e,r){const i=t.hasZ;for(let s=0;s<t.paths.length;s++){const n=t.paths[s];for(let o=0;o<n.length;o++)r[0]=n[o][0],r[1]=n[o][1],i&&(r[2]=n[o][2]),e(r)}},multipoint(t,e,r){const i=t.points,s=t.hasZ;for(let n=0;n<i.length;n++)r[0]=i[n][0],r[1]=i[n][1],s&&(r[2]=i[n][2]),e(r)},extent(t,e,r){t.zmin!=null&&t.zmax!=null?(e(ce(r,t.xmin,t.ymin,t.zmin)),e(ce(r,t.xmax,t.ymin,t.zmin)),e(ce(r,t.xmin,t.ymax,t.zmin)),e(ce(r,t.xmax,t.ymax,t.zmin)),e(ce(r,t.xmin,t.ymin,t.zmax)),e(ce(r,t.xmax,t.ymin,t.zmax)),e(ce(r,t.xmin,t.ymax,t.zmax)),e(ce(r,t.xmax,t.ymax,t.zmax))):(e(ce(r,t.xmin,t.ymin,r[2])),e(ce(r,t.xmax,t.ymin,r[2])),e(ce(r,t.xmin,t.ymax,r[2])),e(ce(r,t.xmax,t.ymax,r[2])))},mesh(t,e,r){const i=t.vertexAttributes&&t.vertexAttributes.position;if(i)for(let s=0;s<i.length;s+=3)e(ce(r,i[s+0],i[s+1],i[s+2]))}};let cet=class{constructor(e,r,i){this.target=e,this.options=r,this.view=i,this.state="pending",this._animationController=null,this._promise=new Promise((s,n)=>{this._resolveCallback=s,this._rejectCallback=n;const o=new AbortController;v(this.options.signal)&&fa(this.options.signal,()=>{this.abort()}),this._abortController=o,this.waitForReady()})}then(e,r){return this._promise.then(e,r)}catch(e){return this._promise.catch(e)}resolve(e){if(this.state!=="finished")return this.state="finished",this._resolveCallback(e)}reject(e){if(this.state!=="finished")return this.state="finished",this._rejectCallback(e)}abort(e=!1){this._abortController.abort(),this.state==="wait-for-animation-finish"&&!e&&v(this._animationController)&&this.view.state.cameraController===this._animationController&&this._animationController.active&&this._animationController.stopController(),this.reject(Hr())}async waitForReady(){if(this.state="wait-for-ready",!this.view.ready)try{await WR(()=>this.view.ready,this._abortController.signal)}catch(e){return this.reject(e)}this.createViewPoint()}createViewPoint(){this.state!=="finished"&&(this.state="wait-for-viewpoint",this._animationController=this.options.animate?this._getAnimationController():null,XQe(this.view,this.target,this._abortController.signal).then(e=>{if(this.state==="finished")return;const r=e?this._getCameraFromViewpoint(e):null;if(!C(r))if(this.options.animate){if(C(this._animationController))return;this.startAnimation(r,this._animationController)}else this.view.stateManager.setStateCamera(r.camera,{applyConstraints:!r.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this.resolve()},e=>{this.reject(e)}))}_getCameraFromViewpoint(e){var n;const r=!!(this.target instanceof mp&&this.target.camera||this.target instanceof kh),i=e.camera;if(C(i))return null;if(!this.view.stateManager.isCompatible(i)){const o=i.position,a=o&&o.spatialReference,l=a?a.wkid:"none",c=(n=this.view.spatialReference)==null?void 0:n.wkid;return this.reject(new q("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${l}, view: ${c})`,{camera:i})),null}const s=xg(this.view,i);return C(s)?(this.reject(new q("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:s,isFullySpecified:r}}startAnimation(e,r){this.state="wait-for-animation-finish";const i=r.viewAnimation;if(C(i))return void this.reject(new q("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(i.update(e.viewpoint,"running"),!r.active||C(r.viewAnimation)||r.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==r)return this.abort();let s;e.isFullySpecified?(s=new uR({view:this.view,desiredCamera:e.camera}),zE(this.view,e.camera,Ph.EYE_AND_CENTER)):Hs(this.view,e.camera),r.begin(e.camera,this.options);const n=()=>{const a=this.view.state.cameraController;s&&(a&&a.active?a instanceof Dg&&v(a.viewAnimation)&&a.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=s):v(r.viewAnimation)&&r.viewAnimation.target===e.viewpoint&&r.state==="finished"&&(this.view.state.cameraController=s))},o=a=>{if(!C(this.view.state))switch(r.state){case os.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.resolve()}break;case os.Ready:case os.Rejected:case os.Running:case os.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.reject(a)}}};i.when(n,a=>o(a)),r.asyncResult={resolve:()=>o(),reject:a=>o(a)}}_getAnimationController(){let e=null,r=null;const i=this.view.state.cameraController;return i instanceof Dg&&(i.updateStateFromViewAnimation(),i.active&&(e=i,r=e.viewAnimation)),e!=null||(e=new Dg({view:this.view,mode:"animation"}),r=e.viewAnimation,this.view.state.switchCameraController(e))?e:(v(r)&&r.stop(),this.reject(new q("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}},un=class extends Te{get camera(){const e=this._get("camera");if(!this.ready)return e;const r=sE(this.view,this.view.state.camera,k8);return r&&e&&r.equals(e)?e:r.clone()}set camera(e){var r,i;this._updatePropertyBeforeReady("camera",e)||((r=this.view.elevationProvider)==null||r.enableElevationCache(!0),this.setStateCamera(xg(this.view,e),{applyConstraints:!1})||se.getLogger(this.declaredClass).error("#camera=","Invalid camera",e),(i=this.view.elevationProvider)==null||i.enableElevationCache(!1))}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const r=sE(this.view,this.view.state.contentCamera,k8);return r&&e&&r.equals(e)?e:r.clone()}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const r=xg(this.view,e);C(r)?this.view.state.contentCamera=null:(this._updateElevation(r),this.view.state.contentCamera=r)}installContentCameraReset(e){if(this.removeHandles(V8),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const r=this.zoom,i=this.view.state.camera.distance**2,s=Nl(this.view.state.camera.center),n=e.sticky?this.contentCamera.clone():null;return this.addHandles([ie(()=>this.contentCamera,()=>{e.sticky||(this.removeHandles(V8),this.test.contentCameraResetState.clear())}),ie(()=>this.zoom,o=>{o!==void 0&&r!==void 0&&(this.test.contentCameraResetState.set("view.zoom",Math.abs(o-r)/2),Math.abs(o-r)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=n))}),ie(()=>this.view.state.camera,o=>{const a=Ro(s,o.center);this.test.contentCameraResetState.set("camera.center",a/i),a>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=n)})],V8),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){var r;this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():se.getLogger(this.declaredClass).error("#center=","Invalid center",e):se.getLogger(this.declaredClass).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+((r=this.view.spatialReference)==null?void 0:r.wkid)+")",e):se.getLogger(this.declaredClass).error("#center=","Center may not be null or undefined"))}get extent(){if(!this.ready)return this._get("extent");const e=this.view,r=kQe(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return v(r)?r:this._get("extent")}set extent(e){var r;this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||se.getLogger(this.declaredClass).error("#extent=","Invalid extent",e):se.getLogger(this.declaredClass).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+((r=this.view.spatialReference)==null?void 0:r.wkid)+")",e):se.getLogger(this.declaredClass).error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get hasInitialView(){return!!this.view.get("map.initialViewProperties.viewpoint")}get scale(){if(this.ready){const e=this.view.pointsOfInterest.centerOnContent;return Lw(this.view,e.distance,e.location.latitude)}return this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||se.getLogger(this.declaredClass).error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,r=e.padding,i=e.pixelRatio,s=this._get("padding"),n=Math.round(r[lr.TOP]/i),o=Math.round(r[lr.RIGHT]/i),a=Math.round(r[lr.BOTTOM]/i),l=Math.round(r[lr.LEFT]/i);return s!=null&&s.top===n&&s.right===o&&s.bottom===a&&s.left===l?s:{top:n,right:o,bottom:a,left:l}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,xI),this.view.state.updateCamera(r=>r.padding=xI))}_paddingToArray(e,r,i){e?ti(i,e.top||0,e.right||0,e.bottom||0,e.left||0):ti(i,0,0,0,0);for(let s=0;s<4;s++)i[s]=Math.round(i[s]*r)}get screenCenter(){const e=this.padding;return Bh((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?WQe(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){var r;if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||se.getLogger(this.declaredClass).error("#viewpoint=","Invalid viewpoint",e);else{const i=v(e.camera)?e.camera.position:e.targetGeometry,s=v(i)&&i.spatialReference;se.getLogger(this.declaredClass).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(s?s.wkid:"none")+", view: "+((r=this.view.spatialReference)==null?void 0:r.wkid)+")",e)}else se.getLogger(this.declaredClass).error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?jQe(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||e===void 0||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||se.getLogger(this.declaredClass).error("#zoom=","Invalid zoom",e)}get _pixelRatio(){var e;return v(this._devicePixelRatioOverride)?this._devicePixelRatioOverride:this._usePhysicalPixelRendering?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,(e=this.view)==null?void 0:e.qualitySettings.maximumPixelRatio)}get _rasterPixelRatio(){return v(this._devicePixelRatioOverride)?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}get _usePhysicalPixelRendering(){var e,r;return((r=(e=this.view)==null?void 0:e._stage)==null?void 0:r.renderer.isFeatureEnabled(Bs.PhysicalPixelRendering))??!1}get _usePhysicalPixelRenderingAny(){var r,i;const e=(i=(r=this.view)==null?void 0:r._stage)==null?void 0:i.renderer;return e&&(e.isFeatureEnabled(Bs.PhysicalPixelRendering,Sr.IDLE)||e.isFeatureEnabled(Bs.PhysicalPixelRendering,Sr.INTERACTING)||e.isFeatureEnabled(Bs.PhysicalPixelRendering,Sr.ANIMATING))}constructor(e){super(e),this._propertiesPool=new ty({frustum:h_},this),this._cameraSetByUser=!1,this._gotoOperation=null,this.constraintsManager=null,this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._cameraChangeTime=0,this._updatingIgnoreRenderState=!1,this.test={viewStateManager:this,contentCameraResetState:new Map,setDevicePixelRatio:r=>this._devicePixelRatioOverride=r,renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},set updatingIgnoreRenderState(r){this.viewStateManager._updatingIgnoreRenderState=r},get updatingIgnoreRenderState(){return this.viewStateManager._updatingIgnoreRenderState||v(this.renderState)}}}initialize(){this._cameraChangeTime=performance.now(),this.addHandles([sn(()=>this.view.state.events,"before-camera-change",e=>e&&this._updateElevation(e)),ie(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},(e,r)=>this._cameraChangedHandler(e,r),ri)]),_a(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},e=>this._updateElevation(e),{once:!0,sync:!0}),this.addHandles([vS({prepare:()=>this._prepareFrame()}),ie(()=>this.view.state.cameraController,()=>{this._cameraSetByUser=!0,this.removeHandles(TI)}),sn(()=>this.view.state.events,"camera-projection-changed",()=>this.notifyChange("scale"))])}destroy(){this.exit(),this._propertiesPool=ke(this._propertiesPool)}init(){this.constraintsManager=new y3({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);for(const r of e)this.set(r.name,r.value);if(!this._cameraSetByUser){const r=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;r&&this.isCompatible(r)?this._setInitialView(r):this.view.state.viewingMode===Be.Local&&this.addHandles(_a(()=>this.view.basemapTerrain.ready,()=>{this.removeHandles(TI),this._setInitialView(this.view.dataExtent)},{once:!0,initial:!0}),TI)}}exit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(TI),this.constraintsManager=ke(this.constraintsManager))}async goTo(e,r){const i={animate:!0,...r};return v(this._gotoOperation)&&this._gotoOperation.abort(i.animate),this._gotoOperation=new cet(e,i,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation}debugSetCameraOnContent(){this.setStateCamera(tx(this.view),{applyConstraints:!1})}step(e){const r=this.view.state,i=r==null?void 0:r.cameraController;i&&(r.updateCamera(s=>i.stepController(e,s)),i.steppingFinished&&i.finishController())}_cancelGoToOperation(){v(this._gotoOperation)&&(this._gotoOperation.abort(),this._gotoOperation=null)}_getInitialProperties(){const e=new Set,r=[];for(const{propertyName:i,overrides:s}of het){const n=e.has(i),o=this._isOverridden(i);!n&&o&&r.push({name:i,value:this._get(i)}),this._clearOverride(i),(n||o)&&s.forEach(a=>e.add(a))}return r}_setInitialView(e){if(C(e)||this._cameraSetByUser)return;if(e instanceof kh)return void this.setStateCamera(xg(this.view,e),{applyConstraints:!1});if(e instanceof mp){if(e.targetGeometry instanceof Zr){const n=hR(this.view,e.targetGeometry,0,.5,Xo.LOCKED);return void(v(n)&&this.setStateCamera(xg(this.view,n),{applyConstraints:!0}))}const i={applyConstraints:!e.camera},s=this._viewpointToCamera(e);return void this.setStateCamera(s,i)}const r=hR(this.view,e,0,.5,Xo.LOCKED);v(r)&&this.setStateCamera(xg(this.view,r),{applyConstraints:!0})}_updatePropertyBeforeReady(e,r){return!this.ready&&(this._override(e,r),r&&uet.includes(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return!C(e)&&(e instanceof mp?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof kh?this.isCompatible(e.position):e.spatialReference&&$_(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(e=det){return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,r,i=Hy){const{heading:s,tilt:n}=this._getPreservingHeadingTilt(),o=wO(this.view,s,n,e,r,Xo.ADJUST);return C(o)?null:(i.copyFrom(this.view.state.camera),i.eye=o.eye,i.center=o.center,i.up=o.up,i)}_centerToCamera(e){const r=this.view.pointsOfInterest.centerOnContent;r.runTask();const i=r.distance;return this._centerPointAtDistanceToCamera(e,i)}_extentToCamera(e){const{heading:r,tilt:i}=this._getPreservingHeadingTilt(),s=hR(this.view,e,r,i,Xo.ADJUST,k8);return s?xg(this.view,s):null}_scaleToCamera(e){if(e==null)return null;const r=this.view.pointsOfInterest.centerOnContent;r.runTask();const i=r.renderLocation,s=r.location.latitude;if(s==null)return null;const n=iZ(this.view,e,s);return this._centerPointAtDistanceToCamera(i,n)}_zoomToCamera(e){return this._scaleToCamera(_we(this.view,e))}_viewpointToCamera(e){return xg(this.view,wwe(this.view,e))}setStateCamera(e,r){return!(C(e)||!this.view.state.stopActiveCameraController())&&(this._cameraSetByUser=!0,r.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera(i=>{r.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up):i.copyFrom(e),r.applyConstraints&&Hs(this.view,i)}),r.applyConstraints||(this.view.state.cameraController=new uR({view:this.view,desiredCamera:e})),!0)}_prepareFrame(){const{surface:e,canvas:r}=this.view;if(!e||!r)return;this._windowDevicePixelRatio=window.devicePixelRatio;const i=this._pixelRatio,s=Math.round(e.clientWidth*i),n=Math.round(e.clientHeight*i);if(s!==0&&n!==0&&(r.width===s&&r.height===n||(r.width=s,r.height=n),this.view.state)){const o=this.view.state.camera;o.fullWidth===s&&o.fullHeight===n&&o.pixelRatio===i||(Hy.copyFrom(o),Hy.pixelRatio!==i&&(this._paddingToArray(this.padding,i,xI),Hy.padding=xI),Hy.fullWidth=s,Hy.fullHeight=n,Hy.pixelRatio=i,this.view.state.camera=Hy),this._updateViewState()}}_updateElevation(e){var n;const r=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,i=((n=this.view.renderCoordsHelper)==null?void 0:n.getAltitude(e.eye))??0,s=r?P5(this.view,e.eye):0;e.relativeElevation=i-s}_updateViewState(){v(this.test.renderState)?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=Sr.ANIMATING:this.view.interacting?this.view.state.mode=Sr.INTERACTING:(this.view.state.mode===Sr.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<=pet?this.view.state.mode=Sr.INTERACTING:this.view.state.mode=Sr.IDLE),this.view.state.rasterPixelRatio=this._rasterPixelRatio,this.view.state.contentPixelRatio=Math.min(this._pixelRatio,this.view.qualitySettings.maximumPixelRatio)}_cameraChangedHandler(e,r){e&&r&&e.almostEquals(r)||(this._cameraChangeTime=performance.now(),this._updateViewState())}};u([d({type:kh,dependsOn:["view.state.camera","ready"]})],un.prototype,"camera",null),u([d({type:kh,dependsOn:["view.state.contentCamera","ready"]})],un.prototype,"contentCamera",null),u([d({type:mt})],un.prototype,"center",null),u([d({type:Zr})],un.prototype,"extent",null),u([d({readOnly:!0})],un.prototype,"frustum",null),u([d({readOnly:!0})],un.prototype,"hasInitialView",null),u([d({readOnly:!0,type:Boolean})],un.prototype,"ready",void 0),u([d({type:Number})],un.prototype,"scale",null),u([d()],un.prototype,"padding",null),u([d({readOnly:!0})],un.prototype,"screenCenter",null),u([d({constructOnly:!0})],un.prototype,"view",void 0),u([d({type:mp})],un.prototype,"viewpoint",null),u([d({type:Number})],un.prototype,"zoom",null),u([d({readOnly:!0})],un.prototype,"_pixelRatio",null),u([d({readOnly:!0})],un.prototype,"_rasterPixelRatio",null),u([d({readOnly:!0})],un.prototype,"_usePhysicalPixelRendering",null),u([d({readOnly:!0})],un.prototype,"_usePhysicalPixelRenderingAny",null),u([d()],un.prototype,"_windowDevicePixelRatio",void 0),u([d()],un.prototype,"_devicePixelRatioOverride",void 0),un=u([I("esri.views.3d.state.ViewStateManager")],un);const uet=["camera","viewpoint","extent","scale","center","zoom"],het=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],det={heading:0,tilt:0},k8=new kh,Hy=new Ct,xI=sr(),TI="pending-initial-view",V8="content-camera-reset",pet=300,Rse=100;let Vf=class extends Cg{constructor(){super(...arguments),this.startCamera=new Ct,this.currentCamera=new Ct,this._lastInteraction=0}get isInteractive(){return performance.now()-this._lastInteraction<Rse}stepController(e,r){r.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(r)}onControllerStart(e){this.state=os.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}commitCamera(){this._lastInteraction=performance.now(),setTimeout(()=>this.notifyChange("isInteractive"),Rse),this.view.state.updateCamera(e=>this.stepController(0,e)),this.steppingFinished&&this.finishController()}};u([d({readOnly:!0})],Vf.prototype,"isInteractive",null),u([d()],Vf.prototype,"_lastInteraction",void 0),Vf=u([I("esri.views.3d.state.controllers.InteractiveController")],Vf);var yc;(function(t){t[t.CENTER=0]="CENTER",t[t.EYE=1]="EYE"})(yc||(yc={}));let dR=class extends Vf{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.pivot=yc.CENTER,this._rotScale=0,this._lastPoint=Je(),this._tmpWorldUp=M(),this._tmpViewDir=M(),this._tmpRotCurPoint=Je(),this._tmpTransf=Ie(),this._tmpAxis=M(),this._tmpPivotPoint=M(),this._pivotPos=M(),this._constraintOptions={selection:Di.ALL,interactionType:nr.TUMBLE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:oo.TUMBLE}}initialize(){this._rotScale=this.pivot===yc.CENTER?3:1.5}begin(e){if(this.active){switch(this.pivot){case yc.EYE:le(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=nr.LOOK_AROUND,this._constraintOptions.tiltMode=oo.LOOK_AROUND,this._constraintOptions.selection=Di.NONE;break;case yc.CENTER:{const r=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,this.view.map.ground.opacity===0?rx:{});r||le(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(e,r),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=nr.TUMBLE,this._constraintOptions.tiltMode=oo.TUMBLE,this._constraintOptions.selection=Di.ALL&~Di.DISTANCE;break}}this._constraintOptions.interactionStartCamera=this.startCamera,Kb(this.startCamera,e,this._lastPoint)}}_constrainPivotPoint(e,r){const i=this.startCamera,s=M();me(s,this._pivotPos,i.eye);const n=Me(s),o=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(i.eye,Ose);let a=Math.max(Math.min(XKe,1/Math.abs(ye(Ose,i.viewForward)))*o,YKe);r&&(a=Math.min(n,a));const l=Jr(this.view.spatialReference),c=as(i.width/i.pixelRatio*.5,i.height/i.pixelRatio*.5),h=D5(this.startCamera,c,l);let p=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,i.fullWidth/i.pixelRatio*.5,i.fullHeight/i.pixelRatio*.5,i,2.5*P8,P8),f=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,e[0],e[1],i,P8);(v(p)||v(f))&&(p=It(p,f),f=C(f)||h===io.Horizontal?p:f,a=p>f?f:p,a=r?Math.min(a,n):a),_e(s,s),le(this._pivotPos,fe(this._tmpPivotPoint,i.eye,ae(this._tmpPivotPoint,s,a)))}update(e){if(this.active){switch(this.pivot){case yc.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this._pivotPos);break;case yc.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this._pivotPos)}Hs(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.active&&this.finishController()}_applyRotation(e,r,i,s){this.view.renderCoordsHelper.worldUpAtPosition(s,this._tmpWorldUp),Kb(e,r,this._tmpRotCurPoint);let n=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,o=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;me(this._tmpViewDir,i,s);const a=Me(this._tmpViewDir),l=Sn(ye(this._tmpViewDir,this._tmpWorldUp)/a);if(this.pivot===yc.EYE){n*=-.5;const c=.5*Math.PI-l,h=.5*Math.PI*.99;n=c-Math.max(-h,Math.min(h,c+n))}return n=ge(n+l,Go.min,Go.max)-l,pt(this._tmpAxis,e.up,this._tmpViewDir),this.pivot===yc.CENTER&&(o=-o),$u(this._tmpTransf,o,this._tmpWorldUp),Rc(this._tmpTransf,this._tmpTransf,n,this._tmpAxis),We(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),e.up=We(B8,e.up,this._tmpTransf),fe(B8,s,this._tmpViewDir),Un(this._lastPoint,this._tmpRotCurPoint),B8}};u([d()],dR.prototype,"pivot",void 0),dR=u([I("esri.views.3d.state.controllers.RotateController")],dR);const B8=M(),Ose=M();let z8=class extends $o{constructor(e,r,i,s){super(!0),this._view=e,this.pointerAction=r,this._pivot=i,this.registerIncoming("drag",s,n=>this._handleDrag(n))}_handleDrag(e){const r=e.data;if(r.pointers.size>1||!tZ(e.data,this.pointerAction))return;const i=as(r.center.x,r.center.y);switch(r.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new dR({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController&&this._cameraController.update(i);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}},Aj=class extends Vf{constructor(){super(...arguments),this._pickPoint=M(),this._tmpP0=Je(),this._panAxisAngle=$5(),this._tmpRayDir=M(),this._tmpRayDirPick=M(),this._targetOnSphere=M(),this._navMode=io.Horizontal,this._tmpRay={origin:M(),direction:M()},this.dragBeginPoint=as(),this._normalizedAnchorPoint=Je(),this._constraintOptions={selection:Di.ALL_EXCEPT_COLLISION,interactionType:nr.ZOOM,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:oo.TUMBLE},this._sphere=on(),this._hasPickPoint=!1}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;Un(this.dragBeginPoint,e),Kb(this.startCamera,e,this._normalizedAnchorPoint);const r=Jr(this.view.spatialReference),i=Hbe(this._intersectionHelper,this.startCamera,e,r,iE.Ellipsoid,this.view.map.ground.opacity===0?rx:{});if(this._navMode=D5(this.startCamera,e,r),this._navMode===io.Horizontal)this._hasPickPoint=!!i.scenePickPoint,this._pickPoint=It(i.scenePickPoint,this._pickPoint),this._sphere=i.sphere;else{let s;GE(this.startCamera,e,this._tmpRay),_e(this._tmpRay.direction,this._tmpRay.direction),v(i.scenePickPoint)&&(me(this._tmpRayDirPick,this.startCamera.eye,i.scenePickPoint),s=Me(this._tmpRayDirPick));const n=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,Mse);let o=ge(Math.min(Fbe,1/Math.abs(ye(Mse,this._tmpRay.direction)))*n,hF[0],hF[1]);const a=this.view._stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,L5);o=v(a)?a:o,o=s!=null?Math.min(o,s):o,this._hasPickPoint=!0,ae(this._tmpRay.direction,this._tmpRay.direction,o),fe(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}this._constraintOptions.interactionStartCamera=this.startCamera}update(e){if(this.active){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this._navMode===io.Horizontal){me(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const r=Me(this._tmpRayDir);Kb(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let s=r*2**i;const n=this.view.state.constraints.minimumPoiDistance;if(i<0&&s<n&&(s=n),Math.abs(r-s)<1e-6)return;if(this._hasPickPoint&&s<r){const o=1-(1-s/r)*(1-this._sphere[3]/Me(this.currentCamera.center));this.currentCamera.center=ae(SI,this.currentCamera.center,o)}ae(this._tmpRayDir,this._tmpRayDir,-s/r),this.currentCamera.eye=fe(SI,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=Hd(Cw(this.dragBeginPoint,e)),Hs(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(bO(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),YY(this._pickPoint,this._targetOnSphere,this._panAxisAngle),av(this.currentCamera,this._sphere,this._panAxisAngle))}else{const r=Me(this._tmpRay.direction);Kb(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let s=r*2**i;const n=this.view.state.constraints.minimumPoiDistance;if(i<0&&s<n&&(s=n),Math.abs(r-s)<1e-6)return;ae(this._tmpRayDir,this._tmpRay.direction,1-s/r),this.currentCamera.eye=fe(SI,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=fe(SI,this.currentCamera.center,this._tmpRayDir)}zE(this.view,this.currentCamera),this.commitCamera()}}end(){this.active&&this.finishController()}};Aj=u([I("esri.views.3d.state.controllers.global.ZoomController")],Aj);const SI=M(),Mse=M();let Rj=class extends Vf{constructor(){super(...arguments),this._tmpP=M(),this._tmpDir=M(),this._tmpN=M(),this._tmpP0=Je(),this._tmpPoi=M(),this._tmpRayDir=M(),this.dragBeginPoint=as(),this._normalizedAnchorPoint=Je(),this._constraintOptions={selection:Di.ALL,interactionType:nr.ZOOM,interactionFactor:0,interactionStartCamera:null,interactionDirection:M(),tiltMode:oo.TUMBLE},this._plane=zr()}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;Un(this.dragBeginPoint,e),Kb(this.startCamera,e,this._normalizedAnchorPoint);const r=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,this.view.map.ground.opacity===0?rx:{});me(this._tmpDir,this._tmpP,this.startCamera.eye);const i=Me(this._tmpDir);_e(this._tmpDir,this._tmpDir);const s=Math.abs(this.view.camera.position.z);let n=ge(Math.min(Fbe,1/Math.abs(ye(fet,this._tmpDir)))*s,hF[0],hF[1]);const o=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,e[0],e[1],this.view.state.camera,L5);n=v(o)?o:n,n=r?Math.min(n,i):n,ae(this._tmpDir,this._tmpDir,n),fe(this._tmpP,this.startCamera.eye,this._tmpDir),me(this._tmpN,this.startCamera.eye,this.startCamera.center),_e(this._tmpN,this._tmpN),this._tmpN[1]<0&&ga(this._tmpN,this._tmpN),lM(this._tmpP,this._tmpN,this._plane),this._constraintOptions.interactionStartCamera=this.startCamera}update(e){if(!this.active)return;ZKe(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPoi)||le(this._tmpPoi,this.currentCamera.center),Kb(this.currentCamera,e,this._tmpP0);let r=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);Un(this._normalizedAnchorPoint,this._tmpP0),me(this._tmpRayDir,this._tmpPoi,this.currentCamera.eye);const i=Me(this._tmpRayDir);let s=i*(1-r);this._constraintOptions.interactionDirection&&(le(this._constraintOptions.interactionDirection,this._tmpRayDir),ae(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(r)/i));const n=this.view.state.constraints.minimumPoiDistance;r>=0&&s<n&&(s=n,r=-(s-i)/i),Math.abs(i-s)<1e-6||(ae(this._tmpRayDir,this._tmpRayDir,r),this.currentCamera.eye=fe(zv,this.currentCamera.eye,this._tmpRayDir),Ys(zv,this.currentCamera.center,this._tmpPoi,r),this._tmpPoi[2]>this.startCamera.center[2]?zv[2]=Math.max(this.startCamera.center[2],zv[2]):zv[2]=Math.min(this.startCamera.center[2],zv[2]),this.currentCamera.center=zv,this._constraintOptions.interactionFactor=Hd(Cw(this.dragBeginPoint,e)),Hs(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}end(){this.active&&this.finishController()}};Rj=u([I("esri.views.3d.state.controllers.local.ZoomController")],Rj);const zv=M(),fet=$e(0,0,1);let met=class extends $o{constructor(e,r,i){super(!0),this._view=e,this.pointerAction=r,this.registerIncoming("drag",i,s=>this._handleDrag(s))}_handleDrag(e){const r=e.data;if(r.pointers.size>1||!tZ(e.data,this.pointerAction))return;const i=as(r.center.x,r.center.y);switch(r.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._view.state.isGlobal?this._cameraController=new Aj({view:this._view}):this._cameraController=new Rj({view:this._view}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController&&this._cameraController.update(i);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}};function od(t){let e=t*t;return t<0&&(e*=-1),e}function Pse(t,e,r){const i=r,s=t.state,n=t.device,o=e.tiltDirection==="forward-down"?1:-1,a=1;return n.deviceType==="standard"?(i.translation[0]=od(s.axes[0]),i.translation[1]=od(s.axes[1]),i.translation[2]=od(s.buttons[7])-od(s.buttons[6]),i.heading=od(s.axes[2]),i.tilt=od(s.axes[3])):n.deviceType==="spacemouse"&&(i.translation[0]=1.2*od(s.axes[0]),i.translation[1]=1.2*od(s.axes[1]),i.translation[2]=2*-od(s.axes[2]),i.heading=1.2*od(s.axes[5]),i.tilt=1.2*od(s.axes[3])),i.tilt*=o,ae(i.translation,i.translation,a),i}function Ise(t,e){const r=e;return r.translation[0]=t[1]-t[0],r.translation[1]=t[3]-t[2],r.translation[2]=t[4]-t[5],r.heading=t[7]-t[6],r.tilt=t[8]-t[9],r.zoom=t[10]-t[11],r}function G8(t){return t.translation[0]===0&&t.translation[1]===0&&t.translation[2]===0&&t.heading===0&&t.tilt===0&&t.zoom===0}let Vb=class extends Vf{constructor(e){super(e),this._filteredSurfaceElevation=0,this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this._tmpCamera=new Ct,this._headingStart=0,this._constraintOptions={selection:Di.ALL,interactionType:nr.NONE,interactionStartCamera:new Ct,interactionFactor:0,interactionDirection:null,tiltMode:oo.LOOK_AROUND}}handleEventGamepad(e){const r=Pse(e,this.view.navigation.gamepad,this._transformation);(e.action==="end"||G8(r))&&this.finishController()}activateDirection(e){this._keysButtonState[e]=1,Ise(this._keysButtonState,this._transformation)}deactivateDirection(e){this._keysButtonState[e]=0;const r=Ise(this._keysButtonState,this._transformation);G8(r)&&this.finishController()}onControllerStart(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const r=this.view.pointsOfInterest.cameraOnSurface.location.z,i=1;this._filteredSurfaceElevation+=i*(r-this._filteredSurfaceElevation)*e}stepController(e,r){var i;this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(r),this._updateCameraCenter(),(i=this._constraintOptions.interactionStartCamera)==null||i.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,Gv),this._applyDisabledMovementTypes(Gv),this._applyPan(Gv.pan),this._applyRotate(Gv.rotate),this._applyZoom(Gv.zoom),this._applyAscend(Gv.ascend),this._constraintOptions.interactionType=nr.NONE,this._constraintOptions.selection=Di.COLLISION,Hs(this.view,this.currentCamera,this._constraintOptions),super.stepController(e,r)}_updateStartHeading(){this._transformation.heading!==0&&(this._headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const r=this.currentCamera;me(dl,r.center,r.eye),We(dl,dl,e.matrix),r.center=fe(dl,dl,r.eye),r.up=We(dl,r.up,e.matrix),this._constraintOptions.interactionType=nr.LOOK_AROUND,this._constraintOptions.selection=Di.ALL_EXCEPT_COLLISION,Hs(this.view,r,this._constraintOptions)}_applyPan(e,r=this.currentCamera){e.enabled&&(r.eye=We(dl,r.eye,e.matrix),r.center=We(dl,r.center,e.matrix),this.view.state.isGlobal&&(r.up=We(dl,r.up,e.matrix)),this._constraintOptions.interactionType=nr.PAN,this._constraintOptions.selection=Di.ALL,Hs(this.view,r,this._constraintOptions))}_applyZoom(e){if(!e)return;const r=this.currentCamera.viewForward;this.currentCamera.eye=fe(dl,this.currentCamera.eye,ae(je.get(),r,e)),le(RC,r),ga(RC,RC),this._constraintOptions.interactionDirection=RC,this._constraintOptions.interactionType=nr.ZOOM,this._constraintOptions.selection=Di.ALL_EXCEPT_COLLISION,Hs(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const r=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,je.get());if(this._constraintOptions.interactionDirection=le(RC,r),this.view.state.isGlobal){const i=Me(this.currentCamera.eye),s=(i+e)/i;this.currentCamera.eye=ae(dl,this.currentCamera.eye,s),this.currentCamera.center=ae(dl,this.currentCamera.center,s)}else{const i=ae(je.get(),r,e);this.currentCamera.eye=fe(dl,this.currentCamera.eye,i),this.currentCamera.center=fe(dl,this.currentCamera.center,i)}this._updateCameraCenter(),this._constraintOptions.interactionType=nr.ASCEND,this._constraintOptions.selection=Di.COLLISION,Hs(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=Di.ALL_EXCEPT_COLLISION,Hs(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_calculateControlTransformation(e,r,i){xet(i);const s=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(s,r,i):this._calculateControlTransformationGlobal(s,r,i)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,r=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=r.intersectManifoldClosestSilhouette(i,e,dl)}_calculateControlTransformationLocal(e,r,i){const{viewRight:s,viewForward:n}=r,o=this._transformation,a=this.view.navigation.gamepad,l=ce(je.get(),n[0],n[1],0);_e(l,l);const c=o.translation[0]*e.pan;if(c!==0){const _=ae(je.get(),s,c);ql(i.pan.matrix,i.pan.matrix,_),i.pan.enabled=!0}switch(a.mode){case"pan":{const _=-o.translation[1]*e.pan;if(_!==0){const b=ae(je.get(),l,_);ql(i.pan.matrix,i.pan.matrix,b),i.pan.enabled=!0}i.zoom=o.zoom*e.zoom;break}case"zoom":i.zoom=(-o.translation[1]+o.zoom)*e.zoom;break;default:a.mode}const h=o.translation[2]*e.ascend;i.ascend=h;const p=-o.heading*e.rotate;p!==0&&(Rc(i.rotate.matrix,i.rotate.matrix,p,this.view.renderCoordsHelper.worldUpAtPosition(r.eye,je.get())),i.rotate.enabled=!0);const f=o.tilt*e.rotate,m=ov(this.view.renderCoordsHelper,r.center,r.eye),y=ge(m+f,Go.min,Go.max)-m;y&&(Rc(i.rotate.matrix,i.rotate.matrix,y,s),i.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,r,i){const{eye:s,viewRight:n}=r,o=this._transformation,a=this.view.navigation.gamepad,l=pt(je.get(),n,s);_e(l,l),ga(l,l),rQe(this.startCamera,r,o,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,i,a),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(Gv.pan,this._tmpCamera);const c=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,h=o.translation[2]*e.ascend;i.ascend=h;const p=-o.heading*e.rotate;p!==0&&(Rc(i.rotate.matrix,i.rotate.matrix,p,this._tmpCamera.eye),i.rotate.enabled=!0);const f=o.tilt*e.rotate,m=this._clampTiltDeltaGlobalToValidRange(f,r.ray,c);m!==0&&(Rc(i.rotate.matrix,i.rotate.matrix,m,this._tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=o.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,r,i){const s=Jr(this.view.spatialReference),n=cD(Go.min,r.origin,i,s);let o=0,a=0;const l=je.get();if(this.view.renderCoordsHelper.intersectManifold(r,i,l)){const c=ov(this.view.renderCoordsHelper,l,r.origin);o=cD(c,r.origin,i,s),a=cD(Go.max,r.origin,i,s)}else{OE(U4(k4,i+s.radius),r,l);const c=Sn(-ye(r.direction,_e(l,l)));o=fse(c,r.origin,i,s),a=fse(Go.max,r.origin,i,s)}return ge(o+e,n,a)-o}_getPointAbsoluteSurfaceElevation(e,r,i){const{renderCoordsHelper:s}=this.view,n=s.getAltitude(e),o=r+Math.abs(n-r);return s.setAltitude(i,o,e),o}_clampedDistanceToSurface(e,r){const{renderCoordsHelper:i}=this.view,{camera:s}=this.view.state,{direction:n}=LQe(this.view,r,0,Swe,wet),o=i.intersectManifoldClosestSilhouette(Du(r,n),e,je.get()),a=xi(r,o),l=i.intersectManifoldClosestSilhouette(Du(r,ay(je.get(),r,s.center)),e,je.get()),c=xi(r,l);return Math.min(a,c)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:r,state:i}=this.view,{camera:s,isGlobal:n}=i,o=r.intersectManifoldClosestSilhouette(s.ray,this._filteredSurfaceElevation,je.get());if(n){const a=me(je.get(),e,o),l=Me(a);ae(a,a,1/l);const c=_e(je.get(),e),h=Sn(ye(c,a));return l*Math.sin(Math.min(yet,h))}{const a=le(je.get(),e);return r.setAltitude(a,this._filteredSurfaceElevation),xi(o,a)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:_et}_computeVelocities(e){const r=this._filteredSurfaceElevation,i=r+Jr(this.view.spatialReference).radius,{camera:s,isGlobal:n}=this.view.state,o=je.get(),a=this._getPointAbsoluteSurfaceElevation(s.eye,r,o),l=this._clampedDistanceToSurface(r,o),c=s.width/2,h=$se*s.width,p=$se*s.width,f=l*Math.tan(.5*s.fovX)/c,m=f/i,y=f/this._computeHeadingRotateRadius(o),_=a-r;return{pan:(n?m:f)*h*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(h*e/c)*_-_),zoom:2**(h*e/c)*l-l,rotate:ge(y*p,vet,bet)*e}}_applyDisabledMovementTypes(e){!v(this.disableMovements)||this.disableMovements.mode!==void 0&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&Gh(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&Gh(e.rotate.matrix))}static activatesFor(e,r){const i=Pse(r,e.navigation.gamepad,get);return!(r.action==="end"||G8(i))}};u([d({constructOnly:!0})],Vb.prototype,"gamepadDevice",void 0),u([d({constructOnly:!0})],Vb.prototype,"disableMovements",void 0),Vb=u([I("esri.views.3d.state.controllers.GamepadKeyboardController")],Vb);const get={translation:[0,0,0],heading:0,tilt:0,zoom:0},Swe=80,yet=Gt(Swe),$se=.75,_et=5,vet=Gt(30),bet=Gt(80),Gv={zoom:0,ascend:0,pan:{enabled:!1,matrix:Ie()},rotate:{enabled:!1,matrix:Ie()}},dl=M(),RC=M(),wet=rZ();function xet(t){t.zoom=0,t.ascend=0,t.pan.enabled=!1,Gh(t.pan.matrix),t.rotate.enabled=!1,Gh(t.rotate.matrix)}let Tet=class extends $o{constructor(e){super(!0),this._view=e,this._watchHandles=new ei,this._handle=this.registerIncoming("gamepad",r=>this._handleEventGamepad(r)),this._handle.pause()}onInstall(e){super.onInstall(e),this._watchHandles.add([ie(()=>this._view.navigation.gamepad.enabled,r=>{r?this._handle.resume():(this._handle.pause(),this._cameraControllerGamepad&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null))},Vt),ie(()=>this._view.navigation.gamepad.device,r=>{this._cameraControllerGamepad&&r&&this._cameraControllerGamepad.gamepadDevice!==r&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null)})])}onUninstall(){this._watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(e){const r=this._view.navigation.gamepad.device;if(r&&e.data.device!==r)return;const i=this._cameraControllerGamepad&&this._cameraControllerGamepad.active;if(i||Vb.activatesFor(this._view,e.data)){if(!i){const s=new Vb({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(s)&&(this._cameraControllerGamepad=s)}this._cameraControllerGamepad&&this._cameraControllerGamepad.active&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}};var dc;(function(t){t[t.LEFT=0]="LEFT",t[t.RIGHT=1]="RIGHT",t[t.FORWARD=2]="FORWARD",t[t.BACKWARD=3]="BACKWARD",t[t.UP=4]="UP",t[t.DOWN=5]="DOWN",t[t.HEADINGLEFT=6]="HEADINGLEFT",t[t.HEADINGRIGHT=7]="HEADINGRIGHT",t[t.TILTUP=8]="TILTUP",t[t.TILTDOWN=9]="TILTDOWN",t[t.ZOOMIN=10]="ZOOMIN",t[t.ZOOMOUT=11]="ZOOMOUT"})(dc||(dc={}));let Eet=class extends $o{constructor(e,r){super(!0),this._view=e,this._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:Be.Local},this._keyToNumber={[r.left]:dc.LEFT,[r.right]:dc.RIGHT,[r.forward]:dc.FORWARD,[r.backward]:dc.BACKWARD,[r.up]:dc.UP,[r.down]:dc.DOWN,[r.headingLeft]:dc.HEADINGLEFT,[r.headingRight]:dc.HEADINGRIGHT,[r.tiltUp]:dc.TILTUP,[r.tiltDown]:dc.TILTDOWN,[r.zoomIn]:dc.ZOOMIN,[r.zoomOut]:dc.ZOOMOUT},this.registerIncoming("key-down",null,i=>this._handleKeyDown(i)),this.registerIncoming("key-up",null,i=>this._handleKeyUp(i)),this.registerIncoming("blur",null,()=>this._handleBlur())}_handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const r=this._keyToNumber[e.data.key];r!=null&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active||(this._cameraControllerKeyboard=new Vb({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.activateDirection(r),e.stopPropagation()))}_handleBlur(){this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}_handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const r=this._keyToNumber[e.data.key];r!=null&&this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.deactivateDirection(r),e.stopPropagation())}},Cet=class extends $o{constructor(e,r){super(!0),this._view=e,this.registerIncoming("mouse-wheel",r,i=>this._handleMouseWheel(i))}_handleMouseWheel(e){if(!this._view.navigation.mouseWheelZoomEnabled)return;const r=e.data;this._cameraController&&this._cameraController.active||(this._cameraController=this._view.state.isGlobal?new mF({view:this._view,mode:"interaction"}):new gF({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._cameraController)),this._cameraController.zoomStep(-1/60*r.deltaY,as(r.x,r.y)),e.preventDefault(),e.stopPropagation()}},TF=class{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return this._value===void 0?0:this._value}update(e){this._value===void 0?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}},Dw=class extends _O{constructor(){super(...arguments),this._beginCamera=new Ct,this._elapsedTimeSec=0,this.constraintOptions={selection:Di.ALL,interactionType:nr.PAN,interactionFactor:0,interactionStartCamera:new Ct,interactionDirection:null,tiltMode:oo.TUMBLE}}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new YS}get steppingFinished(){return this.momentum.isFinished(this._elapsedTimeSec)}onControllerStart(e){this._beginCamera.copyFrom(e),this.constraintOptions.interactionStartCamera=this._beginCamera,super.onControllerStart(e)}stepController(e,r){r.copyViewFrom(this._beginCamera),this._elapsedTimeSec+=e,this.momentumStep(this._elapsedTimeSec,r),Hs(this.view,r,this.constraintOptions)}};Dw=u([I("esri.views.3d.state.controllers.momentum.MomentumController")],Dw);let pR=class extends Dw{constructor(e){super(e),this.interactionType=nr.PAN,this._tmpPan=M()}momentumStep(e,r){const i=this.momentum.value(e);ae(this._tmpPan,this.momentum.direction,i),r.eye=me(Lse,r.eye,this._tmpPan),r.center=me(Lse,r.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}};u([d({constructOnly:!0})],pR.prototype,"momentum",void 0),pR=u([I("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],pR);const Lse=M(),Aet=M(),EI=M();let hD=class extends Dw{constructor(e){super(e),this.interactionType=nr.PAN}momentumStep(e,r){const i=this.momentum.value1(e),s=this.momentum.value2(e);le(EI,r.eye),_e(EI,EI),pt(this.momentum.axis2,EI,this.momentum.axis1),Ybe(r,Aet,this.momentum.axis1,i,this.momentum.axis2,s)}};u([d({constructOnly:!0})],hD.prototype,"momentum",void 0),hD=u([I("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],hD);let Eb=class extends Dw{set center(e){this._set("center",ms(e))}set axis(e){this._set("axis",ms(e))}constructor(e){super(e),this.interactionType=nr.TUMBLE}momentumStep(e,r){const i=this.momentum.value(e);av(r,this.center,vO(this.axis,i))}};u([d({constructOnly:!0})],Eb.prototype,"momentum",void 0),u([d({constructOnly:!0})],Eb.prototype,"center",null),u([d({constructOnly:!0})],Eb.prototype,"axis",null),Eb=u([I("esri.views.3d.state.controllers.momentum.MomentumController")],Eb);let P2=class extends Dw{set zoomCenter(e){this._set("zoomCenter",ms(e))}constructor(e){super(e),this.interactionType=nr.ZOOM,this.constraintOptions.interactionDirection=M()}momentumStep(e,r){const{interactionDirection:i}=this.constraintOptions;if(!i)return;le(i,r.eye);const s=this.momentum.valueDelta(0,e);KY(r,this.zoomCenter,s,this.view.state.constraints.minimumPoiDistance),ay(i,r.eye,i)}};u([d({constructOnly:!0})],P2.prototype,"momentum",void 0),u([d({constructOnly:!0})],P2.prototype,"zoomCenter",null),P2=u([I("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],P2);let tb=class extends Dw{set screenCenter(e){this._set("screenCenter",as(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",ms(e))}constructor(e){super(e),this.interactionType=nr.ZOOM,this.radius=0,this._tmpSceneCenter=M(),this._tmpZoomAxisAngle=$5(),this._sphere=on()}initialize(){this._sphere[3]=this.radius}momentumStep(e,r){const i=this.momentum.valueDelta(0,e);Gbe(this._sphere,r,i),this.constraintOptions.interactionType=nr.ZOOM,Hs(this.view,r,this.constraintOptions),bO(this._sphere,r,this.screenCenter,this._tmpSceneCenter),YY(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),av(r,this._sphere,this._tmpZoomAxisAngle),this.constraintOptions.interactionType=nr.PAN}};u([d({constructOnly:!0})],tb.prototype,"momentum",void 0),u([d({constructOnly:!0})],tb.prototype,"screenCenter",null),u([d({constructOnly:!0})],tb.prototype,"sceneCenter",null),u([d({constructOnly:!0})],tb.prototype,"radius",void 0),tb=u([I("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],tb);let qd=class{constructor(e){this._gain=e,this.lastValue=void 0,this.filteredDelta=void 0}update(e){if(this.hasLastValue()){const r=this.computeDelta(e);this._updateDelta(r)}this.lastValue=e}reset(){this.lastValue=void 0,this.filteredDelta=void 0}hasLastValue(){return this.lastValue!==void 0}hasFilteredDelta(){return this.filteredDelta!==void 0}computeDelta(e){return this.lastValue===void 0?NaN:e-this.lastValue}_updateDelta(e){this.filteredDelta!==void 0?this.filteredDelta=(1-this._gain)*this.filteredDelta+this._gain*e:this.filteredDelta=e}},U5=class{constructor(e,r,i){this._initialVelocity=e,this._stopVelocity=r,this._friction=i,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(e){return e>this.duration}get friction(){return this._friction}value(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}valueDelta(e,r){const i=this.value(e);return this.value(e+r)-i}valueFromInitialVelocity(e,r){r=Math.min(r,this.duration);const i=1-this.friction;return e*(i**r-1)/Math.log(i)}},Ret=class extends U5{constructor(e,r,i,s,n){super(e,r,i),this._sceneVelocity=s,this.direction=n}value(e){return super.valueFromInitialVelocity(this._sceneVelocity,e)}},Ewe=class{constructor(e=300,r=12,i=.84){this._minimumInitialVelocity=e,this._stopVelocity=r,this._friction=i,this.enabled=!0,this._time=new qd(.6),this._screen=[new qd(.4),new qd(.4)],this._scene=[new qd(.6),new qd(.6),new qd(.6)],this._tmpDirection=M()}add(e,r,i){if(this.enabled){if(this._time.hasLastValue()&&this._time.computeDelta(i)<.015)return;this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._scene[0].update(r[0]),this._scene[1].update(r[1]),this._scene[2].update(r[2]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._scene[0].reset(),this._scene[1].reset(),this._scene[2].reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta()||!this._time.hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,r=this._screen[1].filteredDelta,i=e==null||r==null?0:Math.sqrt(e*e+r*r),s=this._time.filteredDelta,n=s==null||i==null?0:i/s;return Math.abs(n)<this._minimumInitialVelocity?null:this.createMomentum(n,this._stopVelocity,this._friction)}createMomentum(e,r,i){ce(this._tmpDirection,this._scene[0].filteredDelta??0,this._scene[1].filteredDelta??0,this._scene[2].filteredDelta??0);const s=Me(this._tmpDirection);s>0&&ae(this._tmpDirection,this._tmpDirection,1/s);const n=this._time.filteredDelta;return new Ret(e,r,i,n==null?0:s/n,this._tmpDirection)}},Dse=class{constructor(e){this._gain=e}update(e){this.filteredValue!==void 0?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return this.filteredValue!==void 0}};const Nse=1e-5;let Oet=class extends U5{constructor(e,r,i,s,n,o=0,a){super(e,r,i),this._angularVelocity1=s,this.axis1=n,this.angularVelocity2=o,this.axis2=a}value1(e){return super.valueFromInitialVelocity(this._angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}},Met=class{constructor(e=300,r=12,i=.84){this._minimumInitialVelocity=e,this._stopVelocity=r,this._friction=i,this.enabled=!0,this._tmpAxis1=M(),this._tmpAxis2=M(),this._tmpAngles=Je(),this._time=new qd(.3),this._screen=[new qd(.4),new qd(.4)],this._angle1=new Dse(.6),this._angle2=new Dse(.6),this._axis1=M(),this._axis2=M(),this._lastScene=M()}addMomentumDirectRotation(e,r,i,s,n,o){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;let a=Wbe(this._lastScene,r,this._tmpAxis2,s,n,o);this._angle2.update(0),ua(this._tmpAxis2)<Nse?a=0:_e(this._axis1,this._tmpAxis2),this._angle1.update(a),le(this._lastScene,r)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}addMomentumPreserveHeading(e,r,i,s,n,o,a){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;Xbe(this._lastScene,r,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,s,n,o,a,!1),ua(this._tmpAxis2)<Nse?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),_e(this._axis1,this._tmpAxis1),_e(this._axis2,this._tmpAxis2)),le(this._lastScene,r)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,r=this._screen[1].filteredDelta,i=e==null||r==null?null:Math.sqrt(e*e+r*r),s=this._time.filteredDelta,n=i==null||s==null?0:i/s;return Math.abs(n)<this._minimumInitialVelocity?null:this.createMomentum(n,this._stopVelocity,this._friction)}createMomentum(e,r,i){const s=this._time.filteredDelta,n=this._angle1.filteredValue,o=this._angle2.filteredValue,a=s==null||o==null?0:o/s;return new Oet(e,r,i,s==null||n==null?0:n/s,this._axis1,a,this._axis2)}},Cwe=class{constructor(e=2.5,r=.01,i=.95,s=12){this._minimumInitialVelocity=e,this._stopVelocity=r,this._friction=i,this._maxVelocity=s,this.enabled=!0,this.value=new qd(.8),this.time=new qd(.3)}add(e,r){if(this.enabled&&r!=null){if(this.time.hasLastValue()){if(this.time.computeDelta(r)<.01)return;if(this.value.hasFilteredDelta()){const i=this.value.computeDelta(e);this.value.filteredDelta*i<0&&this.value.reset()}}this.time.update(r),this.value.update(e)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta()||!this.time.hasFilteredDelta())return null;let e=this.value.filteredDelta/this.time.filteredDelta;return e=ge(e,-this._maxVelocity,this._maxVelocity),Math.abs(e)<this._minimumInitialVelocity?null:this.createMomentum(e,this._stopVelocity,this._friction)}createMomentum(e,r,i){return new U5(e,r,i)}},Awe=class extends Cwe{constructor(e=3,r=.01,i=.95,s=12){super(e,r,i,s)}add(e,r){const i=this.value.lastValue;if(i!=null){let s=e-i;for(;s>Math.PI;)s-=2*Math.PI;for(;s<-Math.PI;)s+=2*Math.PI;e=i+s}super.add(e,r)}},Pet=class extends U5{constructor(e,r,i){super(e,r,i)}value(e){const r=super.value(e);return Math.exp(r)}valueDelta(e,r){const i=super.value(e),s=super.value(e+r)-i;return Math.exp(s)}},Rwe=class extends Cwe{constructor(e=2.5,r=.01,i=.95,s=12){super(e,r,i,s)}add(e,r){super.add(Math.log(e),r)}createMomentum(e,r,i){return new Pet(e,r,i)}},Oj=class extends Vf{constructor(){super(...arguments),this._smoothRotation=new TF(.05),this._rotationAxis=M(),this._beginAngle=0,this._beginHeading=0,this._panningPlane=zr(),this._beginRadius=0,this._smoothScaling=new TF(.05),this._zoomCenterScreen=as(),this._zoomMomentumEstimator=new Rwe,this._rotationMomentumEstimator=new Awe,this._panSphericalMomentumEstimator=new Met,this._panPlanarMomentumEstimator=new Ewe,this._adjustedSphere=on(),this._tmp3d=M(),this._tmpScreenPointArray=as(),this._beginScreenPoint=as(),this._beginScenePoint=M(),this._screenPickPoint=as(),this._scenePickPoint=M(),this._mode=io.Horizontal,this._sphere=on(),this._pointerCount=0,this._tmpInteractionDirection=M(),this._constraintOptions={selection:Di.ALL,interactionType:nr.NONE,interactionFactor:0,interactionStartCamera:new Ct,interactionDirection:null,tiltMode:oo.TUMBLE}}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){var n;if(!this.active)return;const r=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=r,this._rotationMomentumEstimator.enabled=r,this._panPlanarMomentumEstimator.enabled=r,this._panSphericalMomentumEstimator.enabled=r,this._beginHeading=-X_.normalize(Gt(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),Mf(e.center,this._screenPickPoint),Un(this._beginScreenPoint,this._screenPickPoint);const i=Jr(this.view.spatialReference),s=Hbe(this._intersectionHelper,this.startCamera,this._screenPickPoint,i,iE.Silhouette,this.view.map.ground.opacity===0?rx:{});C(s.scenePickPoint)||(this._scenePickPoint=s.scenePickPoint,this._sphere=s.sphere,le(this._beginScenePoint,this._scenePickPoint),this._mode=D5(this.startCamera,this._screenPickPoint,i),this._mode===io.Vertical&&this._preparePlanarPanMode(e,s.hasGeometryIntersection),(n=this._constraintOptions.interactionStartCamera)==null||n.copyFrom(this.startCamera))}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const r=e.pointers.size>1;this._mode===io.Horizontal?(r&&this._zoomSpherical(e),this._panningSpherical(e),r&&this._rotateSpherical(e)):(r&&this._zoomPlanar(e),this._panningPlanar(e),r&&this._rotatePlanar(e)),this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const r=this._zoomMomentumEstimator.evaluateMomentum();if(r)return this._mode===io.Horizontal?new tb({view:this.view,momentum:r,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new P2({view:this.view,momentum:r,zoomCenter:this._beginScenePoint});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new Eb({view:this.view,momentum:i,center:this._sphere,axis:this._rotationAxis});if(this._mode===io.Horizontal){const s=this._panSphericalMomentumEstimator.evaluateMomentum();if(s)return new hD({view:this.view,momentum:s})}else{const s=this._panPlanarMomentumEstimator.evaluateMomentum();if(s)return new pR({view:this.view,momentum:s})}return null}_preparePlanarPanMode(e,r){const i=ga(this._tmp3d,this.startCamera.viewForward);lM(this._scenePickPoint,i,this._panningPlane);const s=as(this._screenPickPoint[0],0),n=M(),o=Me(this.startCamera.eye);this._adjustedSphere[3]=o<this._sphere[3]?o-100:this._sphere[3],bO(this._adjustedSphere,this.startCamera,s,n);const a=qo();this.startCamera.projectToRenderScreen(n,a);const l=M(),c=M(),h=M();me(l,this._scenePickPoint,this.currentCamera.eye);const p=Me(l);_e(l,l);const f=Bbe*Math.max(Math.abs(this.view.camera.position.z),zbe),m=this.view._stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,L5);let y=v(m)?m:f;y=r?Math.min(y,p):y,le(h,fe(c,this.currentCamera.eye,ae(c,l,y))),this._panningPlane[3]=-ye(this._panningPlane,h),this.startCamera.center=fe(c,this.startCamera.eye,ae(c,this.startCamera.viewForward,y));const _=Mf(e.center,this._tmpScreenPointArray);Tj(this._panningPlane,this.startCamera,_,this._beginScenePoint)}_zoomSpherical(e){const r=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(r),Gbe(this._sphere,this.currentCamera,this._smoothScaling.value),Mf(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=nr.ZOOM,this._constraintOptions.interactionFactor=Hd(e.radius-this._beginRadius),Hs(this.view,this.currentCamera,this._constraintOptions)}_panningSpherical(e){const r=Mf(e.center,this._tmpScreenPointArray);bO(this._sphere,this.currentCamera,r,this._tmp3d),QY(this._beginScenePoint,ye(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera)?(Jbe(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(r,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(Zbe(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(r,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=nr.PAN,this._constraintOptions.interactionFactor=Hd(Cw(this._screenPickPoint,r)),Hs(this.view,this.currentCamera,this._constraintOptions)}_rotateSpherical(e){_e(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||ga(this._rotationAxis,this._rotationAxis);const r=this._smoothRotation.value,i=r+xj(e.angle-r),s=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=s,this._smoothRotation.update(i);const n=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(n,.001*e.timestamp),av(this.currentCamera,this._sphere,vO(this._rotationAxis,n)),this._constraintOptions.interactionType=nr.TUMBLE,this._constraintOptions.interactionFactor=Hd(e.radius*i),Hs(this.view,this.currentCamera,this._constraintOptions)}_panningPlanar(e){const r=Mf(e.center,this._tmpScreenPointArray);Tj(this._panningPlane,this.currentCamera,r,this._tmp3d)&&(qbe(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(r,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=nr.PAN,this._constraintOptions.interactionFactor=Hd(Cw(this._beginScreenPoint,r)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),Hs(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}_zoomPlanar(e){const r=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(r),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),KY(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=nr.ZOOM,this._constraintOptions.interactionFactor=Hd(e.radius-this._beginRadius),Hs(this.view,this.currentCamera,this._constraintOptions)}_rotatePlanar(e){le(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||ga(this._rotationAxis,this._rotationAxis);const r=this._smoothRotation.value;let i=e.angle-r;i=xj(i);const s=r+i,n=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=n,this._smoothRotation.update(s);const o=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(o,.001*e.timestamp),av(this.currentCamera,this._sphere,vO(this._rotationAxis,o)),this._constraintOptions.interactionType=nr.TUMBLE,this._constraintOptions.interactionFactor=Hd(e.radius*o),Hs(this.view,this.currentCamera,this._constraintOptions)}};Oj=u([I("esri.views.3d.state.controllers.global.PinchAndPanController")],Oj);const Fse=$e(0,0,1),Iet={ELEVATION_THRESHOLD:3e4,ANGLE_THRESHOLD:16/180*Math.PI};let Mj=class extends Vf{constructor(){super(...arguments),this._rotationValueSmooth=new TF(.05),this._scalingValueSmooth=new TF(.05),this._planeHorizontal=zr(),this._planeVertical=zr(),this._rotationMomentumEstimator=new Awe,this._panMomentumEstimator=new Ewe(300,12,.9),this._zoomMomentumEstimator=new Rwe,this._beginRadius=0,this._beginCenter=M(),this._beginAngle=0,this._tmpPoints=[],this._panMode=io.Horizontal,this._beginCenterScreen=as(),this._tmpCentroid3d=M(),this._tmpCentroid2d=as(),this._tmp2d=as(),this._pointerCount=0,this._constraintOptions={selection:Di.ALL,interactionType:nr.NONE,interactionFactor:0,interactionStartCamera:new Ct,interactionDirection:null,tiltMode:oo.TUMBLE}}begin(e){var y;if(!this.active)return;const r=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=r,this._rotationMomentumEstimator.enabled=r,this._panMomentumEstimator.enabled=r,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),Mf(e.center,this._beginCenterScreen),hme(Fse,0,this._planeHorizontal);const i=M(),s=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,i,this.view.map.ground.opacity===0?rx:{}),n=M();ga(n,this.startCamera.viewForward);const o=M();le(o,Fse);const a=ye(n,o),l=Uh(a<0?-a:a);this._panMode=l>=Iet.ANGLE_THRESHOLD?io.Horizontal:io.Vertical;const c=Math.min(Bbe,1/Math.abs(ye(o,this.startCamera.viewForward)))*Math.max(Math.abs(this.view.camera.position.z),zbe);rz(this._planeHorizontal,this._planeHorizontal,i),this.startCamera.aboveGround||iz(this._planeHorizontal,this._planeHorizontal);const h=M(),p=M(),f=M();me(h,i,this.currentCamera.eye);const m=Me(h);if(_e(h,h),this._panMode===io.Vertical){ae(o,o,a),me(this._planeVertical,n,o),_e(this._planeVertical,this._planeVertical),rz(this._planeVertical,this._planeVertical,i);const _=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,L5);let b=v(_)?_:c;b=s?Math.min(b,m):b,le(f,fe(p,this.currentCamera.eye,ae(p,h,b))),this._planeVertical[3]=-ye(this._planeVertical,f),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),I8(this._tmpPoints,this._beginCenter)}else{const _=s?m:c;le(f,fe(p,this.currentCamera.eye,ae(p,h,_))),this._planeHorizontal[3]=-ye(this._planeHorizontal,f),this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),I8(this._tmpPoints,this._beginCenter)}(y=this._constraintOptions.interactionStartCamera)==null||y.copyFrom(this.startCamera)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const r=e.pointers.size>1,i=this._panMode===io.Horizontal?this._planeHorizontal:this._planeVertical,s=this._beginCenter;if(r){const n=this._beginRadius/e.radius,o=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=o,this._scalingValueSmooth.update(n),KY(this.currentCamera,s,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=nr.ZOOM,this._constraintOptions.interactionFactor=Hd(Math.abs(e.radius-this._beginRadius)),Hs(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,i,this.currentCamera,this._tmpPoints),I8(this._tmpPoints,this._tmpCentroid3d),Mf(e.center,this._tmpCentroid2d),qbe(this.currentCamera,s,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=nr.PAN,this._constraintOptions.interactionFactor=Hd(Cw(this._beginCenterScreen,this._tmpCentroid2d)),Hs(this.view,this.currentCamera,this._constraintOptions),r){const n=this._planeHorizontal,o=s,a=this._rotationValueSmooth.value,l=a+xj(e.angle-a),c=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=c,this._rotationValueSmooth.update(l);const h=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(h,.001*e.timestamp),av(this.currentCamera,o,vO(n,h)),this._constraintOptions.interactionType=nr.TUMBLE,this._constraintOptions.interactionFactor=Hd(Math.abs(e.radius*h)),Hs(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const r=this._zoomMomentumEstimator.evaluateMomentum();if(r)return new P2({view:this.view,momentum:r,zoomCenter:this._beginCenter});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new Eb({view:this.view,momentum:i,center:this._beginCenter,axis:this._planeHorizontal});const s=this._panMomentumEstimator.evaluateMomentum();return s?new pR({view:this.view,momentum:s}):null}_computePlanePoints(e,r,i,s){s.length=e.size;const n=this._tmp2d;let o=0;return e.forEach(a=>{n[0]=a.x,n[1]=a.y,s[o]===void 0&&(s[o]=M()),Tj(r,i,n,s[o]),o+=1}),s}get _intersectionHelper(){return this.view.sceneIntersectionHelper}};Mj=u([I("esri.views.3d.state.controllers.local.PinchAndPanController")],Mj);let Use=class extends $o{constructor(e,r,i){super(!0),this._view=e,this.pointerAction=r,this._lastEndTimestamp=0,this._lastTimestamp=0,this.registerIncoming("drag",i,s=>this._handleDrag(s))}_handleDrag(e){if(e.data.pointerType==="mouse"&&!tZ(e.data,this.pointerAction))return;const r=e.timestamp-this._lastEndTimestamp,i=40,s=this._momentum&&this._momentum.active&&r<i;switch(e.data.action){case"start":case"update":if(s)break;this._controller&&this._controller.active?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}_endController(e,r){if(this._controller&&this._controller.active){this._lastEndTimestamp=e.timestamp;const i=this._controller.end(e.data);r&&i&&(this._momentum=i,this._view.state.switchCameraController(this._momentum))}this._controller=null}_startController(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}_createController(){return this._view.state.isGlobal?new Oj({view:this._view}):new Mj({view:this._view})}},$et=class extends $o{constructor(e,r){super(!0),this.view=e,this.registerIncoming("pointer-down",r,()=>this.view.state.stopActiveCameraController())}},Owe=class extends $o{constructor(e,r){super(!0),this.key=e,this.registerIncoming("key-down",r,i=>this._handleKeyDown(i))}_handleKeyDown(e){e.data.key===this.key&&(this.activate(),e.stopPropagation())}},Let=class extends Owe{constructor(e,r,i){super(r,i),this.view=e}activate(){this.view.goTo({heading:0}).catch(()=>{})}},Det=class extends Owe{constructor(e,r,i){super(r,i),this.view=e}activate(){this.view.goTo({tilt:0}).catch(()=>{})}},Net=class extends $o{constructor(e,r=!1){super(!0),this._view=e,this._invert=r,this.registerIncoming("vertical-two-finger-drag",i=>this._handleTwoFinger(i))}_handleTwoFinger(e){var s,n,o;const r=this._invert?-1:1,i=as(0,e.data.delta*r);switch(e.data.action){case"begin":(s=this._cameraController)==null||s.end(),this._cameraController=new dR({view:this._view,pivot:yc.CENTER}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":(n=this._cameraController)==null||n.update(i);break;case"end":(o=this._cameraController)==null||o.end(),this._cameraController=null}}};function kse(t){const e=t.native;return e?{buttons:e.buttons.map(r=>r.pressed?r.value?r.value:1:0),axes:e.axes.map(r=>ket(r,t.axisThreshold))}:{buttons:[],axes:[]}}function Fet(t,e){if(t.axes.length!==e.axes.length||t.buttons.length!==e.buttons.length)return!1;for(let r=0;r<t.axes.length;r++)if(t.axes[r]!==e.axes[r])return!1;for(let r=0;r<t.buttons.length;r++)if(t.buttons[r]!==e.buttons[r])return!1;return!0}function Uet(t){for(let e=0;e<t.axes.length;e++)if(t.axes[e]!==0)return!1;for(let e=0;e<t.buttons.length;e++)if(t.buttons[e]!==0)return!1;return!0}function ket(t,e){const r=Math.abs(t);return r<e?0:Math.sign(t)*(r-e)/(1-e)}let Vet=class{constructor(e,r){this._element=e,this._input=r,this._hasEventListeners=!1,this._onConnectGamepad=n=>{this._connectGamepad(n.gamepad)},this._onDisconnectGamepad=n=>{const o=n.gamepad,a=o.index,l=this._inputDevices[a];l&&(this._emitGamepadEvent(o,kse(l),!1),this._inputDevices.splice(a,1),this._latestUpdate.splice(a,1),this._input.gamepad.devices.remove(l),this.ensurePollingState())},this._frameTask=null,this._latestUpdate=new Array,this._inputDevices=new Array,this._callback=null;const i="getGamepads"in window.navigator,s=window.isSecureContext;this.supported=i&&s,this.supported&&(this._forEachGamepad(n=>this._connectGamepad(n)),window.addEventListener("gamepadconnected",this._onConnectGamepad),window.addEventListener("gamepaddisconnected",this._onDisconnectGamepad),this.ensurePollingState())}destroy(){this.hasEventListeners=!1,this.supported&&(window.removeEventListener("gamepadconnected",this._onConnectGamepad),window.removeEventListener("gamepaddisconnected",this._onDisconnectGamepad))}set hasEventListeners(e){this._hasEventListeners!==e&&(this._hasEventListeners=e,this.ensurePollingState())}get _eventsEnabled(){return this.supported&&this._inputDevices.length>0&&this._hasEventListeners}set onEvent(e){this._callback=e}_connectGamepad(e){const r=new ZX(e);r.deviceType!=="unknown"&&(this._inputDevices[e.index]=r,this._input.gamepad.devices.add(r)),this.ensurePollingState()}ensurePollingState(){this._eventsEnabled?this._startPolling():this._stopPolling()}_startPolling(){this._frameTask==null&&(this._frameTask=vS({update:()=>this._readGamepadState()}))}_stopPolling(){this._frameTask!=null&&(this._frameTask.remove(),this._frameTask=null,this._latestUpdate=new Array)}_readGamepadState(){const e=document.hasFocus(),r=this._element.contains(document.activeElement),i=this._input.gamepad.enabledFocusMode==="document"&&!e||this._input.gamepad.enabledFocusMode==="view"&&!r;this._forEachGamepad(s=>{const n=this._inputDevices[s.index];if(!n)return;const o=this._latestUpdate[s.index],a=kse(n),l=i||Uet(a);o&&(o.timestamp===s.timestamp||!o.active&&l||Fet(o.state,a))||this._emitGamepadEvent(s,a,!l)})}_forEachGamepad(e){const r=window.navigator.getGamepads();for(let i=0;i<r.length;i++){const s=r[i];this._validate(s)&&e(s)}}_emitGamepadEvent(e,r,i){const s=this._latestUpdate[e.index],n=s&&s.active;if(!n&&!i)return;const o=!n&&i?"start":n&&i?"update":"end";this._latestUpdate[e.index]={timestamp:e.timestamp,state:r,active:i},this._callback&&this._callback({device:this._inputDevices[e.index],state:r,action:o})}_validate(e){if(!e||!e.connected)return!1;for(let r=0;r<e.axes.length;r++)if(isNaN(e.axes[r]))return!1;return!0}};const Vse=de("edge"),Bet=de("chrome"),zet=de("ff"),Get=de("safari"),Bse="esri-view-surface",Ox={touchNone:`${Bse}--touch-none`,touchPan:`${Bse}--touch-pan`};let Mwe=class Pwe{constructor(e,r){this._input=r,this._active={},this._callback=()=>{},this._activePointerCaptures=new Set,this._keyDownState=new Set,this._eventId=1,this._browserTouchPanningEnabled=!1,this._element=e,e.getAttribute("tabindex")||e.setAttribute("tabindex","0"),this._eventHandlers={"key-down":this._handleKey,"key-up":this._handleKey,"pointer-down":this._handlePointer,"pointer-move":this._handlePointerPreventDefault,"pointer-up":this._handlePointerPreventDefault,"pointer-enter":this._handlePointer,"pointer-leave":this._handlePointer,"pointer-cancel":this._handlePointer,"mouse-wheel":this._handleMouseWheel,"pointer-capture-lost":this._handlePointerCaptureLost},this._updateTouchAction(),this._element.addEventListener("keydown",this._preventAltKeyDefault),this._gamepadSource=new Vet(e,this._input),this._gamepadSource.onEvent=i=>this._callback("gamepad",i)}destroy(){this._callback=()=>{},this.activeEvents=null,this._activePointerCaptures.forEach(e=>{this._releasePointerCaptureSafe(e)}),this._gamepadSource=ke(this._gamepadSource),this._activePointerCaptures=null,this._removeTouchAction(),this._element.removeEventListener("keydown",this._preventAltKeyDefault)}get browserTouchPanningEnabled(){return this._browserTouchPanningEnabled}set browserTouchPanningEnabled(e){this._browserTouchPanningEnabled=e,this._updateTouchAction(),this._updateTouchEventHandling()}set onEventReceived(e){this._callback=e}set activeEvents(e){for(const r in this._active)if(!e||!e.has(r)){const i=this._active[r];this._element.removeEventListener(j8[r],i),delete this._active[r]}e&&e.forEach(r=>{if(!this._active[r]&&j8[r]){const i=(this._eventHandlers[r]||this._handleDefault).bind(this,r);this._element.addEventListener(j8[r],i),this._active[r]=i}}),this._gamepadSource.hasEventListeners=(e==null?void 0:e.has("gamepad"))??!1}setPointerCapture(e,r){r?(this._element.setPointerCapture(e.pointerId),this._activePointerCaptures.add(e.pointerId)):(this._releasePointerCaptureSafe(e.pointerId),this._activePointerCaptures.delete(e.pointerId))}_updateTouchAction(){this._element.classList.remove(this._browserTouchPanningEnabled?Ox.touchNone:Ox.touchPan),this._element.classList.add(this._browserTouchPanningEnabled?Ox.touchPan:Ox.touchNone)}_updateTouchEventHandling(){this._browserTouchPanningEnabled?this._element.addEventListener("touchmove",this._preventMultiTouchPanning):this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_removeTouchAction(){this._element.classList.remove(Ox.touchNone),this._element.classList.remove(Ox.touchPan),this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_releasePointerCaptureSafe(e){try{if(this._element.hasPointerCapture&&!this._element.hasPointerCapture(e))return;this._element.releasePointerCapture(e)}catch{}}_updateNormalizedPointerLikeEvent(e,r){const i=gve(this._element,e);return Pwe.test.disableSubpixelCoordinates&&(i.x=Math.round(i.x),i.y=Math.round(i.y)),r.x=i.x,r.y=i.y,r}_handleKey(e,r){const i=Fje(r);i&&e==="key-up"&&this._keyDownState.delete(i);const s={native:r,key:i,repeat:!!i&&this._keyDownState.has(i)};i&&e==="key-down"&&this._keyDownState.add(s.key),this._callback(e,s)}_handlePointer(e,r){const i=this._updateNormalizedPointerLikeEvent(r,{native:r,x:0,y:0,pointerType:r.pointerType,button:r.button,buttons:r.buttons,eventId:this._eventId++});this._callback(e,i)}_handlePointerPreventDefault(e,r){const i=this._updateNormalizedPointerLikeEvent(r,{native:r,x:0,y:0,pointerType:r.pointerType,button:r.button,buttons:r.buttons,eventId:this._eventId++});r.preventDefault(),this._callback(e,i)}_handleMouseWheel(e,r){let i=r.deltaY;switch(r.deltaMode){case 0:Vse&&(i=i/document.documentElement.clientHeight*600);break;case 1:i*=30;break;case 2:i*=900}Vse?i*=.7:Bet||Get?i*=.6:zet&&(i*=1.375);const s=100,n=Math.abs(i);n>s&&(i=i/n*200/(1+Math.exp(-.02*(n-s))));const o=this._updateNormalizedPointerLikeEvent(r,{native:r,x:0,y:0,deltaY:i});this._callback(e,o)}_handlePointerCaptureLost(e,r){this._activePointerCaptures.delete(r.pointerId),this._handleDefault(e,r)}_handleDefault(e,r){const i={native:r};r.preventDefault(),this._callback(e,i)}_preventAltKeyDefault(e){e.key==="Alt"&&e.preventDefault()}_preventMultiTouchPanning(e){e.touches.length>1&&e.preventDefault()}};Mwe.test={disableSubpixelCoordinates:!1};const j8={"key-down":"keydown","key-up":"keyup","pointer-down":"pointerdown","pointer-up":"pointerup","pointer-move":"pointermove","mouse-wheel":"wheel","pointer-capture-got":"gotpointercapture","pointer-capture-lost":"lostpointercapture","context-menu":"contextmenu","pointer-enter":"pointerenter","pointer-leave":"pointerleave","pointer-cancel":"pointercancel",focus:"focus",blur:"blur"};let jet=class extends $o{constructor(){super(!0),this.registerIncoming("context-menu",e=>{e.data.native.preventDefault()})}};function Iwe(t,e){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)}function Het(t,e){const r=e.x-t.x,i=e.y-t.y;return Math.sqrt(r*r+i*i)}function qet(t,e){if(e?(e.radius=0,e.center.x=0,e.center.y=0):e={radius:0,center:Bh()},t.length===0)return e;if(t.length===1)return e.center.x=t[0].x,e.center.y=t[0].y,e;if(t.length===2){const[S,E]=t,[O,R]=[E.x-S.x,E.y-S.y];return e.radius=Math.sqrt(O*O+R*R)/2,e.center.x=(S.x+E.x)/2,e.center.y=(S.y+E.y)/2,e}let r=0,i=0;for(let S=0;S<t.length;S++)r+=t[S].x,i+=t[S].y;r/=t.length,i/=t.length;const s=t.map(S=>S.x-r),n=t.map(S=>S.y-i);let o=0,a=0,l=0,c=0,h=0,p=0,f=0;for(let S=0;S<s.length;S++){const E=s[S],O=n[S],R=E*E,L=O*O;o+=R,a+=L,l+=E*O,c+=R*E,h+=L*O,p+=E*L,f+=O*R}const m=.5*(c+p),y=.5*(h+f),_=o*a-l*l,b=(m*a-y*l)/_,x=(o*y-l*m)/_,T=Bh(b+r,x+i);return{radius:Math.sqrt(b*b+x*x+(o+a)/t.length),center:T}}function fR(t){const{native:e}=t,{pointerId:r,button:i,pointerType:s}=e;return s==="mouse"?`${r}:${i}`:`${s}`}let Wet=class extends $o{constructor(e){super(!1),this._navigationTouch=e,this._startStateModifiers=new Set,this._activePointerMap=new Map,this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._drag=this.registerOutgoing("drag"),this.registerIncoming("pointer-drag",this._handlePointerDrag.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-capture-lost",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-cancel",this._handlePointerUpAndPointerLost.bind(this))}_createPayload(e,r,i,s){return{action:e,pointerType:this._pointerType,button:this._mouseButton,buttons:r.buttons,timestamp:s,pointers:Xet(this._activePointerMap),pointer:r,angle:i.angle,radius:i.radius,center:i.center}}_addPointer(e){const r=e.native.pointerId,i=CI(this._activePointerMap).angle,s={event:e,initialAngle:0,lastAngle:0};this._activePointerMap.set(r,s);const n=dD(s,$we(this._activePointerMap));s.initialAngle=n,s.lastAngle=n,this._updatePointerAngles(i)}_updatePointer(e){if(e&&e.x==null&&e.y==null)return;const r=e.native.pointerId,i=this._activePointerMap.get(r);i?i.event=e:this._addPointer(e)}_removePointer(e){const r=CI(this._activePointerMap).angle;this._activePointerMap.delete(e),this._updatePointerAngles(r)}_updatePointerAngles(e){const r=CI(this._activePointerMap);this._activePointerMap.forEach(i=>{i.initialAngle=dD(i,r)-e,i.lastAngle=dD(i,r)-e})}_emitEvent(e,r,i){const s=CI(this._activePointerMap);this._drag.emit(this._createPayload(e,r,s,i),void 0,this._startStateModifiers)}_handlePointerUpAndPointerLost(e){const r=e.data.native.pointerId,i=e.timestamp;this._activePointerMap.get(r)&&(this._activePointerMap.size===1?(this._updatePointer(e.data),!this._isCurrentDragSuppressed&&this._emitEvent("end",e.data,i),this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._removePointer(r)):(this._removePointer(r),this._emitEvent("removed",e.data,e.timestamp)))}_handlePointerDrag(e){const r=e.data,i=r.currentEvent,s=e.timestamp;switch(r.action){case"start":case"update":this._isDragging?this._activePointerMap.has(i.native.pointerId)?(this._updatePointer(i),!this._isCurrentDragSuppressed&&this._emitEvent("update",i,s)):(this._addPointer(i),this._emitEvent("added",i,s),this._isCurrentDragSuppressed=this._isSuppressed):(this._updatePointer(i),this._pointerType=e.data.startEvent.pointerType,this._mouseButton=e.data.startEvent.button,this._startStateModifiers=e.modifiers,this._isDragging=!0,this._isCurrentDragSuppressed=this._isSuppressed,!this._isCurrentDragSuppressed&&this._emitEvent("start",i,s))}}get _isSuppressed(){return!!this._navigationTouch&&!this._navigationTouch.browserTouchPanEnabled&&this._pointerType==="touch"&&this._activePointerMap.size===1}};function $we(t){const e=[];return t.forEach(r=>{e.push(Bh(r.event.x,r.event.y))}),qet(e)}function CI(t){const e=$we(t);let r=0;return t.forEach(i=>{let s=dD(i,e),n=s-i.lastAngle;for(;n>Math.PI;)n-=2*Math.PI;for(;n<-Math.PI;)n+=2*Math.PI;s=i.lastAngle+n,i.lastAngle=s;const o=s-i.initialAngle;r+=o}),r/=t.size||1,{angle:r,radius:e.radius,center:e.center}}function Xet(t){const e=new Map;return t.forEach((r,i)=>e.set(i,r.event)),e}function dD(t,e){const r=t.event,i=r.x-e.center.x,s=r.y-e.center.y;return Math.atan2(s,i)}var zse;(function(t){t[t.Left=0]="Left",t[t.Middle=1]="Middle",t[t.Right=2]="Right",t[t.Back=3]="Back",t[t.Forward=4]="Forward",t[t.Undefined=-1]="Undefined"})(zse||(zse={}));const O_={maximumDoubleClickDelay:250,maximumDoubleClickDistance:10,maximumDoubleTouchDelay:350,maximumDoubleTouchDistance:35};let Yet=class extends $o{constructor(e=O_.maximumDoubleClickDelay,r=O_.maximumDoubleClickDistance,i=O_.maximumDoubleTouchDelay,s=O_.maximumDoubleTouchDistance,n=r4){super(!1),this._maximumDoubleClickDelay=e,this._maximumDoubleClickDistance=r,this._maximumDoubleTouchDelay=i,this._maximumDoubleTouchDistance=s,this._clock=n,this._pointerState=new Map,this._click=this.registerOutgoing("click"),this._doubleClick=this.registerOutgoing("double-click"),this.registerIncoming("immediate-click",this._handleImmediateClick.bind(this)),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this))}onUninstall(){this._pointerState.forEach(e=>e.doubleClickTimer=ji(e.doubleClickTimer))}get hasPendingInputs(){return Ho(this._pointerState,e=>e.doubleClickTimer!=null)}_clearDoubleClickTimer(e,r){const i=this._pointerState.get(e);i&&(i.doubleClickTimer=ji(i.doubleClickTimer),r&&this._click.emit(i.event.data,void 0,i.event.modifiers),this._pointerState.delete(e),this.refreshHasPendingInputs())}_doubleClickTimeoutExceeded(e){const r=this._pointerState.get(e);r.pointerDownCount===1&&this._click.emit(r.event.data,void 0,r.event.modifiers),r.doubleClickTimer=null,this._pointerState.delete(e),this.refreshHasPendingInputs()}_getPointerId(e){const{pointerId:r,pointerType:i,button:s}=e.native;return i==="mouse"?`${r}:${s}`:`${i}`}_handleImmediateClick(e){const r=e.data,{pointerType:i}=r.native,s=this._getPointerId(r);if(!this._pointerState.has(s))return void this._startClick(e);const n=this._pointerState.get(s),{data:o,modifiers:a}=n.event,l=i==="touch"?this._maximumDoubleTouchDistance:this._maximumDoubleClickDistance;Iwe(o,r)>l?(this._clearDoubleClickTimer(s,!0),this._startClick(e)):(this._clearDoubleClickTimer(s,!1),n.pointerDownCount===2&&this._doubleClick.emit(o,void 0,a))}_handlePointerDown(e){const r=fR(e.data),i=this._pointerState.get(r);i&&(i.pointerDownCount+=1)}_startClick(e){const{data:r}=e,{native:{pointerType:i}}=r,s=fR(r),n=i==="touch"?this._maximumDoubleTouchDelay:this._maximumDoubleClickDelay,o=this._clock.setTimeout(()=>this._doubleClickTimeoutExceeded(s),n),a=1;this._pointerState.set(s,{event:e,doubleClickTimer:o,pointerDownCount:a}),this.refreshHasPendingInputs()}},Zet=class extends $o{constructor(e=O_.maximumDoubleClickDelay,r=O_.maximumDoubleClickDistance,i=O_.maximumDoubleTouchDelay,s=O_.maximumDoubleTouchDistance,n=r4){super(!1),this._maximumDoubleClickDelay=e,this._maximumDoubleClickDistance=r,this._maximumDoubleTouchDelay=i,this._maximumDoubleTouchDistance=s,this._clock=n,this._pointerState=new Map,this._immediateDoubleClick=this.registerOutgoing("immediate-double-click"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUp.bind(this))}onUninstall(){this._pointerState.forEach(e=>{e.immediateDoubleClick&&e.immediateDoubleClick.timeoutHandle.remove()}),super.onUninstall()}_handlePointerDown(e){const r=e.data,i=fR(r);if(!this._pointerState.has(i)){const s={downButton:r.native.button,immediateDoubleClick:null};this._pointerState.set(i,s),this.startCapturingPointer(r.native)}}_handlePointerUp(e){const r=e.data,i=fR(r),s=this._pointerState.get(i);if(s&&s.downButton===r.native.button){const n=s.immediateDoubleClick;if(n){n.timeoutHandle.remove();const o=e.data.native.pointerType==="touch"?this._maximumDoubleTouchDistance:this._maximumDoubleClickDistance;Iwe(n,e.data)>o?this._startImmediateDoubleClick(e,s):(this._immediateDoubleClick.emit(e.data,void 0,n.modifiers),this._removeState(r))}else this._startImmediateDoubleClick(e,s)}}_startImmediateDoubleClick(e,r){const i=e.data.native.pointerType==="touch"?this._maximumDoubleTouchDelay:this._maximumDoubleClickDelay;r.immediateDoubleClick={x:e.data.x,y:e.data.y,modifiers:e.modifiers,timeoutHandle:this._clock.setTimeout(()=>this._removeState(e.data),i)}}_removeState(e){const r=fR(e);this._pointerState.delete(r),this.stopCapturingPointer(e.native),this.refreshHasPendingInputs()}};const OC={maximumClickDelay:300,movementUntilMouseDrag:1.5,movementUntilPenDrag:6,movementUntilTouchDrag:6,holdDelay:500};let Jet=class extends $o{constructor(e=OC.maximumClickDelay,r=OC.movementUntilMouseDrag,i=OC.movementUntilPenDrag,s=OC.movementUntilTouchDrag,n=OC.holdDelay,o=r4){super(!1),this._maximumClickDelay=e,this._movementUntilMouseDrag=r,this._movementUntilPenDrag=i,this._movementUntilTouchDrag=s,this._holdDelay=n,this._clock=o,this._pointerState=new Map,this._pointerDrag=this.registerOutgoing("pointer-drag"),this._immediateClick=this.registerOutgoing("immediate-click"),this._pointerHold=this.registerOutgoing("hold"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",a=>{this._handlePointerLoss(a,"pointer-up")}),this.registerIncoming("pointer-capture-lost",a=>{this._handlePointerLoss(a,"pointer-capture-lost")}),this.registerIncoming("pointer-cancel",a=>{this._handlePointerLoss(a,"pointer-cancel")}),this._moveHandle=this.registerIncoming("pointer-move",this._handlePointerMove.bind(this)),this._moveHandle.pause()}onUninstall(){this._pointerState.forEach(e=>{e.holdTimeout=ji(e.holdTimeout)}),super.onUninstall()}_handlePointerDown(e){const r=e.data,i=r.native.pointerId;let s=null;this._pointerState.size===0&&(s=this._clock.setTimeout(()=>{const o=this._pointerState.get(i);if(o){if(!o.isDragging){const a=o.previousEvent;this._pointerHold.emit(a,void 0,e.modifiers),o.holdEmitted=!0}o.holdTimeout=null}},this._holdDelay));const n={startEvent:r,previousEvent:r,startTimestamp:e.timestamp,isDragging:!1,downButton:r.native.button,holdTimeout:s,modifiers:new Set};this._pointerState.set(i,n),this.startCapturingPointer(r.native),this._moveHandle.resume(),this._pointerState.size>1&&this._startDragging(e)}_createPointerDragData(e,r,i){return{action:e,startEvent:r.startEvent,previousEvent:r.previousEvent,currentEvent:i}}_handlePointerMove(e){const r=e.data,i=r.native.pointerId,s=this._pointerState.get(i);s&&(s.isDragging?this._pointerDrag.emit(this._createPointerDragData("update",s,r),void 0,s.modifiers):Het(r,s.startEvent)>this._getDragThreshold(r.native.pointerType)&&this._startDragging(e),s.previousEvent=r)}_getDragThreshold(e){switch(e){case"touch":return this._movementUntilTouchDrag;case"pen":return this._movementUntilPenDrag;default:return this._movementUntilMouseDrag}}_startDragging(e){const r=e.data,i=r.native.pointerId;this._pointerState.forEach(s=>{s.holdTimeout!=null&&(s.holdTimeout.remove(),s.holdTimeout=null),s.isDragging||(s.modifiers=e.modifiers,s.isDragging=!0,i===s.startEvent.native.pointerId?this._pointerDrag.emit(this._createPointerDragData("start",s,r)):this._pointerDrag.emit(this._createPointerDragData("start",s,s.previousEvent),e.timestamp))})}_handlePointerLoss(e,r){const i=e.data,s=i.native.pointerId,n=this._pointerState.get(s);n&&(n.holdTimeout!=null&&(n.holdTimeout.remove(),n.holdTimeout=null),n.isDragging?this._pointerDrag.emit(this._createPointerDragData("end",n,r==="pointer-up"?i:n.previousEvent),void 0,n.modifiers):r==="pointer-up"&&n.downButton===i.native.button&&e.timestamp-n.startTimestamp<=this._maximumClickDelay&&!n.holdEmitted&&this._immediateClick.emit(i),this._pointerState.delete(s),this.stopCapturingPointer(i.native),this._pointerState.size===0&&this._moveHandle.pause())}},Ket=class{constructor(e){this._callbacks=e,this._currentCount=0,this._callbacks.condition||(this._callbacks.condition=()=>!0)}handle(e){const r=e.data,i=r.pointers.size;switch(r.action){case"start":this._currentCount=i,this._emitStart(e);break;case"added":this._emitEnd(this._previousEvent),this._currentCount=i,this._emitStart(e);break;case"update":this._emitUpdate(e);break;case"removed":this._startEvent&&this._emitEnd(this._previousEvent),this._currentCount=i,this._emitStart(e);break;case"end":this._emitEnd(e),this._currentCount=0}this._previousEvent=e}_emitStart(e){var r,i;this._startEvent=e,(i=(r=this._callbacks).condition)!=null&&i.call(r,this._currentCount,e)&&this._callbacks.start(this._currentCount,e,this._startEvent)}_emitUpdate(e){var r,i;(i=(r=this._callbacks).condition)!=null&&i.call(r,this._currentCount,e)&&this._callbacks.update(this._currentCount,e,this._startEvent)}_emitEnd(e){var r,i;(i=(r=this._callbacks).condition)!=null&&i.call(r,this._currentCount,e)&&this._callbacks.end(this._currentCount,e,this._startEvent),this._startEvent=null}},Qet=class extends $o{constructor(e=20,r=40){super(!1),this._threshold=e,this._maxDelta=r,this._state="ready",this._emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this._dragEventSeparator=new Ket({start:(i,s)=>this._observeStart(i,s),update:(i,s,n)=>this._observeUpdate(i,s,n),end:(i,s)=>this._observeEnd(s)}),this.registerIncoming("drag",i=>this._dragEventSeparator.handle(i))}get failed(){return this._state==="failed"}_observeStart(e,r){e===1&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:r.data.button,buttons:r.data.buttons,pointerType:r.data.pointerType,timestamp:r.data.timestamp,pointers:r.data.pointers,pointer:r.data.pointer,angle:r.data.angle,radius:r.data.radius,center:r.data.center}),r.stopPropagation()),this._state=e===2?"ready":"failed"}_observeUpdate(e,r,i){if(this._state!=="failed"&&e===2)return this._state==="active"?(this._vertical.emit({delta:r.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void r.stopPropagation()):void(this._checkMovementWithinLimits(r.data,i.data)?this._checkVerticalThresholdReached(r.data,i.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=r.data.center,this._artificalDrag.emit({action:"end",button:r.data.button,buttons:r.data.buttons,pointerType:r.data.pointerType,timestamp:r.data.timestamp,pointers:r.data.pointers,pointer:r.data.pointer,angle:r.data.angle,radius:r.data.radius,center:r.data.center}),this._vertical.emit({delta:r.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),r.stopPropagation()):this._state="failed")}_observeEnd(e){this._state==="active"&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}_checkMovementWithinLimits(e,r){let i=-1/0,s=1/0,n=-1/0,o=1/0;for(const{x:_,y:b}of r.pointers.values())i=Math.max(i,_),s=Math.min(s,_),n=Math.max(n,b),o=Math.min(o,b);let a=-1/0,l=1/0,c=-1/0,h=1/0;for(const{x:_,y:b}of e.pointers.values())a=Math.max(a,_),l=Math.min(l,_),c=Math.max(c,b),h=Math.min(h,b);const p=i-s,f=n-o,m=a-l,y=c-h;return Math.abs(e.center.x-r.center.x)<this._threshold&&Math.abs(m-p)<=this._maxDelta&&Math.abs(y-f)<=this._maxDelta}_checkVerticalThresholdReached(e,r){let i=Math.abs(e.center.y-r.center.y);return e.pointers.forEach((s,n)=>{const o=r.pointers.get(n);i=Math.min(i,Math.abs(s.y-o.y))}),i>=this._threshold}},Rd=class extends Te{constructor(){super(...arguments),this._handles=new ei}destroy(){this._handles=ke(this._handles),this.disconnect()}get primaryDragAction(){return this._get("primaryDragAction")}set primaryDragAction(e){e!=="pan"&&e!=="rotate"||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode())}get mode(){return this._get("mode")}set mode(e){e!=="default"&&e!=="pro"||e===this._get("mode")||(this._set("mode",e),this._updateMode())}get hasPendingInputs(){var e;return!!((e=this._inputManager)!=null&&e.hasPendingInputs)}get latestPointerType(){var e;return(e=this._inputManager)==null?void 0:e.latestPointerType}get latestPointerLocation(){var e;return(e=this._inputManager)==null?void 0:e.latestPointerLocation}get multiTouchActive(){var e;return((e=this._inputManager)==null?void 0:e.multiTouchActive)??!1}disconnect(){this.view.viewEvents.disconnect(),this._inputManager=ke(this._inputManager)}connect(){const e=this.view;this._source=new Mwe(this.view.surface,e.input);const r=[new Zet,new Jet,new Yet,new Wet(this.view.navigation),new Qet],i=new lf({eventSource:this._source,recognizers:r});this._inputManager=i,i.installHandlers("prevent-context-menu",[new jet],F_.INTERNAL),this._modeDragPan=new Use(e,"primary"),this._modeDragRotate=new z8(e,"secondary",yc.CENTER),this._modeDragZoom=new met(e,"tertiary");const s={lookAround:"b",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"},resetHeading:"n",resetTilt:"p"};i.installHandlers("navigation",[new $et(e),new cQe(e),new Tet(e),new Eet(e,s.pan),new Cet(e),new Det(e,s.resetTilt),new Let(e,s.resetHeading),new z8(e,"primary",yc.EYE,[s.lookAround]),new z8(e,"secondary",yc.CENTER,[s.lookAround]),new Use(e,"tertiary",[s.lookAround]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new Net(e)],F_.INTERNAL),this.view.viewEvents.connect(i),this._updateMode(),this._handles.add(ie(()=>{var n;return(n=this.view.navigation)==null?void 0:n.browserTouchPanEnabled},n=>{this._source.browserTouchPanningEnabled=!n},Vt))}_updateMode(){var s;const e=this.mode,r=this.primaryDragAction,i=(s=Pj.get(e))==null?void 0:s.get(r);i&&(this._modeDragPan&&(this._modeDragPan.pointerAction=i.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=i.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=i.zoom))}get test(){return{inputManager:this._inputManager,modeDragPan:this._modeDragPan,modeDragRotate:this._modeDragRotate,modeDragZoom:this._modeDragZoom}}};u([d()],Rd.prototype,"view",void 0),u([d({value:"pan"})],Rd.prototype,"primaryDragAction",null),u([d({value:"default"})],Rd.prototype,"mode",null),u([d({readOnly:!0})],Rd.prototype,"hasPendingInputs",null),u([d()],Rd.prototype,"latestPointerType",null),u([d()],Rd.prototype,"latestPointerLocation",null),u([d()],Rd.prototype,"multiTouchActive",null),u([d()],Rd.prototype,"_inputManager",void 0),Rd=u([I("esri.views.3d.input.SceneInputManager")],Rd);const Pj=new Map,H8=new Map,q8=new Map;H8.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),H8.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),q8.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),q8.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),Pj.set("default",H8),Pj.set("pro",q8);const ett=Rd;let fu,cS,Ij=!1,$j=!1,Lj=!1,Dj=!1,mR=null;function ttt(t,e){if(!$j||!cS)return;Lwe();const r=cS;let i=0;for(let s=0;s<t.accBinsNumX;s++)for(let n=0;n<t.accBinsNumY;n++){const o=t.accBins[s][t.accBinsNumY-1-n];i+=o.length;const a=s*t.accBinsSizeX,l=(s+1)*t.accBinsSizeX,c=n*t.accBinsSizeY,h=(n+1)*t.accBinsSizeY;r.fillText(o.length.toFixed(),a+5,c+15),Dwe(a,l,c,h,"blue")}r.fillText("total totalShownLabels: "+i,70,40),r.fillText("total visible labels: "+e.size,70,50),r.fillText("total numTests: "+t.accNumTests,70,30)}function rtt(t){Lj=qr.DECONFLICTOR_SHOW_VISIBLE,Dj=qr.DECONFLICTOR_SHOW_INVISIBLE,Ij=Lj||Dj,$j=qr.DECONFLICTOR_SHOW_GRID,mR=null,Ij||$j?mR=()=>itt(t):fu&&(fu.parentElement.removeChild(fu),fu=null)}function Lwe(){mR&&(mR(),mR=null)}function itt(t){fu==null&&(fu=document.createElement("canvas"),fu.setAttribute("id","canvas2d"),t.surface.parentElement.style.position="relative",t.surface.parentElement.appendChild(fu));const{state:e}=t,{camera:r,pixelRatio:i}=e,{width:s,height:n}=r,o=s*i,a=n*i;fu.setAttribute("width",`${o}px`),fu.setAttribute("height",`${a}px`),fu.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${s}px;height:${n}px`),cS=fu.getContext("2d"),cS.clearRect(0,0,s,n),cS.font="12px Arial"}function Dwe(t,e,r,i,s){Lwe();const n=fu.height,o=cS;o.beginPath(),o.lineWidth=1,o.strokeStyle=s,o.moveTo(t,n-r),o.lineTo(e,n-r),o.stroke(),o.lineTo(e,n-i),o.stroke(),o.lineTo(e,n-r),o.stroke(),o.lineTo(t,n-r),o.stroke(),o.lineTo(t,n-r),o.stroke(),o.closePath()}function stt(t,e){Ij&&(e&&Lj||!e&&Dj)&&Dwe(t.aabr[0],t.aabr[2],t.aabr[1],t.aabr[3],e?"green":"red")}var So,Ec;(function(t){t[t.GRAPHIC=0]="GRAPHIC",t[t.LABEL=1]="LABEL",t[t._COUNT=2]="_COUNT"})(So||(So={})),function(t){t[t.USER_SETTING=0]="USER_SETTING",t[t.SCALE_RANGE=1]="SCALE_RANGE",t[t.FILTER=2]="FILTER",t[t.DECONFLICTION=3]="DECONFLICTION",t[t._COUNT=4]="_COUNT"}(Ec||(Ec={}));function Nwe(t,e){return new Vwe(t,zwe,e)}function ntt(t,e){const{curvatureDependent:r,scaleStart:i,scaleFallOffRange:s}=zwe;return new Vwe(t,{curvatureDependent:{min:{curvature:r.min.curvature,tiltAngle:r.min.tiltAngle,scaleFallOffFactor:W8.curvatureDependent.min.scaleFallOffFactor},max:{curvature:r.max.curvature,tiltAngle:r.max.tiltAngle,scaleFallOffFactor:W8.curvatureDependent.max.scaleFallOffFactor}},scaleStart:i,scaleFallOffRange:s,minPixelSize:W8.minPixelSize},e)}function ott(t){return Math.abs(t*t*t)}function Fwe(t,e,r){const i=r.parameters,s=r.paddingPixelsOverride;return MC.scale=Math.min(i.divisor/(e-i.offset),1),MC.factor=ott(t),MC.minPixelSize=i.minPixelSize,MC.paddingPixels=s,MC}function Uwe(t,e){return t===0?e.minPixelSize:e.minPixelSize*(1+2*e.paddingPixels/t)}function lZ(t,e){return Math.max(Ft(t*e.scale,t,e.factor),Uwe(t,e))}function att(t,e,r){const i=Fwe(t,e,r);return i.minPixelSize=0,i.paddingPixels=0,lZ(1,i)}function Gse(t,e,r,i){i.scale=att(t,e,r),i.factor=0,i.minPixelSize=r.parameters.minPixelSize,i.paddingPixels=r.paddingPixelsOverride}function kwe(t,e,r=[0,0]){const i=Math.min(Math.max(e.scale,Uwe(t[1],e)/Math.max(1e-5,t[1])),1);return r[0]=t[0]*i,r[1]=t[1]*i,r}function ltt(t,e,r,i){return lZ(t,Fwe(e,r,i))}let Vwe=class Bwe{get paddingPixelsOverride(){return this._paddingPixelsOverride||this.parameters.paddingPixels}constructor(e,r,i,s=ctt(),n){this._viewingMode=e,this._description=r,this._ellipsoidRadius=i,this.parameters=s,this._paddingPixelsOverride=n,this._viewingMode===Be.Local?(this._coverageCompensation=this._surfaceCoverageCompensationLocal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersLocal):(this._coverageCompensation=this._surfaceCoverageCompensationGlobal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersGlobal)}update(e){return(!this.parameters||this.parameters.camera.fovY!==e.fovY||this.parameters.camera.distance!==e.distance)&&(this._calculateParameters(e,this._ellipsoidRadius,this.parameters),!0)}overridePadding(e){return e!==this.paddingPixelsOverride?new Bwe(this._viewingMode,this._description,this._ellipsoidRadius,this.parameters,e):this}_calculateParameters(e,r,i){const{scaleStart:s,scaleFallOffRange:n,minPixelSize:o}=this._description,{fovY:a,distance:l}=e,c=this._calculateCurvatureDependentParameters(e,r),h=this._coverageCompensation(e,r,c),{tiltAngle:p,scaleFallOffFactor:f}=c,m=Math.sin(p)*l,y=.5*Math.PI-p-a*(.5-s*h),_=m/Math.cos(y),b=y+a*n*h,x=(_-f*(m/Math.cos(b)))/(1-f);return i.camera.fovY=e.fovY,i.camera.distance=e.distance,i.offset=x,i.divisor=_-x,i.minPixelSize=o,i}_calculateCurvatureDependentParametersLocal(e,r,i=jse){return i.tiltAngle=this._description.curvatureDependent.min.tiltAngle,i.scaleFallOffFactor=this._description.curvatureDependent.min.scaleFallOffFactor,i}_calculateCurvatureDependentParametersGlobal(e,r,i=jse){const s=this._description.curvatureDependent,n=1+e.distance/r,o=Math.sqrt(n*n-1),[a,l]=[s.min.curvature,s.max.curvature],c=ge((o-a)/(l-a),0,1),[h,p]=[s.min,s.max];return i.tiltAngle=Ft(h.tiltAngle,p.tiltAngle,c),i.scaleFallOffFactor=Ft(h.scaleFallOffFactor,p.scaleFallOffFactor,c),i}_surfaceCoverageCompensationLocal(e,r,i){return(e.fovY-i.tiltAngle)/e.fovY}_surfaceCoverageCompensationGlobal(e,r,i){const s=r*r,n=i.tiltAngle+.5*Math.PI,{fovY:o,distance:a}=e,l=a*a+s-2*Math.cos(n)*a*r,c=Math.sqrt(l),h=Math.sqrt(l-s);return(Math.acos(h/c)-Math.asin(r/(c/Math.sin(n)))+.5*o)/o}};const zwe={curvatureDependent:{min:{curvature:Gt(10),tiltAngle:Gt(12),scaleFallOffFactor:.5},max:{curvature:Gt(70),tiltAngle:Gt(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0},W8={curvatureDependent:{min:{scaleFallOffFactor:.7},max:{scaleFallOffFactor:.95}},minPixelSize:14};function ctt(){return{camera:{distance:0,fovY:0},divisor:0,offset:0,minPixelSize:0,paddingPixels:0}}const MC={scale:0,factor:0,minPixelSize:0,paddingPixels:0},jse={tiltAngle:0,scaleFallOffFactor:0};function utt(t){return t instanceof Float32Array&&t.length>=16}function htt(t){return Array.isArray(t)&&t.length>=16}function dtt(t){return utt(t)||htt(t)}function cZ(t){t.vertex.code.add(w`float screenSizePerspectiveMinSize(float size, vec4 factor) {
float nonZeroSize = 1.0 - step(size, 0.0);
return (
factor.z * (
1.0 +
nonZeroSize *
2.0 * factor.w / (
size + (1.0 - nonZeroSize)
)
)
);
}`),t.vertex.code.add(w`float screenSizePerspectiveViewAngleDependentFactor(float absCosAngle) {
return absCosAngle * absCosAngle * absCosAngle;
}`),t.vertex.code.add(w`vec4 screenSizePerspectiveScaleFactor(float absCosAngle, float distanceToCamera, vec4 params) {
return vec4(
min(params.x / (distanceToCamera - params.y), 1.0),
screenSizePerspectiveViewAngleDependentFactor(absCosAngle),
params.z,
params.w
);
}`),t.vertex.code.add(w`float applyScreenSizePerspectiveScaleFactorFloat(float size, vec4 factor) {
return max(mix(size * factor.x, size, factor.y), screenSizePerspectiveMinSize(size, factor));
}`),t.vertex.code.add(w`float screenSizePerspectiveScaleFloat(float size, float absCosAngle, float distanceToCamera, vec4 params) {
return applyScreenSizePerspectiveScaleFactorFloat(
size,
screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params)
);
}`),t.vertex.code.add(w`vec2 applyScreenSizePerspectiveScaleFactorVec2(vec2 size, vec4 factor) {
return mix(size * clamp(factor.x, screenSizePerspectiveMinSize(size.y, factor) / max(1e-5, size.y), 1.0), size, factor.y);
}`),t.vertex.code.add(w`vec2 screenSizePerspectiveScaleVec2(vec2 size, float absCosAngle, float distanceToCamera, vec4 params) {
return applyScreenSizePerspectiveScaleFactorVec2(size, screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params));
}`)}function ptt(t){t.uniforms.add(new pr("screenSizePerspective",e=>Gwe(e.screenSizePerspective)))}function k5(t){t.uniforms.add(new pr("screenSizePerspectiveAlignment",e=>Gwe(e.screenSizePerspectiveAlignment||e.screenSizePerspective)))}function Gwe(t){return ti(ftt,t.parameters.divisor,t.parameters.offset,t.parameters.minPixelSize,t.paddingPixelsOverride)}const ftt=sr();let jwe=class extends ws{constructor(e,r){super(e,"mat4",di.Draw,(i,s,n)=>i.setUniformMatrix4fv(e,r(s,n)))}};function bp(t,e){e.instancedDoublePrecision?t.constants.add("cameraPosition","vec3",ma):t.uniforms.add(new Pu("cameraPosition",(r,i)=>ce(Hwe,i.camera.viewInverseTransposeMatrix[3]-r.origin[0],i.camera.viewInverseTransposeMatrix[7]-r.origin[1],i.camera.viewInverseTransposeMatrix[11]-r.origin[2])))}function $c(t,e){if(!e.instancedDoublePrecision)return void t.uniforms.add([new Hi("proj",(i,s)=>s.camera.projectionMatrix),new jwe("view",(i,s)=>ql(Hse,s.camera.viewMatrix,i.origin)),new Pu("localOrigin",i=>i.origin)]);const r=i=>ce(Hwe,i.camera.viewInverseTransposeMatrix[3],i.camera.viewInverseTransposeMatrix[7],i.camera.viewInverseTransposeMatrix[11]);t.uniforms.add([new Hi("proj",(i,s)=>s.camera.projectionMatrix),new Hi("view",(i,s)=>ql(Hse,s.camera.viewMatrix,r(s))),new qt("localOrigin",(i,s)=>r(s))])}const Hse=pM(),Hwe=M();function nE(t){t.uniforms.add(new Hi("viewNormal",(e,r)=>r.camera.viewInverseTransposeMatrix))}function qwe(t,e){const r=t.vertex;e.hasVerticalOffset?(Wwe(r),e.hasScreenSizePerspective&&(t.include(cZ),k5(r),bp(t.vertex,e)),r.code.add(w`
      vec3 calculateVerticalOffset(vec3 worldPos, vec3 localOrigin) {
        float viewDistance = length((view * vec4(worldPos, 1.0)).xyz);
        ${e.spherical?w`vec3 worldNormal = normalize(worldPos + localOrigin);`:w`vec3 worldNormal = vec3(0.0, 0.0, 1.0);`}
        ${e.hasScreenSizePerspective?w`
            float cosAngle = dot(worldNormal, normalize(worldPos - cameraPosition));
            float verticalOffsetScreenHeight = screenSizePerspectiveScaleFloat(verticalOffset.x, abs(cosAngle), viewDistance, screenSizePerspectiveAlignment);`:w`
            float verticalOffsetScreenHeight = verticalOffset.x;`}
        // Screen sized offset in world space, used for example for line callouts
        float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * viewDistance, verticalOffset.z, verticalOffset.w);
        return worldNormal * worldOffset;
      }

      vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) {
        return worldPos + calculateVerticalOffset(worldPos, localOrigin);
      }
    `)):r.code.add(w`vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) { return worldPos; }`)}const mtt=sr();function Wwe(t){t.uniforms.add(new pr("verticalOffset",(e,r)=>{const{minWorldLength:i,maxWorldLength:s,screenLength:n}=e.verticalOffset,o=Math.tan(.5*r.camera.fovY)/(.5*r.camera.fullViewport[3]),a=r.camera.pixelRatio||1;return ti(mtt,n*a,o,i,s)}))}var cu;(function(t){t[t.Occluded=0]="Occluded",t[t.NotOccluded=1]="NotOccluded",t[t.Both=2]="Both",t[t.COUNT=3]="COUNT"})(cu||(cu={}));var kl;function Xwe(t,e){t.include(cZ),t.attributes.add(A.POSITION,"vec3"),t.attributes.add(A.NORMAL,"vec3"),t.attributes.add(A.AUXPOS1,"vec4");const r=t.vertex;$c(r,e),bp(r,e),r.uniforms.add([new pr("viewport",(i,s)=>s.camera.fullViewport),new Pe("polygonOffset",i=>i.shaderPolygonOffset),new Pe("cameraGroundRelative",(i,s)=>s.camera.aboveGround?1:-1),new Pe("renderTransparentlyOccludedHUD",(i,s)=>s.renderTransparentlyOccludedHUD===cu.Occluded?1:s.renderTransparentlyOccludedHUD===cu.NotOccluded?0:.75),new Mt("hudVisibilityTexture",(i,s)=>s.hudVisibilityTexture)]),e.hasVerticalOffset&&Wwe(r),r.constants.add("smallOffsetAngle","float",.984807753012208),r.code.add(w`struct ProjectHUDAux {
vec3 posModel;
vec3 posView;
vec3 vnormal;
float distanceToCamera;
float absCosAngle;
};`),r.code.add(w`float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {
float pointGroundSign = sign(pointGroundDistance);
if (pointGroundSign == 0.0) {
pointGroundSign = cameraGroundRelative;
}
float groundRelative = cameraGroundRelative * pointGroundSign;
if (polygonOffset > .0) {
float cosAlpha = clamp(absCosAngle, 0.01, 1.0);
float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;
float factor = (1.0 - tanAlpha / viewport[2]);
if (groundRelative > 0.0) {
posView *= factor;
}
else {
posView /= factor;
}
}
return groundRelative;
}`),e.isDraped&&!e.hasVerticalOffset||nE(r),e.isDraped||(r.uniforms.add(new Pe("perDistancePixelRatio",(i,s)=>Math.tan(s.camera.fovY/2)/(s.camera.fullViewport[2]/2))),r.code.add(w`void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {
float distanceToCamera = length(posView);
float pixelOffset = distanceToCamera * perDistancePixelRatio * 0.5;
vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;
vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
posModel += modelOffset;
posView += viewOffset;
}`)),e.screenCenterOffsetUnitsEnabled===kl.Screen&&r.uniforms.add(new Pe("pixelRatio",(i,s)=>s.camera.pixelRatio)),e.hasScreenSizePerspective&&k5(r),r.code.add(w`
    vec4 projectPositionHUD(out ProjectHUDAux aux) {
      // centerOffset is in view space and is used to implement world size offsetting
      // of labels with respect to objects. It also pulls the label towards the viewer
      // so that the label is visible in front of the object.
      vec3 centerOffset = auxpos1.xyz;

      // The pointGroundDistance is the distance of the geometry to the ground and is
      // negative if the point is below the ground, or positive if the point is above
      // ground.
      float pointGroundDistance = auxpos1.w;

      aux.posModel = position;
      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;
      aux.vnormal = normal;
      ${e.isDraped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);"}

      // Screen sized offset in world space, used for example for line callouts
      // Note: keep this implementation in sync with the CPU implementation, see
      //   - MaterialUtil.verticalOffsetAtDistance
      //   - HUDMaterial.applyVerticalOffsetTransformation

      aux.distanceToCamera = length(aux.posView);

      vec3 viewDirObjSpace = normalize(cameraPosition - aux.posModel);
      float cosAngle = dot(aux.vnormal, viewDirObjSpace);

      aux.absCosAngle = abs(cosAngle);

      ${e.hasScreenSizePerspective&&(e.hasVerticalOffset||e.screenCenterOffsetUnitsEnabled===kl.Screen)?"vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":""}

      ${e.hasVerticalOffset?e.hasScreenSizePerspective?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":""}

      ${e.hasVerticalOffset?w`
            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);
            vec3 modelOffset = aux.vnormal * worldOffset;
            aux.posModel += modelOffset;
            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
            aux.posView += viewOffset;
            // Since we elevate the object, we need to take that into account
            // in the distance to ground
            pointGroundDistance += worldOffset;`:""}

      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);

      ${e.screenCenterOffsetUnitsEnabled!==kl.Screen?w`
            // Apply x/y in view space, but z in screen space (i.e. along posView direction)
            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);

            // Same material all have same z != 0.0 condition so should not lead to
            // branch fragmentation and will save a normalization if it's not needed
            if (centerOffset.z != 0.0) {
              aux.posView -= normalize(aux.posView) * centerOffset.z;
            }
          `:""}

      vec4 posProj = proj * vec4(aux.posView, 1.0);

      ${e.screenCenterOffsetUnitsEnabled===kl.Screen?e.hasScreenSizePerspective?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":""}

      ${e.screenCenterOffsetUnitsEnabled===kl.Screen?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""}

      // constant part of polygon offset emulation
      posProj.z -= groundRelative * polygonOffset * posProj.w;
      return posProj;
    }
  `),r.code.add(w`bool testVisibilityHUD(vec4 posProj) {
vec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);
vec4 occlusionPixel = texture2D(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);
if (renderTransparentlyOccludedHUD > 0.5) {
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * renderTransparentlyOccludedHUD < 1.0;
}
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;
}`)}(function(t){t[t.World=0]="World",t[t.Screen=1]="Screen",t[t.COUNT=2]="COUNT"})(kl||(kl={}));const AI=En();function Ywe(t,e,r,i,s,n){if(t.visible)if(t.boundingInfo){ft(t.type===$s.Mesh);const o=e.tolerance;Zwe(t.boundingInfo,r,i,o,s,n)}else{const o=t.indices.get(A.POSITION),a=t.vertexAttributes.get(A.POSITION);IM(r,i,0,o.length/3,o,a,void 0,s,n)}}const gtt=M();function Zwe(t,e,r,i,s,n){if(C(t))return;const o=Kwe(e,r,gtt);if(fpe(AI,t.bbMin),mpe(AI,t.bbMax),v(s)&&s.applyToAabb(AI),hZ(AI,e,o,i)){const{primitiveIndices:a,indices:l,position:c}=t,h=a?a.length:l.length/3;if(h>btt){const p=t.getChildren();if(p!==void 0){for(const f of p)Zwe(f,e,r,i,s,n);return}}IM(e,r,0,h,l,c,a,s,n)}}const Jwe=M();function IM(t,e,r,i,s,n,o,a,l){if(o)return ytt(t,e,r,i,s,n,o,a,l);const{data:c,stride:h}=n,p=t[0],f=t[1],m=t[2],y=e[0]-p,_=e[1]-f,b=e[2]-m;for(let x=r,T=3*r;x<i;++x){let S=h*s[T++],E=c[S++],O=c[S++],R=c[S];S=h*s[T++];let L=c[S++],P=c[S++],U=c[S];S=h*s[T++];let B=c[S++],z=c[S++],G=c[S];v(a)&&([E,O,R]=a.applyToVertex(E,O,R,x),[L,P,U]=a.applyToVertex(L,P,U,x),[B,z,G]=a.applyToVertex(B,z,G,x));const K=L-E,ee=P-O,Q=U-R,H=B-E,$=z-O,N=G-R,F=_*N-$*b,j=b*H-N*y,X=y*$-H*_,J=K*F+ee*j+Q*X;if(Math.abs(J)<=Number.EPSILON)continue;const W=p-E,ue=f-O,pe=m-R,we=W*F+ue*j+pe*X;if(J>0){if(we<0||we>J)continue}else if(we>0||we<J)continue;const Ce=ue*Q-ee*pe,Ge=pe*K-Q*W,Le=W*ee-K*ue,xe=y*Ce+_*Ge+b*Le;if(J>0){if(xe<0||we+xe>J)continue}else if(xe>0||we+xe<J)continue;const De=(H*Ce+$*Ge+N*Le)/J;De>=0&&l(De,uZ(K,ee,Q,H,$,N,Jwe),x,!1)}}function ytt(t,e,r,i,s,n,o,a,l){const{data:c,stride:h}=n,p=t[0],f=t[1],m=t[2],y=e[0]-p,_=e[1]-f,b=e[2]-m;for(let x=r;x<i;++x){const T=o[x];let S=3*T,E=h*s[S++],O=c[E++],R=c[E++],L=c[E];E=h*s[S++];let P=c[E++],U=c[E++],B=c[E];E=h*s[S];let z=c[E++],G=c[E++],K=c[E];v(a)&&([O,R,L]=a.applyToVertex(O,R,L,x),[P,U,B]=a.applyToVertex(P,U,B,x),[z,G,K]=a.applyToVertex(z,G,K,x));const ee=P-O,Q=U-R,H=B-L,$=z-O,N=G-R,F=K-L,j=_*F-N*b,X=b*$-F*y,J=y*N-$*_,W=ee*j+Q*X+H*J;if(Math.abs(W)<=Number.EPSILON)continue;const ue=p-O,pe=f-R,we=m-L,Ce=ue*j+pe*X+we*J;if(W>0){if(Ce<0||Ce>W)continue}else if(Ce>0||Ce<W)continue;const Ge=pe*H-Q*we,Le=we*ee-H*ue,xe=ue*Q-ee*pe,De=y*Ge+_*Le+b*xe;if(W>0){if(De<0||Ce+De>W)continue}else if(De>0||Ce+De<W)continue;const Ue=($*Ge+N*Le+F*xe)/W;Ue>=0&&l(Ue,uZ(ee,Q,H,$,N,F,Jwe),T,!1)}}const qse=M(),Wse=M();function uZ(t,e,r,i,s,n,o){return ce(qse,t,e,r),ce(Wse,i,s,n),pt(o,qse,Wse),_e(o,o),o}function Kwe(t,e,r){return ce(r,1/(e[0]-t[0]),1/(e[1]-t[1]),1/(e[2]-t[2]))}function hZ(t,e,r,i){return dZ(t,e,r,i,1/0)}function dZ(t,e,r,i,s){const n=(t[0]-i-e[0])*r[0],o=(t[3]+i-e[0])*r[0];let a=Math.min(n,o),l=Math.max(n,o);const c=(t[1]-i-e[1])*r[1],h=(t[4]+i-e[1])*r[1];if(l=Math.min(l,Math.max(c,h)),l<0||(a=Math.max(a,Math.min(c,h)),a>l))return!1;const p=(t[2]-i-e[2])*r[2],f=(t[5]+i-e[2])*r[2];return l=Math.min(l,Math.max(p,f)),!(l<0)&&(a=Math.max(a,Math.min(p,f)),!(a>l)&&a<s)}function Qwe(t,e,r,i,s){let n=(r.screenLength||0)*t.pixelRatio;v(s)&&(n=ltt(n,i,e,s));const o=n*Math.tan(.5*t.fovY)/(.5*t.fullHeight);return ge(o*e,r.minWorldLength||0,r.maxWorldLength!=null?r.maxWorldLength:1/0)}function exe(t,e){const r=e?exe(e):{};for(const i in t){let s=t[i];s&&s.forEach&&(s=vtt(s)),s==null&&i in r||(r[i]=s)}return r}function _tt(t,e){let r=!1;for(const i in e){const s=e[i];s!==void 0&&(Array.isArray(s)?t[i]===null?(t[i]=s.slice(),r=!0):UH(t[i],s)&&(r=!0):t[i]!==s&&(r=!0,t[i]=s))}return r}function vtt(t){const e=[];return t.forEach(r=>e.push(r)),e}const txe={multiply:1,ignore:2,replace:3,tint:4},btt=1e3;let wv=class extends RM{constructor(e,r){super(),this.type=$s.Material,this.supportsEdges=!1,this._visible=!0,this._renderPriority=0,this._insertOrder=0,this._vertexAttributeLocations=Rr,this._pp0=$e(0,0,1),this._pp1=$e(0,0,0),this._parameters=exe(e,r),this.validateParameters(this._parameters)}dispose(){}get parameters(){return this._parameters}update(e){return!1}setParameters(e,r=!0){_tt(this._parameters,e)&&(this.validateParameters(this._parameters),r&&this.parametersChanged())}validateParameters(e){}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this.parametersChanged())}shouldRender(e){return this.isVisible()&&this.isVisibleForOutput(e.output)&&(this.renderOccluded&e.renderOccludedMask)!=0}isVisibleForOutput(e){return!0}get renderOccluded(){return this.parameters.renderOccluded}get renderPriority(){return this._renderPriority}set renderPriority(e){e!==this._renderPriority&&(this._renderPriority=e,this.parametersChanged())}get insertOrder(){return this._insertOrder}set insertOrder(e){e!==this._insertOrder&&(this._insertOrder=e,this.parametersChanged())}get vertexAttributeLocations(){return this._vertexAttributeLocations}isVisible(){return this._visible}parametersChanged(){v(this.repository)&&this.repository.materialChanged(this)}intersectDraped(e,r,i,s,n,o){return this._pp0[0]=this._pp1[0]=s[0],this._pp0[1]=this._pp1[1]=s[1],this.intersect(e,r,i,this._pp0,this._pp1,n)}},rxe=class extends IYe{constructor(e,r,i){super(r,i),this.camera=e}};var ns;(function(t){t[t.Occlude=1]="Occlude",t[t.Transparent=2]="Transparent",t[t.OccludeAndTransparent=4]="OccludeAndTransparent",t[t.OccludeAndTransparentStencil=8]="OccludeAndTransparentStencil",t[t.Opaque=16]="Opaque"})(ns||(ns={}));let qE=class extends pi{constructor(){super(...arguments),this.renderOccluded=ns.Occlude}},ixe=class{constructor(){this.factor=new Xse,this.factorAlignment=new Xse}},Xse=class{constructor(){this.scale=0,this.factor=0,this.minPixelSize=0,this.paddingPixels=0}};function PRt(t,e,r,i,s=1){const n=r.typedBuffer,o=r.typedBufferStride,a=t.length;if(i*=o,s===1)for(let l=0;l<a;++l)n[i]=e[t[l]],i+=o;else for(let l=0;l<a;++l){const c=e[t[l]];for(let h=0;h<s;h++)n[i]=c,i+=o}}function wtt(t,e,r,i){const s=r.typedBuffer,n=r.typedBufferStride,o=t.length;i*=n;for(let a=0;a<o;++a){const l=2*t[a];s[i]=e[l],s[i+1]=e[l+1],i+=n}}function sxe(t,e,r,i,s){const n=r.typedBuffer,o=r.typedBufferStride,a=t.length;if(i*=o,s==null||s===1)for(let l=0;l<a;++l){const c=3*t[l];n[i]=e[c],n[i+1]=e[c+1],n[i+2]=e[c+2],i+=o}else for(let l=0;l<a;++l){const c=3*t[l];for(let h=0;h<s;++h)n[i]=e[c],n[i+1]=e[c+1],n[i+2]=e[c+2],i+=o}}function oE(t,e,r,i,s=1){const n=r.typedBuffer,o=r.typedBufferStride,a=t.length;if(i*=o,s===1)for(let l=0;l<a;++l){const c=4*t[l];n[i]=e[c],n[i+1]=e[c+1],n[i+2]=e[c+2],n[i+3]=e[c+3],i+=o}else for(let l=0;l<a;++l){const c=4*t[l];for(let h=0;h<s;++h)n[i]=e[c],n[i+1]=e[c+1],n[i+2]=e[c+2],n[i+3]=e[c+3],i+=o}}function Yse(t,e,r){const i=t.typedBuffer,s=t.typedBufferStride;e*=s;for(let n=0;n<r;++n)i[e]=0,i[e+1]=0,i[e+2]=0,i[e+3]=0,e+=s}function V5(t,e,r,i,s,n=1){if(!r)return void sxe(t,e,i,s,n);const o=i.typedBuffer,a=i.typedBufferStride,l=t.length,c=r[0],h=r[1],p=r[2],f=r[4],m=r[5],y=r[6],_=r[8],b=r[9],x=r[10],T=r[12],S=r[13],E=r[14];s*=a;let O=0,R=0,L=0;const P=D4(r)?U=>{O=e[U]+T,R=e[U+1]+S,L=e[U+2]+E}:U=>{const B=e[U],z=e[U+1],G=e[U+2];O=c*B+f*z+_*G+T,R=h*B+m*z+b*G+S,L=p*B+y*z+x*G+E};if(n===1)for(let U=0;U<l;++U)P(3*t[U]),o[s]=O,o[s+1]=R,o[s+2]=L,s+=a;else for(let U=0;U<l;++U){P(3*t[U]);for(let B=0;B<n;++B)o[s]=O,o[s+1]=R,o[s+2]=L,s+=a}}function pZ(t,e,r,i,s,n=1){if(!r)return void sxe(t,e,i,s,n);const o=r,a=i.typedBuffer,l=i.typedBufferStride,c=t.length,h=o[0],p=o[1],f=o[2],m=o[4],y=o[5],_=o[6],b=o[8],x=o[9],T=o[10],S=!gW(o),E=1e-6,O=1-E;s*=l;let R=0,L=0,P=0;const U=D4(o)?B=>{R=e[B],L=e[B+1],P=e[B+2]}:B=>{const z=e[B],G=e[B+1],K=e[B+2];R=h*z+m*G+b*K,L=p*z+y*G+x*K,P=f*z+_*G+T*K};if(n===1)if(S)for(let B=0;B<c;++B){U(3*t[B]);const z=R*R+L*L+P*P;if(z<O&&z>E){const G=1/Math.sqrt(z);a[s]=R*G,a[s+1]=L*G,a[s+2]=P*G}else a[s]=R,a[s+1]=L,a[s+2]=P;s+=l}else for(let B=0;B<c;++B)U(3*t[B]),a[s]=R,a[s+1]=L,a[s+2]=P,s+=l;else for(let B=0;B<c;++B){if(U(3*t[B]),S){const z=R*R+L*L+P*P;if(z<O&&z>E){const G=1/Math.sqrt(z);R*=G,L*=G,P*=G}}for(let z=0;z<n;++z)a[s]=R,a[s+1]=L,a[s+2]=P,s+=l}}function xtt(t,e,r,i,s,n=1){if(!r)return void oE(t,e,i,s,n);const o=r,a=i.typedBuffer,l=i.typedBufferStride,c=t.length,h=o[0],p=o[1],f=o[2],m=o[4],y=o[5],_=o[6],b=o[8],x=o[9],T=o[10],S=!gW(o),E=1e-6,O=1-E;if(s*=l,n===1)for(let R=0;R<c;++R){const L=4*t[R],P=e[L],U=e[L+1],B=e[L+2],z=e[L+3];let G=h*P+m*U+b*B,K=p*P+y*U+x*B,ee=f*P+_*U+T*B;if(S){const Q=G*G+K*K+ee*ee;if(Q<O&&Q>E){const H=1/Math.sqrt(Q);G*=H,K*=H,ee*=H}}a[s]=G,a[s+1]=K,a[s+2]=ee,a[s+3]=z,s+=l}else for(let R=0;R<c;++R){const L=4*t[R],P=e[L],U=e[L+1],B=e[L+2],z=e[L+3];let G=h*P+m*U+b*B,K=p*P+y*U+x*B,ee=f*P+_*U+T*B;if(S){const Q=G*G+K*K+ee*ee;if(Q<O&&Q>E){const H=1/Math.sqrt(Q);G*=H,K*=H,ee*=H}}for(let Q=0;Q<n;++Q)a[s]=G,a[s+1]=K,a[s+2]=ee,a[s+3]=z,s+=l}}function fZ(t,e,r,i,s,n=1){const o=i.typedBuffer,a=i.typedBufferStride,l=t.length;if(s*=a,r!==e.length||r!==4)if(n!==1)if(r!==4)for(let c=0;c<l;++c){const h=3*t[c];for(let p=0;p<n;++p)o[s]=e[h],o[s+1]=e[h+1],o[s+2]=e[h+2],o[s+3]=255,s+=a}else for(let c=0;c<l;++c){const h=4*t[c];for(let p=0;p<n;++p)o[s]=e[h],o[s+1]=e[h+1],o[s+2]=e[h+2],o[s+3]=e[h+3],s+=a}else{if(r===4){for(let c=0;c<l;++c){const h=4*t[c];o[s]=e[h],o[s+1]=e[h+1],o[s+2]=e[h+2],o[s+3]=e[h+3],s+=a}return}for(let c=0;c<l;++c){const h=3*t[c];o[s]=e[h],o[s+1]=e[h+1],o[s+2]=e[h+2],o[s+3]=255,s+=a}}else{o[s]=e[0],o[s+1]=e[1],o[s+2]=e[2],o[s+3]=e[3];const c=new Uint32Array(i.typedBuffer.buffer,i.start),h=a/4,p=c[s/=4];s+=h;const f=l*n;for(let m=1;m<f;++m)c[s]=p,s+=h}}function nxe(t,e,r,i,s=1){const n=e.typedBuffer,o=e.typedBufferStride;if(i*=o,s===1)for(let a=0;a<r;++a)n[i]=t[0],n[i+1]=t[1],n[i+2]=t[2],n[i+3]=t[3],i+=o;else for(let a=0;a<r;++a)for(let l=0;l<s;++l)n[i]=t[0],n[i+1]=t[1],n[i+2]=t[2],n[i+3]=t[3],i+=o}function oxe(t,e,r,i,s,n){for(const o of e.fieldNames){const a=t.vertexAttributes.get(o),l=t.indices.get(o);if(a&&l)switch(o){case A.POSITION:{ft(a.size===3);const c=s.getField(o,Oi);ft(!!c,`No buffer view for ${o}`),c&&V5(l,a.data,r,c,n);break}case A.NORMAL:{ft(a.size===3);const c=s.getField(o,Oi);ft(!!c,`No buffer view for ${o}`),c&&pZ(l,a.data,i,c,n);break}case A.UV0:{ft(a.size===2);const c=s.getField(o,vy);ft(!!c,`No buffer view for ${o}`),c&&wtt(l,a.data,c,n);break}case A.COLOR:case A.SYMBOLCOLOR:{ft(a.size===3||a.size===4);const c=s.getField(o,xa);ft(!!c,`No buffer view for ${o}`),c&&fZ(l,a.data,a.size,c,n);break}case A.TANGENT:{ft(a.size===4);const c=s.getField(o,Nc);ft(!!c,`No buffer view for ${o}`),c&&xtt(l,a.data,i,c,n);break}case A.PROFILERIGHT:case A.PROFILEUP:case A.PROFILEVERTEXANDNORMAL:case A.FEATUREVALUE:{ft(a.size===4);const c=s.getField(o,Nc);ft(!!c,`No buffer view for ${o}`),c&&oE(l,a.data,c,n)}}else if(o===A.OBJECTANDLAYERIDCOLOR&&v(t.objectAndLayerIdColor)){const c=t.indices.get(A.POSITION);if(ft(!!c,`No buffer view for ${o}`),c){const h=c.length,p=s.getField(o,xa);nxe(t.objectAndLayerIdColor,p,h,n)}}}}function xO(t,e,r=0){const i=ge(t,0,Ett);for(let s=0;s<4;s++)e[r+s]=Math.floor(256*Ctt(i*Ttt[s]))}function mZ(t,e=0){let r=0;for(let i=0;i<4;i++)r+=t[e+i]*Stt[i];return r}const Ttt=[1,256,65536,16777216],Stt=[1/256,1/65536,1/16777216,1/4294967296],Ett=mZ(new Uint8ClampedArray([255,255,255,255]));function Ctt(t){return t-Math.floor(t)}async function sy(t,e){const{data:r}=await Ni(t,{responseType:"image",...e});return r}let gZ=class extends pi{constructor(){super(...arguments),this.color=Ht(1,1,1,1)}};function Att(){const t=new Dr;return t.include(Jh),t.fragment.uniforms.add([new Mt("tex",e=>e.texture),new pr("uColor",e=>e.color)]),t.fragment.code.add(w`void main() {
vec4 texColor = texture2D(tex, uv);
gl_FragColor = texColor * uColor;
}`),t}const Rtt=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:gZ,build:Att},Symbol.toStringTag,{value:"Module"}));function Ott(){if(C(X8)){const t=e=>Wr(`esri/libs/basisu/${e}`);X8=te(()=>import("./basis_transcoder-e0466ff6.js"),["assets/basis_transcoder-e0466ff6.js","assets/_commonjsHelpers-2f3e7994.js"]).then(e=>e.b).then(({default:e})=>e({locateFile:t}).then(r=>(r.initializeBasis(),delete r.then,r)))}return X8}let X8;var Cb;(function(t){t[t.ETC1_RGB=0]="ETC1_RGB",t[t.ETC2_RGBA=1]="ETC2_RGBA",t[t.BC1_RGB=2]="BC1_RGB",t[t.BC3_RGBA=3]="BC3_RGBA",t[t.BC4_R=4]="BC4_R",t[t.BC5_RG=5]="BC5_RG",t[t.BC7_M6_RGB=6]="BC7_M6_RGB",t[t.BC7_M5_RGBA=7]="BC7_M5_RGBA",t[t.PVRTC1_4_RGB=8]="PVRTC1_4_RGB",t[t.PVRTC1_4_RGBA=9]="PVRTC1_4_RGBA",t[t.ASTC_4x4_RGBA=10]="ASTC_4x4_RGBA",t[t.ATC_RGB=11]="ATC_RGB",t[t.ATC_RGBA=12]="ATC_RGBA",t[t.FXT1_RGB=17]="FXT1_RGB",t[t.PVRTC2_4_RGB=18]="PVRTC2_4_RGB",t[t.PVRTC2_4_RGBA=19]="PVRTC2_4_RGBA",t[t.ETC2_EAC_R11=20]="ETC2_EAC_R11",t[t.ETC2_EAC_RG11=21]="ETC2_EAC_RG11",t[t.RGBA32=13]="RGBA32",t[t.RGB565=14]="RGB565",t[t.BGR565=15]="BGR565",t[t.RGBA4444=16]="RGBA4444"})(Cb||(Cb={}));let ap=null,RI=null;async function axe(){return C(RI)&&(RI=Ott(),ap=await RI),RI}function Mtt(t,e){if(C(ap))return t.byteLength;const r=new ap.BasisFile(new Uint8Array(t)),i=cxe(r)?lxe(r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),e):0;return r.close(),r.delete(),i}function Ptt(t,e){if(C(ap))return t.byteLength;const r=new ap.KTX2File(new Uint8Array(t)),i=uxe(r)?lxe(r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),e):0;return r.close(),r.delete(),i}function lxe(t,e,r,i,s){const n=Jve(e?Ms.COMPRESSED_RGBA8_ETC2_EAC:Ms.COMPRESSED_RGB8_ETC2),o=s&&t>1?(4**t-1)/(3*4**(t-1)):1;return Math.ceil(r*i*n*o)}function cxe(t){return t.getNumImages()>=1&&!t.isUASTC()}function uxe(t){return t.getFaces()>=1&&t.isETC1S()}async function Itt(t,e,r){C(ap)&&(ap=await axe());const i=new ap.BasisFile(new Uint8Array(r));if(!cxe(i))return null;i.startTranscoding();const s=hxe(t,e,i.getNumLevels(0),i.getHasAlpha(),i.getImageWidth(0,0),i.getImageHeight(0,0),(n,o)=>i.getImageTranscodedSizeInBytes(0,n,o),(n,o,a)=>i.transcodeImage(a,0,n,o,0,0));return i.close(),i.delete(),s}async function $tt(t,e,r){C(ap)&&(ap=await axe());const i=new ap.KTX2File(new Uint8Array(r));if(!uxe(i))return null;i.startTranscoding();const s=hxe(t,e,i.getLevels(),i.getHasAlpha(),i.getWidth(),i.getHeight(),(n,o)=>i.getImageTranscodedSizeInBytes(n,0,0,o),(n,o,a)=>i.transcodeImage(a,n,0,0,o,0,-1,-1));return i.close(),i.delete(),s}function hxe(t,e,r,i,s,n,o,a){const{compressedTextureETC:l,compressedTextureS3TC:c}=t.capabilities,[h,p]=l?i?[Cb.ETC2_RGBA,Ms.COMPRESSED_RGBA8_ETC2_EAC]:[Cb.ETC1_RGB,Ms.COMPRESSED_RGB8_ETC2]:c?i?[Cb.BC3_RGBA,Ms.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[Cb.BC1_RGB,Ms.COMPRESSED_RGB_S3TC_DXT1_EXT]:[Cb.RGBA32,Ve.RGBA],f=e.hasMipmap?r:Math.min(1,r),m=[];for(let x=0;x<f;x++)m.push(new Uint8Array(o(x,h))),a(x,h,m[x]);const y=m.length>1,_=y?tt.LINEAR_MIPMAP_LINEAR:tt.LINEAR,b={...e,samplingMode:_,hasMipmap:y,internalFormat:p,width:s,height:n};return new ct(t,b,{type:"compressed",levels:m})}const PC=se.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),Ltt=542327876,Dtt=131072,Ntt=4;function yZ(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}function Ftt(t){return String.fromCharCode(255&t,t>>8&255,t>>16&255,t>>24&255)}const Utt=yZ("DXT1"),ktt=yZ("DXT3"),Vtt=yZ("DXT5"),Btt=31,ztt=0,Gtt=1,jtt=2,Htt=3,qtt=4,Wtt=7,Xtt=20,Ytt=21;function Ztt(t,e,r){const{textureData:i,internalFormat:s,width:n,height:o}=Dl(Jtt(r,e.hasMipmap??!1));return e.samplingMode=i.levels.length>1?tt.LINEAR_MIPMAP_LINEAR:tt.LINEAR,e.hasMipmap=i.levels.length>1,e.internalFormat=s,e.width=n,e.height=o,new ct(t,e,i)}function Jtt(t,e){const r=new Int32Array(t,0,Btt);if(r[ztt]!==Ltt)return PC.error("Invalid magic number in DDS header"),null;if(!(r[Xtt]&Ntt))return PC.error("Unsupported format, must contain a FourCC code"),null;const i=r[Ytt];let s,n;switch(i){case Utt:s=8,n=Ms.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case ktt:s=16,n=Ms.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Vtt:s=16,n=Ms.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return PC.error("Unsupported FourCC code:",Ftt(i)),null}let o=1,a=r[qtt],l=r[Htt];!(3&a)&&!(3&l)||(PC.warn("Rounding up compressed texture size to nearest multiple of 4."),a=a+3&-4,l=l+3&-4);const c=a,h=l;let p,f;r[jtt]&Dtt&&e!==!1&&(o=Math.max(1,r[Wtt])),o===1||dp(a)&&dp(l)||(PC.warn("Ignoring mipmaps of non power of two sized compressed texture."),o=1);let m=r[Gtt]+4;const y=[];for(let _=0;_<o;++_)f=(a+3>>2)*(l+3>>2)*s,p=new Uint8Array(t,m,f),y.push(p),m+=f,a=Math.max(1,a>>1),l=Math.max(1,l>>1);return{textureData:{type:"compressed",levels:y},internalFormat:n,width:c,height:h}}let ix=class pD extends RM{constructor(e,r){super(),this._data=e,this.type=$s.Texture,this._glTexture=null,this._powerOfTwoStretchInfo=null,this._loadingPromise=null,this._loadingController=null,this.events=new vs,this._passParameters=new gZ,this.params=r||{},this.params.mipmap=this.params.mipmap!==!1,this.params.noUnpackFlip=this.params.noUnpackFlip||!1,this.params.preMultiplyAlpha=this.params.preMultiplyAlpha||!1,this.params.wrap=this.params.wrap||{s:Rt.REPEAT,t:Rt.REPEAT},this.params.powerOfTwoResizeMode=this.params.powerOfTwoResizeMode||U_.STRETCH,this.estimatedTexMemRequired=pD._estimateTexMemRequired(this._data,this.params),this._startPreload()}_startPreload(){const e=this._data;C(e)||(e instanceof HTMLVideoElement?this._startPreloadVideoElement(e):e instanceof HTMLImageElement&&this._startPreloadImageElement(e))}_startPreloadVideoElement(e){if(!(xS(e.src)||e.preload==="auto"&&e.crossOrigin)){e.preload="auto",e.crossOrigin="anonymous";const r=!e.paused;if(e.src=e.src,r&&e.autoplay){const i=()=>{e.removeEventListener("canplay",i),e.play()};e.addEventListener("canplay",i)}}}_startPreloadImageElement(e){pm(e.src)||xS(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}static _getDataDimensions(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}static _estimateTexMemRequired(e,r){if(C(e))return 0;if(JE(e)||pb(e))return r.encoding===Og.KTX2_ENCODING?Ptt(e,!!r.mipmap):r.encoding===Og.BASIS_ENCODING?Mtt(e,!!r.mipmap):e.byteLength;const{width:i,height:s}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?pD._getDataDimensions(e):r;return(r.mipmap?4/3:1)*i*s*(r.components||4)||0}dispose(){this._data=void 0}get width(){return this.params.width}get height(){return this.params.height}_createDescriptor(e){return{target:bt.TEXTURE_2D,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?tt.LINEAR_MIPMAP_LINEAR:tt.LINEAR,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:this.params.maxAnisotropy??(this.params.mipmap?e.parameters.maxMaxAnisotropy:1)}}get glTexture(){return this._glTexture}load(e,r){if(v(this._glTexture))return this._glTexture;if(v(this._loadingPromise))return this._loadingPromise;const i=this._data;return C(i)?(this._glTexture=new ct(e,this._createDescriptor(e),null),this._glTexture):typeof i=="string"?this._loadFromURL(e,r,i):i instanceof Image?this._loadFromImageElement(e,r,i):i instanceof HTMLVideoElement?this._loadFromVideoElement(e,r,i):i instanceof ImageData||i instanceof HTMLCanvasElement?this._loadFromImage(e,i,r):(JE(i)||pb(i))&&this.params.encoding===Og.DDS_ENCODING?(this._data=void 0,this._loadFromDDSData(e,i)):(JE(i)||pb(i))&&this.params.encoding===Og.KTX2_ENCODING?(this._data=void 0,this._loadFromKTX2(e,i)):(JE(i)||pb(i))&&this.params.encoding===Og.BASIS_ENCODING?(this._data=void 0,this._loadFromBasis(e,i)):pb(i)?this._loadFromPixelData(e,i):JE(i)?this._loadFromPixelData(e,new Uint8Array(i)):null}get requiresFrameUpdates(){return this._data instanceof HTMLVideoElement}frameUpdate(e,r,i){if(!(this._data instanceof HTMLVideoElement)||C(this._glTexture)||this._data.readyState<gR.HAVE_CURRENT_DATA||i===this._data.currentTime)return i;if(v(this._powerOfTwoStretchInfo)){const{framebuffer:s,vao:n,sourceTexture:o}=this._powerOfTwoStretchInfo;o.setData(this._data),this._drawStretchedTexture(e,r,s,n,o,this._glTexture)}else{const{videoWidth:s,videoHeight:n}=this._data,{width:o,height:a}=this._glTexture.descriptor;s!==o||n!==a?this._glTexture.updateData(0,0,0,Math.min(s,o),Math.min(n,a),this._data):this._glTexture.setData(this._data)}return this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this.params.updateCallback&&this.params.updateCallback(),this._data.currentTime}_loadFromDDSData(e,r){return this._glTexture=Ztt(e,this._createDescriptor(e),r),this._glTexture}_loadFromKTX2(e,r){return this._loadAsync(()=>$tt(e,this._createDescriptor(e),r).then(i=>(this._glTexture=i,i)))}_loadFromBasis(e,r){return this._loadAsync(()=>Itt(e,this._createDescriptor(e),r).then(i=>(this._glTexture=i,i)))}_loadFromPixelData(e,r){ft(this.params.width>0&&this.params.height>0);const i=this._createDescriptor(e);return i.pixelFormat=this.params.components===1?Ve.LUMINANCE:this.params.components===3?Ve.RGB:Ve.RGBA,i.width=this.params.width,i.height=this.params.height,this._glTexture=new ct(e,i,r),this._glTexture}_loadFromURL(e,r,i){return this._loadAsync(async s=>{const n=await sy(i,{signal:s});return fr(s),this._loadFromImage(e,n,r)})}_loadFromImageElement(e,r,i){return i.complete?this._loadFromImage(e,i,r):this._loadAsync(async s=>{const n=await Rhe(i,i.src,!1,s);return fr(s),this._loadFromImage(e,n,r)})}_loadFromVideoElement(e,r,i){return i.readyState>=gR.HAVE_CURRENT_DATA?this._loadFromImage(e,i,r):this._loadFromVideoElementAsync(e,r,i)}_loadFromVideoElementAsync(e,r,i){return this._loadAsync(s=>new Promise((n,o)=>{const a=()=>{i.removeEventListener("loadeddata",l),i.removeEventListener("error",c),ji(h)},l=()=>{i.readyState>=gR.HAVE_CURRENT_DATA&&(a(),n(this._loadFromImage(e,i,r)))},c=p=>{a(),o(p||new q("Failed to load video"))};i.addEventListener("loadeddata",l),i.addEventListener("error",c);const h=fa(s,()=>c(Hr()))}))}_loadFromImage(e,r,i){const s=pD._getDataDimensions(r);this.params.width=s.width,this.params.height=s.height;const n=this._createDescriptor(e);return n.pixelFormat=this.params.components===3?Ve.RGB:Ve.RGBA,!this._requiresPowerOfTwo(e,n)||dp(s.width)&&dp(s.height)?(n.width=s.width,n.height=s.height,this._glTexture=new ct(e,n,r),this._glTexture):(this._glTexture=this._makePowerOfTwoTexture(e,r,s,n,i),this._glTexture)}_loadAsync(e){const r=new AbortController;this._loadingController=r;const i=e(r.signal);this._loadingPromise=i;const s=()=>{this._loadingController===r&&(this._loadingController=null),this._loadingPromise===i&&(this._loadingPromise=null)};return i.then(s,s),i}_requiresPowerOfTwo(e,r){const i=Rt.CLAMP_TO_EDGE,s=typeof r.wrapMode=="number"?r.wrapMode===i:r.wrapMode.s===i&&r.wrapMode.t===i;return e.type===vt.WEBGL1&&(r.hasMipmap||!s)}_makePowerOfTwoTexture(e,r,i,s,n){const{width:o,height:a}=i,l=ES(o),c=ES(a);let h;switch(s.width=l,s.height=c,this.params.powerOfTwoResizeMode){case U_.PAD:s.textureCoordinateScaleFactor=[o/l,a/c],h=new ct(e,s),h.updateData(0,0,0,o,a,r);break;case U_.STRETCH:case null:case void 0:h=this._stretchToPowerOfTwo(e,r,s,n());break;default:this.params.powerOfTwoResizeMode}return s.hasMipmap&&h.generateMipmap(),h}_stretchToPowerOfTwo(e,r,i,s){const n=new ct(e,i),o=new Ds(e,{colorTarget:ls.TEXTURE,depthStencilTarget:$r.NONE},n),a=new ct(e,{target:bt.TEXTURE_2D,pixelFormat:i.pixelFormat,dataType:Lt.UNSIGNED_BYTE,wrapMode:Rt.CLAMP_TO_EDGE,samplingMode:tt.LINEAR,flipped:!!i.flipped,maxAnisotropy:8,preMultiplyAlpha:i.preMultiplyAlpha},r),l=Aa(e),c=e.getBoundFramebufferObject();return this._drawStretchedTexture(e,s,o,l,a,n),this.requiresFrameUpdates?this._powerOfTwoStretchInfo={vao:l,sourceTexture:a,framebuffer:o}:(l.dispose(!0),a.dispose(),o.detachColorTexture(),o.dispose()),e.bindFramebuffer(c),n}_drawStretchedTexture(e,r,i,s,n,o){this._passParameters.texture=n,e.bindFramebuffer(i);const a=e.getViewport();e.setViewport(0,0,o.descriptor.width,o.descriptor.height),e.bindTechnique(r,this._passParameters,null),e.bindVAO(s),e.drawArrays($t.TRIANGLE_STRIP,0,Wo(s,"geometry")),e.bindFramebuffer(null),e.setViewport(a.x,a.y,a.width,a.height),this._passParameters.texture=null}unload(){if(v(this._powerOfTwoStretchInfo)){const{framebuffer:e,vao:r,sourceTexture:i}=this._powerOfTwoStretchInfo;r.dispose(!0),i.dispose(),e.dispose(),this._glTexture=null,this._powerOfTwoStretchInfo=null}if(v(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null),v(this._loadingController)){const e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}};var gR;(function(t){t[t.HAVE_NOTHING=0]="HAVE_NOTHING",t[t.HAVE_METADATA=1]="HAVE_METADATA",t[t.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",t[t.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",t[t.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"})(gR||(gR={}));const TO=128,_Z=.5;function dxe(t,e=TO,r=e*_Z,i=0){const s=Ktt(t,e,r,i);return new ix(s,{mipmap:!1,wrap:{s:Rt.CLAMP_TO_EDGE,t:Rt.CLAMP_TO_EDGE},width:e,height:e,components:4,noUnpackFlip:!0})}function Ktt(t,e=TO,r=e*_Z,i=0){switch(t){case"circle":default:return Qtt(e,r);case"square":return ert(e,r);case"cross":return rrt(e,r,i);case"x":return irt(e,r,i);case"kite":return trt(e,r);case"triangle":return srt(e,r);case"arrow":return nrt(e,r)}}function Qtt(t,e){const r=t/2-.5;return $M(t,mxe(r,r,e/2))}function ert(t,e){return pxe(t,e,!1)}function trt(t,e){return pxe(t,e,!0)}function rrt(t,e,r=0){return fxe(t,e,!1,r)}function irt(t,e,r=0){return fxe(t,e,!0,r)}function srt(t,e){return $M(t,gxe(t/2,e,e/2))}function nrt(t,e){const r=e,i=e/2,s=t/2,n=.8*r,o=mxe(s,(t-e)/2-n,Math.sqrt(n*n+i*i)),a=gxe(s,r,i);return $M(t,(l,c)=>Math.max(a(l,c),-o(l,c)))}function pxe(t,e,r){return r&&(e/=Math.SQRT2),$M(t,(i,s)=>{let n=i-.5*t+.25,o=.5*t-s-.75;if(r){const a=(n+o)/Math.SQRT2;o=(o-n)/Math.SQRT2,n=a}return Math.max(Math.abs(n),Math.abs(o))-.5*e})}function fxe(t,e,r,i=0){e-=i,r&&(e*=Math.SQRT2);const s=.5*e;return $M(t,(n,o)=>{let a,l=n-.5*t,c=.5*t-o-1;if(r){const h=(l+c)/Math.SQRT2;c=(c-l)/Math.SQRT2,l=h}return l=Math.abs(l),c=Math.abs(c),a=l>c?l>s?Math.sqrt((l-s)*(l-s)+c*c):c:c>s?Math.sqrt(l*l+(c-s)*(c-s)):l,a-=i/2,a})}function mxe(t,e,r){return(i,s)=>{const n=i-t,o=s-e;return Math.sqrt(n*n+o*o)-r}}function gxe(t,e,r){const i=Math.sqrt(e*e+r*r);return(s,n)=>{const o=Math.abs(s-t)-r,a=n-t+e/2+.75,l=(e*o+r*a)/i,c=-a;return Math.max(l,c)}}function $M(t,e){const r=new Uint8Array(4*t*t);for(let i=0;i<t;i++)for(let s=0;s<t;s++){const n=s+t*i;let o=e(s,i);o=o/t+.5,xO(o,r,4*n)}return r}let $Rt=class extends pi{constructor(e){super(),this.slicePlaneLocalOrigin=e}};function ort(t,e){yxe(t,e,[new qt("slicePlaneOrigin",(r,i)=>wxe(e,r,i)),new qt("slicePlaneBasis1",(r,i)=>{var s;return SF(e,r,i,(s=i.slicePlane)==null?void 0:s.basis1)}),new qt("slicePlaneBasis2",(r,i)=>{var s;return SF(e,r,i,(s=i.slicePlane)==null?void 0:s.basis2)})])}function Xs(t,e){yxe(t,e,[new Pu("slicePlaneOrigin",(r,i)=>wxe(e,r,i)),new Pu("slicePlaneBasis1",(r,i)=>{var s;return SF(e,r,i,(s=i.slicePlane)==null?void 0:s.basis1)}),new Pu("slicePlaneBasis2",(r,i)=>{var s;return SF(e,r,i,(s=i.slicePlane)==null?void 0:s.basis2)})])}function yxe(t,e,r){if(!e.hasSlicePlane){const o=w`#define rejectBySlice(_pos_) false
#define discardBySlice(_pos_) {}
#define highlightSlice(_color_, _pos_) (_color_)`;return e.hasSliceInVertexProgram&&t.vertex.code.add(o),void t.fragment.code.add(o)}t.extensions.add("GL_OES_standard_derivatives"),e.hasSliceInVertexProgram&&t.vertex.uniforms.add(r),t.fragment.uniforms.add(r);const i=w`struct SliceFactors {
float front;
float side0;
float side1;
float side2;
float side3;
};
SliceFactors calculateSliceFactors(vec3 pos) {
vec3 rel = pos - slicePlaneOrigin;
vec3 slicePlaneNormal = -cross(slicePlaneBasis1, slicePlaneBasis2);
float slicePlaneW = -dot(slicePlaneNormal, slicePlaneOrigin);
float basis1Len2 = dot(slicePlaneBasis1, slicePlaneBasis1);
float basis2Len2 = dot(slicePlaneBasis2, slicePlaneBasis2);
float basis1Dot = dot(slicePlaneBasis1, rel);
float basis2Dot = dot(slicePlaneBasis2, rel);
return SliceFactors(
dot(slicePlaneNormal, pos) + slicePlaneW,
-basis1Dot - basis1Len2,
basis1Dot - basis1Len2,
-basis2Dot - basis2Len2,
basis2Dot - basis2Len2
);
}
bool sliceByFactors(SliceFactors factors) {
return factors.front < 0.0
&& factors.side0 < 0.0
&& factors.side1 < 0.0
&& factors.side2 < 0.0
&& factors.side3 < 0.0;
}
bool sliceEnabled() {
return dot(slicePlaneBasis1, slicePlaneBasis1) != 0.0;
}
bool sliceByPlane(vec3 pos) {
return sliceEnabled() && sliceByFactors(calculateSliceFactors(pos));
}
#define rejectBySlice(_pos_) sliceByPlane(_pos_)
#define discardBySlice(_pos_) { if (sliceByPlane(_pos_)) discard; }`,s=w`vec4 applySliceHighlight(vec4 color, vec3 pos) {
SliceFactors factors = calculateSliceFactors(pos);
const float HIGHLIGHT_WIDTH = 1.0;
const vec4 HIGHLIGHT_COLOR = vec4(0.0, 0.0, 0.0, 0.3);
factors.front /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.front);
factors.side0 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side0);
factors.side1 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side1);
factors.side2 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side2);
factors.side3 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side3);
if (sliceByFactors(factors)) {
return color;
}
float highlightFactor = (1.0 - step(0.5, factors.front))
* (1.0 - step(0.5, factors.side0))
* (1.0 - step(0.5, factors.side1))
* (1.0 - step(0.5, factors.side2))
* (1.0 - step(0.5, factors.side3));
return mix(color, vec4(HIGHLIGHT_COLOR.rgb, color.a), highlightFactor * HIGHLIGHT_COLOR.a);
}`,n=e.hasSliceHighlight?w`
        ${s}
        #define highlightSlice(_color_, _pos_) (sliceEnabled() ? applySliceHighlight(_color_, _pos_) : (_color_))
      `:w`#define highlightSlice(_color_, _pos_) (_color_)`;e.hasSliceInVertexProgram&&t.vertex.code.add(i),t.fragment.code.add(i),t.fragment.code.add(n)}function _xe(t,e,r){return t.instancedDoublePrecision?ce(art,r.camera.viewInverseTransposeMatrix[3],r.camera.viewInverseTransposeMatrix[7],r.camera.viewInverseTransposeMatrix[11]):e.slicePlaneLocalOrigin}function vxe(t,e){return v(t)?me(EF,e.origin,t):e.origin}function bxe(t,e,r){return t.hasSliceTranslatedView?v(e)?ql(lrt,r.camera.viewMatrix,e):r.camera.viewMatrix:null}function wxe(t,e,r){if(C(r.slicePlane))return ma;const i=_xe(t,e,r),s=vxe(i,r.slicePlane),n=bxe(t,i,r);return v(n)?We(EF,s,n):s}function SF(t,e,r,i){if(C(i)||C(r.slicePlane))return ma;const s=_xe(t,e,r),n=vxe(s,r.slicePlane),o=bxe(t,s,r);return v(o)?(fe(IC,i,n),We(EF,n,o),We(IC,IC,o),me(IC,IC,EF)):i}const art=M(),EF=M(),IC=M(),lrt=Ie();function B5(t,e){const r=e.output===k.ObjectAndLayerIdColor,i=e.objectAndLayerIdColorInstanced;r&&(t.varyings.add("objectAndLayerIdColorVarying","vec4"),i?t.attributes.add(A.OBJECTANDLAYERIDCOLOR_INSTANCED,"vec4"):t.attributes.add(A.OBJECTANDLAYERIDCOLOR,"vec4")),t.vertex.code.add(w`
     void forwardObjectAndLayerIdColor() {
      ${r?i?w`objectAndLayerIdColorVarying = objectAndLayerIdColor_instanced * 0.003921568627451;`:w`objectAndLayerIdColorVarying = objectAndLayerIdColor * 0.003921568627451;`:w``} }`),t.fragment.code.add(w`
      void outputObjectAndLayerIdColor() {
        ${r?w`gl_FragColor = objectAndLayerIdColorVarying;`:w``} }`)}function crt(t,e){const{vertex:r,fragment:i}=t;e.hasMultipassGeometry&&r.include(b1e),e.hasMultipassTerrain&&t.varyings.add("depth","float"),r.code.add(w`
  void main(void) {
    vec4 posProjCenter;
    if (dot(position, position) > 0.0) {
      // Render single point to center of the pixel to avoid subpixel
      // filtering to affect the marker color
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      posProjCenter = alignToPixelCenter(posProj, viewport.zw);

      ${e.hasMultipassGeometry?w`
        // Don't draw vertices behind geometry
        if(geometryDepthTest(.5 + .5 * posProjCenter.xy / posProjCenter.w, projectAux.posView.z)){
          posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
        }`:""}

      ${e.hasMultipassTerrain?"depth = projectAux.posView.z;":""}
      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        // Project out of clip space
        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
      }

    } else {
      // Project out of clip space
      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
    }

    gl_Position = posProjCenter;
    gl_PointSize = 1.0;
  }
  `),e.hasMultipassTerrain&&i.include(Nu),e.hasMultipassTerrain&&i.uniforms.add([...op("terrainDepthTexture",(s,n)=>n.multipassTerrain.linearDepthTexture,e.hasWebGL2Context?Qr.None:Qr.InvSize),new kr("nearFar",(s,n)=>n.camera.nearFar)]),i.include(kc),i.code.add(w`
  void main() {
    gl_FragColor = vec4(1, 1, 1, 1);
    ${e.hasMultipassTerrain?w`
          vec2 uv = gl_FragCoord.xy;

          // Read the rgba data from the texture linear depth
          vec4 terrainDepthData = ${Ja(e,"terrainDepthTexture","uv")};

          float terrainDepth = linearDepthFromFloat(rgba2float(terrainDepthData), nearFar);

          // If HUD vertex is behind terrain and the terrain depth is not the initialize value (e.g. we are not looking at the sky)
          // Mark the HUD vertex as occluded by transparent terrain
          if(depth < terrainDepth && terrainDepthData != vec4(0,0,0,1)){
            gl_FragColor.g = 0.5;
          }`:""}
  }
  `)}const urt=Ht(1,1,0,1),xxe=Ht(1,0,1,1);function by(t,e){t.fragment.uniforms.add(op("depthTex",(r,i)=>i.highlightDepthTexture,e.hasWebGL2Context?Qr.None:Qr.InvSize)),t.fragment.constants.add("occludedHighlightFlag","vec4",urt).add("unoccludedHighlightFlag","vec4",xxe),t.fragment.code.add(w`
    void outputHighlight() {
      vec3 fragCoord = gl_FragCoord.xyz;

      float sceneDepth = ${Ja(e,"depthTex","fragCoord.xy")}.x;
      if (fragCoord.z > sceneDepth + 5e-7) {
        gl_FragColor = occludedHighlightFlag;
      }
      else {
        gl_FragColor = unoccludedHighlightFlag;
      }
    }
  `)}let z5=class extends ws{constructor(e,r,i){super(e,"vec4",di.Pass,(s,n,o)=>s.setUniform4fv(e,r(n,o)),i)}},ha=class extends ws{constructor(e,r,i){super(e,"float",di.Pass,(s,n,o)=>s.setUniform1fv(e,r(n,o)),i)}},vZ=class extends qE{constructor(){super(...arguments),this.vvSizeEnabled=!1,this.vvSizeMinSize=$e(1,1,1),this.vvSizeMaxSize=$e(100,100,100),this.vvSizeOffset=$e(0,0,0),this.vvSizeFactor=$e(1,1,1),this.vvSizeValue=$e(1,1,1),this.vvColorEnabled=!1,this.vvColorValues=[0,0,0,0,0,0,0,0],this.vvColorColors=[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],this.vvOpacityEnabled=!1,this.vvOpacityValues=[0,0,0,0,0,0,0,0],this.vvOpacityOpacities=[1,1,1,1,1,1,1,1],this.vvSymbolAnchor=[0,0,0],this.vvSymbolRotationMatrix=es()}};const lp=8;function uS(t,e){e.hasVvInstancing&&(e.vvSize||e.vvColor)&&t.attributes.add(A.INSTANCEFEATUREATTRIBUTE,"vec4");const r=t.vertex;e.vvSize?(r.uniforms.add(new qt("vvSizeMinSize",i=>i.vvSizeMinSize)),r.uniforms.add(new qt("vvSizeMaxSize",i=>i.vvSizeMaxSize)),r.uniforms.add(new qt("vvSizeOffset",i=>i.vvSizeOffset)),r.uniforms.add(new qt("vvSizeFactor",i=>i.vvSizeFactor)),r.uniforms.add(new wm("vvSymbolRotationMatrix",i=>i.vvSymbolRotationMatrix)),r.uniforms.add(new qt("vvSymbolAnchor",i=>i.vvSymbolAnchor)),r.code.add(w`vec3 vvScale(vec4 _featureAttribute) {
return clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize);
}
vec4 vvTransformPosition(vec3 position, vec4 _featureAttribute) {
return vec4(vvSymbolRotationMatrix * ( vvScale(_featureAttribute) * (position + vvSymbolAnchor)), 1.0);
}`),r.code.add(w`
      const float eps = 1.192092896e-07;
      vec4 vvTransformNormal(vec3 _normal, vec4 _featureAttribute) {
        vec3 vvScale = clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize + eps, vvSizeMaxSize);
        return vec4(vvSymbolRotationMatrix * _normal / vvScale, 1.0);
      }

      ${e.hasVvInstancing?w`
      vec4 vvLocalNormal(vec3 _normal) {
        return vvTransformNormal(_normal, instanceFeatureAttribute);
      }

      vec4 localPosition() {
        return vvTransformPosition(position, instanceFeatureAttribute);
      }`:""}
    `)):r.code.add(w`vec4 localPosition() { return vec4(position, 1.0); }
vec4 vvLocalNormal(vec3 _normal) { return vec4(_normal, 1.0); }`),e.vvColor?(r.constants.add("vvColorNumber","int",lp),e.hasVvInstancing&&r.uniforms.add([new ha("vvColorValues",i=>i.vvColorValues,lp),new z5("vvColorColors",i=>i.vvColorColors,lp)]),r.code.add(w`
      vec4 vvGetColor(vec4 featureAttribute, float values[vvColorNumber], vec4 colors[vvColorNumber]) {
        float value = featureAttribute.y;
        if (value <= values[0]) {
          return colors[0];
        }

        for (int i = 1; i < vvColorNumber; ++i) {
          if (values[i] >= value) {
            float f = (value - values[i-1]) / (values[i] - values[i-1]);
            return mix(colors[i-1], colors[i], f);
          }
        }
        return colors[vvColorNumber - 1];
      }

      ${e.hasVvInstancing?w`
      vec4 vvColor() {
        return vvGetColor(instanceFeatureAttribute, vvColorValues, vvColorColors);
      }`:""}
    `)):r.code.add(w`vec4 vvColor() { return vec4(1.0); }`)}const CF=.1,Yo=.001;function hrt(t){const e=new Dr,r=t.signedDistanceFieldEnabled;if(e.include(IY),e.include(Xwe,t),e.include(Xs,t),t.occlusionPass)return e.include(crt,t),e;const{vertex:i,fragment:s}=e;e.include(cZ),s.include(kc),s.include(bm),e.include(uS,t),e.include(B5,t),e.varyings.add("vcolor","vec4"),e.varyings.add("vtc","vec2"),e.varyings.add("vsize","vec2"),t.binaryHighlightOcclusionEnabled&&e.varyings.add("voccluded","float"),i.uniforms.add([new pr("viewport",(c,h)=>h.camera.fullViewport),new kr("screenOffset",(c,h)=>or(Txe,2*c.screenOffset[0]*h.camera.pixelRatio,2*c.screenOffset[1]*h.camera.pixelRatio)),new kr("anchorPosition",c=>AF(c)),new pr("materialColor",c=>c.color),new Pe("pixelRatio",(c,h)=>h.camera.pixelRatio)]),r&&(i.uniforms.add(new pr("outlineColor",c=>c.outlineColor)),s.uniforms.add([new pr("outlineColor",c=>Zse(c)?c.outlineColor:qf),new Pe("outlineSize",c=>Zse(c)?c.outlineSize:0)])),t.hasScreenSizePerspective&&(ptt(i),k5(i)),(t.debugDrawLabelBorder||t.binaryHighlightOcclusionEnabled)&&e.varyings.add("debugBorderCoords","vec4"),e.attributes.add(A.UV0,"vec2"),e.attributes.add(A.COLOR,"vec4"),e.attributes.add(A.SIZE,"vec2"),e.attributes.add(A.AUXPOS2,"vec4"),i.code.add(w`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      forwardObjectAndLayerIdColor();

      if (rejectBySlice(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }
      vec2 inputSize;
      ${t.hasScreenSizePerspective?w`
      inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);
      vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
         `:w`
      inputSize = size;
      vec2 screenOffsetScaled = screenOffset;`}

      ${t.vvSize?"inputSize *= vvScale(auxpos2).xx;":""}

      vec2 combinedSize = inputSize * pixelRatio;
      vec4 quadOffset = vec4(0.0);

      ${t.occlusionTestEnabled||t.binaryHighlightOcclusionEnabled?"bool visible = testVisibilityHUD(posProj);":""}

      ${t.binaryHighlightOcclusionEnabled?"voccluded = visible ? 0.0 : 1.0;":""}
    `);const n=w`vec2 uv01 = floor(uv0);
vec2 uv = uv0 - uv01;
quadOffset.xy = ((uv01 - anchorPosition) * 2.0 * combinedSize + screenOffsetScaled) / viewport.zw * posProj.w;`,o=t.pixelSnappingEnabled?r?w`posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;`:w`posProj += quadOffset;
if (inputSize.x == size.x) {
posProj = alignToPixelOrigin(posProj, viewport.zw);
}`:w`posProj += quadOffset;`;t.vvColor&&i.uniforms.add([new z5("vvColorColors",c=>c.vvColorColors,lp),new ha("vvColorValues",c=>c.vvColorValues,lp)]),i.uniforms.add(new kr("textureCoordinateScaleFactor",c=>v(c.texture)&&v(c.texture.descriptor.textureCoordinateScaleFactor)?c.texture.descriptor.textureCoordinateScaleFactor:Hfe)),i.code.add(w`
    ${t.occlusionTestEnabled?"if (visible) {":""}
    ${n}
    ${t.vvColor?"vcolor = vvGetColor(auxpos2, vvColorValues, vvColorColors) * materialColor;":"vcolor = color / 255.0 * materialColor;"}

    ${t.output===k.ObjectAndLayerIdColor?w`vcolor.a = 1.0;`:""}

    bool alphaDiscard = vcolor.a < ${w.float(Yo)};
    ${r?`alphaDiscard = alphaDiscard && outlineColor.a < ${w.float(Yo)};`:""}
    if (alphaDiscard) {
      // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    } else {
      ${o}
      gl_Position = posProj;
    }

    vtc = uv * textureCoordinateScaleFactor;

    ${t.debugDrawLabelBorder?"debugBorderCoords = vec4(uv01, 1.5 / combinedSize);":""}
    vsize = inputSize;
    ${t.occlusionTestEnabled?w`} else { vtc = vec2(0.0);
      ${t.debugDrawLabelBorder?"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);}":"}"}`:""}
  }
  `),s.uniforms.add(new Mt("tex",c=>c.texture));const a=t.debugDrawLabelBorder?w`(isBorder > 0.0 ? 0.0 : ${w.float(CF)})`:w.float(CF),l=w`
    ${t.debugDrawLabelBorder?w`
      float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));`:""}

    ${r?w`
      vec4 fillPixelColor = vcolor;

      // Attempt to sample texel centers to avoid that thin cross outlines
      // disappear with large symbol sizes.
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/7058#issuecomment-603041
      const float txSize = ${w.float(TO)};
      const float texelSize = 1.0 / txSize;
      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel
      vec2 scaleFactor = (vsize - txSize) * texelSize;
      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;

      // Get distance and map it into [-0.5, 0.5]
      float d = rgba2float(texture2D(tex, samplePos)) - 0.5;

      // Distance in output units (i.e. pixels)
      float dist = d * vsize.x;

      // Create smooth transition from the icon into its outline
      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);
      fillPixelColor.a *= fillAlphaFactor;

      if (outlineSize > 0.25) {
        vec4 outlinePixelColor = outlineColor;
        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);

        // Create smooth transition around outline
        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);
        outlinePixelColor.a *= outlineAlphaFactor;

        if (
          outlineAlphaFactor + fillAlphaFactor < ${a} ||
          fillPixelColor.a + outlinePixelColor.a < ${w.float(Yo)}
        ) {
          discard;
        }

        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)
        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);
        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +
          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);

        gl_FragColor = vec4(compositeColor, compositeAlpha);
      } else {
        if (fillAlphaFactor < ${a}) {
          discard;
        }

        gl_FragColor = premultiplyAlpha(fillPixelColor);
      }

      // visualize SDF:
      // gl_FragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);
      `:w`
          vec4 texColor = texture2D(tex, vtc, -0.5);
          if (texColor.a < ${a}) {
            discard;
          }
          gl_FragColor = texColor * premultiplyAlpha(vcolor);
          `}

    // Draw debug border with transparency, so that original texels along border are still partially visible
    ${t.debugDrawLabelBorder?w`gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder * 0.5);`:""}
  `;return t.output===k.Alpha&&s.code.add(w`
      void main() {
        ${l}
        gl_FragColor = vec4(gl_FragColor.a);
      }
      `),t.output===k.ObjectAndLayerIdColor&&s.code.add(w`
      void main() {
        ${l}
        outputObjectAndLayerIdColor();
      }
      `),t.output===k.Color&&s.code.add(w`
    void main() {
      ${l}
      ${t.transparencyPassType===xt.FrontFace?"gl_FragColor.rgb /= gl_FragColor.a;":""}
    }
    `),t.output===k.Highlight&&(e.include(by,t),s.code.add(w`
    void main() {
      ${l}
      ${t.binaryHighlightOcclusionEnabled?w`
          if (voccluded == 1.0) {
            gl_FragColor = vec4(1.0, 1.0, 0.0, 1.0);
          } else {
            gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);
          }`:"outputHighlight();"}
    }
    `)),e}function Zse(t){return t.outlineColor[3]>0&&t.outlineSize>0}function AF(t,e=Txe){return t.textureIsSignedDistanceField?drt(t.anchorPosition,t.distanceFieldBoundingBox,e):Un(e,t.anchorPosition),e}function drt(t,e,r){v(e)?or(r,t[0]*(e[2]-e[0])+e[0],t[1]*(e[3]-e[1])+e[1]):or(r,0,0)}const Txe=Je(),prt=Object.freeze(Object.defineProperty({__proto__:null,build:hrt,calculateAnchorPosForRendering:AF},Symbol.toStringTag,{value:"Module"})),Iu=kn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),frt=Tp(Ee.ONE,Ee.ONE),Sxe=Tp(Ee.ZERO,Ee.ONE_MINUS_SRC_ALPHA);function wy(t){return t===xt.FrontFace?null:t===xt.Alpha?Sxe:frt}function G5(t){return t===xt.FrontFace?Xl:null}const j5=5e5,H5={factor:-1,units:-2};function q5(t){return t?H5:null}function xv(t,e=Mi.LESS){return t===xt.NONE||t===xt.FrontFace?e:Mi.LEQUAL}let Exe=class Cxe extends Vr{initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===vt.WEBGL2,r.spherical=e.viewingMode===Be.Global}initializeProgram(e){return new Fr(e.rctx,Cxe.shader.get().build(this.configuration),Rr)}_setPipelineState(e){const r=this.configuration,i=e===xt.NONE,s=e===xt.FrontFace,n=this.configuration.hasPolygonOffset?mrt:null,o=(i||s)&&r.output!==k.Highlight&&(r.depthEnabled||r.occlusionPass)?Xl:null;return Bt({blending:r.output===k.Color||r.output===k.Alpha||r.output===k.Highlight?i?grt:wy(e):null,depthTest:{func:Mi.LEQUAL},depthWrite:o,colorWrite:Kt,polygonOffset:n})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}get primitiveType(){return this.configuration.occlusionPass?$t.POINTS:$t.TRIANGLES}};Exe.shader=new Nr(prt,()=>te(()=>import("./HUDMaterial.glsl-dce61f9b.js"),[]));const mrt={factor:0,units:-4},grt=Tp(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA);let ks=class extends eo{constructor(){super(...arguments),this.output=k.Color,this.screenCenterOffsetUnitsEnabled=kl.World,this.transparencyPassType=xt.NONE,this.spherical=!1,this.occlusionTestEnabled=!0,this.signedDistanceFieldEnabled=!1,this.vvSize=!1,this.vvColor=!1,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.debugDrawLabelBorder=!1,this.binaryHighlightOcclusionEnabled=!0,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.depthEnabled=!0,this.pixelSnappingEnabled=!0,this.isDraped=!1,this.hasMultipassGeometry=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.occlusionPass=!1,this.objectAndLayerIdColorInstanced=!1}};u([V({count:k.COUNT})],ks.prototype,"output",void 0),u([V({count:kl.COUNT})],ks.prototype,"screenCenterOffsetUnitsEnabled",void 0),u([V({count:xt.COUNT})],ks.prototype,"transparencyPassType",void 0),u([V()],ks.prototype,"spherical",void 0),u([V()],ks.prototype,"occlusionTestEnabled",void 0),u([V()],ks.prototype,"signedDistanceFieldEnabled",void 0),u([V()],ks.prototype,"vvSize",void 0),u([V()],ks.prototype,"vvColor",void 0),u([V()],ks.prototype,"hasVerticalOffset",void 0),u([V()],ks.prototype,"hasScreenSizePerspective",void 0),u([V()],ks.prototype,"debugDrawLabelBorder",void 0),u([V()],ks.prototype,"binaryHighlightOcclusionEnabled",void 0),u([V()],ks.prototype,"hasSlicePlane",void 0),u([V()],ks.prototype,"hasPolygonOffset",void 0),u([V()],ks.prototype,"depthEnabled",void 0),u([V()],ks.prototype,"pixelSnappingEnabled",void 0),u([V()],ks.prototype,"isDraped",void 0),u([V()],ks.prototype,"hasMultipassGeometry",void 0),u([V()],ks.prototype,"hasMultipassTerrain",void 0),u([V()],ks.prototype,"cullAboveGround",void 0),u([V()],ks.prototype,"occlusionPass",void 0),u([V()],ks.prototype,"objectAndLayerIdColorInstanced",void 0),u([V({constValue:!0})],ks.prototype,"hasSliceInVertexProgram",void 0),u([V({constValue:!1})],ks.prototype,"hasVvInstancing",void 0);let aE=class extends wv{constructor(e){super(e,new Crt),this._configuration=new ks}getConfiguration(e,r){return this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVerticalOffset=!!this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen"?kl.Screen:kl.World,this._configuration.hasPolygonOffset=this.parameters.polygonOffset,this._configuration.isDraped=this.parameters.isDraped,this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this._configuration.signedDistanceFieldEnabled=this.parameters.textureIsSignedDistanceField,this._configuration.vvSize=!!this.parameters.vvSizeEnabled,this._configuration.vvColor=!!this.parameters.vvColorEnabled,this._configuration.occlusionPass=r.slot===Se.OCCLUSION_PIXELS&&this.parameters.occlusionTest&&(e===k.Color||e===k.Alpha),e===k.Color&&(this._configuration.debugDrawLabelBorder=!!qr.LABELS_SHOW_BORDER),e===k.Highlight&&(this._configuration.binaryHighlightOcclusionEnabled=this.parameters.binaryHighlightOcclusion),this._configuration.depthEnabled=this.parameters.depthEnabled,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.hasMultipassGeometry=r.multipassGeometry.enabled,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration}intersect(e,r,i,s,n,o){if(!i.options.selectionMode||!i.options.hud||!e.visible)return;const a=this.parameters;let l=1,c=1;if(Hh(Z8,r),v(e.shaderTransformer)){const T=e.shaderTransformer(Qse);l=T[0],c=T[5],vrt(Z8)}const h=e.vertexAttributes.get(A.POSITION),p=e.vertexAttributes.get(A.SIZE),f=e.vertexAttributes.get(A.NORMAL),m=e.vertexAttributes.get(A.AUXPOS1);ft(h.size>=3);const y=i.point,_=i.camera,b=AF(a);l*=_.pixelRatio,c*=_.pixelRatio;const x=this.parameters.centerOffsetUnits==="screen";for(let T=0;T<h.data.length/h.size;T++){const S=T*h.size;ce(ra,h.data[S],h.data[S+1],h.data[S+2]),We(ra,ra,r);const E=T*p.size;qy[0]=p.data[E]*l,qy[1]=p.data[E+1]*c,We(ra,ra,_.viewMatrix);const O=T*m.size;if(ce(Hc,m.data[O+0],m.data[O+1],m.data[O+2]),!x&&(ra[0]+=Hc[0],ra[1]+=Hc[1],Hc[2]!==0)){const L=Hc[2];_e(Hc,ra),me(ra,ra,ae(Hc,Hc,L))}const R=T*f.size;if(ce($C,f.data[R],f.data[R+1],f.data[R+2]),this._normalAndViewAngle($C,Z8,_,J8),this._applyVerticalOffsetTransformationView(ra,J8,_,Y8),_.applyProjection(ra,$a),$a[0]>-1){$a[0]=Math.floor($a[0]),$a[1]=Math.floor($a[1]),x&&(Hc[0]||Hc[1])&&($a[0]+=Hc[0],Hc[1]!==0&&($a[1]+=lZ(Hc[1],Y8.factorAlignment)),_.unapplyProjection($a,ra)),$a[0]+=this.parameters.screenOffset[0],$a[1]+=this.parameters.screenOffset[1],kwe(qy,Y8.factor,qy);const L=Trt*_.pixelRatio;let P=0;if(a.textureIsSignedDistanceField&&(P=a.outlineSize*_.pixelRatio/2),y&&Jse(y,$a[0],$a[1],qy,L,P,a,b)){const U=i.ray;if(We(Kse,ra,Oo(xrt,_.viewMatrix)),$a[0]=y[0],$a[1]=y[1],_.unprojectFromRenderScreen($a,ra)){const B=M();le(B,U.direction);const z=1/Me(B);ae(B,B,z),o(xi(U.origin,ra)*z,B,-1,!0,1,Kse)}}}}}intersectDraped(e,r,i,s,n,o){const a=e.vertexAttributes.get(A.POSITION),l=e.vertexAttributes.get(A.SIZE),c=this.parameters,h=AF(c);let p=1,f=1;if(v(e.shaderTransformer)){const y=e.shaderTransformer(Qse);p=y[0],f=y[5]}p*=e.screenToWorldRatio,f*=e.screenToWorldRatio;const m=Srt*e.screenToWorldRatio;for(let y=0;y<a.data.length/a.size;y++){const _=y*a.size,b=a.data[_],x=a.data[_+1],T=y*l.size;qy[0]=l.data[T]*p,qy[1]=l.data[T+1]*f;let S=0;c.textureIsSignedDistanceField&&(S=c.outlineSize*e.screenToWorldRatio/2),Jse(s,b,x,qy,m,S,c,h)&&n(o.dist,o.normal,-1,!1)}}createBufferWriter(){return new Rrt(this)}_normalAndViewAngle(e,r,i,s){return dtt(r)&&(r=Hh(wrt,r)),Ac(s.normal,e,r),We(s.normal,s.normal,i.viewInverseTransposeMatrix),s.cosAngle=ye(Axe,Ert),s}_updateScaleInfo(e,r,i){const s=this.parameters;v(s.screenSizePerspective)?Gse(i,r,s.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minPixelSize=0,e.factor.paddingPixels=0),v(s.screenSizePerspectiveAlignment)?Gse(i,r,s.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minPixelSize=e.factor.minPixelSize,e.factorAlignment.paddingPixels=e.factor.paddingPixels)}applyShaderOffsetsView(e,r,i,s,n,o,a){const l=this._normalAndViewAngle(r,i,n,J8);return this._applyVerticalGroundOffsetView(e,l,n,a),this._applyVerticalOffsetTransformationView(a,l,n,o),this._applyPolygonOffsetView(a,l,s[3],n,a),this._applyCenterOffsetView(a,s,a),a}applyShaderOffsetsNDC(e,r,i,s,n){return this._applyCenterOffsetNDC(e,r,i,s),v(n)&&le(n,s),this._applyPolygonOffsetNDC(s,r,i,s),s}_applyPolygonOffsetView(e,r,i,s,n){const o=s.aboveGround?1:-1;let a=Math.sign(i);a===0&&(a=o);const l=o*a;if(this.parameters.shaderPolygonOffset<=0)return le(n,e);const c=ge(Math.abs(r.cosAngle),.01,1),h=1-Math.sqrt(1-c*c)/c/s.viewport[2];return ae(n,e,l>0?h:1/h),n}_applyVerticalGroundOffsetView(e,r,i,s){const n=Me(e),o=i.aboveGround?1:-1,a=.5*i.computeRenderPixelSizeAtDist(n),l=ae(ra,r.normal,o*a);return fe(s,e,l),s}_applyVerticalOffsetTransformationView(e,r,i,s){const n=this.parameters;if(!n.verticalOffset||!n.verticalOffset.screenLength){if(n.screenSizePerspective||n.screenSizePerspectiveAlignment){const c=Me(e);this._updateScaleInfo(s,c,r.cosAngle)}else s.factor.scale=1,s.factorAlignment.scale=1;return e}const o=Me(e),a=It(n.screenSizePerspectiveAlignment,n.screenSizePerspective),l=Qwe(i,o,n.verticalOffset,r.cosAngle,a);return this._updateScaleInfo(s,o,r.cosAngle),ae(r.normal,r.normal,l),fe(e,e,r.normal)}_applyCenterOffsetView(e,r,i){const s=this.parameters.centerOffsetUnits!=="screen";return i!==e&&le(i,e),s&&(i[0]+=r[0],i[1]+=r[1],r[2]&&(_e($C,i),fe(i,i,ae($C,$C,r[2])))),i}_applyCenterOffsetNDC(e,r,i,s){const n=this.parameters.centerOffsetUnits!=="screen";return s!==e&&le(s,e),n||(s[0]+=r[0]/i.fullWidth*2,s[1]+=r[1]/i.fullHeight*2),s}_applyPolygonOffsetNDC(e,r,i,s){const n=this.parameters.shaderPolygonOffset;if(e!==s&&le(s,e),n){const o=i.aboveGround?1:-1,a=o*Math.sign(r[3]);s[2]-=(a||o)*n}return s}requiresSlot(e,r){if(r===k.Color||r===k.Alpha||r===k.Highlight||r===k.ObjectAndLayerIdColor){if(e===Se.DRAPED_MATERIAL)return!0;const{drawInSecondSlot:i,occlusionTest:s}=this.parameters;return e===(i?Se.LABEL_MATERIAL:Se.HUD_MATERIAL)||s&&e===Se.OCCLUSION_PIXELS}return!1}createGLMaterial(e){return new yrt(e)}calculateRelativeScreenBounds(e,r,i=ur()){return _rt(this.parameters,e,r,i),i[2]=i[0]+e[0],i[3]=i[1]+e[1],i}},yrt=class extends aY{constructor(e){super({...e,...e.material.parameters})}selectProgram(e){return this.ensureTechnique(Exe,e)}beginSlot(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.selectProgram(e)}};function _rt(t,e,r,i=brt){return Un(i,t.anchorPosition),i[0]*=-e[0],i[1]*=-e[1],i[0]+=t.screenOffset[0]*r,i[1]+=t.screenOffset[1]*r,i}function vrt(t){const e=t[0],r=t[1],i=t[2],s=t[3],n=t[4],o=t[5],a=t[6],l=t[7],c=t[8],h=1/Math.sqrt(e*e+r*r+i*i),p=1/Math.sqrt(s*s+n*n+o*o),f=1/Math.sqrt(a*a+l*l+c*c);return t[0]=e*h,t[1]=r*h,t[2]=i*h,t[3]=s*p,t[4]=n*p,t[5]=o*p,t[6]=a*f,t[7]=l*f,t[8]=c*f,t}function Jse(t,e,r,i,s,n,o,a){let l=e-s-(a[0]>0?i[0]*a[0]:0),c=l+i[0]+2*s,h=r-s-(a[1]>0?i[1]*a[1]:0),p=h+i[1]+2*s;const f=o.distanceFieldBoundingBox;return o.textureIsSignedDistanceField&&v(f)&&(l+=i[0]*f[0],h+=i[1]*f[1],c-=i[0]*(1-f[2]),p-=i[1]*(1-f[3]),l-=n,c+=n,h-=n,p+=n),t[0]>l&&t[0]<c&&t[1]>h&&t[1]<p}const Y8=new ixe,brt=Je(),ra=M(),$C=M(),$a=sr(),Axe=M(),Kse=M(),Z8=es(),wrt=es(),xrt=Ie(),Hc=M(),J8={normal:Axe,cosAngle:0},Qse=Ie(),Trt=1,Srt=2,qy=[0,0],Ert=$e(0,0,1);let Crt=class extends l1e{constructor(){super(...arguments),this.renderOccluded=ns.Occlude,this.color=Ht(1,1,1,1),this.texCoordScale=[1,1],this.polygonOffset=!1,this.anchorPosition=Ur(.5,.5),this.screenOffset=[0,0],this.shaderPolygonOffset=1e-5,this.textureIsSignedDistanceField=!1,this.outlineColor=Ht(1,1,1,1),this.outlineSize=0,this.vvSizeEnabled=!1,this.vvSizeMinSize=[1,1,1],this.vvSizeMaxSize=[100,100,100],this.vvSizeOffset=[0,0,0],this.vvSizeFactor=[1,1,1],this.vvColorEnabled=!1,this.vvColorValues=[0,0,0,0,0,0,0,0],this.vvColorColors=[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],this.hasSlicePlane=!1,this.pixelSnappingEnabled=!0,this.occlusionTest=!0,this.binaryHighlightOcclusion=!0,this.centerOffsetUnits="world",this.drawInSecondSlot=!1,this.depthEnabled=!0,this.isDraped=!1}};const Rxe=ts().vec3f(A.POSITION).vec3f(A.NORMAL).vec2f(A.UV0).vec4u8(A.COLOR).vec2f(A.SIZE).vec4f(A.AUXPOS1).vec4f(A.AUXPOS2),Art=Rxe.clone().vec4u8(A.OBJECTANDLAYERIDCOLOR);let Rrt=class{constructor(e){this._material=e,this.vertexBufferLayout=de("enable-feature:objectAndLayerId-rendering")?Art:Rxe}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 6*e.indices.get(A.POSITION).length}write(e,r,i,s,n){V5(i.indices.get(A.POSITION),i.vertexAttributes.get(A.POSITION).data,e,s.position,n,6),pZ(i.indices.get(A.NORMAL),i.vertexAttributes.get(A.NORMAL).data,r,s.normal,n,6);const o=i.vertexAttributes.get(A.UV0).data;let a,l,c,h;if(o==null||o.length<4){const x=this._material.parameters;a=0,l=0,c=x.texCoordScale[0],h=x.texCoordScale[1]}else a=o[0],l=o[1],c=o[2],h=o[3];c=Math.min(1.99999,c+1),h=Math.min(1.99999,h+1);let p=i.indices.get(A.POSITION).length,f=n;const m=s.uv0;for(let x=0;x<p;++x)m.set(f,0,a),m.set(f,1,l),f+=1,m.set(f,0,c),m.set(f,1,l),f+=1,m.set(f,0,c),m.set(f,1,h),f+=1,m.set(f,0,c),m.set(f,1,h),f+=1,m.set(f,0,a),m.set(f,1,h),f+=1,m.set(f,0,a),m.set(f,1,l),f+=1;fZ(i.indices.get(A.COLOR),i.vertexAttributes.get(A.COLOR).data,4,s.color,n,6);const y=i.indices.get(A.SIZE),_=i.vertexAttributes.get(A.SIZE).data;p=y.length;const b=s.size;f=n;for(let x=0;x<p;++x){const T=_[2*y[x]],S=_[2*y[x]+1];for(let E=0;E<6;++E)b.set(f,0,T),b.set(f,1,S),f+=1}if(i.indices.get(A.AUXPOS1)&&i.vertexAttributes.get(A.AUXPOS1)?oE(i.indices.get(A.AUXPOS1),i.vertexAttributes.get(A.AUXPOS1).data,s.auxpos1,n,6):Yse(s.auxpos1,n,6*p),i.indices.get(A.AUXPOS2)&&i.vertexAttributes.get(A.AUXPOS2)?oE(i.indices.get(A.AUXPOS2),i.vertexAttributes.get(A.AUXPOS2).data,s.auxpos2,n,6):Yse(s.auxpos2,n,6*p),v(i.objectAndLayerIdColor)&&i.indices.get(A.POSITION)){const x=i.indices.get(A.POSITION).length,T=s.getField(A.OBJECTANDLAYERIDCOLOR,xa);nxe(i.objectAndLayerIdColor,T,x,n,6)}}};const $p=M(),Mx=sr(),LC=sr(),K8=M(),Ort=Ie(),Mrt=on(),Q8=ro(),Prt=M(),Irt=ur();class $rt{constructor(){this.aabr=ur(),this.distance=0,this.culled=!1,this.visible=!1}}class Lrt{constructor(e,r){this.graphics3DGraphic=e,this.slicePlaneEnabled=r,this.info={}}}var fc;(function(t){t[t.Idle=0]="Idle",t[t.Process=1]="Process",t[t.Sort=2]="Sort",t[t.Deconflict=3]="Deconflict",t[t.NumStates=4]="NumStates"})(fc||(fc={}));class Oxe{constructor(){this.camera=new Ct,this.slicePlane=uy(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),Jw(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}let I2=class extends Te{get dirty(){return this._dirty}get state(){return this._state}constructor(t){super(t),this._dirty=!1,this._runningViewState=new Oxe,this._state=fc.Idle,this._active=new Map,this._visible=new Map,this._iterators=new Urt,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null,this.accNumTests=0}destroy(){this._active.clear(),this._visible.clear(),this._iterators=null}setDirty(){!this._dirty&&this._active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._state!==fc.Idle||this._dirty}get updatingProgress(){if(!this.updating)return 1;const t=this._state/fc.NumStates;return this._dirty?.5*t:t}get running(){return this.view.ready&&this.view.state!=null&&this.updating}runTask(t){switch(this._state){case fc.Idle:this._startUpdate(),t.madeProgress();case fc.Process:if(this._state=fc.Process,!this._processActiveGraphics(t))return;case fc.Sort:if(this._state=fc.Sort,!this._sortVisibleGraphics(t))return;case fc.Deconflict:if(this._state=fc.Deconflict,!this._deconflictVisibleGraphics(t))return;default:ttt(this,this._visible),this._state=fc.Idle,this.notifyChange("updating")}}modifyGraphics(t,e){e?t.forEach(r=>this.addToActiveGraphics(r)):t.forEach(r=>this.removeFromActiveGraphics(r)),this.setDirty()}layerSupportsDeconfliction(t){if(C(t)||t.type!=="object3d")return!1;const e=t.stageObject;if((e?e.geometries.length:0)!==1)return!1;const r=e==null?void 0:e.geometries[0];return(r==null?void 0:r.material)instanceof aE}_startUpdate(){rtt(this.view),this._dirty=!1,this._runningViewState.copyFrom(this.viewState);const{fullWidth:t,fullHeight:e}=this._runningViewState.camera;this._initBins(t,e),this._resetIterators()}addToActiveGraphics(t){t.info[this.visibilityGroup]=new $rt,this._active.set(t.graphics3DGraphic.graphic.uid,t),this.setDirty()}removeFromActiveGraphics(t){this._visible.delete(t.graphics3DGraphic.graphic.uid),Drt(t,this.visibilityGroup),delete t.info[this.visibilityGroup],this._active.delete(t.graphics3DGraphic.graphic.uid),this.setDirty()}_processActiveGraphics(t){const e=this._ensureActiveGraphicsIterator(),r=CE(Ort,this._runningViewState.camera.projectionMatrix),i=this.view.viewingMode==="global"&&this.view.map.ground.opacity===1&&this._runningViewState.camera.relativeElevation>0?Mrt:null;let s=0;for(v(i)&&(We(i,ma,this._runningViewState.camera.viewMatrix),i[3]=Jr(this.view.spatialReference).radius,s=ame(i,ma));!t.done;){t.madeProgress();const n=e.next();if(n.done===!0)return this._resetActiveGraphicsIterator(),!0;const o=n.value,a=o&&o.info[this.visibilityGroup];a&&(this._collectGraphics3DGraphics(o,r,i,s),a.culled?this._visible.delete(o.graphics3DGraphic.graphic.uid):this._visible.set(o.graphics3DGraphic.graphic.uid,o))}return!1}_sortVisibleGraphics(t){const e=this._ensureSortGraphicsIterator();for(;!t.done;){const r=e.next();if(t.madeProgress(),r.done===!0)return this._resetSortGraphicsIterator(),!0}return!1}_deconflictVisibleGraphics(t){const e=this._ensureVisibleGraphicsIterator(),r=this.visibilityGroup===So.LABEL;for(;!t.done;){t.madeProgress();const i=e.next();if(i.done===!0)return this._resetVisibleGraphicsIterator(),!0;const s=i.value,n=s.info[this.visibilityGroup];if(!n||n.culled)continue;const o=s.graphics3DGraphic,a=(!r||o.isVisible())&&!this._isConflicted(s);a&&this._addToBins(s),n.visible=a,this._setGraphicVisibility(s,a),stt(n,a)}return!1}_resetIterators(){this._iterators.active=null,this._iterators.visible=null,this._iterators.sort=null}_ensureActiveGraphicsIterator(){return this._iterators.active||(this._iterators.active=ene(this._active)),this._iterators.active}_resetActiveGraphicsIterator(){this._iterators.active=null}_ensureVisibleGraphicsIterator(){return this._iterators.visible||(this._iterators.visible=ene(this._visible)),this._iterators.visible}_resetVisibleGraphicsIterator(){this._iterators.visible=null}_ensureSortGraphicsIterator(){return this._iterators.sort||(this._iterators.sort=Nrt(this._visible,this._iterators.sortArray,this.visibilityGroup)),this._iterators.sort}_resetSortGraphicsIterator(){this._iterators.sort=null}_collectGraphics3DGraphics(t,e,r,i){const s=t.graphics3DGraphic;if(s.destroyed)return;const n=t.info[this.visibilityGroup];if(!s.isVisible(So.GRAPHIC,Ec.DECONFLICTION))return void(n.culled=!0);const o=this.getGraphicsLayers(s);zh(n.aabr);let a=null;for(const l of o){if(!this.layerSupportsDeconfliction(l))continue;const c=l.stageObject.geometries[0].material;if(C(a)){if(a=Brt,this._getProjectionInfo(l,e,a),a.isOutsideScreen||this._isCulledBySlice(t,$p)||v(r)&&this._isCulledByHorizon(a,r,i))return void(n.culled=!0);!qr.TESTS_DISABLE_OPTIMIZATIONS&&n.visible&&(a.distance*=.7)}this._expandBoundingRect(n,l,c,a)}C(a)?n.culled=!0:(n.distance=a.distance,n.culled=!1)}_getProjectionInfo(t,e,r){const i=this._runningViewState.camera,s=t.stageObject,n=s.geometries[0],o=n.material,a=s.boundingVolumeWorldSpace.bounds;We($p,a,i.viewMatrix);const l=n.vertexAttributes,c=l.get(A.NORMAL).data,h=l.get(A.AUXPOS1).data;o.applyShaderOffsetsView($p,c,s.transformation,h,i,r.scaleInfo,$p),ti(Mx,$p[0],$p[1],$p[2],1),Su(LC,Mx,i.projectionMatrix),ae(r.positionNDC,LC,1/LC[3]),o.applyShaderOffsetsNDC(r.positionNDC,h,i,r.positionNDC,K8),r.distanceWithoutPolygonOffset=i.depthNDCToWorld(K8[2]),r.distance=K8[2]===r.positionNDC[2]?r.distanceWithoutPolygonOffset:i.depthNDCToWorld(r.positionNDC[2]),ti(LC,r.positionNDC[0],r.positionNDC[1],r.positionNDC[2],1),Su(Mx,LC,e),_E(Mx,Mx,1/Mx[3]),ce(r.positionView,$p[0],$p[1],$p[2])}_isCulledByHorizon(t,e,r){return le(Q8.direction,t.positionView),ce(Q8.origin,0,0,0),!!_v(e,Q8,Prt)&&t.distanceWithoutPolygonOffset>r}_isCulledBySlice(t,e){return t.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&DW(this._runningViewState.slicePlane,e)}_expandBoundingRect(t,e,r,{positionNDC:i,scaleInfo:s}){const n=this._runningViewState.camera,o=e.getScreenSize(krt);kwe(o,s.factor,o),o[0]*=n.pixelRatio,o[1]*=n.pixelRatio;const a=pN(r.calculateRelativeScreenBounds(o,s.factorAlignment.scale,Irt),Ft(0,n.fullWidth,.5+.5*i[0]),Ft(0,n.fullHeight,.5+.5*i[1])),l=this.iconMarginFactor;if(l!==0){const c=l*Math.min(xu(a),fp(a));a[0]-=c,a[1]-=c,a[2]+=c,a[3]+=c}L_(t.aabr,a,t.aabr)}_isConflicted(t){const e=t.graphics3DGraphic.graphic.uid,r=t.info[this.visibilityGroup];for(let i=Math.floor(r.aabr[0]/this._accBinsSizeX);i<=Math.floor(r.aabr[2]/this._accBinsSizeX);i++)if(!(i<0||i>=this._accBinsNumX))for(let s=Math.floor(r.aabr[1]/this._accBinsSizeY);s<=Math.floor(r.aabr[3]/this._accBinsSizeY);s++){if(s<0||s>=this._accBinsNumY)continue;const n=this._accBins[i][s];for(let o=0;o<n.length;o++){const a=n.data[o],l=a.info[this.visibilityGroup];if(l&&l.visible&&a.graphics3DGraphic.graphic.uid!==e&&(this.accNumTests++,x4(l.aabr,r.aabr)))return!0}}return!1}_initBins(t,e){if(this._accBins==null){this._accBins=[];for(let r=0;r<this._accBinsNumX;r++){this._accBins.push([]);const i=this._accBins[this._accBins.length-1];for(let s=0;s<this._accBinsNumY;s++)i.push(new Jt)}}else for(let r=0;r<this._accBinsNumX;r++)for(let i=0;i<this._accBinsNumY;i++)this._accBins[r][i].clear();this._accBinsSizeX=t/this._accBinsNumX,this._accBinsSizeY=e/this._accBinsNumY,this.accNumTests=0}_addToBins(t){const e=t.info[this.visibilityGroup],r=Math.floor(e.aabr[0]/this._accBinsSizeX),i=Math.floor(e.aabr[2]/this._accBinsSizeX),s=Math.floor(e.aabr[1]/this._accBinsSizeY),n=Math.floor(e.aabr[3]/this._accBinsSizeY);for(let o=r;o<=i;o++)if(!(o<0||o>=this._accBinsNumX))for(let a=s;a<=n;a++)a<0||a>=this._accBinsNumY||this._accBins[o][a].push(t)}_setGraphicVisibility(t,e){const r=t.graphics3DGraphic;r.destroyed||(r.setVisibilityFlag(Ec.DECONFLICTION,e,this.visibilityGroup),this.visibilityGroup===So.LABEL&&this.view.labeler.setLabelGraphicVisibility(r,e))}};function Drt(t,e){const r=t.graphics3DGraphic;r.destroyed||r.clearVisibilityFlag(Ec.DECONFLICTION,e)}function*ene(t){if(Map.prototype.entries){const e=t.entries();for(let r=e.next();!r.done;r=e.next())yield r.value[1]}else yield*t.values()}function*Nrt(t,e,r){e.clear(),t.forEach((s,n)=>{const o=e.pushNew();o.id=n,o.visible=s.graphics3DGraphic.hasVisibilityFlag(Ec.DECONFLICTION,r),o.prio=s.info?s.info[r].distance:Number.MAX_VALUE}),yield;const i=e.iterableSort((s,n)=>s.visible!==n.visible?s.visible?-1:1:s.prio!==n.prio?s.prio-n.prio:s.id-n.id);for(let s=i.next();!s.done;s=i.next())yield;e.forAll(s=>{const n=t.get(s.id);n&&(t.delete(s.id),t.set(s.id,n))}),e.clear()}u([d({constructOnly:!0})],I2.prototype,"view",void 0),u([d({type:Boolean,readOnly:!0})],I2.prototype,"updating",null),I2=u([I("esri.views.3d.layers.graphics.Deconflictor")],I2);class Frt{}class Urt{constructor(e=null,r=null,i=null){this.active=e,this.visible=r,this.sort=i,this.sortArray=new Jt({allocator:s=>s||new Frt})}}const krt=Je();class Vrt{constructor(){this.positionView=M(),this.positionNDC=M(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new ixe}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1}}const Brt=new Vrt,zrt=2e3;let fD=class extends I2{constructor(e){super(e),this.visibilityGroup=So.LABEL,this.iconMarginFactor=0,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.running)return Zo.YIELD;const r=performance.now();if(e.state!==Sr.IDLE&&r-this._lastDeconfliction<zrt)return Zo.YIELD;super.runTask(e),this.state===fc.Idle&&(this._lastDeconfliction=r)}enabledChanged(e,r){this.modifyGraphics(r,e.labelsEnabled)}getGraphicsLayers(e){return e.labelLayers}};u([d({constructOnly:!0})],fD.prototype,"parent",void 0),fD=u([I("esri.views.3d.layers.graphics.LabelDeconflictor")],fD);let Nj=class extends I2{constructor(){super(...arguments),this._handles=new ei,this._contexts=new Map,this._viewState=new Oxe,this.visibilityGroup=So.GRAPHIC,this._iconMarginFactor=-.1}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._handles.add([ie(()=>{var e,r;return(r=(e=this.view)==null?void 0:e.state)==null?void 0:r.camera},()=>{this._updateViewState(),this.setDirty()}),ie(()=>{var e,r,i;return(i=(r=(e=this.view)==null?void 0:e.map)==null?void 0:r.ground)==null?void 0:i.opacity},(e,r)=>{e!==1&&r!==1||this.setDirty()}),ie(()=>{var e;return(e=this.view)==null?void 0:e.slicePlane},()=>{this._updateSlicePlane(),this._slicePlaneChanged()},Vt)]),this._frameTask=this.view.resourceController.scheduler.registerTask(_t.GRAPHICS_DECONFLICTOR,this),this._labels=new fD({view:this.view,parent:this})}destroy(){this._labels.destroy(),this._labels=null,this._handles.destroy(),this._handles=null,this._frameTask&&(this._frameTask.remove(),this._frameTask=null)}get iconMarginFactor(){return this._iconMarginFactor}set iconMarginFactor(e){this._iconMarginFactor=e,this.setDirty()}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){super.runTask(e),this.running||this._labels.setDirty()}setInitialIconVisibilityFlag(e,r){const i=!(this._graphicSupportsDeconfliction(r)&&e9(e));r.setVisibilityFlag(Ec.DECONFLICTION,i,So.GRAPHIC)}_updateViewState(){this.view&&this.view.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?this.view.slicePlane:null;v(e)&&xme(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=v(e)}_slicePlaneChanged(){Ho(this._contexts,(e,r)=>r.symbolCreationContext.slicePlaneEnabled)&&this.setDirty()}addGraphicsOwner(e){const r=this._getGraphicsContext(e);return{addGraphic:i=>this._addGraphic(e,r,i),removeGraphic:i=>this._removeGraphic(r,i),labelingInfoChange:()=>this._labels.enabledChanged(e,r),featureReductionChange:()=>this.enabledChanged(e,r),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,r),clear:()=>r.forEach(i=>this._removeGraphic(r,i.graphics3DGraphic))}}removeGraphicsOwner(e){const r=this._contexts.get(e);r&&(r.forEach(i=>this._removeGraphic(r,i.graphics3DGraphic)),this._contexts.delete(e),this.setDirty())}_addGraphic(e,r,i){const s=i.graphic.uid,n=new Lrt(i,e.symbolCreationContext.slicePlaneEnabled);r.set(s,n),e9(e)&&this.addToActiveGraphics(n),e.labelsEnabled&&this._labels.addToActiveGraphics(n)}_removeGraphic(e,r){const i=r.graphic.uid,s=e.get(i);s&&(this.removeFromActiveGraphics(s),this._labels.removeFromActiveGraphics(s),e.delete(i),this.setDirty())}enabledChanged(e,r){const i=e9(e);i||Grt(e),this.modifyGraphics(r,i)}_slicePlaneEnabledChanged(e,r){const i=e.symbolCreationContext.slicePlaneEnabled;r.forEach(s=>s.slicePlaneEnabled=i),this.setDirty()}getGraphicsLayers(e){return e.layers}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const r=e.layers;if(!r||!r.length)return!1;for(const i of r)if(this.layerSupportsDeconfliction(i))return!0;return!1}_getGraphicsContext(e){const r=this._contexts.get(e);if(r)return r;const i=new Map;return this._contexts.set(e,i),this.setDirty(),i}};function e9(t){const e=t.layer;return!(!e||!e.featureReduction||e.featureReduction.type!=="selection")}function Grt(t){const e=t.graphics3DGraphics;e&&e.forEach(r=>r.clearVisibilityFlag(Ec.DECONFLICTION))}Nj=u([I("esri.views.3d.layers.graphics.GraphicsDeconflictor")],Nj);const bZ=(t,e,r)=>[e,r],lE=(t,e,r)=>[e,r,t[2]],wZ=(t,e,r)=>[e,r,t[2],t[3]];function HRt(t){return t?{originPosition:t.originPosition==="upper-left"?"upperLeft":t.originPosition==="lower-left"?"lowerLeft":t.originPosition,scale:t.tolerance?[t.tolerance,t.tolerance]:[1,1],translate:v(t.extent)?[t.extent.xmin,t.extent.ymax]:[0,0]}:null}function jrt({scale:t,translate:e},r){return Math.round((r-e[0])/t[0])}function Hrt({scale:t,translate:e},r){return Math.round((e[1]-r)/t[1])}function Mxe({scale:t,translate:e},r){return r*t[0]+e[0]}function Pxe({scale:t,translate:e},r){return e[1]-r*t[1]}function Ixe(t,e,r){const i=new Array(r.length);if(!r.length)return i;const[s,n]=t.scale;let o=Mxe(t,r[0][0]),a=Pxe(t,r[0][1]);i[0]=e(r[0],o,a);for(let l=1;l<r.length;l++){const c=r[l];o+=c[0]*s,a-=c[1]*n,i[l]=e(c,o,a)}return i}function $xe(t,e,r){const i=new Array(r.length);for(let s=0;s<r.length;s++)i[s]=Ixe(t,e,r[s]);return i}function qrt(t,e,r,i){return Ixe(t,r?i?wZ:lE:i?lE:bZ,e)}function Wrt(t,e,r,i){return $xe(t,r?i?wZ:lE:i?lE:bZ,e)}function Xrt(t,e,r,i){return $xe(t,r?i?wZ:lE:i?lE:bZ,e)}function qRt(t,e,r,i,s){return e.x=jrt(t,r.x),e.y=Hrt(t,r.y),e!==r&&(i&&(e.z=r.z),s&&(e.m=r.m)),e}function Lxe(t,e,r,i,s){return v(r)&&(e.points=qrt(t,r.points,i,s)),e}function Dxe(t,e,r,i,s){return C(r)||(e.x=Mxe(t,r.x),e.y=Pxe(t,r.y),e!==r&&(i&&(e.z=r.z),s&&(e.m=r.m))),e}function Nxe(t,e,r,i,s){return v(r)&&(e.rings=Xrt(t,r.rings,i,s)),e}function Fxe(t,e,r,i,s){return v(r)&&(e.paths=Wrt(t,r.paths,i,s)),e}let WRt=class{constructor(e,r,i){this.uid=e,this.geometry=r,this.attributes=i,this.visible=!0,this.objectId=null,this.centroid=null}};function YRt(t){return v(t.geometry)}let ZRt=class{constructor(){this.exceededTransferLimit=!1,this.features=[],this.fields=[],this.hasM=!1,this.hasZ=!1,this.geometryType=null,this.objectIdFieldName=null,this.globalIdFieldName=null,this.geometryProperties=null,this.geohashFieldName=null,this.spatialReference=null,this.transform=null}};function KRt(t){var n;const e=Ade.fromJSON(t.geometryType),r=et.fromJSON(t.spatialReference),i=t.transform,s=t.features.map(o=>{const a=Yrt(o,e,r,t.objectIdFieldName),l=a.geometry;if(v(l)&&i)switch(l.type){case"point":a.geometry=Dxe(i,l,l,l.hasZ,l.hasM);break;case"multipoint":a.geometry=Lxe(i,l,l,!!l.hasZ,!!l.hasM);break;case"polygon":a.geometry=Nxe(i,l,l,!!l.hasZ,!!l.hasM);break;case"polyline":a.geometry=Fxe(i,l,l,!!l.hasZ,!!l.hasM);break;case"extent":case"mesh":a.geometry=l}return a});return{geometryType:e,features:s,spatialReference:r,fields:((n=t.fields)==null?void 0:n.map(o=>e5.fromJSON(o)))??[],objectIdFieldName:t.objectIdFieldName,globalIdFieldName:t.globalIdFieldName,geohashFieldName:t.geohashFieldName,geometryProperties:t.geometryProperties,hasZ:t.hasZ,hasM:t.hasM,exceededTransferLimit:t.exceededTransferLimit,transform:null}}function Yrt(t,e,r,i){return{uid:Pc(),objectId:i&&t.attributes?t.attributes[i]:null,attributes:t.attributes,geometry:Zrt(t.geometry,e,r),visible:!0}}function Zrt(t,e,r){if(C(t))return null;switch(e){case"point":{const i=t;return{x:i.x,y:i.y,z:i.z,m:i.m,hasZ:i.z!=null,hasM:i.m!=null,type:"point",spatialReference:r}}case"polyline":{const i=t;return{paths:i.paths,hasZ:!!i.hasZ,hasM:!!i.hasM,type:"polyline",spatialReference:r}}case"polygon":{const i=t;return{rings:i.rings,hasZ:!!i.hasZ,hasM:!!i.hasM,type:"polygon",spatialReference:r}}case"multipoint":{const i=t;return{points:i.points,hasZ:!!i.hasZ,hasM:!!i.hasM,type:"multipoint",spatialReference:r}}}}function xy(t,e,r,i){return{x:t,y:e,z:r,hasZ:r!=null,hasM:!1,spatialReference:i,type:"point"}}function Jrt(t){if(C(t))return 0;let e=32;switch(t.type){case"point":e+=42;break;case"polyline":case"polygon":{let r=0;const i=2+(t.hasZ?1:0)+(t.hasM?1:0),s=t.type==="polyline"?t.paths:t.rings;for(const n of s)r+=n.length;e+=8*r*i+64,e+=128*r,e+=34,e+=32*(s.length+1);break}case"multipoint":{const r=2+(t.hasZ?1:0)+(t.hasM?1:0),i=t.points.length;e+=8*i*r+64,e+=128*i,e+=34,e+=32;break}case"extent":e+=98,t.hasM&&(e+=32),t.hasZ&&(e+=32);break;case"mesh":e+=qM(t.vertexAttributes.position),e+=qM(t.vertexAttributes.normal),e+=qM(t.vertexAttributes.uv),e+=qM(t.vertexAttributes.tangent)}return e}function QRt(t){let e=32;return e+=Ife(t.attributes),e+=3,e+=8+Jrt(t.geometry),e}function Krt(t){if(C(t))return 0;switch(t.type){case"point":return 1;case"polyline":{let e=0;for(const r of t.paths)e+=r.length;return e}case"polygon":{let e=0;for(const r of t.rings)e+=r.length;return e}case"multipoint":return t.points.length;case"extent":return 2;case"mesh":{const e=t.vertexAttributes&&t.vertexAttributes.position;return e?e.length/3:0}default:return}}function eOt(t){if(C(t))return!1;switch(t.type){case"extent":case"point":return!0;case"polyline":for(const e of t.paths)if(e.length>0)return!0;return!1;case"polygon":for(const e of t.rings)if(e.length>0)return!0;return!1;case"multipoint":return t.points.length>0;case"mesh":return!t.loaded||t.vertexAttributes.position.length>0}}function tOt(t,e){switch(Ri(e),t.type==="mesh"&&(t=t.extent),t.type){case"point":e[0]=e[3]=t.x,e[1]=e[4]=t.y,t.hasZ&&(e[2]=e[5]=t.z);break;case"polyline":for(let r=0;r<t.paths.length;r++)z6(e,t.paths[r],!!t.hasZ);break;case"polygon":for(let r=0;r<t.rings.length;r++)z6(e,t.rings[r],!!t.hasZ);break;case"multipoint":z6(e,t.points,!!t.hasZ);break;case"extent":e[0]=t.xmin,e[1]=t.ymin,e[3]=t.xmax,e[4]=t.ymax,t.zmin!=null&&(e[2]=t.zmin),t.zmax!=null&&(e[5]=t.zmax)}}function Qrt(t,e){switch(zh(e),t.type==="mesh"&&(t=t.extent),t.type){case"point":e[0]=e[2]=t.x,e[1]=e[3]=t.y;break;case"polyline":for(let r=0;r<t.paths.length;r++)B6(e,t.paths[r]);break;case"polygon":for(let r=0;r<t.rings.length;r++)B6(e,t.rings[r]);break;case"multipoint":B6(e,t.points);break;case"extent":e[0]=t.xmin,e[1]=t.ymin,e[2]=t.xmax,e[3]=t.ymax}}function rOt(t,e){return t.objectId!=null?t.objectId:t.attributes&&e?t.attributes[e]:null}function Uxe(t){return"declaredClass"in t}function tne(t){return"declaredClass"in t}function eit(t){return"declaredClass"in t}function tit(t,e){return t?eit(t)?t:new Io({layer:e,sourceLayer:e,visible:t.visible,symbol:ne(t.symbol),attributes:ne(t.attributes),geometry:kxe(t.geometry)}):null}function kxe(t){return C(t)?null:Uxe(t)?t:il(rit(t))}function rit(t){const{wkid:e,wkt:r,latestWkid:i}=t.spatialReference,s={wkid:e,wkt:r,latestWkid:i};switch(t.type){case"point":{const{x:n,y:o,z:a,m:l}=t;return{x:n,y:o,z:a,m:l,spatialReference:s}}case"polygon":{const{rings:n,hasZ:o,hasM:a}=t;return{rings:rne(n),hasZ:o,hasM:a,spatialReference:s}}case"polyline":{const{paths:n,hasZ:o,hasM:a}=t;return{paths:rne(n),hasZ:o,hasM:a,spatialReference:s}}case"extent":{const{xmin:n,xmax:o,ymin:a,ymax:l,zmin:c,zmax:h,mmin:p,mmax:f,hasZ:m,hasM:y}=t;return{xmin:n,xmax:o,ymin:a,ymax:l,zmin:c,zmax:h,mmin:p,mmax:f,hasZ:m,hasM:y,spatialReference:s}}case"multipoint":{const{points:n,hasZ:o,hasM:a}=t;return{points:Bxe(n)?Vxe(n):n,hasZ:o,hasM:a,spatialReference:s}}default:return}}function rne(t){return iit(t)?t.map(e=>Vxe(e)):t}function Vxe(t){return t.map(e=>Array.from(e))}function iit(t){for(const e of t)if(e.length!==0)return Bxe(e);return!1}function Bxe(t){return t.length>0&&(zH(t[0])||GH(t[0]))}function sit(t,e){if(!t)return null;let r;if(tne(t)){if(e==null)return t.clone();if(tne(e))return e.copy(t)}return e!=null?(r=e,r.x=t.x,r.y=t.y,r.spatialReference=t.spatialReference,t.hasZ?(r.z=t.z,r.hasZ=t.hasZ):(r.z=void 0,r.hasZ=!1),t.hasM?(r.m=t.m,r.hasM=!0):(r.m=void 0,r.hasM=!1)):(r=xy(t.x,t.y,t.z,t.spatialReference),t.hasM&&(r.m=t.m,r.hasM=!0)),r}function iOt(t){const{wkid:e,wkt:r,latestWkid:i}=t,s={wkid:e,wkt:r,latestWkid:i};return et.fromJSON(s)}const t9=se.getLogger("esri.layers.support.labelFormatUtils"),r9={type:"simple",evaluate:()=>null},nit={getAttribute:(t,e)=>t.field(e)};async function zxe(t,e,r){if(!t||!t.symbol||!e)return r9;const i=t.where,s=c5(t),n=i?await te(()=>import("./WhereClause-2e7ef2fe.js").then(a=>a.W),["assets/WhereClause-2e7ef2fe.js","assets/executionError-fb3f283a.js"]):null;let o;if(s.type==="arcade"){const a=await cIe(s.expression,r,e);if(C(a))return r9;o={type:"arcade",evaluate(l){try{const c=a.evaluate({$feature:"attributes"in l?a.repurposeFeature(l):l});if(c!=null)return c.toString()}catch{t9.error(new q("arcade-expression-error","Encountered an error when evaluating label expression for feature",{feature:l,expression:s}))}return null},needsHydrationToEvaluate:()=>UX(s.expression)==null}}else o={type:"simple",evaluate:a=>s.expression.replace(/{[^}]*}/g,l=>{const c=l.slice(1,-1),h=e.get(c);if(!h)return l;let p=null;return"attributes"in a?a&&a.attributes&&(p=a.attributes[h.name]):p=a.field(h.name),p==null?"":Gxe(p,h)})};if(i){let a;try{a=n.WhereClause.create(i,e)}catch(c){return t9.error(new q("bad-where-clause","Encountered an error when evaluating where clause, ignoring",{where:i,error:c})),r9}const l=o.evaluate;o.evaluate=c=>{const h="attributes"in c?void 0:nit;try{if(a.testFeature(c,h))return l(c)}catch(p){t9.error(new q("bad-where-clause","Encountered an error when evaluating where clause for feature",{where:i,feature:c,error:p}))}return null}}return o}function Gxe(t,e){if(t==null)return"";const r=e.domain;if(r){if(r.type==="codedValue"||r.type==="coded-value"){const s=t;for(const n of r.codedValues)if(n.code===s)return n.name}else if(r.type==="range"){const s=+t,n="range"in r?r.range[0]:r.minValue,o="range"in r?r.range[1]:r.maxValue;if(n<=s&&s<=o)return r.name}}let i=t;return e.type==="date"||e.type==="esriFieldTypeDate"?i=nm(i,g4("short-date")):m4(e)&&(i=om(+i)),i||""}const sOt=Object.freeze(Object.defineProperty({__proto__:null,createLabelFunction:zxe,formatField:Gxe},Symbol.toStringTag,{value:"Module"}));let jxe=class{constructor(e=null,r="center",i="center",s=null,n=[0,0,0],o=0,a=[0,0,0,1],l=[0,0],c="world",h=0,p=0){this.verticalOffset=e,this.horizontalPlacement=r,this.verticalPlacement=i,this.text=s,this.translation=n,this.elevationOffset=o,this.centerOffset=a,this.screenOffset=l,this.centerOffsetUnits=c,this.displayWidth=h,this.displayHeight=p}};function xZ(t,e){if(t.type==="point")return Wy(t,e,!1);if(Uxe(t))switch(t.type){case"extent":return Wy(t.center,e,!1);case"polygon":return Wy(t.centroid,e,!1);case"polyline":return Wy(ine(t),e,!0);case"mesh":return Wy(t.origin,e,!1)}else switch(t.type){case"extent":return Wy(oit(t),e,!0);case"polygon":return Wy(ait(t),e,!0);case"polyline":return Wy(ine(t),e,!0)}}function ine(t){const e=t.paths[0];if(!e||e.length===0)return null;const r=hde(e,ude(e)/2);return xy(r[0],r[1],r[2],t.spatialReference)}function oit(t){return xy(.5*(t.xmax+t.xmin),.5*(t.ymax+t.ymin),t.zmin!=null&&t.zmax!=null&&isFinite(t.zmin)&&isFinite(t.zmax)?.5*(t.zmax+t.zmin):void 0,t.spatialReference)}function ait(t){const e=t.rings[0];if(!e||e.length===0)return null;const r=Fq(t.rings,!!t.hasZ);return xy(r[0],r[1],r[2],t.spatialReference)}function Wy(t,e,r){const i=r?t:sit(t);return e&&t?dDe(t,i,e)?i:null:i}function oOt(t,e,r,i=0){if(t){e||(e=ur());const s=t;let n=.5*s.width*(r-1),o=.5*s.height*(r-1);return s.width<1e-7*s.height?n+=o/20:s.height<1e-7*s.width&&(o+=n/20),ti(e,s.xmin-n-i,s.ymin-o-i,s.xmax+n+i,s.ymax+o+i),e}return null}function Hxe(t,e){for(let r=0;r<t.geometries.length;++r){const i=t.geometries[r].getMutableAttribute(A.AUXPOS1);i&&i.data[3]!==e&&(i.data[3]=e,t.geometryVertexAttrsUpdated(t.geometries[r]))}}function yR(t,e){const r=aM(Rh);return v(t)&&(r[0]=t[0],r[1]=t[1],r[2]=t[2]),v(e)?r[3]=e:v(t)&&t.length>3&&(r[3]=t[3]),r}function aOt(t,e,r,i,s,n=[0,0,0,0]){for(let o=0;o<3;++o)v(t)&&t[o]!=null?n[o]=t[o]:v(r)&&r[o]!=null?n[o]=r[o]:n[o]=s[o];return v(e)?n[3]=e:v(i)?n[3]=i:n[3]=s[3],n}function sne(t=Nf,e,r,i=1){const s=new Array(3);if(C(e)||C(r))s[0]=1,s[1]=1,s[2]=1;else{let n,o=0;for(let a=2;a>=0;a--){const l=t[a];let c;const h=l!=null,p=a===0&&!n&&!h,f=r[a];l==="symbol-value"||p?c=f!==0?e[a]/f:1:h&&l!=="proportional"&&isFinite(l)&&(c=f!==0?l/f:1),c!=null&&(s[a]=c,n=c,o=Math.max(o,Math.abs(c)))}for(let a=2;a>=0;a--)s[a]==null?s[a]=n:s[a]===0&&(s[a]=.001*o)}for(let n=2;n>=0;n--)s[n]/=i;return Nl(s)}function lit(t){return t.isPrimitive!=null}function W5(t){return RF(lit(t)?[t.width,t.depth,t.height]:t)?null:"Symbol sizes may not be negative values"}function RF(t){if(Array.isArray(t)){for(const e of t)if(!RF(e))return!1;return!0}return t==null||t>=0}function cit(t,e,r,i=Ie()){const s=t||0,n=e||0,o=r||0;return s!==0&&DS(i,i,-s/180*Math.PI),n!==0&&LS(i,i,n/180*Math.PI),o!==0&&I4(i,i,o/180*Math.PI),i}function TZ(t,e,r){if(r.minDemResolution!=null)return r.minDemResolution;const i=nl(e),s=Hw(t)*i,n=qw(t)*i,o=mv(t)*(e.isGeographic?1:i);return s===0&&n===0&&o===0?r.minDemResolutionForPoints:.01*Math.max(s,n,o)}function qxe(t,e,r,i,s,n,o,a,l,c,h){const p=yit[h.mode];let f,m,y=0;if(_s(t,e,r,i,l.spatialReference,s,a))return p.requiresAlignment(h)?(y=p.applyElevationAlignmentBuffer(i,s,n,o,a,l,c,h),f=n,m=o):(f=i,m=s),_s(f,l.spatialReference,m,n,c.spatialReference,o,a)?y:void 0}function WE(t,e,r,i,s){const n=(yF(t)?t.z:uwe(t)?t.array[t.offset+2]:t[2])||0;switch(r.mode){case"on-the-ground":{const o=It(kf(e,t,"ground"),0);return s.verticalDistanceToGround=0,s.sampledElevation=o,void(s.z=o)}case"relative-to-ground":{const o=It(kf(e,t,"ground"),0),a=r.geometryZWithOffset(n,i);return s.verticalDistanceToGround=a,s.sampledElevation=o,void(s.z=a+o)}case"relative-to-scene":{const o=It(kf(e,t,"scene"),0),a=r.geometryZWithOffset(n,i);return s.verticalDistanceToGround=a,s.sampledElevation=o,void(s.z=a+o)}case"absolute-height":{const o=r.geometryZWithOffset(n,i),a=It(kf(e,t,"ground"),0);return s.verticalDistanceToGround=o-a,s.sampledElevation=a,void(s.z=o)}default:return void(s.z=0)}}function uit(t,e,r,i){return WE(t,e,r,i,$2),$2.z}function LM(t,e,r){return e==null||r==null?t.definedChanged:e==="on-the-ground"&&r==="on-the-ground"?t.staysOnTheGround:e===r||e!=="on-the-ground"&&r!=="on-the-ground"?ys.UPDATE:t.onTheGroundChanged}function Xh(t){return t==="relative-to-ground"||t==="relative-to-scene"}function lv(t){return t!=="absolute-height"}function hit(t,e,r,i,s){WE(e,r,s,i,$2),Hxe(t,$2.verticalDistanceToGround);const n=$2.sampledElevation,o=Fn(_it,t.transformation);return OI[0]=e.x,OI[1]=e.y,OI[2]=$2.z,gp(e.spatialReference,OI,o,i.spatialReference)?t.transformation=o:console.warn("Could not locate symbol object properly, it might be misplaced"),n}function dit(t,e,r,i,s,n){let o=0;const a=n.spatialReference;e*=3,i*=3;for(let l=0;l<s;++l){const c=t[e+0],h=t[e+1],p=t[e+2],f=It(n.getElevation(c,h,p,a,"ground"),0);o+=f,r[i+0]=c,r[i+1]=h,r[i+2]=f,e+=3,i+=3}return o/s}function pit(t,e,r,i,s,n,o,a){let l=0;const c=a.calculateOffsetRenderUnits(o),h=a.featureExpressionInfoContext,p=n.spatialReference;e*=3,i*=3;for(let f=0;f<s;++f){const m=t[e+0],y=t[e+1],_=t[e+2],b=It(n.getElevation(m,y,_,p,"ground"),0);l+=b,r[i+0]=m,r[i+1]=y,r[i+2]=h==null?_+b+c:b+c,e+=3,i+=3}return l/s}function fit(t,e,r,i,s,n,o,a){let l=0;const c=a.calculateOffsetRenderUnits(o),h=a.featureExpressionInfoContext,p=n.spatialReference;e*=3,i*=3;for(let f=0;f<s;++f){const m=t[e+0],y=t[e+1],_=t[e+2],b=It(n.getElevation(m,y,_,p,"scene"),0);l+=b,r[i+0]=m,r[i+1]=y,r[i+2]=h==null?_+b+c:b+c,e+=3,i+=3}return l/s}function mit(t){const e=t.meterUnitOffset,r=t.featureExpressionInfoContext;return e!==0||r!=null}function git(t,e,r,i,s,n,o,a){const l=a.calculateOffsetRenderUnits(o),c=a.featureExpressionInfoContext;e*=3,i*=3;for(let h=0;h<s;++h){const p=t[e+0],f=t[e+1],m=t[e+2];r[i+0]=p,r[i+1]=f,r[i+2]=c==null?m+l:l,e+=3,i+=3}return 0}let DM=class{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}};var ys;(function(t){t[t.NONE=0]="NONE",t[t.UPDATE=1]="UPDATE",t[t.RECREATE=2]="RECREATE"})(ys||(ys={}));const yit={"absolute-height":{applyElevationAlignmentBuffer:git,requiresAlignment:mit},"on-the-ground":{applyElevationAlignmentBuffer:dit,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:pit,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:fit,requiresAlignment:()=>!0}},_it=Ie(),$2=new DM,OI=M();function SZ(t){return v(t.mapPositions)}function Wxe(t,e,r,i,s){const n=t.stageObject,o=n.geometries;let a=0;for(const l of o){if(!SZ(l))continue;const{update:c,averageGeometrySampledElevation:h}=Yxe(l,e,r,i,s);a+=h,c&&n.geometryVertexAttrsUpdated(l)}return a/o.length}function SO(t,e,r,i,s){var p;const n=t.stageObject,o=e.centerPointInElevationSR;let a=0;(p=n.metadata)!=null&&p.usesVerticalDistanceToGround?(i(o,Ul),Hxe(n,Ul.verticalDistanceToGround),a=Ul.sampledElevation):(i(o,Ul),e.mode!=="absolute-height"&&(a=Ul.sampledElevation));const l=Fn(vit,n.transformation),c=ce(Xxe,l[12],l[13],l[14]);qr.TESTS_DISABLE_OPTIMIZATIONS?(Fl[0]=o.x,Fl[1]=o.y,Fl[2]=Ul.z,gp(o.spatialReference,Fl,l,s.spatialReference)&&(n.transformation=l)):s.setAltitudeOfTransformation(Ul.z,l);const h=EZ/s.unitInMeters;return(Math.abs(l[12]-c[0])>=h||Math.abs(l[13]-c[1])>=h||Math.abs(l[14]-c[2])>=h)&&(n.transformation=l),a}const vit=Ie();function bit(t,e,r,i,s){const n=t.graphics3DSymbolLayer.lodRenderer;if(C(n))return 0;const o=e.centerPointInElevationSR;i(o,Ul);const a=e.mode!=="absolute-height"?Ul.sampledElevation:0,l=n.instanceData,c=t.instanceIndex,h=xit;l.getGlobalTransform(c,h);const p=ce(Xxe,h[12],h[13],h[14]);qr.TESTS_DISABLE_OPTIMIZATIONS?(Fl[0]=o.x,Fl[1]=o.y,Fl[2]=Ul.z,gp(o.spatialReference,Fl,h,s.spatialReference)&&l.setGlobalTransform(c,h)):s.setAltitudeOfTransformation(Ul.z,h);const f=EZ/s.unitInMeters;return(qr.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(h[12]-p[0])>=f||Math.abs(h[13]-p[1])>=f||Math.abs(h[14]-p[2])>=f)&&l.setGlobalTransform(c,h),a}function wit(t,e,r,i,s){const n=t.stageObject,o=n.geometries;if(o.length===0)return 0;let a=0,l=null,c=0,h=!1;for(const p of o){if(!SZ(p))continue;const f=p.vertexAttributes.get(A.POSITION);if(f!==l){const{update:m,averageGeometrySampledElevation:y}=Yxe(p,e,r,i,s);c=y,l=f,h=m}h&&n.geometryVertexAttrsUpdated(p),a+=c}return a/o.length}const EZ=.01,Fl=M(),Gu=M(),Px=M(),xit=Ie(),Xxe=M(),Ul=new DM;function Yxe(t,e,r,i,s){let n=!1;const o=t.shaderTransformation,a=e.requiresSampledElevationInfo;Gu[0]=o[12],Gu[1]=o[13],Gu[2]=o[14],t.invalidateBoundingInfo();const l=t.getMutableAttribute(A.POSITION),c=l.data,h=l.size,p=c.length/h,f=new cwe(t.mapPositions,r);let m=0,y=0;for(let _=0;_<p;_++){if(Px[0]=c[m],Px[1]=c[m+1],Px[2]=c[m+2],i(f,Ul),a&&(y+=Ul.sampledElevation),qr.TESTS_DISABLE_OPTIMIZATIONS)c[m]=f.array[f.offset],c[m+1]=f.array[f.offset+1],c[m+2]=Ul.z,_s(c,r,m,c,s.spatialReference,m,1),c[m]-=Gu[0],c[m+1]-=Gu[1],c[m+2]-=Gu[2],n=!0;else{Fl[0]=c[m]+Gu[0],Fl[1]=c[m+1]+Gu[1],Fl[2]=c[m+2]+Gu[2],s.setAltitude(Fl,Ul.z),c[m]=Fl[0]-Gu[0],c[m+1]=Fl[1]-Gu[1],c[m+2]=Fl[2]-Gu[2];const b=EZ/s.unitInMeters;(Math.abs(Px[0]-c[m])>=b||Math.abs(Px[1]-c[m+1])>=b||Math.abs(Px[2]-c[m+2])>=b)&&(n=!0)}m+=h,f.offset+=3}return y/=p,{update:n,averageGeometrySampledElevation:y}}const Tit=se.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function Sit(t){return{cachedResult:t.cachedResult,arcade:t.arcade?{func:t.arcade.func,context:t.arcade.modules.arcadeUtils.createExecContext(null,{sr:t.arcade.context.spatialReference}),modules:t.arcade.modules}:null}}function cOt(t){const e=t&&t.expression;if(typeof e=="string"){const r=Kxe(e);if(r!=null)return{cachedResult:r}}return null}async function uOt(t,e,r,i){const s=t&&t.expression;if(typeof s!="string")return null;const n=Kxe(s);if(n!=null)return{cachedResult:n};const o=await sm();fr(r);const a=o.arcadeUtils,l=a.createSyntaxTree(s);return a.dependsOnView(l)?(i!=null&&i.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:a.createFunction(l),context:a.createExecContext(null,{sr:e}),modules:o}}}function Zxe(t,e,r){return t.arcadeUtils.createFeature(e.attributes,e.geometry,r)}function CZ(t,e){if(t!=null&&!Jxe(t)){if(!e||!t.arcade)return void Tit.errorOncePerTick("Arcade support required but not provided");const r=e;r._geometry&&(r._geometry=kxe(r._geometry)),t.arcade.modules.arcadeUtils.updateExecContext(t.arcade.context,e)}}function Eit(t){if(t!=null){if(Jxe(t))return t.cachedResult;const e=t.arcade;let r=e==null?void 0:e.modules.arcadeUtils.executeFunction(e.func,e.context);return typeof r!="number"&&(t.cachedResult=0,r=0),r}return 0}function hOt(t,e=!1){let r=t&&t.featureExpressionInfo;const i=r&&r.expression;return e||i==="0"||(r=null),r??null}const Cit={cachedResult:0};function Jxe(t){return t.cachedResult!=null}function Kxe(t){return t==="0"?0:null}let Cp=class Qxe{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=wVe(e)}get requiresSampledElevationInfo(){return this.mode!=="absolute-height"}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,r){const i=this.calculateOffsetRenderUnits(r);return this.featureExpressionInfoContext!=null?i:e+i}calculateOffsetRenderUnits(e){let r=this._meterUnitOffset;const i=this.featureExpressionInfoContext;return i!=null&&(r+=Eit(i)*this._metersPerElevationInfoUnit),r/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=bVe(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=It(e.offset,0)}updateFeatureExpressionInfoContext(e,r,i){if(C(e))return void(this._featureExpressionInfoContext=null);const s=e&&e.arcade;s&&v(r)&&v(i)?(this._featureExpressionInfoContext=Sit(e),CZ(this._featureExpressionInfoContext,Zxe(s.modules,r,i))):this._featureExpressionInfoContext=e}static fromElevationInfo(e){const r=new Qxe;return v(e)&&r.setFromElevationInfo(e),r}},Ait=class{constructor(e,r,i){this.graphic=e,this.renderingInfo=r,this.layer=i}};var rr;(function(t){t[t.INVISIBLE=0]="INVISIBLE",t[t.TRANSPARENT=1]="TRANSPARENT",t[t.OPAQUE=2]="OPAQUE"})(rr||(rr={}));let Rit=class{constructor(e,r,i){this.baseMaterial=e,this.edgeMaterials=r,this.properties=i}},xm=class{get isElevationSource(){return!(!this.stageObject.metadata||!this.stageObject.metadata.isElevationSource)}constructor(e,r,i,s,n,o,a,l=null){this.graphics3DSymbolLayer=e,this.stageObject=r,this._uniqueGeometries=i,this._uniqueMaterials=s,this._sharedResource=n,this.elevationAligner=o,this.elevationContext=a,this._edgeState=l,this.type="object3d",this._stageLayer=null,this._stage=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1}initialize(e,r){this._stageLayer=r,this._stage=e,e.addMany(this._uniqueMaterials),e.addMany(this._uniqueGeometries),e.add(this.stageObject)}destroy(){const e=this._stage;this._stageLayer&&(e.removeMany(this._uniqueMaterials),e.removeMany(this._uniqueGeometries)),e.remove(this.stageObject),this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1);const r=this._stage.renderer.ensureEdgeView();r.hasObject(this.stageObject)&&r.removeObject(this.stageObject),this.stageObject.dispose(),v(this._sharedResource)&&this._sharedResource.release(),this._visible=!1,this._stageLayer=null,this._stage=null}layerOpacityChanged(e,r){if(C(this._edgeState))return;const i=nne(this._edgeState.baseMaterial);let s=!1;for(const n of this._edgeState.edgeMaterials)n.objectTransparency!==i&&(n.objectTransparency=i,s=!0);s&&this._resetEdgeObject(r),this._stage.renderer.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[e])}slicePlaneEnabledChanged(e,r){C(this._edgeState)||(this._stage.renderer.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{hasSlicePlane:e},!r),this._edgeState.properties.hasSlicePlane=e)}setVisibility(e){if(this._stage!=null&&this._visible!==e&&(this._visible=e,this.stageObject.visible=e,this._visible&&!this._addedToStage&&(this._stageLayer.add(this.stageObject),this._addedToStage=!0),v(this._edgeState))){const r=this._stage.renderer.ensureEdgeView();r.hasObject(this.stageObject)?r.updateObjectVisibility(this.stageObject,e):e&&this._addOrUpdateEdgeObject(r,!1)}}get visible(){return this._visible}alignWithElevation(e,r,i,s){if(this.elevationAligner==null)return;v(i)&&CZ(this.elevationContext.featureExpressionInfoContext,i);const n=(o,a)=>WE(o,e,this.elevationContext,r,a);this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,e.spatialReference,n,r),this._resetEdgeObject(s)}alignWithAbsoluteElevation(e,r,i){const s=(n,o)=>{o.sampledElevation=e,o.verticalDistanceToGround=0,o.z=e};this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,null,s,r),this._resetEdgeObject(i)}getCenterObjectSpace(e=M()){return le(e,this.stageObject.boundingVolumeObjectSpace.bounds)}getBoundingBoxObjectSpace(e=En()){const r=this.stageObject.boundingVolumeObjectSpace;return fpe(e,r.min),mpe(e,r.max),e}computeAttachmentOrigin(e){if(this.useObjectOriginAsAttachmentOrigin){const r=this.stageObject.transformation;e.render.origin[0]+=r[12],e.render.origin[1]+=r[13],e.render.origin[2]+=r[14],e.render.num++}else for(const r of this.stageObject.geometries)r.computeAttachmentOrigin(Nm)&&(We(Nm,Nm,this.stageObject.transformation),fe(e.render.origin,e.render.origin,Nm),e.render.num++)}async getProjectedBoundingBox(e,r,i,s,n){const o=this.getBoundingBoxObjectSpace(n),a=Oit,l=nW(o)?1:a.length;for(let h=0;h<l;h++){const p=a[h];Xy[0]=o[p[0]],Xy[1]=o[p[1]],Xy[2]=o[p[2]],We(Xy,Xy,this.stageObject.transformation),jv[3*h+0]=Xy[0],jv[3*h+1]=Xy[1],jv[3*h+2]=Xy[2]}if(!e(jv,0,l))return null;Ri(o);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let h=0;h<3*l;h+=3){for(let p=0;p<3;p++)o[p]=Math.min(o[p],jv[h+p]),o[p+3]=Math.max(o[p+3],jv[h+p]);c&&i.push({location:jv.slice(h,h+3),screenSpaceBoundingRect:c})}if(r&&r.service&&this.elevationContext.mode!=="absolute-height"){Yd(o,Nm);const h=this.elevationContext.mode==="relative-to-scene"?"scene":"ground";let p=0;if(r.useViewElevation)p=It(r.service.getElevation(Nm[0],Nm[1],h),0);else try{const f=TZ(o,r.service.spatialReference,r);p=It(await r.service.queryElevation(Nm[0],Nm[1],s,f,h),0)}catch{}ppe(o,0,0,-this.alignedSampledElevation+p)}return o}addObjectState(e,r){e===ry.Highlight&&r.addObject(this.stageObject,this.stageObject.highlight()),e===ry.MaskOccludee&&r.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeObject(this.stageObject)}_resetEdgeObject(e){if(C(this._edgeState))return;const r=this._stage.renderer.ensureEdgeView();this._visible?this._addOrUpdateEdgeObject(r,e):r.removeObject(this.stageObject)}_addOrUpdateEdgeObject(e,r){const i=this._edgeState;if(C(i))return;const s=nne(i.baseMaterial);for(const n of i.edgeMaterials)n.objectTransparency=s;e.addOrUpdateObject3D(this.stageObject,i.edgeMaterials,i.properties,!r).then(()=>{var n;return(n=this._stageLayer)==null?void 0:n.sync()})}};function nne(t){return t.isVisible()?t.parameters.transparent?rr.TRANSPARENT:rr.OPAQUE:rr.INVISIBLE}const jv=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Xy=M(),Nm=M(),Oit=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];let eTe=class{constructor(e,r=null){this.labelText=r,this.elevationOffset=It(e,0)}};var wn;(function(t){t[t.Recreate_Symbol=0]="Recreate_Symbol",t[t.Recreate_Graphics=1]="Recreate_Graphics",t[t.Fast_Update=2]="Fast_Update"})(wn||(wn={}));let AZ=class{constructor(e){this.schedule=e,this._abortController=null,this._loadStatus=yu.LOADING,this._loadError=null,this._loader=null,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(e,r){return this._loadStatus===yu.LOADED?(e&&e(),It(this._loader,Promise.resolve())):this._loadStatus===yu.FAILED?(r&&r(this._loadError),It(this._loader,Promise.resolve())):(C(this._loader)&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then(()=>{this._abortController=null,this._loadStatus=yu.LOADED},i=>{throw this._loadError=i,this._abortController=null,this._loadStatus=yu.FAILED,!Qs(i)&&this.logger&&i.message&&this.logger.warn(i.message),i})),this._loader.then(e,r).catch(()=>{}),this._loader)}abortLoad(){v(this._abortController)?this._abortController=Fh(this._abortController):this._loadStatus===yu.LOADING&&(this._loadStatus=yu.FAILED),this._loader=null}};var yu;(function(t){t[t.LOADING=0]="LOADING",t[t.LOADED=1]="LOADED",t[t.FAILED=2]="FAILED"})(yu||(yu={}));const tTe=3,Fj=3,rTe=10;let iTe=class{constructor(e,r=null){this.geometry=e,this.textures=r}};function MI(t){const e=[];return t.levels.forEach(r=>r.components.forEach(i=>e.push(i.geometry.material))),zO(e)}function one(t){const e=new Array;return t.levels.forEach(r=>{r.components.forEach(i=>{v(i.textures)&&e.push(...i.textures)})}),zO(e)}function sTe(t){const e=t.components.map(r=>r.geometry);return zO(e)}function ane(t){const e=[];return t.levels.forEach(r=>{r.components.forEach(i=>{e.push(i.geometry)})}),zO(e)}function Mit(t){switch(t){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1}function nTe(t,e){const r=(i,s,n=!1)=>({levels:i.map(o=>{const a=s(o.tesselation);return n&&wYe(a),{components:[new iTe(a)],faceCount:a.indexCount/3,minScreenSpaceRadius:o.minScreenSpaceRadius}})});switch(t){case"sphere":return r([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],i=>_Ye(e,.5,i,!0));case"cube":return r([{tesselation:0,minScreenSpaceRadius:0}],()=>cYe(e,1));case"cone":return r(i9,i=>xie(e,1,.5,i,!1),!0);case"inverted-cone":return r(i9,i=>xie(e,1,.5,i,!0),!0);case"cylinder":return r(i9,i=>bYe(e,1,.5,i,[0,0,1],[0,0,.5]));case"tetrahedron":return r([{tesselation:0,minScreenSpaceRadius:0}],()=>yYe(e,1),!0);case"diamond":return r([{tesselation:0,minScreenSpaceRadius:0}],()=>pYe(e,1),!0);default:return}}const i9=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];function Pit(t){return t.type==="fill"}function Iit(t){return t.type==="extrude"}function $it(t){return t&&t.enabled&&(Iit(t)||Pit(t))&&v(t.edges)}function Lit(t){return t&&t.enabled&&t.edges||null}function oTe(t,e){return Dit(Lit(t),e)}function Dit(t,e){if(C(t))return null;const r=v(t.color)?CW(Ze.toUnitRGBA(t.color)):Ht(0,0,0,0),i=Ao(t.size),s=Ao(t.extensionLength);switch(t.type){case"solid":return Nit({color:r,size:i,extensionLength:s,...e});case"sketch":return Fit({color:r,size:i,extensionLength:s,...e});default:return}}function Nit(t){return{...Uit,...t,type:"solid"}}function Fit(t){return{...kit,...t,type:"sketch"}}const Uit={color:Ht(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:rr.OPAQUE,hasSlicePlane:!1},kit={color:Ht(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:rr.OPAQUE,hasSlicePlane:!1},RZ={primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:{bytesPerFeature:0,bytesPerCoordinate:0,bytesPerFeatureLabel:0,resourceBytes:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}}};function _Ot(t){return t.type==="web-style"?RZ:OZ(t.symbolLayers.toArray().map(e=>aTe(t,e)))}function OZ(t){let e=0,r=0,i=0,s=!1,n=0;const o={bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0,resourceBytes:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}};for(const a of t)C(a)||(e+=a.primitivesPerFeature,r+=a.primitivesPerCoordinate,i+=a.drawCallsPerFeature,o.bytesPerFeature+=a.memory.bytesPerFeature,o.bytesPerFeatureLabel+=a.memory.bytesPerFeatureLabel,o.bytesPerCoordinate+=a.memory.bytesPerCoordinate,o.resourceBytes+=a.memory.resourceBytes,o.draped.bytesPerFeature+=a.memory.bytesPerFeature,o.draped.bytesPerFeatureLabel+=a.memory.bytesPerFeatureLabel,o.draped.bytesPerCoordinate+=a.memory.bytesPerCoordinate,s=s||a.estimated,++n);return{primitivesPerFeature:e,primitivesPerCoordinate:r,drawCallsPerFeature:i,estimated:s,memory:o,numComplexities:n}}function vOt(t){const e=OZ(t);return e.numComplexities>0&&(e.primitivesPerFeature/=e.numComplexities,e.primitivesPerCoordinate/=e.numComplexities,e.drawCallsPerFeature/=e.numComplexities,e.memory.bytesPerFeature/=e.numComplexities,e.memory.bytesPerFeatureLabel/=e.numComplexities,e.memory.bytesPerCoordinate/=e.numComplexities,e.memory.resourceBytes/=e.numComplexities,e.memory.draped.bytesPerFeature/=e.numComplexities,e.memory.draped.bytesPerFeatureLabel/=e.numComplexities,e.memory.draped.bytesPerCoordinate/=e.numComplexities),e}const lne={};function aTe(t,e){const r=lTe(t,e),i=$it(e)?2:0;switch(e.type){case"extrude":return{primitivesPerFeature:-4,primitivesPerCoordinate:4,drawCallsPerFeature:i,estimated:!1,memory:r};case"fill":return t.type==="mesh-3d"?{primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:i,estimated:!1,memory:r}:v(e.outline)&&e.outline.size>0?{primitivesPerFeature:-4,primitivesPerCoordinate:3,drawCallsPerFeature:0,estimated:!1,memory:r}:{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:r};case"water":return{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:r};case"line":return{primitivesPerFeature:-2,primitivesPerCoordinate:2,drawCallsPerFeature:0,estimated:!1,memory:r};case"object":return e.resource&&e.resource.href?{primitivesPerFeature:16,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:r}:{...Vit(e.resource&&e.resource.primitive||Spe),memory:r};case"path":{let s=0,n=0;switch(e.profile){case"circle":s=rTe;break;case"quad":s=4;break;default:return void(e.profile,void 0)}switch(e.join??"simple"){case"round":n=tTe;break;case"miter":case"bevel":n=1;break;default:return}const o=2*s,a=s*n*2;let l=-2*a-o;switch(e.cap){case"none":break;case"butt":case"square":l+=2*(s-1);break;case"round":l+=2*(s*(Fj-1)*2+s);break;default:return}return{primitivesPerFeature:l,primitivesPerCoordinate:a+o,drawCallsPerFeature:0,estimated:!1,memory:r}}case"text":case"icon":return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:r};default:return}}function lTe(t,e){const r=t.type==="point-3d";switch(e.type){case"extrude":return e.edges&&e.edges.size>0?pl.EXTRUDE_EDGES:pl.EXTRUDE;case"fill":return v(e.outline)&&e.outline.size>0?pl.FILL_OUTLINE:pl.FILL;case"water":return pl.FILL;case"line":return e.join==="round"?pl.LINE_ROUND:pl.LINE_MITER;case"path":switch(e.join){case"round":switch(e.profile){case"circle":return pl.PATH_ROUND_CIRCLE;case"quad":return pl.PATH_ROUND_QUAD;default:return void(e.profile,void 0)}case"miter":case"bevel":switch(e.profile){case"circle":return pl.PATH_MITER_CIRCLE;case"quad":return pl.PATH_MITER_QUAD;default:return void(e.profile,void 0)}default:return}case"object":return r?pl.OBJECT_POINT:pl.OBJECT_POLYGON;case"icon":case"text":return r?pl.ICON_POINT:pl.ICON_POLYGON;default:return}}function Vit(t){let e=lne[t];if(e)return e;const r=nTe(t,null);return e={primitivesPerFeature:sTe(r.levels[0]).reduce((i,s)=>i+s.indices.get(A.POSITION).length/3,0),primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1},lne[t]=e,e}const pl={ICON_POINT:{bytesPerFeature:3293.7707557538765,bytesPerFeatureLabel:1020.2764,bytesPerCoordinate:0,resourceBytes:0,draped:{bytesPerFeature:2213.51585392203,bytesPerFeatureLabel:1008.84664,bytesPerCoordinate:0}},ICON_POLYGON:{bytesPerFeature:4745.397589234022,bytesPerFeatureLabel:1006.5440666666666,bytesPerCoordinate:3.8971910718981526,resourceBytes:0,draped:{bytesPerFeature:3711.9299672493826,bytesPerFeatureLabel:991.1003999999999,bytesPerCoordinate:3.916858016273668}},OBJECT_POINT:{bytesPerFeature:1751.6405617660876,bytesPerFeatureLabel:1024.7827699999998,bytesPerCoordinate:0,resourceBytes:0,draped:{bytesPerFeature:1751.6405617660876,bytesPerFeatureLabel:1024.7827699999998,bytesPerCoordinate:0}},OBJECT_POLYGON:{bytesPerFeature:3265.877223973855,bytesPerFeatureLabel:1002.3207366666666,bytesPerCoordinate:4.003101524580855,resourceBytes:0,draped:{bytesPerFeature:3265.877223973855,bytesPerFeatureLabel:1002.3207366666666,bytesPerCoordinate:4.003101524580855}},LINE_MITER:{bytesPerFeature:5757.019675077085,bytesPerFeatureLabel:998.6150266666667,bytesPerCoordinate:24.456810187064043,resourceBytes:0,draped:{bytesPerFeature:4101.480288021862,bytesPerFeatureLabel:1007.7540599999999,bytesPerCoordinate:18.25629912730874}},LINE_ROUND:{bytesPerFeature:5770.95297166408,bytesPerFeatureLabel:1017.77396,bytesPerCoordinate:24.60919037084966,resourceBytes:0,draped:{bytesPerFeature:4089.5796612121826,bytesPerFeatureLabel:987.8320266666666,bytesPerCoordinate:18.43599029126731}},PATH_MITER_CIRCLE:{bytesPerFeature:36120.81813311945,bytesPerFeatureLabel:977.3815,bytesPerCoordinate:2713.2216607858863,resourceBytes:0,draped:{bytesPerFeature:36120.81813311945,bytesPerFeatureLabel:977.3815,bytesPerCoordinate:2713.2216607858863}},PATH_ROUND_CIRCLE:{bytesPerFeature:23268.96777866874,bytesPerFeatureLabel:985.2637,bytesPerCoordinate:5284.873051323177,resourceBytes:0,draped:{bytesPerFeature:23268.96777866874,bytesPerFeatureLabel:985.2637,bytesPerCoordinate:5284.873051323177}},PATH_MITER_QUAD:{bytesPerFeature:24548.629753007182,bytesPerFeatureLabel:964.6924,bytesPerCoordinate:2114.107276663994,resourceBytes:0,draped:{bytesPerFeature:24548.629753007182,bytesPerFeatureLabel:964.6924,bytesPerCoordinate:2114.107276663994}},PATH_ROUND_QUAD:{bytesPerFeature:34316.219663191616,bytesPerFeatureLabel:975.7985,bytesPerCoordinate:3331.3952550120293,resourceBytes:0,draped:{bytesPerFeature:34316.219663191616,bytesPerFeatureLabel:975.7985,bytesPerCoordinate:3331.3952550120293}},FILL:{bytesPerFeature:6141.501452970723,bytesPerFeatureLabel:1008.2056066666665,bytesPerCoordinate:9.669541106191478,resourceBytes:0,draped:{bytesPerFeature:4615.812654782311,bytesPerFeatureLabel:1004.2114200000001,bytesPerCoordinate:7.378043214430644}},FILL_OUTLINE:{bytesPerFeature:9038.575581319641,bytesPerFeatureLabel:1017.9996066666668,bytesPerCoordinate:14.96569682175086,resourceBytes:0,draped:{bytesPerFeature:6369.386021594582,bytesPerFeatureLabel:1008.9863733333334,bytesPerCoordinate:10.25287774000214}},EXTRUDE:{bytesPerFeature:20071.2337049912,bytesPerFeatureLabel:1019.49468,bytesPerCoordinate:49.39369614206849,resourceBytes:0,draped:{bytesPerFeature:20071.2337049912,bytesPerFeatureLabel:1019.49468,bytesPerCoordinate:49.39369614206849}},EXTRUDE_EDGES:{bytesPerFeature:22300.21739345088,bytesPerFeatureLabel:1017.4348466666665,bytesPerCoordinate:49.40242281963031,resourceBytes:0,draped:{bytesPerFeature:22300.21739345088,bytesPerFeatureLabel:1017.4348466666665,bytesPerCoordinate:49.40242281963031}}},Ix=se.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");let Tm=class extends AZ{constructor(e,r,i,s){super(i.schedule),this.symbol=e,this.symbolLayer=r,this._context=i,this._elevationInfoOverride=null,this._ignoreDrivers=!1,this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1},this.complexity=null,this.logger=Ix,this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this._renderPriority=s.renderPriority,this._renderPriorityStep=s.renderPriorityStep,this._elevationContext=new Cp,this.complexity=this.computeComplexity(),this._ignoreDrivers=s.ignoreDrivers,this._ignoreDrivers||(this._drivenProperties=cne(this._context.renderer)),this._updateElevationContext()}getCachedSize(){return null}get extentPadding(){return 0}_drivenPropertiesChanged(e){if(this._ignoreDrivers)return!1;const r=this._drivenProperties,i=cne(e);return i.color!==r.color||i.opacity!==r.opacity||i.opacityAlwaysOpaque!==r.opacityAlwaysOpaque||i.size!==r.size}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(e,r,i,s){const n=e.projectionSuccess,o="polygons"in e?e.polygons:null,a=`${s} geometry failed to be created`;let l=null;n?!this._logGeometryValidationWarnings(r,i,s)&&o&&o.length===0&&i==="rings"&&r.length>0&&r[0].length>2&&(l=`${a} (filled rings should use clockwise winding - try reversing the order of vertices)`):l=`${a} (failed to project geometry to view spatial reference)`,l&&Ix.warnOncePerTick(l)}_logGeometryValidationWarnings(e,r,i){const s=`${i} geometry failed to be created`;return!e.length||e.length===1&&!e[0].length?(Ix.warnOncePerTick(`${s} (no ${r} were defined)`),!0):(!Array.isArray(e)||!Array.isArray(e[0]))&&(Ix.warnOncePerTick(`${s} (${r} should be defined as a 2D array)`),!0)}_validateGeometry(e,r=null,i=null){if(v(r)&&!r.includes(e.type))return this.logger.warn("unsupported geometry type for "+i+` symbol: ${e.type}`),!1;if(e.type==="point"){const s=e;if(!isFinite(s.x)||!isFinite(s.y))return Ix.warn("point coordinate is not a valid number, graphic skipped"),!1}return!0}_defaultElevationInfoNoZ(){return Bit}_defaultElevationInfoZ(){return zit}_updateElevationContext(){v(this._elevationInfoOverride)?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e,r=this.getDefaultElevationInfo(e)){return this._elevationContext.mode||r.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext()}setGraphicElevationContext(e,r){const i=e.geometry,s=this.getDefaultElevationInfo(i);r.unit=this._elevationContext.unit!=null?this._elevationContext.unit:s.unit,r.mode=this.getGeometryElevationMode(i,s),r.offsetMeters=It(this._elevationContext.meterUnitOffset,It(s.offset,0));const n=!this._elevationOptions.supportsOnTheGround&&r.mode==="on-the-ground";n&&(r.mode="relative-to-ground",r.offsetMeters=0);const o=n?Cit:this._elevationContext.featureExpressionInfoContext;return r.updateFeatureExpressionInfoContext(o,e,this._context.layer),r}prepareSymbolLayerPatch(e){}updateGeometry(e,r){return!1}onRemoveGraphic(e){}_getLayerOpacity(){return this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner?this._context.graphicsCoreOwner.fullOpacity??0:this._context.layer.opacity??1}_getCombinedOpacity(e,r=une){let i=1;return this.draped||(i*=this._getLayerOpacity()),this._drivenProperties.opacity||(v(e)?i*=e.a:r.hasIntrinsicColor||(i=0)),i}_getCombinedOpacityAndColor(e,r=une){const i=this._getCombinedOpacity(e,r);if(this._drivenProperties.color)return yR(null,i);const s=v(e)?Ze.toUnitRGB(e):Nf;return yR(s,i)}_getVertexOpacityAndColor(e,r=null){const i=this._drivenProperties.color?e.color:null,s=this._drivenProperties.opacity?e.opacity:null,n=yR(i,s);return v(r)&&(n[0]*=r,n[1]*=r,n[2]*=r,n[3]*=r),n}isFastUpdatesEnabled(){return this._fastUpdates&&this._fastUpdates.enabled}computeComplexity(){return aTe(this.symbol,this.symbolLayer)}globalPropertyChanged(e,r,i){switch(e){case"opacity":return this.layerOpacityChanged(r,i),!0;case"elevationInfo":{const s=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(r,i,s)!==ys.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(r,i);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged();case"skipHighSymbolLods":return this.skipHighSymbolLodsChanged();default:return!1}}updateGraphics3DGraphicElevationInfo(e,r,i){let s=ys.UPDATE;return e.forEach(n=>{const o=r(n);if(v(o)){const a=n.graphic;this.setGraphicElevationContext(a,o.elevationContext),o.needsElevationUpdates=i(o.elevationContext.mode)}else s=ys.RECREATE}),s}applyRendererDiff(e,r){return wn.Recreate_Symbol}getFastUpdateAttrValues(e){if(!this._fastUpdates.enabled)return null;const r=this._fastUpdates.visualVariables,i=r.size?Gg(r.size.field,e):0,s=r.color?Gg(r.color.field,e):0,n=r.opacity?Gg(r.opacity.field,e):0;return Ht(i,s,n,0)}get draped(){return this._draped}ensureDrapedStatus(e){return this._draped==null?(this._draped=e,!0):(e!==this.draped&&Ix.warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}test(){const e=()=>{var r,i,s,n,o,a,l,c,h,p,f,m;return{size:((s=(i=(r=this._fastUpdates)==null?void 0:r.visualVariables)==null?void 0:i.size)==null?void 0:s.field)??null,color:((a=(o=(n=this._fastUpdates)==null?void 0:n.visualVariables)==null?void 0:o.color)==null?void 0:a.field)??null,opacity:((h=(c=(l=this._fastUpdates)==null?void 0:l.visualVariables)==null?void 0:c.opacity)==null?void 0:h.field)??null,rotation:((m=(f=(p=this._fastUpdates)==null?void 0:p.visualVariables)==null?void 0:f.rotation)==null?void 0:m.field)??null}};return{drivenProperties:this._drivenProperties,getVisVarFields:e}}};function Gg(t,e){const r=t!=null?e.attributes[t]:0;return r!=null&&isFinite(r)?r:0}function cne(t){const e={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};return t&&"visualVariables"in t&&t.visualVariables&&t.visualVariables.forEach(r=>{switch(r.type){case"color":if(e.color=!0,r.stops)for(let i=0;i<r.stops.length;i++){const s=r.stops[i].color;s&&(e.opacity=!0,s.a<1&&(e.opacityAlwaysOpaque=!1))}break;case"opacity":e.opacity=!0,e.opacityAlwaysOpaque=!1;break;case"size":e.size=!0}}),e}const Bit={mode:"on-the-ground",offset:0,unit:"meters"},zit={mode:"absolute-height",offset:0,unit:"meters"},une={hasIntrinsicColor:!1};let Ty=class extends RM{get geometries(){return this._geometries}get transformation(){return this._transformation}set transformation(e){Fn(this._transformation,e),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}constructor(e={}){super(),this.type=$s.Object,this._geometries=new Array,this._transformation=Ie(),this._bvObjectSpace=new hne,this._bvWorldSpace=new hne,this._bvDirty=!0,this._hasVolatileTransformation=!1,this._visible=!0,this.castShadow=e.castShadow==null||e.castShadow,this.metadata=e.metadata,this.metadata&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new cTe);const r=e.geometries;v(r)&&(this._geometries=Array.from(r))}dispose(){this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(e){ft(this._parentLayer==null||e==null,"Object3D can only be added to a single Layer"),this._parentLayer=e}addGeometry(e){e.visible=this._visible,this._geometries.push(e),this._hasVolatileTransformation=this._hasVolatileTransformation||e.hasVolatileTransformation,this._emit("objectGeometryAdded",{object:this,geometry:e}),this._invalidateBoundingVolume()}removeGeometry(e){const r=this._geometries.splice(e,1)[0];r&&(this._emit("objectGeometryRemoved",{object:this,geometry:r}),this._invalidateBoundingVolume())}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttrsUpdated(e){this._emit("objectGeometryUpdated",{object:this,geometry:e}),this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(e){if(this._visible!==e){this._visible=e;for(const r of this._geometries)r.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const e=new nF(ry.MaskOccludee);for(const r of this._geometries)r.occludees=dj(r.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(const r of this._geometries)r.occludees=pj(r.occludees,e);this._emit("occlusionChanged",this)}highlight(){const e=new nF(ry.Highlight);for(const r of this._geometries)r.highlights=dj(r.highlights,e);return this._emit("highlightChanged",this),e}removeHighlight(e){for(const r of this._geometries)r.highlights=pj(r.highlights,e);this._emit("highlightChanged",this)}getCombinedStaticTransformation(e,r){return gs(r,this.transformation,e.transformation)}_getCombinedShaderTransformation(e){return gs(Ie(),this.transformation,e.shaderTransformation)}hasVolativeTransformation(){return this._hasVolatileTransformation}get boundingVolumeWorldSpace(){return this._validateBoundingVolume(),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._validateBoundingVolume(),this._bvObjectSpace}_validateBoundingVolume(){if(!this._bvDirty&&!this._hasVolatileTransformation)return;this._bvObjectSpace.init(),this._bvWorldSpace.init();for(const s of this._geometries){const n=s.boundingInfo;v(n)&&(dne(n,this._bvObjectSpace,s.shaderTransformation),dne(n,this._bvWorldSpace,this._getCombinedShaderTransformation(s)))}Ys(this._bvObjectSpace.bounds,this._bvObjectSpace.min,this._bvObjectSpace.max,.5),Ys(this._bvWorldSpace.bounds,this._bvWorldSpace.min,this._bvWorldSpace.max,.5);const e=M(),r=M(),i=bw(this.transformation);for(const s of this._geometries){const n=s.boundingInfo;if(C(n))continue;const o=s.shaderTransformation,a=bw(o);We(e,n.center,o);const l=xi(e,this._bvObjectSpace.bounds),c=n.radius*a;this._bvObjectSpace.bounds[3]=Math.max(this._bvObjectSpace.bounds[3],l+c),We(r,e,this.transformation);const h=xi(r,this._bvWorldSpace.bounds),p=c*i;this._bvWorldSpace.bounds[3]=Math.max(this._bvWorldSpace.bounds[3],h+p)}this._bvDirty=!1}_invalidateBoundingVolume(){this._bvDirty=!0,v(this._parentLayer)&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace.bounds)}_emit(e,r){v(this._parentLayer)&&this._parentLayer.events.emit(e,r)}get test(){const e=this;return{hasGeometry:r=>e._geometries.includes(r),getGeometryIndex:r=>e._geometries.indexOf(r)}}},cTe=class{constructor(){this.min=$e(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=$e(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}},hne=class extends cTe{constructor(){super(...arguments),this.bounds=on()}init(){ce(this.min,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),ce(this.max,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),sme(this.bounds)}};function dne(t,e,r){const i=t.bbMin,s=t.bbMax;if(D4(r)){const n=ce(Git,r[12],r[13],r[14]);fe(qc,i,n),fe(ad,s,n);for(let o=0;o<3;++o)e.min[o]=Math.min(e.min[o],qc[o]),e.max[o]=Math.max(e.max[o],ad[o])}else if(We(qc,i,r),Ya(i,s))for(let n=0;n<3;++n)e.min[n]=Math.min(e.min[n],qc[n]),e.max[n]=Math.max(e.max[n],qc[n]);else{We(ad,s,r);for(let n=0;n<3;++n)e.min[n]=Math.min(e.min[n],qc[n],ad[n]),e.max[n]=Math.max(e.max[n],qc[n],ad[n]);for(let n=0;n<3;++n){le(qc,i),le(ad,s),qc[n]=s[n],ad[n]=i[n],We(qc,qc,r),We(ad,ad,r);for(let o=0;o<3;++o)e.min[o]=Math.min(e.min[o],qc[o],ad[o]),e.max[o]=Math.max(e.max[o],qc[o],ad[o])}}}const Git=M(),qc=M(),ad=M();function MZ(t,e,r,i,s,n){const o=t.clippingExtent;if(Jo(e,M_,t.elevationProvider.spatialReference),v(o)&&!iW(o,M_))return null;Jo(e,M_,t.renderCoordsHelper.spatialReference);const a=t.localOriginFactory.getOrigin(M_),l=new Ty({castShadow:!1,metadata:{layerUid:t.layer.uid,graphicUid:s,usesVerticalDistanceToGround:!0}});return r.shaderTransformer=n,r.localOrigin=a,l.addGeometry(r),{object:l,sampledElevation:hit(l,e,t.elevationProvider,t.renderCoordsHelper,i)}}function EO(t,e,r){const i=t.elevationContext,s=r.spatialReference;Jo(e,M_,s),i.centerPointInElevationSR=xy(M_[0],M_[1],e.hasZ?M_[2]:0,v(s)?s:null)}function CO(t){switch(t.type){case"point":return t;case"polygon":case"extent":return xZ(t);case"polyline":{const e=t.paths[0];if(!e||e.length===0)return null;const r=hde(e,ude(e)/2);return xy(r[0],r[1],r[2],t.spatialReference)}case"mesh":return t.origin}return null}const M_=M();function PZ(){return new Float32Array(2)}function jit(t){const e=new Float32Array(2);return e[0]=t[0],e[1]=t[1],e}function xh(t,e){const r=new Float32Array(2);return r[0]=t,r[1]=e,r}function Hit(t,e){return new Float32Array(t,e,2)}function uTe(){return PZ()}function hTe(){return xh(1,1)}function dTe(){return xh(1,0)}function pTe(){return xh(0,1)}const fTe=uTe(),mTe=hTe(),qit=dTe(),Wit=pTe();Object.freeze(Object.defineProperty({__proto__:null,ONES:mTe,UNIT_X:qit,UNIT_Y:Wit,ZEROS:fTe,clone:jit,create:PZ,createView:Hit,fromValues:xh,ones:hTe,unitX:dTe,unitY:pTe,zeros:uTe},Symbol.toStringTag,{value:"Module"}));function Xit(t){const e=new Dr;e.include(IY),e.include(Xwe,t),e.include(Xs,t),e.attributes.add(A.UV0,"vec2");const{vertex:r,fragment:i}=e;return r.uniforms.add([new pr("viewport",(s,n)=>n.camera.fullViewport),new Pe("lineSize",(s,n)=>Math.ceil(s.size)*n.camera.pixelRatio),new kr("pixelToNDC",(s,n)=>or(fne,2/n.camera.fullViewport[2],2/n.camera.fullViewport[3])),new Pe("borderSize",(s,n)=>v(s.borderColor)?n.camera.pixelRatio:0),new kr("screenOffset",(s,n)=>or(fne,s.screenOffset[0]*n.camera.pixelRatio,s.screenOffset[1]*n.camera.pixelRatio))]),e.varyings.add("coverageSampling","vec4"),e.varyings.add("lineSizes","vec2"),t.hasMultipassGeometry&&e.varyings.add("depth","float"),t.hasScreenSizePerspective&&k5(r),r.code.add(w`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 endPoint = projectPositionHUD(projectAux);

      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
    ${t.occlusionTestEnabled?w`
      if (!testVisibilityHUD(endPoint)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }`:""}

    ${t.hasScreenSizePerspective?w`
      vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
      vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);
        `:w`
      vec2 screenOffsetScaled = screenOffset;
        `}
      // Add view dependent polygon offset to get exact same original starting point. This is mostly
      // used to get the correct depth value
      vec3 posView = (view * vec4(position, 1.0)).xyz;
      ${t.hasMultipassGeometry?"depth = posView.z;":""}

      applyHUDViewDependentPolygonOffset(auxpos1.w, projectAux.absCosAngle, posView);
      vec4 startPoint = proj * vec4(posView, 1.0);
      // Apply screen offset to both start and end point
      vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
      startPoint.xy += screenOffsetNorm * startPoint.w;
      endPoint.xy += screenOffsetNorm * endPoint.w;
      // Align start and end to pixel origin
      vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
      vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${t.depthHudEnabled?t.depthHudAlignStartEnabled?w`endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);`:w`startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);`:""}
      vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);
      // The direction of the line in screen space
      vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${t.hasScreenSizePerspective?w`
      float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
      float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);
        `:w`
      float lineSizeScaled = lineSize;
      float borderSizeScaled = borderSize;
        `}
      float halfPixelSize = lineSizeScaled * 0.5;
      // Calculate a pixel offset from the edge of the pixel, s.t. we keep the line aligned
      // to pixels if it has a full pixel size. Since pixel aligned biases to the bottom-left,
      // we bias the size to the right (for odd sizes) to balance out the bias. Grow sub-pixel
      // sizes towards the left or right s.t. there is a smooth transition (e.g. from 2 to 3 px).
      float halfWholePixelSize = floor(lineSizeScaled) * 0.5;
      float halfPixelSizeInt = floor(halfWholePixelSize);

      // Sub-pixel offset if we need to grow sub-pixels to the left
      float subpixelOffset = -fract(lineSizeScaled) * float(halfWholePixelSize > 0.0);

      // Pixel offset aligning to whole pixels and adding subpixel offset if needed
      float pixelOffset = -halfPixelSizeInt + subpixelOffset;

      // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
      float padding = 1.0 + borderSizeScaled;
      vec2 ndcOffset = (pixelOffset - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

      // Offset x/y from the center of the line in screen space
      projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

      // Compute a coverage varying which we can use in the fragment shader to determine
      // how much a pixel is actually covered by the line (i.e. to anti alias the line).
      // This works by computing two coordinates that can be linearly interpolated and then
      // subtracted to find out how far away from the line edge we are.
      float edgeDirection = (uv0.x * 2.0 - 1.0);

      float halfBorderSize = 0.5 * borderSizeScaled;
      float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
      float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

      float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

      coverageSampling = vec4(
        // Edge coordinate
        outerEdgeCoverageSampler,

        // Border edge coordinate
        outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

        // Line offset
        halfPixelSize - 0.5,

        // Border offset
        halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
      );

      lineSizes = vec2(lineSizeScaled, borderSizeScaled);

      gl_Position = projectedPosition;
    }
  `),i.uniforms.add([new pr("uColor",s=>pne(s.color)),new pr("borderColor",s=>pne(s.borderColor))]),t.hasMultipassGeometry&&(i.include(b1e,t),i.uniforms.add(new kr("inverseViewport",(s,n)=>n.inverseViewport))),i.code.add(w`
    void main() {
      ${t.hasMultipassGeometry?"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }":""}

      // Mix between line and border coverage offsets depending on whether we need
      // a border (based on the sidedness).
      vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

      // Mix between border and line color based on the line coverage (conceptually the line
      // blends on top of the border background).
      //
      // Anti-alias by blending final result using the full (including optional border) coverage
      // and the color alpha
      float borderAlpha = uColor.a * borderColor.a * coverage.y;
      float colorAlpha = uColor.a * coverage.x;

      float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);

    ${t.depthHudEnabled?w`
      if (finalAlpha < 0.01) {
        discard;
      }
      `:w`
      vec3 finalRgb = mix(borderColor.rgb * borderAlpha, uColor.rgb, colorAlpha);
      gl_FragColor = vec4(finalRgb, finalAlpha);
      `}
  }
  `),e}function pne(t){return v(t)?t:qf}const fne=Je(),Yit=Object.freeze(Object.defineProperty({__proto__:null,build:Xit},Symbol.toStringTag,{value:"Module"}));let gTe=class yTe extends Vr{initializeConfiguration(e,r){r.spherical=e.viewingMode===Be.Global}initializeProgram(e){return new Fr(e.rctx,yTe.shader.get().build(this.configuration),Rr)}setPipelineState(e){const r=e?Mi.ALWAYS:Mi.LESS;return this.configuration.depthHudEnabled?Bt({depthTest:{func:r},depthWrite:Xl}):Bt({blending:kn(Ee.ONE,Ee.SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),depthTest:{func:r},colorWrite:Kt})}initializePipeline(){return this.setPipelineState(this.configuration.hasMultipassGeometry)}};gTe.shader=new Nr(Yit,()=>te(()=>import("./LineCallout.glsl-fd301efc.js"),[]));let ch=class extends eo{constructor(){super(...arguments),this.screenCenterOffsetUnitsEnabled=kl.World,this.spherical=!1,this.occlusionTestEnabled=!0,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.depthHudEnabled=!1,this.depthHudAlignStartEnabled=!1,this.hasSlicePlane=!1,this.hasMultipassGeometry=!1}};u([V({count:kl.COUNT})],ch.prototype,"screenCenterOffsetUnitsEnabled",void 0),u([V()],ch.prototype,"spherical",void 0),u([V()],ch.prototype,"occlusionTestEnabled",void 0),u([V()],ch.prototype,"hasVerticalOffset",void 0),u([V()],ch.prototype,"hasScreenSizePerspective",void 0),u([V()],ch.prototype,"depthHudEnabled",void 0),u([V()],ch.prototype,"depthHudAlignStartEnabled",void 0),u([V()],ch.prototype,"hasSlicePlane",void 0),u([V()],ch.prototype,"hasMultipassGeometry",void 0),u([V({constValue:!0})],ch.prototype,"hasSliceInVertexProgram",void 0),u([V({constValue:!1})],ch.prototype,"isDraped",void 0);let PI=class Uj extends wv{get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}constructor(e){super(e,new _Te),this._configuration=new ch,this._uniqueMaterialIdentifier=Uj.uniqueMaterialIdentifier(this.parameters)}getPassParameters(){return this.parameters}getConfiguration(e,r){const i=(r==null?void 0:r.slot)!==Se.LINE_CALLOUTS;return this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.hasVerticalOffset=v(this.parameters.verticalOffset),this._configuration.hasScreenSizePerspective=v(this.parameters.screenSizePerspective),this._configuration.depthHudEnabled=i,this._configuration.depthHudAlignStartEnabled=!!this.parameters.depthHUDAlignStart,this._configuration.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen"?kl.Screen:kl.World,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasMultipassGeometry=r.multipassGeometry.enabled,this._configuration}intersect(){}requiresSlot(e,r){if(r===k.Color)switch(e){case Se.LINE_CALLOUTS:case Se.LINE_CALLOUTS_HUD_DEPTH:return!0}return!1}createGLMaterial(e){return new Zit(e)}createBufferWriter(){return new Kit}validateParameters(e){const r=Uj.uniqueMaterialIdentifier(e);r!==this._uniqueMaterialIdentifier&&(this._uniqueMaterialIdentifier=r)}static uniqueMaterialIdentifier(e){return JSON.stringify({screenOffset:e.screenOffset||[0,0],centerOffsetUnits:e.centerOffsetUnits||"world"})}},Zit=class extends bv{beginSlot(e){return this.ensureTechnique(gTe,e)}},_Te=class extends qE{constructor(){super(...arguments),this.screenOffset=Wl,this.color=[0,0,0,1],this.size=1,this.occlusionTest=!1,this.shaderPolygonOffset=1e-5,this.depthHUDAlignStart=!1,this.centerOffsetUnits="world",this.hasSlicePlane=!1}};const Jit=ts().vec3f(A.POSITION).vec3f(A.NORMAL).vec2f(A.UV0).vec4f(A.AUXPOS1),mne=[xh(0,0),xh(1,0),xh(0,1),xh(1,0),xh(1,1),xh(0,1)];let Kit=class{constructor(){this.vertexBufferLayout=Jit}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 6*e.indices.get(A.POSITION).length}write(e,r,i,s,n){V5(i.indices.get(A.POSITION),i.vertexAttributes.get(A.POSITION).data,e,s.position,n,6),pZ(i.indices.get(A.NORMAL),i.vertexAttributes.get(A.NORMAL).data,r,s.normal,n,6),oE(i.indices.get(A.AUXPOS1),i.vertexAttributes.get(A.AUXPOS1).data,s.auxpos1,n,6);for(let o=0;o<mne.length;++o)s.uv0.setVec(n+o,mne[o])}},vTe=class bTe extends Tm{constructor(e,r){super(e,null,r,tst),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._material=new PI(this._materialParameters),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}_perInstanceMaterialParameters(e){const r=this._materialParameters;return r.screenOffset=e.screenOffset||Wl,r.centerOffsetUnits=e.centerOffsetUnits||"world",r}get _materialParameters(){const e=new _Te,r=this.symbol,i=r.callout;if(e.color=v(i.color)?Ze.toUnitRGBA(i.color):[0,0,0,0],e.color[3]*=this._getLayerOpacity(),e.size=Ao(i.size||0),r.verticalOffset){const{screenLength:o,minWorldLength:a,maxWorldLength:l}=r.verticalOffset;e.verticalOffset={screenLength:Ao(o),minWorldLength:a||0,maxWorldLength:v(l)?l:1/0}}e.borderColor=v(i.border)&&v(i.border.color)?Ze.toUnitRGBA(i.border.color):null;const s=r.symbolLayers.getItemAt(0).type==="object",n=r.type==="label-3d";return e.occlusionTest=!s,e.shaderPolygonOffset=s?0:void 0,e.depthHUDAlignStart=n,e.hasSlicePlane=this._context.slicePlaneEnabled,e.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,e}_defaultElevationInfoNoZ(){return est}createGraphics3DGraphic(e){const r=e.renderingInfo,i=e.graphic,s=this.setGraphicElevationContext(i,new Cp,r.elevationOffset||0),n=r.symbol,o=this._elevationContext.mode==="on-the-ground"&&(n.type==="cim"||!n.symbolLayers.some(l=>l.type==="object"||l.type==="text"));if(n.type!=="label-3d"&&o||n.type==="point-3d"&&n.symbolLayers.every(l=>l.type==="text"&&!Mpe(l)))return null;const a=xZ(i.geometry);return C(a)?null:this._createAs3DShape(a,s,r,i.uid)}layerOpacityChanged(){v(this._material)&&this._material.setParameters(this._materialParameters)}layerElevationInfoChanged(e,r,i){const s=this._elevationContext.mode,n=LM(bTe.elevationModeChangeTypes,i,s);return n!==ys.UPDATE||e.forEach(o=>{const a=r(o);v(a)&&this.updateGraphicElevationContext(o.graphic,a)}),n}slicePlaneEnabledChanged(){return C(this._material)||this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}setGraphicElevationContext(e,r,i=0){const s=super.setGraphicElevationContext(e,r);return s.addOffsetRenderUnits(i),s}updateGraphicElevationContext(e,r){this.setGraphicElevationContext(e,r.elevationContext,v(r.metadata)?r.metadata.elevationOffset:0),r.needsElevationUpdates=Xh(r.elevationContext.mode)}computeComplexity(){return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:RZ.memory}}_createVertexData(e){const{translation:r,centerOffset:i}=e,s=new Xe(r?[r[0],r[1],r[2]]:[0,0,0],3,!0),n=new Xe(i?[i[0],i[1],i[2],i[3]]:[0,0,0,1],4,!0);return[[A.POSITION,s],[A.NORMAL,new Xe([0,0,1],3,!0)],[A.AUXPOS1,n]]}_getOrCreateMaterial(e){const r=this._perInstanceMaterialParameters(e),i=PI.uniqueMaterialIdentifier(r);if(v(this._material)&&i===this._material.uniqueMaterialIdentifier)return{material:this._material,isUnique:!1};if(v(e.materialCollection)){let s=e.materialCollection.get(i);return C(s)&&(s=new PI(r),e.materialCollection.add(i,s)),{material:s,isUnique:!1}}return{material:new PI(r),isUnique:!0}}_createAs3DShape(e,r,i,s){const n=this._context.layer.uid,o=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:s,layerUid:n}),a=this._getOrCreateMaterial(i),l=new nn(a.material,this._createVertexData(i),Qit,null,$s.Point,o),c=MZ(this._context,e,l,r,s);if(C(c))return null;const h=new xm(this,c.object,[l],a.isUnique?[a.material]:null,null,SO,r);return h.metadata=new eTe(i.elevationOffset),h.alignedSampledElevation=c.sampledElevation,h.needsElevationUpdates=Xh(r.mode),EO(h,e,this._context.elevationProvider),h}};vTe.elevationModeChangeTypes={definedChanged:ys.UPDATE,staysOnTheGround:ys.UPDATE,onTheGroundChanged:ys.RECREATE};const s9=[0],Qit=[[A.POSITION,s9],[A.NORMAL,s9],[A.AUXPOS1,s9]],est={mode:"relative-to-ground",offset:0},tst={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};let rst=class{constructor(e,r,i=M(),s=sr(),n=Je(),o="world",a=0,l=null){this.renderer=e,this.symbol=r,this.translation=i,this.centerOffset=s,this.screenOffset=n,this.centerOffsetUnits=o,this.elevationOffset=a,this.materialCollection=l}},ist=class extends Ait{};const gne=se.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function sst(t,e){if(!hW(t))return gne.error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${t.type}' does not support callouts`),null;if(!t.callout)return null;const r=nst[t.callout.type];return r?new r(t,e):(gne.error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${t.callout.type}`),null)}const nst={line:vTe},yne=new Co(Array,t=>T4(t,gpe),null,10,5),ost=ur();let ast=class{get labelLayers(){return this._labelLayers}get extent(){return this._extent}constructor(e,r,i,s,n){this.graphic=e,this.graphics3DSymbol=r,this.layers=i,this._labelLayers=new Array,this._auxiliaryLayers=new Array,this._visibilityFlags=lst(So._COUNT,Ec._COUNT),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++r.referenced,this._featureExpressionFeature=n?Zxe(n,e,s):null;for(const o of i)v(o)&&(this.isElevationSource=this.isElevationSource||o.isElevationSource)}initialize(e,r){this._layer=r,this._stage=e,this._forEachSymbolLayerGraphic(i=>{i.initialize(e,r),i.setVisibility(this.isVisible())})}destroy(){this._forEachSymbolLayerGraphic(e=>e.destroy()),this.layers=null,this._auxiliaryLayers=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return this.layers==null}clearLabelGraphics(){this._forEachLabelGraphic(e=>e.destroy()),this._labelLayers.length=0}addLabelGraphic(e,r,i){this._labelLayers.push(e),e.initialize(r,i),e.setVisibility(this.isVisible(So.LABEL))}addAuxiliaryGraphic(e){this._auxiliaryLayers.push(e),this._layer&&(e.initialize(this._stage,this._layer),e.setVisibility(this.isVisible()))}get isDraped(){let e=!1;return this._forEachSymbolLayerGraphic(r=>{r.type==="draped"&&(e=!0)}),e}isVisible(e=So.GRAPHIC,r){for(let i=0;i<=e;i++){const s=this._visibilityFlags[i];for(let n=0;n<s.length;++n)if(s[n]===!1&&n!==r)return!1}return!0}hasVisibilityFlag(e,r){return this._visibilityFlags[r][e]!=null}setVisibilityFlag(e,r,i){const s=this.isVisible(i);this._visibilityFlags[i][e]=r;const n=this.isVisible(i);if(s===n)return!1;if(i===So.LABEL)this._forEachLabelGraphic(o=>o.setVisibility(n));else{this._forEachSymbolLayerGraphic(a=>a.setVisibility(n));const o=this.isVisible(So.LABEL);this._forEachLabelGraphic(a=>a.setVisibility(o))}return!0}clearVisibilityFlag(e,r=So.GRAPHIC){return this.setVisibilityFlag(e,void 0,r)}computeExtent(e){if(!this._extent){const r=this.graphic.geometry;if(C(r))return!1;this._extent=ur(),Qrt(r,this._extent);const i=r.spatialReference;if(!Tn(i,e)&&!N4(this._extent,i,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,r){return v(this._optimizedGeometry.geometry)&&this._optimizedGeometry.hasZ===e&&this._optimizedGeometry.hasM===r||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,r),this._optimizedGeometry.hasZ=e,this._optimizedGeometry.hasM=r),this._optimizedGeometry.geometry}_convertGraphicToOptimizedGeometry(e,r,i){let s=e.geometry;return s.type!=="mesh"&&s.type!=="extent"||(s=pp.fromExtent(s.type==="mesh"?s.extent:s)),o9e(s,r,i)}get usedMemory(){let e=Ife(this.graphic.attributes);return this._forEachSymbolLayerGraphic(r=>{const i=r.graphics3DSymbolLayer.complexity;if(C(i))return;const s=r.type==="draped"?i.memory.draped:i.memory;e+=s.bytesPerFeature,s.bytesPerCoordinate&&(e+=Krt(this.graphic.geometry)*s.bytesPerCoordinate)}),e}computeAttachmentOrigin(){const e={render:{origin:M(),num:0},draped:{origin:Je(),num:0}};for(const r of this.layers)C(r)||r.computeAttachmentOrigin(e);return e.render.num>1&&ae(e.render.origin,e.render.origin,1/e.render.num),e.draped.num>1&&Sc(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(e,r,i,s,n){return n||(n={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),n.boundingBox?Ri(n.boundingBox):n.boundingBox=Ri(),n.requiresDrapedElevation=!1,await l4(this.layers,async o=>{if(C(o))return;const a=o.type==="draped"?r:e,l=yne.acquire(),c=await o.getProjectedBoundingBox(a,i,n.screenSpaceObjects,s,l);isFinite(c[2])&&isFinite(c[5])||(n.requiresDrapedElevation=!0),c&&IS(n.boundingBox,l),yne.release(l)}),x$e(n.boundingBox)||nB(sW(n.boundingBox,ost))?n:null}needsElevationUpdates(){for(const e of this.layers)if(v(e)&&(e.type==="object3d"||e.type==="lod-instance")&&e.needsElevationUpdates)return!0;for(const e of this._labelLayers)if(e&&e.needsElevationUpdates)return!0;return!1}alignWithElevation(e,r,i){this._forEachRenderedGraphic(s=>{s.type!=="object3d"&&s.type!=="lod-instance"||s.alignWithElevation(e,r,this._featureExpressionFeature,i)})}alignWithAbsoluteElevation(e,r,i){this._forEachRenderedGraphic(s=>{s.type==="object3d"&&s.alignWithAbsoluteElevation(e,r,i)})}addObjectStateSet(e,r){this._forEachSymbolLayerGraphic(i=>i.addObjectState(e,r))}removeObjectState(e){this._forEachSymbolLayerGraphic(r=>r.removeObjectState(e))}_forEachGraphicList(e,r){e.forEach(i=>i&&r(i))}_forEachSymbolLayerGraphic(e){this._forEachGraphicList(this.layers,e),this._forEachGraphicList(this._auxiliaryLayers,e)}_forEachLabelGraphic(e){this._forEachGraphicList(this._labelLayers,e)}_forEachRenderedGraphic(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)}};function lst(t,e){const r=new Array(t);for(let i=0;i<r.length;i++)r[i]=new Array(e);return r}var _ne,vne,bne,cv={},cst={get exports(){return cv},set exports(t){cv=t}};_ne=cst,vne=function(){function t($,N,F){F=F||2;var j,X,J,W,ue,pe,we,Ce=N&&N.length,Ge=Ce?N[0]*F:$.length,Le=e($,0,Ge,F,!0),xe=[];if(!Le||Le.next===Le.prev)return xe;if(Ce&&(Le=l($,N,Le,F)),$.length>80*F){j=J=$[0],X=W=$[1];for(var De=F;De<Ge;De+=F)(ue=$[De])<j&&(j=ue),(pe=$[De+1])<X&&(X=pe),ue>J&&(J=ue),pe>W&&(W=pe);we=(we=Math.max(J-j,W-X))!==0?1/we:0}return i(Le,xe,F,j,X,we),xe}function e($,N,F,j,X){var J,W;if(X===H($,N,F,j)>0)for(J=N;J<F;J+=j)W=K(J,$[J],$[J+1],W);else for(J=F-j;J>=N;J-=j)W=K(J,$[J],$[J+1],W);if(W&&O(W,W.next)){var ue=W.next;ee(W),W=ue}return W}function r($,N){if(!$)return $;N||(N=$);var F,j=$;do if(F=!1,j.steiner||!O(j,j.next)&&E(j.prev,j,j.next)!==0)j=j.next;else{var X=j.prev;if(ee(j),(j=N=X)===j.next)break;F=!0}while(F||j!==N);return N}function i($,N,F,j,X,J,W){if($){!W&&J&&y($,j,X,J);for(var ue,pe,we=$;$.prev!==$.next;)if(ue=$.prev,pe=$.next,J?n($,j,X,J):s($))N.push(ue.i/F),N.push($.i/F),N.push(pe.i/F),ee($),$=pe.next,we=pe.next;else if(($=pe)===we){W?W===1?i($=o(r($),N,F),N,F,j,X,J,2):W===2&&a($,N,F,j,X,J):i(r($),N,F,j,X,J,1);break}}}function s($){var N=$.prev,F=$,j=$.next;if(E(N,F,j)>=0)return!1;for(var X=$.next.next;X!==$.prev;){if(T(N.x,N.y,F.x,F.y,j.x,j.y,X.x,X.y)&&E(X.prev,X,X.next)>=0)return!1;X=X.next}return!0}function n($,N,F,j){var X=$.prev,J=$,W=$.next;if(E(X,J,W)>=0)return!1;for(var ue=X.x<J.x?X.x<W.x?X.x:W.x:J.x<W.x?J.x:W.x,pe=X.y<J.y?X.y<W.y?X.y:W.y:J.y<W.y?J.y:W.y,we=X.x>J.x?X.x>W.x?X.x:W.x:J.x>W.x?J.x:W.x,Ce=X.y>J.y?X.y>W.y?X.y:W.y:J.y>W.y?J.y:W.y,Ge=b(ue,pe,N,F,j),Le=b(we,Ce,N,F,j),xe=$.prevZ,De=$.nextZ;xe&&xe.z>=Ge&&De&&De.z<=Le;){if(xe!==$.prev&&xe!==$.next&&T(X.x,X.y,J.x,J.y,W.x,W.y,xe.x,xe.y)&&E(xe.prev,xe,xe.next)>=0||(xe=xe.prevZ,De!==$.prev&&De!==$.next&&T(X.x,X.y,J.x,J.y,W.x,W.y,De.x,De.y)&&E(De.prev,De,De.next)>=0))return!1;De=De.nextZ}for(;xe&&xe.z>=Ge;){if(xe!==$.prev&&xe!==$.next&&T(X.x,X.y,J.x,J.y,W.x,W.y,xe.x,xe.y)&&E(xe.prev,xe,xe.next)>=0)return!1;xe=xe.prevZ}for(;De&&De.z<=Le;){if(De!==$.prev&&De!==$.next&&T(X.x,X.y,J.x,J.y,W.x,W.y,De.x,De.y)&&E(De.prev,De,De.next)>=0)return!1;De=De.nextZ}return!0}function o($,N,F){var j=$;do{var X=j.prev,J=j.next.next;!O(X,J)&&R(X,j,j.next,J)&&B(X,J)&&B(J,X)&&(N.push(X.i/F),N.push(j.i/F),N.push(J.i/F),ee(j),ee(j.next),j=$=J),j=j.next}while(j!==$);return r(j)}function a($,N,F,j,X,J){var W=$;do{for(var ue=W.next.next;ue!==W.prev;){if(W.i!==ue.i&&S(W,ue)){var pe=G(W,ue);return W=r(W,W.next),pe=r(pe,pe.next),i(W,N,F,j,X,J),void i(pe,N,F,j,X,J)}ue=ue.next}W=W.next}while(W!==$)}function l($,N,F,j){var X,J,W,ue=[];for(X=0,J=N.length;X<J;X++)(W=e($,N[X]*j,X<J-1?N[X+1]*j:$.length,j,!1))===W.next&&(W.steiner=!0),ue.push(x(W));for(ue.sort(c),X=0;X<ue.length;X++)F=r(F=p(ue[X],F),F.next);return F}function c($,N){return $.x-N.x}function h($){if($.next.prev===$)return $;let N=$;for(;;){const F=N.next;if(F.prev===N||F===N||F===$)break;N=F}return N}function p($,N){var F=f($,N);if(!F)return N;var j=G(F,$),X=r(F,F.next);let J=h(j);return r(J,J.next),X=h(X),h(N===F?X:N)}function f($,N){var F,j=N,X=$.x,J=$.y,W=-1/0;do{if(J<=j.y&&J>=j.next.y&&j.next.y!==j.y){var ue=j.x+(J-j.y)*(j.next.x-j.x)/(j.next.y-j.y);if(ue<=X&&ue>W){if(W=ue,ue===X){if(J===j.y)return j;if(J===j.next.y)return j.next}F=j.x<j.next.x?j:j.next}}j=j.next}while(j!==N);if(!F)return null;if(X===W)return F;var pe,we=F,Ce=F.x,Ge=F.y,Le=1/0;j=F;do X>=j.x&&j.x>=Ce&&X!==j.x&&T(J<Ge?X:W,J,Ce,Ge,J<Ge?W:X,J,j.x,j.y)&&(pe=Math.abs(J-j.y)/(X-j.x),B(j,$)&&(pe<Le||pe===Le&&(j.x>F.x||j.x===F.x&&m(F,j)))&&(F=j,Le=pe)),j=j.next;while(j!==we);return F}function m($,N){return E($.prev,$,N.prev)<0&&E(N.next,$,$.next)<0}function y($,N,F,j){var X=$;do X.z===null&&(X.z=b(X.x,X.y,N,F,j)),X.prevZ=X.prev,X.nextZ=X.next,X=X.next;while(X!==$);X.prevZ.nextZ=null,X.prevZ=null,_(X)}function _($){var N,F,j,X,J,W,ue,pe,we=1;do{for(F=$,$=null,J=null,W=0;F;){for(W++,j=F,ue=0,N=0;N<we&&(ue++,j=j.nextZ);N++);for(pe=we;ue>0||pe>0&&j;)ue!==0&&(pe===0||!j||F.z<=j.z)?(X=F,F=F.nextZ,ue--):(X=j,j=j.nextZ,pe--),J?J.nextZ=X:$=X,X.prevZ=J,J=X;F=j}J.nextZ=null,we*=2}while(W>1);return $}function b($,N,F,j,X){return($=1431655765&(($=858993459&(($=252645135&(($=16711935&(($=32767*($-F)*X)|$<<8))|$<<4))|$<<2))|$<<1))|(N=1431655765&((N=858993459&((N=252645135&((N=16711935&((N=32767*(N-j)*X)|N<<8))|N<<4))|N<<2))|N<<1))<<1}function x($){var N=$,F=$;do(N.x<F.x||N.x===F.x&&N.y<F.y)&&(F=N),N=N.next;while(N!==$);return F}function T($,N,F,j,X,J,W,ue){return(X-W)*(N-ue)-($-W)*(J-ue)>=0&&($-W)*(j-ue)-(F-W)*(N-ue)>=0&&(F-W)*(J-ue)-(X-W)*(j-ue)>=0}function S($,N){return $.next.i!==N.i&&$.prev.i!==N.i&&!U($,N)&&(B($,N)&&B(N,$)&&z($,N)&&(E($.prev,$,N.prev)||E($,N.prev,N))||O($,N)&&E($.prev,$,$.next)>0&&E(N.prev,N,N.next)>0)}function E($,N,F){return(N.y-$.y)*(F.x-N.x)-(N.x-$.x)*(F.y-N.y)}function O($,N){return $.x===N.x&&$.y===N.y}function R($,N,F,j){var X=P(E($,N,F)),J=P(E($,N,j)),W=P(E(F,j,$)),ue=P(E(F,j,N));return X!==J&&W!==ue||!(X!==0||!L($,F,N))||!(J!==0||!L($,j,N))||!(W!==0||!L(F,$,j))||!(ue!==0||!L(F,N,j))}function L($,N,F){return N.x<=Math.max($.x,F.x)&&N.x>=Math.min($.x,F.x)&&N.y<=Math.max($.y,F.y)&&N.y>=Math.min($.y,F.y)}function P($){return $>0?1:$<0?-1:0}function U($,N){var F=$;do{if(F.i!==$.i&&F.next.i!==$.i&&F.i!==N.i&&F.next.i!==N.i&&R(F,F.next,$,N))return!0;F=F.next}while(F!==$);return!1}function B($,N){return E($.prev,$,$.next)<0?E($,N,$.next)>=0&&E($,$.prev,N)>=0:E($,N,$.prev)<0||E($,$.next,N)<0}function z($,N){var F=$,j=!1,X=($.x+N.x)/2,J=($.y+N.y)/2;do F.y>J!=F.next.y>J&&F.next.y!==F.y&&X<(F.next.x-F.x)*(J-F.y)/(F.next.y-F.y)+F.x&&(j=!j),F=F.next;while(F!==$);return j}function G($,N){var F=new Q($.i,$.x,$.y),j=new Q(N.i,N.x,N.y),X=$.next,J=N.prev;return $.next=N,N.prev=$,F.next=X,X.prev=F,j.next=F,F.prev=j,J.next=j,j.prev=J,j}function K($,N,F,j){var X=new Q($,N,F);return j?(X.next=j.next,X.prev=j,j.next.prev=X,j.next=X):(X.prev=X,X.next=X),X}function ee($){$.next.prev=$.prev,$.prev.next=$.next,$.prevZ&&($.prevZ.nextZ=$.nextZ),$.nextZ&&($.nextZ.prevZ=$.prevZ)}function Q($,N,F){this.i=$,this.x=N,this.y=F,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function H($,N,F,j){for(var X=0,J=N,W=F-j;J<F;J+=j)X+=($[W]-$[J])*($[J+1]+$[W+1]),W=J;return X}return t.deviation=function($,N,F,j){var X=N&&N.length,J=X?N[0]*F:$.length,W=Math.abs(H($,0,J,F));if(X)for(var ue=0,pe=N.length;ue<pe;ue++){var we=N[ue]*F,Ce=ue<pe-1?N[ue+1]*F:$.length;W-=Math.abs(H($,we,Ce,F))}var Ge=0;for(ue=0;ue<j.length;ue+=3){var Le=j[ue]*F,xe=j[ue+1]*F,De=j[ue+2]*F;Ge+=Math.abs(($[Le]-$[De])*($[xe+1]-$[Le+1])-($[Le]-$[xe])*($[De+1]-$[Le+1]))}return W===0&&Ge===0?0:Math.abs((Ge-W)/W)},t.flatten=function($){for(var N=$[0][0].length,F={vertices:[],holes:[],dimensions:N},j=0,X=0;X<$.length;X++){for(var J=0;J<$[X].length;J++)for(var W=0;W<N;W++)F.vertices.push($[X][J][W]);X>0&&(j+=$[X-1].length,F.holes.push(j))}return F},t},(bne=vne())!==void 0&&(_ne.exports=bne);const X5=se.getLogger("esri.views.3d.support.buffer.math");function NM(t,e,r){if(t.count!==e.count)return void X5.error("source and destination buffers need to have the same number of elements");const i=t.count,s=r[0],n=r[1],o=r[2],a=r[4],l=r[5],c=r[6],h=r[8],p=r[9],f=r[10],m=r[12],y=r[13],_=r[14],b=t.typedBuffer,x=t.typedBufferStride,T=e.typedBuffer,S=e.typedBufferStride;for(let E=0;E<i;E++){const O=E*x,R=E*S,L=T[R],P=T[R+1],U=T[R+2];b[O]=s*L+a*P+h*U+m,b[O+1]=n*L+l*P+p*U+y,b[O+2]=o*L+c*P+f*U+_}}function uv(t,e,r){if(t.count!==e.count)return void X5.error("source and destination buffers need to have the same number of elements");const i=t.count,s=r[0],n=r[1],o=r[2],a=r[3],l=r[4],c=r[5],h=r[6],p=r[7],f=r[8],m=t.typedBuffer,y=t.typedBufferStride,_=e.typedBuffer,b=e.typedBufferStride;for(let x=0;x<i;x++){const T=x*y,S=x*b,E=_[S],O=_[S+1],R=_[S+2];m[T]=s*E+a*O+h*R,m[T+1]=n*E+l*O+p*R,m[T+2]=o*E+c*O+f*R}}function kj(t,e,r){const i=Math.min(t.count,e.count),s=t.typedBuffer,n=t.typedBufferStride,o=e.typedBuffer,a=e.typedBufferStride;for(let l=0;l<i;l++){const c=l*n,h=l*a;s[c]=r*o[h],s[c+1]=r*o[h+1],s[c+2]=r*o[h+2]}}function IZ(t,e){const r=Math.min(t.count,e.count),i=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride;for(let a=0;a<r;a++){const l=a*s,c=a*o,h=n[c],p=n[c+1],f=n[c+2],m=h*h+p*p+f*f;if(m>0){const y=1/Math.sqrt(m);i[l]=y*h,i[l+1]=y*p,i[l+2]=y*f}}}function ust(t,e,r){const i=Math.min(t.count,e.count),s=t.typedBuffer,n=t.typedBufferStride,o=e.typedBuffer,a=e.typedBufferStride;for(let l=0;l<i;l++){const c=l*n,h=l*a;s[c]=o[h]>>r,s[c+1]=o[h+1]>>r,s[c+2]=o[h+2]>>r}}Object.freeze(Object.defineProperty({__proto__:null,normalize:IZ,scale:kj,shiftRight:ust,transformMat3:uv,transformMat4:NM},Symbol.toStringTag,{value:"Module"}));function hst(t,e,r){return{objectId:t,target:e,distance:r,type:"vertex"}}function wne(t,e,r,i,s,n=!1){return{objectId:t,target:e,distance:r,type:"edge",start:i,end:s,draped:n}}function Y5(t,e){if(!t||t.symbol)return null;const r=e&&e.renderer;return t&&v(r)&&r.getObservationRenderer?r.getObservationRenderer(t):r}function dst(t,e){if(v(t.symbol))return t.symbol;const r=Y5(t,e);return v(r)&&r.type!=="dot-density"?r.getSymbol(t,e):null}function POt(t,e){const r=Y5(t,e),i=dst(t,e);if(C(i))return null;const s={renderer:r,symbol:i};if(C(r)||!("visualVariables"in r)||!r.visualVariables)return s;const n=_X(r,t,e)??[],o=["proportional","proportional","proportional"];for(const{variable:a,value:l}of n)switch(a.type){case"color":s.color=l.toRgba();break;case"size":if(a.target==="outline")s.outlineSize=l;else{const c=a.axis,h=a.useSymbolValue?"symbol-value":l;switch(c){case"width":o[0]=h;break;case"depth":o[1]=h;break;case"height":o[2]=h;break;case"width-and-depth":o[0]=o[1]=h;break;default:o[0]=o[1]=o[2]=h}}break;case"opacity":s.opacity=l;break;case"rotation":switch(a.axis){case"tilt":s.tilt=l;break;case"roll":s.roll=l;break;default:s.heading=l}}return o[0]==="proportional"&&o[1]==="proportional"&&o[2]==="proportional"||(s.size=o),s}async function pst(t,e){if(v(t.symbol))return t.symbol;const r=Y5(t,e);return v(r)?r.getSymbolAsync(t,e):null}async function IOt(t,e){const r=Y5(t,e),i=await pst(t,e);if(!i)return null;const s={renderer:r,symbol:i};if(!r||!("visualVariables"in r)||!r.visualVariables)return s;const n=_X(r,t,e)??[],o=["proportional","proportional","proportional"];for(const{variable:a,value:l}of n)if(a.type==="color")s.color=Ze.toUnitRGBA(l);else if(a.type==="size")if(a.target==="outline")s.outlineSize=l;else{const c=a.axis,h=a.useSymbolValue?"symbol-value":l;c==="width"?o[0]=h:c==="depth"?o[1]=h:c==="height"?o[2]=h:o[0]=o[1]=c==="width-and-depth"?h:o[2]=h}else a.type==="opacity"?s.opacity=l:a.type==="rotation"&&a.axis==="tilt"?s.tilt=l:a.type==="rotation"&&a.axis==="roll"?s.roll=l:a.type==="rotation"&&(s.heading=l);return(isFinite(o[0])||isFinite(o[1])||isFinite(o[2]))&&(s.size=o),s}function fst(t,e=0){const r=t[e];return typeof r=="number"&&isFinite(r)?r:null}function mst(t){for(let e=0;e<3;e++){const r=t[e];if(typeof r=="number")return isFinite(r)?r:0}return 0}function xne(t){const e=[[A.POSITION,t.indices]],r=[[A.POSITION,new Xe(t.attributeData.position,3,!0)]];return v(t.attributeData.color)&&(r.push([A.COLOR,new Xe(t.attributeData.color,4,!0)]),e.push([A.COLOR,new Array(t.indices.length).fill(0)])),v(t.attributeData.uvMapSpace)&&(r.push([A.UVMAPSPACE,new Xe(t.attributeData.uvMapSpace,4,!0)]),e.push([A.UVMAPSPACE,t.indices])),v(t.attributeData.boundingRect)&&(r.push([A.BOUNDINGRECT,new Xe(t.attributeData.boundingRect,9,!0)]),e.push([A.BOUNDINGRECT,t.indices])),new nn(t.material,r,e,t.mapPositions,$s.Mesh,t.attributeData.objectAndLayerIdColor)}function Tne(t){const e=[[A.POSITION,t.indices],[A.UV0,t.indices]],r=[[A.POSITION,new Xe(t.attributeData.position,3,!0)],[A.UV0,new Xe(t.attributeData.uv0,2,!0)]];return new nn(t.material,r,e,t.mapPositions)}function AO(t){switch(t.type){case"extent":if(t instanceof Zr)return pp.fromExtent(t);break;case"polygon":return t}return null}let Z5=class{constructor(e,r,i){this.renderData=e,this.layerUid=r,this.graphicUid=i,this.outGeometries=new Array}};function Vj(t,e,r){const i=Array.isArray(t),s=i?t.length/e:t.byteLength/(4*e),n=i?t:new Uint32Array(t,0,s*e),o=(r==null?void 0:r.minReduction)??0,a=(r==null?void 0:r.originalIndices)||null,l=a?a.length:0,c=(r==null?void 0:r.componentOffsets)||null;let h=0;if(c)for(let R=0;R<c.length-1;R++){const L=c[R+1]-c[R];L>h&&(h=L)}else h=s;const p=Math.floor(1.1*h)+1;(Lp==null||Lp.length<2*p)&&(Lp=new Uint32Array(ES(2*p)));for(let R=0;R<2*p;R++)Lp[R]=0;let f=0;const m=!!c&&!!a,y=m?l:s;let _=nbe(s/3);const b=new Uint32Array(l),x=1.96;let T=o!==0?Math.ceil(4*x*x/(o*o)*o*(1-o)):y,S=1,E=c?c[1]:y;for(let R=0;R<y;R++){if(R===T){const G=1-f/R;if(G+x*Math.sqrt(G*(1-G)/R)<o)return null;T*=2}if(R===E){for(let G=0;G<2*p;G++)Lp[G]=0;if(a)for(let G=c[S-1];G<c[S];G++)b[G]=_[a[G]];E=c[++S]}const L=m?a[R]:R,P=L*e,U=_st(n,P,e);let B=U%p,z=f;for(;Lp[2*B+1]!==0;){if(Lp[2*B]===U){const G=Lp[2*B+1]-1;if(gst(n,P,G*e,e)){z=_[G];break}}B++,B>=p&&(B-=p)}z===f&&(Lp[2*B]=U,Lp[2*B+1]=L+1,f++),_[L]=z}if(o!==0&&1-f/s<o)return null;if(m){for(let R=c[S-1];R<b.length;R++)b[R]=_[a[R]];_=rS(b)}const O=i?new Array(f):new Uint32Array(f*e);f=0;for(let R=0;R<y;R++)_[R]===f&&(yst(n,(m?a[R]:R)*e,O,f*e,e),f++);if(a&&!m){const R=new Uint32Array(l);for(let L=0;L<R.length;L++)R[L]=_[a[L]];_=rS(R)}return{buffer:Array.isArray(O)?O:O.buffer,indices:_,uniqueCount:f}}function gst(t,e,r,i){for(let s=0;s<i;s++)if(t[e+s]!==t[r+s])return!1;return!0}function yst(t,e,r,i,s){for(let n=0;n<s;n++)r[i+n]=t[e+n]}function _st(t,e,r){let i=0;for(let s=0;s<r;s++)i=t[e+s]+i|0,i=i+(i<<11)+(i>>>2)|0;return i>>>0}let Lp=null;function LOt(t){const e=FM(t.rings,t.hasZ,hm.CCW_IS_HOLE),r=new Array;let i=0,s=0;for(const a of e.polygons){const l=a.count,c=a.index,h=Lh(e.position,3*c,3*l),p=a.holeIndices.map(m=>m-c),f=new Uint32Array(cv(h,p,3));r.push({position:h,faces:f}),i+=h.length,s+=f.length}const n=vst(r,i,s),o=Array.isArray(n.position)?Vj(n.position,3,{originalIndices:n.faces}):Vj(n.position.buffer,6,{originalIndices:n.faces});return n.position=new Float64Array(o.buffer),n.faces=o.indices,n}function vst(t,e,r){if(t.length===1)return t[0];const i=Fc(e),s=new Uint32Array(r);let n=0,o=0,a=0;for(const l of t){for(let c=0;c<l.position.length;c++)i[n++]=l.position[c];for(let c=0;c<l.faces.length;c++)s[o++]=l.faces[c]+a;a=n/3}return{position:i,faces:s}}function FM(t,e,r){const i=t.length,s=new Array(i),n=new Array(i),o=new Array(i);let a=0,l=0,c=0,h=0;for(let m=0;m<i;++m)h+=t[m].length;const p=Fc(3*h);let f=0;for(let m=i-1;m>=0;m--){const y=t[m],_=r===hm.CCW_IS_HOLE&&bst(y);if(_&&i!==1)s[a++]=y;else{let b=y.length;for(let T=0;T<a;++T)b+=s[T].length;const x={index:f,pathLengths:new Array(a+1),count:b,holeIndices:new Array(a)};x.pathLengths[0]=y.length,y.length>0&&(o[c++]={index:f,count:y.length}),f=_?II(y,y.length-1,-1,p,f,y.length,e):II(y,0,1,p,f,y.length,e);for(let T=0;T<a;++T){const S=s[T];x.holeIndices[T]=f,x.pathLengths[T+1]=S.length,S.length>0&&(o[c++]={index:f,count:S.length}),f=II(S,0,1,p,f,S.length,e)}a=0,x.count>0&&(n[l++]=x)}}for(let m=0;m<a;++m){const y=s[m];y.length>0&&(o[c++]={index:f,count:y.length}),f=II(y,0,1,p,f,y.length,e)}return n.length=l,o.length=c,{position:p,polygons:n,outlines:o}}function II(t,e,r,i,s,n,o){s*=3;for(let a=0;a<n;++a){const l=t[e];i[s++]=l[0],i[s++]=l[1],i[s++]=o?l[2]:0,e+=r}return s/3}function bst(t){return!dde(t,!1,!1)}var hm;(function(t){t[t.NONE=0]="NONE",t[t.CCW_IS_HOLE=1]="CCW_IS_HOLE"})(hm||(hm={}));var _R,OF,Bj;(function(t){t[t.RasterImage=0]="RasterImage",t[t.Features=1]="Features"})(_R||(_R={})),function(t){t[t.MapLayer=0]="MapLayer",t[t.ViewLayer=1]="ViewLayer",t[t.Outline=2]="Outline",t[t.SnappingHint=3]="SnappingHint"}(OF||(OF={})),function(t){t[t.WithRasterImage=0]="WithRasterImage",t[t.WithoutRasterImage=1]="WithoutRasterImage"}(Bj||(Bj={}));var Ki,Th,At,vR,fs,yn,aa;(function(t){t[t.INNER=0]="INNER",t[t.OUTER=1]="OUTER"})(Ki||(Ki={})),function(t){t[t.REGULAR=0]="REGULAR",t[t.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",t[t.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",t[t.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(Th||(Th={})),function(t){t[t.NORTH=0]="NORTH",t[t.NORTH_EAST=1]="NORTH_EAST",t[t.EAST=2]="EAST",t[t.SOUTH_EAST=3]="SOUTH_EAST",t[t.SOUTH=4]="SOUTH",t[t.SOUTH_WEST=5]="SOUTH_WEST",t[t.WEST=6]="WEST",t[t.NORTH_WEST=7]="NORTH_WEST"}(At||(At={})),function(t){t[t.OFF=0]="OFF",t[t.ON=1]="ON"}(vR||(vR={})),function(t){t[t.Color=0]="Color",t[t.ColorNoRasterImage=1]="ColorNoRasterImage",t[t.Highlight=2]="Highlight",t[t.Water=3]="Water",t[t.Occluded=4]="Occluded",t[t.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor"}(fs||(fs={})),function(t){t[t.FADING=0]="FADING",t[t.IMMEDIATE=1]="IMMEDIATE",t[t.UNFADED=2]="UNFADED"}(yn||(yn={})),function(t){t[t.INSIDE=0]="INSIDE",t[t.INTERSECTS=1]="INTERSECTS",t[t.OUTSIDE=2]="OUTSIDE"}(aa||(aa={}));let wst=class{constructor(e,r){this.vec3=e,this.id=r}};function bR(t,e,r,i){return new wst($e(t,e,r),i)}var Ll;(function(t){t[t.None=0]="None",t[t.ColorAndWater=1]="ColorAndWater",t[t.Highlight=2]="Highlight",t[t.Occluded=3]="Occluded",t[t.ObjectAndLayerIdColor=4]="ObjectAndLayerIdColor"})(Ll||(Ll={}));let Sne=class{get extent(){return this._extent}constructor(e,r){this.index=e,this.renderTargets=r,this._extent=ur(),this.resolution=0,this.renderLocalOrigin=bR(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new xst,this.hasDrapedFeatureSource=!1,this.hasDrapedRasterSource=!1,this.hasTargetWithoutRasterImage=!1,this.index=e,this.validTargets=new Array(r.renderTargets.length).fill(!1)}getValidTexture(e){return this.validTargets[e]?this.renderTargets.getTarget(e).getTexture():null}get _needsColorWithoutRasterImage(){return this.hasDrapedRasterSource&&this.hasDrapedFeatureSource&&this.hasTargetWithoutRasterImage}getColorTexture(e){const r=e===Ll.ColorAndWater?this.renderTargets.getTarget(fs.Color):e===Ll.Highlight?this.renderTargets.getTarget(fs.Highlight):e===Ll.ObjectAndLayerIdColor?this.renderTargets.getTarget(fs.ObjectAndLayerIdColor):this.renderTargets.getTarget(fs.Occluded);return r?r.getTexture():null}getColorTextureNoRasterImage(){return this._needsColorWithoutRasterImage?this.getValidTexture(fs.ColorNoRasterImage):this.hasDrapedFeatureSource?this.getValidTexture(fs.Color):null}getNormalTexture(e){const r=e===Ll.ColorAndWater?this.renderTargets.getTarget(fs.Water):null;return r?r.getTexture():null}draw(e,r){const i=this.computeRenderTargetValidityBitfield();for(const s of this.renderTargets.renderTargets)s.type!==fs.ColorNoRasterImage||this._needsColorWithoutRasterImage?this.validTargets[s.type]=e.drawTarget(this,s,r):this.validTargets[s.type]=!1;return i^this.computeRenderTargetValidityBitfield()?JS.CHANGED:JS.UNCHANGED}computeRenderTargetValidityBitfield(){const e=this.validTargets;return+e[fs.Color]|+e[fs.ColorNoRasterImage]<<1|+e[fs.Highlight]<<2|+e[fs.Water]<<3|+e[fs.Occluded]<<4}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();const r=.001*e.range;if(this._extent[0]-r<=e.min){const i=this.canvasGeometries.extents[this.canvasGeometries.numViews++];pN(this._extent,e.range,0,i)}if(this._extent[2]+r>=e.max){const i=this.canvasGeometries.extents[this.canvasGeometries.numViews++];pN(this._extent,-e.range,0,i)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,Kg(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const r=this.canvasGeometries.extents[e];if(r[0]!==r[2]&&r[1]!==r[3])return!0}return!1}applyViewport(e){e.setViewport(this.index===Ki.INNER?0:this.resolution,0,this.resolution,this.resolution)}},xst=class{constructor(){this.extents=[ur(),ur(),ur()],this.numViews=0}},wTe=class{constructor(e,r){this._size=PZ(),this._fbo=null,this._fbo=new Ds(e,{colorTarget:ls.TEXTURE,depthStencilTarget:$r.NONE},{target:bt.TEXTURE_2D,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Rt.CLAMP_TO_EDGE,samplingMode:tt.LINEAR_MIPMAP_LINEAR,hasMipmap:r,maxAnisotropy:8,width:0,height:0})}dispose(){this._fbo=Qe(this._fbo)}getTexture(){return this._fbo?this._fbo.colorTexture:null}isValid(){return this._fbo!==null}resize(e,r){this._size[0]=e,this._size[1]=r,this._fbo.resize(this._size[0],this._size[1])}bind(e){e.bindFramebuffer(this._fbo)}generateMipMap(){const e=this._fbo.colorTexture;e.descriptor.hasMipmap&&e.generateMipmap()}disposeRenderTargetMemory(){var e;(e=this._fbo)==null||e.resize(0,0)}get gpuMemoryUsage(){var e;return((e=this._fbo)==null?void 0:e.gpuMemoryUsage)??0}},$x=class{constructor(e,r,i,s=!0){this.output=r,this.type=i,this.valid=!1,this.lastUsed=1/0,this.fbo=new wTe(e,s)}},Tst=class{constructor(e){this.renderTargets=[new $x(e,k.Color,fs.Color),new $x(e,k.Color,fs.ColorNoRasterImage),new $x(e,k.Highlight,fs.Highlight,!1),new $x(e,k.Normal,fs.Water),new $x(e,k.Color,fs.Occluded)],de("enable-feature:objectAndLayerId-rendering")&&this.renderTargets.push(new $x(e,k.ObjectAndLayerIdColor,fs.ObjectAndLayerIdColor))}getTarget(e){return this.renderTargets[e].fbo}dispose(){for(const e of this.renderTargets)e.fbo.dispose()}disposeRenderTargetMemory(){for(const e of this.renderTargets)e.fbo.disposeRenderTargetMemory()}validateUsageForTarget(e,r,i){if(e)r.lastUsed=i;else if(i-r.lastUsed>Sst)r.fbo.disposeRenderTargetMemory(),r.lastUsed=1/0;else if(r.lastUsed<1/0)return!0;return!1}get gpuMemoryUsage(){return this.renderTargets.reduce((e,r)=>e+r.fbo.gpuMemoryUsage,0)}};const Sst=1e3;let xTe=class{constructor(e){this._context=e,this._perConstructorInstances=new BE,this._frameCounter=0,this._keepAliveFrameCount=Ene}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}destroy(){this._perConstructorInstances.forEach(e=>e.forEach(r=>r.technique.destroy())),this._perConstructorInstances.clear()}acquire(e,r=Cst){const i=r.key;let s=this._perConstructorInstances.get(e,i);if(C(s)){const n=new e(this._context,r,()=>this.release(n));s=new Est(n),this._perConstructorInstances.set(e,i,s)}return++s.refCount,s.technique}releaseAndAcquire(e,r,i){if(v(i)){if(r.key===i.key)return i;this.release(i)}return this.acquire(e,r)}release(e){if(C(e)||this._perConstructorInstances.empty)return;const r=this._perConstructorInstances.get(e.constructor,e.key);C(r)||(--r.refCount,r.refCount===0&&(r.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==Ene&&this._perConstructorInstances.forEach((e,r)=>{e.forEach((i,s)=>{i.refCount===0&&i.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(i.technique.destroy(),this._perConstructorInstances.delete(r,s))})})}async reloadAll(){const e=new Array;this._perConstructorInstances.forEach((r,i)=>{const s=async(n,o)=>{const a=o.shader;a&&(await a.reload(),n.forEach(l=>l.technique.reload(this._context)))};e.push(s(r,i))}),await Promise.all(e)}},Est=class{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}};const Ene=-1,Cst=new Ca;let TTe=class{constructor(e,r,i,s){this._textureRepository=e,this._techniqueRepository=r,this.materialChanged=i,this.requestRender=s,this._id2glMaterialRef=new BE}dispose(){this._textureRepository.destroy()}acquire(e,r,i){if(this._ownMaterial(e),!e.requiresSlot(r,i))return null;let s=this._id2glMaterialRef.get(i,e.id);if(C(s)){const n=e.createGLMaterial({material:e,techniqueRep:this._techniqueRepository,textureRep:this._textureRepository,output:i});s=new Ast(n),this._id2glMaterialRef.set(i,e.id,s)}return s.ref(),s.glMaterial}release(e,r){const i=this._id2glMaterialRef.get(r,e.id);v(i)&&(i.unref(),i.referenced||(Qe(i.glMaterial),this._id2glMaterialRef.delete(r,e.id)))}_ownMaterial(e){v(e.repository)&&e.repository!==this&&se.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}},Ast=class{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,ft(this._refCnt>=0)}get referenced(){return this._refCnt>0}};const Rst={orderedRepackingEnabled:!1},Ost={rootOrigin:null},Mst=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","shaderTransformationChanged","objectTransformation","visibilityChanged","occlusionChanged","highlightChanged","objectGeometryAdded","objectGeometryRemoved","objectGeometryUpdated"];let zj=class Gj{get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}constructor(e,r){this._objectToBoundingSphere=e,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new Xn,this._objectCount=0,r&&(r.maximumObjectsPerNode!==void 0&&(this._maximumObjectsPerNode=r.maximumObjectsPerNode),r.maximumDepth!==void 0&&(this._maximumDepth=r.maximumDepth))}destroy(){this._degenerateObjects.clear(),Xn.clearPool(),jj[0]=null,Hv.prune(),rb.prune()}add(e,r=e.length){this._objectCount+=r,this._grow(e,r);const i=Xn.acquire();for(let s=0;s<r;s++){const n=e[s];this._isDegenerate(n)?this._degenerateObjects.add(n):(i.init(this._root),this._add(n,i))}Xn.release(i)}remove(e,r=null){this._objectCount-=e.length;const i=Xn.acquire();for(const s of e){const n=v(r)?r:kS(this._objectToBoundingSphere(s),Dst);_3(n[3])?(i.init(this._root),this._remove(s,n,i)):this._degenerateObjects.delete(s)}Xn.release(i),this._shrink()}update(e,r){if(!_3(r[3])&&this._isDegenerate(e))return;const i=Lst(e);this.remove(i,r),this.add(i)}forEachAlongRay(e,r,i){const s=Du(e,r);this._forEachNode(this._root,n=>{if(!this._intersectsNode(s,n))return!1;const o=n.node;return o.terminals.forAll(a=>{this._intersectsObject(s,a)&&i(a)}),o.residents!==null&&o.residents.forAll(a=>{this._intersectsObject(s,a)&&i(a)}),!0})}forEachAlongRayWithVerticalOffset(e,r,i,s){const n=Du(e,r);this._forEachNode(this._root,o=>{if(!this._intersectsNodeWithOffset(n,o,s))return!1;const a=o.node;return a.terminals.forAll(l=>{this._intersectsObjectWithOffset(n,l,s)&&i(l)}),a.residents!==null&&a.residents.forAll(l=>{this._intersectsObjectWithOffset(n,l,s)&&i(l)}),!0})}forEach(e){this._forEachNode(this._root,r=>{const i=r.node;return i.terminals.forAll(e),i.residents!==null&&i.residents.forAll(e),!0}),this._degenerateObjects.forEach(e)}forEachDegenerateObject(e){this._degenerateObjects.forEach(e)}findClosest(e,r,i,s=()=>!0,n=1/0){let o=1/0,a=1/0,l=null;const c=n9(e,r),h=p=>{if(--n,!s(p))return;const f=this._objectToBoundingSphere(p);if(!R_(i,f))return;const m=i_(e,r,f),y=m-f[3],_=m+f[3];y<o&&(o=y,a=_,l=p)};return this._forEachNodeDepthOrdered(this._root,p=>{if(n<=0||!R_(i,p.bounds)||(ae(ju,c,p.halfSize),fe(ju,ju,p.bounds),i_(e,r,ju)>a))return!1;const f=p.node;return f.terminals.forAll(m=>h(m)),f.residents!==null&&f.residents.forAll(m=>h(m)),!0},e,r),l}forEachInDepthRange(e,r,i,s,n,o,a){let l=-1/0,c=1/0;const h={setRange:_=>{i===Gj.DepthOrder.FRONT_TO_BACK?(l=Math.max(l,_.near),c=Math.min(c,_.far)):(l=Math.max(l,-_.far),c=Math.min(c,-_.near))}};h.setRange(s);const p=i_(r,i,e),f=n9(r,i),m=n9(r,-i),y=_=>{if(!a(_))return;const b=this._objectToBoundingSphere(_),x=b,T=i_(r,i,x)-p,S=T-b[3],E=T+b[3];S>c||E<l||!R_(o,b)||n(_,h)};this._forEachNodeDepthOrdered(this._root,_=>{if(!R_(o,_.bounds)||(ae(ju,f,_.halfSize),fe(ju,ju,_.bounds),i_(r,i,ju)-p>c)||(ae(ju,m,_.halfSize),fe(ju,ju,_.bounds),i_(r,i,ju)-p<l))return!1;const b=_.node;return b.terminals.forAll(x=>y(x)),b.residents!==null&&b.residents.forAll(x=>y(x)),!0},r,i)}forEachNode(e){this._forEachNode(this._root,r=>e(r.node,r.bounds,r.halfSize))}forEachNeighbor(e,r){const i=Fg(r),s=r,n=l=>{const c=this._objectToBoundingSphere(l),h=Fg(c),p=i+h;return!(Ro(c,s)-p*p<=0)||e(l)};let o=!0;const a=l=>{o&&(o=n(l))};this._forEachNode(this._root,l=>{const c=Fg(l.bounds),h=i+c;if(Ro(l.bounds,s)-h*h>0)return!1;const p=l.node;return p.terminals.forAll(a),o&&p.residents!==null&&p.residents.forAll(a),o}),o&&this.forEachDegenerateObject(a)}_intersectsNode(e,r){return $I(r.bounds,2*-r.halfSize,mu),$I(r.bounds,2*r.halfSize,gu),_ie(e.origin,e.direction,mu,gu)}_intersectsNodeWithOffset(e,r,i){return $I(r.bounds,2*-r.halfSize,mu),$I(r.bounds,2*r.halfSize,gu),i.applyToMinMax(mu,gu),_ie(e.origin,e.direction,mu,gu)}_intersectsObject(e,r){const i=this._objectToBoundingSphere(r);return!(i[3]>0)||ez(i,e)}_intersectsObjectWithOffset(e,r,i){const s=this._objectToBoundingSphere(r);return!(s[3]>0)||ez(i.applyToBoundingSphere(s),e)}_forEachNode(e,r){let i=Xn.acquire().init(e);const s=[i];for(;s.length!==0;){if(i=s.pop(),r(i)&&!i.isLeaf())for(let n=0;n<i.node.children.length;n++)i.node.children[n]&&s.push(Xn.acquire().init(i).advance(n));Xn.release(i)}}_forEachNodeDepthOrdered(e,r,i,s=Gj.DepthOrder.FRONT_TO_BACK){let n=Xn.acquire().init(e);const o=[n];for($st(i,s,Rne);o.length!==0;){if(n=o.pop(),r(n)&&!n.isLeaf())for(let a=7;a>=0;--a){const l=Rne[a];n.node.children[l]&&o.push(Xn.acquire().init(n).advance(l))}Xn.release(n)}}_remove(e,r,i){Hv.clear();const s=i.advanceTo(r,(n,o)=>{Hv.push(n.node),Hv.push(o)})?i.node.terminals:i.node.residents;if(s.removeUnordered(e),s.length===0)for(let n=Hv.length-2;n>=0;n-=2){const o=Hv.data[n],a=Hv.data[n+1];if(!this._purge(o,a))break}}_nodeIsEmpty(e){if(e.terminals.length!==0)return!1;if(e.residents!==null)return e.residents.length===0;for(let r=0;r<e.children.length;r++)if(e.children[r])return!1;return!0}_purge(e,r){return r>=0&&(e.children[r]=null),!!this._nodeIsEmpty(e)&&(e.residents===null&&(e.residents=new Jt({shrink:!0})),!0)}_add(e,r){r.advanceTo(this._objectToBoundingSphere(e))?r.node.terminals.push(e):(r.node.residents.push(e),r.node.residents.length>this._maximumObjectsPerNode&&r.depth<this._maximumDepth&&this._split(r))}_split(e){const r=e.node.residents;e.node.residents=null;for(let i=0;i<r.length;i++){const s=Xn.acquire().init(e);this._add(r.getItemAt(i),s),Xn.release(s)}}_grow(e,r){if(r!==0&&(Cne(e,r,i=>this._objectToBoundingSphere(i),Fm),_3(Fm[3])&&!this._fitsInsideTree(Fm)))if(this._nodeIsEmpty(this._root.node))kS(Fm,this._root.bounds),this._root.halfSize=1.25*this._root.bounds[3],this._root.updateBoundsRadiusFromHalfSize();else{const i=this._rootBoundsForRootAsSubNode(Fm);this._placingRootViolatesMaxDepth(i)?this._rebuildTree(Fm,i):this._growRootAsSubNode(i),Xn.release(i)}}_rebuildTree(e,r){le(a9,r.bounds),a9[3]=r.halfSize,Cne([e,a9],2,s=>s,l9);const i=Xn.acquire().init(this._root);this._root.initFrom(null,l9,l9[3]),this._root.increaseHalfSize(1.25),this._forEachNode(i,s=>(this.add(s.node.terminals.data,s.node.terminals.length),s.node.residents!==null&&this.add(s.node.residents.data,s.node.residents.length),!0)),Xn.release(i)}_placingRootViolatesMaxDepth(e){const r=Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E;let i=0;return this._forEachNode(this._root,s=>(i=Math.max(i,s.depth),i+r<=this._maximumDepth)),i+r>this._maximumDepth}_rootBoundsForRootAsSubNode(e){const r=e[3],i=e;let s=-1/0;const n=this._root.bounds,o=this._root.halfSize;for(let l=0;l<3;l++){const c=n[l]-o-(i[l]-r),h=i[l]+r-(n[l]+o),p=Math.max(0,Math.ceil(c/(2*o))),f=Math.max(0,Math.ceil(h/(2*o)))+1,m=2**Math.ceil(Math.log(p+f)*Math.LOG2E);s=Math.max(s,m),LI[l].min=p,LI[l].max=f}for(let l=0;l<3;l++){let c=LI[l].min,h=LI[l].max;const p=(s-(c+h))/2;c+=Math.ceil(p),h+=Math.floor(p);const f=n[l]-o-c*o*2;o9[l]=f+(h+c)*o}const a=s*o;return o9[3]=a*ETe,Xn.acquire().initFrom(null,o9,a,0)}_growRootAsSubNode(e){const r=this._root.node;le(Fm,this._root.bounds),Fm[3]=this._root.halfSize,this._root.init(e),e.advanceTo(Fm,null,!0),e.node.children=r.children,e.node.residents=r.residents,e.node.terminals=r.terminals}_shrink(){for(;;){const e=this._findShrinkIndex();if(e===-1)break;this._root.advance(e),this._root.depth=0}}_findShrinkIndex(){if(this._root.node.terminals.length!==0||this._root.isLeaf())return-1;let e=null;const r=this._root.node.children;let i=0,s=0;for(;s<r.length&&e==null;)i=s++,e=r[i];for(;s<r.length;)if(r[s++])return-1;return i}_isDegenerate(e){return!_3(this._objectToBoundingSphere(e)[3])}_fitsInsideTree(e){const r=this._root.bounds,i=this._root.halfSize;return e[3]<=i&&e[0]>=r[0]-i&&e[0]<=r[0]+i&&e[1]>=r[1]-i&&e[1]<=r[1]+i&&e[2]>=r[2]-i&&e[2]<=r[2]+i}},Xn=class i2{constructor(){this.bounds=on(),this.halfSize=0,this.initFrom(null,null,0,0)}init(e){return this.initFrom(e.node,e.bounds,e.halfSize,e.depth)}initFrom(e,r,i,s=this.depth){return this.node=v(e)?e:i2.createEmptyNode(),v(r)&&kS(r,this.bounds),this.halfSize=i,this.depth=s,this}increaseHalfSize(e){this.halfSize*=e,this.updateBoundsRadiusFromHalfSize()}updateBoundsRadiusFromHalfSize(){this.bounds[3]=this.halfSize*ETe}advance(e){let r=this.node.children[e];r||(r=i2.createEmptyNode(),this.node.children[e]=r),this.node=r,this.halfSize/=2,this.depth++;const i=STe[e];return this.bounds[0]+=i[0]*this.halfSize,this.bounds[1]+=i[1]*this.halfSize,this.bounds[2]+=i[2]*this.halfSize,this.updateBoundsRadiusFromHalfSize(),this}advanceTo(e,r,i=!1){for(;;){if(this.isTerminalFor(e))return r&&r(this,-1),!0;if(this.isLeaf()){if(!i)return r&&r(this,-1),!1;this.node.residents=null}const s=this._childIndex(e);r&&r(this,s),this.advance(s)}}isLeaf(){return this.node.residents!=null}isTerminalFor(e){return e[3]>this.halfSize/2}_childIndex(e){const r=this.bounds;return(r[0]<e[0]?1:0)+(r[1]<e[1]?2:0)+(r[2]<e[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new Jt({shrink:!0}),residents:new Jt({shrink:!0})}}static acquire(){return i2._pool.acquire()}static release(e){i2._pool.release(e)}static clearPool(){i2._pool.prune()}};function Pst(t,e){t[0]=Math.min(t[0],e[0]-e[3]),t[1]=Math.min(t[1],e[1]-e[3]),t[2]=Math.min(t[2],e[2]-e[3])}function Ist(t,e){t[0]=Math.max(t[0],e[0]+e[3]),t[1]=Math.max(t[1],e[1]+e[3]),t[2]=Math.max(t[2],e[2]+e[3])}function $I(t,e,r){r[0]=t[0]+e,r[1]=t[1]+e,r[2]=t[2]+e}function Cne(t,e,r,i){if(e===1){const s=r(t[0]);kS(s,i)}else{mu[0]=1/0,mu[1]=1/0,mu[2]=1/0,gu[0]=-1/0,gu[1]=-1/0,gu[2]=-1/0;for(let s=0;s<e;s++){const n=r(t[s]);_3(n[3])&&(Pst(mu,n),Ist(gu,n))}Ys(i,mu,gu,.5),i[3]=Math.max(gu[0]-mu[0],gu[1]-mu[1],gu[2]-mu[2])/2}}function $st(t,e,r){if(!rb.length)for(let i=0;i<8;++i)rb.push({index:0,distance:0});for(let i=0;i<8;++i){const s=STe[i];rb.data[i].index=i,rb.data[i].distance=i_(t,e,s)}rb.sort((i,s)=>i.distance-s.distance);for(let i=0;i<8;++i)r[i]=rb.data[i].index}function n9(t,e){let r,i=1/0;for(let s=0;s<8;++s){const n=i_(t,e,Ane[s]);n<i&&(i=n,r=Ane[s])}return r}function i_(t,e,r){return e*(t[0]*r[0]+t[1]*r[1]+t[2]*r[2])}function _3(t){return!isNaN(t)&&t!==-1/0&&t!==1/0&&t>0}Xn._pool=new Co(Xn),function(t){var e;(e=t.DepthOrder||(t.DepthOrder={}))[e.FRONT_TO_BACK=1]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT"}(zj||(zj={}));const STe=[$e(-1,-1,-1),$e(1,-1,-1),$e(-1,1,-1),$e(1,1,-1),$e(-1,-1,1),$e(1,-1,1),$e(-1,1,1),$e(1,1,1)],Ane=[$e(-1,-1,-1),$e(-1,-1,1),$e(-1,1,-1),$e(-1,1,1),$e(1,-1,-1),$e(1,-1,1),$e(1,1,-1),$e(1,1,1)],ETe=Math.sqrt(3),jj=[null];function Lst(t){return jj[0]=t,jj}const o9=on(),ju=M(),mu=M(),gu=M(),Hv=new Jt,Dst=on(),Fm=on(),a9=on(),l9=on(),LI=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],rb=new Jt,Rne=[0,0,0,0,0,0,0,0],ep=zj;var B_;(function(t){t[t.ASYNC=0]="ASYNC",t[t.SYNC=1]="SYNC"})(B_||(B_={}));let CTe=class extends RM{get objects(){return this._objects}constructor(e,r=""){super(),this.apiLayerUid=r,this.type=$s.Layer,this.events=new vs,this.sliceable=!1,this._objects=new Jt,this._objectsAdded=new Jt,this._stageHandles=new ei,this.apiLayerUid=r,this.visible=(e==null?void 0:e.visible)??!0,this.pickable=(e==null?void 0:e.pickable)??!0,this.updatePolicy=(e==null?void 0:e.updatePolicy)??B_.ASYNC,this._disableOctree=(e==null?void 0:e.disableOctree)??!1}destroy(){this.detachStage(),this._stage=null}attachStage(e){this.detachStage(),this._stage=e;for(const r of Mst)this._stageHandles.add(this.events.on(r,i=>e.handleEvent(r,i)))}detachStage(){this._stageHandles.removeAll(),this.invalidateSpatialQueryAccelerator()}add(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),v(this._octree)&&this._objectsAdded.push(e)}remove(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),v(this._octree)&&(this._objectsAdded.removeUnordered(e)||this._octree.remove([e])))}addMany(e){this._objects.pushArray(e);for(const r of e)r.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),v(this._octree)&&this._objectsAdded.pushArray(e)}removeMany(e){const r=new Array;if(this._objects.removeUnorderedMany(e,e.length,r),r.length!==0){for(const i of r)i.parentLayer=null;if(this.events.emit("layerObjectsRemoved",{layer:this,objects:r}),v(this._octree)){for(let i=0;i<r.length;)this._objectsAdded.removeUnordered(r[i])?(r[i]=r[r.length-1],r.length-=1):++i;this._octree.remove(r)}}}sync(){v(this._stage)&&this.updatePolicy!==B_.SYNC&&this._stage.syncLayer(this.id)}notifyObjectBBChanged(e,r){v(this._octree)&&!this._objectsAdded.includes(e)&&this._octree.update(e,r)}getSpatialQueryAccelerator(){return C(this._octree)&&this._objects.length>50&&!this._disableOctree?(this._octree=new ep(e=>e.boundingVolumeWorldSpace.bounds),this._octree.add(this._objects.data,this._objects.length)):v(this._octree)&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded.data,this._objectsAdded.length),this._objectsAdded.clear()),this._octree}shaderTransformationChanged(){this.invalidateSpatialQueryAccelerator(),this.events.emit("shaderTransformationChanged",this)}invalidateSpatialQueryAccelerator(){this._octree=ke(this._octree),this._objectsAdded.clear()}};function MF(t){return v(t)&&t.type===$s.Layer}var Dh,Nw;(function(t){t[t.Draped=0]="Draped",t[t.Screen=1]="Screen",t[t.World=2]="World",t[t.COUNT=3]="COUNT"})(Dh||(Dh={})),function(t){t[t.Center=0]="Center",t[t.Tip=1]="Tip",t[t.COUNT=2]="COUNT"}(Nw||(Nw={}));let vo=class extends eo{constructor(){super(...arguments),this.output=k.Color,this.transparencyPassType=xt.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.writeDepth=!1,this.space=Dh.Screen,this.hideOnShortSegments=!1,this.hasCap=!1,this.anchor=Nw.Center,this.hasTip=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}};u([V({count:k.COUNT})],vo.prototype,"output",void 0),u([V({count:xt.COUNT})],vo.prototype,"transparencyPassType",void 0),u([V()],vo.prototype,"occluder",void 0),u([V()],vo.prototype,"hasSlicePlane",void 0),u([V()],vo.prototype,"writeDepth",void 0),u([V({count:Dh.COUNT})],vo.prototype,"space",void 0),u([V()],vo.prototype,"hideOnShortSegments",void 0),u([V()],vo.prototype,"hasCap",void 0),u([V({count:Nw.COUNT})],vo.prototype,"anchor",void 0),u([V()],vo.prototype,"hasTip",void 0),u([V()],vo.prototype,"vvSize",void 0),u([V()],vo.prototype,"vvColor",void 0),u([V()],vo.prototype,"vvOpacity",void 0),u([V()],vo.prototype,"hasOccludees",void 0),u([V()],vo.prototype,"hasMultipassTerrain",void 0),u([V()],vo.prototype,"cullAboveGround",void 0),u([V({constValue:!0})],vo.prototype,"hasVvInstancing",void 0),u([V({constValue:!0})],vo.prototype,"hasSliceTranslatedView",void 0);const One=8;function ATe(t,e){const r=t.vertex;r.uniforms.add(new Pe("intrinsicWidth",i=>i.width)),e.vvSize?(t.attributes.add(A.SIZEFEATUREATTRIBUTE,"float"),r.uniforms.add(new qt("vvSizeMinSize",i=>i.vvSizeMinSize)),r.uniforms.add(new qt("vvSizeMaxSize",i=>i.vvSizeMaxSize)),r.uniforms.add(new qt("vvSizeOffset",i=>i.vvSizeOffset)),r.uniforms.add(new qt("vvSizeFactor",i=>i.vvSizeFactor)),r.code.add(w`float getSize() {
return intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;
}`)):(t.attributes.add(A.SIZE,"float"),r.code.add(w`float getSize(){
return intrinsicWidth * size;
}`)),e.vvOpacity?(t.attributes.add(A.OPACITYFEATUREATTRIBUTE,"float"),r.constants.add("vvOpacityNumber","int",8),r.uniforms.add([new ha("vvOpacityValues",i=>i.vvOpacityValues,One),new ha("vvOpacityOpacities",i=>i.vvOpacityOpacities,One)]),r.code.add(w`float interpolateOpacity( float value ){
if (value <= vvOpacityValues[0]) {
return vvOpacityOpacities[0];
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
}
}
return vvOpacityOpacities[vvOpacityNumber - 1];
}
vec4 applyOpacity( vec4 color ){
return vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));
}`)):r.code.add(w`vec4 applyOpacity( vec4 color ){
return color;
}`),e.vvColor?(t.attributes.add(A.COLORFEATUREATTRIBUTE,"float"),r.constants.add("vvColorNumber","int",lp),r.uniforms.add(new ha("vvColorValues",i=>i.vvColorValues,lp)),r.uniforms.add(new z5("vvColorColors",i=>i.vvColorColors,lp)),r.code.add(w`vec4 interpolateColor( float value ) {
if (value <= vvColorValues[0]) {
return vvColorColors[0];
}
for (int i = 1; i < vvColorNumber; ++i) {
if (vvColorValues[i] >= value) {
float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
return mix(vvColorColors[i-1], vvColorColors[i], f);
}
}
return vvColorColors[vvColorNumber - 1];
}
vec4 getColor(){
return applyOpacity(interpolateColor(colorFeatureAttribute));
}`)):(t.attributes.add(A.COLOR,"vec4"),r.code.add(w`vec4 getColor(){
return applyOpacity(color);
}`))}function ny(t,e){switch(t.fragment.include(kc),e.output){case k.Shadow:case k.ShadowHighlight:case k.ShadowExcludeHighlight:t.extensions.add("GL_OES_standard_derivatives"),t.fragment.code.add(w`float _calculateFragDepth(const in float depth) {
const float SLOPE_SCALE = 2.0;
const float BIAS = 20.0 * .000015259;
float m = max(abs(dFdx(depth)), abs(dFdy(depth)));
float result = depth + SLOPE_SCALE * m + BIAS;
return clamp(result, .0, .999999);
}
void outputDepth(float _linearDepth) {
gl_FragColor = float2rgba(_calculateFragDepth(_linearDepth));
}`);break;case k.Depth:t.fragment.code.add(w`void outputDepth(float _linearDepth) {
gl_FragColor = float2rgba(_linearDepth);
}`)}}let RTe=class{constructor(e){this._rctx=e,this._cache=new Map}destroy(){this._cache.forEach(e=>Qe(e.stippleTexture)),this._cache.clear()}_acquire(e){if(C(e))return null;const r=this._patternId(e),i=this._cache.get(r);if(i)return i.refCount++,i;const{encodedData:s,paddedPixels:n}=Fst(e),o=new Nst(new ct(this._rctx,{width:n,height:1,internalFormat:Ve.RGBA,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Rt.CLAMP_TO_EDGE},s));return this._cache.set(r,o),o}release(e){if(C(e))return;const r=this._patternId(e),i=this._cache.get(r);i&&(i.refCount--,i.refCount===0&&(v(i.stippleTexture)&&i.stippleTexture.dispose(),this._cache.delete(r)))}swap(e,r){const i=this._acquire(r);return this.release(e),i}_patternId(e){return`${e.pattern.join(",")}-r${e.pixelRatio}`}},Nst=class extends pi{constructor(e){super(),this.stippleTexture=e,this.refCount=1}};function Fst(t){const e=$Z(t),r=1/t.pixelRatio,i=OTe(t),s=MTe(t),n=(Math.floor(.5*(s-1))+.5)*r,o=[];let a=1;for(const m of e){for(let y=0;y<m;y++){const _=a*(Math.min(y,m-1-y)+.5)*r/n*.5+.5;o.push(_)}a=-a}const l=Math.round(e[0]/2),c=[...o.slice(l),...o.slice(0,l)],h=i+PTe,p=new Uint8Array(4*h);let f=4;for(const m of c)xO(m,p,f),f+=4;return p.copyWithin(0,f-4,f),p.copyWithin(f,4,8),{encodedData:p,paddedPixels:h}}function $Z(t){return t.pattern.map(e=>Math.round(e*t.pixelRatio))}function OTe(t){if(C(t))return 1;const e=$Z(t);return Math.floor(e.reduce((r,i)=>r+i))}function MTe(t){return $Z(t).reduce((e,r)=>Math.max(e,r))}const PTe=2;function Ust(t){return C(t)?qf:t.length===4?t:ti(kst,t[0],t[1],t[2],1)}const kst=sr();function ITe(t,e){t.constants.add("stippleAlphaColorDiscard","float",.001),t.constants.add("stippleAlphaHighlightDiscard","float",.5),e.stippleEnabled?Vst(t,e):Bst(t)}function Vst(t,e){const r=!(e.draped&&e.stipplePreferContinuous),{vertex:i,fragment:s}=t;s.include(kc),e.draped||(bp(i,e),i.uniforms.add(new Pe("worldToScreenPerDistanceRatio",(o,a)=>1/a.camera.perScreenPixelRatio)),i.code.add(w`float computeWorldToScreenRatio(vec3 segmentCenter) {
float segmentDistanceToCamera = length(segmentCenter - cameraPosition);
return worldToScreenPerDistanceRatio / segmentDistanceToCamera;
}`)),t.varyings.add("vStippleDistance","float"),e.stippleRequiresClamp&&t.varyings.add("vStippleDistanceLimits","vec2"),e.stippleRequiresStretchMeasure&&t.varyings.add("vStipplePatternStretch","float"),i.code.add(w`
    float discretizeWorldToScreenRatio(float worldToScreenRatio) {
      float step = ${Gst};

      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);
      return discreteWorldToScreenRatio;
    }
  `),i.code.add(w`vec2 computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {`),i.code.add(w`
    if (segmentLengthPseudoScreen >= ${r?"patternLength":"1e4"}) {
  `),i.uniforms.add(new Pe("pixelRatio",(o,a)=>a.camera.pixelRatio)),i.code.add(w`
        // Round the screen length to get an integer number of pattern repetitions (minimum 1).
        float repetitions = segmentLengthScreen / (patternLength * pixelRatio);
        float flooredRepetitions = max(1.0, floor(repetitions + 0.5));
        float segmentLengthScreenRounded = flooredRepetitions * patternLength;

        ${e.stippleRequiresStretchMeasure?w`
              float stretch = repetitions / flooredRepetitions;

              // We need to impose a lower bound on the stretch factor to prevent the dots from merging together when there is only 1 repetition.
              // 0.75 is the lowest possible stretch value for flooredRepetitions > 1, so it makes sense as lower bound.
              vStipplePatternStretch = max(0.75, stretch);`:""}

        return vec2(0.0, segmentLengthScreenRounded);
      }
      return vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen);
    }
  `),s.constants.add("stippleTexturePadding","float",PTe);const n=e.hasWebGL2Context?Qr.None:Qr.Size;s.uniforms.add(op("stipplePatternTexture",o=>o.stippleTexture,n)),s.uniforms.add([new Pe("stipplePatternSDFNormalizer",o=>zst(o.stipplePattern)),new Pe("stipplePatternPixelSizeInv",o=>1/LZ(o))]),s.code.add(w`
    float padStippleTexture(float u) {
      float paddedTextureSize = ${$h(e,"stipplePatternTexture")}.x;
      float unpaddedTextureSize = paddedTextureSize - stippleTexturePadding;

      return (u * unpaddedTextureSize + stippleTexturePadding * 0.5) / paddedTextureSize;
    }
  `),s.code.add(w`
    float getStippleSDF(out bool isClamped) {
      ${e.stippleRequiresClamp?w`
          float stippleDistanceClamped = clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y);
          vec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;
          isClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;`:w`
          float stippleDistanceClamped = vStippleDistance;
          isClamped = false;`}

      float u = stippleDistanceClamped * gl_FragCoord.w * stipplePatternPixelSizeInv;
      ${e.stippleScaleWithLineWidth?w`u *= vLineSizeInv;`:""}
      u = padStippleTexture(fract(u));

      float encodedSDF = rgba2float(texture2D(stipplePatternTexture, vec2(u, 0.5)));
      float sdf = (encodedSDF * 2.0 - 1.0) * stipplePatternSDFNormalizer;

      ${e.stippleRequiresStretchMeasure?w`return (sdf - 0.5) * vStipplePatternStretch + 0.5;`:w`return sdf;`}
    }

    float getStippleSDF() {
      bool ignored;
      return getStippleSDF(ignored);
    }

    float getStippleAlpha() {
      bool isClamped;
      float stippleSDF = getStippleSDF(isClamped);

      float antiAliasedResult = ${e.stippleScaleWithLineWidth?w`clamp(stippleSDF * vLineWidth + 0.5, 0.0, 1.0);`:w`clamp(stippleSDF + 0.5, 0.0, 1.0);`}

      return isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;
    }
  `),e.stippleOffColorEnabled?(s.uniforms.add(new pr("stippleOffColor",o=>Ust(o.stippleOffColor))),s.code.add(w`#define discardByStippleAlpha(stippleAlpha, threshold) {}
#define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)`)):s.code.add(w`#define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }
#define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)`)}function Bst(t){t.fragment.code.add(w`float getStippleAlpha() { return 1.0; }
#define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}
#define blendStipple(color, _stippleAlpha_) color`)}function zst(t){return v(t)?(Math.floor(.5*(MTe(t)-1))+.5)/t.pixelRatio:1}function LZ(t){const e=t.stipplePattern;return v(e)?OTe(t.stipplePattern)/e.pixelRatio:1}const Gst=w.float(.4),RO=64,DZ=RO/2,$Te=DZ/5,jst=RO/$Te,Hst=.25;function qst(t,e){return t.fromData(`${e}-marker`,()=>dxe(e,RO,DZ,$Te))}function LTe(t,e){const r=t.vertex;t.constants.add("markerSizePerLineWidth","float",jst),r.uniforms.add(new Pe("pixelRatio",(i,s)=>s.camera.pixelRatio)),C(r.uniforms.get("markerScale"))&&r.constants.add("markerScale","float",1),r.code.add(w`float getLineWidth() {
return max(getSize(), 1.0) * pixelRatio;
}
float getScreenMarkerSize() {
return markerSizePerLineWidth * markerScale * getLineWidth();
}`),e.space===Dh.World&&(r.constants.add("maxSegmentLengthFraction","float",.45),r.uniforms.add(new Pe("perRenderPixelRatio",(i,s)=>s.camera.perRenderPixelRatio)),r.code.add(w`float getWorldMarkerSize(vec4 pos) {
float distanceToCamera = length(pos.xyz);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
return getScreenMarkerSize() * screenToWorldRatio;
}
bool areWorldMarkersHidden(vec4 pos, vec4 other) {
vec3 midPoint = mix(pos.xyz, other.xyz, 0.5);
float distanceToCamera = length(midPoint);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
float worldMarkerSize = getScreenMarkerSize() * screenToWorldRatio;
float segmentLen = length(pos.xyz - other.xyz);
return worldMarkerSize > maxSegmentLengthFraction * segmentLen;
}`))}var Nh;(function(t){t[t.BUTT=0]="BUTT",t[t.SQUARE=1]="SQUARE",t[t.ROUND=2]="ROUND",t[t.COUNT=3]="COUNT"})(Nh||(Nh={}));let Ji=class extends eo{constructor(){super(...arguments),this.output=k.Color,this.capType=Nh.BUTT,this.transparencyPassType=xt.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleScaleWithLineWidth=!1,this.stipplePreferContinuous=!0,this.roundJoins=!1,this.applyMarkerOffset=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.wireframe=!1,this.objectAndLayerIdColorInstanced=!1}};u([V({count:k.COUNT})],Ji.prototype,"output",void 0),u([V({count:Nh.COUNT})],Ji.prototype,"capType",void 0),u([V({count:xt.COUNT})],Ji.prototype,"transparencyPassType",void 0),u([V()],Ji.prototype,"occluder",void 0),u([V()],Ji.prototype,"hasSlicePlane",void 0),u([V()],Ji.prototype,"hasPolygonOffset",void 0),u([V()],Ji.prototype,"writeDepth",void 0),u([V()],Ji.prototype,"draped",void 0),u([V()],Ji.prototype,"stippleEnabled",void 0),u([V()],Ji.prototype,"stippleOffColorEnabled",void 0),u([V()],Ji.prototype,"stippleScaleWithLineWidth",void 0),u([V()],Ji.prototype,"stipplePreferContinuous",void 0),u([V()],Ji.prototype,"roundJoins",void 0),u([V()],Ji.prototype,"applyMarkerOffset",void 0),u([V()],Ji.prototype,"vvSize",void 0),u([V()],Ji.prototype,"vvColor",void 0),u([V()],Ji.prototype,"vvOpacity",void 0),u([V()],Ji.prototype,"falloffEnabled",void 0),u([V()],Ji.prototype,"innerColorEnabled",void 0),u([V()],Ji.prototype,"hasOccludees",void 0),u([V()],Ji.prototype,"hasMultipassTerrain",void 0),u([V()],Ji.prototype,"cullAboveGround",void 0),u([V()],Ji.prototype,"wireframe",void 0),u([V({constValue:!0})],Ji.prototype,"stippleRequiresClamp",void 0),u([V({constValue:!0})],Ji.prototype,"stippleRequiresStretchMeasure",void 0),u([V({constValue:!0})],Ji.prototype,"hasVvInstancing",void 0),u([V({constValue:!0})],Ji.prototype,"hasSliceTranslatedView",void 0),u([V()],Ji.prototype,"objectAndLayerIdColorInstanced",void 0);const PF=1;function Wst(t){const e=new Dr,{vertex:r,fragment:i}=e,s=t.hasMultipassTerrain&&(t.output===k.Color||t.output===k.Alpha);e.include(EM),e.include(ATe,t),e.include(ITe,t);const n=t.applyMarkerOffset&&!t.draped;n&&(r.uniforms.add(new Pe("markerScale",m=>m.markerScale)),e.include(LTe,{space:Dh.World})),t.output===k.Depth&&e.include(ny,t),e.include(B5,t),$c(r,t),r.uniforms.add([new Hi("inverseProjectionMatrix",(m,y)=>y.camera.inverseProjectionMatrix),new kr("nearFar",(m,y)=>y.camera.nearFar),new Pe("miterLimit",m=>m.join!=="miter"?0:m.miterLimit),new pr("viewport",(m,y)=>y.camera.fullViewport)]),r.constants.add("LARGE_HALF_FLOAT","float",65500),e.attributes.add(A.POSITION,"vec3"),e.attributes.add(A.SUBDIVISIONFACTOR,"float"),e.attributes.add(A.UV0,"vec2"),e.attributes.add(A.AUXPOS1,"vec3"),e.attributes.add(A.AUXPOS2,"vec3"),e.varyings.add("vColor","vec4"),e.varyings.add("vpos","vec3"),iv(e),s&&e.varyings.add("depth","float");const o=t.capType===Nh.ROUND,a=t.stippleEnabled&&t.stippleScaleWithLineWidth||o;a&&e.varyings.add("vLineWidth","float");const l=t.stippleEnabled&&t.stippleScaleWithLineWidth;l&&e.varyings.add("vLineSizeInv","float");const c=t.innerColorEnabled||o;c&&e.varyings.add("vLineDistance","float");const h=t.stippleEnabled&&o,p=t.falloffEnabled||h;p&&e.varyings.add("vLineDistanceNorm","float"),o&&(e.varyings.add("vSegmentSDF","float"),e.varyings.add("vReverseSegmentSDF","float")),r.code.add(w`#define PERPENDICULAR(v) vec2(v.y, -v.x);
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}
vec2 rotate(vec2 v, float a) {
float s = sin(a);
float c = cos(a);
mat2 m = mat2(c, -s, s, c);
return m * v;
}`),r.code.add(w`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),b5(e),r.code.add(w`
    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {
      float vnp = nearFar[0] * 0.99;

      if(pos.z > -nearFar[0]) {
        //current pos behind ncp --> we need to clip
        if (!isStartVertex) {
          if(prev.z < -nearFar[0]) {
            //previous in front of ncp
            pos = mix(prev, pos, interp(vnp, prev, pos));
            next = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        } else {
          if(next.z < -nearFar[0]) {
            //next in front of ncp
            pos = mix(pos, next, interp(vnp, pos, next));
            prev = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
      } else {
        //current position visible
        if (prev.z > -nearFar[0]) {
          //previous behind ncp
          prev = mix(pos, prev, interp(vnp, pos, prev));
        }
        if (next.z > -nearFar[0]) {
          //next behind ncp
          next = mix(next, pos, interp(vnp, next, pos));
        }
      }

      ${s?"depth = pos.z;":""}
      linearDepth = calculateLinearDepth(nearFar,pos.z);

      pos = projectAndScale(pos);
      next = projectAndScale(next);
      prev = projectAndScale(prev);
    }
  `),r.uniforms.add(new Pe("pixelRatio",(m,y)=>y.camera.pixelRatio)),r.code.add(w`
  void main(void) {
    // unpack values from uv0.y
    bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;

    float coverage = 1.0;

    // Check for special value of uv0.y which is used by the Renderer when graphics
    // are removed before the VBO is recompacted. If this is the case, then we just
    // project outside of clip space.
    if (uv0.y == 0.0) {
      // Project out of clip space
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
    }
    else {
      bool isJoin = abs(uv0.y) < 3.0;

      float lineSize = getSize();
      float lineWidth = lineSize * pixelRatio;

      ${a?w`vLineWidth = lineWidth;`:""}
      ${l?w`vLineSizeInv = 1.0 / lineSize;`:""}

      // convert sub-pixel coverage to alpha
      if (lineWidth < 1.0) {
        coverage = lineWidth;
        lineWidth = 1.0;
      }else{
        // Ribbon lines cannot properly render non-integer sizes. Round width to integer size if
        // larger than one for better quality. Note that we do render < 1 pixels more or less correctly
        // so we only really care to round anything larger than 1.
        lineWidth = floor(lineWidth + 0.5);
      }

      vec4 pos  = view * vec4(position.xyz, 1.0);
      vec4 prev = view * vec4(auxpos1.xyz, 1.0);
      vec4 next = view * vec4(auxpos2.xyz, 1.0);
  `),n&&r.code.add(w`vec4 other = isStartVertex ? next : prev;
bool markersHidden = areWorldMarkersHidden(pos, other);
if(!isJoin && !markersHidden) {
pos.xyz += normalize(other.xyz - pos.xyz) * getWorldMarkerSize(pos) * 0.5;
}`),r.code.add(w`clipAndTransform(pos, prev, next, isStartVertex);
vec2 left = (pos.xy - prev.xy);
vec2 right = (next.xy - pos.xy);
float leftLen = length(left);
float rightLen = length(right);`),(t.stippleEnabled||o)&&r.code.add(w`
      float isEndVertex = float(!isStartVertex);
      vec2 segmentOrigin = mix(pos.xy, prev.xy, isEndVertex);
      vec2 segment = mix(right, left, isEndVertex);
      ${o?w`vec2 segmentEnd = mix(next.xy, pos.xy, isEndVertex);`:""}
    `),r.code.add(w`left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);
vec2 capDisplacementDir = vec2(0, 0);
vec2 joinDisplacementDir = vec2(0, 0);
float displacementLen = lineWidth;
if (isJoin) {
bool isOutside = (left.x * right.y - left.y * right.x) * uv0.y > 0.0;
joinDisplacementDir = normalize(left + right);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
if (leftLen > 0.001 && rightLen > 0.001) {
float nDotSeg = dot(joinDisplacementDir, left);
displacementLen /= length(nDotSeg * left - joinDisplacementDir);
if (!isOutside) {
displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
}
}
if (isOutside && (displacementLen > miterLimit * lineWidth)) {`),t.roundJoins?r.code.add(w`
        vec2 startDir = leftLen < 0.001 ? right : left;
        startDir = PERPENDICULAR(startDir);

        vec2 endDir = rightLen < 0.001 ? left : right;
        endDir = PERPENDICULAR(endDir);

        float factor = ${t.stippleEnabled?w`min(1.0, subdivisionFactor * ${w.float((PF+2)/(PF+1))})`:w`subdivisionFactor`};

        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
        joinDisplacementDir = rotate(startDir, -sign(uv0.y) * factor * rotationAngle);
      `):r.code.add(w`if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;
}
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);`);const f=t.capType!==Nh.BUTT;return r.code.add(w`
        displacementLen = lineWidth;
      }
    } else {
      // CAP handling ---------------------------------------------------
      joinDisplacementDir = isStartVertex ? right : left;
      joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);

      ${f?w`capDisplacementDir = isStartVertex ? -right : left;`:""}
    }
  `),r.code.add(w`
    // Displacement (in pixels) caused by join/or cap
    vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;

    ${p||c?w`float lineDistNorm = sign(uv0.y) * pos.w;`:""}

    ${c?w`vLineDistance = lineWidth * lineDistNorm;`:""}
    ${p?w`vLineDistanceNorm = lineDistNorm;`:""}

    pos.xy += dpos;
  `),o&&r.code.add(w`vec2 segmentDir = normalize(segment);
vSegmentSDF = (isJoin && isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentOrigin, segmentDir) * pos.w) ;
vReverseSegmentSDF = (isJoin && !isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentEnd, -segmentDir) * pos.w);`),t.stippleEnabled&&(t.draped?r.uniforms.add(new Pe("worldToScreenRatio",(m,y)=>1/y.screenToPCSRatio)):r.code.add(w`vec3 segmentCenter = mix((auxpos2 + position) * 0.5, (position + auxpos1) * 0.5, isEndVertex);
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),r.code.add(w`float segmentLengthScreenDouble = length(segment);
float segmentLengthScreen = segmentLengthScreenDouble * 0.5;
float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);
float segmentLengthRender = length(mix(auxpos2 - position, position - auxpos1, isEndVertex));
vStipplePatternStretch = worldToScreenRatio / discreteWorldToScreenRatio;`),t.draped?r.code.add(w`float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;
float startPseudoScreen = uv0.x * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);`):r.code.add(w`float startPseudoScreen = mix(uv0.x, uv0.x - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),r.uniforms.add(new Pe("stipplePatternPixelSize",m=>LZ(m))),r.code.add(w`
      float patternLength = ${t.stippleScaleWithLineWidth?"lineSize * ":""} stipplePatternPixelSize;

      // Compute the coordinates at both start and end of the line segment, because we need both to clamp to in the fragment shader
      vStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);

      vStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);

      // Adjust the coordinate to the displaced position (the pattern is shortened/overextended on the in/outside of joins)
      if (segmentLengthScreenDouble >= 0.001) {
        // Project the actual vertex position onto the line segment. Note that the resulting factor is within [0..1] at the
        // original vertex positions, and slightly outside of that range at the displaced positions
        vec2 stippleDisplacement = pos.xy - segmentOrigin;
        float stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);

        // Apply this offset to the actual vertex coordinate (can be screen or pseudo-screen space)
        vStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);
      }

      // Cancel out perspective correct interpolation because we want this length the really represent the screen distance
      vStippleDistanceLimits *= pos.w;
      vStippleDistance *= pos.w;

      // Disable stipple distance limits on caps
      vStippleDistanceLimits = isJoin ?
                                 vStippleDistanceLimits :
                                 isStartVertex ?
                                  vec2(-1e038, vStippleDistanceLimits.y) :
                                  vec2(vStippleDistanceLimits.x, 1e038);
    `)),r.code.add(w`
      // Convert back into NDC
      pos.xy = (pos.xy / viewport.zw) * pos.w;

      vColor = getColor();
      vColor.a *= coverage;

      ${t.wireframe&&!t.draped?"pos.z -= 0.001 * pos.w;":""}

      // transform final position to camera space for slicing
      vpos = (inverseProjectionMatrix * pos).xyz;
      gl_Position = pos;
      forwardObjectAndLayerIdColor();
    }
  }
  `),s&&e.include(Fu,t),e.include(Xs,t),i.include(bm),i.code.add(w`
  void main() {
    discardBySlice(vpos);
    ${s?"terrainDepthTest(gl_FragCoord, depth);":""}
  `),t.wireframe?i.code.add(w`vec4 finalColor = vec4(1.0, 0.0, 1.0, 1.0);`):(o&&i.code.add(w`
      float sdf = min(vSegmentSDF, vReverseSegmentSDF);
      vec2 fragmentPosition = vec2(
        min(sdf, 0.0),
        vLineDistance
      ) * gl_FragCoord.w;

      float fragmentRadius = length(fragmentPosition);
      float fragmentCapSDF = (fragmentRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float capCoverage = clamp(0.5 - fragmentCapSDF, 0.0, 1.0);

      if (capCoverage < ${w.float(Yo)}) {
        discard;
      }
    `),h?i.code.add(w`
      vec2 stipplePosition = vec2(
        min(getStippleSDF() * 2.0 - 1.0, 0.0),
        vLineDistanceNorm * gl_FragCoord.w
      );
      float stippleRadius = length(stipplePosition * vLineWidth);
      float stippleCapSDF = (stippleRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);
      float stippleAlpha = step(${w.float(Yo)}, stippleCoverage);
      `):i.code.add(w`float stippleAlpha = getStippleAlpha();`),i.uniforms.add(new pr("intrinsicColor",m=>m.color)),t.output!==k.ObjectAndLayerIdColor&&i.code.add(w`discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);`),i.code.add(w`vec4 color = intrinsicColor * vColor;`),t.innerColorEnabled&&(i.uniforms.add(new pr("innerColor",m=>It(m.innerColor,m.color))),i.uniforms.add(new Pe("innerWidth",(m,y)=>m.innerWidth*y.camera.pixelRatio)),i.code.add(w`float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;
float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);`)),i.code.add(w`vec4 finalColor = blendStipple(color, stippleAlpha);`),t.falloffEnabled&&(i.uniforms.add(new Pe("falloff",m=>m.falloff)),i.code.add(w`finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);`))),i.code.add(w`
    ${t.output===k.ObjectAndLayerIdColor?w`finalColor.a = 1.0;`:""}

    if (finalColor.a < ${w.float(Yo)}) {
      discard;
    }

    ${t.output===k.Alpha?w`gl_FragColor = vec4(finalColor.a);`:""}
    ${t.output===k.Color?w`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${t.output===k.Color&&t.transparencyPassType===xt.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    ${t.output===k.Highlight?w`gl_FragColor = vec4(1.0);`:""}
    ${t.output===k.Depth?w`outputDepth(linearDepth);`:""}
    ${t.output===k.ObjectAndLayerIdColor?w`outputObjectAndLayerIdColor();`:""}
  }
  `),e}const Xst=Object.freeze(Object.defineProperty({__proto__:null,RIBBONLINE_NUM_ROUND_JOIN_SUBDIVISIONS:PF,build:Wst},Symbol.toStringTag,{value:"Module"})),NZ={func:Mi.LESS},IF={func:Mi.ALWAYS},dm={mask:255},DTe={mask:0},Yst=t=>({function:{func:Mi.NOTEQUAL,ref:t,mask:t},operation:{fail:Ls.KEEP,zFail:Ls.KEEP,zPass:Ls.KEEP}}),Zst=t=>({function:{func:Mi.ALWAYS,ref:t,mask:t},operation:{fail:Ls.KEEP,zFail:Ls.KEEP,zPass:Ls.REPLACE}}),Tv={function:{func:Mi.ALWAYS,ref:zl.OutlineVisualElementMask,mask:zl.OutlineVisualElementMask},operation:{fail:Ls.KEEP,zFail:Ls.KEEP,zPass:Ls.ZERO}},hv={function:{func:Mi.ALWAYS,ref:zl.OutlineVisualElementMask,mask:zl.OutlineVisualElementMask},operation:{fail:Ls.KEEP,zFail:Ls.KEEP,zPass:Ls.REPLACE}},NTe={function:{func:Mi.EQUAL,ref:zl.OutlineVisualElementMask,mask:zl.OutlineVisualElementMask},operation:{fail:Ls.KEEP,zFail:Ls.KEEP,zPass:Ls.KEEP}},FTe={function:{func:Mi.NOTEQUAL,ref:zl.OutlineVisualElementMask,mask:zl.OutlineVisualElementMask},operation:{fail:Ls.KEEP,zFail:Ls.KEEP,zPass:Ls.KEEP}},UTe=new Map([[A.POSITION,0],[A.SUBDIVISIONFACTOR,1],[A.UV0,2],[A.AUXPOS1,3],[A.AUXPOS2,4],[A.COLOR,5],[A.COLORFEATUREATTRIBUTE,5],[A.SIZE,6],[A.SIZEFEATUREATTRIBUTE,6],[A.OPACITYFEATUREATTRIBUTE,7],[A.OBJECTANDLAYERIDCOLOR,8]]);let kTe=class VTe extends Vr{initializeProgram(e){return new Fr(e.rctx,VTe.shader.get().build(this.configuration),UTe)}_makePipelineState(e,r){const i=this.configuration,s=e===xt.NONE,n=e===xt.FrontFace;return Bt({blending:i.output===k.Color||i.output===k.Alpha?s?Iu:wy(e):null,depthTest:{func:xv(e)},depthWrite:s?i.writeDepth?Xl:null:G5(e),colorWrite:Kt,stencilWrite:i.hasOccludees?dm:null,stencilTest:i.hasOccludees?r?hv:Tv:null,polygonOffset:s||n?i.hasPolygonOffset?Mne:null:H5})}initializePipeline(){const e=this.configuration;if(e.occluder){const r=e.hasPolygonOffset?Mne:null;this._occluderPipelineTransparent=Bt({blending:Iu,polygonOffset:r,depthTest:IF,depthWrite:null,colorWrite:Kt,stencilWrite:null,stencilTest:FTe}),this._occluderPipelineOpaque=Bt({blending:Iu,polygonOffset:r,depthTest:IF,depthWrite:null,colorWrite:Kt,stencilWrite:DTe,stencilTest:NTe}),this._occluderPipelineMaskWrite=Bt({blending:null,polygonOffset:r,depthTest:NZ,depthWrite:null,colorWrite:null,stencilWrite:dm,stencilTest:hv})}return this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return this.configuration.wireframe?$t.LINES:$t.TRIANGLE_STRIP}getPipelineState(e,r){return r?this._occludeePipelineState:this.configuration.occluder?e===Se.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:e===Se.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(e,r)}};kTe.shader=new Nr(Xst,()=>te(()=>import("./RibbonLine.glsl-145afe61.js"),[]));const Mne={factor:0,units:-4};var pc;(function(t){t[t.LEFT_JOIN_START=-2]="LEFT_JOIN_START",t[t.LEFT_JOIN_END=-1]="LEFT_JOIN_END",t[t.LEFT_CAP_START=-4]="LEFT_CAP_START",t[t.LEFT_CAP_END=-5]="LEFT_CAP_END",t[t.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",t[t.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",t[t.RIGHT_CAP_START=4]="RIGHT_CAP_START",t[t.RIGHT_CAP_END=5]="RIGHT_CAP_END"})(pc||(pc={}));let L2=class extends wv{constructor(e){super(e,new Kst),this._configuration=new Ji,this._vertexAttributeLocations=UTe,this._layout=this.createLayout()}isClosed(e,r){return zTe(this.parameters,e,r)}getConfiguration(e,r){this._configuration.output=e,this._configuration.draped=r.slot===Se.DRAPED_MATERIAL;const i=v(this.parameters.stipplePattern)&&e!==k.Highlight;return this._configuration.stippleEnabled=i,this._configuration.stippleOffColorEnabled=i&&v(this.parameters.stippleOffColor),this._configuration.stippleScaleWithLineWidth=i&&this.parameters.stippleScaleWithLineWidth,this._configuration.stipplePreferContinuous=i&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.roundJoins=this.parameters.join==="round",this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=!!v(this.parameters.markerParameters)&&ent(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.vvOpacity=this.parameters.vvOpacityEnabled,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&v(this.parameters.innerColor),this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.occluder=this.parameters.renderOccluded===ns.OccludeAndTransparentStencil,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration.wireframe=this.parameters.wireframe,this._configuration}intersectDraped(e,r,i,s,n,o){if(!i.options.selectionMode)return;const a=e.vertexAttributes.get(A.POSITION).data,l=e.vertexAttributes.get(A.SIZE);let c=this.parameters.width;if(this.parameters.vvSizeEnabled){const _=e.vertexAttributes.get(A.SIZEFEATUREATTRIBUTE).data[0];c*=ge(this.parameters.vvSizeOffset[0]+_*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else l&&(c*=l.data[0]);const h=s[0],p=s[1],f=(c/2+4)*e.screenToWorldRatio;let m=Number.MAX_VALUE,y=0;for(let _=0;_<a.length-5;_+=3){const b=a[_],x=a[_+1],T=h-b,S=p-x,E=a[_+3]-b,O=a[_+4]-x,R=ge((E*T+O*S)/(E*E+O*O),0,1),L=E*R-T,P=O*R-S,U=L*L+P*P;U<m&&(m=U,y=_/3)}m<f*f&&n(o.dist,o.normal,y,!1)}intersect(e,r,i,s,n,o){if(!i.options.selectionMode||!e.visible)return;if(!rbe(r))return void se.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");const a=e.vertexAttributes,l=a.get(A.POSITION).data;let c=this.parameters.width;if(this.parameters.vvSizeEnabled){const T=a.get(A.SIZEFEATUREATTRIBUTE).data[0];c*=ge(this.parameters.vvSizeOffset[0]+T*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else a.has(A.SIZE)&&(c*=a.get(A.SIZE).data[0]);const h=i.camera,p=tnt;Un(p,i.point);const f=c*h.pixelRatio/2+4*h.pixelRatio;ce(DC[0],p[0]-f,p[1]+f,0),ce(DC[1],p[0]+f,p[1]+f,0),ce(DC[2],p[0]+f,p[1]-f,0),ce(DC[3],p[0]-f,p[1]-f,0);for(let T=0;T<4;T++)if(!h.unprojectFromRenderScreen(DC[T],Um[T]))return;la(h.eye,Um[0],Um[1],u9),la(h.eye,Um[1],Um[2],h9),la(h.eye,Um[2],Um[3],d9),la(h.eye,Um[3],Um[0],p9);let m=Number.MAX_VALUE,y=0;const _=BTe(this.parameters,a,e.indices)?l.length-2:l.length-5;for(let T=0;T<_;T+=3){fl[0]=l[T]+r[12],fl[1]=l[T+1]+r[13],fl[2]=l[T+2]+r[14];const S=(T+3)%l.length;if(ml[0]=l[S]+r[12],ml[1]=l[S+1]+r[13],ml[2]=l[S+2]+r[14],bi(u9,fl)<0&&bi(u9,ml)<0||bi(h9,fl)<0&&bi(h9,ml)<0||bi(d9,fl)<0&&bi(d9,ml)<0||bi(p9,fl)<0&&bi(p9,ml)<0)continue;if(h.projectToRenderScreen(fl,Wv),h.projectToRenderScreen(ml,Xv),Wv[2]<0&&Xv[2]>0){me(Dp,fl,ml);const O=h.frustum,R=-bi(O[vi.NEAR],fl)/ye(Dp,O[vi.NEAR]);ae(Dp,Dp,R),fe(fl,fl,Dp),h.projectToRenderScreen(fl,Wv)}else if(Wv[2]>0&&Xv[2]<0){me(Dp,ml,fl);const O=h.frustum,R=-bi(O[vi.NEAR],ml)/ye(Dp,O[vi.NEAR]);ae(Dp,Dp,R),fe(ml,ml,Dp),h.projectToRenderScreen(ml,Xv)}else if(Wv[2]<0&&Xv[2]<0)continue;Wv[2]=0,Xv[2]=0;const E=OW(Yb(Wv,Xv,$ne),p);E<m&&(m=E,le(Pne,fl),le(Ine,ml),y=T/3)}const b=i.rayBegin,x=i.rayEnd;if(m<f*f){let T=Number.MAX_VALUE;if(Qfe(Yb(Pne,Ine,$ne),Yb(b,x,rnt),qv)){me(qv,qv,b);const S=Me(qv);ae(qv,qv,1/S),T=S/xi(b,x)}o(T,qv,y,!1)}}createLayout(){const e=ts().vec3f(A.POSITION).f32(A.SUBDIVISIONFACTOR).vec2f(A.UV0).vec3f(A.AUXPOS1).vec3f(A.AUXPOS2);return this.parameters.vvSizeEnabled?e.f32(A.SIZEFEATUREATTRIBUTE):e.f32(A.SIZE),this.parameters.vvColorEnabled?e.f32(A.COLORFEATUREATTRIBUTE):e.vec4f(A.COLOR),this.parameters.vvOpacityEnabled&&e.f32(A.OPACITYFEATUREATTRIBUTE),de("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(A.OBJECTANDLAYERIDCOLOR),e}createBufferWriter(){return new Qst(this._layout,this.parameters)}requiresSlot(e,r){return r===k.Color||r===k.Alpha||r===k.Highlight||r===k.Depth||r===k.ObjectAndLayerIdColor?e===Se.DRAPED_MATERIAL?!0:this.parameters.renderOccluded===ns.OccludeAndTransparentStencil?e===Se.OPAQUE_MATERIAL||e===Se.OCCLUDER_MATERIAL||e===Se.TRANSPARENT_OCCLUDER_MATERIAL:r===k.Color||r===k.Alpha?e===(this.parameters.writeDepth?Se.TRANSPARENT_MATERIAL:Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):e===Se.OPAQUE_MATERIAL:!1}createGLMaterial(e){return new Jst(e)}validateParameters(e){e.join!=="miter"&&(e.miterLimit=0),v(e.markerParameters)&&(e.markerScale=e.markerParameters.width/e.width)}},Jst=class extends bv{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output!==k.Color&&this._output!==k.Alpha||this._updateOccludeeState(e);const r=this._material.parameters.stipplePattern;return this._stipplePattern!==r&&(this._material.setParameters(this._stippleTextureRepository.swap(this._stipplePattern,r)),this._stipplePattern=r),this.ensureTechnique(kTe,e)}},Kst=class extends vZ{constructor(){super(...arguments),this.width=0,this.color=Rh,this.join="miter",this.cap=Nh.BUTT,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stippleScaleWithLineWidth=!1,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.hasOccludees=!1,this.wireframe=!1}},Qst=class{constructor(e,r){this._parameters=r,this.numJoinSubdivisions=0,this.vertexBufferLayout=e;const i=r.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=i;break;case"round":this.numJoinSubdivisions=PF+i}}_isClosed(e){return BTe(this._parameters,e.vertexAttributes,e.indices)}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){const i=e.indices.get(A.POSITION).length/2+1,s=this._isClosed(e);let n=s?2:2*2;return n+=((s?i:i-1)-(s?0:1))*(2*this.numJoinSubdivisions+4),n+=2,this._parameters.wireframe&&(n=2+4*(n-2)),n}write(e,r,i,s,n){var Q;const o=int,a=snt,l=nnt,c=i.vertexAttributes.get(A.POSITION).data,h=i.indices&&i.indices.get(A.POSITION),p=(Q=i.vertexAttributes.get(A.DISTANCETOSTART))==null?void 0:Q.data;h&&h.length!==2*(c.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let f=1,m=0;this._parameters.vvSizeEnabled?m=i.vertexAttributes.get(A.SIZEFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(A.SIZE)&&(f=i.vertexAttributes.get(A.SIZE).data[0]);let y=[1,1,1,1],_=0;this._parameters.vvColorEnabled?_=i.vertexAttributes.get(A.COLORFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(A.COLOR)&&(y=i.vertexAttributes.get(A.COLOR).data);const b=de("enable-feature:objectAndLayerId-rendering")?i.objectAndLayerIdColor:null;let x=0;this._parameters.vvOpacityEnabled&&(x=i.vertexAttributes.get(A.OPACITYFEATUREATTRIBUTE).data[0]);const T=c.length/3,S=new Float32Array(s.buffer),E=de("enable-feature:objectAndLayerId-rendering")?new Uint8Array(s.buffer):null,O=this.vertexBufferLayout.stride/4;let R=n*O;const L=R;let P=0;const U=p?(H,$,N)=>P=p[N]:(H,$,N)=>P+=xi(H,$),B=de("enable-feature:objectAndLayerId-rendering"),z=(H,$,N,F,j,X,J)=>{if(S[R++]=$[0],S[R++]=$[1],S[R++]=$[2],S[R++]=F,S[R++]=J,S[R++]=j,S[R++]=H[0],S[R++]=H[1],S[R++]=H[2],S[R++]=N[0],S[R++]=N[1],S[R++]=N[2],this._parameters.vvSizeEnabled?S[R++]=m:S[R++]=f,this._parameters.vvColorEnabled)S[R++]=_;else{const W=Math.min(4*X,y.length-4);S[R++]=y[W],S[R++]=y[W+1],S[R++]=y[W+2],S[R++]=y[W+3]}this._parameters.vvOpacityEnabled&&(S[R++]=x),B&&(v(b)&&(E[4*R]=b[0],E[4*R+1]=b[1],E[4*R+2]=b[2],E[4*R+3]=b[3]),R++)};R+=O,ce(a,c[0],c[1],c[2]),e&&We(a,a,e);const G=this._isClosed(i);if(G){const H=c.length-3;ce(o,c[H],c[H+1],c[H+2]),e&&We(o,o,e)}else ce(l,c[3],c[4],c[5]),e&&We(l,l,e),z(a,a,l,1,pc.LEFT_CAP_START,0,0),z(a,a,l,1,pc.RIGHT_CAP_START,0,0),le(o,a),le(a,l);const K=G?0:1,ee=G?T:T-1;for(let H=K;H<ee;H++){const $=(H+1)%T*3;ce(l,c[$],c[$+1],c[$+2]),e&&We(l,l,e),U(o,a,H),z(o,a,l,0,pc.LEFT_JOIN_END,H,P),z(o,a,l,0,pc.RIGHT_JOIN_END,H,P);const N=this.numJoinSubdivisions;for(let F=0;F<N;++F){const j=(F+1)/(N+1);z(o,a,l,j,pc.LEFT_JOIN_END,H,P),z(o,a,l,j,pc.RIGHT_JOIN_END,H,P)}z(o,a,l,1,pc.LEFT_JOIN_START,H,P),z(o,a,l,1,pc.RIGHT_JOIN_START,H,P),le(o,a),le(a,l)}G?(ce(l,c[3],c[4],c[5]),e&&We(l,l,e),P=U(o,a,ee),z(o,a,l,0,pc.LEFT_JOIN_END,K,P),z(o,a,l,0,pc.RIGHT_JOIN_END,K,P)):(P=U(o,a,ee),z(o,a,a,0,pc.LEFT_CAP_END,ee,P),z(o,a,a,0,pc.RIGHT_CAP_END,ee,P)),c9(S,L+O,S,L,O),R=c9(S,R-O,S,R,O),this._parameters.wireframe&&this._addWireframeVertices(s,L,R,O)}_addWireframeVertices(e,r,i,s){const n=new Float32Array(e.buffer,i*Float32Array.BYTES_PER_ELEMENT),o=new Float32Array(e.buffer,r*Float32Array.BYTES_PER_ELEMENT,i-r);let a=0;const l=c=>a=c9(o,c,n,a,s);for(let c=0;c<o.length-1;c+=2*s)l(c),l(c+2*s),l(c+1*s),l(c+2*s),l(c+1*s),l(c+3*s)}};function c9(t,e,r,i,s){for(let n=0;n<s;n++)r[i++]=t[e++];return i}function BTe(t,e,r){return zTe(t,e.get(A.POSITION).data,r?r.get(A.POSITION):null)}function zTe(t,e,r){return!!t.isClosed&&(r?r.length>2:e.length>6)}function ent(t){return t.anchor===Nw.Tip&&t.hideOnShortSegments&&t.placement==="begin-end"&&t.worldSpace}const fl=M(),ml=M(),Dp=M(),qv=M(),tnt=M(),Wv=qo(),Xv=qo(),Pne=M(),Ine=M(),$ne=xp(),rnt=xp(),int=M(),snt=M(),nnt=M(),DC=[qo(),qo(),qo(),qo()],Um=[M(),M(),M(),M()],u9=zr(),h9=zr(),d9=zr(),p9=zr();let FZ=class{constructor(e){this._originSR=e,this._origins=new Map,this._objects=new Map,this._gridSize=5e5,this._rootOriginId="root/"+Pc()}getOrigin(e){const r=this._origins.get(this._rootOriginId);if(r==null){const h=Ost.rootOrigin;if(v(h))return this._origins.set(this._rootOriginId,bR(h[0],h[1],h[2],this._rootOriginId)),this.getOrigin(e);const p=bR(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,p),p}const i=this._gridSize,s=Math.round(e[0]/i),n=Math.round(e[1]/i),o=Math.round(e[2]/i),a=`${s}/${n}/${o}`;let l=this._origins.get(a);const c=.5*i;if(me(lo,e,r.vec3),lo[0]=Math.abs(lo[0]),lo[1]=Math.abs(lo[1]),lo[2]=Math.abs(lo[2]),lo[0]<c&&lo[1]<c&&lo[2]<c){if(l){const h=Math.max(...lo);if(me(lo,e,l.vec3),lo[0]=Math.abs(lo[0]),lo[1]=Math.abs(lo[1]),lo[2]=Math.abs(lo[2]),Math.max(...lo)<h)return l}return r}return l||(l=bR(s*i,n*i,o*i,a),this._origins.set(a,l)),l}_drawOriginBox(e,r=Ht(1,1,0,1)){const i=window.view,s=i._stage,n=r.toString();if(!this._objects.has(n)){this._material=new L2({width:2,color:r}),s.add(this._material);const m=new CTe({pickable:!1}),y=new Ty({castShadow:!1});s.add(y),m.add(y),s.add(m),this._objects.set(n,y)}const o=this._objects.get(n),a=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],l=a.length,c=new Array(3*l),h=new Array,p=.5*this._gridSize;for(let m=0;m<l;m++)c[3*m+0]=e[0]+(1&a[m]?p:-p),c[3*m+1]=e[1]+(2&a[m]?p:-p),c[3*m+2]=e[2]+(4&a[m]?p:-p),m>0&&h.push(m-1,m);_s(c,this._originSR,0,c,i.renderSpatialReference,0,l);const f=new nn(this._material,[[A.POSITION,new Xe(c,3,!0)]],[[A.POSITION,h]],null,$s.Line);s.add(f),o.addGeometry(f)}get test(){const e=this;return{set gridSize(r){e._gridSize=r}}}};const lo=M();let GTe=class{constructor(e,r,i,s=null){this.rctx=e,this.sliceHelper=s,this.lastFrameCamera=new Ct,this.output=k.Color,this.renderOccludedMask=Lne,this.bindParameters=new v5(r,i,v(s)?s.plane:null)}resetRenderOccludedMask(){this.renderOccludedMask=Lne}},ont=class extends GTe{constructor(e,r,i,s,n){super(e,i,s,n),this.offscreenRenderingHelper=r,this.sliceHelper=n,this.time=0}};const Lne=ns.Occlude|ns.OccludeAndTransparent|ns.OccludeAndTransparentStencil;let v3=class extends Ct{constructor(){super(...arguments),this._projectionMatrix=Ie()}get projectionMatrix(){return this._projectionMatrix}};u([d()],v3.prototype,"_projectionMatrix",void 0),u([d({readOnly:!0})],v3.prototype,"projectionMatrix",null),v3=u([I("esri.views.3d.webgl-engine.lib.CascadeCamera")],v3);var cE;(function(t){t[t.Highlight=0]="Highlight",t[t.Default=1]="Default"})(cE||(cE={}));let DI=class{constructor(){this.camera=new v3,this.lightMat=Ie()}},UZ=class{get depthTexture(){return this._depthTexture}get textureSize(){return this._textureSize}get numCascades(){return this._numCascades}get cascadeDistances(){return ti(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}constructor(e,r){this._rctx=e,this._viewingMode=r,this._enabled=!1,this._snapshots=new Array,this._textureSize=0,this._numCascades=1,this._maxNumCascades=4,this._projectionView=Ie(),this._projectionViewInverse=Ie(),this._modelViewLight=Ie(),this._splitSchemeLambda=0,this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=sr(),this._cascades=[new DI,new DI,new DI,new DI],this._lastOrigin=null,this._maxTextureSize=Math.min(de("esri-mobile")?2048:8192,this._rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}disposeOffscreenBuffers(){this._discardDepthTexture(),this._discardAllSnapshots()}set maxCascades(e){this._maxNumCascades=ge(Math.floor(e),1,4)}get maxCascades(){return this._maxNumCascades}set enabled(e){this._enabled=e,e||(this._discardDepthTexture(),this._discardAllSnapshots())}get enabled(){return this._enabled}get ready(){return this._enabled&&v(this._depthTexture)}getSnapshot(e){return this.enabled?this._snapshots[e]:null}get cascades(){for(let e=0;e<this._numCascades;++e)m9[e]=this._cascades[e];return m9.length=this._numCascades,m9}start(e,r,i){ft(this.enabled),this._textureSize=this._computeTextureSize(e.fullWidth,e.fullHeight),this._ensureDepthTexture();const{near:s,far:n}=this._clampNearFar(i);this._computeCascadeDistances(n,s),this._setupMatrices(e,r);const{viewMatrix:o,projectionMatrix:a}=e;for(let l=0;l<this._numCascades;++l)this._constructCascade(l,a,o,r);this._lastOrigin=null,this.clear()}finish(e){ft(this.enabled),this._rctx.bindFramebuffer(e)}getShadowMapMatrices(e){if(!this._lastOrigin||!Ya(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||M(),le(this._lastOrigin,e);for(let r=0;r<this._numCascades;++r){ql(Vne,this._cascades[r].lightMat,e);for(let i=0;i<16;++i)Bne[16*r+i]=Vne[i]}}return Bne}takeCascadeSnapshotTo(e,r){ft(this.enabled);const i=this._ensureSnapshot(r);this._bindFbo();const s=this._rctx,n=s.bindTexture(i,ct.TEXTURE_UNIT_FOR_UPDATES);s.gl.copyTexSubImage2D(bt.TEXTURE_2D,0,e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[2],e.camera.viewport[3]),s.bindTexture(n,ct.TEXTURE_UNIT_FOR_UPDATES)}clear(){const e=this._rctx;this._bindFbo(),e.setClearColor(1,1,1,1),e.clearSafe(Li.COLOR_BUFFER_BIT|Li.DEPTH_BUFFER_BIT)}_computeTextureSize(e,r){const i=.5*Math.log(e*e+r*r)*Math.LOG2E,s=.35,n=2**Math.round(i+s);return Math.min(this._maxTextureSize,2*n)}_ensureDepthTexture(){if(v(this._depthTexture)&&this._depthTexture.descriptor.width===this._textureSize)return;this._discardDepthTexture();const e={target:bt.TEXTURE_2D,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Rt.CLAMP_TO_EDGE,samplingMode:tt.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize};this._depthTexture=new ct(this._rctx,e),this._fbo=new Ds(this._rctx,{colorTarget:ls.TEXTURE,depthStencilTarget:$r.DEPTH_RENDER_BUFFER,width:this._textureSize,height:this._textureSize},this._depthTexture)}_ensureSnapshot(e){let r=this._snapshots[e];if(v(r)&&r.descriptor.width===this._textureSize)return r;this._discardSnapshot(e);const i={target:bt.TEXTURE_2D,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Rt.CLAMP_TO_EDGE,samplingMode:tt.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize};return r=new ct(this._rctx,i),this._snapshots[e]=r,r}_discardDepthTexture(){this._fbo=Qe(this._fbo),this._depthTexture=Qe(this._depthTexture)}_discardSnapshot(e){this._snapshots[e]=Qe(this._snapshots[e])}_discardAllSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}_bindFbo(){const e=this._rctx;e.unbindTexture(this._depthTexture),e.bindFramebuffer(this._fbo)}_constructCascade(e,r,i,s){const n=this._cascades[e],o=-this._cascadeDistances[e],a=-this._cascadeDistances[e+1],l=(r[10]*o+r[14])/Math.abs(r[11]*o+r[15]),c=(r[10]*a+r[14])/Math.abs(r[11]*a+r[15]);ft(l<c);for(let m=0;m<8;++m){ti(Dne,m%4==0||m%4==3?-1:1,m%4==0||m%4==1?-1:1,m<4?l:c,1);const y=gh[m];Su(y,Dne,this._projectionViewInverse),y[0]/=y[3],y[1]/=y[3],y[2]/=y[3]}ga(f9,gh[0]),n.camera.viewMatrix=ql(ant,this._modelViewLight,f9);for(let m=0;m<8;++m)We(gh[m],gh[m],n.camera.viewMatrix);let h=gh[0][2],p=gh[0][2];for(let m=1;m<8;++m)h=Math.min(h,gh[m][2]),p=Math.max(p,gh[m][2]);h-=200,p+=200,n.camera.near=-p,n.camera.far=-h,hnt(i,s,h,p,n.camera),gs(n.lightMat,n.camera.projectionMatrix,n.camera.viewMatrix);const f=this._textureSize/2;n.camera.viewport=[e%2==0?0:f,Math.floor(e/2)===0?0:f,f,f]}_setupMatrices(e,r){gs(this._projectionView,e.projectionMatrix,e.viewMatrix),Oo(this._projectionViewInverse,this._projectionView);const i=this._viewingMode===Be.Global?e.eye:ce(f9,0,0,1);L4(this._modelViewLight,[0,0,0],[-r[0],-r[1],-r[2]],i)}_clampNearFar(e){let{near:r,far:i}=e;return r<2&&(r=2),i<2&&(i=2),r>=i&&(r=2,i=4),{near:r,far:i}}_computeCascadeDistances(e,r){this._numCascades=Math.min(1+Math.floor(XXe(e/r,4)),this._maxNumCascades);const i=(e-r)/this._numCascades,s=(e/r)**(1/this._numCascades);let n=r,o=r;for(let a=0;a<this._numCascades+1;++a)this._cascadeDistances[a]=Ft(n,o,this._splitSchemeLambda),n*=s,o+=i}get gpuMemoryUsage(){var e;return this._snapshots.reduce((r,i)=>r+Ow(i),((e=this._fbo)==null?void 0:e.gpuMemoryUsage)??0)}get test(){const e=this;return{maxNumCascades:this._maxNumCascades,cascades:this._cascades,textureSize:this._textureSize,set splitSchemeLambda(r){e._splitSchemeLambda=r},get splitSchemeLambda(){return e._splitSchemeLambda}}}};const ant=Ie(),Dne=sr(),gh=[];for(let t=0;t<8;++t)gh.push(sr());const Nne=Je(),Fne=Je(),lnt=Je(),Une=Je(),kne=Je(),f9=M(),m9=[],Vne=Ie(),Bne=new Float32Array(64),Wc=Je(),Lx=Je(),Yv=[Je(),Je(),Je(),Je()],Cn=Je(),g9=Je(),Yy=Je(),NC=Je(),Dx=Je(),Nx=Je(),NI=Je();function cnt(t,e,r,i,s,n,o,a){or(Wc,0,0);for(let O=0;O<4;++O)Vd(Wc,Wc,t[O]);Sc(Wc,Wc,.25),or(Lx,0,0);for(let O=4;O<8;++O)Vd(Lx,Lx,t[O]);Sc(Lx,Lx,.25),QT(Yv[0],t[4],t[5],.5),QT(Yv[1],t[5],t[6],.5),QT(Yv[2],t[6],t[7],.5),QT(Yv[3],t[7],t[4],.5);let l=0,c=YN(Yv[0],Wc);for(let O=1;O<4;++O){const R=YN(Yv[O],Wc);R<c&&(c=R,l=O)}If(Cn,Yv[l],t[l+4]);const h=Cn[0];let p,f;Cn[0]=-Cn[1],Cn[1]=h,If(g9,Lx,Wc),pn(g9,Cn)<0&&KX(Cn,Cn),QT(Cn,Cn,g9,r),cO(Cn,Cn),p=f=pn(If(Yy,t[0],Wc),Cn);for(let O=1;O<8;++O){const R=pn(If(Yy,t[O],Wc),Cn);R<p?p=R:R>f&&(f=R)}Un(i,Wc),Sc(Yy,Cn,p-e),Vd(i,i,Yy);let m=-1,y=1,_=0,b=0;for(let O=0;O<8;++O){If(NC,t[O],i),cO(NC,NC);const R=Cn[0]*NC[1]-Cn[1]*NC[0];R>0?R>m&&(m=R,_=O):R<y&&(y=R,b=O)}yx(m>0,"leftArea"),yx(y<0,"rightArea"),Sc(Dx,Cn,p),Vd(Dx,Dx,Wc),Sc(Nx,Cn,f),Vd(Nx,Nx,Wc),NI[0]=-Cn[1],NI[1]=Cn[0];const x=XP(i,t[b],Nx,Vd(Yy,Nx,NI),1,s),T=XP(i,t[_],Nx,Yy,1,n),S=XP(i,t[_],Dx,Vd(Yy,Dx,NI),1,o),E=XP(i,t[b],Dx,Yy,1,a);yx(x,"rayRay"),yx(T,"rayRay"),yx(S,"rayRay"),yx(E,"rayRay")}function Cr(t,e){return 3*e+t}const zne=Je();function Jl(t,e){return or(zne,t[e],t[e+3]),zne}const gl=Je(),st=es();function unt(t,e,r,i,s){If(gl,r,i),Sc(gl,gl,.5),st[0]=gl[0],st[1]=gl[1],st[2]=0,st[3]=gl[1],st[4]=-gl[0],st[5]=0,st[6]=gl[0]*gl[0]+gl[1]*gl[1],st[7]=gl[0]*gl[1]-gl[1]*gl[0],st[8]=1,st[Cr(0,2)]=-pn(Jl(st,0),t),st[Cr(1,2)]=-pn(Jl(st,1),t);let n=pn(Jl(st,0),r)+st[Cr(0,2)],o=pn(Jl(st,1),r)+st[Cr(1,2)],a=pn(Jl(st,0),i)+st[Cr(0,2)],l=pn(Jl(st,1),i)+st[Cr(1,2)];n=-(n+a)/(o+l),st[Cr(0,0)]+=st[Cr(1,0)]*n,st[Cr(0,1)]+=st[Cr(1,1)]*n,st[Cr(0,2)]+=st[Cr(1,2)]*n,n=1/(pn(Jl(st,0),r)+st[Cr(0,2)]),o=1/(pn(Jl(st,1),r)+st[Cr(1,2)]),st[Cr(0,0)]*=n,st[Cr(0,1)]*=n,st[Cr(0,2)]*=n,st[Cr(1,0)]*=o,st[Cr(1,1)]*=o,st[Cr(1,2)]*=o,st[Cr(2,0)]=st[Cr(1,0)],st[Cr(2,1)]=st[Cr(1,1)],st[Cr(2,2)]=st[Cr(1,2)],st[Cr(1,2)]+=1,n=pn(Jl(st,1),e)+st[Cr(1,2)],o=pn(Jl(st,2),e)+st[Cr(2,2)],a=pn(Jl(st,1),r)+st[Cr(1,2)],l=pn(Jl(st,2),r)+st[Cr(2,2)],n=-.5*(n/o+a/l),st[Cr(1,0)]+=st[Cr(2,0)]*n,st[Cr(1,1)]+=st[Cr(2,1)]*n,st[Cr(1,2)]+=st[Cr(2,2)]*n,n=pn(Jl(st,1),e)+st[Cr(1,2)],o=pn(Jl(st,2),e)+st[Cr(2,2)],a=-o/n,st[Cr(1,0)]*=a,st[Cr(1,1)]*=a,st[Cr(1,2)]*=a,s[0]=st[0],s[1]=st[1],s[2]=0,s[3]=st[2],s[4]=st[3],s[5]=st[4],s[6]=0,s[7]=st[5],s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=st[6],s[13]=st[7],s[14]=0,s[15]=st[8]}function hnt(t,e,r,i,s){const n=1/gh[0][3],o=1/gh[4][3];ft(n<o);let a=n+Math.sqrt(n*o);const l=Math.sin(Sn(t[2]*e[0]+t[6]*e[1]+t[10]*e[2]));a/=l,cnt(gh,a,l,Nne,Fne,lnt,Une,kne),unt(Nne,Fne,Une,kne,s.projectionMatrix),s.projectionMatrix[10]=2/(r-i),s.projectionMatrix[14]=-(r+i)/(r-i)}function dnt(t){return Ep(t)&&t.intersector===Qi.TERRAIN&&!!t.target}let pnt=class extends R5{constructor(e,r,i){super(e,r),this.triangleNr=i}};function jTe(t){return Ep(t)&&t.intersector===Qi.OVERLAY&&!!t.target}let Hj=class{constructor(){this.adds=new Jt,this.removes=new Jt,this.updates=new Jt({allocator:e=>e||new fnt,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}get empty(){return this.adds.length===0&&this.removes.length===0&&this.updates.length===0}},fnt=class{},mnt=class{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}};var ss,Pn;(function(t){t[t.ADD=0]="ADD",t[t.UPDATE=1]="UPDATE",t[t.REMOVE=2]="REMOVE"})(ss||(ss={})),function(t){t[t.NONE=0]="NONE",t[t.VISIBILITY=1]="VISIBILITY",t[t.GEOMETRY=2]="GEOMETRY",t[t.TRANSFORMATION=4]="TRANSFORMATION",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.OCCLUDEE=16]="OCCLUDEE"}(Pn||(Pn={}));function HTe(t){const e=new Map,r=i=>{let s=e.get(i);return s||(s=new mnt,e.set(i,s)),s};return t.removes.forAll(i=>{y9(i)&&r(i.material).removes.push(i)}),t.adds.forAll(i=>{y9(i)&&r(i.material).adds.push(i)}),t.updates.forAll(i=>{y9(i.renderGeometry)&&r(i.renderGeometry.material).updates.push(i)}),e}function y9(t){return t.geometry.indexCount>=1}let gnt=class{constructor(e){this._rctx=e,this._indexBuffer=this._createIndexbuffer(),this._program=this._createProgram()}_createProgram(){const e=`
    void main(void) {
      gl_Position = vec4(0.0, 0.0, float(gl_VertexID)-2.0, 1.0);
    }`,r=`
    void main(void) {
      gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
    }`;return this._rctx.programCache.acquire(e,r,new Map([]))}_createIndexbuffer(){return jr.createIndex(this._rctx,Lr.STATIC_DRAW,new Uint32Array([0]))}resetIndicesType(){this._program.compiled&&this._indexBuffer&&(this._rctx.bindVAO(null),this._rctx.useProgram(this._program),this._rctx.bindBuffer(this._indexBuffer,Ot.ELEMENT_ARRAY_BUFFER),this._rctx.drawElements($t.POINTS,1,lt.UNSIGNED_INT,0))}dispose(){this._program.dispose(),this._indexBuffer.dispose()}},qTe=class{constructor(e,r){this._material=e,this._repository=r,this._map=new Map}destroy(){this._map.forEach((e,r)=>{v(e)&&this._repository.release(this._material,r)})}load(e,r,i){if(!this._material.requiresSlot(r,i))return null;this._map.has(i)||this._map.set(i,this._repository.acquire(this._material,r,i));const s=this._map.get(i);if(v(s)){if(s.ensureResources(e)===Vg.LOADED)return s;this._repository.requestRender()}return null}};function ynt(t){const e=w`vec3 decodeNormal(vec2 f) {
float z = 1.0 - abs(f.x) - abs(f.y);
return vec3(f + sign(f) * min(z, 0.0), z);
}`;t.vertex.code.add(e)}function UM(t,e){switch(e.normalType){case si.CompressedAttribute:t.include(ynt),t.attributes.add(A.NORMALCOMPRESSED,"vec2"),t.vertex.code.add(w`vec3 normalModel() {
return decodeNormal(normalCompressed);
}`);break;case si.Attribute:t.attributes.add(A.NORMAL,"vec3"),t.vertex.code.add(w`vec3 normalModel() {
return normal;
}`);break;case si.ScreenDerivative:t.extensions.add("GL_OES_standard_derivatives"),t.fragment.code.add(w`vec3 screenDerivativeNormal(vec3 positionView) {
return normalize(cross(dFdx(positionView), dFdy(positionView)));
}`);break;default:e.normalType;case si.COUNT:case si.Ground:}}var si;(function(t){t[t.Attribute=0]="Attribute",t[t.CompressedAttribute=1]="CompressedAttribute",t[t.Ground=2]="Ground",t[t.ScreenDerivative=3]="ScreenDerivative",t[t.COUNT=4]="COUNT"})(si||(si={}));function J5(t,e){switch(e.normalType){case si.Attribute:case si.CompressedAttribute:t.include(UM,e),t.varyings.add("vNormalWorld","vec3"),t.varyings.add("vNormalView","vec3"),t.vertex.uniforms.add([new dO("transformNormalGlobalFromModel",r=>r.transformNormalGlobalFromModel),new wm("transformNormalViewFromGlobal",r=>r.transformNormalViewFromGlobal)]),t.vertex.code.add(w`void forwardNormal() {
vNormalWorld = transformNormalGlobalFromModel * normalModel();
vNormalView = transformNormalViewFromGlobal * vNormalWorld;
}`);break;case si.Ground:t.include(tS,e),t.varyings.add("vNormalWorld","vec3"),t.vertex.code.add(w`
        void forwardNormal() {
          vNormalWorld = ${e.spherical?w`normalize(vPositionWorldCameraRelative);`:w`vec3(0.0, 0.0, 1.0);`}
        }
        `);break;case si.ScreenDerivative:t.vertex.code.add(w`void forwardNormal() {}`);break;default:e.normalType;case si.COUNT:}}let WTe=class extends N1e{constructor(){super(...arguments),this.transformNormalViewFromGlobal=es()}},XTe=class extends F1e{constructor(){super(...arguments),this.transformNormalGlobalFromModel=es(),this.toMapSpace=sr()}},qj=class extends XTe{constructor(e=M()){super(),this.origin=e,this.slicePlaneLocalOrigin=this.origin}},XE=class{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get(A.POSITION).length}write(e,r,i,s,n){oxe(i,this.vertexBufferLayout,e,r,s,n)}};const _nt=ts().vec3f(A.POSITION),vnt=ts().vec3f(A.POSITION).vec2f(A.UV0),YTe=ts().vec3f(A.POSITION).vec4u8(A.COLOR);ts().vec3f(A.POSITION).vec4u8(A.OBJECTANDLAYERIDCOLOR);ts().vec3f(A.POSITION).vec2f(A.UV0).vec4u8(A.OBJECTANDLAYERIDCOLOR);const bnt=ts().vec3f(A.POSITION).vec4u8(A.COLOR).vec4u8(A.OBJECTANDLAYERIDCOLOR);let kZ=class extends wv{intersect(e,r,i,s,n,o){return Ywe(e,i,s,n,void 0,o)}};function wnt(t){t.fragment.code.add(w`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function xnt(t){t.fragment.code.add(w`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}function Gne(t){t.fragment.uniforms.add(new Mt("texWaveNormal",e=>e.waveNormal)),t.fragment.uniforms.add(new Mt("texWavePerturbation",e=>e.wavePertubation)),t.fragment.uniforms.add([new pr("waveParams",e=>ti(Tnt,e.waveStrength,e.waveTextureRepeat,e.flowStrength,e.flowOffset)),new kr("waveDirection",e=>or(Snt,e.waveDirection[0]*e.waveVelocity,e.waveDirection[1]*e.waveVelocity))]),t.include(wnt),t.fragment.code.add(w`const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);
vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rg - 1.0;
}
float sampleNoiseTexture(vec2 _uv) {
return texture2D(texWavePerturbation, _uv).b;
}
vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rgb - 1.0;
}
float computeProgress(vec2 uv, float time) {
return fract(time);
}
float computeWeight(vec2 uv, float time) {
float progress = computeProgress(uv, time);
return 1.0 - abs(1.0 - 2.0 * progress);
}
vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {
float flowStrength = waveParams[2];
float flowOffset = waveParams[3];
vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;
float progress = computeProgress(uv, time + phaseOffset);
float weight = computeWeight(uv, time + phaseOffset);
vec2 result = uv;
result -= flowVector * (progress + flowOffset);
result += phaseOffset;
result += (time - progress) * FLOW_JUMP;
return vec3(result, weight);
}
const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;
const float TIME_NOISE_STRENGTH = 7.77;
vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {
float waveStrength = waveParams[0];
vec2 waveMovement = time * -_waveDir;
float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;
vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);
vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);
vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;
vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;
vec3 mixNormal = normalize(normal_A + normal_B);
mixNormal.xy *= waveStrength;
mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));
return mixNormal;
}
vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {
float waveTextureRepeat = waveParams[1];
vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);
float foam  = normals2FoamIntensity(normal, waveParams[0]);
return vec4(normal, foam);
}`)}const Tnt=sr(),Snt=Je();function OO(t,e){e.spherical?t.vertex.code.add(w`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):t.vertex.code.add(w`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),e.spherical?t.vertex.code.add(w`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):t.vertex.code.add(w`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}let kM=class extends ws{constructor(e,r){super(e,"int",di.Pass,(i,s,n)=>i.setUniform1i(e,r(s,n)))}},Ent=class extends ws{constructor(e,r,i){super(e,"mat4",di.Draw,(s,n,o)=>s.setUniformMatrix4fv(e,r(n,o)),i)}},Cnt=class extends ws{constructor(e,r,i){super(e,"mat4",di.Pass,(s,n,o)=>s.setUniformMatrix4fv(e,r(n,o)),i)}},ZTe=class extends pi{constructor(){super(...arguments),this.origin=M()}};function K5(t,e){e.receiveShadows&&(t.fragment.uniforms.add(new Cnt("shadowMapMatrix",(r,i)=>i.shadowMap.getShadowMapMatrices(r.origin),4)),JTe(t,e))}function Fw(t,e){e.receiveShadows&&(t.fragment.uniforms.add(new Ent("shadowMapMatrix",(r,i)=>i.shadowMap.getShadowMapMatrices(r.origin),4)),JTe(t,e))}function JTe(t,e){const r=t.fragment;r.include(kc),r.uniforms.add([...op("shadowMapTex",(i,s)=>s.shadowMap.depthTexture,e.hasWebGL2Context?Qr.None:Qr.Size),new kM("numCascades",(i,s)=>s.shadowMap.numCascades),new pr("cascadeDistances",(i,s)=>s.shadowMap.cascadeDistances)]),r.code.add(w`
    int chooseCascade(float depth, out mat4 mat) {
      vec4 distance = cascadeDistances;

      // choose correct cascade
      int i = depth < distance[1] ? 0 : depth < distance[2] ? 1 : depth < distance[3] ? 2 : 3;

      mat = i == 0 ? shadowMapMatrix[0] : i == 1 ? shadowMapMatrix[1] : i == 2 ? shadowMapMatrix[2] : shadowMapMatrix[3];

      return i;
    }

    vec3 lightSpacePosition(vec3 _vpos, mat4 mat) {
      vec4 lv = mat * vec4(_vpos, 1.0);
      lv.xy /= lv.w;
      return 0.5 * lv.xyz + vec3(0.5);
    }

    vec2 cascadeCoordinates(int i, vec3 lvpos) {
      return vec2(float(i - 2 * (i / 2)) * 0.5, float(i / 2) * 0.5) + 0.5 * lvpos.xy;
    }

    float readShadowMapDepth(vec2 uv, sampler2D _depthTex) {
      return rgba2float(texture2D(_depthTex, uv));
    }

    float posIsInShadow(vec2 uv, vec3 lvpos, sampler2D _depthTex) {
      return readShadowMapDepth(uv, _depthTex) < lvpos.z ? 1.0 : 0.0;
    }

    float filterShadow(vec2 uv, vec3 lvpos, float textureSize, sampler2D _depthTex) {
      float halfPixelSize = 0.5 / textureSize;

      // filter, offset by half pixels
      vec2 st = fract((vec2(halfPixelSize) + uv) * textureSize);

      float s00 = posIsInShadow(uv + vec2(-halfPixelSize, -halfPixelSize), lvpos, _depthTex);
      float s10 = posIsInShadow(uv + vec2(halfPixelSize, -halfPixelSize), lvpos, _depthTex);
      float s11 = posIsInShadow(uv + vec2(halfPixelSize, halfPixelSize), lvpos, _depthTex);
      float s01 = posIsInShadow(uv + vec2(-halfPixelSize, halfPixelSize), lvpos, _depthTex);

      return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);
    }

    float readShadowMap(const in vec3 _vpos, float _linearDepth) {
      mat4 mat;
      int i = chooseCascade(_linearDepth, mat);

      if (i >= numCascades) { return 0.0; }

      vec3 lvpos = lightSpacePosition(_vpos, mat);

      // vertex completely outside? -> no shadow
      if (lvpos.z >= 1.0) { return 0.0; }
      if (lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) { return 0.0; }

      // calc coord in cascade texture
      vec2 uv = cascadeCoordinates(i, lvpos);

      vec2 textureSize = ${$h(e,"shadowMapTex")};

      return filterShadow(uv, lvpos, textureSize.x, shadowMapTex);
    }
  `)}function Ant(t){const e=t.fragment.code;e.add(w`vec3 evaluateDiffuseIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float NdotNG)
{
return ((1.0 - NdotNG) * ambientGround + (1.0 + NdotNG) * ambientSky) * 0.5;
}`),e.add(w`float integratedRadiance(float cosTheta2, float roughness)
{
return (cosTheta2 - 1.0) / (cosTheta2 * (1.0 - roughness * roughness) - 1.0);
}`),e.add(w`vec3 evaluateSpecularIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float RdotNG, float roughness)
{
float cosTheta2 = 1.0 - RdotNG * RdotNG;
float intRadTheta = integratedRadiance(cosTheta2, roughness);
float ground = RdotNG < 0.0 ? 1.0 - intRadTheta : 1.0 + intRadTheta;
float sky = 2.0 - ground;
return (ground * ambientGround + sky * ambientSky) * 0.5;
}`)}function VZ(t,e){const r=t.fragment.code;t.include(EM),e.pbrMode!==dt.Normal&&e.pbrMode!==dt.Schematic&&e.pbrMode!==dt.Terrain&&e.pbrMode!==dt.TerrainWithWater||(r.add(w`float normalDistribution(float NdotH, float roughness)
{
float a = NdotH * roughness;
float b = roughness / (1.0 - NdotH * NdotH + a * a);
return b * b * INV_PI;
}`),r.add(w`const vec4 c0 = vec4(-1.0, -0.0275, -0.572,  0.022);
const vec4 c1 = vec4( 1.0,  0.0425,  1.040, -0.040);
const vec2 c2 = vec2(-1.04, 1.04);
vec2 prefilteredDFGAnalytical(float roughness, float NdotV) {
vec4 r = roughness * c0 + c1;
float a004 = min(r.x * r.x, exp2(-9.28 * NdotV)) * r.x + r.y;
return c2 * a004 + r.zw;
}`)),e.pbrMode!==dt.Normal&&e.pbrMode!==dt.Schematic||(t.include(Ant),r.add(w`struct PBRShadingInfo
{
float NdotL;
float NdotV;
float NdotH;
float VdotH;
float LdotH;
float NdotNG;
float RdotNG;
float NdotAmbDir;
float NdotH_Horizon;
vec3 skyRadianceToSurface;
vec3 groundRadianceToSurface;
vec3 skyIrradianceToSurface;
vec3 groundIrradianceToSurface;
float averageAmbientRadiance;
float ssao;
vec3 albedoLinear;
vec3 f0;
vec3 f90;
vec3 diffuseColor;
float metalness;
float roughness;
};`),r.add(w`vec3 evaluateEnvironmentIllumination(PBRShadingInfo inputs) {
vec3 indirectDiffuse = evaluateDiffuseIlluminationHemisphere(inputs.groundIrradianceToSurface, inputs.skyIrradianceToSurface, inputs.NdotNG);
vec3 indirectSpecular = evaluateSpecularIlluminationHemisphere(inputs.groundRadianceToSurface, inputs.skyRadianceToSurface, inputs.RdotNG, inputs.roughness);
vec3 diffuseComponent = inputs.diffuseColor * indirectDiffuse * INV_PI;
vec2 dfg = prefilteredDFGAnalytical(inputs.roughness, inputs.NdotV);
vec3 specularColor = inputs.f0 * dfg.x + inputs.f90 * dfg.y;
vec3 specularComponent = specularColor * indirectSpecular;
return (diffuseComponent + specularComponent);
}`),r.add(w`float gamutMapChanel(float x, vec2 p){
return (x < p.x) ? mix(0.0, p.y, x/p.x) : mix(p.y, 1.0, (x - p.x) / (1.0 - p.x) );
}`),r.add(w`vec3 blackLevelSoftCompression(vec3 inColor, PBRShadingInfo inputs){
vec3 outColor;
vec2 p = vec2(0.02 * (inputs.averageAmbientRadiance), 0.0075 * (inputs.averageAmbientRadiance));
outColor.x = gamutMapChanel(inColor.x, p) ;
outColor.y = gamutMapChanel(inColor.y, p) ;
outColor.z = gamutMapChanel(inColor.z, p) ;
return outColor;
}`))}function Rnt(t,e){const r=t.fragment.code;t.include(EM),r.add(w`
  struct PBRShadingWater
  {
      float NdotL;   // cos angle between normal and light direction
      float NdotV;   // cos angle between normal and view direction
      float NdotH;   // cos angle between normal and half vector
      float VdotH;   // cos angle between view direction and half vector
      float LdotH;   // cos angle between light direction and half vector
      float VdotN;   // cos angle between view direction and normal vector
  };

  float dtrExponent = ${e.useCustomDTRExponentForWater?"2.2":"2.0"};
  `),r.add(w`vec3 fresnelReflection(float angle, vec3 f0, float f90) {
return f0 + (f90 - f0) * pow(1.0 - angle, 5.0);
}`),r.add(w`float normalDistributionWater(float NdotH, float roughness)
{
float r2 = roughness * roughness;
float NdotH2 = NdotH * NdotH;
float denom = pow((NdotH2 * (r2 - 1.0) + 1.0), dtrExponent) * PI;
return r2 / denom;
}`),r.add(w`float geometricOcclusionKelemen(float LoH)
{
return 0.25 / (LoH * LoH);
}`),r.add(w`vec3 brdfSpecularWater(in PBRShadingWater props, float roughness, vec3 F0, float F0Max)
{
vec3  F = fresnelReflection(props.VdotH, F0, F0Max);
float dSun = normalDistributionWater(props.NdotH, roughness);
float V = geometricOcclusionKelemen(props.LdotH);
float diffusionSunHaze = mix(roughness + 0.045, roughness + 0.385, 1.0 - props.VdotH);
float strengthSunHaze  = 1.2;
float dSunHaze = normalDistributionWater(props.NdotH, diffusionSunHaze)*strengthSunHaze;
return ((dSun + dSunHaze) * V) * F;
}
vec3 tonemapACES(const vec3 x) {
return (x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14);
}`)}function KTe(t,e){t.include(Rnt,e),t.include(m5),t.include(xnt),e.hasCloudsReflections&&t.include(c1e,e),e.hasScreenSpaceReflections&&t.include(oXe,e);const r=t.fragment;r.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.92).add("waterSeaColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]).add("cloudFresnelModifier","vec2",[1.2,.01]),r.code.add(w`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),r.uniforms.add([new Pe("lightingSpecularStrength",(i,s)=>s.lighting.mainLight.specularStrength),new Pe("lightingEnvironmentStrength",(i,s)=>s.lighting.mainLight.environmentStrength)]),r.code.add(w`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 viewPosition, vec3 position) {
float reflectionHit = 0.0;
float reflectionHitDiffused = 0.0;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
specular = lightingSpecularStrength * shadingInfo.NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}
float correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);
vec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);
vec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));`),e.hasCloudsReflections&&r.code.add(w`vec4 cloudsColor = renderClouds(reflectedWorld, position);
cloudsColor.a = 1.0 - cloudsColor.a;
cloudsColor = pow(cloudsColor, vec4(GAMMA));
cloudsColor *= clamp(fresnelModifier.y*cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * clamp((1.0 - totalFadeInOut), 0.0, 1.0);`),e.hasScreenSpaceReflections?(r.uniforms.add([new Hi("view",(i,s)=>s.ssr.camera.viewMatrix),new Mt("lastFrameColorTexture",(i,s)=>s.ssr.lastFrameColorTexture),new Pe("fadeFactor",(i,s)=>s.ssr.fadeFactor)]),r.code.add(w`vec3 viewDir = normalize(viewPosition);
vec4 viewNormalVectorCoordinate = view *vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = view * vec4(localUp, 0.0);
vec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));
vec3 hitCoordinate = screenSpaceIntersection(reflected, viewPosition, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -viewPosition.z);
reflectionHit = clamp(1.0 - (1.3 * dCoords.y), 0.0, 1.0) * heightMod * fadeFactor;
reflectionHitDiffused = waterDiffusion * reflectionHit;
reflectedColor = linearizeGamma(texture2D(lastFrameColorTexture, reprojectedCoordinate).xyz) *
reflectionHitDiffused * fresnelModifier.y * ssrIntensity;
}
float seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod * 0.5, reflectionHitDiffused);
vec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor +
reflSea * seaColorMod + specular + foam);`)):r.code.add(w`vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);`),e.hasCloudsReflections?e.hasScreenSpaceReflections?r.code.add(w`return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;
}`):r.code.add(w`return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;
}`):r.code.add(w`return waterRenderedColor;
}`)}function Ont(t){const e=new Dr,{vertex:r,fragment:i}=e;$c(r,t),e.include(Bl,t),e.attributes.add(A.POSITION,"vec3"),e.attributes.add(A.UV0,"vec2");const s=new pr("waterColor",n=>n.color);if(t.output===k.Color&&t.isDraped)return e.varyings.add("vpos","vec3"),r.uniforms.add(s),r.code.add(w`
        void main(void) {
          if (waterColor.a < ${w.float(Yo)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vpos = position;
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),i.uniforms.add(s),i.code.add(w`void main() {
gl_FragColor = waterColor;
}`),e;switch(t.output!==k.Color&&t.output!==k.Alpha||(e.include(OO,t),e.include(VE,t),e.varyings.add("vuv","vec2"),e.varyings.add("vpos","vec3"),e.varyings.add("vnormal","vec3"),e.varyings.add("vtbnMatrix","mat3"),t.hasMultipassTerrain&&e.varyings.add("depth","float"),r.uniforms.add(s),r.code.add(w`
      void main(void) {
        if (waterColor.a < ${w.float(Yo)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vuv = uv0;
        vpos = position;

        vnormal = getLocalUp(vpos, localOrigin);
        vtbnMatrix = getTBNMatrix(vnormal);

        ${t.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":""}

        gl_Position = transformPosition(proj, view, vpos);
        ${t.output===k.Color?"forwardLinearDepth();":""}
      }
    `)),e.include(Fu,t),t.output){case k.Alpha:e.include(Xs,t),i.uniforms.add(s),i.code.add(w`
        void main() {
          discardBySlice(vpos);
          ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}

          gl_FragColor = vec4(waterColor.a);
        }
      `);break;case k.Color:e.include(ZN,t),e.include(cY,{pbrMode:dt.Disabled,lightingSphericalHarmonicsOrder:2}),e.include(Gne),e.include(Xs,t),e.include(Fw,t),e.include(KTe,t),i.uniforms.add([s,new Pe("timeElapsed",n=>n.timeElapsed),r.uniforms.get("view"),r.uniforms.get("localOrigin")]),bp(i,t),i.include(bm),dy(i),vm(i),i.code.add(w`
      void main() {
        discardBySlice(vpos);
        ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
        vec3 localUp = vnormal;
        // the created normal is in tangent space
        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);

        // we rotate the normal according to the tangent-bitangent-normal-Matrix
        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);
        vec3 v = -normalize(vpos - cameraPosition);
        float shadow = ${t.receiveShadows?w`1.0 - readShadowMap(vpos, linearDepth)`:"1.0"};
        vec4 vPosView = view * vec4(vpos, 1.0);
        vec4 final = vec4(getSeaColor(n, v, mainLightDirection, waterColor.rgb, mainLightIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz, vpos + localOrigin), waterColor.w);

        // gamma correction
        gl_FragColor = delinearizeGamma(final);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${t.transparencyPassType===xt.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `);break;case k.Normal:e.include(OO,t),e.include(Gne,t),e.include(Xs,t),e.varyings.add("vpos","vec3"),e.varyings.add("vuv","vec2"),r.uniforms.add(s),r.code.add(w`
        void main(void) {
          if (waterColor.a < ${w.float(Yo)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vuv = uv0;
          vpos = position;

          gl_Position = transformPosition(proj, view, vpos);
        }
    `),i.uniforms.add(new Pe("timeElapsed",n=>n.timeElapsed)),i.code.add(w`void main() {
discardBySlice(vpos);
vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);
tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);
gl_FragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);
}`);break;case k.Highlight:e.include(by,t),e.varyings.add("vpos","vec3"),r.uniforms.add(s),r.code.add(w`
      void main(void) {
        if (waterColor.a < ${w.float(Yo)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
      }
    `),e.include(Xs,t),i.code.add(w`void main() {
discardBySlice(vpos);
outputHighlight();
}`)}return e}const Mnt=Object.freeze(Object.defineProperty({__proto__:null,build:Ont},Symbol.toStringTag,{value:"Module"}));let QTe=class e2e extends Vr{initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===vt.WEBGL2,r.spherical=e.viewingMode===Be.Global,r.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Fr(e.rctx,e2e.shader.get().build(this.configuration),Rr)}_setPipelineState(e){const r=this.configuration,i=e===xt.NONE,s=e===xt.FrontFace;return Bt({blending:r.output!==k.Normal&&r.output!==k.Highlight&&r.transparent?i?Iu:wy(e):null,depthTest:{func:xv(e)},depthWrite:i?r.writeDepth?Xl:null:G5(e),colorWrite:Kt,polygonOffset:i||s?null:q5(r.enableOffset)})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}};QTe.shader=new Nr(Mnt,()=>te(()=>import("./WaterSurface.glsl-616ab347.js"),[]));let bo=class extends eo{constructor(){super(...arguments),this.output=k.Color,this.transparencyPassType=xt.NONE,this.spherical=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.hasScreenSpaceReflections=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasCloudsReflections=!1,this.isDraped=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}};u([V({count:k.COUNT})],bo.prototype,"output",void 0),u([V({count:xt.COUNT})],bo.prototype,"transparencyPassType",void 0),u([V()],bo.prototype,"spherical",void 0),u([V()],bo.prototype,"receiveShadows",void 0),u([V()],bo.prototype,"hasSlicePlane",void 0),u([V()],bo.prototype,"transparent",void 0),u([V()],bo.prototype,"enableOffset",void 0),u([V()],bo.prototype,"writeDepth",void 0),u([V()],bo.prototype,"hasScreenSpaceReflections",void 0),u([V()],bo.prototype,"doublePrecisionRequiresObfuscation",void 0),u([V()],bo.prototype,"hasCloudsReflections",void 0),u([V()],bo.prototype,"isDraped",void 0),u([V()],bo.prototype,"hasMultipassTerrain",void 0),u([V()],bo.prototype,"cullAboveGround",void 0),u([V({constValue:dt.Water})],bo.prototype,"pbrMode",void 0),u([V({constValue:!0})],bo.prototype,"useCustomDTRExponentForWater",void 0),u([V({constValue:!0})],bo.prototype,"highStepCount",void 0),u([V({constValue:!1})],bo.prototype,"useFillLights",void 0);let Pnt=class extends bv{_updateShadowState(e){e.shadowMap.enabled!==this._material.parameters.receiveShadows&&this._material.setParameters({receiveShadows:e.shadowMap.enabled})}_updateSSRState(e){e.ssr.enabled!==this._material.parameters.hasScreenSpaceReflections&&this._material.setParameters({hasScreenSpaceReflections:e.ssr.enabled})}_updateCloudsReflectionState(e){const r=v(e.cloudsFade.data);r!==this._material.parameters.hasCloudsReflections&&this._material.setParameters({hasCloudsReflections:r})}ensureResources(e){return this._techniqueRepository.constructionContext.waterTextureRepository.ensureResources(e)}beginSlot(e){return this._output===k.Color&&(this._updateShadowState(e),this._updateSSRState(e),this._updateCloudsReflectionState(e)),this._material.setParameters(this._techniqueRepository.constructionContext.waterTextureRepository.passParameters),this.ensureTechnique(QTe,e)}},t2e=class extends kZ{constructor(e){super(e,new r2e),this._configuration=new bo,this.animation=new hbe}getConfiguration(e,r){return this._configuration.output=e,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasScreenSpaceReflections=this.parameters.hasScreenSpaceReflections,this._configuration.hasCloudsReflections=this.parameters.hasCloudsReflections,this._configuration.isDraped=this.parameters.isDraped,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.enableOffset=r.camera.relativeElevation<j5,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration}update(e){const r=Math.min(e.camera.relativeElevation,e.camera.distance);this.animation.enabled=Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*r<Int;const i=this.animation.advance(e);return this.setParameters({timeElapsed:ZH(this.animation.time)*this.parameters.animationSpeed},!1),this.animation.enabled&&i}requiresSlot(e,r){switch(r){case k.Normal:return e===Se.DRAPED_WATER;case k.Color:if(this.parameters.isDraped)return e===Se.DRAPED_MATERIAL;break;case k.Alpha:break;case k.Highlight:return e===Se.OPAQUE_MATERIAL||e===Se.DRAPED_MATERIAL;default:return!1}let i=Se.OPAQUE_MATERIAL;return this.parameters.transparent&&(i=this.parameters.writeDepth?Se.TRANSPARENT_MATERIAL:Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),e===i}createGLMaterial(e){return new Pnt(e)}createBufferWriter(){return new XE(vnt)}},r2e=class extends qE{constructor(){super(...arguments),this.waveStrength=.06,this.waveTextureRepeat=32,this.waveDirection=Ur(1,0),this.waveVelocity=.05,this.flowStrength=.015,this.flowOffset=-.5,this.animationSpeed=.35,this.timeElapsed=0,this.color=Ht(0,0,0,0),this.transparent=!0,this.writeDepth=!0,this.hasSlicePlane=!1,this.isDraped=!1,this.receiveShadows=!0,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1}};const Int=35e3;let BZ=class{constructor(e=0,r=0){this.from=e,this.to=r}get numElements(){return this.to-this.from}};function jne(t){const e=new Map;t.forAll(i=>e.set(i.from,i));let r=!0;for(;r;)r=!1,t.forEach(i=>{const s=e.get(i.to);s&&(i.to=s.to,e.delete(s.from),t.removeUnordered(s),r=!0)})}let Hne=class extends BZ{constructor(e,r,i){super(r,i),this.geometry=e}get isVisible(){return this.geometry.visible}get hasHighlights(){return v(this.geometry.highlights)&&this.isVisible}get hasOccludees(){return v(this.geometry.occludees)}},$nt=class{constructor(){this.first=0,this.count=0}},Lnt=class{constructor(){this._numElements=0,this._instances=new Map,this.holes=new Jt({allocator:e=>e||new BZ,deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.drawCommandsDefault=FI(),this.drawCommandsHighlight=FI(),this.drawCommandsOccludees=FI(),this.drawCommandsShadowHighlightRest=FI()}get numElements(){return this._numElements}get instances(){return this._instances}addInstance(e,r){this.deleteInstance(e),this._instances.set(e,r),this._numElements+=r.numElements}deleteInstance(e){const r=this._instances.get(e);r&&(this._numElements-=r.numElements,this._instances.delete(e))}updateInstance(e,r,i){const s=this._instances.get(e);s&&(this._numElements-=s.numElements,s.from=r,s.to=i,this._numElements+=s.numElements)}updateDrawState(e){e.isVisible?(e.hasHighlights&&(this.hasHighlights=!0),e.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(e){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlight.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,this._instances.size===0)return;if(!this.needsMultipleCommands()){const i=this.drawCommandsDefault.pushNew(),s=this.holes.front();return v(this.vao)&&this.holes.length===1&&s.to===Math.floor(this.vao.size/e)?(i.first=0,void(i.count=s.from)):(i.first=1/0,i.count=0,this._instances.forEach(n=>{i.first=Math.min(i.first,n.from),i.count=Math.max(i.count,n.to)}),void(i.count-=i.first))}const r=Array.from(this._instances.values()).sort((i,s)=>i.from===s.from?i.to-s.to:i.from-s.from);for(const i of r)i.isVisible&&(qne(i.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,i),qne(i.hasHighlights?this.drawCommandsHighlight:this.drawCommandsShadowHighlightRest,i))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}};function Dnt(t){return v(t.vao)}function FI(){return new Jt({allocator:t=>t||new $nt,deallocator:t=>t})}function qne(t,e){const r=t.back();if(r==null){const i=t.pushNew();return i.first=e.from,void(i.count=e.numElements)}if(Nnt(r,e)){const i=e.from-r.first+e.numElements;r.count=i}else{const i=t.pushNew();i.first=e.from,i.count=e.numElements}}function Nnt(t,e){return t.first+t.count>=e.from}let Fnt=class{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach(e=>e.vao.dispose()),this.buffers.length=0}findBuffer(e){return this.buffers.find(r=>r.instances.has(e))}};const Unt=TL+1;let knt=class{constructor(e,r,i){this._rctx=e,this._locations=r,this._layout=i,this._cache=e.newCache(`VaoCache ${Pc()}`,Vnt)}dispose(){this._cache.destroy()}newVao(e){const r=e.toString(),i=this._cache.pop(r);if(v(i)){const n=i.pop();return i.length>0&&this._cache.put(r,i,e*i.length,Unt),n}const s=new Sp(this._rctx,this._locations,{geometry:this._layout},{geometry:jr.createVertex(this._rctx,Lr.STATIC_DRAW)});return s.vertexBuffers.geometry.setSize(e),s}deleteVao(e){if(C(e))return null;const r=e.size,i=r.toString(),s=this._cache.pop(i);return v(s)?(s.push(e),this._cache.put(i,s,r*s.length,-1)):this._cache.put(i,[e],r,-1),null}};function Vnt(t,e){if(e===Eg.ALL)return void t.forEach(s=>s.dispose());const r=t.pop(),i=t.length*r.size;return r.dispose(),i}let i2e=class{constructor(e,r,i){this._rctx=e,this._materialRepository=r,this.material=i,this._dataByOrigin=new Map,this._appleAmdDriverHelper=null,this._hasHighlights=!1,this._hasOccludees=!1,this._glMaterials=new qTe(this.material,this._materialRepository),this._bufferWriter=i.createBufferWriter(),this._vaoCache=new knt(e,i.vertexAttributeLocations,Vc(this._bufferWriter.vertexBufferLayout)),this._rctx.driverTest.drawArraysRequiresIndicesTypeReset.result&&(this._appleAmdDriverHelper=new gnt(this._rctx))}dispose(){var e;this._glMaterials.destroy(),this._dataByOrigin.forEach(r=>r.dispose()),this._dataByOrigin.clear(),this._vaoCache.dispose(),(e=this._appleAmdDriverHelper)==null||e.dispose()}get isEmpty(){return this._dataByOrigin.size===0}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&this.material instanceof t2e}get rendersOccluded(){return!this.isEmpty&&this.material.renderOccluded!==ns.Occlude}get numGeometries(){let e=0;return this._dataByOrigin.forEach(r=>e+=r.buffers.reduce((i,s)=>i+s.instances.size,0)),e}forEachGeometry(e){this._dataByOrigin.forEach(r=>r.buffers.forEach(i=>i.instances.forEach(s=>e(s.geometry))))}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()}_updateGeometries(e){var s;const r=this._bufferWriter,i=r.vertexBufferLayout.stride/4;for(const n of e){const o=n.renderGeometry,a=(s=this._dataByOrigin.get(o.localOrigin.id))==null?void 0:s.findBuffer(o.id);if(C(a))return;const l=a.instances.get(o.id);if(n.updateType&(Pn.GEOMETRY|Pn.TRANSFORMATION)){const c=BI(r.elementCount(l.geometry.geometry)*i),h=r.vertexBufferLayout.createView(c.buffer);this._writeGeometry(o,h,0),a.vao.vertexBuffers.geometry.setSubData(c,l.from*i,0,l.numElements*i)}n.updateType&(Pn.HIGHLIGHT|Pn.OCCLUDEE|Pn.VISIBILITY)&&(a.drawCommandsDirty=!0)}}_computeDeltas(e,r){var s;const i=new BE;for(const n of e){const o=n.localOrigin;if(C(o))continue;let a=i.get(o.id,null);C(a)&&(a=new Wne(o.vec3),i.set(o.id,null,a)),a.changes.push(n)}for(const n of r){const o=n.localOrigin;if(C(o))continue;const a=(s=this._dataByOrigin.get(o.id))==null?void 0:s.findBuffer(n.id);if(C(a))continue;let l=i.get(o.id,a);C(l)&&(l=new Wne(o.vec3),i.set(o.id,a,l)),l.changes.push(n)}return i}_addAndRemoveGeometries(e,r){const{_bufferWriter:i,_dataByOrigin:s}=this,n=i.vertexBufferLayout.stride/4,o=this._computeDeltas(e,r);o.forEach((a,l)=>{const c=a.get(null),h=v(c)?c.changes:[];o.delete(l,null);let p=s.get(l);if(a.forEach((f,m)=>{if(o.delete(l,m),C(m))return void ft(!1,"No VAO for removed geometries");if(m.instances.size===f.changes.length)return this._vaoCache.deleteVao(m.vao),PR(p.buffers,m),void(p.buffers.length===0&&h.length===0&&s.delete(l));const y=m.numElements,_=m.vao.size/4,b=h.reduce((E,O)=>E+i.elementCount(O.geometry),0),x=f.changes.reduce((E,O)=>E+i.elementCount(O.geometry),0),T=Math.min((y+b-x)*n,VI),S=T>_;T>$F&&T<_/2?(f.changes.forEach(({id:E})=>m.deleteInstance(E)),m.instances.forEach(({geometry:E})=>h.push(E)),this._vaoCache.deleteVao(m.vao),PR(p.buffers,m)):S?this._applyAndRebuild(m,h,f):this._applyRemoves(m,f)}),h.length>0)for(C(p)&&(p=new Fnt(c.origin),s.set(l,p)),p.buffers.forEach(f=>this._applyAdds(f,h));h.length>0;)p.buffers.push(this._applyAndRebuild(new Lnt,h,null))})}_updateDrawCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach(e=>{e.buffers.forEach(r=>{r.drawCommandsDirty&&(r.hasHiddenInstances=!1,r.hasHighlights=!1,r.hasOccludees=!1,Ho(r.instances,i=>(r.updateDrawState(i),r.hasHiddenInstances&&r.hasHighlights&&r.hasOccludees)),r.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride)),this._hasHighlights=this._hasHighlights||r.hasHighlights,this._hasOccludees=this._hasOccludees||r.hasOccludees})})}_applyAndRebuild(e,r,i){if(v(i))for(const y of i.changes)e.deleteInstance(y.id);const s=this._bufferWriter,n=s.vertexBufferLayout.stride,o=n/4,a=Math.floor(VI/o);let l=e.numElements;for(;r.length>0;){const y=r.pop(),_=s.elementCount(y.geometry);if(l+_>a&&l>0){r.push(y);break}l+=_;const b=new Hne(y,0,0);ft(e.instances.get(y.id)==null),e.addInstance(y.id,b)}const c=l*o,h=BI(c),p=s.vertexBufferLayout.createView(h.buffer);let f=0;e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,e.instances.forEach((y,_)=>{this._writeGeometry(y.geometry,p,f);const b=f;f+=s.elementCount(y.geometry.geometry),e.updateInstance(_,b,f),e.updateDrawState(y)}),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(Yne(c)),e.vao.vertexBuffers.geometry.setSubData(h,0,0,f*o),e.holes.clear();const m=e.holes.pushNew();return m.from=f,m.to=Math.floor(e.vao.size/n),e.updateDrawCommands(n),e}_applyRemoves(e,r){if(r.changes.length===0)return;for(const a of r.changes){const l=a.id,c=e.instances.get(l);if(!c)continue;e.deleteInstance(l);const h=Np.back();if(h){if(h.to===c.from){h.to=c.to;continue}if(h.from===c.to){h.from=c.from;continue}}const p=Np.pushNew();p.from=c.from,p.to=c.to}jne(Np);const i=this._bufferWriter.vertexBufferLayout.stride/4,s=Np.reduce((a,l)=>Math.max(a,l.numElements),0)*i,n=BI(s);n.fill(0,0,s);const o=e.vao.vertexBuffers.geometry;Np.forAll(a=>o.setSubData(n,a.from*i,0,a.numElements*i)),e.holes.pushArray(Np.data,Np.length),Np.forAll((a,l)=>Np.data[l]=null),Np.clear(),e.drawCommandsDirty=!0}_applyAdds(e,r){if(r.length===0)return;if(!Dnt(e))return void this._applyAndRebuild(e,r,null);const i=this._bufferWriter,s=i.vertexBufferLayout.stride/4,n=e.numElements,o=r.reduce((x,T)=>x+i.elementCount(T.geometry),0),a=Math.min((n+o)*s,VI),l=4*a;if(e.vao.size<Yne(VI-$F)&&l>e.vao.size)return void this._applyAndRebuild(e,r,null);jne(e.holes);const c=new Array;for(const x of r){const T=i.elementCount(x.geometry),S=Bnt(e.holes,T);c.push(S)}const h=e.vao.vertexBuffers.geometry;let p=0,f=0,m=0;const y=BI(a),_=i.vertexBufferLayout.createView(y.buffer);r.forEach((x,T)=>{const S=c[T];if(C(S))return;if(m!==S){const R=m-f;R>0&&h.setSubData(y,f*s,0,R*s),f=S,p=0}const E=i.elementCount(x.geometry);this._writeGeometry(x,_,p),p+=E,m=S+E;const O=new Hne(x,S,S+E);ft(e.instances.get(x.id)==null),e.addInstance(x.id,O),e.drawCommandsDirty=!0});const b=m-f;b>0&&h.setSubData(y,f*s,0,b*s),vAe(r,(x,T)=>C(c[T]))}_writeGeometry(e,r,i){const s=e.localOrigin.vec3;YXe(Xne,-s[0],-s[1],-s[2]);const n=gs(znt,Xne,e.transformation);Oo(UI,n),Dc(UI,UI),this._bufferWriter.write(n,UI,e.geometry,r,i)}updateAnimation(e){return this.material.update(e)}requiresSlot(e,r){return this.material.requiresSlot(e,r)}render(e,r){var c;if(!this.requiresSlot(r.slot,e))return!1;const i=e===k.Highlight||e===k.ShadowHighlight;if(i&&!this._hasHighlights)return!1;const s=e===k.ShadowExcludeHighlight,n=!(i||s),o=this._rctx;let a;const l=()=>{if(v(a))return a;const h=this._glMaterials.load(o,r.slot,e);return C(h)?null:(a=h.beginSlot(r),C(a)?null:(o.bindTechnique(a,this.material.parameters,r),a))};(c=this._appleAmdDriverHelper)==null||c.resetIndicesType();for(const h of this._dataByOrigin.values())for(const p of h.buffers){if(i&&!p.hasHighlights)continue;const f=(i?p.drawCommandsHighlight:s&&p.needsMultipleCommands()?p.drawCommandsShadowHighlightRest:p.drawCommandsDefault)||null,m=n&&p.drawCommandsOccludees||null;if(f!=null&&f.length||m!=null&&m.length){const y=l();if(C(y))return!1;y.program.bindDraw(new qj(h.origin),r,this.material.parameters),y.ensureAttributeLocations(p.vao),o.bindVAO(p.vao),f!=null&&f.length&&(y.bindPipelineState(o,r.slot,!1),f.forAll(_=>o.drawArrays(y.primitiveType,_.first,_.count))),m!=null&&m.length&&(y.bindPipelineState(o,r.slot,!0),m.forAll(_=>o.drawArrays(y.primitiveType,_.first,_.count)))}}return v(a)}get test(){return{material:this.material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}},Wne=class{constructor(e){this.origin=e,this.changes=new Array}};function Bnt(t,e){let r;if(!t.some(s=>!(s.numElements<e)&&(r=s,!0)))return null;const i=r.from;return r.from+=e,r.from>=r.to&&t.removeUnordered(r),i}const Xne=Ie(),znt=Ie(),UI=Ie(),Np=new Jt({allocator:t=>t||new BZ,deallocator:null}),$F=65536,kI=4*$F,s2e=16777216,VI=s2e/4;let _9=new Float32Array($F);function BI(t){return _9.length<t&&(_9=new Float32Array(t)),_9}function Yne(t){const e=4*t;return e<kI?kI:Math.max(Math.min(Math.ceil(1.5*e/kI)*kI,s2e),e)}let nu=class extends Te{constructor(e){super(e),this._pending=new Gnt,this._changes=new Hj,this._materialRenderers=new Map,this._sortedMaterialRenderers=new Jt,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forEach(e=>e.dispose()),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear(),this._geometries.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materialRepository(){return this.rendererContext.materialRepository}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return Ho(this._materialRenderers,e=>e.rendersOccluded)}get isEmpty(){return!this.updating&&this._materialRenderers.size===0&&this._geometries.size===0}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=HTe(this._changes);let r=!1,i=!1,s=!1;return e.forEach((n,o)=>{let a=this._materialRenderers.get(o);if(!a&&n.adds.length>0&&(a=new i2e(this.rctx,this._materialRepository,o),this._materialRenderers.set(o,a),r=!0,i=!0,s=!0),!a)return;const l=i||a.hasHighlights,c=s||a.hasWater;a.modify(n),i=i||l!==a.hasHighlights,s=s||c!==a.hasWater,a.isEmpty&&(this._materialRenderers.delete(o),a.dispose(),r=!0)}),this._changes.clear(),r&&this._updateSortedMaterialRenderers(),i&&(this._hasHighlights=Ho(this._materialRenderers,n=>n.hasHighlights)),s&&(this._hasWater=Ho(this._materialRenderers,n=>n.hasWater)),this.notifyChange("updating"),!0}addGeometries(e,r){if(e.length===0)return;const i=this._validateRenderGeometries(e);for(const n of i)this._geometries.set(n.id,n);const s=this._pending.empty;for(const n of i)this._pending.adds.add(n);s&&this.notifyChange("updating"),r===ss.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,r){const i=this._pending.empty,s=this._pending.adds;for(const n of e)s.has(n)?(this._pending.removed.add(n),s.delete(n)):this._pending.removed.has(n)||this._pending.removes.add(n),this._geometries.delete(n.id);i&&!this._pending.empty&&this.notifyChange("updating"),r===ss.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,r){const i=this._changes.updates.length===0;for(const s of e){const n=this._changes.updates.pushNew();n.renderGeometry=this._validateRenderGeometry(s),n.updateType=r}switch(i&&this._changes.updates.length>0&&this.notifyChange("updating"),r){case Pn.TRANSFORMATION:case Pn.GEOMETRY:return this._notifyGraphicGeometryChanged(e);case Pn.VISIBILITY:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let r=!1;return this._sortedMaterialRenderers.forAll(i=>r=i.updateAnimation(e)||r),r}render(e){this._sortedMaterialRenderers.forAll(r=>{r.material.shouldRender(e)&&r.render(e.output,e.bindParameters)})}intersect(e,r,i,s,n){return this._geometries.forEach(o=>{if(s&&!s(o))return;this._intersectRenderGeometry(o,i,r,0,e,n);const a=this.rendererContext.longitudeCyclical;a&&(o.boundingSphere[0]-o.boundingSphere[3]<a.min&&this._intersectRenderGeometry(o,i,r,a.range,e,n),o.boundingSphere[0]+o.boundingSphere[3]>a.max&&this._intersectRenderGeometry(o,i,r,-a.range,e,n)),n++}),n}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let e=0;this._materialRenderers.forEach((r,i)=>{i.insertOrder=e++,this._sortedMaterialRenderers.push(r)}),this._sortedMaterialRenderers.sort((r,i)=>{const s=i.material.renderPriority-r.material.renderPriority;return s!==0?s:r.material.insertOrder-i.material.insertOrder})}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const r=this._changes.updates.data[e];this._pending.has(r.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}_intersectRenderGeometry(e,r,i,s,n,o){if(!e.visible)return;let a=0;s+=e.transformation[12],a=e.transformation[13],v9[0]=i[0]-s,v9[1]=i[1]-a,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,null,n,v9,(l,c,h)=>{jnt(r,h,e.material.renderPriority,o,n,e.layerUid,e.graphicUid)},r)}_notifyGraphicGeometryChanged(e){if(C(this.drapeSource.notifyGraphicGeometryChanged))return;let r;for(const i of e){const s=i.graphicUid;v(s)&&s!==r&&(this.drapeSource.notifyGraphicGeometryChanged(s),r=s)}}_notifyGraphicVisibilityChanged(e){if(C(this.drapeSource.notifyGraphicVisibilityChanged))return;let r;for(const i of e){const s=i.graphicUid;v(s)&&s!==r&&(this.drapeSource.notifyGraphicVisibilityChanged(s),r=s)}}_validateRenderGeometries(e){for(const r of e)this._validateRenderGeometry(r);return e}_validateRenderGeometry(e){return C(e.localOrigin)&&(e.localOrigin=this._localOriginFactory.getOrigin(e.boundingSphere)),e}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};u([d()],nu.prototype,"drapeSource",void 0),u([d()],nu.prototype,"updating",null),u([d()],nu.prototype,"rctx",null),u([d()],nu.prototype,"rendererContext",void 0),u([d()],nu.prototype,"_materialRepository",null),u([d()],nu.prototype,"_localOriginFactory",null),u([d({readOnly:!0})],nu.prototype,"isEmpty",null),u([d()],nu.prototype,"_materialRenderers",void 0),u([d()],nu.prototype,"_geometries",void 0),nu=u([I("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],nu);let Gnt=class{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return this.adds.size===0&&this.removes.size===0&&this.removed.size===0}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}};function jnt(t,e,r,i,s,n,o){const a=new pnt(n,o,e),l=c=>{c.set(Qi.OVERLAY,a,t.dist,t.normal,t.transformation,r,i)};if((s.results.min.drapedLayerOrder==null||r>=s.results.min.drapedLayerOrder)&&(s.results.min.dist==null||s.results.ground.dist<=s.results.min.dist)&&l(s.results.min),s.options.store!==Po.MIN&&(s.results.max.drapedLayerOrder==null||r<s.results.max.drapedLayerOrder)&&(s.results.max.dist==null||s.results.ground.dist>s.results.max.dist)&&l(s.results.max),s.options.store===Po.ALL){const c=VY(s.ray);l(c),s.results.all.push(c)}}const v9=Je(),b9=4;function Hnt(){const t=new Dr,e=t.fragment;t.include(Jh);const r=(b9+1)/2,i=1/(2*r*r);return e.include(Nu),e.uniforms.add([new Mt("depthMap",s=>s.depthTexture),new SM("tex",s=>s.colorTexture),new hO("blurSize",s=>s.blurSize),new Pe("projScale",(s,n)=>{const o=xi(n.camera.eye,n.camera.center);return o>5e4?Math.max(0,s.projScale-(o-5e4)):s.projScale}),new kr("nearFar",(s,n)=>n.camera.nearFar)]),e.code.add(w`
    void blurFunction(vec2 uv, float r, float center_d, float sharpness, inout float wTotal, inout float bTotal) {
      float c = texture2D(tex, uv).r;
      float d = linearDepthFromTexture(depthMap, uv, nearFar);

      float ddiff = d - center_d;

      float w = exp(-r * r * ${w.float(i)} - ddiff * ddiff * sharpness);
      wTotal += w;
      bTotal += w * c;
    }
  `),e.code.add(w`
    void main(void) {
      float b = 0.0;
      float w_total = 0.0;

      float center_d = linearDepthFromTexture(depthMap, uv, nearFar);

      float sharpness = -0.05 * projScale / center_d;
      for (int r = -${w.int(b9)}; r <= ${w.int(b9)}; ++r) {
        float rf = float(r);
        vec2 uvOffset = uv + rf * blurSize;
        blurFunction(uvOffset, rf, center_d, sharpness, w_total, b);
      }

      gl_FragColor = vec4(b / w_total);
    }
  `),t}const qnt=Object.freeze(Object.defineProperty({__proto__:null,build:Hnt},Symbol.toStringTag,{value:"Module"}));let n2e=class o2e extends Vr{initializeProgram(e){return new Fr(e.rctx,o2e.shader.get().build(),Rr)}initializePipeline(){return Bt({colorWrite:Kt})}};n2e.shader=new Nr(qnt,()=>te(()=>import("./SSAOBlur.glsl-e98d2bad.js"),[]));const Wnt="eXKEvZaUc66cjIKElE1jlJ6MjJ6Ufkl+jn2fcXp5jBx7c6KEflSGiXuXeW6OWs+tfqZ2Yot2Y7Zzfo2BhniEj3xoiXuXj4eGZpqEaHKDWjSMe7palFlzc3BziYOGlFVzg6Zzg7CUY5JrjFF7eYJ4jIKEcyyEonSXe7qUfqZ7j3xofqZ2c4R5lFZ5Y0WUbppoe1l2cIh2ezyUho+BcHN2cG6DbpqJhqp2e1GcezhrdldzjFGUcyxjc3aRjDyEc1h7Sl17c6aMjH92pb6Mjpd4dnqBjMOEhqZleIOBYzB7gYx+fnqGjJuEkWlwnCx7fGl+c4hjfGyRe5qMlNOMfnqGhIWHc6OMi4GDc6aMfqZuc6aMzqJzlKZ+lJ6Me3qRfoFue0WUhoR5UraEa6qMkXiPjMOMlJOGe7JrUqKMjK6MeYRzdod+Sl17boiPc6qEeYBlcIh2c1WEe7GDiWCDa0WMjEmMdod+Y0WcdntzhmN8WjyMjKJjiXtzgYxYaGd+a89zlEV7e2GJfnd+lF1rcK5zc4p5cHuBhL6EcXp5eYB7fnh8iX6HjIKEeaxuiYOGc66RfG2Ja5hzjlGMjEmMe9OEgXuPfHyGhPeEdl6JY02McGuMfnqGhFiMa3WJfnx2l4hwcG1uhmN8c0WMc39og1GBbrCEjE2EZY+JcIh2cIuGhIWHe0mEhIVrc09+gY5+eYBlnCyMhGCDl3drfmmMgX15aGd+gYx+fnuRfnhzY1SMsluJfnd+hm98WtNrcIuGh4SEj0qPdkqOjFF7jNNjdnqBgaqUjMt7boeBhnZ4jDR7c5pze4GGjEFrhLqMjHyMc0mUhKZze4WEa117kWlwbpqJjHZ2eX2Bc09zeId+e0V7WlF7jHJ2l72BfId8l3eBgXyBe897jGl7c66cgW+Xc76EjKNbgaSEjGx4fId8jFFjgZB8cG6DhlFziZhrcIh2fH6HgUqBgXiPY8dahGFzjEmMhEFre2dxhoBzc5SGfleGe6alc7aUeYBlhKqUdlp+cH5za4OEczxza0Gcc4J2jHZ5iXuXjH2Jh5yRjH2JcFx+hImBjH+MpddCl3dreZeJjIt8ZW18bm1zjoSEeIOBlF9oh3N7hlqBY4+UeYFwhLJjeYFwaGd+gUqBYxiEYot2fqZ2ondzhL6EYyiEY02Ea0VjgZB8doaGjHxoc66cjEGEiXuXiXWMiZhreHx8frGMe75rY02Ec5pzfnhzlEp4a3VzjM+EhFFza3mUY7Zza1V5e2iMfGyRcziEhDyEkXZ2Y4OBnCx7g5t2eyBjgV6EhEFrcIh2dod+c4Z+nJ5zjm15jEmUeYxijJp7nL6clIpjhoR5WrZraGd+fnuRa6pzlIiMg6ZzfHx5foh+eX1ufnB5eX1ufnB5aJt7UqKMjIh+e3aBfm5lbYSBhGFze6J4c39oc0mUc4Z+e0V7fKFVe0WEdoaGY02Ec4Z+Y02EZYWBfH6HgU1+gY5+hIWUgW+XjJ57ebWRhFVScHuBfJ6PhBx7WqJzlM+Ujpd4gHZziX6HjHmEgZN+lJt5boiPe2GJgX+GjIGJgHZzeaxufnB5hF2JtdN7jJ57hp57hK6ElFVzg6ZzbmiEbndzhIWHe3uJfoFue3qRhJd2j3xoc65zlE1jc3p8lE1jhniEgXJ7e657vZaUc3qBh52BhIF4aHKDa9drgY5+c52GWqZzbpqJe8tjnM+UhIeMfo2BfGl+hG1zSmmMjKJjZVaGgX15c1lze0mEp4OHa3mUhIWHhDyclJ6MeYOJkXiPc0VzhFiMlKaEboSJa5Jze41re3qRhn+HZYWBe0mEc4p5fnORbox5lEp4hGFjhGGEjJuEc1WEhLZjeHeGa7KlfHx2hLaMeX1ugY5+hIWHhKGPjMN7c1WEho1zhoBzZYx7fnhzlJt5exyUhFFziXtzfmmMa6qMYyiEiXxweV12kZSMeWqXSl17fnhzxmmMrVGEe1mcc4p5eHeGjK6MgY5+doaGa6pzlGV7g1qBh4KHkXiPeW6OaKqafqZ2eXZ5e1V7jGd7boSJc3BzhJd2e0mcYot2h1RoY8dahK6EQmWEWjx7e1l2lL6UgXyBdnR4eU9zc0VreX1umqaBhld7fo2Bc6KEc5Z+hDyEcIeBWtNrfHyGe5qMhMuMe5qMhEGEbVVupcNzg3aHhIF4boeBe0mEdlptc39ofFl5Y8uUlJOGiYt2UmGEcyxjjGx4jFF7a657ZYWBnElzhp57iXtrgZN+tfOEhIOBjE2HgU1+e8tjjKNbiWCDhE15gUqBgYN7fnqGc66ce9d7iYSBj0qPcG6DnGGcT3eGa6qMZY+JlIiMl4hwc3aRdnqBlGV7eHJ2hLZjfnuRhDyEeX6MSk17g6Z+c6aUjHmEhIF4gXyBc76EZW18fGl+fkl+jCxrhoVwhDyUhIqGlL2DlI6EhJd2tdN7eYORhEGMa2Faa6pzc3Bzc4R5lIRznM+UY9eMhDycc5Z+c4p5c4iGY117pb6MgXuPrbJafnx2eYOJeXZ5e657hDyEcziElKZjfoB5eHeGj4WRhGGEe6KGeX1utTStc76EhFGJnCyMa5hzfH6HnNeceYB7hmN8gYuMhIVrczSMgYF8h3N7c5pza5hzjJqEYIRdgYuMlL2DeYRzhGGEeX1uhLaEc4iGeZ1zdl6JhrVteX6Me2iMfm5lWqJzSpqEa6pzdnmchHx2c6OMhNdrhoR5g3aHczxzeW52gV6Ejm15frGMc0Vzc4Z+l3drfniJe+9rWq5rlF1rhGGEhoVwe9OEfoh+e7pac09+c3qBY0lrhDycdnp2lJ6MiYOGhGCDc3aRlL2DlJt5doaGdnp2gYF8gWeOjF2Uc4R5c5Z+jEmMe7KEc4mEeYJ4dmyBe0mcgXiPbqJ7eYB7fmGGiYSJjICGlF1reZ2PnElzbpqJfH6Hc39oe4WEc5eJhK6EhqyJc3qBgZB8c09+hEmEaHKDhFGJc5SGiXWMUpaEa89zc6OMnCyMiXtrho+Be5qMc7KEjJ57dmN+hKGPjICGbmiEe7prdod+hGCDdnmchBx7eX6MkXZ2hGGEa657hm98jFFjY5JreYOJgY2EjHZ2a295Y3FajJ6Mc1J+YzB7e4WBjF2Uc4R5eV12gYxzg1qBeId+c9OUc5pzjFFjgY5+hFiMlIaPhoR5lIpjjIKBlNdSe7KEeX2BfrGMhIqGc65zjE2UhK6EklZ+QmWEeziMWqZza3VzdnR4foh+gYF8n3iJiZhrnKp7gYF8eId+lJ6Me1lrcIuGjKJjhmN8c66MjFF7a6prjJ6UnJ5zezyUfruRWlF7nI5zfHyGe657h4SEe8tjhBx7jFFjc09+c39ojICMeZeJeXt+YzRzjHZ2c0WEcIeBeXZ5onSXkVR+gYJ+eYFwdldzgYF7eX2BjJ6UiXuXlE1jh4SEe1mchLJjc4Z+hqZ7eXZ5bm1zlL6Ue5p7iWeGhKqUY5pzjKJjcIeBe8t7gXyBYIRdlEp4a3mGnK6EfmmMZpqEfFl5gYxzjKZuhGFjhoKGhHx2fnx2eXuMe3aBiWeGvbKMe6KGa5hzYzB7gZOBlGV7hmN8hqZlYot2Y117a6pzc6KEfId8foB5rctrfneJfJ6PcHN2hFiMc5pzjH92c0VzgY2EcElzdmCBlFVzg1GBc65zY4OBboeBcHiBeYJ4ewxzfHx5lIRzlEmEnLKEbk1zfJ6PhmN8eYBljBiEnMOEiXxwezyUcIeBe76EdsKEeX2BdnR4jGWUrXWMjGd7fkl+j4WRlEGMa5Jzho+BhDyEfnqMeXt+g3aHlE1jczClhNN7ZW18eHx8hGFjZW18iXWMjKJjhH57gYuMcIuGWjyMe4ZtjJuExmmMj4WRdntzi4GDhFFzYIRdnGGcjJp7Y0F7e4WEkbCGiX57fnSHa657a6prhBCMe3Z+SmmMjH92eHJ2hK6EY1FzexhrvbKMnI5za4OEfnd+eXuMhImBe897hLaMjN+EfG+BeIOBhF1+eZeJi4GDkXZ2eXKEgZ6Ejpd4c2GHa1V5e5KUfqZuhCx7jKp7lLZrg11+hHx2hFWUoot2nI5zgbh5mo9zvZaUe3qRbqKMfqZ2kbCGhFiM";function Q5(t){t.fragment.uniforms.add(new pr("projInfo",(e,r)=>Xnt(r))),t.fragment.uniforms.add(new kr("zScale",(e,r)=>a2e(r))),t.fragment.code.add(w`vec3 reconstructPosition(vec2 fragCoord, float depth) {
return vec3((fragCoord * projInfo.xy + projInfo.zw) * (zScale.x * depth + zScale.y), depth);
}`)}function Xnt(t){const e=t.camera.projectionMatrix;return e[11]===0?ti(Zne,2/(t.camera.fullWidth*e[0]),2/(t.camera.fullHeight*e[5]),(1+e[12])/e[0],(1+e[13])/e[5]):ti(Zne,-2/(t.camera.fullWidth*e[0]),-2/(t.camera.fullHeight*e[5]),(1-e[8])/e[0],(1-e[9])/e[5])}const Zne=sr();function a2e(t){return t.camera.projectionMatrix[11]===0?or(Jne,0,1):or(Jne,1,0)}const Jne=Je(),Kne=16;function Ynt(){const t=new Dr,e=t.fragment;return t.include(Jh),e.include(Nu),t.include(Q5),e.uniforms.add(new Pe("radius",(r,i)=>zZ(i.camera))),e.code.add(w`vec3 sphere[16];
void fillSphere() {
sphere[0] = vec3(0.186937, 0.0, 0.0);
sphere[1] = vec3(0.700542, 0.0, 0.0);
sphere[2] = vec3(-0.864858, -0.481795, -0.111713);
sphere[3] = vec3(-0.624773, 0.102853, -0.730153);
sphere[4] = vec3(-0.387172, 0.260319, 0.007229);
sphere[5] = vec3(-0.222367, -0.642631, -0.707697);
sphere[6] = vec3(-0.01336, -0.014956, 0.169662);
sphere[7] = vec3(0.122575, 0.1544, -0.456944);
sphere[8] = vec3(-0.177141, 0.85997, -0.42346);
sphere[9] = vec3(-0.131631, 0.814545, 0.524355);
sphere[10] = vec3(-0.779469, 0.007991, 0.624833);
sphere[11] = vec3(0.308092, 0.209288,0.35969);
sphere[12] = vec3(0.359331, -0.184533, -0.377458);
sphere[13] = vec3(0.192633, -0.482999, -0.065284);
sphere[14] = vec3(0.233538, 0.293706, -0.055139);
sphere[15] = vec3(0.417709, -0.386701, 0.442449);
}
float fallOffFunction(float vv, float vn, float bias) {
float f = max(radius * radius - vv, 0.0);
return f * f * f * max(vn-bias, 0.0);
}`),e.code.add(w`float aoValueFromPositionsAndNormal(vec3 C, vec3 n_C, vec3 Q) {
vec3 v = Q - C;
float vv = dot(v, v);
float vn = dot(normalize(v), n_C);
return fallOffFunction(vv, vn, 0.1);
}`),e.uniforms.add([new kr("nearFar",(r,i)=>i.camera.nearFar),new Mt("normalMap",r=>r.normalTexture),new Mt("depthMap",r=>r.depthTexture),new kr("zScale",(r,i)=>a2e(i)),new Pe("projScale",r=>r.projScale),new Mt("rnm",r=>r.noiseTexture),new kr("rnmScale",(r,i)=>or(Qne,i.camera.fullWidth/r.noiseTexture.descriptor.width,i.camera.fullHeight/r.noiseTexture.descriptor.height)),new Pe("intensity",r=>r.intensity),new kr("screenSize",(r,i)=>or(Qne,i.camera.fullWidth,i.camera.fullHeight))]),e.code.add(w`
    void main(void) {
      fillSphere();
      vec3 fres = normalize((texture2D(rnm, uv * rnmScale).xyz * 2.0) - vec3(1.0));
      float currentPixelDepth = linearDepthFromTexture(depthMap, uv, nearFar);

      if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
        gl_FragColor = vec4(0.0);
        return;
      }

      vec3 currentPixelPos = reconstructPosition(gl_FragCoord.xy,currentPixelDepth);

      // get the normal of current fragment
      vec4 norm4 = texture2D(normalMap, uv);
      vec3 norm = vec3(-1.0) + 2.0 * norm4.xyz;
      bool isTerrain = norm4.w<0.5;

      float sum = .0;
      vec3 tapPixelPos;

      // note: the factor 2.0 should not be necessary, but makes ssao much nicer.
      // bug or deviation from CE somewhere else?
      float ps = projScale / (2.0 * currentPixelPos.z * zScale.x + zScale.y);

      for(int i = 0; i < ${w.int(Kne)}; ++i) {
        vec2 unitOffset = reflect(sphere[i], fres).xy;
        vec2 offset = vec2(-unitOffset * radius * ps);

        //don't use current or very nearby samples
        if ( abs(offset.x)<2.0 || abs(offset.y)<2.0) continue;

        vec2 tc = vec2(gl_FragCoord.xy + offset);
        if (tc.x < 0.0 || tc.y < 0.0 || tc.x > screenSize.x || tc.y > screenSize.y) continue;
        vec2 tcTap = tc / screenSize;
        float occluderFragmentDepth = linearDepthFromTexture(depthMap, tcTap, nearFar);

        if (isTerrain) {
          bool isTerrainTap = texture2D(normalMap, tcTap).w<0.5;
          if (isTerrainTap) {
            continue;
          }
        }

        tapPixelPos = reconstructPosition(tc, occluderFragmentDepth);

        sum+= aoValueFromPositionsAndNormal(currentPixelPos, norm, tapPixelPos);
      }

      // output the result
      float A = max(1.0 - sum * intensity / float(${w.int(Kne)}),0.0);

      // Anti-tone map to reduce contrast and drag dark region farther: (x^0.2 + 1.2 * x^4)/2.2
      A = (pow(A, 0.2) + 1.2 * A*A*A*A) / 2.2;
      gl_FragColor = vec4(A);
    }
  `),t}function zZ(t){return Math.max(10,20*t.computeRenderPixelSizeAtDist(Math.abs(4*t.relativeElevation)))}const Qne=Je(),Znt=Object.freeze(Object.defineProperty({__proto__:null,build:Ynt,getRadius:zZ},Symbol.toStringTag,{value:"Module"}));let l2e=class c2e extends Vr{initializeProgram(e){return new Fr(e.rctx,c2e.shader.get().build(),Rr)}initializePipeline(){return Bt({colorWrite:Kt})}};l2e.shader=new Nr(Znt,()=>te(()=>import("./SSAO.glsl-6aa9df81.js"),[]));let Jnt=class extends pi{constructor(){super(...arguments),this.projScale=1}},Knt=class extends Jnt{constructor(){super(...arguments),this.intensity=1}},Qnt=class extends pi{},eot=class extends Qnt{constructor(){super(...arguments),this.blurSize=Je()}};const b3=2;let u2e=class{constructor(e,r,i,s){this._view=e,this._techniqueRepository=r,this._rctx=i,this._requestRender=s,this._quadVAO=null,this._passParameters=new Knt,this._drawParameters=new eot}dispose(){this.enabled=!1,this._quadVAO=Qe(this._quadVAO)}disposeOffscreenBuffers(){so(this._ssaoFBO,e=>e.resize(0,0)),so(this._blur0FBO,e=>e.resize(0,0)),so(this._blur1FBO,e=>e.resize(0,0))}set enabled(e){e?this._enable():this._disable()}get enabled(){return v(this._enableTime)}get active(){return this.enabled&&this._ssaoTechnique.compiled&&this._blurTechnique.compiled}get colorTexture(){return v(this._blur1FBO)?this._blur1FBO.colorTexture:null}render(e,r,i,s){if(C(this._enableTime)||C(i)||C(s)||C(this._ssaoFBO)||C(this._blur0FBO)||C(this._blur1FBO))return;if(!this.active)return this._enableTime=r,void this._requestRender();this._enableTime===0&&(this._enableTime=r);const n=this._rctx,o=e.camera,a=this._view.qualitySettings.fadeDuration,l=a>0?Math.min(a,r-this._enableTime)/a:1;this._passParameters.normalTexture=s,this._passParameters.depthTexture=i,this._passParameters.projScale=1/o.computeRenderPixelSizeAtDist(1),this._passParameters.intensity=4*tot/zZ(o)**6*l;const c=o.fullViewport,h=c[2],p=c[3],f=h/b3,m=p/b3;this._ssaoFBO.resize(h,p),this._blur0FBO.resize(f,m),this._blur1FBO.resize(f,m),C(this._quadVAO)&&(this._quadVAO=Aa(this._rctx)),n.bindFramebuffer(this._ssaoFBO),n.setViewport(0,0,h,p),n.bindTechnique(this._ssaoTechnique,this._passParameters,e).bindDraw(this._drawParameters,e,this._passParameters),n.bindVAO(this._quadVAO);const y=Wo(this._quadVAO,"geometry");n.drawArrays($t.TRIANGLE_STRIP,0,y);const _=n.bindTechnique(this._blurTechnique,this._passParameters,e);n.setViewport(0,0,f,m),n.bindFramebuffer(this._blur0FBO),this._drawParameters.colorTexture=this._ssaoFBO.colorTexture,or(this._drawParameters.blurSize,0,b3/p),_.bindDraw(this._drawParameters,e,this._passParameters),n.setViewport(0,0,f,m),n.drawArrays($t.TRIANGLE_STRIP,0,y),n.bindFramebuffer(this._blur1FBO),this._drawParameters.colorTexture=this._blur0FBO.colorTexture,or(this._drawParameters.blurSize,b3/h,0),_.bindDraw(this._drawParameters,e,this._passParameters),n.drawArrays($t.TRIANGLE_STRIP,0,y),n.setViewport(c[0],c[1],c[2],c[3]),l<1&&this._requestRender()}_enable(){if(v(this._enableTime))return;const e={target:bt.TEXTURE_2D,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.LINEAR,wrapMode:Rt.CLAMP_TO_EDGE,width:0,height:0},r={colorTarget:ls.TEXTURE,depthStencilTarget:$r.NONE};this._ssaoFBO=new Ds(this._rctx,r,e),this._blur0FBO=new Ds(this._rctx,r,e),this._blur1FBO=new Ds(this._rctx,r,e);const i=Uint8Array.from(atob(Wnt),s=>s.charCodeAt(0));this._passParameters.noiseTexture=new ct(this._rctx,{target:bt.TEXTURE_2D,pixelFormat:Ve.RGB,dataType:Lt.UNSIGNED_BYTE,hasMipmap:!0,width:32,height:32},i),C(this._ssaoTechnique)&&(this._ssaoTechnique=this._techniqueRepository.acquire(l2e)),C(this._blurTechnique)&&(this._blurTechnique=this._techniqueRepository.acquire(n2e)),this._enableTime=0,this._requestRender()}_disable(){this._enableTime=null,this._passParameters.noiseTexture=Qe(this._passParameters.noiseTexture),this._blur1FBO=Qe(this._blur1FBO),this._blur0FBO=Qe(this._blur0FBO),this._ssaoFBO=Qe(this._ssaoFBO)}get gpuMemoryUsage(){return(v(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+(v(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(v(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}get test(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}};const tot=.5;let GZ=class h2e extends Vr{initializeProgram(e){return new Fr(e.rctx,h2e.shader.get().build(),Rr)}initializePipeline(){return this.configuration.hasAlpha?Bt({blending:kn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Kt}):Bt({colorWrite:Kt})}};GZ.shader=new Nr(Rtt,()=>te(()=>import("./TextureOnly.glsl-132721e0.js"),[]));let jZ=class extends Ca{constructor(){super(...arguments),this.hasAlpha=!1}};u([V()],jZ.prototype,"hasAlpha",void 0);let Od=class extends Te{get _bindParameters(){return this._renderContext.bindParameters}get rctx(){return this._rctx}get materialRepository(){return this._materialRepository}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}constructor(e){super(e),this._overlays=null,this._overlayRenderTarget=null,this._hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._handles=new ei,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new Jt,this._passParameters=new gZ,this._rctx=null,this._materialRepository=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this._camera=new Ct,this.worldToPCSRatio=1,this.events=new vs,this.longitudeCyclical=null}initialize(){const e=this.view._stage.renderView;this._rctx=e.renderingContext;const r=e.waterTextureRepository;this._stippleTextureRepository=new RTe(e.renderingContext),this._shaderTechniqueRepository=new xTe({rctx:this._rctx,viewingMode:Be.Local,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:r}),this._renderContext=new GTe(this._rctx,new UZ(this._rctx,this.view.state.viewingMode),new u2e(this.view,this._shaderTechniqueRepository,this._rctx,()=>{})),this._handles.add([ie(()=>r.updating,()=>this.events.emit("content-changed"),js),ie(()=>this.spatialReference,i=>this._localOriginFactory=new FZ(i),js),sn(()=>this.view.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0)]),this._materialRepository=new TTe(e.textureRepository,this._shaderTechniqueRepository,i=>{(i.renderOccluded&LF)>0!==this._rendersOccluded&&this._updateRendersOccluded(),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed")),this._bindParameters.slot=Se.DRAPED_MATERIAL,this._bindParameters.highlightDepthTexture=t1e(this._rctx),this._camera.near=1,this._camera.far=1e4,this._camera.relativeElevation=null,this._bindParameters.camera=this._camera,this._bindParameters.transparencyPassType=xt.NONE,this._bindParameters.newLighting.noonFactor=0,this._bindParameters.newLighting.globalFactor=0,this._bindParameters.newLighting.set([new yY($e(1,1,1))]),this._handles.add(this.view.resourceController.scheduler.registerTask(_t.STAGE,this))}destroy(){this._handles.destroy(),this._renderers.forEach(e=>e.destroy()),this._renderers.clear(),this._debugTextureTechnique=Bi(this._debugTextureTechnique),this._passParameters.texture=Qe(this._passParameters.texture),this._bindParameters.highlightDepthTexture=Qe(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=ke(this._shaderTechniqueRepository),this._temporaryFBO=Qe(this._temporaryFBO),this._quadVAO=Qe(this._quadVAO),this.disposeOverlays()}get updating(){return this._sortedDrapeSourceRenderersDirty||Ho(this._renderers,e=>e.updating)}get hasOverlays(){return v(this._overlays)&&v(this._overlayRenderTarget)}get gpuMemoryUsage(){return v(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}createGeometryDrapeSourceRenderer(e){return this.createDrapeSourceRenderer(e,nu)}createDrapeSourceRenderer(e,r,i){const s=this._renderers.get(e);v(s)&&s.destroy();const n=new r({...i,rendererContext:this,drapeSource:e});return this._renderers.set(e,n),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(ie(()=>e.fullOpacity,()=>this.events.emit("content-changed")),e),n}removeDrapeSourceRenderer(e){if(C(e))return;const r=this._renderers.get(e);C(r)||(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this._handles.remove(e),r.destroy())}collectUnusedRenderTargetMemory(e){let r=!1;if(v(this._overlayRenderTarget))for(const i of this._overlayRenderTarget.renderTargets){const[s,n]=this.overlays,o=s.validTargets[i.type]||!n.validTargets[i.type];r=this._overlayRenderTarget.validateUsageForTarget(o,i,e)||r}return r}get overlays(){return It(this._overlays,[])}ensureDrapeTargets(e){v(this._overlays)&&this._overlays.forEach(r=>r.hasTargetWithoutRasterImage=j$(e,i=>i.drapeTargetType===Bj.WithoutRasterImage))}ensureDrapeSources(e){v(this._overlays)&&this._overlays.forEach(r=>{r.hasDrapedFeatureSource=j$(e,i=>i.drapeSourceType===_R.Features),r.hasDrapedRasterSource=j$(e,i=>i.drapeSourceType===_R.RasterImage)})}ensureOverlays(e,r){C(this._overlays)&&(this._overlayRenderTarget=new Tst(this._rctx),this._overlays=[new Sne(Ki.INNER,this._overlayRenderTarget),new Sne(Ki.OUTER,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(r)}disposeOverlays(){this._overlays=null,this._overlayRenderTarget=Qe(this._overlayRenderTarget),this.events.emit("textures-disposed")}get running(){return this.updating}runTask(e){this._processDrapeSources(e,()=>!0)}_processDrapeSources(e,r){let i=!1;for(const[s,n]of this._renderers){if(e.done)break;(s.destroyed||r(s))&&n.commitChanges()&&(i=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,i=!0,this._updateSortedDrapeSourceRenderers()),i&&(v(this._overlays)&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this._updateHasHighlights(),this._updateRendersOccluded(),this._updateHasWater())}processSyncDrapeSources(){this._processDrapeSources(Xa,e=>e.updatePolicy===B_.SYNC)}get isEmpty(){return!qr.OVERLAY_DRAW_DEBUG_TEXTURE&&!Ho(this._renderers,e=>!e.isEmpty)}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}updateAnimation(e){let r=!1;return this._renderers.forEach(i=>r=i.updateAnimation(e)||r),r}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}drawTarget(e,r,i){const s=e.canvasGeometries;if(s.numViews===0)return!1;this._screenToWorldRatio=i*e.mapUnitsPerPixel;const n=r.output;if(this.isEmpty||n===k.Highlight&&!this.hasHighlights||n===k.Normal&&!this.hasWater||!e.hasSomeSizedView())return!1;const o=r.fbo;if(!o.isValid())return!1;const a=2*e.resolution,l=e.resolution;o.resize(a,l);const c=this._rctx;if(this._camera.pixelRatio=e.pixelRatio*i,this._renderContext.output=n,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=n===k.Normal?Se.DRAPED_WATER:Se.DRAPED_MATERIAL,e.applyViewport(this._rctx),o.bind(c),e.index===Ki.INNER&&(c.setClearColor(0,0,0,0),c.clearSafe(Li.COLOR_BUFFER_BIT)),r.type===fs.Occluded&&(this._renderContext.renderOccludedMask=LF),qr.OVERLAY_DRAW_DEBUG_TEXTURE&&r.type!==fs.Occluded)for(let h=0;h<s.numViews;h++)this._setViewParameters(s.extents[h],e),this._drawDebugTexture(e.resolution,iot[e.index]);return this._renderers.size>0&&this._sortedRenderers.forAll(({drapeSource:h,renderer:p})=>{if(r.type===fs.ColorNoRasterImage&&h.drapeSourceType===_R.RasterImage)return;const{fullOpacity:f}=h,m=v(f)&&f<1&&n===k.Color;m&&(this.bindTemporaryFramebuffer(this._rctx,a,l),c.clearSafe(Li.COLOR_BUFFER_BIT));for(let y=0;y<s.numViews;y++)this._setViewParameters(s.extents[y],e),p.render(this._renderContext);m&&v(this._temporaryFBO)&&(o.bind(c),this.view._stage.renderView.compositingHelper.compositeOverlay(this._renderContext.bindParameters,this._temporaryFBO.getTexture(),f,e.index))}),c.bindFramebuffer(null),o.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}bindTemporaryFramebuffer(e,r,i){C(this._temporaryFBO)&&(this._temporaryFBO=new wTe(e,!1)),this._temporaryFBO.resize(r,i),this._temporaryFBO.bind(e)}async reloadShaders(){await this._shaderTechniqueRepository.reloadAll()}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,r,i,s){var o;let n=0;for(const a of this._renderers.values())n=((o=a.intersect)==null?void 0:o.call(a,e,r,i,s,n))??n}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;const e=this.view.map.allLayers;this._renderers.forEach((r,i)=>{const s=e.indexOf(i.layer),n=s>=0,o=this._renderers.size*(i.renderGroup??(n?OF.MapLayer:OF.ViewLayer))+(n?s:0);this._sortedRenderers.push(new rot(i,r,o))}),this._sortedRenderers.sort((r,i)=>r.index-i.index)}_setViewParameters(e,r){const i=this._camera;i.viewport=[0,0,r.resolution,r.resolution],sfe(i.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],i.near,i.far),$4(i.viewMatrix,[-e[0],-e[1],0])}_updateHasWater(){const e=Ho(this._renderers,r=>r.hasWater);e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))}_updateHasHighlights(){const e=Ho(this._renderers,r=>r.hasHighlights);e!==this._hasHighlights&&(this._hasHighlights=e,this.events.emit("has-highlights",e))}_updateRendersOccluded(){const e=Ho(this._renderers,r=>r.rendersOccluded);e!==this._rendersOccluded&&(this._rendersOccluded=e,this.events.emit("renders-occluded",e))}_drawDebugTexture(e,r){this._ensureDebugPatternResources(e,e,r);const i=this._rctx;i.bindTechnique(this._debugTextureTechnique,this._passParameters,null),i.bindVAO(this._quadVAO),i.drawArrays($t.TRIANGLE_STRIP,0,Wo(this._quadVAO,"geometry"))}_ensureDebugPatternResources(e,r,i){if(ce(this._passParameters.color,i[0],i[1],i[2]),this._passParameters.texture)return;const s=new Uint8Array(e*r*4);let n=0;for(let a=0;a<r;a++)for(let l=0;l<e;l++){const c=Math.floor(l/10),h=Math.floor(a/10);c<2||h<2||10*c>e-20||10*h>r-20?(s[n++]=255,s[n++]=255,s[n++]=255,s[n++]=255):(s[n++]=255,s[n++]=255,s[n++]=255,s[n++]=1&c&&1&h?1&l^1&a?0:255:1&c^1&h?0:128)}this._passParameters.texture=new ct(this._rctx,{target:bt.TEXTURE_2D,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,width:e,height:r},s);const o=new jZ;o.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(GZ,o),this._quadVAO=Aa(this._rctx)}get test(){return{drapedRenderers:Array.from(this._renderers.values()),getDrapeSourceRenderer:e=>this._renderers.get(e)}}};u([d()],Od.prototype,"_sortedDrapeSourceRenderersDirty",void 0),u([d({autoDestroy:!0})],Od.prototype,"_shaderTechniqueRepository",void 0),u([d({autoDestroy:!0})],Od.prototype,"_stippleTextureRepository",void 0),u([d({constructOnly:!0})],Od.prototype,"view",void 0),u([d()],Od.prototype,"worldToPCSRatio",void 0),u([d()],Od.prototype,"spatialReference",void 0),u([d({type:Boolean,readOnly:!0})],Od.prototype,"updating",null),u([d()],Od.prototype,"isEmpty",null),Od=u([I("esri.views.3d.terrain.OverlayRenderer")],Od);let rot=class{constructor(e,r,i){this.drapeSource=e,this.renderer=r,this.index=i}};const iot=[[1,.5,.5],[.5,.5,1]],HZ=-2,LF=ns.OccludeAndTransparent;function qZ(t,e,r,i){const s=FM(t.rings,!!t.hasZ,hm.CCW_IS_HOLE),n=Fc(s.position.length),o=qxe(s.position,t.spatialReference,0,n,0,s.position,0,s.position.length/3,e,r,i),a=o!=null;return new oot(s.position,n,f2e(s.polygons,s.position,n),p2e(s.outlines,s.position,n),a,o)}function d2e(t,e){const r=FM(t.rings,!1,hm.CCW_IS_HOLE),i=_s(r.position,t.spatialReference,0,r.position,e,0,r.position.length/3);for(let s=2;s<r.position.length;s+=3)r.position[s]=HZ;return{position:r.position,polygons:f2e(r.polygons,r.position),outlines:p2e(r.outlines,r.position),projectionSuccess:i}}function p2e(t,e,r=null){return t.filter(({count:i})=>i>1).map(({index:i,count:s})=>{const n=3*i,o=3*s;return v(r)?new m2e(i,s,Lh(e,n,o),Lh(r,n,o)):new WZ(i,s,Lh(e,n,o))})}function f2e(t,e,r=null){const i=new Array;for(const{index:s,count:n,holeIndices:o,pathLengths:a}of t){if(n<=1)continue;const l=3*s,c=3*n,h=o.map(f=>f-s),p=v(r)?new sot(s,n,Lh(e,3*s,3*n),Lh(r,l,c),h,a):new not(s,n,Lh(e,3*s,3*n),h,a);i.push(p)}return i}let WZ=class{constructor(e,r,i){this.index=e,this.count=r,this.position=i}},m2e=class extends WZ{constructor(e,r,i,s){super(e,r,i),this.mapPositions=s}},sot=class extends m2e{constructor(e,r,i,s,n,o){super(e,r,i,s),this.holeIndices=n,this.pathLengths=o}},not=class extends WZ{constructor(e,r,i,s,n){super(e,r,i),this.holeIndices=s,this.pathLengths=n}},oot=class{constructor(e,r,i,s,n,o){this.position=e,this.mapPositions=r,this.polygons=i,this.outlines=s,this.projectionSuccess=n,this.sampledElevation=o}};function g2e(t,e){const r=t.fragment;switch(r.code.add(w`struct ShadingNormalParameters {
vec3 normalView;
vec3 viewDirection;
} shadingParams;`),e.doubleSidedMode){case cs.None:r.code.add(w`vec3 shadingNormal(ShadingNormalParameters params) {
return normalize(params.normalView);
}`);break;case cs.View:r.code.add(w`vec3 shadingNormal(ShadingNormalParameters params) {
return dot(params.normalView, params.viewDirection) > 0.0 ? normalize(-params.normalView) : normalize(params.normalView);
}`);break;case cs.WindingOrder:r.code.add(w`vec3 shadingNormal(ShadingNormalParameters params) {
return gl_FrontFacing ? normalize(params.normalView) : normalize(-params.normalView);
}`);break;default:e.doubleSidedMode;case cs.COUNT:}}var cs;(function(t){t[t.None=0]="None",t[t.View=1]="View",t[t.WindingOrder=2]="WindingOrder",t[t.COUNT=3]="COUNT"})(cs||(cs={}));function y2e(t){t.vertex.code.add(w`vec4 offsetBackfacingClipPosition(vec4 posClip, vec3 posWorld, vec3 normalWorld, vec3 camPosWorld) {
vec3 camToVert = posWorld - camPosWorld;
bool isBackface = dot(camToVert, normalWorld) > 0.0;
if (isBackface) {
posClip.z += 0.0000003 * posClip.w;
}
return posClip;
}`)}let aot=class extends Ca{constructor(){super(...arguments),this.instancedDoublePrecision=!1}};function _2e(t,e){e.instanced&&e.instancedDoublePrecision&&(t.attributes.add(A.MODELORIGINHI,"vec3"),t.attributes.add(A.MODELORIGINLO,"vec3"),t.attributes.add(A.MODEL,"mat3"),t.attributes.add(A.MODELNORMAL,"mat3"));const r=t.vertex;e.instancedDoublePrecision&&(r.include(iF,e),r.uniforms.add(new Pu("viewOriginHi",(i,s)=>tYe(ce(zI,s.camera.viewInverseTransposeMatrix[3],s.camera.viewInverseTransposeMatrix[7],s.camera.viewInverseTransposeMatrix[11]),zI))),r.uniforms.add(new Pu("viewOriginLo",(i,s)=>rYe(ce(zI,s.camera.viewInverseTransposeMatrix[3],s.camera.viewInverseTransposeMatrix[7],s.camera.viewInverseTransposeMatrix[11]),zI)))),r.code.add(w`
    vec3 calculateVPos() {
      ${e.instancedDoublePrecision?"return model * localPosition().xyz;":"return localPosition().xyz;"}
    }
    `),r.code.add(w`
    vec3 subtractOrigin(vec3 _pos) {
      ${e.instancedDoublePrecision?w`
          vec3 originDelta = dpAdd(viewOriginHi, viewOriginLo, -modelOriginHi, -modelOriginLo);
          return _pos - originDelta;`:"return vpos;"}
    }
    `),r.code.add(w`
    vec3 dpNormal(vec4 _normal) {
      ${e.instancedDoublePrecision?"return normalize(modelNormal * _normal.xyz);":"return normalize(_normal.xyz);"}
    }
    `),e.output===k.Normal&&(nE(r),r.code.add(w`
    vec3 dpNormalView(vec4 _normal) {
      ${e.instancedDoublePrecision?"return normalize((viewNormal * vec4(modelNormal * _normal.xyz, 1.0)).xyz);":"return normalize((viewNormal * _normal).xyz);"}
    }
    `)),e.hasVertexTangents&&r.code.add(w`
    vec4 dpTransformVertexTangent(vec4 _tangent) {
      ${e.instancedDoublePrecision?"return vec4(modelNormal * _tangent.xyz, _tangent.w);":"return _tangent;"}

    }
    `)}u([V()],aot.prototype,"instancedDoublePrecision",void 0);const zI=M();var _n;function lot(t){switch(t){case"multiply":default:return _n.Multiply;case"ignore":return _n.Ignore;case"replace":return _n.Replace;case"tint":return _n.Tint}}function v2e(t,e,r){if(C(t)||e===_n.Ignore)return r[0]=255,r[1]=255,r[2]=255,void(r[3]=255);const i=ge(Math.round(t[3]*DF),0,DF),s=i===0||e===_n.Tint?0:e===_n.Replace?cot:uot;r[0]=ge(Math.round(t[0]*Fx),0,Fx),r[1]=ge(Math.round(t[1]*Fx),0,Fx),r[2]=ge(Math.round(t[2]*Fx),0,Fx),r[3]=i+s}(function(t){t[t.Multiply=1]="Multiply",t[t.Ignore=2]="Ignore",t[t.Replace=3]="Replace",t[t.Tint=4]="Tint"})(_n||(_n={}));const Fx=255,DF=85,cot=DF,uot=2*DF;function b2e(t){t.vertex.code.add(w`
    vec4 decodeSymbolColor(vec4 symbolColor, out int colorMixMode) {
      float symbolAlpha = 0.0;

      const float maxTint = 85.0;
      const float maxReplace = 170.0;
      const float scaleAlpha = 3.0;

      if (symbolColor.a > maxReplace) {
        colorMixMode = ${w.int(_n.Multiply)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxReplace);
      } else if (symbolColor.a > maxTint) {
        colorMixMode = ${w.int(_n.Replace)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxTint);
      } else if (symbolColor.a > 0.0) {
        colorMixMode = ${w.int(_n.Tint)};
        symbolAlpha = scaleAlpha * symbolColor.a;
      } else {
        colorMixMode = ${w.int(_n.Multiply)};
        symbolAlpha = 0.0;
      }

      return vec4(symbolColor.r, symbolColor.g, symbolColor.b, symbolAlpha);
    }
  `)}function w2e(t,e){e.hasSymbolColors?(t.include(b2e),t.attributes.add(A.SYMBOLCOLOR,"vec4"),t.varyings.add("colorMixMode","mediump float"),t.vertex.code.add(w`int symbolColorMixMode;
vec4 getSymbolColor() {
return decodeSymbolColor(symbolColor, symbolColorMixMode) * 0.003921568627451;
}
void forwardColorMixMode() {
colorMixMode = float(symbolColorMixMode) + 0.5;
}`)):(t.fragment.uniforms.add(new kM("colorMixMode",r=>txe[r.colorMixMode])),t.vertex.code.add(w`vec4 getSymbolColor() { return vec4(1.0); }
void forwardColorMixMode() {}`))}function sx(t,e){e.hasVertexColors?(t.attributes.add(A.COLOR,"vec4"),t.varyings.add("vColor","vec4"),t.vertex.code.add(w`void forwardVertexColor() { vColor = color; }`),t.vertex.code.add(w`void forwardNormalizedVertexColor() { vColor = color * 0.003921568627451; }`)):t.vertex.code.add(w`void forwardVertexColor() {}
void forwardNormalizedVertexColor() {}`)}function hot(t){t.fragment.code.add(w`
    #define discardOrAdjustAlpha(color) { if (color.a < ${w.float(Yo)}) { discard; } }
  `)}let ew=class extends ws{constructor(e,r){super(e,"float",di.Draw,(i,s,n)=>i.setUniform1f(e,r(s,n)))}};function tw(t,e){x2e(t,e,new Pe("textureAlphaCutoff",r=>r.textureAlphaCutoff))}function dot(t,e){x2e(t,e,new ew("textureAlphaCutoff",r=>r.textureAlphaCutoff))}function x2e(t,e,r){const i=t.fragment;switch(e.alphaDiscardMode!==ui.Mask&&e.alphaDiscardMode!==ui.MaskBlend||i.uniforms.add(r),e.alphaDiscardMode){case ui.Blend:return t.include(hot);case ui.Opaque:i.code.add(w`void discardOrAdjustAlpha(inout vec4 color) {
color.a = 1.0;
}`);break;case ui.Mask:i.code.add(w`#define discardOrAdjustAlpha(color) { if (color.a < textureAlphaCutoff) { discard; } else { color.a = 1.0; } }`);break;case ui.MaskBlend:t.fragment.code.add(w`#define discardOrAdjustAlpha(color) { if (color.a < textureAlphaCutoff) { discard; } }`)}}function T2e(t,e){const{vertex:r,fragment:i}=t,s=e.hasModelTransformation;s&&r.uniforms.add(new Hi("model",o=>v(o.modelTransformation)?o.modelTransformation:Lu));const n=e.hasColorTexture&&e.alphaDiscardMode!==ui.Opaque;switch(e.output){case k.Depth:case k.Shadow:case k.ShadowHighlight:case k.ShadowExcludeHighlight:case k.ObjectAndLayerIdColor:$c(r,e),t.include(Bl,e),t.include(Zf,e),t.include(uS,e),t.include(ny,e),t.include(Xs,e),t.include(B5,e),Pw(t),t.varyings.add("depth","float"),n&&i.uniforms.add(new Mt("tex",o=>o.texture)),r.code.add(w`
          void main(void) {
            vpos = calculateVPos();
            vpos = subtractOrigin(vpos);
            vpos = addVerticalOffset(vpos, localOrigin);
            gl_Position = transformPositionWithDepth(proj, view, ${s?"model,":""} vpos, nearFar, depth);
            forwardTextureCoordinates();
            forwardObjectAndLayerIdColor();
          }
        `),t.include(tw,e),i.code.add(w`
          void main(void) {
            discardBySlice(vpos);
            ${n?w`
                    vec4 texColor = texture2D(tex, ${e.hasColorTextureTransform?w`colorUV`:w`vuv0`});
                    discardOrAdjustAlpha(texColor);`:""}
            ${e.output===k.ObjectAndLayerIdColor?w`outputObjectAndLayerIdColor();`:w`outputDepth(depth);`}
          }
        `);break;case k.Normal:$c(r,e),t.include(Bl,e),t.include(UM,e),t.include(J5,e),t.include(Zf,e),t.include(uS,e),n&&i.uniforms.add(new Mt("tex",o=>o.texture)),t.varyings.add("vPositionView","vec3"),r.code.add(w`
          void main(void) {
            vpos = calculateVPos();
            vpos = subtractOrigin(vpos);
            ${e.normalType===si.Attribute?w`
            vNormalWorld = dpNormalView(vvLocalNormal(normalModel()));`:""}
            vpos = addVerticalOffset(vpos, localOrigin);
            gl_Position = transformPosition(proj, view, ${s?"model,":""} vpos);
            forwardTextureCoordinates();
          }
        `),t.include(Xs,e),t.include(tw,e),i.code.add(w`
          void main() {
            discardBySlice(vpos);
            ${n?w`
                    vec4 texColor = texture2D(tex, ${e.hasColorTextureTransform?w`colorUV`:w`vuv0`});
                    discardOrAdjustAlpha(texColor);`:""}

            ${e.normalType===si.ScreenDerivative?w`
                vec3 normal = screenDerivativeNormal(vPositionView);`:w`
                vec3 normal = normalize(vNormalWorld);
                if (gl_FrontFacing == false) normal = -normal;`}
            gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
          }
        `);break;case k.Highlight:$c(r,e),t.include(Bl,e),t.include(Zf,e),t.include(uS,e),n&&i.uniforms.add(new Mt("tex",o=>o.texture)),r.code.add(w`
          void main(void) {
            vpos = calculateVPos();
            vpos = subtractOrigin(vpos);
            vpos = addVerticalOffset(vpos, localOrigin);
            gl_Position = transformPosition(proj, view, ${s?"model,":""} vpos);
            forwardTextureCoordinates();
          }
        `),t.include(Xs,e),t.include(tw,e),t.include(by,e),i.code.add(w`
          void main() {
            discardBySlice(vpos);
            ${n?w`
                    vec4 texColor = texture2D(tex, ${e.hasColorTextureTransform?w`colorUV`:w`vuv0`});
                    discardOrAdjustAlpha(texColor);`:""}
            outputHighlight();
          }
        `)}}function S2e(t,e){const r=t.fragment;if(e.hasVertexTangents?(t.attributes.add(A.TANGENT,"vec4"),t.varyings.add("vTangent","vec4"),e.doubleSidedMode===cs.WindingOrder?r.code.add(w`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = gl_FrontFacing ? vTangent.w : -vTangent.w;
vec3 tangent = normalize(gl_FrontFacing ? vTangent.xyz : -vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`):r.code.add(w`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = vTangent.w;
vec3 tangent = normalize(vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`)):(t.extensions.add("GL_OES_standard_derivatives"),r.code.add(w`mat3 computeTangentSpace(vec3 normal, vec3 pos, vec2 st) {
vec3 Q1 = dFdx(pos);
vec3 Q2 = dFdy(pos);
vec2 stx = dFdx(st);
vec2 sty = dFdy(st);
float det = stx.t * sty.s - sty.t * stx.s;
vec3 T = stx.t * Q2 - sty.t * Q1;
T = T - normal * dot(normal, T);
T *= inversesqrt(max(dot(T,T), 1.e-10));
vec3 B = sign(det) * cross(normal, T);
return mat3(T, B, normal);
}`)),e.textureCoordinateType!==qs.None){t.include(oY,e);const i=e.supportsTextureAtlas?e.hasWebGL2Context?Qr.None:Qr.Size:Qr.None;r.uniforms.add(e.pbrTextureBindType===di.Pass?op("normalTexture",s=>s.textureNormal,i):k_("normalTexture",s=>s.textureNormal,i)),r.code.add(w`
    vec3 computeTextureNormal(mat3 tangentSpace, vec2 uv) {
      vtc.uv = uv;
      ${e.supportsTextureAtlas?w`vtc.size = ${$h(e,"normalTexture")};`:""}
      vec3 rawNormal = textureLookup(normalTexture, vtc).rgb * 2.0 - 1.0;
      return tangentSpace * rawNormal;
    }
  `)}}function VM(t,e){const r=t.fragment;e.receiveAmbientOcclusion?(r.uniforms.add(op("ssaoTex",(i,s)=>s.ssaoHelper.colorTexture,e.hasWebGL2Context?Qr.None:Qr.InvSize)),r.constants.add("blurSizePixelsInverse","float",1/b3),r.code.add(w`
      float evaluateAmbientOcclusionInverse() {
        vec2 ssaoTextureSizeInverse = ${$h(e,"ssaoTex",!0)};
        return texture2D(ssaoTex, gl_FragCoord.xy * blurSizePixelsInverse * ssaoTextureSizeInverse).a;
      }

      float evaluateAmbientOcclusion() {
        return 1.0 - evaluateAmbientOcclusionInverse();
      }
    `)):r.code.add(w`float evaluateAmbientOcclusionInverse() { return 1.0; }
float evaluateAmbientOcclusion() { return 0.0; }`)}function BM(t){t.constants.add("ambientBoostFactor","float",I1e)}function YE(t){t.uniforms.add(new Pe("lightingGlobalFactor",(e,r)=>r.lighting.globalFactor))}function Uw(t,e){const r=t.fragment;switch(t.include(VM,e),e.pbrMode!==dt.Disabled&&t.include(VZ,e),t.include(cY,e),t.include(EM),r.code.add(w`
    const float GAMMA_SRGB = 2.1;
    const float INV_GAMMA_SRGB = 0.4761904;
    ${e.pbrMode===dt.Disabled?"":"const vec3 GROUND_REFLECTANCE = vec3(0.2);"}
  `),BM(r),YE(r),dy(r),r.code.add(w`
    float additionalDirectedAmbientLight(vec3 vPosWorld) {
      float vndl = dot(${e.spherical?w`normalize(vPosWorld)`:w`vec3(0.0, 0.0, 1.0)`}, mainLightDirection);
      return smoothstep(0.0, 1.0, clamp(vndl * 2.5, 0.0, 1.0));
    }
  `),vm(r),r.code.add(w`vec3 evaluateAdditionalLighting(float ambientOcclusion, vec3 vPosWorld) {
float additionalAmbientScale = additionalDirectedAmbientLight(vPosWorld);
return (1.0 - ambientOcclusion) * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor * mainLightIntensity;
}`),e.pbrMode){case dt.Disabled:case dt.WaterOnIntegratedMesh:case dt.Water:t.include(ZN,e),r.code.add(w`vec3 evaluateSceneLighting(vec3 normalWorld, vec3 albedo, float shadow, float ssao, vec3 additionalLight)
{
vec3 mainLighting = evaluateMainLighting(normalWorld, shadow);
vec3 ambientLighting = calculateAmbientIrradiance(normalWorld, ssao);
vec3 albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
vec3 totalLight = mainLighting + ambientLighting + additionalLight;
totalLight = min(totalLight, vec3(PI));
vec3 outColor = vec3((albedoLinear / PI) * totalLight);
return pow(outColor, vec3(INV_GAMMA_SRGB));
}`);break;case dt.Normal:case dt.Schematic:r.code.add(w`const float fillLightIntensity = 0.25;
const float horizonLightDiffusion = 0.4;
const float additionalAmbientIrradianceFactor = 0.02;
vec3 evaluateSceneLightingPBR(vec3 normal, vec3 albedo, float shadow, float ssao, vec3 additionalLight, vec3 viewDir, vec3 normalGround, vec3 mrr, vec3 _emission, float additionalAmbientIrradiance)
{
vec3 viewDirection = -viewDir;
vec3 h = normalize(viewDirection + mainLightDirection);
PBRShadingInfo inputs;
inputs.NdotL = clamp(dot(normal, mainLightDirection), 0.001, 1.0);
inputs.NdotV = clamp(abs(dot(normal, viewDirection)), 0.001, 1.0);
inputs.NdotH = clamp(dot(normal, h), 0.0, 1.0);
inputs.VdotH = clamp(dot(viewDirection, h), 0.0, 1.0);
inputs.NdotNG = clamp(dot(normal, normalGround), -1.0, 1.0);
vec3 reflectedView = normalize(reflect(viewDirection, normal));
inputs.RdotNG = clamp(dot(reflectedView, normalGround), -1.0, 1.0);
inputs.albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
inputs.ssao = ssao;
inputs.metalness = mrr[0];
inputs.roughness = clamp(mrr[1] * mrr[1], 0.001, 0.99);`),r.code.add(w`inputs.f0 = (0.16 * mrr[2] * mrr[2]) * (1.0 - inputs.metalness) + inputs.albedoLinear * inputs.metalness;
inputs.f90 = vec3(clamp(dot(inputs.f0, vec3(50.0 * 0.33)), 0.0, 1.0));
inputs.diffuseColor = inputs.albedoLinear * (vec3(1.0) - inputs.f0) * (1.0 - inputs.metalness);`),e.useFillLights?r.uniforms.add(new Bg("hasFillLights",(i,s)=>s.enableFillLights)):r.constants.add("hasFillLights","bool",!1),r.code.add(w`vec3 ambientDir = vec3(5.0 * normalGround[1] - normalGround[0] * normalGround[2], - 5.0 * normalGround[0] - normalGround[2] * normalGround[1], normalGround[1] * normalGround[1] + normalGround[0] * normalGround[0]);
ambientDir = ambientDir != vec3(0.0)? normalize(ambientDir) : normalize(vec3(5.0, -1.0, 0.0));
inputs.NdotAmbDir = hasFillLights ? abs(dot(normal, ambientDir)) : 1.0;
vec3 mainLightIrradianceComponent = inputs.NdotL * (1.0 - shadow) * mainLightIntensity;
vec3 fillLightsIrradianceComponent = inputs.NdotAmbDir * mainLightIntensity * fillLightIntensity;
vec3 ambientLightIrradianceComponent = calculateAmbientIrradiance(normal, ssao) + additionalLight;
inputs.skyIrradianceToSurface = ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;
inputs.groundIrradianceToSurface = GROUND_REFLECTANCE * ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;`),r.uniforms.add([new Pe("lightingSpecularStrength",(i,s)=>s.lighting.mainLight.specularStrength),new Pe("lightingEnvironmentStrength",(i,s)=>s.lighting.mainLight.environmentStrength)]),r.code.add(w`vec3 horizonRingDir = inputs.RdotNG * normalGround - reflectedView;
vec3 horizonRingH = normalize(viewDirection + horizonRingDir);
inputs.NdotH_Horizon = dot(normal, horizonRingH);
vec3 mainLightRadianceComponent = lightingSpecularStrength * normalDistribution(inputs.NdotH, inputs.roughness) * mainLightIntensity * (1.0 - shadow);
vec3 horizonLightRadianceComponent = lightingEnvironmentStrength * normalDistribution(inputs.NdotH_Horizon, min(inputs.roughness + horizonLightDiffusion, 1.0)) * mainLightIntensity * fillLightIntensity;
vec3 ambientLightRadianceComponent = lightingEnvironmentStrength * calculateAmbientRadiance(ssao) + additionalLight;
inputs.skyRadianceToSurface = ambientLightRadianceComponent + mainLightRadianceComponent + horizonLightRadianceComponent;
inputs.groundRadianceToSurface = GROUND_REFLECTANCE * (ambientLightRadianceComponent + horizonLightRadianceComponent) + mainLightRadianceComponent;
inputs.averageAmbientRadiance = ambientLightIrradianceComponent[1] * (1.0 + GROUND_REFLECTANCE[1]);`),r.code.add(w`
        vec3 reflectedColorComponent = evaluateEnvironmentIllumination(inputs);
        vec3 additionalMaterialReflectanceComponent = inputs.albedoLinear * additionalAmbientIrradiance;
        vec3 emissionComponent = pow(_emission, vec3(GAMMA_SRGB));
        vec3 outColorLinear = reflectedColorComponent + additionalMaterialReflectanceComponent + emissionComponent;
        ${e.pbrMode===dt.Schematic?w`vec3 outColor = pow(max(vec3(0.0), outColorLinear - 0.005 * inputs.averageAmbientRadiance), vec3(INV_GAMMA_SRGB));`:w`vec3 outColor = pow(blackLevelSoftCompression(outColorLinear, inputs), vec3(INV_GAMMA_SRGB));`}
        return outColor;
      }
    `);break;case dt.Terrain:case dt.TerrainWithWater:t.include(ZN,e),r.code.add(w`const float roughnessTerrain = 0.5;
const float specularityTerrain = 0.5;
const vec3 fresnelReflectionTerrain = vec3(0.04);
vec3 evaluateTerrainLighting(vec3 n, vec3 c, float shadow, float ssao, vec3 al, vec3 vd, vec3 nup) {
vec3 viewDirection = -vd;
vec3 h = normalize(viewDirection + mainLightDirection);
float NdotL = clamp(dot(n, mainLightDirection), 0.001, 1.0);
float NdotV = clamp(abs(dot(n, viewDirection)), 0.001, 1.0);
float NdotH = clamp(dot(n, h), 0.0, 1.0);
float NdotNG = clamp(dot(n, nup), -1.0, 1.0);
vec3 albedoLinear = pow(c, vec3(GAMMA_SRGB));
float lightness = 0.3 * albedoLinear[0] + 0.5 * albedoLinear[1] + 0.2 * albedoLinear[2];
vec3 f0 = (0.85 * lightness + 0.15) * fresnelReflectionTerrain;
vec3 f90 =  vec3(clamp(dot(f0, vec3(50.0 * 0.33)), 0.0, 1.0));
vec3 mainLightIrradianceComponent = (1. - shadow) * NdotL * mainLightIntensity;
vec3 ambientLightIrradianceComponent = calculateAmbientIrradiance(n, ssao) + al;
vec3 ambientSky = ambientLightIrradianceComponent + mainLightIrradianceComponent;
vec3 indirectDiffuse = ((1.0 - NdotNG) * mainLightIrradianceComponent + (1.0 + NdotNG ) * ambientSky) * 0.5;
vec3 outDiffColor = albedoLinear * (1.0 - f0) * indirectDiffuse / PI;
vec3 mainLightRadianceComponent = normalDistribution(NdotH, roughnessTerrain) * mainLightIntensity;
vec2 dfg = prefilteredDFGAnalytical(roughnessTerrain, NdotV);
vec3 specularColor = f0 * dfg.x + f90 * dfg.y;
vec3 specularComponent = specularityTerrain * specularColor * mainLightRadianceComponent;
vec3 outColorLinear = outDiffColor + specularComponent;
vec3 outColor = pow(outColorLinear, vec3(INV_GAMMA_SRGB));
return outColor;
}`);break;default:e.pbrMode;case dt.COUNT:}}function Gl(){const t=new Float32Array(9);return t[0]=1,t[4]=1,t[8]=1,t}function E2e(t){const e=new Float32Array(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}function mD(t,e,r,i,s,n,o,a,l){const c=new Float32Array(9);return c[0]=t,c[1]=e,c[2]=r,c[3]=i,c[4]=s,c[5]=n,c[6]=o,c[7]=a,c[8]=l,c}function pot(t,e){return new Float32Array(t,e,9)}Object.freeze(Object.defineProperty({__proto__:null,clone:E2e,create:Gl,createView:pot,fromValues:mD},Symbol.toStringTag,{value:"Module"}));function fot(t){t.vertex.uniforms.add(new wm("colorTextureTransformMatrix",e=>v(e.colorTextureTransformMatrix)?e.colorTextureTransformMatrix:Gl())),t.varyings.add("colorUV","vec2"),t.vertex.code.add(w`void forwardColorUV(){
colorUV = (colorTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)}function mot(t){t.vertex.uniforms.add(new wm("normalTextureTransformMatrix",e=>v(e.normalTextureTransformMatrix)?e.normalTextureTransformMatrix:Gl())),t.varyings.add("normalUV","vec2"),t.vertex.code.add(w`void forwardNormalUV(){
normalUV = (normalTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)}function got(t){t.vertex.uniforms.add(new wm("emissiveTextureTransformMatrix",e=>v(e.emissiveTextureTransformMatrix)?e.emissiveTextureTransformMatrix:Gl())),t.varyings.add("emissiveUV","vec2"),t.vertex.code.add(w`void forwardEmissiveUV(){
emissiveUV = (emissiveTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)}function yot(t){t.vertex.uniforms.add(new wm("occlusionTextureTransformMatrix",e=>v(e.occlusionTextureTransformMatrix)?e.occlusionTextureTransformMatrix:Gl())),t.varyings.add("occlusionUV","vec2"),t.vertex.code.add(w`void forwardOcclusionUV(){
occlusionUV = (occlusionTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)}function _ot(t){t.vertex.uniforms.add(new wm("metallicRoughnessTextureTransformMatrix",e=>v(e.metallicRoughnessTextureTransformMatrix)?e.metallicRoughnessTextureTransformMatrix:Gl())),t.varyings.add("metallicRoughnessUV","vec2"),t.vertex.code.add(w`void forwardMetallicRoughnessUV(){
metallicRoughnessUV = (metallicRoughnessTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)}function MO(t){t.include(bm),t.code.add(w`
    vec3 mixExternalColor(vec3 internalColor, vec3 textureColor, vec3 externalColor, int mode) {
      // workaround for artifacts in OSX using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      vec3 internalMixed = internalColor * textureColor;
      vec3 allMixed = internalMixed * externalColor;

      if (mode == ${w.int(_n.Multiply)}) {
        return allMixed;
      }
      if (mode == ${w.int(_n.Ignore)}) {
        return internalMixed;
      }
      if (mode == ${w.int(_n.Replace)}) {
        return externalColor;
      }

      // tint (or something invalid)
      float vIn = rgb2v(internalMixed);
      vec3 hsvTint = rgb2hsv(externalColor);
      vec3 hsvOut = vec3(hsvTint.x, hsvTint.y, vIn * hsvTint.z);
      return hsv2rgb(hsvOut);
    }

    float mixExternalOpacity(float internalOpacity, float textureOpacity, float externalOpacity, int mode) {
      // workaround for artifacts in OSX using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      float internalMixed = internalOpacity * textureOpacity;
      float allMixed = internalMixed * externalOpacity;

      if (mode == ${w.int(_n.Ignore)}) {
        return internalMixed;
      }
      if (mode == ${w.int(_n.Replace)}) {
        return externalOpacity;
      }

      // multiply or tint (or something invalid)
      return allMixed;
    }
  `)}function vot(t){const e=new Dr,{vertex:r,fragment:i,varyings:s}=e;return $c(r,t),e.include(CM),s.add("vpos","vec3"),e.include(uS,t),e.include(_2e,t),e.include(qwe,t),t.hasColorTextureTransform&&e.include(fot),t.output!==k.Color&&t.output!==k.Alpha||(t.hasNormalTextureTransform&&e.include(mot),t.hasEmissionTextureTransform&&e.include(got),t.hasOcclusionTextureTransform&&e.include(yot),t.hasMetallicRoughnessTextureTransform&&e.include(_ot),bp(r,t),e.include(UM,t),e.include(Bl,t),t.normalType===si.Attribute&&t.offsetBackfaces&&e.include(y2e),e.include(S2e,t),e.include(J5,t),t.instancedColor&&e.attributes.add(A.INSTANCECOLOR,"vec4"),s.add("localvpos","vec3"),e.include(Zf,t),e.include(VE,t),e.include(w2e,t),e.include(sx,t),r.uniforms.add(new pr("externalColor",n=>n.externalColor)),s.add("vcolorExt","vec4"),t.hasMultipassTerrain&&s.add("depth","float"),t.hasModelTransformation&&r.uniforms.add(new Hi("model",n=>v(n.modelTransformation)?n.modelTransformation:Lu)),r.code.add(w`
      void main(void) {
        forwardNormalizedVertexColor();
        vcolorExt = externalColor;
        ${t.instancedColor?"vcolorExt *= instanceColor;":""}
        vcolorExt *= vvColor();
        vcolorExt *= getSymbolColor();
        forwardColorMixMode();

        if (vcolorExt.a < ${w.float(Yo)}) {
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        } else {
          vpos = calculateVPos();
          localvpos = vpos - view[3].xyz;
          vpos = subtractOrigin(vpos);
          ${t.normalType===si.Attribute?w`vNormalWorld = dpNormal(vvLocalNormal(normalModel()));`:""}
          vpos = addVerticalOffset(vpos, localOrigin);
          ${t.hasVertexTangents?"vTangent = dpTransformVertexTangent(tangent);":""}
          gl_Position = transformPosition(proj, view, ${t.hasModelTransformation?"model,":""} vpos);
          ${t.normalType===si.Attribute&&t.offsetBackfaces?"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, cameraPosition);":""}
        }

        ${t.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":""}
        forwardLinearDepth();
        forwardTextureCoordinates();
        ${t.hasColorTextureTransform?w`forwardColorUV();`:""}
        ${t.hasNormalTextureTransform?w`forwardNormalUV();`:""}
        ${t.hasEmissionTextureTransform?w`forwardEmissiveUV();`:""}
        ${t.hasOcclusionTextureTransform?w`forwardOcclusionUV();`:""}
        ${t.hasMetallicRoughnessTextureTransform?w`forwardMetallicRoughnessUV();`:""}
      }
    `)),t.output===k.Alpha&&(e.include(Xs,t),e.include(tw,t),e.include(Fu,t),i.uniforms.add([new Pe("opacity",n=>n.opacity),new Pe("layerOpacity",n=>n.layerOpacity)]),t.hasColorTexture&&i.uniforms.add(new Mt("tex",n=>n.texture)),i.include(MO),i.code.add(w`
      void main() {
        discardBySlice(vpos);
        ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
        ${t.hasColorTexture?w`
                vec4 texColor = texture2D(tex, ${t.hasColorTextureTransform?w`colorUV`:w`vuv0`});
                ${t.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
                discardOrAdjustAlpha(texColor);`:w`vec4 texColor = vec4(1.0);`}
        ${t.hasVertexColors?w`float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:w`float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));`}
        gl_FragColor = vec4(opacity_);
      }
    `)),t.output===k.Color&&(e.include(Xs,t),e.include(Uw,t),e.include(VM,t),e.include(tw,t),e.include(t.instancedDoublePrecision?K5:Fw,t),e.include(Fu,t),bp(i,t),i.uniforms.add([r.uniforms.get("localOrigin"),new qt("ambient",n=>n.ambient),new qt("diffuse",n=>n.diffuse),new Pe("opacity",n=>n.opacity),new Pe("layerOpacity",n=>n.layerOpacity)]),t.hasColorTexture&&i.uniforms.add(new Mt("tex",n=>n.texture)),e.include(lY,t),e.include(VZ,t),i.include(MO),e.include(g2e,t),BM(i),YE(i),vm(i),i.code.add(w`
      void main() {
        discardBySlice(vpos);
        ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
        ${t.hasColorTexture?w`
                vec4 texColor = texture2D(tex, ${t.hasColorTextureTransform?w`colorUV`:w`vuv0`});
                ${t.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
                discardOrAdjustAlpha(texColor);`:w`vec4 texColor = vec4(1.0);`}
        shadingParams.viewDirection = normalize(vpos - cameraPosition);
        ${t.normalType===si.ScreenDerivative?w`
                vec3 normal = screenDerivativeNormal(localvpos);`:w`
                shadingParams.normalView = vNormalWorld;
                vec3 normal = shadingNormal(shadingParams);`}
        ${t.pbrMode===dt.Normal?"applyPBRFactors();":""}
        float ssao = evaluateAmbientOcclusionInverse();
        ssao *= getBakedOcclusion();

        vec3 posWorld = vpos + localOrigin;

        float additionalAmbientScale = additionalDirectedAmbientLight(posWorld);
        float shadow = ${t.receiveShadows?"readShadowMap(vpos, linearDepth)":t.spherical?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

        vec3 matColor = max(ambient, diffuse);
        ${t.hasVertexColors?w`
                vec3 albedo = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
                float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:w`
                vec3 albedo = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
                float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));`}
        ${t.hasNormalTexture?w`
                mat3 tangentSpace = ${t.hasVertexTangents?"computeTangentSpace(normal);":"computeTangentSpace(normal, vpos, vuv0);"}
                vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);`:w`vec3 shadingNormal = normal;`}
        vec3 normalGround = ${t.spherical?w`normalize(posWorld);`:w`vec3(0.0, 0.0, 1.0);`}

        ${t.snowCover?w`
                float snow = smoothstep(0.5, 0.55, dot(normal, normalGround));
                albedo = mix(albedo, vec3(1), snow);
                shadingNormal = mix(shadingNormal, normal, snow);
                ssao = mix(ssao, 1.0, snow);`:""}

        vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

        ${t.pbrMode===dt.Normal||t.pbrMode===dt.Schematic?w`
                float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * mainLightIntensity[2];
                ${t.snowCover?w`
                        mrr = mix(mrr, vec3(0.0, 1.0, 0.04), snow);
                        emission = mix(emission, vec3(0.0), snow);`:""}

                vec3 shadedColor = evaluateSceneLightingPBR(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight, shadingParams.viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:w`vec3 shadedColor = evaluateSceneLighting(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight);`}
        gl_FragColor = highlightSlice(vec4(shadedColor, opacity_), vpos);
        ${t.transparencyPassType===xt.Color?w`gl_FragColor = premultiplyAlpha(gl_FragColor);`:""}
      }
    `)),e.include(T2e,t),e}const bot=Object.freeze(Object.defineProperty({__proto__:null,build:vot},Symbol.toStringTag,{value:"Module"}));let wot=class extends WTe{constructor(){super(...arguments),this.isSchematic=!1,this.usePBR=!1,this.mrrFactors=$e(0,1,.5),this.hasVertexColors=!1,this.hasSymbolColors=!1,this.doubleSided=!1,this.doubleSidedType="normal",this.cullFace=Ti.Back,this.emissiveFactor=$e(0,0,0),this.instancedDoublePrecision=!1,this.normalType=si.Attribute,this.receiveSSAO=!0,this.receiveShadows=!0,this.castShadows=!0,this.shadowMappingEnabled=!1,this.ambient=$e(.2,.2,.2),this.diffuse=$e(.8,.8,.8),this.externalColor=Ht(1,1,1,1),this.colorMixMode="multiply",this.opacity=1,this.layerOpacity=1,this.origin=M(),this.hasSlicePlane=!1,this.hasSliceHighlight=!0,this.offsetTransparentBackfaces=!1,this.vvSizeEnabled=!1,this.vvSizeMinSize=[1,1,1],this.vvSizeMaxSize=[100,100,100],this.vvSizeOffset=[0,0,0],this.vvSizeFactor=[1,1,1],this.vvSizeValue=[1,1,1],this.vvColorEnabled=!1,this.vvColorValues=[0,0,0,0,0,0,0,0],this.vvColorColors=[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],this.vvSymbolAnchor=[0,0,0],this.vvSymbolRotationMatrix=es(),this.vvOpacityEnabled=!1,this.vvOpacityValues=[],this.vvOpacityOpacities=[],this.transparent=!1,this.writeDepth=!0,this.customDepthTest=Aw.Less,this.textureAlphaMode=ui.Blend,this.textureAlphaCutoff=CF,this.textureAlphaPremultiplied=!1,this.hasOccludees=!1,this.renderOccluded=ns.Occlude}},xot=class extends XTe{constructor(){super(...arguments),this.origin=M(),this.slicePlaneLocalOrigin=this.origin}},XZ=class C2e extends Vr{initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===vt.WEBGL2,r.spherical=e.viewingMode===Be.Global,r.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result,r.textureCoordinateType=r.hasColorTexture||r.hasMetallicRoughnessTexture||r.hasEmissionTexture||r.hasOcclusionTexture||r.hasNormalTexture?qs.Default:qs.None,r.objectAndLayerIdColorInstanced=r.instanced}initializeProgram(e){return this._initializeProgram(e,C2e.shader)}_initializeProgram(e,r){return new Fr(e.rctx,r.get().build(this.configuration),Rr)}_convertDepthTestFunction(e){return e===Aw.Lequal?Mi.LEQUAL:Mi.LESS}_makePipeline(e,r){const i=this.configuration,s=e===xt.NONE,n=e===xt.FrontFace;return Bt({blending:i.output!==k.Color&&i.output!==k.Alpha||!i.transparent?null:s?Iu:wy(e),culling:Tot(i)?y5(i.cullFace):null,depthTest:{func:xv(e,this._convertDepthTestFunction(i.customDepthTest))},depthWrite:(s||n)&&i.writeDepth?Xl:null,colorWrite:Kt,stencilWrite:i.hasOccludees?dm:null,stencilTest:i.hasOccludees?r?hv:Tv:null,polygonOffset:s||n?null:q5(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._makePipeline(this.configuration.transparencyPassType,!0),this._makePipeline(this.configuration.transparencyPassType,!1)}getPipelineState(e,r){return r?this._occludeePipelineState:super.getPipelineState(e,r)}};function Tot(t){return t.cullFace!==Ti.None||!t.hasSlicePlane&&!t.transparent&&!t.doubleSidedMode}XZ.shader=new Nr(bot,()=>te(()=>import("./DefaultMaterial.glsl-1278dddb.js"),[]));let Yt=class extends eo{constructor(){super(...arguments),this.output=k.Color,this.alphaDiscardMode=ui.Opaque,this.doubleSidedMode=cs.None,this.pbrMode=dt.Disabled,this.cullFace=Ti.None,this.transparencyPassType=xt.NONE,this.normalType=si.Attribute,this.textureCoordinateType=qs.None,this.customDepthTest=Aw.Less,this.spherical=!1,this.hasVertexColors=!1,this.hasSymbolColors=!1,this.hasVerticalOffset=!1,this.hasSlicePlane=!1,this.hasSliceHighlight=!0,this.hasColorTexture=!1,this.hasMetallicRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasScreenSizePerspective=!1,this.hasVertexTangents=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.hasModelTransformation=!1,this.offsetBackfaces=!1,this.vvSize=!1,this.vvColor=!1,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.textureAlphaPremultiplied=!1,this.instanced=!1,this.instancedColor=!1,this.objectAndLayerIdColorInstanced=!1,this.instancedDoublePrecision=!1,this.doublePrecisionRequiresObfuscation=!1,this.writeDepth=!0,this.transparent=!1,this.enableOffset=!0,this.cullAboveGround=!1,this.snowCover=!1,this.hasColorTextureTransform=!1,this.hasEmissionTextureTransform=!1,this.hasNormalTextureTransform=!1,this.hasOcclusionTextureTransform=!1,this.hasMetallicRoughnessTextureTransform=!1}};u([V({count:k.COUNT})],Yt.prototype,"output",void 0),u([V({count:ui.COUNT})],Yt.prototype,"alphaDiscardMode",void 0),u([V({count:cs.COUNT})],Yt.prototype,"doubleSidedMode",void 0),u([V({count:dt.COUNT})],Yt.prototype,"pbrMode",void 0),u([V({count:Ti.COUNT})],Yt.prototype,"cullFace",void 0),u([V({count:xt.COUNT})],Yt.prototype,"transparencyPassType",void 0),u([V({count:si.COUNT})],Yt.prototype,"normalType",void 0),u([V({count:qs.COUNT})],Yt.prototype,"textureCoordinateType",void 0),u([V({count:Aw.COUNT})],Yt.prototype,"customDepthTest",void 0),u([V()],Yt.prototype,"spherical",void 0),u([V()],Yt.prototype,"hasVertexColors",void 0),u([V()],Yt.prototype,"hasSymbolColors",void 0),u([V()],Yt.prototype,"hasVerticalOffset",void 0),u([V()],Yt.prototype,"hasSlicePlane",void 0),u([V()],Yt.prototype,"hasSliceHighlight",void 0),u([V()],Yt.prototype,"hasColorTexture",void 0),u([V()],Yt.prototype,"hasMetallicRoughnessTexture",void 0),u([V()],Yt.prototype,"hasEmissionTexture",void 0),u([V()],Yt.prototype,"hasOcclusionTexture",void 0),u([V()],Yt.prototype,"hasNormalTexture",void 0),u([V()],Yt.prototype,"hasScreenSizePerspective",void 0),u([V()],Yt.prototype,"hasVertexTangents",void 0),u([V()],Yt.prototype,"hasOccludees",void 0),u([V()],Yt.prototype,"hasMultipassTerrain",void 0),u([V()],Yt.prototype,"hasModelTransformation",void 0),u([V()],Yt.prototype,"offsetBackfaces",void 0),u([V()],Yt.prototype,"vvSize",void 0),u([V()],Yt.prototype,"vvColor",void 0),u([V()],Yt.prototype,"receiveShadows",void 0),u([V()],Yt.prototype,"receiveAmbientOcclusion",void 0),u([V()],Yt.prototype,"textureAlphaPremultiplied",void 0),u([V()],Yt.prototype,"instanced",void 0),u([V()],Yt.prototype,"instancedColor",void 0),u([V()],Yt.prototype,"objectAndLayerIdColorInstanced",void 0),u([V()],Yt.prototype,"instancedDoublePrecision",void 0),u([V()],Yt.prototype,"doublePrecisionRequiresObfuscation",void 0),u([V()],Yt.prototype,"writeDepth",void 0),u([V()],Yt.prototype,"transparent",void 0),u([V()],Yt.prototype,"enableOffset",void 0),u([V()],Yt.prototype,"cullAboveGround",void 0),u([V()],Yt.prototype,"snowCover",void 0),u([V()],Yt.prototype,"hasColorTextureTransform",void 0),u([V()],Yt.prototype,"hasEmissionTextureTransform",void 0),u([V()],Yt.prototype,"hasNormalTextureTransform",void 0),u([V()],Yt.prototype,"hasOcclusionTextureTransform",void 0),u([V()],Yt.prototype,"hasMetallicRoughnessTextureTransform",void 0),u([V({constValue:!0})],Yt.prototype,"hasVvInstancing",void 0),u([V({constValue:!1})],Yt.prototype,"useCustomDTRExponentForWater",void 0),u([V({constValue:!1})],Yt.prototype,"supportsTextureAtlas",void 0),u([V({constValue:!0})],Yt.prototype,"useFillLights",void 0);function Sot(t){const e=new Dr,{vertex:r,fragment:i,varyings:s}=e;return $c(r,t),e.include(CM),s.add("vpos","vec3"),e.include(uS,t),e.include(_2e,t),e.include(qwe,t),t.output!==k.Color&&t.output!==k.Alpha||(bp(e.vertex,t),e.include(UM,t),e.include(Bl,t),t.offsetBackfaces&&e.include(y2e),t.instancedColor&&e.attributes.add(A.INSTANCECOLOR,"vec4"),s.add("vNormalWorld","vec3"),s.add("localvpos","vec3"),t.hasMultipassTerrain&&s.add("depth","float"),e.include(Zf,t),e.include(VE,t),e.include(w2e,t),e.include(sx,t),r.uniforms.add(new pr("externalColor",n=>n.externalColor)),s.add("vcolorExt","vec4"),r.code.add(w`
        void main(void) {
          forwardNormalizedVertexColor();
          vcolorExt = externalColor;
          ${t.instancedColor?"vcolorExt *= instanceColor;":""}
          vcolorExt *= vvColor();
          vcolorExt *= getSymbolColor();
          forwardColorMixMode();

          if (vcolorExt.a < ${w.float(Yo)}) {
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          } else {
            vpos = calculateVPos();
            localvpos = vpos - view[3].xyz;
            vpos = subtractOrigin(vpos);
            vNormalWorld = dpNormal(vvLocalNormal(normalModel()));
            vpos = addVerticalOffset(vpos, localOrigin);
            gl_Position = transformPosition(proj, view, vpos);
            ${t.offsetBackfaces?"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, cameraPosition);":""}
          }
          ${t.hasMultipassTerrain?w`depth = (view * vec4(vpos, 1.0)).z;`:""}
          forwardLinearDepth();
          forwardTextureCoordinates();
        }
      `)),t.output===k.Alpha&&(e.include(Xs,t),e.include(tw,t),e.include(Fu,t),i.uniforms.add([new Pe("opacity",n=>n.opacity),new Pe("layerOpacity",n=>n.layerOpacity)]),t.hasColorTexture&&i.uniforms.add(new Mt("tex",n=>n.texture)),i.include(MO),i.code.add(w`
      void main() {
        discardBySlice(vpos);
        ${t.hasMultipassTerrain?w`terrainDepthTest(gl_FragCoord, depth);`:""}
        ${t.hasColorTexture?w`
                vec4 texColor = texture2D(tex, ${t.hasColorTextureTransform?w`colorUV`:w`vuv0`});
                ${t.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
                discardOrAdjustAlpha(texColor);`:w`vec4 texColor = vec4(1.0);`}
        ${t.hasVertexColors?w`float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:w`float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));`}

        gl_FragColor = vec4(opacity_);
      }
    `)),t.output===k.Color&&(e.include(Xs,t),e.include(Uw,t),e.include(VM,t),e.include(tw,t),e.include(t.instancedDoublePrecision?K5:Fw,t),e.include(Fu,t),bp(e.fragment,t),dy(i),BM(i),YE(i),i.uniforms.add([r.uniforms.get("localOrigin"),r.uniforms.get("view"),new qt("ambient",n=>n.ambient),new qt("diffuse",n=>n.diffuse),new Pe("opacity",n=>n.opacity),new Pe("layerOpacity",n=>n.layerOpacity)]),t.hasColorTexture&&i.uniforms.add(new Mt("tex",n=>n.texture)),e.include(lY,t),e.include(VZ,t),i.include(MO),e.extensions.add("GL_OES_standard_derivatives"),vm(i),i.code.add(w`
      void main() {
        discardBySlice(vpos);
        ${t.hasMultipassTerrain?w`terrainDepthTest(gl_FragCoord, depth);`:""}
        ${t.hasColorTexture?w`
                vec4 texColor = texture2D(tex, ${t.hasColorTextureTransform?w`colorUV`:w`vuv0`});
                ${t.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
                discardOrAdjustAlpha(texColor);`:w`vec4 texColor = vec4(1.0);`}
        vec3 viewDirection = normalize(vpos - cameraPosition);
        ${t.pbrMode===dt.Normal?"applyPBRFactors();":""}
        float ssao = evaluateAmbientOcclusionInverse();
        ssao *= getBakedOcclusion();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${t.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":t.spherical?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 matColor = max(ambient, diffuse);
        ${t.hasVertexColors?w`
                vec3 albedo = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
                float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:w`
                vec3 albedo = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
                float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));`}
        ${t.snowCover?w`albedo = mix(albedo, vec3(1), 0.9);`:w``}
        ${w`
            vec3 shadingNormal = normalize(vNormalWorld);
            albedo *= 1.2;
            vec3 viewForward = vec3(view[0][2], view[1][2], view[2][2]);
            float alignmentLightView = clamp(dot(viewForward, -mainLightDirection), 0.0, 1.0);
            float transmittance = 1.0 - clamp(dot(viewForward, shadingNormal), 0.0, 1.0);
            float treeRadialFalloff = vColor.r;
            float backLightFactor = 0.5 * treeRadialFalloff * alignmentLightView * transmittance * (1.0 - shadow);
            additionalLight += backLightFactor * mainLightIntensity;`}
        ${t.pbrMode===dt.Normal||t.pbrMode===dt.Schematic?t.spherical?w`vec3 normalGround = normalize(vpos + localOrigin);`:w`vec3 normalGround = vec3(0.0, 0.0, 1.0);`:w``}
        ${t.pbrMode===dt.Normal||t.pbrMode===dt.Schematic?w`
                float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * mainLightIntensity[2];
                ${t.snowCover?w`
                        mrr = vec3(0.0, 1.0, 0.04);
                        emission = vec3(0.0);`:""}

                vec3 shadedColor = evaluateSceneLightingPBR(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight, viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:w`vec3 shadedColor = evaluateSceneLighting(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight);`}
        gl_FragColor = highlightSlice(vec4(shadedColor, opacity_), vpos);
        ${t.transparencyPassType===xt.Color?w`gl_FragColor = premultiplyAlpha(gl_FragColor);`:w``}
      }
    `)),e.include(T2e,t),e}const Eot=Object.freeze(Object.defineProperty({__proto__:null,build:Sot},Symbol.toStringTag,{value:"Module"}));let A2e=class R2e extends XZ{initializeConfiguration(e,r){super.initializeConfiguration(e,r),r.hasMetallicRoughnessTexture=!1,r.hasEmissionTexture=!1,r.hasOcclusionTexture=!1,r.hasNormalTexture=!1,r.hasModelTransformation=!1,r.normalType=si.Attribute,r.doubleSidedMode=cs.WindingOrder,r.hasVertexTangents=!1}initializeProgram(e){return this._initializeProgram(e,R2e.shader)}};A2e.shader=new Nr(Eot,()=>te(()=>import("./RealisticTree.glsl-5831a571.js"),[]));let oy=class extends wv{constructor(e){super(e,Rot),this.supportsEdges=!0,this._configuration=new Yt,this._vertexBufferLayout=Oot(this.parameters)}isVisibleForOutput(e){return e!==k.Shadow&&e!==k.ShadowExcludeHighlight&&e!==k.ShadowHighlight||this.parameters.castShadows}isVisible(){const e=this.parameters;if(!super.isVisible()||e.layerOpacity===0)return!1;const{instanced:r,hasVertexColors:i,hasSymbolColors:s,vvColorEnabled:n}=e,o=v(r)&&r.includes("color"),a=e.colorMixMode==="replace",l=e.opacity>0,c=e.externalColor&&e.externalColor[3]>0;return i&&(o||n||s)?!!a||l:i?a?c:l:o||n||s?!!a||l:a?c:l}getConfiguration(e,r){return this._configuration.output=e,this._configuration.hasNormalTexture=!!this.parameters.normalTextureId,this._configuration.hasColorTexture=!!this.parameters.textureId,this._configuration.hasVertexTangents=this.parameters.hasVertexTangents,this._configuration.instanced=!!this.parameters.instanced,this._configuration.instancedDoublePrecision=this.parameters.instancedDoublePrecision,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.hasVerticalOffset=v(this.parameters.verticalOffset),this._configuration.hasScreenSizePerspective=v(this.parameters.screenSizePerspective),this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasSliceHighlight=this.parameters.hasSliceHighlight,this._configuration.alphaDiscardMode=this.parameters.textureAlphaMode,this._configuration.normalType=this.parameters.normalType,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,v(this.parameters.customDepthTest)&&(this._configuration.customDepthTest=this.parameters.customDepthTest),this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.cullFace=this.parameters.hasSlicePlane?Ti.None:this.parameters.cullFace,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration.hasModelTransformation=v(this.parameters.modelTransformation),e!==k.Color&&e!==k.Alpha||(this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSymbolColors=this.parameters.hasSymbolColors,this.parameters.treeRendering?this._configuration.doubleSidedMode=cs.WindingOrder:this._configuration.doubleSidedMode=this.parameters.doubleSided&&this.parameters.doubleSidedType==="normal"?cs.View:this.parameters.doubleSided&&this.parameters.doubleSidedType==="winding-order"?cs.WindingOrder:cs.None,this._configuration.instancedColor=v(this.parameters.instanced)&&this.parameters.instanced.includes("color"),this._configuration.receiveShadows=this.parameters.receiveShadows&&this.parameters.shadowMappingEnabled,this._configuration.receiveAmbientOcclusion=!!r.ssaoHelper.active&&this.parameters.receiveSSAO,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.textureAlphaPremultiplied=!!this.parameters.textureAlphaPremultiplied,this._configuration.pbrMode=this.parameters.usePBR?this.parameters.isSchematic?dt.Schematic:dt.Normal:dt.Disabled,this._configuration.hasMetallicRoughnessTexture=!!this.parameters.metallicRoughnessTextureId,this._configuration.hasEmissionTexture=!!this.parameters.emissiveTextureId,this._configuration.hasOcclusionTexture=!!this.parameters.occlusionTextureId,this._configuration.offsetBackfaces=!(!this.parameters.transparent||!this.parameters.offsetTransparentBackfaces),this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.enableOffset=r.camera.relativeElevation<j5,this._configuration.snowCover=this.hasSnowCover(r),this._configuration.hasColorTextureTransform=!!this.parameters.colorTextureTransformMatrix,this._configuration.hasNormalTextureTransform=!!this.parameters.normalTextureTransformMatrix,this._configuration.hasEmissionTextureTransform=!!this.parameters.emissiveTextureTransformMatrix,this._configuration.hasOcclusionTextureTransform=!!this.parameters.occlusionTextureTransformMatrix,this._configuration.hasMetallicRoughnessTextureTransform=!!this.parameters.metallicRoughnessTextureTransformMatrix),this._configuration}hasSnowCover(e){return v(e.weather)&&e.weatherVisible&&e.weather.type==="snowy"&&e.weather.snowCover==="enabled"}intersect(e,r,i,s,n,o){if(v(this.parameters.verticalOffset)){const a=i.camera;ce(x9,r[12],r[13],r[14]);let l=null;switch(i.viewingMode){case Be.Global:l=_e(eoe,x9);break;case Be.Local:l=le(eoe,Iot)}let c=0;const h=me($ot,x9,a.eye),p=Me(h),f=ae(h,h,1/p);let m=null;this.parameters.screenSizePerspective&&(m=ye(l,f)),c+=Qwe(a,p,this.parameters.verticalOffset,m??0,this.parameters.screenSizePerspective),ae(l,l,c),Ac(w9,l,i.transform.inverseRotation),s=me(Mot,s,w9),n=me(Pot,n,w9)}Ywe(e,i,s,n,vj(i.verticalOffset),o)}requiresSlot(e,r){return r===k.Color||r===k.Alpha||r===k.Depth||r===k.Normal||r===k.Shadow||r===k.ShadowHighlight||r===k.ShadowExcludeHighlight||r===k.Highlight||r===k.ObjectAndLayerIdColor?e===(this.parameters.transparent?this.parameters.writeDepth?Se.TRANSPARENT_MATERIAL:Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:Se.OPAQUE_MATERIAL)||e===Se.DRAPED_MATERIAL:!1}createGLMaterial(e){return new Cot(e)}createBufferWriter(){return new XE(this._vertexBufferLayout)}},Cot=class extends aY{constructor(e){super({...e,...e.material.parameters})}_updateShadowState(e){e.shadowMap.enabled!==this._material.parameters.shadowMappingEnabled&&this._material.setParameters({shadowMappingEnabled:e.shadowMap.enabled})}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output!==k.Color&&this._output!==k.Alpha||(this._updateShadowState(e),this._updateOccludeeState(e));const r=this._material.parameters;this.updateTexture(r.textureId);const i=e.camera.viewInverseTransposeMatrix;return ce(r.origin,i[3],i[7],i[11]),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(r.treeRendering?A2e:XZ,e)}},Aot=class extends wot{constructor(){super(...arguments),this.initTextureTransparent=!1,this.treeRendering=!1,this.hasVertexTangents=!1}};const Rot=new Aot;function Oot(t){const e=ts().vec3f(A.POSITION).vec3f(A.NORMAL),r=t.textureId||t.normalTextureId||t.metallicRoughnessTextureId||t.emissiveTextureId||t.occlusionTextureId;return t.hasVertexTangents&&e.vec4f(A.TANGENT),r&&e.vec2f(A.UV0),t.hasVertexColors&&e.vec4u8(A.COLOR),t.hasSymbolColors&&e.vec4u8(A.SYMBOLCOLOR),de("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(A.OBJECTANDLAYERIDCOLOR),e}const Mot=M(),Pot=M(),Iot=$e(0,0,1),eoe=M(),w9=M(),x9=M(),$ot=M(),Lot=["polygon","extent"];let Dot=class extends Tm{constructor(e,r,i,s){super(e,r,i,s),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const a=W5(this._getSymbolSize());if(a)throw new q("graphics3dextrudesymbollayer:invalid-size",a)}const e=Dn(this.symbolLayer,"material","color"),r=this._getCombinedOpacityAndColor(e),i=Nl(r),s=r[3],n=s<1||this.needsDrivenTransparentPass,o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:i,ambient:i,opacity:s,transparent:n,cullFace:n?Ti.None:Ti.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new oy(o),this._bottomMaterial=new oy({...o,cullFace:Ti.Back}),this._context.stage.add(this._material),this._context.stage.add(this._bottomMaterial)}destroy(){super.destroy(),this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry,Lot,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),s=this.setGraphicElevationContext(r,new Cp);return this._createAs3DShape(r,e.renderingInfo,i,s,r.uid)}layerOpacityChanged(e,r){const i=Dn(this.symbolLayer,"material","color"),s=this._getCombinedOpacity(i),n=s<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:s,transparent:n}),this._bottomMaterial.setParameters({opacity:s,transparent:n});const o=this._getLayerOpacity();e.forEach(a=>{const l=r(a);v(l)&&l.layerOpacityChanged(o,this._context.isAsync)})}layerElevationInfoChanged(e,r){return this.updateGraphics3DGraphicElevationInfo(e,r,lv)}slicePlaneEnabledChanged(e,r){return this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),e.forEach(i=>{const s=r(i);v(s)&&s.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}_getExtrusionSize(e){let r;return r=e.size&&this._drivenProperties.size?fst(e.size,2)??0:this._getSymbolSize(),r/=this._context.renderCoordsHelper.unitInMeters,r}applyRendererDiff(e,r){return this._drivenPropertiesChanged(r)?wn.Recreate_Symbol:wn.Recreate_Graphics}async queryForSnapping(e,r,i,s){const n=this._getExtrusionSize(i)*this._context.renderCoordsHelper.unitInMeters/uw(r),{objectId:o,target:a}=e,l=ne(a);switch(l.z=(l.z??0)+n,e.type){case"edge":{const{start:c,end:h}=e,p=ne(c),f=ne(h);return p.z=(p.z??0)+n,f.z=(f.z??0)+n,[wne(o,l,1/0,p,f)]}case"vertex":return[hst(o,l,1/0),wne(o,a,1/0,a,l)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(e,r,i,s,n){const o=AO(e.geometry);if(C(o))return null;if(o.rings.length===0||!o.rings.some(K=>K.length>0))return this._logGeometryValidationWarnings(o.rings,"rings","ExtrudeSymbol3DLayer"),null;const a=qZ(o,this._context.elevationProvider,this._context.renderCoordsHelper,s);this._logGeometryCreationWarnings(a,o.rings,"rings","ExtrudeSymbol3DLayer");const l=xZ(o);if(C(l))return null;const c=new Array,h=En(),p=Ie(),f=M(),m=this._context.renderCoordsHelper.viewingMode===Be.Global;m||this._context.renderCoordsHelper.worldUpAtPosition(null,f),gp(o.spatialReference,[l.x,l.y,0],p,this._context.renderCoordsHelper.spatialReference);const y=Ie();Oo(y,p);const _=es();QS(_,y);const{polygons:b,mapPositions:x,position:T}=a,S=T.length/3,E=new Float64Array(3*S*6),O=new Float64Array(3*S*6),R=new Float64Array(3*S*6),L=new Float64Array(1*S*6);let P=0;for(let K=0;K<b.length;++K){const ee=b[K],Q=ee.count;if(this._context.clippingExtent&&(Ri(h),Cu(h,ee.mapPositions),!Zd(h,this._context.clippingExtent)))continue;const H=cv(ee.mapPositions,ee.holeIndices,3);if(H.length===0)continue;const $=3*Q*2+H.length,N=new Array($),F=new Array(H.length),j=6*Q,X=3*E.BYTES_PER_ELEMENT,J=new wa(E.buffer,P*X,X,(P+j)*X),W=3*O.BYTES_PER_ELEMENT,ue=new wa(O.buffer,P*W,W,(P+j)*W),pe=new Float64Array(R.buffer,3*P*R.BYTES_PER_ELEMENT,3*j),we=new Float64Array(L.buffer,1*P*L.BYTES_PER_ELEMENT,1*j),Ce=this._getExtrusionSize(r);Not(T,x,H,ee,J.typedBuffer,pe,ue.typedBuffer,we,N,F,Ce,f,m),NM(J,J,y),uv(ue,ue,_),P+=6*Q;const Ge=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:n,layerUid:this._context.layer.uid}),Le=new Bot(J.typedBuffer,pe,ue.typedBuffer,we);c.push(toe(this._material,N,N.length-F.length,Le,i,Ge)),c.push(toe(this._bottomMaterial,F,0,Le,i,Ge))}if(c.length===0)return null;const U=new Ty({geometries:c,metadata:{layerUid:this._context.layer.uid,graphicUid:n,isElevationSource:!0}});U.transformation=p;const B=oTe(this.symbolLayer,{opacity:this._getLayerOpacity()}),z=v(B)?{baseMaterial:this._material,edgeMaterials:[B],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null,G=new xm(this,U,c,null,null,kot,s,z);return G.alignedSampledElevation=a.sampledElevation,G.needsElevationUpdates=lv(s.mode),G}};function toe(t,e,r,i,s,n){const o=new Array(e.length).fill(0),a=[[A.POSITION,new Xe(i.positions,3,!0)],[A.NORMAL,new Xe(i.normals,3,!0)],[A.COLOR,new Xe(s,4,!0)],[A.SIZE,new Xe(i.heights,1,!0)]],l=[[A.POSITION,e],[A.NORMAL,e],[A.COLOR,o]];return new nn(t,a,l,i.elevation,$s.Mesh,n,r)}function Not(t,e,r,i,s,n,o,a,l,c,h,p,f){const m=r.length/3;let y=0,_=2*i.count;Fot(t,e,i.index,i.count,r,0,m,s,n,o,a,l,c,_,h,p,f);let b=2*i.count;_=0,roe(s,n,a,o,y,i.pathLengths[0],i.count,b,l,_,h),b+=4*i.pathLengths[0],_+=2*i.pathLengths[0],y+=i.pathLengths[0];for(let x=1;x<i.pathLengths.length;++x)roe(s,n,a,o,y,i.pathLengths[x],i.count,b,l,_,h),b+=4*i.pathLengths[x],_+=2*i.pathLengths[x],y+=i.pathLengths[x]}function Fot(t,e,r,i,s,n,o,a,l,c,h,p,f,m,y,_,b){le(yl,_);const x=y>0?1:-1;let T=3*r,S=0,E=3*S,O=i,R=3*O;for(let U=0;U<i;++U)b&&(yl[0]=t[T+0],yl[1]=t[T+1],yl[2]=t[T+2],_e(yl,yl)),a[E+0]=t[T+0],a[E+1]=t[T+1],a[E+2]=t[T+2],l[E+0]=e[T+0],l[E+1]=e[T+1],l[E+2]=e[T+2],c[E+0]=-x*yl[0],c[E+1]=-x*yl[1],c[E+2]=-x*yl[2],h[S]=0,a[R+0]=t[T+0]+y*yl[0],a[R+1]=t[T+1]+y*yl[1],a[R+2]=t[T+2]+y*yl[2],l[R+0]=e[T+0],l[R+1]=e[T+1],l[R+2]=e[T+2],c[R+0]=x*yl[0],c[R+1]=x*yl[1],c[R+2]=x*yl[2],h[O]=y,E+=3,R+=3,T+=3,S+=1,O+=1;T=3*n,E=0,R=3*m;const L=y<0?loe:aoe,P=y<0?aoe:loe;for(let U=0;U<o;++U)f[E+0]=s[T+L[0]],f[E+1]=s[T+L[1]],f[E+2]=s[T+L[2]],p[R+0]=s[T+P[0]]+i,p[R+1]=s[T+P[1]]+i,p[R+2]=s[T+P[2]]+i,E+=3,R+=3,T+=3}function GI(t,e,r,i,s,n,o){i[n]=i[o],o*=3,t[(n*=3)+0]=t[o+0],t[n+1]=t[o+1],t[n+2]=t[o+2],e[n+0]=e[o+0],e[n+1]=e[o+1],e[n+2]=e[o+2],r[n+0]=s[0],r[n+1]=s[1],r[n+2]=s[2]}const FC=M();function roe(t,e,r,i,s,n,o,a,l,c,h){let p=s,f=s+1,m=s+o,y=s+o+1,_=a,b=a+1,x=a+2*n,T=a+2*n+1;h<0&&(p=s+o+1,y=s),c*=3;for(let S=0;S<n;++S)S===n-1&&(h>0?(f=s,y=s+o):(f=s,p=s+o)),Uot(t,p,f,m,FC),GI(t,e,i,r,FC,_,p),GI(t,e,i,r,FC,b,f),GI(t,e,i,r,FC,x,m),GI(t,e,i,r,FC,T,y),l[c++]=_,l[c++]=x,l[c++]=T,l[c++]=_,l[c++]=T,l[c++]=b,p++,f++,m++,y++,_+=2,b+=2,x+=2,T+=2}const T9=M(),ioe=M(),soe=M(),noe=M(),ooe=M();function Uot(t,e,r,i,s){e*=3,r*=3,i*=3,ce(T9,t[e++],t[e++],t[e++]),ce(ioe,t[r++],t[r++],t[r++]),ce(soe,t[i++],t[i++],t[i++]),me(noe,ioe,T9),me(ooe,soe,T9),pt(s,ooe,noe),_e(s,s)}const Ux=M();function kot(t,e,r,i,s){const n=t.stageObject,o=n.geometries,a=o.length,l=e.mode!=="absolute-height";let c=0;const h=n.transformation,p=CE(Ie(),h);for(let f=0;f<a;f+=2){const m=o[f];if(!SZ(m))continue;const y=m.getMutableAttribute(A.POSITION).data,_=m.vertexAttributes.get(A.SIZE).data,b=new cwe(m.mapPositions),x=y.length/3;let T=0,S=!1,E=0;for(let O=0;O<x;O++){Ux[0]=y[T],Ux[1]=y[T+1],Ux[2]=y[T+2],i(b,jI),l&&(E+=jI.sampledElevation),qr.TESTS_DISABLE_OPTIMIZATIONS?(ce(Kl,b.array[b.offset+0],b.array[b.offset+1],jI.z+_[T/3]),v(r)&&s.toRenderCoords(Kl,r,Kl),We(Kl,Kl,p)):(ce(Kl,y[T+0],y[T+1],y[T+2]),We(Kl,Kl,h),s.setAltitude(Kl,jI.z+_[T/3]),We(Kl,Kl,p)),y[T]=Kl[0],y[T+1]=Kl[1],y[T+2]=Kl[2];const R=Vot/s.unitInMeters;(Math.abs(Ux[0]-y[T])>=R||Math.abs(Ux[1]-y[T+1])>=R||Math.abs(Ux[2]-y[T+2])>=R)&&(S=!0),b.offset+=3,T+=3}S&&(m.invalidateBoundingInfo(),n.geometryVertexAttrsUpdated(o[f]),o[f+1].invalidateBoundingInfo(),n.geometryVertexAttrsUpdated(o[f+1])),c+=E/x}return c/a}const Kl=M(),yl=M(),jI=new DM,aoe=[0,2,1],loe=[0,1,2],Vot=.01;let Bot=class{constructor(e,r,i,s){this.positions=e,this.elevation=r,this.normals=i,this.heights=s}};function zot(t,e,r,i,s){if(C(t))return null;const n=t.referencesGeometry()&&s?Got(e,i,s):e,o=t.repurposeFeature(n);try{return t.evaluate({...r,$feature:o})}catch(a){return se.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",a),null}}const S9=new Map;function Got(t,e,r){const{transform:i,hasZ:s,hasM:n}=r;S9.has(e)||S9.set(e,jot(e));const o=S9.get(e)(t.geometry,i,s,n);return{...t,geometry:o}}function jot(t){const e={};switch(t){case"esriGeometryPoint":return(r,i,s,n)=>Dxe(i,e,r,s,n);case"esriGeometryPolygon":return(r,i,s,n)=>Nxe(i,e,r,s,n);case"esriGeometryPolyline":return(r,i,s,n)=>Fxe(i,e,r,s,n);case"esriGeometryMultipoint":return(r,i,s,n)=>Lxe(i,e,r,s,n);default:return se.getLogger("esri.views.2d.support.arcadeOnDemand").error(new q("mapview-arcade",`Unable to handle geometryType: ${t}`)),r=>r}}const sPt=1.2,Hot=qf;let e6=class{constructor(e,r,i,s){this.graphics3DSymbolLayer=e,this.renderGeometries=r,this.boundingBox=i,this._drapeSourceRenderer=s,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this.isElevationSource=!1}initialize(e){this.stage=e}setVisibility(e){if(this.stage!=null&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._drapeSourceRenderer.addGeometries(this.renderGeometries,ss.ADD);if(e||this._addedToStage){for(const r of this.renderGeometries)r.visible=this._visible;this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,Pn.VISIBILITY)}}}destroy(){this.stage&&this._addedToStage&&this._drapeSourceRenderer.removeGeometries(this.renderGeometries,ss.REMOVE),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(e=M()){return ce(e,0,0,0)}getBoundingBoxObjectSpace(e=En()){return Ri(e)}addObjectState(e,r){e===ry.Highlight&&(this.renderGeometries.forEach(i=>{const s=i.geometry.addHighlight();r.addRenderGeometry(i,s,this)}),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,Pn.HIGHLIGHT))}removeObjectState(e){this.renderGeometries.forEach(r=>{e.removeRenderGeometry(r)})}removeRenderGeometryObjectState(e,r){e.geometry.removeHighlight(r),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,Pn.HIGHLIGHT)}computeAttachmentOrigin(e){for(const r of this.renderGeometries)r.geometry.computeAttachmentOrigin(kx)&&(e.draped.origin[0]+=kx[0],e.draped.origin[1]+=kx[1],e.draped.num++)}async getProjectedBoundingBox(e,r,i,s,n){Ri(n);for(let o=0;o<this.renderGeometries.length;o++){const a=this.renderGeometries[o];this._getRenderGeometryProjectedBoundingRect(a,e,coe,i),w$e(n,coe)}if(r){let o;Yd(n,kx);const a=TZ(n,r.service.spatialReference,r);try{o=await r.service.queryElevation(kx[0],kx[1],s,a,"ground")}catch{}v(o)&&(n[2]=Math.min(n[2],o),n[5]=Math.max(n[5],o))}return n}_getRenderGeometryProjectedBoundingRect(e,r,i,s){if(this.boundingBox)T4(Fp,this.boundingBox);else{const n=e.boundingSphere,o=n[3];Fp[0]=n[0]-o,Fp[1]=n[1]-o,Fp[2]=n[2]-o,Fp[3]=n[0]+o,Fp[4]=n[1]+o,Fp[5]=n[2]+o}return r(Fp,0,2),this.calculateRelativeScreenBounds&&s.push({location:Yd(Fp),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),sW(Fp,i)}};const coe=ur(),Fp=En(),kx=M();let O2e=class{constructor(e,r,i,s=2048){this.text=e,this._alignment=r,this._parameters=i,this._maxSize=s,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key=`TextRenderer-${this._parameters.key}-${this._alignment}--${e}`,this._lines=e.split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._backgroundHorizontalPadding)}get displayHeight(){const e=this._lineSpacing*(this._lines.length-1),r=this._lineHeight;return Math.ceil(e+r+2*this._haloSize+this._backgroundTopPadding+this._backgroundBottomPadding)}get renderedWidth(){return Math.ceil(this._toRenderUnit(this.displayWidth))}get renderedHeight(){return Math.ceil(this._toRenderUnit(this.displayHeight))}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._baselinePosition)}get _firstLineYOffset(){return this._backgroundTopPadding+this._haloSize}get _metrics(){if(C(this._metricsCached)){const e=Wj(uoe,HI,HI).getContext("2d");this._setFontProperties(e,this._fontSize);let r=2*this._haloSize;const i=this._parameters.definition.font;i.style!=="italic"&&i.style!=="oblique"&&i.weight!=="bold"&&i.weight!=="bolder"||(r+=.3*e.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let s,n,o=0,a=0,l=0;this._lines.forEach((y,_)=>{const b=e.measureText(y),x=b.width,T=x+r;this._textWidths.push(x),this._lineWidths.push(T),o=Math.max(o,T),a=Math.max(a,b.actualBoundingBoxAscent),l=Math.max(l,b.actualBoundingBoxDescent),_===0&&(s=b),_===this._lines.length-1&&(n=b)});const c=e.font;let h=doe.get(c);if(!h){const y=e.measureText(Wot);h=new Yot(y.actualBoundingBoxAscent,y.actualBoundingBoxDescent),doe.set(c,h)}a=Math.max(a,h.actualBoundingBoxAscent),l=Math.max(l,h.actualBoundingBoxDescent);const p=a+l,f=this._hasBackground?s.actualBoundingBoxAscent:a,m=this._hasBackground?n.actualBoundingBoxDescent:l;this._metricsCached=new Xot(a-f,l-m,p,o,a)}return this._metricsCached}get _lineSpacing(){return(this._lineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _lineHeight(){return this._metrics.lineHeight}get _linePadding(){return this._lineHeight*qot}get _baselinePosition(){return this._metrics.baselinePosition}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _backgroundHorizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _backgroundVerticalPadding(){return this._hasBackground?this._parameters.definition.background.padding[1]:0}get _backgroundTopPadding(){return Math.max(0,this._backgroundVerticalPadding-this._metrics.paddingTop)}get _backgroundBottomPadding(){return Math.max(0,this._backgroundVerticalPadding-this._metrics.paddingBottom)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(C(this._renderPixelRatio)){const e=this._parameters.definition.pixelRatio;this._maxSize>0?this._renderPixelRatio=Math.min(e,Math.min(this._maxSize/this.displayWidth,this._maxSize/this.displayHeight)):this._renderPixelRatio=e}return this._renderPixelRatio}_getLineXOffset(e){switch(this._alignment){case z_.Left:return this._backgroundHorizontalPadding;case z_.Center:return(this.displayWidth-this._lineWidths[e])/2;case z_.Right:return this.displayWidth-this._backgroundHorizontalPadding-this._lineWidths[e]}}render(e,r=0,i=0){e.save();const s=r/=this.renderPixelRatio,n=i/=this.renderPixelRatio,o=this._haloSize,a=this._firstLineYOffset;r+=o,i+=a+this._baselinePosition;const l=this._haloSize>0;l&&this._renderHalo(e,s,n,o,a),this._setFontProperties(e,this._renderedFontSize);for(let c=0;c<this._lines.length;++c){const h=this._lines[c],p=this._getLineXOffset(c);l&&(e.globalCompositeOperation="destination-out",e.fillStyle="rgb(0, 0, 0)",this._fillText(e,h,r+p,i),this._renderLineDecoration(e,r+p,i,this._textWidths[c])),e.globalCompositeOperation="source-over",e.fillStyle=this._parameters.textStyle,this._fillText(e,h,r+this._getLineXOffset(c),i),this._renderLineDecoration(e,r+p,i,this._textWidths[c]),i+=this._lineSpacing}if(qr.TEXT_SHOW_BASELINE){e.strokeStyle=hoe,e.setLineDash([2,2]),e.lineWidth=1;let c=n+a;for(let h=0;h<this._lines.length;++h){const p=c+this._baselinePosition;this._drawLine(e,[s,p],[s+this.displayWidth,p]),c+=this._lineSpacing}}if(qr.TEXT_SHOW_BORDER&&(e.strokeStyle=hoe,e.setLineDash([]),e.lineWidth=1,this._drawBox(e,[s,n],[this.displayWidth,this.displayHeight])),this._hasBackground){const c=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(e,s,n,c),e.globalCompositeOperation="destination-over",e.fillStyle=this._parameters.backgroundStyle,e.fill()}e.restore()}_renderLineDecoration(e,r,i,s,n=!1){if(this._parameters.definition.font.decoration==="none"||s===0)return;const o=1,a=Math.max(this._parameters.definition.size/16,o);switch(this._parameters.definition.font.decoration){case"underline":i+=2*a;break;case"line-through":i-=.33*this._baselinePosition}const l=n?this._haloSize:0;e.strokeStyle=n?this._parameters.haloStyle:this._parameters.textStyle,e.lineWidth=this._toRenderUnit(a+2*l),e.beginPath(),e.moveTo(this._toRenderUnit(r-l),this._toRenderUnit(i)),e.lineTo(this._toRenderUnit(r+s+l),this._toRenderUnit(i)),e.stroke()}_roundedRect(e,r,i,s){r=this._toRenderUnit(r),i=this._toRenderUnit(i);const n=this.renderedWidth,o=this.renderedHeight;s!==0?(s=ge(s,0,Math.floor(o/2)),e.beginPath(),e.moveTo(r,i+s),e.arcTo(r,i,r+s,i,s),e.lineTo(r+n-s,i),e.arcTo(r+n,i,r+n,i+s,s),e.lineTo(r+n,i+o-s),e.arcTo(r+n,i+o,r+n-s,i+o,s),e.lineTo(r+s,i+o),e.arcTo(r,i+o,r,i+o-s,s),e.closePath()):e.rect(r,i,n,o)}_renderHalo(e,r,i,s,n){const o=this.renderedWidth,a=this.renderedHeight,l=Wj(uoe,Math.max(o,HI),Math.max(a,HI)),c=l.getContext("2d");c.clearRect(0,0,o,a),this._setFontProperties(c,this._renderedFontSize),c.fillStyle=this._parameters.haloStyle,c.strokeStyle=this._parameters.haloStyle;const h=this._renderedHaloSize<3;c.lineJoin=h?"miter":"round",h?this._renderHaloEmulated(c,s,n):this._renderHaloNative(c,s,n);let p=n+this._baselinePosition;for(let f=0;f<this._lines.length;++f){const m=this._getLineXOffset(f);this._renderLineDecoration(c,s+m,p,this._textWidths[f],!0),p+=this._lineSpacing}e.globalAlpha=this._parameters.definition.halo.color[3],e.drawImage(l,0,0,o,a,this._toRenderUnit(r),this._toRenderUnit(i),o,a),e.globalAlpha=1}_renderHaloEmulated(e,r,i){i+=this._baselinePosition;for(let s=0;s<this._lines.length;++s){const n=this._lines[s],o=this._getLineXOffset(s);for(const[a,l]of M2e)this._fillText(e,n,r+o+this._haloSize*a,i+this._haloSize*l);i+=this._lineSpacing}}_renderHaloNative(e,r,i){const s=2*this._haloSize;i+=this._baselinePosition;for(let n=0;n<this._lines.length;++n){const o=this._lines[n],a=this._getLineXOffset(n),l=5,c=.1;for(let h=0;h<l;h++){const p=1-(l-1)*c+h*c;e.lineWidth=this._toRenderUnit(p*s),this._strokeText(e,o,r+a,i)}i+=this._lineSpacing}}_setFontProperties(e,r){e.font=this._parameters.fontString(r),e.textAlign="left",e.textBaseline="alphabetic"}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(e){return e*this.renderPixelRatio}_toRoundedRenderUnit(e){return Math.round(e*this.renderPixelRatio)}_fillText(e,r,i,s){e.fillText(r,this._toRenderUnit(i),this._toRenderUnit(s))}_strokeText(e,r,i,s){e.strokeText(r,this._toRenderUnit(i),this._toRenderUnit(s))}_drawLine(e,r,i){e.beginPath(),e.moveTo(this._toRoundedRenderUnit(r[0])+.5,this._toRoundedRenderUnit(r[1])+.5),e.lineTo(this._toRoundedRenderUnit(i[0])+.5,this._toRoundedRenderUnit(i[1])+.5),e.stroke()}_drawBox(e,r,i){const s=this._toRenderUnit(r[0]),n=this._toRenderUnit(r[1]),o=this._toRenderUnit(i[0]),a=this._toRenderUnit(i[1]),l=Math.floor(s)+.5,c=Math.ceil(s+o)-.5,h=Math.floor(n)+.5,p=Math.ceil(n+a)-.5;e.beginPath(),e.moveTo(l,h),e.lineTo(c,h),e.lineTo(c,p),e.lineTo(l,p),e.lineTo(l,h),e.stroke()}};const M2e=[];for(let e=0;e<360;e+=360/16)M2e.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)]);var z_;function Wj(t,e,r){return t.canvas||(t.canvas=document.createElement("canvas")),t.canvas.width=e,t.canvas.height=r,t.canvas}(function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right"})(z_||(z_={}));const uoe={canvas:null},qot=.2,HI=512,hoe="rgb(255, 0, 255, 0.5)",Wot=(()=>{let t="";for(let e=32;e<127;e++)t+=String.fromCharCode(e);return t})();let Xot=class{constructor(e,r,i,s,n){this.paddingTop=e,this.paddingBottom=r,this.lineHeight=i,this.displayWidth=s,this.baselinePosition=n}},Yot=class{constructor(e,r){this.actualBoundingBoxAscent=e,this.actualBoundingBoxDescent=r}};const doe=new Map,Zot=Object.freeze({left:0,center:.5,right:1}),gD=Object.freeze({"bottom-left":Ur(0,0),bottom:Ur(.5,0),"bottom-right":Ur(1,0),left:Ur(0,.5),center:Ur(.5,.5),right:Ur(1,.5),"top-left":Ur(0,1),top:Ur(.5,1),"top-right":Ur(1,1)});function P2e(t){switch(t){case"left":return z_.Left;case"right":return z_.Right;default:return z_.Center}}function poe(t){switch(t){case"bottom-left":case"left":case"top-left":return"left";case"bottom":case"center":case"top":return"center";case"bottom-right":case"right":case"top-right":return"right"}}function Jot(t){switch(t){case"bottom-left":case"bottom":case"bottom-right":return"bottom";case"left":case"center":case"right":return"center";case"top-left":case"top":case"top-right":return"top"}}function Kot(t,e){switch(e){case"bottom":return t==="left"?"bottom-left":t==="right"?"bottom-right":"bottom";case"center":return t;case"top":return t==="left"?"top-left":t==="right"?"top-right":"top"}}function Qot(t){return t==="middle"?"center":t}var ca,foe;function UC(t){return t!=null}function Vx(t){return typeof t=="number"}function t6(t){return typeof t=="string"}function eat(t){return t==null||t6(t)}function vn(t,e){t&&t.push(e)}function tat(t,e,r,i=Ie()){const s=t||0,n=e||0,o=r||0;return s!==0&&DS(i,i,-s/180*Math.PI),n!==0&&LS(i,i,n/180*Math.PI),o!==0&&I4(i,i,o/180*Math.PI),i}function Zy(t,e,r,i,s){const n=t.minSize,o=t.maxSize;if(t.expression)return vn(s,"Could not convert size info: expression not supported"),!1;if(t.useSymbolValue){const a=i.symbolSize[r];return e.minSize[r]=a,e.maxSize[r]=a,e.offset[r]=e.minSize[r],e.factor[r]=0,e.type[r]=ca.DefinedSize,!0}if(UC(t.field))return UC(t.stops)?t.stops.length===2&&Vx(t.stops[0].size)&&Vx(t.stops[1].size)?(moe(t.stops[0].size,t.stops[1].size,t.stops[0].value,t.stops[1].value,e,r),e.type[r]=ca.DefinedSize,!0):(vn(s,"Could not convert size info: stops only supported with 2 elements"),!1):Vx(n)&&Vx(o)&&UC(t.minDataValue)&&UC(t.maxDataValue)?(moe(n,o,t.minDataValue,t.maxDataValue,e,r),e.type[r]=ca.DefinedSize,!0):GS[t.valueUnit]!=null?(e.minSize[r]=-1/0,e.maxSize[r]=1/0,e.offset[r]=0,e.factor[r]=1/GS[t.valueUnit],e.type[r]=ca.DefinedSize,!0):t.valueUnit==="unknown"?(vn(s,"Could not convert size info: proportional size not supported"),!1):(vn(s,"Could not convert size info: scale-dependent size not supported"),!1);if(!UC(t.field)){if(t.stops&&t.stops[0]&&Vx(t.stops[0].size))return e.minSize[r]=t.stops[0].size,e.maxSize[r]=t.stops[0].size,e.offset[r]=e.minSize[r],e.factor[r]=0,e.type[r]=ca.DefinedSize,!0;if(Vx(n))return e.minSize[r]=n,e.maxSize[r]=n,e.offset[r]=n,e.factor[r]=0,e.type[r]=ca.DefinedSize,!0}return vn(s,"Could not convert size info: unsupported variant of sizeInfo"),!1}function moe(t,e,r,i,s,n){const o=Math.abs(i-r)>0?(e-t)/(i-r):0;s.minSize[n]=o>0?t:e,s.maxSize[n]=o>0?e:t,s.offset[n]=t-r*o,s.factor[n]=o}function rat(t,e,r,i){if(t.normalizationField||t.valueRepresentation)return vn(i,"Could not convert size info: unsupported property"),null;if(!eat(t.field))return vn(i,"Could not convert size info: field is not a string"),null;if(e.size){if(t.field)if(e.size.field){if(t.field!==e.size.field)return vn(i,"Could not convert size info: multiple fields in use"),null}else e.size.field=t.field}else e.size={field:t.field,minSize:[0,0,0],maxSize:[0,0,0],offset:[0,0,0],factor:[0,0,0],type:[ca.Undefined,ca.Undefined,ca.Undefined]};let s;switch(t.axis){case"width":return s=Zy(t,e.size,0,r,i),s?e:null;case"height":return s=Zy(t,e.size,2,r,i),s?e:null;case"depth":return s=Zy(t,e.size,1,r,i),s?e:null;case"width-and-depth":return s=Zy(t,e.size,0,r,i),s&&Zy(t,e.size,1,r,i),s?e:null;case null:case void 0:case"all":return s=Zy(t,e.size,0,r,i),s=s&&Zy(t,e.size,1,r,i),s=s&&Zy(t,e.size,2,r,i),s?e:null;default:return vn(i,`Could not convert size info: unknown axis "${t.axis}""`),null}}function iat(t,e,r){for(let s=0;s<3;++s){let n=e.unitInMeters;t.type[s]===ca.DefinedSize&&(n*=e.modelSize[s],t.type[s]=ca.DefinedScale),t.minSize[s]=t.minSize[s]/n,t.maxSize[s]=t.maxSize[s]/n,t.offset[s]=t.offset[s]/n,t.factor[s]=t.factor[s]/n}let i;if(t.type[0]!==ca.Undefined)i=0;else if(t.type[1]!==ca.Undefined)i=1;else{if(t.type[2]===ca.Undefined)return vn(r,"No size axis contains a valid size or scale"),!1;i=2}for(let s=0;s<3;++s)t.type[s]===ca.Undefined&&(t.minSize[s]=t.minSize[i],t.maxSize[s]=t.maxSize[i],t.offset[s]=t.offset[i],t.factor[s]=t.factor[i],t.type[s]=t.type[i]);return!0}function goe(t,e,r){t[4*e+0]=r.r/255,t[4*e+1]=r.g/255,t[4*e+2]=r.b/255,t[4*e+3]=r.a}function sat(t,e,r){if(t.normalizationField)return vn(r,"Could not convert color info: unsupported property"),null;if(t6(t.field)){if(!t.stops)return vn(r,"Could not convert color info: missing stops or colors"),null;{if(t.stops.length>8)return vn(r,"Could not convert color info: too many color stops"),null;e.color={field:t.field,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};const i=t.stops;for(let s=0;s<8;++s){const n=i[Math.min(s,i.length-1)];e.color.values[s]=n.value,goe(e.color.colors,s,n.color)}}}else{if(!(t.stops&&t.stops.length>=0))return vn(r,"Could not convert color info: no field and no colors/stops"),null;{const i=t.stops&&t.stops.length>=0&&t.stops[0].color;e.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(let s=0;s<8;s++)e.color.values[s]=1/0,goe(e.color.colors,s,i)}}return e}function nat(t,e,r){if(t.normalizationField)return vn(r,"Could not convert opacity info: unsupported property"),null;if(t6(t.field)){if(!t.stops)return vn(r,"Could not convert opacity info: missing stops or opacities"),null;{if(t.stops.length>8)return vn(r,"Could not convert opacity info: too many opacity stops"),null;e.opacity={field:t.field,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};const i=t.stops;for(let s=0;s<8;++s){const n=i[Math.min(s,i.length-1)];e.opacity.values[s]=n.value,e.opacity.opacityValues[s]=n.opacity}}}else{if(!(t.stops&&t.stops.length>=0))return vn(r,"Could not convert opacity info: no field and no opacities/stops"),null;{const i=t.stops&&t.stops.length>=0?t.stops[0].opacity:0;e.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(let s=0;s<8;s++)e.opacity.values[s]=1/0,e.opacity.opacityValues[s]=i}}return e}function E9(t,e,r){const i=r===2&&t.rotationType==="arithmetic";e.offset[r]=i?90:0,e.factor[r]=i?-1:1,e.type[r]=1}function oat(t,e,r){if(!t6(t.field))return vn(r,"Could not convert rotation info: field is not a string"),null;if(e.rotation){if(t.field)if(e.rotation.field){if(t.field!==e.rotation.field)return vn(r,"Could not convert rotation info: multiple fields in use"),null}else e.rotation.field=t.field}else e.rotation={field:t.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(t.axis){case"tilt":return E9(t,e.rotation,0),e;case"roll":return E9(t,e.rotation,1),e;case null:case void 0:case"heading":return E9(t,e.rotation,2),e;default:return vn(r,`Could not convert rotation info: unknown axis "${t.axis}""`),null}}function I2e(t,e,r){if(!t)return null;const i=!e.supportedTypes||!!e.supportedTypes.size,s=!e.supportedTypes||!!e.supportedTypes.color,n=!e.supportedTypes||!!e.supportedTypes.rotation,o=!!e.supportedTypes&&!!e.supportedTypes.opacity,a=t.reduce((l,c)=>{if(!l)return l;if(c.valueExpression)return vn(r,"Could not convert visual variables: arcade expressions not supported"),null;switch(c.type){case"size":return i?rat(c,l,e,r):l;case"color":return s?sat(c,l,r):l;case"opacity":return o?nat(c,l,r):null;case"rotation":return n?oat(c,l,r):l;default:return null}},{size:null,color:null,opacity:null,rotation:null});return!(t.length>0&&a)||a.size||a.color||a.opacity||a.rotation?a&&a.size&&!iat(a.size,e,r)?null:a:null}function YZ(t){return t&&t.size!=null}function PO(t,e){if(!t)return{enabled:!1};if(qr.TESTS_DISABLE_FAST_UPDATES)return{enabled:!1};const r=I2e(t.visualVariables,e);return r?{enabled:!0,visualVariables:r,materialParameters:$2e(r,e),requiresShaderTransformation:YZ(r)}:{enabled:!1}}function IO(t,e,r){if(!e||!t.enabled)return!1;const i=t.visualVariables,s=I2e(e.visualVariables,r);return!!s&&!!(qI(i.size,s.size,"size")&&qI(i.color,s.color,"color")&&qI(i.rotation,s.rotation,"rotation")&&qI(i.opacity,s.opacity,"opacity"))&&(t.visualVariables=s,t.materialParameters=$2e(s,r),t.requiresShaderTransformation=YZ(s),!0)}function qI(t,e,r){if(!!t!=!!e||t&&t.field!==e.field)return!1;if(t&&r==="rotation"){const i=t,s=e;for(let n=0;n<3;n++)if(i.type[n]!==s.type[n]||i.offset[n]!==s.offset[n]||i.factor[n]!==s.factor[n])return!1}return!0}function $2e(t,e){const r={vvSizeEnabled:!1,vvSizeMinSize:null,vvSizeMaxSize:null,vvSizeOffset:null,vvSizeFactor:null,vvSizeValue:null,vvColorEnabled:!1,vvColorValues:null,vvColorColors:null,vvOpacityEnabled:!1,vvOpacityValues:null,vvOpacityOpacities:null,vvSymbolAnchor:null,vvSymbolRotationMatrix:null},i=YZ(t);return t&&t.size?(r.vvSizeEnabled=!0,r.vvSizeMinSize=t.size.minSize,r.vvSizeMaxSize=t.size.maxSize,r.vvSizeOffset=t.size.offset,r.vvSizeFactor=t.size.factor):t&&i&&(r.vvSizeValue=e.transformation.scale),t&&i&&(r.vvSymbolAnchor=e.transformation.anchor,r.vvSymbolRotationMatrix=es(),Gh(wR),tat(e.transformation.rotation[2],e.transformation.rotation[0],e.transformation.rotation[1],wR),Hh(r.vvSymbolRotationMatrix,wR)),t&&t.color&&(r.vvColorEnabled=!0,r.vvColorValues=t.color.values,r.vvColorColors=t.color.colors),t&&t.opacity&&(r.vvOpacityEnabled=!0,r.vvOpacityValues=t.opacity.values,r.vvOpacityOpacities=t.opacity.opacityValues),r}function Xj(t,e,r){if(!t.vvSizeEnabled)return r;Fn(Jy,r);const i=t.vvSymbolRotationMatrix;ym(wR,i[0],i[1],i[2],0,i[3],i[4],i[5],0,i[6],i[7],i[8],0,0,0,0,1),gs(Jy,Jy,wR);for(let s=0;s<3;++s){const n=t.vvSizeOffset[s]+e[0]*t.vvSizeFactor[s];yoe[s]=ge(n,t.vvSizeMinSize[s],t.vvSizeMaxSize[s])}return P4(Jy,Jy,yoe),ql(Jy,Jy,t.vvSymbolAnchor),Jy}function aat(t,e,r){if(!e.vvSizeEnabled)return ce(t,1,1,1);for(let i=0;i<3;++i){const s=e.vvSizeOffset[i]+r[0]*e.vvSizeFactor[i];t[i]=ge(s,e.vvSizeMinSize[i],e.vvSizeMaxSize[i])}return t}(function(t){t[t.Undefined=0]="Undefined",t[t.DefinedSize=1]="DefinedSize",t[t.DefinedScale=2]="DefinedScale"})(ca||(ca={})),function(t){t[t.Undefined=0]="Undefined",t[t.DefinedAngle=1]="DefinedAngle"}(foe||(foe={}));const Jy=Ie(),yoe=M(),wR=Ie();let uE=class{constructor(e,r={}){this.geometry=e,this.boundingSphere=sr(),this.screenToWorldRatio=1,this._transformation=Ie(),this._shaderTransformationDirty=!0,this.id=Pc(),this.layerUid=r.layerUid,this.graphicUid=r.graphicUid,this.boundingInfo=r.boundingInfo,this.shaderTransformer=r.shaderTransformer,this.castShadow=!!r.castShadow&&r.castShadow}get transformation(){return this._transformation}updateTransformation(e){e(this._transformation),this._shaderTransformationDirty=!0,this.computeBoundingSphere(this._transformation,this.boundingSphere)}shaderTransformationChanged(){this._shaderTransformationDirty=!0}computeBoundingSphere(e,r,i=bw(e)){C(this.boundingInfo)||(We(r,this.boundingInfo.center,e),r[3]=this.boundingInfo.radius*i)}get hasShaderTransformation(){return v(this.shaderTransformer)}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return C(this.shaderTransformer)?this.transformation:(this._shaderTransformationDirty&&(this._shaderTransformation||(this._shaderTransformation=Ie()),Fn(this._shaderTransformation,this.shaderTransformer(this.transformation)),this._shaderTransformationDirty=!1),this._shaderTransformation)}get indices(){return this.geometry.indices}get vertexAttributes(){return this.geometry.vertexAttributes}get highlights(){return this.geometry.highlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}};const lat=Ie(),_oe=$e(0,0,1),cat=16,uat=1.5,Bb=_Z,hat=[Bb/2,Bb/2,1-Bb/2,1-Bb/2],dat=[TO*Bb,TO*Bb];let Yj=class L2e extends Tm{getCachedSize(){return{size:this._getIconSize()}}constructor(e,r,i,s){super(e,r,i,s),this._cimLayers=null,this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._cimRequiredFields=null,this._cimScaleFactorOrFunction=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}async doLoad(e){this._validateOrThrow();const r=this._prepareMaterialParameters(),i=this._getPrimitive();if(v(i))this._prepareResourcesPrimitive(r,i);else{const s=CUe(this.symbolLayer),n=ZO(s);n&&n.mediaType==="application/json"?await this._prepareResourcesCIM(r,JSON.parse(n.data),e):await this._prepareResourcesHref(r,s,e)}}_validateOrThrow(){if(this._drivenProperties.size)return;const e=W5(this._getIconSize());if(e)throw new q("graphics3diconsymbollayer:invalid-size",e)}_getIconSize(){const e=this.symbolLayer,r=Math.round(e.size!=null?Ao(e.size):cat);return this._drivenProperties.size?Math.max(r,64):r}_generateTextureCIM(e){const r=this._getGraphicHash(e);let i=r===""?null:this._cimSymbolTextures.get(r);if(!i){const s={scaleFactor:this._cimScaleFactorOrFunction},n=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol3D(this._cimLayers,e,"esriGeometryPoint",s,void 0,void 0);this._cimMaterialParametersInfo.anchorPosition=this._getAnchorPos("relative",n.anchorPosition);const o={width:n.imageData.width,height:n.imageData.height,powerOfTwoResizeMode:U_.PAD};i=new ix(n.imageData,o),this._cimSymbolTextures.set(r,i),this._context.stage.add(i)}return i}_computeSize(e,r){const i=e.width/e.height;return i>1?[r,Math.round(r/i)]:[Math.round(r*i),r]}_prepareMaterialParameters(){const e={anchorPosition:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},r=this.symbol;if(pat(r)){const{screenLength:i,minWorldLength:s,maxWorldLength:n}=r.verticalOffset;e.verticalOffset={screenLength:Ao(i),minWorldLength:s||0,maxWorldLength:v(n)?n:1/0}}return this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),e.occlusionTest=!0,e.hasSlicePlane=this._context.slicePlaneEnabled,e}_prepareResourcesPrimitive(e,r){const i=this._getOutlineSize();if(C9(r)&&i===0)throw new Error("Nothing to render");if(this._outlineSize=i,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,v(this._context.sharedResources.textures)){const n=this._context.sharedResources.textures.fromData(`${r}-icon`,()=>dxe(r));this._texture=n.texture,this._releaseTexture=n,e.textureId=this._texture.id}e.textureIsSignedDistanceField=!0,e.distanceFieldBoundingBox=hat;const s=this._getIconSize();this._size=[s,s],this._symbolTextureRatio=1/Bb,this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesHref(e,r,i){this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1;const s=this._getIconSize(),n=s*this._context.graphicsCoreOwner.view.state.rasterPixelRatio;if(v(this._context.sharedResources.textures)){const o=await hp(this._context.sharedResources.textures.fromUrl(r,n,{signal:i}));if(o.ok===!1)throw xc(o.error),new q("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${r})`);this._releaseTexture=o.value;const a=o.value.texture,l=a.params;this._size=this._computeSize(l,s),e.textureId=a.id}this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesCIM(e,r,i){const s=new wE({data:r});if(!this._context.sharedResources.cimSymbolRasterizer){const h=(await te(()=>import("./CIMSymbolRasterizer-da3f1947.js"),["assets/CIMSymbolRasterizer-da3f1947.js","assets/cimAnalyzer-0375b3f7.js","assets/BidiEngine-836b7ef6.js","assets/TileClipper-ae6eca9e.js","assets/enums-c655c737.js","assets/number-b10bd8f5.js","assets/_commonjsHelpers-2f3e7994.js","assets/imageutils-405116e1.js","assets/rasterizingUtils-399b821b.js"])).CIMSymbolRasterizer;fr(i),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new h(this._context.renderCoordsHelper.spatialReference,!0))}const n=this._context.layer.fields?this._context.layer.fields.map(h=>h.toJSON()):null;let o,a;if(this._cimLayers=await this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(s,n,this._context.renderer&&this._context.renderer.type==="dictionary"?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:i}),this._context.renderer&&this._context.renderer.type==="dictionary"&&this._context.renderer.scaleExpression){const h=this._context.renderer;if(isNaN(h.scaleExpression)){const p=h.scaleExpression,f=await uIe(p,this._context.layer.spatialReference,n);a=(m,y,_)=>{const b=zot(f,m,{$view:_},"esriGeometryPoint",y);return b!==null?b:1}}else o=Number(h.scaleExpression)}this._cimScaleFactorOrFunction=o||a||1;const l=this._context.renderer?await this._context.renderer.getRequiredFields(this._context.layer.fieldsIndex):[];fr(i);const c=this._context.layer.fieldsIndex;this._cimRequiredFields=l.map(h=>c.get(h).name),this._cimMaterialParametersInfo=e,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1}_getPrimitive(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||B$e}_getOutlineSize(){let e=0;const r=this.symbolLayer;return v(r.outline)&&r.outline.size!=null?Math.max(Ao(r.outline.size),0):(e=C9(this._getPrimitive())?uat:0,Math.max(e,0))}_getOutlineColor(){const e=this._getLayerOpacity(),r=this.symbolLayer,i=Dn(r,"outline","color");if(v(i)){const s=Ze.toUnitRGB(i),n=i.a*e;return[s[0],s[1],s[2],n]}return[0,0,0,0]}_getFillColor(){if(C9(this._getPrimitive()))return Hot;const e=C(this._getPrimitive()),r=Dn(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(r,{hasIntrinsicColor:e})}_getAnchorPos(e,r){return e==="relative"?Ur((r.x||0)+.5,.5-(r.y||0)):e in gD?gD[e]:gD.center}_createMaterialAndAddToStage(e,r){if(this._cimLayers?this._fastUpdates={enabled:!1}:this._fastUpdates=PO(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&Object.assign(e,this._fastUpdates.materialParameters),this._cimLayers){let i=v(e.textureId)?this._cimSymbolMaterials.get(e.textureId):null;return i||(i=new aE(e),this._cimSymbolMaterials.set(It(e.textureId,0),i),r.add(i)),i}return this._material=new aE(e),r.add(this._material),this._material}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial(e=>{e.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,hasSlicePlane:!1,shaderPolygonOffset:0,isDraped:this.draped})}),this.layerOpacityChanged())}destroy(){super.destroy(),this._forEachMaterial(e=>this._context.stage.remove(e)),this._material=null,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach(e=>this._context.stage.remove(e)),this._cimSymbolTextures.clear(),this._releaseTexture=Bi(this._releaseTexture)}_getScaleFactor(e,r){if(this._drivenProperties.size&&e.size){for(let i=0;i<3;i++){const s=e.size[i];s&&s!=="symbol-value"&&s!=="proportional"&&(e.size[i]=Ao(s))}if(e.size[0]==="symbol-value")return 1;if(isFinite(+e.size[0]))return+e.size[0]/r;if(isFinite(+e.size[2]))return+e.size[2]/r}return 1}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry))return null;let i,s=[0,0];if(this._cimLayers){if(!this._cimLayers.length)return null;const p=this._generateTextureCIM(r),f={textureId:p.id,...this._cimMaterialParametersInfo};i=this._createMaterialAndAddToStage(f,this._context.stage),s=[p.params.width,p.params.height]}else s=this._size,i=this._material;const n=CO(r.geometry);if(C(n))return this.logger.warn(`unsupported geometry type for icon symbol: ${r.geometry.type}`),null;const o=e.renderingInfo,a=this._getVertexOpacityAndColor(o);let l=1;if(!this._fastUpdates.enabled||!this._fastUpdates.visualVariables.size){const p=s[0]>s[1]?s[0]:s[1];l=this._getScaleFactor(o,p)}l*=this._symbolTextureRatio;const c=Ur(s[0]*l,s[1]*l),h=this.setGraphicElevationContext(r,new Cp);return this.ensureDrapedStatus(h.mode==="on-the-ground")&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(r,n,i,a,c,e.layer.uid):this._createAs3DShape(r,n,i,a,c,h,r.uid)}layerOpacityChanged(){const e=this._getFillColor(),r=this._getOutlineColor();this._forEachMaterial(i=>{i.setParameters({color:e}),i.setParameters({outlineColor:r})})}layerElevationInfoChanged(e,r,i){const s=this._elevationContext.mode,n=LM(L2e.elevationModeChangeTypes,i,s);if(n!==ys.UPDATE)return n;const o=Xh(s)||s==="absolute-height";return this.updateGraphics3DGraphicElevationInfo(e,r,()=>o)}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial(e=>{e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!!this._getPrimitive()}skipHighSymbolLodsChanged(){return!0}applyRendererDiff(e,r){for(const i in e.diff){if(i!=="visualVariables"||!IO(this._fastUpdates,r,this._fastVisualVariableConvertOptions()))return wn.Recreate_Symbol;v(this._material)&&this._material.setParameters(this._fastUpdates.materialParameters)}return wn.Fast_Update}_defaultElevationInfoNoZ(){return fat}_createAs3DShape(e,r,i,s,n,o,a){const l=this.getFastUpdateAttrValues(e),c=l?_=>Xj(this._fastUpdates.materialParameters,l,_):void 0,h=this._context.layer.uid,p=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:a,layerUid:h}),f=fj(i,_oe,null,s,n,mat,null,l,p),m=MZ(this._context,r,f,o,a,c);if(C(m))return null;const y=new xm(this,m.object,[f],null,null,SO,o);return y.alignedSampledElevation=m.sampledElevation,y.needsElevationUpdates=Xh(o.mode)||o.mode==="absolute-height",y.getScreenSize=this._createScreenSizeGetter(n,c),y.calculateRelativeScreenBounds=_=>i.calculateRelativeScreenBounds(y.getScreenSize(),1,_),EO(y,r,this._context.elevationProvider),y}_createAsOverlay(e,r,i,s,n,o){i.renderPriority=this._renderPriority;const a=sr();Jo(r,a,this._context.overlaySR),a[2]=HZ;const l=this._context.clippingExtent;if(v(l)&&!iW(l,a))return null;const c=this.getFastUpdateAttrValues(e),h=c?_=>Xj(this._fastUpdates.materialParameters,c,_):void 0,p=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:e.uid,layerUid:this._context.layer.uid}),f=fj(i,_oe,a,s,n,null,null,c,p),m=new uE(f,{layerUid:o,graphicUid:e.uid,shaderTransformer:h});a[3]=0,Xd(m.boundingSphere,a);const y=new e6(this,[m],null,this._context.drapeSourceRenderer);return y.getScreenSize=this._createScreenSizeGetter(n,h),y.calculateRelativeScreenBounds=_=>i.calculateRelativeScreenBounds(y.getScreenSize(),1,_),y}_createScreenSizeGetter(e,r){const i=this._outlineSize+2;if(this._fastUpdates.enabled){const s=e[0]/this._symbolTextureRatio,n=e[1]/this._symbolTextureRatio;return(o=Je())=>{const a=r(lat);return o[0]=a[0]*s+i,o[1]=a[5]*n+i,o}}{const s=e[0]/this._symbolTextureRatio+i,n=e[1]/this._symbolTextureRatio+i;return(o=Je())=>(o[0]=s,o[1]=n,o)}}_fastVisualVariableConvertOptions(){const e=this._size[0]>this._size[1]?this._size[0]:this._size[1],r=$e(e,e,e),i=Vh(1),s=e*i;return{modelSize:r,symbolSize:$e(s,s,s),unitInMeters:i,transformation:{anchor:ma,scale:Nf,rotation:ma}}}_getGraphicHash(e){let r="";for(const i of this._cimRequiredFields)r+=i+e.attributes[i];return r}_forEachMaterial(e){v(this._material)&&e(this._material),this._cimSymbolMaterials.forEach(e)}test(){return{...super.test(),material:this._material}}};function pat(t){return t&&t.type==="point-3d"&&t.hasVisibleVerticalOffset()}function C9(t){return!C(t)&&(t==="cross"||t==="x")}Yj.PRIMITIVE_SIZE=dat,Yj.elevationModeChangeTypes={definedChanged:ys.UPDATE,staysOnTheGround:ys.NONE,onTheGroundChanged:ys.RECREATE};const fat={mode:"relative-to-ground",offset:0},mat=Ht(0,0,0,1);function Zj(t){switch(t){case"butt":return Nh.BUTT;case"square":return Nh.SQUARE;case"round":return Nh.ROUND;default:return null}}function gat(t){return t==="diamond"?"kite":t}function Jj(t,e,r=null){const i=[],s=[],n=e.mapPositions;yat(e,s,i);const o=s[0][1].data,a=i[0][1].length,l=new Array(a).fill(0);return _at(e,s,i,l),wat(e,s,i,l),vat(e,s,i,l),bat(e,s,i,l),xat(e,s,i,l),Tat(e,s,i,l),Sat(e,s,i,o),new nn(t,s,i,n,$s.Line,r)}function yat(t,e,r){const{attributeData:{position:i},removeDuplicateStartEnd:s}=t,n=Eat(i)&&s,o=i.length/3-(n?1:0),a=new Array(2*(o-1)),l=n?i.slice(0,i.length-3):i;let c=0;for(let h=0;h<o-1;h++)a[c++]=h,a[c++]=h+1;e.push([A.POSITION,new Xe(l,3,n)]),r.push([A.POSITION,a])}function _at(t,e,r,i){if(v(t.attributeData.colorFeature))return;const s=t.attributeData.color;e.push([A.COLOR,new Xe(It(s,Rh),4)]),r.push([A.COLOR,i])}function vat(t,e,r,i){if(!v(t.attributeData.normal))return;const s=t.attributeData.normal;e.push([A.NORMAL,new Xe(s,3)]),r.push([A.NORMAL,i])}function bat(t,e,r,i){const s=t.attributeData.colorFeature;C(s)||(e.push([A.COLORFEATUREATTRIBUTE,new Xe([s],1,!0)]),r.push([A.COLOR,i]))}function wat(t,e,r,i){if(v(t.attributeData.sizeFeature))return;const s=t.attributeData.size;e.push([A.SIZE,new Xe([It(s,1)],1,!0)]),r.push([A.SIZE,i])}function xat(t,e,r,i){const s=t.attributeData.sizeFeature;C(s)||(e.push([A.SIZEFEATUREATTRIBUTE,new Xe([s],1,!0)]),r.push([A.SIZEFEATUREATTRIBUTE,i]))}function Tat(t,e,r,i){const s=t.attributeData.opacityFeature;C(s)||(e.push([A.OPACITYFEATUREATTRIBUTE,new Xe([s],1,!0)]),r.push([A.OPACITYFEATUREATTRIBUTE,i]))}function Sat(t,e,r,i){if(C(t.overlayInfo)||t.overlayInfo.renderCoordsHelper.viewingMode!==Be.Global||!t.overlayInfo.spatialReference.isGeographic)return;const s=Fc(i.length),n=Jr(t.overlayInfo.spatialReference);for(let f=0;f<s.length;f+=3)vW(i,f,s,f,n);const o=i.length/3,a=Ws(o+1);let l=Cat,c=Aat,h=0,p=0;ce(l,s[p++],s[p++],s[p++]),a[0]=0;for(let f=1;f<o+1;++f)f===o&&(p=0),ce(c,s[p++],s[p++],s[p++]),h+=Dve(l,c),a[f]=h,[l,c]=[c,l];e.push([A.DISTANCETOSTART,new Xe(a,1,!0)]),r.push([A.DISTANCETOSTART,r[0][1]])}function Eat(t){const e=t.length;return t[0]===t[e-3]&&t[1]===t[e-2]&&t[2]===t[e-1]}const Cat=M(),Aat=M();function uPt(t,e){if(C(t)||t.length===0)return[];const r=[];return t.forEach(i=>{const s=i.length,n=Fc(3*s);i.forEach((a,l)=>{n[3*l+0]=a[0],n[3*l+1]=a[1],n[3*l+2]=a[2]});const o={attributeData:{position:n,normal:e},removeDuplicateStartEnd:!1};r.push(o)}),r}function Rat(t,e,r,i){const s=t.type==="polygon"?hm.CCW_IS_HOLE:hm.NONE,n=t.type==="polygon"?t.rings:t.paths,{position:o,outlines:a}=FM(n,!!t.hasZ,s),l=Fc(o.length),c=qxe(o,t.spatialReference,0,l,0,o,0,o.length/3,e,r,i),h=c!=null;return{lines:h?D2e(a,o,l):[],projectionSuccess:h,sampledElevation:c}}function Oat(t,e){const r=t.type==="polygon"?hm.CCW_IS_HOLE:hm.NONE,i=t.type==="polygon"?t.rings:t.paths,{position:s,outlines:n}=FM(i,!1,r),o=_s(s,t.spatialReference,0,s,e,0,s.length/3);for(let a=2;a<s.length;a+=3)s[a]=HZ;return{lines:o?D2e(n,s):[],projectionSuccess:o}}function D2e(t,e,r=null){const i=new Array;for(const{index:s,count:n}of t){if(n<=1)continue;const o=3*s,a=3*n;i.push({position:Lh(e,3*s,3*n),mapPositions:v(r)?Lh(r,o,a):void 0})}return i}function Mat(t){const e=new Dr,r=t.hasMultipassTerrain&&(t.output===k.Color||t.output===k.Alpha),i=t.space===Dh.World;t.hasTip&&i&&e.extensions.add("GL_OES_standard_derivatives"),e.include(ATe,t),e.include(LTe,t),t.output===k.Depth&&e.include(ny,t);const{vertex:s,fragment:n}=e;return n.include(kc),$c(s,t),e.attributes.add(A.POSITION,"vec3"),e.attributes.add(A.UV0,"vec2"),e.attributes.add(A.AUXPOS1,"vec3"),e.varyings.add("vColor","vec4"),e.varyings.add("vpos","vec3"),e.varyings.add("vUV","vec2"),e.varyings.add("vSize","float"),iv(e),r&&e.varyings.add("depth","float"),t.hasTip&&e.varyings.add("vLineWidth","float"),s.uniforms.add([new kr("nearFar",(o,a)=>a.camera.nearFar),new pr("viewport",(o,a)=>a.camera.fullViewport)]),s.code.add(w`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),s.code.add(w`void clip(vec4 pos, inout vec4 prev) {
float vnp = nearFar[0] * 0.99;
if (prev.z > -nearFar[0]) {
float interpolation = (-vnp - pos.z) / (prev.z - pos.z);
prev = mix(pos, prev, interpolation);
}
}`),i?(e.attributes.add(A.NORMAL,"vec3"),nE(s),s.constants.add("tiltThreshold","float",.7),s.code.add(w`vec3 perpendicular(vec3 v) {
vec3 n = (viewNormal * vec4(normal.xyz, 1.0)).xyz;
vec3 n2 = cross(v, n);
vec3 forward = vec3(0.0, 0.0, 1.0);
float tiltDot = dot(forward, n);
return abs(tiltDot) < tiltThreshold ? n : n2;
}`)):s.code.add(w`vec2 perpendicular(vec2 v) {
return vec2(v.y, -v.x);
}`),s.code.add(w`
      #define vecN ${i?"vec3":"vec2"}

      vecN normalizedSegment(vecN pos, vecN prev) {
        vecN segment = pos - prev;
        float segmentLen = length(segment);

        // normalize or zero if too short
        return (segmentLen > 0.001) ? segment / segmentLen : ${i?"vec3(0.0, 0.0, 0.0)":"vec2(0.0, 0.0)"};
      }

      vecN displace(vecN pos, vecN prev, float displacementLen) {
        vecN segment = normalizedSegment(pos, prev);

        vecN displacementDirU = perpendicular(segment);
        vecN displacementDirV = segment;

        ${t.anchor===Nw.Tip?"pos -= 0.5 * displacementLen * displacementDirV;":""}

        return pos + displacementLen * (uv0.x * displacementDirU + uv0.y * displacementDirV);
      }
    `),t.space===Dh.Screen&&(s.uniforms.add(new Hi("inverseProjectionMatrix",(o,a)=>a.camera.inverseProjectionMatrix)),s.code.add(w`vec3 inverseProject(vec4 posScreen) {
posScreen.xy = (posScreen.xy / viewport.zw) * posScreen.w;
return (inverseProjectionMatrix * posScreen).xyz;
}`),s.code.add(w`bool rayIntersectPlane(vec3 rayDir, vec3 planeOrigin, vec3 planeNormal, out vec3 intersection) {
float cos = dot(rayDir, planeNormal);
float t = dot(planeOrigin, planeNormal) / cos;
intersection = t * rayDir;
return abs(cos) > 0.001 && t > 0.0;
}`),s.uniforms.add(new Pe("perScreenPixelRatio",(o,a)=>a.camera.perScreenPixelRatio)),s.code.add(w`
      vec4 toFront(vec4 displacedPosScreen, vec3 posLeft, vec3 posRight, vec3 prev, float lineWidth) {
        // Project displaced position back to camera space
        vec3 displacedPos = inverseProject(displacedPosScreen);

        // Calculate the plane that we want the marker to lie in. Note that this will always be an approximation since ribbon lines are generally
        // not planar and we do not know the actual position of the displaced prev vertices (they are offset in screen space, too).
        vec3 planeNormal = normalize(cross(posLeft - posRight, posLeft - prev));
        vec3 planeOrigin = posLeft;

        ${t.hasCap?`
                if(prev.z > posLeft.z) {
                  vec2 diff = posLeft.xy - posRight.xy;
                  planeOrigin.xy += perpendicular(diff) / 2.0;
                }
              `:""};

        // Move the plane towards the camera by a margin dependent on the line width (approximated in world space). This tolerance corrects for the
        // non-planarity in most cases, but sharp joins can place the prev vertices at arbitrary positions so markers can still clip.
        float offset = lineWidth * perScreenPixelRatio;
        planeOrigin *= (1.0 - offset);

        // Intersect camera ray with the plane and make sure it is within clip space
        vec3 rayDir = normalize(displacedPos);
        vec3 intersection;
        if (rayIntersectPlane(rayDir, planeOrigin, planeNormal, intersection) && intersection.z < -nearFar[0] && intersection.z > -nearFar[1]) {
          return vec4(intersection.xyz, 1.0);
        }

        // Fallback: use depth of pos or prev, whichever is closer to the camera
        float minDepth = planeOrigin.z > prev.z ? length(planeOrigin) : length(prev);
        displacedPos *= minDepth / length(displacedPos);
        return vec4(displacedPos.xyz, 1.0);
      }
  `)),s.uniforms.add(new Pe("pixelRatio",(o,a)=>a.camera.pixelRatio)),b5(e),s.code.add(w`void main(void) {
if (uv0.y == 0.0) {
gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
}
else {
float lineWidth = getLineWidth();
float screenMarkerSize = getScreenMarkerSize();
vec4 pos  = view * vec4(position.xyz, 1.0);
vec4 prev = view * vec4(auxpos1.xyz, 1.0);
clip(pos, prev);`),i?(t.hideOnShortSegments&&s.code.add(w`if (areWorldMarkersHidden(pos, prev)) {
gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
return;
}`),s.code.add(w`pos.xyz = displace(pos.xyz, prev.xyz, getWorldMarkerSize(pos));
vec4 displacedPosScreen = projectAndScale(pos);`)):(s.code.add(w`vec4 posScreen = projectAndScale(pos);
vec4 prevScreen = projectAndScale(prev);
vec4 displacedPosScreen = posScreen;
displacedPosScreen.xy = displace(posScreen.xy, prevScreen.xy, screenMarkerSize);`),t.space===Dh.Screen&&s.code.add(w`vec2 displacementDirU = perpendicular(normalizedSegment(posScreen.xy, prevScreen.xy));
vec3 lineRight = inverseProject(posScreen + lineWidth * vec4(displacementDirU.xy, 0.0, 0.0));
vec3 lineLeft = pos.xyz + (pos.xyz - lineRight);
pos = toFront(displacedPosScreen, lineLeft, lineRight, prev.xyz, lineWidth);
displacedPosScreen = projectAndScale(pos);`)),s.code.add(w`
        ${r?"depth = pos.z;":""}
        linearDepth = calculateLinearDepth(nearFar,pos.z);

        // Convert back into NDC
        displacedPosScreen.xy = (displacedPosScreen.xy / viewport.zw) * displacedPosScreen.w;

        // Convert texture coordinate into [0,1]
        vUV = (uv0 + 1.0) / 2.0;

        ${i?"":"vUV *= displacedPosScreen.w;"}

        ${t.hasTip?"vLineWidth = lineWidth;":""}

        vSize = screenMarkerSize;
        vColor = getColor();

        // Use camera space for slicing
        vpos = pos.xyz;

        gl_Position = displacedPosScreen;
      }
    }
  `),r&&e.include(Fu,t),e.include(Xs,t),n.uniforms.add([new pr("intrinsicColor",o=>o.color),new Mt("tex",o=>o.texture)]),n.include(bm),e.constants.add("texelSize","float",1/RO),n.code.add(w`float markerAlpha(vec2 samplePos) {
samplePos += vec2(0.5, -0.5) * texelSize;
float sdf = rgba2float(texture2D(tex, samplePos)) - 0.5;
float distance = sdf * vSize;
distance -= 0.5;
return clamp(0.5 - distance, 0.0, 1.0);
}`),t.hasTip&&(e.constants.add("relativeMarkerSize","float",DZ/RO),e.constants.add("relativeTipLineWidth","float",Hst),n.code.add(w`
    float tipAlpha(vec2 samplePos) {
      // Convert coordinates s.t. they are in pixels and relative to the tip of an arrow marker
      samplePos -= vec2(0.5, 0.5 + 0.5 * relativeMarkerSize);
      samplePos *= vSize;

      float halfMarkerSize = 0.5 * relativeMarkerSize * vSize;
      float halfTipLineWidth = 0.5 * max(1.0, relativeTipLineWidth * vLineWidth);

      ${i?"halfTipLineWidth *= fwidth(samplePos.y);":""}

      float distance = max(abs(samplePos.x) - halfMarkerSize, abs(samplePos.y) - halfTipLineWidth);
      return clamp(0.5 - distance, 0.0, 1.0);
    }
  `)),e.constants.add("symbolAlphaCutoff","float",Yo),n.code.add(w`
  void main() {
    discardBySlice(vpos);
    ${r?"terrainDepthTest(gl_FragCoord, depth);":""}

    vec4 finalColor = intrinsicColor * vColor;

    ${i?"vec2 samplePos = vUV;":"vec2 samplePos = vUV * gl_FragCoord.w;"}

    ${t.hasTip?"finalColor.a *= max(markerAlpha(samplePos), tipAlpha(samplePos));":"finalColor.a *= markerAlpha(samplePos);"}

    ${t.output===k.ObjectAndLayerIdColor?w`finalColor.a = 1.0;`:""}

    if (finalColor.a < symbolAlphaCutoff) {
      discard;
    }

    ${t.output===k.Alpha?w`gl_FragColor = vec4(finalColor.a);`:""}
    ${t.output===k.Color?w`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${t.output===k.Color&&t.transparencyPassType===xt.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    ${t.output===k.Highlight?w`gl_FragColor = vec4(1.0);`:""}
    ${t.output===k.Depth?w`outputDepth(linearDepth);`:""}
  }
  `),e}const Pat=Object.freeze(Object.defineProperty({__proto__:null,build:Mat},Symbol.toStringTag,{value:"Module"})),N2e=new Map([[A.POSITION,0],[A.UV0,2],[A.AUXPOS1,3],[A.NORMAL,4],[A.COLOR,5],[A.COLORFEATUREATTRIBUTE,5],[A.SIZE,6],[A.SIZEFEATUREATTRIBUTE,6],[A.OPACITYFEATUREATTRIBUTE,7]]);let F2e=class U2e extends Vr{initializeProgram(e){return new Fr(e.rctx,U2e.shader.get().build(this.configuration),N2e)}_makePipelineState(e,r){const i=this.configuration,s=e===xt.NONE;return Bt({blending:i.output===k.Color||i.output===k.Alpha?s?Iu:wy(e):null,depthTest:{func:xv(e)},depthWrite:s?i.writeDepth?Xl:null:G5(e),colorWrite:Kt,stencilWrite:i.hasOccludees?dm:null,stencilTest:i.hasOccludees?r?hv:Tv:null,polygonOffset:{factor:0,units:-10}})}initializePipeline(){return this.configuration.occluder&&(this._occluderPipelineTransparent=Bt({blending:Iu,depthTest:IF,depthWrite:null,colorWrite:Kt,stencilWrite:null,stencilTest:FTe}),this._occluderPipelineOpaque=Bt({blending:Iu,depthTest:IF,depthWrite:null,colorWrite:Kt,stencilWrite:DTe,stencilTest:NTe}),this._occluderPipelineMaskWrite=Bt({blending:null,depthTest:NZ,depthWrite:null,colorWrite:null,stencilWrite:dm,stencilTest:hv})),this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e,r){return r?this._occludeePipelineState:this.configuration.occluder?e===Se.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:e===Se.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(e,r)}};F2e.shader=new Nr(Pat,()=>te(()=>import("./LineMarker.glsl-ffcac6fc.js"),[]));let Iat=class extends wv{constructor(e){super(e,new Lat),this._vertexAttributeLocations=N2e,this._configuration=new vo,this._layout=this.createLayout()}dispose(){}getConfiguration(e,r){return this._configuration.output=e,this._configuration.space=r.slot===Se.DRAPED_MATERIAL?Dh.Draped:this.parameters.worldSpace?Dh.World:Dh.Screen,this._configuration.hideOnShortSegments=this.parameters.hideOnShortSegments,this._configuration.hasCap=this.parameters.cap!==Nh.BUTT,this._configuration.anchor=this.parameters.anchor,this._configuration.hasTip=this.parameters.hasTip,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.vvOpacity=this.parameters.vvOpacityEnabled,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.occluder=this.parameters.renderOccluded===ns.OccludeAndTransparentStencil,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration}intersect(){}createLayout(){const e=ts().vec3f(A.POSITION).vec2f(A.UV0).vec3f(A.AUXPOS1);return this.parameters.worldSpace&&e.vec3f(A.NORMAL),this.parameters.vvSizeEnabled?e.f32(A.SIZEFEATUREATTRIBUTE):e.f32(A.SIZE),this.parameters.vvColorEnabled?e.f32(A.COLORFEATUREATTRIBUTE):e.vec4f(A.COLOR),this.parameters.vvOpacityEnabled&&e.f32(A.OPACITYFEATUREATTRIBUTE),e}createBufferWriter(){return new Dat(this._layout,this.parameters)}requiresSlot(e,r){return r===k.Color||r===k.Alpha||r===k.Highlight||r===k.Depth?e===Se.DRAPED_MATERIAL?!0:this.parameters.renderOccluded===ns.OccludeAndTransparentStencil?e===Se.OPAQUE_MATERIAL||e===Se.OCCLUDER_MATERIAL||e===Se.TRANSPARENT_OCCLUDER_MATERIAL:r===k.Color||r===k.Alpha?e===(this.parameters.writeDepth?Se.TRANSPARENT_MATERIAL:Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):e===Se.OPAQUE_MATERIAL:!1}createGLMaterial(e){return new $at(e)}},$at=class extends aY{_updateParameters(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(F2e,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==k.Color&&this._output!==k.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}},Lat=class extends vZ{constructor(){super(...arguments),this.width=0,this.color=[1,1,1,1],this.placement="end",this.cap=Nh.BUTT,this.anchor=Nw.Center,this.hasTip=!1,this.worldSpace=!1,this.hideOnShortSegments=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.hasOccludees=!1}},Dat=class{constructor(e,r){this.vertexBufferLayout=e,this._parameters=r}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(){return this._parameters.placement==="begin-end"?12:6}write(e,r,i,s,n){const o=i.vertexAttributes.get(A.POSITION).data,a=o.length/3;let l=[1,0,0];const c=i.vertexAttributes.get(A.NORMAL);this._parameters.worldSpace&&v(c)&&(l=c.data);let h=1,p=0;this._parameters.vvSizeEnabled?p=i.vertexAttributes.get(A.SIZEFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(A.SIZE)&&(h=i.vertexAttributes.get(A.SIZE).data[0]);let f=[1,1,1,1],m=0;this._parameters.vvColorEnabled?m=i.vertexAttributes.get(A.COLORFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(A.COLOR)&&(f=i.vertexAttributes.get(A.COLOR).data);let y=0;this._parameters.vvOpacityEnabled&&(y=i.vertexAttributes.get(A.OPACITYFEATUREATTRIBUTE).data[0]);const _=new Float32Array(s.buffer);let b=n*(this.vertexBufferLayout.stride/4);const x=(O,R,L,P)=>{if(_[b++]=O[0],_[b++]=O[1],_[b++]=O[2],_[b++]=L[0],_[b++]=L[1],_[b++]=R[0],_[b++]=R[1],_[b++]=R[2],this._parameters.worldSpace&&(_[b++]=l[0],_[b++]=l[1],_[b++]=l[2]),this._parameters.vvSizeEnabled?_[b++]=p:_[b++]=h,this._parameters.vvColorEnabled)_[b++]=m;else{const U=Math.min(4*P,f.length-4);_[b++]=f[U+0],_[b++]=f[U+1],_[b++]=f[U+2],_[b++]=f[U+3]}this._parameters.vvOpacityEnabled&&(_[b++]=y)};let T;(function(O){O[O.ASCENDING=1]="ASCENDING",O[O.DESCENDING=-1]="DESCENDING"})(T||(T={}));const S=(O,R)=>{const L=ce(Nat,o[3*O],o[3*O+1],o[3*O+2]),P=Fat;let U=O+R;do ce(P,o[3*U],o[3*U+1],o[3*U+2]),U+=R;while(q_(L,P)&&U>=0&&U<a);e&&(We(L,L,e),We(P,P,e)),x(L,P,[-1,-1],O),x(L,P,[1,-1],O),x(L,P,[1,1],O),x(L,P,[-1,-1],O),x(L,P,[1,1],O),x(L,P,[-1,1],O)},E=this._parameters.placement;E!=="begin"&&E!=="begin-end"||S(0,T.ASCENDING),E!=="end"&&E!=="begin-end"||S(a-1,T.DESCENDING)}};const Nat=M(),Fat=M(),ia={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},Uat={dash:ia.dash,"dash-dot":[...ia.dash,...ia.dot],dot:ia.dot,"long-dash":ia["long-dash"],"long-dash-dot":[...ia["long-dash"],...ia.dot],"long-dash-dot-dot":[...ia["long-dash"],...ia.dot,...ia.dot],none:null,"short-dash":ia["short-dash"],"short-dash-dot":[...ia["short-dash"],...ia["short-dot"]],"short-dash-dot-dot":[...ia["short-dash"],...ia["short-dot"],...ia["short-dot"]],"short-dot":ia["short-dot"],solid:null},kat=8;function Vat(t,e=2){return C(t)?t:{pattern:t.slice(),pixelRatio:e}}function mPt(t,e=2){return{pattern:[t,t],pixelRatio:e}}function k2e(t){return v(t)&&t.type==="style"?Bat(t.style):null}function Bat(t){return v(t)?Vat(Uat[t],kat):null}const zat=["polyline","polygon","extent"];let V2e=class B2e extends Tm{constructor(e,r,i,s){super(e,r,i,s)}async doLoad(){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=PO(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},!this._drivenProperties.size&&(this.symbolLayer.size!=null?this.symbolLayer.size:Vh(1))<0)throw new q("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._markerTexture=v(this.symbolLayer.marker)&&v(this._context.sharedResources.textures)?qst(this._context.sharedResources.textures,gat(this.symbolLayer.marker.style)):null}_getMaterialParameters(e,r=!1){var n;const i=this._getCombinedOpacityAndColor(r&&this._markerColor||this._materialColor);this._patternHidesLine&&!r&&(i[3]=0);const s={width:this._computeMaterialWidth((n=this.symbolLayer)==null?void 0:n.size),color:i,hasPolygonOffset:!0,join:this.symbolLayer.join||"miter",cap:Zj(this.symbolLayer.cap||"butt"),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:k2e(this.symbolLayer.pattern),stippleScaleWithLineWidth:!0};return this._fastUpdates&&this._fastUpdates.visualVariables?{...s,...this._fastUpdates.materialParameters}:s}get _materialColor(){return so(this.symbolLayer.material,e=>e.color)}get _markerColor(){return so(this.symbolLayer.marker,e=>e.color)}get _lineMaterial(){return C(this._lineMaterialCached)&&(this._lineMaterialCached=new L2(this._getMaterialParameters(!1)),this._context.stage.add(this._lineMaterialCached)),this._lineMaterialCached}get _ringMaterial(){return C(this._ringMaterialCached)&&(this._ringMaterialCached=new L2(this._getMaterialParameters(!0)),this._context.stage.add(this._ringMaterialCached)),this._ringMaterialCached}get _wireframeLineMaterial(){return C(this._wireframeLineMaterialCached)&&(this._wireframeLineMaterialCached=new L2({...this._getMaterialParameters(!1),wireframe:!0}),this._context.stage.add(this._wireframeLineMaterialCached)),this._wireframeLineMaterialCached}get _wireframeRingMaterial(){return C(this._wireframeRingMaterialCached)&&(this._wireframeRingMaterialCached=new L2({...this._getMaterialParameters(!0),wireframe:!0}),this._context.stage.add(this._wireframeRingMaterialCached)),this._wireframeRingMaterialCached}get _markerMaterial(){return C(this._markerMaterialCached)&&v(this.symbolLayer.marker)&&v(this._markerTexture)&&(this._markerMaterialCached=new Iat({...this._getMaterialParameters(!1,!0),placement:this.symbolLayer.marker.placement,textureId:this._markerTexture.texture.id}),this._context.stage.add(this._markerMaterialCached)),this._markerMaterialCached}destroy(){super.destroy(),this._forEachMaterial(e=>this._context.stage.remove(e)),this._lineMaterialCached=null,this._ringMaterialCached=null,this._wireframeLineMaterialCached=null,this._wireframeRingMaterialCached=null,this._markerMaterialCached=null,this._markerTexture=Bi(this._markerTexture)}_getDrivenSize(e){return this._drivenProperties.size&&e.size?Ao(mst(e.size)):1}_getSizeFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?Gg(this._fastUpdates.visualVariables.size.field,e):null}_getDrivenColor(e){const r=Ht(1,1,1,1);return this._drivenProperties.color&&e.color&&(r[0]=e.color[0],r[1]=e.color[1],r[2]=e.color[2],e.color.length>0&&(r[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(r[3]=e.opacity),r}_getColorFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?Gg(this._fastUpdates.visualVariables.color.field,e):null}_getOpacityFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?Gg(this._fastUpdates.visualVariables.opacity.field,e):null}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry,zat,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(r,new Cp);return this.ensureDrapedStatus(i.mode==="on-the-ground"),this.draped?this._createAsOverlay(e,this._context.layer.uid):this._createAs3DShape(e,i,r.uid)}applyRendererDiff(e,r){for(const i in e.diff){if(i!=="visualVariables"||!IO(this._fastUpdates,r,this._vvConvertOptions))return wn.Recreate_Symbol;this._forEachMaterial(s=>s.setParameters(this._fastUpdates.materialParameters))}return wn.Fast_Update}prepareSymbolLayerPatch(e){var n,o;if(e.diff.type!=="partial")return;const r=e.diff.diff,i={};((n=r.size)==null?void 0:n.type)==="complete"&&(i.width=this._computeMaterialWidth(r.size.newValue),delete r.size),((o=r.cap)==null?void 0:o.type)==="complete"&&(i.cap=Zj(It(r.cap.newValue,"butt")),delete r.cap);const s=this._prepareMarkerPatch(e,r);this._prepareMaterialPatch(e,r,s),e.symbolLayerStatePatches.push(()=>this._forEachMaterial(a=>a.setParameters(i)))}layerOpacityChanged(){this._forEachMaterial((e,r)=>this._updateMaterialLayerOpacity(e,r))}_forEachMaterial(e){v(this._lineMaterialCached)&&e(this._lineMaterialCached),v(this._ringMaterialCached)&&e(this._ringMaterialCached),v(this._wireframeLineMaterialCached)&&e(this._wireframeLineMaterialCached),v(this._wireframeRingMaterialCached)&&e(this._wireframeRingMaterialCached),v(this._markerMaterialCached)&&e(this._markerMaterialCached,!0)}_updateMaterialLayerOpacity(e,r=!1){const i=e.parameters.color,s=Dn(this.symbolLayer,"material","color"),n=this._patternHidesLine&&!r?0:this._getCombinedOpacity(s),o=Ht(i[0],i[1],i[2],n);e.setParameters({color:o})}layerElevationInfoChanged(e,r,i){const s=this._elevationContext.mode,n=LM(B2e.elevationModeChangeTypes,i,s);if(n!==ys.UPDATE)return n;const o=Xh(s);return this.updateGraphics3DGraphicElevationInfo(e,r,()=>o)}slicePlaneEnabledChanged(){const e={hasSlicePlane:this._context.slicePlaneEnabled};return this._forEachMaterial(r=>r.setParameters(e)),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}_getGeometryAsPolygonOrPolyline(e){switch(e.type){case"extent":if(e instanceof Zr)return pp.fromExtent(e);break;case"polygon":case"polyline":return e}return null}_createAs3DShape(e,r,i){const s=e.graphic,n=this._getGeometryAsPolygonOrPolyline(s.geometry),o=n.type==="polygon"?n.rings:n.paths,a=new Array,l=En(),c=Rat(n,this._context.elevationProvider,this._context.renderCoordsHelper,r),h=n.type==="polygon"?"rings":"paths";this._logGeometryCreationWarnings(c,o,h,"LineSymbol3DLayer");for(let m=0;m<c.lines.length;m++){const y=c.lines[m],_=y.position,b=y.mapPositions;if(v(this._context.clippingExtent)&&(Ri(l),Cu(l,b),!Zd(l,this._context.clippingExtent)))continue;const x=this._createGeometry(n.type==="polygon"?this._ringMaterial:this._lineMaterial,e,_,b,n.type,xR.ELEVATED,i);a.push(x),qr.LINE_WIREFRAMES&&a.push(x.instantiate({material:n.type==="polygon"?this._wireframeRingMaterial:this._wireframeLineMaterial})),v(this._markerMaterial)&&a.push(x.instantiate({material:this._markerMaterial}))}if(a.length===0)return null;const p=new Ty({geometries:a,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:i}}),f=new xm(this,p,a,null,null,wit,r);return f.alignedSampledElevation=c.sampledElevation,f.needsElevationUpdates=Xh(r.mode),f}_createGeometry(e,r,i,s,n,o,a){const l=n==="polygon",c=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,h=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size,p=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:a,layerUid:this._context.layer.uid});return Jj(e,{overlayInfo:o===xR.DRAPED?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,removeDuplicateStartEnd:l,mapPositions:s,attributeData:{position:i,size:h?null:this._getDrivenSize(r.renderingInfo),color:c?null:this._getDrivenColor(r.renderingInfo),sizeFeature:this._getSizeFeatureAttributeData(r.graphic),colorFeature:this._getColorFeatureAttributeData(r.graphic),opacityFeature:this._getOpacityFeatureAttributeData(r.graphic)}},p)}_createAsOverlay(e,r){const i=e.graphic,s=this._getGeometryAsPolygonOrPolyline(i.geometry),n=s.type==="polygon"?s.rings:s.paths,o=s.type==="polygon"?this._ringMaterial:this._lineMaterial;o.renderPriority=this._renderPriority;const a=qr.LINE_WIREFRAMES?s.type==="polygon"?this._wireframeRingMaterial:this._wireframeLineMaterial:null,l=this._markerMaterial;v(a)&&(a.renderPriority=this._renderPriority-.001),v(l)&&(l.renderPriority=this._renderPriority-.002);const c=new Array,h=En(),p=Ri(),f=Oat(s,this._context.overlaySR),m=s.type==="polygon"?"rings":"paths";this._logGeometryCreationWarnings(f,n,m,"LineSymbol3DLayer");for(const y of f.lines){if(Ri(h),Cu(h,y.position),!Zd(h,this._context.clippingExtent))continue;IS(p,h);const _=x=>{const T=this._createGeometry(x,e,y.position,void 0,s.type,xR.DRAPED,i.uid),S=new uE(T,{layerUid:r,graphicUid:i.uid});return c.push(S),S};if(v(l)){const x=_(l),T=this.symbolLayer.marker.placement;T!=="begin"&&T!=="begin-end"||Cu(h,y.position,0,1),T!=="end"&&T!=="begin-end"||Cu(h,y.position,y.position.length-3,1),this._updateBoundingSphere(x,h)}const b=_(o);if(this._updateBoundingSphere(b,h),qr.LINE_WIREFRAMES){const x=_(a);this._updateBoundingSphere(x,h)}}return new e6(this,c,p,this._context.drapeSourceRenderer)}_updateBoundingSphere(e,r){ti(e.boundingSphere,.5*(r[0]+r[3]),.5*(r[1]+r[4]),0,.5*Math.sqrt((r[3]-r[0])*(r[3]-r[0])+(r[4]-r[1])*(r[4]-r[1])))}get _patternHidesLine(){const e=this.symbolLayer.pattern;return v(e)&&e.type==="style"&&e.style==="none"}_computeMaterialWidth(e){return e=It(e,Vh(1)),this._drivenProperties.size?this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?Ao(1):1:Ao(e)}_prepareMaterialPatch(e,r,i){var a;const s=r.material;if(C(s))return void(i.changed&&i.useMaterialColor&&this._patchMaterialColor(this._getCombinedOpacityAndColor(this._materialColor),this._markerMaterialCached,e));if(s.type==="collection")return;const n=s.type==="complete"?so(s.newValue,l=>l.color):((a=s.diff.color)==null?void 0:a.type)==="complete"?s.diff.color.newValue:null,o=this._getCombinedOpacityAndColor(n);i.useMaterialColor&&this._patchMaterialColor(aM(o),this._markerMaterialCached,e),this._patternHidesLine&&(o[3]=0),this._patchMaterialColor(o,this._lineMaterialCached,e),delete r.material}_prepareMarkerPatch(e,r){const i=r.marker;if(C(i)||i.type!=="partial"||v(i.diff.style)||v(i.diff.placement)||v(i.diff.color)&&i.diff.color.type!=="complete")return{changed:!1,useMaterialColor:C(this._markerColor)};const s=i.diff.color;if(C(s))return delete r.marker,{changed:!1,useMaterialColor:C(this._markerColor)};const n=s.newValue;return C(n)?(delete r.marker,{changed:!0,useMaterialColor:!0}):(this._patchMaterialColor(this._getCombinedOpacityAndColor(n),this._markerMaterialCached,e),delete r.marker,{changed:!0,useMaterialColor:!1})}_patchMaterialColor(e,r,i){C(r)||i.symbolLayerStatePatches.push(()=>r.setParameters({color:e}))}};var xR;V2e.elevationModeChangeTypes={definedChanged:ys.RECREATE,staysOnTheGround:ys.NONE,onTheGroundChanged:ys.RECREATE},function(t){t[t.DRAPED=0]="DRAPED",t[t.ELEVATED=1]="ELEVATED"}(xR||(xR={}));let kC=null,NF=!0;function A9(t,e,r){if(!t||!e)throw new Error("Cannot construct image data without dimensions");if(NF)try{return new ImageData(t,e)}catch{NF=!1}return z2e(t,e,r)}function Gat(t,e,r,i){if(!e||!r)throw new Error("Cannot construct image data without dimensions");if(NF)try{return new ImageData(t,e,r)}catch{NF=!1}const s=z2e(e,r,i);return s.data.set(t,0),s}function jat(){return kC||(kC=document.createElement("canvas"),kC.width=1,kC.height=1),kC}function z2e(t,e,r){return r||(r=jat()),r.getContext("2d").createImageData(t,e)}var s2;const R9=new WeakMap;let Hat=0,df=s2=class extends ve{constructor(t){super(t),this.wrap="repeat"}get url(){return this._get("url")||null}set url(t){this._set("url",t),t&&this._set("data",null)}get data(){return this._get("data")||null}set data(t){this._set("data",t),t&&this._set("url",null)}writeData(t,e,r,i){if(t instanceof HTMLImageElement){const s={type:"image-element",src:gw(t.src,i),crossOrigin:t.crossOrigin};e[r]=s}else if(t instanceof HTMLCanvasElement){const s=t.getContext("2d").getImageData(0,0,t.width,t.height),n={type:"canvas-element",imageData:this._encodeImageData(s)};e[r]=n}else if(t instanceof HTMLVideoElement){const s={type:"video-element",src:gw(t.src,i),autoplay:t.autoplay,loop:t.loop,muted:t.muted,crossOrigin:t.crossOrigin,preload:t.preload};e[r]=s}else if(t instanceof ImageData){const s={type:"image-data",imageData:this._encodeImageData(t)};e[r]=s}}readData(t){switch(t.type){case"image-element":{const e=new Image;return e.src=t.src,e.crossOrigin=t.crossOrigin,e}case"canvas-element":{const e=this._decodeImageData(t.imageData),r=document.createElement("canvas");return r.width=e.width,r.height=e.height,r.getContext("2d").putImageData(e,0,0),r}case"image-data":return this._decodeImageData(t.imageData);case"video-element":{const e=document.createElement("video");return e.src=t.src,e.crossOrigin=t.crossOrigin,e.autoplay=t.autoplay,e.loop=t.loop,e.muted=t.muted,e.preload=t.preload,e}default:return}}get transparent(){const t=this.data,e=this.url;if(t instanceof HTMLCanvasElement)return this._imageDataContainsTransparent(t.getContext("2d").getImageData(0,0,t.width,t.height));if(t instanceof ImageData)return this._imageDataContainsTransparent(t);if(e){const r=e.substr(e.length-4,4).toLowerCase(),i=e.substr(0,15).toLocaleLowerCase();if(r===".png"||i==="data:image/png;")return!0}return!1}set transparent(t){this._overrideIfSome("transparent",t)}get contentHash(){const t=typeof this.wrap=="string"?this.wrap:typeof this.wrap=="object"?`${this.wrap.horizontal}/${this.wrap.vertical}`:"",e=(r="")=>`d:${r},t:${this.transparent},w:${t}`;return this.url!=null?e(this.url):this.data!=null?this.data instanceof HTMLImageElement||this.data instanceof HTMLVideoElement?e(this.data.src):(R9.has(this.data)||R9.set(this.data,++Hat),e(R9.get(this.data))):e()}clone(){const t={url:this.url,data:this.data,wrap:this._cloneWrap()};return new s2(t)}cloneWithDeduplication(t){const e=t.get(this);if(e)return e;const r=this.clone();return t.set(this,r),r}_cloneWrap(){return typeof this.wrap=="string"?this.wrap:{horizontal:this.wrap.horizontal,vertical:this.wrap.vertical}}_encodeImageData(t){let e="";for(let r=0;r<t.data.length;r++)e+=String.fromCharCode(t.data[r]);return{data:btoa(e),width:t.width,height:t.height}}_decodeImageData(t){const e=atob(t.data),r=new Uint8ClampedArray(e.length);for(let i=0;i<e.length;i++)r[i]=e.charCodeAt(i);return Gat(r,t.width,t.height)}_imageDataContainsTransparent(t){for(let e=3;e<t.data.length;e+=4)if(t.data[e]!==255)return!0;return!1}static from(t){return typeof t=="string"?new s2({url:t}):t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof ImageData||t instanceof HTMLVideoElement?new s2({data:t}):bS(s2,t)}};u([d({type:String,json:{write:Y_}})],df.prototype,"url",null),u([d({json:{write:{overridePolicy(){return{enabled:!this.url}}}}}),d()],df.prototype,"data",null),u([He("data")],df.prototype,"writeData",null),u([Fe("data")],df.prototype,"readData",null),u([d({type:Boolean,json:{write:{overridePolicy(){return{enabled:this._isOverridden("transparent")}}}}})],df.prototype,"transparent",null),u([d({json:{write:!0}})],df.prototype,"wrap",void 0),u([d({readOnly:!0})],df.prototype,"contentHash",null),df=s2=u([I("esri.geometry.support.MeshTexture")],df);const TR=df;var Kj;let Md=Kj=class extends ve{constructor(t){super(t),this.color=null,this.colorTexture=null,this.normalTexture=null,this.alphaMode="auto",this.alphaCutoff=.5,this.doubleSided=!0}clone(){return this.cloneWithDeduplication(null,new Map)}cloneWithDeduplication(t,e){const r=v(t)?t.get(this):null;if(r)return r;const i=new Kj(this.clonePropertiesWithDeduplication(e));return v(t)&&t.set(this,i),i}clonePropertiesWithDeduplication(t){return{color:v(this.color)?this.color.clone():null,colorTexture:v(this.colorTexture)?this.colorTexture.cloneWithDeduplication(t):null,normalTexture:v(this.normalTexture)?this.normalTexture.cloneWithDeduplication(t):null,alphaMode:this.alphaMode,alphaCutoff:this.alphaCutoff,doubleSided:this.doubleSided,colorTextureTransform:v(this.colorTextureTransform)?this.colorTextureTransform:null,normalTextureTransform:v(this.normalTextureTransform)?this.normalTextureTransform:null}}};u([d({type:Ze,json:{write:!0}})],Md.prototype,"color",void 0),u([d({type:TR,json:{write:!0}})],Md.prototype,"colorTexture",void 0),u([d({type:TR,json:{write:!0}})],Md.prototype,"normalTexture",void 0),u([d({nonNullable:!0,json:{write:!0}})],Md.prototype,"alphaMode",void 0),u([d({nonNullable:!0,json:{write:!0}})],Md.prototype,"alphaCutoff",void 0),u([d({nonNullable:!0,json:{write:!0}})],Md.prototype,"doubleSided",void 0),u([d()],Md.prototype,"colorTextureTransform",void 0),u([d()],Md.prototype,"normalTextureTransform",void 0),Md=Kj=u([I("esri.geometry.support.MeshMaterial")],Md);const ZZ=Md;var Qj;let uh=Qj=class extends ZZ{constructor(t){super(t),this.emissiveColor=null,this.emissiveTexture=null,this.occlusionTexture=null,this.metallic=1,this.roughness=1,this.metallicRoughnessTexture=null}clone(){return this.cloneWithDeduplication(null,new Map)}cloneWithDeduplication(t,e){const r=v(t)?t.get(this):null;if(r)return r;const i=new Qj(this.clonePropertiesWithDeduplication(e));return v(t)&&t.set(this,i),i}clonePropertiesWithDeduplication(t){return{...super.clonePropertiesWithDeduplication(t),emissiveColor:v(this.emissiveColor)?this.emissiveColor.clone():null,emissiveTexture:v(this.emissiveTexture)?this.emissiveTexture.cloneWithDeduplication(t):null,occlusionTexture:v(this.occlusionTexture)?this.occlusionTexture.cloneWithDeduplication(t):null,metallic:this.metallic,roughness:this.roughness,metallicRoughnessTexture:v(this.metallicRoughnessTexture)?this.metallicRoughnessTexture.cloneWithDeduplication(t):null,occlusionTextureTransform:v(this.occlusionTextureTransform)?this.occlusionTextureTransform:null,emissiveTextureTransform:v(this.emissiveTextureTransform)?this.emissiveTextureTransform:null,metallicRoughnessTextureTransform:v(this.metallicRoughnessTextureTransform)?this.metallicRoughnessTextureTransform:null}}};u([d({type:Ze,json:{write:!0}})],uh.prototype,"emissiveColor",void 0),u([d({type:TR,json:{write:!0}})],uh.prototype,"emissiveTexture",void 0),u([d({type:TR,json:{write:!0}})],uh.prototype,"occlusionTexture",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0},range:{min:0,max:1}})],uh.prototype,"metallic",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0},range:{min:0,max:1}})],uh.prototype,"roughness",void 0),u([d({type:TR,json:{write:!0}})],uh.prototype,"metallicRoughnessTexture",void 0),u([d()],uh.prototype,"occlusionTextureTransform",void 0),u([d()],uh.prototype,"emissiveTextureTransform",void 0),u([d()],uh.prototype,"metallicRoughnessTextureTransform",void 0),uh=Qj=u([I("esri.geometry.support.MeshMaterialMetallicRoughness")],uh);const G2e=uh;var yD;const j2e="esri.geometry.support.MeshVertexAttributes",Bx=se.getLogger(j2e);let Hu=yD=class extends ve{constructor(t){super(t),this.color=null,this.position=new Float64Array(0),this.uv=null,this.normal=null,this.tangent=null}castColor(t){return n2(t,Uint8Array,[Uint8ClampedArray],{loggerTag:".color=",stride:4},Bx)}castPosition(t){return t&&t instanceof Float32Array&&Bx.warn(".position=","Setting position attribute from a Float32Array may cause precision problems. Consider storing data in a Float64Array or a regular number array"),n2(t,Float64Array,[Float32Array],{loggerTag:".position=",stride:3},Bx)}castUv(t){return n2(t,Float32Array,[Float64Array],{loggerTag:".uv=",stride:2},Bx)}castNormal(t){return n2(t,Float32Array,[Float64Array],{loggerTag:".normal=",stride:3},Bx)}castTangent(t){return n2(t,Float32Array,[Float64Array],{loggerTag:".tangent=",stride:4},Bx)}clone(){const t={position:ne(this.position),uv:ne(this.uv),normal:ne(this.normal),tangent:ne(this.tangent),color:ne(this.color)};return new yD(t)}clonePositional(){const t={position:ne(this.position),normal:ne(this.normal),tangent:ne(this.tangent),uv:this.uv,color:this.color};return new yD(t)}};function O9(t,e,r,i){const{loggerTag:s,stride:n}=e;return t.length%n!=0?(i.error(s,`Invalid array length, expected a multiple of ${n}`),new r([])):t}function n2(t,e,r,i,s){if(!t)return t;if(t instanceof e)return O9(t,i,e,s);for(const n of r)if(t instanceof n)return O9(new e(t),i,e,s);if(Array.isArray(t))return O9(new e(t),i,e,s);{const n=r.map(o=>`'${o.name}'`);return s.error(`Failed to set property, expected one of ${n}, but got ${t.constructor.name}`),new e([])}}function VC(t,e,r){e[r]=qat(t)}function qat(t){const e=new Array(t.length);for(let r=0;r<t.length;r++)e[r]=t[r];return e}u([d({json:{write:VC}})],Hu.prototype,"color",void 0),u([cr("color")],Hu.prototype,"castColor",null),u([d({nonNullable:!0,json:{write:VC}})],Hu.prototype,"position",void 0),u([cr("position")],Hu.prototype,"castPosition",null),u([d({json:{write:VC}})],Hu.prototype,"uv",void 0),u([cr("uv")],Hu.prototype,"castUv",null),u([d({json:{write:VC}})],Hu.prototype,"normal",void 0),u([cr("normal")],Hu.prototype,"castNormal",null),u([d({json:{write:VC}})],Hu.prototype,"tangent",void 0),u([cr("tangent")],Hu.prototype,"castTangent",null),Hu=yD=u([I(j2e)],Hu);var w3;const H2e="esri.geometry.support.MeshComponent",Wat=se.getLogger(H2e);let fg=w3=class extends ve{static from(t){return bS(w3,t)}constructor(t){super(t),this.faces=null,this.material=null,this.shading="source",this.trustSourceNormals=!1}castFaces(t){return n2(t,Uint32Array,[Uint16Array],{loggerTag:".faces=",stride:3},Wat)}castMaterial(t){return bS(t&&typeof t=="object"&&("metallic"in t||"roughness"in t||"metallicRoughnessTexture"in t)?G2e:ZZ,t)}clone(){return new w3({faces:ne(this.faces),shading:this.shading,material:ne(this.material),trustSourceNormals:this.trustSourceNormals})}cloneWithDeduplication(t,e){const r={faces:ne(this.faces),shading:this.shading,material:this.material?this.material.cloneWithDeduplication(t,e):null,trustSourceNormals:this.trustSourceNormals};return new w3(r)}};u([d({json:{write:!0}})],fg.prototype,"faces",void 0),u([cr("faces")],fg.prototype,"castFaces",null),u([d({type:ZZ,json:{write:!0}})],fg.prototype,"material",void 0),u([cr("material")],fg.prototype,"castMaterial",null),u([d({type:String,json:{write:!0}})],fg.prototype,"shading",void 0),u([d({type:Boolean})],fg.prototype,"trustSourceNormals",void 0),fg=w3=u([I(H2e)],fg);const Xat=fg,r6=se.getLogger("esri.geometry.support.meshUtils.normalProjection");function Yat(t,e,r,i,s){return s6(i)?(i6(jg.TO_PCPF,Oi.fromTypedArray(t),wa.fromTypedArray(e),wa.fromTypedArray(r),i,Oi.fromTypedArray(s)),s):(r6.error("Cannot convert spatial reference to PCPF"),s)}function gPt(t,e,r,i,s){return s6(i)?(i6(jg.FROM_PCPF,Oi.fromTypedArray(t),wa.fromTypedArray(e),wa.fromTypedArray(r),i,Oi.fromTypedArray(s)),s):(r6.error("Cannot convert to spatial reference from PCPF"),s)}function yPt(t,e,r){return _s(t,e,0,r,j4(e),0,t.length/3),r}function _Pt(t,e,r){return _s(t,j4(r),0,e,r,0,t.length/3),e}function Zat(t,e,r){if(C(t))return e;const i=wa.fromTypedArray(t),s=wa.fromTypedArray(e);return NM(s,i,r),e}function Jat(t,e,r){if(C(t))return e;QS(Yn,r);const i=Oi.fromTypedArray(t),s=Oi.fromTypedArray(e);return uv(s,i,Yn),gY(Yn)||IZ(s,s),e}function Kat(t,e,r){if(C(t))return e;QS(Yn,r);const i=Oi.fromTypedArray(t,4*Float32Array.BYTES_PER_ELEMENT),s=Oi.fromTypedArray(e,4*Float32Array.BYTES_PER_ELEMENT);if(uv(s,i,Yn),gY(Yn)||IZ(s,s),t!==e)for(let n=3;n<t.length;n+=4)e[n]=t[n];return e}function Qat(t,e,r,i,s){if(!s6(i))return r6.error("Cannot convert spatial reference to PCPF"),s;i6(jg.TO_PCPF,Oi.fromTypedArray(t,4*Float32Array.BYTES_PER_ELEMENT),wa.fromTypedArray(e),wa.fromTypedArray(r),i,Oi.fromTypedArray(s,4*Float32Array.BYTES_PER_ELEMENT));for(let n=3;n<t.length;n+=4)s[n]=t[n];return s}function vPt(t,e,r,i,s){if(!s6(i))return r6.error("Cannot convert to spatial reference from PCPF"),s;i6(jg.FROM_PCPF,Oi.fromTypedArray(t,16),wa.fromTypedArray(e),wa.fromTypedArray(r),i,Oi.fromTypedArray(s,16));for(let n=3;n<t.length;n+=4)s[n]=t[n];return s}function i6(t,e,r,i,s,n){if(!e)return;const o=r.count,a=j4(s);if(q2e(s))for(let l=0;l<o;l++)i.getVec(l,WI),e.getVec(l,Up),gp(a,WI,XI,a),Hh(Yn,XI),t===jg.FROM_PCPF&&qh(Yn,Yn),Ac(Up,Up,Yn),n.setVec(l,Up);else for(let l=0;l<o;l++){i.getVec(l,WI),e.getVec(l,Up),gp(a,WI,XI,a),Hh(Yn,XI);const c=tN(r.get(l,1));let h=Math.cos(c);t===jg.TO_PCPF&&(h=1/h),Yn[0]*=h,Yn[1]*=h,Yn[2]*=h,Yn[3]*=h,Yn[4]*=h,Yn[5]*=h,t===jg.FROM_PCPF&&qh(Yn,Yn),Ac(Up,Up,Yn),_e(Up,Up),n.setVec(l,Up)}return n}function s6(t){return q2e(t)||elt(t)}function q2e(t){return t.isWGS84||hhe(t)||fm(t)||mm(t)}function elt(t){return t.isWebMercator}var jg;(function(t){t[t.TO_PCPF=0]="TO_PCPF",t[t.FROM_PCPF=1]="FROM_PCPF"})(jg||(jg={}));const WI=M(),Up=M(),XI=Ie(),Yn=es();let W2e=class{constructor(e){this.data=e,this.type="encoded-mesh-texture",this.encoding=Og.KTX2_ENCODING}};function rw(t){return(t==null?void 0:t.type)==="encoded-mesh-texture"}async function tlt(t){return new Promise((e,r)=>{const i=new Blob([t]),s=new FileReader;s.onload=()=>{const n=s.result;e(JSON.parse(n))},s.onerror=n=>{r(n)},s.readAsText(i)})}async function rlt(t,e){return e===Og.KTX2_ENCODING?new W2e(t):new Promise((r,i)=>{const s=new Blob([t],{type:e}),n=URL.createObjectURL(s),o=new Image,a=()=>{URL.revokeObjectURL(n),"decode"in o?o.decode().then(()=>r(o),()=>r(o)).then(c):(r(o),c())},l=h=>{URL.revokeObjectURL(n),i(h),c()},c=()=>{o.removeEventListener("load",a),o.removeEventListener("error",l)};o.addEventListener("load",a),o.addEventListener("error",l),o.src=n})}function Lf(t){if(C(t))return null;const e=v(t.offset)?t.offset:fTe,r=v(t.rotation)?t.rotation:0,i=v(t.scale)?t.scale:mTe,s=mD(1,0,0,0,1,0,e[0],e[1],1),n=mD(Math.cos(r),-Math.sin(r),0,Math.sin(r),Math.cos(r),0,0,0,1),o=mD(i[0],0,0,0,i[1],0,0,0,1),a=Gl();return KS(a,n,o),KS(a,s,a),a}function ilt(t){const e=new Dr,{vertex:r,fragment:i}=e;return e.include(Bl,t),e.include(sx,t),e.include(ITe,t),$c(r,t),t.stippleEnabled&&(e.attributes.add(A.UV0,"vec2"),e.attributes.add(A.AUXPOS1,"vec3"),r.uniforms.add(new pr("viewport",(s,n)=>n.camera.fullViewport))),e.attributes.add(A.POSITION,"vec3"),e.varyings.add("vpos","vec3"),r.code.add(w`void main(void) {
vpos = position;
forwardNormalizedVertexColor();
gl_Position = transformPosition(proj, view, vpos);`),t.stippleEnabled&&(r.code.add(w`vec4 vpos2 = transformPosition(proj, view, auxpos1);
vec2 ndcToPixel = viewport.zw * 0.5;
float lineSegmentPixelSize = length((vpos2.xy / vpos2.w - gl_Position.xy / gl_Position.w) * ndcToPixel);`),t.draped?r.uniforms.add(new Pe("worldToScreenRatio",(s,n)=>1/n.screenToPCSRatio)):r.code.add(w`vec3 segmentCenter = (position + auxpos1) * 0.5;
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),r.code.add(w`float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);`),t.draped?r.code.add(w`float startPseudoScreen = uv0.y * discreteWorldToScreenRatio - mix(0.0, lineSegmentPixelSize, uv0.x);
float segmentLengthPseudoScreen = lineSegmentPixelSize;`):r.code.add(w`float segmentLengthRender = length(position - auxpos1);
float startPseudoScreen = mix(uv0.y, uv0.y - segmentLengthRender, uv0.x) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),r.uniforms.add(new Pe("stipplePatternPixelSize",s=>LZ(s))),r.code.add(w`vec2 stippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, lineSegmentPixelSize, stipplePatternPixelSize);
vStippleDistance = mix(stippleDistanceLimits.x, stippleDistanceLimits.y, uv0.x);
vStippleDistance *= gl_Position.w;`)),r.code.add(w`}`),t.output===k.Highlight&&e.include(by,t),e.include(Xs,t),i.uniforms.add(new Pe("alphaCoverage",(s,n)=>Math.min(1,s.width*n.camera.pixelRatio))),t.hasVertexColors||i.uniforms.add(new pr("constantColor",s=>s.color)),i.code.add(w`
  void main() {
    discardBySlice(vpos);

    vec4 color = ${t.hasVertexColors?"vColor":"constantColor"};

    float stippleAlpha = getStippleAlpha();
    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);

    vec4 finalColor = blendStipple(vec4(color.rgb, color.a * alphaCoverage), stippleAlpha);

    ${t.output===k.ObjectAndLayerIdColor?w`finalColor.a = 1.0;`:""}

    if (finalColor.a < ${w.float(Yo)}) {
      discard;
    }

    ${t.output===k.Color?w`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${t.output===k.Highlight?w`outputHighlight();`:""}
  }
  `),e}const slt=Object.freeze(Object.defineProperty({__proto__:null,build:ilt},Symbol.toStringTag,{value:"Module"}));let X2e=class Y2e extends Vr{get _stippleEnabled(){return this.configuration.stippleEnabled&&this.configuration.output!==k.Highlight}initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===vt.WEBGL2}initializeProgram(e){return new Fr(e.rctx,Y2e.shader.get().build(this.configuration),Rr)}initializePipeline(){const e=this.configuration,r=kn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),i=(s,n=null,o=null)=>Bt({blending:n,depthTest:NZ,depthWrite:o,colorWrite:Kt,stencilWrite:e.hasOccludees?dm:null,stencilTest:e.hasOccludees?s?hv:Tv:null});return e.output===k.Color?(this._occludeePipelineState=i(!0,e.transparent||this._stippleEnabled?r:null,Xl),i(!1,e.transparent||this._stippleEnabled?r:null,Xl)):i(!1)}get primitiveType(){return $t.LINES}getPipelineState(e,r){return r?this._occludeePipelineState:super.getPipelineState(e,r)}};X2e.shader=new Nr(slt,()=>te(()=>import("./NativeLine.glsl-97d41d2d.js"),[]));let ru=class extends eo{constructor(){super(...arguments),this.output=k.Color,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.hasOccludees=!1}};u([V({count:k.COUNT})],ru.prototype,"output",void 0),u([V()],ru.prototype,"hasSlicePlane",void 0),u([V()],ru.prototype,"hasVertexColors",void 0),u([V()],ru.prototype,"transparent",void 0),u([V()],ru.prototype,"draped",void 0),u([V()],ru.prototype,"stippleEnabled",void 0),u([V()],ru.prototype,"stippleOffColorEnabled",void 0),u([V()],ru.prototype,"stipplePreferContinuous",void 0),u([V()],ru.prototype,"hasOccludees",void 0),u([V({constValue:!1})],ru.prototype,"stippleRequiresClamp",void 0),u([V({constValue:!1})],ru.prototype,"stippleScaleWithLineWidth",void 0),u([V({constValue:!1})],ru.prototype,"stippleRequiresStretchMeasure",void 0);var FF;(function(t){t[t.START=0]="START",t[t.END=1]="END"})(FF||(FF={}));let voe=class extends wv{constructor(e){super(e,new alt),this._configuration=new ru}getConfiguration(e,r){this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._configuration.draped=r.slot===Se.DRAPED_MATERIAL;const i=v(this.parameters.stipplePattern);return this._configuration.stippleEnabled=i,this._configuration.stippleOffColorEnabled=i&&v(this.parameters.stippleOffColor),this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.stipplePreferContinuous=this.parameters.stipplePreferContinuous,this._configuration}intersect(e,r,i,s,n,o){if(!i.options.selectionMode||!e.visible)return;if(!rbe(r))return void se.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial").error("intersection assumes a translation-only matrix");const a=e.vertexAttributes.get(A.POSITION).data,l=i.camera,c=clt;Un(c,i.point);const h=2;ce(BC[0],c[0]-h,c[1]+h,0),ce(BC[1],c[0]+h,c[1]+h,0),ce(BC[2],c[0]+h,c[1]-h,0),ce(BC[3],c[0]-h,c[1]-h,0);for(let _=0;_<4;_++)if(!l.unprojectFromRenderScreen(BC[_],km[_]))return;la(l.eye,km[0],km[1],M9),la(l.eye,km[1],km[2],P9),la(l.eye,km[2],km[3],I9),la(l.eye,km[3],km[0],$9);let p=Number.MAX_VALUE,f=0;for(let _=0;_<a.length-5;_+=3){if(ka[0]=a[_]+r[12],ka[1]=a[_+1]+r[13],ka[2]=a[_+2]+r[14],Va[0]=a[_+3]+r[12],Va[1]=a[_+4]+r[13],Va[2]=a[_+5]+r[14],bi(M9,ka)<0&&bi(M9,Va)<0||bi(P9,ka)<0&&bi(P9,Va)<0||bi(I9,ka)<0&&bi(I9,Va)<0||bi($9,ka)<0&&bi($9,Va)<0)continue;if(l.projectToRenderScreen(ka,Jv),l.projectToRenderScreen(Va,Kv),Jv[2]<0&&Kv[2]>0){me(kp,ka,Va);const x=l.frustum,T=-bi(x[vi.NEAR],ka)/ye(kp,x[vi.NEAR]);ae(kp,kp,T),fe(ka,ka,kp),l.projectToRenderScreen(ka,Jv)}else if(Jv[2]>0&&Kv[2]<0){me(kp,Va,ka);const x=l.frustum,T=-bi(x[vi.NEAR],Va)/ye(kp,x[vi.NEAR]);ae(kp,kp,T),fe(Va,Va,kp),l.projectToRenderScreen(Va,Kv)}else if(Jv[2]<0&&Kv[2]<0)continue;Jv[2]=0,Kv[2]=0;const b=OW(Yb(Jv,Kv,xoe),c);b<p&&(p=b,le(boe,ka),le(woe,Va),f=_/3)}const m=i.rayBegin,y=i.rayEnd;if(p<h*h){let _=Number.MAX_VALUE;if(Qfe(Yb(boe,woe,xoe),Yb(m,y,llt),Zv)){me(Zv,Zv,m);const b=Me(Zv);ae(Zv,Zv,1/b),_=b/xi(m,y)}o(_,Zv,f,!1)}}intersectDraped(e,r,i,s,n,o){if(!i.options.selectionMode)return;const a=e.vertexAttributes.get(A.POSITION).data,l=e.vertexAttributes.get(A.SIZE),c=l?l.data[0]:0,h=s[0],p=s[1],f=((c+1)/2+4)*e.screenToWorldRatio;let m=Number.MAX_VALUE,y=0;for(let _=0;_<a.length-5;_+=3){const b=a[_],x=a[_+1],T=h-b,S=p-x,E=a[_+3]-b,O=a[_+4]-x,R=ge((E*T+O*S)/(E*E+O*O),0,1),L=E*R-T,P=O*R-S,U=L*L+P*P;U<m&&(m=U,y=_/3)}m<f*f&&n(o.dist,o.normal,y,!1)}requiresSlot(e,r){return!(r!==k.Color&&r!==k.Highlight&&r!==k.ObjectAndLayerIdColor||e!==Se.OPAQUE_MATERIAL&&e!==Se.DRAPED_MATERIAL)}createGLMaterial(e){return new nlt(e)}createBufferWriter(){const e=this.parameters.hasVertexColors?YTe:_nt;return C(this.parameters.stipplePattern)?new XE(e):new olt(e.clone().vec3f(A.AUXPOS1).vec2f(A.UV0))}},nlt=class extends bv{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output===k.Color&&this._updateOccludeeState(e);const r=this._material.parameters.stipplePattern;return this._stipplePattern!==r&&(this._material.setParameters(this._stippleTextureRepository.swap(this._stipplePattern,r)),this._stipplePattern=r),this.ensureTechnique(X2e,e)}},olt=class{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get(A.POSITION).length}write(e,r,i,s,n){oxe(i,this.vertexBufferLayout,e,r,s,n),this._writeAuxpos1(e,i,s,n),this._writeUV0(e,i,s,n)}_writeAuxpos1(e,r,i,s){const n=i.getField(A.AUXPOS1,Oi),o=r.indices.get(A.POSITION),a=r.vertexAttributes.get(A.POSITION).data,l=e,c=n.typedBufferStride,h=n.typedBuffer;s*=c;for(let p=0;p<o.length-1;p+=2)for(const f of[1,0]){const m=3*o[p+f],y=a[m],_=a[m+1],b=a[m+2],x=l[0]*y+l[4]*_+l[8]*b+l[12],T=l[1]*y+l[5]*_+l[9]*b+l[13],S=l[2]*y+l[6]*_+l[10]*b+l[14];h[s]=x,h[s+1]=T,h[s+2]=S,s+=c}}_writeUV0(e,r,i,s){var S;const n=i.getField(A.UV0,vy),o=r.indices.get(A.POSITION),a=r.vertexAttributes.get(A.POSITION).data,l=(S=r.vertexAttributes.get(A.DISTANCETOSTART))==null?void 0:S.data,c=n.typedBufferStride,h=n.typedBuffer;let p=0;h[s*=c]=FF.START,h[s+1]=p,s+=c;const f=3*o[0],m=ce(ka,a[f],a[f+1],a[f+2]);e&&We(m,m,e);const y=Va,_=o.length-1;let b=1;const x=l?(E,O,R)=>p=l[R]:(E,O,R)=>p+=xi(E,O);for(let E=1;E<_;E+=2){const O=3*o[E];ce(y,a[O],a[O+1],a[O+2]),e&&We(y,y,e),x(m,y,b++);for(let R=0;R<2;++R)h[s]=1-R,h[s+1]=p,s+=c;le(m,y)}const T=3*o[_];ce(y,a[T],a[T+1],a[T+2]),e&&We(y,y,e),x(m,y,b),h[s]=FF.END,h[s+1]=p}},alt=class extends qE{constructor(){super(...arguments),this.color=Rh,this.hasVertexColors=!1,this.hasSlicePlane=!1,this.width=1,this.stipplePreferContinuous=!0,this.hasOccludees=!1,this.stippleTexture=null}};const ka=M(),Va=M(),kp=M(),Zv=M(),Jv=qo(),Kv=qo(),boe=M(),woe=M(),xoe=xp(),llt=xp(),clt=M(),BC=[qo(),qo(),qo(),qo()],km=[M(),M(),M(),M()],M9=zr(),P9=zr(),I9=zr(),$9=zr(),ult=["mesh"];class hlt extends Tm{constructor(e,r,i,s){super(e,r,i,s),this._materials=new Map,this._textures=new Map,this.ensureDrapedStatus(!1)}async doLoad(){qr.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new voe({color:[1,0,1,1]}),this._debugFaceNormalMaterial=new voe({color:[0,1,1,1]}))}destroy(){super.destroy(),this._context.stage.removeMany(Array.from(this._materials.values(),e=>e.material)),this._context.stage.removeMany(Array.from(this._textures.values())),this._materials.clear(),this._textures.clear()}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry,ult,"fill on mesh-3d"))return null;const i=this.setGraphicElevationContext(r,new Cp),s=e.renderingInfo;return this._createAs3DShape(r,s,i,r.uid)}layerOpacityChanged(e,r){const i=this._getLayerOpacity();this._materials.forEach(s=>{s.material.setParameters({layerOpacity:i});const n=s.material.parameters;this._setMaterialTransparentParameter(n,s),s.material.setParameters({transparent:n.transparent})}),e.forEach(s=>{const n=r(s);v(n)&&n.layerOpacityChanged(i,this._context.isAsync)})}layerElevationInfoChanged(e,r){return this.updateGraphics3DGraphicElevationInfo(e,r,lv)}slicePlaneEnabledChanged(e,r){return this._materials.forEach(i=>{i.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),e.forEach(i=>{const s=r(i);v(s)&&s.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){const e=this._usePBR();return this._materials.forEach(r=>r.material.setParameters({usePBR:e})),!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}_requiresSymbolVertexColors(){return this._drivenProperties.color||this._drivenProperties.opacity}_colorOrTextureUid(e){return C(e)?"-":e instanceof Ze?e.toHex():e.contentHash}_materialPropertiesDefault(e,r){const i=this._requiresSymbolVertexColors(),s=!!e.vertexAttributes.color,n=!!e.vertexAttributes.tangent;return{hasSymbolVertexColors:i,hasVertexColors:s,hasVertexTangents:n,uid:`vc:${s},vt:${n},vct${r},svc:${i}`}}_materialProperties(e,r,i){const s=this._materialPropertiesDefault(e,i);if(!r.material)return s;const{color:n,colorTexture:o,normalTexture:a,doubleSided:l,alphaCutoff:c,alphaMode:h}=r.material,p=this._colorOrTextureUid(n),f=this._colorOrTextureUid(o),m=this._colorOrTextureUid(a);if(s.color=n,s.colorTexture=o,s.normalTexture=a,s.uid=`${s.uid},cmuid:${p},ctmuid:${f},ntmuid:${m},ds:${l},ac:${c},am:${h}`,r.material instanceof G2e){const{metallic:y,roughness:_,metallicRoughnessTexture:b,emissiveColor:x,emissiveTexture:T,occlusionTexture:S}=r.material,E=this._colorOrTextureUid(b),O=this._colorOrTextureUid(x),R=this._colorOrTextureUid(T),L=this._colorOrTextureUid(S);s.metallic=y,s.roughness=_,s.metallicRoughnessTexture=b,s.emissiveColor=x,s.emissiveTexture=T,s.occlusionTexture=S,s.colorTextureTransform=r.material.colorTextureTransform,s.normalTextureTransform=r.material.normalTextureTransform,s.emissiveTextureTransform=r.material.emissiveTextureTransform,s.occlusionTextureTransform=r.material.occlusionTextureTransform,s.metallicRoughnessTextureTransform=r.material.metallicRoughnessTextureTransform,s.uid=`${s.uid},mrm:${y},mrr:${_},mrt:${E},emuid:${O},etmuid:${R},otmuid:${L}`}return s}_setInternalColorValueParameters(e,r){r.diffuse=Ze.toUnitRGB(e),r.opacity=e.a}_getLoadableTextureResource(e){return e.data?e.data:e.url}_getInternalTextureId(e){const r=this._getInternalTexture(e,ui.Opaque);return v(r)?r.id:null}_getInternalTexture(e,r){const i=this._getLoadableTextureResource(e);if(!i)return null;const s=`${e.contentHash}/${r}`;let n=this._textures.get(s);return n||(n=new ix(rw(i)?i.data:i,{mipmap:!0,wrap:this._castTextureWrap(e.wrap),noUnpackFlip:!0,preMultiplyAlpha:!rw(i)&&r!==ui.Opaque,encoding:rw(i)&&v(i.encoding)?i.encoding:void 0}),this._textures.set(s,n),this._context.stage.add(n),this._context.stage.loadImmediate(n)),n}_castTextureWrap(e="repeat"){if(typeof e=="string"){const r=this._castTextureWrapIndividual(e);return{s:r,t:r}}return{s:this._castTextureWrapIndividual(e.horizontal),t:this._castTextureWrapIndividual(e.vertical)}}_castTextureWrapIndividual(e){switch(e){case"clamp":return Rt.CLAMP_TO_EDGE;case"mirror":return Rt.MIRRORED_REPEAT;default:return Rt.REPEAT}}_setInternalMaterialParameters(e,r){if(v(e.color)&&this._setInternalColorValueParameters(e.color,r),v(e.colorTexture)){const i=this._getInternalTexture(e.colorTexture,r.textureAlphaMode);v(i)?(r.textureId=i.id,r.textureAlphaPremultiplied=!!i.params.preMultiplyAlpha):r.textureId=void 0}v(e.normalTexture)&&(r.normalTextureId=this._getInternalTextureId(e.normalTexture)),v(e.emissiveColor)&&(r.emissiveFactor=Ze.toUnitRGB(e.emissiveColor)),v(e.emissiveTexture)&&(r.emissiveTextureId=this._getInternalTextureId(e.emissiveTexture)),v(e.occlusionTexture)&&(r.occlusionTextureId=this._getInternalTextureId(e.occlusionTexture)),v(e.metallicRoughnessTexture)&&(r.metallicRoughnessTextureId=this._getInternalTextureId(e.metallicRoughnessTexture)),r.colorTextureTransformMatrix=Lf(e.colorTextureTransform),r.normalTextureTransformMatrix=Lf(e.normalTextureTransform),r.occlusionTextureTransformMatrix=Lf(e.occlusionTextureTransform),r.emissiveTextureTransformMatrix=Lf(e.emissiveTextureTransform),r.metallicRoughnessTextureTransformMatrix=Lf(e.metallicRoughnessTextureTransform)}_setExternalMaterialParameters(e){const r=this._drivenProperties.color;let i=v(this.symbolLayer.material)?this.symbolLayer.material.colorMixMode:null;if(r)e.externalColor=Rh;else{const s=v(this.symbolLayer.material)?this.symbolLayer.material.color:null;v(s)?e.externalColor=Ze.toUnitRGBA(s):(i=null,e.externalColor=Rh)}i&&(e.colorMixMode=i),e.castShadows=!!this.symbolLayer.castShadows}_hasTransparentVertexColors(e){const r=e.vertexAttributes.color;if(C(r))return!1;for(let i=3;i<r.length;i+=4)if(r[i]!==255)return!0;return!1}_getOrCreateMaterial(e,r){var y,_,b;const i=(y=r.material)==null?void 0:y.color,s=(_=r.material)==null?void 0:_.colorTexture,n=(b=r.material)==null?void 0:b.alphaMode,o=n==="blend",a=n!=="opaque"&&(this._hasTransparentVertexColors(e)||v(i)&&i.a<1||v(s)&&s.transparent||o),l=this._materialProperties(e,r,a),c=this._materials.get(l.uid);if(c)return c.material;const h={material:null,isComponentTransparent:a,alphaMode:r.material?r.material.alphaMode:"opaque"},p=l.metallicRoughnessTexture==null&&l.metallic==null&&l.roughness==null,f={usePBR:this._usePBR(),isSchematic:p,hasVertexColors:l.hasVertexColors,hasSymbolColors:l.hasSymbolVertexColors,hasVertexTangents:l.hasVertexTangents,ambient:ma,diffuse:Nf,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:Ti.None,layerOpacity:this._getLayerOpacity(),hasSlicePlane:this._context.slicePlaneEnabled,initTextureTransparent:!0};p||(f.mrrFactors=[l.metallic!=null?l.metallic:1,l.roughness!=null?l.roughness:1,.5]),r.material&&(f.doubleSided=r.material.doubleSided,f.cullFace=r.material.doubleSided?Ti.None:Ti.Back,f.textureAlphaCutoff=r.material.alphaCutoff),this._setExternalMaterialParameters(f),this._setMaterialTransparentParameter(f,h),this._setInternalMaterialParameters(l,f);const m=new oy(f);return h.material=m,this._materials.set(l.uid,h),this._context.stage.add(m),m}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTransparentParameter(e,r){e.transparent=this.needsDrivenTransparentPass||r.isComponentTransparent||e.layerOpacity<1||e.opacity<1||e.externalColor&&e.externalColor[3]<1,r.alphaMode==="auto"?e.textureAlphaMode=e.transparent?ui.MaskBlend:ui.Opaque:e.textureAlphaMode=r.alphaMode==="opaque"?ui.Opaque:r.alphaMode==="mask"?ui.Mask:ui.Blend}_addDebugNormals(e,r){const i=r.length,s=e.spatialReference.isGeographic?20015077/180:1,n=.1*Math.max(e.extent.width*s,e.extent.height*s,e.extent.zmax-e.extent.zmin),o=[],a=[],l=[],c=[];for(let m=0;m<i;m++){const y=r[m],_=y.vertexAttributes.get(A.POSITION),b=y.vertexAttributes.get(A.NORMAL),x=y.indices.get(A.POSITION),T=y.indices.get(A.NORMAL),S=_.data,E=b.data;for(let O=0;O<x.length;O++){const R=3*x[O],L=3*T[O];for(let P=0;P<3;P++)o.push(S[R+P]);for(let P=0;P<3;P++)o.push(S[R+P]+E[L+P]*n);if(a.push(a.length),a.push(a.length),O%3==0){this._calculateFaceNormal(S,x,O,jx),this._getFaceVertices(S,x,O,Uo,zx,Gx),fe(Uo,Uo,zx),fe(Uo,Uo,Gx),ae(Uo,Uo,1/3);for(let P=0;P<3;P++)l.push(Uo[P]);for(let P=0;P<3;P++)l.push(Uo[P]+jx[P]*n);c.push(c.length),c.push(c.length)}}}const h=r[0].transformation,p=new nn(this._debugVertexNormalMaterial,[[A.POSITION,new Xe(o,3,!0)]],[[A.POSITION,a]],null,$s.Line);r.push(p),p.transformation=h;const f=new nn(this._debugFaceNormalMaterial,[[A.POSITION,new Xe(l,3,!0)]],[[A.POSITION,c]],null,$s.Line);f.transformation=h,r.push(f)}_createAs3DShape(e,r,i,s){const n=e.geometry;if(n.type!=="mesh")return null;const o=this._createGeometryInfo(n,r,s);if(C(o))return null;const{geometries:a,objectTransformation:l}=o;qr.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(n,a);const c=new Ty({geometries:a,metadata:{layerUid:this._context.layer.uid,graphicUid:s}});c.transformation=l;const h=oTe(this.symbolLayer,{opacity:this._getLayerOpacity()}),p=v(h)?new Rit(a[0].material,[h],{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}):null,f=new xm(this,c,a,null,null,SO,i,p);f.needsElevationUpdates=lv(i.mode),f.useObjectOriginAsAttachmentOrigin=!0,i.centerPointInElevationSR=this._getCenterPointInElevationSR(c);const{elevationProvider:m,renderCoordsHelper:y}=this._context,_=(b,x)=>WE(b,m,i,y,x);return f.alignedSampledElevation=SO(f,i,m.spatialReference,_,y),f}_getCenterPointInElevationSR(e){const r=xy(0,0,0,v(this._context.elevationProvider.spatialReference)?this._context.elevationProvider.spatialReference:null);return yfe([e.transformation[12],e.transformation[13],e.transformation[14]],this._context.renderCoordsHelper.spatialReference,r),r}_createComponentNormals(e,r,i,s){switch(i.shading||"flat"){default:case"source":return this._createComponentNormalsSource(e,r,i,s);case"flat":return this._createComponentNormalsFlat(e,s);case"smooth":return this._createComponentNormalsSmooth(e,s)}}_createComponentNormalsSource(e,r,i,s){if(C(r))return this._createComponentNormalsFlat(e,s);let n=!1;if(!i.trustSourceNormals)for(let o=0;o<s.length;o+=3){this._calculateFaceNormal(e,s,o,jx);for(let a=0;a<3;a++){const l=3*s[o+a];Uo[0]=r[l+0],Uo[1]=r[l+1],Uo[2]=r[l+2],ye(jx,Uo)<0&&(r[l+0]=-r[l+0],r[l+1]=-r[l+1],r[l+2]=-r[l+2],n=!0)}}return new L9(r,s,n)}_createComponentNormalsFlat(e,r){const i=Ws(r.length),s=new Array(3*r.length);for(let n=0;n<r.length;n+=3){const o=this._calculateFaceNormal(e,r,n,jx);for(let a=0;a<3;a++)i[n+a]=o[a],s[n+a]=n/3}return new L9(i,s,!1)}_createComponentNormalsSmooth(e,r){const i={};for(let o=0;o<r.length;o+=3){const a=this._calculateFaceNormal(e,r,o,jx);for(let l=0;l<3;l++){const c=r[o+l];let h=i[c];h||(h={normal:M(),count:0},i[c]=h),fe(h.normal,h.normal,a),h.count++}}const s=Ws(3*r.length),n=new Array(3*r.length);for(let o=0;o<r.length;o++){const a=i[r[o]];a.count!==1&&(_e(a.normal,a.normal),a.count=1);for(let l=0;l<3;l++)s[3*o+l]=a.normal[l];n[o]=o}return new L9(s,n,!1)}_getFaceVertices(e,r,i,s,n,o){const a=3*r[i+0],l=3*r[i+1],c=3*r[i+2];s[0]=e[a+0],s[1]=e[a+1],s[2]=e[a+2],n[0]=e[l+0],n[1]=e[l+1],n[2]=e[l+2],o[0]=e[c+0],o[1]=e[c+1],o[2]=e[c+2]}_calculateFaceNormal(e,r,i,s){return this._getFaceVertices(e,r,i,Uo,zx,Gx),me(zx,zx,Uo),me(Gx,Gx,Uo),pt(Uo,zx,Gx),_e(s,Uo),s}_getOrCreateComponents(e){return It(e.components,dlt)}_createPositionBuffer(e,r){let i=e.vertexAttributes.position;const s=r.reprojection===ou.ECEF?r.transformBeforeProject:null;if(v(s)&&(i=Zat(i,new Float64Array(i.length),s)),r.reprojection===ou.NONE)return r.needsBufferCopy?new Float64Array(i):i;const n=v(s)?i:new Float64Array(i.length);return _s(i,e.spatialReference,0,n,this._context.renderCoordsHelper.spatialReference,0,i.length/3),n}_createNormalBuffer(e,r,i){let s=e.vertexAttributes.normal;if(C(s))return null;const n=i.reprojection===ou.ECEF?i.transformBeforeProject:null;if(v(n)&&(s=Jat(s,new Float32Array(s.length),n)),this._context.graphicsCoreOwner.view.viewingMode==="local"||i.reprojection===ou.NONE)return i.needsBufferCopy&&e.vertexAttributes.normal===s?new Float32Array(s):s;const o=e.vertexAttributes.position,a=v(n)?s:new Float32Array(s.length);return Yat(s,o,r,e.spatialReference,a)}_createTangentBuffer(e,r,i){let s=e.vertexAttributes.tangent;if(C(s))return null;const n=i.reprojection===ou.ECEF?i.transformBeforeProject:null;if(v(n)&&(s=Kat(s,new Float32Array(s.length),n)),this._context.graphicsCoreOwner.view.viewingMode==="local"||i.reprojection===ou.NONE)return i.needsBufferCopy&&e.vertexAttributes.normal===s?new Float32Array(s):s;const o=e.vertexAttributes.position,a=v(n)?s:new Float32Array(s.length);return Qat(s,o,r,e.spatialReference,a)}_createColorBuffer(e){return e.vertexAttributes.color}_createSymbolColorBuffer(e){if(this._requiresSymbolVertexColors()){const r=this._getVertexOpacityAndColor(e),i=lot(Dn(this.symbolLayer,"material","colorMixMode")),s=new Uint8Array(4);return v2e(r,i,s),s}return null}_createBuffers(e,r){const i=e.vertexAttributes&&e.vertexAttributes.position;if(!i)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const s=e.vertexAttributes.normal,n=e.vertexAttributes.uv,o=e.vertexAttributes.tangent;if(v(s)&&s.length!==i.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(v(o)&&o.length/4!=i.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(v(n)&&n.length/2!=i.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const a=this._computeReprojectionInfo(e),l=this._createPositionBuffer(e,a),c=this._createColorBuffer(e),h=this._createSymbolColorBuffer(r),p=this._createNormalBuffer(e,l,a),f=this._createTangentBuffer(e,l,a);return{positionBuffer:l,normalBuffer:p,tangentBuffer:f,uvBuffer:n,colorBuffer:c,symbolColorBuffer:h,objectTransformation:a.reprojection===ou.NONE&&v(a.objectTransformation)?a.objectTransformation:this._transformOriginLocal(e,l,p,f),geometryTransformation:a.reprojection===ou.NONE&&v(a.geometryTransformation)?a.geometryTransformation:Ie()}}_computeReprojectionInfo(e){const r=v(e.transform),i=r&&e.transform.geographic||this._context.renderCoordsHelper.viewingMode===Be.Local?ou.NONE:ou.ECEF;if(r){if(i===ou.NONE){const n=Ie();return gp(e.spatialReference,e.transform.origin,n,this._context.renderCoordsHelper.spatialReference),{reprojection:i,objectTransformation:n,geometryTransformation:FS(e.transform.localMatrix),needsBufferCopy:!1}}const s=$4(Ie(),e.transform.origin);return gs(s,s,e.transform.localMatrix),{reprojection:i,transformBeforeProject:s,needsBufferCopy:!0}}return{reprojection:i,needsBufferCopy:!0}}_transformOriginLocal(e,r,i,s){const n=this._context.renderCoordsHelper.spatialReference,o=e.anchor;YI[0]=o.x,YI[1]=o.y,YI[2]=o.z;const a=Ie();gp(e.spatialReference,YI,a,n);const l=wa.fromTypedArray(r);if(Oo(Toe,a),NM(l,l,Toe),v(i)||v(s)){if(Hh(zC,a),qh(zC,zC),v(i)){const c=Oi.fromTypedArray(i);uv(c,c,zC)}if(v(s)){const c=Oi.fromTypedArray(s,4*s.BYTES_PER_ELEMENT);uv(c,c,zC)}}return a}_validateFaces(e,r){const i=e.vertexAttributes.position.length/3,s=r.faces;if(s){let n=-1;for(let o=0;o<s.length;o++){const a=s[o];a>n&&(n=a)}if(i<=n)return this.logger.warn(`Vertex index ${n} is out of bounds of the mesh position buffer`),!1}else if(i%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0}_getOrCreateFaces(e,r){return r.faces?r.faces:tE(e.vertexAttributes.position.length/3)}_isOutsideClippingArea(e){if(!this._context.clippingExtent)return!1;const r=e.vertexAttributes&&e.vertexAttributes.position;if(!r)return!1;const i=this._context.elevationProvider.spatialReference;let s;const n=r.length/3;return v(i)&&!e.spatialReference.equals(i)?(s=new Float64Array(r.length),_s(e.vertexAttributes.position,e.spatialReference,0,s,i,0,n)):s=r,Ri(D9),Cu(D9,s,0,n),!Zd(D9,this._context.clippingExtent)}_createGeometryInfo(e,r,i){if(!yw(e.spatialReference,this._context.graphicsCoreOwner.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(e))return null;const s=this._createBuffers(e,r);if(C(s))return null;const{positionBuffer:n,uvBuffer:o,colorBuffer:a,symbolColorBuffer:l,normalBuffer:c,tangentBuffer:h,objectTransformation:p,geometryTransformation:f}=s,m=this._getOrCreateComponents(e),y=new Array;let _=!1;for(const b of m){if(!this._validateFaces(e,b))return null;const x=this._getOrCreateFaces(e,b);if(x.length===0)continue;const T=this._createComponentNormals(n,c,b,x);T.didFlipNormals&&(_=!0);const S=[[A.POSITION,new Xe(n,3,!0)],[A.NORMAL,new Xe(T.normals,3,!0)]],E=[[A.POSITION,x],[A.NORMAL,T.indices]];v(a)&&(S.push([A.COLOR,new Xe(a,4,!0)]),E.push([A.COLOR,x])),v(l)&&(S.push([A.SYMBOLCOLOR,new Xe(l,4,!0)]),E.push([A.SYMBOLCOLOR,new Array(x.length).fill(0)])),v(o)&&(S.push([A.UV0,new Xe(o,2,!0)]),E.push([A.UV0,x])),v(h)&&(S.push([A.TANGENT,new Xe(h,4,!0)]),E.push([A.TANGENT,x]));const O=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerUid:this._context.layer.uid}),R=this._getOrCreateMaterial(e,b),L=new nn(R,S,E,null,$s.Mesh,O);L.transformation=f,y.push(L)}return _&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:y,objectTransformation:p}}}let L9=class{constructor(e,r,i){this.normals=e,this.indices=r,this.didFlipNormals=i}};const YI=M(),Uo=M(),zx=M(),Gx=M(),jx=M(),Toe=Ie(),zC=es(),D9=En(),dlt=[new Xat];var ou;(function(t){t[t.NONE=0]="NONE",t[t.ECEF=1]="ECEF"})(ou||(ou={}));let plt=class{constructor(e,r,i,s){this.graphics3DSymbolLayer=e,this.instanceIndex=r,this.elevationAligner=i,this.elevationContext=s,this.type="lod-instance",this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}initialize(){}setVisibility(e){const r=this._lodRenderer.instanceData;e!==r.getVisible(this.instanceIndex)&&r.setVisible(this.instanceIndex,e)}destroy(){this.instanceIndex!=null&&(this._lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(e,r,i){if(this.elevationAligner){CZ(this.elevationContext.featureExpressionInfoContext,i);const s=(o,a)=>WE(o,e,this.elevationContext,r,a),n=this.elevationAligner(this,this.elevationContext,e.spatialReference,s,r);v(n)&&(this.alignedSampledElevation=n)}}getCenterObjectSpace(e=M()){return this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,Vp),We(e,this._lodRenderer.baseBoundingSphere.center,Vp)}getBoundingBoxObjectSpace(e=En()){this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,Vp);const r=this._lodRenderer.baseBoundingBox;Ri(e);for(let i=0;i<8;++i)ce(qu,1&i?r[3]:r[0],2&i?r[4]:r[1],4&i?r[5]:r[2]),We(qu,qu,Vp),lm(e,qu);return e}computeAttachmentOrigin(e){this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,Vp),e.render.origin[0]+=Vp[12],e.render.origin[1]+=Vp[13],e.render.origin[2]+=Vp[14],e.render.num++}async getProjectedBoundingBox(e,r,i,s,n){const o=this.getBoundingBoxObjectSpace(n),a=flt,l=nW(o)?1:a.length;this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,Vp);for(let h=0;h<l;h++){const p=a[h];qu[0]=o[p[0]],qu[1]=o[p[1]],qu[2]=o[p[2]],We(qu,qu,Vp),Qv[3*h+0]=qu[0],Qv[3*h+1]=qu[1],Qv[3*h+2]=qu[2]}if(!e(Qv,0,l))return null;Ri(o);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let h=0;h<3*l;h+=3){for(let p=0;p<3;p++)o[p]=Math.min(o[p],Qv[h+p]),o[p+3]=Math.max(o[p+3],Qv[h+p]);c&&i.push({location:Qv.slice(h,h+3),screenSpaceBoundingRect:c})}if(r&&(Yd(o,N9),this.elevationContext.mode!=="absolute-height")){let h;const p=TZ(o,r.service.spatialReference,r);try{h=await r.service.queryElevation(N9[0],N9[1],s,p,"ground")}catch{}v(h)&&ppe(o,0,0,-this.alignedSampledElevation+h)}return o}addObjectState(e,r){if(e===ry.Highlight){const i=new nF(e);this._addHighlightId(i),r.addExternal(s=>{this._removeHighlightId(s)},i)}}removeObjectState(e){this._highlights.forEach(r=>e.remove(r))}_addHighlightId(e){this._highlights.add(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}_removeHighlightId(e){this._highlights.delete(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,this._highlights.size>0)}get _lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}};const Qv=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],qu=M(),N9=M(),flt=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],Vp=Ie();function mlt(t){const e=new Array;return t.stageResources.geometries.forEach(r=>{const i=t.stageResources.textures;e.push(new iTe(r,i))}),{components:e,minScreenSpaceRadius:It(t.lodThreshold,0),pivotOffset:t.pivotOffset}}function glt(t){return{levels:t.map(e=>mlt(e))}}function ylt(t,e,r){if(t.count!==e.count)return void X5.error("source and destination buffers need to have the same number of elements");const i=t.count,s=r[0],n=r[1],o=r[2],a=r[3],l=r[4],c=r[5],h=r[6],p=r[7],f=r[8],m=r[9],y=r[10],_=r[11],b=r[12],x=r[13],T=r[14],S=r[15],E=t.typedBuffer,O=t.typedBufferStride,R=e.typedBuffer,L=e.typedBufferStride;for(let P=0;P<i;P++){const U=P*O,B=P*L,z=R[B],G=R[B+1],K=R[B+2],ee=R[B+3];E[U]=s*z+l*G+f*K+b*ee,E[U+1]=n*z+c*G+m*K+x*ee,E[U+2]=o*z+h*G+y*K+T*ee,E[U+3]=a*z+p*G+_*K+S*ee}}function Z2e(t,e,r){if(t.count!==e.count)return void X5.error("source and destination buffers need to have the same number of elements");const i=t.count,s=r[0],n=r[1],o=r[2],a=r[3],l=r[4],c=r[5],h=r[6],p=r[7],f=r[8],m=t.typedBuffer,y=t.typedBufferStride,_=e.typedBuffer,b=e.typedBufferStride;for(let x=0;x<i;x++){const T=x*y,S=x*b,E=_[S],O=_[S+1],R=_[S+2],L=_[S+3];m[T]=s*E+a*O+h*R,m[T+1]=n*E+l*O+p*R,m[T+2]=o*E+c*O+f*R,m[T+3]=L}}function _lt(t,e){const r=Math.min(t.count,e.count),i=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride;for(let a=0;a<r;a++){const l=a*s,c=a*o,h=n[c],p=n[c+1],f=n[c+2],m=h*h+p*p+f*f;if(m>0){const y=1/Math.sqrt(m);i[l]=y*h,i[l+1]=y*p,i[l+2]=y*f}}}function eH(t,e,r){const i=Math.min(t.count,e.count),s=t.typedBuffer,n=t.typedBufferStride,o=e.typedBuffer,a=e.typedBufferStride;for(let l=0;l<i;l++){const c=l*n,h=l*a;s[c]=r*o[h],s[c+1]=r*o[h+1],s[c+2]=r*o[h+2],s[c+3]=r*o[h+3]}}function vlt(t,e,r){const i=Math.min(t.count,e.count),s=t.typedBuffer,n=t.typedBufferStride,o=e.typedBuffer,a=e.typedBufferStride;for(let l=0;l<i;l++){const c=l*n,h=l*a;s[c]=o[h]>>r,s[c+1]=o[h+1]>>r,s[c+2]=o[h+2]>>r,s[c+3]=o[h+3]>>r}}Object.freeze(Object.defineProperty({__proto__:null,normalize:_lt,scale:eH,shiftRight:vlt,transformMat3:Z2e,transformMat4:ylt},Symbol.toStringTag,{value:"Module"}));function blt(t,e,r){const i=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride,a=r?r.count:e.count;let l=(r&&r.dstIndex?r.dstIndex:0)*s,c=(r&&r.srcIndex?r.srcIndex:0)*o;for(let h=0;h<a;++h){for(let p=0;p<9;++p)i[l+p]=n[c+p];l+=s,c+=o}}Object.freeze(Object.defineProperty({__proto__:null,copy:blt},Symbol.toStringTag,{value:"Module"}));function wlt(t,e,r){const i=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride,a=r?r.count:e.count;let l=(r&&r.dstIndex?r.dstIndex:0)*s,c=(r&&r.srcIndex?r.srcIndex:0)*o;for(let h=0;h<a;++h){for(let p=0;p<16;++p)i[l+p]=n[c+p];l+=s,c+=o}}Object.freeze(Object.defineProperty({__proto__:null,copy:wlt},Symbol.toStringTag,{value:"Module"}));function xlt(t,e,r){const i=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride,a=r?r.count:e.count;let l=(r&&r.dstIndex?r.dstIndex:0)*s,c=(r&&r.srcIndex?r.srcIndex:0)*o;for(let h=0;h<a;++h)i[l]=n[c],l+=s,c+=o}function _D(t,e){const r=t.count;e||(e=new t.TypedArrayConstructor(r));for(let i=0;i<r;i++)e[i]=t.get(i);return e}Object.freeze(Object.defineProperty({__proto__:null,copy:xlt,makeDense:_D},Symbol.toStringTag,{value:"Module"}));function J2e(t,e,r){const i=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride,a=r?r.count:e.count;let l=(r&&r.dstIndex?r.dstIndex:0)*s,c=(r&&r.srcIndex?r.srcIndex:0)*o;for(let h=0;h<a;++h)i[l]=n[c],i[l+1]=n[c+1],l+=s,c+=o}function K2e(t,e,r){const i=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride,a=r?r.count:e.count;let l=(r&&r.dstIndex?r.dstIndex:0)*s,c=(r&&r.srcIndex?r.srcIndex:0)*o;if(zXe(e.elementType)){const h=GXe(e.elementType);if(BXe(e.elementType))for(let p=0;p<a;++p)i[l]=Math.max(n[c]/h,-1),i[l+1]=Math.max(n[c+1]/h,-1),l+=s,c+=o;else for(let p=0;p<a;++p)i[l]=n[c]/h,i[l+1]=n[c+1]/h,l+=s,c+=o}else J2e(t,e,r);return t}function Tlt(t,e,r,i){const s=t.typedBuffer,n=t.typedBufferStride,o=(i==null?void 0:i.count)??t.count;let a=((i==null?void 0:i.dstIndex)??0)*n;for(let l=0;l<o;++l)s[a]=e,s[a+1]=r,a+=n}Object.freeze(Object.defineProperty({__proto__:null,copy:J2e,fill:Tlt,normalizeIntegerBuffer:K2e},Symbol.toStringTag,{value:"Module"}));function n6(t,e,r){const i=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride,a=r?r.count:e.count;let l=(r&&r.dstIndex?r.dstIndex:0)*s,c=(r&&r.srcIndex?r.srcIndex:0)*o;for(let h=0;h<a;++h)i[l]=n[c],i[l+1]=n[c+1],i[l+2]=n[c+2],l+=s,c+=o}function Slt(t,e,r,i,s){const n=t.typedBuffer,o=t.typedBufferStride,a=(s==null?void 0:s.count)??t.count;let l=((s==null?void 0:s.dstIndex)??0)*o;for(let c=0;c<a;++c)n[l]=e,n[l+1]=r,n[l+2]=i,l+=o}Object.freeze(Object.defineProperty({__proto__:null,copy:n6,fill:Slt},Symbol.toStringTag,{value:"Module"}));function Q2e(t,e,r){const i=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride,a=r?r.count:e.count;let l=(r&&r.dstIndex?r.dstIndex:0)*s,c=(r&&r.srcIndex?r.srcIndex:0)*o;for(let h=0;h<a;++h)i[l]=n[c],i[l+1]=n[c+1],i[l+2]=n[c+2],i[l+3]=n[c+3],l+=s,c+=o}function eSe(t,e,r,i,s,n){const o=t.typedBuffer,a=t.typedBufferStride,l=(n==null?void 0:n.count)??t.count;let c=((n==null?void 0:n.dstIndex)??0)*a;for(let h=0;h<l;++h)o[c]=e,o[c+1]=r,o[c+2]=i,o[c+3]=s,c+=a}Object.freeze(Object.defineProperty({__proto__:null,copy:Q2e,fill:eSe},Symbol.toStringTag,{value:"Module"}));function Ab(t,e){return new t(new ArrayBuffer(e*t.ElementCount*Q1e(t.ElementType)))}let tSe=class{constructor(e){this._streamDataRequester=e}async loadJSON(e,r){return this._load("json",e,r)}async loadBinary(e,r){return pm(e)?(fr(r),hq(e)):this._load("binary",e,r)}async loadImage(e,r){return this._load("image",e,r)}async _load(e,r,i){if(C(this._streamDataRequester))return(await Ni(r,{responseType:Elt[e]})).data;const s=await hp(this._streamDataRequester.request(r,e,i));if(s.ok===!0)return s.value;throw xc(s.error),new q("",`Request for resource failed: ${s.error}`)}};const Elt={image:"image",binary:"array-buffer",json:"json"};function Clt(t={}){return{color:[1,1,1],opacity:1,alphaMode:"OPAQUE",alphaCutoff:.5,doubleSided:!1,castShadows:!0,receiveShadows:!0,receiveAmbientOcclustion:!0,textureColor:null,textureNormal:null,textureOcclusion:null,textureEmissive:null,textureMetallicRoughness:null,colorTextureTransform:null,normalTextureTransform:null,occlusionTextureTransform:null,emissiveTextureTransform:null,metallicRoughnessTextureTransform:null,emissiveFactor:[0,0,0],metallicFactor:1,roughnessFactor:1,colorMixMode:"multiply",...t}}function Alt(t,e={}){return{data:t,parameters:{wrap:{s:Rt.REPEAT,t:Rt.REPEAT,...e.wrap},noUnpackFlip:!0,mipmap:!1,...e}}}let hE=class{constructor(e,r,i=""){this.major=e,this.minor=r,this._context=i}lessThan(e,r){return this.major<e||e===this.major&&this.minor<r}since(e,r){return!this.lessThan(e,r)}validate(e){if(this.major!==e.major){const r=this._context&&this._context+":",i=this._context&&this._context+" ";throw new q(r+"unsupported-version",`Required major ${i}version is '${this.major}', but got '\${version.major}.\${version.minor}'`,{version:e})}}clone(){return new hE(this.major,this.minor,this._context)}static parse(e,r=""){const[i,s]=e.split("."),n=/^\s*\d+\s*$/;if(!i||!i.match||!i.match(n))throw new q((r&&r+":")+"invalid-version","Expected major version to be a number, but got '${version}'",{version:e});if(!s||!s.match||!s.match(n))throw new q((r&&r+":")+"invalid-version","Expected minor version to be a number, but got '${version}'",{version:e});const o=parseInt(i,10),a=parseInt(s,10);return new hE(o,a,r)}},Soe=class{constructor(e){this._data=e,this._offset4=0,this._dataUint32=new Uint32Array(this._data,0,Math.floor(this._data.byteLength/4))}readUint32(){const e=this._offset4;return this._offset4+=1,this._dataUint32[e]}readUint8Array(e){const r=4*this._offset4;return this._offset4+=e/4,new Uint8Array(this._data,r,e)}remainingBytes(){return this._data.byteLength-4*this._offset4}};var SR,Eoe;(function(t){t.SCALAR="SCALAR",t.VEC2="VEC2",t.VEC3="VEC3",t.VEC4="VEC4",t.MAT2="MAT2",t.MAT3="MAT3",t.MAT4="MAT4"})(SR||(SR={})),function(t){t[t.ARRAY_BUFFER=34962]="ARRAY_BUFFER",t[t.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER"}(Eoe||(Eoe={}));const rSe={baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1},Rlt={pbrMetallicRoughness:rSe,emissiveFactor:[0,0,0],alphaMode:"OPAQUE",alphaCutoff:.5,doubleSided:!1},Olt={ESRI_externalColorMixMode:"tint"},Coe=(t={})=>{const e={...rSe,...t.pbrMetallicRoughness},r=Mlt({...Olt,...t.extras});return{...Rlt,...t,pbrMetallicRoughness:e,extras:r}};function Mlt(t){switch(t.ESRI_externalColorMixMode){case"multiply":case"tint":case"ignore":case"replace":break;default:t.ESRI_externalColorMixMode,t.ESRI_externalColorMixMode="tint"}return t}const Plt={magFilter:tt.LINEAR,minFilter:tt.LINEAR_MIPMAP_LINEAR,wrapS:Rt.REPEAT,wrapT:Rt.REPEAT},Ilt=t=>({...Plt,...t});function $lt(t){let e,r;return t.replace(/^(.*\/)?([^/]*)$/,(i,s,n)=>(e=s||"",r=n||"","")),{dirPart:e,filePart:r}}const ZI={MAGIC:1179937895,CHUNK_TYPE_JSON:1313821514,CHUNK_TYPE_BIN:5130562,MIN_HEADER_LENGTH:20};let Llt=class H0{constructor(e,r,i,s){if(this._context=e,this.uri=r,this.json=i,this._glbBuffer=s,this._bufferLoaders=new Map,this._textureLoaders=new Map,this._textureCache=new Map,this._materialCache=new Map,this._nodeParentMap=new Map,this._nodeTransformCache=new Map,this._supportedExtensions=["KHR_texture_basisu"],this._baseUri=$lt(this.uri).dirPart,this._checkVersionSupported(),this._checkRequiredExtensionsSupported(),i.scenes==null)throw new q("gltf-loader-unsupported-feature","Scenes must be defined.");if(i.meshes==null)throw new q("gltf-loader-unsupported-feature","Meshes must be defined");if(i.nodes==null)throw new q("gltf-loader-unsupported-feature","Nodes must be defined.");this._computeNodeParents()}static async load(e,r,i){if(pm(r)){const o=ZO(r);if(o&&o.mediaType!=="model/gltf-binary")try{const l=JSON.parse(o.isBase64?atob(o.data):o.data);return new H0(e,r,l)}catch{}const a=hq(r);if(H0._isGLBData(a))return this._fromGLBData(e,r,a)}if(r.endsWith(".gltf")){const o=await e.loadJSON(r,i);return new H0(e,r,o)}const s=await e.loadBinary(r,i);if(H0._isGLBData(s))return this._fromGLBData(e,r,s);const n=await e.loadJSON(r,i);return new H0(e,r,n)}static _isGLBData(e){if(e==null)return!1;const r=new Soe(e);return r.remainingBytes()>=4&&r.readUint32()===ZI.MAGIC}static async _fromGLBData(e,r,i){const s=await H0._parseGLBData(i);return new H0(e,r,s.json,s.binaryData)}static async _parseGLBData(e){const r=new Soe(e);if(r.remainingBytes()<12)throw new q("gltf-loader-error","GLB binary data is insufficiently large.");const i=r.readUint32(),s=r.readUint32(),n=r.readUint32();if(i!==ZI.MAGIC)throw new q("gltf-loader-error","Magic first 4 bytes do not fit to expected GLB value.");if(e.byteLength<n)throw new q("gltf-loader-error","GLB binary data is smaller than header specifies.");if(s!==2)throw new q("gltf-loader-unsupported-feature","An unsupported GLB container version was detected. Only version 2 is supported.");let o,a,l=0;for(;r.remainingBytes()>=8;){const c=r.readUint32(),h=r.readUint32();if(l===0){if(h!==ZI.CHUNK_TYPE_JSON)throw new q("gltf-loader-error","First GLB chunk must be JSON.");if(c<0)throw new q("gltf-loader-error","No JSON data found.");o=await tlt(r.readUint8Array(c))}else if(l===1){if(h!==ZI.CHUNK_TYPE_BIN)throw new q("gltf-loader-unsupported-feature","Second GLB chunk expected to be BIN.");a=r.readUint8Array(c)}else se.getLogger("esri.views.3d.glTF").warn("[Unsupported Feature] More than 2 GLB chunks detected. Skipping.");l+=1}if(!o)throw new q("gltf-loader-error","No GLB JSON chunk detected.");return{json:o,binaryData:a}}async getBuffer(e,r){const i=this.json.buffers[e];if(i.uri==null){if(this._glbBuffer==null)throw new q("gltf-loader-error","GLB buffer not present");return this._glbBuffer}const s=await this._getBufferLoader(e,r);if(s.byteLength!==i.byteLength)throw new q("gltf-loader-error","Buffer byte lengths should match.");return s}async _getBufferLoader(e,r){const i=this._bufferLoaders.get(e);if(i)return i;const s=this.json.buffers[e].uri,n=this._context.loadBinary(this._resolveUri(s),r).then(o=>new Uint8Array(o));return this._bufferLoaders.set(e,n),n}async getAccessor(e,r){if(!this.json.accessors)throw new q("gltf-loader-unsupported-feature","Accessors missing.");const i=this.json.accessors[e];if((i==null?void 0:i.bufferView)==null)throw new q("gltf-loader-unsupported-feature","Some accessor does not specify a bufferView.");if(i.type in[SR.MAT2,SR.MAT3,SR.MAT4])throw new q("gltf-loader-unsupported-feature",`AttributeType ${i.type} is not supported`);const s=this.json.bufferViews[i.bufferView],n=await this.getBuffer(s.buffer,r),o=Flt[i.type],a=Ult[i.componentType],l=o*a,c=s.byteStride||l;return{raw:n.buffer,byteStride:c,byteOffset:n.byteOffset+(s.byteOffset||0)+(i.byteOffset||0),entryCount:i.count,isDenselyPacked:c===l,componentCount:o,componentByteSize:a,componentType:i.componentType,min:i.min,max:i.max,normalized:!!i.normalized}}async getIndexData(e,r){if(e.indices==null)return;const i=await this.getAccessor(e.indices,r);if(i.isDenselyPacked)switch(i.componentType){case lt.UNSIGNED_BYTE:return new Uint8Array(i.raw,i.byteOffset,i.entryCount);case lt.UNSIGNED_SHORT:return new Uint16Array(i.raw,i.byteOffset,i.entryCount);case lt.UNSIGNED_INT:return new Uint32Array(i.raw,i.byteOffset,i.entryCount)}else switch(i.componentType){case lt.UNSIGNED_BYTE:return _D(this._wrapAccessor(eE,i));case lt.UNSIGNED_SHORT:return _D(this._wrapAccessor(T5,i));case lt.UNSIGNED_INT:return _D(this._wrapAccessor(E5,i))}}async getPositionData(e,r){if(e.attributes.POSITION==null)throw new q("gltf-loader-unsupported-feature","No POSITION vertex data found.");const i=await this.getAccessor(e.attributes.POSITION,r);if(i.componentType!==lt.FLOAT)throw new q("gltf-loader-unsupported-feature","Expected type FLOAT for POSITION vertex attribute, but found "+lt[i.componentType]);if(i.componentCount!==3)throw new q("gltf-loader-unsupported-feature","POSITION vertex attribute must have 3 components, but found "+i.componentCount.toFixed());return this._wrapAccessor(Oi,i)}async getNormalData(e,r){if(e.attributes.NORMAL==null)throw new q("gltf-loader-error","No NORMAL vertex data found.");const i=await this.getAccessor(e.attributes.NORMAL,r);if(i.componentType!==lt.FLOAT)throw new q("gltf-loader-unsupported-feature","Expected type FLOAT for NORMAL vertex attribute, but found "+lt[i.componentType]);if(i.componentCount!==3)throw new q("gltf-loader-unsupported-feature","NORMAL vertex attribute must have 3 components, but found "+i.componentCount.toFixed());return this._wrapAccessor(Oi,i)}async getTangentData(e,r){if(e.attributes.TANGENT==null)throw new q("gltf-loader-error","No TANGENT vertex data found.");const i=await this.getAccessor(e.attributes.TANGENT,r);if(i.componentType!==lt.FLOAT)throw new q("gltf-loader-unsupported-feature","Expected type FLOAT for TANGENT vertex attribute, but found "+lt[i.componentType]);if(i.componentCount!==4)throw new q("gltf-loader-unsupported-feature","TANGENT vertex attribute must have 4 components, but found "+i.componentCount.toFixed());return new Nc(i.raw,i.byteOffset,i.byteStride,i.byteOffset+i.byteStride*i.entryCount)}async getTextureCoordinates(e,r){if(e.attributes.TEXCOORD_0==null)throw new q("gltf-loader-error","No TEXCOORD_0 vertex data found.");const i=await this.getAccessor(e.attributes.TEXCOORD_0,r);if(i.componentCount!==2)throw new q("gltf-loader-unsupported-feature","TEXCOORD_0 vertex attribute must have 2 components, but found "+i.componentCount.toFixed());if(i.componentType===lt.FLOAT)return this._wrapAccessor(vy,i);if(!i.normalized)throw new q("gltf-loader-unsupported-feature","Integer component types are only supported for a normalized accessor for TEXCOORD_0.");return klt(i)}async getVertexColors(e,r){if(e.attributes.COLOR_0==null)throw new q("gltf-loader-error","No COLOR_0 vertex data found.");const i=await this.getAccessor(e.attributes.COLOR_0,r);if(i.componentCount!==4&&i.componentCount!==3)throw new q("gltf-loader-unsupported-feature","COLOR_0 attribute must have 3 or 4 components, but found "+i.componentCount.toFixed());if(i.componentCount===4){if(i.componentType===lt.FLOAT)return this._wrapAccessor(Nc,i);if(i.componentType===lt.UNSIGNED_BYTE)return this._wrapAccessor(xa,i);if(i.componentType===lt.UNSIGNED_SHORT)return this._wrapAccessor(AM,i)}else if(i.componentCount===3){if(i.componentType===lt.FLOAT)return this._wrapAccessor(Oi,i);if(i.componentType===lt.UNSIGNED_BYTE)return this._wrapAccessor(mO,i);if(i.componentType===lt.UNSIGNED_SHORT)return this._wrapAccessor(S5,i)}throw new q("gltf-loader-unsupported-feature","Unsupported component type for COLOR_0 attribute: "+lt[i.componentType])}hasPositions(e){return e.attributes.POSITION!==void 0}hasNormals(e){return e.attributes.NORMAL!==void 0}hasVertexColors(e){return e.attributes.COLOR_0!==void 0}hasTextureCoordinates(e){return e.attributes.TEXCOORD_0!==void 0}hasTangents(e){return e.attributes.TANGENT!==void 0}async getMaterial(e,r,i){var n,o,a,l,c,h,p,f,m,y;let s=e.material?this._materialCache.get(e.material):void 0;if(!s){const _=e.material!=null?Coe(this.json.materials[e.material]):Coe(),b=_.pbrMetallicRoughness,x=this.hasVertexColors(e),T=this.getTexture(b.baseColorTexture,r),S=this.getTexture(_.normalTexture,r),E=i?this.getTexture(_.occlusionTexture,r):void 0,O=i?this.getTexture(_.emissiveTexture,r):void 0,R=i?this.getTexture(b.metallicRoughnessTexture,r):void 0,L=e.material!=null?e.material:-1;s={alphaMode:_.alphaMode,alphaCutoff:_.alphaCutoff,color:b.baseColorFactor,doubleSided:!!_.doubleSided,colorTexture:await T,normalTexture:await S,name:_.name,id:L,occlusionTexture:await E,emissiveTexture:await O,emissiveFactor:_.emissiveFactor,metallicFactor:b.metallicFactor,roughnessFactor:b.roughnessFactor,metallicRoughnessTexture:await R,hasVertexColors:x,ESRI_externalColorMixMode:_.extras.ESRI_externalColorMixMode,colorTextureTransform:(o=(n=b==null?void 0:b.baseColorTexture)==null?void 0:n.extensions)==null?void 0:o.KHR_texture_transform,normalTextureTransform:(l=(a=_.normalTexture)==null?void 0:a.extensions)==null?void 0:l.KHR_texture_transform,occlusionTextureTransform:(h=(c=_.occlusionTexture)==null?void 0:c.extensions)==null?void 0:h.KHR_texture_transform,emissiveTextureTransform:(f=(p=_.emissiveTexture)==null?void 0:p.extensions)==null?void 0:f.KHR_texture_transform,metallicRoughnessTextureTransform:(y=(m=b==null?void 0:b.metallicRoughnessTexture)==null?void 0:m.extensions)==null?void 0:y.KHR_texture_transform}}return s}async getTexture(e,r){if(!e)return;if((e.texCoord||0)!==0)throw new q("gltf-loader-unsupported-feature","Only TEXCOORD with index 0 is supported.");const i=e.index,s=this.json.textures[i],n=Ilt(s.sampler!=null?this.json.samplers[s.sampler]:{}),o=this._getTextureSourceId(s),a=this.json.images[o],l=await this._loadTextureImageData(i,s,r);return JH(this._textureCache,i,()=>{const c=p=>p===33071||p===33648||p===10497,h=p=>{throw new q("gltf-loader-error",`Unexpected TextureSampler WrapMode: ${p}`)};return{data:l,wrapS:c(n.wrapS)?n.wrapS:h(n.wrapS),wrapT:c(n.wrapT)?n.wrapT:h(n.wrapT),minFilter:n.minFilter,name:a.name,id:i}})}getNodeTransform(e){if(e===void 0)return Dlt;let r=this._nodeTransformCache.get(e);if(!r){const i=this.getNodeTransform(this._getNodeParent(e)),s=this.json.nodes[e];s.matrix?r=gs(Ie(),i,s.matrix):s.translation||s.rotation||s.scale?(r=FS(i),s.translation&&ql(r,r,s.translation),s.rotation&&(JI[3]=$Y(JI,s.rotation),Rc(r,r,JI[3],JI)),s.scale&&P4(r,r,s.scale)):r=FS(i),this._nodeTransformCache.set(e,r)}return r}_wrapAccessor(e,r){return new e(r.raw,r.byteOffset,r.byteStride,r.byteOffset+r.byteStride*(r.entryCount-1)+r.componentByteSize*r.componentCount)}_resolveUri(e){return wu(e,this._baseUri)}_getNodeParent(e){return this._nodeParentMap.get(e)}_checkVersionSupported(){const e=hE.parse(this.json.asset.version,"glTF");Nlt.validate(e)}_checkRequiredExtensionsSupported(){const e=this.json;if(e.extensionsRequired&&!e.extensionsRequired.every(r=>this._supportedExtensions.includes(r)))throw new q("gltf-loader-unsupported-feature","gltf loader was not able to load unsupported feature. Required extensions: "+e.extensionsRequired.join(", "))}_computeNodeParents(){this.json.nodes.forEach((e,r)=>{e.children&&e.children.forEach(i=>{this._nodeParentMap.set(i,r)})})}async _loadTextureImageData(e,r,i){const s=this._textureLoaders.get(e);if(s)return s;const n=this._createTextureLoader(r,i);return this._textureLoaders.set(e,n),n}_getTextureSourceId(e){if(e.extensions!==void 0&&e.extensions.KHR_texture_basisu!==null)return e.extensions.KHR_texture_basisu.source;if(e.source!==null)return e.source;throw new q("gltf-loader-unsupported-feature","Source is expected to be defined for a texture. It can also be omitted in favour of an KHR_texture_basisu extension tag.")}async _createTextureLoader(e,r){const i=this._getTextureSourceId(e),s=this.json.images[i];if(s.uri){if(s.uri.endsWith(".ktx2")){const l=await this._context.loadBinary(this._resolveUri(s.uri),r);return new W2e(new Uint8Array(l))}return this._context.loadImage(this._resolveUri(s.uri),r)}if(s.bufferView==null)throw new q("gltf-loader-unsupported-feature","Image bufferView must be defined.");if(s.mimeType==null)throw new q("gltf-loader-unsupported-feature","Image mimeType must be defined.");const n=this.json.bufferViews[s.bufferView],o=await this.getBuffer(n.buffer,r);if(n.byteStride!=null)throw new q("gltf-loader-unsupported-feature","byteStride not supported for image buffer");const a=o.byteOffset+(n.byteOffset||0);return rlt(new Uint8Array(o.buffer,a,n.byteLength),s.mimeType)}async getLoadedBuffersSize(){if(this._glbBuffer)return this._glbBuffer.byteLength;const e=await Bk(Array.from(this._bufferLoaders.values())),r=await Bk(Array.from(this._textureLoaders.values()));return e.reduce((i,s)=>i+((s==null?void 0:s.byteLength)??0),0)+r.reduce((i,s)=>i+(s?rw(s)?s.data.byteLength:s.width*s.height*4:0),0)}};const Dlt=Qpe(Ie(),Math.PI/2),Nlt=new hE(2,0,"glTF"),JI=Zh(),Flt={SCALAR:1,VEC2:2,VEC3:3,VEC4:4},Ult={[lt.BYTE]:1,[lt.UNSIGNED_BYTE]:1,[lt.SHORT]:2,[lt.UNSIGNED_SHORT]:2,[lt.FLOAT]:4,[lt.UNSIGNED_INT]:4};function klt(t){switch(t.componentType){case lt.BYTE:return new C5(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount);case lt.UNSIGNED_BYTE:return new x5(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount);case lt.SHORT:return new A5(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount);case lt.UNSIGNED_SHORT:return new OY(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount);case lt.UNSIGNED_INT:return new MY(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount);case lt.FLOAT:return new vy(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount)}}let Vlt=0;async function iSe(t,e,r={},i=!0){const s=await Llt.load(t,e,r),n="gltf_"+Vlt++,o={lods:[],materials:new Map,textures:new Map,meta:Blt(s)},a=!(!s.json.asset.extras||s.json.asset.extras.ESRI_type!=="symbolResource"),l=new Map;await zlt(s,async(h,p,f,m)=>{const y=l.get(f)??0;l.set(f,y+1);const _=h.mode!==void 0?h.mode:$t.TRIANGLES,b=_===$t.TRIANGLES||_===$t.TRIANGLE_STRIP||_===$t.TRIANGLE_FAN?_:null;if(C(b))return void se.getLogger("esri.views.3d.glTF").warn("[Unsupported Feature] Unsupported primitive mode ("+$t[_]+"). Skipping primitive.");if(!s.hasPositions(h))return void se.getLogger("esri.views.3d.glTF").warn("Skipping primitive without POSITION vertex attribute.");const x=s.getPositionData(h,r),T=s.getMaterial(h,r,i),S=s.hasNormals(h)?s.getNormalData(h,r):null,E=s.hasTangents(h)?s.getTangentData(h,r):null,O=s.hasTextureCoordinates(h)?s.getTextureCoordinates(h,r):null,R=s.hasVertexColors(h)?s.getVertexColors(h,r):null,L=s.getIndexData(h,r),P={transform:FS(p),attributes:{position:await x,normal:S?await S:null,texCoord0:O?await O:null,color:R?await R:null,tangent:E?await E:null},indices:await L,primitiveType:b,material:jlt(o,await T,n)};let U=null;v(o.meta)&&v(o.meta.ESRI_lod)&&o.meta.ESRI_lod.metric==="screenSpaceRadius"&&(U=o.meta.ESRI_lod.thresholds[f]),o.lods[f]=o.lods[f]||{parts:[],name:m,lodThreshold:U},o.lods[f].parts[y]=P});for(const h of o.lods)h.parts=h.parts.filter(p=>!!p);const c=await s.getLoadedBuffersSize();return{model:o,meta:{isEsriSymbolResource:a,uri:s.uri},customMeta:{},size:c}}function Blt(t){const e=t.json;let r=null;return e.nodes.forEach(i=>{const s=i.extras;v(s)&&(s.ESRI_proxyEllipsoid||s.ESRI_lod)&&(r=s)}),r}async function zlt(t,e){const r=t.json,i=r.scenes[r.scene||0].nodes,s=i.length>1,n=[];for(const a of i){const l=r.nodes[a];n.push(o(a,0)),Glt(l)&&!s&&l.extensions.MSFT_lod.ids.forEach((c,h)=>o(c,h+1))}async function o(a,l){const c=r.nodes[a],h=t.getNodeTransform(a);if(c.weights!=null&&se.getLogger("esri.views.3d.glTF").warn("[Unsupported Feature] Morph targets are not supported."),c.mesh!=null){const p=r.meshes[c.mesh];for(const f of p.primitives)n.push(e(f,h,l,p.name))}for(const p of c.children||[])n.push(o(p,l))}await Promise.all(n)}function Glt(t){return t.extensions&&t.extensions.MSFT_lod&&Array.isArray(t.extensions.MSFT_lod.ids)}function jlt(t,e,r){const i=n=>{const o=`${r}_tex_${n&&n.id}${n&&n.name?"_"+n.name:""}`;if(n&&!t.textures.has(o)){const a=Alt(n.data,{wrap:{s:n.wrapS,t:n.wrapT},mipmap:Hlt.includes(n.minFilter),noUnpackFlip:!0});t.textures.set(o,a)}return o},s=`${r}_mat_${e.id}_${e.name}`;if(!t.materials.has(s)){const n=Clt({color:[e.color[0],e.color[1],e.color[2]],opacity:e.color[3],alphaMode:e.alphaMode,alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,colorMixMode:e.ESRI_externalColorMixMode,textureColor:e.colorTexture?i(e.colorTexture):void 0,textureNormal:e.normalTexture?i(e.normalTexture):void 0,textureOcclusion:e.occlusionTexture?i(e.occlusionTexture):void 0,textureEmissive:e.emissiveTexture?i(e.emissiveTexture):void 0,textureMetallicRoughness:e.metallicRoughnessTexture?i(e.metallicRoughnessTexture):void 0,emissiveFactor:[e.emissiveFactor[0],e.emissiveFactor[1],e.emissiveFactor[2]],colorTextureTransform:e.colorTextureTransform,normalTextureTransform:e.normalTextureTransform,occlusionTextureTransform:e.occlusionTextureTransform,emissiveTextureTransform:e.emissiveTextureTransform,metallicRoughnessTextureTransform:e.metallicRoughnessTextureTransform,metallicFactor:e.metallicFactor,roughnessFactor:e.roughnessFactor});t.materials.set(s,n)}return s}const Hlt=[tt.LINEAR_MIPMAP_LINEAR,tt.LINEAR_MIPMAP_NEAREST];function qlt(t,e=tE){return typeof t=="number"?e(t):VH(t)||pb(t)?new Uint32Array(t):t}function Wlt(t){const e=typeof t=="number"?t:t.length;if(e<3)return[];const r=e-2,i=nbe(r);if(typeof t=="number"){let s=0;for(let n=0;n<r;n+=1)n%2==0?(i[s++]=n,i[s++]=n+1,i[s++]=n+2):(i[s++]=n+1,i[s++]=n,i[s++]=n+2)}else{let s=0;for(let n=0;n<r;n+=1)if(n%2==0){const o=t[n],a=t[n+1],l=t[n+2];i[s++]=o,i[s++]=a,i[s++]=l}else{const o=t[n+1],a=t[n],l=t[n+2];i[s++]=o,i[s++]=a,i[s++]=l}}return i}function Xlt(t){const e=typeof t=="number"?t:t.length;if(e<3)return new Uint16Array(0);const r=e-2,i=r<=65536?new Uint16Array(3*r):new Uint32Array(3*r);if(typeof t=="number"){let s=0;for(let n=0;n<r;++n)i[s++]=0,i[s++]=n+1,i[s++]=n+2;return i}{const s=t[0];let n=t[1],o=0;for(let a=0;a<r;++a){const l=t[a+2];i[o++]=s,i[o++]=n,i[o++]=l,n=l}return i}}let Ylt=class{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}},Zlt=class{constructor(e,r,i){this.name=e,this.lodThreshold=r,this.pivotOffset=i,this.stageResources=new Ylt,this.numberOfVertices=0}};const mg=se.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");async function sSe(t,e){const r=await Jlt(t,e),i=await rct(r.textureDefinitions??{},e);let s=0;for(const n in i)if(i.hasOwnProperty(n)){const o=i[n];s+=o!=null&&o.image?o.image.width*o.image.height*4:0}return{resource:r,textures:i,size:s+$fe(r)}}async function Jlt(t,e){const r=v(e)&&e.streamDataRequester;if(r)return Klt(t,r,e);const i=await hp(Ni(t,e));if(i.ok===!0)return i.value.data;xc(i.error),nSe(i.error)}async function Klt(t,e,r){const i=await hp(e.request(t,"json",r));if(i.ok===!0)return i.value;xc(i.error),nSe(i.error.details.url)}function nSe(t){throw new q("",`Request for object resource failed: ${t}`)}function Qlt(t){const e=t.params,r=e.topology;let i=!0;switch(e.vertexAttributes||(mg.warn("Geometry must specify vertex attributes"),i=!1),e.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const n=e.faces;if(n){if(e.vertexAttributes)for(const o in e.vertexAttributes){const a=n[o];a&&a.values?(a.valueType!=null&&a.valueType!=="UInt32"&&(mg.warn(`Unsupported indexed geometry indices type '${a.valueType}', only UInt32 is currently supported`),i=!1),a.valuesPerElement!=null&&a.valuesPerElement!==1&&(mg.warn(`Unsupported indexed geometry values per element '${a.valuesPerElement}', only 1 is currently supported`),i=!1)):(mg.warn(`Indexed geometry does not specify face indices for '${o}' attribute`),i=!1)}}else mg.warn("Indexed geometries must specify faces"),i=!1;break}default:mg.warn(`Unsupported topology '${r}'`),i=!1}t.params.material||(mg.warn("Geometry requires material"),i=!1);const s=t.params.vertexAttributes;for(const n in s)s[n].values||(mg.warn("Geometries with externally defined attributes are not yet supported"),i=!1);return i}function ect(t,e){const r=new Array,i=new Array,s=new Array,n=new BE,o=t.resource,a=hE.parse(o.version||"1.0","wosr");sct.validate(a);const l=o.model.name,c=o.model.geometries,h=o.materialDefinitions??{},p=t.textures;let f=0;const m=new Map;for(let y=0;y<c.length;y++){const _=c[y];if(!Qlt(_))continue;const b=ict(_),x=_.params.vertexAttributes,T=[];for(const z in x){const G=x[z],K=G.values;T.push([z,new Xe(K,G.valuesPerElement,!0)])}const S=[];if(_.params.topology!=="PerAttributeArray"){const z=_.params.faces;for(const G in z)S.push([G,z[G].values])}const E=b.texture,O=p&&p[E];if(O&&!m.has(E)){const{image:z,params:G}=O,K=new ix(z,G);i.push(K),m.set(E,K)}const R=m.get(E),L=R?R.id:void 0,P=b.material;let U=n.get(P,E);if(C(U)){const z=h[P.substring(P.lastIndexOf("/")+1)].params;z.transparency===1&&(z.transparency=0);const G=O&&O.alphaChannelUsage,K=z.transparency>0||G==="transparency"||G==="maskAndTransparency",ee=O?oSe(O.alphaChannelUsage):void 0,Q={ambient:Nl(z.diffuse),diffuse:Nl(z.diffuse),opacity:1-(z.transparency||0),transparent:K,textureAlphaMode:ee,textureAlphaCutoff:.33,textureId:L,initTextureTransparent:!0,doubleSided:!0,cullFace:Ti.None,colorMixMode:z.externalColorMixMode||"tint",textureAlphaPremultiplied:!!O&&!!O.params.preMultiplyAlpha};v(e)&&e.materialParamsMixin&&Object.assign(Q,e.materialParamsMixin),U=new oy(Q),n.set(P,E,U)}s.push(U);const B=new nn(U,T,S);f+=S.position?S.position.length:0,r.push(B)}return{engineResources:[{name:l,stageResources:{textures:i,materials:s,geometries:r},pivotOffset:o.model.pivotOffset,numberOfVertices:f,lodThreshold:null}],referenceBoundingBox:tct(r)}}function tct(t){const e=Ri();return t.forEach(r=>{const i=r.boundingInfo;v(i)&&(lm(e,i.bbMin),lm(e,i.bbMax))}),e}async function rct(t,e){const r=[];for(const n in t){const o=t[n],a=o.images[0].data;if(!a){mg.warn("Externally referenced texture data is not yet supported");continue}const l=o.encoding+";base64,"+a,c="/textureDefinitions/"+n,h=o.channels==="rgba"?o.alphaChannelUsage||"transparency":"none",p={noUnpackFlip:!0,wrap:{s:Rt.REPEAT,t:Rt.REPEAT},preMultiplyAlpha:oSe(h)!==ui.Opaque},f=v(e)&&e.disableTextures?Promise.resolve(null):sy(l,e);r.push(f.then(m=>({refId:c,image:m,params:p,alphaChannelUsage:h})))}const i=await Promise.all(r),s={};for(const n of i)s[n.refId]=n;return s}function oSe(t){switch(t){case"mask":return ui.Mask;case"maskAndTransparency":return ui.MaskBlend;case"none":return ui.Opaque;default:return ui.Blend}}function ict(t){const e=t.params;return{id:1,material:e.material,texture:e.texture,region:e.texture}}const sct=new hE(1,2,"wosr"),Hx=2.1;async function aSe(t,e){const r=lSe($je(t));if(r.fileType==="wosr"){const p=await(e.cache?e.cache.loadWOSR(r.url,e):sSe(r.url,e)),{engineResources:f,referenceBoundingBox:m}=ect(p,e);return{lods:f,referenceBoundingBox:m,isEsriSymbolResource:!1,isWosr:!0}}const i=await(e.cache?e.cache.loadGLTF(r.url,e,!!e.usePBR):iSe(new tSe(e.streamDataRequester),r.url,e,e.usePBR)),s=Dn(i.model.meta,"ESRI_proxyEllipsoid"),n=i.meta.isEsriSymbolResource&&v(s)&&i.meta.uri.includes("/RealisticTrees/");n&&!i.customMeta.esriTreeRendering&&(i.customMeta.esriTreeRendering=!0,cct(i,s));const o=!!e.usePBR,a=i.meta.isEsriSymbolResource?{usePBR:o,isSchematic:!1,treeRendering:n,mrrFactors:[0,1,.2]}:{usePBR:o,isSchematic:!1,treeRendering:!1,mrrFactors:[0,1,.5]},l={...e.materialParamsMixin,treeRendering:n},{engineResources:c,referenceBoundingBox:h}=cSe(i,a,l,e.skipHighLods&&r.specifiedLodIndex==null?{skipHighLods:!0}:{skipHighLods:!1,singleLodIndex:r.specifiedLodIndex});return{lods:c,referenceBoundingBox:h,isEsriSymbolResource:i.meta.isEsriSymbolResource,isWosr:!1}}function lSe(t){const e=t.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return e?{fileType:"gltf",url:e[1],specifiedLodIndex:e[4]!=null?Number(e[4]):null}:t.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:t,specifiedLodIndex:null}:{fileType:"unknown",url:t,specifiedLodIndex:null}}function cSe(t,e,r,i){const s=t.model,n=new Array,o=new Map,a=new Map,l=s.lods.length,c=Ri();return s.lods.forEach((h,p)=>{const f=i.skipHighLods===!0&&(l>1&&p===0||l>3&&p===1)||i.skipHighLods===!1&&i.singleLodIndex!=null&&p!==i.singleLodIndex;if(f&&p!==0)return;const m=new Zlt(h.name,h.lodThreshold,[0,0,0]);h.parts.forEach(y=>{const _=f?new oy({}):nct(s,y,m,e,r,o,a),{geometry:b,vertexCount:x}=oct(y,v(_)?_:new oy({})),T=b.boundingInfo;v(T)&&p===0&&(lm(c,T.bbMin),lm(c,T.bbMax)),v(_)&&(m.stageResources.geometries.push(b),m.numberOfVertices+=x)}),f||n.push(m)}),{engineResources:n,referenceBoundingBox:c}}function nct(t,e,r,i,s,n,o){const a=e.material+(e.attributes.normal?"_normal":"")+(e.attributes.color?"_color":"")+(e.attributes.texCoord0?"_texCoord0":"")+(e.attributes.tangent?"_tangent":""),l=t.materials.get(e.material),c=v(e.attributes.texCoord0),h=v(e.attributes.normal);if(C(l))return null;const p=act(l.alphaMode);if(!n.has(a)){if(c){const E=(O,R=!1)=>{if(v(O)&&!o.has(O)){const L=t.textures.get(O);if(v(L)){const P=L.data;o.set(O,new ix(rw(P)?P.data:P,{...L.parameters,preMultiplyAlpha:!rw(P)&&R,encoding:rw(P)&&v(P.encoding)?P.encoding:void 0}))}}};E(l.textureColor,p!==ui.Opaque),E(l.textureNormal),E(l.textureOcclusion),E(l.textureEmissive),E(l.textureMetallicRoughness)}const m=l.color[0]**(1/Hx),y=l.color[1]**(1/Hx),_=l.color[2]**(1/Hx),b=l.emissiveFactor[0]**(1/Hx),x=l.emissiveFactor[1]**(1/Hx),T=l.emissiveFactor[2]**(1/Hx),S=v(l.textureColor)&&c?o.get(l.textureColor):null;n.set(a,new oy({...i,transparent:p===ui.Blend,customDepthTest:Aw.Lequal,textureAlphaMode:p,textureAlphaCutoff:l.alphaCutoff,diffuse:[m,y,_],ambient:[m,y,_],opacity:l.opacity,doubleSided:l.doubleSided,doubleSidedType:"winding-order",cullFace:l.doubleSided?Ti.None:Ti.Back,hasVertexColors:!!e.attributes.color,hasVertexTangents:!!e.attributes.tangent,normalType:h?si.Attribute:si.ScreenDerivative,castShadows:!0,receiveSSAO:!0,textureId:v(S)?S.id:void 0,colorMixMode:l.colorMixMode,normalTextureId:v(l.textureNormal)&&c?o.get(l.textureNormal).id:void 0,textureAlphaPremultiplied:v(S)&&!!S.params.preMultiplyAlpha,occlusionTextureId:v(l.textureOcclusion)&&c?o.get(l.textureOcclusion).id:void 0,emissiveTextureId:v(l.textureEmissive)&&c?o.get(l.textureEmissive).id:void 0,metallicRoughnessTextureId:v(l.textureMetallicRoughness)&&c?o.get(l.textureMetallicRoughness).id:void 0,emissiveFactor:[b,x,T],mrrFactors:[l.metallicFactor,l.roughnessFactor,i.mrrFactors[2]],isSchematic:!1,colorTextureTransformMatrix:Lf(l.colorTextureTransform),normalTextureTransformMatrix:Lf(l.normalTextureTransform),occlusionTextureTransformMatrix:Lf(l.occlusionTextureTransform),emissiveTextureTransformMatrix:Lf(l.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:Lf(l.metallicRoughnessTextureTransform),...s}))}const f=n.get(a);if(r.stageResources.materials.push(f),c){const m=y=>{v(y)&&r.stageResources.textures.push(o.get(y))};m(l.textureColor),m(l.textureNormal),m(l.textureOcclusion),m(l.textureEmissive),m(l.textureMetallicRoughness)}return f}function oct(t,e){const r=t.attributes.position.count,i=lct(t.indices||r,t.primitiveType),s=Ab(Oi,r);NM(s,t.attributes.position,t.transform);const n=[[A.POSITION,new Xe(s.typedBuffer,s.elementCount,!0)]],o=[[A.POSITION,i]];if(v(t.attributes.normal)){const a=Ab(Oi,r);QS(KI,t.transform),uv(a,t.attributes.normal,KI),n.push([A.NORMAL,new Xe(a.typedBuffer,a.elementCount,!0)]),o.push([A.NORMAL,i])}if(v(t.attributes.tangent)){const a=Ab(Nc,r);QS(KI,t.transform),Z2e(a,t.attributes.tangent,KI),n.push([A.TANGENT,new Xe(a.typedBuffer,a.elementCount,!0)]),o.push([A.TANGENT,i])}if(v(t.attributes.texCoord0)){const a=Ab(vy,r);K2e(a,t.attributes.texCoord0),n.push([A.UV0,new Xe(a.typedBuffer,a.elementCount,!0)]),o.push([A.UV0,i])}if(v(t.attributes.color)){const a=Ab(xa,r);if(t.attributes.color.elementCount===4)t.attributes.color instanceof Nc?eH(a,t.attributes.color,255):t.attributes.color instanceof xa?Q2e(a,t.attributes.color):t.attributes.color instanceof AM&&eH(a,t.attributes.color,1/256);else{eSe(a,255,255,255,255);const l=new mO(a.buffer,0,4);t.attributes.color instanceof Oi?kj(l,t.attributes.color,255):t.attributes.color instanceof mO?n6(l,t.attributes.color):t.attributes.color instanceof S5&&kj(l,t.attributes.color,1/256)}n.push([A.COLOR,new Xe(a.typedBuffer,a.elementCount,!0)]),o.push([A.COLOR,i])}return{geometry:new nn(e,n,o),vertexCount:r}}const KI=es();function act(t){switch(t){case"BLEND":return ui.Blend;case"MASK":return ui.Mask;case"OPAQUE":case null:case void 0:return ui.Opaque}}function lct(t,e){switch(e){case $t.TRIANGLES:return qlt(t);case $t.TRIANGLE_STRIP:return Wlt(t);case $t.TRIANGLE_FAN:return Xlt(t)}}function cct(t,e){for(let r=0;r<t.model.lods.length;++r){const i=t.model.lods[r];for(const s of i.parts){const n=s.attributes.normal;if(C(n))return;const o=s.attributes.position,a=o.count,l=M(),c=M(),h=M(),p=Ab(xa,a),f=Ab(Oi,a),m=Oo(Ie(),s.transform);for(let y=0;y<a;y++){o.getVec(y,c),n.getVec(y,l),We(c,c,s.transform),me(h,c,e.center),nN(h,h,e.radius);const _=h[2],b=Me(h),x=Math.min(.45+.55*b*b,1);nN(h,h,e.radius),m!==null&&We(h,h,m),_e(h,h),r+1!==t.model.lods.length&&t.model.lods.length>1&&Ys(h,h,l,_>-1?.2:Math.min(-4*_-3.8,1)),f.setVec(y,h),p.set(y,0,255*x),p.set(y,1,255*x),p.set(y,2,255*x),p.set(y,3,255)}s.attributes.normal=f,s.attributes.color=p}}}const $Pt=Object.freeze(Object.defineProperty({__proto__:null,fetch:aSe,gltfToEngineResources:cSe,parseUrl:lSe},Symbol.toStringTag,{value:"Module"}));var ki;function uct(t){let e=ts().mat4f64(A.LOCALTRANSFORM).mat4f64(A.GLOBALTRANSFORM).vec4f64(A.BOUNDINGSPHERE).vec3f64(A.MODELORIGIN).mat3f(A.MODEL).mat3f(A.MODELNORMAL).vec2f(A.MODELSCALEFACTORS);return t.includes("color")&&(e=e.vec4f(A.COLOR)),t.includes("featureAttribute")&&(e=e.vec4f(A.FEATUREATTRIBUTE)),e=e.u8(A.STATE).u8(A.LODLEVEL),t.includes(A.OBJECTANDLAYERIDCOLOR)&&(e=e.vec4u8(A.OBJECTANDLAYERIDCOLOR)),e.alignTo(8),e}(function(t){t[t.ALLOCATED=1]="ALLOCATED",t[t.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",t[t.VISIBLE=4]="VISIBLE",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",t[t.REMOVE=32]="REMOVE",t[t.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",t[t.ACTIVE=18]="ACTIVE"})(ki||(ki={}));let hct=class{constructor(e){this.localTransform=e.getField(A.LOCALTRANSFORM,fO),this.globalTransform=e.getField(A.GLOBALTRANSFORM,fO),this.modelOrigin=e.getField(A.MODELORIGIN,wa),this.model=e.getField(A.MODEL,sv),this.modelNormal=e.getField(A.MODELNORMAL,sv),this.modelScaleFactors=e.getField(A.MODELSCALEFACTORS,vy),this.boundingSphere=e.getField(A.BOUNDINGSPHERE,w5),this.color=e.getField(A.COLOR,Nc),this.featureAttribute=e.getField(A.FEATUREATTRIBUTE,Nc),this.state=e.getField(A.STATE,eE),this.lodLevel=e.getField(A.LODLEVEL,eE),this.objectAndLayerIdColor=e.getField(A.OBJECTANDLAYERIDCOLOR,xa)}},o2=class extends Te{constructor(e,r){super(e),this.events=new vs,this._capacity=0,this._size=0,this._next=0,this._buffer=null,this._view=null,this._layout=uct(r)}get capacity(){return this._capacity}get size(){return this._size}get buffer(){return this._buffer.buffer}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const e=this._findSlot();return this._view.state.set(e,ki.ALLOCATED),this._size++,this.events.emit("instances-changed"),e}removeInstance(e){const r=this._view.state;ft(e>=0&&e<this._capacity&&(r.get(e)&ki.ALLOCATED)!=0,"invalid instance handle"),this._getStateFlag(e,ki.ACTIVE)?this._setStateFlags(e,ki.REMOVE):this.freeInstance(e),this.events.emit("instances-changed")}freeInstance(e){const r=this._view.state;ft(e>=0&&e<this._capacity&&(r.get(e)&ki.ALLOCATED)!=0,"invalid instance handle"),r.set(e,0),this._size--}setLocalTransform(e,r,i=!0){this._view.localTransform.setMat(e,r),i&&this.updateModelTransform(e)}getLocalTransform(e,r){this._view.localTransform.getMat(e,r)}setGlobalTransform(e,r,i=!0){this._view.globalTransform.setMat(e,r),i&&this.updateModelTransform(e)}getGlobalTransform(e,r){this._view.globalTransform.getMat(e,r)}updateModelTransform(e){const r=this._view,i=Ky,s=ld;r.localTransform.getMat(e,Aoe),r.globalTransform.getMat(e,F9);const n=gs(F9,F9,Aoe);ce(i,n[12],n[13],n[14]),r.modelOrigin.setVec(e,i),Hh(s,n),r.model.setMat(e,s);const o=iNe(Ky,n);o.sort(),r.modelScaleFactors.set(e,0,o[1]),r.modelScaleFactors.set(e,1,o[2]),ex(s,s),qh(s,s),r.modelNormal.setMat(e,s),this._setStateFlags(e,ki.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:e})}getModelTransform(e,r){const i=this._view;i.model.getMat(e,ld),i.modelOrigin.getVec(e,Ky),r[0]=ld[0],r[1]=ld[1],r[2]=ld[2],r[3]=0,r[4]=ld[3],r[5]=ld[4],r[6]=ld[5],r[7]=0,r[8]=ld[6],r[9]=ld[7],r[10]=ld[8],r[11]=0,r[12]=Ky[0],r[13]=Ky[1],r[14]=Ky[2],r[15]=1}applyShaderTransformation(e,r){v(this.shaderTransformation)&&this.shaderTransformation.applyTransform(this,e,r)}getCombinedModelTransform(e,r){return this.getModelTransform(e,r),v(this.shaderTransformation)&&this.shaderTransformation.applyTransform(this,e,r),r}getCombinedLocalTransform(e,r){return this._view.localTransform.getMat(e,r),v(this.shaderTransformation)&&this.shaderTransformation.applyTransform(this,e,r),r}getCombinedMaxScaleFactor(e){let r=this._view.modelScaleFactors.get(e,1);if(v(this.shaderTransformation)){const i=this.shaderTransformation.scaleFactor(Ky,this,e);r*=Math.max(i[0],i[1],i[2])}return r}getCombinedMedianScaleFactor(e){let r=this._view.modelScaleFactors.get(e,0);if(v(this.shaderTransformation)){const i=this.shaderTransformation.scaleFactor(Ky,this,e);r*=dct(i[0],i[1],i[2])}return r}getModel(e,r){this._view.model.getMat(e,r)}setFeatureAttribute(e,r){this._view.featureAttribute.setVec(e,r)}getFeatureAttribute(e,r){this._view.featureAttribute.getVec(e,r)}setColor(e,r){this._view.color.setVec(e,r)}setObjectAndLayerIdColor(e,r){this._view.objectAndLayerIdColor.setVec(e,r)}getColor(e,r){this._view.color.getVec(e,r)}setVisible(e,r){r!==this.getVisible(e)&&(this._setStateFlag(e,ki.VISIBLE,r),this.events.emit("instance-visibility-changed",{index:e}))}getVisible(e){return this._getStateFlag(e,ki.VISIBLE)}setHighlight(e,r){r!==this.getHighlight(e)&&(this._setStateFlag(e,ki.HIGHLIGHT,r),this.events.emit("instance-highlight-changed"))}getHighlight(e){return this._getStateFlag(e,ki.HIGHLIGHT)}getState(e){return this._view.state.get(e)}getLodLevel(e){return this._view.lodLevel.get(e)}countFlags(e){let r=0;for(let i=0;i<this._capacity;++i)this.getState(i)&e&&++r;return r}_setStateFlags(e,r){const i=this._view.state;r=i.get(e)|r,i.set(e,r)}_clearStateFlags(e,r){const i=this._view.state;r=i.get(e)&~r,i.set(e,r)}_setStateFlag(e,r,i){i?this._setStateFlags(e,r):this._clearStateFlags(e,r)}_getStateFlag(e,r){return!!(this._view.state.get(e)&r)}_grow(){const e=Math.max(pct,Math.floor(this._capacity*fct)),r=this._layout.createBuffer(e);if(this._buffer){const i=new Uint8Array(this._buffer.buffer);new Uint8Array(r.buffer).set(i)}this._capacity=e,this._buffer=r,this._view=new hct(this._buffer)}_findSlot(){const e=this._view.state;let r=this._next;for(;e.get(r)&ki.ALLOCATED;)r=r+1===this._capacity?0:r+1;return this._next=r+1===this._capacity?0:r+1,r}};function dct(t,e,r){return Math.max(Math.min(t,e),Math.min(Math.max(t,e),r))}u([d({constructOnly:!0})],o2.prototype,"shaderTransformation",void 0),u([d()],o2.prototype,"_size",void 0),u([d({readOnly:!0})],o2.prototype,"size",null),o2=u([I("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],o2);const pct=1024,fct=2,Ky=M(),ld=es(),Aoe=Ie(),F9=Ie();let mct=class extends ep{constructor(e,r){super(i=>this._instanceData.view.boundingSphere.getVec(i,this._tmpSphere),{maximumDepth:25}),this._tmpSphere=on(),this._tmpMat4=Ie(),this._instanceData=e,this._boundingSphere=r}addInstance(e){const r=this._instanceData.view.boundingSphere,i=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);We(this._tmpSphere,this._boundingSphere.center,i),this._tmpSphere[3]=this._boundingSphere.radius*bw(i),r.setVec(e,this._tmpSphere),this.add([e])}removeInstance(e){this.remove([e])}},gct=class{constructor(e,r){this._worldSpaceRadius=e,this._minScreenSpaceRadii=r}selectLevel(e,r,i){const s=i.computeScreenPixelSizeAt(e),n=this._worldSpaceRadius*r/s;let o=0;for(let a=1;a<this._minScreenSpaceRadii.length;++a)n>=this._minScreenSpaceRadii[a]&&(o=a);return o}},yct=class extends R5{constructor(e,r,i,s,n,o){super(e,r),this.layerUid=e,this.graphicUid=r,this.geometryId=i,this.triangleNr=s,this.baseBoundingSphere=n,this.numLodLevels=o}};function JZ(t){return Ep(t)&&t.intersector===Qi.LOD&&!!t.target}let _ct=class{constructor(e,r){const i=e.renderContext.rctx,s=r.geometry;this._materialRepository=e.materialRepository,s.material.setParameters({instancedDoublePrecision:!0});const n=s.material.createBufferWriter(),o=n.vertexBufferLayout,a=n.elementCount(s),l=n.allocate(a);n.write(null,null,s,l,0),this.geometry=s,this.material=s.material,this.glMaterials=new qTe(s.material,this._materialRepository),this.vertexBufferLayout=o,this.vbo=jr.createVertex(i,Lr.STATIC_DRAW,l.buffer),this.vao=new Sp(i,Rr,{geometry:Vc(o)},{geometry:this.vbo}),this.vertexCount=a}destroy(){this.glMaterials.destroy(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(e,r,i,s,n,o,a,l){const c=this.geometry.id;this.material.intersect(this.geometry,e.transform.transform,e,i,s,(h,p,f,m,y)=>{if(h>=0){if(r!=null&&!r(e.rayBegin,e.rayEnd,h))return;const _=new yct(o.layerUid,o.graphicUid(n),c,f,a,l);if((e.results.min.drapedLayerOrder==null||y>=e.results.min.drapedLayerOrder)&&(e.results.min.dist==null||h<e.results.min.dist)&&e.results.min.set(Qi.LOD,_,h,p,e.transform.transform,y),e.options.store!==Po.MIN&&(e.results.max.drapedLayerOrder==null||y>=e.results.max.drapedLayerOrder)&&(e.results.max.dist==null||h>e.results.max.dist)&&e.results.max.set(Qi.LOD,_,h,p,e.transform.transform,y),e.options.store===Po.ALL){const b=VY(e.results.min.ray);b.set(Qi.LOD,_,h,p,e.transform.transform,y),e.results.all.push(b)}}})}},vct=class uSe{static async create(e,r,i){const s=await Promise.allSettled(r.components.map(o=>e.controller.schedule(()=>new _ct(e,o),i))),n=s.map(o=>o.status==="fulfilled"?o.value:null).filter(v);if(Ln(i)||n.length!==s.length){n.forEach(o=>o.destroy()),fr(i);for(const o of s)if(o.status==="rejected")throw o.reason}return new uSe(r.minScreenSpaceRadius,n)}constructor(e,r){this.minScreenSpaceRadius=e,this.components=r}destroy(){this.components.forEach(e=>e.destroy())}intersect(e,r,i,s,n,o,a){this.components.forEach(l=>l.intersect(e,r,i,s,n,o,this.boundingSphere,a))}get boundingBox(){if(C(this._boundingBox)){const e=Ri();this.components.forEach(r=>{v(r.boundingInfo)&&(lm(e,r.boundingInfo.bbMin),lm(e,r.boundingInfo.bbMax))}),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(C(this._boundingSphere)){const e=this.boundingBox,r=M();Yd(e,r),this._boundingSphere={center:r,radius:.5*dpe(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((e,r)=>e+r.triangleCount,0)}},bct=class{constructor(e,r,i){this._elementSize=r,this._buffer=jr.createVertex(e,Lr.STATIC_DRAW),this.resize(i)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get memoryUsage(){return{cpu:this._capacity*this._elementSize,gpu:this._capacity*this._elementSize}}copyRange(e,r,i,s=0){const n=new Uint8Array(this.array,e*this.elementSize,(r-e)*this.elementSize);new Uint8Array(i.array,s*this.elementSize).set(n)}transferAll(){this._buffer.setData(this._array)}transferRange(e,r){const i=e*this._elementSize,s=r*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),i,i,s)}resize(e){const r=e*this._elementSize,i=new ArrayBuffer(r);this._array&&(e>=this._capacity?new Uint8Array(i).set(new Uint8Array(this._array)):new Uint8Array(i).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=i,this._buffer.setSize(r),this._capacity=e}},wct=class{constructor(e){this.modelOriginHi=e.getField(A.MODELORIGINHI,Oi),this.modelOriginLo=e.getField(A.MODELORIGINLO,Oi),this.model=e.getField(A.MODEL,sv),this.modelNormal=e.getField(A.MODELNORMAL,sv),this.color=e.getField(A.INSTANCECOLOR,Nc),this.featureAttribute=e.getField(A.INSTANCEFEATUREATTRIBUTE,Nc),this.objectAndLayerIdColor=e.getField(A.OBJECTANDLAYERIDCOLOR_INSTANCED,xa)}},Roe=class{constructor(e,r){this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._rctx=e,this._instanceBufferLayout=r,this._elementSize=r.stride,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const e=this._headIndex,r=this._tailIndex;return e>=r?e-r:e+this._capacity-r}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get memoryUsage(){return this._buffer?this._buffer.memoryUsage:{cpu:0,gpu:0}}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){ft(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){ft(this._updating,"not updating"),this.size<Tct*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){ft(this._updating,"not updating"),this.isFull&&this._grow();const e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this._incrementHead(),ft(this._headIndex!==this._tailIndex,"invalid pointers"),e}freeTail(){ft(this._updating,"not updating"),ft(this.size>0,"invalid size");const e=this._tailIndex===this._firstIndex;this._incrementTail(),e&&(this._firstIndex=this._tailIndex)}_grow(){const e=Math.max(Ooe,Math.floor(this._capacity*xct));this._resize(e)}_shrink(){const e=Math.max(Ooe,Math.floor(this._capacity*Sct));this._resize(e)}_resize(e){if(ft(this._updating,"not updating"),e===this._capacity)return;const r=new bct(this._rctx,this._elementSize,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const i=this.size,s=this._compactInstances(r);ft(s===i,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=s,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=r,this._view=new wct(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(e){const r=this._headIndex,i=this._tailIndex;return i<r?(this._buffer.copyRange(i,r,e),r-i):i>r?(this._buffer.copyRange(i,this._capacity,e),r>0&&this._buffer.copyRange(0,r,e,this._capacity-i),r+(this._capacity-i)):0}_incrementHead(e=1){this._headIndex=(this._headIndex+e)%this._capacity}_incrementTail(e=1){this._tailIndex=(this._tailIndex+e)%this._capacity}_transferRange(e,r){e<r?this._buffer.transferRange(e,r):e>r&&(r>0&&this._buffer.transferRange(0,r),this._buffer.transferRange(e,this._capacity))}};const Ooe=1024,xct=2,Tct=.3,Sct=.5,Ect=t=>{const e=t.baseBoundingSphere.radius,r=t.levels.map(i=>i.minScreenSpaceRadius);return new gct(e,r)};let hh=class extends Te{constructor(e,r){super(e),this.type=Qi.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new Ct,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.slots=[Se.OPAQUE_MATERIAL,Se.TRANSPARENT_MATERIAL],this.canRender=!0,this._instanceData=new o2({shaderTransformation:e.shaderTransformation},e.optionalFields),this._frameTask=r.registerTask(_t.LOD_RENDERER,this)}initialize(){this._instanceBufferLayout=Act(this.optionalFields),this._glInstanceBufferLayout=Vc(this._instanceBufferLayout,1),this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",({index:e})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(e)}),this._instanceData.events.on("instance-visibility-changed",({index:e})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(e)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))}destroy(){this._frameTask.remove()}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerUid(){return this.metadata.layerUid}get instanceData(){return this._instanceData}get memoryUsage(){const e={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach(r=>{const i=r.memoryUsage;e.cpu+=i.cpu,e.gpu+=i.gpu}),this._highlightRenderInstanceData.forEach(r=>{const i=r.memoryUsage;e.cpu+=i.cpu,e.gpu+=i.gpu}),e}get renderStats(){const e=this._instanceData.size,r=[];return this._levels.forEach((i,s)=>{const n=this._defaultRenderInstanceData[s],o=this._highlightRenderInstanceData[s],a=n.size+o.size,l=i.triangleCount;r.push({renderedInstances:a,renderedTriangles:a*l,trianglesPerInstance:l})}),{totalInstances:e,renderedInstances:r.reduce((i,s)=>i+s.renderedInstances,0),renderedTriangles:r.reduce((i,s)=>i+s.renderedTriangles,0),levels:r}}async initializeRenderContext(e,r){this._context=e;const i=e.renderContext.rctx,s=await Promise.allSettled(this.symbol.levels.map(o=>(this._defaultRenderInstanceData.push(new Roe(i,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new Roe(i,this._instanceBufferLayout)),vct.create(e,o,r)))),n=s.map(o=>o.status==="fulfilled"?o.value:null).filter(v);if(Ln(r)||n.length!==s.length){n.forEach(o=>o.destroy()),fr(r);for(const o of s)if(o.status==="rejected")throw o.reason}this._levels=n,this._levelSelector=Ect(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(e=>e.destroy()),this._defaultRenderInstanceData.forEach(e=>e.destroy()),this._highlightRenderInstanceData.forEach(e=>e.destroy())}get needsTransparentPass(){return this._levels.some(e=>e.components.some(r=>r.material.requiresSlot(Se.TRANSPARENT_MATERIAL,k.Color)))}get needsHighlight(){return this._highlightRenderInstanceData.some(e=>e.size>0)}prepareRender(e){if(!qr.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const r=e.bindParameters.contentCamera.equals(this._camera);this._camera.copyFrom(e.bindParameters.contentCamera),r||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(Xa),this._needFullCycle=!1)}}render(e){!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleForOutput(e.output)||(e.rctx.bindVAO(),e.output!==k.Highlight&&e.output!==k.ShadowHighlight&&this._renderComponents(e,this._defaultRenderInstanceData),e.output!==k.ShadowExcludeHighlight&&this._renderComponents(e,this._highlightRenderInstanceData))}intersect(e,r,i,s){if(!this.baseMaterial.isVisible()||C(this._octree))return;const n=M();me(n,s,i);const o=a=>{this._instanceData.getCombinedModelTransform(a,Ioe),e.transform.set(Ioe),We($oe,i,e.transform.inverse),We(Loe,s,e.transform.inverse);const l=this._instanceData.getState(a),c=this._instanceData.getLodLevel(a),h=this._levels.length;ft((l&ki.ACTIVE)!=0,"invalid instance state"),ft(c>=0&&c<h,"invaid lod level"),this._levels[c].intersect(e,r,$oe,Loe,a,this.metadata,h)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(o):this._octree.forEachAlongRay(i,n,o)}queryDepthRange(e){return this._queryDepthRangeOctree(e)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){var e;if(C(this._octreeCached)){const r=this._instanceData,i=(e=r.view)==null?void 0:e.state;if(!i)return null;this._octreeCached=new mct(r,this.baseBoundingSphere);for(let s=0;s<r.capacity;++s)i.get(s)&ki.ACTIVE&&this._octreeCached.addInstance(s)}return this._octreeCached}_invalidateOctree(){this._octreeCached=ke(this._octreeCached)}_queryDepthRangeOctree(e){if(C(this._octree))return{near:1/0,far:-1/0};const r=e.viewForward,i=this._octree.findClosest(r,ep.DepthOrder.FRONT_TO_BACK,e.frustum),s=this._octree.findClosest(r,ep.DepthOrder.BACK_TO_FRONT,e.frustum);if(i==null||s==null)return{near:1/0,far:-1/0};const n=e.eye,o=this._instanceData.view;o.boundingSphere.getVec(i,Bp),me(Bp,Bp,n);const a=ye(Bp,r)-Bp[3];o.boundingSphere.getVec(s,Bp),me(Bp,Bp,n);const l=ye(Bp,r)+Bp[3];return{near:Math.max(e.near,a),far:Math.min(e.far,l)}}_requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,e&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach(e=>e.startUpdateCycle()),this._highlightRenderInstanceData.forEach(e=>e.startUpdateCycle())}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(e){const{_enableLevelSelection:r,_camera:i,_levelSelector:s}=this;this._defaultRenderInstanceData.forEach(h=>h.beginUpdate()),this._highlightRenderInstanceData.forEach(h=>h.beginUpdate());const n=this._instanceData,o=n.view;let a=n.size;const l=n.capacity;let c=this._instanceIndex;for(let h=0;h<a&&!e.done;++h){c===this._cycleStartIndex&&this._startUpdateCycle();const p=o.state.get(c);let f=0;if(!(p&ki.ALLOCATED)){c=c+1===l?0:c+1,a++;continue}const m=o.lodLevel.get(c);if(p&ki.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[m].freeTail(),p&ki.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[m].freeTail(),p&ki.REMOVE)n.freeInstance(c);else if(p&ki.VISIBLE){let y=0;r&&(o.modelOrigin.getVec(c,Poe),y=s.selectLevel(Poe,n.getCombinedMedianScaleFactor(c),i)),f=p&~(ki.ACTIVE|ki.TRANSFORM_CHANGED),y>=0&&(p&ki.HIGHLIGHT?(Moe(this._highlightRenderInstanceData[y],o,c),f|=ki.HIGHLIGHT_ACTIVE):(Moe(this._defaultRenderInstanceData[y],o,c),f|=ki.DEFAULT_ACTIVE)),o.state.set(c,f),o.lodLevel.set(c,y)}else f=p&~(ki.ACTIVE|ki.TRANSFORM_CHANGED),o.state.set(c,f);if(v(this._octreeCached)){const y=!!(p&ki.ACTIVE),_=!!(f&ki.ACTIVE);!y&&_?this._octreeCached.addInstance(c):y&&!_?this._octreeCached.removeInstance(c):y&&_&&p&ki.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(c),this._octreeCached.addInstance(c))}c=c+1===l?0:c+1,e.madeProgress()}this._instanceIndex=c,this._defaultRenderInstanceData.forEach(h=>h.endUpdate()),this._highlightRenderInstanceData.forEach(h=>h.endUpdate()),this._context.requestRender()}_renderComponents(e,r){this.levels.forEach((i,s)=>{const n=i.components.map(o=>this._beginComponent(e,r[s],o));i.components.forEach((o,a)=>this._renderComponent(e,n[a],r[s],o,s))})}_beginComponent(e,r,i){const{bindParameters:s,rctx:n,output:o}=e;if(r.size===0||!i.material.requiresSlot(s.slot,e.output))return null;const a=i.glMaterials.load(n,s.slot,o);return v(a)?a.beginSlot(s):null}_renderComponent(e,r,i,s,n){if(C(r))return;const{bindParameters:o,rctx:a}=e,l=a.bindTechnique(r,s.material.parameters,o);a.bindVAO(s.vao),r.ensureAttributeLocations(s.vao),l.bindDraw(Rct,o,s.material.parameters),qr.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&e.output===k.Color&&(l.setUniform4fv("externalColor",Doe[Math.min(n,Doe.length-1)]),l.setUniform1i("colorMixMode",txe.replace));const c=a.capabilities.instancing,h=i.capacity,p=i.headIndex,f=i.tailIndex,m=i.firstIndex,y=this._glInstanceBufferLayout,_=(b,x)=>{iY(a,Rr,i.buffer,y,b),c.drawArraysInstanced(r.primitiveType,0,s.vertexCount,x-b),sY(a,Rr,i.buffer,y)};s.material.parameters.transparent&&m!=null?p>f?(ft(m>=f&&m<=p,"invalid firstIndex"),_(m,p),_(f,m)):p<f&&(m<=p?(ft(m>=0&&m<=p,"invalid firstIndex"),_(m,p),_(f,h),_(0,m)):(ft(m>=f&&m<=h,"invalid firstIndex"),_(m,h),_(0,p),_(f,m))):p>f?_(f,p):p<f&&(_(0,p),_(f,h)),a.bindVAO(null)}};function Moe(t,e,r){const i=t.allocateHead();Cct(e,r,t.view,i)}function Cct(t,e,r,i){iYe(t.modelOrigin,e,r.modelOriginHi,r.modelOriginLo,i),r.model.copyFrom(i,t.model,e),r.modelNormal.copyFrom(i,t.modelNormal,e),t.color&&r.color&&r.color.copyFrom(i,t.color,e),t.objectAndLayerIdColor&&r.objectAndLayerIdColor&&r.objectAndLayerIdColor.copyFrom(i,t.objectAndLayerIdColor,e),t.featureAttribute&&r.featureAttribute&&r.featureAttribute.copyFrom(i,t.featureAttribute,e)}function Act(t){let e=ts().vec3f(A.MODELORIGINHI).vec3f(A.MODELORIGINLO).mat3f(A.MODEL).mat3f(A.MODELNORMAL);return v(t)&&t.includes("color")&&(e=e.vec4f(A.INSTANCECOLOR)),v(t)&&t.includes("featureAttribute")&&(e=e.vec4f(A.INSTANCEFEATUREATTRIBUTE)),v(t)&&t.includes("objectAndLayerIdColor")&&(e=e.vec4u8(A.OBJECTANDLAYERIDCOLOR_INSTANCED)),e}u([d({constructOnly:!0})],hh.prototype,"symbol",void 0),u([d({constructOnly:!0})],hh.prototype,"optionalFields",void 0),u([d({constructOnly:!0})],hh.prototype,"metadata",void 0),u([d({constructOnly:!0})],hh.prototype,"shaderTransformation",void 0),u([d()],hh.prototype,"_instanceData",void 0),u([d()],hh.prototype,"_cycleStartIndex",void 0),u([d({readOnly:!0})],hh.prototype,"_enableLevelSelection",null),u([d()],hh.prototype,"_updateCyclesWithStaticCamera",void 0),u([d({readOnly:!0})],hh.prototype,"running",null),hh=u([I("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],hh);const Poe=M(),Bp=sr(),Ioe=Ie(),$oe=M(),Loe=M(),Doe=[Ht(1,0,1,1),Ht(0,0,1,1),Ht(0,1,0,1),Ht(1,1,0,1),Ht(1,0,0,1)],Rct=new xot;let Noe=class{constructor(e,r,i,s,n,o,a,l,c,h,p,f){this.lodResources=e,this.lodRenderer=r,this.stageResources=i,this.originalMaterialParameters=s,this.resourceSize=n,this.isEsriSymbolResource=o,this.isWosr=a,this.resourceBoundingBox=l,this.symbolSize=c,this.extentPadding=h,this.physicalBasedRenderingEnabled=p,this.pivotOffset=f}},Oct=class extends Tm{getCachedSize(){const[e,r,i]=v(this._resources)?this._resources.symbolSize:[1,1,1];return{width:e,depth:r,height:i}}constructor(e,r,i,s){super(e,r,i,s),this._resources=null,this._optionalFields=new Array,this._instanceIndexToGraphicUid=new Map,this._hasLoadedPBRTextures=!1,this._disposeResourceHandles=new Array,this.ensureDrapedStatus(!1),this._hasLoadedPBRTextures=i.physicalBasedRenderingEnabled}async doLoad(e){if(!this._drivenProperties.size&&W5(this.symbolLayer))throw new Error;const r=this.symbolLayer;if(this._isPrimitive){const i=r.resource?r.resource.primitive:Spe;this._resources=await this._createResourcesForPrimitive(i,e)}else this._resources=await this._createResourcesForUrl(r.resource.href,e);this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.complexity=this.computeComplexity()}get extentPadding(){return v(this._resources)?this._resources.extentPadding:0}get _isPrimitive(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}get lodRenderer(){return v(this._resources)?this._resources.lodRenderer:null}_setMaterialTransparencyParams(e,r=Dn(this.symbolLayer,"material","color")){const i=this._getCombinedOpacity(r),s=i<1||this.needsDrivenTransparentPass;return e.transparent=s,e.opacity=i,e.cullFace=s?Ti.None:Ti.Back,e}async _createResourcesForPrimitive(e,r){if(!Mit(e))throw new Error(`Unknown object symbol primitive: ${e}`);const i=this.symbolLayer,s=En(M$e(e)),n=Nl(iP(s)),o=Nl(G6(n,i)),a=Me(o),l=!1,c=!1,h={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,ambient:Nf,diffuse:Nf,hasSlicePlane:this._context.slicePlaneEnabled,hasSliceHighlight:!1,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},p=!!h.usePBR;this._setMaterialTransparencyParams(h);const f=this.symbol;if(f.type==="point-3d"&&f.verticalOffset){const{screenLength:T,minWorldLength:S,maxWorldLength:E}=f.verticalOffset;h.verticalOffset={screenLength:Ao(T),minWorldLength:S||0,maxWorldLength:v(E)?E:1/0},h.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(h.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)h.externalColor=Rh;else{const T=v(i.material)?i.material.color:null,S=v(T)?Ze.toUnitRGBA(T):Rh;h.externalColor=S}this._fastUpdates=PO(this._context.renderer,this._fastVisualVariableConvertOptions(s,o,n,d1)),h.instanced=["transformation"],this._fastUpdates.enabled?(Object.assign(h,this._fastUpdates.materialParameters),h.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(h.instanced.push("color"),this._optionalFields.push("color")),de("enable-feature:objectAndLayerId-rendering")&&(h.instanced.push("objectAndLayerIdColor"),this._optionalFields.push("objectAndLayerIdColor"));const m=new oy(h),y=nTe(e,m);if(!y)throw new Error(`Unknown object symbol primitive: ${e}`);const _=MI(y).map(T=>({opacity:1,transparent:T.parameters.transparent})),b=await this._createStageResources(y,p,r),x=await this._createLodRenderer(y,r);return new Noe(y,x,b,_,n,l,c,s,o,a,p,d1)}async _createResourcesForUrl(e,r){const i=["transformation"],s={materialParamsMixin:{instanced:i,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=PO(this._context.renderer,this._fastVisualVariableConvertOptions(d1,d1,d1,d1)),this._fastUpdates.enabled?(Object.assign(s.materialParamsMixin,this._fastUpdates.materialParameters),i.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(i.push("color"),this._optionalFields.push("color")),de("enable-feature:objectAndLayerId-rendering")&&(i.push("objectAndLayerIdColor"),this._optionalFields.push("objectAndLayerIdColor"));const n=this.symbol;if(n.type==="point-3d"&&n.verticalOffset){const{screenLength:B,minWorldLength:z,maxWorldLength:G}=n.verticalOffset;s.materialParamsMixin.verticalOffset={screenLength:Ao(B),minWorldLength:z||0,maxWorldLength:v(G)?G:1/0},s.materialParamsMixin.castShadows=!1}s.signal=r,s.usePBR=this._context.physicalBasedRenderingEnabled,s.skipHighLods=this._context.skipHighSymbolLods;const o=s.usePBR,a=await aSe(e,s),l=a.isEsriSymbolResource,c=a.isWosr,h=glt(a.lods);h.levels.sort((B,z)=>B.minScreenSpaceRadius-z.minScreenSpaceRadius);const p=this._context,f=this.symbolLayer.material,m=this._getExternalColorParameters(f),y=Dn(this.symbolLayer,"material","color"),_=this._getCombinedOpacity(y,{hasIntrinsicColor:!0}),b=this.needsDrivenTransparentPass,x=MI(h),T=MI(h).map(B=>({opacity:B.parameters.opacity||1,transparent:B.parameters.transparent}));x.forEach(B=>{const z=B.parameters;B.setParameters(m);const G=z.opacity*_,K=G<1||b||z.transparent;B.setParameters({opacity:G,transparent:K}),p.screenSizePerspectiveEnabled&&B.setParameters({screenSizePerspective:p.sharedResources.screenSizePerspectiveSettings})});const S=a.referenceBoundingBox,E=Nl(iP(S)),O=Nl(h.levels[0].pivotOffset),R=Nl(G6(E,this.symbolLayer)),L=Me(R);IO(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(S,R,E,O))&&x.forEach(B=>B.setParameters(this._fastUpdates.materialParameters));const P=await this._createStageResources(h,o,r),U=await this._createLodRenderer(h,r);return new Noe(h,U,P,T,E,l,c,S,R,L,o,O)}_addDisposeResource(e){this._disposeResourceHandles.push(e)}async _createStageResources(e,r,i){const s=this._context.stage,n=MI(e);r!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),s.addMany(n),this._addDisposeResource(()=>s.removeMany(n));const o=one(e);s.addMany(o),this._addDisposeResource(()=>s.removeMany(o)),await s.load(o,i),fr(i);const a=ane(e);return s.addMany(a),this._addDisposeResource(()=>s.removeMany(a)),{materials:n,textures:o,geometries:a}}async _createLodRenderer(e,r){const i=this._context.stage,s={layerUid:this._context.layer.uid,graphicUid:a=>this._instanceIndexToGraphicUid.get(a),notifyGraphicGeometryChanged:a=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(a)),notifyGraphicVisibilityChanged:a=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(a))},n=this._fastUpdates.enabled?{applyTransform:(a,l,c)=>{a.getFeatureAttribute(l,QI),Fn(c,Xj(this._fastUpdates.materialParameters,QI,c))},scaleFactor:(a,l,c)=>(l.getFeatureAttribute(c,QI),aat(a,this._fastUpdates.materialParameters,QI))}:null,o=new hh({symbol:e,optionalFields:this._optionalFields,metadata:s,shaderTransformation:n},this._context.scheduler);return o.slicePlaneEnabled=this._context.slicePlaneEnabled,this._addDisposeResource(()=>{i.removeRenderPlugin(o),o.destroy()}),await i.addRenderPlugin(o.slots,o,r),o}_getExternalColorParameters(e){const r={};return this._drivenProperties.color?r.externalColor=Rh:v(e)&&v(e.color)?r.externalColor=Ze.toUnitRGBA(e.color):(r.externalColor=Rh,r.colorMixMode="ignore"),r}destroy(){super.destroy(),this._cleanupResources()}_cleanupResources(){this._disposeResourceHandles.forEach(e=>e()),this._disposeResourceHandles.length=0,this._resources=null}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry))return null;const i=CO(r.geometry);if(C(i))return this.logger.warn(`unsupported geometry type for icon symbol: ${r.geometry.type}`),null;const s=this.setGraphicElevationContext(r,new Cp),n=e.renderingInfo;return this._createAs3DShape(r,i,n,s,r.uid,e.layer.uid)}notifyDestroyGraphicLayer(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(C(this._resources))return;const e=this._drivenProperties.opacity,r=!this._isPrimitive,i=this._resources.stageResources.materials,s=this._resources.originalMaterialParameters;for(let n=0;n<i.length;n++){const o=i[n],a=Dn(this.symbolLayer,"material","color"),l=s[n],c=this._getCombinedOpacity(a,{hasIntrinsicColor:r})*l.opacity,h=c<1||e||l.transparent;o.setParameters({opacity:c,transparent:h}),this._isPrimitive&&o.setParameters({cullFace:h?Ti.None:Ti.Back})}}layerElevationInfoChanged(e,r){return this.updateGraphics3DGraphicElevationInfo(e,r,lv)}slicePlaneEnabledChanged(){if(C(this._resources))return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(C(this._resources))return!0;const{stageResources:e,isWosr:r}=this._resources;for(const i of e.materials)this._isPrimitive?i.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):r||i.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return this._hasLoadedPBRTextures!==!1||this._context.physicalBasedRenderingEnabled!==!0||(this._hasLoadedPBRTextures=!0,!1)}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!1}applyRendererDiff(e,r){if(C(this._resources))return wn.Recreate_Symbol;const{stageResources:{materials:i},lodRenderer:s,resourceBoundingBox:n,symbolSize:o,resourceSize:a,pivotOffset:l}=this._resources;for(const c in e.diff){if(c!=="visualVariables"||!IO(this._fastUpdates,r,this._fastVisualVariableConvertOptions(n,o,a,l)))return wn.Recreate_Symbol;for(const h of i)h.setParameters(this._fastUpdates.materialParameters);s.notifyShaderTransformationChanged()}return wn.Fast_Update}computeComplexity(){if(C(this._resources))return super.computeComplexity();const e=this._resources.lodResources,r=sTe(e.levels[0]).reduce((n,o)=>n+o.indices.get(A.POSITION).length,0)/3,i=n=>Array.from(n.vertexAttributes.values()).reduce((o,a)=>{var l;return o+(((l=a.data.buffer)==null?void 0:l.byteLength)??0)},0)+Array.from(n.indices.values()).reduce((o,a)=>o+(Array.isArray(a)?12*a.length:a.buffer.byteLength),0),s=one(e).reduce((n,o)=>n+(o.params.encoding&&o.params.encoding==="image/ktx2"?o.estimatedTexMemRequired:o.estimatedTexMemRequired/4),0)+ane(e).reduce((n,o)=>n+i(o),0);return{primitivesPerFeature:r,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:{...lTe(this.symbol,this.symbolLayer),resourceBytes:s}}}_hasLodRenderer(){return v(this._resources)}_createAs3DShape(e,r,i,s,n,o){if(!this._hasLodRenderer()||C(this._resources))return null;const a=this.getFastUpdateAttrValues(e),l=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?yR(i.color,i.opacity):null,c=this._context.clippingExtent;if(Jo(r,qx,this._context.elevationProvider.spatialReference),v(c)&&!iW(c,qx))return null;const h=this._requiresTerrainElevation(s),p=this._computeGlobalTransform(r,s,U9,e$),f=this._computeLocalTransform(this._resources,this.symbolLayer,i,Foe),m=this._resources.lodRenderer.instanceData,y=m.addInstance();this._instanceIndexToGraphicUid.set(y,n),m.setLocalTransform(y,f,!1),m.setGlobalTransform(y,p),a&&m.setFeatureAttribute(y,a),l&&m.setColor(y,l),v(this._context.stage.renderView.objectAndLayerIdRenderHelper)&&m.setObjectAndLayerIdColor(y,this._context.stage.renderView.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor({graphicUid:n,layerUid:o}));const _=new plt(this,y,bit,s);return h&&(_.alignedSampledElevation=e$.sampledElevation),_.needsElevationUpdates=lv(s.mode),EO(_,r,this._context.elevationProvider),_}_computeGlobalTransform(e,r,i,s){return WE(e,this._context.elevationProvider,r,this._context.renderCoordsHelper,s),qx[0]=e.x,qx[1]=e.y,qx[2]=s.z,gp(e.spatialReference,qx,i,this._context.renderCoordsHelper.spatialReference),i}_computeLocalTransform(e,r,i,s){return Gh(s),this._applyObjectRotation(i,!1,s),this._applyObjectRotation(r,!0,s),this._applyObjectScale(e,i,s),this._applyAnchor(e,r,s),s}_applyObjectScale(e,r,i){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const s=this._drivenProperties.size&&r.size?r.size:e.symbolSize,n=sne(s,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);n[0]===1&&n[1]===1&&n[2]===1||P4(i,i,n)}prepareSymbolLayerPatch(e){if(e.diff.type!=="partial")return;const r=e.diff.diff;this._preparePatchTransform(e,r),this._preparePatchColor(e,r)}updateGeometry(e,r){if(C(this._resources))return!0;const i=r&&CO(r);if(C(i))return!1;const s=this.getGeometryElevationMode(r);return e.elevationContext.mode===s&&(this._computeGlobalTransform(i,e.elevationContext,U9,e$),this._requiresTerrainElevation(e.elevationContext)&&(e.alignedSampledElevation=e$.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,U9,!0),EO(e,i,this._context.elevationProvider),!0)}_preparePatchTransform(e,r){if(!(r.heading||r.tilt||r.roll||r.width||r.height||r.depth||r.anchor||r.anchorPosition)||C(this._resources))return;const i=(y,_,b)=>It(y!=null&&y.type==="complete"?y.newValue:_,b),s=i(r.heading,this.symbolLayer.heading,0),n=i(r.tilt,this.symbolLayer.tilt,0),o=i(r.roll,this.symbolLayer.roll,0),a=i(r.width,this.symbolLayer.width,void 0),l=i(r.height,this.symbolLayer.height,void 0),c=i(r.depth,this.symbolLayer.depth,void 0),h=i(r.anchor,this.symbolLayer.anchor,void 0),p=i(r.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete r.heading,delete r.tilt,delete r.roll,delete r.width,delete r.height,delete r.depth,delete r.anchor,delete r.anchorPosition;const f={heading:s,tilt:n,roll:o,anchor:h,anchorPosition:p},m=this._resources;this.loadStatus===yu.LOADED&&e.symbolLayerStatePatches.push(()=>{m.symbolSize=Nl(G6(m.resourceSize,{width:a,height:l,depth:c,isPrimitive:this.symbolLayer.isPrimitive}))}),e.graphics3DGraphicPatches.push((y,_)=>{const b=this._computeLocalTransform(m,f,_,Foe),x=y.instanceIndex;m.lodRenderer.instanceData.setLocalTransform(x,b,!0)})}_preparePatchColor(e,r){if(!r.material||r.material.type!=="partial")return;const i=r.material.diff;if(!i.color||i.color.type!=="complete"||i.color.newValue==null||i.color.oldValue==null)return;const s=i.color.newValue,n=v(s)?Ze.toUnitRGBA(s):Rh;delete i.color;const o=this._resources;C(o)||e.graphics3DGraphicPatches.push(a=>{let l;this._hasPerInstanceColor()?(o.lodRenderer.instanceData.setColor(a.instanceIndex,n),l=this._setMaterialTransparencyParams({},s)):l=this._setMaterialTransparencyParams({externalColor:n},s);for(const c of o.stageResources.materials)c.setParameters(l)})}_requiresTerrainElevation(e){return e.mode!=="absolute-height"}_applyObjectRotation(e,r,i){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&r))return cit(e.heading,e.tilt,e.roll,i)}_computeAnchor(e,r,i){const s=M();switch(i.anchor){case"center":le(s,Yd(e)),ga(s,s);break;case"top":{const n=Yd(e);ce(s,-n[0],-n[1],-e[5]);break}case"bottom":{const n=Yd(e);ce(s,-n[0],-n[1],-e[2]);break}case"relative":{const n=Yd(e),o=iP(e),a=i.anchorPosition,l=a?$e(a.x,a.y,a.z):ma;d4(s,o,l),fe(s,s,n),ga(s,s);break}default:v(r)?ga(s,r):le(s,ma)}return s}_applyAnchor(e,r,i){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const s=this._computeAnchor(e.resourceBoundingBox,e.pivotOffset,r);s&&ql(i,i,s)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(e,r,i,s){const n=v(e)?Nl(iP(e)):Nf,o=v(e)?this._computeAnchor(e,s,this.symbolLayer):ma,a=this._context.renderCoordsHelper.unitInMeters,l=sne(v(r)?r:void 0,r,i,a),c=$e(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:n,symbolSize:v(r)?r:Nf,unitInMeters:a,transformation:{anchor:o,scale:l,rotation:c}}}};const qx=M(),Foe=Ie(),U9=Ie(),QI=sr(),e$=new DM;function Mct(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function Pct(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t}function tH(t,e,r,i,s){return t[0]=e,t[1]=r,t[2]=i,t[3]=s,t}function Ict(t,e){if(t===e){const r=e[1];t[1]=e[2],t[2]=r}else t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3];return t}function $ct(t,e){const r=e[0],i=e[1],s=e[2],n=e[3];let o=r*n-s*i;return o?(o=1/o,t[0]=n*o,t[1]=-i*o,t[2]=-s*o,t[3]=r*o,t):null}function Lct(t,e){const r=e[0];return t[0]=e[3],t[1]=-e[1],t[2]=-e[2],t[3]=r,t}function Dct(t){return t[0]*t[3]-t[2]*t[1]}function hSe(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=r[0],l=r[1],c=r[2],h=r[3];return t[0]=i*a+n*l,t[1]=s*a+o*l,t[2]=i*c+n*h,t[3]=s*c+o*h,t}function Nct(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=Math.sin(r),l=Math.cos(r);return t[0]=i*l+n*a,t[1]=s*l+o*a,t[2]=i*-a+n*l,t[3]=s*-a+o*l,t}function Fct(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=r[0],l=r[1];return t[0]=i*a,t[1]=s*a,t[2]=n*l,t[3]=o*l,t}function Uct(t,e){const r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=r,t[2]=-r,t[3]=i,t}function kct(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t}function Vct(t){return"mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}function Bct(t){return Math.sqrt(t[0]**2+t[1]**2+t[2]**2+t[3]**2)}function zct(t,e,r,i){return t[2]=i[2]/i[0],r[0]=i[0],r[1]=i[1],r[3]=i[3]-t[2]*r[1],[t,e,r]}function Gct(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t}function dSe(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t}function jct(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function Hct(t,e){const r=t[0],i=t[1],s=t[2],n=t[3],o=e[0],a=e[1],l=e[2],c=e[3],h=Sa();return Math.abs(r-o)<=h*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(i-a)<=h*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(s-l)<=h*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(n-c)<=h*Math.max(1,Math.abs(n),Math.abs(c))}function qct(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t}function Wct(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t}const Xct=hSe,Yct=dSe;Object.freeze(Object.defineProperty({__proto__:null,LDU:zct,add:Gct,adjoint:Lct,copy:Mct,determinant:Dct,equals:Hct,exactEquals:jct,frob:Bct,fromRotation:Uct,fromScaling:kct,identity:Pct,invert:$ct,mul:Xct,multiply:hSe,multiplyScalar:qct,multiplyScalarAndAdd:Wct,rotate:Nct,scale:Fct,set:tH,str:Vct,sub:Yct,subtract:dSe,transpose:Ict},Symbol.toStringTag,{value:"Module"}));let Zct=class extends nn{constructor(e,r,i,s,n,o,a,l){super(e,r,i,null,$s.Mesh,l),this.path=s,this.geometrySR=n,this.upVectorAlignment=o,this.stencilWidth=a}};var G_;function pSe(t){return"upVectorAlignment"in t}(function(t){t[t.World=0]="World",t[t.Path=1]="Path"})(G_||(G_={}));function fSe(){return[1,0,0,1]}function Jct(t){return[t[0],t[1],t[2],t[3]]}function Kct(t,e,r,i){return[t,e,r,i]}function Qct(t,e){return new Float64Array(t,e,4)}Object.freeze(Object.defineProperty({__proto__:null,clone:Jct,create:fSe,createView:Qct,fromValues:Kct},Symbol.toStringTag,{value:"Module"}));function mSe(){return{up:M(),right:M()}}function eut(t,e,r){We(t.up,e.up,r),We(t.right,e.right,r)}function tut(t,e,r){or(t,ye(r,e.right),ye(r,e.up))}let rut=class{constructor(){this.pos=M(),this.posES=M(),this.vLeft=M(),this.vRight=M(),this.vMinSiblingLength=0,this.frame=mSe(),this.rotationFrameUp=M(),this.rotationRight=Je(),this.rotationAngle=0,this.miterStretch=fSe(),this.maxStretchDistance=0}setFrameFromUpVector(e){le(this.frame.up,e),fe(a2,this.vLeft,this.vRight),_e(a2,a2),ae(rH,this.frame.up,ye(a2,this.frame.up)),me(r$,a2,rH),_e(r$,r$),pt(this.frame.right,r$,this.frame.up)}},gSe=class{constructor(){this.vertices=[],this.vertexIndices=[],this.vertexNormals=[],this.poles=[],this.poleIndices=[]}addVertex(e,r){return this.vertices.push(LA(e)),this.vertexNormals.push(LA(r)),this.vertices.length-1}addPole(e,r=null){return this.poles.push({position:LA(e),normal:r?LA(r):null}),this.poles.length-1}addSegment(e,r=null){this.vertexIndices.push(e.v0),this.vertexIndices.push(e.v1),r&&(this.poleIndices.push(r.v0),this.poleIndices.push(r.v1))}get numSegments(){return this.vertexIndices.length/2}translate(e,r){for(const i of this.vertices)i[0]+=e,i[1]+=r;for(const i of this.poles)i.position[0]+=e,i.position[1]+=r}};function iut(t=20){const r=new gSe,i={v0:0,v1:0};r.addPole(Ur(0,0));for(let n=0;n<t;++n){const o=2*n*Math.PI/t,a=Math.cos(o),l=Math.sin(o),c=Ur(a*.5,l*.5),h=Ur(a,l);r.addVertex(c,h)}for(let n=0;n<t-1;++n){const o={v0:n,v1:n+1};r.addSegment(o,i)}const s={v0:t-1,v1:0};return r.addSegment(s,i),r}function sut(){const r=new gSe,i=Ur(.5*-1,.5*-1),s=Ur(.5*1,.5*-1),n=Ur(.5*1,.5*1),o=Ur(.5*-1,.5*1),a=Ur(0,-1),l=Ur(1,0),c=Ur(0,1),h=Ur(-1,0);return r.addPole(Ur(0,.5*1),c),r.addPole(Ur(0,.5*1)),r.addPole(Ur(0,.5*-1)),r.addPole(Ur(0,.5*-1),a),r.addVertex(i,a),r.addVertex(s,a),r.addSegment({v0:0,v1:1},{v0:3,v1:3}),r.addVertex(s,l),r.addVertex(n,l),r.addSegment({v0:2,v1:3},{v0:2,v1:1}),r.addVertex(n,c),r.addVertex(o,c),r.addSegment({v0:4,v1:5},{v0:0,v1:0}),r.addVertex(o,h),r.addVertex(i,h),r.addSegment({v0:6,v1:7},{v0:1,v1:2}),r}let nut=class{constructor(e){this.vertices=e,this.offset=M(),this.xform=Ie();const r=Math.floor((e.length-1)/2);le(this.offset,this.vertices[r].pos);for(const i of this.vertices)me(i.pos,i.pos,this.offset);ql(this.xform,this.xform,this.offset),this.updatePathVertexInformation()}updatePathVertexInformation(){const e=this.vertices.length,r=this.vertices[0];r.index=0,r.vLeft=M(),me(r.vRight,this.vertices[1].pos,r.pos);let i=Me(r.vRight);r.vMinSiblingLength=i,_e(r.vRight,r.vRight);let s=r;for(let n=1;n<e;++n){const o=this.vertices[n];if(o.index=n,o.vLeft=s.vRight,n<e-1){me(o.vRight,this.vertices[n+1].pos,o.pos);const a=Me(o.vRight);o.vMinSiblingLength=Math.min(i,a),i=a,_e(o.vRight,o.vRight)}else le(o.vRight,o.vLeft),o.vMinSiblingLength=i;s=o}}};function out(t,e){let r=null;const i=t.vertices.length,s=.99619469809,n=M(),o=M(),a=M(),l=M(),c=M(),h=M(),p=zr();let f=t.vertices[0];le(o,e),ce(n,0,1,0),oF(f.vRight,o,n,n,a,o,s),le(f.frame.up,o),le(f.frame.right,a),r=f;for(let m=1;m<i;++m){f=t.vertices[m],fe(c,f.vLeft,f.vRight);let y=Me(c);y>0?(y=1/Math.sqrt(y),c[0]=c[0]*y,c[1]=c[1]*y,c[2]=c[2]*y):(c[0]=f.vRight[0],c[1]=f.vRight[1],c[2]=f.vRight[2]),fe(h,r.pos,r.frame.up),lM(f.pos,c,p),Zw(p,Du(h,f.vLeft),l)?(me(l,l,f.pos),_e(o,l),pt(a,c,o),_e(a,a)):oF(c,r.frame.up,r.frame.right,n,a,o,s),le(f.frame.up,o),le(f.frame.right,a),r=f}}let aut=class{numProfilesPerJoin(){return 1}extrude(e,r,i){for(let s=0;s<r.vertices.length;++s)i(e.index,e.frame,r.vertices[s],r.vertexNormals[s],!1)}},k9=class{constructor(e=.8*Math.PI,r=1){this.cutoffAngle=e,this.numBendSubdivisions=r}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(e,r,i){const s=fut;if(Math.abs(e.rotationAngle)>=this.cutoffAngle)for(let n=0;n<this.numBendSubdivisions+1;++n){$u(Voe,.5*-e.rotationAngle+n*e.rotationAngle/this.numBendSubdivisions,e.rotationFrameUp),eut(s,e.frame,Voe);for(let o=0;o<r.vertices.length;++o)pn(r.vertices[o],e.rotationRight)*e.rotationAngle>=0?i(e.index,s,r.vertices[o],r.vertexNormals[o],!1):(yG(zb,r.vertices[o],e.miterStretch),i(e.index,e.frame,zb,r.vertexNormals[o],!0))}else for(let n=0;n<this.numBendSubdivisions+1;++n)for(let o=0;o<r.vertices.length;++o){const a=pn(r.vertices[o],e.rotationRight)*e.rotationAngle>=0;yG(zb,r.vertices[o],e.miterStretch),i(e.index,e.frame,zb,r.vertexNormals[o],!a)}}},KZ=class{rebuildConnectingProfileGeometry(e,r,i){for(let s=0;s<r.vertices.length;++s)i(e.index,e.frame,r.vertices[s],r.vertexNormals[s],0,0)}},Uoe=class extends KZ{constructor(){super()}getNumVertices(){return 0}getNumIndices(){return 0}rebuildCapGeometry(){}buildTopology(){}},t$=class extends KZ{constructor(e,r=0,i=!1){super(),this.profile=e,this.profilePlaneOffset=r,this.flip=i}getNumVertices(){return this.profile.vertices.length}getNumIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(e,r,i){for(let s=0;s<r.vertices.length;++s)i(e.index,e.frame,r.vertices[s],r.vertexNormals[s],this.profilePlaneOffset,0)}rebuildCapGeometry(e,r){const i=QZ;or(i,0,0);const s=this.flip?1:-1;for(let n=0;n<this.profile.vertices.length;++n)r(e.index,e.frame,this.profile.vertices[n],i,this.profilePlaneOffset,s)}buildTopology(e,r){const i=this.vertexBufferStart+this.profile.vertexIndices[0];for(let s=1;s<this.profile.numSegments;++s){const n=this.profile.vertexIndices[2*s+0],o=this.profile.vertexIndices[2*s+1],a=this.vertexBufferStart+n,l=this.vertexBufferStart+o;this.flip?r(l,a,i):r(i,a,l)}}},koe=class extends KZ{constructor(e){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=e.profile,this.flip=e.flip,this.sign=this.flip?1:-1,this.breakNormals=e.breakNormals,this.numSegments=e.subdivisions}getNumVertices(){let e=0;return e=this.profile.vertices.length*(this.numSegments-1),this.breakNormals&&(e+=this.profile.vertices.length),e+=this.profile.poles.length,e}getNumIndices(){let e=0;e+=2*this.profile.numSegments*(this.numSegments-1);for(let r=0;r<this.profile.numSegments;++r){const i=this.profile.vertexIndices[2*r+0],s=this.profile.vertexIndices[2*r+1];this.profile.poleIndices[i]===this.profile.poleIndices[s]?e+=1:e+=2}return 3*e}rebuildCapGeometry(e,r){const i=e.frame,s=.5*this.sign,n=zb,o=QZ;or(o,0,0);for(let a=0;a<this.profile.poles.length;++a){const l=this.profile.poles[a];l.normal?r(e.index,i,l.position,l.normal,s,0):r(e.index,i,l.position,o,s,this.sign)}if(this.breakNormals)for(let a=0;a<this.profile.vertices.length;++a)r(e.index,i,this.profile.vertices[a],this.profile.vertexNormals[a],0,0);for(let a=0;a<this.numSegments-1;++a){const l=(1-(a+1)/this.numSegments)*Math.PI*.5,c=Math.sin(l),h=Math.cos(l);for(let p=0;p<this.profile.vertices.length;++p){const f=this.profile.poles[this.profile.poleIndices[p]];If(n,this.profile.vertices[p],f.position),Sc(n,n,c),f.normal?(Vd(n,n,f.position),r(e.index,i,n,f.normal,s*h,0)):(cO(o,n),Sc(o,o,c),Vd(n,n,f.position),r(e.index,i,n,o,s*h,this.sign*h))}}}buildTopology(e,r){const i=this.breakNormals?this.vertexBufferStart+this.profile.poles.length:this.firstProfileVertexIndex,s=this.breakNormals?this.vertexBufferStart+this.profile.poles.length+this.profile.vertices.length:this.vertexBufferStart+this.profile.poles.length;for(let n=0;n<this.profile.numSegments;++n){const o=this.profile.vertexIndices[2*n+0],a=this.profile.vertexIndices[2*n+1],l=this.vertexBufferStart+this.profile.poleIndices[o],c=this.vertexBufferStart+this.profile.poleIndices[a];let h=i+o,p=i+a;for(let f=0;f<this.numSegments-1;++f){const m=s+f*this.profile.vertices.length+o,y=s+f*this.profile.vertices.length+a;this.flip?(r(m,p,h),r(p,m,y)):(r(h,p,m),r(y,m,p)),h=m,p=y}this.flip?(r(l,p,h),l!==c&&r(l,c,p)):(r(h,p,l),l!==c&&r(p,c,l))}}},lut=class{constructor(e,r,i,s,n,o={}){this.options=o,this._extrusionVertexCount=0,this.numExtrusionProfiles=0,this.numVerticesTotal=0,this.numNormalsTotal=0,this.profile=r,this.path=e,this.extruder=i,this.startCap=s,this.endCap=n;const a=this.path.vertices.length-2;this.numExtrusionProfiles=i.numProfilesPerJoin()*a+2,this.numVerticesTotal=r.vertices.length*this.numExtrusionProfiles,this.numNormalsTotal=this.numVerticesTotal,this.startCap.vertexBufferStart=this.numVerticesTotal;const l=this.startCap.getNumVertices();this.numVerticesTotal+=l,this.numNormalsTotal+=l,this.endCap.vertexBufferStart=this.numVerticesTotal;const c=this.endCap.getNumVertices();this.numVerticesTotal+=c,this.numNormalsTotal+=c,this.pathVertexData=Ws(1*this.numVerticesTotal),this.profileRightAxisData=Ws(4*this.numVerticesTotal),this.profileUpAxisData=Ws(4*this.numVerticesTotal),this.profileVertexAndNormalData=Ws(4*this.numVerticesTotal),this.originData=Ws(3*this.path.vertices.length),this._rebuildGeometry(),this.buildTopology()}emitVertex(e,r,i,s,n){if(this.profileRightAxisData[4*this._extrusionVertexCount+0]=r.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=r.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=r.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=r.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=r.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=r.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=i[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=i[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=s[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=e,n){const o=this.path.vertices[e];this.profileRightAxisData[4*this._extrusionVertexCount+3]=o.rotationRight[0]*o.maxStretchDistance,this.profileUpAxisData[4*this._extrusionVertexCount+3]=o.rotationRight[1]*o.maxStretchDistance}else this.profileRightAxisData[4*this._extrusionVertexCount+3]=0,this.profileUpAxisData[4*this._extrusionVertexCount+3]=0;++this._extrusionVertexCount}emitCapVertex(e,r,i,s,n,o){this.profileRightAxisData[4*this._extrusionVertexCount+0]=r.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=r.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=r.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=r.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=r.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=r.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=i[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=i[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=s[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=e,this.profileRightAxisData[4*this._extrusionVertexCount+3]=n,this.profileUpAxisData[4*this._extrusionVertexCount+3]=o,++this._extrusionVertexCount}_rebuildGeometry(){const e=(i,s,n,o,a)=>this.emitVertex(i,s,n,o,a),r=(i,s,n,o,a,l)=>this.emitCapVertex(i,s,n,o,a,l);this._extrusionVertexCount=0;for(const i of this.path.vertices)this.originData[3*i.index+0]=i.pos[0],this.originData[3*i.index+1]=i.pos[1],this.originData[3*i.index+2]=i.pos[2];this.startCap.rebuildConnectingProfileGeometry(this.path.vertices[0],this.profile,r);for(let i=1;i<this.path.vertices.length-1;++i)this.extruder.extrude(this.path.vertices[i],this.profile,e);this.endCap.rebuildConnectingProfileGeometry(this.path.vertices[this.path.vertices.length-1],this.profile,r),this.startCap.rebuildCapGeometry(this.path.vertices[0],r),this.endCap.rebuildCapGeometry(this.path.vertices[this.path.vertices.length-1],r)}buildTopology(){const e=this.profile.vertices.length,r=this.profile.numSegments,i=this.numExtrusionProfiles-1;let s=3*(2*(r*i));this.startCap.indexBufferStart=s,this.startCap.firstProfileVertexIndex=0,s+=this.startCap.getNumIndices(),this.endCap.indexBufferStart=s,this.endCap.firstProfileVertexIndex=e*(this.numExtrusionProfiles-1);const n=new Array,o=new Array,a=new Array,l=(c,h,p)=>{n.push(c),n.push(h),n.push(p),o.push(c),o.push(h),o.push(p),a.push(this.pathVertexData[c]),a.push(this.pathVertexData[h]),a.push(this.pathVertexData[p])};for(let c=0;c<r;++c){const h=this.profile.vertexIndices[2*c],p=this.profile.vertexIndices[2*c+1];for(let f=0;f<i;++f){const m=f*e+h,y=(f+1)*e+p,_=f*e+p;l(m,(f+1)*e+h,y),l(m,y,_)}}this.startCap.buildTopology(this.path.vertices[0],l),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],l),this.vertexIndices=rS(n),this.normalIndices=rS(o),this.pathVertexIndices=rS(a)}onPathChanged(){this._rebuildGeometry()}},ySe=class{constructor(e){this.builder=e}get xform(){return this.builder.path.xform}onPathChanged(){this.builder.onPathChanged()}},_Se=class extends ySe{constructor(e){super(e),this.vertexAttributePosition=null,this.vertexAttributeNormal=null,this.vertexAttributeColor=null,this.vertexAttributePosition=Ws(3*this.builder.numVerticesTotal),this.vertexAttributeNormal=Ws(3*this.builder.numNormalsTotal),this.vertexAttributeColor=new Uint8Array(4),this.vertexAttributeColor[0]=255,this.vertexAttributeColor[1]=255,this.vertexAttributeColor[2]=255,this.vertexAttributeColor[3]=255}bakeVertexColors(e){this.vertexAttributeColor[0]=255*e[0],this.vertexAttributeColor[1]=255*e[1],this.vertexAttributeColor[2]=255*e[2],this.vertexAttributeColor[3]=255*(e.length>3?e[3]:1)}bake(e){this.size=e;for(let r=0;r<this.builder.numVerticesTotal;++r){let i=this.builder.pathVertexData[r];const s=i===0||i===this.builder.path.vertices.length-1;i*=3;const n=uut;ce(n,this.builder.originData[i++],this.builder.originData[i++],this.builder.originData[i]);const o=4*r,a=rH,l=zb,c=a2,h=dut,p=put;let f=0,m=0;if(ce(h,this.builder.profileRightAxisData[o],this.builder.profileRightAxisData[o+1],this.builder.profileRightAxisData[o+2]),ce(p,this.builder.profileUpAxisData[o],this.builder.profileUpAxisData[o+1],this.builder.profileUpAxisData[o+2]),or(l,this.builder.profileVertexAndNormalData[o]*e[0],this.builder.profileVertexAndNormalData[o+1]*e[1]),s)pt(c,p,h),f=this.builder.profileRightAxisData[o+3]*e[0],m=this.builder.profileUpAxisData[o+3];else{const _=QZ,b=hut;or(_,this.builder.profileRightAxisData[o+3],this.builder.profileUpAxisData[o+3]);const x=JX(_);cO(_,_);const T=pn(l,_);if(Math.abs(T)>x){or(b,-_[1],_[0]);const S=pn(l,b);Sc(_,_,x*Math.sign(T)),Sc(b,b,S),Vd(l,_,b)}ce(c,0,0,0)}ce(a,h[0]*l[0]+p[0]*l[1],h[1]*l[0]+p[1]*l[1],h[2]*l[0]+p[2]*l[1]),this.vertexAttributePosition[3*r+0]=n[0]+a[0]+c[0]*f,this.vertexAttributePosition[3*r+1]=n[1]+a[1]+c[1]*f,this.vertexAttributePosition[3*r+2]=n[2]+a[2]+c[2]*f;const y=zb;or(y,this.builder.profileVertexAndNormalData[o+2],this.builder.profileVertexAndNormalData[o+3]),this.vertexAttributeNormal[3*r+0]=h[0]*y[0]+p[0]*y[1]+c[0]*m,this.vertexAttributeNormal[3*r+1]=h[1]*y[0]+p[1]*y[1]+c[1]*m,this.vertexAttributeNormal[3*r+2]=h[2]*y[0]+p[2]*y[1]+c[2]*m}}createGeometryData(){const e=[[A.POSITION,this.builder.vertexIndices],[A.NORMAL,this.builder.normalIndices]],r=[[A.POSITION,new Xe(this.vertexAttributePosition,3,!0)],[A.NORMAL,new Xe(this.vertexAttributeNormal,3,!0)]];if(this.vertexAttributeColor){const i=this.builder.vertexIndices.length;e.push([A.COLOR,new Array(i).fill(0)]),r.push([A.COLOR,new Xe(this.vertexAttributeColor,4)])}return{vertexAttributes:r,indices:e}}onPathChanged(){super.onPathChanged(),this.bake(this.size)}intersect(e,r,i){const s=this.builder.vertexIndices,n=new Xe(this.vertexAttributePosition,3),o=s.length/3;IM(e,r,0,o,s,n,void 0,void 0,i)}},cut=class extends ySe{constructor(e,r,i,s){super(e),this.sizeAttributeValue=r,this.colorAttributeValue=i,this.opacityAttributeValue=s,this.vvData=null,this.baked=new _Se(e),this.vvData=Ws(4*this.builder.path.vertices.length);for(let n=0;n<this.builder.path.vertices.length;++n){this.vvData[4*n+0]=r,this.vvData[4*n+1]=i,this.vvData[4*n+2]=s;const o=n===0||n===this.builder.path.vertices.length-1;this.vvData[4*n+3]=o?1:0}}createGeometryData(){return{vertexAttributes:[[A.POSITION,new Xe(this.builder.originData,3,!0)],[A.PROFILERIGHT,new Xe(this.builder.profileRightAxisData,4,!0)],[A.PROFILEUP,new Xe(this.builder.profileUpAxisData,4,!0)],[A.PROFILEVERTEXANDNORMAL,new Xe(this.builder.profileVertexAndNormalData,4,!0)],[A.FEATUREVALUE,new Xe(this.vvData,4,!0)]],indices:[[A.POSITION,this.builder.pathVertexIndices],[A.PROFILERIGHT,this.builder.vertexIndices],[A.PROFILEUP,this.builder.vertexIndices],[A.PROFILEVERTEXANDNORMAL,this.builder.vertexIndices],[A.FEATUREVALUE,this.builder.pathVertexIndices]]}}};const uut=M(),zb=Je(),QZ=Je(),hut=Je(),rH=M(),a2=M(),dut=M(),put=M(),r$=M(),fut=mSe(),Voe=Ie(),V9=8;function mut(t,e){const r=A.FEATUREVALUE;t.attributes.add(r,"vec4");const i=t.vertex;i.code.add(w`
  bool isCapVertex() {
    return ${r}.w == 1.0;
  }
  `),i.uniforms.add(new kr("size",s=>s.size)),e.vvSize?(i.uniforms.add(new qt("vvSizeMinSize",s=>s.vvSizeMinSize)),i.uniforms.add(new qt("vvSizeMaxSize",s=>s.vvSizeMaxSize)),i.uniforms.add(new qt("vvSizeOffset",s=>s.vvSizeOffset)),i.uniforms.add(new qt("vvSizeFactor",s=>s.vvSizeFactor)),i.code.add(w`
    vec2 getSize() {
      return size * clamp(vvSizeOffset + ${r}.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).xz;
    }
    `)):i.code.add(w`vec2 getSize(){
return size;
}`),e.vvOpacity?(i.constants.add("vvOpacityNumber","int",V9),i.uniforms.add([new ha("vvOpacityValues",s=>s.vvOpacityValues,V9),new ha("vvOpacityOpacities",s=>s.vvOpacityOpacities,V9)]),i.code.add(w`
    vec4 applyOpacity(vec4 color) {
      float value = ${r}.z;
      if (value <= vvOpacityValues[0]) {
        return vec4( color.xyz, vvOpacityOpacities[0]);
      }

      for (int i = 1; i < vvOpacityNumber; ++i) {
        if (vvOpacityValues[i] >= value) {
          float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
          return vec4( color.xyz, mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f));
        }
      }

      return vec4( color.xyz, vvOpacityOpacities[vvOpacityNumber - 1]);
    }
    `)):i.code.add(w`vec4 applyOpacity(vec4 color){
return color;
}`),e.vvColor?(i.constants.add("vvColorNumber","int",lp),i.uniforms.add([new ha("vvColorValues",s=>s.vvColorValues,lp),new z5("vvColorColors",s=>s.vvColorColors,lp)]),i.code.add(w`
    vec4 getColor() {
      float value = ${r}.y;
      if (value <= vvColorValues[0]) {
        return applyOpacity(vvColorColors[0]);
      }

      for (int i = 1; i < vvColorNumber; ++i) {
        if (vvColorValues[i] >= value) {
          float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
          return applyOpacity(mix(vvColorColors[i-1], vvColorColors[i], f));
        }
      }

      return applyOpacity(vvColorColors[vvColorNumber - 1]);
    }
    `)):i.code.add(w`vec4 getColor(){
return applyOpacity(vec4(1, 1, 1, 1));
}`),t.include(CM),t.attributes.add(A.PROFILERIGHT,"vec4"),t.attributes.add(A.PROFILEUP,"vec4"),t.attributes.add(A.PROFILEVERTEXANDNORMAL,"vec4"),i.code.add(w`vec3 calculateVPos() {
vec2 size = getSize();
vec3 origin = position;
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileVertex = profileVertexAndNormal.xy * size;
vec2 profileNormal = profileVertexAndNormal.zw;
float positionOffsetAlongProfilePlaneNormal = 0.0;
float normalOffsetAlongProfilePlaneNormal = 0.0;`),i.code.add(w`if(!isCapVertex()) {
vec2 rotationRight = vec2(profileRight.w, profileUp.w);
float maxDistance = length(rotationRight);`),i.code.add(w`rotationRight = maxDistance > 0.0 ? normalize(rotationRight) : vec2(0, 0);
float rx = dot(profileVertex, rotationRight);
if (abs(rx) > maxDistance) {
vec2 rotationUp = vec2(-rotationRight.y, rotationRight.x);
float ry = dot(profileVertex, rotationUp);
profileVertex = rotationRight * maxDistance * sign(rx) + rotationUp * ry;
}
}else{
positionOffsetAlongProfilePlaneNormal = profileRight.w * size[0];
normalOffsetAlongProfilePlaneNormal = profileUp.w;
}
vec3 offset = right * profileVertex.x + up * profileVertex.y + forward * positionOffsetAlongProfilePlaneNormal;
return origin + offset;
}`),i.code.add(w`vec3 localNormal() {
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileNormal = profileVertexAndNormal.zw;
vec3 normal = right * profileNormal.x + up * profileNormal.y;
if(isCapVertex()) {
normal += forward * profileUp.w;
}
return normal;
}`)}let gut=class extends vZ{constructor(){super(...arguments),this.size=Ur(1,1)}};function yut(t){const e=new Dr,{vertex:r,fragment:i}=e;switch($c(r,t),e.varyings.add("vpos","vec3"),e.include(mut,t),t.output!==k.Color&&t.output!==k.Alpha||(e.include(Bl,t),e.include(Fw,t),e.include(VE,t),e.varyings.add("vnormal","vec3"),e.varyings.add("vcolor","vec4"),t.hasMultipassTerrain&&e.varyings.add("depth","float"),r.code.add(w`
      void main() {
        vpos = calculateVPos();
        vnormal = normalize(localNormal());

        ${t.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":""}
        gl_Position = transformPosition(proj, view, vpos);

        ${t.output===k.Color?"forwardLinearDepth();":""}

        vcolor = getColor();
      }
    `)),e.include(Fu,t),t.output){case k.Alpha:e.include(Xs,t),i.uniforms.add(new Pe("opacity",s=>s.opacity)),i.code.add(w`
      void main() {
        discardBySlice(vpos);
        ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
        float combinedOpacity = vcolor.a * opacity;
        gl_FragColor = vec4(combinedOpacity);
      }
    `);break;case k.Color:e.include(Xs,t),e.include(Uw,t),e.include(VM,t),e.include(Fw,t),e.include(g2e,t),bp(i,t),BM(i),YE(i),i.uniforms.add([r.uniforms.get("localOrigin"),new qt("ambient",s=>s.ambient),new qt("diffuse",s=>s.diffuse),new qt("specular",s=>s.specular),new Pe("opacity",s=>s.opacity)]),i.include(bm),vm(i),i.code.add(w`
        void main() {
          discardBySlice(vpos);
          ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}

          shadingParams.viewDirection = normalize(vpos - cameraPosition);
          shadingParams.normalView = vnormal;
          vec3 normal = shadingNormal(shadingParams);
          float ssao = evaluateAmbientOcclusionInverse();

          float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
          ${t.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":t.spherical?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
          vec3 albedo = vcolor.rgb * max(ambient, diffuse); // combine the old material parameters into a single one
          float combinedOpacity = vcolor.a * opacity;
          albedo += 0.25 * specular; // don't completely ignore specular for now

          vec3 shadedColor = evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight);
          gl_FragColor = vec4(shadedColor, combinedOpacity);
          gl_FragColor = highlightSlice(gl_FragColor, vpos);
          ${t.transparencyPassType===xt.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
        }
      `);break;case k.Depth:case k.Shadow:case k.ShadowHighlight:case k.ShadowExcludeHighlight:e.include(Bl,t),Pw(e),e.varyings.add("depth","float"),r.code.add(w`void main() {
vpos = calculateVPos();
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);
}`),e.include(Xs,t),e.include(ny,t),i.code.add(w`void main() {
discardBySlice(vpos);
outputDepth(depth);
}`);break;case k.Normal:e.include(Bl,t),e.include(OO,t),nE(r),e.varyings.add("vnormal","vec3"),r.code.add(w`void main(void) {
vpos = calculateVPos();
vnormal = normalize((viewNormal * vec4(localNormal(), 1.0)).xyz);
gl_Position = transformPosition(proj, view, vpos);
}`),e.include(Xs,t),i.code.add(w`void main() {
discardBySlice(vpos);
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) normal = -normal;
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
}`);break;case k.Highlight:e.include(Bl,t),e.include(OO,t),e.varyings.add("vnormal","vec3"),r.code.add(w`void main(void) {
vpos = calculateVPos();
gl_Position = transformPosition(proj, view, vpos);
}`),e.include(Xs,t),e.include(by,t),i.code.add(w`void main() {
discardBySlice(vpos);
outputHighlight();
}`)}return e}const _ut=Object.freeze(Object.defineProperty({__proto__:null,build:yut},Symbol.toStringTag,{value:"Module"})),vSe=new Map([[A.POSITION,0],[A.PROFILERIGHT,1],[A.PROFILEUP,2],[A.PROFILEVERTEXANDNORMAL,3],[A.FEATUREVALUE,4]]);let vut=class extends gut{constructor(){super(...arguments),this.ambient=$e(.2,.2,.2),this.diffuse=$e(.8,.8,.8),this.specular=$e(0,0,0),this.opacity=1}},bSe=class wSe extends Vr{initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===vt.WEBGL2,r.spherical=e.viewingMode===Be.Global,r.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Fr(e.rctx,wSe.shader.get().build(this.configuration),vSe)}initializePipeline(){const e=this.configuration.transparencyPassType,r=this.configuration,i=e===xt.NONE,s=e===xt.FrontFace;return Bt({blending:r.output!==k.Color&&r.output!==k.Alpha||!r.transparent?null:i?Iu:wy(e),culling:r.hasSlicePlane&&!r.transparent&&r.doubleSidedMode!==cs.None?Vve:null,depthTest:{func:xv(e)},depthWrite:i||s?Xl:null,colorWrite:Kt,stencilWrite:r.hasOccludees?dm:null,stencilTest:r.hasOccludees?Tv:null,polygonOffset:i||s?null:H5})}};bSe.shader=new Nr(_ut,()=>te(()=>import("./Path.glsl-982d8513.js"),[]));let qn=class extends eo{constructor(){super(...arguments),this.output=k.Color,this.doubleSidedMode=cs.None,this.transparencyPassType=xt.NONE,this.spherical=!1,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasSlicePlane=!1,this.transparent=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.doublePrecisionRequiresObfuscation=!1}};u([V({count:k.COUNT})],qn.prototype,"output",void 0),u([V({count:cs.COUNT})],qn.prototype,"doubleSidedMode",void 0),u([V({count:xt.COUNT})],qn.prototype,"transparencyPassType",void 0),u([V()],qn.prototype,"spherical",void 0),u([V()],qn.prototype,"receiveShadows",void 0),u([V()],qn.prototype,"receiveAmbientOcclusion",void 0),u([V()],qn.prototype,"vvSize",void 0),u([V()],qn.prototype,"vvColor",void 0),u([V()],qn.prototype,"vvOpacity",void 0),u([V()],qn.prototype,"hasSlicePlane",void 0),u([V()],qn.prototype,"transparent",void 0),u([V()],qn.prototype,"hasOccludees",void 0),u([V()],qn.prototype,"hasMultipassTerrain",void 0),u([V()],qn.prototype,"cullAboveGround",void 0),u([V()],qn.prototype,"doublePrecisionRequiresObfuscation",void 0),u([V({constValue:dt.Disabled})],qn.prototype,"pbrMode",void 0),u([V({constValue:!0})],qn.prototype,"hasVvInstancing",void 0),u([V({constValue:!1})],qn.prototype,"useCustomDTRExponentForWater",void 0),u([V({constValue:!1})],qn.prototype,"useFillLights",void 0);let but=class xSe extends wv{constructor(e){super(e,new xut),this.supportsEdges=!0,this._vertexAttributeLocations=vSe,this._configuration=new qn,this._vertexBufferLayout=xSe.getVertexBufferLayout()}getConfiguration(e,r){return this._configuration.output=e,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.vvOpacity=this.parameters.vvOpacityEnabled,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasOccludees=this.parameters.hasOccludees,e!==k.Color&&e!==k.Alpha||(this._configuration.doubleSidedMode=this.parameters.doubleSided&&this.parameters.doubleSidedType==="normal"?cs.View:this.parameters.doubleSided&&this.parameters.doubleSidedType==="winding-order"?cs.WindingOrder:cs.None,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.receiveAmbientOcclusion=!!r.ssaoHelper.active&&this.parameters.receiveSSAO),this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration}isVisibleForOutput(e){return e!==k.Shadow&&e!==k.ShadowExcludeHighlight&&e!==k.ShadowHighlight||this.parameters.castShadows}isVisible(){return super.isVisible()&&this.parameters.opacity>0}intersect(e,r,i,s,n,o){const a=e;if(!pSe(a))return;const l=a.path,c=[this.parameters.size[0],this.parameters.size[1]];if(this.parameters.vvSizeEnabled){const b=this.parameters.vvSizeOffset,x=this.parameters.vvSizeFactor,T=this.parameters.vvSizeMinSize,S=this.parameters.vvSizeMaxSize,E=l.sizeAttributeValue;c[0]*=ge(b[0]+E*x[0],T[0],S[0]),c[1]*=ge(b[2]+E*x[2],T[2],S[2])}const h=Math.max(c[0],c[1]),p=e.boundingInfo;if(C(p))return void this._intersectTriangles(l,c,s,n,o);const f=mw(p.bbMin[0]-h,p.bbMin[1]-h,p.bbMin[2]-h,p.bbMax[0]+h,p.bbMax[1]+h,p.bbMax[2]+h),m=[n[0]-s[0],n[1]-s[1],n[2]-s[2]],y=Math.sqrt(m[0]*m[0]+m[1]*m[1]+m[2]*m[2]),_=[y/m[0],y/m[1],y/m[2]];hZ(f,s,_,i.tolerance)&&this._intersectTriangles(l,c,s,n,o)}_intersectTriangles(e,r,i,s,n){e.baked.size&&e.baked.size[0]===r[0]&&e.baked.size[1]===r[1]||e.baked.bake(r),e.baked.intersect(i,s,n)}createBufferWriter(){return new XE(this._vertexBufferLayout)}requiresSlot(e,r){switch(r){case k.Shadow:case k.ShadowHighlight:case k.ShadowExcludeHighlight:if(!this.parameters.castShadows)return!1;case k.Color:case k.Alpha:case k.Depth:case k.Normal:case k.Highlight:case k.ObjectAndLayerIdColor:return e===(this.parameters.transparent?Se.TRANSPARENT_MATERIAL:Se.OPAQUE_MATERIAL)||e===Se.DRAPED_MATERIAL;default:return!1}}createGLMaterial(e){return new wut(e)}static getVertexBufferLayout(){return ts().vec3f(A.POSITION).vec4f(A.PROFILERIGHT).vec4f(A.PROFILEUP).vec4f(A.PROFILEVERTEXANDNORMAL).vec4f(A.FEATUREVALUE)}},wut=class extends bv{_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}_updateShadowState(e){(C(this.technique)||e.shadowMap.enabled!==this.technique.configuration.receiveShadows)&&this._material.setParameters({receiveShadows:e.shadowMap.enabled})}beginSlot(e){return this._output!==k.Color&&this._output!==k.Alpha||(this._updateShadowState(e),this._updateOccludeeState(e)),this.ensureTechnique(bSe,e)}},xut=class extends vut{constructor(){super(...arguments),this.doubleSided=!1,this.doubleSidedType="normal",this.receiveSSAO=!0,this.receiveShadows=!1,this.castShadows=!0,this.hasSlicePlane=!1,this.transparent=!1,this.hasOccludees=!1}};const Tut=["polyline"];let Sut=class extends Tm{constructor(e,r,i,s){super(e,r,i,s),this._intrinsicSize=Ur(1,1),this._upVectorAlignment=G_.Path,this._stencilWidth=.1,this.ensureDrapedStatus(!1)}async doLoad(){const e=v(this.symbolLayer.width)?this.symbolLayer.width:this.symbolLayer.height,r=v(this.symbolLayer.height)?this.symbolLayer.height:e;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[e,1,r],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=PO(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1};const i=this.symbolLayer.anchor||"center";this._upVectorAlignment=this.symbolLayer.profileRotation==="heading"?G_.World:G_.Path;const s=this.symbolLayer.profile||"circle";switch(s){default:case"circle":this._profile=iut(rTe);break;case"quad":this._profile=sut()}let n=[0,0];switch(i!=="center"&&(n={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[i],this._profile.translate(n[0],n[1])),this.symbolLayer.join){case"round":this._extruder=new k9(0,tTe);break;case"bevel":this._extruder=new k9(0,1);break;case"miter":this._extruder=new k9(.8*Math.PI,1);break;default:this._extruder=new aut}const o=this.symbolLayer.cap||"butt";switch(o){case"none":this._startCap=new Uoe,this._endCap=new Uoe;break;case"butt":default:this._startCap=new t$(this._profile,0),this._endCap=new t$(this._profile,0,!0);break;case"square":this._startCap=new t$(this._profile,-.5),this._endCap=new t$(this._profile,.5,!0);break;case"round":{const m=s==="quad";this._startCap=new koe({profile:this._profile,flip:!1,breakNormals:m,subdivisions:Fj}),this._endCap=new koe({profile:this._profile,flip:!0,breakNormals:m,subdivisions:Fj});break}}const a=Dn(this.symbolLayer,"material","color"),l=this._getCombinedOpacityAndColor(a),c=Nl(l),h=l[3],p=h<1||this.needsDrivenTransparentPass,f={diffuse:c,ambient:c,opacity:h,transparent:p,hasVertexColors:!1,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:p||o==="none"?Ti.None:Ti.Back,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(or(this._intrinsicSize,e,r),!RF(this._intrinsicSize[0])||!RF(this._intrinsicSize[1])))throw new q("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");if(this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||Sc(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates.enabled){const m={...f,...this._fastUpdates.materialParameters,size:kfe(this._intrinsicSize)};this._material=new but(m)}else f.hasVertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new oy(f);this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry,Tut,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(r,new Cp),s=e.renderingInfo;return this._createAs3DShape(r,s,i,r.uid)}layerOpacityChanged(){const e=Dn(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(e),i=r<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:r,transparent:i})}layerElevationInfoChanged(e,r){return this.updateGraphics3DGraphicElevationInfo(e,r,lv)}slicePlaneEnabledChanged(){return this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}applyRendererDiff(e,r){for(const i in e.diff){if(i!=="visualVariables"||!IO(this._fastUpdates,r,this._vvConvertOptions))return wn.Recreate_Symbol;this._material.setParameters(this._fastUpdates.materialParameters)}return wn.Fast_Update}_getVertexData(e){let r=0;const i=e.paths,s=[],n=e.spatialReference,o=this._context.elevationProvider.spatialReference,a=this._context.renderCoordsHelper.spatialReference;for(const f of i)r+=f.length;const l=Fc(3*r),c=Fc(3*r);let h=0;for(const f of i){s.push({index:h,numVertices:f.length});for(const m of f)l[h++]=m[0],l[h++]=m[1],l[h++]=e.hasZ?m[2]:0}let p=!0;return v(o)&&!n.equals(o)&&(p=_s(l,n,0,l,o,0,r)),v(o)&&!o.equals(a)?_s(l,o,0,c,a,0,r):this._copyVertices(l,0,c,0,r),{pathVertexDataInfos:s,vertexDataES:l,vertexDataRS:c,projectionSuccess:p,terrainElevation:0}}_copyVertices(e,r,i,s,n){r*=3,s*=3;for(let o=0;o<n;++o)i[s++]=e[r++],i[s++]=e[r++],i[s++]=e[r++]}_createAs3DShape(e,r,i,s){const n=e.geometry,o=new Array,a=n.spatialReference,l=En(),c=this._context.renderCoordsHelper;SSe.spatialReference=a;const h=this._getVertexData(n);if(!h.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(h.pathVertexDataInfos.length===0)return n.paths.length!==0&&n.paths.some(y=>y.length>0)||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)"),null;for(const y of h.pathVertexDataInfos){const _=y.index,b=y.numVertices;if(b<2||v(this._context.clippingExtent)&&(Ri(l),Cu(l,h.vertexDataES,3*_,b),!Zd(l,this._context.clippingExtent)))continue;const x=[];for(let U=_;U<_+3*b;){const B=U++,z=U++,G=U++,K=new rut;ce(K.posES,h.vertexDataES[B],h.vertexDataES[z],h.vertexDataES[G]);const ee=uit(K.posES,this._context.elevationProvider,i,c);ce(Ui,h.vertexDataRS[B],h.vertexDataRS[z],h.vertexDataRS[G]),c.setAltitude(Ui,ee),le(K.pos,Ui),x.push(K)}const T=new nut(x);TSe(T,this._upVectorAlignment,this._context.renderCoordsHelper);const S=new lut(T,this._profile,this._extruder,this._startCap,this._endCap);let E=null;if(this._fastUpdates.enabled){const U=this._fastUpdates.visualVariables,B=U.size?Gg(U.size.field,e):0,z=U.color?Gg(U.color.field,e):0,G=U.opacity?Gg(U.opacity.field,e):0;E=new cut(S,B,z,G)}else{const U=[this._intrinsicSize[0],this._intrinsicSize[1]];if(this._drivenProperties.size){const G=r.size;U[0]*=Boe(G[0],G[2]==="symbol-value"?this.symbolLayer.height||0:G[2],this.symbolLayer.width||0),U[1]*=Boe(G[2],G[0]==="symbol-value"?this.symbolLayer.width||0:G[0],this.symbolLayer.height||0)}let B;this._drivenProperties.color&&(B=r.color),this._drivenProperties.opacity&&r.opacity!=null&&(B=B?[B[0],B[1],B[2],r.opacity]:[1,1,1,r.opacity]);const z=new _Se(S);z.bake(U),B&&z.bakeVertexColors(B),E=z}const{vertexAttributes:O,indices:R}=E.createGeometryData(),L=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:s,layerUid:this._context.layer.uid}),P=new Zct(this._material,O,R,E,a,this._upVectorAlignment,this._stencilWidth,L);P.transformation=E.xform,o.push(P)}if(o.length===0)return null;const p={layerUid:this._context.layer.uid,graphicUid:s},f=new Ty({geometries:o,metadata:p}),m=new xm(this,f,o,null,null,Cut,i);return m.alignedSampledElevation=h.terrainElevation,m.needsElevationUpdates=lv(i.mode),m}};function TSe(t,e,r){switch(e){default:case G_.World:for(const i of t.vertices){fe(Ui,i.pos,t.offset),r.worldUpAtPosition(Ui,Ui),i.setFrameFromUpVector(Ui),i.rotationFrameUp=i.frame.up,or(i.rotationRight,1,0),ae(Ui,i.frame.up,ye(i.frame.up,i.vLeft)),me(Ui,i.vLeft,Ui),ga(Ui,Ui),_e(Ui,Ui),ae(Qy,i.frame.up,ye(i.frame.up,i.vRight)),me(Qy,i.vRight,Qy),_e(Qy,Qy),pt(zoe,i.rotationFrameUp,i.vLeft);const s=Math.sign(ye(zoe,i.vRight));if(i.rotationAngle=s*(Math.PI-Sn(ye(Ui,Qy))),Math.abs(i.rotationAngle)>0){const o=D6(Math.cos(.5*i.rotationAngle));tH(i.miterStretch,o-1+1,0,0,1)}const n=Math.PI-i.rotationAngle;i.maxStretchDistance=Math.abs(i.vMinSiblingLength/Math.cos(.5*n))}break;case G_.Path:fe(Ui,t.vertices[0].pos,t.offset),r.worldUpAtPosition(Ui,Ui),out(t,Ui);for(const i of t.vertices){const s=Math.sign(ye(i.frame.right,i.vRight));pt(i.rotationFrameUp,i.vRight,i.vLeft),ae(i.rotationFrameUp,i.rotationFrameUp,s),_e(i.rotationFrameUp,i.rotationFrameUp);const n=ye(i.rotationFrameUp,i.frame.up),o=ye(i.rotationFrameUp,i.frame.right);if(ae(Ui,i.frame.up,-o),ae(Qy,i.frame.right,n),fe(Ui,Ui,Qy),_e(Ui,Ui),tut(i.rotationRight,i.frame,Ui),ga(Ui,i.vLeft),i.rotationAngle=-s*(Math.PI-Sn(ye(Ui,i.vRight))),Math.abs(i.rotationAngle)>0){const l=D6(Math.cos(.5*i.rotationAngle));tH(i.miterStretch,1+(l-1)*i.rotationRight[0]*i.rotationRight[0],(l-1)*i.rotationRight[0]*i.rotationRight[1],(l-1)*i.rotationRight[0]*i.rotationRight[1],1+(l-1)*i.rotationRight[1]*i.rotationRight[1])}const a=Math.PI-i.rotationAngle;i.maxStretchDistance=Math.abs(i.vMinSiblingLength*D6(Math.cos(.5*a)))}}}function Boe(t,e,r){switch(t){case"symbol-value":return r;case"proportional":return e;default:return t}}function Eut(t,e,r,i){let s=0;for(const n of t.vertices)r(n.posES,B9),s+=B9.sampledElevation,fe(Ui,n.pos,t.offset),i.setAltitude(Ui,B9.z),me(n.pos,Ui,t.offset);return t.updatePathVertexInformation(),s/t.vertices.length}function Cut(t,e,r,i,s){const n=t.stageObject,o=n.geometries;let a=0;Aut.spatialReference=s.spatialReference;for(const l of o){if(!pSe(l))continue;const c=l.path,h=c.builder.path,p=l.geometrySR;SSe.spatialReference=p,a+=Eut(h,e,i,s),l.upVectorAlignment!==G_.World&&TSe(h,l.upVectorAlignment,s),c.onPathChanged(),l.invalidateBoundingInfo(),n.geometryVertexAttrsUpdated(l)}return a/o.length}const Aut=xy(0,0,0,null),SSe=xy(0,0,0,null),Ui=M(),Qy=M(),zoe=M(),B9=new DM;function Rut(t,e,r,i,s=1){if(r.isGeographic&&i===Be.Global){const c=Fc(e.length),h=e.length,p=Jr(r);for(let f=0;f<h;f+=3)vW(e,f,c,f,p);e=c}or(mn,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(let c=0;c<e.length;c+=3)mn[0]=Math.min(mn[0],e[c]),mn[1]=Math.min(mn[1],e[c+1]);const n=mn[0]%s,o=mn[1]%s,a=mn[0]-n,l=mn[1]-o;for(let c=0;c<e.length;c+=3){const h=c/3*4;t[h]=(e[c]-a)/s,t[h+1]=(e[c+1]-l)/s,t[h+2]=a/s,t[h+3]=l/s}}function ESe(t,e,r,i,s=1){ce(e1,1,0,0),ce(t1,0,1,0),ce(Xx,0,0,1),Put(z9,r),Out(r,Goe)&&Mut(Goe,e1,t1,Xx,i,z9),or(mn,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),or(r1,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let h=0;h<r.length;h+=3){ce(Wx,r[h],r[h+1],r[h+2]);const p=ye(e1,Wx),f=ye(t1,Wx);mn[0]=Math.min(mn[0],p),mn[1]=Math.min(mn[1],f),r1[0]=Math.max(r1[0],p),r1[1]=Math.max(r1[1],f)}const n=ye(Xx,z9);j9(e0,mn[0],mn[1],n,e1,t1,Xx),j9(i1,r1[0],mn[1],n,e1,t1,Xx),j9(s1,mn[0],r1[1],n,e1,t1,Xx),me(i1,i1,e0),ae(i1,i1,.5),me(s1,s1,e0),ae(s1,s1,.5),fe(e0,e0,i1),fe(e0,e0,s1);const o=mn[0]%s,a=mn[1]%s,l=mn[0]-o,c=mn[1]-a;for(let h=0;h<r.length;h+=3){ce(Wx,r[h],r[h+1],r[h+2]);const p=h/3,f=4*p;t[f]=(ye(e1,Wx)-l)/s,t[f+1]=(ye(t1,Wx)-c)/s,t[f+2]=l/s,t[f+3]=c/s;const m=9*p;for(let y=0;y<3;y++)e[m+y]=e0[y],e[m+y+3]=i1[y],e[m+y+6]=s1[y]}}const z9=M(),Wx=M(),Goe=zr(),e1=M(),t1=M(),Xx=M(),mn=Je(),r1=Je(),e0=M(),i1=M(),s1=M();function Out(t,e){const r=t.length/3-1;return dme(t,e,0,Math.floor(r/3),Math.floor(r*(2/3)))}function Mut(t,e,r,i,s,n){v(s)?(s.basisMatrixAtPosition(n,zp),ce(i$,zp[0],zp[1],zp[2]),ce(s$,zp[4],zp[5],zp[6]),ce(G9,zp[8],zp[9],zp[10])):(ce(i$,1,0,0),ce(s$,0,1,0),ce(G9,0,0,1));const o=t;ye(o,G9)<0&&ae(o,o,-1),le(i,o);const a=ye(o,s$),l=ye(o,i$);Math.abs(a)<Math.abs(l)?(Pb(e,i$,o,-l),_e(e,e),pt(r,e,o),_e(r,r),ae(r,r,-1)):(Pb(r,s$,o,-a),_e(r,r),pt(e,r,o),_e(e,e))}const zp=Ie(),i$=M(),s$=M(),G9=M();function Put(t,e){ce(GC,0,0,0);for(let r=0;r<e.length-3;r+=3)GC[0]+=e[r],GC[1]+=e[r+1],GC[2]+=e[r+2];ae(t,GC,1/(e.length/3-1))}const GC=M();function j9(t,e,r,i,s,n,o){ce(t,e*s[0]+r*n[0]+i*o[0],e*s[1]+r*n[1]+i*o[1],e*s[2]+r*n[2]+i*o[2])}function Iut(t){const e=new Dr,{vertex:r,fragment:i}=e,s=t.output===k.Depth,n=t.hasMultipassTerrain&&(t.output===k.Color||t.output===k.Alpha);return $c(r,t),e.include(Bl,t),e.include(sx,t),e.include(B5,t),e.attributes.add(A.POSITION,"vec3"),e.varyings.add("vpos","vec3"),n&&e.varyings.add("depth","float"),s&&(e.include(ny,t),Pw(e),iv(e)),r.code.add(w`
    void main(void) {
      vpos = position;
      forwardNormalizedVertexColor();
      forwardObjectAndLayerIdColor();
      ${n?"depth = (view * vec4(vpos, 1.0)).z;":""}
      gl_Position = ${s?w`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:w`transformPosition(proj, view, vpos);`}
    }
  `),e.include(Xs,t),n&&e.include(Fu,t),i.include(bm),i.uniforms.add(new pr("eColor",o=>o.color)),t.output===k.Highlight&&e.include(by,t),i.code.add(w`
  void main() {
    discardBySlice(vpos);
    ${n?"terrainDepthTest(gl_FragCoord, depth);":""}
    vec4 fColor = ${t.hasVertexColors?"vColor * eColor;":"eColor;"}

    ${t.output===k.ObjectAndLayerIdColor?w`fColor.a = 1.0;`:""}

    if (fColor.a < ${w.float(Yo)}) {
      discard;
    }

    ${t.output===k.Alpha?w`gl_FragColor = vec4(fColor.a);`:""}

    ${t.output===k.Color?w`gl_FragColor = highlightSlice(fColor, vpos); ${t.transparencyPassType===xt.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
    ${t.output===k.Highlight?w`outputHighlight();`:""};
    ${t.output===k.Depth?w`outputDepth(linearDepth);`:""};
    ${t.output===k.ObjectAndLayerIdColor?w`outputObjectAndLayerIdColor();`:""}
  }
  `),e}const $ut=Object.freeze(Object.defineProperty({__proto__:null,build:Iut},Symbol.toStringTag,{value:"Module"}));let CSe=class ASe extends Vr{initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===vt.WEBGL2}initializeProgram(e){return new Fr(e.rctx,ASe.shader.get().build(this.configuration),Rr)}_createPipeline(e,r){const i=this.configuration,s=e===xt.NONE,n=e===xt.FrontFace;return Bt({blending:i.output!==k.Color&&i.output!==k.Alpha||!i.transparent?null:s?Iu:wy(e),culling:y5(i.cullFace),depthTest:{func:xv(e)},depthWrite:(s||n)&&i.writeDepth?Xl:null,colorWrite:Kt,stencilWrite:i.hasOccludees?dm:null,stencilTest:i.hasOccludees?r?hv:Tv:null,polygonOffset:s||n?i.polygonOffset?Lut:null:q5(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._createPipeline(this.configuration.transparencyPassType,!0),this._createPipeline(this.configuration.transparencyPassType,!1)}getPipelineState(e,r){return r?this._occludeePipelineState:super.getPipelineState(e,r)}};CSe.shader=new Nr($ut,()=>te(()=>import("./ColorMaterial.glsl-ed40db2e.js"),[]));const Lut={factor:1,units:1};let cc=class extends eo{constructor(){super(...arguments),this.output=k.Color,this.cullFace=Ti.None,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.transparencyPassType=xt.NONE,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.objectAndLayerIdColorInstanced=!1}};u([V({count:k.COUNT})],cc.prototype,"output",void 0),u([V({count:Ti.COUNT})],cc.prototype,"cullFace",void 0),u([V()],cc.prototype,"hasSlicePlane",void 0),u([V()],cc.prototype,"hasVertexColors",void 0),u([V()],cc.prototype,"transparent",void 0),u([V()],cc.prototype,"polygonOffset",void 0),u([V()],cc.prototype,"enableOffset",void 0),u([V()],cc.prototype,"writeDepth",void 0),u([V()],cc.prototype,"hasOccludees",void 0),u([V({count:xt.COUNT})],cc.prototype,"transparencyPassType",void 0),u([V()],cc.prototype,"hasMultipassTerrain",void 0),u([V()],cc.prototype,"cullAboveGround",void 0),u([V()],cc.prototype,"objectAndLayerIdColorInstanced",void 0);let joe=class extends kZ{constructor(e){super(e,new Nut),this.supportsEdges=!0,this._configuration=new cc}getConfiguration(e,r){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.enableOffset=r.camera.relativeElevation<j5,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration}requiresSlot(e,r){return r===k.Color||r===k.Alpha||r===k.Highlight||r===k.Depth&&this.parameters.writeLinearDepth||r===k.ObjectAndLayerIdColor?e===Se.DRAPED_MATERIAL?!0:r===k.Highlight?e===Se.OPAQUE_MATERIAL:e===(this.parameters.transparent?this.parameters.writeDepth?Se.TRANSPARENT_MATERIAL:Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:Se.OPAQUE_MATERIAL):!1}createGLMaterial(e){return new Dut(e)}createBufferWriter(){return new XE(de("enable-feature:objectAndLayerId-rendering")?bnt:YTe)}},Dut=class extends bv{_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==k.Color&&this._output!==k.Alpha||this._updateOccludeeState(e),this.ensureTechnique(CSe,e)}},Nut=class extends qE{constructor(){super(...arguments),this.color=qf,this.transparent=!1,this.writeDepth=!0,this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=Ti.None,this.hasOccludees=!1}};var Eo;(function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical",t[t.Cross=2]="Cross",t[t.ForwardDiagonal=3]="ForwardDiagonal",t[t.BackwardDiagonal=4]="BackwardDiagonal",t[t.DiagonalCross=5]="DiagonalCross",t[t.COUNT=6]="COUNT"})(Eo||(Eo={}));const iH=.70710678118,Hoe=iH,Fut=.08715574274;function Uut(t){const e=new Dr,r=t.hasMultipassTerrain&&(t.output===k.Color||t.output===k.Alpha);t.draped||e.extensions.add("GL_OES_standard_derivatives");const{vertex:i,fragment:s}=e;$c(i,t),e.include(Bl,t),e.include(sx,t),t.draped?i.uniforms.add(new Pe("worldToScreenRatio",(a,l)=>1/l.screenToPCSRatio)):e.attributes.add(A.BOUNDINGRECT,"mat3"),e.attributes.add(A.POSITION,"vec3"),e.attributes.add(A.UVMAPSPACE,"vec4"),e.varyings.add("vpos","vec3"),e.varyings.add("vuv","vec2"),r&&e.varyings.add("depth","float");const n=t.style===Eo.ForwardDiagonal||t.style===Eo.BackwardDiagonal||t.style===Eo.DiagonalCross;n&&i.code.add(w`
      const mat2 rotate45 = mat2(${w.float(iH)}, ${w.float(-Hoe)},
                                 ${w.float(Hoe)}, ${w.float(iH)});
    `),t.draped||(bp(i,t),i.uniforms.add(new Pe("worldToScreenPerDistanceRatio",(a,l)=>1/l.camera.perScreenPixelRatio)),i.code.add(w`vec3 projectPointToLineSegment(vec3 center, vec3 halfVector, vec3 point) {
float projectedLength = dot(halfVector, point - center) / dot(halfVector, halfVector);
return center + halfVector * clamp(projectedLength, -1.0, 1.0);
}`),i.code.add(w`vec3 intersectRayPlane(vec3 rayDir, vec3 rayOrigin, vec3 planeNormal, vec3 planePoint) {
float d = dot(planeNormal, planePoint);
float t = (d - dot(planeNormal, rayOrigin)) / dot(planeNormal, rayDir);
return rayOrigin + t * rayDir;
}`),i.code.add(w`
      float boundingRectDistanceToCamera() {
        vec3 center = vec3(boundingRect[0][0], boundingRect[0][1], boundingRect[0][2]);
        vec3 halfU = vec3(boundingRect[1][0], boundingRect[1][1], boundingRect[1][2]);
        vec3 halfV = vec3(boundingRect[2][0], boundingRect[2][1], boundingRect[2][2]);
        vec3 n = normalize(cross(halfU, halfV));

        vec3 viewDir = - vec3(view[0][2], view[1][2], view[2][2]);

        float viewAngle = dot(viewDir, n);
        float minViewAngle = ${w.float(Fut)};

        if (abs(viewAngle) < minViewAngle) {
          // view direction is (almost) parallel to plane -> clamp it to min angle
          float normalComponent = sign(viewAngle) * minViewAngle - viewAngle;
          viewDir = normalize(viewDir + normalComponent * n);
        }

        // intersect view direction with infinite plane that contains bounding rect
        vec3 planeProjected = intersectRayPlane(viewDir, cameraPosition, n, center);

        // clip to bounds by projecting to u and v line segments individually
        vec3 uProjected = projectPointToLineSegment(center, halfU, planeProjected);
        vec3 vProjected = projectPointToLineSegment(center, halfV, planeProjected);

        // use to calculate the closest point to camera on bounding rect
        vec3 closestPoint = uProjected + vProjected - center;

        return length(closestPoint - cameraPosition);
      }
    `)),i.code.add(w`
    vec2 scaledUV() {
      vec2 uv = uvMapSpace.xy ${n?" * rotate45":""};
      vec2 uvCellOrigin = uvMapSpace.zw ${n?" * rotate45":""};

      ${t.draped?"":w`
            float distanceToCamera = boundingRectDistanceToCamera();
            float worldToScreenRatio = worldToScreenPerDistanceRatio / distanceToCamera;
          `}

      // Logarithmically discretize ratio to avoid jittering
      float step = 0.1;
      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);

      vec2 uvOffset = mod(uvCellOrigin * discreteWorldToScreenRatio, ${w.float(t.patternSpacing)});
      return uvOffset + (uv * discreteWorldToScreenRatio);
    }
  `);const o=t.output===k.Depth;return o&&(e.include(ny,t),Pw(e),iv(e)),i.code.add(w`
    void main(void) {
      vuv = scaledUV();
      vpos = position;
      ${r?"depth = (view * vec4(vpos, 1.0)).z;":""}
      forwardNormalizedVertexColor();
      gl_Position = ${o?w`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:w`transformPosition(proj, view, vpos);`}
    }
  `),e.include(Xs,t),s.include(bm),t.draped&&s.uniforms.add(new Pe("texelSize",(a,l)=>1/l.camera.pixelRatio)),t.output===k.Highlight&&e.include(by,t),r&&e.include(Fu,t),t.output!==k.Highlight&&(s.code.add(w`
      const float lineWidth = ${w.float(t.lineWidth)};
      const float spacing = ${w.float(t.patternSpacing)};
      const float spacingINV = ${w.float(1/t.patternSpacing)};

      float coverage(float p, float txlSize) {
        p = mod(p, spacing);

        float halfTxlSize = txlSize / 2.0;

        float start = p - halfTxlSize;
        float end = p + halfTxlSize;

        float coverage = (ceil(end * spacingINV) - floor(start * spacingINV)) * lineWidth;
        coverage -= min(lineWidth, mod(start, spacing));
        coverage -= max(lineWidth - mod(end, spacing), 0.0);

        return coverage / txlSize;
      }
    `),t.draped||s.code.add(w`const int maxSamples = 5;
float sample(float p) {
vec2 dxdy = abs(vec2(dFdx(p), dFdy(p)));
float fwidth = dxdy.x + dxdy.y;
ivec2 samples = 1 + ivec2(clamp(dxdy, 0.0, float(maxSamples - 1)));
vec2 invSamples = 1.0 / vec2(samples);
float accumulator = 0.0;
for (int j = 0; j < maxSamples; j++) {
if(j >= samples.y) {
break;
}
for (int i = 0; i < maxSamples; i++) {
if(i >= samples.x) {
break;
}
vec2 step = vec2(i,j) * invSamples - 0.5;
accumulator += coverage(p + step.x * dxdy.x + step.y * dxdy.y, fwidth);
}
}
accumulator /= float(samples.x * samples.y);
return accumulator;
}`)),s.uniforms.add(new pr("uColor",a=>a.color)),s.code.add(w`
    void main() {
      discardBySlice(vpos);
      ${r?"terrainDepthTest(gl_FragCoord, depth);":""}
      vec4 color = ${t.hasVertexColors?"vColor * uColor;":"uColor;"}
      color = highlightSlice(color, vpos);

      ${t.output!==k.Highlight?w`color.a *= ${kut(t)};`:""}

      ${t.output===k.ObjectAndLayerIdColor?w`color.a = 1.0;`:""}

      if (color.a < ${w.float(Yo)}) {
        discard;
      }

      ${t.output===k.Alpha?w`gl_FragColor = vec4(color.a);`:""}

      ${t.output===k.Color?w`gl_FragColor = color; ${t.transparencyPassType===xt.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
      ${t.output===k.Highlight?w`outputHighlight();`:""}
      ${t.output===k.Depth?w`outputDepth(linearDepth);`:""};
    }
  `),e}function kut(t){function e(r){return t.draped?w`coverage(vuv.${r}, texelSize)`:w`sample(vuv.${r})`}switch(t.style){case Eo.ForwardDiagonal:case Eo.Horizontal:return e("y");case Eo.BackwardDiagonal:case Eo.Vertical:return e("x");case Eo.DiagonalCross:case Eo.Cross:return w`
        1.0 - (1.0 - ${e("x")}) * (1.0 - ${e("y")})
      `;default:return"0.0"}}const Vut=Object.freeze(Object.defineProperty({__proto__:null,build:Uut},Symbol.toStringTag,{value:"Module"}));let RSe=class OSe extends Vr{initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===vt.WEBGL2}initializeProgram(e){return new Fr(e.rctx,OSe.shader.get().build(this.configuration),MSe)}_setPipelineState(e,r){const i=this.configuration,s=e===xt.NONE,n=e===xt.FrontFace;return Bt({blending:i.output===k.Color||i.output===k.Alpha?s?Iu:wy(e):null,culling:y5(i.cullFace),depthTest:{func:xv(e)},depthWrite:s?i.writeDepth?Xl:null:G5(e),colorWrite:Kt,stencilWrite:i.hasOccludees?dm:null,stencilTest:i.hasOccludees?r?hv:Tv:null,polygonOffset:s||n?i.polygonOffset?But:null:q5(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipelineState(this.configuration.transparencyPassType,!0),this._setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e,r){return r?this._occludeePipelineState:super.getPipelineState(e,r)}};RSe.shader=new Nr(Vut,()=>te(()=>import("./Pattern.glsl-2ab2f52a.js"),[]));const But={factor:1,units:1};let Ba=class extends eo{constructor(){super(...arguments),this.output=k.Color,this.cullFace=Ti.None,this.transparencyPassType=xt.NONE,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.writeDepth=!0,this.hasOccludees=!1,this.enableOffset=!0,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}};u([V({count:k.COUNT})],Ba.prototype,"output",void 0),u([V({count:Ti.COUNT})],Ba.prototype,"cullFace",void 0),u([V({count:Eo.COUNT})],Ba.prototype,"style",void 0),u([V({count:xt.COUNT})],Ba.prototype,"transparencyPassType",void 0),u([V()],Ba.prototype,"hasSlicePlane",void 0),u([V()],Ba.prototype,"hasVertexColors",void 0),u([V()],Ba.prototype,"polygonOffset",void 0),u([V()],Ba.prototype,"writeDepth",void 0),u([V()],Ba.prototype,"hasOccludees",void 0),u([V()],Ba.prototype,"patternSpacing",void 0),u([V()],Ba.prototype,"lineWidth",void 0),u([V()],Ba.prototype,"enableOffset",void 0),u([V()],Ba.prototype,"draped",void 0),u([V()],Ba.prototype,"hasMultipassTerrain",void 0),u([V()],Ba.prototype,"cullAboveGround",void 0);const MSe=new Map([[A.POSITION,0],[A.COLOR,3],[A.UVMAPSPACE,4],[A.BOUNDINGRECT,5]]);let eJ=class extends kZ{constructor(e){super(e,new jut),this.supportsEdges=!0,this._vertexAttributeLocations=MSe,this._configuration=new Ba}getConfiguration(e,r){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.style=this.parameters.style,this._configuration.patternSpacing=this.parameters.patternSpacing,this._configuration.lineWidth=this.parameters.lineWidth,this._configuration.draped=this.parameters.draped,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.enableOffset=r.camera.relativeElevation<j5,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration}requiresSlot(e,r){return r===k.Color||r===k.Alpha||r===k.Highlight||r===k.Depth&&this.parameters.writeLinearDepth?e===Se.DRAPED_MATERIAL?!0:r===k.Highlight?e===Se.OPAQUE_MATERIAL:e===(this.parameters.writeDepth?Se.TRANSPARENT_MATERIAL:Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):!1}createGLMaterial(e){return new zut(e)}createBufferWriter(){const e=ts().vec3f(A.POSITION).vec4u8(A.COLOR).vec4f(A.UVMAPSPACE);return this.parameters.draped||e.mat3f(A.BOUNDINGRECT),new Gut(e)}},zut=class extends bv{_updateParameters(e){return this.ensureTechnique(RSe,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==k.Color&&this._output!==k.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}},Gut=class extends XE{write(e,r,i,s,n){for(const o of this.vertexBufferLayout.fieldNames){const a=i.vertexAttributes.get(o),l=i.indices.get(o);if(a&&l)switch(o){case A.POSITION:{ft(a.size===3);const c=s.getField(o,Oi);c&&V5(l,a.data,e,c,n);break}case A.COLOR:{ft(a.size===3||a.size===4);const c=s.getField(o,xa);c&&fZ(l,a.data,a.size,c,n);break}case A.UVMAPSPACE:{ft(a.size===4);const c=s.getField(o,Nc);c&&oE(l,a.data,c,n);break}case A.BOUNDINGRECT:{ft(a.size===9);const c=s.getField(o,sv);c&&this.writeBoundingRect(l,a.data,e,c,n);break}}}}writeBoundingRect(e,r,i,s,n){const o=i,a=s.typedBuffer,l=s.typedBufferStride,c=e.length;n*=l;for(let h=0;h<c;++h){const p=9*e[h],f=r[p],m=r[p+1],y=r[p+2];a[n]=o[0]*f+o[4]*m+o[8]*y+o[12],a[n+1]=o[1]*f+o[5]*m+o[9]*y+o[13],a[n+2]=o[2]*f+o[6]*m+o[10]*y+o[14];for(let _=3;_<9;++_)a[n+_]=r[p+_];n+=l}}},jut=class extends qE{constructor(){super(...arguments),this.color=Ht(1,1,1,1),this.writeDepth=!0,this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=Ti.None,this.hasOccludees=!1,this.style=Eo.Cross,this.patternSpacing=10,this.lineWidth=1,this.draped=!0}};function Hut(t,e,r){return Wut(qut(t),e,r)}function qut(t){return t&&t.pattern||null}function Wut(t,e,r){return v(t)?t.style==="none"||t.style==="solid"?(t.style==="none"&&(e.color=Ht(0,0,0,0),e.transparent=!0),new joe(e)):(e.style=Xut(t.style),e.draped=r.isDraped,new eJ(e)):new joe(e)}function Xut(t){switch(t){case"horizontal":return Eo.Horizontal;case"vertical":return Eo.Vertical;case"cross":return Eo.Cross;case"forward-diagonal":return Eo.ForwardDiagonal;case"backward-diagonal":return Eo.BackwardDiagonal;case"diagonal-cross":return Eo.DiagonalCross;default:return}}function Yut(t){return t.material instanceof eJ&&!t.material.parameters.draped}function Zut(t,e){if(Yut(t)){const r=t.vertexAttributes.get(A.POSITION).data,i=t.getMutableAttribute(A.UVMAPSPACE).data,s=t.getMutableAttribute(A.BOUNDINGRECT).data;ESe(i,s,r,e)}}function Jut(t,e,r,i,s){const n=Wxe(t,e,r,i,s),o=t.stageObject.geometries;for(const a of o)Zut(a,s);return n}const Kut=["polyline","polygon","extent"];let PSe=class ISe extends Tm{constructor(e,r,i,s){super(e,r,i,s),this._needsUV=!1,this._hasOutline=!1}async doLoad(){}_ensureMaterials(){this._ensureFillMaterial(),this._ensureOutlineMaterial()}_ensureFillMaterial(){if(v(this._material))return;const e=Dn(this.symbolLayer,"material","color"),r=this._getCombinedOpacityAndColor(e);this._material=Hut(this.symbolLayer,{color:r,transparent:r[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,hasVertexColors:!0,writeLinearDepth:!0,hasSlicePlane:this._context.slicePlaneEnabled},{isDraped:this.draped}),this._needsUV=this._material instanceof eJ,this._context.stage.add(this._material)}_ensureOutlineMaterial(){const e=this.symbolLayer.outline;if(v(this._outlineMaterial)||!this._isValidOutline(e))return;this._hasOutline=!0;const r=i=>{const s=k2e(e.pattern);return new L2({width:i,color:this._getOutlineColor(),hasPolygonOffset:!0,hasSlicePlane:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:s,stippleScaleWithLineWidth:!0,cap:Zj(e.patternCap||"butt")})};this._outlineMaterial=r(Ao(e.size)),this._context.stage.add(this._outlineMaterial)}_isValidOutline(e){return v(e)&&e.size!=null&&e.size>0&&v(e.color)&&(C(e.pattern)||e.pattern.type!=="style"||e.pattern.style!=="none")}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null,this._context.stage.remove(this._outlineMaterial),this._outlineMaterial=null}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry,Kut,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),s=this.setGraphicElevationContext(r,new Cp);return this.ensureDrapedStatus(s.mode==="on-the-ground"),this._ensureMaterials(),this.draped?this._createAsOverlay(r,i):this._createAs3DShape(r,i,s)}layerOpacityChanged(){if(v(this._material)){const e=this._material.parameters.color,r=Dn(this.symbolLayer,"material","color"),i=this._getCombinedOpacity(r);this._material.setParameters({color:[e[0],e[1],e[2],i],transparent:i<1||this.needsDrivenTransparentPass})}if(v(this._outlineMaterial)){const e=this._outlineMaterial.parameters.color;this._outlineMaterial.setParameters({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}}layerElevationInfoChanged(e,r,i){const s=this._elevationContext.mode,n=LM(ISe.elevationModeChangeTypes,i,s);if(n!==ys.UPDATE)return n;const o=Xh(s);return this.updateGraphics3DGraphicElevationInfo(e,r,()=>o)}slicePlaneEnabledChanged(){if(v(this._material)&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),v(this._outlineMaterial)){const e={hasSlicePlane:this._context.slicePlaneEnabled};this._outlineMaterial.setParameters(e)}return!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}_createAs3DShape(e,r,i){var h;const s=AO(e.geometry);if(C(s))return null;const n=qZ(s,this._context.elevationProvider,this._context.renderCoordsHelper,i),o=new Qut(n,r,this._context.layer.uid,e.uid),a=o.renderData.position.length/3;if(this._needsUV&&(o.uvMapSpace=Ws(4*a,!0),o.boundingRect=Fc(9*a,!0),ESe(o.uvMapSpace,o.boundingRect,o.renderData.position,this._context.renderCoordsHelper)),o.objectAndLayerIdColor=(h=this._context.stage.renderView)==null?void 0:h.getObjectAndLayerIdColor(o),this._createAs3DShapeFill(o),this._hasOutline&&this._createAs3DShapeOutline(o),this._logGeometryCreationWarnings(o.renderData,s.rings,"rings","FillSymbol3DLayer"),o.outGeometries.length===0)return null;const l=new Ty({geometries:o.outGeometries,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e.uid}}),c=new xm(this,l,o.outGeometries,null,null,Jut,i);return c.alignedSampledElevation=o.renderData.sampledElevation,c.needsElevationUpdates=Xh(i.mode),c}_createAs3DShapeFill(e){const r=e.renderData.polygons;for(const{position:i,mapPositions:s,holeIndices:n,index:o,count:a}of r){if(v(this._context.clippingExtent)&&(Ri(Wu),Cu(Wu,s),!Zd(Wu,this._context.clippingExtent)))continue;const l=cv(s,n,3);if(l.length===0)continue;const c=xne({material:this._material,indices:l,mapPositions:s,attributeData:{position:i,color:e.color,uvMapSpace:this._needsUV?yie(e.uvMapSpace,4*o,4*a):null,boundingRect:this._needsUV?Lh(e.boundingRect,9*o,9*a):null,objectAndLayerIdColor:e.objectAndLayerIdColor}});e.outGeometries.push(c)}}_createAs3DShapeOutline(e){if(!this._hasOutline)return;const r=e.renderData.outlines;for(let i=0;i<r.length;++i){const{mapPositions:s,position:n}=r[i];if(v(this._context.clippingExtent)&&(Ri(Wu),Cu(Wu,s),!Zd(Wu,this._context.clippingExtent)))continue;const o=Jj(this._outlineMaterial,{overlayInfo:null,removeDuplicateStartEnd:!0,mapPositions:s,attributeData:{position:n}},e.objectAndLayerIdColor),a=o.vertexAttributes.get(A.POSITION);a.data===n&&(a.data=HXe(n)),e.outGeometries.push(o)}}_createAsOverlay(e,r){var a;const i=AO(e.geometry);if(C(i))return null;this._material.renderPriority=this._renderPriority+this._renderPriorityStep/2,v(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority);const s=d2e(i,this._context.overlaySR),n=new eht(s,r,this._context.layer.uid,e.uid),o=n.renderData.position.length/3;return this._needsUV&&(n.uvMapSpace=Ws(4*o,!0),Rut(n.uvMapSpace,n.renderData.position,this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode)),n.outBoundingBox=Ri(),n.objectAndLayerIdColor=(a=this._context.stage.renderView)==null?void 0:a.getObjectAndLayerIdColor(n),this._createAsOverlayFill(n),this._hasOutline&&this._createAsOverlayOutline(n),this._logGeometryCreationWarnings(n.renderData,i.rings,"rings","FillSymbol3DLayer"),n.outGeometries.length===0?null:new e6(this,n.outGeometries,n.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayFill(e){const r=e.renderData.polygons;for(const{position:i,holeIndices:s,index:n,count:o}of r){const a=Ri(Wu);if(Cu(a,i),!Zd(a,this._context.clippingExtent))continue;const l=cv(i,s,3);if(l.length===0)continue;IS(e.outBoundingBox,a);const c=xne({material:this._material,indices:l,attributeData:{position:i,color:e.color,uvMapSpace:this._needsUV?yie(e.uvMapSpace,4*n,4*o):null,objectAndLayerIdColor:e.objectAndLayerIdColor}}),h=new uE(c,e);ti(h.boundingSphere,.5*(a[0]+a[3]),.5*(a[1]+a[4]),0,.5*Math.sqrt((a[3]-a[0])*(a[3]-a[0])+(a[4]-a[1])*(a[4]-a[1]))),e.outGeometries.push(h)}}_createAsOverlayOutline(e){if(!this._hasOutline)return;const r=e.renderData.outlines;for(let i=0;i<r.length;++i){const{position:s}=r[i];if(Ri(Wu),Cu(Wu,s),!Zd(Wu,this._context.clippingExtent))continue;IS(e.outBoundingBox,Wu);const n=Jj(this._outlineMaterial,{overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:!0,attributeData:{position:s}},e.objectAndLayerIdColor),o=new uE(n,e),a=Wu;ti(o.boundingSphere,.5*(a[0]+a[3]),.5*(a[1]+a[4]),0,.5*Math.sqrt((a[3]-a[0])*(a[3]-a[0])+(a[4]-a[1])*(a[4]-a[1]))),e.outGeometries.push(o)}}_getOutlineOpacity(){const e=Dn(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*(v(e)?e.a:0)}_getOutlineColor(){const e=Dn(this.symbolLayer,"outline","color"),r=this._getOutlineOpacity();return yR(v(e)?Ze.toUnitRGB(e):null,r)}test(){return{...super.test(),createAsOverlay:(e,r)=>this._createAsOverlay(e,r),createAs3DShape:(e,r,i)=>this._createAs3DShape(e,r,i)}}};PSe.elevationModeChangeTypes={definedChanged:ys.RECREATE,staysOnTheGround:ys.NONE,onTheGroundChanged:ys.RECREATE};const Wu=En();let Qut=class extends Z5{constructor(e,r,i,s){super(e,i,s),this.color=r}},eht=class extends Z5{constructor(e,r,i,s){super(e,i,s),this.color=r}},$Se=class LSe{constructor(e){this.definition=e,this.key=JSON.stringify(e),this.haloSize=Math.round(e.halo.size),this.textStyle=this._colorToRGBA(e.color),this.haloStyle=this._colorToRGB(e.halo.color),this.backgroundStyle=e.background.color[3]!==0?this._colorToRGBA(e.background.color):null}fontString(e){const r=this.definition.font;return`${r.style} ${r.weight} ${e}px ${r.family}, sans-serif`}_colorToRGB(e){return`rgb(${e.slice(0,3).map(r=>Math.floor(255*r)).toString()})`}_colorToRGBA(e){return`rgba(${e.slice(0,3).map(r=>Math.floor(255*r)).toString()},${e[3]})`}static async fromSymbol(e,r){const i=Dn(e,"material","color"),s=_u(i,qf,Ze.toUnitRGBA),n=_u(e.size,12,Ao),o=e.lineHeight,a=v(e.background)?Ze.toUnitRGBA(e.background.color):qf,l={family:_u(e.font,"sans-serif",m=>m.family),decoration:_u(e.font,"none",m=>m.decoration),weight:_u(e.font,"normal",m=>m.weight),style:_u(e.font,"normal",m=>m.style)},c=e.halo,h=v(c)&&v(c.color)&&c.size>0?{size:Ao(c.size),color:Ze.toUnitRGBA(c.color)}:{size:0,color:qf},p=new LSe({color:s,size:n,background:{color:a,padding:v(e.background)?[.65*n,.5*n]:[0,0],borderRadius:v(e.background)?n*(6/16):0},lineSpacingFactor:o,font:l,halo:h,pixelRatio:r}),f=p.fontString(n);try{await document.fonts.load(f)}catch{se.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters").warnOnce(`Failed to preload font '${f}'. Some text symbology may be rendered using the default browser font.`)}return p}},tht=class{constructor(e,r,i){this._renderer=new O2e(e,r,i)}get key(){return this._renderer.key}get baselineAnchorY(){return 1-this._renderer.firstRenderedBaselinePosition/this._renderer.renderedHeight}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}create(){const e=Wj(rht,this._renderer.renderedWidth,this._renderer.renderedHeight),r=e.getContext("2d");return r.save(),this._renderer.render(r,0,0),r.restore(),new ix(e,{wrap:{s:Rt.CLAMP_TO_EDGE,t:Rt.CLAMP_TO_EDGE},noUnpackFlip:!1,mipmap:!0,preMultiplyAlpha:!0,powerOfTwoResizeMode:U_.PAD})}};const rht={canvas:null},iht=[0,0,1];let sht=class extends Tm{constructor(e,r,i,s){super(e,r,i,s),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const e=W5(this.symbolLayer.size);if(e)throw new q("graphics3dtextsymbollayer:invalid-size",e)}await this._createTextRenderParameters()}async _createTextRenderParameters(){const e=this._context.graphicsCoreOwner.view.state.rasterPixelRatio;this._textRenderParameters=await $Se.fromSymbol(this.symbolLayer,e)}destroy(){super.destroy()}createGraphics3DGraphic(e){const r=e.graphic,i=CO(r.geometry);if(C(i))return this.logger.warn(`unsupported geometry type for text symbol: ${r.geometry.type}`),null;const s=this.symbolLayer.text;if(C(s)||s==="")return null;const n=hW(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if(v(n)&&!Mpe(this.symbolLayer))return this.logger.errorOncePerTick(`Callouts and vertical offset on text symbols are currently only supported with 'center' horizontal alignment (not with '${this.symbolLayer.horizontalAlignment}' alignment)`),null;const o=new jxe(n,this.symbolLayer.horizontalAlignment,Qot(this.symbolLayer.verticalAlignment));return this._createAs3DShape(r,i,s,o)}createLabel(e,r,i,s){const n=e.graphic,o=CO(n.geometry);if(C(o))return this.logger.warn(`unsupported geometry type for label: ${n.geometry.type}`),null;const a=r.text;return!a||/^\s+$/.test(a)?null:this._createAs3DShape(n,o,a,r,i,s)}setGraphicElevationContext(e,r,i=0){const s=super.setGraphicElevationContext(e,r);return s.addOffsetRenderUnits(i),s}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerElevationInfoChanged(e,r){return qoe(e,r,(i,s)=>{this.updateGraphicElevationContext(s,i)}),ys.UPDATE}slicePlaneEnabledChanged(e,r){return qoe(e,r,i=>{for(const s of i.stageObject.geometries)s.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!1}skipHighSymbolLodsChanged(){return!0}updateGraphicElevationContext(e,r){const i=r.elevationContext;this.setGraphicElevationContext(e,i,v(r.metadata)?r.metadata.elevationOffset:0),r.needsElevationUpdates=Xh(i.mode)||i.mode==="absolute-height"}_defaultElevationInfoNoZ(){return oht}_createAs3DShape(e,r,i,s,n,o){const a=this.setGraphicElevationContext(e,new Cp,s.elevationOffset),l=Dn(e.geometry,"type")==="polyline",c=e.uid;let h=null,p=null;if(C(o)){const P=P2e(s.horizontalPlacement);h=new tht(i,P,this._textRenderParameters);let U=null;if(v(this._context.sharedResources.textures)){p=this._context.sharedResources.textures.fromData(h.key,()=>h.create(),()=>{v(U)&&U.release()});const B=this._context.stage.renderView.textureRepository.acquire(p.texture.id);if(C(B)||Uu(B))return p.release(),null;U=B}}const f=nht(h,s),m={occlusionTest:!0,screenOffset:s.screenOffset,anchorPosition:f,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:s.centerOffsetUnits,drawInSecondSlot:!0};if(v(o)?m.textureId=o.id:v(p)&&(m.textureId=p.texture.id),v(s.verticalOffset)){const{screenLength:P,minWorldLength:U,maxWorldLength:B}=s.verticalOffset;m.verticalOffset={screenLength:Ao(P),minWorldLength:U||0,maxWorldLength:v(B)?B:1/0}}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:P,screenSizePerspectiveSettingsLabels:U}=this._context.sharedResources;m.screenSizePerspective=U.overridePadding(this._textRenderParameters.haloSize+this._textRenderParameters.definition.background.padding[0]),m.screenSizePerspectiveAlignment=P}let y;if(l&&(m.shaderPolygonOffset=1e-4),m.hasSlicePlane=this._context.slicePlaneEnabled,v(n)){const P=JSON.stringify(m);y=n.get(P),C(y)&&(y=new aE(m),n.add(P,y))}else y=new aE(m);const _=s.translation,b=v(h)?Ur(h.displayWidth,h.displayHeight):Wl,x=s.centerOffset,T=fj(y,iht,_,null,b,x,[0,0],null),S=MZ(this._context,r,T,a,c);if(C(S))return null;const E=new xm(this,S.object,[T],C(n)?[y]:null,p,SO,a);E.alignedSampledElevation=S.sampledElevation,E.needsElevationUpdates=Xh(a.mode)||a.mode==="absolute-height";const{displayWidth:O,displayHeight:R}=v(h)?h:s;E.getScreenSize=(P=Je())=>(P[0]=O,P[1]=R,P);const L=new eTe(s.elevationOffset,i);return E.metadata=L,EO(E,r,this._context.elevationProvider),E}};function qoe(t,e,r){t&&t.forEach(i=>{const s=e(i);v(s)&&r(s,i.graphic)})}function nht(t,e){if(e.verticalPlacement==="baseline"){const i=Zot[e.horizontalPlacement],s=v(t)?t.baselineAnchorY:0;return Ur(i,s)}const r=Kot(e.horizontalPlacement,e.verticalPlacement);return gD[r]}const oht={mode:"relative-to-ground",offset:0},aht={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}},lht=["polyline","polygon","extent"];let sH=class ib extends Tm{constructor(e,r,i,s){super(e,r,i,s)}async doLoad(){}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry,lht,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(r,new Cp);return this.ensureDrapedStatus(i.mode==="on-the-ground"),this.ensureMaterial(),this.draped?this._createAsOverlay(r):this._createAs3DShape(r,i,r.uid)}ensureMaterial(){if(v(this._material))return;const e=new r2e,r=this.symbolLayer.color;v(r)&&(e.color=Ze.toUnitRGBA(r));const i=this._getCombinedOpacity(r,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],i],e.transparent=i<1||this.needsDrivenTransparentPass,e.waveDirection=v(this.symbolLayer.waveDirection)?ib.headingVectorFromAngle(this.symbolLayer.waveDirection):Ur(0,0);const s=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,n=aht[s];e.waveStrength=n.waveStrength,e.waveTextureRepeat=n.textureRepeat,e.waveVelocity=n.waveVelocity,e.flowStrength=n.perturbationStrength,e.hasSlicePlane=this._context.slicePlaneEnabled,e.isDraped=this.draped,this._material=new t2e(e),this._context.stage.add(this._material)}layerOpacityChanged(){if(C(this._material))return;const e=this._material.parameters.color,r=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),i=r<1||this.needsDrivenTransparentPass;this._material.setParameters({color:[e[0],e[1],e[2],r],transparent:i})}layerElevationInfoChanged(e,r,i){const s=this._elevationContext.mode,n=LM(ib.elevationModeChangeTypes,i,s);if(n!==ys.UPDATE)return n;const o=Xh(s);return this.updateGraphics3DGraphicElevationInfo(e,r,()=>o)}slicePlaneEnabledChanged(){return v(this._material)&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}_createAs3DShape(e,r,i){const s=AO(e.geometry);if(C(s))return null;const n=qZ(s,this._context.elevationProvider,this._context.renderCoordsHelper,r),o=n.position.length/3,a=Fc(2*o);this._createUVCoordsFromVertices(a,n.mapPositions,o,this._context.elevationProvider.spatialReference);const l=new cht(n,a);if(this._create3DShapeGeometries(l),this._logGeometryCreationWarnings(l.renderData,s.rings,"rings","WaterSymbol3DLayer"),l.outGeometries.length===0)return null;const c=new Ty({geometries:l.outGeometries,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:i}}),h=new xm(this,c,l.outGeometries,null,null,Wxe,r);return h.alignedSampledElevation=l.renderData.sampledElevation,h.needsElevationUpdates=Xh(r.mode),h}_createUVCoordsFromVertices(e,r,i,s){const n=nl(s);zh(t0);for(let l=0;l<i;l++)or(Woe,r[3*l],r[3*l+1]),tW(t0,Woe);_E(t0,t0,n);const o=t0[0]%ib.unitSizeOfTexture,a=t0[1]%ib.unitSizeOfTexture;n$[0]=t0[0]-o,n$[1]=t0[1]-a;for(let l=0;l<i;l++)e[2*l]=(r[3*l]*n-n$[0])/ib.unitSizeOfTexture,e[2*l+1]=(r[3*l+1]*n-n$[1])/ib.unitSizeOfTexture}_create3DShapeGeometries(e){const r=e.renderData.polygons,i=e.uvCoords;for(const{count:s,index:n,position:o,mapPositions:a,holeIndices:l}of r){if(v(this._context.clippingExtent)&&(Ri(r0),Cu(r0,a),!Zd(r0,this._context.clippingExtent)))continue;const c=cv(a,l,3);if(c.length===0)continue;const h=Lh(i,2*n,2*s),p=Tne({material:this._material,indices:c,mapPositions:a,attributeData:{position:o,uv0:h}});e.outGeometries.push(p)}}_createAsOverlay(e){const r=AO(e.geometry);if(C(r))return null;this._material.renderPriority=this._renderPriority;const i=d2e(r,this._context.overlaySR),s=i.position.length/3,n=Fc(2*s);this._createUVCoordsFromVertices(n,i.position,s,this._context.overlaySR);const o=new uht(i,n,this._context.layer.uid,e.uid);return o.outBoundingBox=Ri(),this._createAsOverlayWater(o),this._logGeometryCreationWarnings(o.renderData,r.rings,"rings","WaterSymbol3DLayer"),o.outGeometries.length===0?null:new e6(this,o.outGeometries,o.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayWater(e){const r=e.uvCoords,i=e.renderData.polygons;for(const{position:s,holeIndices:n,index:o,count:a}of i){if(Ri(r0),Cu(r0,s),!Zd(r0,this._context.clippingExtent))continue;IS(e.outBoundingBox,r0);const l=cv(s,n,3);if(l.length===0)continue;const c=Lh(r,2*o,2*a),h=Tne({material:this._material,indices:l,attributeData:{position:s,uv0:c}}),p=new uE(h,e),f=r0;ti(p.boundingSphere,.5*(f[0]+f[3]),.5*(f[1]+f[4]),0,.5*Math.sqrt((f[3]-f[0])*(f[3]-f[0])+(f[4]-f[1])*(f[4]-f[1]))),e.outGeometries.push(p)}}static headingVectorFromAngle(e){const r=Je(),i=h4(e);return r[0]=Math.sin(i),r[1]=Math.cos(i),r}test(){return{...super.test(),create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}};sH.unitSizeOfTexture=100,sH.elevationModeChangeTypes={definedChanged:ys.RECREATE,staysOnTheGround:ys.NONE,onTheGroundChanged:ys.RECREATE};const n$=Je(),t0=ur(),Woe=Je(),r0=En();let cht=class extends Z5{constructor(e,r){super(e,null,null),this.uvCoords=r}},uht=class extends Z5{constructor(e,r,i,s){super(e,i,s),this.uvCoords=r}};function hht(t,e,r,i){const s=Xoe[t.type]&&Xoe[t.type][e.type]||dht[e.type];return s?new s(t,e,r,i):(se.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory").error("GraphicsLayerFactory#make",`unknown symbol type ${e.type}`),null)}const dht={icon:Yj,object:Oct,line:V2e,path:Sut,fill:PSe,extrude:Dot,text:sht,water:sH},Xoe={"mesh-3d":{fill:hlt}};let pht=class extends AZ{set symbol(e){this._symbol=e,e.symbolLayers.forEach((r,i)=>{const s=this.symbolLayers[i];v(s)&&(s.symbol=e,s.symbolLayer=r)})}get symbol(){return this._symbol}constructor(e,r,i){super(r.schedule),this._symbol=e,this._context=r,this._backgroundLayers=i,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}async doLoad(e){let r=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(r=this._backgroundLayers.concat(r));const i=r.length;for(;this.symbolLayers.length<r.length;)this.symbolLayers.push(null);this.symbolLayers.length=r.length;const s=[];for(let n=0;n<i;n++){const o=r.getItemAt(n);if(o.enabled===!1)continue;o$.renderPriority=1-(1+n)/i,o$.renderPriorityStep=1/i,o$.ignoreDrivers=o._ignoreDrivers;const a=hht(this.symbol,o,this._context,o$),l=XH(e,()=>{this.symbolLayers[n]=null,a.destroy()});l&&s.push(l),this.symbolLayers[n]=a}if(await l4(this.symbolLayers,async(n,o)=>{if(v(n))try{await n.load(),this._extentPadding+=Math.max(this._extentPadding,n.extentPadding)}catch{this.symbolLayers[o]=null}}),s.forEach(n=>n.remove()),fr(e),this.symbolLayers.length&&!this.symbolLayers.some(n=>!!n))throw new Error}getSymbolLayerSize(e){const r=this.symbolLayers[e];return v(r)?r.getCachedSize():null}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some(e=>v(e)&&e.queryForSnapping)}createGraphics3DGraphic(e,r){const i=e.graphic,s=new Array(this.symbolLayers.length);for(let o=0;o<this.symbolLayers.length;o++){const a=this.symbolLayers[o];s[o]=v(a)?a.createGraphics3DGraphic(e):null}const n=this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null;return new ast(i,r||this,s,e.layer,n)}get complexity(){return OZ(this.symbolLayers.map(e=>Dn(e,"complexity")))}globalPropertyChanged(e,r){const i=this.symbolLayers.length;for(let s=0;s<i;s++){const n=this.symbolLayers[s],o=a=>{const l=a.layers[s];return l instanceof xm?l:null};if(v(n)&&!n.globalPropertyChanged(e,r,o))return!1}return!0}applyRendererDiff(e,r){return this.loadStatus!==yu.LOADED?wn.Recreate_Symbol:this.symbolLayers.reduce((i,s)=>i!==wn.Recreate_Symbol&&v(s)?Math.min(i,s.applyRendererDiff(e,r)):i,wn.Fast_Update)}prepareSymbolPatch(e){if(this.loadStatus===yu.FAILED||e.diff.type!=="partial")return;const r=e.diff.diff;if(!r.symbolLayers||r.symbolLayers.type!=="partial")return;const i=r.symbolLayers.diff;this.symbolLayers.forEach((s,n)=>{if(C(s))return;const o=i[n];if(o){const a={diff:o,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};s.prepareSymbolLayerPatch(a),e.symbolStatePatches.push(...a.symbolLayerStatePatches),a.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push((l,c)=>{const h=l.layers[n];v(h)&&a.graphics3DGraphicPatches.forEach(p=>p(h,c))})}})}updateGeometry(e,r){for(let i=0;i<this.symbolLayers.length;i++){const s=this.symbolLayers[i];if(C(s))continue;const n=e.layers[i];if(C(n)||!s.updateGeometry(n,r))return!1}return!0}onRemoveGraphic(e){for(let r=0;r<this.symbolLayers.length;r++){const i=this.symbolLayers[r];if(C(i))continue;const s=e.layers[r];v(s)&&i.onRemoveGraphic(s)}}getFastUpdateStatus(){let e=0,r=0,i=0;return this.symbolLayers.forEach(s=>{C(s)||(s.loadStatus===yu.LOADING?e++:s.isFastUpdatesEnabled()?i++:r++)}),{loading:e,slow:r,fast:i}}async queryForSnapping(e,r,i,s){const n=this.symbolLayers.filter(v).filter(a=>v(a.queryForSnapping)).map(a=>a.queryForSnapping(e,r,i,s)),o=await Promise.all(n);return fr(s),o.flat()}destroy(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{super.destroy();for(const e of this.symbolLayers)v(e)&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}};const o$={renderPriority:0,renderPriorityStep:1,ignoreDrivers:!1};let fht=class extends AZ{constructor(e,r,i){super(r),this.symbol=e,this._convert=i,this.symbologySnappingSupported=!1,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return v(this.graphics3DSymbol)?this.graphics3DSymbol.getSymbolLayerSize(e):null}get symbolLayers(){return v(this.graphics3DSymbol)?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return v(this.graphics3DSymbol)?this.graphics3DSymbol.extentPadding:0}async doLoad(e){const r=await this.symbol.fetchSymbol({signal:e});r.id=this.symbol.id,this.graphics3DSymbol=this._convert(r),v(this.graphics3DSymbol)&&await this.graphics3DSymbol.load()}createGraphics3DGraphic(e){return v(this.graphics3DSymbol)?this.graphics3DSymbol.createGraphics3DGraphic(e,this):null}get complexity(){return v(this.graphics3DSymbol)?this.graphics3DSymbol.complexity:RZ}globalPropertyChanged(e,r){return!!v(this.graphics3DSymbol)&&this.graphics3DSymbol.globalPropertyChanged(e,r)}applyRendererDiff(e,r){return v(this.graphics3DSymbol)?this.graphics3DSymbol.applyRendererDiff(e,r):wn.Recreate_Symbol}prepareSymbolPatch(e){v(this.graphics3DSymbol)&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e,r){return!!v(this.graphics3DSymbol)&&this.graphics3DSymbol.updateGeometry(e,r)}onRemoveGraphic(){}getFastUpdateStatus(){return v(this.graphics3DSymbol)?this.graphics3DSymbol.getFastUpdateStatus():{loading:1,fast:0,slow:0}}destroy(){v(this.graphics3DSymbol)&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return this.graphics3DSymbol===void 0}};function tJ(t){return t instanceof fht?t.graphics3DSymbol:t instanceof pht?t:null}const $O=se.getLogger("esri.views.3d.layers.graphics.labelPlacement");function mht(t){const e=Sht(t);if(C(e))return null;const r=ght(t,e);if(C(r))return null;const i=r.anchor,s=!!e.hasLabelVerticalOffset;return _ht({anchor:i,verticalOffset:e.verticalOffset,screenOffset:Je(),centerOffset:Ht(0,0,0,-1),centerOffsetUnits:"world",translation:M(),elevationOffset:0,hasLabelVerticalOffset:s},r,t)}function ght(t,e){if(e.anchor)return e;const r=t.labelClass.labelPlacement,i=tp[r],s=i||UF(t);return r&&!i&&$O.warnOncePerTick(`the requested label placement '${r}' is currently unsupported in SceneView.`),yht(s,t)}function rJ(t){const e=t.graphics3DGraphic.graphics3DSymbol,r=tJ(e);return v(r)?r.symbol.symbolLayers.getItemAt(0):null}function yht(t,e){const r=e.graphics3DGraphic.graphic.geometry;if(C(r))return null;if(v(e.disablePlacement))return e.labelClass.labelPlacement?($O.warnOncePerTick(Yoe(t.placement,e.disablePlacement.logEntityDescription)),UF(e)):t;const i=r.type;switch(i){case"polyline":case"polygon":case"extent":case"multipoint":if(e.labelClass.labelPlacement)return $O.warnOncePerTick(Yoe(t.placement,`'${i}' geometries`)),UF(e);break;case"point":case"mesh":return t}return t}function Yoe(t,e){return`the requested label placement '${t}' is currently unsupported for ${e} in SceneView.`}function UF(t){const e=t.graphics3DGraphic.graphic.geometry;if(C(e))return null;switch(e.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:null,anchor:"center"};case"polygon":{const r=rJ(t);return v(r)&&r.type==="extrude"?tp["above-center"]:{placement:"center-center",normalizedOffset:null,anchor:"center"}}case"point":case"mesh":return tp["above-center"];default:return}}function _ht(t,e,r){const i=r.graphics3DGraphic.graphic.geometry;if(C(i))return null;switch(i.type){case"point":bht(t,e,r);break;case"polygon":vht(t,e,r);break;case"mesh":iJ(t,e,r.graphics3DGraphic.layers[0])}return t}function vht(t,e,r){const i=rJ(r);if(!C(i))switch(i.type){case"extrude":{const s=r.graphics3DGraphic.layers[0];v(s)?(s.getBoundingBoxObjectSpace(ER),Yd(ER,t.translation),t.translation[2]=mv(ER)/2):ce(t.translation,0,0,0),iJ(t,e,s);break}}}function bht(t,e,r){const i=rJ(r);if(C(i))return;const s=r.graphics3DGraphic.layers[0];switch(v(s)?s.getCenterObjectSpace(t.translation):ce(t.translation,0,0,0),i.type){case"icon":case"text":wht(t,e,r,s);break;case"object":iJ(t,e,s)}}function wht(t,e,r,i){const{graphics3DGraphic:s}=r,n=v(i)?i.getScreenSize():null;if(!s.isDraped&&v(n)){const o=xht(r);jC[0]=n[0]/2*(e.normalizedOffset[0]-o[0]),jC[1]=n[1]/2*(e.normalizedOffset[1]-o[1]),t.screenOffset[0]=jC[0],t.hasLabelVerticalOffset?(t.centerOffset[1]=jC[1],t.centerOffsetUnits="screen"):t.screenOffset[1]=jC[1]}else t.hasLabelVerticalOffset||t.anchor==="center"||(tp[r.labelClass.labelPlacement]&&$O.warnOncePerTick(`the requested placement '${e.placement}' is currently unsupported for draped graphics`),t.anchor="center")}function xht(t,e=Eht){const{graphics3DGraphic:r}=t,i=r.layers[0],s=v(i)?i.stageObject.geometries[0].material:null;if(s&&s instanceof aE){const n=s.parameters.anchorPosition;e[0]=2*(n[0]-.5),e[1]=2*(n[1]-.5)}else e[0]=0,e[1]=0;return e}function iJ(t,e,r){const i=v(r)?r.getBoundingBoxObjectSpace(ER):ER,s=$e(i[3]-i[0],i[4]-i[1],i[5]-i[2]),n=Math.sqrt(s[0]*s[0]+s[1]*s[1]);t.centerOffset[0]=n/2*e.normalizedOffset[0];const o=t.translation[2],a=s[2]/2*e.normalizedOffset[1];t.translation[2]=0,t.elevationOffset=o+a;const l=Me(s);t.centerOffset[2]=l/2*e.normalizedOffset[2]}function Tht(t){return t==="above-center"}function Sht(t){const e=t.labelClass.labelPlacement,{labelSymbol:r,graphics3DGraphic:i}=t,s=tJ(i.graphics3DSymbol),n=so(s,a=>a.symbol.type==="point-3d"?a.symbol:null),o=tp[e]||UF(t);return v(n)&&n.supportsCallout()&&n.hasVisibleVerticalOffset()&&!i.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:Zoe(n.verticalOffset),anchor:null,normalizedOffset:null}:r&&r.hasVisibleVerticalOffset()&&(C(n)||!n.supportsCallout()||!n.verticalOffset||i.isDraped)?Tht(o.placement)?{placement:"above-center",verticalOffset:Zoe(r.verticalOffset),anchor:"bottom",normalizedOffset:[0,o.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:($O.errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+e+" placement)"),null):{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}}function Zoe(t){const{screenLength:e,minWorldLength:r,maxWorldLength:i}=t;return{screenLength:e,minWorldLength:r,maxWorldLength:i}}const tp={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},Joe={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const t in Joe){const e=Joe[t],r=tp[t];e.forEach(i=>{tp[i]=r})}Object.freeze&&(Object.freeze(tp),Object.keys(tp).forEach(t=>{Object.freeze(tp[t]),Object.freeze(tp[t].normalizedOffset)}));const jC=[0,0],Eht=[0,0],ER=En();let Koe=class{constructor(e){this._stage=e,this._materials=new Map}get(e){return this._materials.get(e)}add(e,r){this._materials.set(e,r),this._stage.add(r)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}};const H9=512,q9=4096,Cht=.85,Aht=.95;let Rht=class{constructor(){this.offset={x:0,y:0},this.uvMinMax=sr()}},Oht=class{constructor(e,r){this.textId=e,this.textRenderer=r,this.placement=new Rht,this.rendered=!1}},x3=class extends Te{constructor(e){super(e),this.type=$s.Texture,this.id=Pc(),this.events=new vs,this._glTexture=null,this._needsClear=!1,this._elementsToAddOrUpdate=new Map,this._elementsToRemove=new Map,this._elementsToRender=new Map,this._elements=new Map,this._stageObjects=new Map,this.updating=!1}initialize(){this._stage=this.view._stage,this._canvas=this._create2DCanvas(),this._ctx=this._canvas.getContext("2d"),this._stage.add(this);const e=this._computeAtlasResolution(this.view.width,this.view.height);this._createAtlasRegion(e),this._update2DCanvasSize(),this._resetAtlasCursor()}unload(){this._glTexture=Qe(this._glTexture),this.updating=!1,this.events.emit("unloaded")}get width(){return this._atlas.size.width}get height(){return this._atlas.size.height}get requiresFrameUpdates(){return!1}_createDescriptor(e){return{target:bt.TEXTURE_2D,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Rt.CLAMP_TO_EDGE,flipped:!0,samplingMode:tt.LINEAR_MIPMAP_LINEAR,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}}get glTexture(){return this._glTexture}load(e){return v(this._glTexture)||(this._glTexture=new ct(e,this._createDescriptor(e),this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(_t.TEXT_TEXTURE_ATLAS,this),this.setDirty()),this._glTexture}dispose(){this._elements=null,this._elementsToAddOrUpdate=null,this._elementsToRemove=null,this._elementsToRender=null,this._frameWorker=ji(this._frameWorker),this._glTexture&&(this._stage.remove(this),this._glTexture=Qe(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_create2DCanvas(){const e=document.createElement("canvas");return e.setAttribute("id","canvas2d"),e.setAttribute("style","display:none"),e.setAttribute("width",H9.toString()),e.setAttribute("height",H9.toString()),e}_update2DCanvasSize(){this._canvas.setAttribute("width",this._atlas.size.width.toString()),this._canvas.setAttribute("height",this._atlas.size.height.toString())}_createAtlasRegion(e=H9){this._atlas={size:{width:e,height:e},cursor:{x:0,y:0},lineHeight:0}}_computeAtlasResolution(e,r){let i=Math.max(e,r);return i+=256,i=ES(i),i=Math.min(i,q9),i}_resizeAtlas(e,r){r=r||e;const i=this._atlas;i.size.width=e,i.size.height=r,v(this._glTexture)&&this._glTexture.resize(e,r),this._update2DCanvasSize()}_resetAtlasCursor(){const e=this._atlas;e.cursor.x=HC,e.cursor.y=HC+Qoe,e.lineHeight=0,this._needsClear=!0}_getAtlasUsage(){const e=this._atlas;return(e.cursor.x+e.cursor.y*e.size.width)/(e.size.width*e.size.height)}_getExpectedAtlasUsage(){const e=this._elementsToRemove.size,r=this._elementsToAddOrUpdate.size,i=this._elements.size;return this._getAtlasUsage()/i*(i+r-e)}_addAtlasElement(e,r,i,s){const n=this._atlas,{renderedWidth:o,renderedHeight:a}=e.textRenderer;e.placement.offset.x=n.cursor.x,e.placement.offset.y=n.cursor.y,ti(e.placement.uvMinMax,e.placement.offset.x/n.size.width,1-(e.placement.offset.y+a)/n.size.height,(e.placement.offset.x+o)/n.size.width,1-e.placement.offset.y/n.size.height),n.cursor.x+=i,n.lineHeight=Math.max(n.lineHeight,s),this._elements.set(r,e)}_removeAtlasElement(e){if(e&&this._elements.has(e.textId)){const r=e.placement.offset;this._ctx.clearRect(r.x,r.y,e.textRenderer.renderedWidth,e.textRenderer.renderedHeight),this._elements.delete(e.textId)}}_ensureStageObjects(e){const r=this._stageObjects.get(e);if(r)return r;const i=new Set;return this._stageObjects.set(e,i),i}_addStageObject(e,r){this._ensureStageObjects(e).add(r)}_removeStageObject(e,r){const i=this._stageObjects.get(e);i&&i.delete(r)&&(r.geometries[0].vertexAttributes.get(A.SIZE).data=[0,0],r.geometryVertexAttrsUpdated(r.geometries[0]))}_processAddition(e,r){const i=this._atlas,s=e.textId,n=e.textRenderer.renderedWidth,o=e.textRenderer.renderedHeight,a=n+HC,l=o+HC+Qoe;if(i.cursor.x+a<i.size.width&&i.cursor.y+l<i.size.height)this._addAtlasElement(e,s,a,l),this._elementsToRender.set(s,e),this._elementsToAddOrUpdate.delete(s);else{if(!(i.cursor.y+l+i.lineHeight<i.size.height)){const c=this._getExpectedAtlasUsage(),h=c>Cht&&i.size.width<q9;return h&&this._resizeAtlas(2*i.size.width,2*i.size.height),!r||!h&&c>Aht&&i.size.width===q9?(this._processRemovals(),D2.OK):(this._repack(),D2.REPACK)}i.cursor.x=HC,i.cursor.y+=i.lineHeight,i.lineHeight=0,this._addAtlasElement(e,s,a,l),this._elementsToRender.set(s,e),this._elementsToAddOrUpdate.delete(s)}return D2.OK}_processRemovals(){this._elementsToRemove.forEach((e,r)=>{const i=this._stageObjects.get(r);i&&i.size!==0||this._removeAtlasElement(e),i&&i.size===0&&this._stageObjects.delete(r)}),this._elementsToRemove.clear()}_repack(){this._processRemovals(),this._elements.forEach((e,r)=>{e.rendered=!1,this._elementsToAddOrUpdate.set(r,e)}),this._elements.clear(),this._resetAtlasCursor(),this._elementsToRender.clear()}_processRenderingRequest(e){this._ctx.clearRect(e.placement.offset.x,e.placement.offset.y,e.textRenderer.renderedWidth,e.textRenderer.renderedHeight),e.textRenderer.render(this._ctx,e.placement.offset.x,e.placement.offset.y);const r=this._stageObjects.get(e.textId);r&&r.forEach(i=>{i.geometries[0].vertexAttributes.get(A.UV0).data=new Float32Array(e.placement.uvMinMax),i.geometries[0].vertexAttributes.get(A.SIZE).data=[e.textRenderer.displayWidth,e.textRenderer.displayHeight],i.geometryVertexAttrsUpdated(i.geometries[0])}),e.rendered=!0}get running(){return this.updating}runTask(e,r=!0){if(C(this._glTexture))return Zo.YIELD;let i=!1;if(Ho(this._elementsToAddOrUpdate,(n,o)=>{const a=this._elements.get(o);if(a&&a.rendered){const l=this._stageObjects.get(o);return l&&l.forEach(c=>{const h=c.geometries[0].vertexAttributes,p=this._elements.get(o);h.get(A.UV0).data=p.placement.uvMinMax,h.get(A.SIZE).data=[p.textRenderer.displayWidth,p.textRenderer.displayHeight],c.geometryVertexAttrsUpdated(c.geometries[0])}),this._elementsToAddOrUpdate.delete(o),e.madeProgress(),!1}return this._processAddition(this._elementsToAddOrUpdate.get(o),r)===D2.REPACK&&(i=!0,!0)}),i)return this.runTask(Xa,!1),void e.madeProgress();let s=!1;this._elementsToRender.size>0&&this._needsClear&&(this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._needsClear=!1),Ho(this._elementsToRender,(n,o)=>(this._processRenderingRequest(n),this._elementsToRender.delete(o),s=!0,e.madeProgress(),e.done)),s&&this._glTexture.setData(this._canvas),this.updating=this._elementsToRender.size>0,!this.updating&&Rst.orderedRepackingEnabled&&(this.repackOrdered(),e.madeProgress())}addTextTexture(e,r){const i=e.key;this._elementsToAddOrUpdate.has(i)||this._elementsToAddOrUpdate.set(i,new Oht(i,e)),this._addStageObject(i,r),this._elementsToRemove.delete(i),this.setDirty()}removeTextTexture(e,r){const i=e.key;this._elementsToRemove.set(i,this._elements.get(i)),this._removeStageObject(i,r)}setDirty(){this._glTexture&&(this.updating=!0)}repackOrdered(){if(this._elements.size===0)return;const e=[];this._elements.forEach((i,s)=>e.push({element:i,key:s}));let r=!0;for(let i=0;i<e.length-1;i++)if(e[i].key.localeCompare(e[i+1].key)>0){r=!1;break}if(!r||this._elementsToRemove.size){e.sort((i,s)=>i.key.localeCompare(s.key)),this._elements.clear();for(const{element:i,key:s}of e)this._elements.set(s,i);this._repack(),this.setDirty()}}get test(){const{_elements:e,_stageObjects:r,_elementsToRemove:i,_atlas:s}=this,n=this;return{elements:e,stageObjects:r,elementsToRemove:i,atlas:s,resizeAtlas:(o,a)=>n._resizeAtlas(o,a),run:(o,a)=>n.runTask(o,a)}}};u([d({constructOnly:!0})],x3.prototype,"view",void 0),u([d({type:Boolean})],x3.prototype,"updating",void 0),x3=u([I("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],x3);const HC=2,Qoe=2;var D2;(function(t){t[t.OK=0]="OK",t[t.REPACK=1]="REPACK"})(D2||(D2={}));let eae=class{constructor(e,r){this.labelingContext=e,this.graphics3DGraphic=r,this.hasGraphics3DResources=!1,this.visible=!1,this.rendered=!1,this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}},Mht=class{constructor(e,r,i,s,n){this.labelClass=e,this.graphics3DSymbol=r,this.graphics3DCalloutSymbolLayer=i,this.textRenderParameters=s,this.labelFunction=n,this.calloutSymbolLayerIndex=0}},Pht=class{constructor(e,r,i,s,n,o,a){this.layer=e,this.graphics3DCore=r,this.scaleVisibility=i,this.emptySymbolLabelSupported=s,this.elevationInfoOverride=n,this.disablePlacement=o,this.active=a,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new CTe({pickable:!0,disableOctree:!0},e.uid)}},sb=class extends Te{constructor(e){super(e),this._dirty=!1,this._labels=new Map,this._labelsToAdd=new Map,this._labelsToRemove=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this._handles=new ei,this._handles.add([ie(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},()=>this.setDirty()),ie(()=>{var e;return(e=this.view.state)==null?void 0:e.rasterPixelRatio},()=>this._resetAllLabels()),this.view.resourceController.scheduler.registerTask(_t.LABELER,this)]),this._textTextureAtlas=new x3({view:this.view}),this._hudMaterialCollection=new Koe(this.view._stage),this._calloutMaterialCollection=new Koe(this.view._stage)}dispose(){this._handles=ke(this._handles),this._textTextureAtlas=Qe(this._textTextureAtlas),this._hudMaterialCollection=Qe(this._hudMaterialCollection),this._calloutMaterialCollection=Qe(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear(),this._labelsToAdd.clear(),this._labelsToRemove.clear()}_activateLabelingContext(e){e.graphics.forEach((r,i)=>{const s=new eae(e,r);this._labels.set(i,s),e.labelsToInitialize.set(i,s),r.setVisibilityFlag(Ec.USER_SETTING,!0,So.LABEL)}),e.active=!0}_deactivateLabelingContext(e){e.graphics.forEach((r,i)=>{r.setVisibilityFlag(Ec.USER_SETTING,!1,So.LABEL),this.setLabelGraphicVisibility(r,!1),this._labels.delete(i)}),e.active=!1}_addLabelTextureToAtlas(e){for(const r of e.graphics3DGraphic.labelLayers){if(!r._labelClass)continue;const i=e.textRenderers[r._labelIndex];v(i)&&this._textTextureAtlas.addTextTexture(i,r.stageObject)}e.rendered=!0}_removeLabelTextureFromAtlas(e){for(const r of e.graphics3DGraphic.labelLayers){if(!r._labelClass)continue;const i=e.textRenderers[r._labelIndex];v(i)&&this._textTextureAtlas.removeTextTexture(i,r.stageObject)}e.rendered=!1}get running(){return this.view.ready&&(this._dirty||this.deconflictor.running)}runTask(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e),Zo.YIELD}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const r of this._labelingContexts)if(r.active){if(!tae(r)){if(Iht(r)){this._deactivateLabelingContext(r);continue}if(this._createLabelClassContext(r),W9(r)){this._dirty=!0;continue}if(!tae(r))continue}Ho(r.labelsToInitialize,(i,s)=>(this._ensureGraphics3DResources(i)&&(this._labels.set(s,i),this.deconflictor.setDirty(),e.madeProgress()),(i.visible&&i.textInitialized||!i.visible&&i.hasGraphics3DResources)&&(r.labelsToInitialize.delete(s),e.madeProgress()),e.done))&&(this._dirty=!0)}this._labelsToRemove.forEach(r=>this._removeLabelTextureFromAtlas(r)),this._labelsToAdd.forEach(r=>this._addLabelTextureToAtlas(r)),this._labelsToRemove.clear(),this._labelsToAdd.clear(),this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){var o,a,l;const r=(o=e.labelClassAbortController)==null?void 0:o.signal;await((l=(a=e.layer).when)==null?void 0:l.call(a)),fr(r),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const i=e.graphics3DCore,s=i.layer,n=s.labelingInfo&&s.labelingInfo.filter(c=>!!c.symbol);!n||n.length===0||(await l4(n,async(c,h)=>{const p=c.symbol,f=tJ(i.getOrCreateGraphics3DSymbol(p));if(C(f))return void se.getLogger(this.declaredClass).error("Failed to create Graphics3DSymbol for label");await f.load(),fr(r);let m=null;hW(p)&&p.hasVisibleCallout()&&(m=sst(p,i.symbolCreationContext),await m.load(),fr(r));const y=await hp(zxe(c,e.layer.fieldsIndex,this.view.spatialReference));if(fr(r),y.ok===!0){const _=await this._createTextRenderParameters(f.symbol);fr(r),e.labelClassContexts[h]=new Mht(c,f,m,_,y.value)}else se.getLogger(this.declaredClass).error(`Label expression failed to evaluate: ${y.error}`)}),fr(r))}async _createLabelClassContext(e){return C(e.labelClassPromise)&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch(r=>{if(Qs(r))throw r;e.labelClassContexts.length=0}).then(()=>{e.labelClassAbortController=null,this.notifyChange("updating")}).catch(()=>{}),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const r=e.symbolLayers.getItemAt(0);return r&&r.type==="text"?$Se.fromSymbol(r,this.view.state.rasterPixelRatio):null}_destroyLabelClassContext(e){for(const i of e.labelClassContexts)--i.graphics3DSymbol.referenced;const r=e.labelClassAbortController;e.labelClassAbortController=new AbortController,Fh(r),e.labelClassContexts.length=0,e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,r,i,s,n){const o=new jxe(i.verticalOffset,poe(i.anchor),Jot(i.anchor),e.text,i.translation,i.elevationOffset,i.centerOffset,i.screenOffset,i.centerOffsetUnits,e.displayWidth,e.displayHeight);return i0.graphic=r,i0.renderingInfo=null,i0.layer=s,n.createLabel(i0,o,this._hudMaterialCollection,this._textTextureAtlas)}_createLineCalloutGraphic(e,r,i,s,n){return i0.graphic=e,i0.layer=n,i0.renderingInfo=new rst(null,r,s.translation,s.centerOffset,s.screenOffset,s.centerOffsetUnits,s.elevationOffset,this._calloutMaterialCollection),i.createGraphics3DGraphic(i0)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const r=e.graphics3DGraphic;if(r.destroyed)return!1;this._ensureTextTextureResources(e);const i=e.labelingContext,s=i.labelClassContexts;if(!s||s.length===0||!i.emptySymbolLabelSupported&&r.layers.length===0)return!1;let n=!1;const o=r.graphic,a=i.layer,l=a$(i.layer),c=this.view._stage;for(let h=0;h<s.length;h++){const p=e.textRenderers[h],f=e.textLabelPlacements[h];if(C(p)||C(f))continue;const m=s[h],y=m.graphics3DSymbol,_=y.symbol&&y.symbol.type==="label-3d"?y.symbol:null,b=y.symbolLayers[0];if(!b)continue;b.setElevationInfoOverride(i.elevationInfoOverride);const x=this._createTextSymbolGraphic(p,o,f,a,b);if(C(x))return!1;x._labelClass=m.labelClass,x._labelIndex=h,r.addLabelGraphic(x,c,i.stageLayer),r.setVisibilityFlag(Ec.USER_SETTING,l,So.LABEL),r.clearVisibilityFlag(Ec.SCALE_RANGE,So.LABEL),r.setVisibilityFlag(Ec.DECONFLICTION,!1,So.LABEL),n=!0;const T=m.graphics3DCalloutSymbolLayer;if(T&&f.hasLabelVerticalOffset){T.setElevationInfoOverride(i.elevationInfoOverride);const S=this._createLineCalloutGraphic(o,_,T,f,a);v(S)&&(m.calloutSymbolLayerIndex=r.labelLayers.length,r.addLabelGraphic(S,c,i.stageLayer))}break}return i.scaleVisibility&&n&&i.scaleVisibility.updateGraphicLabelScaleVisibility(r),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const r=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelLayers){if(i._labelClass==null)continue;const s=r[i._labelIndex].graphics3DSymbol.symbolLayers[0];s!=null&&s.onRemoveGraphic(i)}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){var n;if(e.textInitialized)return;const r=e.labelingContext,i=r.labelClassContexts;if(!i||i.length===0)return;const s=e.graphics3DGraphic.graphic;for(let o=0;o<i.length;o++){const a=i[o];if(e.textRenderers[o]=null,e.textLabelPlacements[o]=null,!a.textRenderParameters)continue;const l=a.labelFunction;let c;if(l.type==="arcade")try{const T=l.needsHydrationToEvaluate()?tit(s,r.layer):s;c=l.evaluate(T)}catch{c=null}else c=l.evaluate(s);if(C(c)||c===""||/^\s+$/.test(c))continue;const h=a.graphics3DSymbol,p=((n=h.symbol)==null?void 0:n.type)==="label-3d"?h.symbol:null;if(!h.symbolLayers[0])continue;const f=e.graphics3DGraphic,m=a.labelClass,y=r.disablePlacement,_=mht({graphics3DGraphic:f,labelSymbol:p,labelClass:m,disablePlacement:y});if(C(_))continue;const b=poe(_.anchor),x=P2e(b);e.textRenderers[o]=new O2e(c,x,a.textRenderParameters),e.textLabelPlacements[o]=_}e.textInitialized=!0}_destroyTextTextureResources(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}_addGraphic(e,r){const i=r.graphic.uid;if(e.graphics.set(i,r),e.active){const s=new eae(e,r);this._labels.set(i,s),e.labelsToInitialize.set(i,s)}this.setDirty(),this.deconflictor.setDirty()}_removeGraphic(e,r){const i=r.graphic.uid,s=this._labels.get(i);e.graphics.delete(i),s&&(this._destroyGraphic(s,i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,r){this._labels.has(r)&&(this._labels.delete(r),this._labelsToAdd.delete(r),this._labelsToRemove.delete(r)),e.textInitialized&&(this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e)),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,r){if(!r)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const i of r){const s=e.graphics.get(i);s&&(this._removeGraphic(e,s),this._addGraphic(e,s))}}_globalPropertyChanged(e,r){for(const i of r.labelClassContexts){const s=new Map;r.graphics.forEach(o=>s.set(o.graphic.uid,o));const n=o=>o.labelLayers[0];if(i.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,s,n),i.graphics3DCalloutSymbolLayer){const o=a=>a.labelLayers[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,s,o)}}}_visibilityInfoChange(e){const r=a$(e.layer);r&&!e.active&&this._activateLabelingContext(e),!r&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.graphics.forEach((r,i)=>{const s=this._labels.get(i);s&&(this._destroyGraphic(s,i),s.visible=!1,s.rendered=!1,e.labelsToInitialize.set(i,s))}),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const r of this._labelingContexts)if(r.graphics3DCore===e)return r;return null}addGraphicsOwner(e,r,i){const s=i&&i.emptySymbolLabelSupported||!1,n=i&&i.elevationInfoOverride||null,o=i&&i.disablePlacement||null;if(this._findLabelingContext(e))return;const a=e.layer,l=new Pht(a,e,r,s,n,o,a$(a));return this.view._stage.add(l.stageLayer),this._labelingContexts.push(l),this.setDirty(),{addGraphic:c=>this._addGraphic(l,c),removeGraphic:c=>this._removeGraphic(l,c),featureReductionChange:()=>{},layerLabelsEnabled:()=>a$(l.layer),labelingInfoChange:c=>this._labelingInfoChange(l,c),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",l),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",l),visibilityInfoChange:()=>this._visibilityInfoChange(l),reset:()=>this._resetLabels(l),clear:()=>{}}}removeGraphicsOwner(e){const r=this._findLabelingContext(e);if(!r)return;const i=this._labelingContexts.indexOf(r);this._labelingContexts.splice(i,1),r.graphics.forEach(s=>this._removeGraphic(r,s)),this.view._stage.remove(r.stageLayer),this.setDirty()}setLabelGraphicVisibility(e,r){const i=e.graphic.uid,s=this._labels.get(i);s&&s.visible!==r&&(r&&!s.rendered?(this._labelsToAdd.set(i,s),this._labelsToRemove.delete(i),s.textInitialized||s.labelingContext.labelsToInitialize.set(i,s)):!r&&s.rendered&&(this._labelsToRemove.set(i,s),this._labelsToAdd.delete(i)),s.visible=r,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){var e;return this._dirty||((e=this._textTextureAtlas)==null?void 0:e.updating)||this.deconflictor.updating||this._labelingContexts.some(r=>W9(r))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce((r,i)=>r+(W9(i)?0:1),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}};function W9(t){return!!t.labelClassPromise&&!!t.labelClassAbortController}function tae(t){return t.labelClassContexts&&t.labelClassContexts.length}function Iht(t){return t.labelClassContexts===null}function a$(t){var e;return t.labelsVisible===!0&&!!((e=t.labelingInfo)!=null&&e.some(r=>!!r.symbol))}u([d({constructOnly:!0})],sb.prototype,"view",void 0),u([d({constructOnly:!0})],sb.prototype,"deconflictor",void 0),u([d()],sb.prototype,"_textTextureAtlas",void 0),u([d({type:Boolean,readOnly:!0})],sb.prototype,"updating",null),sb=u([I("esri.views.3d.layers.graphics.Labeler")],sb);const i0=new ist(null,null,null);let T3=class l2{constructor(e,r,i,s=null){this.lij=[0,0,0],this.extent=ur(),this.resolution=0,this.loadPriority=0,this.measures={visibility:oa.VISIBLE_ON_SURFACE,screenRect:ur(),distance:0,shouldSplit:!1},this.used=!1,s&&this.acquire(e,r,i,s)}acquire(e,r,i,s){this.tilingScheme=s,this.id=l2.id(e,r,i),this.lij[0]=e,this.lij[1]=r,this.lij[2]=i,s.getExtent(e,r,i,this.extent),this.resolution=s.resolutionAtLevel(e)}release(){this.tilingScheme=null}getChildren(e){const r=this.lij[0]+1,i=2*this.lij[1],s=2*this.lij[2];return e?(e[0].acquire(r,i,s,this.tilingScheme),e[1].acquire(r,i+1,s,this.tilingScheme),e[2].acquire(r,i,s+1,this.tilingScheme),e[3].acquire(r,i+1,s+1,this.tilingScheme),e):[new l2(r,i,s,this.tilingScheme),new l2(r,i+1,s,this.tilingScheme),new l2(r,i,s+1,this.tilingScheme),new l2(r,i+1,s+1,this.tilingScheme)]}copyMeasurementsFrom(e){this.measures.visibility=e.measures.visibility,this.measures.shouldSplit=e.measures.shouldSplit,this.measures.distance=e.measures.distance,Kg(e.measures.screenRect,this.measures.screenRect)}static id(e,r,i){return`${e}/${r}/${i}`}};var oa;(function(t){t[t.INVISIBLE=0]="INVISIBLE",t[t.VISIBLE_WHEN_EXTENDED=1]="VISIBLE_WHEN_EXTENDED",t[t.VISIBLE_ON_SURFACE=2]="VISIBLE_ON_SURFACE"})(oa||(oa={}));const DSe=.5*Math.PI,$ht=DSe/Math.PI*180;let Lht=class{constructor(e){this._renderCoordsHelper=e.renderCoordsHelper,this._extent=new Array(4),this._planes=new Array(6),this._maxSpan=0,this._center={origin:M(),direction:M()};for(let r=0;r<4;r++)this._extent[r]={origin:M(),direction:M(),cap:{next:null,direction:M()}},this._planes[r]=zr();this._planes[vi.NEAR]=zr(),this._planes[vi.FAR]=zr(),this._planesWithoutFar=this._planes.slice(0,5)}update(e,r,i,s=!0){const n=this._extent;this._toRenderBoundingExtent(e,r,i),fe(this._center.origin,n[0].origin,n[2].origin),ae(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),s||ae(this._center.direction,this._center.direction,-1);for(let o=0;o<4;o++){const a=n[o];this._renderCoordsHelper.worldUpAtPosition(a.origin,a.direction);const l=n[o===3?0:o+1];a.cap.next=l.origin,ay(a.cap.direction,a.origin,l.origin),KR(a.direction,a.cap.direction,a.origin,this._planes[o]),s||ae(a.direction,a.direction,-1)}KR(n[0].cap.direction,n[1].cap.direction,n[0].origin,this._planes[vi.NEAR]),s?iz(this._planes[vi.NEAR],this._planes[vi.FAR]):(V4(this._planes[vi.FAR],this._planes[vi.NEAR]),iz(this._planes[vi.NEAR],this._planes[vi.NEAR])),this._maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this._maxSpanSpatialReference=r,this._minGlobalAltitude=.9*Jr(this._maxSpanSpatialReference).radius}isVisibleInFrustum(e,r,i=!1){if(e==null)return!1;if(this._renderCoordsHelper.viewingMode===Be.Global){const n=this._maxSpanSpatialReference.isGeographic?$ht:DSe*r;if(this._maxSpan>n)return!0;if(e.altitude!=null&&e.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(e)}if(this._maxSpan===0){const n=this._extent[0];return!(i||!e.intersectsRay(Du(n.origin,n.direction)))}for(let n=0;n<this._extent.length;n++){const o=this._extent[n];if(!i&&e.intersectsRay(Du(o.origin,o.direction))||e.intersectsLineSegment(Yb(o.origin,o.cap.next,Nht),o.cap.direction))return!0}const s=i?this._planes:this._planesWithoutFar;for(let n=0;n<e.lines.length;n++){const o=e.lines[n];if(eJe(s,o.origin,o.endpoint,o.direction))return!0}return!1}_toRenderBoundingExtentGlobal(e,r,i){rW(e,cd),cd[2]=i,gp(r,cd,X9,this._renderCoordsHelper.spatialReference),Oo(rae,X9),Ri(Ql);for(const{x0:n,x1:o,y0:a,y1:l}of Dht)for(let c=0;c<5;c++){const h=c/4;cd[0]=Ft(e[n],e[o],h),cd[1]=Ft(e[a],e[l],h),cd[2]=i,no(cd,r,cd,this._renderCoordsHelper.spatialReference),We(cd,cd,rae),lm(Ql,cd)}ce(this._extent[0].origin,Ql[0],Ql[1],Ql[2]),ce(this._extent[1].origin,Ql[3],Ql[1],Ql[2]),ce(this._extent[2].origin,Ql[3],Ql[4],Ql[2]),ce(this._extent[3].origin,Ql[0],Ql[4],Ql[2]);for(let n=0;n<4;++n)We(this._extent[n].origin,this._extent[n].origin,X9)}_toRenderBoundingExtentLocal(e,r,i){N4(e,r,Vm,this._renderCoordsHelper.spatialReference),ce(this._extent[0].origin,Vm[0],Vm[1],i),ce(this._extent[1].origin,Vm[2],Vm[1],i),ce(this._extent[2].origin,Vm[2],Vm[3],i),ce(this._extent[3].origin,Vm[0],Vm[3],i)}_toRenderBoundingExtent(e,r,i){switch(this._renderCoordsHelper.viewingMode){case Be.Global:this._toRenderBoundingExtentGlobal(e,r,i);break;case Be.Local:this._toRenderBoundingExtentLocal(e,r,i);break;default:this._renderCoordsHelper.viewingMode}}_isVisibleInFrustumGlobal(e){if(bi(e.planes[vi.NEAR],this._center.origin)<0&&ye(this._center.direction,e.direction)<0)return!0;for(let r=0;r<4;r++){const i=this._extent[r];if(bi(e.planes[vi.NEAR],i.origin)<0&&ye(i.direction,e.direction)<0)return!0}return!1}};const Dht=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],cd=M(),X9=Ie(),rae=Ie(),Ql=En(),Vm=ur(),Nht=xp();let Fht=class{constructor(e){this._renderCoordsHelper=e,this._surfaceElevation=0,this._cache=new Map,this._frustum=new h_(e),this._extendedFrustum=new h_(e),this._intersector=new Lht({renderCoordsHelper:e}),this._renderCoordsHelper=e}begin(e,r){this._surfaceElevation=r,this._aboveGround=this._renderCoordsHelper.getAltitude(e.eye)>r,this._frustum.update(e),this._shortenFrustumFarPlane(this._frustum),this._updateExtendedFrustum(e)}end(){this._cache.clear()}calculate(e){if(this._allTilesInvisible)return oa.INVISIBLE;const r=this._renderCoordsHelper.viewingMode===Be.Global&&e.lij[0]>=Uht&&e.lij[0]<kht,i=this._getOrCalculateSingleTileVisibility(e,!r);return i!==oa.INVISIBLE&&r?this._calculateAggregatedChildrenVisibility(e):i}_shortenFrustumFarPlane(e){const r=h_.nearFarLineIndices,i=e.mutablePoints;for(const s of r){const[n,o]=s,a=i[n],l=i[o];me(Xc,l,a),ae(Xc,Xc,Bht),fe(i[o],a,Xc)}e.updatePoints(i)}_calculateAggregatedChildrenVisibility(e){let r=oa.INVISIBLE;const i=this._cache.get(e.id);if(i!=null)return i;const s=oae.acquire();e.getChildren(s);for(const n of s){const o=this.calculate(n);if(o!==oa.INVISIBLE&&(r=o,o===oa.VISIBLE_ON_SURFACE))break}return oae.release(s),this._cache.set(e.id,r),r}_getOrCalculateSingleTileVisibility(e,r){const i=this._cache.get(e.id);if(i!=null)return i;const s=this._calculateSingleTileVisibility(e);return r&&this._cache.set(e.id,s),s}_calculateSingleTileVisibility(e){return!this._aboveGround&&this._renderCoordsHelper.viewingMode===Be.Global&&e.lij[0]<Vht?this._calculateSingleTileVisibilitySided(e,!1)===oa.INVISIBLE?this._calculateSingleTileVisibilitySided(e,!0):void 0:this._calculateSingleTileVisibilitySided(e,this._aboveGround)}_calculateSingleTileVisibilitySided(e,r){this._intersector.update(e.extent,e.tilingScheme.spatialReference,this._surfaceElevation,r);const i=Jr(e.tilingScheme.spatialReference).radius;return this._intersector.isVisibleInFrustum(this._extendedFrustum,i)?this._intersector.isVisibleInFrustum(this._frustum,i,!0)?oa.VISIBLE_ON_SURFACE:oa.VISIBLE_WHEN_EXTENDED:oa.INVISIBLE}_updateExtendedFrustum(e){this._extendedFrustum.update(e),this._shortenFrustumFarPlane(this._extendedFrustum);const r=this._renderCoordsHelper.worldUpAtPosition(e.eye,Xc);this._aboveGround||ga(r,r);const i=Sn(-ye(r,e.viewForward));if(this._allTilesInvisible=i>(Math.PI+e.fovY)/2,this._allTilesInvisible||(this._hasExtendedFrustum=i>e.fovY/2,!this._hasExtendedFrustum))return;const s=this._extendedFrustumParameters(),n=this._extendedFrustum.mutablePoints;for(let o=0;o<4;o++){const a=s.pointIndices[o],l=n[a],c=this._renderCoordsHelper.getAltitude(l);if(s.needsAltitudeAdjustment(c)){switch(this._renderCoordsHelper.worldUpAtPosition(l,Xc),a){case nt.FAR_BOTTOM_LEFT:case nt.FAR_TOP_LEFT:case nt.NEAR_BOTTOM_LEFT:case nt.NEAR_TOP_LEFT:sz(this._extendedFrustum.planes[vi.LEFT],Xc,Xc);break;case nt.FAR_BOTTOM_RIGHT:case nt.FAR_TOP_RIGHT:case nt.NEAR_BOTTOM_RIGHT:case nt.NEAR_TOP_RIGHT:sz(this._extendedFrustum.planes[vi.RIGHT],Xc,Xc)}ae(Xc,Xc,s.direction),this._renderCoordsHelper.intersectInfiniteManifold(Du(l,Xc),s.zWithMargin,l)}}if(this._extendedFrustum.updatePoints(n),la(n[nt.NEAR_BOTTOM_LEFT],n[nt.NEAR_BOTTOM_RIGHT],n[nt.NEAR_TOP_RIGHT],sae),la(n[nt.NEAR_BOTTOM_RIGHT],n[nt.NEAR_TOP_RIGHT],n[nt.NEAR_TOP_LEFT],nae),ye(sae,nae)<0){const o=this._extendedFrustum.mutablePoints;this._aboveGround?[o[nt.NEAR_BOTTOM_LEFT],o[nt.NEAR_BOTTOM_RIGHT]]=[o[nt.NEAR_BOTTOM_RIGHT],o[nt.NEAR_BOTTOM_LEFT]]:[o[nt.NEAR_TOP_LEFT],o[nt.NEAR_TOP_RIGHT]]=[o[nt.NEAR_TOP_RIGHT],o[nt.NEAR_TOP_LEFT]],this._extendedFrustum.updatePoints(o)}}_extendedFrustumParameters(){return this._aboveGround?this._extendedFrustumParametersAboveSurface():this._extendedFrustumParametersBelowSurface()}_extendedFrustumParametersAboveSurface(){const e=this._surfaceElevation-iae;return{zWithMargin:e,pointIndices:h_.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:r=>r>e}}_extendedFrustumParametersBelowSurface(){const e=this._surfaceElevation+iae;return{zWithMargin:e,pointIndices:h_.planePointIndices.top,direction:1,needsAltitudeAdjustment:r=>r<e}}};const Uht=2,kht=6,Vht=12,Bht=.95,iae=1,Xc=M(),sae=zr(),nae=zr(),oae=new Co(Array,t=>{t.length!==4&&(t[0]=new T3,t[1]=new T3,t[2]=new T3,t[3]=new T3)},t=>{t[0].release(),t[1].release(),t[2].release(),t[3].release()});let zht=class{constructor(e){this._camera=new Ct,this._focusOnMap=[0,0],this._screenRect=ur(),this._tileSize=e.tileSize,this._renderCoordsHelper=e.renderCoordsHelper,this._tilingScheme=e.tilingScheme,this._visibility=new Fht(e.renderCoordsHelper)}begin(e,r,i){this._camera.copyFrom(e),this._surfaceElevation=i,this._focusOnMap[0]=r.x,this._focusOnMap[1]=r.y,eW(0,0,e.fullWidth,e.fullHeight,this._screenRect),this._visibility.begin(this._camera,i)}end(){this._visibility.end()}updateTile(e){e.measures.visibility=this._visibility.calculate(e),e.measures.distance=_$e(e.extent,this._focusOnMap),e.measures.visibility!==oa.INVISIBLE&&this._updateScreenMeasure(e)}_updateScreenMeasure(e){const r=Ght,i=1<<r,s=e.measures.screenRect;zh(s);let n=0;const o=e.lij[0]+r,a=e.lij[1]<<r,l=e.lij[2]<<r,c=this._tileSizeWithBias(e),h=c*c;for(let p=0;p<i;p++)for(let f=0;f<i;f++)if(n+=this._computeScreenArea(e,o,a+p,l+f,s),n>h)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1}_tileSizeWithBias(e){return e.measures.visibility===oa.VISIBLE_WHEN_EXTENDED?this._tileSize*jht:this._tileSize}_computeScreenArea(e,r,i,s,n){const o=e.measures.visibility===oa.VISIBLE_WHEN_EXTENDED;this._projectToScreen(r,i,s,o,s0),zh(Y9);for(let a=0;a<4;a++)tW(Y9,s0[a]);return L_(n,Y9,n),bie(s0[0],s0[1],s0[2])+bie(s0[0],s0[2],s0[3])}_projectToScreen(e,r,i,s,n){this._tilingScheme.ensureMaxLod(e),this._tilingScheme.getExtent(e,r,i,qC),this._toRenderCoords(qC,0,3,n0[0]),this._toRenderCoords(qC,2,3,n0[1]),this._toRenderCoords(qC,2,1,n0[2]),this._toRenderCoords(qC,0,1,n0[3]),s&&(this._projectToPlane(n0,this._camera.frustum[vi.NEAR]),this._projectToPlane(n0,this._camera.frustum[vi.TOP]),this._projectToPlane(n0,this._camera.frustum[vi.BOTTOM]));for(let o=0;o<4;o++)this._camera.projectToRenderScreen(n0[o],aae),this._camera.renderToScreen(aae,n[o])}_projectToPlane(e,r){for(let s=0;s<4;s++)XC[s]=bi(r,e[s]);const i=Math.max(XC[0],XC[1],XC[2],XC[3]);if(i>0){const s=ae(WC,r,-i);for(let n=0;n<4;n++)fe(e[n],e[n],s)}}_toRenderCoords(e,r,i,s){return WC[0]=e[r],WC[1]=e[i],WC[2]=this._surfaceElevation,this._renderCoordsHelper.toRenderCoords(WC,this._tilingScheme.spatialReference,s),s}};const Y9=ur(),Ght=2,jht=5,s0=[as(),as(),as(),as()],qC=ur(),WC=M(),n0=[M(),M(),M(),M()],XC=[0,0,0,0],aae=qo();function VIt(t,e,r){if(C(t)||C(r))return!1;let i=!0;return fn[0]=t.xmin!=null?t.xmin:0,fn[1]=t.ymin!=null?t.ymin:0,fn[2]=t.zmin!=null?t.zmin:0,i=i&&_s(fn,t.spatialReference,0,e,r,0,1),fn[0]=t.xmax!=null?t.xmax:0,fn[1]=t.ymax!=null?t.ymax:0,fn[2]=t.zmax!=null?t.zmax:0,i=i&&_s(fn,t.spatialReference,0,e,r,3,1),t.xmin==null&&(e[0]=-1/0),t.ymin==null&&(e[1]=-1/0),t.zmin==null&&(e[2]=-1/0),t.xmax==null&&(e[3]=1/0),t.ymax==null&&(e[4]=1/0),t.zmax==null&&(e[5]=1/0),i}function NSe(t,e,r){if(C(t)||C(r))return!1;let i=!0;return fn[0]=t.xmin!=null?t.xmin:0,fn[1]=t.ymin!=null?t.ymin:0,fn[2]=t.zmin!=null?t.zmin:0,i=i&&_s(fn,t.spatialReference,0,fn,r,0,1),e[0]=fn[0],e[1]=fn[1],fn[0]=t.xmax!=null?t.xmax:0,fn[1]=t.ymax!=null?t.ymax:0,fn[2]=t.zmax!=null?t.zmax:0,i=i&&_s(fn,t.spatialReference,0,fn,r,0,1),e[2]=fn[0],e[3]=fn[1],t.xmin==null&&(e[0]=-1/0),t.ymin==null&&(e[1]=-1/0),t.xmax==null&&(e[2]=1/0),t.ymax==null&&(e[3]=1/0),i}const fn=M();let xo=class extends Te{get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(v(e)&&!e.spatialReference.equals(this.viewState.spatialReference))return void se.getLogger(this.declaredClass).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const r=this._get("filterExtent");if(r===e||v(r)&&e&&r.equals(e))return;const i=v(e)?e.clone():null;this._set("filterExtent",i),this._setDirty()}get _filterExtentRect(){if(C(this.filterExtent))return null;const e=ur();return NSe(this.filterExtent,e,this.tilingScheme.spatialReference),e}get _rootTileIds(){const{tilingScheme:e}=this;return this._filterExtentRect&&e?e.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}constructor(e){super(e),this.tiles=new Pt,this.tileSize=512,this._idToTile=new Map,this._handles=new ei,this._clients=new Set,this._dirty=!1,this._pendingTiles=null,this._newTiles=new Jt}initialize(){this._handles.add([ie(()=>[this.tilingScheme,this.tileSize],()=>this._reset(),ri),ie(()=>{var e,r,i;return[this.tileSize,(e=this.cameraOnSurface)==null?void 0:e.location,this.tilingScheme,(r=this.viewState)==null?void 0:r.contentCamera,(i=this.focus)==null?void 0:i.location]},()=>this._setDirty(),js)]),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(_t.FEATURE_TILE_TREE,this))}destroy(){this._frameWorker=ji(this._frameWorker),this._handles=ke(this._handles)}addClient(){const e=qht();return this._clients.add(e),this._clients.size===1&&this._setDirty(),{remove:()=>this._removeClient(e)}}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(Xa))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}get running(){return this.updating}runTask(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),v(this._frameWorker)&&(this._frameWorker.priority=_t.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),!this._pendingTiles&&v(this._frameWorker)&&(this._frameWorker.priority=_t.FEATURE_TILE_TREE),this.notifyChange("updating")}_startUpdate(){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new zht({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize}));const e=this.viewState.contentCamera;this._tileMeasurements.begin(e,this.focus.location,this.cameraOnSurface.location.z??0),this._pendingTiles=this._getRootTiles()}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}_getRootTiles(){const{tilingScheme:e}=this;return this._rootTileIds.map(r=>new T3(r[0],r[1],r[2],e))}_purgeHorizonTiles(e){e.sort((r,i)=>{const s=r.measures.screenRect,n=i.measures.screenRect;return s[1]+s[3]-(n[1]+n[3])}),zh(l$);for(let r=0;r<e.length;r++)if(L_(l$,e.data[r].measures.screenRect,l$),fp(l$)>Wht)return e.data.slice(r,e.length);return[]}_subdivideTilesForView(e){if(!this._pendingTiles)return;const{tilingScheme:r}=this;for(;this._pendingTiles.length>0&&!e.done;){const i=this._pendingTiles.pop();e.madeProgress(),this._filterExtentRect&&!x4(this._filterExtentRect,i.extent)||(this._tileMeasurements.updateTile(i),i.measures.visibility!==oa.INVISIBLE&&(i.measures.shouldSplit?(r.ensureMaxLod(i.lij[0]+1),this._pendingTiles.push(...i.getChildren())):this._newTiles.push(i)))}this._pendingTiles.length===0&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}_updateTiles(e){for(const s of this.tiles.items)s.used=!1;const r=e.filter(s=>{const n=this._idToTile.get(s.id);return n?(n.copyMeasurementsFrom(s),n.used=!0):this._idToTile.set(s.id,s),!n}),i=this.tiles.items.filter(s=>!s.used&&(this._idToTile.delete(s.id),!0));this.tiles.removeMany(i),this.tiles.addMany(r),this._sortTiles()}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort((e,r)=>e.measures.visibility!==r.measures.visibility?e.measures.visibility===oa.VISIBLE_ON_SURFACE?-1:1:e.measures.distance-r.measures.distance),this.tiles.forEach((e,r)=>e.loadPriority=r)}};u([d({constructOnly:!0})],xo.prototype,"scheduler",void 0),u([d({constructOnly:!0})],xo.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],xo.prototype,"tilingSchemeOwner",void 0),u([d({constructOnly:!0})],xo.prototype,"cameraOnSurface",void 0),u([d({constructOnly:!0})],xo.prototype,"focus",void 0),u([d({constructOnly:!0})],xo.prototype,"viewState",void 0),u([d({constructOnly:!0})],xo.prototype,"terrain",void 0),u([d()],xo.prototype,"tiles",void 0),u([d()],xo.prototype,"tileSize",void 0),u([d({readOnly:!0})],xo.prototype,"tilingScheme",null),u([d()],xo.prototype,"filterExtent",null),u([d({readOnly:!0})],xo.prototype,"_filterExtentRect",null),u([d({readOnly:!0})],xo.prototype,"_rootTileIds",null),u([d({value:!1})],xo.prototype,"suspended",null),u([d({readOnly:!0})],xo.prototype,"updating",null),xo=u([I("esri.views.3d.layers.support.FeatureTileTree3D")],xo);let Hht=0;function qht(){return Hht++}const l$=ur(),Wht=10;let hn=class extends Te{constructor(){super(...arguments),this._propertiesPool=new ty({camera:Ct},this),this._lastSeenCameraProjectionValues=new Ct,this.mode=Sr.ANIMATING,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.events=new vs,this.viewingMode=Be.Global,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}init(e,r){this._set("viewingMode",e),this._set("spatialReference",r),this._set("constraints",new dg({mode:this.viewingMode}))}exit(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new ty({camera:Ct},this)}createInitialCamera(){if(this.viewingMode===Be.Global){const e=Jr(this.spatialReference).radius;this.camera=new Ct({eye:$e(4*e,0,0),center:$e(e,0,0),up:$e(0,0,1)})}else this.camera=new Ct({eye:$e(0,0,100),center:$e(0,0,0),up:$e(0,1,0)})}get animation(){return this.cameraController instanceof _O&&v(this.cameraController.viewAnimation)?this.cameraController.viewAnimation:null}get camera(){return this._get("camera")}set camera(e){e!==Xu&&Xu.copyFrom(e),Xu.computeUp(this.viewingMode),this.events.emit("before-camera-change",Xu);const r=this._get("camera");if(this._cameraProjectionChanged(this._lastSeenCameraProjectionValues,Xu)&&(this._lastSeenCameraProjectionValues.copyFrom(Xu),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),(!r||!r.equals(Xu))&&(this._set("camera",this._propertiesPool.get("camera").copyFrom(Xu)),this._cameraChanged=!r||!r.almostEquals(Xu),this._cameraChanged)){const i=xue(()=>{this._cameraChanged=!1,i.remove()})}}get pixelRatio(){return this.camera.pixelRatio}get contentCamera(){return It(this._contentCamera,this.camera)}set contentCamera(e){this._contentCamera=v(e)?e.clone():null}get fixedContentCamera(){return v(this._contentCamera)}get isGlobal(){return this.viewingMode===Be.Global}get isLocal(){return this.viewingMode===Be.Local}get navigating(){return!(!this.cameraController||!this.cameraController.isInteractive)}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(e&&(this.removeHandles(lae),this.addHandles(_a(()=>e.state===os.Finished||e.state===os.Stopped,()=>{this._set("cameraController",null),this.updateCamera(r=>e.onControllerEnd(r))},{sync:!0,once:!0}),lae),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=os.Rejected)}switchCameraController(e){return this.cameraController=e,e.state!==os.Rejected}stopActiveCameraController(){return!(this.cameraController&&!this.cameraController.stopController())}updateCamera(e){this._updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(this._updateQueue.length===0||this._processingUpdates)return;this._processingUpdates=!0;const e=this._updateQueue.shift();Xu.copyFrom(this._get("camera")),e(Xu),this.camera=Xu,this._processingUpdates=!1,this._processUpdateQueue()}_cameraProjectionChanged(e,r){return e.fov!==r.fov||e.fullViewport[0]!==r.fullViewport[0]||e.fullViewport[1]!==r.fullViewport[1]||e.fullViewport[2]!==r.fullViewport[2]||e.fullViewport[3]!==r.fullViewport[3]||e.padding[lr.TOP]!==r.padding[lr.TOP]||e.padding[lr.RIGHT]!==r.padding[lr.RIGHT]||e.padding[lr.BOTTOM]!==r.padding[lr.BOTTOM]||e.padding[lr.LEFT]!==r.padding[lr.LEFT]}};u([d()],hn.prototype,"mode",void 0),u([d({readOnly:!0,type:YS})],hn.prototype,"animation",null),u([d({type:Ct})],hn.prototype,"camera",null),u([d({readOnly:!0})],hn.prototype,"pixelRatio",null),u([d()],hn.prototype,"rasterPixelRatio",void 0),u([d()],hn.prototype,"contentPixelRatio",void 0),u([d({})],hn.prototype,"_contentCamera",void 0),u([d({type:Ct})],hn.prototype,"contentCamera",null),u([d({readOnly:!0})],hn.prototype,"fixedContentCamera",null),u([d({readOnly:!0})],hn.prototype,"constraints",void 0),u([d({readOnly:!0})],hn.prototype,"events",void 0),u([d({readOnly:!0})],hn.prototype,"isGlobal",null),u([d({readOnly:!0})],hn.prototype,"isLocal",null),u([d({readOnly:!0})],hn.prototype,"viewingMode",void 0),u([d({readOnly:!0})],hn.prototype,"spatialReference",void 0),u([d()],hn.prototype,"navigating",null),u([d()],hn.prototype,"stationary",null),u([d()],hn.prototype,"_cameraChanged",void 0),u([d()],hn.prototype,"cameraController",null),hn=u([I("esri.views.3d.state.ViewState")],hn);const Xht=hn,Xu=new Ct,lae="ViewStateHandles";let Yht=class{constructor(e,r,i){this.viewingMode=e,this._forEachLayer=r,this._view=i,this._externalIntersectionHandlers=new Jt,this._tolerance=rE,this._tmpRay=ro(),this._tmpRegion=ur(),this._validateHUDIntersector=Wh(this.viewingMode),this._validateHUDIntersector.options.hud=!1}intersectScreen(e,r,i){return this.intersectRay(this._getPickRay(e,this._tmpRay),cae(this.viewingMode),r,i)}intersectScreenFreePointFallback(e,r,i){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),r,i)}intersectRayFreePointFallback(e,r,i){return this.intersectRay(e,cae(this.viewingMode),r,i)||this._intersectRayFreePointLocal(e,r)}intersectRay(e,r,i,s){return r.options.selectionMode=!1,r.options.store=Po.MIN,this.computeIntersection(e,r,s),!!r.results.min&&r.results.min.getIntersectionPoint(i)}getCenterRayWithSubpixelOffset(e,r,i=.5,s=.5){return e.getRenderCenter(h$,i,s),h$[0]+=.0466,h$[1]-=.0123,ZY(e,h$,r)}intersectIntersectorScreen(e,r,i){this.computeIntersection(this._getPickRay(e,this._tmpRay),r,i)}intersectToolIntersectorScreen(e,r,i){const s=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(s,r,i)}intersectToolIntersectorRay(e,r,i){r.options.selectionMode=!0,this.computeIntersection(e,r,i);const s=r.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||Ep(s)&&s.intersector!==Qi.TERRAIN||(r.options.selectionMode=!1,this.computeIntersection(e,r,i))}setTolerance(e=rE){this._tolerance=e}addIntersectionHandler(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort((r,i)=>r.type===Qi.TERRAIN?1:i.type===Qi.TERRAIN?-1:0)}removeIntersectionHandler(e){this._externalIntersectionHandlers.removeUnordered(e)!=null&&this._externalIntersectionHandlers.sort((r,i)=>r.type===Qi.TERRAIN?1:i.type===Qi.TERRAIN?-1:0)}_getPickRay(e,r){const i=this._view.state.camera;return Nbe(i,e,r)}_intersectRayFreePointLocal(e,r){return this.viewingMode!==Be.Local||C(e)||fe(r,e.origin,_e(je.get(),e.direction)),!1}intersectElevationFromScreen(e,r,i=0,s=null){return this._intersectElevation(this._getPickRay(e,this._tmpRay),r,i,s)}_intersectElevation(e,r,i=0,s=null){if(C(e))return null;const n=v(r)?r.mode:"absolute-height",o=v(r)?It(r.offset,0):0,a=n!=="on-the-ground"?o+i:0,l=a/this._view.renderCoordsHelper.unitInMeters;if(n==="absolute-height"){if(this._view.renderCoordsHelper.intersectInfiniteManifold(e,a,u$)){const T=this._view.computeMapPointFromVec3d(u$);return T.z??(T.z=0),T.z-=o,T}return null}const c=this._view.state.camera,h=je.get();c.projectToRenderScreen(e.origin,h);const p=new uae(null,this._forEachLayer),f=this._view.slicePlane,m=v(f)?ese(f):null,y=Wh(this.viewingMode);y.options.store=Po.MIN,y.options.verticalOffset=l;const _=e.origin,b=fe(je.get(),_,e.direction);y.reset(_,b,c),y.point=h;const x=v(s)?"type"in s&&s.type==="graphics"?T=>{var S;return((S=T.metadata)==null?void 0:S.layerUid)!==s.uid}:T=>{var S;return((S=T.metadata)==null?void 0:S.graphicUid)!==s.uid}:null;switch(n){case"relative-to-scene":{const T=S=>{var E;return(C(x)||x(S))&&!!((E=S.metadata)!=null&&E.isElevationSource)};y.intersect(p.layers,h,this._tolerance,null,T),this._externalIntersectionHandlers.forAll(S=>{if(S.type===Qi.I3S||S.type===Qi.TERRAIN){const E=S.slicePlaneEnabled?m:null;S.intersect(y,E,y.rayBegin,y.rayEnd,h)}});break}case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll(T=>{if(T.isGround){const S=T.slicePlaneEnabled?m:null;T.intersect(y,S,y.rayBegin,y.rayEnd,h)}})}if(y.results.min.getIntersectionPoint(u$)){const T=this._view.computeMapPointFromVec3d(u$);return T.z=i,T}return null}computeIntersection(e,r,i){var y;if(C(e))return;const s=this._view.state.camera,n=je.get();s.projectToRenderScreen(e.origin,n);const o=new uae(i,this._forEachLayer);r.options.selectOpaqueTerrainOnly=!i||!("include"in i||"exclude"in i);const a=e.origin,l=fe(je.get(),e.origin,e.direction);r.reset(a,l,s),r.intersect(o.layers,n,this._tolerance);const c=this._view.slicePlane,h=v(c)?ese(c):null;r.intersect(o.sliceableLayers,n,this._tolerance,h);const p=i&&(i.requiresGroundFeedback||i.enableDraped);this._externalIntersectionHandlers.forAll(_=>{const b=_.layerUid,x=Array.isArray(b),T=x?b:[b];x&&(r.options.filteredLayerUids=[]);let S=!1;for(const E of T)o.filterLayerUid(E)?S=!0:x&&r.options.filteredLayerUids.push(E);if(r.options.isFiltered=!S,_.isGround&&p||!r.options.isFiltered){const E=_.slicePlaneEnabled?h:null;_.intersect(r,E,a,l,n)}});const f=je.get(),m=this._view.basemapTerrain;if(i&&i.enableDraped&&v(m.spatialReference)&&r.results.ground.getIntersectionPoint(f)){const _=m.overlayManager.renderer,b=this._view.renderCoordsHelper.spatialReference,x=je.get();this._view.renderCoordsHelper.fromRenderCoords(f,x,m.spatialReference),x[2]=It((y=this._view.elevationProvider)==null?void 0:y.getElevation(f[0],f[1],f[2],b,"ground"),0),_.intersect(r,x,r.results.ground,T=>o.filterRenderGeometry(T))}r.sortResults(),this._processHUDResults(r)}_processHUDResults(e){const r=e.results.hud;Kg(this._tmpRegion,lB);const i=this._view.state.camera,s=[],n=this._tmpRegion,o=x=>{const T=new Jht(x);i.projectToRenderScreen(x.target.center,T.screenPoint),T.screenPoint[0]=Math.floor(T.screenPoint[0]),T.screenPoint[1]=Math.floor(T.screenPoint[1]),s.push(T),tW(n,T.screenPoint)};e.sortResults(r.all),v(r.min.dist)&&o(r.min);for(const x of r.all)r.min.target.object!==x.target.object&&r.max.target.object!==x.target.object&&o(x);if(v(r.max.dist)&&r.max.target.object!==r.min.target.object&&o(r.max),!s.length)return;n[0]===n[2]&&(n[2]+=1),n[1]===n[3]&&(n[3]+=1);const a=i.fullWidth,l=i.fullHeight,c=Math.max(0,n[0]-S3),h=Math.max(0,n[1]-S3),p=Math.min(xu(n)+2*S3,a-c),f=Math.min(fp(n)+2*S3,l-h),m=new Uint8Array(p*f*4);this._view._stage.renderer.readHUDVisibility(c,h,p,f,m);let y=!0;const _=C(e.results.max.dist);let b=0;for(const x of s)for(const T of Zht)if(m[4*(Math.min(x.screenPoint[0]+T[0],a)-n[0]+(Math.min(x.screenPoint[1]+T[1],l)-n[1])*p)]){y&&(e.results.min.copy(x.result),y=!1),_&&e.results.max.copy(x.result),e.options.store===Po.ALL&&e.results.all.splice(b++,0,x.result);break}}};const S3=1,Zht=(()=>{const t=[],e=S3;for(let r=-e;r<=e;r++)for(let i=-e;i<=e;i++)t.push([i+e,r+e]);return t})();let Jht=class{constructor(e){this.result=e,this.screenPoint=qo()}},c$;function cae(t){return c$&&c$.viewingMode===t||(c$=Wh(t)),c$}let uae=class{constructor(e,r){this.layers=new Array,this.sliceableLayers=new Array,this.include=e==null?void 0:e.include,this.exclude=e==null?void 0:e.exclude,r(i=>{i.pickable&&this.filterLayerUid(i.apiLayerUid)&&(i.sliceable?this.sliceableLayers:this.layers).push(i)})}filterLayerUid(e){const{include:r,exclude:i}=this;return C(e)?r==null&&i==null:(r==null||r.has(e))&&(i==null||!i.has(e))}filterRenderGeometry(e){return this.filterLayerUid(e.layerUid)}};function hae(t){return typeof t=="object"&&"intersect"in t}const u$=M(),h$=qo();let qIt=class{constructor(e,r){this.spatialReference=e,this._view=r}getElevation(e,r,i){return this._view.elevationProvider.getElevation(e,r,0,this.spatialReference,i)}async queryElevation(e,r,i,s,n){return this._view.elevationProvider.queryElevation(e,r,0,this.spatialReference,n,i,s)}},Kht=class{constructor(e,r,i,s){this.spatialReference=r,this._getElevationQueryProvider=i,this._queries=new Array,this._queryOptions={...s,ignoreInvisibleLayers:!0},this._frameTask=e.registerTask(_t.ELEVATION_QUERY,this)}destroy(){this._frameTask.remove()}queryElevation(e,r,i,s=0){return new Promise((n,o)=>{const a={x:e,y:r,minDemResolution:s,result:{resolve:n,reject:o},signal:i};this._queries.push(a),fa(i,()=>{kH(this._queries,a),o(Hr())})})}get running(){return this._queries.length>0}runTask(e){const r=this._queries;this._queries=[];const i=this._getElevationQueryProvider();if(!i)return r.forEach(h=>h.result.reject()),void e.madeProgress();const s=r.map(h=>[h.x,h.y]),n=r.reduce((h,p)=>Math.min(h,p.minDemResolution),1/0),o=new QO({points:s,spatialReference:this.spatialReference}),a=r.length>1&&r.some(h=>!!h.signal)?new AbortController:null,l=v(a)?a.signal:r[0].signal;if(v(a)){let h=0;r.forEach(p=>fa(p.signal,()=>{h++,p.result.reject(Hr()),h===r.length&&a.abort()}))}const c={...this._queryOptions,minDemResolution:n,signal:l};i.queryElevation(o,c).then(h=>{r.forEach((p,f)=>{v(p.signal)&&p.signal.aborted?p.result.reject(Hr()):p.result.resolve(h.geometry.points[f][2])})}).catch(h=>{r.forEach(p=>p.result.reject(h))}),e.madeProgress()}get test(){const e=this;return{update:()=>e._queries.length>0&&e.runTask(Xa)}}},E3=class extends vs.EventedMixin(Te){get spatialReference(){var e,r;return(r=(e=this.view)==null?void 0:e.basemapTerrain)==null?void 0:r.spatialReference}constructor(e){super(e),this._im=new Array,this._ground=new Array,this._scene=new Array,this._handles=new Map,this.lastElevationQuery=null,this.elevationCacheEnabled=!1}destroy(){this._elevationQueryCached=ke(this._elevationQueryCached)}get _elevationQuery(){return C(this._elevationQueryCached)&&(this._elevationQueryCached=new Kht(this.view.resourceController.scheduler,this.view.spatialReference,()=>this.view.map&&this.view.map.ground,{maximumAutoTileRequests:4})),this._elevationQueryCached}enableElevationCache(e){e||(this.lastElevationQuery=null),this.elevationCacheEnabled=e}getElevation(e,r,i,s,n){if(this.elevationCacheEnabled&&this.lastElevationQuery!=null){const a=this.lastElevationQuery;if(e===a.x&&r===a.y&&i===a.z&&Tn(s,a.spatialReference)&&n===a.queryContext)return a.result}let o=null;return o=d$(o,this._im,e,r,i,s,n),C(o)&&(o=d$(o,this._ground,e,r,i,s,n)),n==="scene"&&(o=d$(o,this._scene,e,r,i,s,n)),this.elevationCacheEnabled&&(this.lastElevationQuery={x:e,y:r,z:i,spatialReference:s,queryContext:n,result:o}),o}queryElevation(e,r,i,s,n,o=null,a=0){const l=H_();return this._elevationQuery.queryElevation(e,r,o,a).then(c=>{n==="scene"&&(c=d$(c,this._scene,e,r,i,s,n)),l.resolve(c)}).catch(c=>{Qs(c)?l.reject(c):l.resolve(this.getElevation(e,r,i,s,n))}),l.promise}register(e,r){this._handles.set(r,r.on("elevation-change",i=>this.emit("elevation-change",i))),this._providersFromContext(e).push(r)}unregister(e){var r;this._handles.has(e)&&((r=this._handles.get(e))==null||r.remove(),this._handles.delete(e));for(const i of[this._im,this._ground,this._scene]){const s=i.indexOf(e);s>-1&&i.splice(s,1)}}_providersFromContext(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}};function d$(t,e,r,i,s,n,o){for(const a of e){const l=a.getElevation(r,i,s,n,o);v(l)&&(t=v(t)?Math.max(l,t):l)}return t}u([d({constructOnly:!0})],E3.prototype,"view",void 0),u([d()],E3.prototype,"spatialReference",null),E3=u([I("esri.views.3d.support.CombinedElevationProvider")],E3);let C3=class nH{static isValidProfile(e){return e in nH.profiles}static getDefaultProfile(){return de("esri-iPhone")?"low":"medium"}static apply(e,r){const i=nH.profiles[e];r.graphics3D.maxTotalNumberOfFeatures=i.graphics3D.maxTotalNumberOfFeatures,r.graphics3D.maxTotalNumberOfPrimitives=i.graphics3D.maxTotalNumberOfPrimitives,r.graphics3D.polygonLodFactor=i.graphics3D.polygonLodFactor,r.graphics3D.polylineLodFactor=i.graphics3D.polylineLodFactor,r.graphics3D.snapshotAvailable=i.graphics3D.snapshotAvailable,r.graphics3D.skipHighSymbolLods=i.graphics3D.skipHighSymbolLods;const s=r.sceneService.object,n=i.sceneService.object;s.lodFactor=n.lodFactor,s.lodCrossfadeinDuration=n.lodCrossfadeinDuration,s.lodCrossfadeoutDuration=n.lodCrossfadeoutDuration,s.lodCrossfadeUncoveredDuration=n.lodCrossfadeUncoveredDuration,r.sceneService.point.lodFactor=i.sceneService.point.lodFactor,r.sceneService.integratedMesh.lodFactor=i.sceneService.integratedMesh.lodFactor,r.sceneService.pointCloud.lodFactor=i.sceneService.pointCloud.lodFactor,r.sceneService.uncompressedTextureDownsamplingEnabled=i.sceneService.uncompressedTextureDownsamplingEnabled,r.tiledSurface.lodBias=i.tiledSurface.lodBias,r.tiledSurface.angledSplitBias=i.tiledSurface.angledSplitBias,r.tiledSurface.reduceTileLevelDifferences=i.tiledSurface.reduceTileLevelDifferences,r.tiledSurface.textureFadeDuration=i.tiledSurface.textureFadeDuration,r.heatmap.pixelRatio=i.heatmap.pixelRatio,r.heatmap.maxTotalNumberOfFeatures=i.heatmap.maxTotalNumberOfFeatures,r.fadeDuration=i.fadeDuration,r.antialiasingEnabled=i.antialiasingEnabled,r.physicallyBasedRenderingEnabled=i.physicalBasedRenderingEnabled,r.highQualityTransparency=i.highQualityTransparency,r.memoryLimit=i.memoryLimit,r.additionalCacheMemory=i.additionalCacheMemory,r.frameRate=i.frameRate,r.maximumPixelRatio=i.maximumPixelRatio}};function dae(){const t=!!de("esri-mobile"),e=!!de("ios"),r=400;return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxTotalNumberOfPrimitives:85e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:25e3},sceneService:{object:{lodFactor:.2,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:0},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,reduceTileLevelDifferences:!1,textureFadeDuration:0},fadeDuration:0,antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,memoryLimit:200,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:t?.8:1,polylineLodFactor:t?1.2:1.5,snapshotAvailable:!e,skipHighSymbolLods:!1},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:r},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:t},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!de("disable-feature:reduce-map-tile-levels"),textureFadeDuration:r},fadeDuration:r,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:t?600:750,additionalCacheMemory:t?0:150,frameRate:0,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:t?1.2:2,polylineLodFactor:t?1.2:2,snapshotAvailable:!e,skipHighSymbolLods:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:r},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!de("disable-feature:reduce-map-tile-levels"),textureFadeDuration:r},fadeDuration:r,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:t?900:1500,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:t?1:1/0}}}C3.test={reset(){const t=dae();for(const e in t)C3.profiles[e]=t[e]}},function(t){t.profiles=dae()}(C3||(C3={}));const vD=C3;function FSe(){return new Float32Array(4)}function Qht(t){const e=new Float32Array(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function wp(t,e,r,i){const s=new Float32Array(4);return s[0]=t,s[1]=e,s[2]=r,s[3]=i,s}function edt(t,e){return new Float32Array(t,e,4)}function USe(){return FSe()}function kSe(){return wp(1,1,1,1)}function VSe(){return wp(1,0,0,0)}function BSe(){return wp(0,1,0,0)}function zSe(){return wp(0,0,1,0)}function GSe(){return wp(0,0,0,1)}const tdt=USe(),rdt=kSe(),idt=VSe(),sdt=BSe(),ndt=zSe(),odt=GSe();Object.freeze(Object.defineProperty({__proto__:null,ONES:rdt,UNIT_W:odt,UNIT_X:idt,UNIT_Y:sdt,UNIT_Z:ndt,ZEROS:tdt,clone:Qht,create:FSe,createView:edt,fromValues:wp,ones:kSe,unitW:GSe,unitX:VSe,unitY:BSe,unitZ:zSe,zeros:USe},Symbol.toStringTag,{value:"Module"}));const pae=new Ze([0,255,255]),fae=new Ze([0,0,0]),mae=1,gae=.25,yae=.4,_ae=.2;let pf=class extends Te{constructor(){super(...arguments),this.color=pae.clone(),this.haloColor=null,this.haloOpacity=mae,this.fillOpacity=gae,this.shadowOpacity=yae,this.shadowColor=fae.clone(),this.shadowDifference=_ae}static toEngineOptions(e){const r=Ze.toUnitRGBA(e.color??pae),i=v(e.haloColor)?Ze.toUnitRGBA(e.haloColor):r,s=Ze.toUnitRGBA(e.shadowColor??fae),n=e.haloOpacity??mae,o=e.fillOpacity??gae,a=e.shadowOpacity??yae,l=e.shadowDifference??_ae;return{color:wp(r[0],r[1],r[2],r[3]),haloColor:wp(i[0],i[1],i[2],i[3]),haloOpacity:n,haloOpacityOccluded:.25*n,fillOpacity:o,fillOpacityOccluded:.25*o,shadowOpacity:a,shadowColor:Ht(s[0],s[1],s[2],s[3]),occludedShadowOpacity:a*(1-l)}}};u([d({type:Ze})],pf.prototype,"color",void 0),u([d({type:Ze})],pf.prototype,"haloColor",void 0),u([d()],pf.prototype,"haloOpacity",void 0),u([d()],pf.prototype,"fillOpacity",void 0),u([d()],pf.prototype,"shadowOpacity",void 0),u([d({type:Ze})],pf.prototype,"shadowColor",void 0),u([d()],pf.prototype,"shadowDifference",void 0),pf=u([I("esri.views.3d.support.HighlightOptions")],pf);const oH=pf;let nb=class extends ve{constructor(e){super(e),this.geometries=[],this.outSpatialReference=null,this.transformation=null,this.transformForward=null}toJSON(){const e=this.geometries.map(s=>s.toJSON()),r=this.geometries[0],i={};return i.outSR=this.outSpatialReference.wkid||JSON.stringify(this.outSpatialReference.toJSON()),i.inSR=r.spatialReference.wkid||JSON.stringify(r.spatialReference.toJSON()),i.geometries=JSON.stringify({geometryType:vE(r),geometries:e}),this.transformation&&(i.transformation=this.transformation.wkid||JSON.stringify(this.transformation)),this.transformForward!=null&&(i.transformForward=this.transformForward),i}};u([d()],nb.prototype,"geometries",void 0),u([d({json:{read:{source:"outSR"}}})],nb.prototype,"outSpatialReference",void 0),u([d()],nb.prototype,"transformation",void 0),u([d()],nb.prototype,"transformForward",void 0),nb=u([I("esri.rest.support.ProjectParameters")],nb);const o6=nb,adt=us(o6);async function sJ(t,e,r){e=adt(e);const i=aX(t),s={...i.query,f:"json",...e.toJSON()},n=e.outSpatialReference,o=vE(e.geometries[0]),a=r8e(s,r);return Ni(i.path+"/project",a).then(({data:{geometries:l}})=>mye(l,o,n))}async function nJ(t=null,e){var s,n;if(Yr.geometryServiceUrl)return Yr.geometryServiceUrl;if(!t)throw new q("internal:geometry-service-url-not-configured");let r;r="portal"in t?t.portal||tl.getDefault():t,await r.load({signal:e});const i=(n=(s=r.helperServices)==null?void 0:s.geometry)==null?void 0:n.url;if(!i)throw new q("internal:geometry-service-url-not-configured");return i}async function ldt(t,e,r=null,i){const s=await nJ(r,i),n=new o6;n.geometries=[t],n.outSpatialReference=e;const o=await sJ(s,n,{signal:i});if(o&&Array.isArray(o)&&o.length===1)return o[0];throw new q("internal:geometry-service-projection-failed")}const cdt=Object.freeze(Object.defineProperty({__proto__:null,getGeometryServiceURL:nJ,projectGeometry:ldt},Symbol.toStringTag,{value:"Module"}));let udt=class{constructor(e,r){this.spatialReference=r,this.unitInMeters=nl(this.spatialReference,Jr(this.spatialReference).metersPerDegree),this._geometryServiceURLPromise=nJ(e&&e.get("portalItem")).catch(()=>{throw new q("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")})}async toGeographic(e){const r=await this._geometryServiceURLPromise;let i,s=!0;Array.isArray(e[0])&&typeof e[0]!="number"?i=e:(i=[e],s=!1);const n=i.map(l=>l instanceof mt?l:new mt(l,this.spatialReference)),o=new o6({geometries:n,outSpatialReference:et.WGS84}),a=(await sJ(r,o)).map(l=>l.type==="point"?[l.x,l.y]:void 0).filter(l=>!!l);return s?a:a[0]}},Ld=class extends Te{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxTotalNumberOfPrimitives=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1,this.skipHighSymbolLods=!1}};u([d()],Ld.prototype,"minTotalNumberOfFeatures",void 0),u([d()],Ld.prototype,"maxTotalNumberOfFeatures",void 0),u([d()],Ld.prototype,"maxTotalNumberOfPrimitives",void 0),u([d()],Ld.prototype,"snapshotAvailable",void 0),u([d()],Ld.prototype,"polygonLodFactor",void 0),u([d()],Ld.prototype,"polylineLodFactor",void 0),u([d()],Ld.prototype,"skipHighSymbolLods",void 0),Ld=u([I("esri.views.3d.support.QualitySettings.Graphics3DSettings")],Ld);let Jf=class extends Te{constructor(){super(...arguments),this.lodFactor=1}};u([d()],Jf.prototype,"lodFactor",void 0),Jf=u([I("esri.views.3d.support.QualitySettings.LoDFactorSettings")],Jf);let kF=class extends Jf{constructor(){super(...arguments),this.lodCrossfadeinDuration=0,this.lodCrossfadeoutDuration=0,this.lodCrossfadeUncoveredDuration=0}};kF=u([I("esri.views.3d.support.QualitySettings.LoDFactor3DObjectSettings")],kF);let Tg=class extends Te{constructor(){super(...arguments),this.object=new kF,this.point=new Jf,this.integratedMesh=new Jf,this.pointCloud=new Jf,this.uncompressedTextureDownsamplingEnabled=!1}};u([d({type:kF})],Tg.prototype,"object",void 0),u([d({type:Jf})],Tg.prototype,"point",void 0),u([d({type:Jf})],Tg.prototype,"integratedMesh",void 0),u([d({type:Jf})],Tg.prototype,"pointCloud",void 0),u([d()],Tg.prototype,"uncompressedTextureDownsamplingEnabled",void 0),Tg=u([I("esri.views.3d.support.QualitySettings.SceneServiceSettings")],Tg);let s_=class extends Te{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.reduceTileLevelDifferences=!0,this.textureFadeDuration=400}};u([d()],s_.prototype,"lodBias",void 0),u([d()],s_.prototype,"angledSplitBias",void 0),u([d()],s_.prototype,"reduceTileLevelDifferences",void 0),u([d()],s_.prototype,"textureFadeDuration",void 0),s_=u([I("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],s_);let N2=class extends Te{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};u([d()],N2.prototype,"pixelRatio",void 0),u([d()],N2.prototype,"maxTotalNumberOfFeatures",void 0),N2=u([I("esri.views.3d.support.QualitySettings.HeatmapSettings")],N2);let Cl=class extends Te{constructor(){super(...arguments),this.graphics3D=new Ld,this.sceneService=new Tg,this.tiledSurface=new s_,this.heatmap=new N2,this.fadeDuration=400,this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0,this.memoryLimit=void 0,this.additionalCacheMemory=void 0,this.frameRate=void 0,this.maximumPixelRatio=1/0}};u([d({type:Ld})],Cl.prototype,"graphics3D",void 0),u([d({type:Tg})],Cl.prototype,"sceneService",void 0),u([d({type:s_})],Cl.prototype,"tiledSurface",void 0),u([d({type:N2})],Cl.prototype,"heatmap",void 0),u([d()],Cl.prototype,"fadeDuration",void 0),u([d()],Cl.prototype,"antialiasingEnabled",void 0),u([d()],Cl.prototype,"physicallyBasedRenderingEnabled",void 0),u([d()],Cl.prototype,"highQualityTransparency",void 0),u([d()],Cl.prototype,"memoryLimit",void 0),u([d()],Cl.prototype,"additionalCacheMemory",void 0),u([d()],Cl.prototype,"frameRate",void 0),u([d()],Cl.prototype,"maximumPixelRatio",void 0),Cl=u([I("esri.views.3d.support.QualitySettings.QualitySettings")],Cl);const vae=Cl;function hdt(t){return zH(t)&&t.length>=3}function ddt(t){return(GH(t)||Array.isArray(t))&&t.length>=3}function pdt(t){return hdt(t)||ddt(t)}let fdt=class aH{constructor(e,r,i,s){this.viewingMode=e,this.spatialReference=r,this.unitInMeters=i,this._coordinateSystem=s,this._tmpCoordinateSystem=PNe(s)}set extent(e){e&&INe(this._coordinateSystem,e,this._coordinateSystem)}getAltitude(e){return VNe(this._coordinateSystem,e)}setAltitude(e,r,i=e){return Ame(this._coordinateSystem,i,r,e)}setAltitudeOfTransformation(e,r){BNe(this._coordinateSystem,r,e,r)}worldUpAtPosition(e,r){return NNe(this._coordinateSystem,e,r)}worldBasisAtPosition(e,r,i){return FNe(this._coordinateSystem,e,r,i)}basisMatrixAtPosition(e,r){const i=this.worldBasisAtPosition(e,Oc.X,je.get()),s=this.worldBasisAtPosition(e,Oc.Y,je.get()),n=this.worldBasisAtPosition(e,Oc.Z,je.get());return ym(r,i[0],i[1],i[2],0,s[0],s[1],s[2],0,n[0],n[1],n[2],0,0,0,0,1),r}headingAtPosition(e,r){const i=this.worldUpAtPosition(e,je.get()),s=this.worldBasisAtPosition(e,Oc.Y,je.get()),n=rme(r,s,i);return rl(n)}intersectManifoldClosestSilhouette(e,r,i){return tU(this._coordinateSystem,r,this._tmpCoordinateSystem),kNe(this._tmpCoordinateSystem,e,i),i}intersectManifold(e,r,i){tU(this._coordinateSystem,r,this._tmpCoordinateSystem);const s=je.get();return UNe(this._tmpCoordinateSystem,e,s)?le(i,s):null}intersectInfiniteManifold(e,r,i){if(this.viewingMode===Be.Global)return this.intersectManifold(e,r,i);tU(this._coordinateSystem,r,this._tmpCoordinateSystem);const s=this._tmpCoordinateSystem.value,n=je.get();return Zw(s.plane,e,n)?le(i,n):null}toRenderCoords(e,r,i){return yF(e)?Jo(e,r,this.spatialReference):no(e,r,i,this.spatialReference)}fromRenderCoords(e,r,i=null){return yF(r)?(v(i)&&(r.spatialReference=i),yfe(e,this.spatialReference,r)):pdt(r)?no(e,this.spatialReference,r,i)?r:null:J_(e,this.spatialReference,r)}static create(e,r){switch(e){case Be.Local:return new aH(Be.Local,r,nl(r),DNe());case Be.Global:return new aH(Be.Global,r,1,LNe(r))}}static renderUnitScaleFactor(e,r){return bae(e)/bae(r)}};function bae(t){if(_F(t,Be.Global))return 1;const e=Rme(!1,t);return nl(e)}var Df;(function(t){t[t.ELEVATION=0]="ELEVATION",t[t.BASEMAP=1]="BASEMAP",t[t.I3S_INDEX=2]="I3S_INDEX",t[t.I3S_DATA=3]="I3S_DATA",t[t.SYMBOLOGY=4]="SYMBOLOGY"})(Df||(Df={}));const mdt=(()=>{const t=new Array;return t[Df.ELEVATION]=10,t[Df.BASEMAP]=10,t[Df.I3S_INDEX]=10,t[Df.I3S_DATA]=10,t[Df.SYMBOLOGY]=5,t})(),gdt=30;function jSe(t){return typeof t.getUsedMemory=="function"}function ydt(t){return new Al({view:t})}const p$=1,Z9=1,_dt=.75,vdt=.6,wae=1.3;let Al=class extends Te{constructor(e){super(e),this._quality=1,this._memoryUsed=0,this._updating=!1,this.minQuality=.1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryPredicted=0,this._cacheStorage=new nX,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=500,this._additionalCacheMemory=100}destroy(){this._cacheStorage.destroy()}set maxMemory(e){e==null||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(p$),this._maxMemory=e)}get maxMemory(){return this._maxMemory}set additionalCacheMemory(e){e!=null&&e>=0&&(this._additionalCacheMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._memoryUsed}newCache(e,r){return new TUe(e,this._cacheStorage,r)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<vdt&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(p$);else if(e)(this._memoryPredicted>1.1*Z9||this._memoryUsed>Z9)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/wae),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._memoryUsed>Z9)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/wae),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._memoryUsed<_dt&&this._quality<p$){this._stableQuality=this._quality;const r=.05;e=this._updateQuality(this._quality+r)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e}_updateQuality(e){return(e=Math.min(Math.max(e,this.minQuality),p$))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some(e=>!!e.updating)}_updateMemory(){let e=0,r=0;this.view.basemapTerrain&&this.view.basemapTerrain.getUsedMemory&&(e+=this.view.basemapTerrain.getUsedMemory());const i=this.view._stage&&this.view._stage.renderView&&this.view._stage.renderer.edgeView;v(i)&&(e+=i.usedMemory),this.view.allLayerViews&&this.view.allLayerViews.forEach(a=>{if(jSe(a)){const l=a.ignoresMemoryFactor()?this._quality:1;e+=a.getUsedMemory()*l,r+=a.getUnloadedMemory()*l}});const s=C(this._warnMemoryUsage)||Math.round(10*e)!==Math.round(10*this._warnMemoryUsage),n=1048576*this.maxMemory;if(e>n&&s){this._warnMemoryUsage=e;const a=c=>(c/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",l=Math.round(100*this._quality);se.getLogger(this.declaredClass).warn(`Memory Limit exceeded! Limit: ${a(n)} Current: ${a(e)} Projected: ${a(e+r)} Quality: ${l}%`)}this._memoryUsed=e/n,this._memoryPredicted=(e+r)/n;const o=n-e;this._cacheStorage.maxSize=Math.max(0,o+1048576*this.additionalCacheMemory)}get test(){const e=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const r=e._numQualityChanges;return e._numQualityChanges=0,r}}}};u([d({constructOnly:!0})],Al.prototype,"view",void 0),u([d()],Al.prototype,"maxMemory",null),u([d()],Al.prototype,"additionalCacheMemory",null),u([d()],Al.prototype,"memoryFactor",null),u([d()],Al.prototype,"updating",null),u([d()],Al.prototype,"usedMemory",null),u([d()],Al.prototype,"_quality",void 0),u([d()],Al.prototype,"_memoryUsed",void 0),u([d()],Al.prototype,"_updating",void 0),u([d()],Al.prototype,"_stableQuality",void 0),u([d()],Al.prototype,"_maxMemory",void 0),u([d()],Al.prototype,"_additionalCacheMemory",void 0),Al=u([I("esri.views.3d.support.MemoryController")],Al);let bdt=class{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}},wdt=class{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new xdt}},xdt=class{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}},Tdt=class{constructor(e,r,i,s){this._workerFunc=e,this._callbackFunc=r,this._maxTotalNumWorkers=i,this._totalNumWorkers=0,this._clients=s.map(n=>new wdt(n))}destroy(){this._clients.length=0}hasQuota(e){const r=this._clients[e];return!!r&&(this._totalNumWorkers<this._maxTotalNumWorkers||r.numWorkers+r.tasks.length<r.typeWorkerQuota)}push(e){const r=this._clients[e.client];r&&(this._totalNumWorkers<this._maxTotalNumWorkers?(r.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,(i,s)=>this._taskCallback(i,s))):r.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}_taskFinished(e){const r=this._clients[e.client];this._totalNumWorkers--,r.numWorkers--,r.statistics.requests++,r.statistics.size+=e.size||0,r.statistics.duration+=e.duration||0,r.statistics.speed=r.statistics.duration>0?r.statistics.size/r.statistics.duration:0,ft(r.numWorkers>=0),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),(r,i)=>this._taskCallback(r,i)))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,r){e._cancelled||(this._callbackFunc(e,r),this._taskFinished(e))}getStatsForType(e){const r=this._clients[e];return r?{quota:r.typeWorkerQuota,workers:r.numWorkers,queueSize:r.tasks.length,requestStats:r.statistics}:null}get test(){const e=this;return{set workerFunc(r){e._workerFunc=r}}}},bD=class extends Te{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,r,i){this._loadQueue=new Tdt((s,n)=>this._startLoading(s,n),(s,n)=>this._doneLoadingCB(s,n),e,r),i&&(this._frameTask=i.registerTask(_t.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=ji(this._frameTask),this._tasks.forEach(e=>Fh(e.abortController)),this._loadQueue=ke(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,r,i,s={}){const n=H_();n.__signal=v(s)?s.signal:null;const o=this._createOrUpdateTask(e,r,i,s,n);return fa(s,()=>this._cancelRequest(o,n)),n.promise}_createTask(e,r,i,s,n,o){const a=new Cdt(e,r,i,s,n);return this._updateTask(a,o),this._tasks.set(n,a),this._tasks.size===1&&this._set("updating",!0),this._loadQueue.push(a),a}_cancelRequest(e,r){var i;PR(e.resolvers,r),r.reject(Hr()),e.resolvers.length===0&&(e.status===ph.DOWNLOADING&&(e.status=ph.CANCELLED,this._loadQueue.cancel(e),(i=e.abortController)==null||i.abort(),e.request=null,e.abortController=null),e.status=ph.CANCELLED,this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1))}_updateTask(e,r){e.resolvers.push(r)}_createOrUpdateTask(e,r,i,s,n){const o=Adt(v(s)&&s.uid||e,r,i),a=this._tasks.get(o);return a?(this._updateTask(a,n),a):this._createTask(e,s,r,i,o,n)}_doneLoadingCB(e,r){this._loadQueue&&(ft(e.status===ph.DOWNLOADING),e.status=ph.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:r}):this._doneLoading(e,r))}get running(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const r=this._onLoadQueue.shift();fr(r.task.abortController),r.task.abortController=null,r.callback(r.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const r=this._doneQueue.shift();r.task.status!==ph.DOWNLOADED&&(r.err=r.err||Hr()),this._doneLoading(r.task,r.err),e.madeProgress()}}_doneLoading(e,r){if(r&&!Qs(r)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let i=e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const s of e.resolvers)if(r)Qs(r)?s.reject(r):s.reject(new q("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${r}`,{url:e.url,error:r}));else{--i;const n=i<=0?e.result:ne(e.result);s.resolve(n)}this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1)}_startLoading(e,r){if(e.status===ph.CANCELLED)return!1;let i,s;switch(e.startTime=performance.now(),e.status=ph.DOWNLOADING,e.docType){case"binary":s="array-buffer",i=0;break;case"image":s="image";break;case"image+type":s="array-buffer";break;default:s="json"}e.abortController=new AbortController;const n=e.abortController.signal;e.request=Ni(e.url,{...e.options,responseType:s,timeout:i,signal:n});let o=()=>{};const a=c=>{e.duration=performance.now()-e.startTime,e.size=c instanceof ArrayBuffer?c.byteLength:e.size||0,e.result=c,this._frameTask?this._onLoadQueue.push({callback:r,task:e}):(e.abortController=null,r(e))},l=c=>{e.status===ph.DOWNLOADING&&r(e,c),o()};return e.docType!=="image+type"?(e.request.then(c=>a(c.data),l),!0):(e.request.then(c=>{const h=c.data,p=Edt(h);if(s="image",e.size=h.byteLength,p==="unknown")return e.request=Ni(e.url,{responseType:s,timeout:i,signal:n}),void e.request.then(y=>a(y.data),l);const f=new Blob([h],{type:p}),m=window.URL.createObjectURL(f);o=()=>window.URL.revokeObjectURL(m),e.request=Ni(m,{responseType:s,timeout:i,signal:n}),e.request.then(y=>a(new a6(y.data,p,o)),l)},l),!0)}get test(){return{loadQueue:this._loadQueue}}};u([d({readOnly:!0})],bD.prototype,"updating",void 0),bD=u([I("esri.views.3d.support.StreamDataLoader")],bD);const Sdt={numRetries:0};function Edt(t){if(t.byteLength<2)return"unknown";const e=new Uint8Array(t,0,t.byteLength);return e[0]===137&&e[1]===80?"image/png":e[0]===71&&e[1]===73?"image/gif":e[0]===66&&e[1]===77?"image/bmp":e[0]===255&&e[1]===216?"image/jpeg":"unknown"}let a6=class{constructor(e,r,i){this.image=e,this.type=r,this.release=i}get isOpaque(){return this.type==="image/jpeg"}},Cdt=class extends bdt{constructor(e,r,i,s,n){super(s),this.url=e,this.options=r,this.docType=i,this.key=n,this.result=null,this.status=ph.QUEUED,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=Sdt.numRetries}};function Adt(t,e,r){return`${t}:${e}:${r}`}var ph;(function(t){t[t.QUEUED=1]="QUEUED",t[t.DOWNLOADING=2]="DOWNLOADING",t[t.DOWNLOADED=3]="DOWNLOADED",t[t.CANCELLED=4]="CANCELLED"})(ph||(ph={}));let wD=class extends Te{constructor(){super(...arguments),this.updating=!1}};function Rdt(t){return new ff({view:t})}u([d({readOnly:!0})],wD.prototype,"updating",void 0),wD=u([I("esri.views.3d.support.ResourceControllerMain")],wD);let ff=class extends wD{constructor(){super(...arguments),this._immediateTask=XS,this._normalTask=XS,this._frameTask=null}get immediate(){return this._immediateTask}get normal(){return this._normalTask}initialize(){this._scheduler=SHe(),this._memoryController=ydt(this.view),this._streamDataLoader=new bD,this._streamDataLoader.setup(gdt,mdt,this._scheduler),this.addHandles([ie(()=>{var e;return(e=this.view.state)==null?void 0:e.mode},e=>{e!=null&&(this._scheduler.state=e)},ri),ie(()=>this.view.stationary,()=>this._stationaryChangedHandler())]),this._frameTask=vS({update:e=>this._frame(e)}),this._immediateTask=this._scheduler.registerTask(_t.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(_t.RESOURCE_CONTROLLER)}destroy(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=ji(this._frameTask),this._streamDataLoader=ke(this._streamDataLoader),this._memoryController=ke(this._memoryController),this._scheduler=ke(this._scheduler)}get updating(){var e,r,i;return!!((e=this._memoryController)!=null&&e.updating||(r=this._streamDataLoader)!=null&&r.updating||(i=this._immediateTask)!=null&&i.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){const r=this._streamDataLoader;return{request:(i,s,n)=>r.request(i,s,e,n),get busy(){return!r.hasDownloadSlots(e)}}}_frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(ZH(e.deltaTime)),!this._scheduler)||(this._scheduler.updateBudget(e)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update())}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get test(){return{getQueueStats:e=>this._streamDataLoader.test.loadQueue.getStatsForType(e)}}};u([d({constructOnly:!0})],ff.prototype,"view",void 0),u([d()],ff.prototype,"_scheduler",void 0),u([d()],ff.prototype,"_memoryController",void 0),u([d()],ff.prototype,"_streamDataLoader",void 0),u([d()],ff.prototype,"_immediateTask",void 0),u([d()],ff.prototype,"_normalTask",void 0),u([d({readOnly:!0})],ff.prototype,"updating",null),ff=u([I("esri.views.3d.support.ResourceControllerImpl")],ff);function Odt(t){return"performanceInfo"in t}const Yx=M(),Mdt=M(),Bm=M(),zm=M();function Pdt(t,e,r=0){const i=t.extent;if(C(i))return!1;if(r===0)return hpe(i,e);const s=Math.min(i[2]-i[0],i[3]-i[1]);return y$e(i,e,r*s)}function f$(t,e,r,i){le(Yx,r),Yx[i]=e[i];const s=me(Yx,Yx,e),n=me(Mdt,t,e),o=ye(n,s),a=ye(s,s);let l;l=o<=0?e:a<=o?r:fe(Yx,e,ae(s,s,o/a));const c=me(Yx,t,l);return Math.PI/2-Math.atan(c[2]/Math.sqrt(c[0]*c[0]+c[1]*c[1]))}function Idt(t,e,r){const i=t.extent;if(C(i))return 0;Bm[0]=i[0],Bm[1]=i[1],Bm[2]=r,zm[0]=i[2],zm[1]=i[3],zm[2]=r;let s=1/0,n=1/0;return e[0]<Bm[0]?s=f$(e,Bm,zm,0):e[0]>zm[0]&&(s=f$(e,zm,Bm,0)),e[1]<Bm[1]?n=f$(e,Bm,zm,1):e[1]>zm[1]&&(n=f$(e,zm,Bm,1)),Math.min(s,n)}function $dt(t,e,r){if(C(t))return YX();if(t.spatialReference.isGeographic&&!vw(t.spatialReference))return new q("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const i=Tc.checkUnsupported(t);if(v(i))return i;if(C(r))return new q("tilingscheme:extent-not-exist","The layer does not provide a layer extent.");const s=Ldt(t,r);if(s)return s;const n=t.spatialReference;return v(e)&&!(n.equals(e)||e.isWGS84&&n.isWebMercator)?new q("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"):null}function Ldt(t,e){const r=t.lods,i=r[0].resolution*2**r[0].level,s=[i*t.size[0],i*t.size[1]],n=[t.origin.x,t.origin.y],o=cpe(e),a=ur();Tc.computeRowColExtent(o,s,n,a);const l=(a[2]-a[0])*(a[3]-a[1]);if(l>E2){const c=r[0].scale*2**r[0].level;let h=Math.max((o[3]-o[1])/t.size[1],(o[2]-o[0])/t.size[0])*c/i;const p=Math.floor(Math.log(h)/Math.log(10));return h=Math.ceil(h/10**p)*10**p,new q("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(c).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+h.toLocaleString()+".",{level0Scale:c,suggestedLevel0Scale:h,requiredNumRootTiles:l,allowedNumRootTiles:E2})}return null}const Ddt=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:$dt,isInsideExtent:Pdt,tiltToExtentEdge:Idt},Symbol.toStringTag,{value:"Module"}));function Ndt(){return!0}function Fdt(){return 0}function Udt(t,e){if(C(t))return YX();const r=t.lods.length-1,i=t.spatialReference,s=vw(i)||fm(i)||mm(i);if(i.isWebMercator){if(!Tc.makeWebMercatorAuxiliarySphere(r).compatibleWith(t))return new q("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!s)return new q("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!Tc.makeGCSWithTileSize(t.spatialReference,t.size[0],r).compatibleWith(t))return t.spatialReference.isWGS84?new q("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new q("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return v(e)&&!t.spatialReference.equals(e)?new q("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene"):void 0}const kdt=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:Udt,isInsideExtent:Ndt,tiltToExtentEdge:Fdt},Symbol.toStringTag,{value:"Module"})),Vdt={[Be.Global]:kdt,[Be.Local]:Ddt};function Of(t,e){t||console.warn("Terrain: "+e)}let xn=!1,VF=!1;function Bdt(t){VF=t,xn=xn||t}function zdt(t){xn=t}function Re(t,e){var r;if(xn&&!t){const i=(r=new Error().stack)==null?void 0:r.slice(5);throw console.warn("Terrain internal: "+(e||"")+" at "+i),new Error("Assertion failed"+(e?": "+e:""))}}function lH(t){return l6(t)?{fullExtent:t.fullExtent,minScale:t.layer.minScale,maxScale:t.layer.maxScale,tilemapCache:null}:t.layer}function BF(t){return(t==null?void 0:t.type)==="imagery-tile"||(t==null?void 0:t.type)==="wcs"}function l6(t){return(t==null?void 0:t.type)==="imagery-tile-3d"}function oJ(t){return(t==null?void 0:t.type)==="tile-3d"}function LO(t){return(t==null?void 0:t.type)==="vector-tile-3d"}function HSe(t){return(t==null?void 0:t.type)==="wmts-3d"}function cH(t){return(t==null?void 0:t.type)==="elevation-3d"}function YC(t){return(t==null?void 0:t.type)==="group"}function zF(t){return t&&(oJ(t)||HSe(t)||l6(t)||LO(t))}function uH(t){return t&&(oJ(t)||l6(t)||LO(t)||HSe(t))}function DO(t){return uH(t)||cH(t)}function Gdt(t){var r;const e=(r=t==null?void 0:t.sourceLayerInfo)==null?void 0:r.data;return v(e)&&"type"in e&&e.type==="raster-tile"}function jdt(t){var r;const e=(r=t==null?void 0:t.sourceLayerInfo)==null?void 0:r.data;return v(e)&&"type"in e&&e.type==="vector-tile"}function Hdt(t){var r;const e=(r=t==null?void 0:t.sourceLayerInfo)==null?void 0:r.data;return v(e)&&"type"in e&&e.type==="tile-texture"}function qdt(t){var r;const e=(r=t==null?void 0:t.sourceLayerInfo)==null?void 0:r.data;return e instanceof HTMLImageElement||e instanceof a6||e instanceof HTMLCanvasElement||e instanceof ImageData}function hS(t){return v(t)&&"release"in t&&t.release(),null}function xae(t){return t.fetchTile&&t.hasOverriddenFetchTile!==!1}function aJ(t,e,r,i){return Vdt[i].checkIfTileInfoSupportedForViewSR(t,r,e)}function c6(t,e,r){let i=null,s=null;if((t==null?void 0:t.type)==="wmts"){const n=Wdt(t,e,r);i=n.tileInfo,s=n.fullExtent}else{s=BF(t)?t.getCompatibleFullExtent(e):t.fullExtent;const n=r===Be.Local;if(BF(t))i=t.getCompatibleTileInfo(e,s,n);else if((t==null?void 0:t.type)==="vector-tile"){const o=n&&!Xdt(e)||Ydt.force512VTL,a=t.tileInfo.spatialReference.isGeographic;i=o?t.tileInfo:t.tileInfo.getOrCreateCompatible(256,a?1:2)}else i=t.tileInfo}return v(i)&&v(s)&&aJ(i,s,e,r)==null?{tileInfo:i,fullExtent:s}:null}function Wdt(t,e,r){const i=EMe(t);if(v(i)){if(!Pt.isCollection(i))return{tileInfo:i.tileInfo,fullExtent:i.fullExtent};{const s=i.find(n=>aJ(n.tileInfo,n.fullExtent,e,r)==null);if(s)return{tileInfo:s.tileInfo,fullExtent:s.fullExtent}}}return{tileInfo:null,fullExtent:null}}function Xdt(t){return t.isWGS84||t.isWebMercator||hhe(t)||!NR(t)}const Ydt={force512VTL:!1};function Tae(t){return"["+t[0]+","+t[1]+","+t[2]+"]"}function Gm(t){return"("+t[0]+","+t[1]+","+t[2]+")"}function Sh(t,e,r=Kdt){return Math.abs(t-e)<r}function hH(t){return t===At.NORTH_EAST?At.SOUTH_WEST:t===At.NORTH_WEST?At.SOUTH_EAST:t===At.SOUTH_WEST?At.NORTH_EAST:At.NORTH_WEST}function GF(t){return t===At.NORTH?At.SOUTH:t===At.EAST?At.WEST:t===At.SOUTH?At.NORTH:At.EAST}function Zdt(t){return t===At.NORTH_WEST||t===At.SOUTH_WEST}function Jdt(t){return t===At.NORTH_WEST||t===At.NORTH_EAST}function Sae(t){return t===At.NORTH_WEST||t===At.WEST||t===At.SOUTH_WEST}function Eae(t){return t===At.NORTH_EAST||t===At.EAST||t===At.SOUTH_EAST}function Cae(t){return t===At.SOUTH_EAST||t===At.SOUTH||t===At.SOUTH_WEST}function Aae(t){return t===At.NORTH_EAST||t===At.NORTH||t===At.NORTH_WEST}const Bf=[At.NORTH,At.EAST,At.SOUTH,At.WEST],jF=[At.NORTH_EAST,At.SOUTH_EAST,At.SOUTH_WEST,At.NORTH_WEST],Kdt=1e-5;let Qdt=class{constructor(e,r){if(this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=e.layer,this.memory=DO(e)?r.basemapTerrain.getUsedMemoryForLayerView(e):e.getUsedMemory(),Odt(e)){const i=e.performanceInfo;this.displayedNumberOfFeatures=i.displayedNumberOfFeatures,this.maximumNumberOfFeatures=i.maximumNumberOfFeatures,this.totalNumberOfFeatures=i.totalNumberOfFeatures}}},ept=class{constructor(e){var i;if(this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array,v(e.resourceController)){const s=e.resourceController.memoryController;this.totalMemory=(s.maxMemory??0)*US.MEGABYTES,this.usedMemory=Math.round(s.usedMemory*this.totalMemory),this.quality=s.memoryFactor,this.load=e.resourceController.scheduler.load}this.terrainMemory=((i=e.basemapTerrain)==null?void 0:i.getUsedMemory())??0;const r=e._stage&&e._stage.renderView&&e._stage.renderer.edgeView;this.edgesMemory=v(r)?r.usedMemory:0,e.allLayerViews.items.forEach(s=>{(jSe(s)||DO(s))&&this.layerPerformanceInfos.push(new Qdt(s,e))}),this.layerPerformanceInfos.sort((s,n)=>n.memory-s.memory)}},tpt=class{constructor(e){this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=e("gltf-resources",()=>{}),this._wosrMemCache=e("wosr-resources",()=>{})}destroy(){this._gltfLoading.forEach(e=>e.abortController.abort()),this._wosrLoading.forEach(e=>e.abortController.abort()),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}loadGLTF(e,r,i){const s=i?`gltfPBR:${e}`:`gltf:${e}`,n=this._gltfMemCache.get(s);return v(n)?Promise.resolve(n):this._loadOnce(this._gltfLoading,this._gltfMemCache,s,o=>iSe(new tSe(o.streamDataRequester),e,o,i),r)}loadWOSR(e,r){const i=`wosr:${e}:${r.disableTextures}`,s=this._wosrMemCache.get(i);return v(s)?Promise.resolve(s):this._loadOnce(this._wosrLoading,this._wosrMemCache,i,n=>sSe(e,n),r)}async _loadOnce(e,r,i,s,n){fr(n);const o=fa(n,()=>this._abortLoad(e,i));let a=e.get(i);if(a)a.refCount++;else{const l=new AbortController;a={refCount:1,abortController:l,promise:s({...n,signal:l.signal})},e.set(i,a)}try{const l=await a.promise;return r.put(i,l,l.size),e.delete(i),fr(n),l}finally{ji(o)}}_abortLoad(e,r){const i=e.get(r);v(i)&&--i.refCount>0||(e.delete(r),v(i)&&i.abortController.abort())}},rpt=class extends C2{constructor(e,r,i,s){super(r,s),this._streamDataRequester=e,this._parameters=i}async fromUrl(e,r,i){fr(i);const s=v(i)?i.signal:null,n=this.makeUid(e,r);let o=this._textureRequests.get(n);if(!o){const a=new AbortController,l=this._streamDataRequester.request(e,"image",{uid:n,signal:a.signal});o={referenceCount:0,texture:null,textureAsync:null,abortController:a};const c=o;this._textureRequests.set(n,o),o.textureAsync=l.then(async h=>{const p=this._createTexture(e,h,r);return c.texture=p,c.abortController=null,this._stage.add(p),await this._stage.load(p),{uid:n,texture:p,release:()=>this._release(n)}},h=>{throw c.abortController=null,h})}o.referenceCount++;try{return await YH(o.textureAsync,s)}catch(a){throw this._release(n),a}}_createTexture(e,r,i){var n;const s={...this._parameters,powerOfTwoResizeMode:U_.PAD};if(nhe(e)){if(i||r.width===0&&r.height===0){const o=r.width?r.height/r.width:1;i=i||64,o>1?(r.width=Math.round(i/o),r.height=i):(r.width=i,r.height=Math.round(i*o))}(n=this._stage.renderView)!=null&&n.renderingContext.driverTest.svgPremultipliesAlpha.result&&(s.preMultiplyAlpha=!1)}return s.width=r.width,s.height=r.height,new ix(r,s)}},ipt=class{constructor(e){this.textures=null,this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=e.viewState,this._view=e.view,this._pointsOfInterest=e.pointsOfInterest,this.streamDataRequester=e.resourceController.createStreamDataRequester(Df.SYMBOLOGY),this.objectResourceCache=new tpt((i,s)=>e.resourceController.memoryController.newCache(i,s)),this.textures=new rpt(this.streamDataRequester,e.view._stage,{preMultiplyAlpha:!0,wrap:{s:Rt.CLAMP_TO_EDGE,t:Rt.CLAMP_TO_EDGE}},e.resourceController.scheduler);const r=Jr(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=Nwe(e.viewingMode,r),this.screenSizePerspectiveSettingsLabels=ntt(e.viewingMode,r)}destroy(){ke(this.textures),this.textures=null,this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return cp();this._graphicsOwners.push(e);const r=ie(()=>{var i;return(i=e.layer)==null?void 0:i.screenSizePerspectiveEnabled},()=>this._updateScreenSizePerspectiveEnabled());return this._updateScreenSizePerspectiveEnabled(),cp(()=>{r.remove(),PR(this._graphicsOwners,e),this._updateScreenSizePerspectiveEnabled()})}_updateScreenSizePerspectiveEnabled(){const e=this._graphicsOwners.some(r=>{var i;return((i=r.layer)==null?void 0:i.screenSizePerspectiveEnabled)===!0});if(e&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new ei;const r=()=>this._updateScreenSizePerspectiveSettings();this._screenSizePerspectiveHandles.add([ie(()=>this._pointsOfInterest.centerOnSurfaceInfrequent.distance,r,ri),this._viewState.events.on("camera-projection-changed",r)]),this._updateScreenSizePerspectiveSettings()}else e||(this._screenSizePerspectiveHandles=ke(this._screenSizePerspectiveHandles))}_updateScreenSizePerspectiveSettings(){const e=this._pointsOfInterest;m$.distance=e.centerOnSurfaceInfrequent.distance,m$.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(m$),this.screenSizePerspectiveSettingsLabels.update(m$),this._view._stage.renderView.requestRender()}get test(){return{screenSizePerspectiveHandles:this._screenSizePerspectiveHandles}}};const m$={distance:0,fovY:0};let c2=class{constructor(e,r,i=""){this.graphics=e,this._symbol=new v_({symbolLayers:[new __({material:{color:r},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new Ww({text:i,halo:{color:"white",size:1/.75},material:{color:r},size:12})]})}show(e,r){if(C(r))return;this.hide();const i=new mt({x:e[0],y:e[1],z:e[2],spatialReference:r});this._graphic=new Io({geometry:i,symbol:this._symbol}),this.graphics.add(this._graphic)}hide(){v(this._graphic)&&(this.graphics.remove(this._graphic),this._graphic=null)}},p_=class extends Te{constructor(e){super(e),this.handles=new ei}destroy(){this.handles.destroy()}};u([d({constructOnly:!0})],p_.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],p_.prototype,"surface",void 0),u([d({constructOnly:!0})],p_.prototype,"state",void 0),p_=u([I("esri.views.3d.support.PointOfInterest")],p_);const spt=Array;let Pd=class extends p_{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new ty({location:mt,renderLocation:spt},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.renderLocation=M(),this._tmpPoint=new mt}initialize(){if(this.scheduler&&this.handles.add(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.handles.add(sn(()=>{var r,i;return(i=(r=this.map)==null?void 0:r.ground)==null?void 0:i.layers},"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool=ke(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get scale(){const e=this._camera,r=xi(e.eye,this.renderLocation),i={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return Lw(i,r,0)}get updating(){return this._dirty||this._pendingElevationQueryController!=null}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map||!this.map.ground)return this._updateSurfaceAltitude(0),Zo.YIELD;const e=this.state.spatialReference;this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint,e);const r=(this._tmpPoint.z??0)>npt&&this.renderCoordsHelper.viewingMode===Be.Global&&(e.isWGS84||e.isWebMercator);let i=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:i.signal,cache:this.cache,minDemResolution:r?opt:0}).then(s=>this._updateSurfaceAltitude(s.geometry.z??0)).catch(s=>{Qs(s)||this._updateSurfaceAltitude(0)}).catch(()=>{}).then(()=>{this._pendingElevationQueryController===i&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),i=null}),this._pendingElevationQueryController=i,Zo.YIELD}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(J9,this._estimatedSurfaceAltitude,this._camera.eye),Ya(this._get("renderLocation"),J9)||(this._set("renderLocation",le(this._propertiesPool.get("renderLocation"),J9)),this.notifyChange("renderLocation"))}};u([d({constructOnly:!0})],Pd.prototype,"scheduler",void 0),u([d({constructOnly:!0})],Pd.prototype,"cache",void 0),u([d({constructOnly:!0})],Pd.prototype,"task",void 0),u([d({readOnly:!0})],Pd.prototype,"location",null),u([d({constructOnly:!0})],Pd.prototype,"map",void 0),u([d({readOnly:!0})],Pd.prototype,"renderLocation",void 0),u([d({readOnly:!0})],Pd.prototype,"scale",null),u([d({readOnly:!0})],Pd.prototype,"updating",null),Pd=u([I("esri.views.3d.support.CameraOnSurface")],Pd);const J9=M(),npt=1e5,opt=1e6,apt=Array;let fh=class extends p_{constructor(e){super(e),this._propertiesPool=new ty({location:mt,renderLocation:apt},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=M(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=ji(this._frameWorker),this._propertiesPool=ke(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,Zo.YIELD}_updateRenderLocation(){const e=cpt;let r=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!r&&i&&(r=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),r&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const s=upt;r&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,s)&&(le(e,s),this._currentSurfaceAltitude=this._latestSurfaceAltitude),r?this.distance=xi(this._camera.eye,e):(ae(e,this._camera.viewForward,this._get("distance")),fe(e,e,this._camera.eye)),Ya(this._get("renderLocation"),e)||this._set("renderLocation",le(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,r){var s,n;const i=this._camera;if(!this.renderCoordsHelper.intersectManifold(i.ray,e,r))return!1;if(this.state.isGlobal){const o=Jr(this.renderCoordsHelper.spatialReference).radius,a=o+e,l=ua(i.eye),c=l<a*a,h=xi(i.eye,r);if(c&&h>o/4){const p=a-Math.sqrt(l);return ae(r,i.viewForward,p),fe(r,r,i.eye),!0}}else{const o=(s=this.surface)!=null&&s.ready?this.surface.extent:null;v(o)&&N4(o,(n=this.surface)==null?void 0:n.spatialReference,ZC,this.renderCoordsHelper.spatialReference)&&(r[0]=ge(r[0],ZC[0],ZC[2]),r[1]=ge(r[1],ZC[1],ZC[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,r){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||e==null)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,r)){if(qr.TESTS_DISABLE_OPTIMIZATIONS)return!0;const i=this._camera.eye,s=xi(i,e),n=xi(i,r);if(Math.abs(n-s)/s>lpt)return!0}return!1}};u([d({constructOnly:!0})],fh.prototype,"scheduler",void 0),u([d({constructOnly:!0})],fh.prototype,"task",void 0),u([d()],fh.prototype,"distance",void 0),u([d({constructOnly:!0})],fh.prototype,"estimateSurfaceAltitudeAtCenter",void 0),u([d({readOnly:!0})],fh.prototype,"location",null),u([d({readOnly:!0})],fh.prototype,"renderLocation",void 0),u([d()],fh.prototype,"updating",void 0),fh=u([I("esri.views.3d.support.CenterOnSurface")],fh);const lpt=.05,cpt=M(),upt=M(),ZC=ur();let hpt=class{constructor(e){this._handles=new ei,this.events=new vs,this._contentLayerViews=e.contentLayerViews,this._handles.add(this._contentLayerViews.on("change",r=>this._layerViewsChanged(r))),this._layerViewsChanged({added:this._contentLayerViews.toArray(),removed:[],moved:[],target:this._contentLayerViews})}destroy(){this._handles=ke(this._handles)}_layerViewsChanged(e){e.added.forEach(r=>{r.declaredClass==="esri.views.3d.layers.SceneLayerView3D"&&this._handles.add(r.on("visible-geometry-changed",()=>this._contentChanged()),r.uid)}),e.removed.forEach(r=>this._handles.remove(r.uid))}_contentChanged(){this.events.emit("request-update",dpt)}};const dpt={},ppt=Array;let mf=class extends p_{constructor(e){super(e),this._propertiesPool=new ty({location:mt,renderLocation:ppt},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.handles.add([ie(()=>this.centerOnSurface.renderLocation,()=>this.updateRenderLocation()),ie(()=>this.state.contentCamera,()=>this.updateRenderLocation())]),this.scheduler&&this.handles.add(this.scheduler.registerTask(_t.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool=ke(this._propertiesPool)}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),r=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,s=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(r,Rae);const n=Math.max(0,(Math.acos(ye(Rae,s.viewForward))-.5*Math.PI)*(s.aboveGround?1:-1));if(Number.isNaN(n)){if(!e||!q_(e,r)){const c=this._propertiesPool.get("renderLocation");le(c,r),this._set("renderLocation",c)}return Zo.YIELD}const o=1-ge(n/(.5*Math.PI),0,1),a=o*o*o;this._calculateScreenHorizontalEdgeOnSurface(Oae);const l=this._propertiesPool.get("renderLocation");return Ys(l,r,Oae,a),e&&q_(e,l)||this._set("renderLocation",l),Zo.YIELD}_calculateScreenHorizontalEdgeOnSurface(e){const r=this.state.contentCamera,i=r.getRenderCenter(qo());if(i[1]=r.aboveGround?r.padding[lr.BOTTOM]:r.fullHeight-r.padding[lr.TOP],this.estimateSurfaceIntersectionAtRenderPoint(i,e))return e;const s=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(r.unprojectFromRenderScreen(i,JC)){me(JC,JC,r.eye);const n=_e(JC,JC);if(this.renderCoordsHelper.intersectManifold(Du(r.eye,n),s,e))return e}return this.renderCoordsHelper.setAltitude(e,s,r.eye)}updateRenderLocation(){this._dirty=!0}};u([d()],mf.prototype,"_dirty",void 0),u([d({constructOnly:!0})],mf.prototype,"scheduler",void 0),u([d({constructOnly:!0})],mf.prototype,"centerOnSurface",void 0),u([d({constructOnly:!0})],mf.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),u([d({readOnly:!0})],mf.prototype,"updating",null),u([d({readOnly:!0})],mf.prototype,"location",null),u([d({readOnly:!0})],mf.prototype,"renderLocation",void 0),mf=u([I("esri.views.3d.support.pointsOfInterest.Focus")],mf);const Rae=M(),JC=M(),Oae=M();let gg=class extends Te{get surface(){var e;return(e=this.view.map)==null?void 0:e.ground}get surfaceView(){return this.view.basemapTerrain}get renderLocation(){if(!this.location)return null;const e=M();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}constructor(e){super(e),this.location=null,this._updateController=null,this._handles=new ei}initialize(){this.view.state.isLocal&&(this._handles.add([ie(()=>{var e,r;return[(e=this.surfaceView)==null?void 0:e.spatialReference,(r=this.surfaceView)==null?void 0:r.extent]},()=>this._update()),sn(()=>{var e;return(e=this.surface)==null?void 0:e.layers},"change",()=>this._update())]),this._update())}destroy(){this._handles.destroy()}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),!this.surfaceView||C(this.surfaceView.extent)||C(this.surfaceView.spatialReference))return void this._set("location",null);const e=rW(this.surfaceView.extent),r=new mt({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(r,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then(i=>{this._updateController=null,this._set("location",i.geometry)}).catch(i=>{Qs(i)||i&&i.name==="elevation-query:invalid-layer"||console.error("StableSurfaceCenter failed to update: ",i)})):this._set("location",r)}};u([d({constructOnly:!0})],gg.prototype,"view",void 0),u([d({constructOnly:!0})],gg.prototype,"cache",void 0),u([d()],gg.prototype,"surface",null),u([d()],gg.prototype,"surfaceView",null),u([d({readOnly:!0})],gg.prototype,"location",void 0),u([d({readOnly:!0})],gg.prototype,"renderLocation",null),gg=u([I("esri.views.3d.terrain.StableSurfaceCenter")],gg);let yg=class extends Te{constructor(e){super(e),this._tileGeometryUpdateExtent=zh(),this._tileGeometryUpdateSpatialReference=null,this.events=new vs,this.updating=!1}initialize(){this.addHandles([this.surface.on("elevation-change",e=>this._tileGeometryChanged(e)),this.scheduler.registerTask(_t.SURFACE_GEOMETRY_UPDATES,this)])}get running(){return this.updating}runTask(){return this.updating&&(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",fpt),zh(this._tileGeometryUpdateExtent),this._set("updating",!1)),Zo.YIELD}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,L_(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let r=1;r<this.centerOnSurfaces.length;r++){const i=this.centerOnSurfaces[r];i.distance>e.distance&&(e=i)}return e}_centerIntersectsExtent(e,r){const i=this.state.contentCamera.eye,s=mpt,n=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,n1,r),this.renderCoordsHelper.fromRenderCoords(n.renderLocation,o1,r),n1[0]<o1[0]?(s[0]=n1[0],s[2]=o1[0]):(s[0]=o1[0],s[2]=n1[0]),n1[1]<o1[1]?(s[1]=n1[1],s[3]=o1[1]):(s[1]=o1[1],s[3]=n1[1]),x4(s,e)}};u([d({constructOnly:!0})],yg.prototype,"state",void 0),u([d({constructOnly:!0})],yg.prototype,"centerOnSurfaces",void 0),u([d({constructOnly:!0})],yg.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],yg.prototype,"scheduler",void 0),u([d({constructOnly:!0})],yg.prototype,"surface",void 0),u([d({readOnly:!0})],yg.prototype,"updating",void 0),yg=u([I("esri.views.3d.support.SurfaceGeometryUpdates")],yg);const fpt={},n1=M(),o1=M(),mpt=zh();let Pl=class extends Te{constructor(e){super(e),this._handles=new ei,this._tmpRay=ro(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new ty({renderPointOfView:gpt},this),this.renderPointOfView=M(),this._pois=new Array,this._debugCenters=new Map}initialize(){var h;const{state:e,basemapTerrain:r,renderCoordsHelper:i,map:s}=this.view;this._surfaceIntersector=Wh(e.viewingMode),e.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=Po.MIN,this._contentIntersector=Wh(e.viewingMode);const n=()=>this._estimateSurfaceAltitudeAtCenter(),o=this.view.resourceController.scheduler,a=(h=this.view.basemapTerrain)==null?void 0:h.elevationQueryCache,l={state:e,scheduler:o,surface:r,renderCoordsHelper:i};this._set("centerOnSurfaceInfrequent",new fh({...l,task:_t.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:n})),this._set("centerOnSurfaceFrequent",new fh({...l,task:_t.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:n})),this._set("centerOnContent",new fh({...l,task:_t.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new Pd({...l,cache:a,task:_t.POINT_OF_INTEREST_INFREQUENT,map:s})),this._set("surfaceGeometryUpdates",new yg({...l,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new hpt({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:i})),this._set("surfaceOrigin",new gg({cache:a,view:this.view})),this._set("focus",new mf({state:e,scheduler:o,surface:r,renderCoordsHelper:i,centerOnSurface:this.centerOnSurfaceInfrequent,estimateSurfaceIntersectionAtRenderPoint:(p,f)=>this._estimateSurfaceIntersectionAtRenderPoint(p,this.view.state.contentCamera,f)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus);const c=this.view.graphics;this._debugCenters.set(this.centerOnContent,new c2(c,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new c2(c,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new c2(c,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new c2(c,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new c2(c,"green","Focus")),this._handles.add([ie(()=>e.contentCamera,p=>this._cameraChanged(p),ri),ie(()=>r.extent,()=>this._updateCenterPointsOfInterest()),_a(()=>!r.updating,()=>this._updateCenterPointsOfInterest(),ri),sn(()=>this.surfaceGeometryUpdates.events,"request-update",()=>this._updateCenterPointsOfInterest()),sn(()=>this.contentGeometryUpdates.events,"request-update",()=>this._updateCenterOnContent()),_a(()=>qr.SHOW_POI,p=>this._setDebug(p),Vt)]),this._cameraChanged(this.view.state.contentCamera);for(const p of this._pois)p.runTask()}destroy(){this._setDebug(!1),this._handles.destroy(),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy()}get updating(){var e;return!(!((e=this.surfaceGeometryUpdates)!=null&&e.updating)&&!this._pois.some(r=>r.updating))}get _centerRay(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this._centerRay;return C(e)||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,Zx,_pt)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Zx):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this._centerRay;if(C(e))return this._surfaceAltitudeAtCenter;const r=e.origin,i=fe(Zx,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.contentCamera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,r,i),this._surfaceIntersector.results.min.getIntersectionPoint(Zx)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Zx)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,r,i){const s=ZY(r,e,ypt);if(C(s))return null;const n=s.origin,o=fe(Zx,s.origin,s.direction);return this._surfaceIntersector.resetWithRay(s,r),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,n,o),this._surfaceIntersector.results.min.getIntersectionPoint(i)?i:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const r=e.eye;Ya(this.renderPointOfView,r)||this._set("renderPointOfView",le(this._propertiesPool.get("renderPointOfView"),r))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters.forEach(r=>r.hide()),void this._handles.remove("debug");for(const r of this._pois)this._handles.add(ie(()=>r.renderLocation,i=>{var s;return(s=this._debugCenters.get(r))==null?void 0:s.show(i,r.renderCoordsHelper.spatialReference)},Vt),"debug")}get test(){return{update:()=>{this.surfaceGeometryUpdates.runTask();for(const e of this._pois)e.runTask()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}};u([d({readOnly:!0})],Pl.prototype,"centerOnContent",void 0),u([d({readOnly:!0})],Pl.prototype,"centerOnSurfaceFrequent",void 0),u([d({readOnly:!0})],Pl.prototype,"centerOnSurfaceInfrequent",void 0),u([d({readOnly:!0})],Pl.prototype,"cameraOnSurface",void 0),u([d({readOnly:!0})],Pl.prototype,"focus",void 0),u([d({readOnly:!0})],Pl.prototype,"renderPointOfView",void 0),u([d({readOnly:!0})],Pl.prototype,"surfaceOrigin",void 0),u([d({readOnly:!0})],Pl.prototype,"contentGeometryUpdates",void 0),u([d({readOnly:!0})],Pl.prototype,"surfaceGeometryUpdates",void 0),u([d({constructOnly:!0})],Pl.prototype,"view",void 0),u([d({readOnly:!0})],Pl.prototype,"updating",null),Pl=u([I("esri.views.3d.support.PointsOfInterest")],Pl);const gpt=Array,Zx=M(),ypt=ro(),_pt={exclude:new Set([c_])};let vpt=class{constructor(e){this._store=e}destroy(){this._store.destroy()}get(e){return this._store.get(e)}put(e,r){this._store.put(e,r,r.values.byteLength+256)}},bpt=class{constructor(e,r,i,s){this._hasNoDataValues=null,this._minValue=null,this._maxValue=null,"pixelData"in e?(this.values=e.pixelData,this.width=e.width,this.height=e.height,this.noDataValue=e.noDataValue):(this.values=e,this.width=r,this.height=i,this.noDataValue=s)}get hasNoDataValues(){if(C(this._hasNoDataValues)){const e=this.noDataValue;this._hasNoDataValues=this.values.includes(e)}return this._hasNoDataValues}get minValue(){return this._ensureBounds(),this._minValue}get maxValue(){return this._ensureBounds(),this._maxValue}_ensureBounds(){if(v(this._minValue))return;const{noDataValue:e,values:r}=this;let i=1/0,s=-1/0,n=!0;for(const o of r)o===e?this._hasNoDataValues=!0:(i=o<i?o:i,s=o>s?o:s,n=!1);n?(this._minValue=0,this._maxValue=0):(this._minValue=i,this._maxValue=s>-3e38?s:0)}},qSe=class{constructor(e,r,i,s,n={}){this._mainMethod=r,this._transferLists=i,this._listeners=[],this._promise=Zpe(e,{...n,schedule:s}).then(o=>{if(this._thread===void 0){this._thread=o,this._promise=null,n.hasInitialize&&this.broadcast({},"initialize");for(const a of this._listeners)this._connectListener(a)}else o.close()}),this._promise.catch(o=>se.getLogger("esri.core.workers.WorkerHandle").error(`Failed to initialize ${e} worker: ${o}`))}on(e,r){const i={removed:!1,eventName:e,callback:r,threadHandle:null};return this._listeners.push(i),this._connectListener(i),cp(()=>{i.removed=!0,kH(this._listeners,i),this._thread&&v(i.threadHandle)&&i.threadHandle.remove()})}destroy(){this._thread&&(this._thread.close(),this._thread=null),this._promise=null}invoke(e,r){return this.invokeMethod(this._mainMethod,e,r)}invokeMethod(e,r,i){if(this._thread){const s=this._transferLists[e],n=s?s(r):[];return this._thread.invoke(e,r,{transferList:n,signal:i})}return this._promise?this._promise.then(()=>(fr(i),this.invokeMethod(e,r,i))):Promise.reject(null)}broadcast(e,r){return this._thread?Promise.all(this._thread.broadcast(r,e)).then(()=>{}):this._promise?this._promise.then(()=>this.broadcast(e,r)):Promise.reject()}get promise(){return this._promise}_connectListener(e){this._thread&&this._thread.on(e.eventName,e.callback).then(r=>{e.removed||(e.threadHandle=r)})}},Mae=class extends qSe{constructor(e=null){super("LercWorker","_decode",{_decode:r=>[r.buffer]},e,{strategy:"dedicated"}),this.schedule=e,this.ref=0}decode(e,r,i){return e&&e.byteLength!==0?this.invoke({buffer:e,options:r},i):Promise.resolve(null)}release(){--this.ref<=0&&(CR.forEach((e,r)=>{e===this&&CR.delete(r)}),this.destroy())}};const CR=new Map;function wpt(t=null){let e=CR.get(t);return e||(v(t)?(e=new Mae(r=>t.immediate.schedule(r)),CR.set(t,e)):(e=new Mae,CR.set(null,e))),++e.ref,e}var bc,Pae,Iae;(function(t){t[t.FILL=1]="FILL",t[t.LINE=2]="LINE",t[t.SYMBOL=3]="SYMBOL",t[t.CIRCLE=4]="CIRCLE"})(bc||(bc={})),function(t){t[t.BACKGROUND=0]="BACKGROUND",t[t.FILL=1]="FILL",t[t.OUTLINE=2]="OUTLINE",t[t.LINE=3]="LINE",t[t.ICON=4]="ICON",t[t.CIRCLE=5]="CIRCLE",t[t.TEXT=6]="TEXT",t[t.TILEINFO=7]="TILEINFO"}(Pae||(Pae={})),function(t){t[t.PAINTER_CHANGED=0]="PAINTER_CHANGED",t[t.LAYOUT_CHANGED=1]="LAYOUT_CHANGED",t[t.LAYER_CHANGED=2]="LAYER_CHANGED",t[t.LAYER_REMOVED=3]="LAYER_REMOVED",t[t.SPRITES_CHANGED=4]="SPRITES_CHANGED"}(Iae||(Iae={}));let xpt=class{constructor(e){this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=e}},D$t=class{constructor(){this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1}};function F$t(t,e,r,i,s,n){const o=r-s;if(o>=0)return(e>>o)+(i-(n<<o))*(t>>o);const a=-o;return e-(n-(i<<a))*(t>>a)<<a}let U$t=class{constructor(e,r,i){this._rows=Math.ceil(r/i),this._columns=Math.ceil(e/i),this._cellSize=i,this.cells=new Array(this._rows);for(let s=0;s<this._rows;s++){this.cells[s]=new Array(this._columns);for(let n=0;n<this._columns;n++)this.cells[s][n]=[]}}getCell(e,r){const i=Math.min(Math.max(Math.floor(r/this._cellSize),0),this._rows-1),s=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[i]&&this.cells[i][s]||null}getCellSpan(e,r,i,s){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(r/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(s/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}};function Tpt(t,e,r,i,s,n){const o=e[i++];for(let a=0;a<o;a++){const l=new xpt(n);l.xTile=e[i++],l.yTile=e[i++],l.hash=e[i++],l.priority=e[i++];const c=e[i++];for(let f=0;f<c;f++){const m=e[i++],y=e[i++],_=e[i++],b=e[i++],x=!!e[i++],T=e[i++],S=r[i++],E=r[i++],O=e[i++],R=e[i++];l.colliders.push({xTile:m,yTile:y,dxPixels:_,dyPixels:b,hard:x,partIndex:T,width:O,height:R,minLod:S,maxLod:E})}const h=t[i++];for(let f=0;f<h;f++)l.textVertexRanges.push([t[i++],t[i++]]);const p=t[i++];for(let f=0;f<p;f++)l.iconVertexRanges.push([t[i++],t[i++]]);s.push(l)}return i}function V$t(t,e,r){for(const[i,s]of t.symbols)Spt(t,e,r,s,i)}function Spt(t,e,r,i,s){const n=t.layerData.get(s);if(n.type===bc.SYMBOL){for(const o of i){const a=o.unique;let l;if(o.selectedForRendering){const c=a.parts[0],h=c.startOpacity,p=c.targetOpacity;t.allSymbolsFadingOut=t.allSymbolsFadingOut&&p===0;const f=r?Math.floor(127*h)|p<<7:p?255:0;l=f<<24|f<<16|f<<8|f}else l=0;for(const[c,h]of o.iconVertexRanges)for(let p=c;p<c+h;p+=4)n.iconOpacity[p/4]=l;if(o.selectedForRendering){const c=a.parts[1],h=c.startOpacity,p=c.targetOpacity;t.allSymbolsFadingOut=t.allSymbolsFadingOut&&p===0;const f=r?Math.floor(127*h)|p<<7:p?255:0;l=f<<24|f<<16|f<<8|f}else l=0;for(const[c,h]of o.textVertexRanges)for(let p=c;p<c+h;p+=4)n.textOpacity[p/4]=l}n.lastOpacityUpdate=e,n.opacityChanged=!0}}let u6=class{constructor(e,r){this.layerUIDs=[],this.isDestroyed=!1,this._data=e,this.memoryUsed=e.byteLength;let i=1;const s=new Uint32Array(e);this.layerUIDs=[];const n=s[i++];for(let o=0;o<n;o++)this.layerUIDs[o]=s[i++];this.bufferDataOffset=i,r&&(this.layer=r.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return C(this._data)}get offset(){return this.bufferDataOffset}destroy(){this.isDestroyed||(this.doDestroy(),this.isDestroyed=!0)}prepareForRendering(e){C(this._data)||(this.doPrepareForRendering(e,this._data,this.bufferDataOffset),this._data=null)}},Ept=class extends u6{constructor(e,r){super(e,r),this.type=bc.LINE,this.lineIndexStart=0,this.lineIndexCount=0;const i=new Uint32Array(e);let s=this.bufferDataOffset;this.lineIndexStart=i[s++],this.lineIndexCount=i[s++];const n=i[s++];if(n>0){const o=new Map;for(let a=0;a<n;a++){const l=i[s++],c=i[s++],h=i[s++];o.set(l,[c,h])}this.patternMap=o}this.bufferDataOffset=s}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){v(this.lineVertexArrayObject)&&this.lineVertexArrayObject.dispose(),v(this.lineVertexBuffer)&&this.lineVertexBuffer.dispose(),v(this.lineIndexBuffer)&&this.lineIndexBuffer.dispose(),this.lineVertexArrayObject=null,this.lineVertexBuffer=null,this.lineIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(e,r,i){const s=new Uint32Array(r),n=new Int32Array(s.buffer),o=s[i++];this.lineVertexBuffer=jr.createVertex(e,Lr.STATIC_DRAW,new Int32Array(n.buffer,4*i,o)),i+=o;const a=s[i++];this.lineIndexBuffer=jr.createIndex(e,Lr.STATIC_DRAW,new Uint32Array(s.buffer,4*i,a)),i+=a;const l=this.layer.lineMaterial;this.lineVertexArrayObject=new jh(e,l.getAttributeLocations(),l.getLayoutInfo(),{geometry:this.lineVertexBuffer},this.lineIndexBuffer)}},Cpt=class extends u6{constructor(e,r){super(e,r),this.type=bc.FILL,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const i=new Uint32Array(e);let s=this.bufferDataOffset;this.fillIndexStart=i[s++],this.fillIndexCount=i[s++],this.outlineIndexStart=i[s++],this.outlineIndexCount=i[s++];const n=i[s++];if(n>0){const o=new Map;for(let a=0;a<n;a++){const l=i[s++],c=i[s++],h=i[s++];o.set(l,[c,h])}this.patternMap=o}this.bufferDataOffset=s}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){v(this.fillVertexArrayObject)&&this.fillVertexArrayObject.dispose(),v(this.fillVertexBuffer)&&this.fillVertexBuffer.dispose(),v(this.fillIndexBuffer)&&this.fillIndexBuffer.dispose(),this.fillVertexArrayObject=null,this.fillVertexBuffer=null,this.fillIndexBuffer=null,v(this.outlineVertexArrayObject)&&this.outlineVertexArrayObject.dispose(),v(this.outlineVertexBuffer)&&this.outlineVertexBuffer.dispose(),v(this.outlineIndexBuffer)&&this.outlineIndexBuffer.dispose(),this.outlineVertexArrayObject=null,this.outlineVertexBuffer=null,this.outlineIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(e,r,i){const s=new Uint32Array(r),n=new Int32Array(s.buffer),o=s[i++];this.fillVertexBuffer=jr.createVertex(e,Lr.STATIC_DRAW,new Int32Array(n.buffer,4*i,o)),i+=o;const a=s[i++];this.fillIndexBuffer=jr.createIndex(e,Lr.STATIC_DRAW,new Uint32Array(s.buffer,4*i,a)),i+=a;const l=s[i++];this.outlineVertexBuffer=jr.createVertex(e,Lr.STATIC_DRAW,new Int32Array(n.buffer,4*i,l)),i+=l;const c=s[i++];this.outlineIndexBuffer=jr.createIndex(e,Lr.STATIC_DRAW,new Uint32Array(s.buffer,4*i,c)),i+=c;const h=this.layer,p=h.fillMaterial,f=h.outlineMaterial;this.fillVertexArrayObject=new jh(e,p.getAttributeLocations(),p.getLayoutInfo(),{geometry:this.fillVertexBuffer},this.fillIndexBuffer),this.outlineVertexArrayObject=new jh(e,f.getAttributeLocations(),f.getLayoutInfo(),{geometry:this.outlineVertexBuffer},this.outlineIndexBuffer)}},Apt=class extends u6{constructor(e,r,i){super(e,r),this.type=bc.SYMBOL,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const s=new Uint32Array(e),n=new Int32Array(e),o=new Float32Array(e);let a=this.bufferDataOffset;this.isIconSDF=!!s[a++];const l=s[a++];for(let f=0;f<l;f++){const m=s[a++],y=s[a++],_=s[a++];this.iconPerPageElementsMap.set(m,[y,_])}const c=s[a++];for(let f=0;f<c;f++){const m=s[a++],y=s[a++],_=s[a++];this.glyphPerPageElementsMap.set(m,[y,_])}const h=s[a++],p=s[a++];this.iconOpacity=new Int32Array(h),this.textOpacity=new Int32Array(p),a=Tpt(s,n,o,a,this.symbols,i),this.bufferDataOffset=a}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let e=0;for(const[r,i]of this.iconPerPageElementsMap)e+=i[1];for(const[r,i]of this.glyphPerPageElementsMap)e+=i[1];return e/3}doDestroy(){v(this.iconVertexArrayObject)&&this.iconVertexArrayObject.dispose(),v(this.iconVertexBuffer)&&this.iconVertexBuffer.dispose(),v(this.iconOpacityBuffer)&&this.iconOpacityBuffer.dispose(),v(this.iconIndexBuffer)&&this.iconIndexBuffer.dispose(),this.iconVertexArrayObject=null,this.iconVertexBuffer=null,this.iconOpacityBuffer=null,this.iconIndexBuffer=null,v(this.textVertexArrayObject)&&this.textVertexArrayObject.dispose(),v(this.textVertexBuffer)&&this.textVertexBuffer.dispose(),v(this.textOpacityBuffer)&&this.textOpacityBuffer.dispose(),v(this.textIndexBuffer)&&this.textIndexBuffer.dispose(),this.textVertexArrayObject=null,this.textVertexBuffer=null,this.textOpacityBuffer=null,this.textIndexBuffer=null,this.memoryUsed=0}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const e=this.iconOpacity,r=this.iconOpacityBuffer;e.length>0&&e.byteLength===r.size&&r.setSubData(e,0,0,e.length);const i=this.textOpacity,s=this.textOpacityBuffer;i.length>0&&i.byteLength===s.size&&s.setSubData(i,0,0,i.length)}doPrepareForRendering(e,r,i){const s=new Uint32Array(r),n=new Int32Array(s.buffer),o=s[i++];this.iconVertexBuffer=jr.createVertex(e,Lr.STATIC_DRAW,new Int32Array(n.buffer,4*i,o)),i+=o;const a=s[i++];this.iconIndexBuffer=jr.createIndex(e,Lr.STATIC_DRAW,new Uint32Array(s.buffer,4*i,a)),i+=a;const l=s[i++];this.textVertexBuffer=jr.createVertex(e,Lr.STATIC_DRAW,new Int32Array(n.buffer,4*i,l)),i+=l;const c=s[i++];this.textIndexBuffer=jr.createIndex(e,Lr.STATIC_DRAW,new Uint32Array(s.buffer,4*i,c)),i+=c,this.iconOpacityBuffer=jr.createVertex(e,Lr.STATIC_DRAW,this.iconOpacity.buffer),this.textOpacityBuffer=jr.createVertex(e,Lr.STATIC_DRAW,this.textOpacity.buffer);const h=this.layer,p=h.iconMaterial,f=h.textMaterial;this.iconVertexArrayObject=new jh(e,p.getAttributeLocations(),p.getLayoutInfo(),{geometry:this.iconVertexBuffer,opacity:this.iconOpacityBuffer},this.iconIndexBuffer),this.textVertexArrayObject=new jh(e,f.getAttributeLocations(),f.getLayoutInfo(),{geometry:this.textVertexBuffer,opacity:this.textOpacityBuffer},this.textIndexBuffer)}},Rpt=class extends u6{constructor(e,r){super(e,r),this.type=bc.CIRCLE,this.circleIndexStart=0,this.circleIndexCount=0;const i=new Uint32Array(e);let s=this.bufferDataOffset;this.circleIndexStart=i[s++],this.circleIndexCount=i[s++],this.bufferDataOffset=s}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){v(this.circleVertexArrayObject)&&this.circleVertexArrayObject.dispose(),v(this.circleVertexBuffer)&&this.circleVertexBuffer.dispose(),v(this.circleIndexBuffer)&&this.circleIndexBuffer.dispose(),this.circleVertexArrayObject=null,this.circleVertexBuffer=null,this.circleIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(e,r,i){const s=new Uint32Array(r),n=new Int32Array(s.buffer),o=s[i++];this.circleVertexBuffer=jr.createVertex(e,Lr.STATIC_DRAW,new Int32Array(n.buffer,4*i,o)),i+=o;const a=s[i++];this.circleIndexBuffer=jr.createIndex(e,Lr.STATIC_DRAW,new Uint32Array(s.buffer,4*i,a)),i+=a;const l=this.layer.circleMaterial;this.circleVertexArrayObject=new jh(e,l.getAttributeLocations(),l.getLayoutInfo(),{geometry:this.circleVertexBuffer},this.circleIndexBuffer)}};const q$t=!0,W$t=32,$ae=200,Opt=1/de("mapview-transitions-duration");let Mpt=class extends vs{constructor(){super(...arguments),this._fadeOutResolver=null,this._fadeInResolver=null,this._clips=null,this.computedVisible=!0,this.computedOpacity=1,this.fadeTransitionEnabled=!1,this.inFadeTransition=!1,this._isReady=!1,this._opacity=1,this.parent=null,this._stage=null,this._visible=!0}get clips(){return this._clips}set clips(e){this._clips=e,this.requestRender()}get isReady(){return this._isReady}get opacity(){return this._opacity}set opacity(e){this._opacity!==e&&(this._opacity=Math.min(1,Math.max(e,0)),this.requestRender())}get stage(){return this._stage}set stage(e){var i;if(this._stage===e)return;const r=this._stage;this._stage=e,e?(i=this._stage)!=null&&i.untrashDisplayObject(this)||(this.onAttach(),this.emit("attach")):r==null||r.trashDisplayObject(this)}get transforms(){return this._getTransforms()}_getTransforms(){return C(this._transforms)&&(this._transforms=this._createTransforms()),this._transforms}get visible(){return this._visible}set visible(e){this._visible!==e&&(this._visible=e,this.requestRender())}fadeIn(){return this._fadeInResolver||(this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.opacity=1,this.computedOpacity=0,this.fadeTransitionEnabled=!0,this._fadeInResolver=H_(),this.requestRender()),this._fadeInResolver.promise}fadeOut(){return this._fadeOutResolver||(this.opacity=0,this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this.fadeTransitionEnabled=!0,this._fadeOutResolver=H_(),this.requestRender()),this._fadeOutResolver.promise}endTransitions(){var e,r;(e=this._fadeInResolver)==null||e.call(this),this._fadeInResolver=null,(r=this._fadeOutResolver)==null||r.call(this),this._fadeOutResolver=null,this.computedOpacity=this.visible?this.opacity:0,this.requestRender()}beforeRender(e){this.updateTransitionProperties(e.deltaTime,e.state.scale)}afterRender(e){this._fadeInResolver&&this.computedOpacity===this.opacity?(this._fadeInResolver(),this._fadeInResolver=null):this._fadeOutResolver&&this.computedOpacity===0&&(this._fadeOutResolver(),this._fadeOutResolver=null)}remove(){var e;(e=this.parent)==null||e.removeChild(this)}setTransform(e){}processRender(e){this.stage&&this.computedVisible&&this.doRender(e)}requestRender(){this.stage&&this.stage.requestRender()}processDetach(){this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.onDetach(),this.emit("detach")}updateTransitionProperties(e,r){if(this.fadeTransitionEnabled){const i=this._fadeOutResolver||!this.visible?0:this.opacity,s=this.computedOpacity;if(s===i)this.computedVisible=this.visible;else{const n=e*Opt;this.computedOpacity=s>i?Math.max(i,s-n):Math.min(i,s+n),this.computedVisible=this.computedOpacity>0;const o=i===this.computedOpacity;this.inFadeTransition=!o,o||this.requestRender()}}else this.computedOpacity=this.opacity,this.computedVisible=this.visible}onAttach(){}onDetach(){}doRender(e){}ready(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}},dH=class ob{static getId(e,r,i,s){return typeof e=="object"?`${e.level}/${e.row}/${e.col}/${e.world}`:`${e}/${r}/${i}/${s}`}constructor(e,r,i,s){this.set(e,r,i,s)}get key(){return this}get id(){return this.toString()}set id(e){this.set(e)}get hash(){const e=4095&this.row,r=4095&this.col,i=63&this.level;return(3&this.world)<<30|r<<22|e<<8|i}acquire(e,r,i,s){this.set(e,r,i,s)}contains(e){const r=e.level-this.level;return r>=0&&this.row===e.row>>r&&this.col===e.col>>r&&this.world===e.world}equals(e){return this.level===e.level&&this.row===e.row&&this.col===e.col&&this.world===e.world}clone(){return new ob(this)}release(){this.level=0,this.row=0,this.col=0,this.world=0}set(e,r,i,s){if(e==null)this.level=0,this.row=0,this.col=0,this.world=0;else if(typeof e=="object")this.level=e.level||0,this.row=e.row||0,this.col=e.col||0,this.world=e.world||0;else if(typeof e=="string"){const[n,o,a,l]=e.split("/");this.level=parseFloat(n),this.row=parseFloat(o),this.col=parseFloat(a),this.world=parseFloat(l)}else this.level=+e,this.row=+r,this.col=+i,this.world=+s||0;return this}toString(){return`${this.level}/${this.row}/${this.col}/${this.world}`}getParentKey(){return this.level<=0?null:new ob(this.level-1,this.row>>1,this.col>>1,this.world)}getChildKeys(){const e=this.level+1,r=this.row<<1,i=this.col<<1,s=this.world;return[new ob(e,r,i,s),new ob(e,r,i+1,s),new ob(e,r+1,i,s),new ob(e,r+1,i+1,s)]}compareRowMajor(e){return this.row<e.row?-1:this.row>e.row?1:this.col<e.col?-1:this.col>e.col?1:0}};dH.pool=new Co(dH,null,null,25,50);let Ppt=class extends Mpt{constructor(e,r,i,s,n,o,a=n,l=o){super(),this.triangleCountReportedInDebug=0,this.triangleCount=0,this.texture=null,this.key=new dH(e),this.resolution=r,this.x=i,this.y=s,this.width=n,this.height=o,this.rangeX=a,this.rangeY=l}destroy(){this.texture&&(this.texture.dispose(),this.texture=null)}setTransform(e){const r=this.resolution/(e.resolution*e.pixelRatio),i=this.transforms.tileMat3,[s,n]=e.toScreenNoRotation([0,0],[this.x,this.y]),o=this.width/this.rangeX*r,a=this.height/this.rangeY*r;hY(i,o,0,0,0,a,0,s,n,1),KS(this.transforms.dvs,e.displayViewMat3,i)}},K9=class WSe extends Ppt{constructor(e,r,i,s,n,o,a,l=null){super(e,r,i,s,n,o,4096,4096),this._memCache=l,this.type="vector-tile",this._referenced=0,this._hasSymbolBuckets=!1,this._memoryUsedByLayerData=0,this.layerData=new Map,this.layerCount=0,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.invalidating=!1,this.parentTile=null,this.childrenTiles=new Set,this._processed=!1,this._referenced=1,this.styleRepository=a,this.id=e.id}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<$ae}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<$ae)}get wasRequested(){return this.status==="errored"||this.status==="loaded"||this.status==="reloading"}setData(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this.invalidating=!1,this._processed=!0}deleteLayerData(e){let r=!1;for(const i of e)if(this.layerData.has(i)){const s=this.layerData.get(i);this._memoryUsedByLayerData-=s.memoryUsed,s.type===bc.SYMBOL&&this.symbols.has(i)&&(this.symbols.delete(i),r=!0),s.destroy(),this.layerData.delete(i),this.layerCount--}v(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData),r&&this.emit("symbols-changed"),this.requestRender()}processed(){return this._processed}hasData(){return this.layerCount>0}dispose(){this.status!=="unloaded"&&(XSe.delete(this),WSe._destroyRenderBuckets(this.layerData),this.layerData=null,this.layerCount=0,this._memoryUsedByLayerData=0,this.destroy(),this.status="unloaded")}release(){return--this._referenced==0&&(this.dispose(),this.stage=null,!0)}retain(){++this._referenced}get referenced(){return this._referenced}get memoryUsage(){return(this._memoryUsedByLayerData+256)/(this._referenced||1)}changeDataImpl(e){let r=!1;if(e){const{bucketsWithData:i,emptyBuckets:s}=e,n=this._createRenderBuckets(i);if(s&&s.byteLength>0){const o=new Uint32Array(s);for(const a of o)this._deleteLayerData(a)}for(const[o,a]of n)this._deleteLayerData(o),a.type===bc.SYMBOL&&(this.symbols.set(o,a.symbols),r=!0),this._memoryUsedByLayerData+=a.memoryUsed,this.layerData.set(o,a),this.layerCount++;v(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData)}this._hasSymbolBuckets=!1;for(const[i,s]of this.layerData)s.type===bc.SYMBOL&&(this._hasSymbolBuckets=!0);r&&this.emit("symbols-changed")}attachWithContext(e){this.stage={context:e,trashDisplayObject(r){r.processDetach()},untrashDisplayObject:()=>!1}}setTransform(e){super.setTransform(e);const r=this.resolution/(e.resolution*e.pixelRatio),i=this.width/this.rangeX*r,s=this.height/this.rangeY*r,n=[0,0];e.toScreen(n,[this.x,this.y]);const o=this.transforms.tileUnitsToPixels;dY(o),eF(o,o,n),pY(o,o,Math.PI*e.rotation/180),fY(o,o,[i,s,1])}_createTransforms(){return{dvs:Gl(),tileMat3:Gl(),tileUnitsToPixels:Gl()}}static _destroyRenderBuckets(e){if(!e)return;const r=new Set;e.forEach(i=>{r.has(i)||(i.destroy(),r.add(i))}),e.clear()}_createRenderBuckets(e){const r=new Map,i=new Map;for(const s of e){const n=this._deserializeBucket(s,i);for(const o of n.layerUIDs)r.set(o,n)}return r}_deserializeBucket(e,r){let i=r.get(e);if(i)return i;switch(new Uint32Array(e)[0]){case bc.FILL:i=new Cpt(e,this.styleRepository);break;case bc.LINE:i=new Ept(e,this.styleRepository);break;case bc.SYMBOL:i=new Apt(e,this.styleRepository,this);break;case bc.CIRCLE:i=new Rpt(e,this.styleRepository)}return r.set(e,i),i}_deleteLayerData(e){if(!this.layerData.has(e))return;const r=this.layerData.get(e);this._memoryUsedByLayerData-=r.memoryUsed,r.destroy(),this.layerData.delete(e),this.layerCount--}};const XSe=new Map;function Ipt(){XSe.forEach((t,e)=>{console.log(`
${e.key}:`),t[0].forEach(r=>console.log(r)),console.log("========"),t[1].forEach(r=>console.log(r))})}const Z$t={value:.5,readOnly:!0},$pt={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}};let F2=class{constructor(e=0,r=0){this.min=e,this.max=r,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}},Lpt=class{constructor(e,r){this.data=e,this.safeWidth=.99999999*(e.width-1),this.dx=(e.width-1)/(r[2]-r[0]),this.dy=(e.width-1)/(r[3]-r[1]),this.x0=r[0],this.y1=r[3]}},Dpt=class{constructor(e,r,i){this.type="elevation",this.level=e[0],this.i=e[1],this.j=e[2],this.extent=r,this.samplerData=new Lpt(i,r)}computeMinMaxValue(e,r,i,s){s.min=1/0,s.max=-1/0,s.hasNoDataValues=!1;const n=e-this.level;if(n<=0)return s;const o=2**n;if(!(Math.floor(r/o)===this.i&&Math.floor(i/o)===this.j))return s;let a=1/0,l=-1/0;const c=this.samplerData.data.width,h=this.samplerData.data.values,p=.5*oO;let f=(c-1)/o,m=(i-this.j*o)*f,y=(r-this.i*o)*f;if(f<1){const _=Math.floor(m),b=Math.floor(y),x=_+b*c,T=h[x],S=h[x+1],E=h[x+c],O=h[x+c+1];if(T+S+E+O<p){const R=m-_,L=y-b,P=pP(T,S,E,O,R,L),U=pP(T,S,E,O,R+f,L),B=pP(T,S,E,O,R,L+f),z=pP(T,S,E,O,R+f,L+f);return s.min=Math.min(P,U,B,z),s.max=Math.max(P,U,B,z),s}m=_,y=b,f=1}else m=Math.floor(m),y=Math.floor(y),f=Math.ceil(f);for(let _=m;_<=m+f;_++)for(let b=y;b<=y+f;b++){const x=h[_+b*c];x<p?(a=Math.min(a,x),l=Math.max(l,x)):s.hasNoDataValues=!0}return s.min=a,s.max=l,s}};const Npt=.5*oO;function zi(t,e,r){if(C(r))return null;for(const i of r){if(!i)continue;const s=i.safeWidth;let n=ge(i.dy*(i.y1-e),0,s),o=ge(i.dx*(t-i.x0),0,s);const a=Math.floor(n),l=Math.floor(o),c=i.data.width,h=a*c+l,p=i.data.values,f=p[h],m=p[h+1],y=h+c,_=p[y],b=p[y+1];if(f+_+m+b<Npt){n-=a,o-=l;const x=f+(m-f)*o;return x+(_+(b-_)*o-x)*n}}return null}let dh=class extends Te{constructor(e){super(e),this._handles=new ei}initialize(){this._handles.add([this.layerViews.on("change",()=>this.notifyChange("stencilEnabledExtents"))])}destroy(){this._handles=ke(this._handles)}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach(r=>{const i=r.layer;if(i.operationalLayerType==="IntegratedMeshLayer"&&this.viewSpatialReference!=null){const s=YSe(i.fullExtent,this.viewSpatialReference);v(s)&&e.push(cpe(s))}}),e}};function Fpt(t,e){return t===Be.Global?new pH(e):new fH(e)}u([d({readOnly:!0})],dh.prototype,"layerViewsExtent",null),u([d({readOnly:!0})],dh.prototype,"tiledLayersExtent",null),u([d({readOnly:!0})],dh.prototype,"stencilEnabledExtents",null),u([d()],dh.prototype,"viewSpatialReference",void 0),u([d()],dh.prototype,"tilingScheme",void 0),u([d()],dh.prototype,"defaultTiledLayersExtent",void 0),u([d({constructOnly:!0})],dh.prototype,"layers",void 0),u([d({constructOnly:!0})],dh.prototype,"layerViews",void 0),dh=u([I("esri.views.3d.terrain.ExtentHelper")],dh);let pH=class extends dh{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?hve:uHe}};pH=u([I("esri.views.3d.terrain.ExtentHelperGlobal")],pH);let fH=class extends dh{_computeLayerViewsExtent(){const e=zh(),r=this.viewSpatialReference;this.layerViews.forEach(n=>{const o=n.layer;if(n.isResolved()&&(o.type!=="graphics"||!o.internal)){const a=YSe("fullExtentInLocalViewSpatialReference"in n&&n.fullExtentInLocalViewSpatialReference||n.layer.fullExtent,r);L_(e,a,e)}});const i=nB(e)?e:null,s=this._get("layerViewsExtent");return qb(i,s)?s:i}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const r=this.viewSpatialReference,i=zh();this.layers.forEach(o=>{if(o.loaded&&B3(o)){const a=c6(o,r,Be.Local);if(C(a))return;const{tileInfo:l,fullExtent:c}=a;v(l)&&v(c)&&(BF(o)||e.compatibleWith(l)&&c.spatialReference.equals(e.spatialReference))&&L_(i,c,i)}}),L_(i,this.defaultTiledLayersExtent,i);const s=nB(i)?i:null,n=this._get("tiledLayersExtent");return qb(s,n)?n:s}};function YSe(t,e){return v(t)&&!t.spatialReference.equals(e)?ffe(t,t.spatialReference,e):t}fH=u([I("esri.views.3d.terrain.ExtentHelperLocal")],fH);var dr;(function(t){t[t.ELEVATION=0]="ELEVATION",t[t.MAP=1]="MAP"})(dr||(dr={}));const ab=[dr.ELEVATION,dr.MAP];function ZSe(){var e;const t=(e=globalThis.require)==null?void 0:e.modules;if(t){const r=Object.keys(t);for(const i of r)i.search(".glsl")!==-1&&delete t[i]}}const Upt=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let o0,Rl=class extends Te{get running(){return this._placementDirty&&(this._drapeSources.size>0||this._view.graphics.length>0||qr.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this._view.state.isGlobal}get _worldToPCSRatio(){return v(this._spatialReference)&&this._spatialReference.isGeographic&&!this._view.state.isLocal?Jr(this._spatialReference).metersPerDegree:1}get _view(){return this.surface.view}get suspended(){return this.surface.suspended}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get hasHighlights(){return this.renderer.hasHighlights}get rendersOccluded(){return this.renderer.rendersOccluded}constructor(e){super(e),this._handles=new ei,this._spatialReference=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._hasUnusedRenderTargets=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=de("esri-mobile")?2048:4096,this._animationTimeLast=0}initialize(){var r;const e=this._view;this.renderer=new Od({view:e,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference}),this._groundIntersector=Wh(this._view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this._handles.add([this.renderer.events.on("has-highlights",()=>{this.setDrawTexturesDirty(),this.notifyChange("hasHighlights")}),this.renderer.events.on("has-water",i=>{var s;return(s=e._stage)==null?void 0:s.renderer.setParameters({hasOverlayWater:i})}),this.renderer.events.on("renders-occluded",()=>{this.setDrawTexturesDirty(),this.notifyChange("rendersOccluded")}),this.renderer.events.on("content-changed",()=>this.setDrawTexturesDirty()),this.renderer.events.on("textures-disposed",()=>this.updateOverlayResult()),ie(()=>{var i,s,n;return[(i=e.pointsOfInterest)==null?void 0:i.renderPointOfView,(n=(s=e.pointsOfInterest)==null?void 0:s.centerOnSurfaceFrequent)==null?void 0:n.location]},()=>this.setPlacementDirty()),ie(()=>{var i,s;return[(i=e.state)==null?void 0:i.pixelRatio,(s=e.state)==null?void 0:s.contentPixelRatio]},()=>this.setPlacementDirty(),ri),this.surface.on("elevation-change",()=>this.setPlacementDirty()),e.on("resize",()=>this.setPlacementDirty()),e.resourceController.scheduler.registerTask(_t.OVERLAY,this),e._stage.renderView.events.on("force-camera-for-screenshot",i=>{this._updateOverlays(Xa,i,Ps.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlayTextures(this.renderer.overlays,Ps.BACKGROUND,i.pixelRatio)})]),(r=e._stage)==null||r.renderer.setParameters({renderOverlay:i=>{this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.hasOverlays&&(this._dispatchAnimationUpdate(i),this._drawOverlayTextures(this.renderer.overlays,Ps.UPDATE)),this._hasUnusedRenderTargets&&this._collectUnusedRenderTargetMemory()}})}destroy(){this._handles=ke(this._handles),v(o0)&&(o0.hide(),o0=null)}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;const r=this._view.renderSpatialReference;v(e)&&v(r)?(this._renderSR=r,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new W_(-20037508342787e-6,20037508342787e-6):new W_(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()}get gpuMemoryUsage(){return this.renderer.gpuMemoryUsage}registerDrapeSource(e,r,i){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const s=this.renderer.createDrapeSourceRenderer(e,r,i);return this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running"),s}registerGeometryDrapeSource(e){return this.registerDrapeSource(e,nu)}_updateDrapeSourceExtent(e){this.renderer.overlays.length===2&&v(e.setDrapingExtent)&&v(this._spatialReference)&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}registerDrapeTarget(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}updateOverlayResult(){var e;(e=this._view._stage)==null||e.renderer.setParameters({overlays:this.renderer.overlays})}unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.setDrawTexturesDirty()}setPlacementDirty(){this._placementDirty=!0}runTask(e){return this._updateOverlays(e,this._view.state.contentCamera,Ps.UPDATE)}_updateOverlays(e,r,i){if(!this._spatialReference)return Zo.YIELD;const s=this._computeOverlayResolution(r);this._computeOverlayExtents(r,s,jm);const n=xu(jm.inner)/xu(jm.outer);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const o=this._updateOverlay(Ki.INNER,jm.inner,s,1*jm.pixelRatioAdjustment,jm.mapUnitsPerPixel),a=this._updateOverlay(Ki.OUTER,jm.outer,s,n*jm.pixelRatioAdjustment,jm.mapUnitsPerPixel);o!==Cf.EXTENT&&a!==Cf.EXTENT||(this._drapeSources.forEach(l=>this._updateDrapeSourceExtent(l)),this.surface.updateTileOverlayParams(i)),o===Cf.NONE&&a===Cf.NONE||this.setDrawTexturesDirty(),this._placementDirty=!1,e.madeProgress()}_computeOverlayResolution(e){const r=this._view.state.contentPixelRatio,i=e.fullWidth/e.pixelRatio*r,s=e.fullHeight/e.pixelRatio*r;return Math.min(ES(Math.max(i,s)+256),this._maxResolution)}_updateOverlay(e,r,i,s,n){if(this.renderer.overlays.length===0)return Cf.NONE;const o=this.renderer.overlays[e],a=o.mapUnitsPerPixel;if(o.mapUnitsPerPixel=n,o.pixelRatio=s,kpt(r,o.extent)&&i===o.resolution)return a===n?Cf.NONE:Cf.RERENDER_ONLY;Kg(o.extent,r),o.resolution=i;const l=rW(o.extent);return o.renderLocalOrigin=bR(l[0],l[1],0,"OV_"+this._latestOriginId++),Cf.EXTENT}setTileParameters(e){const r=e.renderData.overlay;if(this.renderer.overlays.length>0){const i=this.renderer.overlays[Ki.INNER],s=this.renderer.overlays[Ki.OUTER],n=e.extent;this._rectInsideRect(i.extent,n)||this._rectanglesOverlap(n,i.extent)||this._rectanglesOverlap(n,s.extent)?(this._setTileOverlayData(n,Ki.INNER,r),this._setTileOverlayData(n,Ki.OUTER,r)):(this._clearTileOverlayData(Ki.INNER,r),this._clearTileOverlayData(Ki.OUTER,r))}else this._clearTileOverlayData(Ki.INNER,r),this._clearTileOverlayData(Ki.OUTER,r)}overlayPixelSizeInMapUnits(e){if(this.renderer.overlays.length===0)return 0;const r=this.renderer.overlays[Ki.INNER],i=this.renderer.overlays[Ki.OUTER],s=this._pointIsInExtent(e,r.extent)?r:i;return(s.extent[2]-s.extent[0])/s.resolution}_setTileOverlayData(e,r,i){if(this.renderer.overlays.length===0)return;const s=this.renderer.overlays[r].extent,n=xu(s),o=fp(s);let a=e[0];if(this._longitudeCyclical){a=this._longitudeCyclical.minimalMonotonic(s[0],a);const l=this._longitudeCyclical.minimalMonotonic(s[0],e[2]);a>l&&(a=l-(e[2]-e[0]))}i.setScale(r,xu(e)/n,fp(e)/o),i.setOffset(r,(a-s[0])/n,(e[1]-s[1])/o)}_clearTileOverlayData(e,r){r.setScale(e,-1,-1),r.setOffset(e,-1,-1)}async reloadShaders(){ZSe(),await this.renderer.reloadShaders(),this.setDrawTexturesDirty(),this.runTask(Xa)}_dispatchAnimationUpdate(e){const r=e-this._animationTimeLast;if(r>=this.surface.view._stage.renderer.animationTimestep||v(this._view.state.forcedAnimationTime)||this._drawTexturesDirty||this._drawTexturesAnimateDirty){const i=r/this.surface.view._stage.renderer.animationTimeDilation,s=new rxe(this._view.state.camera,i,this._view.state.forcedAnimationTime);this.renderer.updateAnimation(s)&&(this._drawTexturesAnimateDirty=!0),this._animationTimeLast=e}}setDrawTexturesDirty(){this.renderer.hasOverlays?(this._contentUpdated=!0,this._drawTexturesDirty=!0,this._view._stage.renderView.requestRender()):this.setPlacementDirty()}_intersectGroundFromView(e,r,i,s){const n=this._view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,zpt,r,i);if(C(n))return!1;const o=n.origin,a=fe(g$,n.origin,n.direction);return this._groundIntersector.reset(o,a,e),this._groundIntersector.intersect([]),this._view.basemapTerrain.intersect(this._groundIntersector,null,o,a),this._groundIntersector.results.min.getIntersectionPoint(s)}_findHorizonBasedPointOfInterest(e,r){let i=.5;const s=.55,n=this._view.renderCoordsHelper.getAltitude(e.eye),o=this._view.pointsOfInterest.centerOnSurfaceFrequent,a=1e-5,l=ge(o.estimatedSurfaceAltitude,e.aboveGround?-1/0:n+a,e.aboveGround?n-a:1/0),c=e.aboveGround;if(this._view.viewingMode==="global"){const h=g$;OE(U4(k4,Jr(this._view.spatialReference).radius+l),Du(e.eye,e.viewForward),h),me(h,h,e.eye);const p=X_.normalize(rme(e.viewForward,h,e.viewRight))/e.fovY+.5,f=p<=0||p>=1?.5:s;i=c?f*p:p+f*(1-p)}else{const h=.5*Math.PI-Math.acos(-e.viewForward[2]),p=Math.tan(h),f=Ht(0,p,1,0),m=Su(f,f,e.projectionMatrix)[1],y=ge(.5+.5*m,0,1);i=y===1||y===0?.5:c?y*s:1-(1-y)*s}return!!this._intersectGroundFromView(e,.5,i,r)&&Pq(r,e.eye)<o.distance*o.distance}_computeOverlayExtents(e,r,i){const s=this._view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,n=M();this._findHorizonBasedPointOfInterest(e,n)||le(n,s);const o=Math.max(.1,xi(e.eye,n)),a=ov(this._view.renderCoordsHelper,s,e.eye),l=Math.PI/2-Math.abs(a-Math.PI/2);qr.OVERLAY_SHOW_CENTER?(C(o0)&&(o0=new c2(this._view.graphics,"red")),o0.show(n,this._renderSR)):v(o0)&&o0.hide(),this._overlaySREqualsRenderSR||no(n,this._renderSR,n,this._spatialReference);const c=this.surface.extent,h=!this._isSpherical&&v(this._spatialReference)&&this._spatialReference.isGeographic,p=h&&v(this._spatialReference)?1/Jr(this._spatialReference).metersPerDegree:1,f=this._view.state.contentPixelRatio,m=e.perScreenPixelRatio/f*o*p;i.mapUnitsPerPixel=m/this._worldToPCSRatio;let y=r*m/2,_=!1,b=h?90:1/0;this._isSpherical&&v(c)&&v(this._spatialReference)&&(this._spatialReference.isWebMercator?(y/=Math.cos(tN(n[1])),b=c[3]):(_=!0,y/=Jr(this._spatialReference).metersPerDegree,b=90),y>=b&&(y=b,n[1]=0,this._spatialReference.isWebMercator&&(n[0]=0)));let x=1;_&&(x=1/Math.max(.2,Math.cos(Math.abs(Gt(n[1])))),y*x>180&&(x=180/y),i.mapUnitsPerPixel*=x);const T=Math.log(2)/12;y=Math.exp(Math.round(Math.log(y)/T)*T);const S=y*x,E=32,O=.5*r/(E*S),R=.5*r/(E*y);n[0]=Math.round(n[0]*O)/O,n[1]=Math.round(n[1]*R)/R;const L=i.inner;L[0]=n[0]-S,L[1]=n[1]-y,L[2]=n[0]+S,L[3]=n[1]+y,this._isSpherical&&this._shiftExtentToFitBounds(L,1/0,b);const P=i.outer;if(6*S>xu(c))Kg(P,c);else if(l<=.25*Math.PI)P[0]=L[0]-S,P[1]=L[1]-y,P[2]=L[2]+S,P[3]=L[3]+y;else{no(e.eye,this._renderSR,g$,this._spatialReference),If(a1,n,g$);let B=-Math.atan2(a1[1],a1[0])+.125*Math.PI;B<0&&(B+=2*Math.PI);const z=Math.floor(B/(.25*Math.PI));_E(a1,Upt[z],2*y),a1[0]*=x,a1[2]*=x,Iq(P,L,a1)}if(this._isSpherical)P[0]=this._longitudeCyclical.clamp(P[0]),P[2]=this._longitudeCyclical.clamp(P[2]),P[1]=Math.max(P[1],-b),P[3]=Math.min(P[3],b);else{const B=oB(L,c,Vpt),z=oB(P,c,Bpt);BK(B,z)&&(P[2]=P[0],P[3]=P[1])}const U=Math.abs(L[2]-L[0])/r;i.mapUnitsPerPixel=Math.max(i.mapUnitsPerPixel,U),i.pixelRatioAdjustment=i.mapUnitsPerPixel/U}_drawOverlayTextures(e,r,i=this._view.state.contentPixelRatio){if(e.length===0||!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return;const s=this._drawTexturesDirty;this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1;const n=this._drawOverlay(e[Ki.INNER],i),o=this._drawOverlay(e[Ki.OUTER],i);n!==JS.CHANGED&&o!==JS.CHANGED||this.surface.updateTileOverlayParams(Ps.UPDATE),this._collectUnusedRenderTargetMemory(),this.updateOverlayResult(),s?(this.surface.requestRender(r),r===Ps.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(Ps.BACKGROUND)}_drawOverlay(e,r){return this._longitudeCyclical?e.setupGeometryViewsCyclical(this._longitudeCyclical):e.setupGeometryViewsDirect(),e.draw(this.renderer,r)}_collectUnusedRenderTargetMemory(){if(this._hasUnusedRenderTargets=!1,this.renderer.hasOverlays){const e=performance.now();this._hasUnusedRenderTargets=this.renderer.collectUnusedRenderTargetMemory(e)}}_rectanglesOverlap(e,r){return!C(e)&&(this._longitudeCyclical?(this._longitudeCyclical.contains(r[0],r[2],e[0])||this._longitudeCyclical.contains(r[0],r[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],r[0]))&&!(e[1]>r[3]||e[3]<r[1]):x4(e,r))}_rectInsideRect(e,r){return!C(r)&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],r[0])&&this._longitudeCyclical.contains(e[0],e[2],r[2])&&r[1]>e[1]&&r[3]<e[3]:BK(e,r))}_pointIsInExtent(e,r){if(this._longitudeCyclical)return this._longitudeCyclical.contains(r[0],r[2],e.x)&&e.y>=r[1]&&e.y<=r[3];const i=e.x,s=e.y;return i>r[0]&&i<r[2]&&s>r[1]&&s<r[3]}_shiftExtentToFitBounds(e,r,i){let s=0,n=0;e[0]<-r?s=e[0]+r:e[2]>r&&(s=r-e[2]),e[1]<-i?n=e[1]+i:e[3]>i&&(n=i-e[3]),pN(e,s,n)}get test(){return{renderer:this.renderer,update:()=>this.runTask(Xa)}}};function kpt(t,e){const i=qr.TESTS_DISABLE_OPTIMIZATIONS?0:1e-5*Math.max(t[2]-t[0],t[3]-t[1],e[2]-e[0],e[3]-e[1]);return Math.abs(e[0]-t[0])<=i&&Math.abs(e[1]-t[1])<=i&&Math.abs(e[2]-t[2])<=i&&Math.abs(e[3]-t[3])<=i}u([d()],Rl.prototype,"_spatialReference",void 0),u([d({readOnly:!0})],Rl.prototype,"running",null),u([d()],Rl.prototype,"_placementDirty",void 0),u([d()],Rl.prototype,"_contentUpdated",void 0),u([d()],Rl.prototype,"_isSpherical",null),u([d()],Rl.prototype,"_worldToPCSRatio",null),u([d({autoDestroy:!0})],Rl.prototype,"renderer",void 0),u([d({constructOnly:!0})],Rl.prototype,"surface",void 0),u([d()],Rl.prototype,"suspended",null),u([d()],Rl.prototype,"updating",null),u([d({type:Boolean})],Rl.prototype,"hasHighlights",null),u([d({type:Boolean})],Rl.prototype,"rendersOccluded",null),Rl=u([I("esri.views.3d.terrain.OverlayManager")],Rl);const a1=sr(),g$=M(),jm={inner:ur(),outer:ur(),mapUnitsPerPixel:0,pixelRatioAdjustment:1},Vpt=ur(),Bpt=ur(),zpt=ro();var Cf;(function(t){t[t.NONE=0]="NONE",t[t.EXTENT=1]="EXTENT",t[t.RERENDER_ONLY=2]="RERENDER_ONLY"})(Cf||(Cf={}));let JSe=class mH{constructor(e,r){this._factoryCallback=e,this._lengthCallback=r,this._pool=new Map}acquire(e){if(!mH.test.disabled){const r=this._pool.get(e);if(r&&r.length!==0)return r.pop()}try{return this._factoryCallback(e)}catch(r){const i=window.performance&&window.performance.memory;let s="";throw i&&(s=`
  totalJSHeapSize: ${i.totalJSHeapSize}, usedJSHeapSize: ${i.usedJSHeapSize}, jsHeapSizeLimit: ${i.jsHeapSizeLimit}`),console.log("Array allocation of size "+e+" failed: "+r+s),r}}release(e){if(mH.test.disabled)return;const r=this._lengthCallback(e);let i=this._pool.get(r);i||(i=new Jt({shrink:!0}),this._pool.set(r,i)),i.push(e)}clear(){this._pool.clear()}get test(){return{size:this._pool.size}}};JSe.test={disabled:!1};let Gpt=class{constructor(){this.indices=null,this.vertexAttributes=null,this.boundingBox=Ri(),this.indexCount=0,this.numVerticesPerSide=0,this.uvRange=[0,0,1,1],this.outerEdges=[null,null,null,null],this.innerEdges=[null,null,null,null]}},Lae=class{constructor(e,r,i,s,n){this.attributes=e,this.localOrigin=r,this.index0=i,this.stride=s,this.count=n}getVertexIndex(e){return this.getAttributeIndex(e)}getAttributeIndex(e){return Re(0<=e&&e<this.count),this.index0+this.stride*e}_getVertexRaw(e,r){this.attributes.position.getVec(e,r)}_getNormalRaw(e,r){this.attributes.normalCompressed.getVec(e,r)}getVertexPos(e,r){this._getVertexRaw(this.getAttributeIndex(r),e),fe(e,e,this.localOrigin)}getNormal(e,r){const i=Je();this._getNormalRaw(this.getAttributeIndex(r),i),Wpt(e,i)}_setNormal(e,r,i,s){NO(this.attributes.normalCompressed,e,r,i,s)}_setUV(e,r,i){Lc(this.attributes.uv0,e,r,i)}setNormalFromValues(e,r,i,s){this._setNormal(this.getAttributeIndex(e),r,i,s)}setVertexFromValuesRawPositionUV(e,r,i,s,n,o){const a=this.getAttributeIndex(e);this.attributes.position.setValues(a,r,i,s),this._setUV(a,n,o)}setVertexFromValuesRawPositionUVNormal(e,r,i,s,n,o,a,l,c){const h=this.getAttributeIndex(e);this.attributes.position.setValues(h,r,i,s),this._setUV(h,n,o),this._setNormal(h,a,l,c)}};const jpt=ts().vec3f(A.POSITION).vec2i16(A.UV0).vec2i16(A.NORMALCOMPRESSED,{glNormalized:!0}),lJ=new JSe(t=>jpt.createBuffer(t),t=>t.count);function Hpt(){lJ.clear()}function KSe(t){return lJ.acquire(t)}function qpt(t){lJ.release(t.vertexAttributes),t.vertexAttributes=null,t.indices=null}function NO(t,e,r,i,s){const n=1/(Math.abs(r)+Math.abs(i)+Math.abs(s)),o=r*n,a=i*n,l=s<=0?(o>=0?1:-1)*(1-Math.abs(a)):o,c=s<=0?(a>=0?1:-1)*(1-Math.abs(o)):a;t.setValues(e,Nae(l),Nae(c))}function Wpt(t,e){const r=Fae(e[0]),i=Fae(e[1]),s=1-Math.abs(r)-Math.abs(i);t[2]=s,s<0?(t[0]=(r>=0?1:-1)*(1-Math.abs(i)),t[1]=(i>=0?1:-1)*(1-Math.abs(r))):(t[0]=r,t[1]=i),_e(t,t)}const Dae=16384;function Lc(t,e,r,i){t.setValues(e,r*Dae,i*Dae)}function Nae(t){return ge(Math.round(32767*t),-32767,32767)}function Fae(t){return ge(t/32767,-1,1)}function Ka(t,e,r,i){t<i[0]?i[0]=t:t>i[3]&&(i[3]=t),e<i[1]?i[1]=e:e>i[4]&&(i[4]=e),r<i[2]?i[2]=r:r>i[5]&&(i[5]=r)}let Xpt=class{constructor(){this.sinLonLUT=new Array(t3+1),this.cosLonLUT=new Array(t3+1),this.sinLatLUT=new Array(t3+1),this.cosLatLUT=new Array(t3+1)}update(e,r,i){const s=r[0],n=r[2];for(let o=0;o<=e;o++){const a=o/e,l=s*(1-a)+n*a;this.sinLonLUT[o]=Math.sin(l),this.cosLonLUT[o]=Math.cos(l);const c=i(a);this.sinLatLUT[o]=Math.sin(c),this.cosLatLUT[o]=Math.cos(c)}}},y$=class{constructor(){this.cornerTiles=[null,null,null,null],this.cornerTileSamplerVersions=[-1,-1,-1,-1]}},Ypt=class{constructor(){this.cornerNeighborData=[new y$,new y$,new y$,new y$],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1],this.cornerPeerNeighbors=[null,null,null,null]}},Zpt=class{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.clippingArea=null,this.wireframe=!1,this.shading=!1,this.samplerDataVersion=0,this.neighborData=new Ypt}},QSe=class xD{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=ke(this._current),this._next=ke(this._next),this._waiting=ke(this._waiting),this._delayed=ke(this._delayed)}get current(){if(C(this._current))return null;if(!this._isFadingEnabled){const r=this._delayed||this._waiting||this._next||this._current;r!==this._current&&(this._current=null,this.clear(),this._current=r)}let e=xD.test.fadeMoment;if(v(this._delayed)&&(e=e||performance.now(),e>=this._delayedTime&&(this._push(this._delayed,Hg.Immediate),this._delayed=null)),v(this._next)){e=e||performance.now();const r=this._fadeDuration,i=v(this._current)&&this._next.texture===this._current.texture,s=this._next.type!==yn.FADING,n=e-this._fadeStart>=r;(i||s||n)&&(ke(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(e))}return this._current}get next(){return this._next}get fadeFactor(){if(C(this._next))return 1;const e=xD.test.fadeMoment||performance.now(),r=Math.max(0,e-this._fadeStart),i=this._fadeDuration;return r>i?0:1-r/i}get isFading(){return v(this._next)||v(this._delayed)}push(e,r=Hg.Immediate){this._delayed=ke(this._delayed),this._push(e,r)}_push(e,r){if(this._isFadingEnabled||this.clear(),C(this._current))return void(this._current=e);const i=xD.test.fadeMoment||performance.now();return r!==Hg.Immediate?(this._delayed=e,void(this._delayedTime=i+r)):C(this._next)?(this._next=e,void(this._fadeStart=this._alignFadeStart(i))):void(C(e)||(ke(this._waiting),this._waiting=e))}get _fadeDuration(){return C(this._waiting)?this._getFadeDuration():.5*this._getFadeDuration()}_alignFadeStart(e){const r=this._getFadeDuration();return e+r-e%r}get _isFadingEnabled(){return this._getFadeDuration()>0}};var Hg;QSe.test={fadeMoment:0},function(t){t[t.Immediate=0]="Immediate",t[t.Delayed=5e3]="Delayed"}(Hg||(Hg={}));var dE;(function(t){t[t.BACK_TO_FRONT=-1]="BACK_TO_FRONT",t[t.NONE=0]="NONE",t[t.FRONT_TO_BACK=1]="FRONT_TO_BACK"})(dE||(dE={}));let eEe=class{constructor(){this._queue=new Jt,this.remove=()=>{}}get done(){return this._queue.length===0&&(!this._last||this._last.isLeaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=void 0}reset(e=null){this._queue.clear(),v(e)&&this._queue.pushArray(e),this._last=void 0}skipSubtree(){this._last=void 0}next(){var r;const e=(r=this._last)==null?void 0:r.children;return e&&e[0]&&this._queue.pushArray(e),this._last=this._queue.pop(),this._last}},Jpt=class{constructor(){this._q=new Jt}get done(){return this._q.length===0}reset(e){if(this._q.clear(),!C(e)){this._q.pushArray(e);for(let r=0;r<this._q.length;++r){const i=this._q.data[r];i.isLeaf||this._q.pushArray(i.children)}}}next(){return this._q.pop()}};function AR(t,e,r){if(C(e)||C(e.fullExtent))return!1;const i=e.fullExtent,s=t.extent;if(r){if(s[0]<i.xmin||s[1]<i.ymin||s[2]>i.xmax||s[3]>i.ymax)return!1}else if(i.xmin>s[2]||i.ymin>s[3]||i.xmax<s[0]||i.ymax<s[1])return!1;const n=t.surface.tilingScheme.levels[t.level].scale,o=e.minScale;if(o>0&&n>1.00000001*o)return!1;const a=e.maxScale;return!(a>0&&n<.99999999*a)}function qg(t,e){const r=t.lij,i=e.lij;return r[0]-i[0]||r[1]-i[1]||r[2]-i[2]}function tEe(t,e,r=null){C(r)||r.length===0?t===dE.BACK_TO_FRONT?e.sort(Kpt):e.sort(Qpt):e.sort((i,s)=>eft(i,s,t,r))}function Kpt(t,e){const r=e.screenDepth-t.screenDepth;if(r!==0)return r;const i=t.lij,s=e.lij;return i[0]-s[0]||i[1]-s[1]||i[2]-s[2]}function Qpt(t,e){const r=t.screenDepth-e.screenDepth;if(r!==0)return r;const i=t.lij,s=e.lij;return i[0]-s[0]||i[1]-s[1]||i[2]-s[2]}function rEe(t,e,r){const i=t.screenDepth,s=e.screenDepth;return i<s?-r:i>s?r:qg(t,e)}function eft(t,e,r,i){return Uae(t,i)===Uae(e,i)?rEe(t,e,r):t?r:-r}function Uae(t,e){for(const r of e)if(t.intersectsExtent(r))return!0;return!1}function tft(t,e){const r=t.distanceToPOI-e.distanceToPOI;if(r!==0)return r;const i=t.lij,s=e.lij;return i[0]-s[0]||i[1]-s[1]||i[2]-s[2]}function rft(t,e){const r=t.length;for(let i=0;i<r;++i)t.getItemAt(i).updateDistanceToPOI(e);t.sort(tft)}function ift(t,e,r){let i=1,s=0,n=0;for(;t!==e;)if(i*=.5,s*=.5,n*=.5,1&t.lij[2]&&(s+=.5),!(1&t.lij[1])&&(n+=.5),(t=t.parent)==null)throw new Error("tile was not a descendant of upsampleTile");r.init(e,s,n,i)}function sft(t){for(let e=0;e<t.length;e++){const r=t[e],i=r.parent;if(i)for(let s=0;s<4;s++){const n=i.children[s];if(n&&n!==r)return!0}}return!1}function dLt(t,e){if(!t||!e||t[0]===e[0])return!1;const r=t[0]<e[0],i=r?t:e,s=r?e:t,n=1<<s[0]-i[0];return Math.floor(s[1]/n)===i[1]&&Math.floor(s[2]/n)===i[2]}let cJ=class{get updating(){return!!this._tileRequested}init(e,r,i,s){this.tile=e,this._layerIdx=r,this._layerClass=i,this._suspended=s,this._tileLayerInfo=e.getLayerInfo(r,i),this._tileRequested=null;const n=this._findAncestorWithData();this._setUpsampleTile(n)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e){this._setUpsampleTile(e),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,yn.FADING):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return v(e)?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,r=this._layerClass,i=this.tile.surface.layerViewByIndex(e,r),s=lH(i),{minLevel:n,maxLevel:o}=i.dataLevelRange,a=this._desiredMinLevelDelta,l=this._progressiveLevelModulo+a,c=this._scaleRangeEnabled?AR:()=>!0;let h=this.tile;const p=h.level;let f;const m=this._tileLayerInfo.upsampleInfo,y=v(m)?m.tile.level:-1,_=!!v(m)&&y-p>=a,b=Dn(s,"tilemapCache");for(;h&&c(h,s,!1)&&h.level>=n;){const x=h.level,T=p-x,S=h.layerInfo[r][e];if(S.data&&T>=a){(!_||x>y)&&this._setUpsampleTile(h),S.dataInvalidated&&(f=h);break}if((C(b)||b.getAvailability(h.lij[0],h.lij[1],h.lij[2])!=="unavailable")&&x<=o&&!S.data&&!S.dataMissing&&((C(f)||h.level===n||x%uve==0||p-f.level<a)&&(f=h),T>=l))break;h=h.parent}return v(f)&&p-f.level<a&&this._tileLayerInfo.upsampleInfo&&(f=null),f}_findAncestorWithData(){const e=this.tile.vlevel,r=this._desiredMinLevelDelta;let i;for(let s=this.tile;s;s=s.parent)if(s.hasLayerData(this._layerIdx,this._layerClass)){if(e-s.level>=r)return s;i=s}return i}_setUpsampleTile(e){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,yn.FADING)}get test(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}},nft=class extends cJ{get _desiredMinLevelDelta(){throw kae}get _progressiveLevelModulo(){throw kae}dispose(){}};const kae=new Error("Abstract method called on TileAgent"),ec=new nft;let iEe=class extends cJ{constructor(){super(...arguments),this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return rG(this.tile.level)-(this.tile.vlevel-this.tile.level)}get _progressiveLevelModulo(){return 0}},sEe=class extends cJ{constructor(){super(),this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return uve}};var iw,kw;(function(t){t[t.Stretch=0]="Stretch",t[t.Lut=1]="Lut",t[t.Hillshade=2]="Hillshade",t[t.COUNT=3]="COUNT"})(iw||(iw={})),function(t){t[t.Noop=0]="Noop",t[t.PerBand=1]="PerBand",t[t.COUNT=2]="COUNT"}(kw||(kw={}));function oft(t,e){t.fragment.uniforms.add([new Mt("u_colormap",r=>r.u_colormap),new Pe("u_colormapOffset",r=>r.colormap.u_colormapOffset),new Pe("u_colormapMaxIndex",r=>r.colormap.u_colormapMaxIndex),new Pe("u_opacity",r=>r.common.u_opacity)]),t.fragment.code.add(w`
    vec4 colormap(vec4 currentPixel, bool isFloat) {
      float colorIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
      vec4 result;
      // handle no data and out of range pixels
      if (currentPixel.a == 0.0 || colorIndex > u_colormapMaxIndex) {
        result = vec4(0.0, 0.0, 0.0, 0.0);
      } else {
        // colormap lookup
        vec2 texelCoordinates = vec2((colorIndex + 0.5), 0.5);
        result = ${Ja(e,"u_colormap","texelCoordinates","(1.0 / vec2(u_colormapMaxIndex + 1.0, 1.0))")};
      }
      return result;
    }
  `)}function aft(t,e){t.fragment.uniforms.add(op("u_transformGrid",r=>r.u_transformGrid,e.hasWebGL2Context?Qr.None:Qr.InvSize)),t.fragment.uniforms.add(new kr("u_transformSpacing",r=>r.common.u_transformSpacing)),t.fragment.uniforms.add(new kr("u_targetImageSize",r=>r.common.u_targetImageSize)),t.fragment.code.add(w`
    vec2 projectPixelLocation(vec2 coords) {
      // Pixel index in row/column, corresponds to upperleft corner, e.g. [100, 20]
      vec2 index_image = floor(coords * u_targetImageSize);

      // Pixel's corresponding cell index in transform grid
      // Each transform cell corresponds to 4 pixels: 6 coefficients from lowerleft triangle followed by 6 coefficients from upperright triangle
      vec2 oneTransformPixel = vec2(4.0, 1.0);
      vec2 index_transform = floor(index_image / u_transformSpacing) * oneTransformPixel;

      // Correspoding position in transform grid cell, cell center coordinates
      vec2 pos = fract((index_image + 0.5) / u_transformSpacing);

      // Pixel's corresponding transform cell location, cell center coordinates
      vec2 transform_location = index_transform + 0.5;

      vec2 srcLocation;

      // Use lower triangle or upper triangle
      if (pos.s <= pos.t) {
        vec3 ll_abc = ${Ja(e,"u_transformGrid","transform_location")}.rgb;
        vec3 ll_def = ${Ja(e,"u_transformGrid","vec2(transform_location.s + 1.0, transform_location.t)")}.rgb;
        srcLocation.s = dot(ll_abc, vec3(pos, 1.0));
        srcLocation.t = dot(ll_def, vec3(pos, 1.0));
      } else {
        vec3 ur_abc = ${Ja(e,"u_transformGrid","vec2(transform_location.s + 2.0, transform_location.t)")}.rgb;
        vec3 ur_def = ${Ja(e,"u_transformGrid","vec2(transform_location.s + 3.0, transform_location.t)")}.rgb;
        srcLocation.s = dot(ur_abc, vec3(pos, 1.0));
        srcLocation.t = dot(ur_def, vec3(pos, 1.0));
      }

      return srcLocation;
    }
  `)}let nEe=class extends pi{constructor(){super(...arguments),this.scale=1,this.offset=Wl}};function oEe(t){t.attributes.add(A.POSITION,"vec2"),t.attributes.add(A.UV0,"vec2"),t.vertex.uniforms.add(new Pe("scale",e=>e.scale)),t.vertex.uniforms.add(new kr("offset",e=>e.offset)),t.varyings.add("uv","vec2"),t.varyings.add("vuv","vec2"),t.vertex.code.add(w`void main(void) {
gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
vuv = uv0;
}`)}let lft=class extends nEe{constructor(e,r,i){super(),this.common=e,this.u_image=r,this.u_transformGrid=i}};function cft(t,e){t.include(aft,e),t.fragment.uniforms.add([new Mt("u_image",r=>r.u_image),new Bg("u_flipY",r=>r.common.u_flipY),new Bg("u_applyTransform",r=>r.common.u_applyTransform)]),t.fragment.code.add(w`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}
vec4 getPixel(vec2 pixelLocation) {
return texture2D(u_image, pixelLocation);
}`)}var Ne;(function(t){t[t.Normal=0]="Normal",t[t.Average=1]="Average",t[t.Lighten=2]="Lighten",t[t.Lighter=3]="Lighter",t[t.Plus=4]="Plus",t[t.Screen=5]="Screen",t[t.ColorDodge=6]="ColorDodge",t[t.Darken=7]="Darken",t[t.Multiply=8]="Multiply",t[t.ColorBurn=9]="ColorBurn",t[t.Overlay=10]="Overlay",t[t.SoftLight=11]="SoftLight",t[t.HardLight=12]="HardLight",t[t.VividLight=13]="VividLight",t[t.Hue=14]="Hue",t[t.Saturation=15]="Saturation",t[t.Luminosity=16]="Luminosity",t[t.Color=17]="Color",t[t.DestinationOver=18]="DestinationOver",t[t.DestinationAtop=19]="DestinationAtop",t[t.DestinationIn=20]="DestinationIn",t[t.DestinationOut=21]="DestinationOut",t[t.SourceAtop=22]="SourceAtop",t[t.SourceIn=23]="SourceIn",t[t.SourceOut=24]="SourceOut",t[t.Xor=25]="Xor",t[t.Difference=26]="Difference",t[t.Exclusion=27]="Exclusion",t[t.Minus=28]="Minus",t[t.Invert=29]="Invert",t[t.Reflect=30]="Reflect",t[t.COUNT=31]="COUNT"})(Ne||(Ne={}));const gH={normal:Ne.Normal,average:Ne.Average,lighten:Ne.Lighten,lighter:Ne.Lighter,screen:Ne.Screen,plus:Ne.Plus,"color-dodge":Ne.ColorDodge,darken:Ne.Darken,multiply:Ne.Multiply,"color-burn":Ne.ColorBurn,overlay:Ne.Overlay,"soft-light":Ne.SoftLight,"hard-light":Ne.HardLight,"vivid-light":Ne.VividLight,hue:Ne.Hue,saturation:Ne.Saturation,luminosity:Ne.Luminosity,color:Ne.Color,difference:Ne.Difference,exclusion:Ne.Exclusion,minus:Ne.Minus,invert:Ne.Invert,reflect:Ne.Reflect,"destination-over":Ne.DestinationOver,"destination-atop":Ne.DestinationAtop,"destination-in":Ne.DestinationIn,"destination-out":Ne.DestinationOut,"source-atop":Ne.SourceAtop,"source-in":Ne.SourceIn,"source-out":Ne.SourceOut,xor:Ne.Xor};function uft(t){return t===Ne.DestinationOver||t===Ne.DestinationAtop||t===Ne.DestinationIn||t===Ne.DestinationOut||t===Ne.SourceAtop||t===Ne.SourceIn||t===Ne.SourceOut||t===Ne.Xor}function uJ(t){t.code.add(w`
    float lineFactorAtPosition(float value) {
      float pos = value * ${w.float(257)};
      if(pos < 0.5 || pos > ${w.float(257-.5)}) {
        return 1.0;
      }

      pos = pos + 0.5;
      float modulo = mod(pos, 16.0);
      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
    }

    float lineFactorAtUV(vec2 uv) {
      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
    }

    float lineFactor(vec2 uv) {
      vec2 offset = fwidth(uv) * 0.25;
      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
    }

    vec3 gridColor(vec2 uv) {
      float line = lineFactor(uv) * 0.1 + 0.9;
      return vec3(1.0, 0.972, 0.918) * line;
    }`)}function hft(t,e){const r=e.blendMode;r!==Ne.Normal&&(r===Ne.Reflect&&t.code.add(w`float reflectBlend(in float cb, in float cl) {
return (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);
}`),r!==Ne.ColorDodge&&r!==Ne.VividLight||t.code.add(w`float colorDodge(in float cb, in float cl) {
return (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));
}`),r!==Ne.ColorBurn&&r!==Ne.VividLight||t.code.add(w`float colorBurn(in float cb, in float cl) {
return (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);
}`),r===Ne.Overlay&&t.code.add(w`float overlay(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);
}`),r===Ne.HardLight&&t.code.add(w`float hardLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));
}`),r===Ne.SoftLight&&t.code.add(w`float softLight(in float cb, in float cl) {
if (cl <= 0.5) {
return cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);
}
if (cb <= 0.25) {
return cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);
}
return cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);
}`),r===Ne.VividLight&&t.code.add(w`float vividLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));
}`),r!==Ne.Hue&&r!==Ne.Saturation&&r!==Ne.Color&&r!==Ne.Luminosity||(t.code.add(w`float minv3(in vec3 c) {
return min(min(c.r, c.g), c.b);
}
float maxv3(in vec3 c) {
return max(max(c.r, c.g), c.b);
}
float lumv3(in vec3 c) {
return dot(c, vec3(0.3, 0.59, 0.11));
}
vec3 clipColor(vec3 color) {
float lum = lumv3(color);
float mincol = minv3(color);
float maxcol = maxv3(color);
if (mincol < 0.0) {
color = lum + ((color - lum) * lum) / (lum - mincol);
}
if (maxcol > 1.0) {
color = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);
}
return color;
}
vec3 setLum(vec3 cbase, vec3 clum) {
return clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));
}`),r!==Ne.Hue&&r!==Ne.Saturation||t.code.add(w`float satv3(vec3 c) {
return maxv3(c) - minv3(c);
}
vec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)
{
float minbase = minv3(cbase);
float sbase = satv3(cbase);
float ssat = satv3(csat);
return setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);
}`)),t.code.add(w`
    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {
      ${r===Ne.Multiply?w`return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Ne.Average?w`return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Ne.Lighten?w`return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Ne.Darken?w`return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Ne.Lighter?w`return vec4(cl * ol + cb * ob, ol + ob);`:r===Ne.Plus?w`return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);`:r===Ne.Minus?w`return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);`:r===Ne.Screen?w`return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Ne.Difference?w`return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Ne.Invert?w`return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);`:r===Ne.DestinationOver?w`return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);`:r===Ne.DestinationAtop?w`return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);`:r===Ne.DestinationOut?w`return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));`:r===Ne.SourceAtop?w`return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);`:r===Ne.SourceOut?w`return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));`:r===Ne.Xor?w`return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));`:r===Ne.DestinationIn?w`return vec4(cb * ob * ol, ol * ob);`:r===Ne.SourceIn?w`return vec4(cl * ol * ob, ol * ob);`:r===Ne.Hue?w`
          vec3 f = setLumSat(cl, cb, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Ne.Saturation?w`
          vec3 f = setLumSat(cb, cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Ne.Color?w`
          vec3 f = setLum(cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Ne.Luminosity?w`
          vec3 f = setLum(cb, cl);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Ne.Exclusion?w`
          vec3 f = cl + cb - 2.0 * cl * cb;
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Ne.Reflect?w`
          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Ne.ColorDodge?w`
          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Ne.ColorBurn?w`
          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Ne.Overlay?w`
          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Ne.SoftLight?w`
          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Ne.HardLight?w`
          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Ne.VividLight?w`
          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:w``}
    }
  `))}var In,rp,Bd;(function(t){t[t.Composite=0]="Composite",t[t.ColorComposite=1]="ColorComposite",t[t.GridComposite=2]="GridComposite",t[t.GroupBackgroundComposite=3]="GroupBackgroundComposite",t[t.COUNT=4]="COUNT"})(In||(In={})),function(t){t[t.NotRequired=0]="NotRequired",t[t.Required=1]="Required",t[t.COUNT=2]="COUNT"}(rp||(rp={})),function(t){t[t.Off=0]="Off",t[t.On=1]="On",t[t.COUNT=2]="COUNT"}(Bd||(Bd={}));function aEe(t,e){const r=e.output===In.GridComposite,i=e.output===In.ColorComposite,s=e.output===In.GroupBackgroundComposite,n=e.output===In.Composite;r&&(t.extensions.add("GL_OES_standard_derivatives"),t.fragment.include(uJ)),i&&t.fragment.uniforms.add(new qt("backgroundColor",c=>c.backgroundColor));const o=e.baseOpacityMode===rp.Required;if(o&&t.fragment.uniforms.add(new Pe("baseOpacity",c=>c.baseOpacity)),n){const c=e.hasWebGL2Context?Qr.None:Qr.InvSize;t.fragment.uniforms.add(op("fboColor",h=>h.fboTexture,c))}const a=e.blendMode!==Ne.Normal,l=e.premultipliedSource===Bd.On;t.fragment.include(hft,e),t.fragment.code.add(w`
    vec4 getBackground(vec2 uv) {
      return ${o?w`baseOpacity *`:""} ${s?w`vec4(0.0, 0.0, 0.0, 0.0)`:i?w`vec4(backgroundColor, 1.0)`:r?w`vec4(gridColor(uv), 1.0)`:w`${Ja(e,"fboColor","gl_FragCoord.xy")}`};
    }

    vec4 blendLayers(vec4 bgColor, vec4 colorLayer, float opacity) {
      ${a?w`
          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;
          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;
          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);`:w`
          float composeAlpha = colorLayer.a * opacity;
          return ${!l&&(n&&!o||s)?w`colorLayer * opacity;`:w`bgColor * (1.0 - composeAlpha) + colorLayer * opacity;`}`}
    }`)}let h6=class extends lft{constructor(e,r,i,s,n,o){super(e,s,n),this.colormap=r,this.symbolizer=i,this.u_colormap=o,this.backgroundColor=ma,this.fboTexture=null,this.baseOpacity=1}},dft=class extends h6{},pft=class extends h6{};function fft(t){const e=new Dr;return e.include(oEe),e.include(cft,t),e.include(oft,t),e.include(aEe,t),e.fragment.code.add(w`vec4 applyBackgroundBlend(vec4 layerColor) {
vec4 bgColor = getBackground(vuv);
return blendLayers(bgColor, layerColor, u_opacity);
}`),t.colorizerType===iw.Stretch?gft(e,t):t.colorizerType===iw.Lut?mft(e):t.colorizerType===iw.Hillshade&&yft(e,t),e}function mft(t){t.fragment.code.add(w`void main() {
vec2 pixelLocation = getPixelLocation(uv);
if (isOutside(pixelLocation)) {
gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
return;
}
vec4 currentPixel = getPixel(pixelLocation);
gl_FragColor = applyBackgroundBlend(colormap(currentPixel, true));
}`)}function gft(t,e){t.fragment.uniforms.add([new kM("u_bandCount",i=>i.symbolizer.u_bandCount),new ha("u_minCutOff",i=>i.symbolizer.u_minCutOff,3),new ha("u_maxCutOff",i=>i.symbolizer.u_maxCutOff,3),new ha("u_factor",i=>i.symbolizer.u_factor,3),new Pe("u_minOutput",i=>i.symbolizer.u_minOutput),new Pe("u_maxOutput",i=>i.symbolizer.u_maxOutput),new Bg("u_useGamma",i=>i.symbolizer.u_useGamma),new ha("u_gamma",i=>i.symbolizer.u_gamma,3),new ha("u_gammaCorrection",i=>i.symbolizer.u_gammaCorrection,3),new Pe("u_opacity",i=>i.common.u_opacity)]),t.fragment.code.add(w`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const r=e.applyColormap?w`gl_FragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));`:w`gl_FragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));`;t.fragment.code.add(w`
      void main() {
        vec2 pixelLocation = getPixelLocation(uv);
        if (isOutside(pixelLocation)) {
          gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
          return;
        }

        vec4 currentPixel = getPixel(pixelLocation);
        ${e.stretchType===kw.Noop?w`
        gl_FragColor = applyBackgroundBlend(currentPixel);`:w`
        if (currentPixel.a == 0.0) {
          gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
          return;
        }
        if (u_bandCount == 1) {
          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          ${r}
        } else {
          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
          gl_FragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));
        }`}
      }`)}function yft(t,e){const r=t.fragment;r.uniforms.add([new Mt("u_image",s=>s.u_image),new kM("u_hillshadeType",s=>s.symbolizer.u_hillshadeType),new ha("u_sinZcosAs",s=>s.symbolizer.u_sinZcosAs,6),new ha("u_sinZsinAs",s=>s.symbolizer.u_sinZsinAs,6),new ha("u_cosZs",s=>s.symbolizer.u_cosZs,6),new ha("u_weights",s=>s.symbolizer.u_weights,6),new kr("u_factor",s=>s.symbolizer.u_factor),new Pe("u_minValue",s=>s.symbolizer.u_minValue),new Pe("u_maxValue",s=>s.symbolizer.u_maxValue),new kr("u_srcImageSize",s=>s.common.u_srcImageSize)]),r.include(bm),r.code.add(w`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 color = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(color.rgb);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv), 1.0) * alpha * color.a;
}`),r.code.add(w`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const i=e.applyColormap?w`gl_FragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));`:w`hillshade *= alpha;
gl_FragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));`;r.code.add(w`
    void main() {
      vec2 pixelLocation = getPixelLocation(uv);
      if (isOutside(pixelLocation)) {
        gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture2D(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture2D(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture2D(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture2D(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture2D(u_image, pixelLocation);
      vec4 vf = texture2D(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture2D(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture2D(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture2D(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${i}
    }
  `)}const _ft=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:pft,ColorizerStretchUniforms:dft,ColorizerUniforms:h6,build:fft},Symbol.toStringTag,{value:"Module"}));function vft(t,e,r="nearest",i=!1){var c;const s=!(i&&e.pixelType==="u8"),n=s?Lt.FLOAT:Lt.UNSIGNED_BYTE,o=e.pixels==null||e.pixels.length===0?null:s?e.getAsRGBAFloat():e.getAsRGBA(),a=(c=t.capabilities.textureFloat)==null?void 0:c.textureFloatLinear,l={width:e.width,height:e.height,target:bt.TEXTURE_2D,pixelFormat:Ve.RGBA,internalFormat:t.type===vt.WEBGL2&&s?St.RGBA32F:Ve.RGBA,samplingMode:!a||r!=="bilinear"&&r!=="cubic"?tt.NEAREST:tt.LINEAR,dataType:n,wrapMode:Rt.CLAMP_TO_EDGE,flipped:!1};return new ct(t,l,o)}function bft(t,e){const{spacing:r,offsets:i,coefficients:s,size:[n,o]}=e,a=r[0]>1,l={width:a?4*n:n,height:o,target:bt.TEXTURE_2D,pixelFormat:Ve.RGBA,internalFormat:t.type===vt.WEBGL2?St.RGBA32F:Ve.RGBA,dataType:Lt.FLOAT,samplingMode:tt.NEAREST,wrapMode:Rt.CLAMP_TO_EDGE,flipped:!1},c=new Float32Array(a?n*o*16:2*i.length);if(a&&s!=null)for(let h=0,p=0;h<s.length;h++)c[p++]=s[h],h%3==2&&(c[p++]=1);else for(let h=0;h<o;h++)for(let p=0;p<n;p++){const f=4*(h*n+p),m=2*(p*o+h);c[f]=i[m],c[f+1]=i[m+1],c[f+3]=i[m]===-1?0:1}return new ct(t,l,c)}function Vae(t,e){const r={width:e.length/4,height:1,target:bt.TEXTURE_2D,pixelFormat:Ve.RGBA,internalFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,wrapMode:Rt.CLAMP_TO_EDGE,flipped:!1};return new ct(t,r,e)}function wft(t,e,r,i=1,s=!0){return{u_flipY:s,u_applyTransform:!!t,u_opacity:i,u_transformSpacing:t?t.spacing:Wl,u_transformGridSize:t?t.size:Wl,u_targetImageSize:e,u_srcImageSize:r}}function xft(t,e){return{u_colormapOffset:e||0,u_colormapMaxIndex:t?t.length/4-1:0}}function Tft(t){return{u_bandCount:t.bandCount,u_minOutput:t.outMin,u_maxOutput:t.outMax,u_minCutOff:t.minCutOff,u_maxCutOff:t.maxCutOff,u_factor:t.factor,u_useGamma:t.useGamma,u_gamma:t.gamma,u_gammaCorrection:t.gammaCorrection}}function Sft(t){return{u_hillshadeType:t.hillshadeType,u_sinZcosAs:t.sinZcosAs,u_sinZsinAs:t.sinZsinAs,u_cosZs:t.cosZs,u_weights:t.weights,u_factor:t.factor,u_minValue:t.minValue,u_maxValue:t.maxValue}}const Bae={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};let Eft=class{constructor(e,r,i=null,s=null){this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.lij=null,this.opacity=1,this.lij=e,this.source=r,this.width=i||r.width,this.height=s||r.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture=Qe(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?{...Bae,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||Bae}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){v(e)&&e.length>0?this._bandIds&&e.every((r,i)=>{var s;return!!((s=this._bandIds)!=null&&s[i])&&r===this._bandIds[i]})||(this._bandIds=e,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){if(this._interpolation=e,v(this._rasterTexture)){const r=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode(r==="bilinear"?tt.LINEAR:tt.NEAREST)}}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture=Qe(this._transformGridTexture),this._memoryUsed=null}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((C(this._rasterTexture)||this._dirty)&&this._updateRasterTexture(e,this.bandIds),v(this._rasterTexture)&&(this._updateColormapTexture(e),this.transformGrid&&C(this._transformGridTexture)&&(this._transformGridTexture=bft(e,this.transformGrid))),!0)}getUniforms(){const{symbolizerParameters:e,transformGrid:r,width:i,height:s,opacity:n}=this,o=wft(r,[i,s],[this.source.width,this.source.height],n),a=xft(e.colormap,e.colormapOffset),l=this.symbolizerParameters.type==="stretch"?Tft(this.symbolizerParameters):null,c=this.symbolizerParameters.type==="hillshade"?Sft(this.symbolizerParameters):null;return new h6(o,a,l||c,this._rasterTexture,this._transformGridTexture,this._colormapTexture)}get memoryUsage(){if(C(this._memoryUsed)){const e=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=e.map(r=>v(r)?r.descriptor.width*r.descriptor.height*4:0).reduce((r,i)=>r+i,0)}return this._memoryUsed}release(){return this._rasterTexture=Qe(this._rasterTexture),this._transformGridTexture=Qe(this._transformGridTexture),this._colormapTexture=Qe(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,r){const i=this.source?this.source.extractBands(r):null;if(!(i&&i.pixels&&i.pixels.length>0))return void(this._rasterTexture=Qe(this._rasterTexture));const s=C(r)&&C(this.bandIds)||v(r)&&v(this.bandIds)&&r.join("")===this.bandIds.join("");if(v(this._rasterTexture)&&s)return;this._rasterTexture=Qe(this._rasterTexture);const n=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=vft(e,i,n,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&this.symbolizerParameters.stretchType==="none"&&!this.symbolizerParameters.useGamma&&this.source.pixelType==="u8"}_getRasterTextureInterpolation(e){return this.symbolizerParameters.type==="lut"||e==="nearest"||e==="majority"?"nearest":"bilinear"}_updateColormapTexture(e){const r=this._colormap,i=this.symbolizerParameters.colormap;return i?r?i.length!==r.length||i.some((s,n)=>s!==r[n])?(this._colormapTexture=Qe(this._colormapTexture),this._colormapTexture=Vae(e,i),void(this._colormap=i)):void 0:(this._colormapTexture=Vae(e,i),void(this._colormap=i)):(this._colormapTexture=Qe(this._colormapTexture),void(this._colormap=null))}},TD=class{constructor(){this.waitingAgents=new Jt,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0}static acquire(e){const r=Q9.acquire();return r._init(e),r}release(){this.dispose(),SD.delete(this),Q9.release(this)}dispose(){this.loadingAgent=Qe(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=hS(this._data)}static prune(){Q9.prune(0)}_init(e){this.waitingAgents.clear(),this._data=hS(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=Fh(this.requestAbort),this.requestPromise=null}get upsampleInfo(){return this._upsampleInfo}_unsetUpsampleInfo(){v(this._upsampleInfo)&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}setUpsampleInfo(e,r){if(e===r||C(r))this._unsetUpsampleInfo();else{if(C(this._upsampleInfo))this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===r)return;this._upsampleInfo.tile.unrefMapData()}r.refMapData(),ift(e,r,this._upsampleInfo)}}get data(){return this._data}set data(e){hS(this._data),this._data=e}};const Q9=new Co(TD,null,()=>{}),SD=new Map;function Cft(){SD.size>0&&(console.log(`${SD.size} live TilePerLayerInfo allocations:`),SD.forEach(t=>console.log(t,`
`)))}let u2=class{constructor(e){this._texture=e,this.type="tile-texture",this._refCount=1}retain(){++this._refCount}release(){--this._refCount,this._refCount===0&&this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}};var Et;(function(t){t[t.NONE=0]="NONE",t[t.NONE_HIT_MAXLOD=1]="NONE_HIT_MAXLOD",t[t.SPLIT=2]="SPLIT",t[t.VSPLITMERGE=4]="VSPLITMERGE",t[t.MERGE=8]="MERGE",t[t.RENDERDATA=16]="RENDERDATA",t[t.GEOMETRY=32]="GEOMETRY",t[t.TEXTURE_NOFADING=64]="TEXTURE_NOFADING",t[t.TEXTURE_FADING=128]="TEXTURE_FADING"})(Et||(Et={}));const ek=M(),Jx=M(),co=M(),Aft=.1;let hJ=class{constructor(){this.lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this.renderData=null,this._dirty=!0,this._previouslyRendered=!1,this.extent=ur(),this._elevationBounds=Je(),this.layerInfo=[[],[]],this.extentInRadians=ur(),this.centerAtSeaLevel=M(),this._center=[M(),on(),M()],this.up=Oq(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=null,this._mapTileMemoryInternal=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=M()}static prune(){dJ.prune(0),pJ.prune(0),TD.prune()}get _isCached(){return!this.shouldLoad&&this._mapDataRefCount<=0}get maxTesselation(){return this._maxTesselation}get isWithinClippingArea(){return this._isWithinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBounds(){return this._elevationBounds}get level(){return this.lij[0]}get key(){return`${this.lij[0]}/${this.lij[1]}/${this.lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[Ks.MIDDLE][3]}get visible(){return this._dirty&&this.computeVisibility(),this._visible}get frustumVisibility(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}computeVisibility(){var i;this._dirty=!1;const e=((i=this.parent)==null?void 0:i.frustumVisibility)??aa.INTERSECTS;this._frustumVisibility=e===aa.INSIDE?aa.INSIDE:e===aa.OUTSIDE?aa.OUTSIDE:this._calculateFrustumVisibilityStatus(this.surface.frustum);const r=this._frustumVisibility!==aa.OUTSIDE&&this._intersectsClippingArea;r!==this._visible&&(this._visible=r,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}get loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}get shouldLoad(){const e=this._surface.snapLevel;if(v(e)){const r=this.level-e;if(r===0)return!0;if(r===1)return!1}return this.isLeaf}init(e,r,i){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],this.ellipsoid=Jr(i.tilingScheme.spatialReference),i.tilingScheme.getExtent(e[0],e[1],e[2],this.extent),i.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,i.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[Ks.MIDDLE][3]=0,this.vlevel=e?e[0]:0,r&&r.elevationBounds?Un(this._elevationBounds,r.elevationBounds):or(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=r,this.unsetChildren(),this._surface=i,this.updateVisibility();for(const s of ab){const n=i.numLayers(s),o=this.layerInfo[s];for(const a of o)a.release();o.length=n;for(let a=0;a<n;a++)o[a]=TD.acquire(this._surface.upsampleInfoPool),s===dr.ELEVATION&&this.findElevationBoundsForLayer(a,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(i.tilingScheme.pixelSize,t3)}release(){Of(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key);for(const e of ab){for(const r of this.layerInfo[e])r.release();this.layerInfo[e].length=0}this._parent=null;for(let e=0;e<4;++e)this._children[e]=null;this._surface=null,this.setMemoryDirty()}refMapData(){++this._mapDataRefCount,this._isCached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){if(--this._mapDataRefCount,this._isCached){this.setMemoryDirty();const e=this._cachedMemory;e>0&&this._surface.upsampleMapCache.put(this.key,this,e)}}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this._ensureUsedMemory()+(this._isCached?0:this._mapTileMemoryInternal)}get _cachedMemory(){return this._isCached?this._mapTileMemory:0}get _mapTileMemory(){return this._ensureUsedMemory(),this.layerInfo[dr.MAP].reduce((e,r)=>e+(r instanceof K9?r.memoryUsage:0),this._mapTileMemoryInternal)}get _cpuImageMemorySize(){const r=this._surface.tilingScheme.pixelSize;return r*r*4}_ensureUsedMemory(){if(v(this._usedMemory))return this._usedMemory;this._usedMemory=0,this._mapTileMemoryInternal=0;let e=0;for(const{data:i}of this.layerInfo[dr.MAP])i instanceof K9?e+=this._getTerrainDataMemory(i):this._mapTileMemoryInternal+=this._getTerrainDataMemory(i);const r=this._cpuImageMemorySize;for(const i of this.layerInfo[dr.ELEVATION])this._usedMemory+=i.data?r:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemoryInternal+=Ow(this.renderData.textureDescriptor)),this._isCached&&this._surface.upsampleMapCache.updateSize(this.key,this,this._mapTileMemoryInternal+e),this._usedMemory}getUsedMemoryForLayer(e,r){const i=this.layerInfo[e][r];return i!=null&&i.data?e===dr.MAP?this._isCached?0:this._getTerrainDataMemory(i.data):e===dr.ELEVATION?this._cpuImageMemorySize:0:0}_getTerrainDataMemory(e){return e instanceof u2?Ow(e.texture):e instanceof HTMLImageElement||e instanceof a6?this._cpuImageMemorySize:e instanceof K9||e instanceof Eft?e.memoryUsage:0}updateScreenDepth(e){const r=this._center[Ks.MIDDLE],i=e,s=r[0],n=r[1],o=r[2],a=i[2]*s+i[6]*n+i[10]*o+i[14];this.screenDepth=a<0?0:a/(i[3]*s+i[7]*n+i[11]*o+i[15])}shouldSplit(e,r,i){if(!this.visible||v(e.frustum)&&(!this._intersectsClippingArea||this._calculateFrustumVisibilityStatus(e.frustum)===aa.OUTSIDE))return Et.NONE;const s=this.level;me(ek,this._center[Ks.MIDDLE],r);let n=ua(ek),o=Ks.MIDDLE;me(Jx,this._center[Ks.TOP],r);const a=ua(Jx);a<n&&(n=a,o=Ks.TOP),me(Jx,this._center[Ks.BOTTOM],r);const l=ua(Jx);if(l<n&&(n=l,o=Ks.BOTTOM),this._edgeLen2>n&&s<e.maxLod)return Et.SPLIT;const c=Math.sqrt(n),h=e.fovX*c*2,p=this._edgeLen/h,f=()=>{const b=s+Math.ceil(-Math.log2(e.relativeWidthLimit/p));return b!==this.vlevel?(this.vlevel=b,Et.VSPLITMERGE):Et.NONE_HIT_MAXLOD};if(v(i)&&i-s===1)return s>=e.maxLod?f():Et.SPLIT;const m=ye(this.up,ek),y=this._elevationBounds[1]-this._elevationBounds[0],_=y/this.edgeLen;if(e.aboveGround&&m>0&&_<.001&&m/c-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-_>0)return Et.NONE;if(p<e.relativeWidthLimit)return this.vlevel!==this.level?(this.vlevel=this.level,Et.VSPLITMERGE):Et.NONE;if(s>=e.maxLod)return f();if(s>6){me(Jx,this._center[o],r),ae(co,this.up,m),me(co,co,Jx);const b=ua(co);if(b>this.radius*this.radius){ae(co,co,this.radius/Math.sqrt(b)),fe(co,co,this._center[o]),me(co,r,co);const x=Math.min(1,(Math.abs(ye(co,this.up))+.5*y+this._curvatureHeight)/Me(co)),T=Aft/e.angledSplitBias,S=e.fovY*c*2;if(x*(this._edgeLen/S)<T*e.relativeHeightLimit)return Et.NONE}}return Et.SPLIT}setChildren(e,r,i,s){Of(!!(e&&r&&i&&s),"Null child passed"),this._children[0]=e,this._children[1]=r,this._children[2]=i,this._children[3]=s}unsetChildren(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}get isLoaded(){var e;return((e=this.renderData)==null?void 0:e.hasGeometry)??!1}load(){this.refMapData();for(const e of ab)this._createOrUpdateAgents(0,e);this.surface.renderer.loadTile(this)}unload(e){e.unloadTile(this);for(const r of ab){const i=this.layerInfo[r];for(const s of i)s.loadingAgent&&s.loadingAgent!==ec&&(_$(s.loadingAgent),s.loadingAgent=null),s.pendingUpdates=0}this.resetPendingUpdate(Et.GEOMETRY),this.resetPendingUpdate(Et.TEXTURE_NOFADING),this.resetPendingUpdate(Et.TEXTURE_FADING),this.unrefMapData()}unloadMapData(){const e=this.layerInfo[dr.MAP];for(const r of e)r.loadingAgent&&r.loadingAgent!==ec&&(_$(r.loadingAgent),r.loadingAgent=null),r.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if(qb(e,this._clippingArea))return!1;const r=this._intersectsClippingArea,i=this._isWithinClippingArea;v(e)?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const s=i&&this._isWithinClippingArea,n=!(i||r||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||s||n||this.setPendingUpdate(Et.GEOMETRY),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,r){return this.layerInfo[r][e]}hasLayerData(e,r){const i=this.layerInfo[r][e];return!(!i||!i.data||i.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of ab){const r=this.layerInfo[e];for(const i of r)if(i.loadingAgent&&i.loadingAgent!==ec&&i.loadingAgent.updating)return!0}return!1}_isSuspended(e){return!!this.hasPendingUpdate(Et.SPLIT)||e!==dr.ELEVATION&&!this.loadable}get hasPendingUpdates(){return this._pendingUpdates!==0}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){this._pendingUpdates|=e,e===Et.SPLIT||e===Et.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate()}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,r,i){const s=this.layerInfo[r][e];if(s.waitingAgents.has(i))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),r,e),!0;if(s.waitingAgents.push(i),s.data&&!s.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),r,e),i.dataArrived(this),!0;if(s.requestPromise)return!0;Fh(s.requestAbort),s.requestAbort=new AbortController;const n=this._surface.requestTileData(this,e,r,s.requestAbort);if(!n)return s.requestAbort=null,!1;const o=()=>{s.requestPromise===n&&(s.requestPromise=null,s.requestAbort=null)};return s.requestPromise=n,n.then(o,o),!0}get isLeaf(){return this._children[0]==null}hasLij(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;const r=this._children;return r[0]?r[0].findByLij(e)||r[1].findByLij(e)||r[2].findByLij(e)||r[3].findByLij(e):null}distanceToSquared(e){return ua(me(co,this._center[Ks.MIDDLE],e))}containsPoint(e){const r=this.extent;return e[0]>=r[0]&&e[1]>=r[1]&&e[0]<=r[2]&&e[1]<=r[3]}containsPointXY(e,r){const i=this.extent;return e>=i[0]&&r>=i[1]&&e<=i[2]&&r<=i[3]}unrequestLayerData(e,r,i){const s=this.layerInfo[r][e],n=s.waitingAgents,o=n.removeUnordered(i)!=null;Of(o,"agent has not requested this piece of map data"),n.length<1&&(s.abortRequest(),this.setMemoryDirty())}dataArrived(e,r,i){const s=this.layerInfo[r][e];s.data=i,s.dataInvalidated=!1,s.waitingAgents.forAll(n=>n.dataArrived(this)),s.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(e,r,i){i.notInTilemap||console.error(`Tile ${this.lij.toString()} layer ${r}/${e} error ${i}`);const s=this.layerInfo[r][e];s.dataMissing=!0,s.waitingAgents.forAll(n=>n.dataMissing()),s.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(e,r){switch(e){case dr.MAP:return this._updateTexture(r);case dr.ELEVATION:return this._updateGeometry()}}_updateTexture(e){this.renderData&&(this.resetPendingUpdate(e===yn.FADING?Et.TEXTURE_NOFADING:Et.TEXTURE_FADING),this.setPendingUpdate(e===yn.FADING?Et.TEXTURE_FADING:Et.TEXTURE_NOFADING))}_updateGeometry(){this.setPendingUpdate(Et.GEOMETRY);for(const e of this.layerInfo[dr.ELEVATION])e.pendingUpdates|=Et.GEOMETRY}invalidateLayerData(e,r){this.layerInfo[r][e].invalidateSourceData(),this.restartAgents(r)}computeElevationBounds(){const e=this._elevationBounds,r=e[0],i=e[1];or(e,1/0,-1/0);const s=this.layerInfo[dr.ELEVATION];let n=!0;for(const o of s)v(o.elevationBounds)&&(e[0]=Math.min(e[0],o.elevationBounds.min),e[1]=Math.max(e[1],o.elevationBounds.max),o.elevationBounds.hasNoDataValues||(n=!1));n&&(e[0]=Math.min(e[0],0),e[1]=Math.max(e[1],0)),r===e[0]&&i===e[1]||(this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}_updateCenter(){const e=this._elevationBounds,r=.5*(e[0]+e[1]),i=this._center;ae(co,this.up,r),fe(i[Ks.MIDDLE],this.centerAtSeaLevel,co),ae(co,this.up,e[0]),fe(i[Ks.TOP],this.centerAtSeaLevel,co),ae(co,this.up,e[1]),fe(i[Ks.BOTTOM],this.centerAtSeaLevel,co)}findElevationBoundsForLayer(e,r){const i=this.layerInfo[dr.ELEVATION][e],s=rG(this.level),n=Math.max(this.vlevel-s,0),o=i.elevationBounds;if(v(o)&&o.level>=r&&o.level<=n)return;const a=this._surface.layerViewByIndex(e,dr.ELEVATION),l=lH(a);if(!AR(this,l,!1))return;const c=Oft;let h=!1;const p=i.data;if(p&&p.level<=n){const f=i.data;c.min=f.samplerData.data.minValue,c.max=f.samplerData.data.maxValue,c.hasNoDataValues=f.samplerData.data.hasNoDataValues,c.level=this.level,h=!0}else{let f,m,y=0;for(let _=this._parent;_&&(!m||y<s)&&(y=this.vlevel-_.level,f=m||f,m=_.layerInfo[dr.ELEVATION][e].data,!(!m&&f&&_.level<=n));_=_.parent);m=m||f,m&&(m.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],c),c.min!==1/0&&(c.level=m.level,h=!0))}h&&(C(i.elevationBounds)&&(i.elevationBounds=new F2),i.elevationBounds.copyFrom(c))}modifyLayers(e,r,i){const s=this.layerInfo[i];for(const a of s)a.loadingAgent&&a.loadingAgent!==ec&&(_$(a.loadingAgent),a.loadingAgent=null),a.waitingAgents.clear();for(let a=0;a<s.length;++a)e[a]===void 0&&s[a].release();const n=new Array(...s),o=r.length;s.length=o;for(let a=0;a<o;a++){const l=r[a];s[a]=l>-1?n[l]:TD.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,yn.FADING))}updateAgents(e){if(this.renderData){const r=this.layerInfo[e];for(const i of r)i.loadingAgent===ec&&(i.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of ab){const r=this._isSuspended(e);for(const i of this.layerInfo[e])i.loadingAgent&&i.loadingAgent!==ec&&(i.loadingAgent.setSuspension(r),i.loadingAgent===ec&&this.updateRenderData(e,yn.FADING))}}removeLayerAgent(e,r){const i=this.layerInfo[r][e];i.loadingAgent&&i.loadingAgent!==ec&&i.loadingAgent.dispose(),i.loadingAgent=null}agentDone(e,r){const i=this.layerInfo[r][e];i.loadingAgent=ec,!i.data&&C(i.upsampleInfo)&&this._createOrUpdateAgents(e+1,r)}_hasBlendableAncestor(e){return e.blendMode!=="normal"||SS(e.parent)&&this._hasBlendableAncestor(e.parent)}_hasBlendModes(e,r,i){var s,n,o;for(let a=e;a<r;++a){const l=this._surface.layerViewByIndex(a,i);if(zF(l)&&((s=l==null?void 0:l.layer)==null?void 0:s.blendMode)!=="normal"||SS((n=l==null?void 0:l.layer)==null?void 0:n.parent)&&this._hasBlendableAncestor((o=l==null?void 0:l.layer)==null?void 0:o.parent))return!0}return!1}_createOrUpdateAgents(e,r){const i=this.layerInfo[r];if(i.length===0)return;const s=this._isSuspended(r);for(let n=e;n<i.length;++n){const o=i[n];let a=!1;const l=this._surface.layerViewByIndex(n,r),c=lH(l);if(o.loadingAgent?AR(this,c,!1)?(o.loadingAgent!==ec&&o.loadingAgent.setSuspension(s),o.loadingAgent!==ec&&(a=o.loadingAgent.update())):o.dispose():AR(this,c,!1)&&(o.loadingAgent=Rft(this,n,r,s),a=o.loadingAgent.startLoading(),a?o.loadingAgent===ec&&this.setPendingUpdate(Et.GEOMETRY):(_$(o.loadingAgent),o.loadingAgent=ec)),o.loadingAgent===ec&&this.updateRenderData(r,yn.FADING),!this._hasBlendModes(e,i.length,r)&&a&&l.isOpaque)return}}_isWithinExtent(e){const r=this.extent;return r[0]>=e[0]&&e[2]>=r[2]&&r[1]>=e[1]&&e[3]>=r[3]}intersectsExtent(e){const r=this.extent;return r[2]>=e[0]&&e[2]>=r[0]&&r[3]>=e[1]&&e[3]>=r[1]}getElevationVerticesPerSide(e){const r=this.vlevel-this.level,i=Math.max(this.level-e,rG(this.level)-r),s=ge(1+(this.maxTesselation>>i),2,this.maxTesselation+1),n=this.getDefaultVerticesPerSide();return Math.max(s,n)}get test(){return{cachedMemory:this._cachedMemory}}_findLIJ(e,r){if(!e)return null;const i=this.surface.rootTiles;if(v(i)){for(const s of i)if(Mft(s,e)){let n=s,o=e[0]-n.level-1;for(;o>=0&&!n.isLeaf&&!r(n);){const a=e[1]>>o&1,l=e[2]>>o&1;n=n.children[2*a+l],o--}return r(n)?n:null}}return null}findNeighborTile(e,r){const i=this.lij,s=this.getNeighborLIJ(i,e);return s?Pft(i,s)?r(this)?this:null:this._findLIJ(s,r):null}findCorner(e,r){const i=e===At.NORTH_EAST?1:e===At.NORTH_WEST?0:e===At.SOUTH_WEST?2:3;let s=this;for(;s.children[0]&&(!r||!r(s));)s=s.children[i];return s}findNeighborCornerTileExact(e,r){var i;return((i=this.findNeighborTile(e,s=>r(s)||s.level===this.level))==null?void 0:i.findCorner(hH(e),r))||null}forAllSubtreeOnSide(e,r){const i=e===At.NORTH?[0,1]:e===At.NORTH_EAST?[1]:e===At.EAST?[1,3]:e===At.SOUTH_EAST?[3]:e===At.SOUTH?[2,3]:e===At.SOUTH_WEST?[2]:e===At.WEST?[0,2]:[0],s=n=>{const o=n.children;!r(n)&&o[0]&&i.forEach(a=>s(o[a]))};s(this)}forallNeighbors(e){jF.forEach(r=>this.findNeighborCornerTileExact(r,e)),Bf.forEach(r=>{var i;return(i=this.findNeighborTile(r,s=>s.level===this.level||e(s)))==null?void 0:i.forAllSubtreeOnSide(GF(r),e)})}getNeighborEdgeStartVertexIndex(e,r){if(!r)return 0;const i=this.level-r.level;if(Re(!xn||i>=0),i===0)return 0;const s=2**i,n=(1&e)==1,o=n?0:1,a=r.lij[o+1]*s,l=this.lij[o+1],c=l-a,h=n?s-1-c:c;return xn&&(Re(a<=l&&l<a+s),Re(0<=h&&h<s)),h}forEachLoadedNeighbor(e){const r=this.level,i=s=>s.level===r||s.isLoaded;Bf.forEach(s=>{const n=this.findNeighborTile(s,i);n!=null&&n!==this&&n.forAllSubtreeOnSide(GF(s),o=>!!o.isLoaded&&(e(o,s),!0))}),jF.forEach(s=>{var o;const n=(o=this.findNeighborTile(s,i))==null?void 0:o.findCorner(hH(s),a=>a.isLoaded);Re(!n||yH(this,n,s)),n!=null&&n.isLoaded&&e(n,s)})}getNeighborLIJ(e,r){const i=Aae(r)?-1:Cae(r)?1:0,s=Sae(r)?-1:Eae(r)?1:0,n=[e[0],e[1]+i,e[2]+s];return n[1]<0?null:this.surface.isGlobal?this.wrapLIJ(n):n[2]<0?null:n}wrapLIJ(e){return!e||e[1]<0||e[1]>=2**e[0]?null:this.surface.wrapEastWest(e)}get westNeighborWestExtent(){return this.extent[0]*(this.isWestEnd?-1:1)}get eastNeighborEastExtent(){return this.extent[2]*(this.isEastEnd?-1:1)}get isEastEnd(){return this.lij[2]===this.surface.lijEastEnd(this.level)-1}get isWestEnd(){return this.lij[2]===0}get isNorthEnd(){return this.lij[1]===0}get isSouthEnd(){return this.extent[1]+Sa()>=this.surface.extent[1]}checkGeometryWaterproofness(){var e;VF&&(Re(this.isLoaded),(e=this.renderData)==null||e.checkGeometryWaterproofness())}shouldHaveNeighbor(e){const r=this.extent,i=this.surface.rootTilesExtent,s=.25*(r[2]-r[0]);if(Aae(e)&&r[3]+s>=i[3]||Cae(e)&&r[1]-s<=i[1])return!1;const n=this.surface.isGlobal;return!(!n&&Sae(e)&&r[0]-s<=i[0])&&!(!n&&Eae(e)&&r[2]+s>=i[2])}updateDistanceToPOI(e){const r=this._lastPOI;if(this.distanceToPOI>=0&&r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2])return;le(this._lastPOI,e);const i=this._center[Ks.MIDDLE],s=e[0]-i[0],n=e[1]-i[1],o=e[2]-i[2];this.distanceToPOI=s*s+n*n+o*o}};function Rft(t,e,r,i){const s=r===dr.ELEVATION?pJ.acquire():dJ.acquire();return s.init(t,e,r,i),s}function _$(t){t.dispose(),t instanceof iEe?pJ.release(t):t instanceof sEe&&dJ.release(t)}const dJ=new Co(sEe),pJ=new Co(iEe),Oft=new F2;var Ks;function Mft(t,e){const r=t.level,i=e[0];if(r>i)return!1;const s=i-r,n=Math.floor(e[1]/2**s),o=Math.floor(e[2]/2**s);return n===t.lij[1]&&o===t.lij[2]}function Pft(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function Ift(t,e,r){if(C(t)||C(e))return!1;if(t.level===0&&e.level===0&&(t.isEastEnd&&e.isWestEnd&&r===At.EAST||t.isWestEnd&&e.isEastEnd&&r===At.WEST))return!0;const i=Math.max(1e-6*(t.extent[2]-t.extent[0]),1);switch(r){case At.NORTH:return Sh(t.extent[3],e.extent[1],i);case At.SOUTH:return Sh(t.extent[1],e.extent[3],i);case At.EAST:return Sh(t.extent[2],e.extent[0],i)||Sh(t.extent[2],-e.extent[0],i);case At.WEST:return Sh(t.extent[0],e.extent[2],i)||Sh(t.extent[0],-e.extent[2],i)}}function yH(t,e,r){return!C(t)&&!C(e)&&e!==t&&(t.level>=e.level?zae(t,e,r):zae(e,t,hH(r)))}function zae(t,e,r){Re(t.level>=e.level);const i=Zdt(r),s=Jdt(r),n=t.extent,o=e.extent,a=[i?n[0]:n[2],s?n[3]:n[1]],l=[i?o[2]:o[0],s?o[1]:o[3]],c=1e-5*(n[2]-n[0]),h=Sh(a[0],l[0],c)||t.surface.isGlobal&&Sh(a[0],-l[0],c),p=Sh(a[1],l[1],c);if(h&&p)return!0;if(t.level===e.level||!h&&!p)return Re(!1),!1;const f=h?Gae(o[1],o[3],n[1],n[3],c):Gae(o[0],o[2],n[0],n[2],c);return Re(f),f}function Gae(t,e,r,i,s=Sa()){return t-s<=r&&r<=i&&i<=e+s}(function(t){t[t.TOP=0]="TOP",t[t.MIDDLE=1]="MIDDLE",t[t.BOTTOM=2]="BOTTOM"})(Ks||(Ks={}));let $ft=class{constructor(){this._scales=Ht(-1,-1,-1,-1),this._offsets=Ht(-1,-1,-1,-1)}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,r,i){this._scales[2*e]=r,this._scales[2*e+1]=i}setOffset(e,r,i){this._offsets[2*e]=r,this._offsets[2*e+1]=i}get scales(){return this._scales}get offsets(){return this._offsets}};function Lft(t,e){t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),e.spherical?t.vertex.code.add(w`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):t.vertex.code.add(w`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),t.fragment.code.add(w`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}let fJ=class extends WTe{constructor(){super(...arguments),this.slicePlaneLocalOrigin=M(),this.origin=this.slicePlaneLocalOrigin}};var Cc;(function(t){t[t.Material=0]="Material",t[t.ShadowMap=1]="ShadowMap",t[t.Highlight=2]="Highlight"})(Cc||(Cc={}));let Dft=class extends fJ{constructor(){super(...arguments),this.identifier=Cc.Material,this.output=k.Color,this.transparent=!1,this.integratedMesh=!1}},Nft=class extends fJ{constructor(){super(...arguments),this.identifier=Cc.ShadowMap}},Fft=class extends fJ{constructor(){super(...arguments),this.identifier=Cc.Highlight}},HF=class extends ws{constructor(e,r){super(e,"vec4",di.Draw,(i,s,n)=>i.setUniform4fv(e,r(s,n)))}};var Wg;function Uft(t,e){const{vertex:r,fragment:i}=t;r.uniforms.add([new HF("overlayTexOffset",(s,n)=>kft(s,n)),new HF("overlayTexScale",(s,n)=>Vft(s,n))]),i.constants.add("overlayOpacity","float",1),i.uniforms.add(new Mt("ovColorTex",(s,n)=>_H(s,n))),lEe(t,e)}function lEe(t,e){t.extensions.add("GL_OES_standard_derivatives"),e.pbrMode!==dt.Water&&e.pbrMode!==dt.WaterOnIntegratedMesh&&e.pbrMode!==dt.TerrainWithWater||t.include(KTe,e);const{vertex:r,fragment:i}=t;t.varyings.add("vtcOverlay","vec4"),r.code.add(w`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),i.code.add(w`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture2D(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture2D(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),i.code.add(w`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),i.code.add(w`
    vec4 getOverlayColorTexel(vec4 texCoords) {
          vec2 texDim =  ${$h(e,"ovColorTex")};

          vec4 color0 = ${Ja(e,"ovColorTex","vec2(texCoords.x * 0.5, texCoords.y)*texDim")};
          vec4 color1 = ${Ja(e,"ovColorTex","vec2(texCoords.z * 0.5 + 0.5, texCoords.w)*texDim")};

          bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
          bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));

          return mix(color1 * float(isValid1), color0, float(isValid0));
    }
  `),e.pbrMode!==dt.Water&&e.pbrMode!==dt.WaterOnIntegratedMesh&&e.pbrMode!==dt.TerrainWithWater||(dy(i),vm(i),i.code.add(w`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position, vec3 positionWorld) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, mainLightDirection, colorInput.rgb, mainLightIntensity, localUp, 1.0 - shadow, maskInput.w, position, positionWorld);
return vec4(final, colorInput.w);
}`))}function _H(t,e){return e.overlays.length===0?null:t.identifier===Cc.Material&&t.output===k.Color?e.overlays[Ki.INNER].getColorTextureNoRasterImage():t.identifier===Cc.Material&&t.output===k.ObjectAndLayerIdColor?e.overlays[Ki.INNER].getColorTexture(Ll.ObjectAndLayerIdColor):t.identifier===Cc.Highlight?e.overlays[Ki.INNER].getValidTexture(fs.Highlight):null}function kft(t,e){for(const r of e.overlays){const{index:i,extent:s}=r;upe(s)>0&&(dS[2*i]=t.toMapSpace[0]/xu(s)-s[0]/xu(s),dS[2*i+1]=t.toMapSpace[1]/fp(s)-s[1]/fp(s))}return dS}function Vft(t,e){for(const r of e.overlays){const{index:i,extent:s}=r;upe(s)>0&&(dS[2*i]=t.toMapSpace[2]/xu(s),dS[2*i+1]=t.toMapSpace[3]/fp(s))}return dS}(function(t){t[t.Disabled=0]="Disabled",t[t.Enabled=1]="Enabled",t[t.EnabledWithWater=2]="EnabledWithWater",t[t.COUNT=3]="COUNT"})(Wg||(Wg={}));const dS=sr();var zf;(function(t){t[t.LayerOnly=0]="LayerOnly",t[t.ColorComposite=1]="ColorComposite",t[t.GridComposite=2]="GridComposite",t[t.COUNT=3]="COUNT"})(zf||(zf={}));let Bft=class extends pi{constructor(){super(...arguments),this.overlayOpacity=1}};function KC(t,e){t.vertex.uniforms.add([new qF("overlayTexOffset"),new qF("overlayTexScale")]),t.fragment.uniforms.add([new Pe("overlayOpacity",r=>r.overlayOpacity),new Mt("ovColorTex",(r,i)=>i.overlays.length===0?null:i.overlays[Ki.INNER].getColorTexture(r.overlaySource))]),lEe(t,e)}function zft(t,e){const{vertex:r,fragment:i,varyings:s}=t;s.add("vtc","vec2"),r.uniforms.add(new qF("texOffsetAndScale")),i.uniforms.add(new jae("tex")),i.uniforms.add(new tk("textureOpacities"));const n=e.textureFadingEnabled&&!e.renderOccluded;n&&(r.uniforms.add(new qF("nextTexOffsetAndScale")),s.add("nvtc","vec2"),i.uniforms.add(new jae("texNext")),i.uniforms.add(new tk("nextTexOpacities")),i.uniforms.add(new Gft("fadeFactor")));const o=e.tileBlendInput===zf.ColorComposite,a=e.tileBlendInput===zf.GridComposite;a&&i.include(uJ),o&&i.uniforms.add(new tk("backgroundColor")),r.code.add(w`
  void forwardTextureCoordinatesWithTransform(in vec2 uv) {
    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;
    ${n?w`nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;`:w``}
  }`),i.code.add(w`
    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
      ${a||o?w`
              if (opacities.y <= 0.0) {
                return color * opacities.z * opacities.x;
              }
              vec4 bg = vec4(${o?w`backgroundColor`:w`gridColor(uv)`} * opacities.y, opacities.y);
              vec4 layer = color * opacities.z;
              return (bg * (1.0 - layer.a) + layer) * opacities.x;`:w`return color;`}
    }`),n?i.code.add(w`vec4 getTileColor() {
vec4 color = getColor(texture2D(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture2D(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):i.code.add(w`vec4 getTileColor() {
return getColor(texture2D(tex, vtc), vtc, textureOpacities);
}`)}let Gft=class extends ws{constructor(e){super(e,"float")}},tk=class extends ws{constructor(e){super(e,"vec3")}},qF=class extends ws{constructor(e){super(e,"vec4")}},jae=class extends ws{constructor(e){super(e,"sampler2D")}},cEe=class extends Bft{};function jft(t){const e=new Dr,{vertex:r,fragment:i,varyings:s}=e;e.include(CM),e.include(UM,t),e.include(Zf,t);const n=()=>{e.include(OO,t),r.code.add(w`
      vec3 decodeNormalTerrain(vec2 e) {
        float z = 1.0 - abs(e.x) - abs(e.y);
        vec3 n = vec3(e + vec2(e.x >= 0.0 ? 1.0 : -1.0, e.y >= 0.0 ? 1.0 : -1.0) * min(z,0.0),z);
        return normalize(n);
      }

      vec3 getNormal() {
        return  ${t.shading?w`decodeNormalTerrain(normalCompressed)`:w`getLocalUp(position, localOrigin)`};
      }
  `)};$c(r,t),e.include(Bl,t);const o=t.overlayMode!==Wg.Disabled;switch(t.output){case k.Color:{e.include(zft,t),e.include(Uw,t),o&&e.include(KC,{...t,pbrMode:t.pbrMode===dt.Terrain?dt.TerrainWithWater:dt.Water});const a=t.overlayMode===Wg.EnabledWithWater;a&&e.include(Lft,t),s.add("vnormal","vec3"),s.add("vpos","vec3"),s.add("vup","vec3"),n(),(t.atmosphere||t.screenSizePerspective)&&nE(r);const l=t.receiveShadows&&!t.renderOccluded;l&&e.include(VE,t),t.atmosphere&&s.add("wnormal","vec3"),t.screenSizePerspective&&(s.add("screenSizeDistanceToCamera","float"),s.add("screenSizeCosAngle","float")),r.code.add(w`
        void main(void) {
          //Position
          vpos = position;
          vec3 positionWorld = position + localOrigin;
          gl_Position = transformPosition(proj, view, vpos);

          //Normal
          vnormal = getNormal();

          //Up
          vup = getLocalUp(position, localOrigin);

          ${a?w`forwardVertexTangent(vnormal);`:w``}

          ${t.atmosphere?w`wnormal = normalize((viewNormal * vec4(normalize(positionWorld), 1.0)).xyz);`:""}

          //Texture UV
          vec2 uv = getUV0();
          forwardTextureCoordinatesWithTransform(uv);
          ${o?w`setOverlayVTC(uv);`:""}
          ${t.tileBorders?w`forwardTextureCoordinates();`:""}

          ${t.screenSizePerspective?w`
          vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
          screenSizeDistanceToCamera = length(viewPos);
          vec3 viewSpaceNormal = (viewNormal * vec4(normalize(positionWorld), 1.0)).xyz;
          screenSizeCosAngle = abs(viewSpaceNormal.z);`:""}

          ${l?w`forwardLinearDepth();`:""}

        }
      `),e.extensions.add("GL_OES_standard_derivatives"),e.extensions.add("GL_EXT_shader_texture_lod"),e.include(Xs,t),e.include(Uw,t),e.include(VM,t),e.include(Fw,t),bp(i,t),BM(i),YE(i),i.uniforms.add([r.uniforms.get("localOrigin"),new qt("viewDirection",(c,h)=>_e(Hae,ce(Hae,h.camera.viewMatrix[12],h.camera.viewMatrix[13],h.camera.viewMatrix[14])))]),a&&i.uniforms.add([new Mt("ovWaterTex",(c,h)=>h.overlays.length===0?null:h.overlays[Ki.INNER].getNormalTexture(c.overlaySource)),new jwe("view",(c,h)=>ql(Hft,h.camera.viewMatrix,c.origin))]),i.code.add(w`const float sliceOpacity = 0.2;
float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),dy(i),vm(i),i.code.add(w`
        void main() {
          vec3 normal = normalize(vnormal);
          float vndl = dot(normal, mainLightDirection);

          float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));
          float shadow = ${t.receiveShadows&&!t.renderOccluded?"readShadowMap(vpos, linearDepth)":t.spherical&&t.shading?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

          float ssao = evaluateAmbientOcclusionInverse();
          vec4 tileColor = getTileColor();

          ${o?w`
              vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
              vec4 overlayColor = overlayOpacity * overlayColorOpaque;
              ${t.invisible?w`if (overlayColor.a == 0.0) { discard; }`:""}
              vec4 groundColor = tileColor;
              tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`:""}

          // If combined alpha is 0 we can discard pixel. The performance impact by having a discard here
          // is neglectable because terrain typically renders first into the framebuffer.
          if(tileColor.a <= 0.0) {
            discard;
          }

          bool sliced = rejectBySlice(vpos);
          if (sliced) {
            tileColor *= sliceOpacity;
          }
          ${t.atmosphere?w`
              float ndotl = clamp(vndl, 0.0, 1.0);
              vec3 atm = vec3(clamp(1.0 - dot(-viewDirection, wnormal), 0.0, 1.0));
              atm *= clamp(1.0 - lum(tileColor.rgb) * 1.5, 0.0, 1.0); // avoid atmosphere on bright base maps
              atm *= clamp(ndotl * 2.0, 0.0, 1.0); // avoid atmosphere on dark side of the globe
              atm *= tileColor.a; // premultiply with tile alpha`:""}

          vec3 albedo = ${t.atmosphere?w`atm + tileColor.rgb;`:w`tileColor.rgb;`}

          // heuristic shading function used in the old terrain, now used to add ambient lighting

          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

          ${t.pbrMode===dt.Terrain||t.pbrMode===dt.TerrainWithWater?w`gl_FragColor = vec4(evaluateTerrainLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight, normalize(vpos - cameraPosition), vup), tileColor.a);`:w`gl_FragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);`}
          ${a?w`
              vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
              float waterNormalLength = length(overlayWaterMask);
              if (waterNormalLength > 0.95) {
                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
                vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
                vec4 viewPosition = view*vec4(vpos, 1.0);
                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + localOrigin);
                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                float opacity = sliced ? sliceOpacity : 1.0;
                // un-gamma the ground color to mix in linear space
                gl_FragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w) * opacity;
              }`:""}
          ${t.screenSizePerspective?w`
            float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, vec4(0.0, 0.0, 0.0, 0.0));
            if (perspectiveScale <= 0.25) {
              gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
            }
            else if (perspectiveScale <= 0.5) {
              gl_FragColor = mix(gl_FragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
            }
            else if (perspectiveScale >= 0.99) {
              gl_FragColor = mix(gl_FragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
            }
            else {
              gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
            }`:""}
          ${t.visualizeNormals?t.spherical?w`
                  vec3 localUp = normalize(vpos + localOrigin);
                  vec3 right = normalize(cross(vec3(0.0, 0.0, 1.0), localUp));
                  vec3 forward = normalize(cross(localUp, right));
                  mat3 tbn = mat3(right, forward, localUp);
                  vec3 tNormal = normalize(normal * tbn);
                  gl_FragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);
              `:w`
                  vec3 tNormal = normalize(normal);
                  gl_FragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);
              `:""}
          ${t.tileBorders?w`
              vec2 dVuv = fwidth(vuv0);
              vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv0, 1.0 - vuv0));
              float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
              gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`:""}
          gl_FragColor = highlightSlice(gl_FragColor, vpos);
        }
      `)}break;case k.Depth:o&&e.include(KC,t),e.include(ny,t),iv(e),Pw(e),r.code.add(w`
              void main(void) {
                ${o?w`setOverlayVTC(getUV0());`:""}
                gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);
              }
          `),i.code.add(w`
              void main() {
                ${o&&t.invisible?w`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
                outputDepth(linearDepth);
              }
          `);break;case k.Shadow:case k.ShadowHighlight:case k.ShadowExcludeHighlight:e.include(ny,t),iv(e),Pw(e),r.code.add(w`void main(void) {
gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);
}`),i.code.add(w`void main() {
outputDepth(linearDepth);
}`);break;case k.Normal:o&&e.include(KC,t),s.add("vnormal","vec3"),nE(r),n(),r.code.add(w`
            void main(void) {
              ${o?w`setOverlayVTC(getUV0());`:""}
              gl_Position = transformPosition(proj, view, position);
              vnormal = normalize((viewNormal * vec4(getNormal(), 1.0)).xyz);
            }
        `),i.code.add(w`
            void main() {
              ${o&&t.invisible?w`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
              vec3 normal = normalize(vnormal);
              if (gl_FrontFacing == false) {
                normal = -normal;
              }
              gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 0.0);
            }
        `);break;case k.Highlight:o&&e.include(KC,t),r.code.add(w`
          void main() {
            ${o?w`setOverlayVTC(getUV0());`:""}
            gl_Position = transformPosition(proj, view, position);
          }
        `),e.include(by,t),i.code.add(w`
          void main() {
            ${o?w`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
            outputHighlight();
          }
        `)}return t.output===k.ObjectAndLayerIdColor&&(e.include(KC,{...t,pbrMode:dt.Disabled}),r.code.add(w`void main(void) {
gl_Position = transformPosition(proj, view, position);
setOverlayVTC(getUV0());
}`),i.code.add(w`void main() {
gl_FragColor = getOverlayColorTexel(vtcOverlay);
}`)),e}const Hft=Ie(),Hae=M(),qft=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:cEe,build:jft},Symbol.toStringTag,{value:"Module"}));let uEe=class hEe extends Vr{constructor(){super(...arguments),this.useStencil=!1}initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===vt.WEBGL2,r.spherical=e.viewingMode===Be.Global}initializeProgram(e){return new Fr(e.rctx,hEe.shader.get().build(this.configuration),dEe)}initializePipeline(){return this._stencilPipelineState=this._createPipeline(!0),this._createPipeline(!1)}_createPipeline(e){const r=this.configuration,i=r.backfaceCullingEnabled&&!r.renderOccluded;return Bt({blending:r.renderOccluded?Tp(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA):null,culling:i?tY:null,depthTest:r.renderOccluded?null:{func:Mi.LESS},depthWrite:r.renderOccluded?null:Xl,colorWrite:Kt,stencilTest:e?Yst(zl.IntegratedMeshMaskExcluded):null})}getPipelineState(e,r){return this.useStencil?this._stencilPipelineState:super.getPipelineState(e,r)}};uEe.shader=new Nr(qft,()=>te(()=>import("./Terrain.glsl-a6607208.js"),[]));const dEe=new Map([[A.POSITION,0],[A.UV0,1],[A.NORMALCOMPRESSED,2]]);let Wft=class{constructor(){this.geometryInfo=new Gpt,this.intersectionData=null,this.geometryState=null,this._textureRef=new QSe(()=>this.tile.surface.textureFadeDuration),this.overlay=new $ft,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._numVerticesPerSideChanged=!1,this._samplerDataChanged=!1,this._clippingAreaChanged=!1,this._wireframeChanged=!1,this._shadingChanged=!1,this._dirtyEdgeResolutions=15,this._dirtyEdges=15,this._dirtyCorners=15}get tile(){return this._tile}init(e){this.clear(),this._tile=e;const r=this.geometryInfo;r.indices=null,r.vertexAttributes=null,Ri(r.boundingBox),r.indexCount=0,r.numVerticesPerSide=0,this.intersectionData=null,this.geometryState=new Zpt,this.localOrigin=null,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}updateGeometryIfNeeded(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this._wireframeChanged||this._shadingChanged||this._clippingAreaChanged||this._samplerDataChanged||this._numVerticesPerSideChanged||this._dirtyCorners||this._dirtyEdgeResolutions||this._dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),xn&&this.tile.intersectsClippingArea)for(let r=0;r<4;++r)Re(this.geometryInfo.outerEdges[r].count===this.geometryState.neighborData.edgeResolutions[r]+1)}_calculateEdgeResolution(e,r){var l;const i=this.tile,s=this.geometryState.numVerticesPerSide-1;if(!i.surface.isGlobal){const c=i.surface.extent;if(v(c)&&(e===0&&i.extent[3]>c[3]||e===1&&i.extent[2]>c[2]||e===2&&i.extent[1]<c[1]||e===3&&i.extent[0]<c[0]))return s}const n=i.level,o=Bf[e];if(!r)return Re(C((l=i.surface)==null?void 0:l.rootTiles)||i.surface.updatingRootTiles||!i.shouldHaveNeighbor(o)),s;if(r.isLoaded){const c=r,h=c.renderData.geometryState,p=n-c.level;if(Re(p>=0),p===0){const y=h.numVerticesPerSide-1;return Math.max(y,s)}const f=2**p,m=h.neighborData.edgeResolutions[(e+2)%4]/f;return Math.max(1,m)}Re(!r.isLeaf);let a=s;return r.forAllSubtreeOnSide(GF(o),c=>c===i||(c.isLoaded?(a=Math.max(a,2**(c.level-n)),!0):(Re(!c.isLeaf),!1))),a}updateNeighborData(){var a;const e=this.tile;if(!e.intersectsClippingArea)return;const r=e.renderData.geometryState.neighborData,i=l=>(l.isLoaded||l.level===e.level)&&(l==null?void 0:l.intersectsClippingArea),s=r.edgePeerNeighbors,n=r.edgePeerNeighborSamplerVersions;for(let l=0;l<4;++l){const c=e.findNeighborTile(Bf[l],i),h=Rb(e,c),p=((a=h==null?void 0:h.renderData)==null?void 0:a.geometryState.samplerDataVersion)??-1,f=s[l],m=h!==Rb(e,f),y=n[l]!==p;s[l]=c,(m||y)&&(n[l]=p,this._markEdgeDirty(l));const _=r.edgeResolutions[l],b=this._calculateEdgeResolution(l,c);Re(dp(b)),Re(b>=1),r.edgeResolutions[l]=b,_!==b&&this._markEdgeResolutionDirty(l)}const o=r.cornerPeerNeighbors;for(let l=0;l<4;++l){const c=e.findNeighborTile(jF[l],i);o[l]=c;const h=Rb(e,s[l]),p=Rb(e,s[(l+1)%4]),f=Rb(e,c);ud[l]=f,ud[(l+1)%4]=p,ud[(l+2)%4]=e,ud[(l+3)%4]=h,Re(ud.some(b=>(b==null?void 0:b.isLoaded)||b===e));const m=ud.reduce((b,x)=>Math.min(b,(x==null?void 0:x.level)??1/0),1/0);ud.forEach((b,x)=>{b&&(b==null?void 0:b.level)>m&&(ud[x]=null)}),Re(ud.some(b=>(b==null?void 0:b.isLoaded)||b===e));const y=r.cornerNeighborData[l].cornerTiles,_=r.cornerNeighborData[l].cornerTileSamplerVersions;for(let b=0;b<4;++b){const x=ud[b],T=(x==null?void 0:x.renderData.geometryState.samplerDataVersion)??-1,S=y[b]!==x,E=!S&&_[b]!==T;(S||E)&&(y[b]=x,_[b]=T,this._markCornerDirty(l))}Re(y.some(b=>(b==null?void 0:b.isLoaded)||b===e))}xn&&Re(this.geometryState.neighborData.edgeResolutions.every(l=>l>0));for(let l=0;l<4;++l)ud[l]=null}_updateGeometry(e){if(!this.tile.intersectsClippingArea)return;xn&&Re(!this.tile.intersectsClippingArea||this.geometryState.neighborData.edgeResolutions.every(l=>l>0)),this.intersectionData=null;const r=this.tile,i=this._vao,s=this.geometryInfo.vertexAttributes,n=!i||!s||this._wireframeChanged||this._shadingChanged||this._numVerticesPerSideChanged||this._samplerDataChanged||this._clippingAreaChanged||this._dirtyEdgeResolutions,o=!n&&(this._dirtyEdges!==0||this._dirtyEdgeResolutions!==0),a=!o&&this._dirtyCorners!==0;n?(this.releaseGeometry(),this._createGeometry(e)):o||a?r.updateEdgeElevations():a?r.updateCornerElevations():console.warn("Update for no reason?"),this._numVerticesPerSideChanged=!1,this._samplerDataChanged=!1,this._dirtyEdgeResolutions=0,this._dirtyEdges=0,this._dirtyCorners=0,this._clippingAreaChanged=!1,this._wireframeChanged=!1,this._shadingChanged=!1}get hasGeometry(){return this._hasGeometry}releaseGeometry(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao.dispose(),this._vao=null,qpt(this.geometryInfo),!0)}ensureTexture(e,r){return v(this._texture)&&this._texture.descriptor.width!==e&&this.releaseTexture(),C(this._texture)&&(this._texture=r(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){v(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}_markCornerDirty(e){const r=1<<e;this._dirtyCorners|=r}_markEdgeDirty(e){const r=1<<e;this._dirtyEdges|=r}_markEdgeResolutionDirty(e){const r=1<<e;this._dirtyEdgeResolutions|=r,this._dirtyEdges|=r}_markAllEdgesAndCornersDirty(){this._dirtyCorners=15,this._dirtyEdges=15,this._dirtyEdgeResolutions=15}updateGeometryState(){const e=this._getElevationInfo(),r=this.tile,i=e.samplerData?r.getElevationVerticesPerSide(e.maxTileLevel):r.getDefaultVerticesPerSide(),s=Math.max(i,5);let n=r.clippingArea;r.intersectsClippingArea&&!r.isWithinClippingArea||(n=null);const o=this.geometryState;let a=!1;o.numVerticesPerSide!==s&&(this._numVerticesPerSideChanged=!0,o.numVerticesPerSide=s,o.samplerDataVersion++,a=!0),e.changed&&(this._samplerDataChanged=!0,o.samplerData=e.samplerData,o.samplerDataVersion++,a=!0),Xg(o.clippingArea,n)||(this._clippingAreaChanged=!0,o.clippingArea=n,a=!0);const l=r.surface,c=l.wireframe;o.wireframe!==c&&(this._wireframeChanged=!0,o.wireframe=c,a=!0);const h=l.shading;return o.shading!==h&&(this._shadingChanged=h,o.shading=h,a=h),this._geometryStateChangedSinceLastUpdate||(this._geometryStateChangedSinceLastUpdate=a),a&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}_createGeometry(e){this.tile.createGeometry();const r=this.geometryInfo.vertexAttributes,i=this.geometryInfo.indices,s=e.gl;this._vao=new Sp(e,dEe,{geometry:Vc(r.layout)},{geometry:jr.createVertex(e,s.STATIC_DRAW,r.buffer)},jr.createIndex(e,s.STATIC_DRAW,i)),this._hasGeometry=!0}get vao(){return this._vao}setTextureReference(e,r=Hg.Immediate){v(e)&&e.texture!==this._texture&&this.releaseTexture(),this._textureRef.push(e,r)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const e=this.geometryState.samplerData,r=this.tile.layerInfo[dr.ELEVATION],i=r.length,s=new Array(i);let n=0,o=0,a=!1;for(let h=0;h<i;h++){const p=r[h];if(v(p.upsampleInfo)){const f=p.upsampleInfo.tile,m=f.layerInfo[dr.ELEVATION][h].data,y=m&&m.samplerData;e&&e[n]===y||(a=!0),s[n++]=y,o=Math.max(o,f.lij[0])}else if(p.data){const f=this.tile.surface.layerViewByIndex(h,dr.ELEVATION);if(AR(this.tile,f.layer,!1)){const m=p.data;e&&e[n]===m.samplerData||(a=!0),s[n++]=m.samplerData,o=this.tile.level}}}v(e)&&e.length!==n&&(a=!0);const l=n>0,c=l?s:null;return l&&(s.length=n),{changed:a,samplerData:c,maxTileLevel:o}}get estimatedGeometryMemoryUsage(){var r,i;const e=_u(this.intersectionData,0,s=>s.estimatedMemoryUsage);return(((r=this.geometryInfo.indices)==null?void 0:r.byteLength)??0)+(((i=this.geometryInfo.vertexAttributes)==null?void 0:i.byteLength)??0)+e}get textureDescriptor(){return v(this._texture)?this._texture.descriptor:null}get test(){return{hasTexture:this._texture!=null}}checkGeometryWaterproofness(){if(!xn)return;const e=this.tile;if(Re(e==null?void 0:e.isLoaded),!e.isLoaded||!e.intersectsClippingArea)return;const r=e.renderData;if(e.level===0)return;const i=e.surface.extent;if(v(i)&&!e.intersectsExtent(i))return;const s=Bf.map((l,c)=>!!v(i)&&(c<2?-1:1)*(e.extent[3-c]-i[3-c])<0),n=e.level;Re(this._dirtyCorners===0),Re(this._dirtyEdges===0),Re(this._dirtyEdgeResolutions===0),Re(!this._numVerticesPerSideChanged),Re(!this._samplerDataChanged),Re(!this._clippingAreaChanged),Re(!this._wireframeChanged);const o=jF.map(l=>e.findNeighborCornerTileExact(l,c=>!c.intersectsClippingArea||c.isLoaded||c.level===e.level)??null).map(l=>l!=null&&l.intersectsClippingArea?l:null),a=this.geometryState.neighborData;for(let l=0;l<4;++l){const c=a.cornerPeerNeighbors[l],h=o[l];Re(h===c,`Tile[${e.lij}].corner[${l}] out of date: cur=[${c==null?void 0:c.lij}] exp=[${h==null?void 0:h.lij}]`)}Bf.forEach((l,c)=>{if(s[c])return;const h=e.findNeighborTile(l,N=>(N.level===n||(N==null?void 0:N.isLoaded))&&(N==null?void 0:N.intersectsClippingArea));if(!h){const N=!e.surface.updatingRootTiles&&v(e.surface.rootTiles)&&e.surface.rootTiles.length>0&&e.shouldHaveNeighbor(l);return void Re(!N)}Re(h.isLoaded||h.level===e.level),Re(h===this.geometryState.neighborData.edgePeerNeighbors[c]);const p=n-h.level;if(!h.isLoaded)return Re(!h.isLeaf),void Re(p===0);const f=h.renderData;Re(Ift(e,h,l)),Re(p>=0);const m=2**p;if(p<0)return void Re(!1);const y=r.geometryInfo,_=y.outerEdges[c],b=y.numVerticesPerSide-1,x=f.geometryInfo;if(!x)return void Re(!1);{const N=this.geometryState.neighborData.edgePeerNeighbors[c];if(N!=null&&N.isLoaded){const F=N.renderData;Re(N==N),Re(r.geometryState.neighborData.edgePeerNeighborSamplerVersions[c]===F.geometryState.samplerDataVersion),Re(this.geometryState.neighborData.edgePeerNeighborSamplerVersions[c]===F.geometryState.samplerDataVersion)}}const T=(c+2)%4,S=x.outerEdges[T],E=_.count-1,O=S.count-1;Re(E*m===O,`Tile[${e.lij}]:e${c},res=${E} edgeRes mismatch with Neighbor[${h.lij}]:e${T},res=${O} (expected:${E*m})`);const R=e.extent,L=l===At.NORTH||l===At.SOUTH,P=S.count-1,U=P/2**p,B=_.count-1;if(U<1)return void Re(B===1);Re(U===B),Re(dp(U));const z=x.numVerticesPerSide-1;Re(p>0||U===Math.max(z,b));const G=e.getNeighborEdgeStartVertexIndex(c,h);Re(0<=G&&G<m);const K=G*U;Re(0<=K&&K<=P-U);let ee=0,Q=K;_.getVertexPos(Gp,0),_.getVertexPos(jp,_.count-1);const H=xi(Gp,jp),$=Math.max(Xft,1e-4*H);for(let N=0;N<=U;++N){_.getVertexPos(Gp,ee),S.getVertexPos(jp,Q);const F=N/U,j=L?R[0]+F*(R[2]-R[0]):l===At.WEST?R[0]:R[2],X=L?l===At.SOUTH?R[1]:R[3]:R[1]+F*(R[3]-R[1]),J=e.surface.extent;if(C(J)||w4(J,j,X)){const W=KO(Gp,jp),ue=mc(Gp)-wr.radius,pe=mc(jp)-wr.radius,we=W<$;if(!we){console.warn(`Tile edge vertex position mismatch: between [${e.lij}].edge${c}[${ee}/${_.count}] and [${h.lij}].edge${T}[${Q}/${S.count}]`),v(J)&&console.warn("  surface extent= ",J," x,y=",j,",",X);const Ce=M();me(Ce,r.localOrigin,f.localOrigin),mc(Ce)>0&&console.warn(`   localOrigins: ${r.localOrigin} vs ${f.localOrigin} d=${mc(Ce)} [${Ce}]`),(()=>{const Ge=ms(Gp),Le=ms(jp);e.updateEdgeElevations(),h.updateEdgeElevations(),_.getVertexPos(Gp,ee),S.getVertexPos(jp,Q);const xe=M();to(xe,Gp,Ge),mc(xe)>0&&console.warn(`  XXX Tile[${e.lij}] edge out of date: ${Ge} vs ${Gp} d=${mc(xe)} [${xe}]`),to(xe,jp,Le),mc(xe)>0&&console.warn(`  XXX Neighbor[${h.lij}] edge out of date: ${Le} vs ${jp} d=${mc(xe)} [${xe}]`)})(),Re(we,`Mismatch in tile [${e.lij}].edge[${c}][${ee}/${_.count}] vs neighbor [${h.lij}].edge[${T}][${Q}/${S.count}] ${Gm(Gp)} vs ${Gm(jp)}  dist=${W} h(t|n|d)=${ue}|${pe}|${pe-ue}`)}if(e.surface.shading){_.getNormal(Kx,ee),S.getNormal(Qx,Q),_e(qae,Kx),_e(Wae,Qx);const Ce=ye(qae,Wae),Ge=1-Ce<.01||!1||e===h;if(!Ge){const Le=M();to(Le,Kx,Qx);const xe=()=>`Mismatch in tile edge normal ${Tae(e.lij)} (${ee}/${_.count-1}) edge ${c} vs neighbor ${Tae(h.lij)}  (${Q}/${S.count-1}) nedge ${T} :${Gm(Kx)} vs ${Gm(Qx)}  dot = ${Ce} : ${Gm(Le)}`;console.warn("Mismatch in tile edge normal: ",xe());{e.updateEdgeElevations(),h.updateEdgeElevations();const De=M(),Ue=M();_.getNormal(De,ee),S.getNormal(Ue,Q),q_(Kx,De)||console.warn("Missing update in tile normal: ",Gm(Kx)," => ",Gm(De)),q_(Qx,Ue)||console.warn("Missing update in neighbor normal: ",Gm(Qx)," => ",Gm(Ue))}Re(Ge,xe())}}}ee+=1,Q+=1}})}};const Gp=M(),jp=M(),Kx=M(),Qx=M(),qae=M(),Wae=M(),Xft=1,ud=[null,null,null,null];function Rb(t,e){return e!=null&&e.isLoaded||e===t?e:null}const Yft=65536;function Zft(t,e){const r=t.tile,{extent:i,extentInRadians:s,surface:n}=r,o=t.localOrigin,a=t.geometryState,l=n.isWebMercator,c=n.shading||Vw,h=a.numVerticesPerSide,p=h-1,f=(h-2)**2,m=l&&(e===Th.HAS_SOUTH_POLE||e===Th.HAS_BOTH_POLES),y=l&&(e===Th.HAS_NORTH_POLE||e===Th.HAS_BOTH_POLES),_=6,b=((m?1:0)+(y?1:0))*_*(p+1),x=a.neighborData,T=x.edgeResolutions.reduce((P,U)=>P+U+1,0),S=KSe(f+b+T),E=t.geometryInfo;E.numVerticesPerSide=a.numVerticesPerSide,E.vertexAttributes=S;const O=E.boundingBox;Ri(O);const R=mJ(t);rn.update(p,s,R),Jft(t),wEe(t,f),pEe(t);const L=[];if((()=>{let P=f+T;const U=o[0],B=o[1],z=o[2],G=r.ellipsoid.radius,K=i[1],ee=i[3],Q=(H,$)=>{const N=$*h;Ka(-U,-B,H*G-z,O),L.push({connectedRowOffset:N,connectedOuterEdgeOffset:H===1?0:2,rowOffset:P,latitudeResolution:_});const F=gEe(H===-1?K:ee,G),j=H*Math.PI/2-F,X=.99*(H===1?1:-1),J=G+0,W=S.position,ue=S.uv0,pe=S.normalCompressed;for(let we=1;we<=_;++we){const Ce=F+j*(we/_),Ge=Math.cos(Ce),Le=Math.sin(Ce);for(let xe=0;xe<=p;xe++){const De=xe/p,Ue=rn.sinLonLUT[xe],wt=rn.cosLonLUT[xe]*Ge,Ke=Ue*Ge,Ut=Le,Wt=wt*J-U,Qt=Ke*J-B,Xt=Ut*J-z;Ka(Wt,Qt,Xt,O),W.setValues(P,Wt,Qt,Xt),Lc(ue,P,De,X),c&&NO(pe,P,wt,Ke,Ut),++P}}};m&&Q(-1,0),y&&Q(1,p)})(),bEe(E,a.numVerticesPerSide,L,[0,h-1],[0,h-1],a.wireframe),t.intersectionData=null,xn)for(let P=0;P<4;++P)Re(E.outerEdges[P].count===x.edgeResolutions[P]+1)}function Jft(t){const e=t.tile;e.intersectsClippingArea&&(e.surface.shading||Vw?Qft(t):Kft(t))}function Kft(t){const e=t.geometryState,r=e.numVerticesPerSide,i=r-2,s=r-1,n=t.geometryInfo,o=n.vertexAttributes,a=o.position,l=o.uv0,c=t.tile,h=c.extent,p=h[0],f=h[2],m=h[1],y=h[3],_=c.ellipsoid.radius,b=e.samplerData,x=t.localOrigin,T=x[0],S=x[1],E=x[2],O=n.boundingBox,R=a.typedBuffer,L=a.typedBufferStride;let P=0;for(let U=1;U<=i;U++){const B=U/s,z=m*(1-B)+y*B,G=rn.sinLatLUT[U],K=rn.cosLatLUT[U];for(let ee=1;ee<=i;ee++){const Q=ee/s,H=p*(1-Q)+f*Q,$=rn.sinLonLUT[ee],N=rn.cosLonLUT[ee],F=_+zi(H,z,b),j=N*K*F-T,X=$*K*F-S,J=G*F-E;Ka(j,X,J,O);const W=P*L;R[W]=j,R[W+1]=X,R[W+2]=J,Lc(l,P,Q,B),++P}}}function Qft(t){const e=t.geometryState,r=e.numVerticesPerSide,i=r-2,s=r-1,n=t.geometryInfo,o=n.vertexAttributes,a=o.position,l=o.uv0,c=o.normalCompressed,h=t.tile,p=h.extent,f=p[0],m=p[2],y=p[1],_=p[3],b=h.ellipsoid.radius,x=e.samplerData,T=t.localOrigin,S=T[0],E=T[1],O=T[2],R=a.typedBuffer,L=a.typedBufferStride,P=1/s,U=n.boundingBox;let B=0;if(1<=i){const z=P,G=y*(1-z)+_*z,K=rn.sinLatLUT[1],ee=rn.cosLatLUT[1];for(let Q=1;Q<=i;Q++){const H=Q*P,$=f*(1-H)+m*H,N=rn.sinLonLUT[Q],F=rn.cosLonLUT[Q],j=b+zi($,G,x),X=j*F*ee-S,J=j*N*ee-E,W=j*K-O;Ka(X,J,W,U);const ue=(Q-1)*L;R[ue]=X,R[ue+1]=J,R[ue+2]=W,Lc(l,Q-1,H,z)}}for(let z=1;z<=i;z++){const G=z*P,K=y*(1-G)+_*G,ee=rn.sinLatLUT[z],Q=rn.cosLatLUT[z],H=z+1,$=H*P,N=y*(1-$)+_*$,F=rn.sinLatLUT[H],j=rn.cosLatLUT[H],X=rn.sinLonLUT[0],J=rn.cosLonLUT[0],W=b+zi(f,K,x);let ue=J*Q*W-S,pe=X*Q*W-E,we=ee*W-O;const Ce=B*L;let Ge=R[Ce],Le=R[Ce+1],xe=R[Ce+2];for(let De=1;De<=i;De++){const Ue=De*P,wt=f*(1-Ue)+m*Ue,Ke=rn.sinLonLUT[De],Ut=rn.cosLonLUT[De];let Wt=Ut*Q,Qt=Ke*Q,Xt=ee,gr=0,Kr=0,Er=0;{let it=0,Ye=0,at=0;if(De<i){const Or=(B+1)*L;it=R[Or],Ye=R[Or+1],at=R[Or+2]}else{const Or=rn.sinLonLUT[s],Mr=rn.cosLonLUT[s],Pr=b+zi(m,K,x);it=Mr*Q*Pr-S,Ye=Or*Q*Pr-E,at=ee*Pr-O}const ut=ue,Tt=pe,jt=we;ue=Ge,pe=Le,we=xe,Ge=it,Le=Ye,xe=at,gr=it-ut,Kr=Ye-Tt,Er=at-jt}{let it=0,Ye=0,at=0;if(z>1){const ut=(B-i)*L;it=R[ut],Ye=R[ut+1],at=R[ut+2]}else{const ut=rn.sinLatLUT[0],Tt=rn.cosLatLUT[0],jt=b+zi(wt,y,x);it=Ut*Tt*jt-S,Ye=Ke*Tt*jt-E,at=ut*jt-O}{const ut=b+zi(wt,N,x),Tt=Ut*j*ut-S,jt=Ke*j*ut-E,Or=F*ut-O;if(z<i){const Si=B+i,ir=Si*L;R[ir]=Tt,R[ir+1]=jt,R[ir+2]=Or,Ka(Tt,jt,Or,U),Lc(l,Si,Ue,$)}const Mr=it-Tt,Pr=Ye-jt,Ir=at-Or;Xt*Xt<.999&&(Wt=Er*Pr-Kr*Ir,Qt=gr*Ir-Er*Mr,Xt=Kr*Mr-gr*Pr)}}const Tr=1/Math.sqrt(Wt*Wt+Qt*Qt+Xt*Xt);NO(c,B,Wt*Tr,Qt*Tr,Xt*Tr),++B}}}function emt(t){t.tile.intersectsClippingArea&&(pEe(t),d6(t))}function tmt(t){t.tile.intersectsClippingArea&&(mEe(t),fEe(t,!0),d6(t))}function pEe(t){t.tile.intersectsClippingArea&&(mEe(t),fEe(t))}function fEe(t,e=!1){const r=t.geometryState,i=t.geometryInfo,s=r.neighborData,n=t.tile,o=n.level,a=n.extent,l=n.ellipsoid.radius,c=n.extentInRadians,h=c[0],p=c[2],f=c[1],m=c[3],y=r.samplerData,_=a[0],b=a[2],x=a[1],T=a[3],S=mJ(t),E=i.boundingBox,O=t.localOrigin,R=O[0],L=O[1],P=O[2],U=n.surface.shading||Vw,B=i.vertexAttributes,z=B.position,G=z.typedBuffer,K=z.typedBufferStride,ee=B.uv0;for(let Q=0;Q<4;++Q){const H=Q===1||Q===3,$=s.edgeResolutions[Q];Re(dp($));const N=$+1,F=Rb(n,s.edgePeerNeighbors[Q]);if(SEe(n,F,Q)){xEe(t,Q,F);continue}const j=v(F);Re(!j||F.level===n.level),Re(!j||qg(n,F)<=0);const X=F==null?void 0:F.renderData,J=X==null?void 0:X.geometryState;if(xn){const Ye=n.surface;if(!F&&Ye&&!Ye.updatingRootTiles){const at=Bf[Q],ut=n.findNeighborTile(at,Tt=>Tt.isLoaded||Tt.isLeaf||Tt.level===n.level);ut?ut.intersectsClippingArea&&(Re(!ut.isLoaded),Re(!ut.isLeaf),Re(ut.level===o)):Re(C(Ye==null?void 0:Ye.rootTiles)||!n.shouldHaveNeighbor(at))}}const W=Q===1?a[2]:a[0],ue=F==null?void 0:F.extent,pe=ue&&H?Q===1?ue[0]:ue[2]:W,we=Q===0?a[3]:a[1],Ce=Q===1?1:0,Ge=Q===0?1:0,Le=Q===1?p:h,xe=Q===0?m:f,De=Math.sin(Le),Ue=Math.cos(Le),wt=Math.sin(xe),Ke=Math.cos(xe),Ut=J==null?void 0:J.samplerData,Wt=j?(Ye,at,ut)=>.5*(zi(Ye,at,y)+zi(ut,at,Ut)):(Ye,at,ut)=>zi(Ye,at,y),Qt=i.outerEdges[Q],Xt=e&&N>3?N-3:1,gr=v(y)&&y.some(Ye=>Ye!=null),Kr=v(Ut)&&Ut.some(Ye=>Ye!=null),Er=gr||Kr,Tr=1/$,it=Qt.index0;U?(Re(!ue||Sh(ue[2]-ue[0],a[2]-a[0])),(()=>{const Ye=Q===1?-1:Q===3?1:0,at=Q===0?-1:Q===2?1:0,ut=(a[2]-a[0])*Tr,Tt=Ye*ut,jt=at*ut,Or=H?Ye*((p-h)*Tr):0,Mr=H?0:at*Tr,Pr=Ge,Ir=H?Le+Or:Le,Si=H?Math.sin(Ir):De,ir=H?Math.cos(Ir):Ue,xr=H?Le-Or:Le,yr=H?Math.sin(xr):De,xs=H?Math.cos(xr):Ue,ni=H?xe:S(Pr+Mr),qi=H?wt:Math.sin(ni),Ei=H?Ke:Math.cos(ni),Fi=H?xe:S(Pr-Mr),hs=H?wt:Math.sin(Fi),Ns=H?Ke:Math.cos(Fi);let ao=0,Vn=0,Ts=0;{const oi=0*Tr,Lo=H?W:_*(1-oi)+b*oi,ol=H?pe:Lo,he=H?x*(1-oi)+T*oi:we,gi=H?Le:h*(1-oi)+p*oi,ed=H?De:Math.sin(gi),Ko=H?Ue:Math.cos(gi),Bc=H?S(oi):xe,ht=H?Math.sin(Bc):wt,Yl=H?Math.cos(Bc):Ke,rs=l+Wt(Lo,he,ol);ao=Ko*Yl*rs,Vn=ed*Yl*rs,Ts=ht*rs}let Wi=0,Xi=0,Ss=0;{const oi=1*Tr,Lo=H?W:_*(1-oi)+b*oi,ol=H?pe:Lo,he=H?x*(1-oi)+T*oi:we,gi=H?Le:h*(1-oi)+p*oi,ed=H?De:Math.sin(gi),Ko=H?Ue:Math.cos(gi),Bc=H?S(oi):xe,ht=H?Math.sin(Bc):wt,Yl=H?Math.cos(Bc):Ke,rs=l+Wt(Lo,he,ol);Wi=Ko*Yl*rs,Xi=ed*Yl*rs,Ss=ht*rs}for(let oi=1;oi<N-1;oi+=Xt){let Lo=0,ol=0,he=0;{const Do=(oi+1)*Tr,ku=H?W:_*(1-Do)+b*Do,Vu=H?pe:ku,ai=H?x*(1-Do)+T*Do:we,Ap=H?Le:h*(1-Do)+p*Do,Am=H?De:Math.sin(Ap),nx=H?Ue:Math.cos(Ap),Ev=H?S(Do):xe,ox=H?Math.sin(Ev):wt,Cv=H?Math.cos(Ev):Ke,Ay=l+Wt(ku,ai,Vu);Lo=nx*Cv*Ay,ol=Am*Cv*Ay,he=ox*Ay}const gi=Lo,ed=ol,Ko=he,Bc=Wi,ht=Xi,Yl=Ss;Wi=gi,Xi=ed,Ss=Ko;{const Do=it+oi,ku=Do*K,Vu=Bc-R,ai=ht-L,Ap=Yl-P;G[ku]=Vu,G[ku+1]=ai,G[ku+2]=Ap,Ka(Vu,ai,Ap,E);const Am=oi*Tr;Lc(ee,Do,H?Ce:Am,H?Am:Ge)}const rs=ao,Sv=Vn,v6=Ts;ao=Bc,Vn=ht,Ts=Yl;const al=Bc,Sy=ht,Em=Yl,er=1/Math.sqrt(al*al+Sy*Sy+Em*Em),jM=Em*er;let Cm=0,Ey=0,Cy=0;if(Er&&jM*jM<.999){let Do=0,ku=0,Vu=0;{const ai=Q===0?-1:1;Do=ai*(gi-rs),ku=ai*(ed-Sv),Vu=ai*(Ko-v6)}{const ai=oi*Tr,Ap=H?W:_*(1-ai)+b*ai,Am=H?pe:Ap,nx=H?x*(1-ai)+T*ai:we,Ev=H?Le:h*(1-ai)+p*ai,ox=H?De:Math.sin(Ev),Cv=H?Ue:Math.cos(Ev),Ay=H?S(ai):xe,ll=H?Math.sin(Ay):wt,HM=H?Math.cos(Ay):Ke;let ZE=al,Y=Sy,be=Em;if(j){const Oe=l+zi(Am-Tt,nx-jt,Ut),hr=H?HM:Ns;ZE=(H?xs:Cv)*hr*Oe,Y=(H?yr:ox)*hr*Oe,be=(H?ll:hs)*Oe}{const Oe=l+zi(Ap+Tt,nx+jt,y),hr=H?HM:Ei,Bn=(H?ir:Cv)*hr*Oe,Es=(H?Si:ox)*hr*Oe,cl=(H?ll:qi)*Oe;j||(ZE=2*al-Bn,Y=2*Sy-Es,be=2*Em-cl);const Ry=Q===3?-1:1,AJ=Ry*(ZE-Bn),RJ=Ry*(Y-Es),OJ=Ry*(be-cl);Cm=Vu*RJ-ku*OJ,Ey=Do*OJ-Vu*AJ,Cy=ku*AJ-Do*RJ;const b6=1/Math.sqrt(Cm*Cm+Ey*Ey+Cy*Cy);Cm*=b6,Ey*=b6,Cy*=b6}}}else Cm=al*er,Ey=Sy*er,Cy=Em*er;Qt.setNormalFromValues(oi,Cm,Ey,Cy)}})()):(()=>{for(let Ye=1;Ye<N-1;Ye+=Xt){const at=Ye*Tr,ut=H?Ce:at,Tt=H?at:Ge,jt=H?W:_*(1-at)+b*at,Or=H?x*(1-at)+T*at:we,Mr=H?pe:jt,Pr=H?Le:h*(1-at)+p*at,Ir=H?De:Math.sin(Pr),Si=H?Ue:Math.cos(Pr),ir=H?S(at):xe,xr=H?Math.sin(ir):wt,yr=H?Math.cos(ir):Ke,xs=Wt(jt,Or,Mr),ni=l+xs,qi=Si*yr*ni-R,Ei=Ir*yr*ni-L,Fi=xr*ni-P;Ka(qi,Ei,Fi,E);const hs=it+Ye,Ns=hs*K;G[Ns]=qi,G[Ns+1]=Ei,G[Ns+2]=Fi,Lc(ee,hs,ut,Tt)}})()}}function mEe(t){TEe(t)}function gEe(t,e){return Math.PI/2-2*Math.atan(Math.exp(-t/e))}function rmt(t,e,r,i){return gEe(t*(1-i)+e*i,r)}function imt(t,e,r){return t*(1-r)+e*r}function mJ(t){const e=t.tile;if(e.surface.isWebMercator){const i=e.extent,s=e.ellipsoid.radius;return n=>rmt(i[1],i[3],s,n)}const r=e.extentInRadians;return i=>imt(r[1],r[3],i)}function smt(t,e){const r=t.tile.extent,i=t.geometryState,s=r[0],n=r[1],o=r[2]-s,a=r[3]-n,l=i.clippingArea,c=v(l)?Math.max(0,(l[0]-s)/o):0,h=v(l)?Math.max(0,(l[1]-n)/a):0,p=v(l)?Math.min(1,(l[2]-s)/o):1,f=v(l)?Math.min(1,(l[3]-n)/a):1,m=i.numVerticesPerSide,y=(m-2)**2,_=i.neighborData.edgeResolutions.reduce((S,E)=>S+E+1,0),b=KSe(y+_),x=t.geometryInfo,T=x.boundingBox;Ri(T),x.numVerticesPerSide=i.numVerticesPerSide,x.vertexAttributes=b,ti(x.uvRange,c,h,p,f),nmt(t),wEe(t,y),yEe(t),bEe(x,i.numVerticesPerSide,[],[0,m-1],[0,m-1],i.wireframe),t.intersectionData=null}function nmt(t){const e=t.tile;e.intersectsClippingArea&&(e.surface.shading?amt(t):omt(t))}function omt(t){const e=t.geometryState,r=e.samplerData,i=t.tile,s=i.surface,n=t.localOrigin,o=s.isWebMercatorOnPlateeCarree,a=e.clippingArea,l=v(a)?a:p6,c=i.extent,h=c[0],p=c[1],f=c[2],m=c[3],y=Math.max(h,l[0]),_=Math.min(f,l[2]),b=Math.max(p,l[1]),x=Math.min(m,l[3]),T=n[0],S=n[1],E=n[2],O=i.ellipsoid.radius,R=i.horizontalScale,L=gJ(o,O,R),P=e.numVerticesPerSide,U=P-1,B=P-2,z=t.geometryInfo,G=z.uvRange,K=G[0],ee=G[1],Q=G[2],H=G[3],$=z.boundingBox,N=z.vertexAttributes,F=N.position,j=N.uv0;let X=0;for(let J=1;J<=B;J++){const W=J/U,ue=ge(p*(1-W)+m*W,b,x),pe=ge(W,ee,H),we=L(ue)-S;for(let Ce=1;Ce<=B;Ce++){const Ge=Ce/U,Le=ge(h*(1-Ge)+f*Ge,y,_),xe=ge(Ge,K,Q),De=Le*R-T,Ue=zi(Le,ue,r)-E;Ka(De,we,Ue,$),F.setValues(X,De,we,Ue),Lc(j,X,xe,pe),++X}}}function amt(t){const e=t.tile,r=e.surface;if(!(r.shading||Vw))return;const i=t.geometryState,s=i.samplerData,n=t.localOrigin,o=r.isWebMercatorOnPlateeCarree,a=i.clippingArea,l=v(a)?a:p6,c=e.extent,h=c[0],p=c[1],f=c[2],m=c[3],y=Math.max(h,l[0]),_=Math.min(f,l[2]),b=Math.max(p,l[1]),x=Math.min(m,l[3]),T=e.ellipsoid.radius,S=e.horizontalScale,E=i.numVerticesPerSide,O=E-1,R=E-2,L=t.geometryInfo,P=L.vertexAttributes,U=P.position,B=P.uv0,z=P.normalCompressed,G=L.uvRange,K=G[0],ee=G[1],Q=G[2],H=G[3],$=L.boundingBox,N=n[0],F=n[1],j=n[2],X=U.typedBuffer,J=U.typedBufferStride;let W=0;const ue=ge(p,b,x),pe=o?(Math.PI/2-2*Math.atan(Math.exp(-ue/T)))*T:ue*S,we=1/O,Ce=ge(p*(1-we)+m*we,b,x);let Ge=pe,Le=o?(Math.PI/2-2*Math.atan(Math.exp(-Ce/T)))*T:Ce*S;for(let xe=1;xe<=R;xe++){const De=xe/O,Ue=ge(p*(1-De)+m*De,b,x),wt=ge(De,ee,H),Ke=Le,Ut=(xe-1)/O,Wt=ge(p*(1-Ut)+m*Ut,b,x),Qt=Ge,Xt=(xe+1)/O,gr=ge(p*(1-Xt)+m*Xt,b,x),Kr=o?(Math.PI/2-2*Math.atan(Math.exp(-gr/T)))*T:gr*S,Er=ge(Xt,ee,H);Ge=Le,Le=Kr;const Tr=ge(h,y,_);let it=Tr*S,Ye=zi(Tr,Ue,s);const at=1/O,ut=ge(at,K,Q),Tt=ge(h*(1-ut)+f*ut,y,_);let jt=ut,Or=Tt,Mr=Tt*S,Pr=zi(Tt,Ue,s);if(xe===1){const Ir=Mr-N,Si=Ge-F,ir=Pr-j,xr=0*J;X[xr]=Ir,X[xr+1]=Si,X[xr+2]=ir,Ka(Ir,Si,ir,$);const yr=ge(at,K,Q);Lc(B,W,yr,wt)}for(let Ir=1;Ir<=R;Ir++){const Si=Mr,ir=Pr,xr=(Ir+1)/O,yr=ge(xr,K,Q),xs=ge(h*(1-xr)+f*xr,y,_),ni=Or;Or=xs;{const Ts=W+1,Wi=Ts*J;if(xe===1||Ir===R){const Xi=xs*S,Ss=zi(xs,Ue,s);if(xe===1&&Ir<R){const oi=Xi-N,Lo=Ke-F,ol=Ss-j;X[Wi]=oi,X[Wi+1]=Lo,X[Wi+2]=ol,Ka(oi,Lo,ol,$),Lc(B,Ts,yr,wt)}Mr=Xi,Pr=Ss}else Mr=X[Wi]+N,Pr=X[Wi+2]+j}const qi=Mr,Ei=Pr,Fi=it,hs=Ye;it=Si,Ye=ir;const Ns=(W-R)*J,ao=xe===1?zi(ni,Wt,s):X[Ns+2]+j,Vn=zi(ni,gr,s);if(xe<R){const Ts=W+R,Wi=Ts*J,Xi=Si-N,Ss=Kr-F,oi=Vn-j;X[Wi]=Xi,X[Wi+1]=Ss,X[Wi+2]=oi,Ka(Xi,Ss,oi,$);const Lo=jt;jt=yr,Lc(B,Ts,Lo,Er)}{const Ts=qi-Fi,Wi=Qt-Kr,Xi=Wi*(Ei-hs),Ss=Ts*(ao-Vn),oi=-Wi*Ts,Lo=Xi*Xi+Ss*Ss+oi*oi;if(Lo===0)NO(z,W,0,0,1);else{const ol=1/Math.sqrt(Lo);NO(z,W,Xi*ol,Ss*ol,oi*ol)}}++W}}}function lmt(t,e){t.tile.intersectsClippingArea&&(vEe(t),_Ee(t,!0),d6(t))}function cmt(t,e){t.tile.intersectsClippingArea&&(yEe(t),d6(t))}function yEe(t,e){t.tile.intersectsClippingArea&&(vEe(t),_Ee(t,!1))}function _Ee(t,e){const r=t.geometryState,i=r.neighborData,s=t.tile,n=s.surface,o=n.shading||Vw,a=s.extent,l=r.clippingArea,c=v(l)?l:p6,h=a[0],p=a[2],f=a[1],m=a[3],y=[m>c[3],p>c[2],f<c[1],h<c[0]],_=t.geometryInfo,b=s.horizontalScale,x=gJ(n.isWebMercatorOnPlateeCarree,s.ellipsoid.radius,b),T=_.boundingBox,S=_.uvRange[0],E=_.uvRange[1],O=_.uvRange[2],R=_.uvRange[3],L=Math.max(h,c[0]),P=Math.min(p,c[2]),U=Math.max(f,c[1]),B=Math.min(m,c[3]),z=t.localOrigin,G=z[0],K=z[1],ee=z[2],Q=r.samplerData;for(let H=0;H<4;++H){const $=H===1||H===3,N=i.edgeResolutions[H];Re(dp(N));const F=N+1,j=y[H],X=Rb(s,i.edgePeerNeighbors[H]);if(!j&&SEe(s,X,H)){xEe(t,H,X);continue}const J=v(X)&&!j,W=X==null?void 0:X.renderData,ue=W==null?void 0:W.geometryState;if(xn&&(Re(!J||X.level===s.level),Re(!J||qg(s,X)<=0),s&&!X&&!n.updatingRootTiles)){const wt=Bf[H],Ke=s.findNeighborTile(wt,Ut=>Ut.isLoaded||Ut.isLeaf||Ut.level===s.level);n.updatingRootTiles||(Ke?Ke.intersectsClippingArea&&(Re(!Ke.isLoaded),Re(!Ke.isLeaf),Re(Ke.level===s.level)):Re(C(n==null?void 0:n.rootTiles)||!s.shouldHaveNeighbor(wt)))}const pe=ge(H===1?p:h,L,P),we=ge(H===0?m:f,U,B),Ce=ue==null?void 0:ue.samplerData,Ge=_.outerEdges[H],Le=e&&F>3?F-3:1,xe=ge(H===1?1:0,S,O),De=ge(H===0?1:0,E,R),Ue=J?(wt,Ke)=>.5*(zi(wt,Ke,Ce)+zi(wt,Ke,Q)):(wt,Ke)=>zi(wt,Ke,Q);if(o){const wt=(p-h)/N,Ke=$?H===1?wt:-wt:0,Ut=$?0:H===0?wt:-wt,Wt=-Ke,Qt=-Ut;let Xt=0,gr=0,Kr=0;{const Ye=0/N,at=$?pe:ge(h*(1-Ye)+p*Ye,L,P),ut=$?ge(f*(1-Ye)+m*Ye,U,B):we,Tt=Ue(at,ut);Xt=at*b,gr=x(ut),Kr=Tt}let Er=0,Tr=0,it=0;{const Ye=1/N,at=$?pe:ge(h*(1-Ye)+p*Ye,L,P),ut=$?ge(f*(1-Ye)+m*Ye,U,B):we,Tt=Ue(at,ut);Er=at*b,Tr=x(ut),it=Tt}for(let Ye=1;Ye<F-1;Ye+=Le){const at=Ye/N,ut=Er,Tt=Tr,jt=it;{const ni=$?xe:ge(at,S,O),qi=$?ge(at,E,R):De,Ei=ut-G,Fi=Tt-K,hs=jt-ee;Ka(ut,Fi,hs,T),Ge.setVertexFromValuesRawPositionUV(Ye,Ei,Fi,hs,ni,qi)}{const ni=(Ye+1)/N,qi=$?pe:ge(h*(1-ni)+p*ni,L,P),Ei=$?ge(f*(1-ni)+m*ni,U,B):we,Fi=Ue(qi,Ei);Er=qi*b,Tr=x(Ei),it=Fi}const Or=Er,Mr=it,Pr=Xt,Ir=gr,Si=Kr;Xt=ut,gr=Tt,Kr=jt;let ir=0,xr=0,yr=0;if($){const ni=Tr-Tt,qi=Mr-jt,Ei=Ir-Tt,Fi=Si-jt,hs=ge(f*(1-at)+m*at,U,B),Ns=pe+Wt,ao=Ns*b-ut,Vn=zi(Ns,hs,Q)-jt,Ts=H===3?-1:1;if(ir=Ts*(-Ei+ni)*Vn,xr=Ts*ao*(-Fi+qi),yr=-Ts*ao*(-Ei+ni),J){const Wi=pe+Ke,Xi=Wi*b-ut;ir=(-Ei+ni)*(Vn-(zi(Wi,hs,Ce)-jt)),xr=(ao-Xi)*(-Fi+qi),yr=-(ao-Xi)*(-Ei+ni)}}else{const ni=Or-ut,qi=Mr-jt,Ei=Pr-ut,Fi=Si-jt,hs=ge(h*(1-at)+p*at,L,P),Ns=we+Qt,ao=zi(hs,Ns,Q)-jt,Vn=x(Ns)-Tt,Ts=H===2?-1:1;if(ir=Ts*Vn*(-Fi+qi),xr=Ts*(-Ei+ni)*ao,yr=-Ts*Vn*(-Ei+ni),J){const Wi=hs,Xi=we+Ut,Ss=x(Xi)-Tt;ir=(-Vn+Ss)*(-Fi+qi),xr=(-Ei+ni)*(-ao+(zi(Wi,Xi,Ce)-jt)),yr=-(-Vn+Ss)*(-Ei+ni)}}const xs=1/Math.sqrt(ir*ir+xr*xr+yr*yr);Ge.setNormalFromValues(Ye,ir*xs,xr*xs,yr*xs)}}else for(let wt=1;wt<F-1;wt+=Le){const Ke=wt/N,Ut=$?pe:ge(h*(1-Ke)+p*Ke,L,P),Wt=$?ge(f*(1-Ke)+m*Ke,U,B):we,Qt=$?xe:ge(Ke,S,O),Xt=$?ge(Ke,E,R):De,gr=Ue(Ut,Wt),Kr=Ut*b-G,Er=x(Wt)-K,Tr=gr-ee;Ka(Kr,Er,Tr,T),Ge.setVertexFromValuesRawPositionUV(wt,Kr,Er,Tr,Qt,Xt)}}}function vEe(t,e){TEe(t)}function umt(t,e){return(Math.PI/2-2*Math.atan(Math.exp(-t/e)))*e}function hmt(t,e){return t*e}function gJ(t,e,r){return t?i=>umt(i,e):i=>hmt(i,r)}function bEe(t,e,r,i,s,n){const o=e-1,a=t.vertexAttributes.count,l=2*(Math.min(e-2,i[1])-Math.max(1,i[0]))*(Math.min(e-2,s[1])-Math.max(1,s[0])),c=Bf.map((S,E)=>E===0&&s[1]<e-2||E===1&&i[1]<e-2||E===2&&s[0]>1||E===3&&i[0]>1),h=t.outerEdges.reduce((S,E,O)=>S+(c[O]?0:o-2+E.count-1),0),p=r.reduce((S,E)=>S+o*(2*(E.latitudeResolution-1)+1),0),f=n?2:1,m=3*(l+h+p)*f,y=a>=Yft?new Uint32Array(m):new Uint16Array(m);let _=0;const b=e-2,x=o-2;Re(x>=0);const T=(S,E,O,R,L,P)=>{const U=S*L,B=P[U],z=P[U+1],G=P[U+2],K=E*L,ee=P[K],Q=P[K+1],H=P[K+2],$=O*L,N=P[$],F=P[$+1],j=P[$+2],X=R*L,J=P[X],W=P[X+1],ue=P[X+2];return(ee-J)*(ee-J)+(Q-W)*(Q-W)+(H-ue)*(H-ue)>(B-N)*(B-N)+(z-F)*(z-F)+(G-j)*(G-j)};if(n){const S=(O,R,L)=>{y[_++]=O,y[_++]=R,y[_++]=R,y[_++]=L,y[_++]=L,y[_++]=O,xn&&(Re(O<a),Re(R<a),Re(L<a),Re(_<=m))};(()=>{for(let O=Math.max(s[0],1)-1;O<Math.min(s[1],e-2)-1;++O){const R=O*b;for(let L=Math.max(i[0],1)-1;L<Math.min(i[1],e-2)-1;++L){const P=O*b+L,U=P+1,B=U+b,z=B-1,G=R+L,K=G+1,ee=K+b,Q=ee-1,H=t.vertexAttributes.position.typedBuffer,$=t.vertexAttributes.position.typedBufferStride;T(G,K,ee,Q,$,H)?(S(P,U,B),S(B,z,P)):(S(P,U,z),S(z,B,U))}}})(),Re(_===3*l*f),(()=>{for(let O=0;O<4;++O){const R=_;if(c[O])continue;const L=t.outerEdges[O],P=t.innerEdges[O];let U=0,B=0;const z=L.count,G=P.count;Re(G===o-1);let K=0;const ee=O===1||O===2?(Q,H,$)=>S(Q,H,$):(Q,H,$)=>S(Q,$,H);for(;U<z-1||B<G-1;){const Q=P.getVertexIndex(B),H=L.getVertexIndex(U),$=U<z-1,N=B<G-1;$&&(!N||($?0+o*(U+.5)/(z-1):0)<=(N?1+x*(B+.5)/(G-1):0))?(++U,xn&&Re(U<z),ee(Q,H,L.getVertexIndex(U)),K++):(++B,xn&&Re(B<G),ee(Q,H,P.getVertexIndex(B)),K++)}xn&&(Re(U===z-1),Re(B===G-1),Re(K===z+G-2),Re(K===o-2+L.count-1),Re(_===R+3*K*f))}})(),Re(_===3*(l+h)*f);const E=O=>{const R=t.outerEdges[O.connectedOuterEdgeOffset];let L=R.getVertexIndex(0),P=R.stride;for(let U=0;U<O.latitudeResolution;++U){const B=U===0?O.rowOffset:L+e;for(let z=0;z<o;z++)S(L,L+1,B+z),U<O.latitudeResolution-1&&S(L+1,B+z+1,B+z),L+=P;L=B,P=1}};r.forEach(E)}else{(()=>{const E=Math.max(s[0],1)-1,O=Math.min(s[1],e-2)-1,R=Math.max(i[0],1)-1,L=Math.min(i[1],e-2)-1;for(let P=E;P<O;++P){const U=P*b;for(let B=R;B<L;++B){const z=U+B,G=z+1,K=G+b,ee=K-1,Q=t.vertexAttributes.position.typedBuffer,H=t.vertexAttributes.position.typedBufferStride;T(z,G,K,ee,H,Q)?(y[_]=z,y[_+1]=G,y[_+2]=K,y[_+3]=K,y[_+4]=ee,y[_+5]=z):(y[_]=z,y[_+1]=G,y[_+2]=ee,y[_+3]=ee,y[_+4]=G,y[_+5]=K),_+=6}}})(),Re(_===3*l*f),(()=>{for(let E=0;E<4;++E){if(c[E])continue;const O=t.outerEdges[E],R=t.innerEdges[E];let L=0,P=0;const U=O.count,B=R.count;Re(B===o-1);const z=E===1||E===2,G=z?1:2,K=z?2:1,ee=O.index0,Q=O.stride,H=R.index0,$=R.stride;for(;L<U-1||P<B-1;){const N=H+P*$,F=ee+L*Q,j=L<U-1,X=P<B-1,J=j&&(!X||(j?0+o*(L+.5)/(U-1):0)<=(X?1+x*(P+.5)/(B-1):0));J?++L:++P;const W=J?F+Q:N+$;y[_]=N,y[_+G]=F,y[_+K]=W,_+=3}}})(),Re(_===3*(l+h)*f);const S=E=>{const O=t.outerEdges[E.connectedOuterEdgeOffset];let R=O.getVertexIndex(0),L=O.stride;for(let P=0;P<E.latitudeResolution;++P){const U=P===0?E.rowOffset:R+e;for(let B=0;B<o;B++){const z=U+B;y[_]=R,y[_+1]=R+1,y[_+2]=z,P<E.latitudeResolution-1?(y[_+3]=R+1,y[_+4]=z+1,y[_+5]=z,_+=6):_+=3,R+=L}R=U,L=1}};r.forEach(S)}Re(_===m),t.indices=y,t.indexCount=m}function wEe(t,e){const r=t.localOrigin,i=t.geometryInfo,s=t.geometryState.neighborData.edgeResolutions,n=i.numVerticesPerSide-2,o=i.vertexAttributes;let a=e;for(let l=0;l<4;++l){{const c=l===0||l===2,h=(l===0?n-1:0)*n+(l===1?n-1:0),p=(c?0:1)*n+(c?1:0);i.innerEdges[l]=new Lae(o,r,h,p,n)}{const c=a,h=s[l]+1;i.outerEdges[l]=new Lae(o,r,c,1,h),a+=h}}}function xEe(t,e,r){const i=(e+2)%4,s=t.geometryState,n=t.tile,o=s.neighborData,a=n.level-r.level,l=e===1||e===3,c=o.edgeResolutions[e];Re(dp(c));const h=c+1,p=t.geometryInfo,f=p.boundingBox,m=p.outerEdges[e],y=p.uvRange[0],_=p.uvRange[1],b=p.uvRange[2],x=p.uvRange[3],T=ge(e===1?1:0,y,b),S=ge(e===0?1:0,_,x),E=r.renderData,O=E.geometryState,R=E.geometryInfo.outerEdges[i],L=n.getNeighborEdgeStartVertexIndex(e,r)*c,P=c*2**a;Re(O.neighborData.edgeResolutions[i]===P),Re(R.count-1===P);const U=E.localOrigin[0]-t.localOrigin[0],B=E.localOrigin[1]-t.localOrigin[1],z=E.localOrigin[2]-t.localOrigin[2],G=m.attributes,K=m.index0,ee=m.stride,Q=G.position.typedBuffer,H=G.position.typedBufferStride,$=G.normalCompressed.typedBuffer,N=G.normalCompressed.typedBufferStride,F=G.uv0,j=R.attributes,X=R.index0,J=R.stride,W=j.position.typedBuffer,ue=j.position.typedBufferStride,pe=j.normalCompressed.typedBuffer,we=j.normalCompressed.typedBufferStride;for(let Ce=1;Ce<h-1;++Ce){const Ge=K+ee*Ce,Le=X+J*(L+Ce),xe=Ge*H,De=Le*ue,Ue=W[De]+U,wt=W[De+1]+B,Ke=W[De+2]+z;Q[xe]=Ue,Q[xe+1]=wt,Q[xe+2]=Ke,Ka(Ue,wt,Ke,f);const Ut=Ge*N,Wt=Le*we;$[Ut]=pe[Wt],$[Ut+1]=pe[Wt+1];const Qt=Ce/c,Xt=l?T:ge(Qt,y,b),gr=l?ge(Qt,_,x):S;Lc(F,Ge,Xt,gr)}}function TEe(t){var De;const e=t.geometryState,r=e.neighborData,i=t.localOrigin,s=r.cornerNeighborData,n=t.geometryInfo,o=n.outerEdges,a=n.boundingBox,l=t.tile,c=((De=t.tile.surface.view)==null?void 0:De.viewingMode)==="local",h=l.ellipsoid.radius,p=l.extentInRadians,f=l.horizontalScale;let m=0,y=0,_=0;const b=(Ue,wt,Ke)=>{const Ut=p[wt===0?1:3],Wt=p[Ue===0?0:2],Qt=Math.cos(Ut),Xt=Math.sin(Ut),gr=Math.sin(Wt),Kr=Math.cos(Wt),Er=h+Ke;m=Kr*Qt*Er,y=gr*Qt*Er,_=Xt*Er},x=c?(()=>{const Ue=t.geometryState.clippingArea,wt=l.extent,Ke=v(Ue)&&(wt[3]>Ue[3]||wt[2]>Ue[2]||wt[1]<Ue[1]||wt[0]<Ue[0]),Ut=gJ(l.surface.isWebMercatorOnPlateeCarree,l.ellipsoid.radius,f);return(Wt,Qt,Xt)=>{const gr=Wt===0?K[0]:K[2],Kr=Qt===0?K[1]:K[3],Er=Ke?ge(gr,Ue[0],Ue[2]):gr,Tr=Ke?ge(Kr,Ue[1],Ue[3]):Kr,it=Xt;m=Er*f,y=Ut(Tr),_=it}})():b;let T=0,S=0,E=0,O=0,R=0,L=0,P=0,U=0,B=0;const z=c&&t.tile.surface.isWebMercatorOnPlateeCarree,G=(Ue,wt,Ke,Ut,Wt)=>{let Qt=0,Xt=0,gr=0;if(c){const Kr=wt*f,Er=z?(Math.PI/2-2*Math.atan(Math.exp(-Ke/h)))*h:Ke*f;Qt=Kr-m,Xt=Er-y,gr=Ut-_}else{const Kr=mJ(Ue),Er=Ue.tile,Tr=Er.extent,it=Er.extentInRadians,Ye=(wt-Tr[0])/(Tr[2]-Tr[0]),at=(Ke-Tr[1])/(Tr[3]-Tr[1]),ut=it[0]*(1-Ye)+it[2]*Ye,Tt=Kr(at),jt=Math.cos(Tt),Or=Math.sin(Tt),Mr=Math.sin(ut),Pr=Math.cos(ut),Ir=h+Ut;Qt=Pr*jt*Ir-m,Xt=Mr*jt*Ir-y,gr=Or*Ir-_}switch(Wt){case 0:P+=Qt,U+=Xt,B+=gr;break;case 1:O-=Qt,R-=Xt,L-=gr;break;case 2:P-=Qt,U-=Xt,B-=gr;break;case 3:O+=Qt,R+=Xt,L+=gr}},K=l.extent,ee=e.clippingArea,Q=v(ee)?ee:p6,H=K[0],$=K[2],N=K[1],F=K[3],j=[F>Q[3],$>Q[2],N<Q[1],H<Q[0]],X=Math.max(H,Q[0]),J=Math.min($,Q[2]),W=Math.max(N,Q[1]),ue=Math.min(F,Q[3]),pe=n.uvRange[0],we=n.uvRange[1],Ce=n.uvRange[2],Ge=n.uvRange[3],Le=l.surface.shading||Vw,xe=Ue=>{var Tr;const wt=s[Ue].cornerTiles;T=0,S=0,E=1;let Ke=1/0;for(let it=0;it<4;++it)Ke=Math.min(Ke,((Tr=wt[it])==null?void 0:Tr.level)??1/0);for(let it=0;it<4;++it){const Ye=wt[it];QC[it]=(Ye==null?void 0:Ye.level)===Ke?Ye:null}let Ut=1,Wt=0;for(let it=0;it<4;++it){const Ye=QC[it];Ye&&(Ut=Math.max(Ut,Ye==null?void 0:Ye.renderData.geometryState.numVerticesPerSide),Wt=Ye.extent[2]-Ye.extent[0])}const Qt=Wt,Xt=Ut;Re(Xt>1);const gr=Qt/Xt;for(let it=0;it<4;++it){const Ye=QC[(it+3)%4],at=QC[it%4];if(!Ye&&!at)continue;const ut=it===0?1:it===1?2:it===2?3:0,Tt=it===0?2:it===1?3:it===2?0:1;if(Ye&&at){const jt=rk[it][0]*gr,Or=rk[it][1]*gr,Mr=Ye.extent,Pr=Mr[ut===0||ut===1?2:0]+jt,Ir=Mr[ut===0||ut===3?3:1]+Or,Si=at.extent,ir=Si[Tt===0||Tt===1?2:0]+jt,xr=Si[Tt===0||Tt===3?3:1]+Or,yr=Ye.renderData,xs=at.renderData,ni=zi(Pr,Ir,yr.geometryState.samplerData),qi=zi(ir,xr,xs.geometryState.samplerData);G(yr,Pr,Ir,.5*(ni+qi),it)}else{const jt=Ye??at,Or=Ye?ut:Tt,Mr=jt.extent,Pr=rk[it],Ir=Mr[Or===0||Or===1?2:0]+Pr[0]*gr,Si=Mr[Or===0||Or===3?3:1]+Pr[1]*gr,ir=jt.renderData,xr=zi(Ir,Si,ir.geometryState.samplerData);G(ir,Ir,Si,xr,it)}}if(!c){const it=Math.sqrt(m*m+y*y+_*_);T=m/it,S=y/it,E=_/it}const Kr=Math.sqrt(O*O+R*R+L*L);O/=Kr,R/=Kr,L/=Kr;const Er=Math.sqrt(P*P+U*U+B*B);if(P/=Er,U/=Er,B/=Er,c||E*E<.999){T=L*U-R*B,S=O*B-L*P,E=R*P-O*U;const it=1/Math.sqrt(T*T+S*S+E*E);T*=it,S*=it,E*=it}};for(let Ue=0;Ue<4;++Ue){const wt=Ue,Ke=(Ue+1)%4,Ut=Ue===0||Ue===1?1:0,Wt=Ue===0||Ue===3?1:0,Qt=ge(Ut,pe,Ce),Xt=ge(Wt,we,Ge),gr=o[wt],Kr=Ue===0||Ue===3?gr.count-1:0,Er=o[Ke],Tr=Ue===0||Ue===1?Er.count-1:0,it=s[Ue].cornerTiles;let Ye=-1;for(let Tt=0;Tt<4;++Tt){const jt=it[Tt];jt&&(Ye===-1||qg(it[Ye],jt)>0)&&(Ye=Tt)}const at=Ye,ut=it[at];if(T=0,S=0,E=1,ut!==l){const Tt=l.level-ut.level,jt=2**Tt,Or=[ut.lij[0]+Tt,ut.lij[1]*jt,ut.lij[2]*jt],Mr=[Or[1]+jt===l.lij[1],Ue===0&&(at===1||at===0&&ut!==it[3])||Ue===1&&(at===0||at===1&&ut!==it[2]),Or[1]===l.lij[1]+1,Ue===2&&(at===3||at===2&&ut!==it[1])||Ue===3&&(at===2||at===3&&ut!==it[0])],Pr=Mr.reduce((yr,xs)=>yr+(xs?1:0),0);Re(Pr===1||Pr===2);let Ir=-1,Si=-1;const ir=ut.renderData;if(Pr===1){const yr=Mr.findIndex(ni=>ni);Re(0<=yr&&yr<=3),Ir=(yr+2)%4;const xs=t.geometryState.neighborData.edgeResolutions[yr];Si=l.getNeighborEdgeStartVertexIndex(yr,ut)*xs+xs*(yr===0&&Ue===0||yr===1&&Ue===0||yr===2&&Ue===1||yr===3&&Ue===3?1:0)}else{Re(Mr[1]||Mr[3]),Ir=Mr[1]?3:1;const yr=ir.geometryState.neighborData.edgeResolutions[Ir];Si=Ue===0||Ue===3?0:yr}const xr=ir.geometryInfo.outerEdges[Ir];{const yr=gr.index0+Kr*gr.stride,xs=Er.index0+Tr*Er.stride,ni=xr.index0+Si*xr.stride;{const qi=xr.attributes.position,Ei=qi.typedBuffer,Fi=ni*qi.typedBufferStride,hs=t.localOrigin,Ns=xr.localOrigin,ao=Ei[Fi]+Ns[0]-hs[0],Vn=Ei[Fi+1]+Ns[1]-hs[1],Ts=Ei[Fi+2]+Ns[2]-hs[2];Ka(ao,Vn,Ts,a);{const Wi=gr.attributes.position,Xi=Wi.typedBuffer,Ss=yr*Wi.typedBufferStride;Xi[Ss]=ao,Xi[Ss+1]=Vn,Xi[Ss+2]=Ts}{const Wi=Er.attributes.position,Xi=Wi.typedBuffer,Ss=xs*Wi.typedBufferStride;Xi[Ss]=ao,Xi[Ss+1]=Vn,Xi[Ss+2]=Ts}}Lc(gr.attributes.uv0,yr,Qt,Xt),Lc(Er.attributes.uv0,xs,Qt,Xt);{const qi=xr.attributes.normalCompressed.typedBuffer,Ei=ni*xr.attributes.normalCompressed.typedBufferStride;{const Fi=gr.attributes.normalCompressed,hs=Fi.typedBuffer,Ns=yr*Fi.typedBufferStride;hs[Ns]=qi[Ei],hs[Ns+1]=qi[Ei+1]}{const Fi=Er.attributes.normalCompressed,hs=Fi.typedBuffer,Ns=xs*Fi.typedBufferStride;hs[Ns]=qi[Ei],hs[Ns+1]=qi[Ei+1]}}}}else{const Tt=j[wt],jt=j[Ke];let Or;if(Tt||jt){const Si=ge(H*(1-Ut)+$*Ut,X,J),ir=ge(N*(1-Wt)+F*Wt,W,ue),xr=e.samplerData;Or=zi(Si,ir,xr)}else Or=dmt(it);x(Ut,Wt,Or),(Le||Vw)&&xe(Ue);const Mr=m-i[0],Pr=y-i[1],Ir=_-i[2];Ka(Mr,Pr,Ir,a),gr.setVertexFromValuesRawPositionUVNormal(Kr,Mr,Pr,Ir,Qt,Xt,T,S,E),Er.setVertexFromValuesRawPositionUVNormal(Tr,Mr,Pr,Ir,Qt,Xt,T,S,E)}}for(let Ue=0;Ue<4;++Ue)QC[Ue]=null}function dmt(t){var n,o;const e=t.reduce((a,l)=>Math.min(a,(l==null?void 0:l.level)??1/0),1/0);xn&&(Re(!t[0]||!t[2]||yH(t[0],t[2],At.SOUTH_WEST)),Re(!t[1]||!t[3]||yH(t[1],t[3],At.NORTH_WEST)));let r=0,i=0;for(let a=0;a<4;++a){const l=t[a];if(l&&l.level===e){const c=a===0||a===1,h=a===0||a===3,p=l.extent,f=p[c?0:2],m=p[h?1:3],y=(o=(n=l.renderData)==null?void 0:n.geometryState)==null?void 0:o.samplerData;i+=zi(f,m,y),r++}}const s=r?i/r:0;return Re(s!=null),s}function d6(t){const e=t.vao,r=t.geometryInfo.vertexAttributes.position.typedBuffer;e.vertexBuffers.geometry.setSubData(r,0,0,r.length)}const rk=[[0,1],[1,0],[0,-1],[-1,0]],rn=new Xpt,p6=eW(-1/0,-1/0,1/0,1/0),QC=[null,null,null,null];function SEe(t,e,r){if(!e)return!1;const i=qg(t,e);return i>0||i===0&&r>=2}const Vw=!0;let pmt=class extends hJ{get horizontalScale(){return this._horizontalScaleFactor}constructor(e,r,i){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=ur(),e!==void 0&&this.init(e,r,i)}init(e,r,i){super.init(e,r,i);const s=i.view.renderSpatialReference,n=i.spatialReference,o=v(s)&&mq(s)&&v(n)&&n.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=o;const a=this.surface.isWebMercatorOnPlateeCarree,l=this._extentInRenderSR,c=this.extent;if(a){const h=$e(c[0],c[1],0);no(h,et.WebMercator,h,et.PlateCarree);const p=$e(c[2],c[3],0);no(p,et.WebMercator,p,et.PlateCarree),l[0]=h[0],l[1]=h[1],l[2]=p[0],l[3]=p[1]}else for(let h=0;h<4;++h)l[h]=c[h]*o;this.centerAtSeaLevel[0]=.5*(l[0]+l[2]),this.centerAtSeaLevel[1]=.5*(l[1]+l[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(l[2]-l[0],l[3]-l[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=this._extentInRenderSR,r=.5*(e[2]-e[0]),i=.5*(e[3]-e[1]),s=Math.sqrt(r*r+i*i),n=.5*(this.elevationBounds[0]-this.elevationBounds[1]),o=Math.max(s,n);this._center[Ks.MIDDLE][3]=o}_calculateFrustumVisibilityStatus(e){const r=this._aabb(),i=r[0],s=r[1],n=r[2],o=r[3],a=r[4],l=r[5];let c=!0;for(let h=0;h<6;h++){const p=e[h],f=p[0],m=p[1],y=p[2],_=p[3];if(f*(f>0?i:o)+m*(m>0?s:a)+y*(y>0?n:l)+_>=0)return aa.OUTSIDE;c=c&&f*(f<0?i:o)+m*(m<0?s:a)+y*(y<0?n:l)+_<=0}return c?aa.INSIDE:aa.INTERSECTS}_aabb(){const e=this._extentInRenderSR;return E$e(e[0],e[1],this.elevationBounds[0],e[2],e[3],this.elevationBounds[1])}intersectsRay(e,r,i,s){return v$[0]=1/r[0],v$[1]=1/r[1],v$[2]=1/r[2],dZ(this._aabb(),e,v$,i,s)}createGeometry(){smt(this.renderData,this._horizontalScaleFactor),this.setMemoryDirty()}getDefaultVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){lmt(this.renderData,this._horizontalScaleFactor)}updateEdgeElevations(){cmt(this.renderData,this._horizontalScaleFactor)}};const v$=M();let fmt=class{constructor(){this.extent=sr(),this.minLevel=0,this.maxLevel=0,this.callback=null}},ED=class extends Te{constructor(){super(...arguments),this._queries=new Jt({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new Jt({initialSize:30}),this._queryPool=new Co(fmt)}queryVisibleLevelRange(e,r,i,s){const n=this._queryPool.acquire();Xd(n.extent,e),n.minLevel=r??-Number.MAX_VALUE,n.maxLevel=i??Number.MAX_VALUE,n.callback=s,this._queryQueue.push(n),this.notifyChange("updating")}get updating(){return this._queryQueue.length!==0}prepare(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}process(){for(let e=0;e<this._queries.length;e++){const r=this._queries.data[e];this._queryPool.release(r),r.callback(e>=this._queriesInvPtr),r.callback=null}this._queries.clear(),this.notifyChange("updating")}queriesForTile(e){const r=e.level;let i=0;for(;i<this._queriesInvPtr;){const s=this._queries.data[i],n=s.extent;r>=s.minLevel&&r<=s.maxLevel&&n[0]<=e.extent[2]&&n[2]>=e.extent[0]&&n[1]<=e.extent[3]&&n[3]>=e.extent[1]?(this._queries.swapElements(i,this._queriesInvPtr-1),this._queriesInvPtr--):i++}}};u([d()],ED.prototype,"updating",null),ED=u([I("esri.views.3d.terrain.ScaleRangeQueries")],ED);let mmt=class extends hJ{get convexHull(){return this._convexHull}constructor(e,r,i){super(),this._convexHull=new Array(24),this._boundingSphere=on(),e!==void 0&&this.init(e,r,i)}init(e,r,i){super.init(e,r,i);const s=this.ellipsoid.radius,n=this.extentInRadians[0],o=this.extentInRadians[1],a=this.extentInRadians[2],l=this.extentInRadians[3],c=e[0],h=Ft(o,l,.5),p=Ft(n,a,.5),f=c===0?0:Math.min(Math.abs(o),Math.abs(l));this._edgeLen=(a-n)*Math.cos(f)*s,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=s-Math.sqrt(s*s-this._edgeLen2/4),EDe(this.centerAtSeaLevel,p,h,this.ellipsoid.radius);const m=Nl(this.centerAtSeaLevel);_e(m,m),this.up=m,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateBoundingVolumes();const e=this._center;if(this.lij[0]===0)ce(e[Ks.MIDDLE],0,0,0),ce(e[Ks.TOP],0,0,0),ce(e[Ks.BOTTOM],0,0,0),e[Ks.MIDDLE][3]=this.ellipsoid.radius+this.elevationBounds[1];else{this._updateCenter();const r=e[Ks.MIDDLE],i=this.convexHull;let s=0;for(let n=0;n<8;++n)s=Math.max(s,gmt(r,i,3*n));e[Ks.MIDDLE][3]=Math.sqrt(s)}}_calculateFrustumVisibilityStatus(e){if(!R_(e,this._boundingSphere))return aa.OUTSIDE;if(this.lij[0]<10)return aa.INTERSECTS;const r=this.convexHull,i=this.surface.view.state.camera.near;let s=!0;for(let n=0;n<rv.NUM;n++){const o=n===vi.NEAR,a=e[n],l=a[0],c=a[1],h=a[2],p=a[3]-(o?i:0);let f=!1;for(let m=0;m<8;++m){const y=3*m;if(l*r[y+0]+c*r[y+1]+h*r[y+2]+p<0){if(f=!0,!s)break}else s=!1}if(!f)return aa.OUTSIDE}return s?aa.INSIDE:aa.INTERSECTS}computeElevationBounds(){super.computeElevationBounds(),this._updateBoundingVolumes()}createGeometry(){Zft(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}_updateBoundingVolumes(){this._updateConvexHull(),this._updateBoundingSphere(),xn&&this._checkBVs()}_updateBoundingSphere(){const e=this._boundingSphere,r=e,i=this.elevationBounds,s=this.ellipsoid.radius,n=i[1];if(this.level===0)ce(r,0,0,0),e[3]=s+n;else{const o=this.extentInRadians,a=.5*(o[0]+o[2]),l=o[1],c=o[3];l1(Zae,a,l,s),l1(Jae,a,c,s),fe(r,Zae,Jae);const h=.5*(i[0]+i[1]);ae(r,r,(s+h)/mc(r));const p=this.convexHull;let f=0;const m=(_,b)=>{const x=_[0]-p[3*b+0],T=_[1]-p[3*b+1],S=_[2]-p[3*b+2];return Math.sqrt(x*x+T*T+S*S)};for(let _=0;_<8;++_){const b=m(r,_);f=Math.max(f,b)}const y=f;e[3]=y+2}}_updateConvexHull(){const e=this.extentInRadians,r=this.ellipsoid.radius;if(this.level===0)return;const i=this.elevationBounds,s=this._getPatchType(),n=this.surface.isWebMercator,o=n&&s===Th.HAS_NORTH_POLE,a=n&&s===Th.HAS_SOUTH_POLE,l=a||o,c=Math.PI/2,h=e[0],p=e[2],f=a?-c:e[1],m=o?c:e[3],y=.5*(h+p),_=i[0],b=r+(l?Math.min(0,_-1):_),x=(H,$,N)=>l1(H,$,N,b),T=M(),S=M(),E=M(),O=M();x(T,h,f),x(S,h,m),x(E,p,m),x(O,p,f);const R=(H,$)=>{for(let N=0;N<3;++N)this._convexHull[3*$+N]=H[N]};R(T,0),R(S,1),R(E,2),R(O,3);const L=i[1],P=r+(l?Math.max(0,L+1):L),U=M(),B=M(),z=M();l1(B,y,m,b),l1(z,y,f,b),fe(U,B,z),_e(U,U);const G=M(),K=M(),ee=(H,$)=>{to(K,H,$),_e(K,K);const N=-ye(H,G)/ye(K,G);Re(N>=0),ae(K,K,N),fe(H,H,K)};if(2**this.lij[0]>2*this.lij[1]){const H=z,$=M();pt($,Yae,H),_e($,$),pt(G,H,$),_e(G,G),Re(Sh(ye(G,H)/mc(H),0)),ee(T,S),ee(O,E),R(T,0),R(O,3)}else if(2**this.lij[0]!==2*this.lij[1]){const H=B,$=M();pt($,Yae,H),_e($,$),pt(G,$,H),_e(G,G),ee(S,T),ee(E,O),R(S,1),R(E,2)}const Q=(H,$)=>{const N=P/ye($,U);for(let F=0;F<3;++F)this._convexHull[3*H+F]=$[F]*N};Q(4,T),Q(5,S),Q(6,E),Q(7,O)}_getPatchType(){const e=this.lij[1],r=e===0,i=e===(1<<this.level)-1;return r?i?Th.HAS_BOTH_POLES:Th.HAS_NORTH_POLE:i?Th.HAS_SOUTH_POLE:Th.REGULAR}intersectsRay(e,r,i,s){const n=this._boundingSphere,o=n[3]+i,a=r[0]*r[0]+r[1]*r[1]+r[2]*r[2],l=n[0]-e[0],c=n[1]-e[1],h=n[2]-e[2],p=(l*r[0]+c*r[1]+h*r[2])/a,f=r[0]*p-l,m=r[1]*p-c,y=r[2]*p-h;return f*f+m*m+y*y<o*o}getDefaultVerticesPerSide(){return this.level<Xae.length?Xae[this.level]+1:2}updateCornerElevations(){tmt(this.renderData),this._updateBoundingVolumes()}updateEdgeElevations(){emt(this.renderData),this._updateBoundingVolumes()}_checkBVs(){var ue;if(!xn||this.level<=2)return;const e=this._boundingSphere,r=e[3],i=e,s=M(),n=this.ellipsoid.radius,o=this.elevationBounds;o[1],o[0];const a=n+o[0],l=1,c=0,h=this._center[Ks.MIDDLE][3],p=this.convexHull,f=(pe,we)=>{for(let Ce=0;Ce<3;++Ce)pe[Ce]=p[3*we+Ce]};{const pe=M(),we=M(),Ce=M(),Ge=M(),Le=M(),xe=(De,Ue,wt,Ke)=>{f(we,De),f(Ce,Ue),f(Ge,wt),to(we,we,Ce),to(Ge,Ge,Ce),pt(pe,we,Ge),_e(pe,pe);const Ut=ye(pe,Ce);f(Le,Ke);const Wt=ye(pe,Le),Qt=Math.abs(Wt-Ut);Re(Sh(Qt,0),`Non coplanar ${De},${Ue},${wt},${Ke} diff = ${Qt}`)};xe(0,1,2,3),xe(4,5,6,7),xe(0,1,4,5),xe(1,2,5,6),xe(2,3,6,7),xe(3,0,7,4)}const m=Fc(24),y=(pe,we,Ce)=>{const Ge=4*pe;for(let Le=0;Le<3;++Le)m[Ge+Le]=we[Le];m[Ge+3]=Ce},_=M(),b=M(),x=M(),T=M(),S=(pe,we,Ce,Ge)=>{f(_,we),f(b,Ce),f(x,Ge),to(_,_,b),_e(_,_),to(x,x,b),_e(x,x),pt(T,_,x),_e(T,T);const Le=ye(T,b);y(pe,T,Le)};S(0,0,1,2),S(1,1,0,4),S(2,1,5,2),S(3,3,2,6),S(4,4,0,3),S(5,4,6,5);const E=1,O=(pe,we,Ce,Ge)=>{const Le=4*pe;return m[Le+0]*we+m[Le+1]*Ce+m[Le+2]*Ge-m[Le+3]},R=(pe,we,Ce,Ge)=>O(pe,we,Ce,Ge)>=-E,L=(pe,we)=>R(pe,we[0],we[1],we[2]),P=2**this.lij[0]>2*this.lij[1],U=(pe,we,Ce)=>Math.sqrt(EEe(pe,we,Ce,i[0],i[1],i[2]))<r,B=pe=>U(pe[0],pe[1],pe[2]),z=(pe,we)=>U(pe[we+0],pe[we+1],pe[we+2]),G=this.extentInRadians,K=.5*(G[0]+G[2]),ee=G[1],Q=G[3],H=M(),$=M();l1(H,K,Q,a),l1($,K,ee,a);const N=P?"Upper":"Lower";let F=!0;for(let pe=0;pe<6;++pe){for(let we=0;we<8;++we){const Ce=3*we,Ge=R(pe,p[Ce+0],p[Ce+1],p[Ce+2]);F&&(F=Ge),Re(Ge,`Tile[${this.lij}] Convex hull point ${we} outside of plane ${pe}`)}Re(L(pe,$),`Tile[${this.lij}] (${N}) bottom mid outside of plane ${pe}`),Re(L(pe,H),`Tile[${this.lij}] (${N}) top mid outside of plane ${pe}`)}Re(F,"Not all convex hull points are inside  convex hull polyhedron"),Re(B($),`Tile[${this.lij}] (${N}) bottom mid outside of bounding sphere`),Re(B(H),`Tile[${this.lij}] (${N}) top mid outside of bounding sphere`);for(let pe=0;pe<8;++pe){const we=z(p,3*pe);Re(we,`Tile[${this.lij}] Convex hull point ${pe} outside of bounding sphere`)}for(let pe=0;pe<6;++pe)for(let we=0;we<8;++we){const Ce=3*we;R(pe,p[Ce+0],p[Ce+1],p[Ce+2])||console.error(`Tile[${this.lij}] Convex hull point ${we} outside of plane ${pe}`)}const j=this.extentInRadians,X=Math.max(j[2]-j[0],j[3]-j[1]),J=Math.round(X*n),W=this.renderData;if(W){const pe=W.geometryInfo,we=W.localOrigin,Ce=(ue=pe.vertexAttributes)==null?void 0:ue.position;if(!Ce)return;const Ge=Ce.count,Le=M(),xe=pe.numVerticesPerSide-2,De=xe*xe,Ue=W.geometryState.neighborData,wt=Ue.edgeResolutions.reduce((Ke,Ut)=>Ke+Ut+1,0);for(let Ke=0;Ke<Ge;++Ke){const Ut=Ke<De,Wt=!Ut&&Ke<De+wt;let Qt=!1,Xt=-1;if(Wt){let ir=De;for(let xr=0;xr<4;++xr){const yr=Ue.edgeResolutions[xr];if(Ke===ir||Ke===ir+yr-1){Qt=!0;break}if(ir+=yr,Ke<ir){Xt=xr;break}}}const gr=Xt,Kr=Qt,Er=Wt&&!Kr,Tr=Wt?Ue.edgePeerNeighbors[gr]:null,it=Wt&&Tr&&qg(this,Tr)>0,Ye=Ut?"internal":Er?"edge":Kr?"corner":"pole";Ce.getVec(Ke,s),fe(Le,s,we);const at=mc(Le)-n;let ut=0,Tt=!1;const jt=o[0]-at,Or=at-o[1],Mr=jt>l,Pr=Or>l,Ir=Mr||Pr,Si=`Tile[${this.lij}].vertex[${Ke}]:${Ye}`+(Mr?"(below)":Pr?"(above)":"")+(it?"(Neighbor)":"");{const ir=KO(Le,i);if(ir>=r+c){const xr=ir-r;Ir||(console.error(`${Si} is out of the bounding sphere by ${xr.toFixed(0)} / ${r.toFixed(0)}[tol=${c}] h=${at.toFixed(0)} / [${o[0].toFixed(0)}..${o[1].toFixed(0)}] (${(xr/r).toFixed(0)})`),Tt=!0)}}for(let ir=0;ir<6;++ir)if(!R(ir,Le[0],Le[1],Le[2])){const xr=O(ir,Le[0],Le[1],Le[2]),yr=Ke%xe,xs=(Ke-yr)/xe;ir===0&&jt||ir===5&&Or||(console.error(`${Si} (${yr},${xs})|${xe}] is out of the bounding trapezoid plane ${ir} h=${Math.round(at)} / [${Math.round(o[0])}..${Math.round(o[1])}] dist=${Math.round(xr)} radii = ${Math.round(r)}/${Math.round(h)}} : maxL = ${J}`),++ut)}if(Tt||ut>0)break}}}};const Xae=[128,64,64,32,16,8,8,4];function gmt(t,e,r){return EEe(t[0],t[1],t[2],e[r+0],e[r+1],e[r+2])}function EEe(t,e,r,i,s,n){const o=i-t,a=s-e,l=n-r;return o*o+a*a+l*l}const l1=(t,e,r,i)=>{const s=Math.cos(e),n=Math.sin(e),o=Math.cos(r),a=Math.sin(r);t[0]=i*o*s,t[1]=i*o*n,t[2]=i*a},Yae=[0,0,1],Zae=M(),Jae=M();let ymt=class{constructor(){this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}},CEe=class extends Ca{constructor(){super(...arguments),this.blendMode=Ne.Normal}};u([V({count:Ne.COUNT})],CEe.prototype,"blendMode",void 0);let U2=class extends CEe{constructor(){super(...arguments),this.output=In.Composite,this.baseOpacityMode=rp.NotRequired,this.premultipliedSource=Bd.Off,this.hasWebGL2Context=!1}};u([V({count:In.COUNT})],U2.prototype,"output",void 0),u([V({count:rp.COUNT})],U2.prototype,"baseOpacityMode",void 0),u([V()],U2.prototype,"premultipliedSource",void 0),u([V()],U2.prototype,"hasWebGL2Context",void 0);var Bw;function _mt(t){const e=new Dr;if(e.include(oEe),t.background===Bw.Only){const r=t.output===In.ColorComposite;return r?e.fragment.uniforms.add(new qt("backgroundColor",i=>i.backgroundColor)):(e.extensions.add("GL_OES_standard_derivatives"),e.fragment.include(uJ)),e.fragment.code.add(w`
    void main() {
      gl_FragColor = vec4(${r?w`backgroundColor`:w`gridColor(uv)`}, 1.0);
    }
  `),e}return e.include(aEe,t),e.fragment.uniforms.add(new Mt("tex",r=>r.texture)),e.fragment.uniforms.add(new Pe("opacity",r=>r.opacity)),e.fragment.code.add(w`void main() {
vec4 bgColor = getBackground(uv);
gl_FragColor = blendLayers(bgColor, texture2D(tex, uv), opacity);
}`),e}(function(t){t[t.BelowLayer=0]="BelowLayer",t[t.Only=1]="Only",t[t.COUNT=2]="COUNT"})(Bw||(Bw={}));const vmt=Object.freeze(Object.defineProperty({__proto__:null,get BackgroundMode(){return Bw},build:_mt},Symbol.toStringTag,{value:"Module"}));let bmt=class extends nEe{constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.backgroundColor=ma}},AEe=class REe extends Vr{initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===vt.WEBGL2}initializeProgram(e){return new Fr(e.rctx,REe.shader.get().build(this.configuration),Rr)}initializePipeline(){return Bt({blending:Tp(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Kt})}};AEe.shader=new Nr(vmt,()=>te(()=>import("./BlendLayers.glsl-cad296b3.js"),[]));let OEe=class extends U2{constructor(){super(...arguments),this.background=Bw.BelowLayer}};u([V()],OEe.prototype,"background",void 0);let ik=class{constructor(e,r,i,s,n,o){this.texture=e,this.type=r,e.retain(),this.offsetAndScale=Ht(i.offset[0],i.offset[1],i.scale,i.scale),this.opacities=$e(s,n,o)}destroy(){this.texture.release()}};function CD(){return[1,0,0,1,0,0]}function wmt(t){return[t[0],t[1],t[2],t[3],t[4],t[5]]}function xmt(t,e,r,i,s,n){return[t,e,r,i,s,n]}function Tmt(t,e){return new Float64Array(t,e,6)}Object.freeze(Object.defineProperty({__proto__:null,clone:wmt,create:CD,createView:Tmt,fromValues:xmt},Symbol.toStringTag,{value:"Module"}));function Smt(t){return t instanceof Float32Array&&t.length>=2}function Emt(t){return Array.isArray(t)&&t.length>=2}function sk(t){return Smt(t)||Emt(t)}const Cmt=96,Amt=39.37;function yJ(t,e){return e.type?or(t,e.x,e.y):Un(t,e)}function Rmt(t){return nl(t)}function Omt(t,e){const r=t.targetGeometry,i=e.targetGeometry;return r.x=i.x,r.y=i.y,r.spatialReference=i.spatialReference,t.scale=e.scale,t.rotation=e.rotation,t}const Mmt=function(){const t=Je();return function(e,r,i){const s=r.targetGeometry;yJ(t,s);const n=.5*f6(r);return e.xmin=t[0]-n*i[0],e.ymin=t[1]-n*i[1],e.xmax=t[0]+n*i[0],e.ymax=t[1]+n*i[1],e.spatialReference=s.spatialReference,e}}();function f6(t){return t.scale*Pmt(t.targetGeometry)}function Pmt(t){return v(t)&&pa(t.spatialReference)?1/(Rmt(t.spatialReference)*Amt*Cmt):1}function Imt(t){return h4(t.rotation)||0}const _J=function(){const t=Je(),e=Je(),r=Je();return function(i,s,n,o,a,l){return KX(t,s),Sc(e,n,.5*l),or(r,1/o*l,-1/o*l),qX(i,e),a&&jX(i,i,a),Q_e(i,i,r),HX(i,i,t),i}}(),$mt=function(){const t=Je();return function(e,r,i,s){const n=f6(r),o=Imt(r);return yJ(t,r.targetGeometry),_J(e,t,i,n,o,s)}}(),Lmt=function(){const t=Je();return function(e,r,i,s){const n=f6(r);return yJ(t,r.targetGeometry),_J(e,t,i,n,0,s)}}();function Dmt(t){const e=I_(t);return e?e.valid[1]-e.valid[0]:0}function Nmt(t,e){return Math.round(Dmt(t)/e)}var vH;const Hm=[0,0];let q0=vH=class extends ve{constructor(t){super(t),this._viewpoint2D={center:Je(),rotation:0,scale:0,spatialReference:void 0},this.center=[0,0],this.extent=new Zr,this.id=0,this.inverseTransform=CD(),this.resolution=0,this.rotation=0,this.scale=0,this.transform=CD(),this.transformNoRotation=CD(),this.displayMat3=Gl(),this.displayViewMat3=Gl(),this.viewMat3=Gl(),this.viewMat2d=Y_e(),this.worldScreenWidth=0,this.size=[0,0]}set pixelRatio(t){this._set("pixelRatio",t),this._update()}set size(t){this._set("size",t),this._update()}set viewpoint(t){if(t){const e=this._viewpoint2D,r=t.targetGeometry;e.center[0]=r.x,e.center[1]=r.y,e.rotation=t.rotation,e.scale=t.scale,e.spatialReference=r.spatialReference}this._update()}copy(t){const e=this.size,r=this.viewpoint;return r&&e?(this.viewpoint=Omt(r,t.viewpoint),this._set("size",Un(e,t.size))):(this.viewpoint=t.viewpoint.clone(),this._set("size",[t.size[0],t.size[1]])),this._set("pixelRatio",t.pixelRatio),this}clone(){return new vH({size:this.size,viewpoint:this.viewpoint.clone(),pixelRatio:this.pixelRatio})}toMap(t,e,r){return sk(e)?J1(t,e,this.inverseTransform):(Hm[0]=e,Hm[1]=r,J1(t,Hm,this.inverseTransform))}toScreen(t,e,r){return sk(e)?J1(t,e,this.transform):(Hm[0]=e,Hm[1]=r,J1(t,Hm,this.transform))}toScreenNoRotation(t,e,r){return sk(e)?J1(t,e,this.transformNoRotation):(Hm[0]=e,Hm[1]=r,J1(t,Hm,this.transformNoRotation))}getScreenTransform(t,e){const{center:r}=this._viewpoint2D,i=this._get("pixelRatio")||1,s=this._get("size");return _J(t,r,s,e,0,i),t}_update(){const{center:t,spatialReference:e,scale:r,rotation:i}=this._viewpoint2D,s=this._get("pixelRatio")||1,n=this._get("size"),o=new mp({targetGeometry:new mt(t[0],t[1],e),scale:r,rotation:i});if(this._set("viewpoint",o),!n||!e||!r)return;this.resolution=f6(o),this.rotation=i,this.scale=r,this.spatialReference=e,Un(this.center,t);const a=n[0]!==0?2/n[0]:0,l=n[1]!==0?-2/n[1]:0;hY(this.displayMat3,a,0,0,0,l,0,-1,1,1);const c=dY(this.viewMat3),h=xh(n[0]/2,n[1]/2),p=xh(-n[0]/2,-n[1]/2),f=h4(i);eF(c,c,h),pY(c,c,f),eF(c,c,p),KS(this.displayViewMat3,this.displayMat3,c);const m=qX(this.viewMat2d,h);return jX(m,m,f),HX(m,m,p),Mmt(this.extent,o,n),$mt(this.transform,o,n,s),J_e(this.inverseTransform,this.transform),Lmt(this.transformNoRotation,o,n,s),this.worldScreenWidth=Nmt(this.spatialReference,this.resolution),this._set("id",this.id+1),this}};u([d({readOnly:!0})],q0.prototype,"id",void 0),u([d({value:1,json:{write:!0}})],q0.prototype,"pixelRatio",null),u([d({json:{write:!0}})],q0.prototype,"size",null),u([d()],q0.prototype,"spatialReference",void 0),u([d({type:mp,json:{write:!0}})],q0.prototype,"viewpoint",null),q0=vH=u([I("esri.views.2d.ViewState")],q0);const Fmt=q0,Umt=.125;let kmt=class{constructor(){this._renderParams={context:null,drawPhase:1,state:new Fmt({viewpoint:new mp({targetGeometry:new mt(0,0),scale:1,rotation:0}),size:[256,256]}),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null}}dispose(){this._renderParams=null}render(e,r,i,s,n,o,a,l,c,h){const p=o.adjustLevel(r[0]),f=this._renderParams;f.context=e,f.painter=s,f.glyphMosaic=s.glyphMosaic,f.spriteMosaic=s.spriteMosaic,f.pixelRatio=h,f.displayLevel=p,f.requiredLevel=p;const m=o.getScale(r[0]),[y,_]=o.getShift(r,a*m),b=Umt*a*m/c,x=i.transforms.dvs;x[0]=b,x[4]=-b,x[6]=-1-y-l[0]*a*2,x[7]=1+_+(1-l[1])*a*2-2,f.state.size[0]=c,f.state.size[1]=c,i.stage||i.attachWithContext(e),i.triangleCount=0,s.drawTile(f,i,n)}},MEe=class PEe extends Vr{initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===vt.WEBGL2}initializeProgram(e){return new Fr(e.rctx,PEe.shader.get().build(this.configuration),Rr)}initializePipeline(){return Bt({blending:Tp(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Kt})}};MEe.shader=new Nr(_ft,()=>te(()=>import("./RasterColorizer.glsl-bfdd97eb.js"),[]));let AD=class extends U2{constructor(){super(...arguments),this.colorizerType=iw.Stretch,this.stretchType=kw.Noop,this.applyColormap=!0}};u([V({count:iw.COUNT})],AD.prototype,"colorizerType",void 0),u([V({count:kw.COUNT})],AD.prototype,"stretchType",void 0),u([V()],AD.prototype,"applyColormap",void 0);let Kae=class{constructor(e){this._rctx=e,this._fbos=new Map}get(e){return this._getPool(e)}dispose(){this._fbos.forEach(e=>e.dispose()),this._fbos.clear()}_getPool(e){const r=this._fbos.get(e);if(r)return r;const i=new Ds(this._rctx,{colorTarget:ls.TEXTURE,depthStencilTarget:$r.DEPTH_RENDER_BUFFER,width:e,height:e});return this._fbos.set(e,i),i}};const Vmt=se.getLogger("esri.views.3d.terrain");let Bmt=class{constructor(e,r){this._rctx=e,this._techniqueRepository=r,this._fbos=[],this._vectorTileHelper=new kmt,this._bindParameters=new v5(null,null,null),this._blendLayersTechniqueConfig=new OEe,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vaoQuad=Aa(this._rctx,kE)}dispose(){this._fbos.forEach(Qe),this._fbos=null,this._vtFBO=Qe(this._vtFBO),this._vaoQuad=Qe(this._vaoQuad),this._vectorTileHelper=Qe(this._vectorTileHelper),this._backgroundTechnique=Bi(this._backgroundTechnique),this._applyOpacityTechnique=Bi(this._applyOpacityTechnique),this._blendLayersTechnique=Bi(this._blendLayersTechnique)}_getBlendLayersTechnique(e,r,i,s=Bd.Off,n=Bw.BelowLayer){return this._blendLayersTechniqueConfig.output=r,this._blendLayersTechniqueConfig.blendMode=e,this._blendLayersTechniqueConfig.baseOpacityMode=i,this._blendLayersTechniqueConfig.premultipliedSource=s,this._blendLayersTechniqueConfig.background=n,this._blendLayersTechnique=this._techniqueRepository.releaseAndAcquire(AEe,this._blendLayersTechniqueConfig,this._blendLayersTechnique),this._blendLayersTechnique}drawBackground(e,r){const i=this._getBlendLayersTechnique(Ne.Normal,r?In.ColorComposite:In.GridComposite,rp.NotRequired,Bd.Off,Bw.Only),s=this._rctx.bindTechnique(i,e,this._bindParameters);this._render(s)}_render(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays($t.TRIANGLE_STRIP,0,Wo(this._vaoQuad,"geometry"))}drawGroup(e,r,i,s,n,o=Bd.On){r===In.Composite&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(i).colorTexture),e.texture=this.currentFBO(i).colorTexture,this.closeGroup(i);const a=this._getBlendLayersTechnique(s,r,n,o),l=this._rctx.bindTechnique(a,e,this._bindParameters);this._render(l)}drawRasterData(e,r,i,s,n,o=Bd.Off){if(C(e.texture))return;e.fboTexture=r===In.GroupBackgroundComposite||s===Ne.Normal&&n===rp.NotRequired&&o===Bd.Off?null:this.switch(i).colorTexture;const a=this._getBlendLayersTechnique(s,r,n,o),l=this._rctx.bindTechnique(a,e,this._bindParameters);this._render(l)}drawImageryTileData(e,r,i,s,n,o){const a=o.sourceLayerInfo.data;if(!a.source||(o.tile.surface.layerViewByIndex(o.layerIndex,dr.MAP).ensureSymbolizerParameters(a),!a.bind(this._rctx)))return;e.fboTexture=s===Ne.Normal&&n===rp.NotRequired?null:this.switch(i).colorTexture;const l=this._getRasterColorizerTechnique(a,r,s,n);a.opacity=e.opacity;const c=a.getUniforms();c.scale=o.scale,c.offset=o.offset,c.backgroundColor=e.backgroundColor,c.fboTexture=e.fboTexture,c.baseOpacity=e.baseOpacity;const h=this._rctx.bindTechnique(l,c,null);this._render(h)}_getRasterColorizerTechnique(e,r,i,s){const n=e.symbolizerParameters,o=["stretch","lut","hillshade"].indexOf(n.type);return C(this._rasterColorizerConfig)&&(this._rasterColorizerConfig=new AD,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.output=r,this._rasterColorizerConfig.blendMode=i,this._rasterColorizerConfig.baseOpacityMode=s,this._rasterColorizerConfig.colorizerType=o,this._rasterColorizerConfig.applyColormap=!!n.colormap,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?kw.Noop:kw.PerBand,this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(MEe,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}drawVectorData(e,r,i,s,n,o,a,l,c){const h=this._rctx,p=o.sourceLayerInfo.data,f=o.tile.surface.layerViewByIndex(o.layerIndex,dr.MAP),m=n===rp.Required||e.opacity<1||s!==Ne.Normal||r!==In.Composite,y=m?Bd.On:Bd.Off;this._getBlendLayersTechnique(s,r,n,y).bindPipelineState(h);let _=null,b=null;m?(b=this.currentFBO(i),C(this._vtFBO)&&(this._vtFBO=new Kae(this._rctx)),_=this._vtFBO.get(i),h.bindFramebuffer(_),this._clearCurrentFBO()):c&&h.clearSafe(Li.DEPTH_BUFFER_BIT);try{this._vectorTileHelper.render(h,o.sourceLod,p,f.painter,f.layer.styleRepository,f.schemaHelper,Math.round(1/o.scale),o.offset,l,a)}catch(x){Vmt.warnOnce("A render call containing vector tiles did not resolve correctly.",x)}return!v(_)||(h.bindFramebuffer(b),e.texture=_.colorTexture,e.offset=Wl,e.scale=1,this.drawRasterData(e,r,i,s,n,y),c)}copyFBOToTexture(e){const r=this._rctx,i=r.bindTexture(e.texture,ct.TEXTURE_UNIT_FOR_UPDATES),s=e.descriptor;r.gl.copyTexImage2D(bt.TEXTURE_2D,0,s.pixelFormat,0,0,s.width,s.height,0),e.generateMipmap(),r.bindTexture(i,ct.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.clearSafe(Li.COLOR_BUFFER_BIT|Li.DEPTH_BUFFER_BIT)}_initFBO(e,r,i){this._rctx.bindFramebuffer(e),i&&(this._rctx.setViewport(0,0,r,r),this._clearCurrentFBO())}ensureBuffer(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}bind(e,r=0,i=!0){if(this._current=r,r>=this._fbos.length)for(let s=this._fbos.length;s<=r;s++)this._fbos.push(new Kae(this._rctx));this._initFBO(this._fbos[r].get(e),e,i)}_bindNextFreeBuffer(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}openGroup(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}switch(e){const r=this.currentFBO(e),i=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(i),r}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(e){const r=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(r),this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(e){return this._fbos[this._current].get(e)}},zmt=class{constructor(e,r,i,s){this.start=e,this.end=r,this.blendMode=i,this.opacity=s}},Gmt=class{constructor(e,r,i){this._rctx=e,this.tileSize=r,this._techniqueRepository=i,this._passParameters=new bmt,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1,this._blackTex=null,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._composition=new Bmt(this._rctx,this._techniqueRepository),this._blackTex=new u2(_We(this._rctx,[0,0,0,1])),this._ensureBackgroundTexture(this.tileSize)}dispose(){this._composition=Qe(this._composition),this._backgroundTexture=Bi(this._backgroundTexture),this._blackTex=Bi(this._blackTex)}get backgroundIsGrid(){return C(this._backgroundColor)}get backgroundColor(){return this._backgroundColor}updateTileTexture(e,r){if(!e.renderData)return;const i=e.surface,s=i.baseOpacity;let n=0,o=0,a=this.tileSize,l=!1;const c=i.view.state.contentPixelRatio;let h=!1;WF.clear(),eT.length=0;const p=e.layerInfo[dr.MAP];let f=p.length,m=0;for(;m<p.length;m++){const b=i.layerViewByIndex(m,dr.MAP),x=b.layer.opacity;Qae[m]=x;const T=b.fullOpacity;if(ele[m]=T,Vhe(b.layer)&&f>=p.length&&(f=m),zF(b)){tle[m]=b.layer.blendMode;let E=b.layer.blendMode!=="normal";if(SS(b.layer.parent)){const O=bH(b.layer.parent);v(O)&&O!==""&&(E=IEe(b.layer.parent)||E)}E&&(h=E,l=!1)}if(x===0&&!h){p[m].pendingUpdates&=~(Et.TEXTURE_NOFADING&Et.TEXTURE_FADING);continue}++o;const S=nk(e,m);if(S){if(p[m].pendingUpdates&=~(Et.TEXTURE_NOFADING&Et.TEXTURE_FADING),SS(b.layer.parent)){const E=bH(b.layer.parent);v(E)&&E!==""&&$Ee(b.layer.parent,m)}LO(b)?a=Math.max(a,this.tileSize*c):s===1&&T===1&&(b.isOpaque||this._dataToTexture(S)&&S.sourceLayerInfo.data.descriptor.isOpaque)&&(l=!0),++n}}this._rctx.type===vt.WEBGL1&&(a=jmt(a));const y=a/this.tileSize,_=m-1;this._ensureBackgroundTexture(this.tileSize),n!==0?n===1&&!h&&this._useLayerTexture(e,_,f,ele[_])||this._composeMapLayers(e,r,_,f,Qae,tle,a,y,!l||h,WF,h):this._useBackgroundTexture(e,o)}_ensureBackgroundTexture(e){C(this._backgroundTexture)&&(this._backgroundTexture=this._buildTexture(e),this._backgroundDirty=!0),this._backgroundDirty&&(this._composition.bind(e),this._passParameters.offset=Wl,this._passParameters.scale=1,this._passParameters.opacity=1,v(this.backgroundColor)&&(this._passParameters.backgroundColor=this.backgroundColor),this._composition.drawBackground(this._passParameters,v(this.backgroundColor)),this._composition.copyFBOToTexture(this._backgroundTexture),this._composition.unbind(),this._backgroundDirty=!1)}_useBackgroundTexture(e,r){let i=Hg.Immediate;(e.surface.view.layerViewManager.updating||r>0)&&(i=Hg.Delayed);const s=e.renderData;this._backgroundTexture&&C(s.textureReference)&&(i=Hg.Immediate),s.setTextureReference(v(this._backgroundTexture)?new ik(this._backgroundTexture,yn.FADING,rle,e.surface.baseOpacity,0,1):null,i)}_useLayerTexture(e,r,i,s){const n=r<i,o=n?1:e.surface.baseOpacity,a=n?e.surface.baseOpacity:1,l=nk(e,r);return!!this._dataToTexture(l)&&(e.renderData.setTextureReference(new ik(l.sourceLayerInfo.data,yn.FADING,l,o,a,s)),!0)}_composeMapLayers(e,r,i,s,n,o,a,l,c,h,p){this._composition.ensureBuffer(a);const f=e.surface.baseOpacity;let m=!1,y=tt.LINEAR_MIPMAP_LINEAR,_=!1,b=0;for(let S=i;S>=0;S--){const E=nk(e,S);if(!E||n[S]===0&&!p)continue;const O=S<s&&f<1&&!m;this._passParameters.baseOpacity=O?f:1;const R=this._passParameters.baseOpacity<1?rp.Required:rp.NotRequired;O&&(m=!0);let L=!1;h.forEach(z=>{z.start===S&&(eT.push(z),this._composition.openGroup(a),L=!0)});const P=b===0,U=L?In.GroupBackgroundComposite:c&&P?this.backgroundIsGrid?In.GridComposite:In.ColorComposite:In.Composite,B=gH[o[S]];for(jdt(E)?(this._passParameters.opacity=n[S],_=this._composition.drawVectorData(this._passParameters,U,a,B,R,E,l,this.tileSize,_)):Gdt(E)?(this._passParameters.opacity=n[S],this._composition.drawImageryTileData(this._passParameters,U,a,B,R,E),this._hasNearestInterpolation(E)&&(y=tt.NEAREST)):this._dataToTexture(E)&&(this._passParameters.texture=E.sourceLayerInfo.data.texture,this._passParameters.offset=E.offset,this._passParameters.scale=E.scale,this._passParameters.opacity=n[S],this._composition.drawRasterData(this._passParameters,U,a,B,R));eT.length>0&&eT[eT.length-1].end===S;){const z=eT.pop();this._passParameters.opacity=z.opacity,this._passParameters.offset=Wl,this._passParameters.scale=1;const G=c&&P?this.backgroundIsGrid?In.GridComposite:In.ColorComposite:In.Composite;this._composition.drawGroup(this._passParameters,G,a,gH[z.blendMode],R)}b++}const x=e.renderData,T=x.ensureTexture(a,()=>this._buildTexture(a,y));this._composition.copyFBOToTexture(T),this._composition.unbind(),x.setTextureReference(new ik(T,r,rle,m?1:f,0,1))}_hasNearestInterpolation(e){const r=e.sourceLayerInfo.data;return!!r.source&&r.interpolation==="nearest"}_dataToTexture(e){if(qdt(e)){const r=e.sourceLayerInfo;r.data=this._buildTexture(r.data),e.tile.setMemoryDirty()}return Hdt(e)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)}_buildTexture(e,r=tt.LINEAR_MIPMAP_LINEAR){if(C(e))return null;const i={target:bt.TEXTURE_2D,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Rt.CLAMP_TO_EDGE,samplingMode:r,maxAnisotropy:this._maxAnisotropy,preMultiplyAlpha:!0,flipped:!0,hasMipmap:!0},s=this._rctx;let n;if(typeof e=="number")i.width=i.height=e,n=new u2(new ct(s,i));else if(e instanceof a6)i.isOpaque=e.isOpaque,n=new u2(new ct(s,i,e.image)),e.release();else try{i.width=e.width,i.height=e.height,n=new u2(new ct(s,i,e))}catch{n=new u2(e1e(s)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const o=s.bindTexture(n.texture,ct.TEXTURE_UNIT_FOR_UPDATES);return n.generateMipmap(),s.bindTexture(o,ct.TEXTURE_UNIT_FOR_UPDATES),n}get test(){return{backgroundTexture:this._backgroundTexture}}};function jmt(t){const e=ES(t),r=e*e,i=t*t;if(r===i)return t;const s=e/2;return r-i<i-s*s?e:s}function nk(t,e){Yc.layerIndex=e;const r=t.layerInfo[dr.MAP][e];if(v(r.data))return or(Yc.offset,0,0),Yc.tile=t,Yc.scale=1,Yc.sourceLod=t.lij,Yc.sourceLayerInfo=r,Yc;const i=r.upsampleInfo;if(v(i)){const s=i.tile.layerInfo[dr.MAP][e];return Yc.tile=i.tile,Un(Yc.offset,i.offset),Yc.scale=i.scale,Yc.sourceLod=i.tile.lij,Yc.sourceLayerInfo=s,Yc}return null}function bH(t){return t.get("uid")}function IEe(t){let e=t.blendMode!=="normal";return SS(t.parent)&&(e=IEe(t.parent)||e),e}function $Ee(t,e){SS(t.parent)&&$Ee(t.parent,e);const r=bH(t);if(v(r)&&r!==""){const i=WF.get(r);i?i.start=e:WF.set(r,new zmt(e,e,t.blendMode,t.opacity))}}const Qae=new Array,ele=new Array,tle=new Array,WF=new Map,eT=new Array,Yc={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0},rle={offset:[0,0],scale:1},LEe=200,ok=40,Hmt=.8,qmt=10,A3=1e-6;function Wmt(t,e,r){const i=e,s=r;let n=0,o=1/0;for(let a=0;a<3;++a){{const l=t[a];if(i[a]<l){if(s[a]<=A3)return!1;const c=(l-i[a])/s[a];n=Math.max(n,c)}else if(s[a]<=-A3){const c=(l-i[a])/s[a];o=Math.min(o,c)}if(n>o)return!1}{const l=t[a+3];if(i[a]>l){if(s[a]>=-A3)return!1;const c=(l-i[a])/s[a];n=Math.max(n,c)}else if(s[a]>=A3){const c=(l-i[a])/s[a];o=Math.min(o,c)}if(n>o)return!1}}return!0}let ile=class{constructor(e,r,i,s,n){this.aabb=e,this.axis=r,this.d=i,this.midStartIndex=s,this.rightStartIndex=n}},vJ=class wH{constructor(e,r,i,s){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=r,this.positionAttribute=s,this._rayDirection=M(),this.bspNodeTree=new Array;const n=i-r,o=n<=DEe?new Uint16Array(n):new Uint32Array(n);this.indices=o;for(let a=0;a<n;++a)o[a]=a;{const a=Kmt(e,r,i,s.data,s.stride),l=ge(Math.log2(n/ok),2,qmt),c=(h,p,f)=>{const m=Zmt(o,a,h,p),y=p-h;if(y<=ok){const E=new ile(m,void 0,0,h,p);return this.bspNodeTree.push(E),E}const{axis:_,midValue:b}=Jmt(m),x=Ymt(o,a,h,p,_,b),T=(E,O)=>{if(f>l)return;const R=O-E;return R<ok||R>=Hmt*y?void 0:c(E,O,f+1)},S=new ile(m,_,b,x.next,x.mid);return this.bspNodeTree.push(S),S.leftNode=T(h,x.next),S.rightNode=T(x.mid,p),S};c(0,n,0),this.triangleVertexIndices=Qmt(o,e,r,i)}}intersectRayTriangleRange(e,r){{if(e>=r)return;const i=this.triangleVertexIndices,s=this.positionAttribute.data,n=this.positionAttribute.stride,o=this._rayOrigin,a=o[0],l=o[1],c=o[2],h=this._rayDirection,p=h[0],f=h[1],m=h[2];for(let y=e,_=3*e;y<r;++y){let b=i[_++]*n;const x=s[b++],T=s[b++],S=s[b];b=i[_++]*n;const E=s[b++],O=s[b++],R=s[b];b=i[_++]*n;const L=E-x,P=O-T,U=R-S,B=s[b++]-x,z=s[b++]-T,G=s[b]-S,K=f*G-z*m,ee=m*B-G*p,Q=p*z-B*f,H=L*K+P*ee+U*Q;if(Math.abs(H)<=Number.EPSILON)continue;const $=a-x,N=l-T,F=c-S,j=$*K+N*ee+F*Q;if(H>0){if(j<0||j>H)continue}else if(j>0||j<H)continue;const X=N*U-P*F,J=F*L-U*$,W=$*P-L*N,ue=p*X+f*J+m*W;if(H>0){if(ue<0||j+ue>H)continue}else if(ue>0||j+ue<H)continue;const pe=(B*X+z*J+G*W)/H;if(pe>=0){const we=this.indices[y]+this.firstTriangleIndex,Ce=uZ(L,P,U,B,z,G,Xmt);this._callback(pe,Ce,we,!1)}}}wH.numFacesTested+=r-e}intersectRay(e,r){wH.numFacesTested=0;const i=$e(e.r0[0],e.r0[1],e.r0[2]),s=$e(e.r1[0],e.r1[1],e.r1[2]),n=s[0]-i[0],o=s[1]-i[1],a=s[2]-i[2];if(n*n+o*o+a*a<A3)return;this._rayOrigin=i;const l=this._rayDirection;l[0]=n,l[1]=o,l[2]=a;const c=this.triangleVertexIndices.length/3;this._callback=r;const h=this.bspNodeTree[0];this.intersectRayBSP(h,0,c)}intersectRayBSP(e,r,i){const s=this._rayOrigin,n=this._rayDirection;if(!Wmt(e.aabb,s,n))return;const o=e.axis,a=e.d;if(s[o]<a||n[o]<0){const l=r,c=e.midStartIndex;if(l<c){const h=e.leftNode;h!==void 0?this.intersectRayBSP(h,l,c):this.intersectRayTriangleRange(l,c)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),s[o]>a||n[o]>0){const l=e.rightStartIndex,c=i;if(l<c){const h=e.rightNode;h!==void 0?this.intersectRayBSP(h,l,c):this.intersectRayTriangleRange(l,c)}}}get estimatedMemoryUsage(){return this.triangleVertexIndices.byteLength+this.indices.byteLength}};vJ.numFacesTested=0;const Xmt=M(),tT=[1/0,1/0,1/0],rT=[-1/0,-1/0,-1/0];function Ymt(t,e,r,i,s,n){let o=r,a=i;for(;o<a;){const c=t[o];e[6*c+s+3]<=n?++o:(--a,t[o]=t[a],t[a]=c)}let l=o;for(a=i;l<a;){const c=t[a-1];e[6*c+s]>=n?--a:(t[a-1]=t[l],t[l]=c,++l)}return{next:o,mid:l}}function Zmt(t,e,r,i){if(i<=r)return mw(NaN,NaN,NaN,NaN,NaN,NaN);{const s=6*t[r];for(let n=0;n<3;++n)tT[n]=e[s+0+n],rT[n]=e[s+3+n]}for(let s=r+1;s<i;++s){const n=6*t[s];for(let o=0;o<3;++o)tT[o]=Math.min(tT[o],e[n+0+o]),rT[o]=Math.max(rT[o],e[n+3+o])}return mw(tT[0],tT[1],tT[2],rT[0],rT[1],rT[2])}function Jmt(t){const e=t[3]-t[0],r=t[4]-t[1],i=t[5]-t[2],s=e>r?e>i?0:r>i?1:2:r>i?1:i>e?2:0;return{axis:s,midValue:(t[s]+t[s+3])/2}}function Kmt(t,e,r,i,s){const n=r-e,o=new Float32Array(6*n);for(let a=0;a<n;++a){const l=3*(a+e),c=t[l+0]*s,h=t[l+1]*s,p=t[l+2]*s;for(let f=0;f<3;++f){const m=i[c+f],y=i[h+f],_=i[p+f];o[6*a+f]=Math.min(m,y,_),o[6*a+3+f]=Math.max(m,y,_)}}return o}function Qmt(t,e,r,i){const s=i-r;let n=0;for(let a=r;a<i;++a)for(let l=0;l<3;++l)n=Math.max(e[3*a+l],n);const o=n<=DEe?new Uint16Array(3*s):new Uint32Array(3*s);for(let a=0;a<s;++a){const l=3*(t[a]+r);for(let c=0;c<3;++c){const h=e[l+c];o[3*a+c]=h}}return o}const DEe=65535;let is=class extends eo{constructor(){super(...arguments),this.output=k.Color,this.overlayMode=Wg.Disabled,this.tileBlendInput=zf.LayerOnly,this.spherical=!1,this.doublePrecisionRequiresObfuscation=!1,this.atmosphere=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.backfaceCullingEnabled=!1,this.stencilEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1,this.shading=!qr.TERRAIN_USE_LEGACY_SHADING,this.useLegacyTerrainShading=qr.TERRAIN_USE_LEGACY_SHADING,this.invisible=!1,this.tileBorders=!1,this.visualizeNormals=!1,this.screenSizePerspective=!1,this.receiveAmbientOcclusion=!1,this.pbrMode=dt.Terrain}};u([V({count:k.COUNT})],is.prototype,"output",void 0),u([V({count:Wg.COUNT})],is.prototype,"overlayMode",void 0),u([V({count:zf.COUNT})],is.prototype,"tileBlendInput",void 0),u([V()],is.prototype,"spherical",void 0),u([V()],is.prototype,"doublePrecisionRequiresObfuscation",void 0),u([V()],is.prototype,"atmosphere",void 0),u([V()],is.prototype,"receiveShadows",void 0),u([V()],is.prototype,"hasSlicePlane",void 0),u([V()],is.prototype,"backfaceCullingEnabled",void 0),u([V()],is.prototype,"stencilEnabled",void 0),u([V()],is.prototype,"textureFadingEnabled",void 0),u([V()],is.prototype,"renderOccluded",void 0),u([V()],is.prototype,"hasScreenSpaceReflections",void 0),u([V()],is.prototype,"hasCloudsReflections",void 0),u([V()],is.prototype,"shading",void 0),u([V()],is.prototype,"useLegacyTerrainShading",void 0),u([V()],is.prototype,"invisible",void 0),u([V()],is.prototype,"tileBorders",void 0),u([V()],is.prototype,"visualizeNormals",void 0),u([V()],is.prototype,"screenSizePerspective",void 0),u([V()],is.prototype,"receiveAmbientOcclusion",void 0),u([V({count:dt.COUNT})],is.prototype,"pbrMode",void 0),u([V({constValue:si.CompressedAttribute})],is.prototype,"normalType",void 0),u([V({constValue:qs.Compressed})],is.prototype,"textureCoordinateType",void 0),u([V({constValue:!1})],is.prototype,"highStepCount",void 0),u([V({constValue:!1})],is.prototype,"useCustomDTRExponentForWater",void 0),u([V({constValue:!1})],is.prototype,"useFillLights",void 0);const ak=7,egt=10,lk=En();var On;(function(t){t[t.Opaque=0]="Opaque",t[t.Semitransparent=1]="Semitransparent",t[t.TransparentWithDraped=2]="TransparentWithDraped",t[t.Empty=3]="Empty"})(On||(On={}));let uc=class extends Te{get _isGlobal(){return this._stage.viewingMode===Be.Global}get shading(){return this._techniqueConfiguration.shading}set shading(e){this._techniqueConfiguration.shading=e}constructor(e){super(e),this.type=Qi.TERRAIN,this.isGround=!0,this._tileSize=256,this._techniqueConfiguration=new is,this._passParameters=new cEe,this._rctx=null,this._renderDataPool=new Co(Wft),this._patchGroups=new Map,this._patchGroupsDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new eEe,this._highestVisibleLODTile=null,this._visible=!0,this._transparencyState=On.Opaque,this._velvetOverground=!0,this._castShadows=!0,this._emptyTex=null,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.needsHighlight=!1,this.renderOccludedFlags=ns.Occlude}initialize(){const e=[Se.OPAQUE_TERRAIN,Se.TRANSPARENT_TERRAIN,Se.OCCLUDED_TERRAIN];this._stage.addRenderPlugin(e,this)}destroy(){this._stage.removeRenderPlugin(this),Hpt()}get canRender(){return this._visible&&!!this._rootTiles&&!this.renderingDisabled}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setDirty()}set transparency(e){this._transparencyState!==e&&(this._techniqueConfiguration.invisible=e===On.TransparentWithDraped||e===On.Empty,this._transparencyState=e,this.setNeedsRender())}get transparency(){return this._transparencyState}get needsLinearDepth(){return this._overlayRenderer.hasWater}get renderPatchBorders(){return!!this._techniqueConfiguration.tileBorders}set renderPatchBorders(e){this._techniqueConfiguration.tileBorders!==e&&(this._techniqueConfiguration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return!!this._techniqueConfiguration.visualizeNormals}set visualizeNormals(e){this._techniqueConfiguration.visualizeNormals!==e&&(this._techniqueConfiguration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._techniqueConfiguration.backfaceCullingEnabled}set cullBackFaces(e){this._techniqueConfiguration.backfaceCullingEnabled!==e&&(this._techniqueConfiguration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this._setSortingDirty()}set velvetOverground(e){this._velvetOverground!==e&&(this._velvetOverground=e,this.setNeedsRender())}get layerUid(){return c_}get slicePlaneEnabled(){return this._techniqueConfiguration.hasSlicePlane}set slicePlaneEnabled(e){this._techniqueConfiguration.hasSlicePlane!==e&&(this._techniqueConfiguration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._techniqueConfiguration.textureFadingEnabled!==e&&(this._techniqueConfiguration.textureFadingEnabled=e,this.setNeedsRender())}set pbrMode(e){this._techniqueConfiguration.pbrMode!==e&&(this._techniqueConfiguration.pbrMode=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this._techniqueConfiguration.screenSizePerspective!==e&&(this._techniqueConfiguration.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setDirty()}setNeedsHighlight(e){this.needsHighlight=e,this.setNeedsRender()}setRenderOccludedOverlay(e){this.renderOccludedFlags=e?LF:ns.Occlude,this.setNeedsRender()}setStencilEnabledLayerExtents(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}setTileSize(e){this._tileSize=e,v(this._tileRenderer)&&(this._tileRenderer.tileSize=e),this.setDirty()}_prepareTileForLoading(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e))}loadTile(e){this._prepareTileForLoading(e),this.updateTileGeometryState(e),this.updateTileTexture(e,Et.TEXTURE_FADING)}updateTileTexture(e,r){v(this._tileRenderer)&&(this._tileRenderer.updateTileTexture(e,r===Et.TEXTURE_FADING?yn.FADING:yn.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(r))}updateTileGeometryState(e){for(const i of e.layerInfo[dr.ELEVATION])i.pendingUpdates&=~Et.GEOMETRY;e.resetPendingUpdate(Et.GEOMETRY);const r=e.renderData.updateGeometryState();return r&&this.setDirty(),r}updateGeometryIfNeeded(e){e.isLoaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(e){const r=e.renderData;r&&(r.releaseGeometry(),this._renderDataPool.release(r),r.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(e){const r=egt-ak,i=Math.max(0,Math.floor((e.level-r)/ak)*ak);if(this._isGlobal&&i===0)return ma;for(;e.parent&&e.level>i;)e=e.parent;return e.centerAtSeaLevel}setVisibility(e){this._visible=e,this.setDirty()}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}setDirty(e=Ps.UPDATE){this._patchGroupsDirty=!0,this._context.requestRender(e)}_setSortingDirty(e=Ps.UPDATE){this._patchSortingDirty=!0,this._context.requestRender(e)}setNeedsRender(e=Ps.UPDATE){this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this._rctx=e.renderContext.rctx,this._techniqueRepository=e.techniqueRepository,this._tileRenderer=new Gmt(this._rctx,this._tileSize,this._techniqueRepository),this.updateTileBackground(),this._emptyTex=e1e(this._rctx)}uninitializeRenderContext(){this._emptyTex=Qe(this._emptyTex),this._tileRenderer=Qe(this._tileRenderer)}intersect(e,r,i,s){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&this.transparency!==On.Opaque)return;const n=tgt,o=rgt;me(n,s,i),ce(o,1/n[0],1/n[1],1/n[2]);const a=e.results.min,l=e.results.max,c=e.results.ground,h=e.options.store===Po.MIN,p=!!e.results.ground.target,f=MJe(e.verticalOffset),m=e.tolerance;let y,_=h&&v(a.dist)?a.dist:1/0;const b=T=>{const S=T.renderData;if(!(S!=null&&S.vao))return;const E=S.geometryInfo;T4(lk,E.boundingBox);const O=S.localOrigin;v(f)&&(f.localOrigin=O,f.applyToAabb(lk));const R=lk;if(iT[0]=i[0]-O[0],iT[1]=i[1]-O[1],iT[2]=i[2]-O[2],!dZ(R,iT,o,m,_))return;const L=(Q,H,$)=>{Q.set(this.type,T,H,$,Lu),_=h&&v(a.dist)?a.dist:1/0},P=(Q,H)=>{if(v(H)&&Q>=0&&(e.options.backfacesTerrain||ye(H,n)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||r==null||r(i,s,Q))){if((c.dist==null||Q<c.dist)&&L(c,Q,H),e.options.isFiltered)return;e.options.store===Po.ALL&&(C(y)?(y=VY(e.ray),L(y,Q,H),e.results.all.push(y)):Q<y.dist&&L(y,Q,H)),(a.dist==null||Q<a.dist)&&L(a,Q,H),e.options.store!==Po.MIN&&(l.dist==null||Q>l.dist)&&L(l,Q,H)}},U=igt;me(U,s,O);const B=E.indices,z=E.vertexAttributes,G=z.getField(A.POSITION,Oi),K=new Xe(G.typedBuffer,3,!1,z.stride/4),ee=E.indexCount/3;if(C(f)&&ee>LEe){const Q=T.renderData;C(Q.intersectionData)&&(Q.intersectionData=new vJ(B,0,ee,K)),Q.intersectionData.intersectRay({r0:iT,r1:U},P)}else IM(iT,U,0,ee,B,K,null,f,P)},x=this._rootTiles;v(x)&&(()=>{const T=this._tileIterator;T.reset(x);const S=e.options.invisibleTerrain;for(let E=T.next();E;E=T.next())!(E.visible||S&&E.intersectsClippingArea)||!v(f)&&!E.intersectsRay(i,n,m,_)||p&&this._useStencilForTile(E)?T.skipSubtree():b(E)})()}processScaleRangeQueries(e,r){var i;if(!r.done)for(this._updatePatchGroups();e.updating&&!r.done;){e.prepare();for(const s of this._patchGroups.values())for(const n of s)v((i=n.renderData)==null?void 0:i.textureReference)&&e.queriesForTile(n);e.process(),r.madeProgress()}}prepareTechnique(e){if(e.bindParameters.slot===Se.OCCLUDED_TERRAIN){if(!(e.renderOccludedMask&LF))return null}else{const r=this.transparency===On.Opaque?Se.OPAQUE_TERRAIN:Se.TRANSPARENT_TERRAIN;if(e.bindParameters.slot!==r)return null}switch(e.output){case k.Color:return this.transparency===On.Empty?null:(this._techniqueConfiguration.hasScreenSpaceReflections=e.bindParameters.ssr.enabled,this._techniqueConfiguration.hasCloudsReflections=v(e.bindParameters.cloudsFade.data),this._techniqueConfiguration.receiveShadows=e.bindParameters.shadowMap.ready,this._techniqueConfiguration.receiveAmbientOcclusion=e.bindParameters.ssaoHelper.active,this._techniqueConfiguration.overlayMode=this._overlayRenderer.isEmpty?Wg.Disabled:this._overlayRenderer.hasWater?Wg.EnabledWithWater:Wg.Enabled,this._updateTechnique(k.Color,e.bindParameters.slot===Se.OCCLUDED_TERRAIN));case k.Shadow:case k.ShadowExcludeHighlight:return this._castShadows&&e.bindParameters.lighting.globalFactor===1?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(k.Shadow,!1)):null;case k.Depth:return this.transparency===On.Empty?null:(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(k.Depth,!1));case k.Normal:return this.transparency===On.Empty?null:(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(k.Normal,!1));case k.ObjectAndLayerIdColor:return this.transparency===On.Empty?null:this._updateTechnique(k.ObjectAndLayerIdColor,!1);case k.Highlight:return this.transparency!==On.Empty&&this.needsHighlight?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(k.Highlight,!1)):null}return null}render(e,r){const i=e.bindParameters.lighting.globalFactor===1;switch(this._updatePatchGroups(),r.useStencil=!1,e.output){case k.Color:{const s=e.bindParameters.slot===Se.OCCLUDED_TERRAIN?Ll.Occluded:Ll.ColorAndWater;this.transparency===On.Opaque?this._renderMaterialPass(e,r,s):e.offscreenRenderingHelper.renderToTargets(()=>this._renderMaterialPass(e,r,s),e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]);break}case k.Depth:case k.Normal:this._renderAuxiliaryPass(e,r,Ll.None);break;case k.Highlight:this.needsHighlight&&this._renderAuxiliaryPass(e,r,Ll.Highlight);break;case k.Shadow:case k.ShadowExcludeHighlight:this._castShadows&&i&&this._renderAuxiliaryPass(e,r,Ll.None);break;case k.ObjectAndLayerIdColor:this._renderAuxiliaryPass(e,r,Ll.ObjectAndLayerIdColor)}}_renderMaterialPass(e,r,i){const{rctx:s}=e;this._passParameters.overlaySource=i,s.bindTechnique(r,this._passParameters,e.bindParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this._renderPatchGroups(e,r,i)}_renderAuxiliaryPass(e,r,i){const s=e.rctx;this._passParameters.overlaySource=i,s.bindTechnique(r,this._passParameters,e.bindParameters),this._renderPatchGroupsAuxiliary(e,r,i)}updateTileBackground(e=null){if(C(this._tileRenderer))return;const r=this._tileRenderer;let i=null;if(v(e)){const s=Ze.toUnitRGBA(e);i=$e(s[0]||0,s[1]||0,s[2]||0)}r.setBackground(i),this._allTiles.forAll(s=>r.updateTileTexture(s,yn.FADING)),this._techniqueConfiguration.tileBlendInput=r.backgroundIsGrid?zf.GridComposite:v(r.backgroundColor)?zf.ColorComposite:zf.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this._patchGroupsDirty&&(this._highestVisibleLODTile=null,this._rebuildPatchGroups(),this._patchGroupsDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==dE.NONE){const e=Array.from(this._patchGroups.values()),r=this._stencilEnabledLayerExtents;for(const i of e)tEe(this.renderOrder,i,r);e.sort((i,s)=>rEe(i[0],s[0],this.renderOrder)),this._patchGroups=new Map(e.map(i=>[i[0].renderData.localOrigin,i])),this._patchSortingDirty=!1}}_rebuildPatchGroups(){var r;const e=this._rootTiles;if(!C(e)){(r=e[0])==null||r.surface.checkAllTilesWaterproofness(),this._patchGroups.clear();for(const i of e)this._rebuildPatchGroupsForRootTile(i)}}_rebuildPatchGroupsForRootTile(e){const r=this._tileIterator;for(r.resetOne(e);!r.done;){const i=r.next(),s=i.renderData;if(!s){this._numTilesCulled++;continue}if(!i.visible){this._numTilesCulled++,r.skipSubtree();continue}const n=s.localOrigin;let o=this._patchGroups.get(n);o||(o=new Array,this._patchGroups.set(n,o)),o.push(i),(!this._highestVisibleLODTile||i.vlevel>this._highestVisibleLODTile.vlevel)&&(this._highestVisibleLODTile=i),r.skipSubtree()}}_useStencilForTile(e){for(const r of this._stencilEnabledLayerExtents)if(e.intersectsExtent(r))return!0;return!1}_renderPatchGroupsAuxiliary(e,r,i){const s=this._stencilEnabledLayerExtents.length>0;this._patchGroups.forEach(n=>{const o=n[0].renderData.localOrigin;r.program.bindDraw(new qj(o),e.bindParameters,this._passParameters);for(let a=0;a<n.length;a++)this._renderPatch(e,r,n[a],$t.TRIANGLES,s,i)}),e.rctx.bindVAO(null)}_renderPatchGroups(e,r,i){const s=e.bindParameters.camera,n=r.program;if(this._techniqueConfiguration.screenSizePerspective&&this.pointsOfInterest){const p=Nwe(this._stage.viewingMode,this._ellipsoidRadius),f=this.pointsOfInterest.centerOnSurfaceFrequent.distance;p.update({distance:f,fovY:s.fovY})}const o=this._stencilEnabledLayerExtents.length>0,a=i===Ll.Occluded;a&&(n.bindTexture("tex",this._emptyTex),n.setUniform3fv("textureOpacities",ma),n.setUniform4fv("texOffsetAndScale",qf));const l=v(this._tileRenderer)&&v(this._tileRenderer.backgroundColor)?this._tileRenderer.backgroundColor:ma;this._techniqueConfiguration.tileBlendInput===zf.ColorComposite&&n.setUniform3fv("backgroundColor",l);const c=this.wireframe?$t.LINES:$t.TRIANGLES;this._techniqueConfiguration.textureFadingEnabled&&n.bindTexture("texNext",this._emptyTex);const h=this._patchGroups;for(const p of h.values()){const f=p[0].renderData.localOrigin;r.program.bindDraw(new qj(f),e.bindParameters,this._passParameters),this._numOriginsRendered++;for(const m of p){const y=m.renderData,_=y.textureReference;if(!C(_)){if(!a){n.setUniform4fv("texOffsetAndScale",_.offsetAndScale),n.bindTexture("tex",_.texture.texture);const b=y.textureFadeFactor,x=b<1?y.nextTextureReference:null;this._techniqueConfiguration.textureFadingEnabled&&v(x)&&b<1?(n.setUniform1f("fadeFactor",b),n.setUniform4fv("nextTexOffsetAndScale",x.offsetAndScale),n.setUniform3fv("nextTexOpacities",x.opacities),n.bindTexture("texNext",x.texture.texture)):n.setUniform1f("fadeFactor",1),y.textureIsFading&&this.setNeedsRender(),n.setUniform3fv("textureOpacities",_.opacities)}this._renderPatch(e,r,m,c,o,i),m.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}e.rctx.bindVAO(null)}_renderPatch(e,r,i,s,n,o){const a=i.renderData,l=a.vao,c=l.indexBuffer;if(C(c))return void(xn&&console.error("Rendered tile with no indices: ",i.lij," : ",a));const h=r.program;o===Ll.None||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(h,a.overlay),n&&(r.useStencil=this._useStencilForTile(i),r.bindPipelineState(e.rctx,e.bindParameters.slot));const p=a.geometryInfo.indexCount;e.rctx.bindVAO(l),h.assertCompatibleVertexAttributeLocations(l),e.rctx.drawElements(s,p,c.indexType,0)}_bindOverlayPatchData(e,r){e.setUniform4fv("overlayTexOffset",r.offsets),e.setUniform4fv("overlayTexScale",r.scales)}_updateTechnique(e,r){return this._techniqueConfiguration.output=e,e===k.Color&&(this._techniqueConfiguration.atmosphere=this._isGlobal&&this._velvetOverground),this._techniqueConfiguration.renderOccluded=r,this._techniqueConfiguration.stencilEnabled=!1,this._shaderTechnique=this._techniqueRepository.releaseAndAcquire(uEe,this._techniqueConfiguration,this._shaderTechnique),this._shaderTechnique}get test(){return{tileRenderer:this._tileRenderer}}};u([d({constructOnly:!0})],uc.prototype,"_overlayRenderer",void 0),u([d({constructOnly:!0})],uc.prototype,"_stage",void 0),u([d({readOnly:!0})],uc.prototype,"_isGlobal",null),u([d({constructOnly:!0})],uc.prototype,"_allTiles",void 0),u([d({constructOnly:!0})],uc.prototype,"_ellipsoidRadius",void 0),u([d({value:!1})],uc.prototype,"renderingDisabled",null),u([d()],uc.prototype,"renderPatchBorders",null),u([d()],uc.prototype,"visualizeNormals",null),u([d()],uc.prototype,"cullBackFaces",null),u([d({value:dE.FRONT_TO_BACK})],uc.prototype,"renderOrder",null),u([d()],uc.prototype,"wireframe",null),uc=u([I("esri.views.3d.terrain.TerrainRenderer")],uc);const tgt=M(),rgt=M(),iT=M(),igt=M();let sgt=class{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}},gf=class extends Te{constructor(e){super(e),this._handles=new ei}initialize(){this._handles.add(this.layers.on("change",()=>this._update())),this._handles.add(ie(()=>this.extentHelper.layerViewsExtent,()=>this._setAdHocTilingScheme())),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._handles=ke(this._handles),this._waitTask=null}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some(r=>!(!B3(r)||r.isRejected())&&!(r.isFulfilled()&&!ngt(r,this.viewSpatialReference,this.viewingMode))&&(e=r,!((r==null?void 0:r.type)==="vector-tile"||BF(r)))),e)if(e.isResolved()){const r=c6(e,this.viewSpatialReference,this.viewingMode);if(v(r)){const i=new Tc(r.tileInfo);this._lockTilingScheme(i)}}else this._updateWhen(e)}_updateWhen(e){const r=e.when().catch(()=>{}).then(()=>{r!==this._waitTask||this.destroyed||this._update()});this._waitTask=r}_lockTilingScheme(e){if(this.viewingMode===Be.Global){const r=e.levels.length-1;e.spatialReference.isWebMercator?e=Tc.makeWebMercatorAuxiliarySphere(r):vw(e.spatialReference)&&(e=Tc.makeGCSWithTileSize(e.spatialReference,e.pixelSize,r))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this._handles.removeAll(),this._handles.add(ie(()=>this.extentHelper.tiledLayersExtent,()=>this._updateTiledLayerExtent()))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===Be.Global){const e=this.extentHelper.viewSpatialReference,r=vw(e)||fm(e)||mm(e);e.isWebMercator?this.tilingScheme=Tc.WebMercatorAuxiliarySphere:r&&(this.tilingScheme=Tc.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;v(e)&&!qb(e,this.extent)&&(this.tilingScheme=Tc.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){return{lockTilingScheme:e=>this._lockTilingScheme(e),done:!this._waitTask}}};function ngt(t,e,r){return v(c6(t,e,r))}u([d()],gf.prototype,"tilingScheme",void 0),u([d({readOnly:!0})],gf.prototype,"extent",void 0),u([d({value:!1})],gf.prototype,"tilingSchemeLocked",void 0),u([d({constructOnly:!0})],gf.prototype,"viewSpatialReference",void 0),u([d({constructOnly:!0})],gf.prototype,"layers",void 0),u([d({constructOnly:!0})],gf.prototype,"extentHelper",void 0),u([d({constructOnly:!0})],gf.prototype,"viewingMode",void 0),gf=u([I("esri.views.3d.terrain.TilingSchemeLogic")],gf);let ogt=class{constructor(){this.offset=Je(),this.scale=0,this.tile=null}init(e,r,i,s){this.tile=e,this.offset[0]=r,this.offset[1]=i,this.scale=s}dispose(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0}},tr=class extends vs.EventedMixin(Te){constructor(e){var r,i;super(e),this._scaleRangeQueries=new ED,this._iteratorPool=new Co(eEe,s=>s.remove=()=>this._iteratorPool.release(s)),this._postorderIterator=new Jpt,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._visibleCached=!1,this._usedMemory=null,this._performanceInfo=new sgt,this._viewChanged=!1,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=M(),this._eyePosSurfaceSR=M(),this._splitLimits=new ymt,this._frustum=pO(),this._viewProjectionMatrix=Ie(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._handles=new ei,this._watchUpdatingTracking=new Hf,this._frameTask=XS,this._allTiles=new Jt,this._upsampleInfoPool=new Co(ogt),this._rootTilesExtent=ur(),this.updatingProgress=0,this._maxNumUpdating=1,this.maxTextureScale=1.2,this._spatialReference=et.WebMercator,this.visibleElevationBounds=new F2(1/0,-1/0),this.rootTileElevationBounds=new F2(1/0,-1/0),this._updatingRootTiles=!1,this._pendingTilesForElevationUpdateEvent=new Set,this._pendingTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this.oneBatchPerFrameTask=!0,this._layerViewsDirty=!1,this._shading=!0,this._isWebMercator=!1,this._isWebMercatorOnPlateeCarree=!1,this._isGlobal=!((i=(r=e.view)==null?void 0:r.state)!=null&&i.isLocal)}initialize(){this._lercDecoder=wpt(this.view.resourceController),this._tilePool=this.view.state.isLocal?new Co(pmt):new Co(mmt);const e=this.view.resourceController.memoryController;this._upsampleMapCache=e.newCache("esri.views.3d.terrain.upsample",o=>o.unloadMapData()),this._elevationQueryCache=new vpt(e.newCache("elevation-query")),this._set("overlayManager",new Rl({surface:this})),this._handles.add([ie(()=>this.overlayManager.hasHighlights,o=>this._renderer.setNeedsHighlight(o)),ie(()=>this.overlayManager.rendersOccluded,o=>this._renderer.setRenderOccludedOverlay(o)),ie(()=>this.overlayManager.renderer.isEmpty,()=>this._evaluateTransparency())],"overlayManager"),this._renderer=new uc({_overlayRenderer:this.overlayManager.renderer,_ellipsoidRadius:Jr(this.view.spatialReference).radius,_stage:this.view._stage,_allTiles:this._allTiles}),this._handles.add([ie(()=>this.baseOpacity,()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?yn.UNFADED:yn.IMMEDIATE)},js),ie(()=>this.hasCompositeBlendMode,()=>this._updateTileTextures(this._evaluateTransparency()?yn.UNFADED:yn.IMMEDIATE),js),ie(()=>this.renderingDisabled,()=>{var o,a;return(a=(o=this.view)==null?void 0:o._stage)==null?void 0:a.renderer.setParameters({terrainRenderingEnabled:!this.renderingDisabled})},ri),ie(()=>this.backgroundColor,o=>{this._handleLayerViewChanges(),this._renderer.updateTileBackground(o)},js),ie(()=>this.snapLevel,()=>this._viewChanged=!0,ri),ie(()=>this.view.pointsOfInterest,o=>{this._renderer.pointsOfInterest=o,this._watchUpdatingTracking.removeAll(),o&&this._watchUpdatingTracking.add(()=>o.focus.renderLocation,()=>this._allTilesSorted=!1)}),ie(()=>qr.TERRAIN_TILE_TREE_SHOW_TILES,o=>{o&&!this._treeDebugger?te(()=>import("./TerrainTileTree3DDebugger-87fc420d.js"),["assets/TerrainTileTree3DDebugger-87fc420d.js","assets/TileTreeDebugger-3992eb72.js"]).then(({TerrainTileTree3DDebugger:a})=>{!this._treeDebugger&&qr.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new a({view:this.view}))}):o||(this._treeDebugger=ke(this._treeDebugger))},Vt)]);const{spatialReference:r}=this.view;this._extentHelper=Fpt(this.viewingMode,{layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,viewSpatialReference:r});const i=new VR({getCollections:()=>{var o,a,l;return(l=(a=(o=this.view)==null?void 0:o.defaultsFromMap)==null?void 0:a.mapCollections)==null?void 0:l.map(({layers:c})=>c)},getChildrenFunction:o=>o&&"layers"in o?o.layers:null}),s=new gf({layers:i,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:r});this._set("tilingSchemeLogic",s),this._updateTilingScheme(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(Df.ELEVATION),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(Df.BASEMAP);const n=this.view.resourceController.scheduler;this._frameTask=n.registerTask(_t.TERRAIN_SURFACE,this),this._handles.add([ie(()=>this._extentHelper.stencilEnabledExtents,o=>this._renderer.setStencilEnabledLayerExtents(o),Vt),ie(()=>this.tilingSchemeLogic.tilingScheme,()=>this._updateTilingScheme(),ri),ie(()=>this.extent,()=>this._updateRootTiles(),Vt),this.view.on("resize",()=>this._viewChangeUpdate()),ie(()=>{var l,c;const o=this.view,a=o.state;return[this._lodBias,this.lodSnapping,(c=(l=o.resourceController)==null?void 0:l.memoryController)==null?void 0:c.memoryFactor,a.camera,a.contentCamera,a.fixedContentCamera]},()=>this._viewChangeUpdate(),js),ie(()=>{var o,a;return(a=(o=this.view.qualitySettings)==null?void 0:o.tiledSurface)==null?void 0:a.textureFadeDuration},o=>this._renderer.textureFadingEnabled=o>0,Vt),ie(()=>{var o;return(o=this.view.qualitySettings)==null?void 0:o.physicallyBasedRenderingEnabled},o=>this._renderer.pbrMode=o?dt.Terrain:dt.Disabled,Vt),ie(()=>this._userClippingExtent,()=>this._updateClippingExtent(),ri)]),this._handles.add(this.view.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0)),this._handles.add([ie(()=>{var o;return(o=this.view)==null?void 0:o.map.ground.shading},()=>{this._updateShadingIfChanged()})]),this._updateShading(),this._layerViewsDirty=!0,this._handleLayerViewChanges()}destroy(){this._frameTask.remove(),this._handles.destroy(),this._watchUpdatingTracking.destroy(),this._lercDecoder=Bi(this._lercDecoder),this._removeAllTiles(),this._upsampleMapCache=ke(this._upsampleMapCache),this._elevationQueryCache=ke(this._elevationQueryCache);const e=this.tilingSchemeLogic.layers;this._set("tilingSchemeLogic",ke(this.tilingSchemeLogic)),e.destroy(),this._basemapLayerViewHandles.forEach((r,i)=>this._unregisterTiledLayerView(i)),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",ke(this.overlayManager)),this._tilePool=ke(this._tilePool),hJ.prune(),this._treeDebugger=ke(this._treeDebugger),this._renderer=ke(this._renderer),this._iteratorPool=ke(this._iteratorPool),this._set("view",null),this._upsampleInfoPool=ke(this._upsampleInfoPool),Ipt(),Cft()}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){var e,r;if(this.lodSnapping===vR.ON){const i=this.view,s=this.tilingScheme,n=(r=(e=i.pointsOfInterest)==null?void 0:e.cameraOnSurface)==null?void 0:r.scale;if(n&&s){const o=i.state.contentCamera;let a=N5(i,o.eye,o.viewForward,o.up).tilt;a>90&&(a=180-a);const l=2*(a/90)**2,c=s.levelAtScale(n)-l;return Math.round(c)}}return null}get lodSnapping(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?vR.ON:vR.OFF}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get mapTileRequester(){return this._mapDataRequester}get _userClippingExtent(){const{spatialReference:e}=this,{clippingArea:r}=this.view;if(C(r)||C(e))return null;const i=ur(),s=NSe(r,i,e)?i:null,n=this._get("extent");return qb(s,n)?n:s}get rootTilesExtent(){return this._rootTilesExtent}get extent(){const e=oB(this.groundExtent,this._userClippingExtent,ur()),r=this._get("extent");return qb(e,r)?r:e}get groundExtent(){return v(this._tilingSchemeExtent)?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){var e;return(e=this.tilingSchemeLogic)==null?void 0:e.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.running||this._watchUpdatingTracking.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||this.overlayManager.updating)}get running(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries.updating||this._frameTask.updating)&&this.ready&&!this.suspended}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get baseOpacity(){return this.view.map.ground.opacity}set baseOpacity(e){this.view.map.ground.opacity=e}get viewingMode(){return this.view.state.viewingMode}get ready(){return v(this._rootTiles)}set renderOrder(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}get rootTiles(){return this._rootTiles}get spatialReference(){var e;return((e=this.tilingScheme)==null?void 0:e.spatialReference)??null}get backgroundColor(){return this.view.map.ground.surfaceColor}set backgroundColor(e){this.view.map.ground.surfaceColor=e}set slicePlaneEnabled(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),this._evaluateTransparency()}get tilingSchemeLocked(){var e;return((e=this.tilingSchemeLogic)==null?void 0:e.tilingSchemeLocked)??!1}set velvetOverground(e){this._renderer.velvetOverground=e,this._set("velvetOverground",e)}get wireframe(){return this._renderer.wireframe}set wireframe(e){e!==this._renderer.wireframe&&(this._renderer.wireframe=e,this._updateAllTileGeometries())}set _visible(e){e!==this._visibleCached&&(this._visibleCached=e,this._renderer.setVisibility(e),this.suspended=!e)}get opaque(){return this._renderer.transparency===On.Opaque}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}get textureFadeDuration(){return this.view.qualitySettings.tiledSurface.textureFadeDuration??0}intersect(e,r,i,s){this._renderer.intersect(e,r,i,s)}getElevation(e,r,i,s){const n=this._rootTiles;if(C(n)||!n.length||n[0].layerInfo[dr.ELEVATION].length===0)return null;const o=_l;return o[0]=e,o[1]=r,o[2]=i,no(o,s,o,this._spatialReference)?nle(n,o[0],o[1]):(se.getLogger(this.declaredClass).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null)}getElevations(e,r,i){const s=this._rootTiles,n=s?s[0].layerInfo[dr.ELEVATION].length:0;if(!C(s)&&s.length&&n!==0)for(let o=0;o<r;++o){const a=3*o;i(o,nle(s,e[a+0],e[a+1]))}else for(let o=0;o<r;++o)i(o,null)}getScale(e){if(!this.tilingScheme)return null;if(!Jo(e,_l,this.spatialReference))return se.getLogger(this.declaredClass).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const r=this._rootTiles;if(v(r)){for(const i of r)if(i!=null&&i.containsPoint(_l)){let s=i;for(;s.children[0]&&!s.rendered;){const n=s.children[0].extent;let o=0;_l[0]>n[2]&&(o+=1),_l[1]<n[1]&&(o+=2),s=s.children[o]}return this._getLodBiasCorrectedScale(s.level)}}return 1/0}getSphereElevationBounds(e,r,i,s,n){var h;if(_l[0]=e,_l[1]=r,_l[2]=i,_l[3]=s,!no(_l,n,_l,(h=this.tilingScheme)==null?void 0:h.spatialReference))return se.getLogger(this.declaredClass).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;let o=1/0,a=-1/0;const l=p=>{if(p&&VK(p.extent,_l))if(p.isLeaf||p.rendered)o=Math.min(o,p.elevationBounds[0]),a=Math.max(a,p.elevationBounds[1]);else for(const f of p.children)l(f)},c=this._rootTiles;if(v(c))for(const p of c)l(p);return{min:o,max:a}}getSphereScale(e,r){if(!this.tilingScheme)return null;if(!Jo(e,_l,this.spatialReference))return se.getLogger(this.declaredClass).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;_l[3]=r;let i=null;const s=o=>{if(o&&VK(o.extent,_l)){const a=o.children;if(a[0]&&!o.rendered)for(const l of a)s(l);else{const l=this._getLodBiasCorrectedScale(o.level);i=i==null?l:Math.min(i,l)}}},n=this._rootTiles;if(v(n))for(const o of n)s(o);return i}queryVisibleScaleRange(e,r,i,s){const n=r?this.tilingScheme.levelAtScale(r):0,o=i?this.tilingScheme.levelAtScale(i):1/0,a=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(e,n+a,o+a,s)}_evaluateTransparency(){var o,a;const e=this.baseOpacity,r=this.overlayManager.renderer.isEmpty,i=this._renderer.transparency,s=this._allSurfaceLayersTransparent()?r?On.Empty:On.TransparentWithDraped:e>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?On.Opaque:On.Semitransparent,n=i!==s;return n&&(this._renderer.transparency=s,(a=(o=this.view)==null?void 0:o._stage)==null||a.renderer.setParameters({terrainTransparency:this._renderer.transparency})),n}_updateTilingScheme(){var i,s,n;const e=this.tilingSchemeLogic.tilingScheme;if(e===this.tilingScheme)return;Of(!!e,"tiling scheme cannot be reset to undefined"),this._isGlobal=!((s=(i=this.view)==null?void 0:i.state)!=null&&s.isLocal),this.tilingScheme&&this._removeAllTiles();const r=(e==null?void 0:e.spatialReference)??et.WebMercator;this._spatialReference=r,this._isWebMercator=!!(r!=null&&r.isWebMercator),this._isWebMercatorOnPlateeCarree=this._isWebMercator&&mq((n=this.view)==null?void 0:n.renderSpatialReference),this._set("tilingScheme",e),this._updateClippingExtent(),e&&(this._updateTiledLayers(),this._renderer.setTileSize(e.pixelSize),this.overlayManager.setSpatialReference(e.spatialReference),this._updateRootTiles())}_acquireTile(e,r,i,s){const n=this._tilePool.acquire();return b$[0]=e,b$[1]=r,b$[2]=i,n.init(b$,s,this),n}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){const{extent:e,tilingScheme:r}=this;if(!r)return;const i=cgt;let s=r.rootTilesInExtent(e,i,5*E2);if(v(this._rootTiles)){if(s.length>E2)return void se.getLogger(this.declaredClass).warn(hHe);const n=this._rootTiles.map(a=>a.lij),o=pAe(n,s,sle);if(this._updatingRootTiles=!0,o.removed.length>0||o.added.length>0){const a=this._rootTiles.filter(l=>!(o.removed.findIndex(c=>sle(c,l.lij))>-1)||(this._purgeTile(l),!1));o.added.forEach(l=>a.push(this._newRootTile(l))),this._setRootTiles(a)}}else this._updatingRootTiles=!0,s.length>E2&&(se.getLogger(this.declaredClass).warn(dHe),s=r.rootTilesInExtent(e,i,E2)),this._setRootTiles(s.map(n=>this._newRootTile(n)));qb(i,this._rootTilesExtent)||(this._rootTilesExtent=ur(i)),this._visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}_updateAllTileGeometries(){const e=this._allTiles.filter(r=>r.isLoaded&&r.intersectsClippingArea);e.forEach(r=>this._renderer.updateTileGeometryState(r)),e.forEach(r=>r.renderData.updateNeighborData()),this._updateTilesGeometries(e),this._pendingTilesToUpdate.clear()}_updateTilesGeometries(e){if(e.length===0)return;e.sort(qg);const r=this.renderer;e.forEach(i=>r.updateGeometryIfNeeded(i)),e.forEach(i=>this._pendingTilesForElevationUpdateEvent.add(i))}_shouldSplit(e){return e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===Et.SPLIT}_newRootTile(e){const r=this._acquireTile(0,e[1],e[2],null);return this._shouldSplit(r)&&r.setPendingUpdate(Et.SPLIT),this._loadTile(r),this._markTileToUpdate(r),this._updateRootTileElevationBounds(),r}_setRootTiles(e){if(this._rootTiles=e,this._allTiles.clear(),v(e)){const r=this._iteratorPool.acquire();for(r.reset(e);!r.done;)this._allTiles.push(r.next());r.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(e)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this._visibleCached&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(Et.GEOMETRY)&&this._updateTileGeometryState(e)}_updateTilesVisibility(e){if(C(e))return;const r=sft(e),i=this.visibleElevationBounds;let s=r?i.min:1/0,n=r?i.max:-1/0;const o=this.extent,a=this._viewProjectionMatrix;this.setTileTreeDirty();const l=this._iteratorPool.acquire();for(l.reset(e);!l.done;){const c=l.next();c.updateClippingStatus(o)&&c.resetPendingUpdate(Et.GEOMETRY)&&this._updateTileGeometryState(c),c.setPendingUpdate(Et.RENDERDATA),c.computeVisibility(),c.updateScreenDepth(a),c.renderData&&(s=Math.min(c.elevationBounds[0],s),n=Math.max(c.elevationBounds[1],n))}l.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._batchUpdatePendingTileGeometries(),isFinite(s)&&isFinite(n)&&(i.min!==s||i.max!==n)&&(this.visibleElevationBounds=new F2(s,n))}_updateRootTileElevationBounds(){let e=1/0,r=-1/0;const i=this._rootTiles;v(i)&&i.forEach(({elevationBounds:n})=>{e=Math.min(e,n[0]),r=Math.max(r,n[1])});const s=this.rootTileElevationBounds;s.min===e&&s.max===r||(this.rootTileElevationBounds=new F2(e,r))}_updateViewDependentParameters(){const{camera:e,contentCamera:r}=this.view.state,i=Math.tan(.5*r.fovX),s=Math.tan(.5*r.fovY),n=this.tilingScheme.pixelSize,o=2**-this._lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=s,this._splitLimits.relativeWidthLimit=n/e.width*this.maxTextureScale*o,this._splitLimits.relativeHeightLimit=n/e.height*this.maxTextureScale*o,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?(C(this._splitLimits.frustum)&&(this._splitLimits.frustum=pO()),tF(this._splitLimits.frustum,r.frustum)):this._splitLimits.frustum=null,tF(this._frustum,e.frustum),gs(this._viewProjectionMatrix,r.projectionMatrix,r.viewMatrix),le(this._eyePosRenderSR,r.eye),no(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateRenderData(e){e.rendered&&!e.shouldLoad&&(NEe(e)?this._loadChildren(e):lgt(e)&&this._loadParent(e))}_updateTileGeometryState(e){e.updateVisibility(),this._renderer.updateTileGeometryState(e)&&this._markTileToUpdate(e),this._usedMemory=null}_markAllTileNeighborsForGeometryUpdate(e){const r=this._pendingTilesToUpdate;e.forEachLoadedNeighbor(i=>{r.add(i)})}_updateTileTexture(e,r){const i=e.resetPendingUpdate(Et.TEXTURE_FADING)?Et.TEXTURE_FADING:!!e.resetPendingUpdate(Et.TEXTURE_NOFADING)&&Et.TEXTURE_NOFADING;i&&(this._renderer.updateTileTexture(e,i),this._usedMemory=null,r.madeProgress())}_emitElevationUpdateEventForTiles(){const e=uk.extent;zh(e),this._pendingTilesForElevationUpdateEvent.forEach(r=>L_(e,r.extent,e)),this._pendingTilesForElevationUpdateEvent.clear(),uk.spatialReference=this.spatialReference,this.emit("elevation-change",uk)}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(e),this._sortTiles(e);const r=!this.view.state.fixedContentCamera;this._mergeAndSplit(e,r),this._updateElevation(e),this._updateTextures(e),r||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._batchUpdatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),e.done&&e.hasProgressed?this.requestUpdate():this.getUsedMemory(),this.notifyChange("updatingProgressValue")}_updateAllTilesStatus(e){if(!this._viewChanged||!this._rootTiles||e.done)return;this._viewChanged=!1;const r=this._iteratorPool.acquire();r.reset(this._rootTiles);const i=this.snapLevel,s=this._splitLimits,n=this._eyePosRenderSR;for(;!r.done;){const o=r.next(),a=o.shouldSplit(s,n,i);if(a!==Et.SPLIT){if(o.resetPendingUpdate(Et.SPLIT)&&o.updateAgentSuspension(),a===Et.VSPLITMERGE&&o.updateAgents(dr.ELEVATION),r.skipSubtree(),!o.isLeaf){o.setPendingUpdate(Et.MERGE),o.resetPendingUpdate(Et.SPLIT);const l=this._iteratorPool.acquire();l.resetOne(o);const c=this._viewProjectionMatrix;for(let h=l.next();!l.done;h=l.next())this._updateClippingStatus(h),h.updateVisibility(),h.updateScreenDepth(c);l.remove()}}else o.resetPendingUpdate(Et.MERGE),o.isLeaf&&(o.setPendingUpdate(Et.SPLIT),r.skipSubtree()),o.rendered&&o.setPendingUpdate(Et.RENDERDATA)}r.remove(),this.requestUpdate(),(this.shortBatches||!this.oneBatchPerFrameTask)&&this._batchUpdatePendingTileGeometries(),e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||(rft(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}_markTileToUpdate(e){Re(e.isLoaded),e.intersectsClippingArea&&(this._pendingTilesToUpdate.add(e),this._markAllTileNeighborsForGeometryUpdate(e))}_batchUpdatePendingTileGeometries(){const e=this._pendingTilesToUpdate;if(e.size===0)return;const r=Array.from(this._pendingTilesToUpdate.keys()).filter(n=>n.isLoaded&&n.intersectsClippingArea),i=(n,o)=>{!(o!=null&&o.isLoaded)||!o.intersectsClippingArea||o.level<n.level||e.has(o)||(e.add(o),r.push(o),o.renderData.updateNeighborData())};r.sort(qg);const s=r.length;for(let n=0;n<s;++n){const o=r[n];Re(o.isLoaded),Re(o.intersectsClippingArea);const a=o.renderData;a.updateNeighborData();const l=a._dirtyEdgeResolutions,c=a.geometryState.neighborData;for(let h=0;h<4;++h)if(l&1<<h){const p=a.geometryState.neighborData.edgePeerNeighbors[h];p&&(p==null?void 0:p.level)>=o.level&&p.forAllSubtreeOnSide(GF(Bf[h]),f=>!(!f.isLoaded||!f.intersectsClippingArea)&&(Re(e.has(f)||qg(o,f)<0),i(o,f),!0)),i(o,c.cornerPeerNeighbors[h]),i(o,c.cornerPeerNeighbors[(h+1)%4])}}e.clear(),this._updateTilesGeometries(r),xn&&VF&&this.checkAllTilesWaterproofness()}_mergeAndSplit(e,r){if(this.suspended||e.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let i=!1;const s=this.view.state.fixedContentCamera;let n=!1;for(;!e.done;){n=!0;let o=!1;const a=!this._allTiles.some(l=>{var h;if(!i&&!s&&!l.visible)return e.done;let c=l;if(l.resetPendingUpdate(Et.MERGE)){if(!r)return l.setPendingUpdate(Et.MERGE),e.done;for(;(h=c.parent)!=null&&h.resetPendingUpdate(Et.MERGE);)c=c.parent;this._mergeTile(c),o=!0,e.madeProgress()}else l.resetPendingUpdate(Et.SPLIT)&&(this._splitTile(l),o=!0,e.madeProgress());return!e.done&&c===l&&l.resetPendingUpdate(Et.RENDERDATA)&&(this._updateRenderData(l),e.madeProgress()),e.done});if(o&&(this._allTilesSorted=!1,this._allTilesDirty=!0),a){if(!i){i=!0;continue}if(!o)break}else this._allTilesDirty=!0}n?e.madeProgress():this._allTilesDirty=!0,!this.oneBatchPerFrameTask&&this._batchUpdatePendingTileGeometries(),this._sortTiles(e)}_updateElevation(e){e.done||(this._allTiles.some(r=>(r.resetPendingUpdate(Et.GEOMETRY)&&(this._updateTileGeometryState(r),this._updateTileTexture(r,e),this.shortBatches&&this._batchUpdatePendingTileGeometries(),e.madeProgress()),e.done)),!this.oneBatchPerFrameTask&&this._batchUpdatePendingTileGeometries())}_updateTextures(e){e.done||this._allTiles.some(r=>(this._updateTileTexture(r,e),e.done))}_updateClippingExtent(){this.spatialReference&&(this.updateTileOverlayParams(Ps.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get _lodBias(){const e=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*cHe}_getLodBiasCorrectedScale(e){const r=this.tilingScheme.levels,i=ge(e-this._lodBias,0,r.length-1),s=i-Math.floor(i);return r[Math.floor(i)].scale*(1-s)+r[Math.ceil(i)].scale*s}_removeAllTiles(){v(this._rootTiles)&&(this._rootTiles.forEach(e=>this._purgeTile(e)),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this._visible=!1}_purgeDescendantTiles(e){if(!e.children[0])return!1;let r=!1;for(let i=0;i<4;++i)r=this._purgeTile(e.children[i])||r;return e.unsetChildren(),r}_purgeTile(e){const r=this._purgeDescendantTiles(e)||e.rendered;return this._allTiles.removeUnordered(e),this._unloadTile(e),this._tilePool.release(e),r}_unloadTile(e){this._pendingTilesToUpdate.delete(e),this._pendingTilesForElevationUpdateEvent.delete(e),e.unload(this._renderer)}_splitTile(e){Of(e.isLeaf,"tile that is already split should not be split again!");const r=e.level+1,i=2*e.lij[1],s=2*e.lij[2];e.setChildren(this._createTile(r,i,s,e),this._createTile(r,i,s+1,e),this._createTile(r,i+1,s,e),this._createTile(r,i+1,s+1,e)),e.setPendingUpdate(Et.RENDERDATA),e.updateAgentSuspension(),this._allTiles.pushArray(e.children),this._allTilesDirty=!0,++this._performanceInfo.numSplit}_emitTileScaleChange(e,r=e.level){w$.spatialReference=this.spatialReference,w$.extent=e.extent,w$.scale=this._getLodBiasCorrectedScale(r),this.emit("scale-change",w$)}_createTile(e,r,i,s){Of(!!s,"_createTile sanity check");const n=this._acquireTile(e,r,i,s);return n.updateClippingStatus(this.extent),n.updateScreenDepth(this._viewProjectionMatrix),this._shouldSplit(n)&&n.setPendingUpdate(Et.SPLIT),n}get shortBatches(){return this.view.state.mode!==Sr.IDLE}_mergeTile(e){Of(!e.hasPendingUpdate(Et.SPLIT),"_mergeTile sanity check"),this._purgeDescendantTiles(e)&&(Of(!e.renderData,"_mergeTile sanity check"),this._loadTile(e),this._markTileToUpdate(e),this._emitTileScaleChange(e),this.shortBatches&&this._batchUpdatePendingTileGeometries()),this._allTilesDirty=!0,++this._performanceInfo.numMerged}_loadChildren(e){Of(e.rendered,"parent should be rendered"),this._unloadTile(e);const r=e.children;r.forEach(i=>this._loadTile(i)),r.forEach(i=>this._pendingTilesToUpdate.add(i)),this._markAllTileNeighborsForGeometryUpdate(e),this._emitTileScaleChange(e,e.level+1),this.shortBatches&&this._batchUpdatePendingTileGeometries()}_loadParent(e){const r=e.parent;this._unloadChildren(r),this._loadTile(r),this._markTileToUpdate(r),this._emitTileScaleChange(r,r.level),this.shortBatches&&this._batchUpdatePendingTileGeometries()}_unloadChildren(e){const r=e.children;if(r[0])for(let i=0;i<4;++i){const s=r[i];this._unloadChildren(s),this._unloadTile(s)}}_loadTile(e){e.load(),e.setPendingUpdate(Et.RENDERDATA),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e)}_elevationDataArrived(e,r,i){const s=new Dpt(e.lij,e.extent,i);e.dataArrived(r,dr.ELEVATION,s);const n=[e],o=e.level,a=this._iteratorPool.acquire();for(a.reset(n);!a.done;){const l=a.next();l.findElevationBoundsForLayer(r,o),l.computeElevationBounds()}o===0&&this._updateRootTileElevationBounds(),a.remove(),this._updateTilesVisibility(n)}_handleLayerViewChanges(e=Xa){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let r=!1;const i=new Set;let s=-1;for(const n of this.view.allLayerViews.items)if(i.add(n.uid),DO(n)||YC(n))if(this._basemapLayerViewHandles.has(n.uid)&&!YC(n)){const o=this._layerClassFromLayerView(n),a=this._getLayerIdxByUID(o,n.uid);v(a)&&((a<s||C(s))&&(r=!0),s=a)}else this._registerTiledLayerView(n),n.layer.loaded&&(r=!0);this._basemapLayerViewHandles.forEach((n,o)=>{i.has(o)||(this._unregisterTiledLayerView(o),r=!0)}),r&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),e.madeProgress()}_allSurfaceLayersTransparent(){var r,i;let e=((i=(r=this.view.map)==null?void 0:r.ground)==null?void 0:i.opacity)===0;for(const s of this.view.allLayerViews.items)if(uH(s)&&!Vhe(s.layer)&&s.fullOpacity!==0)return e=!1,e;return e}_hasCompositeBlendMode(){for(const e of this.view.allLayerViews.items)if((zF(e)||YC(e))&&uft(gH[e.layer.blendMode]))return!0;return!1}_layerClassFromLayerView(e){return cH(e)?dr.ELEVATION:dr.MAP}_registerTiledLayerView(e){const r=[];if((zF(e)||YC(e))&&r.push(ie(()=>e.layer.blendMode,()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(yn.UNFADED)})),YC(e))return;const i=this._layerClassFromLayerView(e);r.push(ie(()=>e.suspended,()=>this._updateTiledLayers())),r.push(ie(()=>e.fullOpacity,()=>this._updateTileTextures(yn.UNFADED))),r.push(ie(()=>"effectiveScaleRange"in e.layer?e.layer.effectiveScaleRange:null,()=>this._restartAllAgents(i))),e.on("data-changed",()=>{const s=this._getLayerIdxByUID(i,e.uid);v(s)&&this._invalidateLayerData(s,i)}),this._basemapLayerViewHandles.set(e.uid,r)}_unregisterTiledLayerView(e){const r=this._basemapLayerViewHandles.get(e);if(r){for(let i=0;i<r.length;i++)r[i].remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,r=[[],[]];let i=null;e.forEach(s=>{if(!s.layer||s.suspended||!DO(s)||!s.fullExtent)return;const n=this._layerClassFromLayerView(s);if(n===dr.MAP){const o=s.displayLevelRange.maxLevel;o!==1/0&&(i===null||o>i)&&(i=o)}r[n].push(s)});for(const s of ab){const n=this._layerViews[s],o=r[s];o.reverse();const a=o.length;let l=n.length!==a;const c=new Array(a),h=new Array(n.length);this._layerIndexByUid[s].clear();for(let p=0;p<a;p++){const f=o[p].uid;this._layerIndexByUid[s].set(f,p);const m=n.indexOf(o[p]);c[p]=m,p!==m&&(l=!0),m>-1&&(h[m]=p)}if(l){const p=this._postorderIterator;for(p.reset(this._rootTiles);!p.done;)p.next().modifyLayers(h,c,s);this._layerViews[s]=o,this._restartAllAgents(s),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate()}_restartAllAgents(e){const r=this._postorderIterator;for(r.reset(this._rootTiles);!r.done;){const i=r.next();i.restartAgents(e),e===dr.ELEVATION&&i.computeElevationBounds()}this._updateRootTileElevationBounds()}layerViewByIndex(e,r){return this._layerViews[r][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll(r=>{r.updateAgents(dr.MAP),e===yn.IMMEDIATE?this.renderer.updateTileTexture(r,Et.TEXTURE_NOFADING):r.updateRenderData(dr.MAP,e)}),this._evaluateTransparency()}_invalidateLayerData(e,r){this._allTiles.forAll(i=>i.removeLayerAgent(e,r)),this._allTiles.forAll(i=>i.invalidateLayerData(e,r))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(e=Ps.UPDATE){this.renderer.setNeedsRender(e)}requestUpdate(){++this._pendingUpdates==1&&(this._hasPendingUpdates=!0)}requestTileData(e,r,i,s){const n=this.layerViewByIndex(r,i),o=n.layer;return!o.tilemapCache||LO(n)?this._requestTileData(e,i,n,s):(++this._asyncWorkItems,o.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],{...s,timeout:6e3}).then(()=>--this._asyncWorkItems).catch(a=>{throw--this._asyncWorkItems,fr(s),Qs(a)||this._dataMissing(e,i,n,{notInTilemap:!0}),a}).then(()=>this._frameTask.schedule(()=>this._requestTileData(e,i,n,s),s.signal)))}_requestTileData(e,r,i,s){return r===dr.ELEVATION?cH(i)?this._requestElevationTileData(e,i,s):Promise.reject():uH(i)?this._requestMapTileData(e,i,s):Promise.reject()}_requestElevationTileData(e,r,i){++this._asyncWorkItems;const s=a=>{if(Ln(i))return;const l=this._layerIndexByUid[dr.ELEVATION].get(r.uid);l!=null?(this._usedMemory=null,this.requestUpdate(),this._elevationDataArrived(e,l,a)):se.getLogger(this.declaredClass).warn("TerrainSurface: received data from unknown layer %d %s",dr.ELEVATION,e.lij.toString())},n=a=>{Qs(a)||(this._dataMissing(e,dr.ELEVATION,r,a),this.requestUpdate())};if(xae(r.layer))return r.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:oO,signal:i.signal}).then(a=>{if(!Ln(i))return this._frameTask.schedule(()=>s(a),i.signal,n);se.getLogger(this.declaredClass).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true.")},n).finally(()=>{--this._asyncWorkItems});const o=r.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(o,"binary",i).then(a=>this._lercDecoder.decode(a,{noDataValue:oO},i.signal)).then(a=>{a?s(new bpt(a)):n(new Error("LERC decoding failed"))},n).finally(()=>{--this._asyncWorkItems})}_requestMapTileData(e,r,i){++this._asyncWorkItems;const s=(h,p)=>{--this._asyncWorkItems,hS(p),Ln(i)||(this._dataMissing(e,dr.MAP,r,h),this.requestUpdate())},n=h=>p=>s(p,h),o=h=>this._frameTask.schedule(()=>{--this._asyncWorkItems,this.requestUpdate(),Ln(i)?hS(h):this._mapTileDataArrived(e,r,h)},i.signal,n(h)).catch(n(h)),a=(h,p=null)=>this._frameTask.schedule(()=>s(h,p));if(LO(r)){const h=r.schemaHelper.getLevelRowColumn(e.lij);return r.fetchTile(h[0],h[1],h[2],i).then(o,a)}if(l6(r))return r.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(o,a);if(oJ(r)&&xae(r.layer))return r.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(h=>{if(Ln(i))return se.getLogger(this.declaredClass).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void a(Hr());o(h)},a);let l=r.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);mGe(r.layer)&&r.layer.refreshTimestamp&&(l+=`${l.includes("?")?"&":"?"}_ts=${r.layer.refreshTimestamp}`);const c=r.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(l,c,i).then(o,a)}_mapTileDataArrived(e,r,i){const s=this._getLayerIdxByUID(dr.MAP,r.uid);v(s)?e.dataArrived(s,dr.MAP,i):(hS(i),se.getLogger(this.declaredClass).warn("TerrainSurface: received data from unknown layer"))}_getLayerIdxByUID(e,r){return this._layerIndexByUid[e].get(r)}_dataMissing(e,r,i,s){const n=this._getLayerIdxByUID(r,i.uid);v(n)?e.dataMissing(n,r,s):se.getLogger(this.declaredClass).warn("TerrainSurface: received data from unknown layer")}updateTileOverlayParams(e){this._rootTiles&&this.overlayManager&&(this._allTiles.forAll(r=>{r.renderData&&this.overlayManager.setTileParameters(r)}),this._renderer.setNeedsRender(e))}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll(r=>{r.isLeaf&&e.numLeaves++;const i=r.level;r.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),r.visible&&(e.numVisible++,r.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))}),e}getUsedMemory(){return this.tilingScheme?(C(this._usedMemory)&&(this._usedMemory=this._recalculateUsedMemory()),v(this._usedMemory)?this._usedMemory:0):0}_recalculateUsedMemory(){return this.tilingScheme?this._allTiles.reduce((e,r)=>e+r.usedMemory,0):null}getUsedMemoryForLayerView(e){let r=0;const i=this._layerClassFromLayerView(e),s=this._getLayerIdxByUID(i,e.uid);return v(s)&&this._allTiles.forAll(n=>r+=n.getUsedMemoryForLayer(i,s)),r}getTile(e){if(C(e)||C(this._rootTiles))return null;const r=e.split("/").map(a=>+a);if(r[0]===0)return this._rootTiles.find(a=>a.lij[1]===r[1]&&a.lij[2]===r[2]);const i=2**r[0],s=Math.floor(r[1]/i),n=Math.floor(r[2]/i);let o;if(this._rootTiles.some(a=>a.lij[1]===s&&a.lij[2]===n&&(o=a,!0)),o){let a=1<<r[0]-1;for(;o.lij[0]<r[0];){let l=r[1]&a?2:0;if((r[2]&a)>0&&l++,!o.children[l])return null;o=o.children[l],a>>=1}return Of(o.lij[0]===r[0]&&o.lij[1]===r[1]&&o.lij[2]===r[2],"not the right tile?"),o}return null}get renderPatchBorders(){return this._renderer.renderPatchBorders}set renderPatchBorders(e){this._renderer.renderPatchBorders=e}get visualizeNormals(){return this._renderer.visualizeNormals}set visualizeNormals(e){this._renderer.visualizeNormals=e}get renderingDisabled(){return this._renderer.renderingDisabled}set renderingDisabled(e){this._renderer.renderingDisabled=e}get test(){const e=this;return{renderer:e._renderer,lercDecoder:e._lercDecoder,forceReload:()=>{v(e._rootTiles)&&e._rootTiles.length>0&&(e._mergeTile(e._rootTiles[0]),e._viewChangeUpdate())},getTiles:()=>e._allTiles.toArray(),getRenderedTiles(){ck.clear(),e._allTiles.forAll(i=>{i.visible&&i.rendered&&ck.push(i)});const r=ck.toArray();return tEe(e.renderOrder,r),r},lockTilingScheme(r,i){e._extentHelper.defaultTiledLayersExtent=i,e.tilingSchemeLogic.test.lockTilingScheme(r)}}}checkAllTilesWaterproofness(){if(!VF)return;const e=this._rootTiles;if(C(e))return;const r=o=>{var a,l,c;return((c=(l=(a=o==null?void 0:o.renderData)==null?void 0:a.geometryInfo)==null?void 0:l.indices)==null?void 0:c.length)>0},i=(o,a)=>{r(o)&&console.error("Tile[",o.lij,"] has geometry although parent[",a.lij,"] has geom")},s=o=>{var a,l;if(o.intersectsClippingArea)if(o.renderData&&!o.renderData.geometryState&&console.error("Tile[",o.lij,"] has renderData but not geometryState"),o.renderData&&!o.renderData.geometryInfo&&console.error("Tile[",o.lij,"] has renderData but not geometryInfo"),!((a=o.renderData)!=null&&a.geometryInfo)||(((l=o.renderData.geometryInfo.indices)==null?void 0:l.length)??0)>0||console.error("Tile[",o.lij,"] has renderData but no indices - geometryInfo: ",o.renderData.geometryInfo),r(o)){o.checkGeometryWaterproofness();for(const c of o.children)i(c,o)}else if(o.isLeaf)console.error("Tile[",o.lij,"] has no geometry and no children, from root to leaf");else for(const c of o.children)s(c)},n=o=>{var h;const a=((h=o.parent)==null?void 0:h.visible)??!0,l=o.visible;o.computeVisibility();const c=o.visible;if(l!==c&&a&&console.error(" Tile[",o.lij,"] has out of date visibility: ",l," instead of ",c),!o.isLeaf)for(const p of o.children)n(p)};for(const o of e)s(o),n(o)}get isGlobal(){return this._isGlobal}get shading(){return this._shading}_updateShadingIfChanged(){var r,i,s;((s=(i=(r=this.view)==null?void 0:r.map)==null?void 0:i.ground)==null?void 0:s.shading)!==this._shading&&this._updateShading()}_updateShading(){var r,i,s;const e=(s=(i=(r=this.view)==null?void 0:r.map)==null?void 0:i.ground)==null?void 0:s.shading;this._shading=e,this.renderer&&(this.renderer.shading=e,this.renderer.setNeedsRender()),this._updateAllTileGeometries()}get isWebMercator(){return this._isWebMercator}get isWebMercatorOnPlateeCarree(){return this._isWebMercatorOnPlateeCarree}isEastEndWrap(e){return this.isGlobal&&e[2]===this.lijEastEnd(e[0])-1}isWestEndWrap(e){return this.isGlobal&&e[2]===0}lijEastEnd(e){return 2**(e+(v(this.spatialReference)&&this.spatialReference.isGeographic?1:0))}wrapEastWest(e){const r=this.lijEastEnd(e[0]),i=e[2];if(0<=i&&i<r)return e;if(!this.isGlobal)return null;const s=(i+(i<0?r:0))%r;return[e[0],e[1],s]}enableInternalChecks(e){zdt(e)}enableWaterproofnessChecks(e){Bdt(e)}};u([d()],tr.prototype,"_renderer",void 0),u([d({constructOnly:!0})],tr.prototype,"_scaleRangeQueries",void 0),u([d()],tr.prototype,"_hasPendingUpdates",void 0),u([d()],tr.prototype,"_asyncWorkItems",void 0),u([d()],tr.prototype,"_allTilesDirty",void 0),u([d()],tr.prototype,"_allTilesSorted",void 0),u([d()],tr.prototype,"_viewChanged",void 0),u([d({readOnly:!0})],tr.prototype,"_watchUpdatingTracking",void 0),u([d()],tr.prototype,"_frameTask",void 0),u([d({readOnly:!0})],tr.prototype,"snapLevel",null),u([d({readOnly:!0})],tr.prototype,"lodSnapping",null),u([d({constructOnly:!0})],tr.prototype,"view",void 0),u([d()],tr.prototype,"_userClippingExtent",null),u([d()],tr.prototype,"_rootTilesExtent",void 0),u([d({readOnly:!0})],tr.prototype,"extent",null),u([d({readOnly:!0})],tr.prototype,"groundExtent",null),u([d({readOnly:!0})],tr.prototype,"_tilingSchemeExtent",null),u([d({readOnly:!0})],tr.prototype,"updating",null),u([d({readOnly:!0})],tr.prototype,"running",null),u([d($pt)],tr.prototype,"updatingProgress",void 0),u([d({readOnly:!0})],tr.prototype,"updatingProgressValue",null),u([d()],tr.prototype,"_maxNumUpdating",void 0),u([d()],tr.prototype,"baseOpacity",null),u([d()],tr.prototype,"hasCompositeBlendMode",void 0),u([d({readOnly:!0})],tr.prototype,"overlayManager",void 0),u([d({readOnly:!0})],tr.prototype,"viewingMode",null),u([d()],tr.prototype,"maxTextureScale",void 0),u([d({readOnly:!0})],tr.prototype,"ready",null),u([d({value:dE.FRONT_TO_BACK})],tr.prototype,"renderOrder",null),u([d({readOnly:!0})],tr.prototype,"rootTiles",null),u([d()],tr.prototype,"_rootTiles",void 0),u([d({readOnly:!0})],tr.prototype,"spatialReference",null),u([d({type:Ze})],tr.prototype,"backgroundColor",null),u([d({value:!1})],tr.prototype,"slicePlaneEnabled",null),u([d({readOnly:!0})],tr.prototype,"tilingScheme",void 0),u([d({readOnly:!0})],tr.prototype,"tilingSchemeLocked",null),u([d({readOnly:!0})],tr.prototype,"tilingSchemeLogic",void 0),u([d({value:!0})],tr.prototype,"velvetOverground",null),u([d()],tr.prototype,"wireframe",null),u([d({value:!1})],tr.prototype,"suspended",null),u([d()],tr.prototype,"textureFadeDuration",null),u([d()],tr.prototype,"visibleElevationBounds",void 0),u([d()],tr.prototype,"rootTileElevationBounds",void 0),u([d()],tr.prototype,"_layerViewsDirty",void 0),u([d()],tr.prototype,"renderPatchBorders",null),u([d()],tr.prototype,"visualizeNormals",null),u([d()],tr.prototype,"renderingDisabled",null),tr=u([I("esri.views.3d.terrain.TerrainSurface")],tr);const agt=tr;function sle(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function NEe(t){const e=t.children;if(!e[0])return!1;for(const r of e)if(r.shouldLoad)return!0;for(const r of e)if(NEe(r))return!0;return!1}function lgt(t){var e;return t.isLeaf&&(((e=t.parent)==null?void 0:e.shouldLoad)??!1)}const _l=sr(),cgt=ur(),b$=[0,0,0],ck=new Jt,uk={spatialReference:null,extent:ur(),context:"ground"},w$={spatialReference:null,extent:null,scale:0};function nle(t,e,r){var i;for(const s of t){if(!s.containsPointXY(e,r))continue;let n=s;for(;n&&!n.renderData;){const a=(e>n.extentMidX?1:0)+(r<n.extentMidY?2:0);n=n.children[a]}const o=((i=n==null?void 0:n.renderData)==null?void 0:i.geometryState.samplerData)??null;return zi(e,r,o)}return null}let ugt=class{constructor(e,r,i){this.operation=e,this.geometry=r,this.states=i}},R3=class extends Te{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this.dirty=!1}commitLayer(e,r){const i=this._dirtyGeomRecords.get(e);i&&(i.forEach((s,n)=>{const o=this._ensureGeomRecord(e,n);s.forEach(({geometry:a,operation:l,states:c},h)=>{let p=!1;if(l===ss.UPDATE){const f=o.get(h);if(f){if(c&Pn.TRANSFORMATION){const m=this.model.getObject(n);this.model.updateRenderGeometryTransformation(m,a,f)&&(p=!0)}p||r.updates.push({renderGeometry:f,updateType:c})}else ft(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(l===ss.REMOVE||p){const f=o.get(h);f?(r.removes.push(f),o.delete(h)):l===ss.REMOVE&&ft(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove")}if(l===ss.ADD||p){const f=this.model.getObject(n);if(v(f)){const m=this.model.getRenderGeometry(f,a);r.adds.push(m),o.set(h,m)}}}),o.size===0&&this._residentGeomRecords.get(e).delete(n)}),this._residentGeomRecords.get(e).size===0&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e),this.dirty=this._hasDirtyGeometryRecords)}getResidentRenderGeometries(e,r){const i=this._residentGeomRecords.get(e);i&&i.forEach(s=>s.forEach(n=>r.push(n)))}_objectStateChanged(e,r){for(const i of r.geometries)this._updateOrCreateDirtyRecord(r,i,null,ss.UPDATE,e)}visibilityChanged(e){this._objectStateChanged(Pn.VISIBILITY,e)}highlightChanged(e){this._objectStateChanged(Pn.HIGHLIGHT,e)}occlusionChanged(e){this._objectStateChanged(Pn.OCCLUDEE,e)}objectGeometryUpdated(e){this._updateOrCreateDirtyRecord(e.object,e.geometry,null,ss.UPDATE,Pn.GEOMETRY)}layerAdded(e){e.objects.forAll(r=>this._layerObjectAdded(e,r))}layerRemoved(e){e.objects.forAll(r=>this._layerObjectRemoved(e,r))}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object)}_layerObjectAdded(e,r){const i=e.id;for(const s of r.geometries)this._objectGeometryAdded(r,s,i)}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object)}layerObjectsAdded(e){for(const r of e.objects)this._layerObjectAdded(e.layer,r)}layerObjectsRemoved(e){for(const r of e.objects)this._layerObjectRemoved(e.layer,r)}_layerObjectRemoved(e,r){const i=e.id;for(const s of r.geometries)this._objectGeometryRemoved(r,s,i)}shaderTransformationChanged(e){const r=this._residentGeomRecords.get(e.id);r&&r.forEach((i,s)=>{const n=this.model.getObject(s);n&&n.hasVolativeTransformation()&&i.forEach(o=>o.shaderTransformationChanged())})}objectTransformation(e){const r=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(r,i).forEach(s=>{this._updateOrCreateDirtyRecord(e,s.geometry,r,ss.UPDATE,Pn.TRANSFORMATION)})}objectGeometryAdded(e){this._objectGeometryAdded(e.object,e.geometry)}_objectGeometryAdded(e,r,i=null){this._updateOrCreateDirtyRecord(e,r,i,ss.ADD)}objectGeometryRemoved(e){this._objectGeometryRemoved(e.object,e.geometry)}_objectGeometryRemoved(e,r,i=null){this._updateOrCreateDirtyRecord(e,r,i,ss.REMOVE)}_updateOrCreateDirtyRecord(e,r,i,s,n=Pn.NONE){i=It(i,this._getParentLayerId(e));const o=e.id,a=r.id,l=this._ensureDirtyRecord(i,o),c=l.get(a);if(c){const h=c.operation;h===ss.REMOVE&&s===ss.ADD&&c.states!==Pn.NONE?c.operation=ss.UPDATE:h===ss.REMOVE&&s===ss.ADD||h===ss.ADD&&s===ss.REMOVE?l.delete(a):h!==ss.UPDATE||s!==ss.REMOVE&&s!==ss.UPDATE?(ft((h===ss.REMOVE||h===ss.ADD)&&s===ss.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),c.states|=n):(c.operation=s,c.states|=n)}else l.set(a,new ugt(s,r,n));this.dirty=this._hasDirtyGeometryRecords}_ensureGeomRecord(e,r){let i=this._residentGeomRecords.get(e);i||(i=new Map,this._residentGeomRecords.set(e,i));let s=i.get(r);return s||(s=new Map,i.set(r,s)),s}get _hasDirtyGeometryRecords(){return Ho(this._dirtyGeomRecords,e=>Ho(e,r=>r&&r.size>0))}_ensureDirtyRecord(e,r){let i=this._dirtyGeomRecords.get(e);i||(i=new Map,this._dirtyGeomRecords.set(e,i));let s=i.get(r);return s||(s=new Map,i.set(r,s)),s}_getParentLayerId(e){return v(e.parentLayer)?e.parentLayer.id:c3e}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let r="";return this._dirtyGeomRecords.forEach((i,s)=>{i.forEach((n,o)=>{r.length>0&&(r+=`
`),r+=s+"."+o;const a=[];n.forEach(l=>{const c=l.operation;a[c]||(a[c]=[]),a[c].push(l.geometry.id)});for(let l=0;l<a.length;l++)if(a[l]){r+=" "+e[l-1]+": ";for(let c=0;c<a[l].length;c++)r+=a[l][c]+", "}})}),r}get test(){const e=this;return{get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce((r,i)=>r+i.size,0)},commit:r=>e._dirtyGeomRecords.forEach((i,s)=>e.commitLayer(s,r))}}};u([d({constructOnly:!0})],R3.prototype,"model",void 0),u([d()],R3.prototype,"dirty",void 0),R3=u([I("esri.views.3d.webgl-engine.lib.ModelDirtySet")],R3);const hgt=R3;let RD=class extends Te{constructor(){super(...arguments),this.dirtySet=new hgt({model:this}),this._content=new Map,this._originFactory=new FZ(null)}getObject(e){return this._content.get(e)}add(e){const r=e.id;ft(!this._content.has(r),"Model/Stage already contains object to be added"),this._content.set(r,e),MF(e)&&this.dirtySet.layerAdded(e)}remove(e){ft(this._content.has(e.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(e.id),e.unload(),MF(e)&&this.dirtySet.layerRemoved(e)}addMany(e){for(const r of e)v(r)&&(ft(!this._content.has(r.id),"Model/Stage already contains object to be added"),this._content.set(r.id,r))}removeMany(e){for(const r of e)ft(this._content.has(r.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(r.id),r.unload()}has(e){return this._content.has(e.id)}forEachOfType(e,r){this._content.forEach(i=>{i.type===e&&r(i)})}getRenderGeometry(e,r){const{shaderTransformer:i,localOrigin:s}=r,n=new uE(r,{boundingInfo:r.boundingInfo,shaderTransformer:i,castShadow:e.castShadow});return n.updateTransformation(o=>e.getCombinedStaticTransformation(r,o)),n.localOrigin=v(s)?s:this._originFactory.getOrigin(n.boundingSphere),n}updateRenderGeometryTransformation(e,r,i){if(C(e))return!1;i.updateTransformation(n=>e.getCombinedStaticTransformation(r,n));const s=this._originFactory.getOrigin(i.boundingSphere);return i.localOrigin!==s}getStats(){const e={},r=Array.from(this._content.values());for(let i=0;i<$s.COUNT;++i)e[i]=r.filter(s=>s.type===i).length;return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){return{content:Array.from(this._content.values())}}};u([d({constructOnly:!0})],RD.prototype,"dirtySet",void 0),RD=u([I("esri.views.3d.webgl-engine.parts.Model")],RD);function dgt(){const t=new Float32Array(4);return t[3]=1,t}function FEe(t){const e=new Float32Array(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function pgt(t,e,r,i){const s=new Float32Array(4);return s[0]=t,s[1]=e,s[2]=r,s[3]=i,s}function UEe(t,e){return new Float32Array(t,e,4)}Object.freeze(Object.defineProperty({__proto__:null,clone:FEe,create:dgt,createView:UEe,fromValues:pgt},Symbol.toStringTag,{value:"Module"}));const pE=1e-6,eA=[0,0,0],x$=[0,0,0];function fgt(t,e){const{data:r,size:i}=t,s=r.length/i;if(s<=0)return;const n=new Tgt(t);OD(eA,n.minProj,n.maxProj),Ob(eA,eA,.5),Eh(x$,n.maxProj,n.minProj);const o=xH(x$),a=new Sgt;a.quality=o,s<14&&(t=new Xe(new Float64Array(n.buffer,112,42),3));const l=[0,0,0],c=[0,0,0],h=[0,0,0],p=[0,0,0],f=[0,0,0],m=[0,0,0],y=[0,0,0];switch(mgt(n,t,y,l,c,h,p,f,m,a)){case 1:return void cle(eA,x$,e);case 2:return void xgt(t,p,e)}ggt(t,y,l,c,h,p,f,m,a),kEe(t,a.b0,a.b1,a.b2,fS,mS);const _=[0,0,0];Eh(_,mS,fS),a.quality=xH(_),a.quality<o?VEe(a.b0,a.b1,a.b2,fS,mS,_,e):cle(eA,x$,e)}function mgt(t,e,r,i,s,n,o,a,l,c){return ygt(t,i,s),TH(i,s)<pE?1:(Eh(o,i,s),Bo(o,o),_gt(e,i,o,n)<pE?2:(Eh(a,s,n),Bo(a,a),Eh(l,n,i),Bo(l,l),Ch(r,a,o),Bo(r,r),lb(e,r,o,a,l,c),0))}const tA=[0,0,0],rA=[0,0,0],Yu=[0,0,0],Zu=[0,0,0],Ju=[0,0,0],a0=[0,0,0],l0=[0,0,0],c0=[0,0,0];function ggt(t,e,r,i,s,n,o,a,l){vgt(t,e,r,tA,rA),tA[0]!==void 0&&(Eh(Yu,tA,r),Bo(Yu,Yu),Eh(Zu,tA,i),Bo(Zu,Zu),Eh(Ju,tA,s),Bo(Ju,Ju),Ch(a0,Zu,n),Bo(a0,a0),Ch(l0,Ju,o),Bo(l0,l0),Ch(c0,Yu,a),Bo(c0,c0),lb(t,a0,n,Zu,Yu,l),lb(t,l0,o,Ju,Zu,l),lb(t,c0,a,Yu,Ju,l)),rA[0]!==void 0&&(Eh(Yu,rA,r),Bo(Yu,Yu),Eh(Zu,rA,i),Bo(Zu,Zu),Eh(Ju,rA,s),Bo(Ju,Ju),Ch(a0,Zu,n),Bo(a0,a0),Ch(l0,Ju,o),Bo(l0,l0),Ch(c0,Yu,a),Bo(c0,c0),lb(t,a0,n,Zu,Yu,l),lb(t,l0,o,Ju,Zu,l),lb(t,c0,a,Yu,Ju,l))}function ygt(t,e,r){let i=TH(t.maxVert[0],t.minVert[0]),s=0;for(let n=1;n<7;++n){const o=TH(t.maxVert[n],t.minVert[n]);o>i&&(i=o,s=n)}Mc(e,t.minVert[s]),Mc(r,t.maxVert[s])}const Ku=[0,0,0];function _gt(t,e,r,i){const{data:s,size:n}=t;let o=Number.NEGATIVE_INFINITY,a=0;for(let l=0;l<s.length;l+=n){Ku[0]=s[l]-e[0],Ku[1]=s[l+1]-e[1],Ku[2]=s[l+2]-e[2];const c=r[0]*Ku[0]+r[1]*Ku[1]+r[2]*Ku[2],h=r[0]*r[0]+r[1]*r[1]+r[2]*r[2],p=Ku[0]*Ku[0]+Ku[1]*Ku[1]+Ku[2]*Ku[2]-c*c/h;p>o&&(o=p,a=l)}return Mc(i,s,a),o}const Mn=[0,0];function vgt(t,e,r,i,s){wgt(t,e,Mn,s,i);const n=zEe(r,e);Mn[1]-pE<=n&&(i[0]=void 0),Mn[0]+pE>=n&&(s[0]=void 0)}const ole=[0,0,0],ale=[0,0,0],lle=[0,0,0],sT=[0,0,0],nT=[0,0,0],T$=[0,0,0];function lb(t,e,r,i,s,n){if(BEe(e)<pE)return;Ch(ole,r,e),Ch(ale,i,e),Ch(lle,s,e),pS(t,e,Mn),nT[1]=Mn[0],sT[1]=Mn[1],T$[1]=sT[1]-nT[1];const o=[r,i,s],a=[ole,ale,lle];for(let l=0;l<3;++l){pS(t,o[l],Mn),nT[0]=Mn[0],sT[0]=Mn[1],pS(t,a[l],Mn),nT[2]=Mn[0],sT[2]=Mn[1],T$[0]=sT[0]-nT[0],T$[2]=sT[2]-nT[2];const c=xH(T$);c<n.quality&&(Mc(n.b0,o[l]),Mc(n.b1,e),Mc(n.b2,a[l]),n.quality=c)}}const bgt=[0,0,0];function pS(t,e,r){const{data:i,size:s}=t;r[0]=Number.POSITIVE_INFINITY,r[1]=Number.NEGATIVE_INFINITY;for(let n=0;n<i.length;n+=s){const o=i[n]*e[0]+i[n+1]*e[1]+i[n+2]*e[2];r[0]=Math.min(r[0],o),r[1]=Math.max(r[1],o)}}function wgt(t,e,r,i,s){const{data:n,size:o}=t;Mc(i,n),Mc(s,i),r[0]=zEe(bgt,e),r[1]=r[0];for(let a=o;a<n.length;a+=o){const l=n[a]*e[0]+n[a+1]*e[1]+n[a+2]*e[2];l<r[0]&&(r[0]=l,Mc(i,n,a)),l>r[1]&&(r[1]=l,Mc(s,n,a))}}function cle(t,e,r){Mc(r.center,t),Ob(r.halfSize,e,.5),r.quaternion[0]=0,r.quaternion[1]=0,r.quaternion[2]=0,r.quaternion[3]=1}const qm=[0,0,0],oT=[0,0,0],iA=[0,0,0],fS=[0,0,0],mS=[0,0,0],ule=[0,0,0];function xgt(t,e,r){Mc(qm,e),Math.abs(e[0])>Math.abs(e[1])&&Math.abs(e[0])>Math.abs(e[2])?qm[0]=0:Math.abs(e[1])>Math.abs(e[2])?qm[1]=0:qm[2]=0,BEe(qm)<pE&&(qm[0]=qm[1]=qm[2]=1),Ch(oT,e,qm),Bo(oT,oT),Ch(iA,e,oT),Bo(iA,iA),kEe(t,e,oT,iA,fS,mS),Eh(ule,mS,fS),VEe(e,oT,iA,fS,mS,ule,r)}function kEe(t,e,r,i,s,n){pS(t,e,Mn),s[0]=Mn[0],n[0]=Mn[1],pS(t,r,Mn),s[1]=Mn[0],n[1]=Mn[1],pS(t,i,Mn),s[2]=Mn[0],n[2]=Mn[1]}const S$=[0,0,0],Hp=[1,0,0,0,1,0,0,0,1],aT=[0,0,0];function VEe(t,e,r,i,s,n,o){Hp[0]=t[0],Hp[1]=t[1],Hp[2]=t[2],Hp[3]=e[0],Hp[4]=e[1],Hp[5]=e[2],Hp[6]=r[0],Hp[7]=r[1],Hp[8]=r[2],Egt(o.quaternion,Hp),OD(aT,i,s),Ob(aT,aT,.5),Ob(o.center,t,aT[0]),Ob(S$,e,aT[1]),OD(o.center,o.center,S$),Ob(S$,r,aT[2]),OD(o.center,o.center,S$),Ob(o.halfSize,n,.5)}const Zc=7;let Tgt=class{constructor(e){this.minVert=new Array(Zc),this.maxVert=new Array(Zc);const r=64*Zc;this.buffer=new ArrayBuffer(r);let i=0;this.minProj=new Float64Array(this.buffer,i,Zc),i+=8*Zc,this.maxProj=new Float64Array(this.buffer,i,Zc),i+=8*Zc;for(let l=0;l<Zc;++l)this.minVert[l]=new Float64Array(this.buffer,i,3),i+=24;for(let l=0;l<Zc;++l)this.maxVert[l]=new Float64Array(this.buffer,i,3),i+=24;for(let l=0;l<Zc;++l)this.minProj[l]=Number.POSITIVE_INFINITY,this.maxProj[l]=Number.NEGATIVE_INFINITY;const s=new Array(Zc),n=new Array(Zc),{data:o,size:a}=e;for(let l=0;l<o.length;l+=a){let c=o[l];c<this.minProj[0]&&(this.minProj[0]=c,s[0]=l),c>this.maxProj[0]&&(this.maxProj[0]=c,n[0]=l),c=o[l+1],c<this.minProj[1]&&(this.minProj[1]=c,s[1]=l),c>this.maxProj[1]&&(this.maxProj[1]=c,n[1]=l),c=o[l+2],c<this.minProj[2]&&(this.minProj[2]=c,s[2]=l),c>this.maxProj[2]&&(this.maxProj[2]=c,n[2]=l),c=o[l]+o[l+1]+o[l+2],c<this.minProj[3]&&(this.minProj[3]=c,s[3]=l),c>this.maxProj[3]&&(this.maxProj[3]=c,n[3]=l),c=o[l]+o[l+1]-o[l+2],c<this.minProj[4]&&(this.minProj[4]=c,s[4]=l),c>this.maxProj[4]&&(this.maxProj[4]=c,n[4]=l),c=o[l]-o[l+1]+o[l+2],c<this.minProj[5]&&(this.minProj[5]=c,s[5]=l),c>this.maxProj[5]&&(this.maxProj[5]=c,n[5]=l),c=o[l]-o[l+1]-o[l+2],c<this.minProj[6]&&(this.minProj[6]=c,s[6]=l),c>this.maxProj[6]&&(this.maxProj[6]=c,n[6]=l)}for(let l=0;l<Zc;++l){let c=s[l];Mc(this.minVert[l],o,c),c=n[l],Mc(this.maxVert[l],o,c)}}},Sgt=class{constructor(){this.b0=[1,0,0],this.b1=[0,1,0],this.b2=[0,0,1],this.quality=0}};function xH(t){return t[0]*t[1]+t[0]*t[2]+t[1]*t[2]}function OD(t,e,r){t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2]}function Eh(t,e,r){t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2]}function Ob(t,e,r){t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r}function Mc(t,e,r=0){t[0]=e[r+0],t[1]=e[r+1],t[2]=e[r+2]}function Ch(t,e,r){const i=e[0],s=e[1],n=e[2],o=r[0],a=r[1],l=r[2];t[0]=s*l-n*a,t[1]=n*o-i*l,t[2]=i*a-s*o}function Bo(t,e){const r=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];if(r>0){const i=1/Math.sqrt(r);t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i}}function BEe(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]}function TH(t,e){const r=e[0]-t[0],i=e[1]-t[1],s=e[2]-t[2];return r*r+i*i+s*s}function zEe(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function Egt(t,e){const r=e[0]+e[4]+e[8];if(r>0){let i=Math.sqrt(r+1);t[3]=.5*i,i=.5/i,t[0]=(e[5]-e[7])*i,t[1]=(e[6]-e[2])*i,t[2]=(e[1]-e[3])*i}else{let i=0;e[4]>e[0]&&(i=1),e[8]>e[3*i+i]&&(i=2);const s=(i+1)%3,n=(i+2)%3;let o=Math.sqrt(e[3*i+i]-e[3*s+s]-e[3*n+n]+1);t[i]=.5*o,o=.5/o,t[3]=(e[3*s+n]-e[3*n+s])*o,t[s]=(e[3*s+i]+e[3*i+s])*o,t[n]=(e[3*n+i]+e[3*i+n])*o}}const RR=Zh(),Gb=M(),Cgt=M(),Agt=es();let pDt=class{constructor(e){const o=e*56;this.buffer=new ArrayBuffer(o),this.obbs=new Array(e);for(let a=0;a<e;a++)this.obbs[a]={center:Rq(this.buffer,56*a+0),halfSize:r1e(this.buffer,56*a+24),quaternion:UEe(this.buffer,56*a+36)}}};function GEe(t=[0,0,0],e=[-1,-1,-1],r=Zh()){return{center:ms(t),halfSize:QN(e),quaternion:FEe(r)}}function hle(t){return GEe(t.center,t.halfSize,t.quaternion)}function mDt(t,e){le(e.center,t.center),le(e.halfSize,t.halfSize),DY(e.quaternion,t.quaternion)}function gDt(t,e){return e=e||GEe(),fgt(t,e),e}function cb(t,e){const r=bi(e,t.center),i=m6(t,e);return r>i?1:r<-i?-1:0}function yDt(t,e){e||(e=En());const r=mY(Agt,t.quaternion),i=t.halfSize[0]*Math.abs(r[0])+t.halfSize[1]*Math.abs(r[3])+t.halfSize[2]*Math.abs(r[6]),s=t.halfSize[0]*Math.abs(r[1])+t.halfSize[1]*Math.abs(r[4])+t.halfSize[2]*Math.abs(r[7]),n=t.halfSize[0]*Math.abs(r[2])+t.halfSize[1]*Math.abs(r[5])+t.halfSize[2]*Math.abs(r[8]);return e[0]=t.center[0]-i,e[1]=t.center[1]-s,e[2]=t.center[2]-n,e[3]=t.center[0]+i,e[4]=t.center[1]+s,e[5]=t.center[2]+n,e}function _Dt(t,e){return bi(e,t.center)-m6(t,e)}function vDt(t,e){return bi(e,t.center)+m6(t,e)}function bDt(t,e){return cb(t,e[0])<=0&&cb(t,e[1])<=0&&cb(t,e[2])<=0&&cb(t,e[3])<=0&&cb(t,e[4])<=0&&cb(t,e[5])<=0}function wDt(t,e,r,i=0){Iw(RR,t.quaternion),me(Gb,e,t.center);const s=np(Gb,Gb,RR),n=np(Cgt,r,RR);let o=-1/0,a=1/0;for(let l=0;l<3;l++)if(Math.abs(n[l])>1e-6){const c=(i+t.halfSize[l]-s[l])/n[l],h=(-i-t.halfSize[l]-s[l])/n[l];o=Math.max(o,Math.min(c,h)),a=Math.min(a,Math.max(c,h))}else if(s[l]>t.halfSize[l]+i||s[l]<-t.halfSize[l]-i)return!1;return o<=a}(()=>{const t=new Int8Array(162);let e=0;const r=i=>{for(let s=0;s<i.length;s++)t[e+s]=i[s];e+=6};return r([6,2,3,1,5,4]),r([0,2,3,1,5,4]),r([0,2,3,7,5,4]),r([0,1,3,2,6,4]),r([0,1,3,2,0,0]),r([0,1,5,7,3,2]),r([0,1,3,7,6,4]),r([0,1,3,7,6,2]),r([0,1,5,7,6,2]),r([0,1,5,4,6,2]),r([0,1,5,4,0,0]),r([0,1,3,7,5,4]),r([0,2,6,4,0,0]),r([0,0,0,0,0,0]),r([1,3,7,5,0,0]),r([2,3,7,6,4,0]),r([2,3,7,6,0,0]),r([2,3,1,5,7,6]),r([0,1,5,7,6,2]),r([0,1,5,7,6,4]),r([0,1,3,7,6,4]),r([4,5,7,6,2,0]),r([4,5,7,6,0,0]),r([4,5,1,3,7,6]),r([0,2,3,7,5,4]),r([6,2,3,7,5,4]),r([6,2,3,1,5,4]),t})();function m6(t,e){Iw(RR,t.quaternion),np(Gb,e,RR);const r=t.halfSize;return Math.abs(Gb[0]*r[0])+Math.abs(Gb[1]*r[1])+Math.abs(Gb[2]*r[2])}function xDt(t,e){for(let r=0;r<8;++r){const i=e[r];i[0]=1&r?-t.halfSize[0]:t.halfSize[0],i[1]=2&r?-t.halfSize[1]:t.halfSize[1],i[2]=4&r?-t.halfSize[2]:t.halfSize[2],np(i,i,t.quaternion),fe(i,i,t.center)}}function Rgt(t){return mc(t.halfSize)}function Ogt(t,e,r,i,s){if(DY(s.quaternion,t.quaternion),i===Be.Global){Iw(E$,t.quaternion),np(u0,t.center,E$),mV(lT,u0),Qhe(cT,lT,t.halfSize),to(cT,lT,cT);const n=Me(cT);fe(cT,lT,t.halfSize);const o=Me(cT);if(n<r)le(s.center,t.center),ce(u0,r,r,r),fe(s.halfSize,t.halfSize,u0);else{const a=o>0?1+e/o:1,l=n>0?1+r/n:1,c=(l+a)/2,h=(l-a)/2;ae(s.halfSize,lT,h),Pb(s.halfSize,s.halfSize,t.halfSize,c),ae(s.center,lT,c),Pb(s.center,s.center,t.halfSize,h),Khe(u0,u0),d4(s.center,s.center,u0),np(s.center,s.center,s.quaternion)}}else{const n=ce(u0,0,0,1);Pb(s.center,t.center,n,(r+e)/2),Iw(E$,t.quaternion),np(n,n,E$),mV(n,n),Pb(s.halfSize,t.halfSize,n,(r-e)/2)}return s}const u0=M(),lT=M(),cT=M(),E$=Zh();let Mgt=class{constructor(e){this._totalCount=e,this._indexRanges=[0,e]}allVisible(){return this.componentCount()===this._totalCount}allInvisible(){return this._indexRanges.length===0}componentCount(){const e=this._indexRanges;let r=0;for(let i=0;i<e.length;i+=2)r+=e[i+1];return r}reset(e){e==="all"||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=Pgt(e)}forEachComponent(e){const r=this._indexRanges;for(let i=0;i<r.length;i+=2){const s=r[i],n=s+r[i+1];for(let o=s;o<n;o++)if(!e(o))return!1}return!0}forEachComponentRange(e){const r=this._indexRanges;for(let i=0;i<r.length;i+=2){const s=r[i];if(!e(s,s+r[i+1]))return!1}return!0}computeOffsetRanges(e){const r=new Array(this._indexRanges.length),i=this._indexRanges;for(let s=0;s<i.length;s+=2){const n=i[s],o=n+i[s+1],a=e[n],l=e[o];r[s]=a,r[s+1]=l-a}return r}};function Pgt(t){const e=new Array;if(t.length===0)return e;let r=t[0],i=1;for(let s=1;s<t.length;s++){const n=t[s];r+i===n?i+=1:(e.push(r),e.push(i),r=n,i=1)}return e.push(r),e.push(i),e}let Igt=class{constructor(e,r){this.pickability=null,this.highlightCounts=null,this.verticalOffsets=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.cachedDefaultRanges=null,this.offsets=r.slice();const i=this.count;this.visibility=new Mgt(i),this.materialDataBuffer=e.getBuffer(i),this.materialDataIndices=new Uint16Array(i);for(let s=0;s<i;s++)this.materialDataIndices[s]=this.materialDataBuffer.acquireIndex()}destroy(){for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return C(this.cachedGeometryRanges)&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRanges(){return C(this.highlightCounts)?null:(this._updateCachedHighlightRanges(),this.cachedHighlightRanges)}get defaultShadowMapRanges(){return C(this.highlightCounts)?this.geometryRanges:(this._updateCachedHighlightRanges(),this.cachedDefaultRanges)}highlightsDirty(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null}visibilityDirty(){this.cachedGeometryRanges=null,this.highlightsDirty()}_updateCachedHighlightRanges(){if((C(this.cachedHighlightRanges)||C(this.cachedDefaultRanges))&&v(this.highlightCounts)){const{highlightRanges:e,defaultRanges:r}=$gt(this.highlightCounts,this.visibility,this.offsets);this.cachedHighlightRanges=e,this.cachedDefaultRanges=r}}};function $gt(t,e,r){const i=[],s=[];let n=r.length,o=r.length;return e.forEachComponent(a=>(t[a]>0?(n!==a-1&&(i.length&&i.push(r[n+1]-i[i.length-1]),i.push(r[a])),n=a):(o!==a-1&&(s.length&&s.push(r[o+1]-s[s.length-1]),s.push(r[a])),o=a),!0)),i.length&&i.push(r[n+1]-i[i.length-1]),s.length&&s.push(r[o+1]-s[s.length-1]),{highlightRanges:i,defaultRanges:s}}let O3=class extends Te{constructor(){super(...arguments),this.visible=gS.Hidden}};var gS;u([d({autoDestroy:!0})],O3.prototype,"renderable",void 0),u([d({autoDestroy:!0})],O3.prototype,"components",void 0),O3=u([I("esri.views.3d.webgl-engine.collections.Component.ComponentObject")],O3),function(t){t[t.Hidden=0]="Hidden",t[t.Visible=1]="Visible"}(gS||(gS={}));function Lgt(t,e,r,i){if(r>=e)return t;t==null&&(t=Dgt());const s=t.isVisibleBit;let n=t.data;const o=HEe(n),a=r/o|0,l=r-o*a,c=(e-1)/o|0,h=n,p=i===s;if(!(r<h.length*o)&&p){const m=a+1,y=Math.ceil(h.length*1.5),_=c+1;let b=Math.max(m,y);b=Math.min(b,_),n=new Uint32Array(b),n.set(h)}return a<n.length&&(n[a]=Fgt(n[a],l,p)),t.data=n,t}function jEe(t,e){if(t==null)return!0;const{isVisibleBit:r,data:i}=t,s=HEe(i);return e<i.length*s?Ngt(r,i,e,s):!t.isVisibleBit}function Dgt(t=!0){return{isVisibleBit:!t,data:new Uint32Array(0)}}function Ngt(t,e,r,i){const s=r/i|0,n=r-s*i;return Ugt(e[s],n)===t}function HEe(t){return t.BYTES_PER_ELEMENT*8}function Fgt(t,e,r){return t&~(1<<e)|(r?1:0)<<e}function Ugt(t,e){return(t&1<<e)!=0}let kgt=class{constructor(e,r){this._indices=v(e.indices)?e.indices:tE(e.positions.length/3),this._positions=new Oi(e.positions),this._components=r,this._componentIntersectionData=new Array(r.count)}getComponentAabb(e,r){if(v(this._perComponentAabbs)){for(let i=0;i<6;i++)r[i]=this._perComponentAabbs[6*e+i];return r}return this._computePerComponentAabbs(),this.getComponentAabb(e,r)}getComponentPositions(e,r){r.indices=this._indices,r.data=this._positions.typedBuffer,r.stride=this._positions.typedBufferStride,r.startIndex=this._components.offsets[e],r.endIndex=this._components.offsets[e+1]}intersect(e,r,i,s,n,o,a){const l=new Xe(this._positions.typedBuffer,3,!1,this._positions.typedBufferStride),c=this._indices,h=this._components.offsets,p=Kwe(e,r,Vgt),f=e[2],m=r[2];this._components.visibility.forEachComponent(y=>{if(!jEe(this._components.pickability,y))return!0;const _=this.getComponentAabb(y,Bgt);if(v(o)){const E=o[y];v(n)?n.componentOffset=E:(e[2]=f-E,r[2]=m-E)}if(v(n)&&n.applyToAabb(_),!hZ(_,e,p,i))return!0;const b=h[y]/3,x=h[y+1]/3,T=x-b,S=(E,O,R)=>a(y,E,Ac(O,O,s),R);return C(n)&&T>LEe?(this._componentIntersectionData[y]==null&&(this._componentIntersectionData[y]=new vJ(this._indices,b,x,l)),this._componentIntersectionData[y].intersectRay({r0:e,r1:r},S)):IM(e,r,b,x,c,l,void 0,n,S),!0})}_computePerComponentAabbs(){const e=this._components.count;this._perComponentAabbs=new Float32Array(6*e);const r=this._indices,i=this._positions.typedBuffer,s=this._positions.typedBufferStride,n=this._components.offsets;let o=0;for(let a=0;a<e;a++){const l=n[a],c=n[a+1];let h=1/0,p=1/0,f=1/0,m=-1/0,y=-1/0,_=-1/0;for(let b=l;b<c;b++){const x=r[b]*s,T=i[x],S=i[x+1],E=i[x+2];h=Math.min(h,T),p=Math.min(p,S),f=Math.min(f,E),m=Math.max(m,T),y=Math.max(y,S),_=Math.max(_,E)}this._perComponentAabbs[o++]=h,this._perComponentAabbs[o++]=p,this._perComponentAabbs[o++]=f,this._perComponentAabbs[o++]=m,this._perComponentAabbs[o++]=y,this._perComponentAabbs[o++]=_}}get positions(){return this._positions}get indices(){return this._indices}};const Vgt=M(),Bgt=En();let zgt=class{constructor(e,r,i){this.material=e,this.geometry=r,this.meta=i}destroy(){this.material.dispose(),this.geometry.dispose()}},Ggt=class{constructor(e,r,i,s){this.vao=e,this.primitiveType=r,this.parameters=i,this.indexed=s}dispose(){this.vao.dispose()}},jgt=class{constructor(){this.near=Number.MAX_VALUE,this.far=-Number.MAX_VALUE}};function Hgt(t,e){return{near:t,far:e}}function zM(t){return t?FO(t,1/0,-1/0):Hgt(1/0,-1/0)}function FO(t,e,r){return t.near=e,t.far=r,t}function fE(t,e,r=t){return e!=null&&(r.near=Math.min(t.near,e.near),r.far=Math.max(t.far,e.far)),r}function C$(t,e){return t.near<=e&&e<=t.far}const SH={near:0,far:0};function qgt(t,e){const r=zM(),{eye:i,frustum:s,viewForward:n}=t;e.forAll(o=>{const a=v(o.offsetObb)?o.offsetObb:o.obb,l=ye(to(iu,a.center,i),n),c=m6(a,n);if(C$(r,l-c)&&C$(r,l+c))return;const h=Jgt(a,s);if(h===-1)return;if(h===0)return Wm.far=l+c,Wm.near=l-c,void fE(r,Wm);const p=A$.pushNew();p.near=l-c,p.far=l+c,p.mask=h,p.object=o});for(let o=0;o<A$.length;o++){const a=A$.data[o];if(C$(r,a.near)&&C$(r,a.far))continue;Wm.far=a.far,Wm.near=1/0,Zgt(v(a.object.offsetObb)?a.object.offsetObb:a.object.obb,i,Wgt,c=>{let h=Xgt;for(let p=0;p<qEe&&c.length>0;p++){if(!(a.mask&1<<p))continue;Ygt(s[p],c,h);const f=c;c=h,h=f}for(let p=0;p<c.length;p+=3){ce(Il,c.data[p+0],c.data[p+1],c.data[p+2]);const f=ye(to(Il,Il,i),n);Wm.near=Math.min(Wm.near,f)}})===0&&(Wm.near=0),fE(r,Wm)}return A$.length=0,r}const A$=new Jt({allocator:t=>t||{near:1/0,far:-1/0,mask:0,object:null},deallocator:t=>(t.object=sw(t.object),t)}),Wm=zM(),Il=M(),c1=M(),Wgt=new Jt({deallocator:null}),Xgt=new Jt({deallocator:null});function Ygt(t,e,r){r.length=0;const i=e.length-3;hk(Il,e,i);const s=bi(t,Il);s<=0&&(r.push(Il[0]),r.push(Il[1]),r.push(Il[2]));let n=0,o=s;for(;n<i;n+=3){hk(c1,e,n);const a=bi(t,c1);o*a<0&&(Ys(Il,c1,Il,a/(a-o)),$l(r,Il)),a<=0&&$l(r,c1),o=a,le(Il,c1)}o*s<0&&(hk(c1,e,i),Ys(Il,c1,Il,s/(s-o)),$l(r,Il))}function hk(t,e,r){return ce(t,e.data[r+0],e.data[r+1],e.data[r+2])}function $l(t,e){t.push(e[0]),t.push(e[1]),t.push(e[2])}function Zgt(t,e,r,i){Iw(ple,t.quaternion),to(iu,e,t.center),np(iu,iu,ple);const s=8*((iu[0]<-t.halfSize[0]?-1:iu[0]>t.halfSize[0]?1:0)+3*(iu[1]<-t.halfSize[1]?-1:iu[1]>t.halfSize[1]?1:0)+9*(iu[2]<-t.halfSize[2]?-1:iu[2]>t.halfSize[2]?1:0)+13),n=dle[s];if(n===0)return n;mY(R$,t.quaternion),fY(R$,R$,t.halfSize);const o=(a,l)=>{const c=dle[s+l+1];return ce(a,((1&c)<<1)-1,(2&c)-1,((4&c)>>1)-1),Ac(a,a,R$),fe(a,t.center,a)};return r.length=0,$l(r,o(dk,0)),$l(r,o(fle,1)),$l(r,o(iu,2)),$l(r,o(mle,3)),i(r),n===1||(r.length=0,$l(r,dk),$l(r,mle),$l(r,o(iu,4)),$l(r,o(gle,5)),i(r),n===2||(r.length=0,$l(r,dk),$l(r,gle),$l(r,o(iu,6)),$l(r,fle),i(r))),n}const dle=(()=>{const t=new Int8Array(216);let e=0;const r=i=>{for(let s=0;s<i.length;s++)t[e+s]=i[s];e+=8};return r([3,0,6,2,3,1,5,4]),r([2,0,2,3,1,5,4,0]),r([3,1,0,2,3,7,5,4]),r([2,0,1,3,2,6,4,0]),r([1,0,1,3,2,0,0,0]),r([2,1,5,7,3,2,0,0]),r([3,2,0,1,3,7,6,4]),r([2,2,0,1,3,7,6,0]),r([3,3,0,1,5,7,6,2]),r([2,0,1,5,4,6,2,0]),r([1,0,1,5,4,0,0,0]),r([2,1,3,7,5,4,0,0]),r([1,0,2,6,4,0,0,0]),r([0,0,0,0,0,0,0,0]),r([1,1,3,7,5,0,0,0]),r([2,2,3,7,6,4,0,0]),r([1,2,3,7,6,0,0,0]),r([2,3,1,5,7,6,2,0]),r([3,4,0,1,5,7,6,2]),r([2,5,7,6,4,0,1,0]),r([3,5,0,1,3,7,6,4]),r([2,4,5,7,6,2,0,0]),r([1,4,5,7,6,0,0,0]),r([2,5,1,3,7,6,4,0]),r([3,6,0,2,3,7,5,4]),r([2,6,2,3,7,5,4,0]),r([3,7,6,2,3,1,5,4]),t})(),qEe=4;function Jgt(t,e){let r=0;for(let i=0;i<qEe;i++){const s=cb(t,e[i]);if(s>0)return-1;s===0&&(r|=1<<i)}return r}const R$=es(),ple=Zh(),iu=M(),dk=M(),fle=M(),mle=M(),gle=M();let Kgt=class{constructor(e){this._objects=e}submit(e,r){this._objects.preSubmit(r),this._objects.visibleObjects.forAll(i=>i.renderable.material.submit(e,r,i))}queryShadowCasterDepthRange(e){return this._objects.visibleObjects.length?qgt(e,this._objects.visibleObjects):null}};function Qgt(t){const e=ts().vec3f(A.POSITION);return t.normals&&e.vec2i16(A.NORMALCOMPRESSED,{glNormalized:!0}),t.textureCoordinates===qs.Default?e.vec2f(A.UV0):t.textureCoordinates===qs.Atlas&&(e.vec2f(A.UV0),e.vec4u16(A.UVREGION,{glNormalized:!0})),t.colors&&e.vec4u8(A.COLOR,{glNormalized:!0}),e.alignTo(4)}let eyt=class{constructor(){this.externalColor=sr(),this.externalColorMixMode=_n.Multiply,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0}},tyt=class extends ws{constructor(e,r){super(e,"int",di.Draw,(i,s,n)=>i.setUniform1i(e,r(s,n)))}};var Kf;(function(t){t[t.Uniform=0]="Uniform",t[t.Varying=1]="Varying",t[t.COUNT=2]="COUNT"})(Kf||(Kf={}));const bJ=429496.7296;function WEe(t,e){xO(t/bJ*.5+.5,e)}function ryt(t,e){switch(e.componentData){case Kf.Varying:return iyt(t,e);case Kf.Uniform:return syt(t);case Kf.COUNT:return;default:e.componentData}}function iyt(t,e){const{vertex:r,fragment:i}=t;r.include(kc),r.uniforms.add(k_("componentColorTex",n=>n.componentParameters.texture.texture,e.hasWebGL2Context?Qr.None:Qr.Size)),t.attributes.add(A.COMPONENTINDEX,"float"),t.varyings.add("vExternalColorMixMode","mediump float"),t.varyings.add("vExternalColor","vec4");const s=e.output===k.ObjectAndLayerIdColor;s&&t.varyings.add("vObjectAndLayerIdColor","vec4"),t.include(b2e),r.constants.add("elevationScale","float",2*bJ),r.constants.add("stride","float",de("enable-feature:objectAndLayerId-rendering")?3:2),r.code.add(w`
  vec2 getComponentTextureCoordinates(float componentIndex, float typeOffset) {
    vec2 textureSize = ${$h(e,"componentColorTex")};

    float index = componentIndex * stride + typeOffset;
    float coordX = mod(index, textureSize.x);
    float coordY = floor(index / textureSize.x);

    return vec2(coordX, coordY) + 0.5;
  }
  `),r.code.add(w`
  vec4 _readComponentColor() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 0.0);

    return ${Ja(e,"componentColorTex","textureCoordinates","1.0 / componentColorTexSize")};
   }

   float readElevationOffset() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 1.0);

    vec4 encodedElevation = ${Ja(e,"componentColorTex","textureCoordinates","1.0 / componentColorTexSize")};
    return (rgba2float(encodedElevation) - 0.5) * elevationScale;
  }

  ${s?w`
          void forwardObjectAndLayerIdColor() {
            vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 2.0);

            vObjectAndLayerIdColor = ${Ja(e,"componentColorTex","textureCoordinates","1.0 / componentColorTexSize")};
          }`:w`void forwardObjectAndLayerIdColor() {}`}

  vec4 forwardExternalColor(out bool castShadows) {
    vec4 componentColor = _readComponentColor() * 255.0;

    float shadowFlag = mod(componentColor.b * 255.0, 2.0);
    componentColor.b -= shadowFlag;
    castShadows = shadowFlag >= 1.0;

    int decodedColorMixMode;
    vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451; // = 1/255;
    vExternalColorMixMode = float(decodedColorMixMode) + 0.5; // add 0.5 to avoid interpolation artifacts

    return vExternalColor;
  }
`),i.code.add(w`
  void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
    externalColor = vExternalColor;
    externalColorMixMode = int(vExternalColorMixMode);
  }

  void outputObjectAndLayerIdColor() {
     ${s?w`gl_FragColor = vObjectAndLayerIdColor;`:""}
  }
`)}function syt(t){const{vertex:e,fragment:r}=t;e.uniforms.add(new HF("externalColor",i=>i.componentParameters.externalColor)),r.uniforms.add(new tyt("externalColorMixMode",i=>i.componentParameters.externalColorMixMode)),t.varyings.add("vExternalColor","vec4"),e.code.add(w`float readElevationOffset() {
return 0.0;
}
void forwardObjectAndLayerIdColor() {
}
vec4 forwardExternalColor(out bool castShadows) {
vExternalColor = externalColor;
castShadows = true;
return externalColor;
}`),r.code.add(w`void readExternalColor(out vec4 color, out int colorMixMode) {
color = vExternalColor;
colorMixMode = externalColorMixMode;
}
void outputObjectAndLayerIdColor() {
gl_FragColor = vec4(1.0,0.0,0.0,0.0);
}`)}var Oh;function nyt(t,e){const r=t.vertex;switch(r.code.add(w`#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)`),e.vertexDiscardMode){case Oh.None:r.code.add(w`#define vertexDiscardByOpacity(_opacity_) {}`);break;case Oh.Opaque:r.code.add(w`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);break;case Oh.Transparent:r.code.add(w`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`)}}(function(t){t[t.None=0]="None",t[t.Transparent=1]="Transparent",t[t.Opaque=2]="Opaque",t[t.COUNT=3]="COUNT"})(Oh||(Oh={}));var Qf;function $Dt(t){return t&&fm(t)?Qf.Mars:t&&mm(t)?Qf.Moon:Qf.Earth}(function(t){t[t.Earth=1]="Earth",t[t.Mars=2]="Mars",t[t.Moon=3]="Moon",t[t.COUNT=4]="COUNT"})(Qf||(Qf={}));var bu;(function(t){t[t.None=0]="None",t[t.NoOverlay=1]="NoOverlay",t[t.ColorOverlay=2]="ColorOverlay",t[t.ColorOverlayWithWater=3]="ColorOverlayWithWater",t[t.COUNT=4]="COUNT"})(bu||(bu={}));let vr=class extends Ca{constructor(){super(...arguments),this.output=k.Color,this.textureCoordinateType=qs.None,this.componentData=Kf.Uniform,this.cullFace=Ti.Back,this.vertexDiscardMode=Oh.None,this.doubleSidedMode=cs.WindingOrder,this.alphaDiscardMode=ui.Opaque,this.integratedMeshMode=bu.None,this.transparencyPassType=xt.NONE,this.ellipsoidMode=Qf.Earth,this.pbrMode=dt.Disabled,this.normalType=si.Attribute,this.spherical=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasVertexColors=!1,this.hasNormals=!1,this.hasSlicePlane=!1,this.hasBaseColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.blendingEnabled=!0,this.hasScreenSpaceReflections=!1,this.hasPolygonOffset=!1,this.hasMetallicRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.useLegacyTerrainShading=!1,this.hasCloudsReflections=!0,this.snowCover=!1,this.objectAndLayerIdColor=!1,this.hasWebGL2Context=!1}};u([V({count:k.COUNT})],vr.prototype,"output",void 0),u([V({count:qs.COUNT})],vr.prototype,"textureCoordinateType",void 0),u([V({count:Kf.COUNT})],vr.prototype,"componentData",void 0),u([V({count:Ti.COUNT})],vr.prototype,"cullFace",void 0),u([V({count:Oh.COUNT})],vr.prototype,"vertexDiscardMode",void 0),u([V({count:cs.COUNT})],vr.prototype,"doubleSidedMode",void 0),u([V({count:ui.COUNT})],vr.prototype,"alphaDiscardMode",void 0),u([V({count:bu.COUNT})],vr.prototype,"integratedMeshMode",void 0),u([V({count:xt.COUNT})],vr.prototype,"transparencyPassType",void 0),u([V({count:Qf.COUNT})],vr.prototype,"ellipsoidMode",void 0),u([V({count:dt.COUNT})],vr.prototype,"pbrMode",void 0),u([V({count:si.COUNT})],vr.prototype,"normalType",void 0),u([V()],vr.prototype,"spherical",void 0),u([V()],vr.prototype,"doublePrecisionRequiresObfuscation",void 0),u([V()],vr.prototype,"hasVertexColors",void 0),u([V()],vr.prototype,"hasNormals",void 0),u([V()],vr.prototype,"hasSlicePlane",void 0),u([V()],vr.prototype,"hasBaseColorTexture",void 0),u([V()],vr.prototype,"receiveAmbientOcclusion",void 0),u([V()],vr.prototype,"receiveShadows",void 0),u([V()],vr.prototype,"blendingEnabled",void 0),u([V()],vr.prototype,"hasScreenSpaceReflections",void 0),u([V()],vr.prototype,"hasPolygonOffset",void 0),u([V()],vr.prototype,"hasMetallicRoughnessTexture",void 0),u([V()],vr.prototype,"hasEmissionTexture",void 0),u([V()],vr.prototype,"hasOcclusionTexture",void 0),u([V()],vr.prototype,"hasNormalTexture",void 0),u([V()],vr.prototype,"hasOccludees",void 0),u([V()],vr.prototype,"hasMultipassTerrain",void 0),u([V()],vr.prototype,"cullAboveGround",void 0),u([V()],vr.prototype,"useLegacyTerrainShading",void 0),u([V()],vr.prototype,"hasCloudsReflections",void 0),u([V()],vr.prototype,"snowCover",void 0),u([V()],vr.prototype,"objectAndLayerIdColor",void 0),u([V()],vr.prototype,"hasWebGL2Context",void 0),u([V({constValue:di.Draw})],vr.prototype,"pbrTextureBindType",void 0),u([V({constValue:!0})],vr.prototype,"hasSliceHighlight",void 0),u([V({constValue:!1})],vr.prototype,"hasSliceInVertexProgram",void 0),u([V({constValue:!1})],vr.prototype,"useCustomDTRExponentForWater",void 0),u([V({constValue:!1})],vr.prototype,"hasVertexTangents",void 0),u([V({constValue:!0})],vr.prototype,"supportsTextureAtlas",void 0),u([V({constValue:!1})],vr.prototype,"highStepCount",void 0),u([V({constValue:!1})],vr.prototype,"instancedDoublePrecision",void 0),u([V({constValue:!0})],vr.prototype,"useFillLights",void 0),u([V({constValue:!1})],vr.prototype,"objectAndLayerIdColorInstanced",void 0);function yle(t,e){t.include(sx,e),t.fragment.include(MO);const r=t.fragment;r.uniforms.add(new HF("baseColor",i=>i.baseColor)),r.uniforms.add(new ew("objectOpacity",i=>i.objectOpacity)),e.hasVertexColors?r.code.add(w`vec3 _baseColor() {
return baseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return baseColor.a * vColor.a;
}`):r.code.add(w`vec3 _baseColor() {
return baseColor.rgb;
}
float _baseOpacity() {
return baseColor.a;
}`),r.code.add(w`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = objectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}function _le(t,e){const r=t.fragment;switch(e.doubleSidedMode){case cs.None:r.code.add(w`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`);break;case cs.View:t.include(tS,e),r.code.add(w`vec3 _adjustDoublesided(vec3 normal) {
return dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;
}`);break;case cs.WindingOrder:r.code.add(w`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`);break;default:e.doubleSidedMode;case cs.COUNT:}switch(e.normalType){case si.Attribute:case si.CompressedAttribute:t.include(J5,e),r.code.add(w`vec3 shadingNormalWorld() {
return _adjustDoublesided(normalize(vNormalWorld));
}
vec3 shadingNormal_view() {
vec3 normal = normalize(vNormalView);
return gl_FrontFacing ? normal : -normal;
}`);break;case si.ScreenDerivative:t.extensions.add("GL_OES_standard_derivatives"),t.include(tS,e),r.code.add(w`vec3 shadingNormalWorld() {
return normalize(cross(
dFdx(vPositionWorldCameraRelative),
dFdy(vPositionWorldCameraRelative)
));
}
vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));
}`);break;case si.Ground:e.spherical?(t.include(tS,e),r.code.add(w`vec3 shadingNormalWorld() {
return normalize(positionWorld());
}`)):r.code.add(w`vec3 shadingNormalWorld() {
return vec3(0.0, 0.0, 1.0);
}`),t.extensions.add("GL_OES_standard_derivatives"),r.code.add(w`vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;
}`);break;default:e.normalType;case si.COUNT:}}function oyt(t,e){const r=t.fragment;if(e.hasBaseColorTexture&&(e.output===k.Color||e.alphaDiscardMode!==ui.Opaque)){t.include(oY,e);const i=e.textureCoordinateType===qs.Atlas;r.uniforms.add(k_("baseColorTexture",s=>s.texture,i?e.hasWebGL2Context?Qr.None:Qr.Size:Qr.None)),i?(t.include(a1e),r.code.add(w`
        vec4 readBaseColorTexture() {
          vec2 textureSize = ${$h(e,"baseColorTexture")};
          return textureAtlasLookup(baseColorTexture, textureSize, vuv0, vuvRegion);
        }
      `)):r.code.add(w`vec4 readBaseColorTexture() {
return texture2D(baseColorTexture, vuv0);
}`)}else r.code.add(w`vec4 readBaseColorTexture() { return vec4(1.0); }`)}function ayt(t){const e=new Dr;e.include(tS,t),e.include(J5,t),e.include(sx,t),e.include(Zf,t),e.include(VE,t),e.include(ryt,t),e.include(dot,t),e.include(ort,t),e.include(oyt,t),e.include(nyt,t);const{vertex:r,fragment:i}=e;t.pbrMode!==dt.Normal&&t.pbrMode!==dt.Schematic||(e.include(lY,t),t.hasNormalTexture&&e.include(S2e,t));const s=t.output===k.Shadow||t.output===k.ShadowHighlight||t.output===k.ShadowExcludeHighlight;s&&t.componentData===Kf.Varying?r.code.add(w`#define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`):r.code.add(w`#define discardShadows(castShadows) {}`);const n=t.integratedMeshMode===bu.ColorOverlay||t.integratedMeshMode===bu.ColorOverlayWithWater,o=n&&t.output===k.Color&&t.pbrMode===dt.WaterOnIntegratedMesh;return n&&(e.include(Uw,t),e.include(Uft,t),t.spherical?r.code.add(w`
      const float invEllipsoidRadius = ${w.float(1/(t.ellipsoidMode===Qf.Earth?wr.radius:t.ellipsoidMode===Qf.Mars?Gf.radius:Jg.radius))};
      vec2 projectOverlay(vec3 pos) {
        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);
      }
      `):r.code.add(w`vec2 projectOverlay(vec3 pos) { return pos.xy; }`)),o&&(e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),e.varyings.add("groundNormal","vec3")),r.code.add(w`
    void main() {
      bool castShadows;
      vec4 externalColor = forwardExternalColor(castShadows);
      discardShadows(castShadows);

      vertexDiscardByOpacity(externalColor.a);

      ${t.output===k.ObjectAndLayerIdColor?w`externalColor.a = 1.0;`:""}

      if (externalColor.a < ${w.float(Yo)}) {
        // Discard this vertex
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }

      forwardPosition(readElevationOffset());
      forwardNormal();
      forwardTextureCoordinates();
      forwardVertexColor();
      forwardLinearDepth();
      ${t.output===k.ObjectAndLayerIdColor?w`forwardObjectAndLayerIdColor();`:""}
      ${o?t.spherical?w`
                groundNormal = normalize(positionWorld());
                tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
                tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:w`
                groundNormal = vec3(0.0, 0.0, 1.0);
                tbnTangent = vec3(1.0, 0.0, 0.0);
                tbnBiTangent = vec3(0.0, 1.0, 0.0);`:""}
      ${n?w`setOverlayVTC(projectOverlay(position));`:""}
    }
  `),t.output===k.Alpha&&(i.include(Nu),e.include(Fu,t),e.include(yle,t),n&&i.uniforms.add(new Mt("ovColorTex",(a,l)=>_H(a,l))),i.code.add(w`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${t.hasMultipassTerrain?w`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${n?w`
                vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);
                materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        gl_FragColor = vec4(materialColor.a);
      }
    `)),t.output===k.Color&&(i.include(Nu),e.include(Fu,t),e.include(yle,t),e.include(_le,t),e.include(Uw,t),t.receiveShadows?(e.include(K5,t),i.code.add(w`float evaluateShadow() {
return readShadowMap(vPositionWorldCameraRelative, linearDepth);
}`)):i.code.add(w`float evaluateShadow() { return 0.0; }`),n&&i.uniforms.add(new Mt("ovColorTex",(a,l)=>_H(a,l))),i.code.add(w`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${t.hasMultipassTerrain?w`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${n?w`vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);`:""}
    `),t.pbrMode===dt.Normal||t.pbrMode===dt.Schematic?(vm(i),i.code.add(w`
        ${t.pbrMode===dt.Normal?w`
                applyPBRFactors();
                if (int(externalColorMixMode) == 3) {
                  mrr = vec3(0.0, 0.6, 0.2);
                }`:""}
        vec3 normalVertex = shadingNormalWorld();
        float additionalIrradiance = 0.02 * mainLightIntensity[2];
      `),t.hasNormalTexture?i.code.add(w`mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);
vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);`):i.code.add(w`vec3 shadingNormal = normalVertex;`),i.code.add(w`${t.spherical?w`vec3 normalGround = normalize(positionWorld());`:w`vec3 normalGround = vec3(0.0, 0.0, 1.0);`}
      `),i.code.add(w`
        vec3 viewDir = normalize(vPositionWorldCameraRelative);
        float ssao = 1.0 - occlusion * (1.0 - evaluateAmbientOcclusion());

        ${t.snowCover?w`
                vec3 surfaceNormal = normalize(shadingNormalWorld());
                float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));
                materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);

                shadingNormal = mix(shadingNormal, surfaceNormal, snow);
                ssao = mix(ssao, 0.0, snow);
                mrr = mix(mrr, vec3(0.0, 1.0, 0.04), snow);
                emission = mix(emission, vec3(0.0), snow);`:""}

        ${n?w` materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);
        `)):(t.receiveShadows?i.code.add(w`float shadow = evaluateShadow();`):t.spherical?(YE(i),i.code.add(w`float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());
float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);`)):i.code.add(w`float shadow = 0.0;`),o&&i.uniforms.add(new Mt("ovNormalTex",(a,l)=>wJ(l))),t.snowCover&&(e.extensions.add("GL_OES_standard_derivatives"),i.code.add(w`vec3 surfaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));
float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));
materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);`)),i.code.add(w`
        float ambientOcclusion = evaluateAmbientOcclusion();
        vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());

        ${n?w` materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);
      ${o?w`
              vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
              float waterNormalLength = length(overlayWaterMask);
              if (waterNormalLength > 0.95) {
                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());
                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                // un-gamma the ground color to mix in linear space
                shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
              }`:""}
      `)),i.code.add(w`
        gl_FragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);
        ${t.transparencyPassType===xt.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),(t.output===k.Depth||s)&&(e.include(ny,t),i.code.add(w`void main() {
discardBySlice(vPositionWorldCameraRelative);
vec4 textureColor = readBaseColorTexture();
discardOrAdjustAlpha(textureColor);
outputDepth(linearDepth);
}`)),t.output===k.Normal&&(e.include(_le,t),i.code.add(w`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        // note: the alpha component needs to be 1.0 in order for this material
        // to influence ambient occlusion, see the ssao fragment shader
        float alpha = ${t.normalType===si.Ground?"0.0":"1.0"};
        gl_FragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);
      }
    `)),t.output===k.ObjectAndLayerIdColor&&e.fragment.code.add(w`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${n?w`gl_FragColor = getOverlayColorTexel(vtcOverlay);`:"outputObjectAndLayerIdColor();"}
      }
    `),t.output===k.Highlight&&(e.include(by,t),i.code.add(w`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${n?w`
                vec4 overlayColor = getCombinedOverlayColor();
                if (overlayColor.a == 0.0) {
                  gl_FragColor = vec4(0.0);
                  return;
                }`:""}

        outputHighlight();
      }
    `)),e}function wJ(t){return t.overlays.length===0?null:t.overlays[Ki.INNER].getValidTexture(fs.Water)}const lyt=Object.freeze(Object.defineProperty({__proto__:null,build:ayt,getOverlayNormalTexture:wJ},Symbol.toStringTag,{value:"Module"}));let XEe=class YEe extends Vr{initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===vt.WEBGL2,r.spherical=e.viewingMode===Be.Global,r.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Fr(e.rctx,YEe.shader.get().build(this.configuration),ZEe)}_setPipelineState(e){const r=this.configuration,i=r.integratedMeshMode!==bu.None,s=e===xt.NONE,n=e===xt.FrontFace;return Bt({blending:r.output!==k.Color&&r.output!==k.Alpha||!r.blendingEnabled?null:s?Iu:wy(e),culling:y5(r.cullFace),depthTest:{func:xv(e)},depthWrite:s||n?Xl:null,colorWrite:Kt,stencilWrite:i||r.hasOccludees?dm:null,stencilTest:i?Zst(zl.IntegratedMeshMaskExcluded):r.hasOccludees?Tv:null,polygonOffset:s||n?r.hasPolygonOffset?{factor:2,units:2}:null:H5})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}};XEe.shader=new Nr(lyt,()=>te(()=>import("./ComponentShader.glsl-b41bce28.js"),[]));const ZEe=new Map([[A.POSITION,0],[A.NORMAL,1],[A.NORMALCOMPRESSED,1],[A.COLOR,2],[A.UV0,3],[A.UVREGION,4],[A.COMPONENTINDEX,5]]);let cyt=class extends pi{constructor(){super(...arguments),this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,this._parameterBlocks!=null)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(this._parameterBlocks==null)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}},xJ=class{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}};function ds(t={}){return(e,r)=>{const i=e._parameterCount??0;if(e._parameterCount=i+1,t.vectorOps){const s=t.vectorOps;Object.defineProperty(e,r,{get(){return this[i]},set(n){const o=this[i];if(o==null)this[i]=n;else{if(s.equals(o,n))return;s.copy(o,n)}this._setDirty()}})}else Object.defineProperty(e,r,{get(){return this[i]},set(s){this[i]!==s&&(t.dispose&&this[i]&&this[i].dispose(),this[i]=s,this._setDirty())}})}}function vle(){return(t,e)=>{const r=t._parameterCount??0;t._parameterCount=r+1,t._parameterBlocks=t._parameterBlocks||[],t._parameterBlocks.push(r),Object.defineProperty(t,e,{get(){return this[r]},set(i){this[r]!==i&&(this[r]=i,this._setDirty())}})}}let g6=class{constructor(e){this._low=Vi(),this._high=Vi(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){const r=this._low,i=this._high;le(r,e),to(i,e,r)}setElements(e,r,i){ce(ble,e,r,i),this.set(ble)}get(e){return fe(e,this._low,this._high)}getLowScaled(e){return ae(e,this._low,1)}};const ble=M();let Wn=class extends cyt{constructor(e,r){super(),this.toMapSpace=r,this.baseColor=wp(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=Xr(1,1,.5),this.emissiveFactor=Xr(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.objectOpacity=1,this.commonMaterialParameters=new MD,this.componentParameters=new OR,this.textureAlphaCutoff=CF,this.alphaDiscardMode=ui.Opaque,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=Qf.Earth,this.hasOccludees=!1,this._techniqueConfiguration=new vr;const i=new g6(e.position),s=E2e(e.rotationScale);ex(s,s),this.transformNormalGlobalFromModel=qh(s,s),this.transformWorldFromModelTL=i.low,this.transformWorldFromModelTH=i.high,this.transformWorldFromModelRS=e.rotationScale}dispose(){this._technique=Bi(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get texture(){return v(this.baseColorTexture)?this.baseColorTexture.glTexture:null}get textureMetallicRoughness(){return v(this.metallicRoughnessTexture)?this.metallicRoughnessTexture.glTexture:null}get textureEmissive(){return v(this.emissionTexture)?this.emissionTexture.glTexture:null}get textureOcclusion(){return v(this.occlusionTexture)?this.occlusionTexture.glTexture:null}get textureNormal(){return v(this.normalTexture)?this.normalTexture.glTexture:null}prepareTechnique(e,r,i,s){const n=this._techniqueConfiguration;n.hasVertexColors=s.colors,n.hasNormals=s.normals,n.textureCoordinateType=s.textureCoordinates,n.hasMetallicRoughnessTexture=v(this.metallicRoughnessTexture),n.hasEmissionTexture=v(this.emissionTexture),n.hasOcclusionTexture=v(this.occlusionTexture),n.hasNormalTexture=v(this.normalTexture),n.transparencyPassType=r.identifier===Cc.Material&&i.transparencyPassType!=null?i.transparencyPassType:xt.NONE,n.hasMultipassTerrain=r.identifier===Cc.Material&&i.multipassTerrain!=null&&i.multipassTerrain.enabled,n.cullAboveGround=r.identifier===Cc.Material&&i.multipassTerrain!=null&&i.multipassTerrain.cullAboveGround,n.ellipsoidMode=this.ellipsoidMode,n.componentData=this.componentParameters.type,n.cullFace=this.commonMaterialParameters.cullFace,n.doubleSidedMode=this.commonMaterialParameters.doubleSided?cs.View:cs.None,n.hasBaseColorTexture=v(this.baseColorTexture);const o=this._computeWhichMaterialPass();n.blendingEnabled=o===Ga.Transparent||o===Ga.OpaqueAndTransparent,n.alphaDiscardMode=this.alphaDiscardMode,n.integratedMeshMode=this.isIntegratedMesh?hyt(i)?wJ(i)?bu.ColorOverlayWithWater:bu.ColorOverlay:bu.NoOverlay:bu.None,n.useLegacyTerrainShading=this.isIntegratedMesh&&qr.TERRAIN_USE_LEGACY_SHADING,n.hasPolygonOffset=this.polygonOffsetEnabled;const a=this.hasParametersFromSource&&C(this.baseColorTexture);if(n.pbrMode=n.integratedMeshMode===bu.ColorOverlayWithWater?dt.WaterOnIntegratedMesh:this.usePBR?a?dt.Schematic:dt.Normal:dt.Disabled,n.normalType=n.integratedMeshMode===bu.None?n.hasNormals?si.CompressedAttribute:si.ScreenDerivative:si.Ground,n.hasSlicePlane=v(i.slicePlane)&&this.commonMaterialParameters.hasSlicePlane,r.identifier===Cc.ShadowMap)n.output=k.Shadow,n.vertexDiscardMode=Oh.None;else if(r.identifier===Cc.Highlight)n.output=k.Highlight,n.vertexDiscardMode=Oh.None;else{switch(this._computeWhichMaterialPass()===Ga.OpaqueAndTransparent?n.vertexDiscardMode=r.transparent?Oh.Opaque:Oh.Transparent:n.vertexDiscardMode=Oh.None,n.output=r.output,n.receiveAmbientOcclusion=!1,n.receiveShadows=!1,r.output){case k.Color:n.receiveAmbientOcclusion=i.ssaoHelper.active,n.hasOccludees=i.hasOccludees,n.receiveShadows=i.shadowMap.ready,n.hasScreenSpaceReflections=i.ssr.enabled,n.hasCloudsReflections=v(i.cloudsFade.data);break;case k.Alpha:n.hasOccludees=i.hasOccludees;break;case k.ObjectAndLayerIdColor:n.objectAndLayerIdColor=!0}n.snowCover=this.hasSnowCover(i)}return this._technique=e.releaseAndAcquire(XEe,n,this._technique),this._setClean(),this._technique}hasSnowCover(e){return v(e.weather)&&e.weatherVisible&&e.weather.type==="snowy"&&e.weather.snowCover==="enabled"}submit(e,r,i){if(this.objectOpacity===0)return;const s=i.renderable.geometry,n=i.components,o=i.renderable.meta.cameraDepthSquared,a=n.geometryRanges,l=n.highlightRanges,c=n.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case Ga.Opaque:e.materialOpaque.submitDraw(this,s,a,o);break;case Ga.Transparent:e.materialTransparent.submitDraw(this,s,a,o);break;case Ga.OpaqueAndTransparent:e.materialOpaque.submitDraw(this,s,a,o),e.materialTransparent.submitDraw(this,s,a,o);break;case Ga.IntegratedMesh:e.materialIntegratedMesh.submitDraw(this,s,a,o),uyt(r)&&e.highlightIntegratedMesh.submitDraw(this,s,a,o)}const h=this.componentParameters.castShadows!==$n.None;h&&e.shadowMap.submitDraw(this,s,a,o),v(l)&&(e.highlight.submitDraw(this,s,l,o),h&&e.highlightShadowMap.submitDraw(this,s,l,o)),h&&v(c)&&e.defaultShadowMap.submitDraw(this,s,c,o)}_computeWhichMaterialPass(){return this.isIntegratedMesh?Ga.IntegratedMesh:this.objectOpacity<1?Ga.Transparent:this.componentParameters.opaqueOverride===$n.All?Ga.Opaque:this.baseColor[3]<1||this.alphaDiscardMode===ui.Blend||this.alphaDiscardMode===ui.MaskBlend?Ga.Transparent:this.componentParameters.transparent===$n.None?Ga.Opaque:this.componentParameters.transparent===$n.All?Ga.Transparent:Ga.OpaqueAndTransparent}};var Ga,$n;u([ds({vectorOps:ade})],Wn.prototype,"baseColor",void 0),u([ds()],Wn.prototype,"usePBR",void 0),u([ds()],Wn.prototype,"hasParametersFromSource",void 0),u([ds({vectorOps:EK})],Wn.prototype,"mrrFactors",void 0),u([ds({vectorOps:EK})],Wn.prototype,"emissiveFactor",void 0),u([ds({dispose:!0})],Wn.prototype,"baseColorTexture",void 0),u([ds({dispose:!0})],Wn.prototype,"metallicRoughnessTexture",void 0),u([ds({dispose:!0})],Wn.prototype,"emissionTexture",void 0),u([ds({dispose:!0})],Wn.prototype,"occlusionTexture",void 0),u([ds({dispose:!0})],Wn.prototype,"normalTexture",void 0),u([ds()],Wn.prototype,"objectOpacity",void 0),u([vle()],Wn.prototype,"commonMaterialParameters",void 0),u([vle()],Wn.prototype,"componentParameters",void 0),u([ds()],Wn.prototype,"textureAlphaCutoff",void 0),u([ds()],Wn.prototype,"alphaDiscardMode",void 0),u([ds()],Wn.prototype,"isIntegratedMesh",void 0),u([ds()],Wn.prototype,"polygonOffsetEnabled",void 0),u([ds()],Wn.prototype,"ellipsoidMode",void 0),u([ds()],Wn.prototype,"hasOccludees",void 0),function(t){t[t.Opaque=0]="Opaque",t[t.Transparent=1]="Transparent",t[t.OpaqueAndTransparent=2]="OpaqueAndTransparent",t[t.IntegratedMesh=3]="IntegratedMesh"}(Ga||(Ga={}));let MD=class extends xJ{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=Ti.Back,this.hasSlicePlane=!0}};u([ds()],MD.prototype,"doubleSided",void 0),u([ds()],MD.prototype,"cullFace",void 0),u([ds()],MD.prototype,"hasSlicePlane",void 0);let OR=class extends xJ{constructor(){super(...arguments),this.externalColor=Ht(1,1,1,1),this.externalColorMixMode=_n.Multiply,this.castShadows=$n.All}get transparent(){return this.externalColor[3]<1?$n.All:$n.None}get opaqueOverride(){return this.externalColorMixMode===_n.Replace&&this.externalColor[3]===1?$n.All:$n.None}get visible(){return this.externalColor[3]>0?$n.All:$n.None}get type(){return Kf.Uniform}};u([ds({vectorOps:ade})],OR.prototype,"externalColor",void 0),u([ds()],OR.prototype,"externalColorMixMode",void 0),u([ds()],OR.prototype,"castShadows",void 0),function(t){t[t.All=0]="All",t[t.Some=1]="Some",t[t.None=2]="None"}($n||($n={}));let M3=class extends xJ{constructor(){super(...arguments),this.texture=null,this.transparent=$n.None,this.opaqueOverride=$n.None,this.castShadows=$n.None}get type(){return Kf.Varying}};function uyt(t){return t.overlays.length!==0&&v(t.overlays[Ki.INNER].getValidTexture(fs.Highlight))}function hyt(t){return t.overlays.length!==0&&v(t.overlays[Ki.INNER].getColorTextureNoRasterImage())}u([ds()],M3.prototype,"texture",void 0),u([ds()],M3.prototype,"transparent",void 0),u([ds()],M3.prototype,"opaqueOverride",void 0),u([ds()],M3.prototype,"castShadows",void 0);const XF=ts().vec3f(A.POSITION).u16(A.COMPONENTINDEX).u16(A.U16PADDING),JEe=ts().vec2u8(A.SIDENESS),dyt=Vc(JEe),KEe=ts().vec3f(A.POSITION0).vec3f(A.POSITION1).u16(A.COMPONENTINDEX).u8(A.VARIANTOFFSET,{glNormalized:!0}).u8(A.VARIANTSTROKE).u8(A.VARIANTEXTENSION,{glNormalized:!0}).u8(A.U8PADDING,{glPadding:!0}).u16(A.U16PADDING,{glPadding:!0}),EH=KEe.clone().vec3f(A.NORMAL),CH=KEe.clone().vec3f(A.NORMALA).vec3f(A.NORMALB),QEe=new Map([[A.POSITION0,0],[A.POSITION1,1],[A.COMPONENTINDEX,2],[A.VARIANTOFFSET,3],[A.VARIANTSTROKE,4],[A.VARIANTEXTENSION,5],[A.NORMAL,6],[A.NORMALA,6],[A.NORMALB,7],[A.SIDENESS,8]]);function wle(t,e,r){const i=e/3,s=new Uint32Array(r+1),n=new Uint32Array(r+1),o=(x,T)=>{x<T?s[x+1]++:n[T+1]++};for(let x=0;x<i;x++){const T=t[3*x],S=t[3*x+1],E=t[3*x+2];o(T,S),o(S,E),o(E,T)}let a=0,l=0;for(let x=0;x<r;x++){const T=s[x+1],S=n[x+1];s[x+1]=a,n[x+1]=l,a+=T,l+=S}const c=new Uint32Array(6*i),h=s[r],p=(x,T,S)=>{if(x<T){const E=s[x+1]++;c[2*E]=T,c[2*E+1]=S}else{const E=n[T+1]++;c[2*h+2*E]=x,c[2*h+2*E+1]=S}};for(let x=0;x<i;x++){const T=t[3*x],S=t[3*x+1],E=t[3*x+2];p(T,S,x),p(S,E,x),p(E,T,x)}const f=(x,T)=>{const S=2*x,E=T-x;for(let O=1;O<E;O++){const R=c[S+2*O],L=c[S+2*O+1];let P=O-1;for(;P>=0&&c[S+2*P]>R;P--)c[S+2*P+2]=c[S+2*P],c[S+2*P+3]=c[S+2*P+1];c[S+2*P+2]=R,c[S+2*P+3]=L}};for(let x=0;x<r;x++)f(s[x],s[x+1]),f(h+n[x],h+n[x+1]);const m=new Int32Array(3*i),y=(x,T)=>x===t[3*T]?0:x===t[3*T+1]?1:x===t[3*T+2]?2:-1,_=(x,T)=>{const S=y(x,T);m[3*T+S]=-1},b=(x,T,S,E)=>{const O=y(x,T);m[3*T+O]=E;const R=y(S,E);m[3*E+R]=T};for(let x=0;x<r;x++){let T=s[x];const S=s[x+1];let E=n[x];const O=n[x+1];for(;T<S&&E<O;){const R=c[2*T],L=c[2*h+2*E];R===L?(b(x,c[2*T+1],L,c[2*h+2*E+1]),T++,E++):R<L?(_(x,c[2*T+1]),T++):(_(L,c[2*h+2*E+1]),E++)}for(;T<S;)_(x,c[2*T+1]),T++;for(;E<O;)_(c[2*h+2*E],c[2*h+2*E+1]),E++}return m}let eCe=class{updateSettings(e){this.settings=e,this._edgeHashFunction=e.reducedPrecision?fyt:pyt}write(e,r,i){const s=this._edgeHashFunction(i);M$.seed=s;const n=M$.getIntRange(0,255),o=M$.getIntRange(0,this.settings.variants-1),a=.7,l=M$.getFloat(),c=255*(.5*myt(-(1-Math.min(l/a,1))+Math.max(0,l-a)/(1-a),1.2)+.5);e.position0.setVec(r,i.position0),e.position1.setVec(r,i.position1),e.componentIndex.set(r,i.componentIndex),e.variantOffset.set(r,n),e.variantStroke.set(r,o),e.variantExtension.set(r,c)}trim(e,r){return e.slice(0,r)}};const TJ=new Float32Array(6),YF=new Uint32Array(TJ.buffer),P_=new Uint32Array(1);function pyt(t){const e=TJ;e[0]=t.position0[0],e[1]=t.position0[1],e[2]=t.position0[2],e[3]=t.position1[0],e[4]=t.position1[1],e[5]=t.position1[2],P_[0]=5381;for(let r=0;r<YF.length;r++)P_[0]=31*P_[0]+YF[r];return P_[0]}function fyt(t){const e=TJ;e[0]=uT(t.position0[0]),e[1]=uT(t.position0[1]),e[2]=uT(t.position0[2]),e[3]=uT(t.position1[0]),e[4]=uT(t.position1[1]),e[5]=uT(t.position1[2]),P_[0]=5381;for(let r=0;r<YF.length;r++)P_[0]=31*P_[0]+YF[r];return P_[0]}const xle=1e4;function uT(t){return Math.round(t*xle)/xle}function myt(t,e){const r=t<0?-1:1;return Math.abs(t)**e*r}let ZF=class{constructor(){this._commonWriter=new eCe}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return EH.createBuffer(e)}write(e,r,i){this._commonWriter.write(e,r,i),fe(O$,i.faceNormal0,i.faceNormal1),_e(O$,O$),e.normal.setVec(r,O$)}trim(e,r){return this._commonWriter.trim(e,r)}};ZF.Layout=EH,ZF.glLayout=Vc(EH,1);let JF=class{constructor(){this._commonWriter=new eCe}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return CH.createBuffer(e)}write(e,r,i){this._commonWriter.write(e,r,i),e.normalA.setVec(r,i.faceNormal0),e.normalB.setVec(r,i.faceNormal1)}trim(e,r){return this._commonWriter.trim(e,r)}};JF.Layout=CH,JF.glLayout=Vc(CH,1);const O$=M(),M$=new L3,ub=-1;var KF;function gyt(t,e,r,i=xyt){const s=t.vertices.position,n=t.vertices.componentIndex,o=Gt(i.anglePlanar),a=Gt(i.angleSignificantEdge),l=Math.cos(a),c=Math.cos(o),h=AH.edge,p=h.position0,f=h.position1,m=h.faceNormal0,y=h.faceNormal1,_=wyt(t),b=byt(t),x=b.length/4,T=e.allocate(x);let S=0;const E=x,O=r.allocate(E);let R=0,L=0,P=0;const U=gAe(0,x),B=new Float32Array(x);B.forEach((Q,H,$)=>{s.getVec(b[4*H+0],p),s.getVec(b[4*H+1],f),$[H]=xi(p,f)}),U.sort((Q,H)=>B[H]-B[Q]);const z=new Array,G=new Array;for(let Q=0;Q<x;Q++){const H=U[Q],$=B[H],N=b[4*H+0],F=b[4*H+1],j=b[4*H+2],X=b[4*H+3],J=X===ub;if(s.getVec(N,p),s.getVec(F,f),J)ce(m,_[3*j+0],_[3*j+1],_[3*j+2]),le(y,m),h.componentIndex=n.get(N),h.cosAngle=ye(m,y);else{if(ce(m,_[3*j+0],_[3*j+1],_[3*j+2]),ce(y,_[3*X+0],_[3*X+1],_[3*X+2]),h.componentIndex=n.get(N),h.cosAngle=ye(m,y),_yt(h,c))continue;h.cosAngle<-.9999&&le(y,m)}L+=$,P++,J||yyt(h,l)?(e.write(T,S++,h),z.push($)):vyt(h,o)&&(r.write(O,R++,h),G.push($))}const K=new Float32Array(z.reverse()),ee=new Float32Array(G.reverse());return{regular:{instancesData:e.trim(T,S),lodInfo:{lengths:K}},silhouette:{instancesData:r.trim(O,R),lodInfo:{lengths:ee}},averageEdgeLength:L/P}}function yyt(t,e){return t.cosAngle<e}function _yt(t,e){return t.cosAngle>e}function vyt(t,e){const r=Sn(t.cosAngle),i=AH.fwd,s=AH.ortho;return ay(i,t.position1,t.position0),r*(ye(pt(s,t.faceNormal0,t.faceNormal1),i)>0?-1:1)>e}function byt(t){const e=t.faces.length/3,r=t.faces,i=t.neighbors;let s=0;for(let a=0;a<e;a++){const l=i[3*a+0],c=i[3*a+1],h=i[3*a+2],p=r[3*a+0],f=r[3*a+1],m=r[3*a+2];s+=l===ub||p<f?1:0,s+=c===ub||f<m?1:0,s+=h===ub||m<p?1:0}const n=new Int32Array(4*s);let o=0;for(let a=0;a<e;a++){const l=i[3*a+0],c=i[3*a+1],h=i[3*a+2],p=r[3*a+0],f=r[3*a+1],m=r[3*a+2];(l===ub||p<f)&&(n[o++]=p,n[o++]=f,n[o++]=a,n[o++]=l),(c===ub||f<m)&&(n[o++]=f,n[o++]=m,n[o++]=a,n[o++]=c),(h===ub||m<p)&&(n[o++]=m,n[o++]=p,n[o++]=a,n[o++]=h)}return n}function wyt(t){const e=t.faces.length/3,r=t.vertices.position,i=t.faces,s=pk.v0,n=pk.v1,o=pk.v2,a=new Float32Array(3*e);for(let l=0;l<e;l++){const c=i[3*l+0],h=i[3*l+1],p=i[3*l+2];r.getVec(c,s),r.getVec(h,n),r.getVec(p,o),me(n,n,s),me(o,o,s),pt(s,n,o),_e(s,s),a[3*l+0]=s[0],a[3*l+1]=s[1],a[3*l+2]=s[2]}return a}(function(t){t[t.SOLID=0]="SOLID",t[t.SKETCH=1]="SKETCH"})(KF||(KF={}));const AH={edge:{position0:M(),position1:M(),faceNormal0:M(),faceNormal1:M(),componentIndex:0,cosAngle:0},ortho:M(),fwd:M()},pk={v0:M(),v1:M(),v2:M()},xyt={anglePlanar:4,angleSignificantEdge:35};function Tyt(t){const e=Syt(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return Tle.updateSettings(t.writerSettings),Sle.updateSettings(t.writerSettings),gyt(e,Tle,Sle)}function Syt(t,e,r,i){if(e){const o=wle(r,i,t.count);return new Eyt(r,i,o,t)}const s=Vj(t.buffer,t.stride/4,{originalIndices:r,originalIndicesLength:i}),n=wle(s.indices,i,s.uniqueCount);return{faces:s.indices,facesLength:s.indices.length,neighbors:n,vertices:XF.createView(s.buffer)}}let Eyt=class{constructor(e,r,i,s){this.faces=e,this.facesLength=r,this.neighbors=i,this.vertices=s}};const Tle=new ZF,Sle=new JF,qDt=ts().vec3f(A.POSITION0).vec3f(A.POSITION1),Cyt=ts().vec3f(A.POSITION0).vec3f(A.POSITION1).u16(A.COMPONENTINDEX).u16(A.U16PADDING,{glPadding:!0});let Ayt=class{constructor(e){this._maxCount=e,this._nextIndex=0,this._recycledIndices=[]}get activeCount(){return this._nextIndex-this._recycledIndices.length}get availableCount(){return this._recycledIndices.length+this._maxCount-this._nextIndex}acquire(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this._recycledIndices.push(e)}},Ryt=class{constructor(e,r=1){this._rctx=e,this._fieldCount=r,this.textureWidth=4096,this._dirty=!0,this._texture=new ct(this._rctx,{target:bt.TEXTURE_2D,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,wrapMode:Rt.CLAMP_TO_EDGE,width:this.textureWidth,height:1,flipped:!1}),this._data=new xa(new ArrayBuffer(4*this.textureWidth))}dispose(){this._texture.dispose(),this._texture=void 0,this._data=void 0}setData(e,r,i,s,n,o){const a=e*this._fieldCount+r;this._dirty=!0,this._data.set(a,0,i),this._data.set(a,1,s),this._data.set(a,2,n),this._data.set(a,3,o)}setDataElement(e,r,i,s){const n=e*this._fieldCount+r;this._dirty=!0,this._data.set(n,i,s)}resizeToFit(e){const r=e*this._fieldCount;if(r>=this._data.count){const i=Math.ceil((r+1)/this.textureWidth)*this.textureWidth,s=new xa(new ArrayBuffer(4*i));s.typedBuffer.set(this._data.typedBuffer),this._data=s}}updateTexture(){if(!this._dirty)return;const e=this._texture.descriptor.width,r=this._texture.descriptor.height;this._data.count>e*r&&this._texture.resize(e,this._data.count/e),this._texture.setData(this._data.typedBuffer),this._dirty=!1}get texture(){return this._texture}};const tCe=65536;let Oyt=class{constructor(e,r=1){this.textureBuffer=new Ryt(e,r),this._indexManager=new Ayt(tCe)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this._indexManager.availableCount}get activeCount(){return this._indexManager.activeCount}acquireIndex(){const e=this._indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this._indexManager.release(e)}},rCe=class{constructor(e,r=1){this._rctx=e,this._fieldCount=r,this._buffers=[]}garbageCollect(){this._buffers=this._buffers.filter(e=>e.activeCount!==0||(e.dispose(),!1))}destroy(){this._buffers.forEach(e=>e.dispose()),this._buffers=[]}getBuffer(e){for(const i of this._buffers)if(i.availableCount>=e)return i;if(e>tCe)return null;const r=new Oyt(this._rctx,this._fieldCount);return this._buffers.push(r),r}updateTextures(){for(const e of this._buffers)e.textureBuffer.updateTexture()}};const Ele=se.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class Myt{constructor(e,r){this._renderManager=e,this._viewingMode=r,this._objects=[new Jt,new Jt],this._renderSubmit=new Kgt(this),this._renderManager.register(this._renderSubmit),this._hasObjectAndLayerId=de("enable-feature:objectAndLayerId-rendering"),this._componentBufferManager=new rCe(e.rctx,2+(this._hasObjectAndLayerId?1:0))}destroy(){ft(this._objects[gS.Hidden].length===0&&this._objects[gS.Visible].length===0,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy()}createObject(e){const r=new O3;return r.toMapSpace=e.toMapSpace,r.transform=e.transform,r.obb=hle(e.obb),r.components=new Igt(this._componentBufferManager,e.geometry.componentOffsets),r.renderable=this._createRenderable(e,r.components),r.intersectionGeometry=new kgt(e.geometry.positionData,r.components),this._objects[r.visible].push(r),r}destroyObject(e){const r=e;this._objects[r.visible].removeUnordered(r),r.destroy(),this._notifyDirty()}setObjectVisibility(e,r){const i=e;r!==i.visible&&(this._objects[i.visible].removeUnordered(i),this._objects[r].push(i),i.visible=r,this._notifyDirty())}preSubmit(e){const r=e.camera.eye;this.visibleObjects.forAll(i=>i.renderable.meta.cameraDepthSquared=Ro(r,i.obb.center))}getMaterial(e){return e.renderable.material}updateMaterial(e,r){const i=e.renderable.material;r(i),i.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,r){const i=e;i.components.visibility.reset(r),i.components.visibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,r){return e.components.visibility.forEachComponent(r)}getComponentCount(e){const r=e,i=r.components.visibility.componentCount();return{visible:i,invisible:r.components.count-i}}setComponentData(e,r){const i=e,s=i.renderable.material,n=i.components,o=n.materialDataBuffer,a=n.materialDataIndices,l=new eyt,c=o.textureBuffer,h=new Uint8Array(4),p=new Uint32Array(h.buffer);let f=0,m=0,y=0,_=n.verticalOffsets,b=1/0,x=-1/0,T=!1,S=!1,E=0;for(let O=0;O<n.count;O++){r(O,l),f+=+(l.externalColor[3]<1),m+=+(l.externalColorMixMode===_n.Replace&&l.externalColor[3]===1),y+=+l.castShadows,v2e(l.externalColor,l.externalColorMixMode,h),h[2]=254&h[2]|+l.castShadows,c.setData(a[O],0,h[0],h[1],h[2],h[3]),T||(T=O>0&&E!==p[0]),E=p[0],S||(S=l.elevationOffset!==0),S&&C(_)&&(_=new Array(O).fill(0)),v(_)&&(_[O]=l.elevationOffset),b=Math.min(b,l.elevationOffset),x=Math.max(x,l.elevationOffset),WEe(l.elevationOffset,h),c.setData(a[O],1,h[0],h[1],h[2],h[3]);const R=l.objectAndLayerIdColor;v(R)&&c.setData(a[O],2,R[0],R[1],R[2],R[3]),l.pickable!==jEe(n.pickability,O)&&(n.pickability=Lgt(n.pickability,n.count,O,l.pickable))}n.verticalOffsets=S?_:null,i.offsetObb=S?Ogt(i.obb,b,x,this._viewingMode,v(i.offsetObb)?i.offsetObb:hle(i.obb)):null,T||S||this._hasObjectAndLayerId?(s.componentParameters=new M3,s.componentParameters.castShadows=fk(y,n.count),s.componentParameters.transparent=fk(f,n.count),s.componentParameters.opaqueOverride=fk(m,n.count),s.componentParameters.texture=c,c.updateTexture()):(s.componentParameters=new OR,s.componentParameters.castShadows=l.castShadows?$n.All:$n.None,s.componentParameters.externalColor=l.externalColor,s.componentParameters.externalColorMixMode=l.externalColorMixMode),this._notifyDirty()}getComponentAabb(e,r,i,s=!1){e.intersectionGeometry.getComponentAabb(r,i);const n=e,o=n.components.verticalOffsets;if(s||C(o))return i;const a=o[r];if(this._viewingMode===Be.Local||a===0)return i[2]+=a,i[5]+=a,i;const l=OJe(a);return l.localOrigin=n.transform.position,l.applyToAabb(i)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,r,i){return e.intersectionGeometry.getComponentPositions(r,i)}intersect(e,r,i,s,n,o){const a=e;v(n)&&(n.localOrigin=a.transform.position);const l=ex(Cle,a.transform.rotationScale);to(P$,r,a.transform.position),to(I$,i,a.transform.position),Ac(P$,P$,l),Ac(I$,I$,l);const c=qh(Cle,l);return a.intersectionGeometry.intersect(P$,I$,s,c,n,a.components.verticalOffsets,o)}addEdges(e,r,i,s){const n=e,{indices:o,positions:a}=n.intersectionGeometry,l=n.components.offsets;return r.addComponentObject(e,n.transform,{center:n.obb.center,radius:Rgt(n.obb)},a,o,l,i,s)}async extractEdgeInformation(e,r,i){const s=e,n=s.components.visibility;if(n.allInvisible())return{buffer:Cyt.createBuffer(0),origin:[0,0,0]};const{indices:o,positions:a}=s.intersectionGeometry,l=s.components.offsets,c=XF.createBuffer(a.count);n6(c.position,a),uv(c.position,c.position,s.transform.rotationScale),this._setComponentIndices(c.componentIndex,o,l);const h=c.count,p=this._computeVisibilityIndices(o,n,l,h);return{origin:ms(s.transform.position),buffer:await r.extractComponentsEdgeLocations({indices:p,indicesLength:p.length,skipDeduplicate:!0,data:c,writerSettings:{reducedPrecision:!1,variants:0}},i)}}_setComponentIndices(e,r,i){let s=0;for(let n=0;n<i.length-1;n++){const o=i[n],a=i[n+1];for(let l=o;l<a;l++){const c=r?r[l]:l;e.set(c,s)}s++}}_computeVisibilityIndices(e,r,i,s){if(e&&r.allVisible())return e;let n=0;r.forEachComponentRange((l,c)=>(n+=i[c]-i[l],!0));const o=Array.isArray(e)?new Array(n):(e==null?void 0:e.BYTES_PER_ELEMENT)===2||s<=65536?new Uint16Array(n):new Uint32Array(n);let a=0;return r.forEachComponentRange((l,c)=>{const h=i[l],p=i[c];for(let f=h;f<p;f++)o[a++]=e?e[f]:f;return!0}),o}addComponentHighlight(e,r){const i=e.components;C(i.highlightCounts)&&(i.highlightCounts=new Uint32Array(i.count+1)),i.highlightCounts[r]++===0&&(i.highlightsDirty(),this._notifyDirty()),i.highlightCounts[i.count]++}removeComponentHighlight(e,r){const i=e.components;if(C(i.highlightCounts))return void Ele.warn("Removing non-existing highlight.");const s=i.highlightCounts[r],n=i.highlightCounts[i.count];if(s!==0){if(s>1)return i.highlightCounts[r]=s-1,void(i.highlightCounts[i.count]=n-1);i.highlightCounts[r]=0,i.highlightsDirty(),this._notifyDirty(),n===1?i.highlightCounts=null:i.highlightCounts[i.count]=n-1}else Ele.warn("Removing non-existing highlight.")}clearHighlights(e){const r=e.components;v(r.highlightCounts)&&(r.highlightCounts=null,r.highlightsDirty(),this._notifyDirty())}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._objects[gS.Visible]}_createRenderable(e,r){const i=this._renderManager.rctx,s=e.geometry,n=s.vertices.layoutParameters,o=jr.createVertex(i,Lr.STATIC_DRAW,s.vertices.data),a=so(s.indices,_=>jr.createIndex(i,Lr.STATIC_DRAW,_)),l=Vc(Qgt(n)),c=new Uint16Array(s.vertices.count);for(let _=0;_<r.count;_++){const b=r.offsets[_],x=r.offsets[_+1],T=r.materialDataIndices[_];if(v(s.indices))for(let S=b;S<x;S++)c[s.indices[S]]=T;else for(let S=b;S<x;S++)c[S]=T}const h=jr.createVertex(i,Lr.STATIC_DRAW,c.buffer),p=new Wn(e.transform,e.toMapSpace),f=new jh(i,ZEe,{data:l,componentIndices:Pyt},{data:o,componentIndices:h},a),m=new Ggt(f,$t.TRIANGLES,n,v(a)),y={cameraDepthSquared:.5,gpuMemoryEstimate:o.byteSize+h.byteSize+(v(a)?a.byteSize:0)};return new zgt(p,m,y)}_notifyDirty(){this._renderManager.notifyDirty()}}const Pyt=Vc(ts().u16(A.COMPONENTINDEX));function fk(t,e){return t===e?$n.All:t===0?$n.None:$n.Some}const Cle=Gl(),P$=M(),I$=M();let iCe=class extends pi{constructor(){super(...arguments),this.opacity=1}};function Iyt(t){const e=new Dr;return e.include(Jh),e.fragment.uniforms.add(new Mt("tex",r=>r.texture)),t.hasOpacityFactor&&e.fragment.uniforms.add(new Pe("opacity",r=>r.opacity)),e.fragment.code.add(w`
    void main() {
      gl_FragColor = texture2D(tex, uv) ${t.hasOpacityFactor?"* opacity":""};
    }`),e}const $yt=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:iCe,build:Iyt},Symbol.toStringTag,{value:"Module"}));var da;(function(t){t[t.None=0]="None",t[t.Alpha=1]="Alpha",t[t.PremultipliedAlpha=2]="PremultipliedAlpha",t[t.COUNT=3]="COUNT"})(da||(da={}));let RH=class extends Ca{constructor(){super(...arguments),this.alphaMode=da.None,this.hasOpacityFactor=!1}};u([V({count:da.COUNT})],RH.prototype,"alphaMode",void 0),u([V()],RH.prototype,"hasOpacityFactor",void 0);let sCe=class nCe extends Vr{initializeProgram(e){return new Fr(e.rctx,nCe.shader.get().build(this.configuration),Rr)}initializePipeline(){switch(this.configuration.alphaMode){case da.None:return Bt({colorWrite:Kt});case da.Alpha:return Bt({blending:kn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Kt});case da.PremultipliedAlpha:case da.COUNT:return Bt({blending:Tp(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Kt})}}};sCe.shader=new Nr($yt,()=>te(()=>import("./Compositing.glsl-ec469703.js"),[]));let oCe=class extends pi{};function Lyt(){const t=new Dr;return t.include(Jh),t.fragment.uniforms.add(new Mt("tex",e=>e.texture)),t.fragment.code.add(w`void main() {
gl_FragColor = vec4(1.0 - texture2D(tex, uv).a);
}`),t}const Dyt=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:oCe,build:Lyt},Symbol.toStringTag,{value:"Module"}));let aCe=class lCe extends Vr{initializeProgram(e){return new Fr(e.rctx,lCe.shader.get().build(),Rr)}initializePipeline(){return Bt({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}};aCe.shader=new Nr(Dyt,()=>te(()=>import("./HUDCompositing.glsl-c2d4c86b.js"),[]));let cCe=class extends pi{};function Nyt(){const t=new Dr;return t.include(Jh),t.fragment.uniforms.add([new Mt("colorTexture",e=>e.colorTexture),new Mt("alphaTexture",e=>e.alphaTexture),new Mt("frontFaceTexture",e=>e.frontFaceTexture)]),t.fragment.code.add(w`void main() {
vec4 srcColor = texture2D(colorTexture, uv);
if(srcColor.a <= 1e-5){
discard;
}
float srcAlpha = texture2D(alphaTexture, uv).r;
vec4 frontFace = texture2D(frontFaceTexture, uv);
gl_FragColor = vec4(mix(srcColor.rgb/srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);
}`),t}const Fyt=Object.freeze(Object.defineProperty({__proto__:null,OITCompositingPassParameters:cCe,build:Nyt},Symbol.toStringTag,{value:"Module"}));let uCe=class hCe extends Vr{initializeProgram(e){return new Fr(e.rctx,hCe.shader.get().build(),Rr)}initializePipeline(){return Bt({blending:kn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Kt})}};uCe.shader=new Nr(Fyt,()=>te(()=>import("./OITCompositing.glsl-6df381f3.js"),[]));let dCe=class extends pi{constructor(){super(...arguments),this.overlayIndex=Ki.INNER,this.opacity=1}};function Uyt(){const t=new Dr;return t.include(Jh),t.fragment.uniforms.add(new Mt("tex",e=>e.texture)),t.fragment.uniforms.add(new kM("overlayIdx",e=>e.overlayIndex)),t.fragment.uniforms.add(new Pe("opacity",e=>e.opacity)),t.fragment.code.add(w`void main() {
vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
gl_FragColor = texture2D(tex, overlayUV) * opacity;
}`),t}const kyt=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:dCe,build:Uyt},Symbol.toStringTag,{value:"Module"}));let pCe=class fCe extends Vr{initializeProgram(e){return new Fr(e.rctx,fCe.shader.get().build(),Rr)}initializePipeline(){return Bt({blending:Tp(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Kt})}};pCe.shader=new Nr(kyt,()=>te(()=>import("./OverlayCompositing.glsl-3d771dbe.js"),[]));let Vyt=class{constructor(e,r){this._rctx=e,this._techniqueRepository=r,this._configuration=new RH,this._passParameters=new iCe,this._oitParameters=new cCe,this._hudParameters=new oCe,this._overlayParameters=new dCe}destroy(){this._vao=Qe(this._vao)}compositeOIT(e,r,i,s){this._oitParameters.colorTexture=r,this._oitParameters.alphaTexture=i,this._oitParameters.frontFaceTexture=s;const n=this._rctx,o=this._techniqueRepository.acquire(uCe);n.bindTechnique(o,this._oitParameters,e);const a=this._ensureVAO();n.bindVAO(a),n.drawArrays($t.TRIANGLE_STRIP,0,Wo(a,"geometry")),o.release()}compositeHUD(e,r){this._hudParameters.texture=r;const i=this._rctx,s=this._techniqueRepository.acquire(aCe);i.bindTechnique(s,this._hudParameters,e);const n=this._ensureVAO();i.bindVAO(n),i.drawArrays($t.TRIANGLE_STRIP,0,Wo(n,"geometry")),s.release()}compositeOverlay(e,r,i,s){this._overlayParameters.texture=r,this._overlayParameters.opacity=i,this._overlayParameters.overlayIndex=s;const n=this._rctx,o=this._techniqueRepository.acquire(pCe);n.bindTechnique(o,this._overlayParameters,e);const a=this._ensureVAO();n.bindVAO(a),n.drawArrays($t.TRIANGLE_STRIP,0,Wo(a,"geometry")),o.release()}composite(e,r,i=da.None,s=1){const n=this._rctx;this._configuration.alphaMode=i,this._configuration.hasOpacityFactor=s!==1,this._passParameters.texture=r,this._passParameters.opacity=s;const o=this._techniqueRepository.acquire(sCe,this._configuration);n.bindTechnique(o,this._passParameters,e);const a=this._ensureVAO();n.bindVAO(a),n.drawArrays($t.TRIANGLE_STRIP,0,Wo(a,"geometry")),o.release()}_ensureVAO(){return C(this._vao)&&(this._vao=Aa(this._rctx)),this._vao}};const Byt=1e4,OH=100,zyt=500,Gyt=500,jyt=.1;function Hyt(t,e,r){return mZ(e,t)*(r[1]-r[0])+r[0]}function qyt(t,e,r){let i=0;if(!e.some(n=>(i+=n.numGeometries,i>=Byt)))return e0t.compute(t,e);const s=zM();return r.forAll(n=>{n.visible&&fE(s,Wyt(t,n))}),s}function Wyt(t,e){if(!e.visible)return;const r=zM(),i=e.getSpatialQueryAccelerator();return v(i)?Xyt(r,t,i):Yyt(r,t,e.objects),r}function Xyt(t,e,r){const i=e.eye,s=e.viewForward,n=e.frustum,o=l=>l.visible,a=r.objectCount;if(a<zyt)FO(yh,e.near,Math.min(t.near,e.far)),r.forEachInDepthRange(i,s,ep.DepthOrder.FRONT_TO_BACK,yh,(l,c)=>{MH(t,e,l),yh.far=t.near,c.setRange(yh)},n,o),FO(yh,Math.max(t.far,e.near),e.far),r.forEachInDepthRange(i,s,ep.DepthOrder.BACK_TO_FRONT,yh,(l,c)=>{MH(t,e,l),yh.near=t.far,c.setRange(yh)},n,o);else{const l=Math.max(Math.min(a,Gyt),Math.ceil(a*jyt)),c=r.findClosest(s,ep.DepthOrder.FRONT_TO_BACK,n,o,l),h=r.findClosest(s,ep.DepthOrder.BACK_TO_FRONT,n,o,l);c&&h&&(Ale(t,e,c.boundingVolumeWorldSpace.bounds),Ale(t,e,h.boundingVolumeWorldSpace.bounds))}}function Yyt(t,e,r){hT.clear(),r.forAll(i=>{i.visible&&i.geometries.length!==0&&hT.add(i)}),hT.empty||(hT.sort(e),FO(yh,e.near,Math.min(t.near,e.far)),hT.forEachInDepthRange(yh,ep.DepthOrder.FRONT_TO_BACK,(i,s)=>{s<t.near&&MH(t,e,i)}),FO(yh,Math.max(t.far,e.near),e.far),hT.forEachInDepthRange(yh,ep.DepthOrder.BACK_TO_FRONT,(i,s,n)=>{t.far=Math.max(t.far,n)}))}function MH(t,e,r){if(!r.visible||!R_(e.frustum,r.boundingVolumeWorldSpace.bounds))return;const i=r.transformation,s=Qyt;r.geometries.forEach(n=>{gs(s,i,n.shaderTransformation);const o=bw(s);mCe(t,e,n.boundingInfo,s,o)})}function mCe(t,e,r,i,s){if(C(r))return;We(zo,r.center,i);const{eye:n,viewForward:o}=e,a=o[0]*(zo[0]-n[0])+o[1]*(zo[1]-n[1])+o[2]*(zo[2]-n[2]);if(zo[3]=r.radius*s,!(a-zo[3]>t.near&&a+zo[3]<t.far)&&R_(e.frustum,zo))if(r.radius>OH&&r.getChildren())for(const l of r.getChildren())mCe(t,e,l,i,s);else PH.unionDepthRangeWithAABB(t,e.viewProjectionMatrix,i,r.bbMin,r.bbMax)}function Ale(t,e,r){const i=e.eye,s=e.viewForward,n=(r[0]-i[0])*s[0]+(r[1]-i[1])*s[1]+(r[2]-i[2])*s[2];t.near=Math.min(t.near,n-r[3]),t.far=Math.max(t.far,n+r[3])}let Zyt=class{constructor(){this._items=new Jt({allocator:e=>e||{obj:null,distance:0,near:0,far:0},deallocator:e=>(e.obj=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return this._items.length===0}clear(){this._items.clear()}add(e){this._items.pushNew().obj=e}sort(e){const r=e.eye,i=e.viewForward;this._items.forAll(s=>{const n=s.obj.boundingVolumeWorldSpace.bounds,o=(n[0]-r[0])*i[0]+(n[1]-r[1])*i[1]+(n[2]-r[2])*i[2];s.distance=o,s.near=o-n[3],s.far=o+n[3]}),this._items.sort((s,n)=>s.distance-n.distance)}forEachInDepthRange(e,r,i){if(r===ep.DepthOrder.FRONT_TO_BACK)for(let s=0;s<this._items.length;++s){const n=this._items.data[s];n.far<e.near||n.near>e.far||i(n.obj,n.near,n.far)}else for(let s=this._items.length-1;s>=0;--s){const n=this._items.data[s];n.far<e.near||n.near>e.far||i(n.obj,n.near,n.far)}}},Jyt=class{constructor(){this._view=Ie(),this._viewProj=Ie(),this._frustum=pO(),this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange={near:0,far:0}}compute(e,r){this._reset(),Fn(this._view,e.viewMatrix),gs(this._viewProj,e.projectionMatrix,this._view),tF(this._frustum,e.frustum);const i=this._view,s=i[2],n=i[6],o=i[10],a=i[14];r.forAll(f=>f.forEachGeometry(m=>{if(!m.visible||!m.castShadow)return;let y;m.hasShaderTransformation?(m.computeBoundingSphere(m.shaderTransformation,zo,1),y=zo):y=m.boundingSphere;const _=s*y[0]+n*y[1]+o*y[2]+a,b=_-y[3],x=_+y[3];this._geometries.push(m),this._near.push(-x),this._far.push(-b)}));const l=new jgt;if(this._geometries.length===0)return l;for(let f=0;f<this._geometries.length;++f)this._near[f]>l.far&&(l.far=this._near[f]),this._near[f]>2&&this._far[f]<l.near&&(l.near=this._far[f]);const c=this._looseRange;c.near=Math.max(.5*l.near,2),c.far=2*l.far;let h=0,p=0;for(let f=0;f<this._geometries.length;++f)this._near[f]<l.near&&(this._near[f]>=c.near?l.near=this._near[f]:this._nearCandidates[h++]=f),this._far[f]>l.far&&(this._far[f]<=c.far?l.far=this._far[f]:this._farCandidates[p++]=f);if(this._nearCandidates.length===0&&this._farCandidates.length===0)return l;this._nearCandidates.sort((f,m)=>this._near[f]<this._near[m]?-1:this._near[f]>this._near[m]?1:0),this._farCandidates.sort((f,m)=>this._far[f]<this._far[m]?1:this._far[f]>this._far[m]?-1:0);for(let f=0;f<this._nearCandidates.length;++f){const m=this._nearCandidates[f];if(this._near[m]<l.near){const y=this._geometries[m],_=y.boundingInfo;this._includeNearBoundingInfoRec(_,y.shaderTransformation,l)}}for(let f=0;f<this._farCandidates.length;++f){const m=this._farCandidates[f];if(this._far[m]>l.far){const y=this._geometries[m],_=y.boundingInfo;this._includeFarBoundingInfoRec(_,y.shaderTransformation,l)}}return this._reset(),l}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_includeNearBoundingInfoRec(e,r,i){if(C(e))return;const s=e.center;We(zo,s,r);const n=bw(r),o=zo[0],a=zo[1],l=zo[2],c=e.radius*n,h=this._frustum;if(h[0][0]*o+h[0][1]*a+h[0][2]*l+h[0][3]>c||h[1][0]*o+h[1][1]*a+h[1][2]*l+h[1][3]>c||h[2][0]*o+h[2][1]*a+h[2][2]*l+h[2][3]>c||h[3][0]*o+h[3][1]*a+h[3][2]*l+h[3][3]>c)return;const p=this._view[2]*o+this._view[6]*a+this._view[10]*l+this._view[14],f=p+c;if(!(-(p-c)<2||-f>=i.near))if(-f>this._looseRange.near)i.near=-f;else{if(c>OH){const m=e.getChildren();if(m!==void 0){for(const y of m)this._includeNearBoundingInfoRec(y,r,i);return}}PH.unionDepthRangeWithAABB(i,this._viewProj,r,e.bbMin,e.bbMax)}}_includeFarBoundingInfoRec(e,r,i){if(C(e))return;let s=e.radius;const n=e.center;We(zo,n,r);const o=bw(r),a=zo[0],l=zo[1],c=zo[2];s*=o;const h=this._frustum;if(h[0][0]*a+h[0][1]*l+h[0][2]*c+h[0][3]>s||h[1][0]*a+h[1][1]*l+h[1][2]*c+h[1][3]>s||h[2][0]*a+h[2][1]*l+h[2][2]*c+h[2][3]>s||h[3][0]*a+h[3][1]*l+h[3][2]*c+h[3][3]>s)return;const p=this._view[2]*a+this._view[6]*l+this._view[10]*c+this._view[14]-s;if(!(-p<=i.far))if(-p<this._looseRange.far)i.far=-p;else{if(s>OH){const f=e.getChildren();if(f!==void 0){for(const m of f)this._includeFarBoundingInfoRec(m,r,i);return}}PH.unionDepthRangeWithAABB(i,this._viewProj,r,e.bbMin,e.bbMax)}}},Kyt=class{constructor(){this._modelViewProj=Ie(),this._clipPosition=[sr(),sr(),sr(),sr(),sr(),sr(),sr(),sr()]}unionDepthRangeWithAABB(e,r,i,s,n){const o=this._modelViewProj;gs(o,r,i);let a=!1;for(let l=0;l<8;++l){const c=this._clipPosition[l],h=l===0||l===3||l===4||l===7?s[0]:n[0],p=l===0||l===1||l===4||l===5?s[1]:n[1],f=l<4?s[2]:n[2];c[0]=o[0]*h+o[4]*p+o[8]*f+o[12],c[1]=o[1]*h+o[5]*p+o[9]*f+o[13],c[2]=o[2]*h+o[6]*p+o[10]*f+o[14],c[3]=o[3]*h+o[7]*p+o[11]*f+o[15]}for(let l=0;l<12;++l){const c=this._clipPosition[mk[l][0]],h=this._clipPosition[mk[l][1]],p=this._clipPosition[mk[l][2]],f=this._clipTriangle(c,h,p);let m=!0;for(let y=0;y<f.length;++y)if(f[y][3]>=2){m=!1;break}if(!m){a=!0;for(let y=0;y<f.length;++y){const _=f[y][3];Number.isFinite(_)&&(e.near=Math.min(_,e.near),e.far=Math.max(_,e.far))}}}return a}_inside(e,r){return r===0?e[0]>=-e[3]:r===1?e[1]>=-e[3]:r===2?e[0]<=e[3]:r===3?e[1]<=e[3]:void ft(!1)}_intersect(e,r,i){let s=0;return i===0?s=(-e[3]-e[0])/(r[0]-e[0]+r[3]-e[3]):i===1?s=(-e[3]-e[1])/(r[1]-e[1]+r[3]-e[3]):i===2?s=(e[3]-e[0])/(r[0]-e[0]-r[3]+e[3]):i===3&&(s=(e[3]-e[1])/(r[1]-e[1]-r[3]+e[3])),p4(sr(),e,r,s)}_clipTriangle(e,r,i){let s=[e,r,i];for(let n=0;n<4;++n){const o=s;s=[];for(let a=0;a<o.length;++a){const l=o[a],c=o[(a+1)%o.length];this._inside(c,n)?(this._inside(l,n)||s.push(this._intersect(l,c,n)),s.push(c)):this._inside(l,n)&&s.push(this._intersect(l,c,n))}}return s}};const mk=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],zo=on(),Qyt=Ie(),yh=zM(),hT=new Zyt,e0t=new Jyt,PH=new Kyt;let t0t=class{},r0t=class extends pi{constructor(){super(...arguments),this.textures=new t0t}};function i0t(){const t=new Dr;return t.attributes.add(A.POSITION,"vec2"),t.vertex.uniforms.add(new pr("drawPosition",(e,r)=>s0t(e,r))),t.varyings.add("vUV","vec2"),t.vertex.code.add(w`void main(void) {
vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);
}`),t.fragment.uniforms.add(new Mt("textureInput",e=>e.textures.input)),t.fragment.uniforms.add(new Mt("textureMask",e=>e.textures.mask)),t.fragment.uniforms.add(new Mt("textureOverlay",e=>e.textures.overlay)),t.fragment.uniforms.add(new Bg("maskEnabled",e=>e.magnifier.maskEnabled)),t.fragment.uniforms.add(new Bg("overlayEnabled",e=>e.magnifier.overlayEnabled)),t.fragment.code.add(w`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}
void main() {
float mask = maskEnabled ? texture2D(textureMask, vUV).a : 1.0;
vec4 inputColor = texture2D(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture2D(textureOverlay, vUV) : vec4(0);
gl_FragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;
}`),t}function s0t(t,e){const r=e.camera.pixelRatio,i=t.magnifier.offset.x*r,s=t.magnifier.offset.y*r;Mf(t.magnifier.position,Rle);const n=e.camera.screenToRender(Rle,n0t),o=Math.ceil(r*t.magnifier.size),a=e.camera.fullWidth,l=e.camera.fullHeight;return ti(o0t,(n[0]+i)/a*2-1,(n[1]-s)/l*2-1,o/a*2,o/l*2)}const Rle=as(),n0t=epe(),o0t=sr();async function a0t(t){const e=te(()=>import("./mask-svg-023bbc42.js"),[]),r=te(()=>import("./overlay-svg-d62383f3.js"),[]),i=sy((await e).default,{signal:t}),s=sy((await r).default,{signal:t}),n={mask:await i,overlay:await s};return fr(t),n}let h2=class extends Te{constructor(){super(...arguments),this._handles=new ei,this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this._passParameters=new r0t,this.events=new vs,this.attributeLocations=new Map([[A.POSITION,0]]),this._tmpScreenPoint=as(),this._tmpRenderPoint=epe()}get updating(){return C(this._imageSources)&&v(this._imageLoadTask)&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const r=()=>{this._updateResourceLoading(),this.events.emit("request-render")};v(this._magnifier)&&this._handles.add(ie(()=>so(this._magnifier,i=>i.version),r)),r()}get enabled(){return v(this._validMagnifier)}get _validMagnifier(){return v(this._magnifier)&&this._magnifier.visible&&v(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}get _factor(){return v(this._magnifier)&&this._magnifier.factor||1}destroy(){this._magnifier=null,this._handles.destroy(),v(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeResources()}render(e,r){const i=this._validMagnifier;if(C(i))return;const s=r.camera.pixelRatio,n=Math.ceil(s*i.size);if(this._updateResources(e,n),C(this._resources))return;const o=this._passParameters.textures,a=Math.ceil(1/this._factor*n);o.input.resize(a,a),Mf(i.position,this._tmpScreenPoint);const l=r.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),c=r.camera.fullWidth,h=r.camera.fullHeight,p=.5*a,f=.5*a;l[0]=ge(l[0],p,c-p-1),l[1]=ge(l[1],f,h-f-1);const m=Math.floor(l[0]-p),y=Math.floor(l[1]-f),_=this._resources.program;_.bindTexture("textureInput",o.input),e.gl.copyTexImage2D(o.input.descriptor.target,0,o.input.descriptor.pixelFormat,m,y,a,a,0),this._passParameters.magnifier=i,e.useProgram(_),_.bindPass(this._passParameters,r),e.bindVAO(this._resources.vao),e.setPipelineState(this._resources.pipelineState),e.drawArrays($t.TRIANGLE_STRIP,0,4)}_updateResourceLoading(){const e=this._validMagnifier;if(C(e))return;const r=e.maskUrl,i=e.overlayUrl;!v(this._imageLoadTask)||this._imageLoadTask.maskUrl===r&&this._imageLoadTask.overlayUrl===i||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),v(this._imageSources)||v(this._imageLoadTask)||(this._imageLoadTask={maskUrl:r,overlayUrl:i,task:YO(async s=>{const n=C(r)||C(i)?a0t(s):null,o=v(r)?sy(r,{signal:s}):n.then(l=>l.mask),a=v(i)?sy(i,{signal:s}):n.then(l=>l.overlay);this._imageSources={mask:await o,overlay:await a},this._disposeResources(),this.events.emit("request-render")})},this._imageLoadTask.task.promise.then(()=>this.notifyChange("updating"),()=>this.notifyChange("updating")))}_updateResources(e,r){if(!this.enabled)return void this._disposeResources();if(v(this._resources)){if(this._passParameters.textures.size!==r){const s=this._createTextureResources(e,r);if(C(s))return void this._disposeResources();this._disposeTextureResources(this._passParameters.textures),this._passParameters.textures=s}return}const i=this._createTextureResources(e,r);C(i)||(this._resources={program:this._createProgram(e),vao:Aa(e,rY,this.attributeLocations,0,1),pipelineState:Bt({blending:Tp(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:Kt})},this._passParameters.textures=i)}_disposeResources(){C(this._resources)||(this._disposeTextureResources(this._passParameters.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}_disposeTextureResources(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()}_createTextureResources(e,r){if(C(this._imageSources))return null;this._imageSources.overlay.width=r,this._imageSources.overlay.height=r,this._imageSources.mask.width=r,this._imageSources.mask.height=r;const i=new ct(e,{target:bt.TEXTURE_2D,pixelFormat:Ve.RGBA,internalFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Rt.CLAMP_TO_EDGE,samplingMode:tt.LINEAR,flipped:!0,preMultiplyAlpha:!nhe(this._imageSources.overlay.src)||!e.driverTest.svgPremultipliesAlpha.result},this._imageSources.overlay),s=new ct(e,{target:bt.TEXTURE_2D,pixelFormat:Ve.ALPHA,internalFormat:Ve.ALPHA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Rt.CLAMP_TO_EDGE,samplingMode:tt.LINEAR,flipped:!0},this._imageSources.mask);return{input:new ct(e,{target:bt.TEXTURE_2D,pixelFormat:Ve.RGBA,internalFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Rt.CLAMP_TO_EDGE,samplingMode:tt.LINEAR,flipped:!1}),mask:s,overlay:i,size:r}}_createProgram(e){return new Fr(e,i0t(),this.attributeLocations)}};u([d()],h2.prototype,"_imageSources",void 0),u([d()],h2.prototype,"_imageLoadTask",void 0),u([d({readOnly:!0})],h2.prototype,"updating",null),h2=u([I("esri/views/3d/webgl-engine/lib/MagnifierHelper")],h2);let l0t=class{constructor(){this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new xa(new ArrayBuffer(4)),this._uidToRenderColor=new Map,this._colorToUID=new Map,this._layerUidToGraphicsUidToObjectId=new Map,this._layerUidToId=new Map,this._layerUidToPopupEnabled=new Map}setUidToObjectAndLayerId(e,r,i,s,n,o=null,a=null,l=null){if(!(e&&r&&i&&s)||(this._layerUidToId.set(s,i),this._layerUidToPopupEnabled.set(s,n),!n))return;let c=this._layerUidToGraphicsUidToObjectId.get(s);c||(c=new Map,this._layerUidToGraphicsUidToObjectId.set(s,c)),c.set(r,{objectId:e,attributeNodeId:o,attributeIndex:a,subLayerId:l})}getObjectAndLayerIdColor(e){const r=this.getObjectAndLayerIdColorArray(e);return Ht(r.get(0,1),r.get(0,2),r.get(0,3),255)}getObjectAndLayerIdColorArray(e){if(!e.layerUid||!e.graphicUid)return this.colorZero;const r=this._layerUidToPopupEnabled.get(e.layerUid);if(r===void 0)return se.getLogger(this.declaredClass).warn("popupEnabled is undefined for layerUid "+e.layerUid),this.colorZero;if(r===!1)return this.colorZero;let i=this._uidToRenderColor.get(e.layerUid);i||(i=new Map,this._uidToRenderColor.set(e.layerUid,i));let s=i.get(e.graphicUid);if(!s){for(;!s;){const o=Math.floor(16777214*Math.random())+1;this._colorToUID.has(o)||(s=o)}if(s>16777215)throw new Error("Object ID Overflow");i.set(e.graphicUid,s),this._colorToUID.set(s,e)}const n=new ArrayBuffer(4);return new DataView(n).setUint32(0,s,!1),new xa(n)}getColorToObjectAndLayerIdMapping(){const e=new Map;for(const[r,i]of this._colorToUID.entries()){const s=this._layerUidToGraphicsUidToObjectId.get(i.layerUid);let n=null;s?(n=s.get(i.graphicUid),n||se.getLogger(this.declaredClass).warn("getColorMapping: no entry found for graphicsId "+i.graphicUid)):se.getLogger(this.declaredClass).warn("getColorMapping: no entry found for layerUid "+i.layerUid);const o=this._layerUidToId.get(i.layerUid);o||se.getLogger(this.declaredClass).warn("no layerId found for uid "+i.layerUid),n&&o&&e.set(r,n.attributeNodeId?{type:"object-and-layer-and-i3s-id",oid:n.objectId,lid:o,attrId:n.attributeNodeId,attrIdx:n.attributeIndex,subLayerId:n.subLayerId}:{type:"object-and-layer-id",oid:n.objectId,lid:o})}return e}};var UO;(function(t){t[t.FrontToBack=0]="FrontToBack",t[t.BackToFront=1]="BackToFront"})(UO||(UO={}));let h0=class{constructor(e,r,i=UO.FrontToBack){this._rctx=e,this._techniqueRepository=r,this._sorting=i,this._draws=new Jt({initialSize:32,allocator:s=>s||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,r,i,s){const n=this._draws.pushNew();n.geometry=r,n.geometryRanges=i,n.material=e,n.depthSquaredHint=s,n.indexType=(r.indexed?r.vao.indexBuffer.indexType:null)??0}dispatch(e,r){const i=this._rctx;this._previouslyBoundDraw.clear();let s=null;const n=this._draws.map(a=>a.material.prepareTechnique(this._techniqueRepository,e,r,a.geometry.parameters)),o=this._draws.length;for(let a=0;a<o;a++){const l=n[a];l===s&&l.configuration.transparencyPassType===xt.NONE||(i.bindTechnique(l,e,r),s=l);const c=this._draws.data[a],h=c.geometry;i.bindVAO(h.vao),this._previouslyBoundDraw.get(l)!==c.material&&(l.program.bindDraw(c.material,r,e),this._previouslyBoundDraw.set(l,c.material));const p=c.geometryRanges,f=p.length;if(c.indexType!==0){const m=PD.get(c.indexType);for(let y=0;y<f;y+=2){const _=p[y],b=p[y+1];i.drawElements(h.primitiveType,b,c.indexType,_*m)}}else for(let m=0;m<f;m+=2){const y=p[m],_=p[m+1];i.drawArrays(h.primitiveType,y,_)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=this._sorting===UO.FrontToBack?1:-1;this._draws.sort((r,i)=>{const s=e*(r.depthSquaredHint-i.depthSquaredHint);return s!==0?s:r.geometry.vao.size-i.geometry.vao.size})}get count(){return this._draws.length}};const PD=new Map;PD.set(lt.UNSIGNED_BYTE,1),PD.set(lt.UNSIGNED_SHORT,2),PD.set(lt.UNSIGNED_INT,4);let c0t=class{constructor(e,r){this.rctx=e,this.shaderTechniqueRepository=r,this.canRender=!0,this._materialPassParameters=new Dft,this._shadowPassParameters=new Nft,this._highlightPassParameters=new Fft,this._systems=new Set,this._passes={materialOpaque:new h0(e,r),materialTransparent:new h0(e,r,UO.BackToFront),materialIntegratedMesh:new h0(e,r),shadowMap:new h0(e,r),highlight:new h0(e,r),highlightIntegratedMesh:new h0(e,r),highlightShadowMap:new h0(e,r),defaultShadowMap:new h0(e,r)}}register(e){this._systems.add(e)}prepareRender(e){if(this._systems.size!==0){for(const r of Object.values(this._passes))r.prepareSubmit();this._systems.forEach(r=>r.submit(this._passes,e.bindParameters));for(const r of Object.values(this._passes))r.finishSubmit();this.shaderTechniqueRepository.frameUpdate()}}render(e){if(this._systems.size!==0)switch(this._configure(e),this._materialPassParameters.output=e.output,e.bindParameters.slot){case Se.OPAQUE_MATERIAL:switch(e.output){case k.Color:case k.Depth:case k.Normal:return this._passes.materialOpaque.dispatch(this._materialPassParameters,e.bindParameters);case k.Highlight:return this._passes.highlight.dispatch(this._highlightPassParameters,e.bindParameters);case k.Shadow:return this._passes.shadowMap.dispatch(this._shadowPassParameters,e.bindParameters);case k.ShadowHighlight:return this._passes.highlightShadowMap.dispatch(this._shadowPassParameters,e.bindParameters);case k.ShadowExcludeHighlight:return this._passes.defaultShadowMap.dispatch(this._shadowPassParameters,e.bindParameters);case k.ObjectAndLayerIdColor:return this._passes.materialOpaque.dispatch(this._materialPassParameters,e.bindParameters)}return;case Se.TRANSPARENT_MATERIAL:switch(e.output){case k.Color:case k.Alpha:case k.Depth:case k.Normal:case k.ObjectAndLayerIdColor:return this._passes.materialTransparent.dispatch(this._materialPassParameters,e.bindParameters)}return;case Se.INTEGRATED_MESH:switch(e.output){case k.Color:case k.Depth:case k.Normal:return this._passes.materialIntegratedMesh.dispatch(this._materialPassParameters,e.bindParameters);case k.Highlight:return this._passes.highlightIntegratedMesh.dispatch(this._highlightPassParameters,e.bindParameters);case k.ObjectAndLayerIdColor:return this._passes.materialIntegratedMesh.dispatch(this._materialPassParameters,e.bindParameters)}return}}notifyDirty(){this._context.requestRender()}slots(){return[Se.OPAQUE_MATERIAL,Se.TRANSPARENT_MATERIAL,Se.INTEGRATED_MESH]}initializeRenderContext(e){this._context=e}uninitializeRenderContext(){}queryDepthRange(e){const r={near:1/0,far:-1/0};return this._systems.forEach(i=>{const s=i.queryShadowCasterDepthRange(e);v(s)&&fE(r,s,r)}),r}_configure(e){const r=e.output===k.Shadow||e.output===k.ShadowHighlight||e.output===k.ShadowExcludeHighlight?this._shadowPassParameters:e.output===k.Highlight?this._highlightPassParameters:this._materialPassParameters;this._updateParameters(e,r)}_updateParameters(e,r){const i=e.bindParameters.camera,s=i.viewInverseTransposeMatrix;ce(gk,s[3],s[7],s[11]),yk.set(gk),le(r.transformWorldFromViewTH,yk.high),le(r.transformWorldFromViewTL,yk.low),le(r.slicePlaneLocalOrigin,gk),Hh(r.transformViewFromCameraRelativeRS,i.viewMatrix),Fn(r.transformProjFromView,i.projectionMatrix),r.identifier===Cc.Material&&(this._materialPassParameters.transparent=e.bindParameters.slot===Se.TRANSPARENT_MATERIAL,this._materialPassParameters.integratedMesh=e.bindParameters.slot===Se.INTEGRATED_MESH,qh(Ole,r.transformViewFromCameraRelativeRS),ex(r.transformNormalViewFromGlobal,Ole))}get needsHighlight(){return this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0}get needsTransparentPass(){return this._passes.materialTransparent.count>0}};const gk=M(),Ole=es(),yk=new g6;let u0t=class{constructor(){this._step=Ile,this._dilation=1,this._firstIdleTime=0}frame(e,r){if(r?this._firstIdleTime===0&&(this._firstIdleTime=performance.now()):this._firstIdleTime=0,de("enable-feature:high-quality-idle")){const s=r?performance.now()-this._firstIdleTime:0;if(s>=Mle+d0t)return this._step=1/0,void(this._dilation=1);this._dilation=s>=Mle?p0t:1}else this._dilation=1;const i=ge(e/h0t,Ile,m0t);this._step===1/0?this._step=i:this._step=this._step*Ple+i*(1-Ple)}get value(){return this._step}get timeDilation(){return this._dilation}clear(){this._step=this._firstIdleTime=0}};const h0t=.5,Mle=6e4,d0t=5e3,p0t=10,Ple=.9,f0t=30,Ile=1e3/1,m0t=1e3/f0t,g0t=8.6,y0t=.4;function _0t(){const t=new Dr,{vertex:e,fragment:r}=t,i=e.code,s=r.code;return t.attributes.add(A.POSITION,"vec2"),t.varyings.add("uv","vec2"),t.attributes.add(A.UV0,"vec2"),e.uniforms.add(new Mt("coverageTex",n=>n.coverageTexture)),i.add(w`void main() {
vec4 cov = texture2D(coverageTex, uv0);
if (cov.r == 0.0) {
gl_Position = vec4(0.0);
return;
}
gl_Position = vec4(position, 0.0, 1.0);
uv = position.xy * 0.5 + vec2(0.5);
}`),r.uniforms.add(new Mt("tex",n=>n.blurColorTexture)),r.uniforms.add(new Mt("origin",n=>n.highlightColorTexture)),r.uniforms.add(new pr("uColor",n=>n.color)),r.uniforms.add(new pr("haloColor",n=>n.haloColor)),r.uniforms.add(new pr("opacities",n=>ti(v0t,n.haloOpacity,n.haloOpacityOccluded,n.fillOpacity,n.fillOpacityOccluded))),r.constants.add("outlineSize","float",g0t),r.constants.add("blurSize","float",y0t),s.add(w`void main() {
vec4 blurredHighlightValue = texture2D(tex, uv);
float highlightIntensity = blurredHighlightValue.a;
if (highlightIntensity == 0.0) {
discard;
}
vec4 origin_color = texture2D(origin, uv);
float outlineIntensity;
float fillIntensity;
if (blurredHighlightValue.g > blurredHighlightValue.b) {
outlineIntensity = haloColor.w * opacities[1];
fillIntensity = uColor.w * opacities[3];
}
else {
outlineIntensity = haloColor.w * opacities[0];
fillIntensity = uColor.w * opacities[2];
}
float inner = 1.0 - outlineSize / 9.0;
float outer = 1.0 - (outlineSize + blurSize) / 9.0;
float outlineFactor = smoothstep(outer, inner, highlightIntensity);
float fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;
float intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;
gl_FragColor = vec4(mix(haloColor.rgb, uColor.rgb, fillFactor), intensity);
}`),t}const v0t=sr(),b0t=Object.freeze(Object.defineProperty({__proto__:null,build:_0t},Symbol.toStringTag,{value:"Module"}));let gCe=class yCe extends Vr{initializeProgram(e){return new Fr(e.rctx,yCe.shader.get().build(),Rr)}initializePipeline(){return Bt({blending:kn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Kt})}};gCe.shader=new Nr(b0t,()=>te(()=>import("./HighlightApply.glsl-6711957d.js"),[]));let _Ce=class extends pi{constructor(){super(...arguments),this.blurSize=Je()}};function w0t(){const t=new Dr,{vertex:e,fragment:r}=t,i=e.code,s=r.code;return t.attributes.add(A.POSITION,"vec2"),t.attributes.add(A.UV0,"vec2"),t.varyings.add("blurCoordinate","vec3"),e.uniforms.add(new Mt("coverageTex",n=>n.coverageTexture)),r.uniforms.add(new hO("blurSize",n=>n.blurSize)),i.add(w`void main() {
gl_Position = vec4(position, 0.0, 1.0);
vec4 cov = texture2D(coverageTex, uv0);
if (cov.r == 0.0) {
gl_Position = vec4(0.0);
}
blurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), max(cov.g, cov.b));
}`),r.uniforms.add(new SM("tex",n=>n.blurInputTexture)),s.add(w`void main() {
vec2 uv = blurCoordinate.xy;
vec4 center = texture2D(tex, uv);
if (blurCoordinate.z == 1.0) {
gl_FragColor = center;
} else {
vec4 sum = vec4(0.0);
sum += center * 0.204164;
sum += texture2D(tex, uv + blurSize * 1.407333) * 0.304005;
sum += texture2D(tex, uv - blurSize * 1.407333) * 0.304005;
sum += texture2D(tex, uv + blurSize * 3.294215) * 0.093913;
sum += texture2D(tex, uv - blurSize * 3.294215) * 0.093913;
gl_FragColor = sum;
}
}`),t}const x0t=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:_Ce,build:w0t},Symbol.toStringTag,{value:"Module"}));let vCe=class bCe extends Vr{initializeProgram(e){return new Fr(e.rctx,bCe.shader.get().build(),Rr)}initializePipeline(){return Bt({colorWrite:Kt})}};vCe.shader=new Nr(x0t,()=>te(()=>import("./HighlightBlur.glsl-c04d20a8.js"),[]));let wCe=class extends pi{constructor(){super(...arguments),this.invFramebufferDim=Je()}};function T0t(){const t=new Dr,{vertex:e,fragment:r}=t,i=e.code,s=r.code;return t.attributes.add(A.POSITION,"vec2"),i.add(w`void main() {
gl_Position = vec4(vec2(1.0) - position * 2.0, 0.0, 1.0);
}`),r.uniforms.add(new SM("tex",n=>n.inputTexture)),r.uniforms.add(new hO("invFramebufferDim",n=>n.invFramebufferDim)),s.add(w`void main() {
vec2 coord = gl_FragCoord.xy * invFramebufferDim;
vec4 value = texture2D(tex, coord);
float mx = floor(max(value.g, value.b));
gl_FragColor = vec4(ceil(value.r), mx, mx, 1.0);
}`),t}const S0t=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:wCe,build:T0t},Symbol.toStringTag,{value:"Module"}));let xCe=class TCe extends Vr{initializeProgram(e){return new Fr(e.rctx,TCe.shader.get().build(),Rr)}initializePipeline(){return Bt({colorWrite:Kt})}};xCe.shader=new Nr(S0t,()=>te(()=>import("./HighlightDownsample.glsl-196711fe.js"),[]));let $le=class extends pi{constructor(){super(...arguments),this.color=wp(1,0,1,1),this.haloColor=wp(1,0,1,1),this.haloOpacity=1,this.haloOpacityOccluded=.25,this.fillOpacity=.2,this.fillOpacityOccluded=.05,this.shadowColor=Ht(1,0,1,1),this.shadowOpacity=.15,this.occludedShadowOpacity=.075}};const E0t=32;let C0t=class{constructor(e,r){this._techniqueRep=e,this._rctx=r,this._viewportToRestore=sr(),this._passParameters=new $le,this._downsampleDrawParameters=new wCe,this._blurDrawParameters=new _Ce,this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0}}_assertResources(){if(this._quadVAO)return;this._quadVAO=Aa(this._rctx);const e={colorTarget:ls.TEXTURE,depthStencilTarget:$r.NONE,width:0,height:0},r={target:bt.TEXTURE_2D,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.LINEAR,wrapMode:Rt.CLAMP_TO_EDGE,width:0,height:0};this._blur0Fbo=new Ds(this._rctx,e,r),this._blur1Fbo=new Ds(this._rctx,e,r),this._blurTechnique=this._techniqueRep.acquire(vCe),this._downsampleTechnique=this._techniqueRep.acquire(xCe),this._applyTechnique=this._techniqueRep.acquire(gCe)}dispose(){if(this._blurTechnique=Bi(this._blurTechnique),this._downsampleTechnique=Bi(this._downsampleTechnique),this._applyTechnique=Bi(this._applyTechnique),this._grid.coverageMipmap)for(let e=1;e<this._grid.coverageMipmap.length;e++)this._grid.coverageMipmap[e].dispose();this._grid.vao&&this._grid.vao.dispose(!0),this._quadVAO&&(this._quadVAO.dispose(!0),this._quadVAO=null),this._blur0Fbo=Qe(this._blur0Fbo),this._blur1Fbo=Qe(this._blur1Fbo)}setDefaultOptions(e){this._passParameters={...new $le,...e}}render(e,r,i){this._passParameters.highlightColorTexture=r.colorTexture,this._assertResources();const s=e.camera;Xd(this._viewportToRestore,s.fullViewport);const n=s.fullWidth,o=s.fullHeight,a=s.pixelRatio,l=Math.ceil(n/a),c=Math.ceil(o/a);this._blur0Fbo.resize(l,c),this._blur1Fbo.resize(l,c);const h=this._rctx;h.bindVAO(this._quadVAO);let p=null;this._gridUpdateResources(r,E0t),this._gridComputeMipmap(e),this._passParameters.coverageTexture=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,p=this._grid.vao;const f=h.bindTechnique(this._blurTechnique,this._passParameters,e);h.bindVAO(p),h.bindFramebuffer(this._blur0Fbo),h.setViewport(0,0,l,c),h.setClearColor(0,0,0,0),h.clear(Li.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=r.colorTexture,or(this._blurDrawParameters.blurSize,1/l,0),f.bindDraw(this._blurDrawParameters,e,this._passParameters),h.drawArrays(this._blurTechnique.primitiveType,0,Wo(p,"geometry")),h.bindFramebuffer(this._blur1Fbo),h.clear(Li.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=this._blur0Fbo.colorTexture,or(this._blurDrawParameters.blurSize,0,1/c),f.bindDraw(this._blurDrawParameters,e,this._passParameters),h.drawArrays(this._blurTechnique.primitiveType,0,Wo(p,"geometry")),h.bindFramebuffer(i),h.setViewport(this._viewportToRestore[0],this._viewportToRestore[1],this._viewportToRestore[2],this._viewportToRestore[3]),this._passParameters.blurColorTexture=this._blur1Fbo.colorTexture,h.bindTechnique(this._applyTechnique,this._passParameters,e),h.drawArrays(this._applyTechnique.primitiveType,0,Wo(p,"geometry")),h.bindVAO(null)}_gridUpdateResources(e,r){const i=this._rctx,s=this._grid;let n=!1;if(s.coverageMipmap===null&&(s.coverageMipmap=[e],n=!0),s.viewportWidth===e.width&&s.viewportHeight===e.height||(n=!0,s.viewportWidth=e.width,s.viewportHeight=e.height),s.coverageMipmap[0]=e,s.cellPixelSize!==r&&(s.cellPixelSize=r,n=!0),n){for(let l=1;l<s.coverageMipmap.length;l++)s.coverageMipmap[l].dispose();s.mipmapLevels=Math.ceil(Math.log(s.cellPixelSize)*Math.LOG2E),s.coverageMipmap.length=s.mipmapLevels+1;for(let l=0;l<s.mipmapLevels;l++){const c=s.coverageMipmap[l],h={target:bt.TEXTURE_2D,pixelFormat:Ve.RGB,dataType:Lt.UNSIGNED_SHORT_5_6_5,samplingMode:tt.LINEAR,wrapMode:Rt.CLAMP_TO_EDGE,width:Math.ceil(c.width/2),height:Math.ceil(c.height/2)},p={colorTarget:ls.TEXTURE,depthStencilTarget:$r.NONE,width:Math.ceil(c.width/2),height:Math.ceil(c.height/2)};s.coverageMipmap[l+1]=new Ds(i,p,h)}}const o=Math.ceil(e.height/s.cellPixelSize),a=Math.ceil(e.width/s.cellPixelSize);if(!s.vao||s.verticalCellCount!==o||s.horizontalCellCount!==a){s.verticalCellCount=o,s.horizontalCellCount=a;const l=o+1,c=a+1,h=1/o,p=1/a,f=6,m=4,y=new Float32Array(f*m*l*c);let _=0;for(let b=0;b<l;b++)for(let x=0;x<c;x++)y[_+0]=(x-.5)*p*2-1,y[_+1]=(b-.5)*h*2-1,y[_+2]=x*p,y[_+3]=b*h,y[_+4]=(x+.5)*p*2-1,y[_+5]=(b-.5)*h*2-1,y[_+6]=x*p,y[_+7]=b*h,y[_+8]=(x-.5)*p*2-1,y[_+9]=(b+.5)*h*2-1,y[_+10]=x*p,y[_+11]=b*h,y[_+12]=(x-.5)*p*2-1,y[_+13]=(b+.5)*h*2-1,y[_+14]=x*p,y[_+15]=b*h,y[_+16]=(x+.5)*p*2-1,y[_+17]=(b-.5)*h*2-1,y[_+18]=x*p,y[_+19]=b*h,y[_+20]=(x+.5)*p*2-1,y[_+21]=(b+.5)*h*2-1,y[_+22]=x*p,y[_+23]=b*h,_+=f*m;s.vao&&s.vao.dispose(!0),s.vao=new Sp(i,Rr,{geometry:kE},{geometry:jr.createVertex(i,Lr.STATIC_DRAW,y)})}}_gridComputeMipmap(e){const r=this._rctx,i=this._grid,s=r.bindTechnique(this._downsampleTechnique,this._passParameters,e);r.bindVAO(this._quadVAO);for(let n=0;n<i.mipmapLevels;n++){r.bindFramebuffer(i.coverageMipmap[n+1]);const o=i.coverageMipmap[n+1].width,a=i.coverageMipmap[n+1].height;this._downsampleDrawParameters.inputTexture=i.coverageMipmap[n].colorTexture,or(this._downsampleDrawParameters.invFramebufferDim,1/o,1/a),s.bindDraw(this._downsampleDrawParameters,e,this._passParameters),r.setViewport(0,0,o,a),r.drawArrays($t.TRIANGLE_STRIP,0,Wo(this._quadVAO,"geometry"))}}get gpuMemoryUsage(){let e=(v(this._blur0Fbo)?this._blur0Fbo.gpuMemoryUsage:0)+(v(this._blur1Fbo)?this._blur1Fbo.gpuMemoryUsage:0);if(this._grid.coverageMipmap)for(const r of this._grid.coverageMipmap)e+=r.gpuMemoryUsage;return e}get test(){return{coverage:this._grid.coverageMipmap,blur:[this._blur0Fbo,this._blur1Fbo]}}};const A0t={dataType:Lt.UNSIGNED_BYTE,internalFormat:Ve.RGBA},R0t={};let O0t=class{constructor(e){this._rctx=e,this._activeTargets=new Set,this._depthTextures=new Map,this._depthBuffers=new Map,this._colorTextures=new Map,this._framebuffers=new Map,this.depthTextureSupported=e.capabilities.depthTexture}dispose(){this._depthBuffers.forEach(e=>e.dispose()),this._depthBuffers.clear(),this._depthTextures.forEach(e=>e.dispose()),this._depthTextures.clear(),this._colorTextures.forEach(e=>e.dispose()),this._colorTextures.clear(),this._framebuffers.forEach(e=>e.dispose()),this._framebuffers.clear(),this._activeTargets.clear()}disposeTargetResource(e){const r=e.id;this._activeTargets.has(r)&&(this._activeTargets.delete(r),this._disposeWithFramebuffers(this._depthTextures,r),this._disposeWithFramebuffers(this._depthBuffers,r),this._disposeWithFramebuffers(this._colorTextures,r))}_disposeWithFramebuffers(e,r){const i=e.get(r);i&&(this._framebuffers.forEach((s,n)=>{s.colorAttachment!==i&&s.depthStencilAttachment!==i||(s.detachAll(),s.dispose(),this._framebuffers.delete(n))}),i.dispose(),e.delete(r))}getDepthTexture(e,r){if(!this.depthTextureSupported)return null;let i=this._depthTextures.get(e.id);return!i||i.descriptor.width===r.width&&i.descriptor.height===r.height||(i.dispose(),i=sw()),i||(i=new ct(this._rctx,{target:bt.TEXTURE_2D,pixelFormat:Ve.DEPTH_STENCIL,dataType:Lt.UNSIGNED_INT_24_8,samplingMode:tt.NEAREST,wrapMode:Rt.CLAMP_TO_EDGE,width:r.width,height:r.height}),this._depthTextures.set(e.id,i),this._activeTargets.add(e.id)),i}getAllocatedDepthTexture(e){return this._depthTextures.get(e.id)}getDepthBuffer(e,r){if(this.depthTextureSupported)return null;let i=this._depthBuffers.get(e.id);return i?i.descriptor.width===r.width&&i.descriptor.height===r.height||i.resize(r.width,r.height):(i=new t2(this._rctx,{internalFormat:Ha.DEPTH_STENCIL,...r}),this._depthBuffers.set(e.id,i),this._activeTargets.add(e.id)),i}getColorTexture(e,r){let i=this._colorTextures.get(e.id);return i&&(i.descriptor.width===r.width&&i.descriptor.height===r.height||(i.dispose(),i=sw())),i||(i=new ct(this._rctx,{target:bt.TEXTURE_2D,pixelFormat:Ve.RGBA,internalFormat:e.internalFormat,dataType:e.dataType,samplingMode:e.samplingMode!=null?e.samplingMode:tt.LINEAR,wrapMode:Rt.CLAMP_TO_EDGE,width:r.width,height:r.height}),this._colorTextures.set(e.id,i),this._activeTargets.add(e.id)),i}getAllocatedColorTexture(e){return this._colorTextures.get(e.id)}registerDepthTarget(e={}){return{id:Pc(),...R0t,...e}}registerColorTarget(e={}){return{id:Pc(),...A0t,...e}}getFramebuffer(e,r,i){const s=this._getKey(r,i);let n=this._framebuffers.get(s);const o=this.getColorTexture(r,e);if(this.depthTextureSupported){const l=i?this.getDepthTexture(i,e):void 0;return n?((n.width!==e.width||n.height!==e.height||n.colorTexture!==o||n.depthStencilTexture!==l)&&(n.detachAll(),n.resize(e.width,e.height),n.attachColorTexture(o),n.attachDepthStencilTexture(l)),n):(n=v(i)?new Ds(this._rctx,{colorTarget:ls.TEXTURE,depthStencilTarget:$r.DEPTH_STENCIL_TEXTURE},o,l):new Ds(this._rctx,{colorTarget:ls.TEXTURE,depthStencilTarget:$r.NONE},o),this._framebuffers.set(s,n),n)}const a=i?this.getDepthBuffer(i,e):void 0;return n?((n.width!==e.width||n.height!==e.height||n.colorTexture!==o)&&(n.detachAll(),n.resize(e.width,e.height),n.attachColorTexture(o),n.attachDepthStencilBuffer(a)),n):(n=new Ds(this._rctx,{colorTarget:ls.TEXTURE,depthStencilTarget:i?$r.DEPTH_STENCIL_RENDER_BUFFER:$r.NONE},o,a),this._framebuffers.set(s,n),n)}_getKey(e,r){return`${e.id}_${r?r.id:"X"}_${e.name}${r?"_"+r.name:""}`}get gpuMemoryUsage(){let e=0;const r=new Set,i=s=>{r.has(s)||(r.add(s),e+=Ow(s))};return this._depthTextures.forEach(i),this._colorTextures.forEach(i),this._depthBuffers.forEach(i),e}},M0t=class{constructor(e,r){this._rctx=e,this._compositingHelper=r,this._mainColorTarget=0,this._dimensions={width:4,height:4},this._background={type:"color",color:[0,0,0,1]};const i=e.type===vt.WEBGL2;this._renderTargetHelper=new O0t(e);const s=this._renderTargetHelper;this._mainColorTargets=[s.registerColorTarget({name:"mainColorTarget0"}),s.registerColorTarget({name:"mainColorTarget1"})],this.frontFaceTarget=s.registerColorTarget({name:"frontFaceTarget"});const n=o=>s.registerColorTarget({name:o,dataType:Lt.FLOAT,internalFormat:i?St.RGBA32F:Ve.RGBA,samplingMode:tt.NEAREST});this.colorFloatTarget=n("colorFloatTarget"),this.alphaFloatTarget=n("alphaFloatTarget"),this.mainDepth=s.registerDepthTarget({name:"mainDepth"}),this.linearDepth=s.registerColorTarget({name:"linearDepth",samplingMode:tt.NEAREST}),this.terrainLinearDepth=s.registerColorTarget({name:"terrainLinearDepth"}),this.geometryLinearDepth=s.registerColorTarget({name:"geometryLinearDepth"}),this.normal=s.registerColorTarget({name:"normal"}),this.highlight=s.registerColorTarget({name:"highlight",internalFormat:i?St.RGBA4:Ve.RGBA,dataType:Lt.UNSIGNED_SHORT_4_4_4_4}),this.hudVisibility=s.registerColorTarget({name:"hudVisibility",internalFormat:i?St.RGBA4:Ve.RGBA,dataType:Lt.UNSIGNED_SHORT_4_4_4_4}),this.tmpColor=s.registerColorTarget({name:"tmpColor"}),this.tmpDepth=s.registerDepthTarget({name:"tmpDepth"}),this.hudColor=s.registerColorTarget({name:"hudColor"})}dispose(){this._renderTargetHelper.dispose()}get width(){return this._dimensions.width}get height(){return this._dimensions.height}set background(e){this._background=e}get background(){return this._background}get currentColorTarget(){return this._mainColorTargets[this._mainColorTarget]}get previousColorTarget(){return this._mainColorTargets[1-this._mainColorTarget]}get framebuffer(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}getFramebuffer(e,r){return this._renderTargetHelper.getFramebuffer(this._dimensions,e,r)}get colorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}get depthTexture(){return this._renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}get linearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}get terrainLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth)}get geometryLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth)}get lastFrameColorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}get normalTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.normal)}get highlightTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.highlight)}get hudVisibilityTexture(){return this._getColorTexture(this.hudVisibility)}get tmpColorTexture(){return this._getColorTexture(this.tmpColor)}get hudColorTexture(){return this._getColorTexture(this.hudColor)}get mainColorTexture(){return this._getColorTexture(this.currentColorTarget)}setupRenderTarget(e){e||(this._mainColorTarget=0,this.disposeTarget(this._mainColorTargets[1])),this._mainColorTarget=this._mainColorTarget===0&&e?1:0}initializeFrame(e){const r=this._rctx;this._dimensions.width=e.fullWidth,this._dimensions.height=e.fullHeight,this.bindTarget(this.currentColorTarget,this.mainDepth),r.setClearStencil(0);const i=this._background.color;r.setClearColor(i[0]*i[3],i[1]*i[3],i[2]*i[3],i[3]),r.clearSafe(Li.COLOR_BUFFER_BIT|Li.DEPTH_BUFFER_BIT|Li.STENCIL_BUFFER_BIT)}composite(e){v(this.colorTexture)&&this._compositingHelper.composite(e,this.colorTexture,da.None)}renderTmpAndCompositeToMain(e,r,i,s=!1){this.renderToTargets(e,this.tmpColor,s?this.tmpDepth:this.mainDepth,P0t),this._compositingHelper.composite(r,this._getColorTexture(this.tmpColor),i)}renderHUDVisibility(e,r=!1){this.renderToTargets(e,this.hudVisibility,r?this.tmpDepth:this.mainDepth,I0t)}compositeTransparentTerrainOntoHUDVisibility(e){this.renderToTargets(()=>this._compositingHelper.compositeHUD(e,this._getColorTexture(this.tmpColor)),this.hudVisibility,this.tmpDepth)}renderOITPass(e,r,i){let s,n;switch(r){case xt.Color:s=this.colorFloatTarget,n=[0,0,0,0];break;case xt.Alpha:s=this.alphaFloatTarget,n=[1,1,1,1];break;case xt.FrontFace:s=this.frontFaceTarget,n=[0,0,0,0]}i?this.renderToTargets(e,s,this.tmpDepth,n,!0,!0):this.renderToTargets(e,s,this.mainDepth,n,!1)}compositeTransparentTerrainOntoMain(e){this.bindFramebuffer(),this._compositingHelper.composite(e,this._getColorTexture(this.tmpColor),da.PremultipliedAlpha)}compositeOccludedOntoMain(e,r){this.bindFramebuffer(),this._compositingHelper.composite(e,this._getColorTexture(this.tmpColor),da.PremultipliedAlpha,r)}compositeTransparentOntoOpaque(e,r){r?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clearSafe(Li.COLOR_BUFFER_BIT)):this.bindFramebuffer(),this._compositingHelper.compositeOIT(e,this._getColorTexture(this.colorFloatTarget),this._getColorTexture(this.alphaFloatTarget),this._getColorTexture(this.frontFaceTarget))}bindFramebuffer(){this._rctx.bindFramebuffer(this.framebuffer)}renderDepthDetached(e){this.bindTarget(this.currentColorTarget),e(),this.bindTarget(this.currentColorTarget,this.mainDepth)}disposeTarget(e){this._renderTargetHelper.disposeTargetResource(e)}renderToFBO(e,r,i=!1,s=!1){const n=this._rctx;let o=0;if(r){const l=Math.max(1e-13,r[3]);n.setClearColor(r[0],r[1],r[2],l),o|=Li.COLOR_BUFFER_BIT}i&&(o|=Li.DEPTH_BUFFER_BIT),s===!1?s=0:(s===!0&&(s=255),o|=Li.STENCIL_BUFFER_BIT),o&&n.clearSafe(o,s),e(),n.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth)}renderToTargets(e,r,i,s,n=!1,o=!1){const a=this.bindTarget(r,i);return this.renderToFBO(e,s,n,o),a}bindTarget(e,r){const i=this._renderTargetHelper.getFramebuffer(this._dimensions,e,r);return this._rctx.bindFramebuffer(i),i}_getColorTexture(e){return this._renderTargetHelper.getColorTexture(e,this._dimensions)}get gpuMemoryUsage(){let e=0;return this._renderTargetHelper&&(e+=this._renderTargetHelper.gpuMemoryUsage),e}};const P0t=[0,0,0,0],I0t=[0,1,0,1];let $0t=class{constructor(e){this._context=e,this._renderPlugins=new Jt,this._slots=[];for(let r=0;r<Se.MAX_SLOTS;++r)this._slots[r]=[]}add(e,r,i){const s=()=>{if(i!=null&&i.aborted)throw r.uninitializeRenderContext(),Hr();this._renderPlugins.push(r);for(const o of e)this._slots[o].push(r);this._context.requestRender()},n=r.initializeRenderContext(this._context,i);if(Uu(n))return n.then(s);s()}remove(e){if(this._renderPlugins.removeUnordered(e)!=null){for(let r=0;r<this._slots.length;++r)this._slots[r]=this._slots[r].filter(i=>i!==e);e.uninitializeRenderContext(),this._context.requestRender()}}prepareRender(){this._renderPlugins.forAll(e=>{e.prepareRender&&e.prepareRender(this._context.renderContext)})}updateAnimation(e){let r=!1;return this._renderPlugins.forAll(i=>{i.updateAnimation&&(r=i.updateAnimation(e)||r)}),r}render(){const e=this._slots[this._context.renderContext.bindParameters.slot],r=new Array;e.filter(i=>{if(!i.canRender)return!1;if(L0t(i)){const s=i.prepareTechnique(this._context.renderContext);return!!s&&(r.push(s),!0)}return r.push(null),!0}).forEach((i,s)=>i.render(this._context.renderContext,r[s]))}queryDepthRange(e){const r=D0t;return r.near=1/0,r.far=-1/0,this._renderPlugins.forAll(i=>{if(i.queryDepthRange){const s=i.queryDepthRange(e);s&&fE(r,s,r)}}),r}get needsTransparentPass(){return this._renderPlugins.some(e=>!!e.needsTransparentPass)}get needsHighlight(){return this._renderPlugins.some(e=>!!e.needsHighlight)}get needsLinearDepth(){return this._renderPlugins.some(e=>!!e.needsLinearDepth)}get needsLaserlineWithContrastControl(){const e=this._slots[Se.LASERLINES_CONTRAST_CONTROL];return!!e&&e.length>0}get renderOccludedFlags(){return this._renderPlugins.reduce((e,r)=>e|r.renderOccludedFlags,0)}};function L0t(t){return"prepareTechnique"in t}const D0t={near:0,far:0};let SCe=class extends ZTe{};const y6=255,N0t=1/y6;function F0t(t){const e=new Dr,r=e.fragment;return r.include(kc),r.include(Nu),e.include(Q5),e.include(Jh),e.include(K5,t),r.uniforms.add([new Mt("depthMap",i=>i.linearDepthTexture),new Hi("inverseViewMatrix",(i,s)=>Oo(Lle,ql(Lle,s.camera.viewMatrix,s.camera.center))),new kr("nearFar",(i,s)=>s.camera.nearFar)]),r.constants.add("sampleValue","float",N0t),r.code.add(w`void main(void) {
float depth = rgba2float(texture2D(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth > nearFar.y || -currentPixelDepth < nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= numCascades) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
vec2 uvShadow = cascadeCoordinates(i, lvpos);
float depthShadow = readShadowMapDepth(uvShadow, shadowMapTex);
bool shadow = depthShadow < lvpos.z;
if (!shadow) {
discard;
}
gl_FragColor = vec4(sampleValue);
}`),e}const Lle=Ie(),U0t=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastAccumulatePassParameters:SCe,ShadowCastMaxSamples:y6,build:F0t},Symbol.toStringTag,{value:"Module"}));var zw;(function(t){t[t.Gradient=0]="Gradient",t[t.Threshold=1]="Threshold",t[t.COUNT=2]="COUNT"})(zw||(zw={}));let IH=class extends Ca{constructor(){super(...arguments),this.visualization=zw.Gradient,this.bandsEnabled=!1}};u([V({count:zw.COUNT})],IH.prototype,"visualization",void 0),u([V()],IH.prototype,"bandsEnabled",void 0);let ECe=class extends pi{constructor(e){super(),this.shadowCastMap=e,this.sampleScale=0,this.opacityFromElevation=1,this.color=aM(k0t),this.bandSize=.1,this.threshold=.5}};const k0t=Ht(.01,0,.25,1);function V0t(t){const e=new Dr,r=e.fragment;r.include(kc),r.include(Nu),e.include(Q5),e.include(Jh);const{visualization:i,bandsEnabled:s}=t;r.constants.add("inverseSampleValue","float",y6),r.uniforms.add([new Mt("shadowCastMap",a=>a.shadowCastMap),new Pe("sampleScale",a=>a.sampleScale),new Pe("opacityFromElevation",a=>a.opacityFromElevation),new pr("uColor",a=>a.color)]);const n=i===zw.Gradient,o=i===zw.Threshold;return n&&s?r.uniforms.add(new Pe("bandSize",a=>a.bandSize)):o&&r.uniforms.add(new Pe("threshold",a=>a.threshold)),r.code.add(w`
      void main(void) {
        vec4 record = texture2D(shadowCastMap, uv);
        float pixelSamples = record.r * inverseSampleValue;
        if (pixelSamples < 1.0) {
          discard;
        }

        float strength = pixelSamples * sampleScale;

        ${o?w`
            if (strength <= threshold) {
              discard;
            }`:""}

        ${n&&s?w`strength = ceil(strength / bandSize) * bandSize;`:""}

        gl_FragColor = vec4(uColor.xyz, uColor.a * opacityFromElevation ${n?w`* strength`:""});
      }
    `),e}const B0t=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:ECe,build:V0t},Symbol.toStringTag,{value:"Module"}));let CCe=class ACe extends Vr{constructor(e,r){super(e,r,()=>this.destroy())}initializeProgram(e){return new Fr(e.rctx,ACe.shader.get().build(this.configuration),Rr)}initializePipeline(){return Bt({blending:Iu,colorWrite:Kt,depthTest:null,depthWrite:null})}get primitiveType(){return $t.TRIANGLE_STRIP}};CCe.shader=new Nr(B0t,()=>te(()=>import("./ShadowCastVisualize.glsl-9ca23b15.js"),[]));const z0t=4e4,G0t=5e4,RCe=1/512;let ID=class extends Te{constructor(e,r,i,s){super({}),this._techniqueRepository=e,this._rctx=r,this._data=i,this._requestRender=s,this._passParameters=new ECe(this._data.shadowCastTexture),this._techniqueConfig=new IH,this._enabled=!1,this._vao=Aa(r),this._techniqueConfig.visualization=zw.Gradient}normalizeCtorArgs(){return{}}dispose(){this._stop(),this._vao=Qe(this._vao),this._techniqueRepository.release(this._technique),this._technique=null}get _visualizeShadowCastTechnique(){return this._technique=this._techniqueRepository.releaseAndAcquire(CCe,this._techniqueConfig,this._technique),this._technique}render(e){if(!this._showVisualization)return;this._passParameters.sampleScale=1/this._data.computedSamples;const r=this._visualizeShadowCastTechnique;this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(r,this._passParameters,e),this._rctx.drawArrays(r.primitiveType,0,Wo(this._vao,"geometry"))}setOptions(e){e.enabled!==void 0&&this._setEnabled(e.enabled),e.color!==void 0&&this._setColor(e.color),e.threshold!==void 0&&(this._threshold=e.threshold),e.visualization!==void 0&&(this._visualization=e.visualization),e.bandSize!==void 0&&(this._bandSize=e.bandSize),e.bandsEnabled!==void 0&&(this._bandsEnabled=e.bandsEnabled)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _showVisualization(){return this._enabled&&this._data.computedSamples>0&&this.opacityFromElevation>RCe}get _threshold(){return this._passParameters.threshold}set _threshold(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfRunning())}get _visualization(){return this._techniqueConfig.visualization}set _visualization(e){e!==this._visualization&&(this._techniqueConfig.visualization=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfRunning())}get _bandsEnabled(){return this._techniqueConfig.bandsEnabled}set _bandsEnabled(e){e!==this._bandsEnabled&&(this._techniqueConfig.bandsEnabled=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}_setColor(e){const r=this._passParameters.color;j2(e,r)||(Xd(this._passParameters.color,e),this._requestRenderIfRunning())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfRunning(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};u([d()],ID.prototype,"opacityFromElevation",null),ID=u([I("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],ID);let QF=class extends Ca{constructor(){super(...arguments),this.receiveShadows=!0,this.hasWebGL2Context=!1}};u([V()],QF.prototype,"receiveShadows",void 0),u([V()],QF.prototype,"hasWebGL2Context",void 0);let OCe=class MCe extends Vr{constructor(e){super(e,new QF,()=>this.destroy())}initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===vt.WEBGL2}initializeProgram(e){return new Fr(e.rctx,MCe.shader.get().build(this.configuration),Rr)}initializePipeline(){return Bt({blending:kn(Ee.ONE,Ee.ONE,Ee.ONE,Ee.ONE),colorWrite:Kt,depthTest:null,depthWrite:null})}get primitiveType(){return $t.TRIANGLE_STRIP}};OCe.shader=new Nr(U0t,()=>te(()=>import("./ShadowCastAccumulate.glsl-0cc0809b.js"),[]));let Ol=class extends Te{constructor(e,r,i,s,n,o){super({}),this._rctx=e,this._stage=i,this._prepareForShadowMapPass=s,this._renderToShadowMap=n,this._requestRender=o,this._progress=0,this._sampleCount=0,this._passParameters=new SCe,this._enabledInternal=!1,this._cachedLightDirections=[],this._depthRange=SH,this._previewing=!1,this._handles=new ei,this._cameraForcedForScreenshot=!1,this._bindParameters=new v5(new UZ(e,i.viewingMode),null,null),this._bindParameters.shadowMap.enabled=!0,this._vao=Aa(e);const a={colorTarget:ls.TEXTURE,depthStencilTarget:$r.NONE,width:0,height:0},l={target:bt.TEXTURE_2D,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.LINEAR,wrapMode:Rt.CLAMP_TO_EDGE,width:0,height:0};this._fbo=new Ds(e,a,l),this._accumulationRenderer=new ID(r,e,this,o);const c=this._stage.view.resourceController.scheduler;this._handles.add([c.registerTask(_t.SHADOW_ACCUMULATOR,this),ie(()=>i.renderView,h=>{this._handles.remove(Dle),v(h)&&this._handles.add(h.events.on("force-camera-for-screenshot",()=>this._cameraForcedForScreenshot=!0),Dle)},js),ie(()=>this._previewing,()=>this._requestRenderIfEnabled(),ri)])}normalizeCtorArgs(){return{}}get computedSamples(){return this._progress}get shadowCastTexture(){return this._fbo.colorTexture}get isAccumulating(){return this._isPreviewing||this._isRefining}get _accumulationTechnique(){if(C(this._accumulationTechniqueCached)){const e={rctx:this._rctx,viewingMode:this._stage.viewingMode};this._accumulationTechniqueCached=new OCe(e)}return this._accumulationTechniqueCached}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}get _isPreviewing(){return this._isActive&&this._previewing}get _isActive(){return this._enabledInternal&&this._sampleCount>0}get canAccumulate(){return this._passParameters.linearDepthTexture!==null&&this._depthRange!==SH&&this._opacityFromElevation>RCe}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(e){const r=this._cachedLightDirections;if(Xg(r,e,q_))return;const i=Math.min(y6,e.length);r.length=i,this._sampleCount=i;for(let s=0;s<i;++s)r[s]=le(r[s]??M(),e[s]);this._invalidate()}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get running(){return this._isRefining&&this.canAccumulate&&this._progress>0}runTask(e){for(this._prepareForShadowMapPass(this._bindParameters);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()}renderAccumulation(e,r,i,s){if(this._depthRange=r,this._updateCamera(i),this._bindParameters.contentCamera=s,this._passParameters.linearDepthTexture=e,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!this.isAccumulating||!this.canAccumulate)return;(this._previewing||this._progress===0||this._cameraForcedForScreenshot)&&this._clear();const n=this._cameraForcedForScreenshot?this._sampleCount:Math.min(j0t,this._sampleCount-this._progress);for(let o=0;o<n;++o)this._accumulateShadow();this._cameraForcedForScreenshot=!1,this._requestRender()}render(e){this._accumulationRenderer.render(e)}dispose(){this._stop(),this._handles.destroy(),this._accumulationRenderer=Qe(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=Qe(this._fbo),this._vao=Qe(this._vao),this._accumulationTechniqueCached=Bi(this._accumulationTechniqueCached),this._cachedLightDirections.length=0,this._sampleCount=0}setOptions(e){e.enabled!==void 0&&(this._enabled=e.enabled),e.previewing!==void 0&&(this._previewing=e.previewing),e.lightDirections!==void 0&&(this._lightDirections=e.lightDirections),this._accumulationRenderer.setOptions(e)}readAccumulatedShadow(e,r){return!this._isActive||this._progress<1||e<0||e>this._fbo.width||r<0||r>this._fbo.height?0:(this._fbo.readPixels(e,r,1,1,Ve.RGBA,Lt.UNSIGNED_BYTE,Nle),Nle[0]/this._progress)}_start(){this._progress=0,this._enabledInternal=!0}_stop(){this._enabledInternal=!1}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(Li.COLOR_BUFFER_BIT),this._progress=0}_accumulateShadow(){this._renderToShadowMap(this._bindParameters,this._sampleLightDirection(),this._depthRange);const e=this._accumulationTechnique;this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(e,this._passParameters,this._bindParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(e.primitiveType,0,Wo(this._vao,"geometry"))}_sampleLightDirection(){return this._progress++,this._lightDirections[this._progress*H0t%this._lightDirections.length]}_updateCamera(e){e.equals(this._bindParameters.camera)||(this._bindParameters.camera.copyFrom(e),this._fbo.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-CS(z0t,G0t,e.relativeElevation))}set _enabled(e){e!==this._enabledInternal&&(e?this._start():this._stop())}_requestRenderIfEnabled(){this._enabledInternal&&this._requestRender()}get test(){const e=this;return{lightDirections:this._lightDirections,get isDone(){return e._isDoneAccumulating},get isActive(){return e._isActive}}}};u([d()],Ol.prototype,"_progress",void 0),u([d()],Ol.prototype,"_sampleCount",void 0),u([d()],Ol.prototype,"_enabledInternal",void 0),u([d()],Ol.prototype,"_depthRange",void 0),u([d()],Ol.prototype,"_previewing",void 0),u([d()],Ol.prototype,"_accumulationRenderer",void 0),u([d()],Ol.prototype,"_isRefining",null),u([d()],Ol.prototype,"_isActive",null),u([d()],Ol.prototype,"canAccumulate",null),u([d()],Ol.prototype,"_isDoneAccumulating",null),u([d()],Ol.prototype,"_opacityFromElevation",null),u([d()],Ol.prototype,"running",null),Ol=u([I("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],Ol);const j0t=6,Dle="renderView",H0t=104729,Nle=new Uint8Array(4),Fle={highlightedThreshold:.99999,selfShadowThreshold:.025};function q0t(t){const e=new Dr;e.include(Fw,t);const r=e.fragment;return r.include(kc),r.include(Nu),e.include(Q5),e.include(Jh),r.uniforms.add([new Mt("defaultDepthTex",(i,s)=>s.shadowMap.getSnapshot(cE.Default)),new Mt("highlightDepthTex",(i,s)=>s.shadowMap.getSnapshot(cE.Highlight)),new Mt("depthMap",(i,s)=>s.linearDepthTexture),new Mt("highlightMap",(i,s)=>s.highlightColorTexture),new pr("uColor",i=>i.shadowColor),new kr("nearFar",(i,s)=>s.camera.nearFar),new Pe("opacity",i=>i.shadowOpacity),new Pe("occludedOpacity",i=>i.occludedShadowOpacity),new Pe("terminationFactor",i=>i.opacityElevation*i.dayNightTerminator),new qt("lightingMainDirectionView",(i,s)=>_e(kle,We(kle,s.lighting.mainLight.direction,s.camera.viewInverseTransposeMatrix))),new kr("texelSize",(i,s)=>v(s.linearDepthTexture)?or(W0t,1/s.linearDepthTexture.descriptor.width,1/s.linearDepthTexture.descriptor.height):Wl),new Hi("inverseViewMatrix",(i,s)=>Oo(Ule,ql(Ule,s.camera.viewMatrix,s.camera.center)))]),r.constants.add("unoccludedHighlightFlag","vec4",xxe).add("highlightedThreshold","float",Fle.highlightedThreshold).add("selfShadowThreshold","float",Fle.selfShadowThreshold),r.code.add(w`vec3 normalFromDepth(vec3 pixelPos, vec2 fragCoord, vec2 uv, vec2 texelSize, sampler2D depthMap, vec2 nearFar) {
float leftPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(-1.0, 0.0) * texelSize, nearFar);
float rightPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(1.0, 0.0) * texelSize, nearFar);
float bottomPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, -1.0) * texelSize, nearFar);
float topPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, 1.0) * texelSize, nearFar);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`),r.code.add(w`void main(void) {
vec4 highlightInfo = texture2D(highlightMap, uv);
float visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;
if (visiblyHighlighted > highlightedThreshold) {
discard;
}
float depth = rgba2float(texture2D(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= numCascades) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
vec2 uvShadow = cascadeCoordinates(i, lvpos);
float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);
bool shadowHighlight = depthHighlight < lvpos.z;
if (!shadowHighlight) {
discard;
}
float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);
bool shadowDefault = depthDefault < lvpos.z;
vec3 normal = normalFromDepth(currentPixelPos.xyz, gl_FragCoord.xy, uv, texelSize, depthMap, nearFar);
bool shaded = dot(normal, lightingMainDirectionView) < selfShadowThreshold;
float fragOpacity = (shadowDefault || shaded) ? occludedOpacity : opacity;
gl_FragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);
}`),e}const Ule=Ie(),kle=M(),W0t=Je(),X0t=Object.freeze(Object.defineProperty({__proto__:null,build:q0t},Symbol.toStringTag,{value:"Module"}));let Y0t=class extends pi{constructor(){super(...arguments),this.shadowColor=Ht(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}},PCe=class ICe extends Vr{constructor(e){super(e,new QF,()=>this.destroy())}initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===vt.WEBGL2}initializeProgram(e){return new Fr(e.rctx,ICe.shader.get().build(this.configuration),Rr)}initializePipeline(){return Bt({blending:kn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Kt,depthTest:null,depthWrite:null})}get primitiveType(){return $t.TRIANGLE_STRIP}};PCe.shader=new Nr(X0t,()=>te(()=>import("./ShadowHighlight.glsl-49016c6c.js"),[]));const Z0t=.001953125,J0t=4e4,K0t=5e4;let Q0t=class{constructor(e,r){this._rctx=e,this._viewingMode=r,this._maxOpacity=1,this._passParameters=new Y0t,this._drawParameters=new ZTe,this._vao=Aa(this._rctx)}get _technique(){return C(this._techniqueCached)&&(this._techniqueCached=new PCe({rctx:this._rctx,viewingMode:this._viewingMode})),this._techniqueCached}render(e,r){if(!e.shadowMap.enabled||!e.linearDepthTexture||!this.isVisible)return;const i=this._technique;this._drawParameters.origin=e.camera.center,this._rctx.bindFramebuffer(r),this._rctx.bindTechnique(i,this._passParameters,e).bindDraw(this._drawParameters,e,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(i.primitiveType,0,Wo(this._vao,"geometry"))}get gpuMemoryUsage(){var e;return((e=this._vao)==null?void 0:e.size)??0}setDefaultOptions(e){this._passParameters={...this._passParameters,...e},this._updateMaxOpacity()}updateParameters(e,r){this._passParameters.opacityElevation=1-CS(J0t,K0t,e.relativeElevation);const i=this._viewingMode===Be.Global?_e(Vle,e.center):ce(Vle,0,0,1),s=ye(i,r);this._passParameters.dayNightTerminator=CS(0,1,ge(30*s,0,1))}dispose(){this._vao=Qe(this._vao),this._techniqueCached=Bi(this._techniqueCached)}get isVisible(){const{opacityElevation:e,dayNightTerminator:r}=this._passParameters;return this._maxOpacity*e*r>=Z0t}_updateMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3]}};const Vle=M(),Ble=uy();let e_t=class{constructor(){this._plane=uy()}get isEnabled(){return!wme(this.plane,Ble)}get plane(){return this._plane}set plane(e){Jw(e||Ble,this._plane)}},t_t=class extends pi{};function kO(t){t.uniforms.add(new pr("resolution",e=>{const{descriptor:r}=e.colorTexture,i=r.width,s=r.height;return ti(r_t,1/i,1/s,i,s)}))}const r_t=sr(),dT={maxSearchSteps:8,maxDistanceAreaTex:16};function i_t(){const t=new Dr,{attributes:e,varyings:r,vertex:i,fragment:s}=t;return e.add(A.POSITION,"vec2"),r.add("uv","vec2"),r.add("offsets[2]","vec4"),r.add("maxOffset","vec4"),r.add("pixelCoord","vec2"),kO(i),i.code.add(w`
      void main() {
        uv = position * 0.5 + vec2(0.5);
        gl_Position = vec4(position, 0, 1);

        pixelCoord = uv * resolution.zw;
        offsets[0] = uv.xyxy + resolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );
        offsets[1] = uv.xyxy + resolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );
        maxOffset = vec4( offsets[0].xz, offsets[1].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * resolution.xxyy * float( ${w.int(dT.maxSearchSteps)} );
      }
    `),s.uniforms.add(new Mt("edgesTexture",n=>n.edges.colorTexture)),s.uniforms.add(new Mt("areaTexture",n=>n.areaTexture)),s.uniforms.add(new Mt("searchTexture",n=>n.searchTexture)),kO(s),s.code.add(w`
      #define SMAA_AREATEX_PIXEL_SIZE ( 1.0 / vec2( 160.0, 560.0 ) )
      #define SMAA_AREATEX_SUBTEX_SIZE ( 1.0 / 7.0 )

      vec4 sampleLevelZeroOffset(sampler2D texture, vec2 coord, vec2 offset) {
        return texture2D(texture, coord + offset.x * resolution.xy, 0.0);
      }

      vec2 round( vec2 x ) {
        return sign(x) * floor(abs(x) + 0.5);
      }

      float searchLength(sampler2D searchTex, vec2 e, float bias, float scale) {
        e.r = bias + e.r * scale;
        return 255.0 * texture2D( searchTex, e, 0.0 ).r;
      }

      float searchXLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${w.int(dT.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 2.0, 0.0 ) * resolution.xy;
          if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x += 0.25 * resolution.x;
        texcoord.x += resolution.x;
        texcoord.x += 2.0 * resolution.x;
        texcoord.x -= resolution.x * searchLength(searchTex, e, 0.0, 0.5);
        return texcoord.x;
      }

      float searchXRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${w.int(dT.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 2.0, 0.0 ) * resolution.xy;
          if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x -= 0.25 * resolution.x;
        texcoord.x -= resolution.x;
        texcoord.x -= 2.0 * resolution.x;
        texcoord.x += resolution.x * searchLength( searchTex, e, 0.5, 0.5 );
        return texcoord.x;
      }

      float searchYUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${w.int(dT.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 0.0, 2.0 ) * resolution.xy;
          if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y -= 0.25 * resolution.y;
        texcoord.y -= resolution.y;
        texcoord.y -= 2.0 * resolution.y;
        texcoord.y += resolution.y * searchLength( searchTex, e.gr, 0.0, 0.5 );
        return texcoord.y;
      }

      float searchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${w.int(dT.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 0.0, 2.0 ) * resolution.xy;
          if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y += 0.25 * resolution.y;
        texcoord.y += resolution.y;
        texcoord.y += 2.0 * resolution.y;
        texcoord.y -= resolution.y * searchLength( searchTex, e.gr, 0.5, 0.5 );
        return texcoord.y;
      }

      vec2 getArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {
        vec2 texcoord = float( ${w.int(dT.maxDistanceAreaTex)} ) * round( 4.0 * vec2( e1, e2 ) ) + dist;
        texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );
        texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;
        return texture2D( areaTex, texcoord, 0.0 ).rg;
      }

      void main() {
        ivec4 subsampleIndices = ivec4(0.0);
        vec4 weights = vec4(0.0);
        vec2 e = texture2D( edgesTexture, uv ).rg;
        if ( e.g > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.x = searchXLeft( edgesTexture, searchTexture, offsets[0].xy, maxOffset.x );
          coords.y = offsets[1].y;
          d.x = coords.x;
          float e1 = texture2D( edgesTexture, coords, 0.0 ).r;
          coords.x = searchXRight( edgesTexture, searchTexture, offsets[0].zw, maxOffset.y );
          d.y = coords.x;
          d = d * resolution.z - pixelCoord.x;
          vec2 sqrt_d = sqrt( abs(d) );
          coords.y -= 1.0 * resolution.y;
          float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2( 1.0, 0.0 ) ).r;
          weights.rg = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.y ) );
        }

        if ( e.r > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.y = searchYUp( edgesTexture, searchTexture, offsets[1].xy, maxOffset.z );
          coords.x = offsets[0].x;
          d.x = coords.y;
          float e1 = texture2D( edgesTexture, coords, 0.0 ).g;
          coords.y = searchYDown( edgesTexture, searchTexture, offsets[1].zw, maxOffset.w );
          d.y = coords.y;
          d = d * resolution.w - pixelCoord.y;
          vec2 sqrt_d = sqrt(abs(d));
          coords.y -= 1.0 * resolution.y;
          float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2(0.0, 1.0)).g;
          weights.ba = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.x ) );

          // for some reason the following lines are necessary to prevent
          // texture lookup precision issues on some Intel integrated graphics chips
          vec4 dbg = (offsets[0] + offsets[1] + maxOffset + coords.xyyx);
          weights.r += 0.00000001 * dot(vec4(0, 1, 0, 1), dbg);
        }
        gl_FragColor = weights;
      }
    `),t}const s_t=Object.freeze(Object.defineProperty({__proto__:null,build:i_t},Symbol.toStringTag,{value:"Module"}));let $Ce=class LCe extends Vr{initializeProgram(e){return new Fr(e.rctx,LCe.shader.get().build(),Rr)}initializePipeline(){return Bt({colorWrite:Kt})}};$Ce.shader=new Nr(s_t,()=>te(()=>import("./BlendWeights.glsl-49de69bd.js"),[]));function n_t(){const t=new Dr,{attributes:e,varyings:r,vertex:i,fragment:s}=t;return e.add(A.POSITION,"vec2"),r.add("uv","vec2"),r.add("offsets[2]","vec4"),kO(i),i.code.add(w`void main() {
uv = position * 0.5 + vec2(0.5);
gl_Position = vec4(position, 0, 1);
offsets[0] = uv.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0, 1.0 );
offsets[1] = uv.xyxy + resolution.xyxy * vec4( 1.0, 0.0, 0.0, -1.0 );
}`),s.uniforms.add(new Mt("blendWeightsTexture",n=>n.blend.colorTexture)),s.uniforms.add(new Mt("colorTexture",n=>n.colorTexture)),kO(s),s.code.add(w`void main() {
vec4 a;
a.rb = texture2D(blendWeightsTexture, uv).rb;
a.g = texture2D(blendWeightsTexture, offsets[1].zw).g;
a.a = texture2D(blendWeightsTexture, offsets[1].xy).a;
if ( dot(a, vec4(1.0)) < 1e-5 ) {
gl_FragColor = texture2D( colorTexture, uv, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture2D( colorTexture, uv, 0.0 );
vec4 Cop = texture2D( colorTexture, uv + sign( offset ) * resolution.xy, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
gl_FragColor = mix(C, Cop, s);
}
}`),t}const o_t=Object.freeze(Object.defineProperty({__proto__:null,build:n_t},Symbol.toStringTag,{value:"Module"}));let DCe=class NCe extends Vr{initializeProgram(e){return new Fr(e.rctx,NCe.shader.get().build(),Rr)}initializePipeline(){return Bt({colorWrite:Kt})}};DCe.shader=new Nr(o_t,()=>te(()=>import("./Blur.glsl-225fd854.js"),[]));const zle={threshold:.05,localConstrastAdaption:2};function a_t(){const t=new Dr,{attributes:e,varyings:r,vertex:i,fragment:s}=t;return e.add(A.POSITION,"vec2"),kO(i),r.add("uv","vec2"),r.add("offsets[3]","vec4"),i.code.add(w`void main() {
uv = position * 0.5 + vec2(0.5);
gl_Position = vec4(position, 0, 1);
offsets[0] = uv.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0,  1.0 );
offsets[1] = uv.xyxy + resolution.xyxy * vec4(  1.0, 0.0, 0.0, -1.0 );
offsets[2] = uv.xyxy + resolution.xyxy * vec4( -2.0, 0.0, 0.0,  2.0 );
}`),s.uniforms.add(new Mt("colorTexture",n=>n.colorTexture)),s.code.add(w`
    float absMax3(vec3 v) {
      vec3 t = abs(v);
      return max(max(t.r, t.g), t.b);
    }

    void main() {
      // Calculate color deltas:
      vec4 delta;
      vec3 C = texture2D(colorTexture, uv).rgb;

      vec3 Cleft = texture2D(colorTexture, offsets[0].xy).rgb;
      delta.x = absMax3(C - Cleft);

      vec3 Ctop = texture2D(colorTexture, offsets[0].zw).rgb;
      delta.y = absMax3(C - Ctop);

      vec2 edges = step(vec2(${w.float(zle.threshold)}), delta.xy);

      // discard if there is no edge:
      if (dot(edges, vec2(1.0)) == 0.0) {
        discard;
      }

      // Calculate right and bottom deltas:
      vec3 Cright = texture2D(colorTexture, offsets[1].xy).rgb;
      delta.z = absMax3(C - Cright);

      vec3 Cbottom  = texture2D(colorTexture, offsets[1].zw).rgb;
      delta.w = absMax3(C - Cbottom);

      // Calculate the maximum delta in the direct neighborhood:
      float maxDelta = max(max(max(delta.x, delta.y), delta.z), delta.w);

      // Calculate left-left and top-top deltas:
      vec3 Cleftleft  = texture2D(colorTexture, offsets[2].xy).rgb;
      delta.z = absMax3(C - Cleftleft);

      vec3 Ctoptop = texture2D(colorTexture, offsets[2].zw).rgb;
      delta.w = absMax3(C - Ctoptop);

      // Calculate the final maximum delta:
      maxDelta = max(max(maxDelta, delta.z), delta.w);

      // Local contrast adaptation in action:
      edges.xy *= step(maxDelta, float(${w.float(zle.localConstrastAdaption)}) * delta.xy);

      gl_FragColor = vec4(edges, 0.0, 0.0);
    }
  `),t}const l_t=Object.freeze(Object.defineProperty({__proto__:null,build:a_t},Symbol.toStringTag,{value:"Module"}));let FCe=class UCe extends Vr{initializeProgram(e){return new Fr(e.rctx,UCe.shader.get().build(),Rr)}initializePipeline(){return Bt({colorWrite:Kt})}};FCe.shader=new Nr(l_t,()=>te(()=>import("./EdgeDetect.glsl-c1a9e52e.js"),[]));let P3=class extends Te{constructor(e,r){super({}),this._rctx=e,this._techniqueRep=r,this._passParameters=new t_t,this._isEnabled=!1}normalizeCtorArgs(){return{}}dispose(){this._abortController=Fh(this._abortController),this.disable()}_loadResources(e){if(v(this._abortController))return!1;if(v(this._passParameters.searchTexture))return!0;this._abortController=new AbortController;const r=this._abortController.signal;return te(()=>import("./SmaaRenderPassData-660b7d34.js"),[]).then(i=>this._loadTextures(i,r)).then(()=>e()).finally(()=>this._abortController=null),!1}_loadTextures(e,r){return fr(r),Promise.all([this._loadTextureFromBase64(e.areaTexture,tt.LINEAR,Ve.RGB),this._loadTextureFromBase64(e.searchTexure,tt.NEAREST,Ve.LUMINANCE)]).then(([i,s])=>{Ln(r)?(i.dispose(),s.dispose(),fr(r)):(this._passParameters.areaTexture=i,this._passParameters.searchTexture=s)})}get updating(){return v(this._abortController)}enable(e){if(this._isEnabled)return!0;if(!this._edgeDetectTechnique||!this._blendWeightsTechnique||!this._blurTechnique){const r=new Ca;this._edgeDetectTechnique=this._techniqueRep.releaseAndAcquire(FCe,r,this._edgeDetectTechnique),this._blendWeightsTechnique=this._techniqueRep.releaseAndAcquire($Ce,r,this._blendWeightsTechnique),this._blurTechnique=this._techniqueRep.releaseAndAcquire(DCe,r,this._blurTechnique)}return!!this._loadResources(e)&&(this._vao=yWe(this._rctx),this._passParameters.edges=new Ds(this._rctx,{colorTarget:ls.TEXTURE,depthStencilTarget:$r.NONE},{target:bt.TEXTURE_2D,pixelFormat:Ve.RGB,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.LINEAR,wrapMode:Rt.CLAMP_TO_EDGE,width:4,height:4}),this._passParameters.blend=new Ds(this._rctx,{colorTarget:ls.TEXTURE,depthStencilTarget:$r.NONE},{target:bt.TEXTURE_2D,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.LINEAR,wrapMode:Rt.CLAMP_TO_EDGE,width:4,height:4}),this._isEnabled=!0,!0)}disable(){this._isEnabled&&(this._vao=Qe(this._vao),this._passParameters.areaTexture=Qe(this._passParameters.areaTexture),this._passParameters.searchTexture=Qe(this._passParameters.searchTexture),this._passParameters.blend=Qe(this._passParameters.blend),this._passParameters.edges=Qe(this._passParameters.edges),this._isEnabled=!1)}get _validPassParameters(){return this._isEnabled?this._passParameters:null}render(e){const r=this._validPassParameters;if(C(r))return;r.colorTexture=e;const i=this._rctx,s=i.getBoundFramebufferObject(),n=e.descriptor.width,o=e.descriptor.height;i.bindVAO(this._vao),i.setViewport(0,0,n,o),r.edges.resize(n,o),i.bindFramebuffer(r.edges),i.setClearColor(0,0,0,1),i.clear(Li.COLOR_BUFFER_BIT),i.bindTechnique(this._edgeDetectTechnique,r,null),i.drawArrays($t.TRIANGLES,0,3),r.blend.resize(n,o),i.bindFramebuffer(r.blend),i.setClearColor(0,0,1,1),i.clear(Li.COLOR_BUFFER_BIT),i.bindTechnique(this._blendWeightsTechnique,r,null),i.drawArrays($t.TRIANGLES,0,3),i.bindFramebuffer(s),i.setClearColor(0,1,0,1),i.clear(Li.COLOR_BUFFER_BIT),i.bindTechnique(this._blurTechnique,r,null),i.drawArrays($t.TRIANGLES,0,3)}_loadTextureFromBase64(e,r,i){return sy(e).then(s=>new ct(this._rctx,{pixelFormat:i,dataType:Lt.UNSIGNED_BYTE,wrapMode:Rt.CLAMP_TO_EDGE,width:s.width,height:s.height,samplingMode:r},s))}};u([d()],P3.prototype,"_abortController",void 0),u([d({readOnly:!0})],P3.prototype,"updating",null),P3=u([I("esri.views.3d.webgl-engine.lib.SmaaRenderPass")],P3);function c_t(t,e){const r=-t[0],i=-t[1],s=-t[2],n=e[3],o=e[7],a=e[11],l=e[15];e[0]+=n*r,e[1]+=n*i,e[2]+=n*s,e[4]+=o*r,e[5]+=o*i,e[6]+=o*s,e[8]+=a*r,e[9]+=a*i,e[10]+=a*s,e[12]+=l*r,e[13]+=l*i,e[14]+=l*s}function u_t(t,e){const r=t[0],i=t[1],s=t[2];e[12]+=r*e[0]+i*e[4]+s*e[8],e[13]+=r*e[1]+i*e[5]+s*e[9],e[14]+=r*e[2]+i*e[6]+s*e[10],e[14]+=r*e[3]+i*e[7]+s*e[11]}let h_t=class{constructor(e){this._factory=e,this._originData=new Map}acquire(e){return this.register(this._factory.getOrigin(e))}register(e){const r=this._originData.get(e.id)||new d_t(e);return r.refCount++,this._originData.has(r.origin.id)||this._originData.set(r.origin.id,r),r}release(e){e.refCount--,e.refCount===0&&this._originData.delete(e.origin.id)}updateViewMatrices(e){this._originData.forEach(r=>{Fn(r.viewMatrix,e),u_t(r.origin.vec3,r.viewMatrix)})}},d_t=class{constructor(e){this.origin=e,this.refCount=0,this.viewMatrix=Ie()}},p_t=class extends N1e{constructor(e,r){super(),this.distanceFalloffFactor=e,this.transparency=r,this.transformNormalViewFromGlobal=es()}},f_t=class extends F1e{constructor(){super(...arguments),this.transformNormalViewFromGlobal=es(),this.slicePlaneLocalOrigin=M(),this.transformNormalGlobalFromModel=es()}};function m_t(t){const e=w`bool isNaN( float val )
{
return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;
}`;t.code.add(e)}const g_t=Ur(.5,-4e-4);function y_t(t,e){const r=t.vertex;r.include(m_t),r.constants.add("depthBias","vec2",g_t),r.uniforms.add(new kr("inverseViewport",(i,s)=>s.inverseViewport)),e.legacy?(r.uniforms.add(new Hi("proj",(i,s)=>s.camera.projectionMatrix)),r.code.add(w`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = depthBias.x;
vec4 projNormal = proj * localView * vec4(globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;
}`)):(r.uniforms.add(new wm("transformNormalViewFromGlobal",i=>i.transformNormalViewFromGlobal)),r.uniforms.add(new Hi("transformProjFromView",i=>i.transformProjFromView)),r.code.add(w`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = depthBias.x;
vec4 projNormal = transformProjFromView * vec4(transformNormalViewFromGlobal * globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;
}`)),r.code.add(w`float _calculateProjectedBiasZ(vec4 projPos) {
float offsetZ = depthBias.y;
return sqrt(max(projPos.z,0.0)) * offsetZ;
}
vec4 adjustProjectedPosition(vec4 projPos, vec3 worldNormal, float lineWidth) {
vec2 offsetXY = calculateProjectedBiasXY(projPos, worldNormal);
if (!isNaN(offsetXY.x) && !isNaN(offsetXY.y)) {
projPos.xy += offsetXY;
}
projPos.z += _calculateProjectedBiasZ(projPos);
return projPos;
}`)}function __t(t,e){const r=t.fragment;r.constants.add("coverageTestThreshold","float",.01),e.antialiasing?r.code.add(w`#define discardByCoverage(radius, coverage) { if (coverage < coverageTestThreshold) discard; }`):r.code.add(w`#define discardByCoverage(radius, coverage) { float coverageLimit = radius <= 0.5 ? coverageTestThreshold : 0.75; if (coverage < coverageLimit) discard; }`)}function v_t(t,e){const r=t.vertex;e.silhouette?(r.code.add(w`bool isSilhouetteEdge(vec3 viewDir, vec3 normalA, vec3 normalB) {
float faceAVisible = dot(viewDir, normalA);
float faceBVisible = dot(viewDir, normalB);
return faceAVisible * faceBVisible < 0.0;
}`),e.legacy?r.code.add(w`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 viewNormalA = _modelToViewNormal(normalA);
vec3 viewNormalB = _modelToViewNormal(normalB);
vec3 viewDir = -viewPos;
if (isSilhouetteEdge(viewDir, viewNormalA, viewNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`):r.code.add(w`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 worldNormalA = _modelToWorldNormal(normalA);
vec3 worldNormalB = _modelToWorldNormal(normalB);
vec3 viewDir = -worldPos;
if (isSilhouetteEdge(viewDir, worldNormalA, worldNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`)):r.code.add(w`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
return false;
}`)}function b_t(t,e){const r=t.vertex;r.include(kc),r.uniforms.add(new Pe("distanceFalloffFactor",i=>i.distanceFalloffFactor)),r.code.add(w`float distanceBasedPerspectiveFactor(float distance) {
return clamp(sqrt(distanceFalloffFactor / distance), 0.0, 1.0);
}`),r.uniforms.add(k_("componentDataTex",i=>i.componentDataTexture,e.hasWebGL2Context?Qr.None:Qr.InvSize)),t.attributes.add(A.COMPONENTINDEX,"float"),r.constants.add("componentColorFieldOffset","float",0),r.constants.add("componentOtherFieldOffset","float",1),r.constants.add("componentVerticalOffsetFieldOffset","float",2),r.constants.add("componentFieldCount","float",3),r.constants.add("lineWidthFractionFactor","float",8),r.constants.add("extensionLengthOffset","float",128),r.constants.add("verticalOffsetScale","float",2*bJ),r.code.add(w`
    vec2 _componentTextureCoords(float componentIndex, float fieldOffset) {
      float fieldIndex = componentFieldCount * componentIndex + fieldOffset;

      vec2 textureSizeInverse = ${$h(e,"componentDataTex",!0)};

      float colIndex = mod(fieldIndex, 1.0 / textureSizeInverse.x);
      float rowIndex = floor(fieldIndex * textureSizeInverse.x);

      return vec2(colIndex, rowIndex) + 0.5;
    }

    struct ComponentData {
      vec4 color;
      float lineWidth;
      float extensionLength;
      float type;
      float verticalOffset;
    };

    ComponentData readComponentData() {
      vec2 colorIndex = _componentTextureCoords(componentIndex, componentColorFieldOffset);
      vec2 otherIndex = _componentTextureCoords(componentIndex, componentOtherFieldOffset);
      vec2 verticalOffsetIndex = _componentTextureCoords(componentIndex, componentVerticalOffsetFieldOffset);

      vec4 colorValue = ${Ja(e,"componentDataTex","colorIndex")};
      vec4 otherValue = ${Ja(e,"componentDataTex","otherIndex")};
      float verticalOffset = (rgba2float(${Ja(e,"componentDataTex","verticalOffsetIndex")}) - 0.5) * verticalOffsetScale;

      return ComponentData(
        vec4(colorValue.rgb, colorValue.a * otherValue.w), // otherValue.w stores separate opacity
        otherValue.x * (255.0 / lineWidthFractionFactor),
        otherValue.y * 255.0 - extensionLengthOffset,
        -(otherValue.z * 255.0) + 0.5, // SOLID (=0/255) needs to be > 0.0, SKETCHY (=1/255) needs to be <= 0;
        verticalOffset
      );
    }
  `),e.legacy?r.code.add(w`vec3 _modelToWorldNormal(vec3 normal) {
return (model * vec4(normal, 0.0)).xyz;
}
vec3 _modelToViewNormal(vec3 normal) {
return (localView * model * vec4(normal, 0.0)).xyz;
}`):(r.uniforms.add(new dO("transformNormalGlobalFromModel",i=>i.transformNormalGlobalFromModel)),r.code.add(w`vec3 _modelToWorldNormal(vec3 normal) {
return transformNormalGlobalFromModel * normal;
}`)),e.silhouette?(t.attributes.add(A.NORMALA,"vec3"),t.attributes.add(A.NORMALB,"vec3"),r.code.add(w`vec3 worldNormal() {
return _modelToWorldNormal(normalize(normalA + normalB));
}`)):(t.attributes.add(A.NORMAL,"vec3"),r.code.add(w`vec3 worldNormal() {
return _modelToWorldNormal(normal);
}`)),e.legacy?r.code.add(w`void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {
worldPos = (model * vec4(modelPos, 1.0)).xyz;
viewPos = (localView * vec4(worldPos, 1.0)).xyz;
}`):(r.include(iF,e),r.include(iF,e),r.uniforms.add([new wm("transformViewFromCameraRelativeRS",i=>i.transformViewFromCameraRelativeRS),new dO("transformWorldFromModelRS",i=>i.transformWorldFromModelRS),new Pu("transformWorldFromModelTL",i=>i.transformWorldFromModelTL),new Pu("transformWorldFromModelTH",i=>i.transformWorldFromModelTH),new qt("transformWorldFromViewTL",i=>i.transformWorldFromViewTL),new qt("transformWorldFromViewTH",i=>i.transformWorldFromViewTH)]),r.code.add(w`
      void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {
        vec3 rotatedModelPosition = transformWorldFromModelRS * modelPos;

        vec3 transformCameraRelativeFromModel = dpAdd(
          transformWorldFromModelTL,
          transformWorldFromModelTH,
          -transformWorldFromViewTL,
          -transformWorldFromViewTH
        );

        worldPos = transformCameraRelativeFromModel + rotatedModelPosition;

        if (verticalOffset != 0.0) {
          vec3 vUp = ${e.spherical?w`normalize(transformWorldFromModelTL + rotatedModelPosition);`:w`vec3(0.0, 0.0, 1.0);`}
          worldPos += verticalOffset * vUp;
        }

        viewPos = transformViewFromCameraRelativeRS * worldPos;
      }
    `)),r.uniforms.add(new Hi("transformProjFromView",(i,s)=>s.camera.projectionMatrix)),r.code.add(w`vec4 projFromViewPosition(vec3 position) {
return transformProjFromView * vec4(position, 1.0);
}`),r.code.add(w`float calculateExtensionLength(float extensionLength, float lineLength) {
return extensionLength / (log2(max(1.0, 256.0 / lineLength)) * 0.2 + 1.0);
}`)}function w_t(t){return t.mode===bn.SKETCH||t.mode===bn.MIXED}var bn,Mb;(function(t){t[t.SOLID=0]="SOLID",t[t.SKETCH=1]="SKETCH",t[t.MIXED=2]="MIXED",t[t.COUNT=3]="COUNT"})(bn||(bn={})),function(t){t[t.REGULAR=0]="REGULAR",t[t.SILHOUETTE=1]="SILHOUETTE"}(Mb||(Mb={}));function SJ(t,e){const r=t.vertex;switch(t.attributes.add(A.SIDENESS,"vec2"),e.mode===bn.MIXED?r.code.add(w`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
float type;
};`):r.code.add(w`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
};`),e.mode){case bn.MIXED:r.code.add(w`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float fType = component.type;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
if (fType <= 0.0) {
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
}
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels, fType);
}`);break;case bn.SKETCH:r.code.add(w`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case bn.SOLID:r.code.add(w`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case bn.COUNT:break;default:e.mode}}function x_t(t,e){const r=t.vertex;switch(t.include(SJ,e),e.mode){case bn.SOLID:r.code.add(w`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return 0.0;
}`);break;case bn.SKETCH:r.uniforms.add(new ew("strokesAmplitude",i=>i.strokesTexture.amplitude)),r.code.add(w`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return strokesAmplitude;
}`);break;case bn.MIXED:r.uniforms.add(new ew("strokesAmplitude",i=>i.strokesTexture.amplitude)),r.code.add(w`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
float type = unpackedAttributes.type;
if (type <= 0.0) {
return strokesAmplitude;
}
else {
return 0.0;
}
}`)}}function T_t(t,e){t.include(SJ,e);const{vertex:r,fragment:i}=t;switch(w_t(e)&&(r.uniforms.add(k_("strokesTexture",s=>s.strokesTexture.texture,e.hasWebGL2Context?Qr.None:Qr.InvSize)),r.uniforms.add([new ew("strokesLog2Resolution",s=>Math.log2(s.strokesTexture.resolution)),new ew("strokeVariants",s=>s.strokesTexture.variants)]),t.varyings.add("vStrokeUV","vec2"),i.uniforms.add([new SM("strokesTexture",s=>s.strokesTexture.texture),new ew("strokesNormalizationScale",s=>s.strokesTexture.normalizationScale)]),r.code.add(w`
      void calculateStyleOutputsSketch(float lineLength, UnpackedAttributes unpackedAttributes) {
        vec2 sidenessNorm = unpackedAttributes.sidenessNorm;

        float lineIndex = clamp(ceil(log2(lineLength)), 0.0, strokesLog2Resolution);

        vec2 textureSizeInverse = ${$h(e,"strokesTexture",!0)};
        vStrokeUV = vec2(exp2(lineIndex) * sidenessNorm.y, lineIndex * strokeVariants + variantStroke + 0.5) * textureSizeInverse;
        vStrokeUV.x += variantOffset;
      }
    `),t.fragment.include(kc),i.code.add(w`float calculateLineOffsetSketch() {
float offsetNorm = rgba2float(texture2D(strokesTexture, vStrokeUV));
return (offsetNorm - 0.5) * strokesNormalizationScale;
}
float calculateLinePressureSketch() {
return rgba2float(texture2D(strokesTexture, vStrokeUV + vec2(0.0, 0.5)));
}`)),e.mode){case bn.SOLID:r.code.add(w`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes) {}`),i.code.add(w`float calculateLineOffset() {
return 0.0;
}
float calculateLinePressure() {
return 1.0;
}`);break;case bn.SKETCH:r.code.add(w`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}`),i.code.add(w`float calculateLineOffset() {
return calculateLineOffsetSketch();
}
float calculateLinePressure() {
return calculateLinePressureSketch();
}`);break;case bn.MIXED:t.varyings.add("vType","float"),r.code.add(w`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
vType = unpackedAttributes.type;
if (unpackedAttributes.type <= 0.0) {
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}
}`),i.code.add(w`float calculateLineOffset() {
if (vType <= 0.0) {
return calculateLineOffsetSketch();
}
else {
return 0.0;
}
}
float calculateLinePressure() {
if (vType <= 0.0) {
return calculateLinePressureSketch();
}
else {
return 1.0;
}
}`)}}function S_t(t){const e=new Dr,{vertex:r,fragment:i}=e;return t.legacy&&r.uniforms.add([new Gle("model"),new Gle("localView")]),e.include(y_t,t),e.include(b_t,t),e.include(x_t,t),e.include(SJ,t),e.include(T_t,t),e.include(Xs,t),e.include(v_t,t),e.include(__t,t),e.include(Fu,t),e.varyings.add("vColor","vec4"),e.varyings.add("vRadius","float"),e.varyings.add("vPosition","vec3"),e.varyings.add("vWorldPosition","vec3"),e.varyings.add("vViewPos","vec3"),e.varyings.add("vLineLengthPixels","float"),e.varyings.add("vSizeFalloffFactor","float"),r.uniforms.add([new kr("pixelToNDC",(s,n)=>or(E_t,2/n.camera.fullViewport[2],2/n.camera.fullViewport[3])),new pr("viewport",(s,n)=>n.camera.fullViewport),new Pe("pixelRatio",(s,n)=>n.camera.pixelRatio)]),e.attributes.add(A.POSITION0,"vec3"),e.attributes.add(A.POSITION1,"vec3"),e.attributes.add(A.VARIANTOFFSET,"float"),e.attributes.add(A.VARIANTSTROKE,"float"),e.attributes.add(A.VARIANTEXTENSION,"float"),r.code.add(w`
    const float opaqueCutoff = 1.0 / 255.0;

    void calculateGeometricOutputs(vec3 viewPosV0, vec3 viewPosV1, vec3 worldPosV0, vec3 worldPosV1, vec3 worldNormal, UnpackedAttributes unpackedAttributes) {
      vec2 sideness = unpackedAttributes.sideness;
      vec2 sidenessNorm = unpackedAttributes.sidenessNorm;

      vWorldPosition = mix(worldPosV0, worldPosV1, sidenessNorm.y).xyz;

      vec3 viewPos = mix(viewPosV0, viewPosV1, sidenessNorm.y);
      vViewPos = viewPos;

      vec4 projPosV0 = projFromViewPosition(viewPosV0);
      vec4 projPosV1 = projFromViewPosition(viewPosV1);
      vec4 projPos = projFromViewPosition(viewPos);

      vec3 screenSpaceLineNDC = (projPosV1.xyz / projPosV1.w - projPosV0.xyz / projPosV0.w);
      vec2 ndcToPixel = viewport.zw * 0.5;
      vec2 screenSpaceLinePixels = screenSpaceLineNDC.xy * ndcToPixel;
      float lineLengthPixels = length(screenSpaceLinePixels);

      float dzPerPixel = screenSpaceLineNDC.z / lineLengthPixels;
      vec2 screenSpaceDirection = screenSpaceLinePixels / lineLengthPixels;
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x) * sideness.x;

      float falloffFactor = distanceBasedPerspectiveFactor(-viewPos.z) * pixelRatio;
      float lineWidthPixels = unpackedAttributes.lineWidthPixels * falloffFactor;

      float extensionLengthPixels = calculateExtensionLength(unpackedAttributes.extensionLengthPixels, lineLengthPixels) * falloffFactor;
      float lineAmplitudePixels = calculateLineAmplitude(unpackedAttributes) * pixelRatio;

      vSizeFalloffFactor = falloffFactor;

      float lineWidthAndAmplitudePixels = lineWidthPixels + lineAmplitudePixels + lineAmplitudePixels;
      float extendedLineLengthPixels = lineLengthPixels + extensionLengthPixels + extensionLengthPixels;

      ${t.antialiasing?w`
        const float aaPaddingPixels = 1.0;

        // Line size with padding
        float halfAAPaddedLineWidthAndAmplitudePixels = lineWidthAndAmplitudePixels * 0.5 + aaPaddingPixels;
        float aaPaddedRoundedCapSizePixels = lineWidthPixels * 0.5 + aaPaddingPixels;`:w`
        float halfAAPaddedLineWidthAndAmplitudePixels = max(lineWidthAndAmplitudePixels, 1.0) * 0.5;
        float aaPaddedRoundedCapSizePixels = max(lineWidthPixels, 1.0) * 0.5;`}

      // Half line width in NDC including padding for anti aliasing
      vec2 halfAAPaddedLineWidthAndAmplitudeNDC = halfAAPaddedLineWidthAndAmplitudePixels * pixelToNDC;
      vec2 aaPaddedRoundedCapSizeNDC = aaPaddedRoundedCapSizePixels * pixelToNDC;
      vec2 extensionLengthNDC = extensionLengthPixels * pixelToNDC;

      // Compute screen space position of vertex, offsetting for line size and end caps
      vec2 ndcOffset = (
          screenSpaceDirection * sideness.y * (aaPaddedRoundedCapSizeNDC + extensionLengthNDC)
        + perpendicularScreenSpaceDirection * halfAAPaddedLineWidthAndAmplitudeNDC
      );

      projPos.xy += ndcOffset * projPos.w;
      projPos.z += (dzPerPixel * (aaPaddedRoundedCapSizePixels + extensionLengthPixels)) * sideness.y * projPos.w;

      projPos = adjustProjectedPosition(projPos, worldNormal, 1.0 + max((lineWidthAndAmplitudePixels - 1.0) * 0.5, 0.0));

      // Line length with end caps
      float aaPaddedLineWithCapsLengthPixels = extendedLineLengthPixels + aaPaddedRoundedCapSizePixels + aaPaddedRoundedCapSizePixels;

      float pixelPositionAlongLine = aaPaddedLineWithCapsLengthPixels * sidenessNorm.y - aaPaddedRoundedCapSizePixels;

      // Position in pixels with origin at first vertex of line segment
      vPosition = vec3(
        halfAAPaddedLineWidthAndAmplitudePixels * sideness.x,
        pixelPositionAlongLine,
        pixelPositionAlongLine / extendedLineLengthPixels
      );

      // The line width radius in pixels
      vRadius = lineWidthPixels * 0.5;
      vLineLengthPixels = extendedLineLengthPixels;

      // discard short edges below a certain length threshold
      ${t.mode===bn.SKETCH?w`
        if (lineLengthPixels <= 3.0) {
          gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
          return;
        }`:t.mode===bn.MIXED?w`
        if (lineLengthPixels <= 3.0 && unpackedAttributes.type <= 0.0) {
           gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
           return;
        }`:""}
      gl_Position = projPos;
    }

    void main() {
      ComponentData component = readComponentData();
      UnpackedAttributes unpackedAttributes = unpackAttributes(component);

      vec3 worldPosV0, worldPosV1, viewPosV0, viewPosV1;
      worldAndViewFromModelPosition(position0, component.verticalOffset, worldPosV0, viewPosV0);
      worldAndViewFromModelPosition(position1, component.verticalOffset, worldPosV1, viewPosV1);

      // Component color
      vColor = component.color;

      // Discard fully transparent edges
      if (vColor.a < opaqueCutoff) {
        gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
        return;
      }

      if (discardNonSilhouetteEdges(viewPosV0, worldPosV0)) {
        return;
      }

      // General geometric computation for all types of edges
      calculateGeometricOutputs(viewPosV0, viewPosV1, worldPosV0, worldPosV1, worldNormal(), unpackedAttributes);

      // Specific computation for different edge styles
      calculateStyleOutputs(unpackedAttributes);
    }
  `),i.code.add(w`
    vec2 lineWithCapsDistance(float radius, vec2 position, float lineLength) {
      float positionX = position.x - calculateLineOffset();

      if (radius < 1.0) {
        float coverageX = clamp(min(radius, positionX + 0.5) - max(-radius, positionX - 0.5), 0.0, 1.0);
        float coverageY = clamp(min(lineLength, position.y + 0.5) - max(0.0, position.y - 0.5), 0.0, 1.0);
        return vec2(0.5 - min(coverageX, coverageY), 0.0);
      }
      else {
        // Between -radius -> 0 for start cap, 0 for line, 0 -> radius
        float positionOnCap = position.y - clamp(position.y, 0.0, lineLength);

        vec2 lineToPosition = vec2(positionX, positionOnCap);
        return vec2(length(lineToPosition) - radius, positionOnCap / radius);
      }
    }

    void main() {
      ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, vViewPos.z);":""}
      float radius = vRadius * calculateLinePressure();

      vec2 distance = lineWithCapsDistance(radius, vPosition.xy, vLineLengthPixels);
      float coverage = clamp(0.5 - distance.x, 0.0, 1.0);

      discardByCoverage(radius, coverage);
      discardBySlice(vWorldPosition);

      gl_FragColor = vec4(vColor.rgb, vColor.a * coverage);
    }
  `),e}const E_t=Je();let Gle=class extends ws{constructor(e){super(e,"mat4")}};const C_t=Object.freeze(Object.defineProperty({__proto__:null,build:S_t},Symbol.toStringTag,{value:"Module"}));let kCe=class VCe extends Vr{initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===vt.WEBGL2}initializeProgram(e){return new Fr(e.rctx,VCe.shader.get().build(this.configuration),QEe)}initializePipeline(e){return e.blendMinMax?Bt({blending:kn(Ee.ONE,Ee.ONE,Ee.ZERO,Ee.ONE,cm.ADD,e.blendMinMax.MAX),depthTest:{func:Mi.LEQUAL},colorWrite:Kt}):Bt({depthTest:{func:Mi.LEQUAL},depthWrite:Xl,colorWrite:Kt})}};kCe.shader=new Nr(C_t,()=>te(()=>import("./EdgeShader.glsl-84ab47c5.js"),[]));let yf=class extends eo{constructor(){super(...arguments),this.mode=bn.SOLID,this.hasSlicePlane=!1,this.silhouette=!1,this.legacy=!1,this.antialiasing=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.spherical=!1}};u([V({count:bn.COUNT})],yf.prototype,"mode",void 0),u([V()],yf.prototype,"hasSlicePlane",void 0),u([V()],yf.prototype,"silhouette",void 0),u([V()],yf.prototype,"legacy",void 0),u([V()],yf.prototype,"antialiasing",void 0),u([V()],yf.prototype,"doublePrecisionRequiresObfuscation",void 0),u([V()],yf.prototype,"hasMultipassTerrain",void 0),u([V()],yf.prototype,"cullAboveGround",void 0),u([V()],yf.prototype,"spherical",void 0);const A_t=8,_k=128,R_t={type:"uber",hasSlicePlane:!1,strokesTexture:null,legacy:!0,spherical:!0},O_t={solid:bn.SOLID,sketch:bn.SKETCH,uber:bn.MIXED};let vk=class BCe{constructor(e,r,i){this._rctx=e,this._shaderTechniqueRepository=r,this._configuration=new yf,this.refCount=0,this._renderables=new Set,this._sortedRenderables={[rr.TRANSPARENT]:{[rr.TRANSPARENT]:new Jt,[rr.OPAQUE]:new Jt},[rr.OPAQUE]:{[rr.TRANSPARENT]:new Jt,[rr.OPAQUE]:new Jt}},this._renderablesDirty=!1,this._drawParameters=new f_t,this._settings={...R_t,...i},this.key=BCe.getKey(this._settings.type,this._settings.hasSlicePlane,this._settings.legacy);const s=this._settings.strokesTexture.variants;this.writerSettings={variants:s,reducedPrecision:qr.TESTS_DISABLE_OPTIMIZATIONS},this._configuration.legacy=this._settings.legacy,this._configuration.mode=O_t[this._settings.type],this._configuration.silhouette=!1,this._configuration.antialiasing=!!this._rctx.capabilities.blendMinMax,this._configuration.hasSlicePlane=this._settings.hasSlicePlane,this._configuration.doublePrecisionRequiresObfuscation=e.driverTest.doublePrecisionRequiresObfuscation.result,this._configuration.spherical=i.spherical}dispose(){this._technique=Bi(this._technique)}addRenderable(e){this._renderables.add(e),this._renderablesDirty=!0}removeRenderable(e){this._renderables.delete(e),this._renderablesDirty=!0}setRenderablesDirty(){this._renderablesDirty=!0}forEachRenderable(e,r){this._renderablesDirty&&this._sortRenderables(),this._sortedRenderables[r][rr.TRANSPARENT].forAll(e),this._sortedRenderables[r][rr.OPAQUE].forAll(e)}updateTechnique(e,r){return this._configuration.hasMultipassTerrain=!!e.multipassTerrain.enabled,this._configuration.cullAboveGround=!!e.multipassTerrain.cullAboveGround,this._configuration.silhouette=r,this._technique=this._shaderTechniqueRepository.releaseAndAcquire(kCe,this._configuration,this._technique),this._technique}bindRegularEdges(e,r){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(r,!1),e,r)}bindSilhouetteEdges(e,r){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(r,!0),e,r)}renderRegularEdges(e,r,i,s,n){this._render(e,r,r.regular.vao,i,s,n)}renderSilhouetteEdges(e,r,i,s,n){this._render(e,r,r.silhouette.vao,i,s,n)}_render(e,r,i,s,n,o){o>0&&(this._bindDraw(e,r,s,n),this._rctx.bindVAO(i),this._rctx.capabilities.instancing.drawArraysInstanced($t.TRIANGLE_FAN,0,4,o))}_bindDraw(e,r,i,s){if(this._drawParameters.componentDataTexture=r.components.buffer.textureBuffer.texture,this._drawParameters.strokesTexture=this._settings.strokesTexture,"origin"in r.transform)this._lastOriginId!==r.transform.origin.origin.id&&(e.setUniformMatrix4fv("localView",r.transform.origin.viewMatrix),this._lastOriginId=r.transform.origin.origin.id),e.setUniformMatrix4fv("model",r.transform.modelMatrix),this._drawParameters.slicePlaneLocalOrigin=r.transform.origin.origin.vec3;else{const n=new g6(r.transform.position),o=qh(jle,ex(jle,r.transform.rotationScale));this._drawParameters.transformWorldFromModelTL=n.low,this._drawParameters.transformWorldFromModelTH=n.high,this._drawParameters.transformWorldFromModelRS=r.transform.rotationScale,this._drawParameters.transformNormalGlobalFromModel=o;const a=s.camera.viewInverseTransposeMatrix;ce(this._drawParameters.slicePlaneLocalOrigin,a[3],a[7],a[11])}e.bindDraw(this._drawParameters,s,i)}_sortRenderables(){this._renderablesDirty=!1,this._sortedRenderables[rr.TRANSPARENT][rr.TRANSPARENT].clear(),this._sortedRenderables[rr.TRANSPARENT][rr.OPAQUE].clear(),this._sortedRenderables[rr.OPAQUE][rr.TRANSPARENT].clear(),this._sortedRenderables[rr.OPAQUE][rr.OPAQUE].clear(),this._renderables.forEach(r=>{r.objectTransparency!==rr.INVISIBLE&&r.edgeTransparency!==rr.INVISIBLE&&this._sortedRenderables[r.objectTransparency][r.edgeTransparency].push(r)});const e=(r,i)=>"origin"in r.transform?"origin"in i.transform?r.transform.origin.origin.id<i.transform.origin.origin.id?-1:r.transform.origin.origin.id>i.transform.origin.origin.id?1:0:1:0;this._sortedRenderables[rr.TRANSPARENT][rr.TRANSPARENT].sort(e),this._sortedRenderables[rr.TRANSPARENT][rr.OPAQUE].sort(e),this._sortedRenderables[rr.OPAQUE][rr.TRANSPARENT].sort(e),this._sortedRenderables[rr.OPAQUE][rr.OPAQUE].sort(e)}static getKey(e,r,i){return`edges-t:${e}:${r}:${i}`}};const jle=Gl();function FNt(t,e){return e.push(t.buffer),{buffer:t.buffer,layout:M_t(t.layout)}}function $$(t){return P_t(t.layout).createView(t.buffer)}function M_t(t){const e=new Array;return t.fields.forEach((r,i)=>{const s={...r,constructor:zCe(r.constructor)};e.push([i,s])}),{stride:t.stride,fields:e,fieldNames:t.fieldNames}}function P_t(t){const e=ts();return e.stride=t.stride,e.fieldNames=t.fieldNames,t.fields.forEach(r=>e.fields.set(r[0],{...r[1],constructor:$_t(r[1].constructor)})),e}const I_t=[SY,vy,Oi,Nc,sv,CY,AY,RY,wa,w5,EY,fO,eE,x5,mO,xa,T5,OY,S5,AM,E5,MY,z1e,G1e,PY,C5,j1e,H1e,q1e,A5,W1e,X1e,Y1e,Z1e,J1e,K1e];function zCe(t){return`${t.ElementType}_${t.ElementCount}`}function $_t(t){return GCe.get(t)}const GCe=new Map;I_t.forEach(t=>GCe.set(zCe(t),t));let L_t=class extends qSe{constructor(e){super("EdgeProcessingWorker","extract",{extract:r=>[r.dataBuffer],extractComponentsEdgeLocations:r=>[r.dataBuffer],extractEdgeLocations:r=>[r.dataBuffer]},e)}async process(e,r,i){if(i)return Tyt(e);const s=await this.invoke(new bk(e),r);return this._unpackOutput(s)}async extractEdgeLocations(e,r){const i=await this.invokeMethod("extractEdgeLocations",new bk(e),r);return $$(i)}async extractComponentsEdgeLocations(e,r){const i=await this.invokeMethod("extractComponentsEdgeLocations",new bk(e),r);return $$(i)}_unpackOutput(e){return{regular:{instancesData:$$(e.regular.instancesData),lodInfo:{lengths:new Float32Array(e.regular.lodInfo.lengths)}},silhouette:{instancesData:$$(e.silhouette.instancesData),lodInfo:{lengths:new Float32Array(e.silhouette.lodInfo.lengths)}},averageEdgeLength:e.averageEdgeLength}}},bk=class{constructor(e){this.dataBuffer=e.data.buffer,this.writerSettings=e.writerSettings,this.skipDeduplicate=e.skipDeduplicate,this.indices=Array.isArray(e.indices)?e.indices:e.indices.buffer,this.indicesType=Array.isArray(e.indices)?"Array":BH(e.indices)?"Uint32Array":"Uint16Array",this.indicesLength=e.indicesLength}};function D_t(t){const r=sA.resolution,i=r/2,s=new Uint8Array(4*r*r),n=4*r*i,o=sA.amplitude,a=2*o,l=4*r,c=Math.log2(r)+1,h=sA.strokes.length;let p=(c-1)*h*l;for(const{distance:m,pressure:y}of sA.strokes){let _=m,b=y,x=p;for(let T=0;T<c;T++){T!==0&&(_=Hle(_,VO.DISTANCE),b=Hle(b,VO.PRESSURE));for(let S=0;S<sA.resolution;S++){const E=.5+(_?_[S%_.length]/a:0),O=b?b[S%b.length]:1;xO(E,s,x),xO(O,s,x+n),x+=4}x-=l*(h+1)}p+=l}const f=new ct(t,{pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,hasMipmap:!1,samplingMode:tt.LINEAR,width:r,height:r,wrapMode:Rt.REPEAT},s);return new F_t(r,a,o,h,f)}function Hle(t,e){if(!t)return null;const r=t.length/2,i=N_t*r,s=new Array(r);let n=0;const o=e===VO.PRESSURE;for(let a=0;a<t.length;a+=2){const l=(t[a]+t[a+1])/2;s[n++]=o?Math.min(i,1-(1-l)*qle):Math.min(i,l*qle)}return s}var VO;(function(t){t[t.DISTANCE=0]="DISTANCE",t[t.PRESSURE=1]="PRESSURE"})(VO||(VO={}));const N_t=.1,qle=.5;let F_t=class{constructor(e,r,i,s,n){this.resolution=e,this.normalizationScale=r,this.amplitude=i,this.variants=s,this.texture=n}dispose(){this.texture=Qe(this.texture)}};const sA={amplitude:8,resolution:256,strokes:[{distance:[-1.59027,-1.59426,-1.59674,-1.59766,-1.59702,-1.59479,-1.59095,-1.5855,-1.57843,-1.56973,-1.55942,-1.5475,-1.53398,-1.5189,-1.50226,-1.4841,-1.46446,-1.44337,-1.42088,-1.39703,-1.37188,-1.34547,-1.31786,-1.28912,-1.2593,-1.22847,-1.19668,-1.16402,-1.13053,-1.09629,-1.06137,-1.02582,-.98972,-.95313,-.91611,-.87872,-.84102,-.80306,-.76488,-.72654,-.68807,-.64952,-.61092,-.57232,-.53375,-.49527,-.45692,-.41874,-.38078,-.34309,-.3057,-.26867,-.23204,-.19585,-.16015,-.12497,-.09036,-.05634,-.02296,.00977,.04183,.07321,.10389,.13386,.16313,.19169,.21956,.24672,.27321,.299,.32413,.34858,.37237,.3955,.41798,.43981,.461,.48154,.50145,.52073,.53939,.55744,.57488,.5917,.6079,.62347,.63837,.65259,.66609,.67885,.69083,.70201,.71235,.72183,.73042,.73812,.7449,.75076,.7557,.75973,.76284,.76507,.76642,.76692,.76659,.76545,.76352,.76083,.7574,.75324,.74837,.74279,.73652,.72959,.72199,.71377,.70493,.69553,.68558,.67515,.66426,.65298,.64135,.62944,.6173,.60499,.59257,.58008,.56759,.55513,.54275,.5305,.51842,.50654,.4949,.48353,.47246,.4617,.45128,.44121,.43149,.42213,.41313,.40448,.39617,.38818,.3805,.37309,.36594,.35902,.35229,.34572,.33927,.33292,.32663,.32035,.31407,.30774,.30135,.29486,.28824,.28148,.27454,.26739,.26002,.25241,.24454,.23639,.22796,.21922,.21016,.20076,.19098,.18082,.17023,.1592,.14768,.13566,.1231,.10996,.09624,.08188,.06688,.05121,.03485,.01778,0,-.0185,-.03771,-.05763,-.07824,-.09952,-.12144,-.14396,-.16706,-.19069,-.21481,-.23938,-.26436,-.28971,-.31539,-.34136,-.36759,-.39404,-.42067,-.44746,-.47437,-.50136,-.52839,-.55544,-.58248,-.60948,-.63642,-.66329,-.6901,-.71684,-.74352,-.77015,-.79675,-.82332,-.84988,-.87644,-.90301,-.92958,-.95615,-.98272,-1.00926,-1.03575,-1.06217,-1.08847,-1.11463,-1.1406,-1.16633,-1.19178,-1.2169,-1.24164,-1.26595,-1.28979,-1.31312,-1.3359,-1.35809,-1.37963,-1.4005,-1.42064,-1.44,-1.45853,-1.47616,-1.49285,-1.50853,-1.52313,-1.53659,-1.54886,-1.55986,-1.56955,-1.57788,-1.5848],pressure:[-.01365,-.00206,.01025,.02327,.03696,.05129,.06619,.08163,.09755,.11393,.1307,.14784,.16531,.18308,.20111,.21938,.23786,.25651,.2753,.29419,.31315,.33215,.35115,.37015,.38913,.40806,.42694,.44576,.46449,.48313,.50167,.5201,.53839,.55653,.57448,.59222,.60971,.62692,.6438,.66033,.67648,.69221,.70753,.72242,.73688,.75093,.76456,.77779,.79063,.80309,.81517,.82686,.83817,.84911,.85967,.86987,.87972,.88924,.89845,.90734,.91594,.92425,.93229,.94005,.94754,.95475,.96166,.96826,.97451,.9804,.98588,.99092,.99549,.99957,.99685,.99381,.99131,.98936,.98796,.98711,.98681,.98706,.98787,.98923,.99113,.99357,.99654,1,.99607,.99171,.98695,.98181,.97634,.97057,.96452,.95824,.95175,.94506,.93818,.93113,.92389,.91647,.90887,.90109,.89314,.88501,.87672,.86831,.85978,.85119,.84256,.83393,.82533,.8168,.80836,.80002,.79181,.78374,.77582,.7681,.76059,.75331,.74629,.73955,.73311,.72697,.72116,.71568,.71054,.70572,.70121,.697,.69304,.68931,.68576,.68236,.67905,.67582,.67262,.66941,.66619,.66291,.65957,.65613,.65259,.64892,.6451,.6411,.6369,.63248,.62783,.62295,.61783,.61247,.60688,.60104,.59498,.58868,.58216,.57542,.56845,.56125,.5538,.5461,.53813,.52986,.52129,.51239,.50316,.49359,.4837,.47349,.46299,.45223,.44124,.43005,.41869,.40719,.39557,.38386,.37207,.36023,.34836,.33648,.32464,.31287,.30119,.28963,.27822,.26698,.25594,.2451,.23448,.22409,.21391,.20394,.19415,.18452,.17503,.16565,.15636,.14713,.13794,.1288,.11968,.11058,.10151,.09247,.08346,.07447,.06552,.05659,.0477,.03885,.03007,.02137,.01278,.00433,-.00393,-.012,-.01983,-.02738,-.03463,-.04155,-.0481,-.05429,-.0601,-.06553,-.07057,-.07524,-.07954,-.08347,-.08703,-.09022,-.09303,-.09544,-.09744,-.09898,-.10004,-.10059,-.1006,-.10005,-.09892,-.0972,-.09487,-.09192,-.08833,-.08409,-.07918,-.07357,-.06724,-.06019,-.0524,-.04386,-.03455,-.02448]},{distance:[-3.46259,-3.47131,-3.47668,-3.47863,-3.47712,-3.4721,-3.46352,-3.45138,-3.43566,-3.41635,-3.39347,-3.36704,-3.33709,-3.30368,-3.26684,-3.22667,-3.18322,-3.1366,-3.08689,-3.0342,-2.97865,-2.92036,-2.85946,-2.79607,-2.73034,-2.66241,-2.59242,-2.52052,-2.44686,-2.37159,-2.29485,-2.2168,-2.13757,-2.05731,-1.97616,-1.89426,-1.81174,-1.72875,-1.64543,-1.56191,-1.47833,-1.39483,-1.3115,-1.22847,-1.14581,-1.06361,-.98193,-.90083,-.82036,-.74054,-.66141,-.583,-.50532,-.4284,-.35228,-.277,-.20261,-.12916,-.05672,.01463,.08485,.15384,.22153,.28784,.35269,.41602,.47776,.53787,.59629,.653,.70799,.76123,.81274,.86253,.9106,.95698,1.0017,1.04477,1.0862,1.126,1.16415,1.20065,1.23546,1.26857,1.29994,1.32953,1.35731,1.38321,1.40719,1.42921,1.44922,1.46719,1.48309,1.49691,1.50862,1.51825,1.52581,1.53133,1.53486,1.53644,1.53616,1.53409,1.53031,1.52493,1.51803,1.50972,1.50009,1.48924,1.47725,1.46421,1.45019,1.43527,1.4195,1.40295,1.38568,1.36778,1.34929,1.3303,1.31087,1.29108,1.27099,1.25066,1.23018,1.2096,1.18898,1.16838,1.14785,1.12745,1.10721,1.08719,1.06741,1.04791,1.02871,1.00986,.99136,.97324,.95551,.93819,.92127,.90476,.88866,.87296,.85767,.84277,.82823,.81406,.80022,.7867,.77346,.76049,.74774,.73519,.72278,.71049,.69827,.68606,.67381,.66145,.64893,.63618,.62313,.60973,.5959,.5816,.56675,.5513,.53516,.51826,.50053,.4819,.46231,.44169,.42002,.39725,.37336,.34834,.32219,.2949,.2665,.23698,.20638,.17469,.14193,.10809,.07316,.03714,0,-.03827,-.07772,-.11836,-.16022,-.20332,-.24768,-.29332,-.34024,-.38844,-.43788,-.48854,-.54036,-.59329,-.64724,-.70211,-.75782,-.81425,-.87128,-.92881,-.98674,-1.04498,-1.10346,-1.1621,-1.22086,-1.27969,-1.33854,-1.3974,-1.45625,-1.51511,-1.57396,-1.63283,-1.69173,-1.75067,-1.80968,-1.86875,-1.9279,-1.98712,-2.04639,-2.10568,-2.16495,-2.22416,-2.28322,-2.34208,-2.40063,-2.4588,-2.51647,-2.57354,-2.62989,-2.68543,-2.74002,-2.79357,-2.84597,-2.89711,-2.94689,-2.99521,-3.04195,-3.087,-3.13023,-3.17152,-3.21075,-3.24779,-3.28252,-3.3148,-3.34451,-3.37154,-3.39577,-3.41709,-3.43539,-3.45059],pressure:[.87183,.87151,.87129,.87118,.87117,.87128,.87149,.87182,.87225,.8728,.87347,.87424,.87513,.87613,.87723,.87845,.87978,.88122,.88276,.88441,.88616,.88801,.88996,.892,.89414,.89637,.89868,.90108,.90356,.90611,.90874,.91144,.91421,.91704,.91993,.92287,.92587,.92892,.93201,.93514,.93831,.94151,.94474,.94799,.95126,.95456,.95786,.96118,.9645,.96783,.97116,.97448,.9778,.98111,.98441,.9877,.99096,.99421,.99742,.99938,.99622,.9931,.99001,.98697,.98397,.98101,.97811,.97526,.97246,.96972,.96703,.96441,.96185,.95935,.95691,.95455,.95225,.95002,.94786,.94577,.94376,.94182,.93995,.93817,.93646,.93483,.93328,.93181,.93042,.92911,.92788,.92673,.92566,.92467,.92376,.92293,.92217,.92149,.92088,.92034,.91987,.91947,.91913,.91886,.91864,.91849,.91838,.91833,.91834,.91839,.91849,.91863,.91883,.91907,.91935,.91968,.92005,.92046,.92092,.92142,.92195,.92253,.92314,.9238,.92449,.92521,.92598,.92677,.9276,.92847,.92936,.93029,.93125,.93224,.93325,.9343,.93537,.93646,.93758,.93872,.93988,.94106,.94225,.94346,.94469,.94593,.94718,.94844,.94971,.95098,.95226,.95354,.95482,.9561,.95738,.95867,.95995,.96122,.9625,.96377,.96504,.9663,.96757,.96883,.97009,.97135,.97261,.97387,.97513,.9764,.97767,.97895,.98023,.98153,.98284,.98416,.98549,.98684,.98821,.9896,.99101,.99244,.99389,.99537,.99688,.99842,1,.99839,.99675,.99508,.99336,.99161,.98982,.98799,.98613,.98422,.98228,.98029,.97827,.97622,.97414,.97202,.96987,.9677,.96551,.9633,.96107,.95882,.95656,.9543,.95202,.94975,.94747,.94519,.94292,.94065,.93838,.93613,.93388,.93164,.92941,.9272,.92499,.9228,.92062,.91846,.91631,.91418,.91207,.90998,.90792,.90588,.90387,.90189,.89995,.89804,.89617,.89434,.89256,.89083,.88914,.88752,.88595,.88443,.88299,.88161,.8803,.87907,.87791,.87683,.87584,.87494,.87412,.8734,.87278,.87225]},{distance:[.39335,.43437,.47737,.52234,.56923,.61801,.66864,.72109,.7753,.83123,.88882,.94801,1.00875,1.07097,1.13461,1.1996,1.26586,1.33333,1.40193,1.47158,1.54221,1.61373,1.68607,1.75913,1.83284,1.90711,1.98186,2.05699,2.13243,2.20809,2.28387,2.35971,2.4355,2.51117,2.58663,2.66179,2.73658,2.81092,2.88473,2.95792,3.03043,3.10217,3.17308,3.24309,3.31211,3.3801,3.44697,3.51267,3.57712,3.64028,3.70208,3.76247,3.8214,3.87881,3.93467,3.98892,4.04152,4.09244,4.14164,4.18908,4.23474,4.27859,4.32061,4.36077,4.39905,4.43544,4.46992,4.50249,4.53314,4.56185,4.58864,4.61349,4.63642,4.65745,4.67657,4.69381,4.7092,4.72274,4.73447,4.74441,4.75259,4.75903,4.76376,4.76682,4.76822,4.768,4.76618,4.76279,4.75786,4.75142,4.74348,4.73409,4.72326,4.71102,4.69739,4.68241,4.6661,4.64849,4.6296,4.60948,4.58816,4.56567,4.54204,4.51732,4.49154,4.46473,4.43694,4.4082,4.37854,4.348,4.31662,4.28443,4.25145,4.21773,4.1833,4.14819,4.11243,4.07606,4.03912,4.00162,3.96361,3.92512,3.88618,3.84683,3.80708,3.76697,3.72653,3.68579,3.64478,3.60351,3.56202,3.52033,3.47845,3.43642,3.39425,3.35196,3.30957,3.2671,3.22455,3.18196,3.13933,3.09668,3.05402,3.01136,2.96873,2.92613,2.88357,2.84108,2.79865,2.75631,2.71407,2.67195,2.62994,2.58807,2.54634,2.50477,2.46338,2.42216,2.38114,2.34032,2.29971,2.25933,2.21916,2.17923,2.13954,2.10008,2.06087,2.02189,1.98316,1.94468,1.90644,1.86845,1.83069,1.79316,1.75586,1.71877,1.68189,1.6452,1.60868,1.57232,1.53611,1.50004,1.46407,1.4282,1.39241,1.35668,1.321,1.28535,1.24972,1.2141,1.17849,1.14286,1.10723,1.07158,1.03593,1.00028,.96464,.92902,.89344,.85793,.8225,.78719,.75203,.71705,.68231,.64784,.61369,.57991,.54656,.51368,.48134,.44959,.41849,.3881,.35848,.32967,.30174,.27474,.24872,.22373,.19982,.17702,.15539,.13497,.11579,.09791,.08137,.06621,.05248,.04022,.02948,.02029,.01271,.00677,.00252,0,-76e-5,27e-5,.00314,.00788,.01451,.02307,.03357,.04604,.0605,.07697,.09546,.11599,.13858,.16322,.18992,.21869,.24952,.28241,.31735,.35434],pressure:[.95248,.95236,.95228,.95223,.95222,.95224,.95231,.95241,.95256,.95274,.95296,.95322,.95352,.95385,.95423,.95465,.9551,.9556,.95613,.9567,.95731,.95796,.95864,.95936,.96012,.96091,.96173,.96259,.96348,.9644,.96535,.96633,.96734,.96838,.96944,.97053,.97164,.97277,.97393,.9751,.97629,.9775,.97873,.97997,.98122,.98249,.98376,.98505,.98634,.98763,.98893,.99023,.99154,.99284,.99414,.99544,.99673,.99802,.9993,.99942,.99816,.99691,.99568,.99445,.99324,.99205,.99087,.98972,.98858,.98746,.98636,.98528,.98423,.9832,.98219,.98121,.98025,.97931,.9784,.97752,.97666,.97582,.97501,.97423,.97347,.97274,.97203,.97135,.9707,.97007,.96948,.9689,.96836,.96784,.96735,.96689,.96646,.96605,.96567,.96533,.965,.96471,.96445,.96421,.964,.96382,.96367,.96355,.96346,.96339,.96335,.96334,.96336,.9634,.96348,.96358,.9637,.96385,.96403,.96423,.96446,.96471,.96499,.96529,.96561,.96595,.96631,.96669,.96709,.96751,.96795,.9684,.96887,.96935,.96984,.97035,.97087,.9714,.97194,.97249,.97304,.97361,.97418,.97476,.97534,.97592,.97651,.97711,.9777,.9783,.9789,.9795,.9801,.9807,.9813,.9819,.9825,.98309,.98369,.98428,.98486,.98545,.98603,.98661,.98718,.98775,.98832,.98888,.98944,.99,.99056,.99112,.99167,.99223,.99279,.99335,.99392,.99449,.99507,.99565,.99624,.99684,.99745,.99807,.9987,.99934,1,.99933,.99866,.99797,.99727,.99656,.99583,.9951,.99435,.99359,.99283,.99205,.99126,.99046,.98966,.98885,.98803,.9872,.98637,.98554,.9847,.98387,.98303,.98219,.98134,.9805,.97967,.97883,.978,.97717,.97634,.97552,.97471,.97389,.97309,.97229,.9715,.97071,.96993,.96915,.96838,.96762,.96687,.96612,.96539,.96466,.96395,.96324,.96255,.96187,.9612,.96055,.95991,.95929,.95869,.95811,.95754,.957,.95648,.95599,.95552,.95508,.95467,.95428,.95393,.9536,.95331,.95305,.95283,.95264]},{distance:[2.85606,2.86149,2.86432,2.8645,2.862,2.85686,2.84912,2.83886,2.82618,2.81117,2.79393,2.77456,2.75314,2.72975,2.70447,2.67734,2.64844,2.61784,2.58564,2.55196,2.5169,2.48057,2.44305,2.40438,2.36462,2.32383,2.28208,2.23943,2.19591,2.15153,2.10628,2.06016,2.01321,1.96548,1.91702,1.86793,1.8183,1.76829,1.71803,1.66767,1.61737,1.56726,1.51746,1.46803,1.41902,1.37044,1.32228,1.27452,1.22716,1.18023,1.13376,1.08781,1.04244,.99769,.95357,.91003,.86701,.82447,.78238,.74069,.69938,.65836,.61758,.57699,.53656,.49627,.45611,.41611,.37632,.33683,.29776,.25924,.22141,.18441,.14839,.11346,.07972,.04727,.01619,-.01348,-.0417,-.0684,-.09351,-.11698,-.13875,-.1588,-.17713,-.19381,-.20889,-.22242,-.23444,-.24501,-.25421,-.26216,-.26897,-.27473,-.27951,-.28336,-.28631,-.28836,-.28948,-.28963,-.28873,-.28673,-.28355,-.27916,-.27354,-.26673,-.25878,-.2498,-.23992,-.22929,-.21802,-.20623,-.19398,-.18134,-.16836,-.1551,-.14163,-.12809,-.11461,-.1013,-.08826,-.07557,-.06335,-.0517,-.04077,-.03065,-.02143,-.01321,-.00606,0,.00496,.00888,.01181,.01385,.01511,.0157,.01574,.01533,.01458,.01358,.0124,.01112,.00979,.00851,.00738,.0065,.006,.00596,.00646,.00754,.00924,.01161,.01471,.01858,.02323,.02865,.03481,.04169,.0493,.05765,.06677,.07671,.08754,.09934,.11222,.12628,.14159,.15823,.17624,.19561,.21632,.23828,.26142,.28563,.31083,.33696,.36397,.39185,.42057,.4501,.48036,.51125,.54264,.5744,.60646,.63871,.67105,.70337,.73556,.76751,.79918,.83048,.86139,.8919,.92202,.95184,.98144,1.01094,1.04045,1.0701,1.10002,1.13029,1.16103,1.1923,1.22416,1.25664,1.28979,1.32364,1.35824,1.39363,1.42985,1.4669,1.50475,1.54332,1.58252,1.62227,1.6625,1.70312,1.744,1.78501,1.82598,1.8668,1.90734,1.94754,1.98732,2.02666,2.06555,2.10402,2.1421,2.17985,2.2173,2.25448,2.29139,2.328,2.36424,2.4,2.43515,2.46955,2.50309,2.53565,2.56717,2.59761,2.62692,2.65505,2.68191,2.7074,2.73138,2.75375,2.7744,2.79324,2.81017,2.82504,2.83772,2.8481],pressure:[.22758,.23641,.24578,.25568,.26609,.27699,.28835,.30016,.31237,.32495,.33789,.35113,.36466,.37843,.39241,.40658,.4209,.43535,.44989,.4645,.47916,.49385,.50853,.5232,.53784,.55243,.56696,.58141,.59578,.61004,.62419,.63821,.65209,.6658,.67934,.69268,.70582,.71873,.73139,.7438,.75594,.76779,.77935,.79061,.80156,.81221,.82254,.83258,.84231,.85176,.86091,.86978,.87837,.88669,.89473,.9025,.91,.91725,.92425,.931,.93752,.9438,.94985,.95566,.96124,.96658,.97168,.97652,.98109,.98539,.98939,.99309,.99646,.99949,.99783,.99552,.99361,.99209,.99098,.99029,.99003,.99019,.99079,.99181,.99324,.9951,.99735,1,.99698,.99361,.98992,.98592,.98163,.97709,.97231,.96731,.96212,.95676,.95122,.94554,.93973,.93378,.92773,.92157,.91532,.90899,.90258,.89612,.88961,.88308,.87653,.87,.8635,.85705,.85068,.8444,.83823,.83219,.82628,.82052,.81493,.80952,.8043,.79929,.7945,.78994,.78561,.78151,.77765,.77402,.77062,.76742,.76443,.76161,.75896,.75645,.75406,.75175,.74951,.7473,.74511,.74289,.74064,.73833,.73592,.73341,.73078,.728,.72507,.72197,.71869,.71522,.71156,.70769,.70363,.69936,.69489,.69021,.68533,.68023,.67492,.66939,.66363,.65765,.65145,.64501,.63833,.63143,.62428,.61691,.60931,.60148,.59344,.58521,.57679,.5682,.55948,.55063,.54167,.53264,.52354,.51439,.50522,.49603,.48686,.47773,.46865,.45964,.45072,.44192,.43324,.42469,.41629,.40804,.39994,.392,.3842,.37655,.36903,.36164,.35437,.3472,.34012,.33312,.3262,.31933,.31251,.30574,.299,.2923,.28563,.27899,.27239,.26583,.25933,.25288,.24652,.24025,.2341,.22808,.22221,.21653,.21104,.20576,.20072,.19592,.19138,.18712,.18313,.17943,.17602,.17292,.17013,.16766,.16551,.16369,.16222,.1611,.16036,.16001,.16007,.16055,.16148,.16286,.16471,.16705,.16988,.17321,.17706,.18144,.18636,.19182,.19785,.20443,.21158,.2193]},{distance:[-2.31317,-2.3191,-2.32189,-2.32154,-2.31811,-2.31174,-2.30254,-2.29062,-2.27609,-2.25904,-2.23954,-2.21767,-2.19355,-2.16732,-2.13907,-2.10885,-2.07672,-2.04268,-2.00677,-1.96911,-1.92985,-1.88914,-1.84713,-1.80397,-1.75979,-1.71467,-1.66864,-1.62171,-1.57395,-1.52546,-1.47625,-1.42628,-1.3755,-1.32384,-1.27131,-1.218,-1.16408,-1.10972,-1.05508,-1.00031,-.94551,-.89077,-.83615,-.7817,-.72757,-.6739,-.62076,-.56821,-.51625,-.46484,-.41397,-.36366,-.314,-.26506,-.21689,-.16957,-.12316,-.07766,-.03301,.01085,.05399,.09643,.13827,.17967,.22079,.26176,.30265,.34342,.38397,.42414,.46381,.50285,.54115,.57863,.61524,.65093,.6856,.71914,.75153,.78275,.81283,.84182,.86972,.89651,.92208,.94634,.96919,.99052,1.01025,1.02835,1.04484,1.05976,1.07309,1.08479,1.09492,1.1036,1.11096,1.11714,1.12224,1.12627,1.12916,1.13083,1.13125,1.13036,1.12816,1.12466,1.11992,1.11397,1.10677,1.09827,1.08849,1.07746,1.06527,1.05203,1.03786,1.02283,1.00695,.99025,.97279,.9546,.93573,.9163,.8965,.8765,.85647,.83652,.81687,.79775,.77939,.76199,.74568,.73049,.71635,.70316,.69082,.67925,.66834,.65804,.64831,.63911,.63032,.62184,.61363,.60564,.59788,.59036,.58308,.57597,.5689,.56177,.55447,.5469,.53896,.53062,.5219,.51283,.5034,.49355,.48335,.47287,.46223,.45154,.44085,.43012,.41923,.40805,.39648,.38441,.37176,.35849,.34458,.32999,.31461,.29833,.28109,.26288,.2437,.22361,.20265,.18082,.15807,.13434,.1096,.0838,.0569,.02894,0,-.0298,-.0604,-.09173,-.12364,-.15594,-.18843,-.22092,-.25331,-.28559,-.31781,-.35006,-.38244,-.41502,-.44785,-.48098,-.5144,-.54811,-.58218,-.61666,-.65153,-.68677,-.72232,-.75807,-.79397,-.83002,-.86628,-.90281,-.93968,-.97693,-1.01465,-1.05282,-1.09139,-1.13031,-1.16956,-1.20917,-1.24905,-1.28907,-1.32908,-1.36891,-1.40844,-1.44765,-1.48658,-1.52527,-1.56376,-1.60206,-1.64016,-1.67801,-1.71552,-1.75264,-1.78936,-1.8257,-1.86161,-1.89702,-1.93182,-1.96584,-1.99894,-2.03102,-2.06203,-2.0919,-2.12056,-2.14794,-2.17397,-2.19852,-2.22138,-2.24235,-2.26129,-2.27805,-2.29243,-2.30422],pressure:[.9681,.97424,.98046,.98674,.99309,.9995,.99404,.98754,.981,.97444,.96785,.96124,.95462,.94801,.94139,.93479,.92822,.92167,.91515,.90868,.90225,.89589,.88959,.88336,.87722,.87115,.86519,.85932,.85356,.84792,.84239,.83699,.83173,.8266,.82162,.81679,.81211,.80759,.80324,.79906,.79505,.79121,.78756,.78409,.78081,.77771,.77481,.77211,.76959,.76728,.76516,.76324,.76153,.76001,.75869,.75757,.75665,.75593,.7554,.75507,.75493,.75498,.75523,.75565,.75627,.75706,.75803,.75917,.76049,.76197,.76361,.76541,.76737,.76947,.77172,.77409,.7766,.77923,.78198,.78484,.7878,.79086,.79401,.79724,.80055,.80394,.8074,.81092,.8145,.81813,.82182,.82556,.82934,.83317,.83703,.84093,.84487,.84884,.85284,.85687,.86094,.86503,.86915,.87329,.87746,.88166,.88587,.89011,.89436,.89863,.90291,.9072,.91149,.91579,.92009,.92438,.92867,.93295,.9372,.94144,.94566,.94985,.954,.95812,.96219,.96623,.97021,.97415,.97802,.98184,.9856,.9893,.99293,.9965,1,.99657,.9932,.98991,.98668,.98352,.98042,.97738,.9744,.97148,.9686,.96577,.96298,.96023,.95751,.95482,.95214,.94949,.94684,.9442,.94156,.93892,.93627,.93361,.93094,.92825,.92555,.92284,.9201,.91735,.91458,.91179,.90899,.90616,.90332,.90047,.8976,.89472,.89183,.88893,.88603,.88314,.88024,.87735,.87448,.87162,.86878,.86597,.86319,.86044,.85774,.85508,.85247,.84993,.84744,.84503,.84269,.84042,.83825,.83616,.83417,.83227,.83048,.8288,.82724,.82578,.82445,.82324,.82215,.82119,.82037,.81967,.81911,.81868,.81839,.81824,.81823,.81835,.81862,.81903,.81957,.82026,.82109,.82206,.82317,.82443,.82583,.82737,.82906,.83089,.83287,.83499,.83726,.83968,.84223,.84494,.84778,.85077,.8539,.85717,.86058,.86412,.86781,.87163,.87559,.87968,.88391,.88826,.89275,.89737,.90211,.90698,.91198,.91709,.92233,.92768,.93315,.93873,.94441,.95019,.95607,.96205]},{distance:[4.72925,4.81721,4.9037,4.98859,5.07177,5.15311,5.23249,5.3098,5.38491,5.45772,5.52811,5.59598,5.66122,5.72375,5.78346,5.84028,5.8941,5.94486,5.99248,6.03689,6.07803,6.11584,6.15028,6.18128,6.20882,6.23285,6.25336,6.27031,6.28369,6.29348,6.29969,6.3023,6.30133,6.29678,6.28867,6.27703,6.26187,6.24324,6.22116,6.19567,6.16683,6.13468,6.09928,6.06068,6.01896,5.97417,5.92639,5.87569,5.82217,5.76589,5.70696,5.64545,5.58147,5.5151,5.44644,5.37559,5.30265,5.2277,5.15085,5.0722,4.99184,4.90987,4.82639,4.74151,4.65533,4.56794,4.47945,4.38996,4.29959,4.20843,4.11658,4.02416,3.93125,3.83796,3.74437,3.65057,3.55666,3.46272,3.36884,3.27509,3.18155,3.08831,2.99545,2.90303,2.81114,2.71984,2.62922,2.53933,2.45026,2.36207,2.27484,2.18862,2.10349,2.01951,1.93675,1.85528,1.77515,1.69644,1.61919,1.54348,1.46935,1.39685,1.32605,1.25698,1.18967,1.12417,1.06049,.99863,.93862,.88044,.82408,.76953,.71676,.66574,.61644,.56882,.52282,.47841,.43553,.39413,.35414,.31551,.27817,.24206,.20712,.17328,.14048,.10866,.07776,.04772,.01848,-.00999,-.03776,-.06487,-.09134,-.11721,-.14251,-.16725,-.19144,-.21509,-.2382,-.26076,-.28275,-.30416,-.32496,-.34511,-.36459,-.38334,-.40134,-.41852,-.43485,-.45026,-.46471,-.47815,-.49052,-.50179,-.51189,-.52081,-.52849,-.5349,-.54003,-.54383,-.54627,-.54734,-.54702,-.54528,-.54211,-.53752,-.53149,-.52403,-.51515,-.50487,-.4932,-.48015,-.46575,-.45001,-.43297,-.41463,-.39503,-.37419,-.35213,-.32887,-.30443,-.27885,-.25214,-.22432,-.19541,-.16544,-.13442,-.10235,-.06926,-.03514,0,.03616,.07336,.11159,.15088,.19125,.23272,.27531,.31906,.36401,.41019,.45764,.5064,.55651,.60802,.66096,.71538,.77129,.82874,.88776,.94836,1.01056,1.07438,1.13982,1.20687,1.27554,1.34581,1.41766,1.49107,1.56599,1.64239,1.72025,1.79951,1.88013,1.96209,2.04532,2.12979,2.21546,2.30226,2.39017,2.47911,2.56905,2.65991,2.75164,2.84416,2.93742,3.03133,3.12582,3.2208,3.31619,3.41191,3.50785,3.60393,3.70006,3.79612,3.89202,3.98765,4.08291,4.17767,4.27182,4.36525,4.45783,4.54944,4.63995],pressure:[.30942,.30838,.30765,.30724,.30715,.30738,.30795,.30884,.31007,.31164,.31354,.31578,.31837,.32129,.32455,.32815,.33209,.33636,.34097,.34591,.35117,.35675,.36265,.36887,.37539,.38221,.38933,.39674,.40442,.41238,.4206,.42907,.43779,.44675,.45593,.46533,.47493,.48473,.49471,.50486,.51517,.52563,.53623,.54694,.55777,.5687,.57971,.59079,.60194,.61313,.62435,.6356,.64686,.65811,.66935,.68056,.69174,.70286,.71391,.72489,.73579,.74659,.75728,.76785,.7783,.7886,.79876,.80877,.81861,.82827,.83776,.84706,.85617,.86507,.87378,.88227,.89056,.89863,.90649,.91412,.92153,.92872,.93568,.94241,.94892,.95519,.96122,.96702,.97258,.97791,.98299,.98783,.99242,.99677,.99911,.99525,.99164,.98827,.98515,.98228,.97966,.97728,.97514,.97324,.97159,.97017,.96898,.96801,.96727,.96674,.96641,.96629,.96635,.96661,.96703,.96762,.96838,.96928,.97032,.97149,.97279,.9742,.97572,.97734,.97905,.98085,.98273,.98468,.98669,.98877,.99091,.99311,.99535,.99765,1,.9976,.99516,.99267,.99014,.98755,.98491,.98222,.97947,.97666,.97378,.97083,.96781,.96471,.96153,.95826,.9549,.95144,.94787,.9442,.94042,.93651,.93249,.92834,.92407,.91966,.91512,.91045,.90564,.90069,.8956,.89037,.885,.87949,.87384,.86806,.86214,.85608,.84988,.84356,.83711,.83053,.82383,.81702,.81009,.80306,.79594,.78872,.78141,.77403,.76657,.75905,.75148,.74385,.73619,.72849,.72076,.71302,.70526,.69749,.68972,.68195,.67419,.66644,.65871,.65099,.64329,.63561,.62795,.62032,.61271,.60512,.59755,.59001,.58248,.57497,.56749,.56002,.55256,.54512,.5377,.5303,.52291,.51554,.50819,.50087,.49358,.48632,.4791,.47192,.4648,.45773,.45072,.44378,.43692,.43015,.42346,.41687,.41039,.40403,.39779,.39168,.38571,.37989,.37423,.36873,.36342,.35828,.35335,.34862,.34409,.3398,.33573,.3319,.32831,.32498,.32192,.31912,.3166,.31436,.31242,.31077]}]};function Wle(t){let e=null;for(const r of t){const i=r.type;if(U_t(r)){if(C(e))e=i;else if(e!==i)return"uber"}}return v(e)?e:"uber"}function Xle(t){let e=rr.INVISIBLE;for(const{material:r}of t)if(jCe(r)){if(r.color[3]*r.opacity<1)return rr.TRANSPARENT;e=rr.OPAQUE}return e}function Yle(t){let e=rr.INVISIBLE;for(const{material:r}of t)if(jCe(r)){switch(r.objectTransparency){case rr.TRANSPARENT:case rr.INVISIBLE:return rr.TRANSPARENT;case rr.OPAQUE:if(r.opacity<1)return rr.TRANSPARENT}e=rr.OPAQUE}return e}function jCe(t){return t.size*t.color[3]*t.opacity>0}function U_t(t){return t.size*t.color[3]>0}function Zle(t,e,r,i){for(let s=0;s<t.length;s++){const n=t[s].index,o=e[s],a=e[s+1];if(i)for(let l=o;l<a;l++){const c=i[l];r.set(c,n)}else for(let l=o;l<a;l++)r.set(l,n)}}let Id=class extends Te{constructor(t){super(t),this._updatingHandles=new Hf,this._perObjectData=new Map,this._perObjectDataEvictionCache=new Set,this._renderers=new Map,this._gpuMemoryUsage=0,this._workerAbort=new AbortController,this._tmpModelPosition=M(),this._localOrigins=new h_t(new FZ(t.renderSR))}initialize(){this._worker=new L_t(this.schedule),this._componentColorManager=new rCe(this.rctx,3);const t=JEe.createBuffer(4);for(let e=0;e<4;e++)t.sideness.set(e,0,e===0||e===3?0:1),t.sideness.set(e,1,e===0||e===1?0:1);this._verticesBufferObject=jr.createVertex(this.rctx,Lr.STATIC_DRAW,t.buffer)}destroy(){this.destroyed||(this._perObjectData.forEach(t=>this._discardObjectEntry(t)),this._perObjectData.clear(),this._strokesTexture=Qe(this._strokesTexture),this._componentColorManager=ke(this._componentColorManager),this._workerAbort.abort(),this._worker.destroy(),this._verticesBufferObject=Qe(this._verticesBufferObject),this._renderers.clear(),this._updatingHandles.destroy())}get updating(){return this._updatingHandles.updating}get usedMemory(){return this._gpuMemoryUsage}shouldRender(){return this._renderers.size>0}async addComponentObject(t,e,r,i,s,n,o,a){if(this.hasObject(t))return this.getObjectMemoryUsage(t);let l;const c=new Kle(new Promise(p=>l=p),r.center,r.radius);this._perObjectData.set(t,c);const h=await this._updatingHandles.addPromise(this._addComponentGeometry(e,c,i,s,n,o,a));return this.setNeedsRender(),l(),h}async addOrUpdateObject3D(t,e,r,i){if(this.destroyed)return void se.getLogger(this.declaredClass).warn("Attempt to add an object to a destroyed instance");const s=this._perObjectData.get(t);let n;(s==null?void 0:s.renderables.length)>0&&this._perObjectDataEvictionCache.add(s);const o=t.boundingVolumeWorldSpace.bounds,a=new Kle(new Promise(c=>n=c),o,Fg(o));this._perObjectData.set(t,a);const l=new Array;if(r.mergeGeometries&&t.geometries.length>1&&k_t(t))l.push(this._addObjectMergedGeometries(t,a,e,r,i));else for(let c=0;c<t.geometries.length;c++){const h=t.geometries[c];h.material.supportsEdges&&l.push(this._addGeometry(t,a,h,e[0],r,i))}await this._updatingHandles.addPromise(Promise.all(l)),this._perObjectDataEvictionCache.delete(a),this._discardObjectEntry(s),this.setNeedsRender(),n()}_discardObjectEntry(t){t&&(t.renderables.length&&(t.renderables.forEach(e=>this._removeRenderable(e)),this.setNeedsRender()),t.loaded=null)}hasObject(t){return this._perObjectData.has(t)}async updateAllComponentOpacities(t,e){const r=await this._updatingHandles.addPromise(this._getObjectEntry(t));if(C(r))return;const i=e instanceof Array?s=>e[s]:()=>e;r.renderables.forEach(s=>{const n=s.components.meta.length;for(let o=0;o<n;o++){const a=i(o),l=s.components.meta[o],c=l.index;l.material.opacity=a,s.components.buffer.textureBuffer.setDataElement(c,1,3,255*a)}this._updateTransparency(s)}),this.setNeedsRender()}async getObjectMemoryUsage(t){const e=await this._getObjectEntry(t);return v(e)?e.renderables.reduce((r,i)=>r+i.statistics.gpuMemoryUsage,0):0}async updateAllComponentMaterials(t,e,r,i){const s=t instanceof Ty,n=!!r.hasSlicePlane,o=Wle(e),a=vk.getKey(o,n,s),l=await this._updatingHandles.addPromise(this._getObjectEntry(t));C(l)||(l.renderables.forEach(c=>{if(a!==c.rendererKey){const h=this._renderers.get(c.rendererKey),p=this._acquireRenderer(o,n,s);h.removeRenderable(c),--h.refCount,c.rendererKey=a,p.addRenderable(c)}for(let h=0;h<e.length;h++)c.components.meta[h].material=e[h];i&&this._updateComponentBuffer(c.components),this._updateTransparency(c)}),this.setNeedsRender())}async updateAllVerticalOffsets(t,e){const r=await this._updatingHandles.addPromise(this._getObjectEntry(t));C(r)||(r.renderables.forEach(i=>{const s=i.components.meta;for(let n=0;n<s.length;n++)i.components.meta[n].verticalOffset=(e==null?void 0:e[n])??0;this._updateComponentBuffer(i.components)}),this.setNeedsRender())}async updateObjectVisibility(t,e){const r=await this._updatingHandles.addPromise(this._getObjectEntry(t));v(r)&&(r.renderables.forEach(i=>i.visible=e),this.setNeedsRender())}removeObject(t){const e=this._perObjectData.get(t);e&&(this._perObjectData.delete(t),this._discardObjectEntry(e))}async _getObjectEntry(t){const e=this._perObjectData.get(t);if(!e)throw new Error("no object");return await e.loaded,e.loaded==null?null:e}render(t,e){if(C(this._componentColorManager))return;this._localOrigins.updateViewMatrices(t.camera.viewMatrix);const r=t.camera.viewInverseTransposeMatrix,i=M(),s=new g6;let n=0,o=0;if(this._renderers.forEach(l=>{if(l.refCount===0)this._renderers.delete(l.key),l.dispose();else{let c=!0,h=!0;l.forEachRenderable(p=>{p.visible&&(n+=p.statistics.averageEdgeLength,o++,c&&p.regular&&(l.updateTechnique(t,!1),c=!1),h&&p.silhouette&&(l.updateTechnique(t,!0),h=!1))},e)}}),this._componentColorManager.garbageCollect(),this._componentColorManager.updateTextures(),o===0)return;const a=new p_t(40*n/o,e);ce(i,r[3],r[7],r[11]),s.set(i),le(a.transformWorldFromViewTH,s.high),le(a.transformWorldFromViewTL,s.low),Hh(a.transformViewFromCameraRelativeRS,t.camera.viewMatrix),qh(rce,a.transformViewFromCameraRelativeRS),ex(a.transformNormalViewFromGlobal,rce),a.transformProjFromView=t.camera.projectionMatrix,this._updateObjectCameraDistances(t),this._renderers.forEach(l=>{this._renderRegularEdges(l,t,a),this._renderSilhouetteEdges(l,t,a)})}_updateTransparency(t){const e=Xle(t.components.meta),r=Yle(t.components.meta);e===t.edgeTransparency&&r===t.objectTransparency||(t.edgeTransparency=e,t.objectTransparency=r,this._renderers.get(t.rendererKey).setRenderablesDirty())}_computeModelTransformWithLocalOrigin(t,e,r){t.getCombinedStaticTransformation(e,r);const i=v(e.localOrigin)?this._localOrigins.register(e.localOrigin):this._localOrigins.acquire(ce(this._tmpModelPosition,r[12],r[13],r[14]));return e.localOrigin=i.origin,c_t(i.origin.vec3,r),i}_updateComponentBuffer(t){const{meta:e,buffer:r}=t,i=new Uint8Array(4);for(let s=0;s<e.length;s++){const n=e[s].material,o=e[s].index,a=ge(Math.round(n.size*A_t),0,255),l=ge(n.extensionLength,-_k,255-_k)+_k,c=n.type==="solid"?KF.SOLID:KF.SKETCH,h=255*n.opacity,p=n.color,f=255*p[0],m=255*p[1],y=255*p[2],_=255*p[3];r.textureBuffer.setData(o,0,f,m,y,_),r.textureBuffer.setData(o,1,a,l,c,h),WEe(e[s].verticalOffset,i),r.textureBuffer.setData(o,2,i[0],i[1],i[2],i[3])}}_createComponentBuffers(t){if(C(this._componentColorManager))return null;const e=new Array,r=this._componentColorManager.getBuffer(t.length);for(let s=0;s<t.length;s++){const n=t[s],o=r.acquireIndex();e.push({index:o,verticalOffset:0,material:n})}const i=new V_t(r,e);return this._updateComponentBuffer(i),i}_extractEdges(t,e,r,i,s,n=s.length){return this._worker.process({data:e,indices:s,indicesLength:n,writerSettings:t,skipDeduplicate:r},this._workerAbort.signal,i)}_createRenderable(t,e,r,i,s){const n=c=>v(this._verticesBufferObject)?new B_t(new Sp(this.rctx,QEe,{vertices:dyt,instances:c===Mb.REGULAR?ZF.glLayout:JF.glLayout},{vertices:this._verticesBufferObject,instances:jr.createVertex(this.rctx,Lr.STATIC_DRAW,c===Mb.REGULAR?t.regular.instancesData.buffer:t.silhouette.instancesData.buffer)}),c===Mb.REGULAR?t.regular.lodInfo:t.silhouette.lodInfo):null,o=t.regular.lodInfo.lengths.length>0?n(Mb.REGULAR):null,a=t.silhouette.lodInfo.lengths.length>0?n(Mb.SILHOUETTE):null,l=(v(o)?o.vao.size:0)+(v(a)?a.vao.size:0);return new G_t(o,a,{gpuMemoryUsage:l,externalMemoryUsage:s,averageEdgeLength:t.averageEdgeLength},r,Xle(e.meta),Yle(e.meta),e,i)}async _addGeometry(t,e,r,i,s,n){const o=r.vertexAttributes.get(A.POSITION),a=r.indices.get(A.POSITION),l=Ie(),c=this._computeModelTransformWithLocalOrigin(t,r,l),h=new tce(o,a,l,c);return this._addPositionData(e,h,r.edgeIndicesLength,i,s,n)}async _addPositionData(t,e,r,i,s,n=!1){if(t.loaded==null)return;const o=this._createComponentBuffers([i]);if(C(o)||r<=0)return;const a=this._acquireRenderer(i.type,!!s.hasSlicePlane,!0),{modelTransform:l,origin:c}=e,h=e.indices,p=e.position,f=p.data.length/p.size,m=XF.createBuffer(f);for(let b=0;b<f;b++)m.position.set(b,0,p.data[b*p.size+0]),m.position.set(b,1,p.data[b*p.size+1]),m.position.set(b,2,p.data[b*p.size+2]);Zle(o.meta,[0,m.componentIndex.count],m.componentIndex);const y=await this._updatingHandles.addPromise(this._extractEdges(a.writerSettings,m,!1,n,h,r));if(t.loaded==null)return;const _=this._createRenderable(y,o,new z_t(l,c),a.key,!1);t.renderables.push(_),a.addRenderable(_),this._gpuMemoryUsage+=_.statistics.gpuMemoryUsage}async _addComponentGeometry(t,e,r,i,s,n,o){if(e.loaded==null)return 0;const a=this._createComponentBuffers(n);if(C(a))return 0;const l=Wle(n),c=this._acquireRenderer(l,o.hasSlicePlane||!1,!1),h=XF.createBuffer(r.count);n6(h.position,r),Zle(a.meta,s,h.componentIndex,i);const p=!0,f=c.writerSettings,m=await this._updatingHandles.addPromise(this._extractEdges(f,h,p,!1,i));if(e.loaded==null)return 0;const y=this._createRenderable(m,a,t,c.key,!0);return e.renderables.push(y),c.addRenderable(y),y.statistics.gpuMemoryUsage}async _addObjectMergedGeometries(t,e,r,i,s){const n=new Map;let o=0,a=null,l=0;for(let x=0;x<t.geometries.length;x++){const T=t.geometries[x];if(!T.material.supportsEdges)continue;!a&&T.localOrigin&&(a=T);const S=T.vertexAttributes.get(A.POSITION);l+=S.data.length/S.size,o+=T.edgeIndicesLength}const c=l>=65536?Uint32Array:Uint16Array,h=o?new c(o):null,p=[];let f=0;for(let x=0;x<t.geometries.length;x++){const T=t.geometries[x];if(!T.material.supportsEdges)continue;const S=T.vertexAttributes.get(A.POSITION),E=T.indices.get(A.POSITION);let O=n.get(S.data);if(O==null){O=p.length/3;for(let R=0;R<S.data.length;R+=S.size)p.push(S.data[R+0]),p.push(S.data[R+1]),p.push(S.data[R+2]);n.set(S.data,O)}if(E)for(let R=0;R<T.edgeIndicesLength;R++)h[f++]=O+E[R]}const m=a||t.geometries[0],y=Ie(),_=this._computeModelTransformWithLocalOrigin(t,m,y);for(let x=0;x<t.geometries.length;x++)t.geometries[x].localOrigin=_.origin;const b=new tce({data:p,size:3},h,y,_);await this._updatingHandles.addPromise(this._addPositionData(e,b,h.length,r[0],i,s))}_acquireRenderer(t,e,r){const i=vk.getKey(t,e,r);let s=this._renderers.get(i);return C(this._strokesTexture)&&(this._strokesTexture=D_t(this.rctx)),s||(s=new vk(this.rctx,this.techniqueRepository,{type:t,hasSlicePlane:e,strokesTexture:this._strokesTexture,legacy:r,spherical:this.viewingMode===Be.Global}),this._renderers.set(i,s)),++s.refCount,s}_removeRenderable(t){Jle(t.regular),Jle(t.silhouette);const e=this._renderers.get(t.rendererKey);if(e){e.removeRenderable(t),--e.refCount,"origin"in t.transform&&this._localOrigins.release(t.transform.origin),this._gpuMemoryUsage-=t.statistics.externalMemoryUsage?0:t.statistics.gpuMemoryUsage;for(const r of t.components.meta)t.components.buffer.releaseIndex(r.index)}}_updateObjectCameraDistances(t){const e=t.camera.eye,r=t.camera.viewForward,i=M(),s=n=>{to(i,n.center,e);const o=ye(i,r),a=n.radius,l=o<-a?1/0:o<a?0:o-a;n.renderables.forEach(c=>c.distanceToCamera=l)};this._perObjectData.forEach(s),this._perObjectDataEvictionCache.forEach(s)}_renderRegularEdges(t,e,r){const i=t.bindRegularEdges(r,e),s=r.transparency,n=e.camera.perScreenPixelRatio;t.forEachRenderable(o=>{if(!Qle(o)||!o.visible)return;const a=L$(o.regular.lod.lengths,o.distanceToCamera,n);t.renderRegularEdges(i,o,r,e,a)},s)}_renderSilhouetteEdges(t,e,r){const i=t.bindSilhouetteEdges(r,e),s=r.transparency,n=e.camera.perScreenPixelRatio;t.forEachRenderable(o=>{if(!ece(o)||!o.visible)return;const a=L$(o.silhouette.lod.lengths,o.distanceToCamera,n);t.renderSilhouetteEdges(i,o,r,e,a)},s)}get test(){return{hasRenderedPrimitives:t=>{let e=!1;const r=t.perScreenPixelRatio,i=(s,n)=>s.forEachRenderable(o=>{o.visible&&!e&&(Qle(o)&&(e=L$(o.regular.lod.lengths,o.distanceToCamera,r)>0),!e&&ece(o)&&(e=L$(o.silhouette.lod.lengths,o.distanceToCamera,r)>0))},n);return this._renderers.forEach(s=>{e||(i(s,rr.OPAQUE),i(s,rr.TRANSPARENT))}),e}}}};function Jle(t){v(t)&&(t.vao.vertexBuffers.instances.dispose(),t.vao.dispose(!1),t.vao=null)}function k_t(t){let e=null,r=null;for(let i=0;i<t.geometries.length;i++){const s=t.geometries[i];if(s.material.supportsEdges){if(e){if(!Xg(e,s.transformation))return!1}else e=s.transformation;if(!r&&v(s.localOrigin))r=s;else if(r&&v(r.localOrigin)&&v(s.localOrigin)&&r.localOrigin.id!==s.localOrigin.id)return!1}}return!0}u([d({constructOnly:!0})],Id.prototype,"rctx",void 0),u([d({constructOnly:!0})],Id.prototype,"renderSR",void 0),u([d({constructOnly:!0})],Id.prototype,"viewingMode",void 0),u([d({constructOnly:!0})],Id.prototype,"techniqueRepository",void 0),u([d({constructOnly:!0})],Id.prototype,"setNeedsRender",void 0),u([d({constructOnly:!0})],Id.prototype,"schedule",void 0),u([d({readOnly:!0})],Id.prototype,"_updatingHandles",void 0),u([d({readOnly:!0})],Id.prototype,"updating",null),Id=u([I("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],Id);class Kle{constructor(e,r,i){this.center=r,this.radius=i,this.renderables=new Array,this.loaded=e,this.loaded.then(()=>{this.loaded!=null&&(this.loaded=!0)})}}class V_t{constructor(e,r){this.buffer=e,this.meta=r}}let B_t=class{constructor(e,r){this.vao=e,this.lod=r}};class z_t{constructor(e,r){this.modelMatrix=e,this.origin=r}}class G_t{constructor(e,r,i,s,n,o,a,l){this.regular=e,this.silhouette=r,this.statistics=i,this.transform=s,this.edgeTransparency=n,this.objectTransparency=o,this.components=a,this.rendererKey=l,this.distanceToCamera=0,this.visible=!0}}function Qle(t){return v(t.regular)}function ece(t){return v(t.silhouette)}function L$(t,e,r){const i=e*r,s=yAe(t,i,!0);return s===-1?i<t[0]?t.length:0:t.length-s}let tce=class{constructor(e,r,i,s){this.position=e,this.indices=r,this.modelTransform=i,this.origin=s}};const rce=es();function Sm(t){return window.WebGL2RenderingContext&&t instanceof window.WebGL2RenderingContext}let ice=class{constructor(e,r,i,s,n,o,a,l,c){this.createQuery=e,this.deleteQuery=r,this.resultAvailable=i,this.getResult=s,this.disjoint=n,this.beginTimeElapsed=o,this.endTimeElapsed=a,this.createTimestamp=l,this.timestampBits=c}},_g=!1;function j_t(t,e){if(e.disjointTimerQuery)return null;let r=t.getExtension("EXT_disjoint_timer_query_webgl2");return r&&Sm(t)?new ice(()=>t.createQuery(),i=>{t.deleteQuery(i),_g=!1},i=>t.getQueryParameter(i,t.QUERY_RESULT_AVAILABLE),i=>t.getQueryParameter(i,t.QUERY_RESULT),()=>t.getParameter(r.GPU_DISJOINT_EXT),i=>{_g||(_g=!0,t.beginQuery(r.TIME_ELAPSED_EXT,i))},()=>{t.endQuery(r.TIME_ELAPSED_EXT),_g=!1},i=>r.queryCounterEXT(i,r.TIMESTAMP_EXT),()=>t.getQuery(r.TIMESTAMP_EXT,r.QUERY_COUNTER_BITS_EXT)):(r=t.getExtension("EXT_disjoint_timer_query"),r?new ice(()=>r.createQueryEXT(),i=>{r.deleteQueryEXT(i),_g=!1},i=>r.getQueryObjectEXT(i,r.QUERY_RESULT_AVAILABLE_EXT),i=>r.getQueryObjectEXT(i,r.QUERY_RESULT_EXT),()=>t.getParameter(r.GPU_DISJOINT_EXT),i=>{_g||(_g=!0,r.beginQueryEXT(r.TIME_ELAPSED_EXT,i))},()=>{r.endQueryEXT(r.TIME_ELAPSED_EXT),_g=!1},i=>r.queryCounterEXT(i,r.TIMESTAMP_EXT),()=>r.getQueryEXT(r.TIMESTAMP_EXT,r.QUERY_COUNTER_BITS_EXT)):null)}function H_t(t,e){const r=t.capabilities.disjointTimerQuery;return C(r)?null:new q_t(r,e)}let q_t=class{constructor(e,r){this._timer=e,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,r.forEach(i=>{const s=this._timer.createQuery(),n=this._timer.createQuery();this._queryPool.push(s,n),this._queryResults.set(i,null)})}start(){_g||(this._currentQuery=this._queryPool.pop(),C(this._currentQuery)||(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}stop(e){if(this._timer.disjoint()||C(this._currentQuery)||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();const r=this._queryResults.get(e);if(C(r))return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(r))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;const i=this._timer.getResult(r)/1e6;return this._queryPool.unshift(r),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,i}abort(){v(this._currentQuery)&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}dispose(){v(this._currentQuery)&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach(e=>{this._timer.deleteQuery(e)}),this._queryResults.forEach(e=>{C(e)||this._timer.deleteQuery(e)})}};var Ai;(function(t){t.OVERLAY="overlay",t.PREPARE="prepare",t.SHADOW_MAP="shadow map",t.LINEAR_DEPTH="linear depth",t.ACCUMULATED_SHADOWS="accumulated shadows",t.NORMALS="normals",t.OBJECT_AND_LAYER_ID_COLOR="object/layer id color",t.SSAO="SSAO",t.OPAQUE="opaque",t.OPAQUE_EDGES="opaque edges",t.VOXEL="voxel",t.TRANSPARENT="transparent",t.TRANSPARENT_EDGES="transparent edges",t.HUD_VISIBILITY="HUD visibility",t.TRANSPARENT_TERRAIN="transparent terrain",t.ENVIRONMENT="environment",t.LASER_LINE="laser line",t.OCCLUDED="occluded",t.ANTIALIASING="antialiasing",t.HIGHLIGHTS="highlights",t.HUD="HUD",t.HUD_OCCLUDED="HUD occluded",t.FINISH="finish"})(Ai||(Ai={}));const sce="Total";let W_t=class{constructor(e){this._rctx=e,this._startTimeStampCPU=0,this._lastTimeStampCPU=0,this._totalCPUTime=new Ig(sce),this._cpuTimeSamplers=new Map(Object.values(Ai).map(r=>[r,new Ig(r)])),this._enableGPUTimer=0,this._totalGPUTime=new Ig("GPU"),this._gpuTimeSamplers=new Map(Object.values(Ai).map(r=>[r,new Ig(r)])),this._totalTime=0,this._totalFrameCount=0}get totalCPUTimeSampler(){return this._totalCPUTime}get cpuTimeSamplers(){return Array.from(this._cpuTimeSamplers.values())}get totalGPUTimeSampler(){return this._totalGPUTime}get gpuTimeSamplers(){return Array.from(this._gpuTimeSamplers.values())}get gpuSamplingEnabled(){return v(this._gpuTimerPool)}get totalTime(){return this._totalTime}get totalFrameCount(){return this._totalFrameCount}get elapsedTime(){return performance.now()-this._startTimeStampCPU}enableGPUPerformanceInfo(){if(C(this._gpuTimerPool)){const e=[...Object.values(Ai),sce];this._gpuTimerPool=H_t(this._rctx,e)}return C(this._gpuTimerPool)?{hasGPUTimerSupport:!1,remove:()=>{}}:(++this._enableGPUTimer,{hasGPUTimerSupport:!0,remove:HH(()=>{--this._enableGPUTimer,this._enableGPUTimer===0&&(this._gpuTimerPool=Qe(this._gpuTimerPool))})})}startFrame(){this._startTimeStampCPU=this._lastTimeStampCPU=performance.now(),v(this._gpuTimerPool)&&this._gpuTimerPool.start()}advance(e){const r=performance.now();if(this._cpuTimeSamplers.get(e).record(r-this._lastTimeStampCPU),this._lastTimeStampCPU=r,v(this._gpuTimerPool)){const i=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).record(i),this._gpuTimerPool.start()}}finishFrame(){if(v(this._gpuTimerPool)){const r=this._gpuTimerPool.stop(Ai.FINISH);this._gpuTimeSamplers.get(Ai.FINISH).record(r)}const e=performance.now()-this._startTimeStampCPU;this._totalTime=this._totalTime+e,this._totalCPUTime.record(e),v(this._gpuTimerPool)&&this._totalGPUTime.record(this.gpuTimeSamplers.reduce((r,i)=>r+(i.last||0),0)),++this._totalFrameCount}},su=class extends Te{get _bindParameters(){return this._renderContext.bindParameters}isFeatureEnabled(t,e=this._state){return It(this._renderStateFeatures.get(e,t),!1)}setFeatureEnabled(t,e,r){this._renderStateFeatures.set(e,t,r),this.notifyChange("_renderStateFeatures"),this._requestRender()}get _antialiasing(){return this._antialiasingEnabled||this.isFeatureEnabled(Bs.Antialiasing)}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(Bs.HighQualityTransparency)}get hasWaterReflection(){return this.hasWater&&(this._waterReflectionEnabled||this.isFeatureEnabled(Bs.WaterReflection))}get hasWater(){return this._hasWater||this._hasOverlayWater}constructor(t,e,r,i,s,n,o,a){super({}),this._stage=t,this._materialRepository=e,this._shaderTechniqueRepository=i,this._rctx=s,this._compositingHelper=n,this._magnifierHelper=o,this._requestRender=a,this._materialRenderers=new Jt,this._needsTransparentPass=!1,this._hasHUDElements=!1,this._hasHighlights=!1,this._hasWater=!1,this._hasOverlayWater=!1,this._renderOverlay=l=>{},this._isRendering=!1,this._fallbackDepthStencilTexture=null,this._sliceHelper=new e_t,this._state=Sr.IDLE,this._renderStateFeatures=Gie(),this._antialiasingEnabled=!0,this._highQualityTransparencyEnabled=!0,this._terrainRenderingEnabled=!0,this._terrainTransparency=On.Opaque,this._waterReflectionEnabled=!1,this._ssaoEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new u0t,this._handles=new ei,this._renderHiddenTransparentEdges=()=>{},this._oitUsed=!1,this._smaaPass=new P3(this._rctx,i),a(),this._offscreen=new M0t(this._rctx,this._compositingHelper),this.performanceInfo=new W_t(this._rctx),this._shadowMap=new UZ(this._rctx,t.viewingMode),this._ssaoHelper=new u2e(t.view,i,this._rctx,a),this._highlight=new C0t(i,this._rctx),this._shadowHighlight=new Q0t(this._rctx,t.viewingMode),this._shadowAccumulator=new Ol(this._rctx,i,t,l=>{const c=this.shadowsEnabled;this._shadowMap.enabled=!0,this._prepare(l.camera,l.contentCamera),this._renderPlugins.prepareRender(),this._shadowMap.enabled=c},(l,c,h)=>{l.shadowMap.start(l.camera,c,h),this._renderShadowCascades(k.Shadow,l.shadowMap),l.camera.setGLViewport(this._rctx),this._prepare(l.camera,l.contentCamera)},a),this._renderContext=new ont(this._rctx,this._offscreen,this._shadowMap,this._ssaoHelper,this._sliceHelper),this._renderPlugins=new $0t({renderContext:this._renderContext,techniqueRepository:i,textureRepository:r,materialRepository:this._materialRepository,requestRender:a,controller:t}),this.renderPassManager=new c0t(this._rctx,this._shaderTechniqueRepository),this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager),this._handles.add([ie(()=>this._stage.view.state.camera,()=>a(),js),ie(()=>qr.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES,l=>{this._renderHiddenTransparentEdges=l?()=>this._renderEdges(rr.TRANSPARENT):()=>{},a()},Vt),ie(()=>this._ssaoEnabled||this.isFeatureEnabled(Bs.SSAO),l=>this._ssaoHelper.enabled=l,js)])}normalizeCtorArgs(){return{}}destroy(){this._handles.destroy(),this._smaaPass.dispose(),this._gpuTimerHandle=ji(this._gpuTimerHandle),this._materialRenderers.forAll(t=>t.dispose()),this._materialRenderers.clear(),this._offscreen.dispose(),this._fallbackDepthStencilTexture=Qe(this._fallbackDepthStencilTexture),this._shadowMap.dispose(),this._ssaoHelper.dispose(),this._highlight.dispose(),this._shadowHighlight.dispose(),this._shadowAccumulator.dispose(),ibe.prune()}disposeOffscreenBuffers(){this._offscreen.dispose(),this._shadowMap.disposeOffscreenBuffers(),this._smaaPass.disable(),this._ssaoHelper.disposeOffscreenBuffers()}get updating(){return this._antialiasing&&this._smaaPass.updating||v(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}ensureEdgeView(){return C(this._edgeView)&&(this._edgeView=new Id({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:t=>this._stage.view.resourceController.immediate.schedule(t)}),this._handles.add(ie(()=>so(this._edgeView,t=>t.updating),()=>this._requestRender(),ri)),this._requestRender()),this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return mW(this._bindParameters.ssr.reprojectionMatrix,Lu)}set _reprojectionMatrix(t){UH(this._bindParameters.ssr.reprojectionMatrix,t)&&this.notifyChange("isCameraFinal")}get shadowsEnabled(){var t;return!!((t=this._shadowMap)!=null&&t.enabled)}setParameters(t){const{_shadowMap:e,_bindParameters:r}=this;if(t.screenSpaceReflectionsEnabled!==void 0&&r.ssr.enabled!==t.screenSpaceReflectionsEnabled&&(r.ssr.enabled=t.screenSpaceReflectionsEnabled,this._requestRender()),t.shadowMap!==void 0&&this._shadowMap.enabled!==t.shadowMap&&(this._shadowMap.enabled=t.shadowMap,this._requestRender()),t.shadowMapMaxCascades!==void 0&&e.maxCascades!==t.shadowMapMaxCascades&&(e.maxCascades=t.shadowMapMaxCascades,this._requestRender()),v(t.environment)){v(t.environment.weather)&&(this._bindParameters.weather=t.environment.weather,this._bindParameters.weatherVisible=!!t.weatherVisible),t.environment.lighting.ambientOcclusionEnabled!==void 0&&this._ssaoEnabled!==t.environment.lighting.ambientOcclusionEnabled&&(this._ssaoEnabled=t.environment.lighting.ambientOcclusionEnabled,this._requestRender()),t.environment.lighting.waterReflectionEnabled!==void 0&&this._waterReflectionEnabled!==t.environment.lighting.waterReflectionEnabled&&(this._waterReflectionEnabled=t.environment.lighting.waterReflectionEnabled,this._requestRender());const i=t.environment.lighting.type!=="virtual";r.enableFillLights!==i&&(r.enableFillLights=i,this._requestRender())}t.background&&this._offscreen.background!==t.background&&(this._offscreen.background=t.background,this._requestRender()),t.antialiasingEnabled!==void 0&&this._antialiasingEnabled!==t.antialiasingEnabled&&(this._antialiasingEnabled=t.antialiasingEnabled,this._requestRender()),t.highQualityTransparency!==void 0&&this._highQualityTransparencyEnabled!==t.highQualityTransparency&&(this._highQualityTransparencyEnabled=t.highQualityTransparency,this._requestRender()),t.defaultHighlightOptions!==void 0&&(this._highlight.setDefaultOptions(t.defaultHighlightOptions),this._shadowHighlight.setDefaultOptions(t.defaultHighlightOptions),this._requestRender()),t.overlays!==void 0&&this._bindParameters.overlays!==t.overlays&&(this._bindParameters.overlays=t.overlays,this._requestRender()),t.hasOverlayWater!==void 0&&this._hasOverlayWater!==t.hasOverlayWater&&(this._hasOverlayWater=t.hasOverlayWater,this._requestRender()),t.renderOverlay!==void 0&&this._renderOverlay!==t.renderOverlay&&(this._renderOverlay=t.renderOverlay,this._requestRender()),t.slicePlane!==void 0&&this._sliceHelper.plane!==t.slicePlane&&(this._sliceHelper.plane=t.slicePlane,this._requestRender()),t.terrainRenderingEnabled!==void 0&&this._terrainRenderingEnabled!==t.terrainRenderingEnabled&&(this._terrainRenderingEnabled=t.terrainRenderingEnabled,this._requestRender()),t.terrainTransparency!==void 0&&this._terrainTransparency!==t.terrainTransparency&&(this._terrainTransparency=t.terrainTransparency,this._requestRender()),t.shadowCastOptions!==void 0&&this._shadowAccumulator.setOptions(t.shadowCastOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get renderPlugins(){return this._renderPlugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}modify(t,e){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:r,removes:i,updates:s}=t;if(r.length===0&&i.length===0&&s.length===0)return;const n=HTe(t);let o=!1;n.forEach((a,l)=>{if(e.done)return;let c=this._materialRenderers.find(h=>h.material===l);C(c)&&a.adds.length>0&&(c=new i2e(this._rctx,this._materialRepository,l),this._materialRenderers.push(c)),c&&(c.modify(a),c.isEmpty&&(o=!0)),a.removes.forEach(h=>t.removes.removeUnordered(h)),a.adds.forEach(h=>t.adds.removeUnordered(h)),a.updates.forEach(h=>t.updates.removeUnordered(h)),e.madeProgress()}),o&&this._materialRenderers.filterInPlace(a=>!a.isEmpty||(a.dispose(),!1)),this._hasHighlights=this._materialRenderers.some(a=>a.hasHighlights),this._bindParameters.hasOccludees=this._materialRenderers.some(a=>a.hasOccludees),this._hasWater=this._materialRenderers.some(a=>a.hasWater),this._hasHUDElements=this._materialRenderers.some(a=>a.requiresSlot(Se.LINE_CALLOUTS_HUD_DEPTH,k.Color)||a.requiresSlot(Se.HUD_MATERIAL,k.Color)||a.requiresSlot(Se.LABEL_MATERIAL,k.Color)),this._requestRender()}updateAnimation(t){const e=this._hasAnimations;return this._hasAnimations=!1,this._materialRenderers.forAll(r=>this._hasAnimations=r.updateAnimation(t)||this._hasAnimations),this._hasAnimations=this._renderPlugins.updateAnimation(t)||this._hasAnimations,this._hasAnimations!==e&&(this._gpuTimerHandle=e?ji(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}render(t,e,r,i,s){this._isRendering=!0,this.performanceInfo.startFrame();const{camera:n,contentCamera:o,mode:a}=r;this._state=a,this._renderOverlay(s),this.performanceInfo.advance(Ai.OVERLAY),this._renderContext.time=s,this._bindParameters.transparencyPassType=xt.NONE;const l=this._offscreen;l.setupRenderTarget(this.hasWaterReflection);const c=uy(this._sliceHelper.plane);i===Rw.OFF&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(t),n.setGLViewport(this._rctx),this._prepare(n,o),this._renderPlugins.prepareRender(),this.performanceInfo.advance(Ai.PREPARE);const h=this._computeDepthRange(n);this._renderShadowMap(t,n,this._bindParameters.lighting.mainLight.direction,h),this.performanceInfo.advance(Ai.SHADOW_MAP),l.initializeFrame(n),this._ensureBindParameters(n,o),this._renderLinearDepth(),this.performanceInfo.advance(Ai.LINEAR_DEPTH),this._accumulateShadows(h,n,o),this.performanceInfo.advance(Ai.ACCUMULATED_SHADOWS),this._renderNormal(),this.performanceInfo.advance(Ai.NORMALS),this._ensureBindParametersSSR(s),this._renderSSAO(s),this.performanceInfo.advance(Ai.SSAO),this._renderContext.output=k.Color,l.bindFramebuffer(),this._renderOpaqueGeometry(),this.performanceInfo.advance(Ai.OPAQUE);const p=this._terrainRenderingEnabled&&(this._terrainTransparency===On.Semitransparent||this._terrainTransparency===On.TransparentWithDraped),f=this._highQualityTransparency&&p;this._renderTerrainLinearDepth(f),this._setMultipassEnabled(f),this._setTerrainCulling(f),this._renderEdges(rr.OPAQUE),this.performanceInfo.advance(Ai.OPAQUE_EDGES),this._offscreen.bindTarget(this._offscreen.currentColorTarget,this._offscreen.mainDepth),this._renderSlot(Se.VOXEL),this.performanceInfo.advance(Ai.VOXEL),this._renderHiddenTransparentEdges();const m=this._needsTransparentPass||this._renderPlugins.needsTransparentPass;m&&(this._oitEnabled?this._renderOrderIndependentTransparency(()=>this._renderTransparentGeometry(),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(Ai.TRANSPARENT),this._renderGeometryLinearDepth(f);const y=this._renderHUDVisibility(f);f||this._renderInternalSlot(Se.LINE_CALLOUTS),this.performanceInfo.advance(Ai.HUD_VISIBILITY),this._renderObjectAndLayerIdColor(e),this.performanceInfo.advance(Ai.OBJECT_AND_LAYER_ID_COLOR),this._renderEdges(rr.TRANSPARENT,f),this.performanceInfo.advance(Ai.TRANSPARENT_EDGES),this._renderTransparentTerrain(),p&&y&&(f?this._renderLineCallouts(cu.Occluded):l.compositeTransparentTerrainOntoHUDVisibility(this._bindParameters),this._renderHUD(cu.Occluded,l.framebuffer),this.performanceInfo.advance(Ai.HUD_OCCLUDED)),this.performanceInfo.advance(Ai.TRANSPARENT_TERRAIN),this._setTerrainCulling(!1),p&&(l.compositeTransparentTerrainOntoMain(this._bindParameters),f&&(this._renderEdges(rr.OPAQUE),this.performanceInfo.advance(Ai.OPAQUE_EDGES),m&&(this._oitEnabled?this._renderOrderIndependentTransparency(()=>this._renderTransparentGeometry(),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(Ai.TRANSPARENT),this._renderEdges(rr.TRANSPARENT),this.performanceInfo.advance(Ai.TRANSPARENT_EDGES))),f&&this._renderLineCallouts(cu.NotOccluded),this._setMultipassEnabled(!1),this._shadowAccumulator.render(this._bindParameters),l.renderToTargets(()=>{this._renderInternalSlot(Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._renderSlot(Se.POSTPROCESSING_ENVIRONMENT_TRANSPARENT),this._renderSlot(Se.LASERLINES)},l.currentColorTarget,l.mainDepth),this.performanceInfo.advance(Ai.ENVIRONMENT),this._renderPlugins.needsLaserlineWithContrastControl&&l.renderTmpAndCompositeToMain(()=>this._renderSlot(Se.LASERLINES_CONTRAST_CONTROL),this._bindParameters,da.PremultipliedAlpha),this.performanceInfo.advance(Ai.LASER_LINE),this._renderOccluded(),this.performanceInfo.advance(Ai.OCCLUDED);const _=i===Rw.ON&&this._magnifierHelper.enabled,b=_&&C(t)?this._offscreen.getFramebuffer(this._offscreen.tmpColor,this._offscreen.tmpDepth):t;this._rctx.bindFramebuffer(b);const x=this._offscreen.colorTexture;!this._renderAntiAliasing(x)&&v(x)&&this._compositingHelper.composite(this._bindParameters,x,da.None),this.performanceInfo.advance(Ai.ANTIALIASING),this._renderHUD(cu.NotOccluded,b),this.performanceInfo.advance(Ai.HUD),this._renderHighlights(b,this._bindParameters),this.performanceInfo.advance(Ai.HIGHLIGHTS),_&&this._magnifierHelper.render(this._rctx,this._bindParameters),b!==t&&(this._rctx.bindFramebuffer(t),this._compositingHelper.composite(this._bindParameters,this._offscreen.tmpColorTexture,da.None)),this._disposeOITBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this._sliceHelper.plane=c,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.finishFrame()}_renderObjectAndLayerIdColor(t){if(v(t)&&de("enable-feature:objectAndLayerId-rendering")){const e=this._renderContext.output;this._rctx.bindFramebuffer(t),this._offscreen.renderToFBO(()=>this._renderGeometryAndTransparentTerrainPass(k.ObjectAndLayerIdColor),[0,0,0,0],!0,!0),this._rctx.bindFramebuffer(t),this._offscreen.renderToFBO(()=>{this._bindParameters.renderTransparentlyOccludedHUD=cu.NotOccluded,this._renderInternalSlot(Se.HUD_MATERIAL)},void 0,!0,!0),this._renderContext.output=e}}finish(t){this._hasAnimations||this._animationTimestep.clear();const e=this.performanceInfo.gpuSamplingEnabled,r=t===Ps.BACKGROUND;if(r||e){const i=r?this.performanceInfo.elapsedTime:0,s=e?this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError(),n=Math.max(i,s);this._animationTimestep.frame(n,r)}}readDepthPixels(t,e,r){const i=this._offscreen.bindTarget(this._offscreen.linearDepth,this._offscreen.tmpDepth);if(!this._needsLinearDepth){this._ensureBindParameters(t,t),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const s=Li.COLOR_BUFFER_BIT|Li.DEPTH_BUFFER_BIT|Li.STENCIL_BUFFER_BIT;this._rctx.clearSafe(s),this._renderGeometryAndTransparentTerrainPass(k.Depth)}i.readPixels(e[0],e[1],e[2],e[3],Ve.RGBA,Lt.UNSIGNED_BYTE,r)}readHUDVisibility(t,e,r,i,s){this._offscreen.bindTarget(this._offscreen.hudVisibility).readPixels(t,e,r,i,Ve.RGBA,Lt.UNSIGNED_BYTE,s)}readAccumulatedShadow(t){return this._shadowAccumulator.readAccumulatedShadow(t[0],t[1])}_setMultipassEnabled(t){this._bindParameters.multipassTerrain.enabled=this._bindParameters.multipassGeometry.enabled=t}_setTerrainCulling(t){this._bindParameters.multipassTerrain.cullAboveGround=t}_renderSlot(t){this._bindParameters.slot=t,this._renderPlugins.render()}_renderEdges(t,e=!1){const r=this._edgeView;v(r)&&r.shouldRender()&&this._offscreen.renderTmpAndCompositeToMain(()=>r.render(this._bindParameters,t),this._bindParameters,da.Alpha,e)}_renderShadowMap(t,e,r,i){const s=this._shadowMap;s.enabled&&this.isFeatureEnabled(Bs.ShadowMapUpdate)&&(s.start(e,r,i),this._shadowHighlight.updateParameters(e,r),this._needsShadowHighlight?(this._renderShadowCascades(k.ShadowHighlight,this._shadowMap,n=>s.takeCascadeSnapshotTo(n,cE.Highlight)),s.clear(),this._renderShadowCascades(k.ShadowExcludeHighlight,this._shadowMap,n=>{s.takeCascadeSnapshotTo(n,cE.Default),this._renderGeometryAndTransparentTerrainPass(k.ShadowHighlight)})):this._renderShadowCascades(k.Shadow),s.finish(t),e.setGLViewport(this._rctx))}_renderShadowCascades(t,e=this._shadowMap,r=i=>{}){for(const i of e.cascades)i.camera.setGLViewport(this._rctx),this._prepare(i.camera,i.camera),this._renderGeometryAndTransparentTerrainPass(t),r(i)}get _needsLinearDepth(){return this._ssaoHelper.active||this._renderPlugins.needsLinearDepth||this.hasWaterReflection||this._needsShadowHighlight||this._needsShadowCast}_renderLinearDepth(){this._needsLinearDepth?this._offscreen.renderToTargets(()=>this._renderGeometryAndTransparentTerrainPass(k.Depth),this._offscreen.linearDepth,this._offscreen.tmpDepth,[0,0,0,0],!0,!0):this._offscreen.disposeTarget(this._offscreen.linearDepth),this._bindParameters.linearDepthTexture=this._offscreen.linearDepthTexture}_renderTerrainLinearDepth(t){if(t){const e=this._renderContext.output;this._renderContext.output=k.Depth,this._offscreen.renderToTargets(()=>this._renderTransparentTerrain(),this._offscreen.terrainLinearDepth,this._offscreen.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.output=e}else this._offscreen.disposeTarget(this._offscreen.terrainLinearDepth);this._bindParameters.multipassTerrain.linearDepthTexture=this._offscreen.terrainLinearDepthTexture}_renderGeometryLinearDepth(t){if(t){const e=this._renderContext.output;this._offscreen.renderToTargets(()=>this._renderGeometryPass(k.Depth),this._offscreen.geometryLinearDepth,this._offscreen.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.output=e}else this._offscreen.disposeTarget(this._offscreen.geometryLinearDepth);this._bindParameters.multipassGeometry.linearDepthTexture=this._offscreen.geometryLinearDepthTexture}get _needsNormal(){return this._ssaoHelper.active}_renderNormal(){this._needsNormal?this._offscreen.renderToTargets(()=>{this._renderGeometryAndTransparentTerrainPass(k.Normal)},this._offscreen.normal,this._offscreen.tmpDepth,[0,0,0,0],!0,!0):this._offscreen.disposeTarget(this._offscreen.normal)}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowCast}_computeDepthRange(t){if(!this._needsDepthRange)return SH;const e=qyt(t,this._materialRenderers,this._stage.layers);return fE(e,this.renderPlugins.queryDepthRange(t)),e.near=Math.max(t.near,e.near),e.far=Math.min(t.far,e.far),e}_renderGeometryAndTransparentTerrainPass(t){this._renderContext.output=t,this._renderGeometryPass(t),this._renderTransparentTerrain()}_renderGeometryPass(t){this._renderContext.output=t,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderSSAO(t){this._ssaoHelper.render(this._bindParameters,t,this._offscreen.linearDepthTexture,this._offscreen.normalTexture)}_renderOpaqueGeometry(){this._renderSlot(Se.INTEGRATED_MESH),this._renderSlot(Se.OPAQUE_TERRAIN),this._renderInternalSlot(Se.OPAQUE_MATERIAL),this._renderSlot(Se.OPAQUE_MATERIAL),this._renderSlot(Se.POSTPROCESSING_ENVIRONMENT_OPAQUE)}_renderTransparentGeometry(){this._renderInternalSlot(Se.TRANSPARENT_MATERIAL),this._renderSlot(Se.TRANSPARENT_MATERIAL)}_renderTransparentTerrain(){this._renderSlot(Se.TRANSPARENT_TERRAIN)}_renderHUDVisibility(t){let e=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility(()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper.hudVisibilityTexture,e=this._renderInternalSlot(Se.OCCLUSION_PIXELS)},t),e}_renderLineCallouts(t){this._bindParameters.renderTransparentlyOccludedHUD=t,t===cu.Occluded?this._offscreen.renderToTargets(()=>this._renderInternalSlot(Se.LINE_CALLOUTS),this._offscreen.currentColorTarget,this._offscreen.tmpDepth,void 0,!0,!0):this._renderInternalSlot(Se.LINE_CALLOUTS)}_renderHUD(t,e){this._hasHUDElements&&(this._oitEnabled?(this._renderOrderIndependentTransparency(()=>this._renderHUDElements(t),!0),this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._bindParameters,this._offscreen.hudColorTexture,da.PremultipliedAlpha)):t===cu.Occluded?this._offscreen.renderToTargets(()=>this._renderHUDElements(cu.Occluded),this._offscreen.currentColorTarget,this._offscreen.tmpDepth,void 0,!0,!0):this._renderHUDElements(t))}_renderHUDElements(t){this._bindParameters.renderTransparentlyOccludedHUD=t,this._renderInternalSlot(Se.LINE_CALLOUTS_HUD_DEPTH),this._renderInternalSlot(Se.HUD_MATERIAL),this._renderInternalSlot(Se.LABEL_MATERIAL)}get _needsHighlight(){return this._hasHighlights||this._renderPlugins.needsHighlight}get _needsShadowHighlight(){return this._shadowMap.enabled&&this._shadowHighlight.isVisible&&this._needsHighlight}_renderHighlights(t,e){if(!this._needsHighlight)return void this._offscreen.disposeTarget(this._offscreen.highlight);const r=this._highlight,i=this._offscreen.renderToTargets(()=>{this._renderGeometryAndTransparentTerrainPass(k.Highlight),this._rctx.clearSafe(Li.DEPTH_BUFFER_BIT),this._renderHUDElements(cu.Both)},this._offscreen.highlight,this._offscreen.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=i.colorTexture,this._needsShadowHighlight&&this._shadowHighlight.render(e,t),r.render(this._bindParameters,i,t)}get _needsShadowCast(){return this._shadowAccumulator.isAccumulating}_accumulateShadows(t,e,r){this._needsShadowCast&&v(this._offscreen.linearDepthTexture)&&this._shadowAccumulator.renderAccumulation(this._offscreen.linearDepthTexture,t,e,r)}_renderOrderIndependentTransparency(t,e){const r=s=>{this._bindParameters.transparencyPassType=s,this._offscreen.renderOITPass(()=>t(),s,e)},i=this._renderContext.output;this._renderContext.output=k.Alpha,r(xt.Alpha),this._renderContext.output=k.Color,r(xt.Color),r(xt.FrontFace),this._offscreen.compositeTransparentOntoOpaque(this._bindParameters,e),this._bindParameters.transparencyPassType=xt.NONE,this._renderContext.output=i,this._oitUsed=!0}_disposeOITBuffers(){this._oitUsed||(this._offscreen.disposeTarget(this._offscreen.alphaFloatTarget),this._offscreen.disposeTarget(this._offscreen.colorFloatTarget),this._offscreen.disposeTarget(this._offscreen.frontFaceTarget)),this._oitUsed=!1}_renderOccluded(){let t=0;hd.clear(),this._materialRenderers.forAll(n=>{n.material&&n.material.isVisible()&&n.material.renderOccluded===ns.OccludeAndTransparentStencil&&(t|=n.material.renderOccluded,hd.push(n))});const e=this._offscreen,r=(n,o,a,l,c)=>{t&o&&(e.renderToTargets(a,e.tmpColor,e.mainDepth,[0,0,0,0],l,c),e.compositeOccludedOntoMain(this._bindParameters,n))};hd.length!==0&&(this._renderInternalSlot(Se.OCCLUDER_MATERIAL,hd),r(.5,ns.OccludeAndTransparentStencil,()=>this._renderInternalSlot(Se.TRANSPARENT_OCCLUDER_MATERIAL,hd),!1,!1)),hd.clear(),this._materialRenderers.forAll(n=>{n.material&&n.material.isVisible()&&(n.material.renderOccluded===ns.OccludeAndTransparent||n.material.renderOccluded===ns.Transparent||n.material.renderOccluded===ns.Opaque)&&(t|=n.material.renderOccluded,hd.push(n))});const i=this._renderPlugins.renderOccludedFlags;if(t|=i,!t)return;const s=n=>{this._renderContext.renderOccludedMask=n,i>ns.Occlude&&this._renderSlot(Se.OCCLUDED_TERRAIN),this._renderInternalSlot(Se.OPAQUE_MATERIAL,hd),this._renderInternalSlot(Se.TRANSPARENT_MATERIAL,hd),this._renderInternalSlot(Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,hd),this._renderContext.resetRenderOccludedMask()};this._renderContext.output=k.Color,r(.5,ns.OccludeAndTransparent,()=>s(ns.OccludeAndTransparent),!0,zl.OutlineVisualElementMask),r(.5,ns.Transparent,()=>s(ns.Transparent),!0,zl.OutlineVisualElementMask),r(1,ns.Opaque,()=>s(ns.Opaque),!0,zl.OutlineVisualElementMask),hd.clear()}_renderAntiAliasing(t){if(this._antialiasing){if(this._smaaPass.enable(()=>this._requestRender())&&v(t))return this._smaaPass.render(t),!0}else this._smaaPass.disable();return!1}_prepare(t,e){this._needsTransparentPass=this._materialRenderers.some(r=>r.requiresSlot(Se.TRANSPARENT_MATERIAL,k.Color)),this._bindParameters.camera=t,this._bindParameters.contentCamera=e}_ensureBindParameters(t,e){this._bindParameters.camera=t,this._bindParameters.contentCamera=e;const r=this._renderContext.offscreenRenderingHelper;this._bindParameters.hudVisibilityTexture=r.hudVisibilityTexture,this._bindParameters.mainColorTexture=r.mainColorTexture,this._bindParameters.highlightDepthTexture=r.depthTexture??this._getFallbackDepthTexture()}_ensureBindParametersSSR(t){if(this._bindParameters.ssr.enabled=this.hasWaterReflection,this._bindParameters.ssr.enabled){C(this._waterReflectionEnableTime)&&(this._waterReflectionEnableTime=t),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=Lu:(Oo(oce,this._bindParameters.camera.viewMatrix),Oo(nce,this._bindParameters.camera.projectionMatrix),gs(pT,oce,nce),gs(pT,this._renderContext.lastFrameCamera.viewMatrix,pT),gs(pT,this._renderContext.lastFrameCamera.projectionMatrix,pT),this._reprojectionMatrix=pT),this._bindParameters.ssr.lastFrameColorTexture=this._offscreen.lastFrameColorTexture;const e=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=e>0?Math.min(e,t-this._waterReflectionEnableTime)/e:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._bindParameters.ssr.lastFrameColorTexture=null,this._waterReflectionEnableTime=null}_renderInternalSlot(t,e=this._materialRenderers){let r=!1;return this._bindParameters.slot=t,e.forAll(i=>{i.material.shouldRender(this._renderContext)&&i.render(this._renderContext.output,this._bindParameters)&&(r=!0)}),r}_getFallbackDepthTexture(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=t1e(this._rctx)),this._fallbackDepthStencilTexture}get gpuMemoryUsage(){var t,e,r,i,s;return{offscreen:((t=this._offscreen)==null?void 0:t.gpuMemoryUsage)??0,highlights:(((e=this._highlight)==null?void 0:e.gpuMemoryUsage)??0)+(((r=this._shadowHighlight)==null?void 0:r.gpuMemoryUsage)??0),shadows:((i=this._shadowMap)==null?void 0:i.gpuMemoryUsage)??0,ssao:((s=this._ssaoHelper)==null?void 0:s.gpuMemoryUsage)??0}}get test(){const t=this;return{offscreen:this._offscreen,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlight,lighting:this._bindParameters.lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,weatherIsFading:this._bindParameters.cloudsFade.isFading,resetRenderStateFeatures:()=>{t._renderStateFeatures=Gie()},getFramebufferTexture:e=>{switch(e){case n_.Color:return t._offscreen.colorTexture;case n_.LinearDepth:return t._offscreen.linearDepthTexture;case n_.Normals:return t._offscreen.normalTexture;case n_.ShadowMap:return t._shadowMap.depthTexture;case n_.HudVisibility:return t._offscreen.hudVisibilityTexture;case n_.Highlight:return t._offscreen.highlightTexture}}}}};var n_;u([d()],su.prototype,"_shadowAccumulator",void 0),u([d()],su.prototype,"_state",void 0),u([d()],su.prototype,"_renderStateFeatures",void 0),u([d()],su.prototype,"_antialiasingEnabled",void 0),u([d({readOnly:!0})],su.prototype,"_antialiasing",null),u([d()],su.prototype,"_ssaoEnabled",void 0),u([d()],su.prototype,"_smaaPass",void 0),u([d({autoDestroy:!0})],su.prototype,"_edgeView",void 0),u([d()],su.prototype,"updating",null),u([d()],su.prototype,"isCameraFinal",null),su=u([I("esri.views.3d.webgl-engine.lib.Renderer")],su),function(t){t[t.Color=0]="Color",t[t.LinearDepth=1]="LinearDepth",t[t.Normals=2]="Normals",t[t.ShadowMap=3]="ShadowMap",t[t.HudVisibility=4]="HudVisibility",t[t.Highlight=5]="Highlight"}(n_||(n_={}));const hd=new Jt,nce=Ie(),oce=Ie(),pT=Ie();let ace=class{constructor(){this.blend=!1,this.blendColor={r:0,g:0,b:0,a:0},this.blendFunction={srcRGB:Ee.ONE,dstRGB:Ee.ZERO,srcAlpha:Ee.ONE,dstAlpha:Ee.ZERO},this.blendEquation={mode:cm.ADD,modeAlpha:cm.ADD},this.colorMask={r:!0,g:!0,b:!0,a:!0},this.faceCulling=!1,this.cullFace=Qd.BACK,this.frontFace=ZS.CCW,this.scissorTest=!1,this.scissorRect={x:0,y:0,width:0,height:0},this.depthTest=!1,this.depthFunction=Mi.LESS,this.clearDepth=1,this.depthWrite=!0,this.depthRange={zNear:0,zFar:1},this.viewport=null,this.stencilTest=!1,this.polygonOffsetFill=!1,this.polygonOffset=[0,0],this.stencilFunction={face:Qd.FRONT_AND_BACK,func:Mi.ALWAYS,ref:0,mask:1},this.clearStencil=0,this.stencilWriteMask=1,this.stencilOperation={face:Qd.FRONT_AND_BACK,fail:Ls.KEEP,zFail:Ls.KEEP,zPass:Ls.KEEP},this.clearColor={r:0,g:0,b:0,a:0},this.program=null,this.vertexBuffer=null,this.indexBuffer=null,this.uniformBuffer=null,this.pixelPackBuffer=null,this.pixelUnpackBuffer=null,this.copyReadBuffer=null,this.copyWriteBuffer=null,this.uniformBufferBindingPoints=new Array,this.readFramebuffer=null,this.drawFramebuffer=null,this.renderbuffer=null,this.activeTexture=0,this.textureUnitMap=new Array,this.vertexArrayObject=null}},X_t=class{constructor(e){this._allocations=new Map,e?Error.stackTraceLimit=1/0:(this.add=()=>{},this.remove=()=>{})}add(e){this._allocations.set(e,new Error().stack)}remove(e){this._allocations.delete(e)}get information(){let e="";if(this._allocations.size>0){e+=`${this._allocations.size} live object allocations:
`;const r=new Map;this._allocations.forEach(i=>{r.set(i,(r.get(i)??0)+1)}),r.forEach((i,s)=>{const n=s.split(`
`);n.shift(),n.shift(),e+=`${i}: ${n.shift()}
`,n.forEach(o=>e+=`   ${o}
`)})}return e}};const Y_t={RECORD_ALLOCATIONS:!1};let Z_t=class{constructor(){for(this._current=new Array,this._max=new Array,this._allocations=new X_t(Y_t.RECORD_ALLOCATIONS);this._current.length<Nn.COUNT;)this._current.push(0),this._max.push(0)}resetMax(){for(this._max.length=0;this._max.length<this._current.length;)this._max.push(0)}increment(e,r){const i=++this._current[e];this._max[e]=Math.max(i,this._max[e]),this._allocations.add(r)}decrement(e,r){--this._current[e],this._allocations.remove(r)}get max(){return this._max}get current(){return this._current}get total(){return this.current.reduce((e,r)=>e+r,0)}get resourceInformation(){let e="";if(this.total>0){e+=`Live objects:
`;for(let r=0;r<Nn.COUNT;++r){const i=this._current[r];i>0&&(e+=`${Nn[r]}: ${i}
`)}}return e+=this._allocations.information,e}};const J_t=["layout","centroid","smooth","case","mat2x2","mat2x3","mat2x4","mat3x2","mat3x3","mat3x4","mat4x2","mat4x3","mat4x4","uint","uvec2","uvec3","uvec4","samplerCubeShadow","sampler2DArray","sampler2DArrayShadow","isampler2D","isampler3D","isamplerCube","isampler2DArray","usampler2D","usampler3D","usamplerCube","usampler2DArray","coherent","restrict","readonly","writeonly","resource","atomic_uint","noperspective","patch","sample","subroutine","common","partition","active","filter","image1D","image2D","image3D","imageCube","iimage1D","iimage2D","iimage3D","iimageCube","uimage1D","uimage2D","uimage3D","uimageCube","image1DArray","image2DArray","iimage1DArray","iimage2DArray","uimage1DArray","uimage2DArray","image1DShadow","image2DShadow","image1DArrayShadow","image2DArrayShadow","imageBuffer","iimageBuffer","uimageBuffer","sampler1DArray","sampler1DArrayShadow","isampler1D","isampler1DArray","usampler1D","usampler1DArray","isampler2DRect","usampler2DRect","samplerBuffer","isamplerBuffer","usamplerBuffer","sampler2DMS","isampler2DMS","usampler2DMS","sampler2DMSArray","isampler2DMSArray","usampler2DMSArray","trunc","round","roundEven","isnan","isinf","floatBitsToInt","floatBitsToUint","intBitsToFloat","uintBitsToFloat","packSnorm2x16","unpackSnorm2x16","packUnorm2x16","unpackUnorm2x16","packHalf2x16","unpackHalf2x16","outerProduct","transpose","determinant","inverse","texture","textureSize","textureProj","textureLod","textureOffset","texelFetch","texelFetchOffset","textureProjOffset","textureLodOffset","textureProjLod","textureProjLodOffset","textureGrad","textureGradOffset","textureProjGrad","textureProjGradOffset"];var lce,$H={},K_t={get exports(){return $H},set exports(t){$H=t}};(lce=["precision","highp","mediump","lowp","attribute","const","uniform","varying","break","continue","do","for","while","if","else","in","out","inout","float","int","void","bool","true","false","discard","return","mat2","mat3","mat4","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4","sampler1D","sampler2D","sampler3D","samplerCube","sampler1DShadow","sampler2DShadow","struct","asm","class","union","enum","typedef","template","this","packed","goto","switch","default","inline","noinline","volatile","public","static","extern","external","interface","long","short","double","half","fixed","unsigned","input","output","hvec2","hvec3","hvec4","dvec2","dvec3","dvec4","fvec2","fvec3","fvec4","sampler2DRect","sampler3DRect","sampler2DRectShadow","sizeof","cast","namespace","using"])!==void 0&&(K_t.exports=lce);const Q_t=$H;var cce,LH={},evt={get exports(){return LH},set exports(t){LH=t}};cce=evt,function(t){var e=["<<=",">>=","++","--","<<",">>","<=",">=","==","!=","&&","||","+=","-=","*=","/=","%=","&=","^^","^=","|=","(",")","[","]",".","!","~","*","/","%","+","-","<",">","&","^","|","?",":","=",",",";","{","}"];e!==void 0&&(cce.exports=e)}();const uce=LH;var DH={},tvt={get exports(){return DH},set exports(t){DH=t}};(function(t){(function(e){var r=function(){return["abs","acos","all","any","asin","atan","ceil","clamp","cos","cross","dFdx","dFdy","degrees","distance","dot","equal","exp","exp2","faceforward","floor","fract","gl_BackColor","gl_BackLightModelProduct","gl_BackLightProduct","gl_BackMaterial","gl_BackSecondaryColor","gl_ClipPlane","gl_ClipVertex","gl_Color","gl_DepthRange","gl_DepthRangeParameters","gl_EyePlaneQ","gl_EyePlaneR","gl_EyePlaneS","gl_EyePlaneT","gl_Fog","gl_FogCoord","gl_FogFragCoord","gl_FogParameters","gl_FragColor","gl_FragCoord","gl_FragData","gl_FragDepth","gl_FragDepthEXT","gl_FrontColor","gl_FrontFacing","gl_FrontLightModelProduct","gl_FrontLightProduct","gl_FrontMaterial","gl_FrontSecondaryColor","gl_LightModel","gl_LightModelParameters","gl_LightModelProducts","gl_LightProducts","gl_LightSource","gl_LightSourceParameters","gl_MaterialParameters","gl_MaxClipPlanes","gl_MaxCombinedTextureImageUnits","gl_MaxDrawBuffers","gl_MaxFragmentUniformComponents","gl_MaxLights","gl_MaxTextureCoords","gl_MaxTextureImageUnits","gl_MaxTextureUnits","gl_MaxVaryingFloats","gl_MaxVertexAttribs","gl_MaxVertexTextureImageUnits","gl_MaxVertexUniformComponents","gl_ModelViewMatrix","gl_ModelViewMatrixInverse","gl_ModelViewMatrixInverseTranspose","gl_ModelViewMatrixTranspose","gl_ModelViewProjectionMatrix","gl_ModelViewProjectionMatrixInverse","gl_ModelViewProjectionMatrixInverseTranspose","gl_ModelViewProjectionMatrixTranspose","gl_MultiTexCoord0","gl_MultiTexCoord1","gl_MultiTexCoord2","gl_MultiTexCoord3","gl_MultiTexCoord4","gl_MultiTexCoord5","gl_MultiTexCoord6","gl_MultiTexCoord7","gl_Normal","gl_NormalMatrix","gl_NormalScale","gl_ObjectPlaneQ","gl_ObjectPlaneR","gl_ObjectPlaneS","gl_ObjectPlaneT","gl_Point","gl_PointCoord","gl_PointParameters","gl_PointSize","gl_Position","gl_ProjectionMatrix","gl_ProjectionMatrixInverse","gl_ProjectionMatrixInverseTranspose","gl_ProjectionMatrixTranspose","gl_SecondaryColor","gl_TexCoord","gl_TextureEnvColor","gl_TextureMatrix","gl_TextureMatrixInverse","gl_TextureMatrixInverseTranspose","gl_TextureMatrixTranspose","gl_Vertex","greaterThan","greaterThanEqual","inversesqrt","length","lessThan","lessThanEqual","log","log2","matrixCompMult","max","min","mix","mod","normalize","not","notEqual","pow","radians","reflect","refract","sign","sin","smoothstep","sqrt","step","tan","texture2D","texture2DLod","texture2DProj","texture2DProjLod","textureCube","textureCubeLod","texture2DLodEXT","texture2DProjLodEXT","textureCubeLodEXT","texture2DGradEXT","texture2DProjGradEXT","textureCubeGradEXT","textureSize","texelFetch"]}();r!==void 0&&(t.exports=r)})()})(tvt);const rvt=DH;var dd=999,hce=9999,wk=0,xk=1,dce=2,pce=3,fce=4,D$=5,ivt=6,svt=7,nvt=8,mce=9,ovt=10,gce=11,avt=["block-comment","line-comment","preprocessor","operator","integer","float","ident","builtin","keyword","whitespace","eof","integer"];function lvt(){var t,e,r,i=0,s=0,n=dd,o=[],a=[],l=1,c=0,h=0,p=!1,f=!1,m="";return function(G){return a=[],G!==null?_(G.replace?G.replace(/\r\n/g,`
`):G):b()};function y(G){G.length&&a.push({type:avt[n],data:G,position:h,line:l,column:c})}function _(G){var K;for(i=0,r=(m+=G).length;t=m[i],i<r;){switch(K=i,n){case wk:i=O();break;case xk:i=E();break;case dce:i=S();break;case pce:i=R();break;case fce:i=U();break;case gce:i=P();break;case D$:i=B();break;case hce:i=z();break;case mce:i=T();break;case dd:i=x()}K!==i&&(m[K]===`
`?(c=0,++l):++c)}return s+=i,m=m.slice(i),a}function b(G){return o.length&&y(o.join("")),n=ovt,y("(eof)"),a}function x(){return o=o.length?[]:o,e==="/"&&t==="*"?(h=s+i-1,n=wk,e=t,i+1):e==="/"&&t==="/"?(h=s+i-1,n=xk,e=t,i+1):t==="#"?(n=dce,h=s+i,i):/\s/.test(t)?(n=mce,h=s+i,i):(p=/\d/.test(t),f=/[^\w_]/.test(t),h=s+i,n=p?fce:f?pce:hce,i)}function T(){return/[^\s]/g.test(t)?(y(o.join("")),n=dd,i):(o.push(t),e=t,i+1)}function S(){return t!=="\r"&&t!==`
`||e==="\\"?(o.push(t),e=t,i+1):(y(o.join("")),n=dd,i)}function E(){return S()}function O(){return t==="/"&&e==="*"?(o.push(t),y(o.join("")),n=dd,i+1):(o.push(t),e=t,i+1)}function R(){if(e==="."&&/\d/.test(t))return n=D$,i;if(e==="/"&&t==="*")return n=wk,i;if(e==="/"&&t==="/")return n=xk,i;if(t==="."&&o.length){for(;L(o););return n=D$,i}if(t===";"||t===")"||t==="("){if(o.length)for(;L(o););return y(t),n=dd,i+1}var G=o.length===2&&t!=="=";if(/[\w_\d\s]/.test(t)||G){for(;L(o););return n=dd,i}return o.push(t),e=t,i+1}function L(G){for(var K,ee,Q=0;;){if(K=uce.indexOf(G.slice(0,G.length+Q).join("")),ee=uce[K],K===-1){if(Q--+G.length>0)continue;ee=G.slice(0,1).join("")}return y(ee),h+=ee.length,(o=o.slice(ee.length)).length}}function P(){return/[^a-fA-F0-9]/.test(t)?(y(o.join("")),n=dd,i):(o.push(t),e=t,i+1)}function U(){return t==="."||/[eE]/.test(t)?(o.push(t),n=D$,e=t,i+1):t==="x"&&o.length===1&&o[0]==="0"?(n=gce,o.push(t),e=t,i+1):/[^\d]/.test(t)?(y(o.join("")),n=dd,i):(o.push(t),e=t,i+1)}function B(){return t==="f"&&(o.push(t),e=t,i+=1),/[eE]/.test(t)||t==="-"&&/[eE]/.test(e)?(o.push(t),e=t,i+1):/[^\d]/.test(t)?(y(o.join("")),n=dd,i):(o.push(t),e=t,i+1)}function z(){if(/[^\d\w_]/.test(t)){var G=o.join("");return n=Q_t.indexOf(G)>-1?nvt:rvt.indexOf(G)>-1?svt:ivt,y(o.join("")),n=dd,i}return o.push(t),e=t,i+1}}function cvt(t){var e=lvt(),r=[];return r=(r=r.concat(e(t))).concat(e(null))}function uvt(t){return cvt(t)}function hvt(t){return t.map(e=>e.type!=="eof"?e.data:"").join("")}const Tk=["GL_OES_standard_derivatives","GL_EXT_frag_depth","GL_EXT_draw_buffers","GL_EXT_shader_texture_lod"];function dvt(t,e="100",r="300 es"){const i=/^\s*\#version\s+([0-9]+(\s+[a-zA-Z]+)?)\s*/;for(const s of t)if(s.type==="preprocessor"){const n=i.exec(s.data);if(n){const o=n[1].replace(/\s\s+/g," ");if(o===r)return o;if(o===e)return s.data="#version "+r,e;throw new Error("unknown glsl version: "+o)}}return t.splice(0,0,{type:"preprocessor",data:"#version "+r},{type:"whitespace",data:`
`}),null}function pvt(t,e){for(let r=e-1;r>=0;r--){const i=t[r];if(i.type!=="whitespace"&&i.type!=="block-comment"){if(i.type!=="keyword")break;if(i.data==="attribute"||i.data==="in")return!0}}return!1}function I3(t,e,r,i){i=i||r;for(const s of t)if(s.type==="ident"&&s.data===r)return i in e?e[i]++:e[i]=0,I3(t,e,i+"_"+e[i],i);return r}function HCe(t,e,r="afterVersion"){function i(l,c){for(let h=c;h<l.length;h++){const p=l[h];if(p.type==="operator"&&p.data===";")return h}return null}function s(l){let c=-1,h=0,p=-1;for(let f=0;f<l.length;f++){const m=l[f];if(m.type==="preprocessor"&&(m.data.match(/\#(if|ifdef|ifndef)\s+.+/)?++h:m.data.match(/\#endif\s*.*/)&&--h),r!=="afterVersion"&&r!=="afterPrecision"||m.type==="preprocessor"&&/^#version/.test(m.data)&&(p=Math.max(p,f)),r==="afterPrecision"&&m.type==="keyword"&&m.data==="precision"){const y=i(l,f);if(y===null)throw new Error("precision statement not followed by any semicolons!");p=Math.max(p,y)}c<p&&h===0&&(c=f)}return c+1}const n={data:`
`,type:"whitespace"},o=l=>l<t.length&&/[^\r\n]$/.test(t[l].data);let a=s(t);o(a-1)&&t.splice(a++,0,n);for(const l of e)t.splice(a++,0,l);o(a-1)&&o(a)&&t.splice(a,0,n)}function fvt(t,e,r,i="lowp"){HCe(t,[{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:i},{type:"whitespace",data:" "},{type:"keyword",data:r},{type:"whitespace",data:" "},{type:"ident",data:e},{type:"operator",data:";"}],"afterPrecision")}function mvt(t,e,r,i,s="lowp"){HCe(t,[{type:"keyword",data:"layout"},{type:"operator",data:"("},{type:"keyword",data:"location"},{type:"whitespace",data:" "},{type:"operator",data:"="},{type:"whitespace",data:" "},{type:"integer",data:i.toString()},{type:"operator",data:")"},{type:"whitespace",data:" "},{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:s},{type:"whitespace",data:" "},{type:"keyword",data:r},{type:"whitespace",data:" "},{type:"ident",data:e},{type:"operator",data:";"}],"afterPrecision")}function gvt(t,e){let r,i,s=-1;for(let n=e;n<t.length;n++){const o=t[n];if(o.type==="operator"&&(o.data==="["&&(r=n),o.data==="]")){i=n;break}o.type==="integer"&&(s=parseInt(o.data,10))}return r&&i&&t.splice(r,i-r+1),s}function yce(t,e){const r=yvt();if(v(r))return r;const i=uvt(t);if(dvt(i,"100","300 es")==="300 es")return t;let s=null,n=null;const o={},a={};for(let l=0;l<i.length;++l){const c=i[l];switch(c.type){case"keyword":e===vu.VERTEX_SHADER&&c.data==="attribute"?c.data="in":c.data==="varying"&&(c.data=e===vu.VERTEX_SHADER?"out":"in");break;case"builtin":if(/^texture(2D|Cube)(Proj)?(Lod|Grad)?(EXT)?$/.test(c.data.trim())&&(c.data=c.data.replace(/(2D|Cube|EXT)/g,"")),e===vu.FRAGMENT_SHADER&&c.data==="gl_FragColor"&&(s||(s=I3(i,o,"fragColor"),fvt(i,s,"vec4")),c.data=s),e===vu.FRAGMENT_SHADER&&c.data==="gl_FragData"){const h=gvt(i,l+1),p=I3(i,o,"fragData");mvt(i,p,"vec4",h,"mediump"),c.data=p}else e===vu.FRAGMENT_SHADER&&c.data==="gl_FragDepthEXT"&&(n||(n=I3(i,o,"gl_FragDepth")),c.data=n);break;case"ident":if(J_t.includes(c.data)){if(e===vu.VERTEX_SHADER&&pvt(i,l))throw new Error("attribute in vertex shader uses a name that is a reserved word in glsl 300 es");c.data in a||(a[c.data]=I3(i,o,c.data)),c.data=a[c.data]}}}for(let l=i.length-1;l>=0;--l){const c=i[l];if(c.type==="preprocessor"){const h=c.data.match(/\#extension\s+(.*)\:/);if(h&&h[1]&&Tk.includes(h[1].trim())){const m=i[l+1];i.splice(l,m&&m.type==="whitespace"?2:1)}const p=c.data.match(/\#ifdef\s+(.*)/);p&&p[1]&&Tk.includes(p[1].trim())&&(c.data="#if 1");const f=c.data.match(/\#ifndef\s+(.*)/);f&&f[1]&&Tk.includes(f[1].trim())&&(c.data="#if 0")}}return _vt(t,hvt(i))}function yvt(t){return null}function _vt(t,e){return e}const vvt=4294967295;let bvt=class{constructor(e,r,i,s,n=new Map){this._context=e,this._locations=s,this._uniformBlockBindings=n,this._refCount=1,this._compiled=!1,this._nameToUniformLocation={},this._nameToUniform1={},this._nameToUniform1v=new Map,this._nameToUniform2=new Map,this._nameToUniform3=new Map,this._nameToUniform4=new Map,this._nameToUniformMatrix3=new Map,this._nameToUniformMatrix4=new Map,e||console.error("RenderingContext isn't initialized!"),r.length===0&&console.error("Shaders source should not be empty!"),this._context.type===vt.WEBGL2&&(r=yce(r,vu.VERTEX_SHADER),i=yce(i,vu.FRAGMENT_SHADER)),this._vShader=_ce(this._context,vu.VERTEX_SHADER,r),this._fShader=_ce(this._context,vu.FRAGMENT_SHADER,i),this._vShader&&this._fShader||console.error("Error loading shaders!"),this._context.instanceCounter.increment(Nn.Shader,this),xG()&&(this.vertexShader=r,this.fragmentShader=i);const o=this._context.gl,a=o.createProgram();if(o.attachShader(a,this._vShader),o.attachShader(a,this._fShader),this._locations.forEach((l,c)=>o.bindAttribLocation(a,l,c)),o.linkProgram(a),xG()&&!o.getProgramParameter(a,o.LINK_STATUS)&&console.error(`Could not link shader
validated: ${o.getProgramParameter(a,o.VALIDATE_STATUS)}, gl error ${o.getError()}, vertex: ${o.getShaderParameter(this._vShader,o.COMPILE_STATUS)}, fragment: ${o.getShaderParameter(this._fShader,o.COMPILE_STATUS)}, info log: ${o.getProgramInfoLog(a)}, vertex source: ${this.vertexShader}, fragment source: ${this.fragmentShader}`),this._context.type===vt.WEBGL2){const l=o;for(const[c,h]of this._uniformBlockBindings){const p=l.getUniformBlockIndex(a,c);p<vvt&&l.uniformBlockBinding(a,p,h)}}this._glName=a,this._context.instanceCounter.increment(Nn.Program,this)}get glName(){return this._glName}get hasGLName(){return v(this._glName)}get compiled(){if(this._compiled)return!0;const e=this._context.gl.getExtension("KHR_parallel_shader_compile");return e==null||C(this.glName)?(this._compiled=!0,!0):(this._compiled=!!this._context.gl.getProgramParameter(this.glName,e.COMPLETION_STATUS_KHR),this._compiled)}dispose(){if(--this._refCount>0)return;const e=this._context.gl;this._vShader&&(e.deleteShader(this._vShader),this._vShader=null,this._context.instanceCounter.decrement(Nn.Shader,this)),this._fShader&&(e.deleteShader(this._fShader),this._fShader=null),this._glName&&(e.deleteProgram(this._glName),this._glName=null,this._context.instanceCounter.decrement(Nn.Program,this))}ref(){++this._refCount}_getUniformLocation(e){return this._nameToUniformLocation[e]===void 0&&v(this.glName)&&(this._nameToUniformLocation[e]=this._context.gl.getUniformLocation(this.glName,e)),this._nameToUniformLocation[e]}hasUniform(e){return this._getUniformLocation(e)!==null}setUniform1i(e,r){const i=this._nameToUniform1[e];i!==void 0&&r===i||(this._context.gl.uniform1i(this._getUniformLocation(e),r),this._nameToUniform1[e]=r)}setUniform1iv(e,r){qp(this._nameToUniform1v,e,r)&&this._context.gl.uniform1iv(this._getUniformLocation(e),r)}setUniform2iv(e,r){qp(this._nameToUniform2,e,r)&&this._context.gl.uniform2iv(this._getUniformLocation(e),r)}setUniform3iv(e,r){qp(this._nameToUniform3,e,r)&&this._context.gl.uniform3iv(this._getUniformLocation(e),r)}setUniform4iv(e,r){qp(this._nameToUniform4,e,r)&&this._context.gl.uniform4iv(this._getUniformLocation(e),r)}setUniform1f(e,r){const i=this._nameToUniform1[e];i!==void 0&&r===i||(this._context.gl.uniform1f(this._getUniformLocation(e),r),this._nameToUniform1[e]=r)}setUniform1fv(e,r){qp(this._nameToUniform1v,e,r)&&this._context.gl.uniform1fv(this._getUniformLocation(e),r)}setUniform2f(e,r,i){const s=this._nameToUniform2.get(e);s===void 0?(this._context.gl.uniform2f(this._getUniformLocation(e),r,i),this._nameToUniform2.set(e,[r,i])):r===s[0]&&i===s[1]||(this._context.gl.uniform2f(this._getUniformLocation(e),r,i),s[0]=r,s[1]=i)}setUniform2fv(e,r){qp(this._nameToUniform2,e,r)&&this._context.gl.uniform2fv(this._getUniformLocation(e),r)}setUniform3f(e,r,i,s){const n=this._nameToUniform3.get(e);n===void 0?(this._context.gl.uniform3f(this._getUniformLocation(e),r,i,s),this._nameToUniform3[e]=[r,i,s]):r===n[0]&&i===n[1]&&s===n[2]||(this._context.gl.uniform3f(this._getUniformLocation(e),r,i,s),n[0]=r,n[1]=i,n[2]=s)}setUniform3fv(e,r){qp(this._nameToUniform3,e,r)&&this._context.gl.uniform3fv(this._getUniformLocation(e),r)}setUniform4f(e,r,i,s,n){const o=this._nameToUniform4.get(e);o===void 0?(this._context.gl.uniform4f(this._getUniformLocation(e),r,i,s,n),this._nameToUniform4.set(e,[r,i,s,n])):o!==void 0&&r===o[0]&&i===o[1]&&s===o[2]&&n===o[3]||(this._context.gl.uniform4f(this._getUniformLocation(e),r,i,s,n),o[0]=r,o[1]=i,o[2]=s,o[3]=n)}setUniform4fv(e,r){qp(this._nameToUniform4,e,r)&&this._context.gl.uniform4fv(this._getUniformLocation(e),r)}setUniformMatrix3fv(e,r,i=!1){qp(this._nameToUniformMatrix3,e,r)&&this._context.gl.uniformMatrix3fv(this._getUniformLocation(e),i,r)}setUniformMatrix4fv(e,r,i=!1){qp(this._nameToUniformMatrix4,e,r)&&this._context.gl.uniformMatrix4fv(this._getUniformLocation(e),i,r)}stop(){}};function _ce(t,e,r){const i=t.gl,s=i.createShader(e);return i.shaderSource(s,r),i.compileShader(s),xG()&&!i.getShaderParameter(s,i.COMPILE_STATUS)&&(console.error("Compile error in ".concat(e===vu.VERTEX_SHADER?"vertex":"fragment"," shader")),console.error(i.getShaderInfoLog(s)),console.error(wvt(r))),s}function wvt(t){let e=2;return t.replace(/\n/g,()=>`
`+xvt(e++)+":")}function xvt(t){return t>=1e3?t.toString():("  "+t).slice(-3)}function qp(t,e,r){const i=t.get(e);return i?UH(i,r):(t.set(e,Array.from(r)),!0)}let Tvt=class{constructor(e){this._rctx=e,this._store=new BE}dispose(){this._store.forEach(e=>e.forEach(r=>r.dispose())),this._store.clear()}acquire(e,r,i,s){const n=this._store.get(e,r);if(v(n))return n.ref(),n;const o=new bvt(this._rctx,e,r,i,s);return o.ref(),this._store.set(e,r,o),o}get test(){let e=0;return this._store.forEach(r=>r.forEach(i=>e+=i.hasGLName?2:1)),{cachedWebGLObjects:e}}},GM=class{constructor(){this._result=!1}dispose(){this._program=Qe(this._program)}get result(){return v(this._program)&&(this._result=this._test(this._program),this.dispose()),this._result}},Svt=class extends GM{constructor(e){super(),this._rctx=e,this._dummyProgram=null,this._rctx.type===vt.WEBGL2&&de("mac")&&de("chrome")&&(this._program=this._prepareProgram(),this._dummyProgram=this._prepareDummyProgram())}dispose(){var e;super.dispose(),(e=this._dummyProgram)==null||e.dispose(),this._dummyProgram=null}_test(e){const r=this._rctx;r.resetState();const i=new Ds(r,{colorTarget:ls.TEXTURE,depthStencilTarget:$r.NONE},{target:bt.TEXTURE_2D,wrapMode:Rt.CLAMP_TO_EDGE,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,width:1,height:1}),s=jr.createIndex(this._rctx,Lr.STATIC_DRAW,new Uint8Array([0]));r.bindFramebuffer(i),r.setViewport(0,0,1,1),r.useProgram(this._dummyProgram),r.bindBuffer(s,Ot.ELEMENT_ARRAY_BUFFER),r.drawElements($t.POINTS,1,lt.UNSIGNED_BYTE,0),r.useProgram(e),r.bindVAO(null),r.drawArrays($t.TRIANGLES,0,258);const n=new Uint8Array(4);return i.readPixels(0,0,1,1,Ve.RGBA,Lt.UNSIGNED_BYTE,n),i.dispose(),s.dispose(),n[0]===255}_prepareProgram(){const r=`
    precision highp float;

    varying float triangleId;

    const vec3 triangleVertices[3] = vec3[3](vec3(-0.5, -0.5, 0.0), vec3(0.5, -0.5, 0.0), vec3(0.0, 0.5, 0.0));

    void main(void) {
      triangleId = floor(float(gl_VertexID)/3.0);

      vec3 position = triangleVertices[gl_VertexID % 3];
      float offset = triangleId / ${w.float(85)};
      position.z = 0.5 - offset;

      gl_Position = vec4(position, 1.0);
    }
    `,i=`
    precision highp float;

    varying float triangleId;

    void main(void) {
      gl_FragColor = triangleId == ${w.float(85)} ? vec4(0.0, 1.0, 0.0, 1.0) : vec4(1.0, 0.0, 0.0, 1.0);
    }
    `;return this._rctx.programCache.acquire(r,i,new Map([]))}_prepareDummyProgram(){const e=`
    void main(void) {
      gl_Position = vec4(0.0, 0.0, float(gl_VertexID)-2.0, 1.0);
    }`,r=`
    void main(void) {
      gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
    }`;return this._rctx.programCache.acquire(e,r,new Map([]))}},Evt=class extends GM{constructor(e){super(),this._rctx=e,this._program=vce(this._rctx,!1),this._obfuscated=vce(this._rctx,!0)}dispose(){super.dispose(),this._obfuscated=Qe(this._obfuscated)}_test(e){if(de("force-double-precision-obfuscation"))return!0;if(C(this._obfuscated))return!1;const r=this._runProgram(e),i=this._runProgram(this._obfuscated);return r!==0&&(i===0||r/i>5)}_runProgram(e){const r=this._rctx;r.resetState();const i=new Ds(r,{colorTarget:ls.TEXTURE,depthStencilTarget:$r.NONE},{target:bt.TEXTURE_2D,wrapMode:Rt.CLAMP_TO_EDGE,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,width:1,height:1}),s=jr.createVertex(r,Lr.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),n=new jh(r,new Map([["position",0]]),{geometry:[new Mo("position",2,lt.UNSIGNED_SHORT,0,4)]},{geometry:s}),o=$e(5633261287538229e-9,2626832878767164e-9,1.4349880495278358e6),a=$e(563327146742708e-8,2.6268736381334523e6,1434963231608387e-9),l=new Float32Array(6);hj(o,l,3);const c=new Float32Array(6);hj(a,c,3),r.useProgram(e),e.setUniform3f("u_highA",l[0],l[2],l[4]),e.setUniform3f("u_lowA",l[1],l[3],l[5]),e.setUniform3f("u_highB",c[0],c[2],c[4]),e.setUniform3f("u_lowB",c[1],c[3],c[5]),r.bindFramebuffer(i),r.setViewport(0,0,1,1),r.bindVAO(n),r.drawArrays($t.TRIANGLE_STRIP,0,4);const h=new Uint8Array(4);i.readPixels(0,0,1,1,Ve.RGBA,Lt.UNSIGNED_BYTE,h),n.dispose(!1),s.dispose(),i.dispose();const p=(o[2]-a[2])/25,f=mZ(h);return Math.abs(p-f)}};function vce(t,e){const r=`

  precision highp float;

  attribute vec2 position;

  uniform vec3 u_highA;
  uniform vec3 u_lowA;
  uniform vec3 u_highB;
  uniform vec3 u_lowB;

  varying vec4 v_color;

  ${e?"#define DOUBLE_PRECISION_REQUIRES_OBFUSCATION":""}

  #ifdef DOUBLE_PRECISION_REQUIRES_OBFUSCATION

  vec3 dpPlusFrc(vec3 a, vec3 b) {
    return mix(a, a + b, vec3(notEqual(b, vec3(0))));
  }

  vec3 dpMinusFrc(vec3 a, vec3 b) {
    return mix(vec3(0), a - b, vec3(notEqual(a, b)));
  }

  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
    vec3 t1 = dpPlusFrc(hiA, hiB);
    vec3 e = dpMinusFrc(t1, hiA);
    vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;
    return t1 + t2;
  }

  #else

  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
    vec3 t1 = hiA + hiB;
    vec3 e = t1 - hiA;
    vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;
    return t1 + t2;
  }

  #endif

  const float MAX_RGBA_FLOAT =
    255.0 / 256.0 +
    255.0 / 256.0 / 256.0 +
    255.0 / 256.0 / 256.0 / 256.0 +
    255.0 / 256.0 / 256.0 / 256.0 / 256.0;

  const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);

  vec4 float2rgba(const float value) {
    // Make sure value is in the domain we can represent
    float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);

    // Decompose value in 32bit fixed point parts represented as
    // uint8 rgba components. Decomposition uses the fractional part after multiplying
    // by a power of 256 (this removes the bits that are represented in the previous
    // component) and then converts the fractional part to 8bits.
    vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);

    // Convert uint8 values (from 0 to 255) to floating point representation for
    // the shader
    const float toU8AsFloat = 1.0 / 255.0;

    return fixedPointU8 * toU8AsFloat;
  }

  void main() {
    vec3 val = dpAdd(u_highA, u_lowA, -u_highB, -u_lowB);

    v_color = float2rgba(val.z / 25.0);

    gl_Position = vec4(position * 2.0 - 1.0, 0.0, 1.0);
  }
  `,i=`
  precision highp float;

  varying vec4 v_color;

  void main() {
    gl_FragColor = v_color;
  }
  `;return t.programCache.acquire(r,i,new Map([["position",0]]))}var bce,wce,NH={},Cvt={get exports(){return NH},set exports(t){NH=t}};bce=Cvt,(wce=function(){var t=function(_){window.console&&window.console.log&&window.console.log(_)},e=function(_){window.console&&window.console.error?window.console.error(_):t(_)},r={enable:{1:{0:!0}},disable:{1:{0:!0}},getParameter:{1:{0:!0}},drawArrays:{3:{0:!0}},drawElements:{4:{0:!0,2:!0}},createShader:{1:{0:!0}},getShaderParameter:{2:{1:!0}},getProgramParameter:{2:{1:!0}},getShaderPrecisionFormat:{2:{0:!0,1:!0}},getVertexAttrib:{2:{1:!0}},vertexAttribPointer:{6:{2:!0}},bindTexture:{2:{0:!0}},activeTexture:{1:{0:!0}},getTexParameter:{2:{0:!0,1:!0}},texParameterf:{3:{0:!0,1:!0}},texParameteri:{3:{0:!0,1:!0,2:!0}},texImage2D:{9:{0:!0,2:!0,6:!0,7:!0},6:{0:!0,2:!0,3:!0,4:!0}},texSubImage2D:{9:{0:!0,6:!0,7:!0},7:{0:!0,4:!0,5:!0}},copyTexImage2D:{8:{0:!0,2:!0}},copyTexSubImage2D:{8:{0:!0}},generateMipmap:{1:{0:!0}},compressedTexImage2D:{7:{0:!0,2:!0}},compressedTexSubImage2D:{8:{0:!0,6:!0}},bindBuffer:{2:{0:!0}},bufferData:{3:{0:!0,2:!0}},bufferSubData:{3:{0:!0}},getBufferParameter:{2:{0:!0,1:!0}},pixelStorei:{2:{0:!0,1:!0}},readPixels:{7:{4:!0,5:!0}},bindRenderbuffer:{2:{0:!0}},bindFramebuffer:{2:{0:!0}},checkFramebufferStatus:{1:{0:!0}},framebufferRenderbuffer:{4:{0:!0,1:!0,2:!0}},framebufferTexture2D:{5:{0:!0,1:!0,2:!0}},getFramebufferAttachmentParameter:{3:{0:!0,1:!0,2:!0}},getRenderbufferParameter:{2:{0:!0,1:!0}},renderbufferStorage:{4:{0:!0,1:!0}},clear:{1:{0:{enumBitwiseOr:["COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","STENCIL_BUFFER_BIT"]}}},depthFunc:{1:{0:!0}},blendFunc:{2:{0:!0,1:!0}},blendFuncSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},blendEquation:{1:{0:!0}},blendEquationSeparate:{2:{0:!0,1:!0}},stencilFunc:{3:{0:!0}},stencilFuncSeparate:{4:{0:!0,1:!0}},stencilMaskSeparate:{2:{0:!0}},stencilOp:{3:{0:!0,1:!0,2:!0}},stencilOpSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},cullFace:{1:{0:!0}},frontFace:{1:{0:!0}},drawArraysInstancedANGLE:{4:{0:!0}},drawElementsInstancedANGLE:{5:{0:!0,2:!0}},blendEquationEXT:{1:{0:!0}}},i=null,s=null;function n(_){if(i==null)for(var b in i={},s={},_)typeof _[b]=="number"&&(i[_[b]]=b,s[b]=_[b])}function o(){if(i==null)throw"WebGLDebugUtils.init(ctx) not called"}function a(_){return o(),i[_]!==void 0}function l(_){o();var b=i[_];return b!==void 0?"gl."+b:"/*UNKNOWN WebGL ENUM*/ 0x"+_.toString(16)}function c(_,b,x,T){var S;if((S=r[_])!==void 0&&(S=S[b])!==void 0&&S[x]){if(typeof S[x]=="object"&&S[x].enumBitwiseOr!==void 0){for(var E=S[x].enumBitwiseOr,O=0,R=[],L=0;L<E.length;++L){var P=s[E[L]];T&P&&(O|=P,R.push(l(P)))}return O===T?R.join(" | "):l(T)}return l(T)}return T===null?"null":T===void 0?"undefined":T.toString()}function h(_,b){for(var x="",T=b.length,S=0;S<T;++S)x+=(S==0?"":", ")+c(_,T,S,b[S]);return x}function p(_,b,x){_.__defineGetter__(x,function(){return b[x]}),_.__defineSetter__(x,function(T){b[x]=T})}function f(_,b,x,T){T=T||_,n(_),b=b||function(P,U,B){for(var z="",G=B.length,K=0;K<G;++K)z+=(K==0?"":", ")+c(U,G,K,B[K]);e("WebGL error "+l(P)+" in "+U+"("+z+")")};var S={};function E(P,U){return function(){x&&x(U,arguments);var B=P[U].apply(P,arguments),z=T.getError();return z!=0&&(S[z]=!0,b(z,U,arguments)),B}}var O={};for(var R in _)if(typeof _[R]=="function")if(R!="getExtension")O[R]=E(_,R);else{var L=E(_,R);O[R]=function(){return f(L.apply(_,arguments),b,x,T)}}else p(O,_,R);return O.getError=function(){for(var P in S)if(S.hasOwnProperty(P)&&S[P])return S[P]=!1,P;return _.NO_ERROR},O}function m(_){var b=_.getParameter(_.MAX_VERTEX_ATTRIBS),x=_.createBuffer();_.bindBuffer(_.ARRAY_BUFFER,x);for(var T=0;T<b;++T)_.disableVertexAttribArray(T),_.vertexAttribPointer(T,4,_.FLOAT,!1,0,0),_.vertexAttrib1f(T,0);_.deleteBuffer(x);var S=_.getParameter(_.MAX_TEXTURE_IMAGE_UNITS);for(T=0;T<S;++T)_.activeTexture(_.TEXTURE0+T),_.bindTexture(_.TEXTURE_CUBE_MAP,null),_.bindTexture(_.TEXTURE_2D,null);for(_.activeTexture(_.TEXTURE0),_.useProgram(null),_.bindBuffer(_.ARRAY_BUFFER,null),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,null),_.bindFramebuffer(_.FRAMEBUFFER,null),_.bindRenderbuffer(_.RENDERBUFFER,null),_.disable(_.BLEND),_.disable(_.CULL_FACE),_.disable(_.DEPTH_TEST),_.disable(_.DITHER),_.disable(_.SCISSOR_TEST),_.blendColor(0,0,0,0),_.blendEquation(_.FUNC_ADD),_.blendFunc(_.ONE,_.ZERO),_.clearColor(0,0,0,0),_.clearDepth(1),_.clearStencil(-1),_.colorMask(!0,!0,!0,!0),_.cullFace(_.BACK),_.depthFunc(_.LESS),_.depthMask(!0),_.depthRange(0,1),_.frontFace(_.CCW),_.hint(_.GENERATE_MIPMAP_HINT,_.DONT_CARE),_.lineWidth(1),_.pixelStorei(_.PACK_ALIGNMENT,4),_.pixelStorei(_.UNPACK_ALIGNMENT,4),_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,!1),_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_.UNPACK_COLORSPACE_CONVERSION_WEBGL&&_.pixelStorei(_.UNPACK_COLORSPACE_CONVERSION_WEBGL,_.BROWSER_DEFAULT_WEBGL),_.polygonOffset(0,0),_.sampleCoverage(1,!1),_.scissor(0,0,_.canvas.width,_.canvas.height),_.stencilFunc(_.ALWAYS,0,4294967295),_.stencilMask(4294967295),_.stencilOp(_.KEEP,_.KEEP,_.KEEP),_.viewport(0,0,_.canvas.width,_.canvas.height),_.clear(_.COLOR_BUFFER_BIT|_.DEPTH_BUFFER_BIT|_.STENCIL_BUFFER_BIT);_.getError(););}function y(_){var b,x,T=[],S=[],E={},O=1,R=!1,L=[],P=0,U=0,B=!1,z=0,G={};function K(W){return typeof W=="function"?W:function(ue){W.handleEvent(ue)}}_.getContext=(x=_.getContext,function(){var W=x.apply(_,arguments);if(W instanceof WebGLRenderingContext){if(W!=b){if(b)throw"got different context";E=J(b=W)}return E}return W});var ee=function(W){T.push(K(W))},Q=function(W){S.push(K(W))};function H(W){var ue=W.addEventListener;W.addEventListener=function(pe,we,Ce){switch(pe){case"webglcontextlost":ee(we);break;case"webglcontextrestored":Q(we);break;default:ue.apply(W,arguments)}}}function $(){for(var W=Object.keys(G),ue=0;ue<W.length;++ue)delete G[W]}function N(){++U,R||P==U&&_.loseContext()}function F(W,ue){var pe=W[ue];return function(){if(N(),!R)return pe.apply(W,arguments)}}function j(){for(var W=0;W<L.length;++W){var ue=L[W];ue instanceof WebGLBuffer?b.deleteBuffer(ue):ue instanceof WebGLFramebuffer?b.deleteFramebuffer(ue):ue instanceof WebGLProgram?b.deleteProgram(ue):ue instanceof WebGLRenderbuffer?b.deleteRenderbuffer(ue):ue instanceof WebGLShader?b.deleteShader(ue):ue instanceof WebGLTexture&&b.deleteTexture(ue)}}function X(W){return{statusMessage:W,preventDefault:function(){B=!0}}}return H(_),_.loseContext=function(){if(!R){for(R=!0,P=0,++O;b.getError(););$(),G[b.CONTEXT_LOST_WEBGL]=!0;var W=X("context lost"),ue=T.slice();setTimeout(function(){for(var pe=0;pe<ue.length;++pe)ue[pe](W);z>=0&&setTimeout(function(){_.restoreContext()},z)},0)}},_.restoreContext=function(){R&&S.length&&setTimeout(function(){if(!B)throw"can not restore. webglcontestlost listener did not call event.preventDefault";j(),m(b),R=!1,U=0,B=!1;for(var W=S.slice(),ue=X("context restored"),pe=0;pe<W.length;++pe)W[pe](ue)},0)},_.loseContextInNCalls=function(W){if(R)throw"You can not ask a lost contet to be lost";P=U+W},_.getNumCalls=function(){return U},_.setRestoreTimeout=function(W){z=W},_;function J(W){for(var ue in W)typeof W[ue]=="function"?E[ue]=F(W,ue):p(E,W,ue);E.getError=function(){if(N(),!R)for(;xe=b.getError();)G[xe]=!0;for(var xe in G)if(G[xe])return delete G[xe],xe;return E.NO_ERROR};for(var pe=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"],we=0;we<pe.length;++we){var Ce=pe[we];E[Ce]=function(xe){return function(){if(N(),R)return null;var De=xe.apply(W,arguments);return De.__webglDebugContextLostId__=O,L.push(De),De}}(W[Ce])}var Ge=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"];for(we=0;we<Ge.length;++we)Ce=Ge[we],E[Ce]=function(xe){return function(){return N(),R?null:xe.apply(W,arguments)}}(E[Ce]);var Le=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"];for(we=0;we<Le.length;++we)Ce=Le[we],E[Ce]=function(xe){return function(){return N(),!R&&xe.apply(W,arguments)}}(E[Ce]);return E.checkFramebufferStatus=function(xe){return function(){return N(),R?E.FRAMEBUFFER_UNSUPPORTED:xe.apply(W,arguments)}}(E.checkFramebufferStatus),E.getAttribLocation=function(xe){return function(){return N(),R?-1:xe.apply(W,arguments)}}(E.getAttribLocation),E.getVertexAttribOffset=function(xe){return function(){return N(),R?0:xe.apply(W,arguments)}}(E.getVertexAttribOffset),E.isContextLost=function(){return R},E}}return{init:n,mightBeEnum:a,glEnumToString:l,glFunctionArgToString:c,glFunctionArgsToString:h,makeDebugContext:f,makeLostContextSimulatingCanvas:y,resetToInitialState:m}}())!==void 0&&(bce.exports=wce);let Avt=class extends GM{constructor(e){var s,n,o,a,l;if(super(),this._rctx=e,!e.gl)return;if(e.type===vt.WEBGL1)return void(this._result=!(!((s=e.capabilities.textureFloat)!=null&&s.textureFloat)||!((n=e.capabilities.colorBufferFloat)!=null&&n.textureFloat)));if(!((o=e.capabilities.textureFloat)!=null&&o.textureFloat&&((a=e.capabilities.colorBufferFloat)!=null&&a.textureFloat)&&((l=e.capabilities.colorBufferFloat)!=null&&l.floatBlend)))return;const r=`
    precision highp float;
    attribute vec2 a_pos;

    void main() {
      gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
    }
    `,i=`
     precision highp float;

     void main() {
      gl_FragColor = vec4(0.5, 0.5, 0.5, 0.5);
     }
    `;this._program=e.programCache.acquire(r,i,new Map([["a_pos",0]]))}_test(e){const r=this._rctx,i=new Ds(r,{colorTarget:ls.TEXTURE,depthStencilTarget:$r.NONE},{target:bt.TEXTURE_2D,wrapMode:Rt.CLAMP_TO_EDGE,pixelFormat:Ve.RGBA,dataType:Lt.FLOAT,internalFormat:St.RGBA32F,samplingMode:tt.NEAREST,width:1,height:1}),s=jr.createVertex(r,Lr.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),n=new jh(r,new Map([["a_pos",0]]),{geometry:[new Mo("a_pos",2,lt.UNSIGNED_SHORT,0,4)]},{geometry:s});r.useProgram(e);const o=r.getBoundFramebufferObject(),{x:a,y:l,width:c,height:h}=r.getViewport();r.bindFramebuffer(i),r.setViewport(0,0,1,1),r.bindVAO(n),r.drawArrays($t.TRIANGLE_STRIP,0,4);const p=Bt({blending:Sxe});r.setPipelineState(p),r.drawArrays($t.TRIANGLE_STRIP,0,4),NH.init(r);const f=r.gl.getError();return r.setViewport(a,l,c,h),r.bindFramebuffer(o),n.dispose(!1),s.dispose(),i.dispose(),f!==1282||(console.warn("Device claims support for WebGL extension EXT_float_blend but does not support it. Using fall back."),!1)}},Rvt=class extends GM{constructor(e){super(),this._rctx=e;const r=`
      precision highp float;
      attribute vec2 a_pos;
      uniform highp sampler2D u_texture;
      varying vec4 v_color;

      float getBit(in float bitset, in int bitIndex) {
        float offset = pow(2.0, float(bitIndex));
        return mod(floor(bitset / offset), 2.0);
      }

      void main() {
        vec4 value = texture2D(u_texture, vec2(0.0));
        float bit = getBit(value.x * 255.0, 1);

        v_color = bit * vec4(1.0);
        gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
      }
      `,i=`
      precision highp float;
      varying vec4 v_color;

      void main() {
        gl_FragColor = v_color;
      }
      `;this._program=e.programCache.acquire(r,i,new Map([["a_pos",0]]))}_test(e){const r=this._rctx,i=new Ds(r,{colorTarget:ls.TEXTURE,depthStencilTarget:$r.NONE},{target:bt.TEXTURE_2D,wrapMode:Rt.CLAMP_TO_EDGE,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,width:1,height:1}),s=new Uint8Array(4),n=jr.createVertex(r,Lr.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),o=new jh(r,new Map([["a_position",0]]),{geometry:[new Mo("a_position",2,lt.SHORT,0,4)]},{geometry:n});r.useProgram(e);const a=new ct(r,{target:bt.TEXTURE_2D,wrapMode:Rt.CLAMP_TO_EDGE,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,width:1,height:1},new Uint8Array([2,255,0,0]));e.setUniform1i("u_texture",0),r.bindTexture(a,0);const l=r.getBoundFramebufferObject();r.bindFramebuffer(i),r.useProgram(e);const{x:c,y:h,width:p,height:f}=r.getViewport();r.setViewport(0,0,1,1),r.bindVAO(o),r.drawArrays($t.TRIANGLE_STRIP,0,4),r.setViewport(c,h,p,f),i.readPixels(0,0,1,1,Ve.RGBA,Lt.UNSIGNED_BYTE,s),o.dispose(!1),n.dispose(),i.dispose();const m=s[0]!==255||s[1]!==255||s[2]!==255||s[3]!==255;return m&&se.getLogger("esri.views.webgl.testSamplerPrecision").warn(`A problem was detected with your graphics driver. Your driver does not appear to honor sampler precision specifiers, which may result in rendering issues due to numerical instability. We recommend ensuring that your drivers have been updated to the latest version. Applying lowp sampler workaround. [${s[0]}.${s[1]}.${s[2]}.${s[3]}]`),r.bindFramebuffer(l),m}};new Mo("a_pos",2,lt.BYTE,0,2);new Mo("a_pos",2,lt.BYTE,0,4),new Mo("a_tex",2,lt.BYTE,2,4);const Ovt={geometry:[new Mo("a_pos",2,lt.UNSIGNED_SHORT,0,4)]};let Mvt=class extends GM{constructor(e){super(),this._rctx=e,this._image=new Image,this._image.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='5' height='5' version='1.1' viewBox='0 0 5 5' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='5' height='5' fill='%23f00' fill-opacity='.5'/%3E%3C/svg%3E%0A",this._image.width=5,this._image.height=5,this._image.decode();const r=`
    precision highp float;

    attribute vec2 a_pos;
    varying vec2 v_uv;

    void main() {
      v_uv = a_pos;
      gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
    }
    `,i=`
    precision highp float;

    varying vec2 v_uv;
    uniform sampler2D u_texture;

    void main() {
      gl_FragColor = texture2D(u_texture, v_uv);
    }
    `;this._program=e.programCache.acquire(r,i,new Map([["a_pos",0]]))}dispose(){super.dispose(),this._image.src=""}_test(e){const r=this._rctx;if(!r.gl)return e.dispose(),!0;const i=new Ds(r,{colorTarget:ls.TEXTURE,depthStencilTarget:$r.NONE},{target:bt.TEXTURE_2D,wrapMode:Rt.CLAMP_TO_EDGE,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,width:1,height:1}),s=jr.createVertex(r,Lr.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),n=new jh(r,new Map([["a_pos",0]]),Ovt,{geometry:s}),o=new ct(r,{dataType:Lt.UNSIGNED_BYTE,pixelFormat:Ve.RGBA,preMultiplyAlpha:!1,wrapMode:Rt.CLAMP_TO_EDGE,samplingMode:tt.LINEAR},this._image);r.useProgram(e),r.bindTexture(o,0),e.setUniform1i("u_texture",0);const a=r.getBoundFramebufferObject(),{x:l,y:c,width:h,height:p}=r.getViewport();r.bindFramebuffer(i),r.setViewport(0,0,1,1),r.setClearColor(0,0,0,0),r.setBlendingEnabled(!1),r.clearSafe(Li.COLOR_BUFFER_BIT),r.bindVAO(n),r.drawArrays($t.TRIANGLE_STRIP,0,4);const f=new Uint8Array(4);return i.readPixels(0,0,1,1,Ve.RGBA,Lt.UNSIGNED_BYTE,f),n.dispose(!1),s.dispose(),i.dispose(),o.dispose(),r.setViewport(l,c,h,p),r.bindFramebuffer(a),f[0]!==255}},Pvt=class{constructor(e){this.rctx=e,this.floatBufferBlend=new Avt(e),this.svgPremultipliesAlpha=new Mvt(e),this.doublePrecisionRequiresObfuscation=new Evt(e),this.ignoresSamplerPrecision=new Rvt(e),this.drawArraysRequiresIndicesTypeReset=new Svt(e)}dispose(){this.ignoresSamplerPrecision.dispose(),this.doublePrecisionRequiresObfuscation.dispose(),this.svgPremultipliesAlpha.dispose(),this.floatBufferBlend.dispose(),this.drawArraysRequiresIndicesTypeReset.dispose()}};function Ivt(t,e){if(e.disjointTimerQuery)return null;if(Sm(t))return{drawBuffers:t.drawBuffers.bind(t),MAX_DRAW_BUFFERS:t.MAX_DRAW_BUFFERS,MAX_COLOR_ATTACHMENTS:t.MAX_COLOR_ATTACHMENTS};if(e.drawBuffers)return null;const r=t.getExtension("WEBGL_draw_buffers");return r?{drawBuffers:r.drawBuffersWEBGL.bind(r),MAX_DRAW_BUFFERS:r.MAX_DRAW_BUFFERS_WEBGL,MAX_COLOR_ATTACHMENTS:r.MAX_COLOR_ATTACHMENTS_WEBGL}:null}function $vt(t){if(Sm(t))return t;const e=t.getExtension("ANGLE_instanced_arrays");return e?{drawArraysInstanced:e.drawArraysInstancedANGLE.bind(e),drawElementsInstanced:e.drawElementsInstancedANGLE.bind(e),vertexAttribDivisor:e.vertexAttribDivisorANGLE.bind(e)}:null}function Lvt(t,e){if(e.compressedTextureETC)return null;const r=t.getExtension("WEBGL_compressed_texture_etc");return r?{COMPRESSED_R11_EAC:r.COMPRESSED_R11_EAC,COMPRESSED_SIGNED_R11_EAC:r.COMPRESSED_SIGNED_R11_EAC,COMPRESSED_RG11_EAC:r.COMPRESSED_RG11_EAC,COMPRESSED_SIGNED_RG11_EAC:r.COMPRESSED_SIGNED_RG11_EAC,COMPRESSED_RGB8_ETC2:r.COMPRESSED_RGB8_ETC2,COMPRESSED_SRGB8_ETC2:r.COMPRESSED_SRGB8_ETC2,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:r.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:r.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_RGBA8_ETC2_EAC:r.COMPRESSED_RGBA8_ETC2_EAC,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:r.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC}:null}function Dvt(t,e){if(e.compressedTextureS3TC)return null;const r=t.getExtension("WEBGL_compressed_texture_s3tc");return r?{COMPRESSED_RGB_S3TC_DXT1:r.COMPRESSED_RGB_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT1:r.COMPRESSED_RGBA_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT3:r.COMPRESSED_RGBA_S3TC_DXT3_EXT,COMPRESSED_RGBA_S3TC_DXT5:r.COMPRESSED_RGBA_S3TC_DXT5_EXT}:null}function Nvt(t,e){if(Sm(t))return{MIN:t.MIN,MAX:t.MAX};if(e.blendMinMax)return null;{const r=t.getExtension("EXT_blend_minmax");return r?{MIN:r.MIN_EXT,MAX:r.MAX_EXT}:null}}function Fvt(t,e){if(e.textureFilterAnisotropic)return null;const r=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic");return r?{MAX_TEXTURE_MAX_ANISOTROPY:r.MAX_TEXTURE_MAX_ANISOTROPY_EXT,TEXTURE_MAX_ANISOTROPY:r.TEXTURE_MAX_ANISOTROPY_EXT}:null}function Uvt(t,e){if(Sm(t))return{textureFloat:!0,textureFloatLinear:!e.textureFloatLinear&&!!t.getExtension("OES_texture_float_linear"),textureHalfFloat:!0,textureHalfFloatLinear:!0,HALF_FLOAT:t.HALF_FLOAT,R16F:t.R16F,RG16F:t.RG16F,RGBA16F:t.RGBA16F,R32F:t.R32F,RG32F:t.RG32F,RGBA32F:t.RGBA32F,R11F_G11F_B10F:t.R11F_G11F_B10F,RGB16F:t.RGB16F};if(t instanceof WebGLRenderingContext){const r=!e.textureHalfFloat&&t.getExtension("OES_texture_half_float");return{textureFloat:!e.textureFloat&&!!t.getExtension("OES_texture_float"),textureFloatLinear:!e.textureFloatLinear&&!!t.getExtension("OES_texture_float_linear"),textureHalfFloat:!!r,textureHalfFloatLinear:!e.textureHalfFloatLinear&&!!t.getExtension("OES_texture_half_float_linear"),HALF_FLOAT:r?r.HALF_FLOAT_OES:void 0}}return null}function kvt(t,e){if(Sm(t)){const r=!e.colorBufferHalfFloat&&t.getExtension("EXT_color_buffer_half_float")||!e.colorBufferFloat&&t.getExtension("EXT_color_buffer_float"),i=!e.colorBufferFloat&&t.getExtension("EXT_color_buffer_float"),s=!e.floatBlend&&!e.colorBufferFloat&&t.getExtension("EXT_float_blend");return r||i||s?{textureFloat:!!i,textureHalfFloat:!!r,floatBlend:!!s,R16F:t.R16F,RG16F:t.RG16F,RGBA16F:t.RGBA16F,R32F:t.R32F,RG32F:t.RG32F,RGBA32F:t.RGBA32F,R11F_G11F_B10F:t.R11F_G11F_B10F,RGB16F:t.RGB16F}:null}if(t instanceof WebGLRenderingContext){const r=!e.colorBufferHalfFloat&&t.getExtension("EXT_color_buffer_half_float"),i=!e.colorBufferFloat&&t.getExtension("WEBGL_color_buffer_float"),s=!e.floatBlend&&!e.colorBufferFloat&&t.getExtension("EXT_float_blend");return r||i||s?{textureFloat:!!i,textureHalfFloat:!!r,floatBlend:!!s,RGBA16F:r?r.RGBA16F_EXT:void 0,RGB16F:r?r.RGB16F_EXT:void 0,RGBA32F:i?i.RGBA32F_EXT:void 0}:null}return null}function nA(t,e,r,i,s){if(i&&Sm(t))return!0;if(e[r])return!1;for(const n of s)if(t.getExtension(n))return!0;return!1}function Vvt(t,e){if(!Sm(t)||e.textureNorm16)return null;const r=t.getExtension("EXT_texture_norm16");return r?{R16:r.R16_EXT,RG16:r.RG16_EXT,RGB16:r.RGB16_EXT,RGBA16:r.RGBA16_EXT,R16_SNORM:r.R16_SNORM_EXT,RG16_SNORM:r.RG16_SNORM_EXT,RGB16_SNORM:r.RGB16_SNORM_EXT,RGBA16_SNORM:r.RGBA16_SNORM_EXT}:null}function Bvt(t,e){const r=e.loseContext&&t.getExtension("WEBGL_lose_context");return r?{loseRenderingContext:()=>r.loseContext()}:null}function zvt(t,e){if(Sm(t))return{createVertexArray:t.createVertexArray.bind(t),deleteVertexArray:t.deleteVertexArray.bind(t),bindVertexArray:t.bindVertexArray.bind(t)};if(e.vao)return null;const r=t.getExtension("OES_vertex_array_object")||t.getExtension("MOZ_OES_vertex_array_object")||t.getExtension("WEBKIT_OES_vertex_array_object");return r?{createVertexArray:r.createVertexArrayOES.bind(r),deleteVertexArray:r.deleteVertexArrayOES.bind(r),bindVertexArray:r.bindVertexArrayOES.bind(r)}:null}let Gvt=class{constructor(e,r){this._gl=e,this._instancing=null,this._vertexArrayObject=null,this._compressedTextureETC=null,this._compressedTextureS3TC=null,this._textureFilterAnisotropic=null,this._textureFloat=null,this._colorBufferFloat=null,this._minMaxBlending=null,this._loseContext=null,this._drawBuffers=null,this._textureNorm16=null,this._depthTexture=null,this._standardDerivatives=null,this._shaderTextureLOD=null,this._fragDepth=null,this._textureFloatLinear=null,this._disabledExtensions=r.disabledExtensions||{},this._debugWebGLExtensions=r.debugWebGLExtensions||{}}get drawBuffers(){return this._drawBuffers||(this._drawBuffers=Ivt(this._gl,this._disabledExtensions)),this._drawBuffers}get instancing(){return this._instancing||(this._instancing=$vt(this._gl)),this._instancing}get vao(){return this._vertexArrayObject||(this._vertexArrayObject=zvt(this._gl,this._disabledExtensions)),this._vertexArrayObject}get compressedTextureETC(){return this._compressedTextureETC||(this._compressedTextureETC=Lvt(this._gl,this._disabledExtensions)),this._compressedTextureETC}get compressedTextureS3TC(){return this._compressedTextureS3TC||(this._compressedTextureS3TC=Dvt(this._gl,this._disabledExtensions)),this._compressedTextureS3TC}get textureFilterAnisotropic(){return this._textureFilterAnisotropic||(this._textureFilterAnisotropic=Fvt(this._gl,this._disabledExtensions)),this._textureFilterAnisotropic}get disjointTimerQuery(){return this._disjointTimerQuery||(this._disjointTimerQuery=j_t(this._gl,this._disabledExtensions)),this._disjointTimerQuery}get textureFloat(){return this._textureFloat||(this._textureFloat=Uvt(this._gl,this._disabledExtensions)),this._textureFloat}get colorBufferFloat(){return this._colorBufferFloat||(this._colorBufferFloat=kvt(this._gl,this._disabledExtensions)),this._colorBufferFloat}get blendMinMax(){return this._minMaxBlending||(this._minMaxBlending=Nvt(this._gl,this._disabledExtensions)),this._minMaxBlending}get depthTexture(){return this._depthTexture===null&&(this._depthTexture=nA(this._gl,this._disabledExtensions,"depthTexture",!0,["WEBGL_depth_texture","MOZ_WEBGL_depth_texture","WEBKIT_WEBGL_depth_texture"])),this._depthTexture}get standardDerivatives(){return this._standardDerivatives===null&&(this._standardDerivatives=nA(this._gl,this._disabledExtensions,"standardDerivatives",!0,["OES_standard_derivatives"])),this._standardDerivatives}get shaderTextureLOD(){return this._shaderTextureLOD===null&&(this._shaderTextureLOD=nA(this._gl,this._disabledExtensions,"shaderTextureLOD",!0,["EXT_shader_texture_lod"])),this._shaderTextureLOD}get fragDepth(){return this._fragDepth===null&&(this._fragDepth=nA(this._gl,this._disabledExtensions,"fragDepth",!0,["EXT_frag_depth"])),this._fragDepth}get loseContext(){return this._loseContext||(this._loseContext=Bvt(this._gl,this._debugWebGLExtensions)),this._loseContext}get textureNorm16(){return this._textureNorm16||(this._textureNorm16=Vvt(this._gl,this._disabledExtensions)),this._textureNorm16}get textureFloatLinear(){return this._textureFloatLinear===null&&(this._textureFloatLinear=nA(this._gl,this._disabledExtensions,"textureFloatLinear",!1,["OES_texture_float_linear"])),this._textureFloatLinear}enable(e){return this[e]}},jvt=class{constructor(e,r){this.gl=e,this.instanceCounter=new Z_t,this.programCache=new Tvt(this),this._state=new ace,this._numOfDrawCalls=0,this._numOfTriangles=0,this.type=Sm(e)?vt.WEBGL2:vt.WEBGL1,this._loadExtensions(),this.configure(r)}get gl2(){return this.type===vt.WEBGL1?null:this.gl}configure(e){this._capabilities=new Gvt(this.gl,e),this._parameters=this._loadParameters(e);const r=this.gl.getParameter(this.gl.VIEWPORT);this._state=new ace,this._state.viewport={x:r[0],y:r[1],width:r[2],height:r[3]},this._stateTracker=new oWe({setBlending:i=>{if(i){this.setBlendingEnabled(!0),this.setBlendEquationSeparate(i.opRgb,i.opAlpha),this.setBlendFunctionSeparate(i.srcRgb,i.dstRgb,i.srcAlpha,i.dstAlpha);const s=i.color;this.setBlendColor(s.r,s.g,s.b,s.a)}else this.setBlendingEnabled(!1)},setCulling:i=>{i?(this.setFaceCullingEnabled(!0),this.setCullFace(i.face),this.setFrontFace(i.mode)):this.setFaceCullingEnabled(!1)},setPolygonOffset:i=>{i?(this.setPolygonOffsetFillEnabled(!0),this.setPolygonOffset(i.factor,i.units)):this.setPolygonOffsetFillEnabled(!1)},setDepthTest:i=>{i?(this.setDepthTestEnabled(!0),this.setDepthFunction(i.func)):this.setDepthTestEnabled(!1)},setStencilTest:i=>{if(i){this.setStencilTestEnabled(!0);const s=i.function;this.setStencilFunction(s.func,s.ref,s.mask);const n=i.operation;this.setStencilOp(n.fail,n.zFail,n.zPass)}else this.setStencilTestEnabled(!1)},setDepthWrite:i=>{i?(this.setDepthWriteEnabled(!0),this.setDepthRange(i.zNear,i.zFar)):this.setDepthWriteEnabled(!1)},setColorWrite:i=>{i?this.setColorMask(i.r,i.g,i.b,i.a):this.setColorMask(!1,!1,!1,!1)},setStencilWrite:i=>{i?this.setStencilWriteMask(i.mask):this.setStencilWriteMask(0)}}),this.enforceState(),Qe(this._driverTest),this._driverTest=new Pvt(this)}dispose(){Qe(this._driverTest),this.programCache.dispose(),this.bindVAO(null),this.unbindBuffer(Ot.ARRAY_BUFFER),this.unbindBuffer(Ot.ELEMENT_ARRAY_BUFFER),this.type===vt.WEBGL2&&(this.unbindBuffer(Ot.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(Ot.PIXEL_PACK_BUFFER),this.unbindBuffer(Ot.PIXEL_UNPACK_BUFFER),this.unbindBuffer(Ot.COPY_READ_BUFFER),this.unbindBuffer(Ot.COPY_WRITE_BUFFER)),this._state.textureUnitMap.length=0,du()&&console.log(this.instanceCounter.resourceInformation)}get driverTest(){return this._driverTest}get contextAttributes(){return this.gl.getContextAttributes()}get parameters(){return this._parameters}setPipelineState(e){this._stateTracker.setPipeline(e)}setBlendingEnabled(e){this._state.blend!==e&&(e===!0?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this._state.blend=e,this._stateTracker.invalidateBlending())}externalProgramUpdate(){var e;(e=this._state.program)==null||e.stop(),this._state.program=null}externalTextureUnitUpdate(e,r){for(let i=0;i<e.length;++i)this._state.textureUnitMap[e[i]]=null;r>=0&&(this._state.activeTexture=r)}externalVertexArrayObjectUpdate(){const e=this.capabilities.vao;e&&(e.bindVertexArray(null),this._state.vertexArrayObject=null),this._state.vertexBuffer=null,this._state.indexBuffer=null}externalVertexBufferUpdate(){this._state.vertexBuffer=null}externalIndexBufferUpdate(){this._state.indexBuffer=null}setBlendColor(e,r,i,s){e===this._state.blendColor.r&&r===this._state.blendColor.g&&i===this._state.blendColor.b&&s===this._state.blendColor.a||(this.gl.blendColor(e,r,i,s),this._state.blendColor.r=e,this._state.blendColor.g=r,this._state.blendColor.b=i,this._state.blendColor.a=s,this._stateTracker.invalidateBlending())}setBlendFunction(e,r){e===this._state.blendFunction.srcRGB&&r===this._state.blendFunction.dstRGB||(this.gl.blendFunc(e,r),this._state.blendFunction.srcRGB=e,this._state.blendFunction.srcAlpha=e,this._state.blendFunction.dstRGB=r,this._state.blendFunction.dstAlpha=r,this._stateTracker.invalidateBlending())}setBlendFunctionSeparate(e,r,i,s){this._state.blendFunction.srcRGB===e&&this._state.blendFunction.srcAlpha===i&&this._state.blendFunction.dstRGB===r&&this._state.blendFunction.dstAlpha===s||(this.gl.blendFuncSeparate(e,r,i,s),this._state.blendFunction.srcRGB=e,this._state.blendFunction.srcAlpha=i,this._state.blendFunction.dstRGB=r,this._state.blendFunction.dstAlpha=s,this._stateTracker.invalidateBlending())}setBlendEquation(e){this._state.blendEquation.mode!==e&&(this.gl.blendEquation(e),this._state.blendEquation.mode=e,this._state.blendEquation.modeAlpha=e,this._stateTracker.invalidateBlending())}setBlendEquationSeparate(e,r){this._state.blendEquation.mode===e&&this._state.blendEquation.modeAlpha===r||(this.gl.blendEquationSeparate(e,r),this._state.blendEquation.mode=e,this._state.blendEquation.modeAlpha=r,this._stateTracker.invalidateBlending())}setColorMask(e,r,i,s){this._state.colorMask.r===e&&this._state.colorMask.g===r&&this._state.colorMask.b===i&&this._state.colorMask.a===s||(this.gl.colorMask(e,r,i,s),this._state.colorMask.r=e,this._state.colorMask.g=r,this._state.colorMask.b=i,this._state.colorMask.a=s,this._stateTracker.invalidateColorWrite())}setClearColor(e,r,i,s){this._state.clearColor.r===e&&this._state.clearColor.g===r&&this._state.clearColor.b===i&&this._state.clearColor.a===s||(this.gl.clearColor(e,r,i,s),this._state.clearColor.r=e,this._state.clearColor.g=r,this._state.clearColor.b=i,this._state.clearColor.a=s)}setFaceCullingEnabled(e){this._state.faceCulling!==e&&(e===!0?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this._state.faceCulling=e,this._stateTracker.invalidateCulling())}setPolygonOffsetFillEnabled(e){this._state.polygonOffsetFill!==e&&(e===!0?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL),this._state.polygonOffsetFill=e,this._stateTracker.invalidatePolygonOffset())}setPolygonOffset(e,r){this._state.polygonOffset[0]===e&&this._state.polygonOffset[1]===r||(this._state.polygonOffset[0]=e,this._state.polygonOffset[1]=r,this.gl.polygonOffset(e,r),this._stateTracker.invalidatePolygonOffset())}setCullFace(e){this._state.cullFace!==e&&(this.gl.cullFace(e),this._state.cullFace=e,this._stateTracker.invalidateCulling())}setFrontFace(e){this._state.frontFace!==e&&(this.gl.frontFace(e),this._state.frontFace=e,this._stateTracker.invalidateCulling())}setScissorTestEnabled(e){this._state.scissorTest!==e&&(e===!0?this.gl.enable(this.gl.SCISSOR_TEST):this.gl.disable(this.gl.SCISSOR_TEST),this._state.scissorTest=e)}setScissorRect(e,r,i,s){this._state.scissorRect.x===e&&this._state.scissorRect.y===r&&this._state.scissorRect.width===i&&this._state.scissorRect.height===s||(this.gl.scissor(e,r,i,s),this._state.scissorRect.x=e,this._state.scissorRect.y=r,this._state.scissorRect.width=i,this._state.scissorRect.height=s)}setDepthTestEnabled(e){this._state.depthTest!==e&&(e===!0?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST),this._state.depthTest=e,this._stateTracker.invalidateDepthTest())}setClearDepth(e){this._state.clearDepth!==e&&(this.gl.clearDepth(e),this._state.clearDepth=e)}setDepthFunction(e){this._state.depthFunction!==e&&(this.gl.depthFunc(e),this._state.depthFunction=e,this._stateTracker.invalidateDepthTest())}setDepthWriteEnabled(e){this._state.depthWrite!==e&&(this.gl.depthMask(e),this._state.depthWrite=e,this._stateTracker.invalidateDepthWrite())}setDepthRange(e,r){this._state.depthRange.zNear===e&&this._state.depthRange.zFar===r||(this.gl.depthRange(e,r),this._state.depthRange.zNear=e,this._state.depthRange.zFar=r,this._stateTracker.invalidateDepthWrite())}setStencilTestEnabled(e){this._state.stencilTest!==e&&(e===!0?this.gl.enable(this.gl.STENCIL_TEST):this.gl.disable(this.gl.STENCIL_TEST),this._state.stencilTest=e,this._stateTracker.invalidateStencilTest())}setClearStencil(e){e!==this._state.clearStencil&&(this.gl.clearStencil(e),this._state.clearStencil=e)}setStencilFunction(e,r,i){this._state.stencilFunction.func===e&&this._state.stencilFunction.ref===r&&this._state.stencilFunction.mask===i||(this.gl.stencilFunc(e,r,i),this._state.stencilFunction.face=Qd.FRONT_AND_BACK,this._state.stencilFunction.func=e,this._state.stencilFunction.ref=r,this._state.stencilFunction.mask=i,this._stateTracker.invalidateStencilTest())}setStencilFunctionSeparate(e,r,i,s){this._state.stencilFunction.face===e&&this._state.stencilFunction.func===r&&this._state.stencilFunction.ref===i&&this._state.stencilFunction.mask===s||(this.gl.stencilFuncSeparate(e,r,i,s),this._state.stencilFunction.face=e,this._state.stencilFunction.func=r,this._state.stencilFunction.ref=i,this._state.stencilFunction.mask=s,this._stateTracker.invalidateStencilTest())}setStencilWriteMask(e){this._state.stencilWriteMask!==e&&(this.gl.stencilMask(e),this._state.stencilWriteMask=e,this._stateTracker.invalidateStencilWrite())}setStencilOp(e,r,i){this._state.stencilOperation.face===Qd.FRONT_AND_BACK&&this._state.stencilOperation.fail===e&&this._state.stencilOperation.zFail===r&&this._state.stencilOperation.zPass===i||(this.gl.stencilOp(e,r,i),this._state.stencilOperation.face=Qd.FRONT_AND_BACK,this._state.stencilOperation.fail=e,this._state.stencilOperation.zFail=r,this._state.stencilOperation.zPass=i,this._stateTracker.invalidateStencilTest())}setStencilOpSeparate(e,r,i,s){this._state.stencilOperation.face===e&&this._state.stencilOperation.fail===r&&this._state.stencilOperation.zFail===i&&this._state.stencilOperation.zPass===s||(this.gl.stencilOpSeparate(e,r,i,s),this._state.stencilOperation.face=e,this._state.stencilOperation.fail=r,this._state.stencilOperation.zFail=i,this._state.stencilOperation.zPass=s,this._stateTracker.invalidateStencilTest())}setActiveTexture(e,r=!1){const i=this._state.activeTexture;return e>=0&&(r||e!==this._state.activeTexture)&&(this.gl.activeTexture(a8+e),this._state.activeTexture=e),i}clear(e){e&&this.gl.clear(e)}clearSafe(e,r=255){e&&(e&Li.COLOR_BUFFER_BIT&&this.setColorMask(!0,!0,!0,!0),e&Li.DEPTH_BUFFER_BIT&&this.setDepthWriteEnabled(!0),e&Li.STENCIL_BUFFER_BIT&&this.setStencilWriteMask(r),this.gl.clear(e))}drawArrays(e,r,i){if(du()&&(this._numOfDrawCalls++,this._numOfTriangles+=xce(e,i)),this.gl.drawArrays(e,r,i),du()){const s=tie(this);s&&console.error("drawArrays:",s)}}drawElements(e,r,i,s){if(du()&&(this._numOfDrawCalls++,this._numOfTriangles+=xce(e,r)),this.gl.drawElements(e,r,i,s),du()){const n=tie(this);if(n){const o=this.getBoundVAO(),a=o==null?void 0:o.indexBuffer,l=o==null?void 0:o.vertexBuffers,c={indexBuffer:a,vertexBuffers:l},h={mode:e,count:r,type:i,offset:s},p=so(a,y=>y.size)??0,f=s+r,m=p<f?`. Buffer is too small. Attempted to draw index ${f} of ${p}`:"";console.error(`drawElements: ${n}${m}`,{args:h,vao:c})}}}logInfo(){du()&&console.log(`DrawCalls: ${this._numOfDrawCalls}, Triangles: ${this._numOfTriangles}`)}resetInfo(){du()&&(this._numOfDrawCalls=0,this._numOfTriangles=0)}get capabilities(){return this._capabilities}setViewport(e,r,i,s){i=Math.max(Math.round(i),1),s=Math.max(Math.round(s),1);const n=this._state.viewport;n.x===e&&n.y===r&&n.width===i&&n.height===s||(n.x=e,n.y=r,n.width=i,n.height=s,this.gl.viewport(e,r,i,s))}getViewport(){const e=this._state.viewport;return{x:e.x,y:e.y,width:e.width,height:e.height}}useProgram(e){var r;this._state.program!==e&&((r=this._state.program)==null||r.stop(),this._state.program=e,this.gl.useProgram((e==null?void 0:e.glName)??null))}bindTexture(e,r,i=!1){(r>=this.parameters.maxTextureImageUnits||r<0)&&console.error("Input texture unit is out of range of available units!");const s=this._state.textureUnitMap[r];return C(e)||e.glName==null?(v(s)&&(this.setActiveTexture(r,i),this.gl.bindTexture(s.descriptor.target,null)),this._state.textureUnitMap[r]=null,s):i||s!==e?(this.setActiveTexture(r,i),this.gl.bindTexture(e.descriptor.target,e.glName),e.applyChanges(),this._state.textureUnitMap[r]=e,s):(e.isDirty&&(this.setActiveTexture(r,i),e.applyChanges()),s)}unbindTexture(e){if(!C(e))for(let r=0;r<this.parameters.maxTextureImageUnits;r++)this._state.textureUnitMap[r]===e&&(this.bindTexture(null,r),this._state.textureUnitMap[r]=null)}bindFramebuffer(e,r=!1){if(r||this._state.readFramebuffer!==e||this._state.drawFramebuffer!==e){if(C(e))return this.gl.bindFramebuffer(Zn.FRAMEBUFFER,null),this._state.readFramebuffer=null,void(this._state.drawFramebuffer=null);e.initializeAndBind(Zn.FRAMEBUFFER),this._state.readFramebuffer=e,this._state.drawFramebuffer=e}}bindFramebufferSeparate(e,r,i=!1){const s=r===Zn.READ_FRAMEBUFFER,n=s?this._state.readFramebuffer:this._state.drawFramebuffer;(i||n!==e)&&(C(e)?this.gl.bindFramebuffer(r,null):e.initializeAndBind(r),s?this._state.readFramebuffer=It(e,null):this._state.drawFramebuffer=It(e,null))}blitFramebuffer(e,r,i=0,s=0,n=e.width,o=e.height,a=0,l=0,c=r.width,h=r.height,p=Li.COLOR_BUFFER_BIT,f=tt.NEAREST){this.bindFramebufferSeparate(e,Zn.READ_FRAMEBUFFER),this.bindFramebufferSeparate(r,Zn.DRAW_FRAMEBUFFER),this.gl.blitFramebuffer(i,s,n,o,a,l,c,h,p,f)}bindBuffer(e,r){if(e)switch(r??(r=e.bufferType),r){case Ot.ARRAY_BUFFER:this._state.vertexBuffer=tc(this.gl,e,r,this._state.vertexBuffer);break;case Ot.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=tc(this.gl,e,r,this._state.indexBuffer);break;case Ot.UNIFORM_BUFFER:this._state.uniformBuffer=tc(this.gl,e,r,this._state.uniformBuffer);break;case Ot.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=tc(this.gl,e,r,this._state.pixelPackBuffer);break;case Ot.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=tc(this.gl,e,r,this._state.pixelUnpackBuffer);break;case Ot.COPY_READ_BUFFER:this._state.copyReadBuffer=tc(this.gl,e,r,this._state.copyReadBuffer);break;case Ot.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=tc(this.gl,e,r,this._state.copyWriteBuffer)}}bindRenderbuffer(e){const r=this.gl;e||(r.bindRenderbuffer(r.RENDERBUFFER,null),this._state.renderbuffer=null),this._state.renderbuffer!==e&&(r.bindRenderbuffer(r.RENDERBUFFER,e.glName),this._state.renderbuffer=e)}_getBufferBinding(e,r){if(r>=this.parameters.maxUniformBufferBindings||r<0)return console.error("Uniform buffer binding point is out of range!"),null;const i=this._state.uniformBufferBindingPoints;let s=i[r];return C(s)&&(s={buffer:null,offset:0,size:0},i[r]=s),s}bindBufferBase(e,r,i){const s=this._getBufferBinding(e,r);C(s)||s.buffer===i&&s.offset===0&&s.size===0||(this.gl.bindBufferBase(e,r,i?i.glName:null),s.buffer=i,s.offset=0,s.size=0)}bindBufferRange(e,r,i,s,n){const o=this._getBufferBinding(e,r);if(!C(o)&&!(o.buffer===i&&o.offset===s&&o.size===n)){if(s%this._parameters.uniformBufferOffsetAlignment!=0)return void console.error("Uniform buffer binding offset is not a multiple of the context offset alignment");this.gl.bindBufferRange(e,r,i.glName,s,n),o.buffer=i,o.offset=s,o.size=n}}bindUBO(e,r,i,s){C(r)?this.bindBufferBase(Ot.UNIFORM_BUFFER,e,null):(du()&&(s??r.byteLength)>this._parameters.maxUniformBlockSize&&console.error("Attempting to bind more data than the maximum uniform block size"),r.initialize(),i!==void 0&&s!==void 0?this.bindBufferRange(Ot.UNIFORM_BUFFER,e,r.buffer,i,s):this.bindBufferBase(Ot.UNIFORM_BUFFER,e,r.buffer))}unbindUBO(e){for(let r=0,i=this._state.uniformBufferBindingPoints.length;r<i;r++){const s=this._state.uniformBufferBindingPoints[r];v(s)&&s.buffer===e.buffer&&this.bindBufferBase(Ot.UNIFORM_BUFFER,r,null)}}unbindBuffer(e){switch(e){case Ot.ARRAY_BUFFER:this._state.vertexBuffer=tc(this.gl,null,e,this._state.vertexBuffer);break;case Ot.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=tc(this.gl,null,e,this._state.indexBuffer);break;case Ot.UNIFORM_BUFFER:this._state.uniformBuffer=tc(this.gl,null,e,this._state.uniformBuffer);break;case Ot.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=tc(this.gl,null,e,this._state.pixelPackBuffer);break;case Ot.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=tc(this.gl,null,e,this._state.pixelUnpackBuffer);break;case Ot.COPY_READ_BUFFER:this._state.copyReadBuffer=tc(this.gl,null,e,this._state.copyReadBuffer);break;case Ot.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=tc(this.gl,null,e,this._state.copyWriteBuffer)}}bindVAO(e=null){C(e)?this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null):this._state.vertexArrayObject!==e&&(e.bind(),this._state.vertexArrayObject=e)}async clientWaitAsync(e=10){const r=this.gl,i=r.fenceSync(wG.SYNC_GPU_COMMANDS_COMPLETE,0);if(!i)throw new Error("Client wait failed, could not create sync object");let s;this.instanceCounter.increment(Nn.Sync,i),r.flush();do await nw(e),s=r.clientWaitSync(i,0,0);while(s===JN.TIMEOUT_EXPIRED);if(this.instanceCounter.decrement(Nn.Sync,i),r.deleteSync(i),s===JN.WAIT_FAILED)throw new Error("Client wait failed")}getBoundFramebufferObject(e=Zn.FRAMEBUFFER){return e===Zn.READ_FRAMEBUFFER?this._state.readFramebuffer:this._state.drawFramebuffer}getBoundVAO(){return this._state.vertexArrayObject}resetState(){this.useProgram(null),this.bindVAO(null),this.bindFramebuffer(null,!0),this.unbindBuffer(Ot.ARRAY_BUFFER),this.unbindBuffer(Ot.ELEMENT_ARRAY_BUFFER),this.type===vt.WEBGL2&&(this.unbindBuffer(Ot.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(Ot.PIXEL_PACK_BUFFER),this.unbindBuffer(Ot.PIXEL_UNPACK_BUFFER),this.unbindBuffer(Ot.COPY_READ_BUFFER),this.unbindBuffer(Ot.COPY_WRITE_BUFFER));for(let e=0;e<this.parameters.maxTextureImageUnits;++e)this.bindTexture(null,e);this.setBlendingEnabled(!1),this.setBlendFunction(Ee.ONE,Ee.ZERO),this.setBlendEquation(cm.ADD),this.setBlendColor(0,0,0,0),this.setFaceCullingEnabled(!1),this.setCullFace(Qd.BACK),this.setFrontFace(ZS.CCW),this.setPolygonOffsetFillEnabled(!1),this.setPolygonOffset(0,0),this.setScissorTestEnabled(!1),this.setScissorRect(0,0,this.gl.canvas.width,this.gl.canvas.height),this.setDepthTestEnabled(!1),this.setDepthFunction(Mi.LESS),this.setDepthRange(0,1),this.setStencilTestEnabled(!1),this.setStencilFunction(Mi.ALWAYS,0,0),this.setStencilOp(Ls.KEEP,Ls.KEEP,Ls.KEEP),this.setClearColor(0,0,0,0),this.setClearDepth(1),this.setClearStencil(0),this.setColorMask(!0,!0,!0,!0),this.setStencilWriteMask(4294967295),this.setDepthWriteEnabled(!0),this.setViewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}enforceState(){var n,o,a;const e=this.capabilities.vao;e&&e.bindVertexArray(null);const{gl:r,gl2:i}=this;for(let l=0;l<this.parameters.maxVertexAttributes;l++)r.disableVertexAttribArray(l);if(this._state.vertexBuffer?r.bindBuffer(this._state.vertexBuffer.bufferType,this._state.vertexBuffer.glName):r.bindBuffer(Ot.ARRAY_BUFFER,null),this._state.indexBuffer?r.bindBuffer(this._state.indexBuffer.bufferType,this._state.indexBuffer.glName):r.bindBuffer(Ot.ELEMENT_ARRAY_BUFFER,null),v(i)){this._state.uniformBuffer?i.bindBuffer(this._state.uniformBuffer.bufferType,this._state.uniformBuffer.glName):i.bindBuffer(Ot.UNIFORM_BUFFER,null);for(let l=0;l<this._parameters.maxUniformBufferBindings;l++){const c=this._state.uniformBufferBindingPoints[l];if(v(c)){const{buffer:h,offset:p,size:f}=c;h!==null?p===0&&f===0?i.bindBufferBase(Ot.UNIFORM_BUFFER,l,h.glName):i.bindBufferRange(Ot.UNIFORM_BUFFER,l,h.glName,p,f):i.bindBufferBase(Ot.UNIFORM_BUFFER,l,null)}}this._state.pixelPackBuffer?i.bindBuffer(this._state.pixelPackBuffer.bufferType,this._state.pixelPackBuffer.glName):i.bindBuffer(Ot.PIXEL_PACK_BUFFER,null),this._state.pixelUnpackBuffer?i.bindBuffer(this._state.pixelUnpackBuffer.bufferType,this._state.pixelUnpackBuffer.glName):i.bindBuffer(Ot.PIXEL_UNPACK_BUFFER,null),this._state.copyReadBuffer?i.bindBuffer(this._state.copyReadBuffer.bufferType,this._state.copyReadBuffer.glName):i.bindBuffer(Ot.COPY_READ_BUFFER,null),this._state.copyWriteBuffer?i.bindBuffer(this._state.copyWriteBuffer.bufferType,this._state.copyWriteBuffer.glName):i.bindBuffer(Ot.COPY_WRITE_BUFFER,null),i.bindFramebuffer(Zn.READ_FRAMEBUFFER,null),i.readBuffer(i.BACK),this._state.readFramebuffer&&(i.bindFramebuffer(Zn.READ_FRAMEBUFFER,this._state.readFramebuffer.glName),i.readBuffer(lu.COLOR_ATTACHMENT0)),i.bindFramebuffer(Zn.DRAW_FRAMEBUFFER,((n=this._state.drawFramebuffer)==null?void 0:n.glName)??null)}else this._state.readFramebuffer=this._state.drawFramebuffer,r.bindFramebuffer(Zn.FRAMEBUFFER,((o=this._state.drawFramebuffer)==null?void 0:o.glName)??null);if(e&&this._state.vertexArrayObject){const l=this._state.vertexArrayObject;this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null),this.bindVAO(l)}r.useProgram(((a=this._state.program)==null?void 0:a.glName)??null),r.blendColor(this._state.blendColor.r,this._state.blendColor.g,this._state.blendColor.b,this._state.blendColor.a),r.bindRenderbuffer(r.RENDERBUFFER,this._state.renderbuffer?this._state.renderbuffer.glName:null),this._state.blend===!0?r.enable(this.gl.BLEND):r.disable(this.gl.BLEND),r.blendEquationSeparate(this._state.blendEquation.mode,this._state.blendEquation.modeAlpha),r.blendFuncSeparate(this._state.blendFunction.srcRGB,this._state.blendFunction.dstRGB,this._state.blendFunction.srcAlpha,this._state.blendFunction.dstAlpha),r.clearColor(this._state.clearColor.r,this._state.clearColor.g,this._state.clearColor.b,this._state.clearColor.a),r.clearDepth(this._state.clearDepth),r.clearStencil(this._state.clearStencil),r.colorMask(this._state.colorMask.r,this._state.colorMask.g,this._state.colorMask.b,this._state.colorMask.a),r.cullFace(this._state.cullFace),r.depthFunc(this._state.depthFunction),r.depthRange(this._state.depthRange.zNear,this._state.depthRange.zFar),this._state.depthTest===!0?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),r.depthMask(this._state.depthWrite),r.frontFace(this._state.frontFace),r.lineWidth(1),this._state.faceCulling===!0?r.enable(r.CULL_FACE):r.disable(r.CULL_FACE),r.polygonOffset(this._state.polygonOffset[0],this._state.polygonOffset[1]),this._state.polygonOffsetFill===!0?r.enable(r.POLYGON_OFFSET_FILL):r.disable(r.POLYGON_OFFSET_FILL),r.scissor(this._state.scissorRect.x,this._state.scissorRect.y,this._state.scissorRect.width,this._state.scissorRect.height),this._state.scissorTest===!0?r.enable(r.SCISSOR_TEST):r.disable(r.SCISSOR_TEST),r.stencilFunc(this._state.stencilFunction.func,this._state.stencilFunction.ref,this._state.stencilFunction.mask),r.stencilOpSeparate(this._state.stencilOperation.face,this._state.stencilOperation.fail,this._state.stencilOperation.zFail,this._state.stencilOperation.zPass),this._state.stencilTest===!0?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST),r.stencilMask(this._state.stencilWriteMask);for(let l=0;l<this.parameters.maxTextureImageUnits;l++){r.activeTexture(a8+l),r.bindTexture(bt.TEXTURE_2D,null),r.bindTexture(bt.TEXTURE_CUBE_MAP,null),this.type===vt.WEBGL2&&(r.bindTexture(bt.TEXTURE_3D,null),r.bindTexture(bt.TEXTURE_2D_ARRAY,null));const c=this._state.textureUnitMap[l];v(c)&&r.bindTexture(c.descriptor.target,c.glName)}r.activeTexture(a8+this._state.activeTexture);const s=this._state.viewport;r.viewport(s.x,s.y,s.width,s.height),this.resetInfo()}_loadExtensions(){this.type===vt.WEBGL1&&this.gl.getExtension("OES_element_index_uint"),this.gl.getExtension("KHR_parallel_shader_compile")}_loadParameters(e){const r=this.capabilities.textureFilterAnisotropic,i=e.maxAnisotropy??1/0,s=this.type===vt.WEBGL2,n=this.gl,o={versionString:this.gl.getParameter(this.gl.VERSION),maxVertexTextureImageUnits:this.gl.getParameter(this.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxVertexAttributes:this.gl.getParameter(this.gl.MAX_VERTEX_ATTRIBS),maxMaxAnisotropy:r?Math.min(this.gl.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY),i):1,maxTextureImageUnits:this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),maxTextureSize:this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE),maxUniformBufferBindings:s?n.getParameter(n.MAX_UNIFORM_BUFFER_BINDINGS):0,maxVertexUniformBlocks:s?n.getParameter(n.MAX_VERTEX_UNIFORM_BLOCKS):0,maxFragmentUniformBlocks:s?n.getParameter(n.MAX_FRAGMENT_UNIFORM_BLOCKS):0,maxUniformBlockSize:s?n.getParameter(n.MAX_UNIFORM_BLOCK_SIZE):0,uniformBufferOffsetAlignment:s?n.getParameter(n.UNIFORM_BUFFER_OFFSET_ALIGNMENT):1,maxArrayTextureLayers:s?n.getParameter(n.MAX_ARRAY_TEXTURE_LAYERS):1,maxSamples:s?n.getParameter(n.MAX_SAMPLES):1};return ct.TEXTURE_UNIT_FOR_UPDATES=o.maxTextureImageUnits-1,o}};function tc(t,e,r,i){return e?i!==e&&t.bindBuffer(r,e.glName):t.bindBuffer(r,null),e}function xce(t,e){switch(t){case $t.POINTS:return 2*e;case $t.TRIANGLES:return e/3;case $t.TRIANGLE_STRIP:case $t.TRIANGLE_FAN:return e-2;default:return 0}}let Hvt=class extends jvt{constructor(e,r,i){super(e,r),this.newCache=i,this._refCount=1}destroy(){--this._refCount>0||this.dispose()}ref(){++this._refCount}bindTechnique(e,r,i,s){return this.useProgram(e.program),e.bindPipelineState(this,i==null?void 0:i.slot,!!s),e.program.bindPass(r,i),e.program}get test(){return this.programCache.test}},d2=class extends Te{constructor(e,r,i){super({}),this._stage=e,this._techniqueRepository=r,this._rctx=i,this._textures=new Map,this._loadingCount=0,this._frameUpdates=new Map,this.events=new vs,this._frameTask=e.view.resourceController.scheduler.registerTask(_t.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}destroy(){this._frameTask.remove(),this._stage.forEachOfType($s.Texture,e=>e.unload())}get updating(){return this._loadingCount>0||this._frameTask.updating}get textureTechnique(){return C(this._textureTechnique)&&(this._textureTechnique=this._techniqueRepository.acquire(GZ,new jZ)),this._textureTechnique}acquire(e){const r=this._textures.get(e);return r?(r.ref(),It(r.loadingPromise,r)):this._createNewRef(e)}update(){let e=!1;this._frameUpdates.forEach(r=>{const i=r.texture.frameUpdate(this._rctx,this.textureTechnique,r.previousToken);i>=0&&i!==r.previousToken&&(r.previousToken=i,e=!0)}),e&&this.events.emit("changed",Ps.BACKGROUND)}_createNewRef(e){const r=this._stage.getObject(e);if(C(r))return ft(r!==void 0),null;const i=r.events.on("unloaded",()=>{i.remove(),this._onTextureUnloaded(e)}),s=new qvt(e,()=>{this._frameTask.schedule(()=>{s.isUnreferenced&&r.unload()})});return this._textures.set(e,s),s.ref(),v(r.glTexture)?(this._updateGLTexture(s,r.glTexture),r.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:r,previousToken:-1}),s):(this._loadingCount++,s.loadingPromise=this._stage.schedule(()=>{const n=r.load(this._rctx,()=>this.textureTechnique),o=l=>(this._loadingCount--,s.loadingPromise=null,this._updateGLTexture(s,l),r.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:r,previousToken:-1}),s),a=l=>(this._loadingCount--,s.loadingPromise=null,Qs(l)||se.getLogger(this.declaredClass).error(l),null);return Uu(n)?n.then(o,a):o(n)}),s.loadingPromise)}_updateGLTexture(e,r){e.glTexture=r,this.events.emit("changed",Ps.UPDATE)}_onTextureUnloaded(e){this._textures.delete(e),this._frameUpdates.delete(e)}};u([d()],d2.prototype,"_loadingCount",void 0),u([d()],d2.prototype,"_frameTask",void 0),u([d()],d2.prototype,"updating",null),d2=u([I("esri.views.3d.webgl-engine.lib.TextureRepository")],d2);class qvt{constructor(e,r){this.id=e,this._release=r,this._refCount=0}get isUnreferenced(){return this._refCount===0}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(this._refCount!==0?(se.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}}let $3=class extends Te{constructor(){super(...arguments),this._passParameters=new Wvt,this._loading=0}get passParameters(){return this._passParameters}destroy(){this._passParameters.waveNormal=Qe(this._passParameters.waveNormal),this._passParameters.wavePertubation=Qe(this._passParameters.wavePertubation)}get updating(){return this._loading>0}ensureResources(e){if(this._loading>0)return Vg.LOADING;if(v(this._passParameters.waveNormal)&&v(this._passParameters.wavePertubation))return Vg.LOADED;const r={target:bt.TEXTURE_2D,pixelFormat:Ve.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Rt.REPEAT,samplingMode:tt.LINEAR_MIPMAP_LINEAR,hasMipmap:!0,maxAnisotropy:8};return++this._loading,sy(Wr("esri/images/materials/water/normals.jpg")).then(i=>this._passParameters.waveNormal=new ct(e,{...r,width:i.width,height:i.height},i)).catch(i=>se.getLogger(this.declaredClass).error("Failed to load water material normal texture.",i)).finally(()=>--this._loading),++this._loading,sy(Wr("esri/images/materials/water/perturbation.jpg")).then(i=>this._passParameters.wavePertubation=new ct(e,{...r,width:i.width,height:i.height},i)).catch(i=>se.getLogger(this.declaredClass).error("Failed to load water material pertubation texture.",i)).finally(()=>--this._loading),Vg.LOADING}};u([d()],$3.prototype,"_loading",void 0),u([d({type:Boolean,readOnly:!0})],$3.prototype,"updating",null),$3=u([I("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],$3);let Wvt=class extends pi{};const Tce=2048,Xvt=1.5,Yvt=8;function Zvt(t,e){const{format:r,quality:i,rotation:s,disableDecorations:n}=t||{},o=EJ(t,e.padding),a=i1t(t,{width:e.width-o.left-o.right,height:e.height-o.top-o.bottom}),{width:l,height:c}=r1t(t,a),h=o1t(r),p=h1t[h];return{format:h,quality:ge(i??p,0,100),area:a,width:l,height:c,rotation:s,disableDecorations:!!n,ignoreBackground:!(!t||!t.ignoreBackground),ignorePadding:!(!t||!t.ignorePadding)}}function Jvt(t,e){const r=Zvt(t,e),i=r.area,s=r.width/i.width,n=EJ(r,e.padding),o=n.left+n.right,a=n.top+n.bottom,l=e.width-o,c=e.height-a,h=Math.floor(l*s+o),p=Math.floor(c*s+a),f=t&&t.layers?t.layers:[],m=r.ignoreBackground,y=r.ignorePadding;return{framebufferWidth:h,framebufferHeight:p,region:{x:Math.floor(i.x*s)+n.left,y:Math.floor(i.y*s)+n.top,width:r.width,height:r.height},format:r.format,quality:r.quality,rotation:r.rotation,pixelRatio:s,layers:f,disableDecorations:r.disableDecorations,ignoreBackground:m,ignorePadding:y,objectAndLayerIdColor:!1}}function Sk(t,e,r){const{ctx:i,canvas:s}=qCe(t,r),n=i.getImageData(0,0,t.width,t.height),o=Qvt(s,e);return WCe(s),{dataUrl:o,data:n}}function Ek(t,e){const{ctx:r,canvas:i}=qCe(t,e),s=r.getImageData(0,0,t.width,t.height);return WCe(i),s}function qCe(t,e){const r=Kvt();e.premultipliedAlpha&&l1t(t),r.width=t.width,r.height=t.height;const i=r.getContext("2d",{willReadFrequently:!0});return i.putImageData(t,0,0),e.flipY&&a1t(i),{ctx:i,canvas:r}}function WCe(t){t.width=0,t.height=0}function Kvt(){return C(Ck)&&(Ck=document.createElement("canvas")),Ck}let Ck=null;function Qvt(t,e){const r=c1t[e.format],i=e.quality/100;return t.toDataURL(r,i)}function e1t(t,e,r,i=0,s=0,n=t.width-i,o=t.height-s,a=!1){const{data:l}=t,{width:c,height:h,data:p}=e,f=n/c,m=o/h,y=Math.ceil(f/2),_=Math.ceil(m/2),b=t.width;for(let x=0;x<h;x++)for(let T=0;T<c;T++){const S=4*(T+(a?h-x-1:x)*c);let E=0,O=0,R=0,L=0,P=0,U=0;const B=(x+.5)*m;for(let z=Math.floor(x*m);z<(x+1)*m;z++){const G=Math.abs(B-(z+.5))/_,K=(T+.5)*f,ee=G*G;for(let Q=Math.floor(T*f);Q<(T+1)*f;Q++){const H=Math.abs(K-(Q+.5))/y,$=Math.sqrt(ee+H*H);if($>=1)continue;let N=2*$*$*$-3*$*$+1;const F=4*(i+Q+(s+z)*b);U+=N*l[F+3],O+=N,!r&&l[F+3]<255&&(N=N*l[F+3]/255),R+=N*l[F],L+=N*l[F+1],P+=N*l[F+2],E+=N}}p[S]=R/E,p[S+1]=L/E,p[S+2]=P/E,p[S+3]=U/O}return e}function t1t(t,e,r){if(!e)return t;const{framebufferWidth:i,framebufferHeight:s,pixelRatio:n,region:o}=t,a=EJ(t,r),l=a.left+a.right,c=a.top+a.bottom,h=i-l,p=s-c,f=Math.min(Yvt,Math.min((Tce-l)/h,(Tce-c)/p));return f<Xvt?t:{...t,framebufferWidth:Math.round(h*f)+l,framebufferHeight:Math.round(p*f)+c,pixelRatio:n*f,resample:{region:{x:Math.round((o.x-a.left)*f)+a.left,y:Math.round((o.y-a.top)*f)+a.top,width:Math.round(o.width*f),height:Math.round(o.height*f)},width:i,height:s}}}function r1t(t,e){if(!t)return e;const r=t.width,i=t.height;if(r!=null&&i!=null)return{width:Math.floor(r),height:Math.floor(i)};if(r==null&&i==null)return e;const s=e.width/e.height;return i==null?{width:Math.floor(r),height:Math.floor(r/s)}:{width:Math.floor(i*s),height:Math.floor(i)}}function i1t(t,e){const r={x:0,y:0,width:e.width,height:e.height};if(t&&t.area){t.area.x!=null&&(r.x=Math.floor(t.area.x)),t.area.y!=null&&(r.y=Math.floor(t.area.y));const i=t.area.width!=null?Math.floor(t.area.width):null,s=t.area.height!=null?Math.floor(t.area.height):null;if(r.width=e.width-r.x,r.height=e.height-r.y,i!=null&&s!=null)r.width=Math.min(r.width,i),r.height=Math.min(r.height,s);else if(i==null&&s!=null){const n=Math.min(r.width,i);r.height=n/r.width*r.height,r.width=n}else if(i!=null&&s==null){const n=Math.min(r.height,s);r.width=n/r.height*r.width,r.height=n}}return s1t(n1t(r,t),e)}function s1t(t,e){const r=Math.floor(Math.max(t.x,0)),i=Math.floor(Math.max(t.y,0)),s={x:r,y:i,width:Math.floor(Math.min(t.width,e.width-r)),height:Math.floor(Math.min(t.height,e.height-i))},n=s.width/s.height,o=t.width/t.height;if(o===n)return s;if(o>n){const c=Math.floor(s.width/o),h=s.height-c;return{x:s.x,y:Math.floor(s.y+h/2),width:s.width,height:c}}const a=Math.floor(s.height*o),l=s.width-a;return{x:Math.floor(s.x+l/2),y:s.y,width:a,height:s.height}}function n1t(t,e){if(!e||e.width==null||e.height==null)return t;const r=e.width/e.height,i=t.width/t.height;if(i===r)return t;if(i<r){const n=Math.floor(t.height*r);return t.x-=(n-t.width)/2,t.width=n,t}const s=Math.floor(t.width/r);return t.y-=(s-t.height)/2,t.height=s,t}function EJ(t,e){return!e||t&&t.ignorePadding?d1t:e}function o1t(t){switch(t){case"png":case"jpg":case"jpeg":return t;default:return u1t}}function a1t(t){t.save(),t.globalCompositeOperation="copy",t.scale(1,-1),t.translate(0,-t.canvas.height),t.drawImage(t.canvas,0,0),t.restore()}function l1t(t){const e=t.data,r=e.length;for(let i=0;i<r;i+=4){const s=e[i+3];if(s!==255&&s>0){const n=255/s;e[i+0]=e[i+0]*n,e[i+1]=e[i+1]*n,e[i+2]=e[i+2]*n}}}const c1t={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},Sce=98,u1t="png",h1t={png:100,jpg:Sce,jpeg:Sce},d1t={top:0,right:0,bottom:0,left:0};let p1t=class{constructor(e,r){this.viewCamera=e,this.frameHasDecorations=r}},f1t=class{constructor(e,r,i,s){this._rctx=e,this._renderFunctions=r,this._forceCameraHook=i,this._disposeOffscreenBuffers=s,this.supersample=!0,this._screenshotQueue=new Array}destroy(){this._rctx=null}async takeScreenshot(e){await this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(Ps.BACKGROUND);const r=H_();return this._screenshotQueue.push({settings:e,resolver:r}),r.promise}update(e,r){for(const i of this._screenshotQueue){if(this._rctx==null){i.resolver.reject();continue}const s={...i.settings,pixelRatio:i.settings.pixelRatio*e.viewCamera.pixelRatio},n=this._renderScreenshot(e,s,r);i.resolver(n)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,r,i){e.width=r.width,e.height=r.height;const s=e.getContext("2d"),n=i.pixelRatio;return s.save(),s.translate(0,r.height),s.scale(1,-1),i.region&&s.translate(-i.region.x,-i.region.y),s.scale(n,n),r=this._renderFunctions.renderOverlay(e,r),s.restore(),r}_readbackScreenshot(e,r){return e.resample?this._readbackScreenshotResampled({...e,resample:e.resample},r):this._readbackScreenshotImmediate(e,r)}_readbackScreenshotResampled(e,r){const{framebufferWidth:i,framebufferHeight:s,region:n,resample:o}=e,a=this._ensureScreenshotEncodeCanvas();let l=A9(i,s,a);this._rctx.gl.readPixels(0,0,i,s,Ve.RGBA,lt.UNSIGNED_BYTE,new Uint8Array(l.data.buffer)),r(),l=this._renderScreenshotOverlay(a,l,{...e,region:void 0});const c=A9(n.width,n.height,a);return e1t(l,c,!0,o.region.x,s-(o.region.y+o.region.height),o.region.width,o.region.height)}_readbackScreenshotImmediate(e,r){const{framebufferHeight:i,region:s}=e,n=this._ensureScreenshotEncodeCanvas(),o=A9(s.width,s.height,n);return this._rctx.gl.readPixels(s.x,i-(s.y+s.height),s.width,s.height,Ve.RGBA,lt.UNSIGNED_BYTE,new Uint8Array(o.data.buffer)),r(),this._renderScreenshotOverlay(n,o,e)}_renderScreenshot(e,r,i){let s=null,n=null;const o=e.viewCamera,{framebufferWidth:a,framebufferHeight:l}=r;let c=!1;const h=r.disableDecorations&&e.frameHasDecorations,p=a!==o.fullWidth||l!==o.fullHeight,f=r.ignorePadding&&o.pixelRatio!==r.pixelRatio,m=p||h||f||r.objectAndLayerIdColor;if(r.objectAndLayerIdColor&&(n=new Ds(this._rctx,{width:a,height:l,colorTarget:ls.TEXTURE,depthStencilTarget:$r.DEPTH_STENCIL_RENDER_BUFFER})),m){const x=o.clone();if(r.ignorePadding){const E=aM(x.padding);for(let O=0;O<4;O++)E[O]=Math.round(E[O]/x.pixelRatio*r.pixelRatio);x.padding=E}x.fullWidth=a,x.fullHeight=l,x.pixelRatio=r.pixelRatio;const T=o.fovX-x.fovX,S=o.fovY-x.fovY;T<0&&T<S?x.fovX=o.fovX:S<0&&S<T&&(x.fovY=o.fovY),this._forceCameraHook(x),c=!0,s=new Ds(this._rctx,{width:x.fullWidth,height:x.fullHeight,colorTarget:ls.TEXTURE,depthStencilTarget:$r.DEPTH_STENCIL_RENDER_BUFFER}),this._renderFunctions.renderScene(s,n,x,r.disableDecorations?Rw.OFF:Rw.ON,i),this._disposeOffscreenBuffers()}const y=()=>{this._rctx.bindFramebuffer(null),Qe(s)},_=this._readbackScreenshot(r,y);y();let b=null;if(r.objectAndLayerIdColor){const x=()=>{this._rctx.bindFramebuffer(null),Qe(n)};this._rctx.bindFramebuffer(n),b=this._readbackScreenshot(r,x),this._rctx.bindFramebuffer(null),x()}if(m&&!this._rctx.contextAttributes.alpha)for(let x=3;x<_.data.length;x+=4)_.data[x]=255;if(b&&!this._rctx.contextAttributes.alpha)for(let x=3;x<b.data.length;x+=4)b.data[x]=255;return c&&this._forceCameraHook(o),[_,b]}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}},wo=class extends Te{constructor(e){super({}),this.events=new vs,this.waterTextureRepository=new $3,this._magnifierHelper=new h2,this.objectAndLayerIdRenderHelper=de("enable-feature:objectAndLayerId-rendering")?new l0t:null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this._container=e.container,this._viewingMode=e.viewingMode,this._initializeContext(e),ie(()=>{var i;return(i=this.waterTextureRepository)==null?void 0:i.updating},()=>this.requestRender(),Vt),this._magnifierHelper.events.on("request-render",()=>this.requestRender()),this._stippleTextureRepository=new RTe(this._rctx),this._shaderTechniqueRepository=new xTe({rctx:this._rctx,viewingMode:e.viewingMode,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),this._textureRepository=new d2(e,this._shaderTechniqueRepository,this._rctx),this._textureRepository.events.on("changed",i=>this.requestRender(i)),this._materialRepository=new TTe(this._textureRepository,this._shaderTechniqueRepository,()=>this.requestRender(),()=>this.requestRender()),this._compositingHelper=new Vyt(this._rctx,this._shaderTechniqueRepository),this.renderer=new su(e,this._materialRepository,this._textureRepository,this._shaderTechniqueRepository,this._rctx,this._compositingHelper,this._magnifierHelper,i=>this.requestRender(i));const r={renderScene:(i,s,n,o,a)=>this.renderer.render(i,s,{camera:n,contentCamera:n,mode:Sr.IDLE},o,a),requestRenderScene:i=>this.requestRender(i),prepareOverlay:()=>e.options.screenshot.prepareOverlay(),renderOverlay:(i,s)=>e.options.screenshot.renderOverlay(i,s)};this._screenshotManager=new f1t(this._rctx,r,i=>this.events.emit("force-camera-for-screenshot",i),()=>this.renderer.disposeOffscreenBuffers()),this._registerFrameTask(e)}normalizeCtorArgs(){return{}}destroy(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask=ji(this._frameTask),this._shaderTechniqueRepository=ke(this._shaderTechniqueRepository)}get performanceInfo(){const e=this._rctx.gl;return{renderer:this.renderer.performanceInfo,textureMemory:e.getUsedTextureMemory!==void 0?e.getUsedTextureMemory():void 0,renderbufferMemory:e.getUsedRenderbufferMemory!==void 0?e.getUsedRenderbufferMemory():void 0,VBOMemory:e.getUsedVBOMemory!==void 0?e.getUsedVBOMemory():void 0}}requestRender(e=Ps.UPDATE){this._needsRender=!0,e===Ps.UPDATE&&(this._needsUpdate=!0)}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating}get textureRepository(){return this._textureRepository}get compositingHelper(){return this._compositingHelper}set magnifier(e){this._magnifierHelper.magnifier=e}setIdleSuspend(e){this._idleSuspend!==e&&(this._idleSuspend=e,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e).then(r=>r[0])}takeScreenshotWithOID(e){return e.objectAndLayerIdColor=!0,this._screenshotManager.takeScreenshot(e)}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(e,r,i,s,n,o=n){const a=s.constrainWindowSize(r,i,n*s.pixelRatio,o*s.pixelRatio),l=this._ensureDepthBuffer(a);this.renderer.readDepthPixels(s,a,l);let c=Number.MAX_VALUE;for(let h=0;h<a[2]*a[3];h++){const p=Hyt(4*h,l,s.nearFar);c>p&&p!==s.nearFar[0]&&p!==s.nearFar[1]&&(c=p)}if(v(e)){const h=e.pickDepth(r*s.pixelRatio,i*s.pixelRatio,s);v(h)&&c>h&&h!==s.nearFar[0]&&h!==s.nearFar[1]&&(c=h)}return c===Number.MAX_VALUE?void 0:c}_ensureDepthBuffer(e){const r=4*e[2]*e[3];return(C(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<r)&&(this._tmpDepthBuffer=new Uint8Array(r)),this._tmpDepthBuffer}async reloadShaders(){ZSe(),await this._shaderTechniqueRepository.reloadAll(),this.requestRender()}_registerFrameTask(e){const r=e.view.state;let i=!1,s=Ps.BACKGROUND,n=!1;const o={preRender:({time:a})=>{i=this.updating,s=this._needsUpdate?Ps.UPDATE:Ps.BACKGROUND,e.commitSyncLayers();const l=a-this._lastAnimationUpdate;if(l>this.renderer.animationTimestep||v(r.forcedAnimationTime)||i||this._needsRender){const c=l/this.renderer.animationTimeDilation,h=new rxe(r.camera,c,r.forcedAnimationTime);this.renderer.updateAnimation(h)&&this.requestRender(Ps.BACKGROUND),this._lastAnimationUpdate=a}},render:({time:a})=>{if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&r.camera.fullWidth>0&&r.camera.fullHeight>0){const l=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this.renderer.render(null,null,r,Rw.ON,a),n=!0,l&&this.renderer.hasWaterReflection&&(this.requestRender(Ps.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:({time:a})=>{const l=new p1t(r.camera,this.renderer.hasSlicePlane||this._magnifierHelper.enabled);this._textureRepository.update(),this._screenshotManager.update(l,a)},finish:()=>{n&&(this.renderer.finish(r.mode===Sr.IDLE?s:Ps.UPDATE),n=!1)}};this._frameTask=vS(o)}_initializeContext(e){const r=e.options;this._canvas=r.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const i={alpha:r.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:r.stencil==null||r.stencil,powerPreference:"high-performance",preserveDrawingBuffer:r.preserveDrawingBuffer??!1},s=cWe("3d",this._canvas,i);if(C(s)){const n=de("esri-force-webgl");se.getLogger(this.declaredClass).error(n)}else this._rctx=this._newRenderingContext(s,e),this._loadShaderOnlyExtensions(),!r.alpha&&this._rctx.contextAttributes.alpha&&se.getLogger(this.declaredClass).error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&de("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)}_newRenderingContext(e,r){const i={disabledExtensions:r.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:r.options.debugWebGLExtensions||{},maxAnisotropy:8},s=(n,o)=>r.view.resourceController.memoryController.newCache(n,o);return new Hvt(e,i,s)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("standardDerivatives"),this._rctx.capabilities.enable("shaderTextureLOD"),this._rctx.capabilities.enable("textureFloat")}getObjectAndLayerIdColor(e){return v(this.objectAndLayerIdRenderHelper)?this.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor(e):null}get componentObjectCollection(){return C(this._componentObjectCollection)&&(this._componentObjectCollection=new Myt(this.renderer.renderPassManager,this._viewingMode)),this._componentObjectCollection}set componentObjectCollection(e){this._componentObjectCollection=e}};u([d({type:Boolean,readOnly:!0})],wo.prototype,"updating",null),u([d({autoDestroy:!0})],wo.prototype,"_rctx",void 0),u([d({autoDestroy:!0})],wo.prototype,"_container",void 0),u([d({autoDestroy:!0})],wo.prototype,"_canvas",void 0),u([d({autoDestroy:!0})],wo.prototype,"_stippleTextureRepository",void 0),u([d({autoDestroy:!0})],wo.prototype,"waterTextureRepository",void 0),u([d({autoDestroy:!0})],wo.prototype,"_magnifierHelper",void 0),u([d({readOnly:!0})],wo.prototype,"objectAndLayerIdRenderHelper",void 0),u([d({autoDestroy:!0})],wo.prototype,"_textureRepository",void 0),u([d({autoDestroy:!0})],wo.prototype,"_compositingHelper",void 0),u([d({autoDestroy:!0,readOnly:!0})],wo.prototype,"renderer",void 0),u([d({autoDestroy:!0})],wo.prototype,"_screenshotManager",void 0),u([d()],wo.prototype,"componentObjectCollection",null),u([d({autoDestroy:!0})],wo.prototype,"_componentObjectCollection",void 0),u([d()],wo.prototype,"_needsUpdate",void 0),u([d()],wo.prototype,"_needsWaterReflectionUpdate",void 0),wo=u([I("esri.views.3d.webgl-engine.parts.RenderView")],wo);let hc=class extends Te{constructor(e){super(e),this._handles=new ei,this._model=new RD,this._layers=new Jt,this._asyncChangeSet=new Hj,this._syncChangeSet=new Hj,this._layerSyncSet=new Set}initialize(){this._set("renderView",new wo(this)),this._frameTask=this.view.resourceController.scheduler.registerTask(_t.STAGE,this),this._handles.add(this._frameTask)}destroy(){this._handles.destroy()}get viewingMode(){return this.view.state.viewingMode}get updating(){return this.running||this.renderView.updating||this._frameTask.updating}get renderer(){var e;return(e=this.renderView)==null?void 0:e.renderer}add(e){this._model.add(e),MF(e)&&(e.attachStage(this),this._addLayer(e)),this.renderView.requestRender()}remove(e){C(e)||(this.renderView.requestRender(),this._model.remove(e),MF(e)&&(this._removeLayer(e),e.detachStage()))}addMany(e){v(e)&&(this._model.addMany(e),this.renderView.requestRender())}removeMany(e){v(e)&&(this._model.removeMany(e),this.renderView.requestRender())}async load(e,r){C(e)||(Array.isArray(e)||(e=[e]),await Promise.all(e.filter(i=>C(i.glTexture)).map(i=>this.schedule(()=>this._model.has(i)?i.load(this.renderView.renderingContext,()=>this.renderView.textureRepository.textureTechnique):null),r)))}loadImmediate(e){return e.load(this.renderView.renderingContext,()=>this.renderView.textureRepository.textureTechnique)}forEachOfType(e,r){this._model.forEachOfType(e,r)}handleEvent(e,r){this.destroyed||(this._model.dirtySet[e](r),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty}runTask(e){this._frameTask.processQueue(e),this._commit(e)}_commit(e){const r=this._model.dirtySet;this._asyncChangeSet.empty||e.done||(this.renderer.modify(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll(i=>{if(e.done)return;const s=this._layerSyncSet.has(i.id)||i.updatePolicy===B_.SYNC,n=s?this._syncChangeSet:this._asyncChangeSet;r.commitLayer(i.id,n),this._layerSyncSet.delete(i.id),n.empty||(this.renderer.modify(n,s?Xa:e),this.renderView.requestRender(),e.madeProgress())}),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Xa),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll(i=>{e.done||this._layerSyncSet.has(i.id)||i.updatePolicy!==B_.ASYNC||(r.commitLayer(i.id,this._asyncChangeSet),this._asyncChangeSet.empty||(this.renderer.modify(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()))}),this._layerSyncSet.clear(),this.notifyChange("running")}commitSyncLayers(){const e=this._model.dirtySet;this._layers.forAll(r=>{(this._layerSyncSet.has(r.id)||r.updatePolicy===B_.SYNC)&&(e.commitLayer(r.id,this._syncChangeSet),this._layerSyncSet.delete(r.id))});for(const r of this._layerSyncSet)e.commitLayer(r,this._syncChangeSet);this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Xa),this.renderView.requestRender())}_commitLayer(e){this._model.dirtySet.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Xa),this.renderView.requestRender())}schedule(e,r){return this._frameTask.schedule(e,r)}reschedule(e,r){return this._frameTask.reschedule(e,r)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.requestRender()}getObject(e){return this._model.getObject(e)}get layers(){return this._layers}_addLayer(e){this._layers.includes(e)||this._layers.push(e)}_removeLayer(e){this._commitLayer(e),this._layers.removeUnordered(e)!=null&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._syncChangeSet.removes),this.renderer.modify(this._syncChangeSet,Xa))}addRenderPlugin(e,r,i){const s=this.renderer.renderPlugins.add(e,r,i),n=()=>{hae(r)&&this.view.sceneIntersectionHelper.addIntersectionHandler(r)};if(Uu(s))return s.then(n);n()}removeRenderPlugin(e){hae(e)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderer.renderPlugins.remove(e)}get performanceInfo(){return{renderView:this.renderView.performanceInfo,model:this._model.getStats()}}get test(){const e=this;return{getCount:r=>e._model.test.content.filter(i=>i.type===r).length,model:e._model}}};hc.DebugSettings={endFrameContentValidation:!1},u([d({constructOnly:!0})],hc.prototype,"view",void 0),u([d({constructOnly:!0})],hc.prototype,"options",void 0),u([d({readOnly:!0})],hc.prototype,"viewingMode",null),u([d({constructOnly:!0})],hc.prototype,"container",void 0),u([d({constructOnly:!0})],hc.prototype,"_handles",void 0),u([d({readOnly:!0})],hc.prototype,"updating",null),u([d({constructOnly:!0})],hc.prototype,"_model",void 0),u([d({autoDestroy:!0})],hc.prototype,"renderView",void 0),u([d({readOnly:!0})],hc.prototype,"renderer",null),u([d({readOnly:!0})],hc.prototype,"running",null),hc=u([I("esri.views.3d.webgl-engine.Stage")],hc);let fFt=class extends R5{constructor(e,r,i,s){super(r,i),this.point=e,this.createGraphic=s}};function XCe(t){return Ep(t)&&t.intersector===Qi.PCL&&!!t.target}let gFt=class extends Sbe{constructor(e,r,i,s,n){super(e),this.layerUid=e,this.sublayerUid=r,this.nodeIndex=i,this.componentIndex=s,this.triangleNr=n}},_Ft=class extends R5{constructor(e,r,i){super(r,null),this.point=e,this.createVoxelGraphic=i}};function _6(t){return Ep(t)&&t.intersector===Qi.I3S&&!!t.target}function YCe(t){return Ep(t)&&t.intersector===Qi.VOXEL&&!!t.target}function Ece(t,e){var r,i;return O5(t)||M5(t)?BO((r=t.target)==null?void 0:r.object.metadata,e):dnt(t)?(i=e.map)==null?void 0:i.ground:XCe(t)||_6(t)||jTe(t)||YCe(t)?BO(t.target,e):null}function bFt(t,e){const r=FH(t,e);return v(r)&&r.type==="graphic"?r.graphic:null}function FH(t,e){var r;if(C(t))return null;if(O5(t)||M5(t))return Cce((r=t.target)==null?void 0:r.object.metadata,e);if(XCe(t)){const i=t.target.createGraphic();return{type:"graphic",graphic:i,layer:i.layer}}if(YCe(t)){const i=t.target.createVoxelGraphic();return{type:"graphic",graphic:i,layer:i.layer}}return jTe(t)||JZ(t)?Cce(t.target,e):_6(t)?m1t(t.target,e):null}function Cce(t,e){if(C(t)||C(t.graphicUid))return null;const r=BO(t,e);if(C(r))return null;if(r===e.graphics)return C(e.graphicsView)||typeof t.graphicUid!="number"?null:e.graphicsView.getHit(t.graphicUid);const i=e.allLayerViews.find(s=>s.layer===r);return!i||i.suspended||C(t.graphicUid)?null:"getHit"in i?i.getHit(t.graphicUid):null}function m1t(t,e){const r=BO(t,e);if(C(r))return null;const i=e.allLayerViews.find(s=>s.layer===r);return i&&!i.suspended&&"getGraphicFromIntersectorTarget"in i?y1t(i.getGraphicFromIntersectorTarget(t)):null}function g1t(t,e){const r=BO(t,e);if(C(r))return null;const i=e.allLayerViews.find(s=>s.layer===r);return i&&!i.suspended&&"getAABBFromIntersectorTarget"in i?i.getAABBFromIntersectorTarget(t):null}function y1t(t){return v(t)?{type:"graphic",graphic:t,layer:t.layer}:null}function BO(t,e){return!t||C(t.layerUid)?null:v(e.graphicsView)&&t.layerUid===e.graphicsView.processor.layer.id?e.graphics:e.map.findLayerByUid(t.layerUid)}function wFt(t,e){if(O5(t)||M5(t))return Fg(t.target.object.boundingVolumeWorldSpace.bounds);if(JZ(t)){rfe(N$,t.transformation);const r=Math.max(N$[0],N$[1],N$[2]);return t.target.baseBoundingSphere.radius*r}return _6(t)?so(g1t(t.target,e),r=>.5*dpe(r)):null}function xFt(t){return!O5(t)&&!M5(t)&&(JZ(t)?t.target.numLodLevels>1:!!_6(t))}const N$=M();async function _1t(t,e){if(t.type==="2d")return t.hitTest(e);const r=await t.hitTest(e);if(r.results.length===0)return r;const i=r.results[0],s=(i.distance??0)*(1+v1t),n=r.results.findIndex(o=>(o.distance??0)>s);return n!==-1&&(r.results=r.results.slice(0,n)),r}const v1t=.05;let Ak,Rk;function b1t(t){const e=Kve(t);for(;e.length>1;){const r=Ace(e.shift());if(r.available)return r}return Ace(e.shift())}function Ace(t){switch(t){case vt.WEBGL1:return w1t();case vt.WEBGL2:return x1t()}}function w1t(){return Ak||(Ak=E1t()),Ak}function x1t(){return Rk||(Rk=C1t()),Rk}let ZCe=class{constructor(){this.available=!1,this.majorPerformanceCaveat=!1,this.maxTextureSize=0,this.supportsVertexShaderSamplers=!1,this.supportsHighPrecisionFragment=!1,this.supportsElementIndexUint=!1,this.supportsStandardDerivatives=!1,this.supportsInstancedArrays=!1,this.supportsTextureFloat=!1,this.supportsTextureHalfFloat=!1,this.supportsColorBufferFloat=!1,this.supportsColorBufferFloatBlend=!1,this.supportsColorBufferHalfFloat=!1}},T1t=class extends ZCe{constructor(){super(...arguments),this.type=vt.WEBGL1}};class S1t extends ZCe{constructor(){super(...arguments),this.type=vt.WEBGL2,this.supportsElementIndexUint=!0,this.supportsStandardDerivatives=!0,this.supportsInstancedArrays=!0,this.supportsTextureFloat=!0,this.supportsTextureHalfFloat=!0}}function JCe(t,e){var n;if(t===vt.WEBGL1&&typeof WebGLRenderingContext>"u"||t===vt.WEBGL2&&typeof WebGL2RenderingContext>"u")return null;const r=document.createElement("canvas");if(!r)return null;let i=KN(r,t,{failIfMajorPerformanceCaveat:!0});if(C(i)&&(i=KN(r,t),v(i)&&(e.majorPerformanceCaveat=!0)),C(i))return i;if(t===vt.WEBGL1){const o=(n=i.getParameter(i.VERSION))==null?void 0:n.match(/^WebGL\s+([\d.]*)/);if(o){const a=parseFloat(o[1]);e.available=a>=.94}}else e.available=!0;e.maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE),e.supportsVertexShaderSamplers=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0;const s=i.getShaderPrecisionFormat(i.FRAGMENT_SHADER,i.HIGH_FLOAT);return s&&(e.supportsHighPrecisionFragment=s.precision>0),i}function E1t(){const t=new T1t,e=JCe(vt.WEBGL1,t);return C(e)||(t.supportsElementIndexUint=e.getExtension("OES_element_index_uint")!==null,t.supportsStandardDerivatives=e.getExtension("OES_standard_derivatives")!==null,t.supportsInstancedArrays=e.getExtension("ANGLE_instanced_arrays")!==null,t.supportsTextureFloat=e.getExtension("OES_texture_float")!==null,t.supportsTextureHalfFloat=e.getExtension("OES_texture_half_float")!==null,t.supportsColorBufferFloat=e.getExtension("WEBGL_color_buffer_float")!==null,t.supportsColorBufferFloatBlend=e.getExtension("EXT_float_blend")!==null,t.supportsColorBufferHalfFloat=e.getExtension("EXT_color_buffer_half_float")!==null),t}function C1t(){const t=new S1t,e=JCe(vt.WEBGL2,t);return C(e)||(t.supportsColorBufferFloat=e.getExtension("EXT_color_buffer_float")!==null,t.supportsColorBufferFloatBlend=e.getExtension("EXT_float_blend")!==null,t.supportsColorBufferHalfFloat=t.supportsColorBufferFloat||e.getExtension("EXT_color_buffer_half_float")!==null),t}function A1t(t){const e=b1t(t);if(!e.available)return new q("webgl:required","WebGL is required but not supported.");if(t==="3d"&&e.majorPerformanceCaveat)return new q("webgl:major-performance-caveat-detected","Your WebGL implementation doesn't seem to support hardware accelerated rendering. Check your browser settings or if your GPU is in a blocklist.");if(!e.supportsHighPrecisionFragment)return new q("webgl:high-precision-fragment-required","WebGL support for high precision fragment shaders is required but not supported.");if(!e.supportsVertexShaderSamplers)return new q("webgl:vertex-shader-samplers-required","WebGL support for vertex shader samplers is required but not supported.");if(e.type===vt.WEBGL1){if(!e.supportsElementIndexUint)return new q("webgl:element-index-uint-required","WebGL support for uint vertex indices is required but not supported.");if(!e.supportsStandardDerivatives)return new q("webgl:standard-derivatives-required","WebGL support for standard derivatives is required but not supported.");if(!e.supportsInstancedArrays)return new q("webgl:instanced-arrays-required","WebGL support for instanced rendering is required but not supported.")}return null}function R1t(t){return t&&"nodeType"in t}function O1t(t){return t&&typeof t.render=="function"}const Rce={component:"esri-component"};let hb=class extends Te{constructor(){super(...arguments),this.widget=null}destroy(){this.widget&&this.widget.destroy(),this.node=null}get id(){return this.get("widget.id")||this.get("node.id")}set node(e){const r=this._get("node");e!==r&&(e&&e.classList.add(Rce.component),r&&r.classList.remove(Rce.component),this._set("node",e))}castNode(e){return e?typeof e=="string"||R1t(e)?(this._set("widget",null),M4(e)):(O1t(e)&&!e.domNode&&(e.domNode=document.createElement("div")),this._set("widget",e),e.domNode):(this._set("widget",null),null)}};u([d({dependsOn:[]})],hb.prototype,"id",null),u([d()],hb.prototype,"node",null),u([cr("node")],hb.prototype,"castNode",null),u([d({readOnly:!0})],hb.prototype,"widget",void 0),hb=u([I("esri.views.ui.Component")],hb);const $D=hb,M1t={left:0,top:0,bottom:0,right:0},KCe={bottom:30,top:15,right:15,left:15},Ok="manual",Xm="esri-ui",vl={ui:Xm,corner:`${Xm}-corner`,innerContainer:`${Xm}-inner-container`,manualContainer:`${Xm}-manual-container`,cornerContainer:`${Xm}-corner-container`,topLeft:`${Xm}-top-left`,topRight:`${Xm}-top-right`,bottomLeft:`${Xm}-bottom-left`,bottomRight:`${Xm}-bottom-right`};function P1t(t){return t&&!t._started&&typeof t.postMixInProperties=="function"&&typeof t.buildRendering=="function"&&typeof t.postCreate=="function"&&typeof t.startup=="function"}function Mk(t){const e=t,r=typeof e=="object"&&e!==null&&Object.getPrototypeOf(e);return(r===null||r===Object.prototype)&&("component"in e||"index"in e||"position"in e)?t:null}function Pk(t,{top:e,bottom:r,left:i,right:s}){t.style.top=e,t.style.bottom=r,t.style.left=i,t.style.right=s}let _f=class extends vs.EventedAccessor{constructor(e){super(e),this._cornerNameToContainerLookup={},this._positionNameToContainerLookup={},this._components=new Array,this._componentToKey=new Map,this._locale=Ih(),this.view=null,this._applyViewPadding=()=>{const r=this.container;r&&Pk(r,this._toPxPosition(this._getViewPadding()))},this._applyUIPadding=()=>{const r=this._innerContainer;r&&Pk(r,this._toPxPosition(this.padding))},this._initContainers()}initialize(){this.addHandles([ie(()=>{var e;return[(e=this.view)==null?void 0:e.padding,this.container]},this._applyViewPadding,Vt),ie(()=>this.padding,this._applyUIPadding,Vt),ie(()=>[this.container,this._locale],([e,r])=>{e&&e.setAttribute("lang",r)},Vt),Dhe(e=>{this._locale=e})])}destroy(){this.container=null;for(const e of this._components)e.destroy();this._components.length=0,this._componentToKey.clear()}set container(e){const r=this._get("container");e!==r&&(e&&(e.classList.add(vl.ui),I6e(e),this._attachContainers(e)),r&&(r.classList.remove(vl.ui),Pk(r,{top:"",bottom:"",left:"",right:""}),jpe(r)),this._set("container",e))}get height(){const e=this.get("view.height")||0;if(e===0)return e;const r=this._getViewPadding(),i=r.top+r.bottom;return Math.max(e-i,0)}get padding(){return this._get("padding")}set padding(e){this._overrideIfSome("padding",e)}castPadding(e){return typeof e=="number"?{bottom:e,top:e,right:e,left:e}:{...KCe,...e}}get width(){const e=this.get("view.width")||0;if(e===0)return e;const r=this._getViewPadding(),i=r.left+r.right;return Math.max(e-i,0)}add(e,r){let i,s;if(Array.isArray(e))return void e.forEach(o=>this.add(o,r));const n=Mk(e);n&&({index:i,position:r,component:e,key:s}=n),r&&typeof r=="object"&&({index:i,key:s,position:r}=r),!e||r&&!this._isValidPosition(r)||this._add(e,r,i,s)}remove(e,r){if(!e)return;if(Array.isArray(e))return e.map(s=>this.remove(s,r));const i=this._find(e);if(i){const s=this._componentToKey;if(s.has(e)&&s.get(e)!==r)return;const n=this._components.indexOf(i);return i.node.parentNode&&i.node.parentNode.removeChild(i.node),this._componentToKey.delete(e),this._components.splice(n,1)[0]}}empty(e){return Array.isArray(e)?e.map(r=>this.empty(r)).reduce((r,i)=>r.concat(i)):(e=e||Ok)===Ok?Array.prototype.slice.call(this._manualContainer.children).filter(r=>!r.classList.contains(vl.corner)).map(r=>this.remove(r)):this._isValidPosition(e)?Array.prototype.slice.call(this._cornerNameToContainerLookup[e].children).map(this.remove,this):null}move(e,r){if(Array.isArray(e)&&e.forEach(o=>this.move(o,r)),!e)return;let i;const s=Mk(e)||Mk(r);if(s&&(i=s.index,r=s.position,e=s.component||e),r&&!this._isValidPosition(r))return;const n=this.remove(e);n&&this.add(n,{position:r,index:i})}find(e){if(!e)return null;const r=this._findById(e);return r&&(r.widget||r.node)}getPosition(e){for(const r in this._positionNameToContainerLookup)if(this._positionNameToContainerLookup[r].contains(e))return r;return null}_add(e,r,i,s){e instanceof $D||(e=new $D({node:e})),this._place({component:e,position:r,index:i}),this._components.push(e),s&&this._componentToKey.set(e,s)}_find(e){return e?e instanceof $D?this._findByComponent(e):typeof e=="string"?this._findById(e):this._findByNode(e.domNode||e):null}_getViewPadding(){return this.get("view.padding")||M1t}_attachContainers(e){e.appendChild(this._innerContainer),e.appendChild(this._manualContainer)}_initContainers(){const e=document.createElement("div");e.classList.add(vl.innerContainer),e.classList.add(vl.cornerContainer);const r=document.createElement("div");r.classList.add(vl.innerContainer),r.classList.add(vl.manualContainer);const i=document.createElement("div");i.classList.add(vl.topLeft),i.classList.add(vl.corner),e.appendChild(i);const s=document.createElement("div");s.classList.add(vl.topRight),s.classList.add(vl.corner),e.appendChild(s);const n=document.createElement("div");n.classList.add(vl.bottomLeft),n.classList.add(vl.corner),e.appendChild(n);const o=document.createElement("div");o.classList.add(vl.bottomRight),o.classList.add(vl.corner),e.appendChild(o),this._innerContainer=e,this._manualContainer=r;const a=Uf();this._cornerNameToContainerLookup={"top-left":i,"top-right":s,"bottom-left":n,"bottom-right":o,"top-leading":a?s:i,"top-trailing":a?i:s,"bottom-leading":a?o:n,"bottom-trailing":a?n:o},this._positionNameToContainerLookup={manual:r,...this._cornerNameToContainerLookup}}_isValidPosition(e){return!!this._positionNameToContainerLookup[e]}_place(e){const r=e.component,i=e.position||Ok,s=e.index,n=this._positionNameToContainerLookup[i],o=s!=null&&s>-1;if(P1t(r.widget)&&r.widget.startup(),!o)return void n.appendChild(r.node);const a=Array.prototype.slice.call(n.children);if(s===0)return void(n.firstChild?qK(r.node,n.firstChild):n.appendChild(r.node));s>=a.length?n.appendChild(r.node):qK(r.node,a[s])}_toPxPosition(e){return{top:this._toPxUnit(e.top),left:this._toPxUnit(e.left),right:this._toPxUnit(e.right),bottom:this._toPxUnit(e.bottom)}}_toPxUnit(e){return e===0?"0":e+"px"}_findByComponent(e){let r,i=null;return this._components.some(s=>(r=s===e,r&&(i=s),r)),i}_findById(e){let r,i=null;return this._components.some(s=>(r=s.id===e,r&&(i=s),r)),i}_findByNode(e){let r,i=null;return this._components.some(s=>(r=s.node===e,r&&(i=s),r)),i}};u([d()],_f.prototype,"_locale",void 0),u([d()],_f.prototype,"container",null),u([d()],_f.prototype,"height",null),u([d({value:KCe})],_f.prototype,"padding",null),u([cr("padding")],_f.prototype,"castPadding",null),u([d()],_f.prototype,"view",void 0),u([d()],_f.prototype,"width",null),_f=u([I("esri.views.ui.UI")],_f);const I1t=_f;function Oce(t,e){return t&&"copyright"in t&&(!e||typeof t.originOf=="function"&&t.originOf("copyright")==="user")}function $1t(t,e){return t.length!==e.length||t.some((r,i)=>r.text!==e[i].text)}function F$(t,e,r){!r||!e||t.find(i=>i.layerView===e&&i.text===r)||t.push({text:r,layerView:e})}function L1t(t){return t.type==="bing-maps"}const d0=[];let p2=class extends ZR{constructor(e){super(e),this._clear=()=>{this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.handles.remove("suspension"),this.notifyChange("state")},this._pendingAttributions=new Set,this._fetchedAttributionData=new Map,this.items=new Pt,this.view=null,this._allLayerViewsChange=r=>{this.handles.remove("suspension");const i=this.get("view.allLayerViews");i&&this.handles.add(i.map(s=>ie(()=>{var n;return[s.suspended,(n=s.layer)==null?void 0:n.attributionVisible]},()=>this._updateAttributionItems())),"suspension"),r&&r.removed&&r.removed.forEach(s=>{this._pendingAttributions.delete(s),this._fetchedAttributionData.delete(s)}),this._updateAttributionItems()},this.handles.add([sn(()=>{var r;return(r=this.view)==null?void 0:r.allLayerViews},"change",r=>this._allLayerViewsChange(r),{onListenerAdd:()=>this._allLayerViewsChange(),onListenerRemove:this._clear}),_a(()=>{var r;return((r=this.view)==null?void 0:r.stationary)===!0},()=>this._updateAttributionItems())])}destroy(){this.view=null,this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.items.removeAll()}get state(){return this.get("view.ready")?this._pendingAttributions.size>0?"loading":"ready":"disabled"}_updateAttributionItems(){const e=this.view,r=e==null?void 0:e.allLayerViews;d0.length=0,e&&r?(r.forEach(i=>{var o;if(i.suspended||!((o=i.layer)!=null&&o.attributionVisible))return;const s=i.layer;if(Oce(s,"user"))return void F$(d0,i,s.copyright);if(s.hasAttributionData){if(this._fetchedAttributionData.has(i)){const a=this._fetchedAttributionData.get(i);return void(a?F$(d0,i,this._getDynamicAttribution(a,e,s)):Oce(s)&&F$(d0,i,s.copyright))}return void this._fetchAttributionData(i)}const n=s.get("portalItem.accessInformation");F$(d0,i,n||s.copyright)}),$1t(this.items,d0)&&(this.items.removeAll(),this.items.addMany(d0)),d0.length=0,this.notifyChange("state")):this._clear()}async _fetchAttributionData(e){if(this._pendingAttributions.has(e))return;this._pendingAttributions.add(e);const r=await hp(e.layer.fetchAttributionData());if(this._pendingAttributions.has(e)){const i=r.ok?this._createContributionIndex(r.value,L1t(e.layer)):null;this._pendingAttributions.delete(e),this._fetchedAttributionData.set(e,i)}this._updateAttributionItems()}_createContributionIndex(e,r){const i=e.contributors,s={};if(!i)return s;for(let n=0;n<i.length;n++){const o=i[n],a=o.coverageAreas;if(!a)return;for(const l of a){const c=l.bbox,h=l.zoomMin-(r&&l.zoomMin?1:0),p=l.zoomMax-(r&&l.zoomMax?1:0),f={xmin:c[1],ymin:c[0],xmax:c[3],ymax:c[2],spatialReference:et.WGS84},m={extent:jf(f),attribution:o.attribution||"",score:l.score!=null?l.score:100,id:n};for(let y=h;y<=p;y++)s[y]=s[y]||[],s[y].push(m)}}return s.maxKey=Math.max.apply(null,Object.keys(s)),s}_getDynamicAttribution(e,r,i){var h;const{extent:s,scale:n}=r;let o=((h=i.tileInfo)==null?void 0:h.scaleToZoom(n))??0;if(o=Math.min(e.maxKey??0,Math.round(o)),!s||o==null||o<=-1)return"";const a=e[o],l=Gw(s.center.clone().normalize(),r.spatialReference),c={};return a?a.filter(p=>{const f=p.id,m=!c[f]&&l&&p.extent&&Tq(p.extent,l);return m&&(c[f]=!0),m}).sort((p,f)=>f.score-p.score||p.objectId-f.objectId).map(p=>p.attribution).join(", "):""}};u([d({readOnly:!0,type:Pt})],p2.prototype,"items",void 0),u([d({readOnly:!0})],p2.prototype,"state",null),u([d()],p2.prototype,"view",void 0),p2=u([I("esri.widgets.Attribution.AttributionViewModel")],p2);const QCe=p2,fT="esri-attribution",p0={base:`${fT} esri-widget`,poweredBy:`${fT}__powered-by`,sources:`${fT}__sources`,open:`${fT}--open`,sourcesOpen:`${fT}__sources--open`,link:`${fT}__link`,widgetIcon:"esri-icon-description",interactive:"esri-interactive"};let Ml=class extends Ea{constructor(e,r){super(e,r),this._isOpen=!1,this._attributionTextOverflowed=!1,this._prevSourceNodeHeight=0,this._resizeObserver=new ResizeObserver(i=>i.forEach(({target:s})=>this._checkSourceTextOverflow(s))),this.iconClass=p0.widgetIcon,this.itemDelimiter=" | ",this.messages=null,this.viewModel=new QCe}initialize(){this.addHandles(sn(()=>{var e;return(e=this.viewModel)==null?void 0:e.items},"change",()=>this.scheduleRender()))}destroy(){var e;(e=this._resizeObserver)==null||e.disconnect()}get _isInteractive(){return this._isOpen||this._attributionTextOverflowed}get attributionText(){return this.viewModel.items.reduce((e,r)=>(e.includes(r.text)||e.push(r.text),e),[]).join(this.itemDelimiter)}get label(){var e;return((e=this.messages)==null?void 0:e.widgetLabel)??""}set label(e){this._overrideIfSome("label",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}render(){const e={[p0.open]:this._isOpen};return re("div",{bind:this,class:this.classes(p0.base,e),dir:"ltr",onclick:this._toggleState,onkeydown:this._toggleState},this.renderSourcesNode(),this.renderPoweredBy())}renderPoweredBy(){return re("div",{class:p0.poweredBy},"Powered by"," ",re("a",{class:p0.link,href:"http://www.esri.com/",target:"_blank",rel:"noreferrer"},"Esri"))}renderSourcesNode(){const e=this._isOpen,r=this._isInteractive,i=r?"0":"",{attributionText:s}=this,n={[p0.sourcesOpen]:e,[p0.interactive]:r};return re("div",{afterCreate:this._afterSourcesNodeCreate,bind:this,class:this.classes(p0.sources,n),innerHTML:s,tabindex:i})}_afterSourcesNodeCreate(e){this._prevSourceNodeHeight=e.clientWidth,this._resizeObserver.observe(e)}_checkSourceTextOverflow(e){let r=!1;const{clientHeight:i,clientWidth:s,scrollWidth:n}=e,o=n>s,a=this._attributionTextOverflowed!==o;if(this._attributionTextOverflowed=o,a&&(r=!0),this._isOpen){const l=i<this._prevSourceNodeHeight;this._prevSourceNodeHeight=i,l&&(this._isOpen=!1,r=!0)}r&&this.scheduleRender()}_toggleState(){this._isInteractive&&(this._isOpen=!this._isOpen)}};u([d()],Ml.prototype,"_isOpen",void 0),u([d()],Ml.prototype,"_isInteractive",null),u([d()],Ml.prototype,"_attributionTextOverflowed",void 0),u([d()],Ml.prototype,"_prevSourceNodeHeight",void 0),u([d({readOnly:!0,dependsOn:["viewModel.items.length","itemDelimiter"]})],Ml.prototype,"attributionText",null),u([d()],Ml.prototype,"iconClass",void 0),u([d()],Ml.prototype,"itemDelimiter",void 0),u([d()],Ml.prototype,"label",null),u([d(),ya("esri/widgets/Attribution/t9n/Attribution")],Ml.prototype,"messages",void 0),u([d()],Ml.prototype,"view",null),u([d({type:QCe})],Ml.prototype,"viewModel",void 0),u([hu()],Ml.prototype,"_toggleState",null),Ml=u([I("esri.widgets.Attribution")],Ml);const D1t=Ml,N1t="esri.widgets.CompassViewModel";let db=class extends WX(Te){constructor(e){super(e),this._handles=new ei,this.orientation={x:0,y:0,z:0},this.view=null,this._updateForCamera=this._updateForCamera.bind(this),this._updateForRotation=this._updateForRotation.bind(this),this._updateRotationWatcher=this._updateRotationWatcher.bind(this)}initialize(){this._handles.add(ie(()=>this.view,this._updateRotationWatcher,Vt))}destroy(){ji(this._handles),this.view=null}get canShowNorth(){const e=this.get("view.spatialReference");return!(!e||!e.isWebMercator&&!e.isGeographic)}get state(){return this.get("view.ready")?this.canShowNorth?"compass":"rotation":"disabled"}reset(){var r;if(!this.get("view.ready"))return;const e={};((r=this.view)==null?void 0:r.type)==="2d"?e.rotation=0:e.heading=0,this.callGoTo({target:e})}_updateForRotation(e){e!=null&&(this.orientation={z:e})}_updateForCamera(e){if(!e)return;const r=-e.heading;this.orientation={x:0,y:0,z:r}}_updateRotationWatcher(e){this._handles.removeAll(),e&&this._handles.add(e.type==="2d"?ie(()=>e==null?void 0:e.rotation,this._updateForRotation,Vt):ie(()=>e==null?void 0:e.camera,this._updateForCamera,Vt))}};u([d({readOnly:!0})],db.prototype,"canShowNorth",null),u([d()],db.prototype,"orientation",void 0),u([d({readOnly:!0})],db.prototype,"state",null),u([d()],db.prototype,"view",void 0),db=u([I(N1t)],db);const eAe=db,f0={base:"esri-compass esri-widget--button esri-widget",text:"esri-icon-font-fallback-text",icon:"esri-compass__icon",rotationIcon:"esri-icon-dial",northIcon:"esri-icon-compass",widgetIcon:"esri-icon-locate-circled",interactive:"esri-interactive",disabled:"esri-disabled"};let vf=class extends Ea{constructor(e,r){super(e,r),this.iconClass=f0.widgetIcon,this.messages=null,this.viewModel=new eAe}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(e){this.viewModel.goToOverride=e}get label(){var e;return((e=this.messages)==null?void 0:e.widgetLabel)??""}set label(e){this._overrideIfSome("label",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}reset(){return this.viewModel.reset()}render(){const{orientation:e,state:r}=this.viewModel,i=r==="disabled",s=(r==="rotation"?"rotation":"compass")=="compass",n=i?-1:0,o={[f0.disabled]:i,[f0.interactive]:!i},a={[f0.northIcon]:s,[f0.rotationIcon]:!s},{messages:l}=this;return re("div",{bind:this,class:this.classes(f0.base,o),onclick:this._reset,onkeydown:this._reset,role:"button",tabIndex:n,"aria-label":l.reset,title:l.reset},re("span",{"aria-hidden":"true",class:this.classes(f0.icon,a),styles:this._toRotationTransform(e)}),re("span",{class:f0.text},l.reset))}_reset(){this.viewModel.reset()}_toRotationTransform(e){return{transform:`rotateZ(${e.z}deg)`}}};u([d()],vf.prototype,"goToOverride",null),u([d()],vf.prototype,"iconClass",void 0),u([d()],vf.prototype,"label",null),u([d(),ya("esri/widgets/Compass/t9n/Compass")],vf.prototype,"messages",void 0),u([d()],vf.prototype,"view",null),u([d({type:eAe})],vf.prototype,"viewModel",void 0),u([hu()],vf.prototype,"_reset",null),vf=u([I("esri.widgets.Compass")],vf);const F1t=vf,mT="esri-navigation-toggle",Qu={base:`${mT} esri-widget`,button:`${mT}__button esri-widget--button`,activeButton:`${mT}__button--active`,panButton:`${mT}__button--pan`,rotateButton:`${mT}__button--rotate`,isLayoutHorizontal:`${mT}--horizontal`,rotationIcon:"esri-icon-rotate",panIcon:"esri-icon-pan",widgetIcon:"esri-icon-pan2",disabled:"esri-disabled"};let f2=class extends Te{constructor(t){super(t),this.navigationMode="pan",this.view=null}initialize(){this.own(_a(()=>{var t;return(t=this.view)==null?void 0:t.inputManager},()=>this._setNavigationMode()))}destroy(){this.view=null}get state(){var t;return this.get("view.ready")&&((t=this.view)==null?void 0:t.type)==="3d"?"ready":"disabled"}toggle(){this.state!=="disabled"&&(this.navigationMode=this.navigationMode!=="pan"?"pan":"rotate",this._setNavigationMode())}_setNavigationMode(){this.get("view.inputManager").primaryDragAction=this.navigationMode==="pan"?"pan":"rotate"}};u([d({readOnly:!0})],f2.prototype,"state",null),u([d()],f2.prototype,"navigationMode",void 0),u([d()],f2.prototype,"view",void 0),f2=u([I("esri.widgets.NavigationToggleViewModel")],f2);const tAe=f2;let bf=class extends Ea{constructor(e,r){super(e,r),this.iconClass=Qu.widgetIcon,this.messages=null,this.viewModel=new tAe}get label(){var e;return((e=this.messages)==null?void 0:e.widgetLabel)??""}set label(e){this._overrideIfSome("label",e)}set layout(e){e!=="horizontal"&&(e="vertical"),this._set("layout",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}toggle(){return this.viewModel.toggle()}render(){const e=this.get("viewModel.state")==="disabled",r=this.get("viewModel.navigationMode")==="pan",i={[Qu.disabled]:e,[Qu.isLayoutHorizontal]:this.layout==="horizontal"},s={[Qu.activeButton]:r},n={[Qu.activeButton]:!r},o=e?-1:0,a=this.messages.toggle;return re("div",{bind:this,class:this.classes(Qu.base,i),onclick:this._toggle,onkeydown:this._toggle,tabIndex:o,"aria-label":a,title:a},re("div",{class:this.classes(Qu.button,Qu.panButton,s)},re("span",{class:Qu.panIcon})),re("div",{class:this.classes(Qu.button,Qu.rotateButton,n)},re("span",{class:Qu.rotationIcon})))}_toggle(){this.toggle()}};u([d()],bf.prototype,"iconClass",void 0),u([d()],bf.prototype,"label",null),u([d({value:"vertical"})],bf.prototype,"layout",null),u([d(),ya("esri/widgets/NavigationToggle/t9n/NavigationToggle")],bf.prototype,"messages",void 0),u([d()],bf.prototype,"view",null),u([d({type:tAe})],bf.prototype,"viewModel",void 0),u([hu()],bf.prototype,"_toggle",null),bf=u([I("esri.widgets.NavigationToggle")],bf);const U1t=bf,oA={button:"esri-widget--button esri-widget",disabled:"esri-disabled",interactive:"esri-interactive",iconText:"esri-icon-font-fallback-text",icon:"esri-icon"};let W0=class extends Ea{constructor(){super(...arguments),this.enabled=!0,this.iconClass="",this.title=""}render(){const t=this.enabled?0:-1,e={[oA.disabled]:!this.enabled,[oA.interactive]:this.enabled},r={[this.iconClass]:!!this.iconClass};return re("div",{bind:this,class:this.classes(oA.button,e),onclick:this._triggerAction,onkeydown:this._triggerAction,role:"button",tabIndex:t,title:this.title},re("span",{"aria-hidden":"true",role:"presentation",class:this.classes(oA.icon,r)}),re("span",{class:oA.iconText},this.title))}_triggerAction(){this.action.call(this)}};u([d()],W0.prototype,"action",void 0),u([d()],W0.prototype,"enabled",void 0),u([d()],W0.prototype,"iconClass",void 0),u([d()],W0.prototype,"title",void 0),u([hu()],W0.prototype,"_triggerAction",null),W0=u([I("esri.widgets.IconButton")],W0);const Mce=W0;let m2=class extends Te{get canZoomIn(){if(!this.get("view.ready"))return!1;const t=this.get("view.animation.target.scale")||this.get("view.scale"),e=this.get("view.constraints.effectiveMaxScale");return e===0||t>e}get canZoomOut(){if(!this.get("view.ready"))return!1;const t=this.get("view.animation.target.scale")||this.get("view.scale"),e=this.get("view.constraints.effectiveMinScale");return e===0||t<e}};u([d({readOnly:!0})],m2.prototype,"canZoomIn",null),u([d({readOnly:!0})],m2.prototype,"canZoomOut",null),u([d()],m2.prototype,"view",void 0),m2=u([I("esri.widgets.Zoom.ZoomConditions2D")],m2);const k1t=m2;let g2=class extends Te{get canZoomIn(){return!!this.view.ready}get canZoomOut(){return!!this.view.ready}};u([d({readOnly:!0})],g2.prototype,"canZoomIn",null),u([d({readOnly:!0})],g2.prototype,"canZoomOut",null),u([d()],g2.prototype,"view",void 0),g2=u([I("esri.widgets.Zoom.ZoomConditions3D")],g2);const V1t=g2;let X0=class extends Te{constructor(e){super(e)}destroy(){this.view=null}get canZoomIn(){return v(this._zoomConditions)&&this._zoomConditions.canZoomIn}get canZoomOut(){var e;return v(this._zoomConditions)&&((e=this._zoomConditions)==null?void 0:e.canZoomOut)}get state(){var e;return(e=this.view)!=null&&e.ready?"ready":"disabled"}set view(e){e?e.type==="2d"?this._zoomConditions=new k1t({view:e}):e.type==="3d"&&(this._zoomConditions=new V1t({view:e})):this._zoomConditions=null,this._set("view",e)}zoomIn(){if(!this.canZoomIn)return;const e=this.view;e.type==="2d"?e.mapViewNavigation.zoomIn():k2(e.goTo({zoomFactor:2}))}zoomOut(){if(!this.canZoomOut)return;const e=this.view;e.type==="2d"?e.mapViewNavigation.zoomOut():k2(e.goTo({zoomFactor:.5}))}};u([d()],X0.prototype,"_zoomConditions",void 0),u([d()],X0.prototype,"canZoomIn",null),u([d()],X0.prototype,"canZoomOut",null),u([d({readOnly:!0})],X0.prototype,"state",null),u([d()],X0.prototype,"view",null),X0=u([I("esri.widgets.Zoom.ZoomViewModel")],X0);const rAe=X0,aA={base:"esri-zoom esri-widget",horizontalLayout:"esri-zoom--horizontal",zoomInIcon:"esri-icon-plus",zoomOutIcon:"esri-icon-minus",widgetIcon:"esri-icon-zoom-in-magnifying-glass"};let vg=class extends Ea{constructor(e,r){super(e,r),this.iconClass=aA.widgetIcon,this.messages=null,this.viewModel=new rAe}initialize(){this._zoomInButton=new Mce({action:this.zoomIn.bind(this),iconClass:aA.zoomInIcon}),this._zoomOutButton=new Mce({action:this.zoomOut.bind(this),iconClass:aA.zoomOutIcon})}destroy(){this._zoomInButton=ke(this._zoomInButton),this._zoomOutButton=ke(this._zoomOutButton)}get label(){var e;return((e=this.messages)==null?void 0:e.widgetLabel)??""}set label(e){this._overrideIfSome("label",e)}set layout(e){e!=="horizontal"&&(e="vertical"),this._set("layout",e)}set view(e){this.viewModel.view=e}get view(){return this.viewModel.view}render(){const e=this.viewModel,r={[aA.horizontalLayout]:this.layout==="horizontal"},{canZoomIn:i,canZoomOut:s}=e;this._zoomInButton.enabled=i,this._zoomOutButton.enabled=s;const{zoomIn:n,zoomOut:o}=this.messages;return this._zoomInButton.title=n,this._zoomOutButton.title=o,re("div",{class:this.classes(aA.base,r)},this._zoomInButton.render(),this._zoomOutButton.render())}zoomIn(){return this.viewModel.zoomIn()}zoomOut(){return this.viewModel.zoomOut()}};u([d()],vg.prototype,"iconClass",void 0),u([d()],vg.prototype,"label",null),u([d({value:"vertical"})],vg.prototype,"layout",null),u([d(),ya("esri/widgets/Zoom/t9n/Zoom")],vg.prototype,"messages",void 0),u([d()],vg.prototype,"view",null),u([d({type:rAe})],vg.prototype,"viewModel",void 0),vg=u([I("esri.widgets.Zoom")],vg);const B1t=vg;function z1t(t){return t&&t.view!==void 0}let LD=class extends I1t{constructor(e){super(e),this._defaultPositionLookup={attribution:"manual",compass:"top-left","navigation-toggle":"top-left",zoom:"top-left"},this.components=[]}initialize(){this.addHandles([ie(()=>this.components,this._componentsWatcher.bind(this),Vt),ie(()=>this.view,this._updateViewAwareWidgets.bind(this),Vt)])}_add(e,r,i,s){let n=e;if(typeof e=="string"&&this._defaultPositionLookup[e]){if(this._find(e))return;n=this._createComponent(e)}super._add(n,r,i,s)}_removeComponents(e){e.forEach(r=>{const i=this._find(r);i&&(this.remove(i),i.destroy())})}_updateViewAwareWidgets(e){this.components.forEach(r=>{const i=this._find(r),s=i&&i.widget;z1t(s)&&(s.view=e)})}_componentsWatcher(e,r){this._removeComponents(r),this._addComponents(e),this._adjustPadding(e)}_adjustPadding(e){if(!e.includes("attribution")&&!this._isOverridden("padding")){const{top:r}=this.padding;this.padding=r}}_addComponents(e){this.constructed&&e.forEach(r=>this.add(this._createComponent(r),this._defaultPositionLookup[r]))}_createComponent(e){const r=this._createWidget(e);if(r)return new $D({id:e,node:r})}_createWidget(e){return e==="attribution"?this._createAttribution():e==="compass"?this._createCompass():e==="navigation-toggle"?this._createNavigationToggle():e==="zoom"?this._createZoom():void 0}_createAttribution(){return new D1t({view:this.view})}_createCompass(){return new F1t({view:this.view})}_createNavigationToggle(){return new U1t({view:this.view})}_createZoom(){return new B1t({view:this.view})}};u([d()],LD.prototype,"components",void 0),LD=u([I("esri.views.ui.DefaultUI")],LD);const G1t=LD;let DD=class extends G1t{constructor(e){super(e),this.components=["attribution","zoom","navigation-toggle","compass"]}};u([d()],DD.prototype,"components",void 0),DD=u([I("esri.views.ui.3d.DefaultUI3D")],DD);const iAe=DD;let ot=class extends HNe(tHe(yHe(GHe))){constructor(t){super(t),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._defaults={},this._externallySet={environment:!1},this._createGraphicsViewController=null,this._lostWebGLContextHandle=null,this._resolveWhenReady=[],this._propertiesPool=new ty({slicePlane:fme},this),this._resourceController=Rdt(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new Nj({view:this}),this.labeler=new sb({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new VS,this.basemapTerrain=null,this.elevationProvider=null,this.canvas=null,this.constraints=new Sb,this.environmentManager=new Ad,this.floors=new Pt,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new HHe({view:this}),this.groundView=null,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new Xht,this.spatialReference=null,this.alphaCompositingEnabled=!1,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new iAe,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.highlightOptions=new oH,this.voxelWasm=null,this.voxelWasmPromise=null,ILe(),t&&t.environment||(this._defaults.environment=new KT,this.environment=this._defaults.environment);const e=(r=null)=>{v(r)&&r.type===fi.MOVE||(this._updatingChanged(),this.map&&this.map.allLayers.forEach(async i=>{try{await i.when()}catch{}this._updatingChanged()}))};this.handles.add([sn(()=>{var r;return(r=this.map)==null?void 0:r.allLayers},"after-changes",r=>e(r),{onListenerAdd:()=>e(),onListenerRemove:()=>e(),sync:!0}),this.allLayerViews.on("after-changes",r=>this._updateUpdatingMonitors(r)),ie(()=>this.map,r=>{r&&"load"in r&&r.load&&r.load().catch(()=>{})})]),this.inputManager=new ett({view:this}),this.stateManager=new un({view:this})}initialize(){this.groundView=new gHe({view:this}),this._updateUpdatingMonitors();const t=()=>this._updateDefaultToMapOptions();this.handles.add(sn(()=>{var e;return(e=this.map)==null?void 0:e.allLayers},"after-changes",t,{onListenerAdd:t,onListenerRemove:t})),this.updatingHandles.add(()=>this.qualitySettings.memoryLimit,e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)},Vt),this.updatingHandles.add(()=>this.qualitySettings.additionalCacheMemory,e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)},Vt),this.updatingHandles.add(()=>this.qualitySettings.frameRate??0,e=>s3e(e>0?1e3/Math.ceil(e):0),Vt),this.updatingHandles.add(()=>{var e;return(e=this.map)==null?void 0:e.ground},t,js),this.updatingHandles.add(()=>{var e,r;return(r=(e=this.map)==null?void 0:e.ground)==null?void 0:r.opacity},()=>this._updateDefaultHitTestOptions(),js),this.handles.add(ie(()=>this.spatialReference,()=>this.notifyChange("clippingArea"),ri))}destroy(){this.destroyed||(this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=ke(this.sharedSymbolResources),this._set("labeler",ke(this.labeler)),this._set("deconflictor",ke(this.deconflictor)),this._resourceController=ke(this._resourceController),this._set("stateManager",ke(this.stateManager)),this._set("inputManager",ke(this.inputManager)),this.state.destroy(),this._propertiesPool.destroy(),this.handles.remove("updatingMonitors"),this._set("environmentManager",ke(this.environmentManager)),this.groundView=ke(this.groundView))}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){var t;return(t=this.basemapTerrain)==null?void 0:t.spatialReference}get animation(){var t;return(t=this.state)==null?void 0:t.animation}get camera(){var t;return(t=this.stateManager)==null?void 0:t.camera}set camera(t){this.stateManager&&(this.stateManager.camera=t)}get contentCamera(){var t;return(t=this.stateManager)==null?void 0:t.contentCamera}set contentCamera(t){this.stateManager&&(this.stateManager.contentCamera=t)}installContentCameraReset(t={sticky:!1}){return this.stateManager.installContentCameraReset(t)}get center(){var t;return(t=this.stateManager)==null?void 0:t.center}set center(t){this.stateManager&&(this.stateManager.center=t)}get clippingArea(){var e;if(this.viewingMode==="global")return null;let t=this._userClippingArea||("clippingArea"in this.map?(e=this.map)==null?void 0:e.clippingArea:void 0);return!(this._userClippingArea||this.get("map.clippingEnabled"))||C(t)?(this._clippingArea=null,null):t instanceof Zr?this.spatialReference&&(t=U$(t,this.spatialReference),C(t))?(se.getLogger(this.declaredClass).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(t=t.clone(),C(t.intersection(this._groundAndLayersExtent))&&(t.xmin=t.xmax,t.ymin=t.ymax),t.zmin=void 0,t.zmax=void 0,t.equals(this._clippingArea)||(this._clippingArea=t),this._clippingArea):(se.getLogger(this.declaredClass).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(t){this.ready&&this.viewingMode==="global"&&v(t)?se.getLogger(this.declaredClass).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=t}get renderDataExtent(){if(this.state.viewingMode===Be.Global)return null;const t=this.renderSpatialReference,e=this.dataExtent;return C(e)||C(t)||e.spatialReference.equals(t)?e:U$(e,t)}get dataExtent(){let t=this._groundAndLayersExtent;const e=this.spatialReference||et.WGS84,r=U$(this.clippingArea,e);v(r)&&(t=v(t)?t.intersection(r):r);const i=this._get("dataExtent");return v(t)&&t.equals(i)?i:t}get _groundAndLayersExtent(){const t=this.spatialReference||et.WGS84;let e;const r=n=>{const o=U$(n,t);C(o)||(v(e)?e.union(o):e=o.clone())},i=this.basemapTerrain;if(i!=null&&i.spatialReference){const n=i.groundExtent;r(new Zr({xmin:n[0],ymin:n[1],zmin:0,xmax:n[2],ymax:n[3],zmax:0,spatialReference:i.spatialReference}))}if(this.map){const n=o=>{!v(o.fullExtent)||o.type==="graphics"&&o.internal||r(o.fullExtent)};this.map.allLayers.forEach(o=>n(o))}if(C(e))return null;e.hasZ?(e.zmin=Math.min(0,e.zmin??0),e.zmax=Math.max(0,e.zmax??0)):(e.zmin=0,e.zmax=0);const s=this._get("_groundAndLayersExtent");return e.equals(s)?s:e}set environment(t){t!==this._defaults.environment&&(this._externallySet.environment=!0),this._set("environment",t)}castEnvironment(t){return t?t instanceof KT?t:t instanceof Ove?this.environment!=null?this.environment.cloneWithWebsceneEnvironment(t):KT.fromWebsceneEnvironment(t):us(KT,t):new KT}get extent(){var t;return(t=this.stateManager)==null?void 0:t.extent}set extent(t){this.stateManager&&(this.stateManager.extent=t)}get screenCenter(){var t;return(t=this.stateManager)==null?void 0:t.screenCenter}get frustum(){var t;return(t=this.stateManager)==null?void 0:t.frustum}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get _defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){return this.navigating||v(this.activeTool)&&this.activeTool.visible}get stationary(){return!this.animation&&!this.resizing&&(C(this.state)||this.state.stationary)}get navigating(){var t;return((t=this.state)==null?void 0:t.navigating)??!1}get padding(){var t;return(t=this.stateManager)==null?void 0:t.padding}set padding(t){this.stateManager&&(this.stateManager.padding=t)}set qualityProfile(t){vD.isValidProfile(t)&&(vD.apply(t,this.qualitySettings),this._set("qualityProfile",t))}get qualityProfile(){return this._get("qualityProfile")||vD.getDefaultProfile()}set slicePlane(t){if(v(this._stage)&&this._stage.renderer.setParameters({slicePlane:t}),C(t))return void this._set("slicePlane",null);const e=this._propertiesPool.get("slicePlane");Jw(t,e),this._set("slicePlane",e)}get typeSpecificPreconditionsReady(){return!!this.viewingMode}get resolution(){return this.spatialReference!=null?zNe(this.scale,this.spatialReference):0}get scale(){var t;return(t=this.stateManager)==null?void 0:t.scale}set scale(t){this.stateManager&&(this.stateManager.scale=t)}get heightModelInfo(){const t=this.getDefaultHeightModelInfo();return t!=null?EE.deriveUnitFromSR(t,this.spatialReference):null}get updating(){var s,n,o;if(this.destroyed)return!1;let t=0,e=this.layerViewManager.updating,r=e?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach(a=>{if(a.isFulfilled()){if(a.updating){if(e=!0,a.suspended||DO(a))return;++r,t+=a.updatingProgress}}else++r});for(const a of[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager])v(a)&&a.updating&&(r+=.1,t+=.5*.1);for(const a of[this.deconflictor,this.labeler,this.basemapTerrain])v(a)&&a.updating&&(++r,t+=a.updatingProgress);const i=this.stateManager.test.updatingIgnoreRenderState?Sr.IDLE:this.state.mode;if(e=!!(e||r>0||this.updatingHandles.updating||!this.ready||!this.stationary||i!==Sr.IDLE||this._createGraphicsViewController||(s=this.inputManager)!=null&&s.hasPendingInputs||(o=(n=this.map)==null?void 0:n.allLayers)!=null&&o.some(a=>!a.isFulfilled())),e?(this._numUpdating=Math.max(r,this._numUpdating),t+=this._numUpdating-r):this._numUpdating=0,this._numUpdating>0?t/=this._numUpdating:t=e?0:1,this._get("updatingProgress")!==t){const a=performance.now();if(t<1){const l=Math.min((a-this._lastUpdateTime)/2e3,1);t=this.updatingProgress*(1-l)+t*l}this._set("updatingProgress",t),this._lastUpdateTime=e&&t<1?a:0}return e}get viewingMode(){var r;const t=this._predeterminedViewingMode;if(v(t))return t8(t);const e=this.spatialReference;return e?v((r=this.defaultsFromMap)==null?void 0:r.viewingMode)&&e.equals(this.defaultsFromMap.spatialReference)?t8(this.defaultsFromMap.viewingMode):_F(e,Be.Global)?"global":"local":"global"}set viewingMode(t){this.ready?se.getLogger(this.declaredClass).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",t)}get viewpoint(){var t;return(t=this.stateManager)==null?void 0:t.viewpoint}set viewpoint(t){this.stateManager&&(this.stateManager.viewpoint=t)}get zoom(){return this.stateManager.zoom}set zoom(t){this.stateManager&&(this.stateManager.zoom=t)}get resourceController(){return this._resourceController}get performanceInfo(){return new ept(this)}on(t,e,r,i){return this.viewEvents.on(t,e,r,i)||super.on(t,e)}hasEventListener(t){return super.hasEventListener(t)||this.viewEvents.hasHandler(t)}toMap(t,e){if(!this.ready)return se.getLogger(this.declaredClass).error("#toMap()","Scene view cannot be used before it is ready"),null;const r=e?this.externalToInternalIntersectOptions(e):this._defaultToMapOptions,i=v(r.graphics)&&(v(r.graphics.include)||v(r.graphics.exclude)),s=Lre(t)?$re(this,t):t,n=Mf(s);r.enableDraped=r.include&&!r.include.has(c_)||r.exclude&&r.exclude.has(c_);const o=this.sceneIntersectionHelper,a=Wh(this.state.viewingMode);if(a.options.selectionMode=!0,a.options.store=i?Po.ALL:Po.MIN,o.intersectIntersectorScreen(n,a,r),i){for(const l of a.results.all){const c=FH(l,this);if(C(c))return this._intersectResultToMapPoint(l);if(c.type!=="graphic"||this._testGraphicUidFilter(r.graphics,c.graphic))return this._intersectResultToMapPoint(l)}return null}return this._intersectResultToMapPoint(a.results.min)}toScreen(t){if(!this.ready)return se.getLogger(this.declaredClass).error("#toScreen()","Scene view cannot be used before it is ready"),null;const e=It(t.z==null?kf(this.elevationProvider,t):null,0);return Jo(t,gT,this.renderSpatialReference,e),this.state.camera.projectToScreen(gT,Ik),Bh(Ik[0],Ik[1])}pixelSizeAt(t){return this.ready?t?(Jo(t,gT,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(gT)):0:(se.getLogger(this.declaredClass).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(t){const e=this.basemapTerrain.overlayManager;return e?e.overlayPixelSizeInMapUnits(t):1}hitTest(t,e){if(!this.ready)return se.getLogger(this.declaredClass).error("#hitTest()","Scene view cannot be used before it is ready"),null;const r=Lre(t)?$re(this,t):t,i=as(r.x,r.y),s=e?this.externalToInternalIntersectOptions(e):this._defaultHitTestOptions;s.requiresGroundFeedback=!0,s.enableDraped=!0;const n=Wh(this.state.viewingMode);n.options.selectionMode=!0,n.options.store=Po.ALL,this.sceneIntersectionHelper.intersectIntersectorScreen(i,n,s);const o=this._intersectResultsToHits(n.results.all,s.graphics),a=n.results.ground,l=Ece(a,this),c=v(l)&&"type"in l&&l.type==="integrated-mesh"?l:null,h={screenPoint:r,results:o,ground:{mapPoint:this._intersectResultToMapPoint(a),distance:Ep(a)?a.distanceInRenderSpace:0,layer:c}};return qr.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(h.intersector=n),Promise.resolve(h)}async popupHitTest(t){const{results:e,ground:r}=await _1t(this,t);let i=null;return!(e.length===0||Math.abs(It(e[0].distance,0)-r.distance)<1e-5)||r.layer&&r.layer.type==="integrated-mesh"||(i=r.mapPoint),{results:e,screenPoint:t,mapPoint:i}}goTo(t,e){return this.updatingHandles.addPromise(this.stateManager.goTo(t,e))}async whenAnalysisView(t){if(C(t.parent))throw new q("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:t});switch(t.parent.type){case"line-of-sight":case"dimension":return(await this.whenLayerView(t.parent)).whenAnalysisView();default:return this.analysisViewManager.whenAnalysisView(t)}}whenLayerView(t){return super.whenLayerView(t)}async takeScreenshot(t){const e=this._completeSettings(t);await this.whenReady();const r=await this._stage.renderView.takeScreenshot(e);return Sk(r,e,this._pixelFormat())}async _takeScreenshot(t){const e=this._completeSettings(t);await this.whenReady();const r=await this._stage.renderView.takeScreenshot(e);return Ek(r,this._pixelFormat())}async _takeScreenshotWithObjectAndLayerId(t){const e=this._completeSettings(t);await this.whenReady();const r=await this._stage.renderView.takeScreenshotWithOID(e);return[Ek(r[0],this._pixelFormat()),Ek(r[1],this._pixelFormat())]}_completeSettings(t){const e=Jvt(t,this);return e.pixelRatio/=this.state.pixelRatio,t1t(e,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this._stage.renderView.getAlpha()}}get test(){return{takeScreenshot:t=>this._takeScreenshot(t),takeScreenshotWithObjectAndLayerId:t=>this._takeScreenshotWithObjectAndLayerId(t)}}async takeScreenshotWithObjectAndLayerId(t){if(!de("enable-feature:objectAndLayerId-rendering"))throw new Error("has enable-feature:objectAndLayerId-rendering must be true");const e=this._completeSettings(t);await this.whenReady();const r=await this._stage.renderView.takeScreenshotWithOID(e),i=Sk(r[0],e,this._pixelFormat()),s=this._completeSettings(t);return s.format="png",[i,Sk(r[1],s,this._pixelFormat())]}getColorToObjectAndLayerIdMapping(){if(C(this._stage.renderView.objectAndLayerIdRenderHelper))throw new Error("has enable-feature:objectAndLayerId-rendering must be true");return this._stage.renderView.objectAndLayerIdRenderHelper.getColorToObjectAndLayerIdMapping()}addUpdatingPromise(t){return this.updatingHandles.addPromise(t)}importLayerView(t){return zre.importLayerView(t)}hasLayerViewModule(t){return zre.hasLayerViewModule(t)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){var t,e,r,i;return this.map&&"initialViewProperties"in this.map&&((e=(t=this.map)==null?void 0:t.initialViewProperties)==null?void 0:e.spatialReference)||((r=this.defaultsFromMap)==null?void 0:r.spatialReference)||((i=this.defaultsFromMap)==null?void 0:i.ready)&&this._initialDefaultSpatialReference||null}async validate(){let t=A1t(this.type);const e=de("safari");if(e&&e<9&&(t=new q("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:e})),v(t))throw se.getLogger(this.declaredClass).warn("#validate()",t.message),t}get _predeterminedViewingMode(){var e;const t=this._isOverridden("viewingMode")?this._get("viewingMode"):(this.map&&"initialViewProperties"in this.map?(e=this.map.initialViewProperties)==null?void 0:e.viewingMode:null)??null;return v(t)?kre(t):null}getSpatialReferenceSupport({spatialReference:t,layer:e}){const r=this._predeterminedViewingMode;if(v(r))return this._validateSpatialReferenceForViewingMode(t,e,r)?{constraints:this._makeSpatialReferenceConstraints(t,e,r)}:null;const i=this._validateSpatialReferenceForViewingMode(t,e,Be.Local),s=this._validateSpatialReferenceForViewingMode(t,e,Be.Global);return i||s?i&&s?{constraints:this._makeSpatialReferenceConstraints(t,e,null)}:i?{constraints:this._makeSpatialReferenceConstraints(t,e,Be.Local)}:{constraints:this._makeSpatialReferenceConstraints(t,e,Be.Global)}:null}_validateSpatialReferenceForViewingMode(t,e,r){return!!_F(t,r)&&(!!C(e)||!!TK(e)||(!B3(e)||!C(c6(e,t,r)))&&(!xK(e)||r!==Be.Global))}_makeSpatialReferenceConstraints(t,e,r){if(C(e))return[{spatialReference:t,viewingMode:r}];const i=t.isWebMercator,s=t.isWGS84;return TK(e)&&(i||s)?!s||r===Be.Local||aJ(e.tileInfo,e.fullExtent,t,Be.Global)===null?[{spatialReference:t,viewingMode:r},{spatialReference:et.WebMercator,viewingMode:r}]:[{spatialReference:i?et.WGS84:et.WebMercator,viewingMode:r}]:B3(e)||xK(e)||!i&&!s?B3(e)&&i&&r!==Be.Global?[{spatialReference:t,viewingMode:r},{spatialReference:et.WGS84,viewingMode:Be.Local}]:[{spatialReference:t,viewingMode:r}]:[{spatialReference:t,viewingMode:r},{spatialReference:i?et.WGS84:et.WebMercator,viewingMode:r}]}_validateSpatialReference(t){const e=v(this.getSpatialReferenceSupport({spatialReference:t})),r=this._predeterminedViewingMode;return e||(v(r)?se.getLogger(this.declaredClass).warnOnce(`Spatial reference defined on view not supported in ${t8(r)} viewing mode.`):t.isGeographic&&se.getLogger(this.declaredClass).warnOnce("Spatial reference is geographic but not supported.")),e}whenReady(){return new Promise(t=>{this.ready?t(this):this._resolveWhenReady.push(t)})}computeMapPointFromVec3d(t,e){let r=this.spatialReference||et.WGS84;return no(t,this.renderSpatialReference,t,r)||(r=et.WGS84,no(t,this.renderSpatialReference,t,r)),e?(e.x=t[0],e.y=t[1],e.z=t[2],e.spatialReference=r):e=new mt(t,r),e}trackGraphicState(t){if(!t.graphic)return se.getLogger(this.declaredClass).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const e=this.getViewForGraphic(t.graphic);let r=null,i=!1;const s=n=>{var o;!i&&v(n)&&"processor"in n&&((o=n.processor)==null?void 0:o.type)==="graphics-3d"&&n.processor.graphicsCore&&(r=n.processor.graphicsCore.trackGraphicState(t))};return v(e)?s(e):this.whenViewForGraphic(t.graphic,{waitForLayer:!0}).then(n=>s(n),()=>{}).catch(()=>{}),{remove:()=>{i=!0,v(r)&&(r.remove(),r=null)}}}highlight(t){if(Array.isArray(t))return yS(t.map(r=>this.highlight(r)));if(Pt.isCollection(t))return yS(t.toArray().map(r=>this.highlight(r)));const e=this.getViewForGraphic(t);return e&&"highlight"in e?e.highlight(t):cp()}maskOccludee(t){if(!t)return se.getLogger(this.declaredClass).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const e=this.getViewForGraphic(t);let r=null,i=!1;const s=n=>{!i&&v(n)&&Wje(n)&&(r=n.maskOccludee(t))};return v(e)?s(e):this.whenViewForGraphic(t,{waitForLayer:!0}).then(n=>s(n),()=>{}).catch(()=>{}),{remove:()=>{i=!0,v(r)&&(r.remove(),r=null)}}}getViewForGraphic(t){return t.layer===this.graphics?this.graphicsView:t.layer?this.allLayerViews.find(e=>e.layer===t.layer):null}graphicChanged(t){v(this.graphicsView)&&this.graphicsView.graphicChanged(t)}async whenViewForGraphic(t,e){if(t.layer===this)return await WR(()=>this.graphicsView),this.graphicsView;if(!t.layer||!this.map)throw new q("no-view-for-graphic");return e&&e.waitForLayer&&!this.map.allLayers.includes(t.layer)?new Promise((r,i)=>{const s=this.map.allLayers.on("change",n=>{n.added.includes(t.layer)&&(s.remove(),this.whenLayerView(t.layer).then(r,i))})}):this.whenLayerView(t.layer)}externalToInternalIntersectOptions(t){const e=this._externalToInternalRenderItems(t.include,MR.INCLUDE),r=this._externalToInternalRenderItems(t.exclude,MR.EXCLUDE);return{include:e.layerUids,exclude:r.layerUids,graphics:{include:e.graphicUids,exclude:r.graphicUids}}}_intersectResultToMapPoint(t,e){return t.getIntersectionPoint(gT)?(e=this.computeMapPointFromVec3d(gT,e),t.intersector===Qi.TERRAIN&&this.basemapTerrain&&(e.z=It(kf(this.basemapTerrain,e),0)),e):null}_intersectResultsToHits(t,e){const r=new Array;let i=null;for(let s=0;s<t.length;s++){const n=t[s],o=Ece(n,this);if(v(o)&&(o===this.map.ground||"type"in o&&o.type==="integrated-mesh"))break;const a=FH(n,this);if(C(a))continue;if(a.type==="graphic"){if(C(i)&&s!==t.length-1&&(i=new Set),v(i)){const h=this._getGraphicFilterUid(a.graphic);if(i.has(h))continue;i.add(h)}if(!this._testGraphicUidFilter(e,a.graphic))continue}const l=this._intersectResultToMapPoint(n),c=n.distanceInRenderSpace;r.push({...a,mapPoint:l,distance:c})}return r}_getGraphicFilterUid(t){var s;const e=t.sourceLayer,r=t.layer,i=e&&"objectIdField"in e?e:r&&"objectIdField"in r?r:e;if(i){const n=i.objectIdField??Ome,o=(s=t.attributes)==null?void 0:s[n];if(o)return`o-${i.id}-${o}`}return`u-${t.uid}`}_testGraphicUidFilter(t,e){const r=this._getGraphicFilterUid(e);return C(t)||(C(t.include)||t.include.has(r))&&(C(t.exclude)||!t.exclude.has(r))}_externalToInternalRenderItems(t,e,r={layerUids:void 0,graphicUids:void 0}){if(!t)return r;if(t instanceof Io)j1t(r,this._getGraphicFilterUid(t)),e===MR.INCLUDE&&(v(this.graphicsView)&&t.layer===this?lA(r,this.graphicsView.processor.layer.id):t.layer&&lA(r,t.layer.uid));else if(Lk(t))for(const i of t)i===this.graphics&&v(this.graphicsView)?lA(r,this.graphicsView.processor.layer.id):i===this.map.ground?lA(r,c_):this._externalToInternalRenderItems(i,e,r);else"uid"in t&&lA(r,t.uid);return r}_initBasemapTerrain(){this._set("basemapTerrain",new agt({view:this})),this._set("elevationProvider",new E3({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new Pl({view:this})),this._set("featureTiles",new xo({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const t=()=>{var r;const e=(r=this.basemapTerrain)==null?void 0:r.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const i=v(this.basemapTerrain.extent)&&v(this.basemapTerrain.spatialReference)?AE(b4(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;v(this.clippingArea)?this.featureTiles.filterExtent=this.clippingArea.intersection(i):this.featureTiles.filterExtent=i}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.handles.add([this.updatingHandles.add(()=>qr.FEATURE_TILE_TREE_SHOW_TILES,e=>{e&&this.featureTiles&&!this._featureTreeDebugger?this.updatingHandles.addPromise(te(()=>import("./FeatureTileTree3DDebugger-ea2ac2fe.js"),["assets/FeatureTileTree3DDebugger-ea2ac2fe.js","assets/TileTreeDebugger-3992eb72.js"])).then(({FeatureTileTree3DDebugger:r})=>{!this._featureTreeDebugger&&qr.FEATURE_TILE_TREE_SHOW_TILES&&(this._featureTreeDebugger=new r({view:this}))}):e||!this._featureTreeDebugger||qr.FEATURE_TILE_TREE_SHOW_TILES||(this._featureTreeDebugger.destroy(),this._featureTreeDebugger=null)},js),this.updatingHandles.add(()=>this.clippingArea,t,js),this.updatingHandles.add(()=>this.basemapTerrain.extent,t,js)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.state&&(this.stateManager.exit(),this.handles.remove("render-coords-helper"),this.handles.remove("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const t=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(t)||this._set("mapCoordsHelper",new udt(this.map,t));const e=this.state.isGlobal,r=Rme(e,t);r!==this.renderSpatialReference&&(this._set("renderCoordsHelper",fdt.create(this.state.viewingMode,r)),e||this.handles.add(ie(()=>{var i;return(i=this.basemapTerrain)==null?void 0:i.extent},i=>{const s=this.renderCoordsHelper.spatialReference;v(i)&&(i[0]!==0||i[1]!==0||i[2]!==0||i[3]!==0)&&N4(i,this.basemapTerrain.spatialReference,Pce,s)&&(this.renderCoordsHelper.extent=Pce)},ri),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(rE/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.handles.remove("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(t=null){v(t)&&t.type===fi.MOVE||(this.handles.remove("updatingMonitors"),this.allLayerViews.forEach(e=>{e.destroyed||(this.handles.add(ie(()=>[e.updating,e.updatingProgress],()=>this._updatingChanged(),ri),"updatingMonitors"),e.when(()=>this._updatingChanged(),()=>this._updatingChanged()))}),this._updatingChanged())}async _prepareScreenshotOverlay(){this.overlay&&await this.overlay.prepare()}_renderScreenshotOverlay(t,e){if(!this.overlay||!this.overlay.hasVisibleItems)return e;const r=t.getContext("2d");return r.putImageData(e,0,0),this.overlay.renderCanvas(t),r.getImageData(0,0,e.width,e.height)}_initStage(){const t={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:()=>this._prepareScreenshotOverlay(),renderOverlay:(s,n)=>this._renderScreenshotOverlay(s,n)}},e=new Yht(this.state.viewingMode,s=>this._stage.layers.forAll(s),this);this._set("sceneIntersectionHelper",e);const r=M4(this.surface);this._stage=new hc({view:this,options:t,container:r}),this._stage.renderer.setParameters({slicePlane:this.slicePlane}),this._lostWebGLContextHandle=qO(this._stage.renderView.canvas,"webglcontextlost",()=>this.fatalError=new q("webgl-context-lost")),this.handles.add([this.updatingHandles.add(()=>this.qualitySettings.antialiasingEnabled,()=>this._stage.renderer.setParameters({antialiasingEnabled:this.qualitySettings.antialiasingEnabled}),Vt),this.updatingHandles.add(()=>this.qualitySettings.highQualityTransparency,s=>this._stage.renderer.setParameters({highQualityTransparency:s}),Vt),ie(()=>this.magnifier,s=>this._stage.renderView.magnifier=s,js),this.on("pointer-move",()=>{var s;return(s=this._stage)==null?void 0:s.renderer.resetAnimation()})],"stage");const i=()=>{this._stage.renderer.setParameters({defaultHighlightOptions:oH.toEngineOptions(this.highlightOptions)})};this.handles.add(this.updatingHandles.add(()=>[this.highlightOptions.color,this.highlightOptions.haloColor,this.highlightOptions.haloOpacity,this.highlightOptions.fillOpacity,this.highlightOptions.shadowOpacity,this.highlightOptions.shadowColor,this.highlightOptions.shadowDifference],i),"stage"),i(),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(rE/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage=ke(this._stage),this._lostWebGLContextHandle=ji(this._lostWebGLContextHandle),this.handles.remove("stage"),this._set("canvas",null)}_initSurface(t){this._exitSurface(),this.state.init(t,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new ipt({view:this,viewingMode:t,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController||this.graphics.length===0)return;this.handles.remove("graphics-view"),this._createGraphicsViewController=new AbortController;const t=()=>{this._createGraphicsViewController=null,this._updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(t,t),this._updatingChanged()}async _createGraphicsViewAsync(t){const e=(await te(()=>import("./GraphicsView3D-3a882cc6.js"),["assets/GraphicsView3D-3a882cc6.js","assets/GraphicsProcessor-5ca4de52.js","assets/Graphics3DObjectStates-4742e98a.js","assets/optimizedFeatureQueryEngineAdapter-9cf4c9eb.js","assets/centroid-0a3057d6.js","assets/PooledRBush-47b3e53d.js","assets/quickselect-56c5966e.js"])).default;fr(t),await WR(()=>{var r;return(r=this.basemapTerrain)==null?void 0:r.ready},t),this._set("graphicsView",new e({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.handles.remove("graphics-view"),v(this.graphicsView)&&(this.handles.remove(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){const t=kre(this.viewingMode);if(t===Be.Global&&(this._clippingArea=null),this._initSurface(t),this._set("ready",!0),this.handles.add(sn(()=>this.graphics,"after-changes",()=>this._createGraphicsViewIfNeeded()),"graphics-view"),this._createGraphicsViewIfNeeded(),!this._externallySet.environment){const r=this.get("map.initialViewProperties.environment");r&&(this.environment=r)}this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const e=this._resolveWhenReady;this._resolveWhenReady=[],e.forEach(r=>r(this))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.handles.remove("graphics-view"),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(c_);for(const t of this.map.allLayers.items)t.type==="integrated-mesh"&&this._defaultToMapOptions.include.add(t.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(c_);for(const t of this.map.allLayers.items)t.type==="integrated-mesh"&&t.opacity<1&&this._defaultHitTestOptions.exclude.add(t.uid)}}addVoxelLayerViewToWasm(t){return C(this.voxelWasm)?(C(this.voxelWasmPromise)&&(this.voxelWasmPromise=te(()=>import("./VoxelWasmPerSceneView-8b8793d7.js"),[]).then(e=>(this.voxelWasm=new e.default(this),this.voxelWasm))),this.voxelWasmPromise.then(e=>e.addVoxelLayer(t))):this.voxelWasm.addVoxelLayer(t)}removeVoxelLayerViewFromWasm(t){v(this.voxelWasm)&&this.voxelWasm.removeVoxelLayer(t)<1&&(this.voxelWasm=null,this.voxelWasmPromise=null)}};function lA(t,e){t.layerUids||(t.layerUids=new Set),t.layerUids.add(e)}function j1t(t,e){t.graphicUids||(t.graphicUids=new Set),t.graphicUids.add(e)}function U$(t,e){return v(t)&&yw(t.spatialReference,e)?AE(t,e):null}var MR;ot.type="3d",u([d()],ot.prototype,"_userClippingArea",void 0),u([d()],ot.prototype,"_resourceController",void 0),u([d()],ot.prototype,"_stage",void 0),u([d({readOnly:!0})],ot.prototype,"deconflictor",void 0),u([d({readOnly:!0})],ot.prototype,"labeler",void 0),u([d(kB(VS,"analyses"))],ot.prototype,"analyses",void 0),u([d({type:YS,readOnly:!0})],ot.prototype,"animation",null),u([d({readOnly:!0})],ot.prototype,"basemapTerrain",void 0),u([d({readOnly:!0})],ot.prototype,"elevationProvider",void 0),u([d()],ot.prototype,"camera",null),u([d({type:kh})],ot.prototype,"contentCamera",null),u([d({readOnly:!0})],ot.prototype,"canvas",void 0),u([d({type:mt})],ot.prototype,"center",null),u([d({type:Zr})],ot.prototype,"clippingArea",null),u([d({type:Sb})],ot.prototype,"constraints",void 0),u([d({type:Zr,readOnly:!0})],ot.prototype,"renderDataExtent",null),u([d({type:Zr,readOnly:!0})],ot.prototype,"dataExtent",null),u([d({type:Zr,readOnly:!0})],ot.prototype,"_groundAndLayersExtent",null),u([d({value:null,type:KT})],ot.prototype,"environment",null),u([cr("environment")],ot.prototype,"castEnvironment",null),u([d({readOnly:!0})],ot.prototype,"environmentManager",void 0),u([d({type:Zr})],ot.prototype,"extent",null),u([d()],ot.prototype,"floors",void 0),u([d()],ot.prototype,"screenCenter",null),u([d()],ot.prototype,"frustum",null),u([d({type:Number,readOnly:!0})],ot.prototype,"fullOpacity",void 0),u([d({readOnly:!0})],ot.prototype,"graphicsView",void 0),u([d({readOnly:!0})],ot.prototype,"analysisViewManager",void 0),u([d()],ot.prototype,"groundView",void 0),u([d({type:Boolean})],ot.prototype,"initialExtentRequired",null),u([d()],ot.prototype,"_defaultsFromMapSettings",null),u([d()],ot.prototype,"interacting",null),u([d()],ot.prototype,"stationary",null),u([d()],ot.prototype,"navigating",null),u([d()],ot.prototype,"map",void 0),u([d({readOnly:!0})],ot.prototype,"mapCoordsHelper",void 0),u([d()],ot.prototype,"padding",null),u([d({type:Pl,readOnly:!0})],ot.prototype,"pointsOfInterest",void 0),u([d({type:xo,readOnly:!0})],ot.prototype,"featureTiles",void 0),u([d()],ot.prototype,"_featureTreeDebugger",void 0),u([d({type:Boolean})],ot.prototype,"screenSizePerspectiveEnabled",void 0),u([d({constructOnly:!0})],ot.prototype,"deactivatedWebGLExtensions",void 0),u([d({constructOnly:!0})],ot.prototype,"debugWebGLExtensions",void 0),u([d({constructOnly:!0})],ot.prototype,"renderCanvas",void 0),u([d({constructOnly:!0})],ot.prototype,"state",void 0),u([d({readOnly:!0})],ot.prototype,"inputManager",void 0),u([d({readOnly:!0})],ot.prototype,"stateManager",void 0),u([d({type:["low","medium","high"]})],ot.prototype,"qualityProfile",null),u([d({type:vae,get(){let t=this._get("qualitySettings");return t||(t=new vae,vD.apply(this.qualityProfile,t)),t}})],ot.prototype,"qualitySettings",void 0),u([d()],ot.prototype,"slicePlane",null),u([d({readOnly:!0})],ot.prototype,"typeSpecificPreconditionsReady",null),u([d({readOnly:!0})],ot.prototype,"renderCoordsHelper",void 0),u([d({readOnly:!0})],ot.prototype,"sceneIntersectionHelper",void 0),u([d({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],ot.prototype,"resolution",null),u([d({type:Number})],ot.prototype,"scale",null),u([d()],ot.prototype,"heightModelInfo",null),u([d()],ot.prototype,"spatialReference",void 0),u([d({type:Boolean,constructOnly:!0})],ot.prototype,"alphaCompositingEnabled",void 0),u([d({constructOnly:!0})],ot.prototype,"preserveDrawingBufferEnabled",void 0),u([d({type:Boolean})],ot.prototype,"supersampleScreenshotsEnabled",void 0),u([d({readOnly:!0})],ot.prototype,"type",void 0),u([d({type:iAe})],ot.prototype,"ui",void 0),u([d({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.hasPendingInputs","toolViewManager.updating","analysisViewManager.updating","state.mode"]})],ot.prototype,"updating",null),u([d({type:Number,readOnly:!0,dependsOn:["updating"]})],ot.prototype,"updatingProgress",void 0),u([d({type:["global","local"]})],ot.prototype,"viewingMode",null),u([d({type:mp})],ot.prototype,"viewpoint",null),u([d({type:Number})],ot.prototype,"zoom",null),u([d({type:oH})],ot.prototype,"highlightOptions",void 0),ot=u([I("esri.views.SceneView")],ot),function(t){t[t.INCLUDE=0]="INCLUDE",t[t.EXCLUDE=1]="EXCLUDE"}(MR||(MR={}));const gT=M(),Ik=as(),Pce=ur(),H1t=ot;new mr({MGRS:"mgrs",USNG:"usng",UTM:"utm",GeoRef:"geo-ref",GARS:"gars",DMS:"dms",DDM:"ddm",DD:"dd"});new mr({109006:"centimeters",9102:"decimal-degrees",109005:"decimeters",9002:"feet",109009:"inches",9036:"kilometers",9001:"meters",9035:"miles",109007:"millimeters",109012:"nautical-miles",9096:"yards"});let u1=class extends ve{constructor(e){super(e),this.deviationUnit=null,this.geometries=null,this.maxDeviation=null}};u([d({type:String,json:{write:!0}})],u1.prototype,"deviationUnit",void 0),u([d({json:{read:{reader:t=>t?t.map(e=>il(e)).filter(v):null},write:{writer:(t,e)=>{e.geometries=(t==null?void 0:t.map(r=>r.toJSON()))??null}}}})],u1.prototype,"geometries",void 0),u([d({type:Number,json:{write:!0}})],u1.prototype,"maxDeviation",void 0),u1=u([I("esri.rest.support.GeneralizeParameters")],u1),u1.from=us(u1);new mr({preserveShape:"preserve-shape"});let m0=class extends ve{constructor(e){super(e),this.calculationType=null,this.geodesic=null,this.lengthUnit=null,this.polylines=null}};u([d({type:String,json:{write:!0}})],m0.prototype,"calculationType",void 0),u([d({type:Boolean,json:{write:!0}})],m0.prototype,"geodesic",void 0),u([d({json:{write:!0}})],m0.prototype,"lengthUnit",void 0),u([d({type:[Eu],json:{read:{reader:t=>t?t.map(e=>il(e)):null},write:{writer:(t,e)=>{e.polylines=t.map(r=>r.toJSON())}}}})],m0.prototype,"polylines",void 0),m0=u([I("esri.rest.support.LengthsParameters")],m0),m0.from=us(m0);new mr({esriGeometryOffsetBevelled:"bevelled",esriGeometryOffsetMitered:"mitered",esriGeometryOffsetRounded:"rounded"});new mr({9001:"meters",9002:"feet",9036:"kilometers",9093:"miles",109012:"nautical-miles",109001:"yards"});let Ym=class extends ve{constructor(e){super(e),this.bevelRatio=null,this.geometries=null,this.offsetDistance=null,this.offsetHow=null,this.offsetUnit=null}};u([d({type:Number,json:{write:!0}})],Ym.prototype,"bevelRatio",void 0),u([d({json:{read:{reader:t=>t?t.map(e=>il(e)).filter(v):null},write:{writer:(t,e)=>{e.geometries=(t==null?void 0:t.map(r=>r.toJSON()))??null}}}})],Ym.prototype,"geometries",void 0),u([d({type:Number,json:{write:!0}})],Ym.prototype,"offsetDistance",void 0),u([d({type:String,json:{write:!0}})],Ym.prototype,"offsetHow",void 0),u([d({type:String,json:{write:!0}})],Ym.prototype,"offsetUnit",void 0),Ym=u([I("esri.rest.support.OffsetParameters")],Ym),Ym.from=us(Ym);new mr({esriGeometryRelationCross:"cross",esriGeometryRelationDisjoint:"disjoint",esriGeometryRelationIn:"in",esriGeometryRelationInteriorIntersection:"interior-intersection",esriGeometryRelationIntersection:"intersection",esriGeometryRelationLineCoincidence:"line-coincidence",esriGeometryRelationLineTouch:"line-touch",esriGeometryRelationOverlap:"overlap",esriGeometryRelationPointTouch:"point-touch",esriGeometryRelationTouch:"touch",esriGeometryRelationWithin:"within",esriGeometryRelationRelation:"relation"});let g0=class extends ve{constructor(e){super(e),this.geometries1=null,this.geometries2=null,this.relation=null,this.relationParameter=null}};u([d({json:{read:{reader:t=>t?t.map(e=>il(e)).filter(v):null},write:{writer:(t,e)=>{e.geometries1=(t==null?void 0:t.map(r=>r.toJSON()))??null}}}})],g0.prototype,"geometries1",void 0),u([d({json:{read:{reader:t=>t?t.map(e=>il(e)).filter(v):null},write:{writer:(t,e)=>{e.geometries2=(t==null?void 0:t.map(r=>r.toJSON()))??null}}}})],g0.prototype,"geometries2",void 0),u([d({type:String,json:{write:!0}})],g0.prototype,"relation",void 0),u([d({type:String,json:{write:!0}})],g0.prototype,"relationParameter",void 0),g0=u([I("esri.rest.support.RelationParameters")],g0),g0.from=us(g0);new mr({0:"default-curve-extension",1:"relocate-ends",2:"keep-end-attributes",4:"no-end-attributes",8:"no-extend-at-from",16:"no-extend-at-to"});let h1=class extends ve{constructor(t){super(t),this.extendHow="default-curve-extension",this.polylines=null,this.trimExtendTo=null}};u([d({type:String,json:{write:!0}})],h1.prototype,"extendHow",void 0),u([d({type:[Eu],json:{read:{reader:t=>t?t.map(e=>il(e)):null},write:{writer:(t,e)=>{e.polylines=t.map(r=>r.toJSON())}}}})],h1.prototype,"polylines",void 0),u([d({json:{read:{reader:t=>t?il(t):null},write:{writer:(t,e)=>{e.trimExtendTo=t.toJSON()}}}})],h1.prototype,"trimExtendTo",void 0),h1=u([I("esri.rest.support.TrimExtendParameters")],h1),h1.from=us(h1);const sAe=se.getLogger("esri.widgets.support.geolocationUtils");function q1t(){const t=de("esri-geolocation");return t||sAe.warn("geolocation-unsupported","Geolocation unsupported."),t}function W1t(){const t=window.isSecureContext;return t||sAe.warn("insecure-context","Geolocation requires a secure origin."),t}function X1t(){return q1t()&&W1t()}function Y1t(t,e){var n;const{position:r,view:i}=t,s=(n=Z1t(r))==null?void 0:n.coords;if(!s)throw new q("geometry-service:no-coords","Geolocation has no coordinates");return K1t(J1t(s),i,e)}function Z1t(t){const e=t&&t.coords||{},r={accuracy:e.accuracy,altitude:e.altitude,altitudeAccuracy:e.altitudeAccuracy,heading:e.heading,latitude:e.latitude,longitude:e.longitude,speed:e.speed};return t&&{coords:r,timestamp:t.timestamp}}function J1t({longitude:t,latitude:e,altitude:r}){return new mt({longitude:t,latitude:e,z:r||void 0,spatialReference:{wkid:4326}})}function K1t(t,e,r){if(!e)return Promise.resolve(t);const i=e.spatialReference;return i.isWGS84?Promise.resolve(t):i.isWebMercator?Promise.resolve(jf(t)):Q1t(r).then(s=>{if(!s)throw new q("geometry-service:missing-url","Geometry service URL is missing");const n=new o6({geometries:[t],outSpatialReference:i});return sJ(s,n,r).then(o=>o[0])})}function Q1t(t){if(Yr.geometryServiceUrl)return Promise.resolve(Yr.geometryServiceUrl);const e=tl.getDefault();return e.load(t).catch(()=>{}).then(()=>e.get("helperServices.geometry.url"))}const ebt=2500;let wf=class extends WX(vs.EventedMixin(Te)){constructor(){super(...arguments),this._geolocationUsable=!0,this._iconPath=Wr("esri/images/support/sdk_gps_location.png"),this.geolocationOptions=null,this.goToLocationEnabled=!0,this.graphic=new Io({symbol:new nM({url:this._iconPath,width:21,height:21})}),this.scale=null,this.useHeadingEnabled=!0,this.view=null}initialize(){X1t()||(this._geolocationUsable=!1)}destroy(){this._clear(),this.view=null}_clear(){this.view&&this.view.graphics.remove(this.graphic)}_getScaleWithinConstraints(t,e){if(!e)return t;if(e.type==="2d"){const{effectiveMaxScale:r,effectiveMinScale:i}=e.constraints;return Math.min(i,Math.max(r,t))}return t}_getScale(t){const{scale:e}=this,r=typeof e=="number"?e:ebt;return this._getScaleWithinConstraints(r,t)}_getHeading(t,e){var n;const r=e==null?void 0:e.spatialReference,i=(r==null?void 0:r.isWebMercator)||(r==null?void 0:r.isGeographic),s=(n=t.coords)==null?void 0:n.heading;if(!(!i||typeof s!="number"||isNaN(s)||s<0||s>360))return s}_addHeading(t){const{heading:e,target:r,view:i}=t;i&&typeof e=="number"&&!isNaN(e)&&(i.type!=="3d"?i.type==="2d"&&(r.rotation=360-e):r.heading=e)}_animatePoint(t,e,r,i){const{view:s}=this;if(!this.goToLocationEnabled||!s)return Promise.resolve(e);const n=this.useHeadingEnabled?this._getHeading(e,s):void 0,o={target:t,scale:r};return this._addHeading({heading:n,target:o,view:s}),this.callGoTo({target:o,options:i}).then(()=>e)}async _setPosition(t,e){try{const r=this.view,i=await Y1t({position:t,view:r},e),{graphic:s}=this,{timestamp:n,coords:o}=t,{accuracy:a,altitude:l,altitudeAccuracy:c,heading:h,latitude:p,longitude:f,speed:m}=o,y={timestamp:n,accuracy:a,altitude:l,altitudeAccuracy:c,heading:h,latitude:p,longitude:f,speed:m};s&&(s.geometry=i,s.attributes=y);const _=this._getScale(r);return this._animatePoint(i,t,_,e)}catch(r){throw new q("positioning:invalid-point","Cannot position invalid point",{error:r})}}};u([d()],wf.prototype,"_geolocationUsable",void 0),u([d()],wf.prototype,"geolocationOptions",void 0),u([d()],wf.prototype,"goToLocationEnabled",void 0),u([d({type:Io,nonNullable:!0})],wf.prototype,"graphic",void 0),u([d()],wf.prototype,"scale",void 0),u([d()],wf.prototype,"useHeadingEnabled",void 0),u([d()],wf.prototype,"view",void 0),wf=u([I("esri.widgets.support.GeolocationPositioning")],wf);const tbt=wf,rbt=15e3;let xf=class extends tbt{constructor(t){super(t),this._watchId=null,this._trackStartingTimeoutId=null,this._settingPosition=null}destroy(){this._stopTracking()}get state(){return this._geolocationUsable?this.view&&!this.view.ready?"disabled":this._settingPosition||this._trackStartingTimeoutId!==null?"waiting":this.tracking?"tracking":"ready":"feature-unsupported"}get tracking(){return this._watchId!==null}start(){this.state!=="disabled"&&this.state!=="feature-unsupported"&&this._startTracking()}stop(){this.state!=="disabled"&&this.state!=="feature-unsupported"&&this._stopTracking()}_stopWatchingPosition(){this._watchId!==null&&(navigator.geolocation.clearWatch(this._watchId),this._watchId=null)}_stopTracking(){this._clearWaitingTimer(),this._stopWatchingPosition(),this._clear()}_startTracking(){this._stopTracking();const t=navigator.geolocation.watchPosition(e=>{this._watchId=t,this._settingPosition=this._setPosition(e).then(r=>{this._clearWaitingTimer();const{view:i,graphic:s}=this;if(i&&i.graphics.remove(s),s){const n=s.clone();this.graphic=n,i&&i.graphics.push(n)}this.emit("track",{position:r})}).catch(r=>{throw this._emitError(r),this._clearWaitingTimer(),r})},this._handleWatchPositionError.bind(this),this.geolocationOptions);this._trackStartingTimeoutId=setTimeout(()=>{this._trackStartingTimeoutId=null},rbt)}_handleWatchPositionError(t){this._emitError(t),this._stopTracking()}_clearWaitingTimer(){clearTimeout(this._trackStartingTimeoutId),this._trackStartingTimeoutId=null,this._settingPosition=null}_emitError(t){this.emit("track-error",{error:t})}};u([d()],xf.prototype,"_watchId",void 0),u([d()],xf.prototype,"_trackStartingTimeoutId",void 0),u([d()],xf.prototype,"_settingPosition",void 0),u([d({readOnly:!0})],xf.prototype,"state",null),u([d({readOnly:!0})],xf.prototype,"tracking",null),u([d()],xf.prototype,"start",null),u([d()],xf.prototype,"stop",null),xf=u([I("esri.widgets.Track.TrackViewModel")],xf);const nAe=xf,Wp={base:"esri-track esri-widget--button esri-widget",text:"esri-icon-font-fallback-text",icon:"esri-icon",loading:"esri-icon-loading-indicator",rotating:"esri-rotating",startTrackingIcon:"esri-icon-tracking",stopTrackingIcon:"esri-icon-pause",widgetIcon:"esri-icon-tracking",disabled:"esri-disabled",hidden:"esri-hidden"};let za=class extends Ea{constructor(t,e){super(t,e),this.iconClass=Wp.widgetIcon,this.messages=null,this.viewModel=new nAe}get geolocationOptions(){return this.viewModel.geolocationOptions}set geolocationOptions(t){this.viewModel.geolocationOptions=t}get goToLocationEnabled(){return this.viewModel.goToLocationEnabled}set goToLocationEnabled(t){this.viewModel.goToLocationEnabled=t}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(t){this.viewModel.goToOverride=t}get graphic(){return this.viewModel.graphic}set graphic(t){this.viewModel.graphic=t}get label(){var t;return((t=this.messages)==null?void 0:t.widgetLabel)??""}set label(t){this._overrideIfSome("label",t)}get scale(){return this.viewModel.scale}set scale(t){this.viewModel.scale=t}get tracking(){return this.viewModel.tracking}get useHeadingEnabled(){return this.viewModel.useHeadingEnabled}set useHeadingEnabled(t){this.viewModel.useHeadingEnabled=t}get view(){return this.viewModel.view}set view(t){this.viewModel.view=t}start(){this.viewModel.start()}stop(){this.viewModel.stop()}render(){const t=this.get("viewModel.state"),e={[Wp.disabled]:t==="disabled",[Wp.hidden]:t==="feature-unsupported"},r=t==="tracking",i={[Wp.startTrackingIcon]:!r&&t!=="waiting",[Wp.stopTrackingIcon]:r,[Wp.rotating]:t==="waiting",[Wp.loading]:t==="waiting"},{messages:s}=this,n=r?s.stopTracking:s.startTracking;return re("div",{bind:this,class:this.classes(Wp.base,e),hidden:t==="feature-unsupported",onclick:this._toggleTracking,onkeydown:this._toggleTracking,role:"button",tabIndex:0,"aria-label":n,title:n},re("span",{"aria-hidden":"true",class:this.classes(Wp.icon,i)}),re("span",{class:Wp.text},n))}_toggleTracking(){const t=this.viewModel;t&&t.state!=="feature-unsupported"&&t.state!=="disabled"&&(t.state!=="tracking"&&t.state!=="waiting"?this.viewModel.start():this.viewModel.stop())}};u([d()],za.prototype,"geolocationOptions",null),u([d()],za.prototype,"goToLocationEnabled",null),u([d()],za.prototype,"goToOverride",null),u([d()],za.prototype,"graphic",null),u([d()],za.prototype,"iconClass",void 0),u([d()],za.prototype,"label",null),u([d(),ya("esri/widgets/Track/t9n/Track")],za.prototype,"messages",void 0),u([d()],za.prototype,"scale",null),u([d({readOnly:!0})],za.prototype,"tracking",null),u([d()],za.prototype,"useHeadingEnabled",null),u([d()],za.prototype,"view",null),u([d({type:nAe}),Hge(["track","track-error"])],za.prototype,"viewModel",void 0),u([hu()],za.prototype,"_toggleTracking",null),za=u([I("esri.widgets.Track")],za);const ibt=za;console.log("Version",void 0);let k$=[];const sbt=document.getElementById("geolocationDiv"),nbt=new Mde({basemap:"topo-vector"}),CJ=new H1t({container:"viewDiv",map:nbt,zoom:4,center:[15,65]}),mE=new ibt({view:CJ,geolocationOptions:{maximumAge:0,timeout:3e4,enableHighAccuracy:!0}});mE.viewModel.positionFilterFunction=t=>{let e=null;return k$.push(t.position.coords),k$.length>4?e=k$.pop():e=t,console.log("filter",k$),e};CJ.ui.add(mE,"top-left");mE.on("track",t=>{var i,s,n,o,a,l;const e=t.position.coords.longitude.toFixed(4),r=t.position.coords.latitude.toFixed(4);console.log("Track1",`${e}, ${r}`),console.log("Track:",t),sbt.innerText=`
  Latitude: ${(i=t.position.coords.latitude)==null?void 0:i.toFixed(4)}
  Longitude: ${(s=t.position.coords.longitude)==null?void 0:s.toFixed(4)}
  Altitude: ${(n=t.position.coords.altitude)==null?void 0:n.toFixed(1)}
  Heading: ${(o=t.position.coords.heading)==null?void 0:o.toFixed(0)}
  Speed: ${(a=t.position.coords.speed)==null?void 0:a.toFixed(2)}
  Accuracy: ${(l=t.position.coords.accuracy)==null?void 0:l.toFixed(0)}m
  Position Filter: ${typeof mE.viewModel.positionFilterFunction=="function"}
  Version: ${void 0}`});mE.on("track-error",t=>{console.error("Geolocation error:",t)});CJ.when(()=>{mE.start()});export{nl as $,Bs as A,ji as B,C,xi as D,Se as E,Rme as F,Po as G,VY as H,Mi as I,Io as J,M as K,_Ft as L,jl as M,Qd as N,Ls as O,RGe as P,V3 as Q,Pt as R,Lpt as S,q as T,Ni as U,hDe as V,AE as W,gEt as X,cpe as Y,e4 as Z,te as _,ke as a,_R as a$,YH as a0,xc as a1,aHe as a2,ur as a3,hp as a4,QO as a5,Eu as a6,mt as a7,BK as a8,yw as a9,aw as aA,ySt as aB,due as aC,Bj as aD,vE as aE,TTt as aF,kke as aG,It as aH,jw as aI,il as aJ,Zr as aK,et as aL,_m as aM,ve as aN,bS as aO,Fe as aP,He as aQ,$K as aR,aX as aS,yye as aT,i8e as aU,r8e as aV,sn as aW,yv as aX,JH as aY,zNe as aZ,sm as a_,a4 as aa,Yw as ab,vs as ac,Dit as ad,_n as ae,aM as af,$de as ag,Qwt as ah,kIe as ai,Yf as aj,_t as ak,mVe as al,Fh as am,js as an,wbt as ao,Bk as ap,H_ as aq,yS as ar,$pt as as,Hr as at,YO as au,Ln as av,_a as aw,B_ as ax,zue as ay,ri as az,I as b,Me as b$,cp as b0,b4 as b1,ss as b2,gbt as b3,Uu as b4,nn as b5,A as b6,Xe as b7,uE as b8,Pn as b9,kr as bA,Pu as bB,ce as bC,yV as bD,Pw as bE,b5 as bF,w as bG,kc as bH,by as bI,Ie as bJ,Je as bK,Nr as bL,Vr as bM,Fr as bN,Rr as bO,Bt as bP,Xl as bQ,Kt as bR,dm as bS,Tv as bT,V as bU,eo as bV,Mo as bW,lt as bX,Jt as bY,zr as bZ,me as b_,HZ as ba,ix as bb,Rt as bc,U_ as bd,qSe as be,ye as bf,mDt as bg,En as bh,yDt as bi,Mxt as bj,T$e as bk,cb as bl,pDt as bm,nF as bn,ry as bo,pi as bp,Lxt as bq,$Rt as br,Dr as bs,Xs as bt,jwe as bu,gs as bv,$4 as bw,Hi as bx,hO as by,or as bz,Hf as c,B6 as c$,ae as c0,ga as c1,ti as c2,ppe as c3,_Dt as c4,vDt as c5,wDt as c6,iW as c7,ua as c8,GDe as c9,JE as cA,Ao as cB,l4 as cC,cEt as cD,Tn as cE,Ri as cF,no as cG,lm as cH,pt as cI,_e as cJ,VR as cK,ZR as cL,Ske as cM,POt as cN,IOt as cO,cN as cP,tit as cQ,oOt as cR,sPt as cS,iSt as cT,WR as cU,HXe as cV,sTt as cW,u4 as cX,Gw as cY,vN as cZ,eW as c_,$t as ca,T4 as cb,$xt as cc,Qe as cd,Sp as ce,jr as cf,Lr as cg,fFt as ch,xHe as ci,VIt as cj,uw as ck,wVe as cl,xy as cm,Df as cn,uEt as co,N4 as cp,hpe as cq,uye as cr,UA as cs,hme as ct,hEt as cu,fr as cv,ubt as cw,le as cx,QN as cy,qM as cz,lbt as d,QRt as d$,L_ as d0,Dk as d1,FR as d2,cw as d3,ge as d4,wr as d5,Bce as d6,Ac as d7,fe as d8,lX as d9,qr as dA,a$ as dB,so as dC,axe as dD,Vc as dE,Qgt as dF,IDe as dG,tTt as dH,hle as dI,gS as dJ,FS as dK,VLe as dL,Hh as dM,Gl as dN,nTt as dO,Ht as dP,qs as dQ,NSe as dR,TE as dS,rr as dT,zye as dU,Gye as dV,aOt as dW,gE as dX,dfe as dY,gDt as dZ,WOe as d_,Ome as da,yp as db,x4 as dc,sW as dd,sr as de,Fc as df,_s as dg,zK as dh,Cu as di,gpe as dj,Ho as dk,v_ as dl,Dl as dm,PR as dn,vS as dp,zh as dq,Wh as dr,jLe as ds,We as dt,OJe as du,gFt as dv,US as dw,fa as dx,GEe as dy,Ze as dz,u as e,S_e as e$,yAe as e0,ne as e1,n4 as e2,Yg as e3,nxt as e4,rxt as e5,yW as e6,CW as e7,Og as e8,ICt as e9,gdt as eA,Xa as eB,rSt as eC,kH as eD,ybt as eE,Qbt as eF,om as eG,Mfe as eH,Pfe as eI,Dn as eJ,zhe as eK,Ade as eL,Eft as eM,b1t as eN,gv as eO,Ww as eP,SE as eQ,Ft as eR,oke as eS,pC as eT,ASt as eU,C4 as eV,RSt as eW,oM as eX,OSt as eY,A4 as eZ,iM as e_,Ti as ea,CF as eb,dp as ec,ui as ed,$Dt as ee,ewt as ef,wu as eg,XH as eh,Lbt as ei,pO as ej,mq as ek,Jr as el,Cp as em,cOt as en,hOt as eo,T1e as ep,Xd as eq,uit as er,Ogt as es,bDt as et,R_ as eu,WDe as ev,Ro as ew,j4 as ex,kre as ey,VK as ez,Te as f,Pe as f$,a$e as f0,CSt as f1,rOt as f2,dDe as f3,Q_ as f4,pht as f5,sst as f6,rst as f7,Ixt as f8,vOt as f9,upe as fA,Lht as fB,fbt as fC,aGe as fD,Owt as fE,tl as fF,pSt as fG,sl as fH,VHe as fI,BEt as fJ,Z$t as fK,aJ as fL,sxt as fM,Gr as fN,xu as fO,fp as fP,PAt as fQ,Ws as fR,qb as fS,Ki as fT,oB as fU,ldt as fV,$c as fW,Bl as fX,Hfe as fY,Fu as fZ,Mt as f_,_Ot as fa,ty as fb,XS as fc,Ec as fd,So as fe,qIt as ff,FZ as fg,uOt as fh,CTe as fi,Zo as fj,Gbt as fk,j_ as fl,Yd as fm,yu as fn,MP as fo,tOt as fp,aQ as fq,YRt as fr,Ait as fs,E4 as ft,Xw as fu,fht as fv,xZ as fw,_M as fx,wn as fy,Kg as fz,Wr as g,k9e as g$,bm as g0,xt as g1,Tp as g2,Ee as g3,wy as g4,y5 as g5,xv as g6,G5 as g7,hv as g8,q5 as g9,Kee as gA,Zg as gB,wGe as gC,V_e as gD,PGe as gE,SVe as gF,Lke as gG,EX as gH,rM as gI,gt as gJ,mr as gK,xGe as gL,xbt as gM,Ar as gN,rTt as gO,nme as gP,Krt as gQ,Rxt as gR,bbt as gS,dLt as gT,Ext as gU,B8e as gV,eOt as gW,Tc as gX,Tye as gY,g0e as gZ,$bt as g_,kZ as ga,j5 as gb,XE as gc,vnt as gd,aY as ge,qE as gf,rm as gg,bRe as gh,gp as gi,Nit as gj,dgt as gk,TAe as gl,SAe as gm,DY as gn,mY as go,xDt as gp,LY as gq,Iw as gr,to as gs,np as gt,lot as gu,es as gv,Oo as gw,tW as gx,Gi as gy,gSt as gz,Vt as h,oQ as h$,Dwt as h0,$_ as h1,Jh as h2,hot as h3,Iu as h4,nu as h5,ls as h6,$r as h7,bt as h8,Ds as h9,Hb as hA,Pye as hB,Rde as hC,Tq as hD,Twt as hE,pa as hF,nX as hG,TUe as hH,IS as hI,o9e as hJ,Gwt as hK,Rue as hL,t4 as hM,aW as hN,gw as hO,qR as hP,m_ as hQ,Au as hR,U$e as hS,xS as hT,k$e as hU,o4e as hV,lw as hW,cwt as hX,Dxt as hY,y2 as hZ,F3 as h_,Aa as ha,Ve as hb,Lt as hc,tt as hd,ct as he,Bi as hf,Li as hg,Wo as hh,cm as hi,ts as hj,wv as hk,YN as hl,bv as hm,V5 as hn,PRt as ho,St as hp,Ife as hq,aTt as hr,q2t as hs,m4 as ht,x2t as hu,Jo as hv,$s as hw,u2t as hx,KOe as hy,nMe as hz,se as i,dH as i$,O2t as i0,Tee as i1,P2t as i2,Hwt as i3,Gq as i4,uhe as i5,rOe as i6,w2t as i7,Rye as i8,Mye as i9,WE as iA,DM as iB,M2t as iC,eTt as iD,I_ as iE,xP as iF,zq as iG,Bq as iH,fye as iI,Vwt as iJ,Fb as iK,Ta as iL,Z2 as iM,V6e as iN,bs as iO,Wb as iP,R6 as iQ,nw as iR,BB as iS,Vs as iT,VB as iU,GB as iV,_N as iW,cDe as iX,Dz as iY,Zpe as iZ,Vk as i_,Cye as ia,SUe as ib,wne as ic,hst as id,oxt as ie,HRt as ig,Ede as ih,VPe as ii,Bwt as ij,e5 as ik,em as il,mM as im,L8e as io,KRt as ip,gVe as iq,ext as ir,txt as is,ixt as it,BR as iu,Ru as iv,UIe as iw,kxe as ix,fi as iy,j$ as iz,k as j,Ty as j$,U$t as j0,W$t as j1,E2e as j2,$ae as j3,F$t as j4,D$t as j5,V$t as j6,YL as j7,K9 as j8,TL as j9,kf as jA,MNe as jB,xTt as jC,uDe as jD,pr as jE,kn as jF,Ur as jG,ns as jH,Un as jI,j2 as jJ,mPt as jK,Dhe as jL,Iwt as jM,gn as jN,gwt as jO,mwt as jP,_he as jQ,ghe as jR,Fhe as jS,Jxt as jT,Qxt as jU,Kxt as jV,If as jW,cO as jX,qo as jY,Yr as jZ,Fn as j_,mD as ja,wp as jb,Pwt as jc,jh as jd,PZ as je,xh as jf,Pae as jg,Xdt as jh,Ydt as ji,Co as jj,xO as jk,EMe as jl,_Tt as jm,gDe as jn,yDe as jo,cv as jp,vw as jq,Oc as jr,iTt as js,mTt as jt,gTt as ju,Cw as jv,cV as jw,rS as jx,bie as jy,Gt as jz,Qi as k,xp as k$,L2 as k0,ma as k1,uPt as k2,Jj as k3,_wt as k4,oV as k5,Y4 as k6,XTt as k7,YTt as k8,ZTt as k9,MW as kA,lM as kB,bi as kC,Y3 as kD,V4 as kE,pme as kF,bTt as kG,vTt as kH,gqe as kI,vqe as kJ,ywt as kK,fwt as kL,pwt as kM,$u as kN,Pb as kO,sit as kP,Pq as kQ,Ire as kR,$At as kS,Pre as kT,Hq as kU,Ya as kV,Gh as kW,P4 as kX,jst as kY,rl as kZ,_5 as k_,JTt as ka,Bh as kb,as as kc,Vd as kd,Sc as ke,KX as kf,JX as kg,epe as kh,Ys as ki,je as kj,ms as kk,yTt as kl,sNe as km,QT as kn,kfe as ko,Lve as kp,$e as kq,Nl as kr,q_ as ks,p4 as kt,Dq as ku,Xg as kv,uqe as kw,pn as kx,Ive as ky,ay as kz,ie as l,ql as l$,ro as l0,Qht as l1,cbt as l2,Yb as l3,lXe as l4,KCt as l5,ZCt as l6,JCt as l7,dTt as l8,vxt as l9,pTt as lA,Axt as lB,ym as lC,wW as lD,vfe as lE,bp as lF,nE as lG,qt as lH,Yo as lI,H5 as lJ,Ywe as lK,oxe as lL,ft as lM,Oi as lN,Pxt as lO,RW as lP,voe as lQ,joe as lR,aO as lS,XO as lT,cr as lU,bh as lV,DK as lW,lTt as lX,c_ as lY,Nu as lZ,Q5 as l_,F_ as la,OF as lb,qxe as lc,MAt as ld,wqe as le,LA as lf,H2 as lg,gV as lh,Sa as li,_S as lj,k2 as lk,jH as ll,$Et as lm,r4 as ln,Iat as lo,qst as lp,Nw as lq,qf as lr,Ct as ls,HH as lt,iOt as lu,Mf as lv,Nbe as lw,Zw as lx,OW as ly,yxt as lz,Qs as m,X2t as m$,Ca as m0,Su as m1,on as m2,exe as m3,uTt as m4,_tt as m5,Du as m6,BDe as m7,dxe as m8,aE as m9,uy as mA,SNe as mB,Qg as mC,z4 as mD,mZe as mE,cTt as mF,xie as mG,IAt as mH,Jw as mI,NLe as mJ,uVe as mK,rGe as mL,lGe as mM,o0e as mN,wpt as mO,bpt as mP,DR as mQ,EE as mR,CVe as mS,_bt as mT,lke as mU,kbt as mV,LE as mW,nVe as mX,lwt as mY,tOe as mZ,qRt as m_,ES as ma,fj as mb,_Z as mc,$wt as md,dAe as me,fTt as mf,_6 as mg,wN as mh,dnt as mi,bFt as mj,xFt as mk,wFt as ml,KO as mm,Cxt as mn,d1 as mo,Mre as mp,uf as mq,KR as mr,IW as ms,DS as mt,_xt as mu,qKe as mv,$W as mw,efe as mx,LS as my,rme as mz,nt as n,E8e as n$,yke as n0,yIe as n1,CIe as n2,A7e as n3,R7e as n4,O7e as n5,Ih as n6,Tyt as n7,Syt as n8,gyt as n9,Kat as nA,v2t as nB,g2t as nC,f2t as nD,A2t as nE,C2t as nF,_2t as nG,qH as nH,KUe as nI,a9e as nJ,Iye as nK,S2t as nL,T2t as nM,lxt as nN,cxt as nO,axt as nP,APe as nQ,ZRt as nR,See as nS,WRt as nT,Pc as nU,P8e as nV,Tke as nW,uIe as nX,S$e as nY,f8e as nZ,I2t as n_,FNt as na,XF as nb,qDt as nc,Cyt as nd,OM as ne,aF as nf,kie as ng,WAt as nh,zLe as ni,wa as nj,NM as nk,mW as nl,Lu as nm,n6 as nn,afe as no,Zh as np,QS as nq,_Pt as nr,uv as ns,gPt as nt,vPt as nu,yPt as nv,Yat as nw,Qat as nx,Zat as ny,Jat as nz,LK as o,DTt as o$,pee as o0,D8e as o1,R2t as o2,pLe as o3,K2t as o4,FB as o5,L3 as o6,yU as o7,_U as o8,hbt as o9,bc as oA,Iae as oB,ya as oC,Ea as oD,re as oE,Tf as oF,SN as oG,Wge as oH,wi as oI,Gce as oJ,z2 as oK,Que as oL,nwt as oM,qO as oN,SRe as oO,ip as oP,c4 as oQ,HO as oR,bwt as oS,OTt as oT,PTt as oU,ige as oV,VTt as oW,g5e as oX,f5e as oY,$Tt as oZ,LTt as o_,dbt as oa,_u as ob,d2t as oc,pbt as od,wc as oe,ey as of,vM as og,Za as oh,Ize as oi,E2t as oj,bye as ok,Xr as ol,Vi as om,XB as on,L9e as oo,D9e as op,XDe as oq,ep as or,hTt as os,tNe as ot,abt as ou,zRe as ov,wS as ow,pq as ox,hAe as oy,q$t as oz,vi as p,cCe as p$,qTt as p0,ATt as p1,jTt as p2,RTt as p3,BTt as p4,UTt as p5,y4e as p6,MTt as p7,NTt as p8,kTt as p9,HTt as pA,cR as pB,Fqe as pC,AWe as pD,m1e as pE,f1e as pF,KWe as pG,_Y as pH,IXe as pI,U1e as pJ,wY as pK,FXe as pL,SYe as pM,GYe as pN,hrt as pO,AF as pP,Xit as pQ,gZ as pR,Att as pS,Bw as pT,_mt as pU,ayt as pV,wJ as pW,iCe as pX,Iyt as pY,oCe as pZ,Lyt as p_,y5e as pa,CTt as pb,Oke as pc,xE as pd,nSt as pe,JSt as pf,$je as pg,WRe as ph,Mke as pi,sSt as pj,B2t as pk,$S as pl,H3 as pm,EB as pn,oSt as po,GTt as pp,zTt as pq,pv as pr,dde as ps,Che as pt,the as pu,C_ as pv,cEe as pw,jft as px,FTt as py,ITt as pz,Be as q,RMe as q$,Nyt as q0,dCe as q1,Uyt as q2,iP as q3,G6 as q4,M$e as q5,_1e as q6,tXe as q7,Dbt as q8,b2 as q9,wCe as qA,T0t as qB,SCe as qC,y6 as qD,F0t as qE,q0t as qF,i_t as qG,n_t as qH,a_t as qI,Kke as qJ,el as qK,kd as qL,j8e as qM,y2t as qN,Cq as qO,MSt as qP,pAe as qQ,ISt as qR,PSt as qS,$St as qT,Mwt as qU,Ont as qV,ECe as qW,V0t as qX,S_t as qY,mSt as qZ,pVe as q_,pde as qa,Uq as qb,BPe as qc,Uwt as qd,Fq as qe,kwt as qf,zwt as qg,Vh as qh,zot as qi,qq as qj,pm as qk,ZO as ql,vot as qm,Sot as qn,Hnt as qo,Ynt as qp,zZ as qq,pft as qr,dft as qs,h6 as qt,fft as qu,PF as qv,Wst as qw,_0t as qx,_Ce as qy,w0t as qz,vt as r,Dye as r$,Mat as r0,ilt as r1,yut as r2,Uut as r3,Iut as r4,hVe as r5,yGe as r6,gGe as r7,Gd as r8,tpe as r9,kX as rA,F_e as rB,Uc as rC,Yh as rD,nM as rE,nIe as rF,sIe as rG,LPe as rH,SK as rI,Qa as rJ,i5 as rK,wOe as rL,bOe as rM,vwt as rN,gU as rO,I3e as rP,AGe as rQ,PE as rR,yX as rS,kye as rT,UUe as rU,Q9e as rV,kUe as rW,jye as rX,Zye as rY,UN as rZ,Hbt as r_,rVe as ra,Zue as rb,_St as rc,RVe as rd,MVe as re,oVe as rf,SX as rg,lVe as rh,cVe as ri,Y_ as rj,hi as rk,lDe as rl,nGe as rm,dVe as rn,eGe as ro,yVe as rp,vGe as rq,NK as rr,Ide as rs,CX as rt,u5 as ru,ere as rv,AVe as rw,N7 as rx,s5 as ry,EVe as rz,eM as s,N_e as s$,rR as s0,aVe as s1,jwt as s2,us as s3,Tbt as s4,mw as s5,Oxt as s6,WS as s7,hE as s8,x_e as s9,N_ as sA,Hte as sB,kR as sC,jS as sD,IVe as sE,PVe as sF,dv as sG,O4 as sH,oX as sI,Xze as sJ,Jke as sK,hy as sL,p7e as sM,Jze as sN,Kze as sO,Nze as sP,Fze as sQ,Uze as sR,kze as sS,Vze as sT,Bze as sU,zze as sV,Gze as sW,jze as sX,Hze as sY,qze as sZ,Wze as s_,KH as sa,$T as sb,mz as sc,VSt as sd,e7e as se,UD as sf,aR as sg,kB as sh,lB as si,qh as sj,KS as sk,IWe as sl,hY as sm,MDe as sn,ex as so,h4 as sp,qwt as sq,owt as sr,tMe as ss,im as st,tm as su,Jde as sv,she as sw,PJ as sx,kN as sy,fVe as sz,ei as t,Z2e as t$,xAe as t0,sp as t1,iwt as t2,rK as t3,xpe as t4,jMe as t5,nN as t6,d4 as t7,OVe as t8,fSt as t9,zS as tA,uq as tB,Xat as tC,Hu as tD,qAt as tE,HAt as tF,LOt as tG,_ye as tH,wwt as tI,B5e as tJ,TP as tK,Nz as tL,pZe as tM,$De as tN,PDe as tO,Nf as tP,G2e as tQ,rw as tR,iZe as tS,awt as tT,tSe as tU,iSe as tV,Ab as tW,TR as tX,Lwt as tY,IZ as tZ,Slt as t_,swt as ta,hRe as tb,HJ as tc,D as td,dwt as te,gme as tf,bNe as tg,oa as th,THe as ti,WN as tj,L_t as tk,W2t as tl,Y_e as tm,xje as tn,K_e as to,yje as tp,J1 as tq,HX as tr,jX as ts,$2t as tt,qX as tu,P7e as tv,I7e as tw,$7e as tx,M_e as ty,mx as tz,h_ as u,_lt as u0,eSe as u1,K2e as u2,Tlt as u3,Nc as u4,eH as u5,xa as u6,Q2e as u7,AM as u8,vlt as u9,mO as ua,kj as ub,S5 as uc,ust as ud,Xlt as ue,Wlt as uf,qlt as ug,vy as uh,RAt as ui,Hx as uj,UOe as uk,L2t as ul,bX as um,j2t as un,zSt as uo,sOt as up,$Pt as uq,pp as v,v as w,fdt as x,d as y,de as z};
