import{cm as xe,dQ as ve,rq as Re,cj as E,rr as we,rs as $e,rt as ce,C as Te,et as F,e as i,a as v,kd as Ve,kV as te,d as G,y as l,a3 as d,nI as _e,bz as Ie,ru as He,K as q,m7 as z,rv as We,bD as X,bE as re,mC as N,mi as pe,j as se,cu as b,m as ke,lM as K,by as ie,mQ as Ae,rw as Ne,rx as Fe,h1 as Me,L as ne,gE as Ge,gF as ue,qt as be,hF as Se,k7 as ze,k5 as Be,k6 as Ue,ry as qe,eQ as Ke,h6 as De,V as Q,b7 as Je,aq as Qe,aK as Xe,g as Ye,df as Ze,br as et,R as tt,dn as nt,P as ot,S as rt,rz as st,af as it,a$ as at}from"./index-d29f6b97.js";import{O as lt}from"./MultiOriginJSONSupport-d8471874.js";import{a as ct}from"./BlendLayer-6b704ca4.js";import{c as pt}from"./OperationalLayer-abee1819.js";import{t as ut}from"./ScaleRangeLayer-4ea69c96.js";import{t as dt}from"./resourceExtension-ea46dd67.js";import{o as ht}from"./BoundsStore-0665b530.js";import{i as mt}from"./MediaElementView-3bb86dc9.js";import"./jsonUtils-5b32189b.js";import"./commonProperties-4511a72e.js";import"./ElevationInfo-568c6f07.js";import"./PooledRBush-5ef79871.js";import"./quickselect-6ad44cba.js";import"./normalizeUtilsSync-4e86052e.js";import"./normalizeUtilsCommon-6017271d.js";const g=Te(),H=F(),Z=F(),de=F();function j(e,t,n){return xe(g,t[0],t[1],1),ve(g,g,Re(H,n)),g[2]===0?E(e,g[0],g[1]):E(e,g[0]/g[2],g[1]/g[2])}function ft(e,t,n){return he(Z,t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7]),he(de,n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7]),we(e,$e(Z,Z),de),e[8]!==0&&(e[0]/=e[8],e[1]/=e[8],e[2]/=e[8],e[3]/=e[8],e[4]/=e[8],e[5]/=e[8],e[6]/=e[8],e[7]/=e[8],e[8]/=e[8]),e}function he(e,t,n,o,r,s,a,c,p){ce(e,t,o,s,n,r,a,1,1,1),xe(g,c,p,1),$e(H,e);const[h,f,x]=ve(g,g,Re(H,H));return ce(H,h,0,0,0,f,0,0,0,x),we(e,H,e)}let oe=class extends Ve{projectOrWarn(t,n){if(t==null)return t;const{geometry:o,pending:r}=te(t,n);return r?null:r||o?o:(G.getLogger(this.declaredClass).warn("geometry could not be projected to the spatial reference",{georeference:this,geometry:t,sourceSpatialReference:t.spatialReference,targetSpatialReference:n}),null)}};oe=i([v("esri.layers.support.GeoreferenceBase")],oe);const Y=oe,ee=F(),u=b();let B=class extends ke{constructor(){super(...arguments),this.sourcePoint=null,this.mapPoint=null}};i([l()],B.prototype,"sourcePoint",void 0),i([l({type:d})],B.prototype,"mapPoint",void 0),B=i([v("esri.layers.support.ControlPoint")],B);let P=class extends _e(Y){constructor(e){super(e),this.controlPoints=null,this.height=0,this.type="control-points",this.width=0}readControlPoints(e,t){const n=Ie.fromJSON(t.spatialReference),o=He(...t.coefficients,1);return e.map(r=>(E(u,r.x,r.y),j(u,u,o),{sourcePoint:r,mapPoint:new d({x:u[0],y:u[1],spatialReference:n})}))}writeControlPoints(e,t,n,o){if(this.transform!=null)e!=null&&m(e[0])&&(t.controlPoints=e.map(r=>{const s=r.sourcePoint;return{x:s.x,y:s.y}}),t.spatialReference=e[0].mapPoint.spatialReference.toJSON(),t.coefficients=this.transform.slice(0,8));else{const r=new q("web-document-write:invalid-georeference","Invalid 'controlPoints', 'width', 'height' configuration.",{layer:o==null?void 0:o.layer,georeference:this});o!=null&&o.messages?o.messages.push(r):G.getLogger(this.declaredClass).error(r.name,r.message)}}get coords(){if(this.controlPoints==null)return null;const e=this._updateTransform(ee);if(e==null||!m(this.controlPoints[0]))return null;const t=this.controlPoints[0].mapPoint.spatialReference;return vt(e,this.width,this.height,t)}set coords(e){if(this.controlPoints==null||!m(this.controlPoints[0]))return;const t=this.controlPoints[0].mapPoint.spatialReference;if((e=this.projectOrWarn(e,t))==null)return;const{width:n,height:o}=this,{rings:[[r,s,a,c]]}=e,p={sourcePoint:z(0,o),mapPoint:new d({x:r[0],y:r[1],spatialReference:t})},h={sourcePoint:z(0,0),mapPoint:new d({x:s[0],y:s[1],spatialReference:t})},f={sourcePoint:z(n,0),mapPoint:new d({x:a[0],y:a[1],spatialReference:t})},x={sourcePoint:z(n,o),mapPoint:new d({x:c[0],y:c[1],spatialReference:t})};m(p)&&m(h)&&m(f)&&m(x)&&(me(ee,p,h,f,x),this.controlPoints=this.controlPoints.map(({sourcePoint:R})=>(E(u,R.x,R.y),j(u,u,ee),{sourcePoint:R,mapPoint:new d({x:u[0],y:u[1],spatialReference:t})})))}get inverseTransform(){return this.transform==null?null:We(F(),this.transform)}get transform(){return this._updateTransform()}toMap(e){if(e==null||this.transform==null||this.controlPoints==null||!m(this.controlPoints[0]))return null;E(u,e.x,e.y);const t=this.controlPoints[0].mapPoint.spatialReference;return j(u,u,this.transform),new d({x:u[0],y:u[1],spatialReference:t})}toSource(e){if(e==null||this.inverseTransform==null||this.controlPoints==null||!m(this.controlPoints[0]))return null;const t=this.controlPoints[0].mapPoint.spatialReference;return e=e.normalize(),(e=te(e,t).geometry)==null?null:(E(u,e.x,e.y),j(u,u,this.inverseTransform),z(u[0],u[1]))}_updateTransform(e){const{controlPoints:t,width:n,height:o}=this;if(!(t!=null&&n>0&&o>0))return null;const[r,s,a,c]=t;if(!m(r))return null;const p=r.mapPoint.spatialReference,h=this._projectControlPoint(s,p),f=this._projectControlPoint(a,p),x=this._projectControlPoint(c,p);if(!h.valid||!f.valid||!x.valid||!m(h.controlPoint))return null;e==null&&(e=F());let R=null;return R=m(f.controlPoint)&&m(x.controlPoint)?me(e,r,h.controlPoint,f.controlPoint,x.controlPoint):m(f.controlPoint)?gt(e,r,h.controlPoint,f.controlPoint):yt(e,r,h.controlPoint),R.every(Oe=>Oe===0)?null:R}_projectControlPoint(e,t){if(!m(e))return{valid:!0,controlPoint:e};const{sourcePoint:n,mapPoint:o}=e,{geometry:r,pending:s}=te(o,t);return s?{valid:!1,controlPoint:null}:s||r?{valid:!0,controlPoint:{sourcePoint:n,mapPoint:r}}:(G.getLogger(this.declaredClass).warn("map point could not be projected to the spatial reference",{georeference:this,controlPoint:e,sourceSpatialReference:o.spatialReference,targetSpatialReference:t}),{valid:!1,controlPoint:null})}};function m(e){return e!=null&&e.sourcePoint!=null&&e.mapPoint!=null}i([l({type:[B],json:{write:{allowNull:!1,isRequired:!0}}})],P.prototype,"controlPoints",void 0),i([X("controlPoints")],P.prototype,"readControlPoints",null),i([re("controlPoints")],P.prototype,"writeControlPoints",null),i([l()],P.prototype,"coords",null),i([l({json:{write:!0}})],P.prototype,"height",void 0),i([l({readOnly:!0})],P.prototype,"inverseTransform",null),i([l({readOnly:!0})],P.prototype,"transform",null),i([l({json:{write:!0}})],P.prototype,"width",void 0),P=i([v("esri.layers.support.ControlPointsGeoreference")],P);const w=b(),$=b(),T=b(),C=b(),_=b(),I=b(),V=b(),O=b(),D=Math.PI/2;function M(e,t,n){E(e,n.sourcePoint.x,n.sourcePoint.y),E(t,n.mapPoint.x,n.mapPoint.y)}function yt(e,t,n){return M(w,_,t),M($,I,n),N(T,$,w,D),N(C,w,$,D),N(V,I,_,-D),N(O,_,I,-D),ae(e,w,$,T,C,_,I,V,O)}function gt(e,t,n,o){return M(w,_,t),M($,I,n),M(T,V,o),pe(C,w,$,.5),N(C,T,C,Math.PI),pe(O,_,I,.5),N(O,V,O,Math.PI),ae(e,w,$,T,C,_,I,V,O)}function me(e,t,n,o,r){return M(w,_,t),M($,I,n),M(T,V,o),M(C,O,r),ae(e,w,$,T,C,_,I,V,O)}const Pt=new Array(8).fill(0),xt=new Array(8).fill(0);function fe(e,t,n,o,r){return e[0]=t[0],e[1]=t[1],e[2]=n[0],e[3]=n[1],e[4]=o[0],e[5]=o[1],e[6]=r[0],e[7]=r[1],e}function ae(e,t,n,o,r,s,a,c,p){return ft(e,fe(Pt,t,n,o,r),fe(xt,s,a,c,p))}function vt(e,t,n,o){const r=K(0,n),s=K(0,0),a=K(t,0),c=K(t,n);return j(r,r,e),j(s,s,e),j(a,a,e),j(c,c,e),new se({rings:[[r,s,a,c,r]],spatialReference:o})}const Le=P;let S=class extends Y{constructor(t){super(t),this.bottomLeft=null,this.bottomRight=null,this.topLeft=null,this.topRight=null,this.type="corners"}get coords(){let{topLeft:t,topRight:n,bottomLeft:o,bottomRight:r}=this;if(t==null||n==null||o==null||r==null)return null;const s=t.spatialReference;return n=this.projectOrWarn(n,s),o=this.projectOrWarn(o,s),r=this.projectOrWarn(r,s),n==null||o==null||r==null?null:new se({rings:[[[o.x,o.y],[t.x,t.y],[n.x,n.y],[r.x,r.y],[o.x,o.y]]],spatialReference:s})}set coords(t){const{topLeft:n}=this;if(n==null)return;const o=n.spatialReference;if((t=this.projectOrWarn(t,o))==null)return;const{rings:[[r,s,a,c]]}=t;this.bottomLeft=new d({x:r[0],y:r[1],spatialReference:o}),this.topLeft=new d({x:s[0],y:s[1],spatialReference:o}),this.topRight=new d({x:a[0],y:a[1],spatialReference:o}),this.bottomRight=new d({x:c[0],y:c[1],spatialReference:o})}};i([l()],S.prototype,"coords",null),i([l({type:d})],S.prototype,"bottomLeft",void 0),i([l({type:d})],S.prototype,"bottomRight",void 0),i([l({type:d})],S.prototype,"topLeft",void 0),i([l({type:d})],S.prototype,"topRight",void 0),S=i([v("esri.layers.support.CornersGeoreference")],S);const Rt=S;let W=class extends Y{constructor(e){super(e),this.extent=null,this.rotation=0,this.type="extent-and-rotation"}get coords(){if(this.extent==null)return null;const{xmin:e,ymin:t,xmax:n,ymax:o,spatialReference:r}=this.extent;let s;if(this.rotation){const{x:a,y:c}=this.extent.center,p=ye(a,c,this.rotation);s=[p(e,t),p(e,o),p(n,o),p(n,t)],s.push(s[0])}else s=[[e,t],[e,o],[n,o],[n,t],[e,t]];return new se({rings:[s],spatialReference:r})}set coords(e){if(e==null||this.extent==null)return;const t=this.extent.spatialReference;if((e=this.projectOrWarn(e,t))==null||e.extent==null)return;const{rings:[[n,o,r]],extent:{center:{x:s,y:a}}}=e,c=Ae(Math.PI/2-Math.atan2(o[1]-n[1],o[0]-n[0])),p=ye(s,a,-c),[h,f]=p(n[0],n[1]),[x,R]=p(r[0],r[1]);this.extent=new ie({xmin:h,ymin:f,xmax:x,ymax:R,spatialReference:t}),this.rotation=c}};function ye(e,t,n){const o=Ne(n),r=Math.cos(o),s=Math.sin(o);return(a,c)=>[r*(a-e)+s*(c-t)+e,r*(c-t)-s*(a-e)+t]}i([l()],W.prototype,"coords",null),i([l({type:ie})],W.prototype,"extent",void 0),i([l({type:Number})],W.prototype,"rotation",void 0),W=i([v("esri.layers.support.ExtentAndRotationGeoreference")],W);const wt=W,$t={key:"type",base:Y,typeMap:{"control-points":Le,corners:Rt,"extent-and-rotation":wt}};let k=class extends Fe(_e(Me)){constructor(e){super(e),this.georeference=null,this.opacity=1}readGeoreference(e){return Le.fromJSON(e)}};i([l({types:$t,json:{write:!0}})],k.prototype,"georeference",void 0),i([X("georeference")],k.prototype,"readGeoreference",null),i([l()],k.prototype,"opacity",void 0),k=i([v("esri.layers.support.MediaElementBase")],k);const le=k;let L=class extends le{constructor(t){super(t),this.content=null,this.image=null,this.type="image",this.image=null}load(){const t=this.image;if(typeof t=="string"){const n=ne(t,{responseType:"image"}).then(({data:o})=>{this._set("content",o)});this.addResolvingPromise(n)}else if(t instanceof HTMLImageElement){const n=t.decode().then(()=>{this._set("content",t)});this.addResolvingPromise(n)}else t?this._set("content",t):this.addResolvingPromise(Promise.reject(new q("image-element:invalid-image-type","Invalid image type",{image:t})));return Promise.resolve(this)}readImage(t,n,o){return Ge(n.url,o)}writeImage(t,n,o,r){if(t==null)return;const s=r==null?void 0:r.portalItem,a=r==null?void 0:r.resources;if(!s||!a)return void(typeof t=="string"&&(n[o]=ue(t,r)));const c=typeof t!="string"||be(t)||Se(t)?null:t;if(c){if(ze(c)==null)return void(n[o]=c);const p=ue(c,{...r,verifyItemRelativeUrls:r&&r.verifyItemRelativeUrls?{writtenUrls:r.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},Be.NO);if(s&&p&&!Ue(p))return a.toKeep.push({resource:s.resourceFromPath(p),compress:!1}),void(n[o]=p)}n[o]="<pending>",a.pendingOperations.push(je(t).then(p=>{const h=It(p,s);n[o]=h.itemRelativeUrl,a.toAdd.push({resource:h,content:p,compress:!1,finish:f=>{this.image=f.url}})}))}};i([l({readOnly:!0})],L.prototype,"content",void 0),i([l({json:{name:"url",type:String}})],L.prototype,"image",void 0),i([X("image",["url"])],L.prototype,"readImage",null),i([re("image")],L.prototype,"writeImage",null),i([l({readOnly:!0,json:{name:"mediaType"}})],L.prototype,"type",void 0),L=i([v("esri.layers.support.ImageElement")],L);const Ee=L;async function je(e){if(typeof e=="string"){if(Se(e)){const{data:t}=await ne(e,{responseType:"blob"});return t}return be(e)?qe(e):je((await ne(e,{responseType:"image"})).data)}return new Promise(t=>_t(e).toBlob(t))}function _t(e){if(e instanceof HTMLCanvasElement)return e;const t=e instanceof HTMLImageElement?e.naturalWidth:e.width,n=e instanceof HTMLImageElement?e.naturalHeight:e.height,o=document.createElement("canvas"),r=o.getContext("2d");return o.width=t,o.height=n,e instanceof HTMLImageElement?r.drawImage(e,0,0,e.width,e.height):e instanceof ImageData&&r.putImageData(e,0,0),o}function It(e,t){const n=Ke(),o=`${De("media",n)}.${dt(e)}`;return t.resourceFromPath(o)}let U=class extends le{constructor(e){super(e),this.content=null,this.type="video"}load(){const e=this.video;if(typeof e=="string"){const t=document.createElement("video");t.src=e,t.crossOrigin="anonymous",t.autoplay=!0,t.muted=!0,t.loop=!0,this.addResolvingPromise(this._loadVideo(t).then(()=>{this._set("content",t)}))}else e instanceof HTMLVideoElement?this.addResolvingPromise(this._loadVideo(e).then(()=>{this._set("content",e)})):this.addResolvingPromise(Promise.reject(new q("video-element:invalid-video-type","Invalid video type",{video:e})));return Promise.resolve(this)}set video(e){this.loadStatus==="not-loaded"?this._set("video",e):G.getLogger(this.declaredClass).error("#video","video cannot be changed after the element is loaded.")}_loadVideo(e){return new Promise((t,n)=>{e.oncanplay=()=>{e.oncanplay=null,e.play().then(t,n)},e.crossOrigin!=="anonymous"&&(e.crossOrigin="anonymous",e.src=e.src)})}};i([l({readOnly:!0})],U.prototype,"content",void 0),i([l()],U.prototype,"video",null),U=i([v("esri.layers.support.VideoElement")],U);const Ce=U,Mt={key:"type",defaultKeyValue:"image",base:le,typeMap:{image:Ee,video:Ce}},ge=Q.ofType(Mt);let A=class extends Me.LoadableMixin(Je(Qe(Xe.EventedAccessor))){constructor(t){super(t),this._index=new ht,this._elementViewsMap=new Map,this._elementsIndexes=new Map,this._elementsChangedHandler=n=>{for(const r of n.removed){const s=this._elementViewsMap.get(r);this._elementViewsMap.delete(r),this._index.delete(s),this.handles.remove(s),s.destroy(),this.notifyChange("fullExtent")}const{spatialReference:o}=this;for(const r of n.added){if(this._elementViewsMap.get(r))continue;const s=new mt({spatialReference:o,element:r});this._elementViewsMap.set(r,s);const a=Ye(()=>s.coords,()=>this._updateIndexForElement(s,!1));this._updateIndexForElement(s,!0),this.handles.add(a,s)}this._elementsIndexes.clear(),this.elements.forEach((r,s)=>this._elementsIndexes.set(r,s)),this.emit("refresh")},this.elements=new ge}async load(t){if(Ze(t),!this.spatialReference){const n=this.elements.find(o=>o.georeference!=null&&o.georeference.coords!=null);this._set("spatialReference",n?n.georeference.coords.spatialReference:Ie.WGS84)}return this._elementsChangedHandler({added:this.elements.items,removed:[]}),this.handles.add(this.elements.on("change",this._elementsChangedHandler)),this}destroy(){this._index.clear(),this._elementViewsMap.clear(),this._elementsIndexes.clear()}set elements(t){this._set("elements",et(t,this._get("elements"),ge))}get fullExtent(){if(this.loadStatus==="not-loaded")return null;const t=this._index.fullBounds;return t==null?null:new ie({xmin:t[0],ymin:t[1],xmax:t[2],ymax:t[3],spatialReference:this.spatialReference})}set spatialReference(t){this.loadStatus==="not-loaded"?this._set("spatialReference",t):G.getLogger(this.declaredClass).error("#spatialReference","spatialReference cannot be changed after the source is loaded.")}async queryElements(t,n){await this.load(),await tt(t.spatialReference,this.spatialReference,null,n);const o=nt(t.spatialReference,this.spatialReference)?t:ot(t,this.spatialReference);if(!o)return[];const r=o.normalize(),s=[];for(const a of r)this._index.forEachInBounds(rt(a),({normalizedCoords:c,element:p})=>{c!=null&&st(a,c)&&s.push(p)});return s.sort((a,c)=>this._elementsIndexes.get(a)-this._elementsIndexes.get(c)),s}_updateIndexForElement(t,n){const o=t.normalizedBounds,r=this._index.has(t),s=o!=null;this._index.delete(t),s&&this._index.set(t,o),this.notifyChange("fullExtent"),n||(r!==s?this.emit("refresh"):this.emit("change",{element:t.element}))}};i([l()],A.prototype,"elements",null),i([l({readOnly:!0})],A.prototype,"fullExtent",null),i([l()],A.prototype,"spatialReference",null),A=i([v("esri.layers.support.LocalMediaElementSource")],A);const J=A;function Pe(e){return typeof e=="object"&&e!=null&&"type"in e}let y=class extends ct(ut(pt(lt(at)))){constructor(e){super(e),this.effectiveSource=null,this.copyright=null,this.operationalLayerType="MediaLayer",this.spatialReference=null,this.type="media",this.source=new J}load(e){const t=this.source;if(!t)return this.addResolvingPromise(Promise.reject(new q("media-layer:source-missing","Set 'MediaLayer.source' before loading the layer."))),Promise.resolve(this);const n=Pe(t)?new J({elements:new Q([t])}):t;this._set("effectiveSource",n),this.spatialReference&&(n.spatialReference=this.spatialReference);const o=n.load(e).then(()=>{this.spatialReference=n.spatialReference});return this.addResolvingPromise(o),Promise.resolve(this)}destroy(){var e,t;(e=this.effectiveSource)==null||e.destroy(),(t=this.source)==null||t.destroy()}get fullExtent(){return this.loaded?this.effectiveSource.fullExtent:null}set source(e){this.loadStatus==="not-loaded"?this._set("source",e):G.getLogger(this.declaredClass).error("#source","source cannot be changed after the layer is loaded.")}castSource(e){return e?Array.isArray(e)?new J({elements:new Q(e)}):e instanceof Q?new J({elements:e}):e:null}readSource(e,t,n){const o=t.mediaType==="image"?new Ee:t.mediaType==="video"?new Ce:null;return o==null||o.read(t,n),o}writeSource(e,t,n,o){var r;e&&Pe(e)&&e.type==="image"?e.write(t,o):o!=null&&o.messages&&((r=o==null?void 0:o.messages)==null||r.push(new q("media-layer:unsupported-source","source must be an 'ImageElement'")))}};i([l({readOnly:!0})],y.prototype,"effectiveSource",void 0),i([l({type:String})],y.prototype,"copyright",void 0),i([l({readOnly:!0})],y.prototype,"fullExtent",null),i([l({type:["MediaLayer"]})],y.prototype,"operationalLayerType",void 0),i([l({type:["show","hide"]})],y.prototype,"listMode",void 0),i([l({nonNullable:!0,json:{write:{enabled:!0,allowNull:!1}}})],y.prototype,"source",null),i([it("source")],y.prototype,"castSource",null),i([X("source",["url"])],y.prototype,"readSource",null),i([re("source")],y.prototype,"writeSource",null),i([l()],y.prototype,"spatialReference",void 0),i([l({readOnly:!0})],y.prototype,"type",void 0),y=i([v("esri.layers.MediaLayer")],y);const qt=y;export{qt as default};
