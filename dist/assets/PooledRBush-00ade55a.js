import{dW as w,eR as S,g9 as A,gm as H,ga as k}from"./index-14eace40.js";class O{constructor(t=9,i){this._compareMinX=E,this._compareMinY=P,this._toBBox=n=>n,this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),i&&(typeof i=="function"?this._toBBox=i:this._initFormat(i)),this.clear()}destroy(){this.clear(),x.prune(),M.prune(),f.prune(),X.prune()}all(t){this._all(this._data,t)}search(t,i){let n=this._data;const e=this._toBBox;if(g(t,n))for(x.clear();n;){for(let h=0,r=n.children.length;h<r;h++){const l=n.children[h],a=n.leaf?e(l):l;g(t,a)&&(n.leaf?i(l):I(t,a)?this._all(l,i):x.push(l))}n=x.pop()}}collides(t){let i=this._data;const n=this._toBBox;if(!g(t,i))return!1;for(x.clear();i;){for(let e=0,h=i.children.length;e<h;e++){const r=i.children[e],l=i.leaf?n(r):r;if(g(t,l)){if(i.leaf||I(t,l))return!0;x.push(r)}}i=x.pop()}return!1}load(t){if(!t.length)return this;if(t.length<this._minEntries){for(let n=0,e=t.length;n<e;n++)this.insert(t[n]);return this}let i=this._build(t.slice(0,t.length),0,t.length-1,0);if(!this._data.children.length)this._data=i;else if(this._data.height===i.height)this._splitRoot(this._data,i);else{if(this._data.height<i.height){const n=this._data;this._data=i,i=n}this._insert(i,this._data.height-i.height-1,!0)}return this}insert(t){return t&&this._insert(t,this._data.height-1),this}clear(){return this._data=new Y([]),this}remove(t){if(!t)return this;let i=this._data,n=null,e=0,h=!1,r;const l=this._toBBox(t);for(f.clear(),X.clear();i||f.length>0;){if(i||(i=S(f.pop()),n=f.data[f.length-1],e=X.pop()??0,h=!0),i.leaf&&(r=A(i.children,t,i.children.length,i.indexHint),r!==-1))return i.children.splice(r,1),f.push(i),this._condense(f),this;!h&&!i.leaf&&I(i,l)?(f.push(i),X.push(e),e=0,n=i,i=i.children[0]):n?(e++,i=n.children[e],h=!1):i=null}return this}toJSON(){return this._data}fromJSON(t){return this._data=t,this}_all(t,i){let n=t;for(M.clear();n;){if(n.leaf===!0)for(const e of n.children)i(e);else M.pushArray(n.children);n=M.pop()??null}}_build(t,i,n,e){const h=n-i+1;let r=this._maxEntries;if(h<=r){const o=new Y(t.slice(i,n+1));return d(o,this._toBBox),o}e||(e=Math.ceil(Math.log(h)/Math.log(r)),r=Math.ceil(h/r**(e-1)));const l=new N([]);l.height=e;const a=Math.ceil(h/r),c=a*Math.ceil(Math.sqrt(r));R(t,i,n,c,this._compareMinX);for(let o=i;o<=n;o+=c){const m=Math.min(o+c-1,n);R(t,o,m,a,this._compareMinY);for(let u=o;u<=m;u+=a){const F=Math.min(u+a-1,m);l.children.push(this._build(t,u,F,e-1))}}return d(l,this._toBBox),l}_chooseSubtree(t,i,n,e){for(;e.push(i),!(i.leaf===!0||e.length-1===n);){let h=1/0,r=1/0,l;for(let a=0,c=i.children.length;a<c;a++){const o=i.children[a],m=y(o),u=D(t,o)-m;u<r?(r=u,h=m<h?m:h,l=o):u===r&&m<h&&(h=m,l=o)}i=l||i.children[0]}return i}_insert(t,i,n){const e=this._toBBox,h=n?t:e(t);f.clear();const r=this._chooseSubtree(h,this._data,i,f);for(r.children.push(t),p(r,h);i>=0&&f.data[i].children.length>this._maxEntries;)this._split(f,i),i--;this._adjustParentBBoxes(h,f,i)}_split(t,i){const n=t.data[i],e=n.children.length,h=this._minEntries;this._chooseSplitAxis(n,h,e);const r=this._chooseSplitIndex(n,h,e);if(!r){console.log("  Error: assertion failed at PooledRBush._split: no valid split index");return}const l=n.children.splice(r,n.children.length-r),a=n.leaf?new Y(l):new N(l);a.height=n.height,d(n,this._toBBox),d(a,this._toBBox),i?t.data[i-1].children.push(a):this._splitRoot(n,a)}_splitRoot(t,i){this._data=new N([t,i]),this._data.height=t.height+1,d(this._data,this._toBBox)}_chooseSplitIndex(t,i,n){let e,h,r;e=h=1/0;for(let l=i;l<=n-i;l++){const a=_(t,0,l,this._toBBox),c=_(t,l,n,this._toBBox),o=q(a,c),m=y(a)+y(c);o<e?(e=o,r=l,h=m<h?m:h):o===e&&m<h&&(h=m,r=l)}return r}_chooseSplitAxis(t,i,n){const e=t.leaf?this._compareMinX:E,h=t.leaf?this._compareMinY:P,r=this._allDistMargin(t,i,n,e),l=this._allDistMargin(t,i,n,h);r<l&&t.children.sort(e)}_allDistMargin(t,i,n,e){t.children.sort(e);const h=this._toBBox,r=_(t,0,i,h),l=_(t,n-i,n,h);let a=B(r)+B(l);for(let c=i;c<n-i;c++){const o=t.children[c];p(r,t.leaf?h(o):o),a+=B(r)}for(let c=n-i-1;c>=i;c--){const o=t.children[c];p(l,t.leaf?h(o):o),a+=B(l)}return a}_adjustParentBBoxes(t,i,n){for(let e=n;e>=0;e--)p(i.data[e],t)}_condense(t){for(let i=t.length-1;i>=0;i--){const n=t.data[i];if(n.children.length===0)if(i>0){const e=t.data[i-1],h=e.children;h.splice(A(h,n,h.length,e.indexHint),1)}else this.clear();else d(n,this._toBBox)}}_initFormat(t){const i=["return a"," - b",";"];this._compareMinX=new Function("a","b",i.join(t[0])),this._compareMinY=new Function("a","b",i.join(t[1])),this._toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}}function d(s,t){_(s,0,s.children.length,t,s)}function _(s,t,i,n,e){e||(e=new Y([])),e.minX=1/0,e.minY=1/0,e.maxX=-1/0,e.maxY=-1/0;for(let h=t,r;h<i;h++)r=s.children[h],p(e,s.leaf?n(r):r);return e}function p(s,t){s.minX=Math.min(s.minX,t.minX),s.minY=Math.min(s.minY,t.minY),s.maxX=Math.max(s.maxX,t.maxX),s.maxY=Math.max(s.maxY,t.maxY)}function E(s,t){return s.minX-t.minX}function P(s,t){return s.minY-t.minY}function y(s){return(s.maxX-s.minX)*(s.maxY-s.minY)}function B(s){return s.maxX-s.minX+(s.maxY-s.minY)}function D(s,t){return(Math.max(t.maxX,s.maxX)-Math.min(t.minX,s.minX))*(Math.max(t.maxY,s.maxY)-Math.min(t.minY,s.minY))}function q(s,t){const i=Math.max(s.minX,t.minX),n=Math.max(s.minY,t.minY),e=Math.min(s.maxX,t.maxX),h=Math.min(s.maxY,t.maxY);return Math.max(0,e-i)*Math.max(0,h-n)}function I(s,t){return s.minX<=t.minX&&s.minY<=t.minY&&t.maxX<=s.maxX&&t.maxY<=s.maxY}function g(s,t){return t.minX<=s.maxX&&t.minY<=s.maxY&&t.maxX>=s.minX&&t.maxY>=s.minY}function R(s,t,i,n,e){const h=[t,i];for(;h.length;){const r=S(h.pop()),l=S(h.pop());if(r-l<=n)continue;const a=l+Math.ceil((r-l)/n/2)*n;H(s,a,l,r,e),h.push(l,a,a,r)}}const x=new w,M=new w,f=new w,X=new w({deallocator:void 0});class J{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}}class j extends J{constructor(){super(...arguments),this.height=1,this.indexHint=new k}}class Y extends j{constructor(t){super(),this.children=t,this.leaf=!0}}class N extends j{constructor(t){super(),this.children=t,this.leaf=!1}}export{O as P};
