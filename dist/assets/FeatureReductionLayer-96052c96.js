import{e as l,y as a,a as g,aH as me,bB as M,eK as b,fD as Y,gw as Z,fy as J,hd as ee,bE as A,bD as T,h6 as te,gn as z,hD as he,gp as K,d as be,v as ie,K as ve}from"./index-ebffac9a.js";import{w as ge}from"./FeatureEffect-9ac45330.js";import{A as se,b as re,j as we,a as R}from"./UniqueValueRenderer-1e273e84.js";import{b as ne,o as L,p as N}from"./jsonUtils-2e3cf42f.js";import{m as oe,p as le}from"./commonProperties-50fc1190.js";import{C as ae}from"./labelingInfo-b3e440ff.js";const P={write:{allowNull:!0}},Ue=e=>{let n=class extends e{constructor(){super(...arguments),this.featureEffect=null}};return l([a({type:ge,json:{origins:{"web-map":P,"portal-item":P}}})],n.prototype,"featureEffect",void 0),n=l([g("esri.layers.mixins.FeatureEffectLayer")],n),n};let I=class extends me(M){constructor(n){super(n),this.expression=null,this.title=null,this.returnType=null}};l([a({type:String,json:{write:!0}})],I.prototype,"expression",void 0),l([a({type:String,json:{write:!0}})],I.prototype,"title",void 0),l([a({type:String,json:{write:!0}})],I.prototype,"returnType",void 0),I=l([g("esri.layers.support.ExpressionInfo")],I);const H=I;var B;let v=B=class extends M{constructor(e){super(e),this.isAutoGenerated=!1,this.name=null,this.alias=null,this.onStatisticField=null,this.onStatisticExpression=null,this.statisticType=null}clone(){return new B({name:this.name,alias:this.alias,isAutoGenerated:this.isAutoGenerated,onStatisticExpression:b(this.onStatisticExpression),onStatisticField:this.onStatisticField,statisticType:this.statisticType})}};l([a({type:Boolean,json:{write:!0}})],v.prototype,"isAutoGenerated",void 0),l([a({type:String,json:{write:!0}})],v.prototype,"name",void 0),l([a({type:String,json:{write:!0}})],v.prototype,"alias",void 0),l([a({type:String,json:{write:!0}})],v.prototype,"onStatisticField",void 0),l([a({type:H,json:{write:!0}})],v.prototype,"onStatisticExpression",void 0),l([a({type:String,json:{write:!0}})],v.prototype,"statisticType",void 0),v=B=l([g("esri.layers.support.AggregateField")],v);const $=v;let x=class extends M{constructor(){super(...arguments),this.type=null}};l([a({type:["selection","cluster","binning"],readOnly:!0,json:{read:!1,write:!0}})],x.prototype,"type",void 0),x=l([g("esri.layers.support.FeatureReduction")],x);var D;const k=Y({types:Z}),xe="esri.layers.support.FeatureReductionBinning";let m=D=class extends x{constructor(e){super(e),this.type="binning",this.binType="geohash",this.fixedBinLevel=3,this.labelingInfo=null,this.labelsVisible=!0,this.maxScale=0,this.popupEnabled=!0,this.popupTemplate=null,this.fields=[],this.renderer=null}writeFields(e,n,t){const i=e.filter(r=>r.statisticType!=="avg_angle").map(r=>r.toJSON());te(t,i,n)}readRenderer(e,n,t){var r;const i=(r=n.drawingInfo)==null?void 0:r.renderer;return i?L(i,n,t)??void 0:n.defaultSymbol?n.types&&n.types.length?new se({defaultSymbol:k(n.defaultSymbol,n,t),field:n.typeIdField,uniqueValueInfos:n.types.map(s=>({id:s.id,symbol:k(s.symbol,s,t)}))}):new N({symbol:k(n.defaultSymbol,n,t)}):null}clone(){return new D({fields:b(this.fields),fixedBinLevel:this.fixedBinLevel,labelingInfo:b(this.labelingInfo),labelsVisible:this.labelsVisible,maxScale:this.maxScale,popupEnabled:this.popupEnabled,popupTemplate:b(this.popupTemplate),renderer:b(this.renderer)})}};l([J({binning:"binning"})],m.prototype,"type",void 0),l([J({geohash:"geohash"})],m.prototype,"binType",void 0),l([a({type:Number,range:{min:1,max:9},json:{write:!0}})],m.prototype,"fixedBinLevel",void 0),l([a({type:[ae],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],m.prototype,"labelingInfo",void 0),l([a(oe)],m.prototype,"labelsVisible",void 0),l([a({type:Number,json:{default:0,name:"visibilityInfo.maxScale"}})],m.prototype,"maxScale",void 0),l([a(le)],m.prototype,"popupEnabled",void 0),l([a({type:ee,json:{name:"popupInfo",write:!0}})],m.prototype,"popupTemplate",void 0),l([a({type:[$],json:{write:!0}})],m.prototype,"fields",void 0),l([A("fields")],m.prototype,"writeFields",null),l([a({types:ne,json:{write:{target:"drawingInfo.renderer"}}})],m.prototype,"renderer",void 0),l([T("renderer",["drawingInfo.renderer"])],m.prototype,"readRenderer",null),m=D=l([g(xe)],m);const ue=m;var O;const C=Y({types:Z}),Se="esri.layers.support.FeatureReductionCluster";function Q(e){var n;return e.type==="simple"&&!((n=e.visualVariables)!=null&&n.length)}let p=O=class extends M{constructor(e){super(e),this.type="cluster",this.clusterRadius=z("80px"),this.clusterMinSize=z("12px"),this.clusterMaxSize=z("50px"),this.maxScale=0,this.popupEnabled=!0,this.popupTemplate=null,this.renderer=null,this.symbol=null,this.labelingInfo=null,this.labelsVisible=!0,this.fields=null}readRenderer(e,n,t){var r,s;const i=(r=n.drawingInfo)==null?void 0:r.renderer;return(s=i==null?void 0:i.authoringInfo)!=null&&s.isAutoGenerated?null:i?Q(i)?null:L(i,n,t)??void 0:n.defaultSymbol?n.types&&n.types.length?new se({defaultSymbol:C(n.defaultSymbol,n,t),field:n.typeIdField,uniqueValueInfos:n.types.map(o=>({id:o.id,symbol:C(o.symbol,o,t)}))}):new N({symbol:C(n.defaultSymbol,n,t)}):null}readSymbol(e,n,t){var r,s;const i=(r=n.drawingInfo)==null?void 0:r.renderer;if((s=i==null?void 0:i.authoringInfo)!=null&&s.isAutoGenerated)return null;if(i&&Q(i)){const o=L(i,n,t);return o==null?void 0:o.symbol}return null}writeSymbol(e,n,t,i){var s,o;const r=(o=(s=this.renderer)==null?void 0:s.authoringInfo)==null?void 0:o.isAutoGenerated;if(!this.renderer||r){const h=new N({symbol:e});n.drawingInfo={renderer:h.write({},i)}}}writeFields(e,n,t){const i=e.filter(r=>r.statisticType!=="avg_angle").map(r=>r.toJSON());te(t,i,n)}readFields(e,n,t){return e.filter(i=>!i.isAutoGenerated).map(i=>$.fromJSON(i))}clone(){return new O({clusterRadius:this.clusterRadius,clusterMinSize:this.clusterMinSize,clusterMaxSize:this.clusterMaxSize,labelingInfo:b(this.labelingInfo),labelsVisible:this.labelsVisible,fields:b(this.fields),maxScale:this.maxScale,renderer:b(this.renderer),symbol:b(this.symbol),popupEnabled:this.popupEnabled,popupTemplate:b(this.popupTemplate)})}};l([a({type:["cluster"],readOnly:!0,json:{write:!0}})],p.prototype,"type",void 0),l([a({type:Number,cast:e=>e==="auto"?e:z(e),json:{write:!0}})],p.prototype,"clusterRadius",void 0),l([a({type:Number,cast:z,json:{write:!0}})],p.prototype,"clusterMinSize",void 0),l([a({type:Number,cast:z,json:{write:!0}})],p.prototype,"clusterMaxSize",void 0),l([a({type:Number,json:{default:0,name:"visibilityInfo.maxScale"}})],p.prototype,"maxScale",void 0),l([a(le)],p.prototype,"popupEnabled",void 0),l([a({type:ee,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],p.prototype,"popupTemplate",void 0),l([a({types:ne,json:{write:{target:"drawingInfo.renderer"}}})],p.prototype,"renderer",void 0),l([T("renderer",["drawingInfo.renderer"])],p.prototype,"readRenderer",null),l([a({types:he})],p.prototype,"symbol",void 0),l([T("symbol",["drawingInfo.renderer"])],p.prototype,"readSymbol",null),l([A("symbol")],p.prototype,"writeSymbol",null),l([a({type:[ae],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],p.prototype,"labelingInfo",void 0),l([a(oe)],p.prototype,"labelsVisible",void 0),l([a({type:[$],json:{write:!0}})],p.prototype,"fields",void 0),l([A("fields")],p.prototype,"writeFields",null),l([T("fields")],p.prototype,"readFields",null),p=O=l([g(Se)],p);const pe=p;var q;let V=q=class extends x{constructor(e){super(e),this.type="selection"}clone(){return new q}};l([a({type:["selection"]})],V.prototype,"type",void 0),V=q=l([g("esri.layers.support.FeatureReductionSelection")],V);const W=V,X={key:"type",base:x,typeMap:{cluster:pe,binning:ue}},$e={types:{key:"type",base:x,typeMap:{selection:W,cluster:pe,binning:ue}},json:{name:"layerDefinition.featureReduction",write:{allowNull:!0},origins:{"web-map":{types:X},"portal-item":{types:X},"web-scene":{types:{key:"type",base:x,typeMap:{selection:W}}}}}},E={Base64:0,Hex:1,String:2,Raw:3},F=8,de=(1<<F)-1;function w(e,n){const t=(65535&e)+(65535&n);return(e>>16)+(n>>16)+(t>>16)<<16|65535&t}function Ee(e){const n=[];for(let t=0,i=e.length*F;t<i;t+=F)n[t>>5]|=(e.charCodeAt(t/F)&de)<<t%32;return n}function Ie(e){const n=[];for(let t=0,i=32*e.length;t<i;t+=F)n.push(String.fromCharCode(e[t>>5]>>>t%32&de));return n.join("")}function ze(e){const n="0123456789abcdef",t=[];for(let i=0,r=4*e.length;i<r;i++)t.push(n.charAt(e[i>>2]>>i%4*8+4&15)+n.charAt(e[i>>2]>>i%4*8&15));return t.join("")}function Fe(e){const n="=",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=[];for(let r=0,s=4*e.length;r<s;r+=3){const o=(e[r>>2]>>r%4*8&255)<<16|(e[r+1>>2]>>(r+1)%4*8&255)<<8|e[r+2>>2]>>(r+2)%4*8&255;for(let h=0;h<4;h++)8*r+6*h>32*e.length?i.push(n):i.push(t.charAt(o>>6*(3-h)&63))}return i.join("")}function Re(e,n){return e<<n|e>>>32-n}function G(e,n,t,i,r,s){return w(Re(w(w(n,e),w(i,s)),r),t)}function d(e,n,t,i,r,s,o){return G(n&t|~n&i,e,n,r,s,o)}function c(e,n,t,i,r,s,o){return G(n&i|t&~i,e,n,r,s,o)}function f(e,n,t,i,r,s,o){return G(n^t^i,e,n,r,s,o)}function y(e,n,t,i,r,s,o){return G(t^(n|~i),e,n,r,s,o)}function je(e,n){e[n>>5]|=128<<n%32,e[14+(n+64>>>9<<4)]=n;let t=1732584193,i=-271733879,r=-1732584194,s=271733878;for(let o=0;o<e.length;o+=16){const h=t,u=i,fe=r,ye=s;t=d(t,i,r,s,e[o],7,-680876936),s=d(s,t,i,r,e[o+1],12,-389564586),r=d(r,s,t,i,e[o+2],17,606105819),i=d(i,r,s,t,e[o+3],22,-1044525330),t=d(t,i,r,s,e[o+4],7,-176418897),s=d(s,t,i,r,e[o+5],12,1200080426),r=d(r,s,t,i,e[o+6],17,-1473231341),i=d(i,r,s,t,e[o+7],22,-45705983),t=d(t,i,r,s,e[o+8],7,1770035416),s=d(s,t,i,r,e[o+9],12,-1958414417),r=d(r,s,t,i,e[o+10],17,-42063),i=d(i,r,s,t,e[o+11],22,-1990404162),t=d(t,i,r,s,e[o+12],7,1804603682),s=d(s,t,i,r,e[o+13],12,-40341101),r=d(r,s,t,i,e[o+14],17,-1502002290),i=d(i,r,s,t,e[o+15],22,1236535329),t=c(t,i,r,s,e[o+1],5,-165796510),s=c(s,t,i,r,e[o+6],9,-1069501632),r=c(r,s,t,i,e[o+11],14,643717713),i=c(i,r,s,t,e[o],20,-373897302),t=c(t,i,r,s,e[o+5],5,-701558691),s=c(s,t,i,r,e[o+10],9,38016083),r=c(r,s,t,i,e[o+15],14,-660478335),i=c(i,r,s,t,e[o+4],20,-405537848),t=c(t,i,r,s,e[o+9],5,568446438),s=c(s,t,i,r,e[o+14],9,-1019803690),r=c(r,s,t,i,e[o+3],14,-187363961),i=c(i,r,s,t,e[o+8],20,1163531501),t=c(t,i,r,s,e[o+13],5,-1444681467),s=c(s,t,i,r,e[o+2],9,-51403784),r=c(r,s,t,i,e[o+7],14,1735328473),i=c(i,r,s,t,e[o+12],20,-1926607734),t=f(t,i,r,s,e[o+5],4,-378558),s=f(s,t,i,r,e[o+8],11,-2022574463),r=f(r,s,t,i,e[o+11],16,1839030562),i=f(i,r,s,t,e[o+14],23,-35309556),t=f(t,i,r,s,e[o+1],4,-1530992060),s=f(s,t,i,r,e[o+4],11,1272893353),r=f(r,s,t,i,e[o+7],16,-155497632),i=f(i,r,s,t,e[o+10],23,-1094730640),t=f(t,i,r,s,e[o+13],4,681279174),s=f(s,t,i,r,e[o],11,-358537222),r=f(r,s,t,i,e[o+3],16,-722521979),i=f(i,r,s,t,e[o+6],23,76029189),t=f(t,i,r,s,e[o+9],4,-640364487),s=f(s,t,i,r,e[o+12],11,-421815835),r=f(r,s,t,i,e[o+15],16,530742520),i=f(i,r,s,t,e[o+2],23,-995338651),t=y(t,i,r,s,e[o],6,-198630844),s=y(s,t,i,r,e[o+7],10,1126891415),r=y(r,s,t,i,e[o+14],15,-1416354905),i=y(i,r,s,t,e[o+5],21,-57434055),t=y(t,i,r,s,e[o+12],6,1700485571),s=y(s,t,i,r,e[o+3],10,-1894986606),r=y(r,s,t,i,e[o+10],15,-1051523),i=y(i,r,s,t,e[o+1],21,-2054922799),t=y(t,i,r,s,e[o+8],6,1873313359),s=y(s,t,i,r,e[o+15],10,-30611744),r=y(r,s,t,i,e[o+6],15,-1560198380),i=y(i,r,s,t,e[o+13],21,1309151649),t=y(t,i,r,s,e[o+4],6,-145523070),s=y(s,t,i,r,e[o+11],10,-1120210379),r=y(r,s,t,i,e[o+2],15,718787259),i=y(i,r,s,t,e[o+9],21,-343485551),t=w(t,h),i=w(i,u),r=w(r,fe),s=w(s,ye)}return[t,i,r,s]}function ce(e,n=E.Hex){const t=n||E.Base64,i=je(Ee(e),e.length*F);switch(t){case E.Raw:return i;case E.Hex:return ze(i);case E.String:return Ie(i);case E.Base64:return Fe(i)}}var U;let _=U=class extends re{writeLevels(e,n,t){for(const i in e){const r=this.levels[i];return void(n.stops=r)}}clone(){return new U({axis:this.axis,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,maxDataValue:this.maxDataValue,maxSize:K(this.maxSize)?this.maxSize.clone():this.maxSize,minDataValue:this.minDataValue,minSize:K(this.minSize)?this.minSize.clone():this.minSize,normalizationField:this.normalizationField,stops:this.stops&&this.stops.map(e=>e.clone()),target:this.target,useSymbolValue:this.useSymbolValue,valueRepresentation:this.valueRepresentation,valueUnit:this.valueUnit,legendOptions:this.legendOptions&&this.legendOptions.clone(),levels:b(this.levels)})}};l([a()],_.prototype,"levels",void 0),l([A("levels")],_.prototype,"writeLevels",null),_=U=l([g("esri.views.2d.engine.LevelDependentSizeVariable")],_);const _e=be.getLogger("esri.views.2d.layers.support.clusterUtils");ie.add("esri-cluster-arcade-enabled",!0);const Te=ie("esri-cluster-arcade-enabled"),Ve=(e,n,t,i,r)=>{const s=n.clone();if(!ke(s))return s;if(s.authoringInfo||(s.authoringInfo=new we),s.authoringInfo.isAutoGenerated=!0,"visualVariables"in s){const o=(s.visualVariables||[]).filter(u=>u.valueExpression!=="$view.scale"),h=Ae(o);o.forEach(u=>{u.type==="rotation"?u.field?u.field=S(e,u.field,"avg_angle","number"):u.valueExpression&&(u.field=j(e,u.valueExpression,"avg_angle","number"),u.valueExpression=null):u.normalizationField?(u.field=S(e,u.field,"avg_norm","number",u.normalizationField),u.normalizationField=null):u.field?u.field=S(e,u.field,"avg","number"):u.valueExpression&&(u.field=j(e,u.valueExpression,"avg","number"),u.valueExpression=null)}),h==null&&!Me(o)&&r&&(o.push(Ge(t,i)),s.dynamicClusterSize=!0),s.visualVariables=o}switch(s.type){case"simple":break;case"pie-chart":for(const o of s.attributes)o.field?o.field=S(e,o.field,"sum","number"):o.valueExpression&&(o.field=j(e,o.valueExpression,"sum","number"),o.valueExpression=null);break;case"unique-value":s.field?s.field=S(e,s.field,"mode","string"):s.valueExpression&&(s.field=j(e,s.valueExpression,"mode","string"),s.valueExpression=null);break;case"class-breaks":s.normalizationField?(s.field=S(e,s.field,"avg_norm","number",s.normalizationField),s.normalizationField=null):s.field?s.field=S(e,s.field,"avg","number"):s.valueExpression&&(s.field=j(e,s.valueExpression,"avg","number"),s.valueExpression=null)}return s},Ae=e=>{for(const n of e)if(n.type==="size")return n;return null},Me=e=>{for(const n of e)if(n.field==="cluster_count")return!0;return!1},Ge=(e,n)=>{const t=[new R({value:0,size:0}),new R({value:1})];if(n==null)return new re({field:"cluster_count",stops:[...t,new R({value:2,size:0})]});const i=Object.keys(n).reduce((r,s)=>({...r,[s]:[...t,new R({value:Math.max(2,n[s].minValue),size:e.clusterMinSize}),new R({value:Math.max(3,n[s].maxValue),size:e.clusterMaxSize})]}),{});return new _({field:"cluster_count",levels:i})},ke=e=>{const n=t=>_e.error(new ve("Unsupported-renderer",t,{renderer:e}));if(!e)return!1;switch(e.type){case"unique-value":if(e.field2||e.field3)return n("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1;break;case"class-breaks":if(e.normalizationField){const t=e.normalizationType;if(t!=="field")return n(`FeatureReductionCluster does not support a normalizationType of ${t}`),!1}break;case"simple":case"pie-chart":break;default:return n(`FeatureReductionCluster does not support renderers of type ${e.type}`),!1}if(!Te){if("valueExpression"in e&&e.valueExpression)return n("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in e&&e.visualVariables||[]).some(t=>!(!("valueExpression"in t)||!t.valueExpression)))return n("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),!1}return!0};function Ce(e,n,t){switch(e){case"sum":return`cluster_sum_${n}`;case"avg":case"avg_angle":return`cluster_avg_${n}`;case"mode":return`cluster_type_${n}`;case"avg_norm":{const i=t,r="field",s=n.toLowerCase()+",norm:"+r+","+i.toLowerCase();return"cluster_avg_"+ce(s)}}}function j(e,n,t,i){const r=ce(n),s=t==="mode"?`cluster_type_${r}`:t==="sum"?`cluster_sum_${r}`:`cluster_avg_${r}`;return e.some(o=>o.name===s)||e.push(new $({name:s,isAutoGenerated:!0,onStatisticExpression:new H({expression:n,returnType:i}),statisticType:t})),s}function S(e,n,t,i,r){if(n==="cluster_count"||e.some(o=>o.name===n))return n;const s=Ce(t,n,r);return e.some(o=>o.name===s)||(t==="avg_norm"?e.push(new $({name:s,isAutoGenerated:!0,onStatisticExpression:new H({expression:`$feature.${n} / $feature.${r}`,returnType:i}),statisticType:"avg"})):e.push(new $({name:s,isAutoGenerated:!0,onStatisticField:n,statisticType:t}))),s}const Ke=e=>{let n=class extends e{constructor(...t){super(...t),this.own(this.watch("renderer",()=>{if(this.featureReduction){const i=this._normalizeFeatureReduction(this.featureReduction);this._set("featureReduction",i)}},!0))}set featureReduction(t){const i=this._normalizeFeatureReduction(t);this._set("featureReduction",i)}set renderer(t){}_normalizeFeatureReduction(t){var h;if((t==null?void 0:t.type)!=="cluster")return t;const i=t.clone(),r=[new $({name:"cluster_count",isAutoGenerated:!0,statisticType:"count"})],s=(i.fields??[]).filter(u=>!u.isAutoGenerated);if(t.renderer&&!((h=t.renderer.authoringInfo)!=null&&h.isAutoGenerated))return i.fields=[...r,...s],i;if(t.symbol)return i.fields=[...r,...s],i.renderer=null,i;if(!this.renderer)return t;const o=Ve(r,this.renderer,t,null,!1);return i.fields=[...r,...s],i.renderer=o,i}};return l([a($e)],n.prototype,"featureReduction",null),n=l([g("esri.layers.mixins.FeatureReductionLayer")],n),n};export{W as a,E as b,Ke as n,Ue as p,x as t,ce as x};
