import{j as E,U as g,G as O}from"./request-c2b0ab45.js";import{r as i}from"./typedArrayUtil-2bcf3cee.js";import{c as R}from"./jsonUtils-8bd548d9.js";import{v as F}from"./normalizeUtils-d322ac85.js";import{t as j}from"./pbfQueryUtils-21bc0894.js";import{r as b}from"./queryZScale-bb883c00.js";function d(r){const t={};for(const o in r){if(o==="declaredClass")continue;const e=r[o];if(e!=null&&typeof e!="function")if(Array.isArray(e)){t[o]=[];for(let n=0;n<e.length;n++)t[o][n]=d(e[n])}else typeof e=="object"?e.toJSON&&(t[o]=JSON.stringify(e)):t[o]=e}return t}const m="Layer does not support extent calculation.";function p(r,t){if(t&&r.type==="extent")return`${r.xmin},${r.ymin},${r.xmax},${r.ymax}`;if(t&&r.type==="point")return`${r.x},${r.y}`;const o=r.toJSON();return delete o.spatialReference,JSON.stringify(o)}function S(r,t){const o=r.geometry,e=r.toJSON();delete e.compactGeometryEnabled,delete e.defaultSpatialReferenceEnabled;const n=e;let a,u,c;if(i(o)&&(u=o.spatialReference,c=o.spatialReference.wkid||JSON.stringify(o.spatialReference),n.geometryType=R(o),n.geometry=p(o,r.compactGeometryEnabled),n.inSR=c),e.groupByFieldsForStatistics&&(n.groupByFieldsForStatistics=e.groupByFieldsForStatistics.join(",")),e.objectIds&&(n.objectIds=e.objectIds.join(",")),e.orderByFields&&(n.orderByFields=e.orderByFields.join(",")),!e.outFields||!e.returnDistinctValues&&(t!=null&&t.returnCountOnly||t!=null&&t.returnExtentOnly||t!=null&&t.returnIdsOnly)?delete n.outFields:e.outFields.includes("*")?n.outFields="*":n.outFields=e.outFields.join(","),e.outSR?(n.outSR=e.outSR.wkid||JSON.stringify(e.outSR),a=r.outSpatialReference):o&&(e.returnGeometry||e.returnCentroid)&&(n.outSR=n.inSR,a=u),e.returnGeometry&&delete e.returnGeometry,e.outStatistics&&(n.outStatistics=JSON.stringify(e.outStatistics)),e.fullText&&(n.fullText=JSON.stringify(e.fullText)),e.pixelSize&&(n.pixelSize=JSON.stringify(e.pixelSize)),e.quantizationParameters&&(r.defaultSpatialReferenceEnabled&&i(u)&&i(r.quantizationParameters)&&i(r.quantizationParameters.extent)&&u.equals(r.quantizationParameters.extent.spatialReference)&&delete e.quantizationParameters.extent.spatialReference,n.quantizationParameters=JSON.stringify(e.quantizationParameters)),e.parameterValues&&(n.parameterValues=JSON.stringify(e.parameterValues)),e.rangeValues&&(n.rangeValues=JSON.stringify(e.rangeValues)),e.dynamicDataSource&&(n.layer=JSON.stringify({source:e.dynamicDataSource}),delete e.dynamicDataSource),e.timeExtent){const y=e.timeExtent,{start:s,end:f}=y;s==null&&f==null||(n.time=s===f?s:`${s??"null"},${f??"null"}`),delete e.timeExtent}return r.defaultSpatialReferenceEnabled&&i(u)&&i(a)&&u.equals(a)&&(n.defaultSR=n.inSR,delete n.inSR,delete n.outSR),n}async function q(r,t,o,e){const n=i(t.timeExtent)&&t.timeExtent.isEmpty?{data:{features:[]}}:await l(r,t,"json",e);return b(t,o,n.data),n}async function P(r,t,o,e){if(i(t.timeExtent)&&t.timeExtent.isEmpty)return{data:o.createFeatureResult()};const n=await x(r,t,e),a=n;return a.data=j(n.data,o),a}function x(r,t,o){return l(r,t,"pbf",o)}function J(r,t,o){return i(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):l(r,t,"json",o,{returnIdsOnly:!0})}function N(r,t,o){return i(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):l(r,t,"json",o,{returnIdsOnly:!0,returnCountOnly:!0})}function z(r,t,o){return i(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0,extent:null}}):l(r,t,"json",o,{returnExtentOnly:!0,returnCountOnly:!0}).then(e=>{const n=e.data;if(n.hasOwnProperty("extent"))return e;if(n.features)throw new Error(m);if(n.hasOwnProperty("count"))throw new Error(m);return e})}function l(r,t,o,e={},n={}){const a=typeof r=="string"?E(r):r,u=t.geometry?[t.geometry]:[];return e.responseType=o==="pbf"?"array-buffer":"json",F(u,null,e).then(c=>{const y=c&&c[0];i(y)&&((t=t.clone()).geometry=y);const s=d({...a.query,f:o,...n,...S(t,n)});return g(O(a.path,"query"),{...e,query:{...s,...e.query}})})}const G=Object.freeze(Object.defineProperty({__proto__:null,encodeGeometry:p,executeQuery:q,executeQueryForCount:N,executeQueryForExtent:z,executeQueryForIds:J,executeQueryPBF:P,executeQueryPBFBuffer:x,queryToQueryStringParameters:S,runQuery:l},Symbol.toStringTag,{value:"Module"}));export{N as S,q as c,x as d,P as f,J as p,G as q,d as t,z as x};
