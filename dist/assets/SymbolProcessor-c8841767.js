import{jf as hs,je as Wt,tm as rt,tn as qe,to as ze,tp as ci,cB as v,bz as ut,tq as Et,tr as Me,ts as $e,e as A,y as K,b as Xe,f as ls,a as cs,jv as us,i$ as ds,T as _t,dC as Gt,C as V,w as E,tt as He,hJ as Ye,d as ue,rk as Qs,i as Bt,d4 as fs,tu as Js,aH as ae,db as tr,aq as er,pc as ir,cv as ct,po as sr,pi as _s,pj as ms,fF as rr,fH as nr,pd as ar,pe as or,pf as hr,pg as lr,tv as ui,tw as di,tx as fi,m as je,av as _i,mU as cr,_ as ps,nX as ur,qi as dr,cM as fr,nW as mi,aL as _r,dm as mr}from"./index-df1c7459.js";import{h as pr,k as ys,l as yr,n as gr,o as we,q as xr,v as gs,w as xs,x as Pe,y as vr,z as Mr,A as wr,f as br,d as Yt,j as Sr}from"./cimAnalyzer-0375b3f7.js";import{l as vs,f as Tr,R as Ce,k as Lr,G as Ir,p as Ms}from"./Pipeline-40ecdda3.js";import{E as w,S as B,L as H,A as jt}from"./TileInfoView-c864a057.js";import{s as Ee,t as zr,o as Mt,v as $r,x as ws,r as X,z as R,D as Pr,E as Cr,F as Er,G as xt,H as kr,I as Wr,J as C,f as Qt,L as bs,X as Vr,e as pi,M as Br,Q as Ss,V as de,W as Ts,a0 as Ls}from"./enums-c655c737.js";import{o as Rr,p as Ar}from"./tileUtils-7f87edc3.js";import{r as Fr,c as Or,i as Dr}from"./TurboLine-4561bd71.js";import{x as I,w as x}from"./number-b10bd8f5.js";import{t as Gr}from"./Rect-98da58d6.js";import{c as ke}from"./GeometryUtils-0258f920.js";import{e as Is,t as zs}from"./TileClipper-ae6eca9e.js";function z(n){if(!n)return 0;const{r:t,g:e,b:i,a:s}=n;return I(t*s,e*s,i*s,255*s)}function G(n){if(!n)return 0;const[t,e,i,s]=n;return I(t*(s/255),e*(s/255),i*(s/255),s)}let At=class We{constructor(t,e,i,s){this.center=hs(t,e),this.centerT=Wt(),this.halfWidth=i/2,this.halfHeight=s/2,this.width=i,this.height=s}get x(){return this.center[0]}get y(){return this.center[1]}get blX(){return this.center[0]+this.halfWidth}get blY(){return this.center[1]+this.halfHeight}get trX(){return this.center[0]-this.halfWidth}get trY(){return this.center[1]-this.halfHeight}get xmin(){return this.x-this.halfWidth}get xmax(){return this.x+this.halfWidth}get ymin(){return this.y-this.halfHeight}get ymax(){return this.y+this.halfHeight}set x(t){this.center[0]=t}set y(t){this.center[1]=t}clone(){return new We(this.x,this.y,this.width,this.height)}serialize(t){return t.writeF32(this.center[0]),t.writeF32(this.center[1]),t.push(this.width),t.push(this.height),t}findCollisionDelta(t,e=4){const i=Math.abs(t.centerT[0]-this.centerT[0]),s=Math.abs(t.centerT[1]-this.centerT[1]),r=(t.halfWidth+this.halfWidth+e)/i,a=(t.halfHeight+this.halfHeight+e)/s,o=Math.min(r,a);return Math.log2(o)}extend(t){const e=Math.min(this.xmin,t.xmin),i=Math.min(this.ymin,t.ymin),s=Math.max(this.xmax,t.xmax)-e,r=Math.max(this.ymax,t.ymax)-i,a=e+s/2,o=i+r/2;this.width=s,this.height=r,this.halfWidth=s/2,this.halfHeight=r/2,this.x=a,this.y=o}static deserialize(t){const e=t.readF32(),i=t.readF32(),s=t.readInt32(),r=t.readInt32();return new We(e,i,s,r)}};const Qe=26,$s=4,Kr=Qe+$s,Nr=Qe-6,yi=3,W=8,Zr=Math.PI/180,at=8,Ur=1.5;let Ps=class{constructor(t,e,i,s){this._rotationT=rt(),this._xBounds=0,this._yBounds=0,this.minZoom=0,this.maxZoom=255,this._bounds=null;const r=i.rect,a=new Float32Array(8);t*=s,e*=s;const o=i.code?r.width*s:i.metrics.width,h=i.code?r.height*s:i.metrics.height;this.width=o,this.height=h,a[0]=t,a[1]=e,a[2]=t+o,a[3]=e,a[4]=t,a[5]=e+h,a[6]=t+o,a[7]=e+h,this._data=a,this._setTextureCoords(r),this._scale=s,this._mosaic=i,this.x=t,this.y=e,this.maxOffset=Math.max(t+o,e+h)}get mosaic(){return this._mosaic}set angle(t){this._angle=t,qe(this._rotationT,-t),this._setOffsets(this._data)}get angle(){return this._angle}get xTopLeft(){return this._data[0]}get yTopLeft(){return this._data[1]}get xBottomRight(){return this._data[6]}get yBottomRight(){return this._data[7]}get texcoords(){return this._texcoords}get textureBinding(){return this._mosaic.textureBinding}get offsets(){return this._offsets||this._setOffsets(this._data),this._offsets}get char(){return String.fromCharCode(this._mosaic.code)}get code(){return this._mosaic.code}get bounds(){if(!this._bounds){const{height:t,width:e}=this._mosaic.metrics,i=e*this._scale,s=Math.abs(t)*this._scale,r=new Float32Array(8);r[0]=this.x,r[1]=this.y,r[2]=this.x+i,r[3]=this.y,r[4]=this.x,r[5]=this.y+s,r[6]=this.x+i,r[7]=this.y+s;const a=ze(rt(),this._rotationT,this._transform);ci(r,r,a);let o=1/0,h=1/0,l=0,u=0;for(let m=0;m<4;m++){const p=r[2*m],y=r[2*m+1];o=Math.min(o,p),h=Math.min(h,y),l=Math.max(l,p),u=Math.max(u,y)}const c=l-o,d=u-h,f=o+c/2,_=h+d/2;this._bounds=new At(f,_,c,d)}return this._bounds}setTransform(t){this._transform=t,this._offsets=null}_setOffsets(t){this._offsets||(this._offsets={upperLeft:0,upperRight:0,lowerLeft:0,lowerRight:0});const e=this._offsets,i=new Float32Array(8),s=ze(rt(),this._rotationT,this._transform);ci(i,t,s),e.upperLeft=x(i[0]*W,i[1]*W),e.upperRight=x(i[2]*W,i[3]*W),e.lowerLeft=x(i[4]*W,i[5]*W),e.lowerRight=x(i[6]*W,i[7]*W)}_setTextureCoords({x:t,y:e,width:i,height:s}){this._texcoords={upperLeft:x(t,e),upperRight:x(t+i,e),lowerLeft:x(t,e+s),lowerRight:x(t+i,e+s)}}};const qr=(n,t)=>({code:0,page:0,sdf:!0,rect:new Gr(0,0,11,8),textureBinding:t,metrics:{advance:0,height:4,width:n,left:0,top:0}});function Rt(n,t){return n.forEach(e=>Et(e,e,t)),{upperLeft:x(W*n[0][0],W*n[0][1]),upperRight:x(W*n[1][0],W*n[1][1]),lowerLeft:x(W*n[2][0],W*n[2][1]),lowerRight:x(W*n[3][0],W*n[3][1])}}let Xr=class{constructor(t,e,i){this._rotation=0,this._decorate(t,e,i),this.glyphs=t,this.bounds=this._createBounds(t),this.isMultiline=e.length>1,this._hasRotation=i.angle!==0,this._transform=this._createGlyphTransform(this.bounds,i),this._borderLineSize=i.borderLineSize,(i.borderLineSize||i.hasBackground)&&([this.bounds,this.background]=this.shapeBackground(this._transform));for(const s of t)s.setTransform(this._transform)}setRotation(t){if(t===0&&this._rotation===0)return;this._rotation=t;const e=this._transform,i=qe(rt(),t);ze(e,i,e);for(const s of this.glyphs)s.setTransform(this._transform)}_decorate(t,e,i){if(!i.decoration||i.decoration==="none"||!t.length)return;const s=i.scale,r=i.decoration==="underline"?Kr:Nr,a=t[0].textureBinding;for(const o of e){const h=o.startX*s,l=o.startY*s,u=(o.width+o.glyphWidthEnd)*s;t.push(new Ps(h,l+r*s,qr(u,a),1))}}shapeBackground(t){const e=v(this._borderLineSize||0),i=(Ur+e)/2,s=this._borderLineSize?i:0,{xmin:r,ymin:a,xmax:o,ymax:h,x:l,y:u,width:c,height:d}=this.bounds,f=[r-at,a-at],_=[o+at,a-at],m=[r-at,h+at],p=[o+at,h+at],y=Rt([[f[0]-i,f[1]-i],[_[0]+i,_[1]-i],[f[0]+s,f[1]+s],[_[0]-s,_[1]+s]],t),g=Rt([[m[0]+s,m[1]-s],[p[0]-s,p[1]-s],[m[0]-i,m[1]+i],[p[0]+i,p[1]+i]],t),M=Rt([[f[0]-i,f[1]-i],[f[0]+s,f[1]+s],[m[0]-i,m[1]+i],[m[0]+s,m[1]-s]],t),b=Rt([[_[0]-s,_[1]+s],[_[0]+i,_[1]-i],[p[0]-s,p[1]-s],[p[0]+i,p[1]+i]],t),S={main:Rt([f,_,m,p],t),top:y,bot:g,left:M,right:b};return[new At(l,u,c+2*i,d+2*i),S]}get boundsT(){const t=this.bounds,e=ut(Wt(),t.x,t.y);if(Et(e,e,this._transform),this._hasRotation){const i=Math.max(t.width,t.height);return new At(e[0],e[1],i,i)}return new At(e[0],e[1],t.width,t.height)}_createBounds(t){let e=1/0,i=1/0,s=0,r=0;for(const h of t)e=Math.min(e,h.xTopLeft),i=Math.min(i,h.yTopLeft),s=Math.max(s,h.xBottomRight),r=Math.max(r,h.yBottomRight);const a=s-e,o=r-i;return new At(e+a/2,i+o/2,a,o)}_createGlyphTransform(t,e){const i=Zr*e.angle,s=rt(),r=Wt();return Me(s,s,ut(r,e.xOffset,-e.yOffset)),e.isCIM?$e(s,s,i):(Me(s,s,ut(r,t.x,t.y)),$e(s,s,i),Me(s,s,ut(r,-t.x,-t.y))),s}},Jt=class{constructor(t,e,i,s,r,a){this.glyphWidthEnd=0,this.startX=0,this.startY=0,this.start=Math.max(0,Math.min(e,i)),this.end=Math.max(0,Math.max(e,i)),this.end<t.length&&(this.glyphWidthEnd=t[this.end].metrics.width),this.width=s,this.yMin=r,this.yMax=a}};const Ve=n=>n===10,gi=n=>n===32;function Hr(n,t,e){const i=new Array,s=1/e.scale,r=e.maxLineWidth*s,a=t?n.length-1:0,o=t?-1:n.length,h=t?-1:1;let l=a,u=0,c=0,d=l,f=d,_=0,m=1/0,p=0;for(;l!==o;){const{code:g,metrics:M}=n[l],b=Math.abs(M.top);if(Ve(g)||gi(g)||(m=Math.min(m,b),p=Math.max(p,b+M.height)),Ve(g))l!==a&&(i.push(new Jt(n,d,l-h,u,m,p)),m=1/0,p=0),u=0,d=l+h,f=l+h,c=0;else if(gi(g))f=l+h,c=0,_=M.advance,u+=M.advance;else if(u>r){if(f!==d){const S=f-2*h;u-=_,i.push(new Jt(n,d,S,u-c,m,p)),m=1/0,p=0,d=f,u=c}else i.push(new Jt(n,d,l-h,u,m,p)),m=1/0,p=0,d=l,f=l,u=0;u+=M.advance,c+=M.advance}else u+=M.advance,c+=M.advance;l+=h}const y=new Jt(n,d,l-h,u,m,p);return y.start>=0&&y.end<n.length&&i.push(y),i}function Yr(n,t){let e=0;for(let r=0;r<n.length;r++){const{width:a}=n[r];e=Math.max(a,e)}const i=t.decoration==="underline"?$s:0,s=n[0].yMin;return{x:0,y:s,height:n[n.length-1].yMax+t.lineHeight*(n.length-1)+i-s,width:e}}function jr(n,t,e){const i=e.scale,s=new Array,r=Hr(n,t,e),a=Yr(r,e),{vAlign:o,hAlign:h}=e,l=o===pr.Baseline?1:0,u=l?0:o-1,c=(1-l)*-a.y+u*(a.height/2)+(l?1:0)*-Qe;for(let d=0;d<r.length;d++){const{start:f,end:_,width:m}=r[d];let p=-1*(h+1)*(m/2)-yi;const y=d*e.lineHeight+c-yi;r[d].startX=p,r[d].startY=y;for(let g=f;g<=_;g++){const M=n[g];if(Ve(M.code))continue;const b=new Ps(p+M.metrics.left,y-M.metrics.top,M,i);p+=M.metrics.advance,s.push(b)}}return new Xr(s,r,e)}function Qr(n,t){return n.length=0,t.forEach(e=>n.push(e)),n}const be=new Set,te=[],Tt=new Map,xi=[0,0];let ot=class extends ls{constructor(t){super(t),this._keyToItem=new Map,this.concurrency=6,this.strategy="scale-first",this.tileInfoView=null}initialize(){const{concurrency:t,process:e}=this;this._queue=new vs({concurrency:t,process:(i,s)=>{const r=this._keyToItem.get(i);return e(r,{signal:s})},peeker:i=>i.values().next().value})}destroy(){this.clear(),this._queue=cs(this._queue)}get length(){return this._queue?this._queue.length:0}get onGoingCount(){return this._keyToItem.size}get updating(){return this.length>0||this.onGoingCount>0}abort(t){const e=typeof t=="string"?t:t.id;this._queue.abort(e)}clear(){this._queue.clear(),this._keyToItem.clear(),this.notifyChange("updating")}has(t){return typeof t=="string"?this._keyToItem.has(t):this._keyToItem.has(t.id)}isOngoing(t){const e=typeof t=="string"?t:t.id;return this.has(e)&&this._queue.isOngoing(e)}pause(){this._queue.pause()}push(t,e){const i=t.key.id+"-"+e;if(this.has(i))return this.get(i);const s=this._queue.push(i),r=()=>{this._keyToItem.delete(i),this.notifyChange("updating")};return this._keyToItem.set(i,t),s.then(r,r),this.notifyChange("updating"),s}reset(){this._queue.reset(),this.notifyChange("updating")}resume(){this._queue.resume()}_peekByScaleFirst(t){if(!this.state)return t.values().next().value;const e=this.tileInfoView;let i=Number.NEGATIVE_INFINITY,s=Number.POSITIVE_INFINITY;t.forEach(u=>{const c=this._keyToItem.get(u),d=this.tileInfoView.getTileScale(c.key);Tt.has(d)||(Tt.set(d,[]),i=Math.max(d,i),s=Math.min(d,s)),Tt.get(d).push(c.key),be.add(d)});let r=this.state.scale;Tt.has(r)||(Qr(te,be),te.sort((u,c)=>u-c),r=te.reduce((u,c)=>Math.abs(c-r)<Math.abs(u-r)?c:u,te[0])),r=Math.min(r,i),r=Math.max(r,s);const a=Tt.get(r),o=e.getClosestInfoForScale(r),h=o.getColumnForX(this.state.center[0]),l=o.getRowForY(this.state.center[1]);return a.sort((u,c)=>{const d=o.denormalizeCol(u.col,u.world),f=o.denormalizeCol(c.col,c.world);return Math.sqrt((h-d)*(h-d)+(l-u.row)*(l-u.row))-Math.sqrt((h-f)*(h-f)+(l-c.row)*(l-c.row))}),be.clear(),Tt.clear(),a[0].id}_peekByCenterFirst(t){if(!this.state)return t.values().next().value;const e=this.tileInfoView,i=this.state.center;let s,r=Number.POSITIVE_INFINITY;return t.forEach(a=>{const o=this._keyToItem.get(a);e.getTileCoords(xi,o.key);const h=us(xi,i);h<r&&(r=h,s=o.key)}),s.id}};A([K({constructOnly:!0})],ot.prototype,"concurrency",void 0),A([K({constructOnly:!0})],ot.prototype,"process",void 0),A([K()],ot.prototype,"state",void 0),A([K({constructOnly:!0})],ot.prototype,"strategy",void 0),A([K({constructOnly:!0})],ot.prototype,"tileInfoView",void 0),A([K({readOnly:!0})],ot.prototype,"updating",null),ot=A([Xe("esri.views.2d.tiling.PagedTileQueue")],ot);function Jr(n,t){return n.length=0,t.forEach(e=>n.push(e)),n}const Se=new Set,ee=[],Lt=new Map,vi=[0,0];let ht=class extends ls{constructor(t){super(t),this._keyToItem=new Map,this.concurrency=6,this.strategy="scale-first",this.tileInfoView=null}initialize(){const{concurrency:t,process:e,strategy:i}=this;this._queue=new vs({concurrency:t,process:(s,r)=>{const a=this._keyToItem.get(s);return e(a,{signal:r})},peeker:i==="scale-first"?s=>this._peekByScaleFirst(s):s=>this._peekByCenterFirst(s)})}destroy(){this.clear(),this._queue=cs(this._queue)}get length(){return this._queue?this._queue.length:0}get onGoingCount(){return this._keyToItem.size}get updating(){return this.length>0||this.onGoingCount>0}abort(t){const e=typeof t=="string"?t:t.id;this._queue.abort(e)}clear(){this._queue.clear(),this._keyToItem.clear(),this.notifyChange("updating")}has(t){return typeof t=="string"?this._keyToItem.has(t):this._keyToItem.has(t.id)}isOngoing(t){const e=typeof t=="string"?t:t.id;return this.has(e)&&this._queue.isOngoing(e)}pause(){this._queue.pause()}push(t){const e=t.key.id;if(this._queue.has(e))return this._queue.get(e);const i=this._queue.push(e),s=()=>{this._keyToItem.delete(e),this.notifyChange("updating")};return this._keyToItem.set(e,t),i.then(s,s),this.notifyChange("updating"),i}reset(){this._queue.reset()}resume(){this._queue.resume()}_peekByScaleFirst(t){if(!this.state)return t.values().next().value;const e=this.tileInfoView;let i=Number.NEGATIVE_INFINITY,s=Number.POSITIVE_INFINITY;t.forEach(u=>{const c=this._keyToItem.get(u),d=this.tileInfoView.getTileScale(c.key);Lt.has(d)||(Lt.set(d,[]),i=Math.max(d,i),s=Math.min(d,s)),Lt.get(d).push(c.key),Se.add(d)});let r=this.state.scale;Lt.has(r)||(Jr(ee,Se),ee.sort((u,c)=>u-c),r=ee.reduce((u,c)=>Math.abs(c-r)<Math.abs(u-r)?c:u,ee[0])),r=Math.min(r,i),r=Math.max(r,s);const a=Lt.get(r),o=e.getClosestInfoForScale(r),h=o.getColumnForX(this.state.center[0]),l=o.getRowForY(this.state.center[1]);return a.sort((u,c)=>{const d=o.denormalizeCol(u.col,u.world),f=o.denormalizeCol(c.col,c.world);return Math.sqrt((h-d)*(h-d)+(l-u.row)*(l-u.row))-Math.sqrt((h-f)*(h-f)+(l-c.row)*(l-c.row))}),Se.clear(),Lt.clear(),a[0].id}_peekByCenterFirst(t){if(!this.state)return t.values().next().value;const e=this.tileInfoView,i=this.state.center;let s,r=Number.POSITIVE_INFINITY;return t.forEach(a=>{const o=this._keyToItem.get(a);e.getTileCoords(vi,o.key);const h=us(vi,i);h<r&&(r=h,s=o.key)}),s.id}};A([K({constructOnly:!0})],ht.prototype,"concurrency",void 0),A([K({constructOnly:!0})],ht.prototype,"process",void 0),A([K()],ht.prototype,"state",void 0),A([K({constructOnly:!0})],ht.prototype,"strategy",void 0),A([K({constructOnly:!0})],ht.prototype,"tileInfoView",void 0),A([K({readOnly:!0})],ht.prototype,"updating",null),ht=A([Xe("esri.views.2d.tiling.TileQueue")],ht);new ds(0,0,0,0);const Pt=new Map;function tn(n,t,e){const{indicesPerRecord:i,multiplier:s,verticesPerRecord:r}=Pt.get(n);return{recordBytes:e*Ee*Uint32Array.BYTES_PER_ELEMENT,indexBytes:s*i*e*Uint32Array.BYTES_PER_ELEMENT,vertexBytes:s*r*e*t}}Pt.set(w.MARKER,{multiplier:1,indicesPerRecord:6,verticesPerRecord:4}),Pt.set(w.LINE,{multiplier:1,indicesPerRecord:24,verticesPerRecord:8}),Pt.set(w.FILL,{multiplier:1,indicesPerRecord:10,verticesPerRecord:10}),Pt.set(w.TEXT,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4}),Pt.set(w.LABEL,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4});const en=1.25;let ie=class{get length(){return this._pos}constructor(t,e){this._pos=0;const i=e?this._roundToNearest(e,t.BYTES_PER_ELEMENT):40;this._array=new ArrayBuffer(i),this._buffer=new t(this._array),this._ctor=t,this._i16View=new Int16Array(this._array)}_roundToNearest(t,e){const i=Math.round(t);return i+(e-i%e)}_ensureSize(t){if(this._pos+t>=this._buffer.length){const e=this._roundToNearest((this._array.byteLength+t*this._buffer.BYTES_PER_ELEMENT)*en,this._buffer.BYTES_PER_ELEMENT),i=new ArrayBuffer(e),s=new this._ctor(i);s.set(this._buffer,0),this._array=i,this._buffer=s,this._i16View=new Int16Array(this._array)}}ensureSize(t){this._ensureSize(t)}writeF32(t){this._ensureSize(1);const e=this._pos;return new Float32Array(this._array,4*this._pos,1)[0]=t,this._pos++,e}push(t){this._ensureSize(1);const e=this._pos;return this._buffer[this._pos++]=t,e}writeFixed(t){this._buffer[this._pos++]=t}setValue(t,e){this._buffer[t]=e}i1616Add(t,e,i){this._i16View[2*t]+=e,this._i16View[2*t+1]+=i}getValue(t){return this._buffer[t]}incr(t){if(this._buffer.length<t)throw new Error("Increment index overflows the target buffer");this._buffer[t]++}decr(t){this._buffer[t]--}writeRegion(t){this._ensureSize(t.length);const e=this._pos;return this._buffer.set(t,this._pos),this._pos+=t.length,e}writeManyFrom(t,e,i){this._ensureSize(i-e);for(let s=e;s!==i;s++)this.writeFixed(t._buffer[s])}buffer(){const t=this._array.slice(0,4*this._pos);return this.destroy(),t}toArray(){const t=this._array,e=[];for(let i=0;i<t.byteLength/4;i++)e.push(t[i]);return e}seek(t){this._pos=t}destroy(){this._array=null,this._buffer=null}},Mi=class{constructor(t,e,i){this._start={index:0,vertex:0};const s=tn(t,e,i),r=e/4;this.geometryType=t,this._records=new ie(Int32Array,s.recordBytes),this._indices=new ie(Uint32Array,s.indexBytes),this._vertices=new ie(Uint32Array,s.vertexBytes),this._metrics=new ie(Float32Array,0),this._strideInt=r}serialize(t){const e=this._records.buffer(),i=this._indices.buffer(),s=this._vertices.buffer(),r=this._metrics.length?this._metrics.buffer():null,a=4*this._strideInt;return t.push(e,i,s),{stride:a,records:e,indices:i,vertices:s,metrics:r}}get strideInt(){return this._strideInt}get recordCount(){return this._records.length/Ee}get vertexCount(){return this._vertices.length/this._strideInt}get indexCount(){return this._indices.length}get indexWriter(){return this._indices}get vertexWriter(){return this._vertices}get metricWriter(){return this._metrics}vertexEnsureSize(t){this._vertices.ensureSize(t)}indexEnsureSize(t){this._indices.ensureSize(t)}recordStart(){this._start.index=this._indices.length,this._start.vertex=this._vertices.length}recordEnd(t,e,i,s,r,a,o,h){this._records.push(t),this._records.push(e??0),this._records.push(i),this._records.push(s),this._records.push(r),this._records.push(a),this._records.push(o),this._records.writeF32(h)}writeIndex(t){this._indices.push(t)}writeVertex(t){this._vertices.push(t)}writeVertexF32(t){this._vertices.writeF32(t)}copyLastFrom(t,e,i){const s=t._records.length-Ee,r=t._records.getValue(s),a=t._records.getValue(s+1),o=t._records.getValue(s+2),h=t._records.getValue(s+4),l=t._records.getValue(s+6),u=t._records.getValue(s+7),c=this._vertices.length,d=(t._start.vertex-this._vertices.length)/this._strideInt,f=this._indices.length,_=this.vertexCount;for(let m=t._start.index;m!==t._indices.length;m++){const p=t._indices.getValue(m);this._indices.push(p-d)}for(let m=t._start.vertex;m!==t._vertices.length;m++){const p=t._vertices.getValue(m);this._vertices.push(p)}for(let m=c;m<=this._vertices.length;m+=this._strideInt)this._vertices.i1616Add(m,e,i);this._records.push(r),this._records.push(a),this._records.push(o),this._records.push(f),this._records.push(h),this._records.push(_),this._records.push(l),this._records.push(u)}};const fe=1,Je=2,_e=4,ti=8,ei=16,me=32,ii=64,pe=128;function wi(n){switch(n){case fe:case ti:case me:return-1;case Je:case ii:return 0;case _e:case ei:case pe:return 1}}function bi(n){switch(n){case fe:case Je:case _e:return-1;case ti:case ei:return 0;case me:case ii:case pe:return 1}}const Si=fe|ti|me,Ti=_e|ei|pe,Li=fe|Je|_e,Ii=me|ii|pe;let sn=class{constructor(t,e,i,s,r,a=0){this._hasAggregate=!1,this.hasRecords=!1,this._data={self:new Map,neighbors:new Array},this._version=0,this._current={geometryType:0,writer:null,overlaps:0,start:0,insertAfter:0,sortKey:0,id:0,materialKey:0,indexStart:0,vertStart:0,isDotDensity:!1,bufferingEnabled:!1,metricBoxLenPointer:0},this.hint=e,this.tileKey=t,this._hasAggregate=s,this._pixelBufferEnabled=r,this._version=a,this._symbologyType=i}get hasAggregates(){return this._hasAggregate}get hasPixelBufferEnabled(){return this._pixelBufferEnabled}serialize(t){const e=[];return e.push(this._serializeTileVertexData(this.tileKey,this.tileKey,this._data.self)),this._data.neighbors.forEach((i,s)=>{const r=1<<s,a=wi(r),o=bi(r),h=Rr(new ds(this.tileKey),a,o,t),l=this._serializeTileVertexData(this.tileKey,h.id,i.vertexData);l.message.bufferIds=i.displayIds,e.push(l)}),e}_serializeTileVertexData(t,e,i){var r,a,o,h,l;const s=new Array;return{message:{tileKeyOrigin:t,tileKey:e,data:{[w.MARKER]:(r=i.get(w.MARKER))==null?void 0:r.serialize(s),[w.FILL]:(a=i.get(w.FILL))==null?void 0:a.serialize(s),[w.LINE]:(o=i.get(w.LINE))==null?void 0:o.serialize(s),[w.TEXT]:(h=i.get(w.TEXT))==null?void 0:h.serialize(s),[w.LABEL]:(l=i.get(w.LABEL))==null?void 0:l.serialize(s)},version:this._version},transferList:s}}featureStart(t,e){this._current.insertAfter=t,this._current.sortKey=e}featureEnd(){}recordStart(t,e,i,s){this._current.writer=this._getVertexWriter(i),this._current.overlaps=0,this._current.indexStart=this._current.writer.indexCount,this._current.vertStart=this._current.writer.vertexCount,this._current.bufferingEnabled=s,this._current.id=t,this._current.materialKey=e,this._current.geometryType=i,this._current.isDotDensity=!1,this._current.writer.recordStart()}recordCount(){return this._current.writer.recordCount}vertexCount(){return this._current.writer.vertexCount}indexCount(){return this._current.writer.indexCount}vertexEnsureSize(t){this._current.writer.vertexEnsureSize(t)}indexEnsureSize(t){this._current.writer.indexEnsureSize(t)}vertexBounds(t,e,i,s){this._current.bufferingEnabled&&this._addOverlap(t,e,i,s)}vertexWrite(t){this._current.writer.writeVertex(t)}vertexWriteF32(t){this._current.writer.writeVertexF32(t)}vertexEnd(){}vertexWriter(){return this._current.writer.vertexWriter}indexWrite(t){this._current.writer.writeIndex(t)}indexWriter(){return this._current.writer.indexWriter}metricWriter(){return this._current.writer.metricWriter}metricStart(t,e,i,s,r,a,o,h){this._current.writer=this._getVertexWriter(w.LABEL);const l=this._current.writer.metricWriter;l.push(Tr(t)),l.push(e),l.push(i),l.push(s),l.push(r),l.push(a),l.push(o),l.push(h),l.push(255),this._current.metricBoxLenPointer=l.push(0)}metricEnd(){const t=this._current.writer.metricWriter;t.getValue(this._current.metricBoxLenPointer)===0&&t.seek(t.length-10)}metricBoxWrite(t,e,i,s){const r=this._current.writer.metricWriter;r.incr(this._current.metricBoxLenPointer),r.push(0),r.push(0),r.push(t),r.push(e),r.push(i),r.push(s)}recordEnd(){const t=this._current.vertStart,e=this._current.writer.vertexCount-t;if(!e)return!1;this.hasRecords=!0;const i=this._current.indexStart,s=this._current.writer.indexCount-i;if(this._current.writer.recordEnd(this._current.id,this._current.materialKey,this._current.insertAfter,i,s,t,e,this._current.sortKey),!this._pixelBufferEnabled||this._hasAggregate||this._current.overlaps===0||this._current.geometryType===w.LABEL)return!0;const r=this._current.writer;for(let a=0;a<8;a++){const o=1<<a;if(this._current.overlaps&o){this._data.neighbors[a]||(this._data.neighbors[a]={vertexData:new Map,displayIds:new Set});const h=this._data.neighbors[a],l=this._current.geometryType;if(!h.vertexData.has(l)){const _=Ce(l,this._symbologyType).geometry,m=new Mi(l,_,zr);h.vertexData.set(l,m)}const u=h.vertexData.get(this._current.geometryType),c=8,d=512*-wi(o)*c,f=512*-bi(o)*c;u==null||u.copyLastFrom(r,d,f),h.displayIds.add(this._current.id)}}return!0}_addOverlap(t,e,i,s){const r=255^((t<0+i?Ti:t>=Mt-i?Si:Ti|Si)|(e<0+s?Ii:e>=Mt-s?Li:Ii|Li));this._current.overlaps|=r}_getVertexWriter(t){if(!this._data.self.has(t)){const e=this._data.self,i=Ce(t,this._symbologyType).geometry;e.set(t,new Mi(t,i,this.hint.records))}return this._data.self.get(t)}};function rn(n,t,e){const i=H.SIZE_FIELD_STOPS|H.SIZE_MINMAX_VALUE|H.SIZE_SCALE_STOPS|H.SIZE_UNIT_VALUE,s=(t&(jt.FIELD_TARGETS_OUTLINE|jt.MINMAX_TARGETS_OUTLINE|jt.SCALE_TARGETS_OUTLINE|jt.UNIT_TARGETS_OUTLINE))>>>4;return n===w.LINE&&e.isOutline||n===w.FILL&&Cs(e.symbologyType)?i&s:i&~s}const zi=0,$i=8,nn=7,Pi=8,Ci=11,Ei=11,ki=12,Wi=13,Vi=14,Bi=15,Ri=16,Ai=17,Fi=18,Oi=19,Di=20,Gi=21,Ki=26,an=Object.keys(B).filter(n=>typeof B[n]=="number").reduce((n,t)=>({...n,[t]:B[t]}),{});function on(n){return n===B.SIMPLE||n===B.OUTLINE_FILL_SIMPLE}function Cs(n){return n===B.OUTLINE_FILL||n===B.OUTLINE_FILL_SIMPLE}function Es(n){return on(n.symbologyType)}function oe(n){return Cs(n.symbologyType)}function ye(n,t){switch(n){case w.FILL:return et.from(t);case w.LINE:return dt.from(t);case w.MARKER:return wt.from(t);case w.TEXT:return Kt.from(t);case w.LABEL:return vt.from(t);default:throw new Error(`Unable to createMaterialKey for unknown geometryType ${n}`)}}function Ka(n){switch(Y.load(n).geometryType){case w.MARKER:return new wt(n);case w.FILL:return new et(n);case w.LINE:return new dt(n);case w.TEXT:return new Kt(n);case w.LABEL:return new vt(n)}}class Y{static load(t){const e=this.shared;return e.data=t,e}constructor(t){this._data=0,this._data=t}set data(t){this._data=t??0}get data(){return this._data}get geometryType(){return this.bits(Pi,Ci)}set geometryType(t){this.setBits(t,Pi,Ci)}get mapAligned(){return!!this.bit(Di)}set mapAligned(t){this.setBit(Di,t)}get sdf(){return!!this.bit(Ei)}set sdf(t){this.setBit(Ei,t??!1)}get pattern(){return!!this.bit(ki)}set pattern(t){this.setBit(ki,t)}get textureBinding(){return this.bits(zi,$i)}set textureBinding(t){this.setBits(t,zi,$i)}get symbologyType(){return this.bits(Gi,Ki)}set symbologyType(t){this.setBits(t,Gi,Ki)}get geometryTypeString(){switch(this.geometryType){case w.FILL:return"fill";case w.MARKER:return"marker";case w.LINE:return"line";case w.TEXT:return"text";case w.LABEL:return"label";default:throw new _t(`Unable to handle unknown geometryType: ${this.geometryType}`)}}setBit(t,e){const i=1<<t;e?this._data|=i:this._data&=~i}bit(t){return(this._data&1<<t)>>t}setBits(t,e,i){for(let s=e,r=0;s<i;s++,r++)this.setBit(s,(t&1<<r)!=0)}bits(t,e){let i=0;for(let s=t,r=0;s<e;s++,r++)i|=this.bit(s)<<r;return i}hasVV(){return!1}setVV(t,e){}getVariation(){return{mapAligned:this.mapAligned,pattern:this.pattern,sdf:this.sdf,symbologyType:{value:B[this.symbologyType],options:an,namespace:"SYMBOLOGY_TYPE"}}}getVariationHash(){return this._data&~(nn&this.textureBinding)}}Y.shared=new Y(0);const Xt=n=>class extends n{get vvSizeMinMaxValue(){return this.bit(Ri)!==0}set vvSizeMinMaxValue(t){this.setBit(Ri,t)}get vvSizeScaleStops(){return this.bit(Ai)!==0}set vvSizeScaleStops(t){this.setBit(Ai,t)}get vvSizeFieldStops(){return this.bit(Fi)!==0}set vvSizeFieldStops(t){this.setBit(Fi,t)}get vvSizeUnitValue(){return this.bit(Oi)!==0}set vvSizeUnitValue(t){this.setBit(Oi,t)}hasVV(){return super.hasVV()||this.vvSizeMinMaxValue||this.vvSizeScaleStops||this.vvSizeFieldStops||this.vvSizeUnitValue}setVV(t,e){super.setVV(t,e);const i=rn(this.geometryType,t,e)&t;this.vvSizeMinMaxValue=!!(i&H.SIZE_MINMAX_VALUE),this.vvSizeFieldStops=!!(i&H.SIZE_FIELD_STOPS),this.vvSizeUnitValue=!!(i&H.SIZE_UNIT_VALUE),this.vvSizeScaleStops=!!(i&H.SIZE_SCALE_STOPS)}},ks=n=>class extends n{get vvRotation(){return this.bit(Bi)!==0}set vvRotation(t){this.setBit(Bi,t)}hasVV(){return super.hasVV()||this.vvRotation}setVV(t,e){super.setVV(t,e),this.vvRotation=!e.isOutline&&!!(t&H.ROTATION)}},ge=n=>class extends n{get vvColor(){return this.bit(Wi)!==0}set vvColor(t){this.setBit(Wi,t)}hasVV(){return super.hasVV()||this.vvColor}setVV(t,e){super.setVV(t,e),this.vvColor=!e.isOutline&&!!(t&H.COLOR)}},xe=n=>class extends n{get vvOpacity(){return this.bit(Vi)!==0}set vvOpacity(t){this.setBit(Vi,t)}hasVV(){return super.hasVV()||this.vvOpacity}setVV(t,e){super.setVV(t,e),this.vvOpacity=!e.isOutline&&!!(t&H.OPACITY)}};let et=class extends ge(xe(Xt(Y))){static load(t){const e=this.shared;return e.data=t,e}static from(t){const{symbologyType:e,vvFlags:i}=t,s=this.load(0);return s.geometryType=w.FILL,s.symbologyType=e,e!==B.DOT_DENSITY&&s.setVV(i,t),s.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}};et.shared=new et(0);class wt extends ge(xe(ks(Xt(Y)))){static load(t){const e=this.shared;return e.data=t,e}static from(t){const{symbologyType:e,vvFlags:i}=t,s=this.load(0);return s.geometryType=w.MARKER,s.symbologyType=e,e!==B.HEATMAP&&s.setVV(i,t),s.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvRotation:this.vvRotation,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}wt.shared=new wt(0);let dt=class extends ge(xe(Xt(Y))){static load(t){const e=this.shared;return e.data=t,e}static from(t){const e=this.load(0);return e.geometryType=w.LINE,e.symbologyType=t.symbologyType,e.setVV(t.vvFlags,t),e.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}};dt.shared=new dt(0);let Kt=class extends ge(xe(ks(Xt(Y)))){static load(t){const e=this.shared;return e.data=t,e}static from(t){const e=this.load(0);return e.geometryType=w.TEXT,e.symbologyType=t.symbologyType,e.setVV(t.vvFlags,t),e.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvRotation:this.vvRotation,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}};Kt.shared=new Kt(0);let vt=class extends Xt(Y){static load(t){const e=this.shared;return e.data=t,e}static from(t){const e=this.load(0);return e.geometryType=w.LABEL,e.symbologyType=t.symbologyType,e.setVV(t.vvFlags,t),e.mapAligned=ys(t.placement),e.data}getVariation(){return{...super.getVariation(),vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}};vt.shared=new vt(0);const Q=0,J=100;function Ni(n,t,e){return n[0]=t[0]-e[0],n[1]=t[1]-e[1],n}function Ws(n,t){return Math.sqrt(n*n+t*t)}function Zi(n){const t=Ws(n[0],n[1]);n[0]/=t,n[1]/=t}function hn(n,t){return Ws(n[0]-t[0],n[1]-t[1])}function T(n){return typeof n=="function"}function Be(n=2){return 1/Math.max(n,1)}function mt(n,t){return[!!(n!=null&&n.minScale)&&t.scaleToZoom(n.minScale)||Q,!!(n!=null&&n.maxScale)&&t.scaleToZoom(n.maxScale)||J]}function ln(n,t){return n[t+1]}function Vs(n){return n.length-1}function cn(n){let t=0;for(let e=0;e<Vs(n);e++)t+=un(n,e);return t}function un(n,t,e=1){const[i,s]=ln(n,t);return Math.sqrt(i*i+s*s)*e}let dn=class Re{constructor(t,e,i,s,r){this._segments=t,this._index=e,this._distance=i,this._xStart=s,this._yStart=r,this._done=!1}static create(t){return new Re(t,0,0,t[0][0],t[0][1])}clone(){return new Re(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(t){return this._index===t._index||t._index===this._index-1&&(this._distance===0||t._distance===1)||t._index===this._index+1&&(this._distance===1||t._distance===0)}leq(t){return this._index<t._index||this._index===t._index&&this._distance<=t._distance}geq(t){return this._index>t._index||this._index===t._index&&this._distance>=t._distance}get _segment(){return this._segments[this._index+1]}get angle(){const t=this.dy,e=(0*t+-1*-this.dx)/(1*this.length);let i=Math.acos(e);return t>0&&(i=2*Math.PI-i),i}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){const{dx:t,dy:e}=this;return Math.sqrt(t*t+e*e)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<Vs(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(t,e){const i=this.backwardLength;if(t<=i)return this._distance=(i-t)/this.length,this;let s=this.backwardLength;for(;this.prev();){if(s+this.length>t)return this._seekBackwards(t-s);s+=this.length}return this._distance=0,e?this:null}seek(t,e=!1){if(t<0)return this._seekBackwards(Math.abs(t),e);if(t<=this.remainingLength)return this._distance=(this.backwardLength+t)/this.length,this;let i=this.remainingLength;for(;this.next();){if(i+this.length>t)return this.seek(t-i,e);i+=this.length}return this._distance=1,e?this:null}};function fn(n,t,e,i=!0){const s=cn(n),r=dn.create(n),a=s/2;if(!i)return r.seek(a),void e(r.clone(),0,a+0*t,s);const o=Math.max((s-t)/2,0),h=Math.floor(o/t),l=a-h*t;r.seek(l);for(let u=-h;u<=h;u++)r.x<512&&r.x>=0&&r.y<512&&r.y>=0&&e(r.clone(),u,a+u*t,s),r.seek(t)}function _n(n,t){const e=t;for(let i=0;i<n.length;i++){let s=n[i];const r=[];r.push(s[0]);for(let o=1;o<s.length;o++){let[h,l]=r[o-1];h+=s[o][0],l+=s[o][1],r.push([h,l])}mn(r,e);const a=[];a.push(r[0]);for(let o=1;o<r.length;o++){const[h,l]=r[o-1],[u,c]=r[o],d=Math.round(u-h),f=Math.round(c-l);a.push([d,f])}n[i]=a,s=a}return n}function mn(n,t){if(t<=0)return;const i=n.length;if(i<3)return;const s=[];let r=0;s.push(0);for(let c=1;c<i;c++)r+=hn(n[c],n[c-1]),s.push(r);t=Math.min(t,.2*r);const a=[];a.push(n[0][0]),a.push(n[0][1]);const o=n[i-1][0],h=n[i-1][1],l=Ni([0,0],n[0],n[1]);Zi(l),n[0][0]+=t*l[0],n[0][1]+=t*l[1],Ni(l,n[i-1],n[i-2]),Zi(l),n[i-1][0]+=t*l[0],n[i-1][1]+=t*l[1];for(let c=1;c<i;c++)s[c]+=t;s[i-1]+=t;const u=.5*t;for(let c=1;c<i-1;c++){let d=0,f=0,_=0;for(let m=c-1;m>=0&&!(s[m+1]<s[c]-u);m--){const p=u+s[m+1]-s[c],y=s[m+1]-s[m],g=s[c]-s[m]<u?1:p/y;if(Math.abs(g)<1e-6)break;const M=g*g,b=g*p-.5*M*y,S=g*y/t,L=n[m+1],$=n[m][0]-L[0],P=n[m][1]-L[1];d+=S/b*(L[0]*g*p+.5*M*(p*$-y*L[0])-M*g*y*$/3),f+=S/b*(L[1]*g*p+.5*M*(p*P-y*L[1])-M*g*y*P/3),_+=S}for(let m=c+1;m<i&&!(s[m-1]>s[c]+u);m++){const p=u-s[m-1]+s[c],y=s[m]-s[m-1],g=s[m]-s[c]<u?1:p/y;if(Math.abs(g)<1e-6)break;const M=g*g,b=g*p-.5*M*y,S=g*y/t,L=n[m-1],$=n[m][0]-L[0],P=n[m][1]-L[1];d+=S/b*(L[0]*g*p+.5*M*(p*$-y*L[0])-M*g*y*$/3),f+=S/b*(L[1]*g*p+.5*M*(p*P-y*L[1])-M*g*y*P/3),_+=S}a.push(d/_),a.push(f/_)}a.push(o),a.push(h);for(let c=0,d=0;c<i;c++)n[c][0]=a[d++],n[c][1]=a[d++]}let Bs=class{static getPlacement(t,e,i,s,r){const a=yr(e);if(!a)return null;const o=gr(t);return a.execute(o,e,i,s,r)}};const It=8,N=x(4,4),he=x(4,2),Z=x(4,6),Ui=[he,he,Z,Z],qi=[he,Z,he,Z],pn=[Z,Z,N,N],yn=[N,N,Z,Z],gn=[Z,N,Z,N],xn=[N,Z,N,Z],Rs=n=>class extends n{constructor(...t){super(...t),this._isCIM=!1,this._vertexBoundsScale=1,this.geometryType=w.TEXT,this._aux=I(0,0,this._referenceSize,this._bitset)}bindTextInfo(t,e){t&&t.length?this._shapingInfo=Gt(t,i=>jr(i,e,{scale:this._scale,angle:this._angle,xOffset:this._xOffset,yOffset:this._yOffset,hAlign:this._xAlignD,vAlign:this._yAlignD,maxLineWidth:Math.max(32,Math.min(this._lineWidth,512)),lineHeight:$r*Math.max(.25,Math.min(this._lineHeight,4)),decoration:this._decoration,isCIM:this._isCIM,hasBackground:!!this._backgroundColor,borderLineSize:this._borderLineSize})):this._shapingInfo=null}_write(t,e,i,s){const r=e.getDisplayId();this._writeGeometry(t,e,r,i,s)}_writeGeometry(t,e,i,s,r){const a=this._shapingInfo;if(V(a))return;if(E(this._textPlacement)){const h=r??e.readLegacyGeometryForDisplay();return this._writePlacedText(t,i,h,a,s)}const o=r?He(Ye(r),2):e.geometryType==="esriGeometryPolygon"?e.readCentroid():e.readGeometryForDisplay();if(!V(o)){if(o.isPoint){const[h,l]=o.coords;return!t.hasAggregates&&t.hasPixelBufferEnabled&&(h<0||h>=512||l<0||l>=512)?void 0:this._writeGlyphs(t,i,{x:h,y:l},a)}o.forEachVertex((h,l)=>this._writeGlyphs(t,i,{x:h,y:l},a))}}_writePlacedText(t,e,i,s,r){const a=ue(this._textPlacement),o=Bs.getPlacement(i,a,v(1),t.tileKey,r.geometryEngine);if(!o)return;let h=o.next();for(;h!=null;){const l=-h.getAngle();s.setRotation(l);const u=h.tx,c=-h.ty;u<0||u>=512||c<0||c>=512||(this._writeGlyphs(t,e,{x:u,y:c},s),s.setRotation(-l)),h=o.next()}}_writeGlyphs(t,e,i,s){const r=Y.load(this._materialKey),a=x(Math.round(It*i.x),Math.round(It*i.y)),o=this._vertexBoundsScale,{bounds:h,background:l,glyphs:u}=s;u.length>0&&(this._borderLineColor||this._backgroundColor)&&(r.textureBinding=u[0].textureBinding,t.recordStart(e,r.data,this.geometryType,!0),this._writeBackgroundGeometry(t,e,i,h,l),t.recordEnd());const c=2*Math.max(h.width,h.height);for(const d of s.glyphs)r.textureBinding=d.textureBinding,t.recordStart(e,r.data,this.geometryType,!0),t.vertexBounds(i.x+h.x+this._xOffset,i.y+h.y-this._yOffset,c*o,c*o),this._writeVertices(t,e,a,d),t.recordEnd()}_writeGlyph(t,e,i,s,r){const a=Y.load(this._materialKey),o=x(Math.round(It*i),Math.round(It*s));a.textureBinding=r.textureBinding,t.recordStart(e,a.data,this.geometryType,!0);const h=r.bounds,l=this._vertexBoundsScale;t.vertexBounds(i+h.x*l,s+h.y*l,h.width*l,h.height*l),this._writeVertices(t,e,o,r),t.recordEnd()}_writeVertices(t,e,i,s){const r=t.vertexCount();this._writeVertexCommon(t,e,i,s),t.vertexWrite(s.offsets.upperLeft),t.vertexWrite(s.texcoords.upperLeft),t.vertexEnd(),this._writeVertexCommon(t,e,i,s),t.vertexWrite(s.offsets.upperRight),t.vertexWrite(s.texcoords.upperRight),t.vertexEnd(),this._writeVertexCommon(t,e,i,s),t.vertexWrite(s.offsets.lowerLeft),t.vertexWrite(s.texcoords.lowerLeft),t.vertexEnd(),this._writeVertexCommon(t,e,i,s),t.vertexWrite(s.offsets.lowerRight),t.vertexWrite(s.texcoords.lowerRight),t.vertexEnd(),t.indexWrite(r+0),t.indexWrite(r+1),t.indexWrite(r+2),t.indexWrite(r+1),t.indexWrite(r+3),t.indexWrite(r+2)}_writeVertexCommon(t,e,i,s){const r=this._color,a=this._haloColor,o=I(0,0,this._referenceSize,this._bitset),h=I(0,0,this._size,this._haloSize);t.vertexWrite(i),t.vertexWrite(e),t.vertexWrite(r),t.vertexWrite(a),t.vertexWrite(h),t.vertexWrite(o),t.vertexWrite(this._minMaxZoom)}_writeBackgroundVertex(t,e,i,s,r,a){const o=I(0,1,this._referenceSize,this._bitset),h=I(0,0,this._size,this._haloSize),l=I(0,0,0,0);t.vertexWrite(i),t.vertexWrite(e),t.vertexWrite(s),t.vertexWrite(l),t.vertexWrite(h),t.vertexWrite(o),t.vertexWrite(this._minMaxZoom),t.vertexWrite(r),t.vertexWrite(a),t.vertexEnd()}_writeBackgroundQuad(t,e,i,s,r,a){const o=t.vertexCount();this._writeBackgroundVertex(t,e,i,s,r.upperLeft,a[0]),this._writeBackgroundVertex(t,e,i,s,r.upperRight,a[1]),this._writeBackgroundVertex(t,e,i,s,r.lowerLeft,a[2]),this._writeBackgroundVertex(t,e,i,s,r.lowerRight,a[3]),t.indexWrite(o+0),t.indexWrite(o+1),t.indexWrite(o+2),t.indexWrite(o+1),t.indexWrite(o+3),t.indexWrite(o+2)}_writeBackgroundGeometry(t,e,i,s,r){const a=x(Math.round(It*i.x),Math.round(It*i.y)),{x:o,y:h,width:l,height:u}=s,c=2*Math.max(l,u);if(t.vertexBounds(i.x+o+this._xOffset,i.y+h-this._yOffset,c*this._vertexBoundsScale,c*this._vertexBoundsScale),this._backgroundColor){const d=[N,N,N,N];this._writeBackgroundQuad(t,e,a,this._backgroundColor,r.main,d)}if(this._borderLineColor||this._backgroundColor){const d=!!this._borderLineColor&&!!this._borderLineSize&&this._borderLineSize>0,[f,_,m,p,y]=d?[Ui,Ui,qi,qi,this._borderLineColor]:[pn,yn,gn,xn,this._backgroundColor];this._writeBackgroundQuad(t,e,a,y,r.top,f),this._writeBackgroundQuad(t,e,a,y,r.bot,_),this._writeBackgroundQuad(t,e,a,y,r.left,m),this._writeBackgroundQuad(t,e,a,y,r.right,p)}}};let Ht=class{constructor(){this._materialKey=null}bindFeature(t,e,i){}write(t,e,i,s){var o;if(V(this._effects)||((o=this._effects)==null?void 0:o.length)===0)return this._write(t,e,s);const r=we.executeEffects(this._effects,e.readLegacyGeometryForDisplay(),t.tileKey,s.geometryEngine);let a=we.next(r);for(;a;)this._write(t,e,s,a),a=we.next(r)}_write(t,e,i,s){}};const vn=5;let Ae=class Fe extends Rs(Ht){constructor(t,e,i,s,r,a,o,h,l,u,c,d,f,_,m,p,y,g,M,b,S,L,$,P){super(),this._xOffset=v(f),this._yOffset=v(_),this._decoration=u||"none",this._backgroundColor=L,this._borderLineColor=$,this._borderLineSize=P,this._color=r,this._haloColor=a,this._haloSize=Math.min(Math.floor(vn*v(Qs(i))),127),this._size=Math.min(Math.round(v(e)),127);const U=Math.min(Math.round(v(s||e)),127);this._referenceSize=Math.round(Math.sqrt(256*U)),this._scale=this._size/ws,this._angle=d,this._justify=xr(o||"center"),this._xAlignD=gs(o||"center"),this._yAlignD=xs(h||"baseline"),this._baseline=(h||"baseline")==="baseline",this._bitset=(l===X.MAP?1:0)|(c?1:0)<<1;const q=Y.load(t);q.sdf=!0,this._materialKey=q.data,this._lineWidth=v(m)||512,this._lineHeight=p||1,this._textPlacement=y,this._effects=g,this._isCIM=M??!1,this._minMaxZoom=x(Math.round(b*R),Math.round(S*R))}static fromText(t,e){var a,o;const i=(a=t.font)==null?void 0:a.size,s=new Fe(t.materialKey,i,t.haloSize||0,i,t.color&&G(t.color)||0,t.haloColor&&G(t.haloColor)||0,t.horizontalAlignment,t.verticalAlignment,X.SCREEN,(o=t.font)==null?void 0:o.decoration,!1,t.angle||0,t.xoffset||0,t.yoffset||0,t.lineWidth||0,t.lineHeight||0,null,null,!1,Q,J,t.backgroundColor&&G(t.backgroundColor),t.borderLineColor&&G(t.borderLineColor),t.borderLineSize),[,r]=Pe(t.text);return s.bindTextInfo(e??[],r),s._vertexBoundsScale=t.maxVVSize&&i?t.maxVVSize/i:1,s}static fromCIMText(t,e,i){const s=t.scaleFactor||1,r=t.size*t.sizeRatio*s,[a,o]=mt(t.scaleInfo,i),h=new Fe(t.materialKey,r,t.outlineSize*t.sizeRatio,t.referenceSize,z(t.color),z(t.outlineColor),t.horizontalAlignment,t.verticalAlignment,t.alignment,t.decoration,t.colorLocked??!1,t.angle,t.offsetX*t.sizeRatio*s,t.offsetY*t.sizeRatio*s,512,1,t.markerPlacement,t.effects,!0,a,o,t.backgroundColor?z(t.backgroundColor):void 0,t.borderLineColor?z(t.borderLineColor):void 0,t.borderLineWidth),[,l]=Pe(t.text);return h.bindTextInfo(e,l),h._vertexBoundsScale=t.maxVVSize?t.maxVVSize/r:1,h}};const As=Bt.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),Mn=(n,t="mapview-labeling")=>As.error(new _t(t,n)),se=1,zt=0,wn=4,Te=25;function bn(n,t){const e=!!n.minScale&&t.scaleToZoom(n.minScale)||0;return fs(e,0,25.5)}function Sn(n,t){const e=!!n.maxScale&&t.scaleToZoom(n.maxScale)||255;return fs(e,0,25.5)}function Tn(n){const t=new Map;return e=>(t.has(e)||t.set(e,n(e)),t.get(e))}const Ln=Tn(n=>{let t=0;if(n===0)return 1/0;for(;!(n%2);)t++,n/=2;return t}),re=n=>Math.floor(127*n+127),pt=n=>Math.floor(10*n),lt=n=>Math.round(n*(254/360));let Xi=class Fs extends Ae{constructor(t,e,i,s){var c,d,f;super(t,(c=i.font)==null?void 0:c.size,i.haloSize||0,(d=i.font)==null?void 0:d.size,i.color&&G(i.color)||0,i.haloColor&&G(i.haloColor)||0,i.horizontalAlignment,i.verticalAlignment,ys(e.labelPlacement)?X.MAP:X.SCREEN,(f=i.font)==null?void 0:f.decoration,!1,i.angle||0,i.xoffset,i.yoffset,i.lineWidth,i.lineHeight,null,null,!1,null,null,i.backgroundColor&&G(i.backgroundColor),i.borderLineColor&&G(i.borderLineColor),i.borderLineSize),this._outLineLabelAngle=0,this._refPlacementPadding=0,this._refPlacementDirX=0,this._refPlacementDirY=0,this._refOffsetX=0,this._refOffsetY=0,this._zoomLevel=0,this.geometryType=w.LABEL,this._allowOverrun=e.allowOverrun??!1,this._repeatLabel=e.repeatLabel??!0,this._labelPosition=e.labelPosition??"curved";const r=bn(e,s),a=Sn(e,s),o=e.labelPlacement,[h,l]=vr(o);this._xAlignD=h,this._yAlignD=l,this._minZoom=r,this._maxZoom=a,this._minBackgroundZoom=r,this._maxBackgroundZoom=a,this._refPlacementPadding=v(i.haloSize)+Pr,this._repeatLabelDistance=e.repeatLabelDistance?v(e.repeatLabelDistance):128;const u=vt.load(t);u.sdf=!0,this._materialKey=u.data}static fromLabelClass(t,e){if(t.labelPlacement==="esriServerLinePlacementCenterAlong"){const i=t.symbol;i.xoffset=0,i.yoffset=0,i.angle=0,i.font.decoration="none"}return new Fs(t.materialKey,t,t.symbol,e)}get _shapedBox(){return ue(this._shapingInfo).bounds}setZoomLevel(t){this._zoomLevel=t}bindReferenceTemplate(t){let e=Mr(this._xAlignD),i=wr(this._yAlignD);if(this._refOffsetX=0,this._refOffsetY=0,V(t))return void(this._refSymbolAndPlacementOffset=I(0,0,re(e),re(i)));if(t.boundsType==="circle"&&(e||i)){const a=Math.sqrt(e*e+i*i);e/=a,i/=a}const s=Math.max(t.height,t.width),r=this._refPlacementPadding*wn;this._refSymbolAndPlacementOffset=I(r,s,re(e),re(i)),this._referenceSize=s,this._refPlacementDirX=e,this._refPlacementDirY=i,this._refOffsetX=t.xOffset,this._refOffsetY=t.yOffset}_write(t,e){if(V(this._shapingInfo))return;const i=this._shapingInfo,s=e.getDisplayId(),r=e.geometryType==="esriGeometryPolygon"?e.readLegacyCentroid():e.readLegacyGeometry();if(r)switch(this._current={out:t,inId:s,inShaping:i,zoomLevel:this._zoomLevel},e.geometryType==="esriGeometryPolyline"&&this._labelPosition==="curved"&&(this._borderLineColor||this._backgroundColor)&&As.warnOnce("TextSymbol properties 'borderLineColor', 'borderLineSize', and 'backgroundColor' are not supported in curved labels"),e.geometryType){case"esriGeometryPolyline":this._placeLineLabels(r);break;case"esriGeometryPoint":case"esriGeometryPolygon":this._placePointLabels(r);break;default:Mn(`Geometry of type ${e.geometryType} is not supported`)}}_isVisible(t,e){const i=pt(this._current.zoomLevel);return pt(t)<=i&&i<=pt(e)}_placePointLabels(t){const{out:e,inId:i,inShaping:s}=this._current;this._writeGlyphs(e,i,t,s)}_placeLineLabels(t){const e=_n(t.paths,this._current.inShaping.bounds.width),i=this._placeSubdivGlyphs.bind(this),s=(this._shapedBox.width+this._repeatLabelDistance)/(1<<se);for(const r of e)fn(r,s,i,this._repeatLabel)}_placeSubdivGlyphs(t,e,i,s){const r=Ln(e),a=this._shapedBox.width/(1<<se),o=Math.sqrt(this._repeatLabelDistance)/(1<<se),h=Math.min(i,s-i),l=this._current.inShaping.isMultiline?Te:Math.log2(h/(o+a/2)),u=e===0?l:Math.min(r,l),c=Math.max(this._minZoom,this._current.zoomLevel+se-u),d=this._current.zoomLevel-c,f=this._shapedBox.width/2*2**d;this._current.inShaping.isMultiline?e===0&&this._placeStraight(t,c):this._allowOverrun&&d<0?this._placeStraightAlong(t,this._minZoom):this._labelPosition==="parallel"?this._placeStraightAlong(t,c):this._labelPosition==="curved"&&this._placeCurved(t,c,f)}_placeStraight(t,e){const{out:i,inId:s,inShaping:r}=this._current,a=Math.ceil(t.angle*(180/Math.PI)%360),o=Math.ceil((t.angle*(180/Math.PI)+180)%360);this._outLineLabelAngle=lt(a),this._writeGlyphs(i,s,t,r,e),this._outLineLabelAngle=lt(o),this._writeGlyphs(i,s,t,r,e)}_placeCurved(t,e,i){const{out:s,inId:r}=this._current;s.metricStart(r,e,t.x,t.y,0,0,0,0);const a=t.clone(),o=t.angle*(180/Math.PI)%360,h=(t.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=lt(o),this._placeFirst(a,e,1),this._placeBack(t,a,e,i,1),this._placeForward(t,a,e,i,1),this._outLineLabelAngle=lt(h),this._placeFirst(a,e,0),this._placeBack(t,a,e,i,0),this._placeForward(t,a,e,i,0),s.metricEnd()}_placeStraightAlong(t,e){const{out:i,inId:s,inShaping:r}=this._current;i.metricStart(s,e,t.x,t.y,0,0,0,0);const a=t.clone(),o=t.angle*(180/Math.PI)%360,h=(t.angle*(180/Math.PI)+180)%360,l=r.glyphs.length>0&&(this._borderLineColor||this._backgroundColor);if(this._maxBackgroundZoom=Te,this._minBackgroundZoom=Math.max(e,0),l){const u=vt.load(this._materialKey);u.textureBinding=r.glyphs[0].textureBinding;const c=qe(rt(),-t.angle),[d,f]=r.shapeBackground(c);this._outLineLabelAngle=lt(o),i.recordStart(s,u.data,this.geometryType,!0),this._writeBackgroundGeometry(i,s,t,d,f),i.recordEnd(),this._outLineLabelAngle=lt(h),i.recordStart(s,u.data,this.geometryType,!0),this._writeBackgroundGeometry(i,s,t,d,f),i.recordEnd()}this._outLineLabelAngle=lt(o),this._placeFirst(a,e,1,!0),this._outLineLabelAngle=lt(h),this._placeFirst(a,e,0,!0),i.metricEnd()}_placeBack(t,e,i,s,r){const a=t.clone();let o=t.backwardLength+zt;for(;a.prev()&&!(o>=s);)this._placeOnSegment(a,e,o,i,-1,r),o+=a.length+zt}_placeForward(t,e,i,s,r){const a=t.clone();let o=t.remainingLength+zt;for(;a.next()&&!(o>=s);)this._placeOnSegment(a,e,o,i,1,r),o+=a.length+zt}_placeFirst(t,e,i,s=!1){const r=t,a=this._current.inShaping,o=a.glyphs,h=this._current.zoomLevel,{out:l,inId:u}=this._current;for(const c of o){const d=c.x>a.bounds.x?i:1-i,f=d*t.remainingLength+(1-d)*t.backwardLength,_=Math.abs(c.x+c.width/2-a.bounds.x),m=Math.max(0,h+Math.log2(_/(f+zt))),p=Math.max(e,s?0:m);if(c.maxZoom=Te,c.angle=t.angle+(1-i)*Math.PI,c.minZoom=p,this._writeGlyph(l,u,r.x,r.y,c),i&&this._isVisible(c.minZoom,c.maxZoom)){const y=c.bounds;l.metricBoxWrite(y.center[0],y.center[1],y.width,y.height)}}}_placeOnSegment(t,e,i,s,r,a){const o=this._current.inShaping.glyphs,{out:h,inId:l}=this._current,u=this._current.inShaping,c=this._current.zoomLevel,d=t.dx/t.length,f=t.dy/t.length,_={x:t.x+i*-r*d,y:t.y+i*-r*f};for(const m of o){const p=m.x>u.bounds.x?a:1-a;if(!(p&&r===1||!p&&r===-1))continue;const y=Math.abs(m.x+m.width/2-u.bounds.x),g=Math.max(0,c+Math.log2(y/i)-.1),M=Math.max(s,c+Math.log2(y/(i+t.length+zt)));if(g!==0&&(m.angle=t.angle+(1-a)*Math.PI,m.minZoom=M,m.maxZoom=g,this._writeGlyph(h,l,_.x,_.y,m),a&&this._isVisible(m.minZoom,m.maxZoom))){const b=m.bounds,S=t.x-e.x,L=t.y-e.y;h.metricBoxWrite(b.center[0]+S,b.center[1]+L,b.width,b.height)}}}_writeGlyphs(t,e,i,s,r=this._minZoom){if(i.x<0||i.x>=512||i.y<0||i.y>=512)return;if(s.glyphs.length>0&&(this._borderLineColor||this._backgroundColor)){const c=vt.load(this._materialKey);c.textureBinding=s.glyphs[0].textureBinding,t.recordStart(e,c.data,this.geometryType,!0),this._writeBackgroundGeometry(t,e,i,s.bounds,s.background),t.recordEnd()}const a=i.x+this._refOffsetX,o=i.y-this._refOffsetY;for(const c of s.glyphs)c.minZoom=r,c.maxZoom=this._maxZoom,this._writeGlyph(t,e,a,o,c);const h=this._refPlacementDirX,l=this._refPlacementDirY,u=s.boundsT;t.metricStart(e,r,a,o,h,l,this._referenceSize,this._materialKey),t.metricBoxWrite(u.center[0],u.center[1],u.width,u.height),t.metricEnd()}_writeVertexCommon(t,e,i,s){const r=this._color,a=this._haloColor,o=I(0,0,this._size,this._haloSize),h=Math.max(s.minZoom,this._minZoom),l=Math.min(s.maxZoom,this._maxZoom),u=I(pt(h),pt(l),this._outLineLabelAngle,0);t.vertexWrite(i),t.vertexWrite(e),t.vertexWrite(r),t.vertexWrite(a),t.vertexWrite(o),t.vertexWrite(this._refSymbolAndPlacementOffset),t.vertexWrite(u)}_writeBackgroundVertex(t,e,i,s,r,a){const o=I(0,0,this._size,this._haloSize),h=I(0,0,0,0),l=I(pt(this._minBackgroundZoom),pt(this._maxBackgroundZoom),this._outLineLabelAngle,1);t.vertexWrite(i),t.vertexWrite(e),t.vertexWrite(s),t.vertexWrite(h),t.vertexWrite(o),t.vertexWrite(this._refSymbolAndPlacementOffset),t.vertexWrite(l),t.vertexWrite(r),t.vertexWrite(a),t.vertexEnd()}};const Hi=3.14159265359/180,Yi=8,Os=n=>class extends n{constructor(...t){super(...t),this.angle=0,this.xOffset=0,this.yOffset=0,this.width=0,this.height=0,this.boundsType="square",this._anchorX=0,this._anchorY=0,this._computedWidth=0,this._computedHeight=0,this._allowBorrowing=!0,this._vertexBoundsScaleX=1,this._vertexBoundsScaleY=1,this._offsets={xUpperLeft:0,yUpperLeft:0,xUpperRight:0,yUpperRight:0,xBottomLeft:0,yBottomLeft:0,xBottomRight:0,yBottomRight:0},this.geometryType=w.MARKER}_write(t,e,i,s){const r=e.getDisplayId();t.recordStart(r,this._materialKey,this.geometryType,!0),this._writeGeometry(t,e,r,i,s),t.recordEnd()}_writeGeometry(t,e,i,s,r){if(E(this._markerPlacement))return this._writePlacedMarkers(t,e,s,r);if(this._allowBorrowing=!0,!r&&e.geometryType==="esriGeometryPoint"){const o=e.getX(),h=e.getY();return!t.hasAggregates&&t.hasPixelBufferEnabled&&(o<0||o>=513||h<0||h>=513)?void 0:this._writeVertices(t,i,this._getPos(o,h),o,h)}const a=r?He(Ye(r),2):e.geometryType==="esriGeometryPolygon"?e.readCentroid():e.readGeometryForDisplay();if(!V(a)){if(a.isPoint){const[o,h]=a.coords;return!t.hasAggregates&&t.hasPixelBufferEnabled&&(o<0||o>=512||h<0||h>=512)?void 0:this._writeVertices(t,i,this._getPos(o,h),o,h)}a.forEachVertex((o,h)=>{const l=2*Mt;o<-l||o>=l||h<-l||h>=l||this._writeVertices(t,i,this._getPos(o,h),o,h)})}}_writePlacedMarkers(t,e,i,s){const r=s??e.readLegacyGeometryForDisplay(),a=Bs.getPlacement(r,ue(this._markerPlacement),v(1),t.tileKey,i.geometryEngine);if(!a)return;this._allowBorrowing=e.geometryType!=="esriGeometryPolygon";const o=e.getDisplayId(),h=Wt(),l=rt(),u=-128,c=640;let d=a.next();for(;d!=null;){const f=d.tx,_=-d.ty;f>=u&&f<=c&&_>=u&&_<=c&&(this._applyTransformation(l,h,-d.getAngle()/Hi),this._writeVertices(t,o,this._getPos(f,_),f,_)),d=a.next()}}_writeVertices(t,e,i,s,r){const a=wt.load(this._materialKey);return a.symbologyType===B.HEATMAP?this._writeHeatmapVertices(t,e,i):this._writeMarkerVertices(t,e,a,i,s,r)}_writeMarkerVertices(t,e,i,s,r,a){const o=i.vvRotation,h=t.vertexCount();let l=this._computedWidth*this._vertexBoundsScaleX,u=this._computedHeight*this._vertexBoundsScaleY;if(this.angle){const c=Math.max(l,u);l=c,u=c}if(o){const c=Math.max(this.xOffset,this.yOffset);l+=c,u+=c}this._allowBorrowing&&t.vertexBounds(r+this.xOffset,a-this.yOffset,l,u),t.vertexWrite(s),t.vertexWrite(this._offsetUpperLeft),t.vertexWrite(this._texUpperLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(s),t.vertexWrite(this._offsetUpperRight),t.vertexWrite(this._texUpperRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(s),t.vertexWrite(this._offsetBottomLeft),t.vertexWrite(this._texBottomLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(s),t.vertexWrite(this._offsetBottomRight),t.vertexWrite(this._texBottomRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),this._writeIndices(t,h)}_writeHeatmapVertices(t,e,i){const s=t.vertexCount();t.vertexWrite(i),t.vertexWrite(this._offsetUpperLeft),t.vertexWrite(e),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetUpperRight),t.vertexWrite(e),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomLeft),t.vertexWrite(e),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomRight),t.vertexWrite(e),t.vertexEnd(),this._writeIndices(t,s)}_writeIndices(t,e){t.indexWrite(e+0),t.indexWrite(e+1),t.indexWrite(e+2),t.indexWrite(e+1),t.indexWrite(e+3),t.indexWrite(e+2)}_applyTransformation(t,e,i=0){Js(t,hs(this.xOffset,-this.yOffset)),this.angle!=null&&this.angle+i!==0&&$e(t,t,Hi*(this.angle+i));const s=this._computedWidth,r=this._computedHeight,a=-(.5+this._anchorX)*s,o=-(.5-this._anchorY)*r;ut(e,a,o),Et(e,e,t),this._offsetUpperLeft=x(16*e[0],16*e[1]),this._offsets.xUpperLeft=e[0],this._offsets.yUpperLeft=e[1],ut(e,a+s,o),Et(e,e,t),this._offsetUpperRight=x(16*e[0],16*e[1]),this._offsets.xUpperRight=e[0],this._offsets.yUpperRight=e[1],ut(e,a,o+r),Et(e,e,t),this._offsetBottomLeft=x(16*e[0],16*e[1]),this._offsets.xBottomLeft=e[0],this._offsets.yBottomLeft=e[1],ut(e,a+s,o+r),Et(e,e,t),this._offsetBottomRight=x(16*e[0],16*e[1]),this._offsets.xBottomRight=e[0],this._offsets.yBottomRight=e[1]}_getPos(t,e){return x(Math.round(Yi*t),Math.round(Yi*e))}};let Ft=class Ot extends Os(Ht){constructor(t,e,i,s,r,a,o,h,l,u,c,d,f,_,m,p,y,g,M,b,S,L,$){super(),this.angle=s,this.height=o,this.width=a,this.xOffset=e*M,this.yOffset=i*M,this._markerPlacement=b,this._effects=S,this._anchorX=p,this._anchorY=y,this._minMaxZoom=x(Math.round(L*R),Math.round($*R));const P=(_===X.MAP?Cr:Er)|(c?xt:0)|(f?kr:0)|(d?Wr:0),U=m&&m.sdf,q=wt.load(t);q.sdf=U,q.pattern=!0,q.textureBinding=m.textureBinding,this._materialKey=q.data,this._fillColor=r,this._outlineColor=l,this._sizeOutlineWidth=I(Math.round(Math.min(Math.sqrt(128*a),255)),Math.round(Math.min(Math.sqrt(128*o),255)),Math.round(Math.min(Math.sqrt(128*u),255)),Math.round(Math.min(Math.sqrt(128*h),255)));const nt=m.rect.x+C,j=m.rect.y+C,bt=nt+m.width,St=j+m.height;this._offsets.xUpperLeft=nt,this._offsets.yUpperLeft=j,this._offsets.xUpperRight=bt,this._offsets.yUpperRight=j,this._offsets.xBottomLeft=nt,this._offsets.yBottomLeft=St,this._offsets.xBottomRight=bt,this._offsets.yBottomRight=St,q.symbologyType===B.PIE_CHART?(this._texUpperLeft=x(0,1),this._texUpperRight=x(1,1),this._texBottomLeft=x(0,0),this._texBottomRight=x(1,0)):(this._texUpperLeft=x(nt,j),this._texUpperRight=x(bt,j),this._texBottomLeft=x(nt,St),this._texBottomRight=x(bt,St)),a*=g,o*=g,a*=M,o*=M;const Hs=Math.round(64*g);this._bitestAndDistRatio=x(P,Hs),this._computedWidth=a,this._computedHeight=o;const Ys=Wt(),js=rt();this._applyTransformation(js,Ys)}static fromCIMMarker(t,e,i){const s=e&&e.width||1,r=e&&e.height||1,a=t.size,o=s/r*t.scaleX,h=t.scaleSymbolsProportionally&&t.frameHeight?a/t.frameHeight:1,l=z(t.color),u=z(t.outlineColor),c=v(a),d=c*o,f=v(t.offsetX||0),_=v(t.offsetY||0),m=v(t.outlineWidth||0)*h,p=t.alignment||X.SCREEN,y=v(t.referenceSize),[g,M]=mt(t.scaleInfo,i);let b=t.rotation||0;t.rotateClockwise||(b=-b);let S=0,L=0;const $=t.anchorPoint;$&&(t.isAbsoluteAnchorPoint?a&&(S=$.x/(a*o),L=$.y/a):(S=$.x,L=$.y));const P=new Ot(t.materialKey,f,_,b,l,d,c,y,u,m,t.colorLocked,t.scaleSymbolsProportionally,!1,p,e,S,L,t.sizeRatio,ae(t.scaleFactor,1),t.markerPlacement,t.effects,g,M);return P._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/d:1,P._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/c:1,P}static fromPictureMarker(t,e){const i=Math.round(v(t.width)),s=Math.round(v(t.height)),r=bs,a=Math.round(v(t.xoffset||0)),o=Math.round(v(t.yoffset||0)),h=new Ot(t.materialKey,a,o,t.angle,r,i,s,s,0,0,!1,!1,!1,X.SCREEN,e,0,0,1,1,null,null,Q,J);return h._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/t.width:1,h._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/t.height:1,h}static fromSimpleMarker(t,e){const i=G(t.color),s=Math.round(v(t.size)),r=s,a=Math.round(v(t.xoffset||0)),o=Math.round(v(t.yoffset||0)),h=t.style,l=t.outline,u=0|((l==null?void 0:l.color)&&G(l.color)),c=0|((l==null?void 0:l.width)&&Math.round(v(l.width))),d=new Ot(t.materialKey,a,o,t.angle,i,s,r,r,u,c,!1,!1,h==="esriSMSCross"||h==="esriSMSX",X.SCREEN,e,0,0,126/64,1,null,null,Q,J);return d.boundsType=h==="esriSMSCircle"?"circle":"square",d._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/t.size:1,d._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/t.size:1,d}static fromLineSymbolMarker(t,e){const i=G(t.color),s=6,r=Math.round(v(s*t.lineWidth)),a=r,o=t.style==="cross"||t.style==="x";let h;switch(t.placement){case"begin-end":h=Qt.Both;break;case"begin":h=Qt.JustBegin;break;case"end":h=Qt.JustEnd;break;default:h=Qt.None}const l={type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:h,offsetAlongLine:0},u=new Ot(t.materialKey,0,0,0,i,r,a,a/s,i,o?Math.round(v(t.lineWidth)):0,!1,!1,o,X.MAP,e,0,0,126/64,1,l,null,Q,J);return u.boundsType=t.style==="circle"?"circle":"square",u}};function In(n,t,e,i,s,r,a){Ge=0;const o=(i-e)*r,h=s&&s.length,l=h?(s[0]-e)*r:o;let u,c,d,f,_,m=Ds(t,e,i,0,l,r,!0);if(m&&m.next!==m.prev){if(h&&(m=Cn(t,e,i,s,m,r)),o>80*r){u=d=t[0+e*r],c=f=t[1+e*r];for(let p=r;p<l;p+=r){const y=t[p+e*r],g=t[p+1+e*r];u=Math.min(u,y),c=Math.min(c,g),d=Math.max(d,y),f=Math.max(f,g)}_=Math.max(d-u,f-c),_=_!==0?1/_:0}Zt(m,n,r,u,c,_,a,0)}}function Ds(n,t,e,i,s,r,a){let o;if(a===Bn(n,t,e,i,s,r)>0)for(let h=i;h<s;h+=r)o=ji(h+t*r,n[h+t*r],n[h+1+t*r],o);else for(let h=s-r;h>=i;h-=r)o=ji(h+t*r,n[h+t*r],n[h+1+t*r],o);return o&&gt(o,o.next)&&(Ut(o),o=o.next),o}function Nt(n,t=n){if(!n)return n;let e,i=n;do if(e=!1,i.steiner||!gt(i,i.next)&&k(i.prev,i,i.next)!==0)i=i.next;else{if(Ut(i),i=t=i.prev,i===i.next)break;e=!0}while(e||i!==t);return t}function Zt(n,t,e,i,s,r,a,o){if(!n)return;!o&&r&&(n=Gs(n,i,s,r));let h=n;for(;n.prev!==n.next;){const l=n.prev,u=n.next;if(r?$n(n,i,s,r):zn(n))t.push(l.index/e+a),t.push(n.index/e+a),t.push(u.index/e+a),Ut(n),n=u.next,h=u.next;else if((n=u)===h){o?o===1?Zt(n=An(n,t,e,a),t,e,i,s,r,a,2):o===2&&Fn(n,t,e,i,s,r,a):Zt(Nt(n),t,e,i,s,r,a,1);break}}}function zn(n){const t=n.prev,e=n,i=n.next;if(k(t,e,i)>=0)return!1;let s=n.next.next;const r=s;let a=0;for(;s!==n.prev&&(a===0||s!==r);){if(a++,kt(t.x,t.y,e.x,e.y,i.x,i.y,s.x,s.y)&&k(s.prev,s,s.next)>=0)return!1;s=s.next}return!0}function $n(n,t,e,i){const s=n.prev,r=n,a=n.next;if(k(s,r,a)>=0)return!1;const o=s.x<r.x?s.x<a.x?s.x:a.x:r.x<a.x?r.x:a.x,h=s.y<r.y?s.y<a.y?s.y:a.y:r.y<a.y?r.y:a.y,l=s.x>r.x?s.x>a.x?s.x:a.x:r.x>a.x?r.x:a.x,u=s.y>r.y?s.y>a.y?s.y:a.y:r.y>a.y?r.y:a.y,c=Oe(o,h,t,e,i),d=Oe(l,u,t,e,i);let f=n.prevZ,_=n.nextZ;for(;f&&f.z>=c&&_&&_.z<=d;){if(f!==n.prev&&f!==n.next&&kt(s.x,s.y,r.x,r.y,a.x,a.y,f.x,f.y)&&k(f.prev,f,f.next)>=0||(f=f.prevZ,_!==n.prev&&_!==n.next&&kt(s.x,s.y,r.x,r.y,a.x,a.y,_.x,_.y)&&k(_.prev,_,_.next)>=0))return!1;_=_.nextZ}for(;f&&f.z>=c;){if(f!==n.prev&&f!==n.next&&kt(s.x,s.y,r.x,r.y,a.x,a.y,f.x,f.y)&&k(f.prev,f,f.next)>=0)return!1;f=f.prevZ}for(;_&&_.z<=d;){if(_!==n.prev&&_!==n.next&&kt(s.x,s.y,r.x,r.y,a.x,a.y,_.x,_.y)&&k(_.prev,_,_.next)>=0)return!1;_=_.nextZ}return!0}function ji(n,t,e,i){const s=Vt.create(n,t,e);return i?(s.next=i.next,s.prev=i,i.next.prev=s,i.next=s):(s.prev=s,s.next=s),s}function Ut(n){n.next.prev=n.prev,n.prev.next=n.next,n.prevZ&&(n.prevZ.nextZ=n.nextZ),n.nextZ&&(n.nextZ.prevZ=n.prevZ)}function Pn(n){let t=n,e=n;do(t.x<e.x||t.x===e.x&&t.y<e.y)&&(e=t),t=t.next;while(t!==n);return e}function Cn(n,t,e,i,s,r){const a=new Array;for(let o=0,h=i.length;o<h;o++){const l=Ds(n,t,e,i[o]*r,o<h-1?i[o+1]*r:e*r,r,!1);l===l.next&&(l.steiner=!0),a.push(Pn(l))}a.sort(Rn);for(const o of a)s=En(o,s);return s}function En(n,t){const e=kn(n,t);if(!e)return t;const i=Ns(e,n);return Nt(i,i.next),Nt(e,e.next)}function kn(n,t){let e=t;const i=n.x,s=n.y;let r,a=-1/0;do{if(s<=e.y&&s>=e.next.y&&e.next.y!==e.y){const d=e.x+(s-e.y)*(e.next.x-e.x)/(e.next.y-e.y);if(d<=i&&d>a){if(a=d,d===i){if(s===e.y)return e;if(s===e.next.y)return e.next}r=e.x<e.next.x?e:e.next}}e=e.next}while(e!==t);if(!r)return null;if(i===a)return r.prev;const o=r,h=r.x,l=r.y;let u,c=1/0;for(e=r.next;e!==o;)i>=e.x&&e.x>=h&&i!==e.x&&kt(s<l?i:a,s,h,l,s<l?a:i,s,e.x,e.y)&&(u=Math.abs(s-e.y)/(i-e.x),(u<c||u===c&&e.x>r.x)&&qt(e,n)&&(r=e,c=u)),e=e.next;return r}function Gs(n,t,e,i){let s;for(;s!==n;s=s.next){if(s=s||n,s.z===null&&(s.z=Oe(s.x,s.y,t,e,i)),s.prev.next!==s||s.next.prev!==s)return s.prev.next=s,s.next.prev=s,Gs(n,t,e,i);s.prevZ=s.prev,s.nextZ=s.next}return n.prevZ.nextZ=null,n.prevZ=null,Wn(n)}function Wn(n){let t,e=1;for(;;){let i,s=n;n=null,t=null;let r=0;for(;s;){r++,i=s;let a=0;for(;a<e&&i;a++)i=i.nextZ;let o=e;for(;a>0||o>0&&i;){let h;a===0?(h=i,i=i.nextZ,o--):o!==0&&i?s.z<=i.z?(h=s,s=s.nextZ,a--):(h=i,i=i.nextZ,o--):(h=s,s=s.nextZ,a--),t?t.nextZ=h:n=h,h.prevZ=t,t=h}s=i}if(t.nextZ=null,e*=2,r<2)return n}}function k(n,t,e){return(t.y-n.y)*(e.x-t.x)-(t.x-n.x)*(e.y-t.y)}function Ks(n,t,e,i){return!!(gt(n,t)&&gt(e,i)||gt(n,i)&&gt(e,t))||k(n,t,e)>0!=k(n,t,i)>0&&k(e,i,n)>0!=k(e,i,t)>0}function Vn(n,t){let e=n;do{if(e.index!==n.index&&e.next.index!==n.index&&e.index!==t.index&&e.next.index!==t.index&&Ks(e,e.next,n,t))return!0;e=e.next}while(e!==n);return!1}function Bn(n,t,e,i,s,r){let a=0;for(let o=i,h=s-r;o<s;o+=r)a+=(n[h+t*r]-n[o+t*r])*(n[o+1+t*r]+n[h+1+t*r]),h=o;return a}function kt(n,t,e,i,s,r,a,o){return(s-a)*(t-o)-(n-a)*(r-o)>=0&&(n-a)*(i-o)-(e-a)*(t-o)>=0&&(e-a)*(r-o)-(s-a)*(i-o)>=0}function qt(n,t){return k(n.prev,n,n.next)<0?k(n,t,n.next)>=0&&k(n,n.prev,t)>=0:k(n,t,n.prev)<0||k(n,n.next,t)<0}function Oe(n,t,e,i,s){return(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=32767*(n-e)*s)|n<<8))|n<<4))|n<<2))|n<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*s)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function gt(n,t){return n.x===t.x&&n.y===t.y}function Rn(n,t){return n.x-t.x}function An(n,t,e,i){let s=n;do{const r=s.prev,a=s.next.next;!gt(r,a)&&Ks(r,s,s.next,a)&&qt(r,a)&&qt(a,r)&&(t.push(r.index/e+i),t.push(s.index/e+i),t.push(a.index/e+i),Ut(s),Ut(s.next),s=n=a),s=s.next}while(s!==n);return s}function Fn(n,t,e,i,s,r,a){let o=n;do{let h=o.next.next;for(;h!==o.prev;){if(o.index!==h.index&&On(o,h)){let l=Ns(o,h);return o=Nt(o,o.next),l=Nt(l,l.next),Zt(o,t,e,i,s,r,a,0),void Zt(l,t,e,i,s,r,a,0)}h=h.next}o=o.next}while(o!==n)}function On(n,t){return n.next.index!==t.index&&n.prev.index!==t.index&&!Vn(n,t)&&qt(n,t)&&qt(t,n)&&Dn(n,t)}function Dn(n,t){let e=n,i=!1;const s=(n.x+t.x)/2,r=(n.y+t.y)/2;do e.y>r!=e.next.y>r&&e.next.y!==e.y&&s<(e.next.x-e.x)*(r-e.y)/(e.next.y-e.y)+e.x&&(i=!i),e=e.next;while(e!==n);return i}function Ns(n,t){const e=Vt.create(n.index,n.x,n.y),i=Vt.create(t.index,t.x,t.y),s=n.next,r=t.prev;return n.next=t,t.prev=n,e.next=s,s.prev=e,i.next=e,e.prev=i,r.next=i,i.prev=r,i}class Vt{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(t,e,i){const s=Ge<De.length?De[Ge++]:new Vt;return s.index=t,s.x=e,s.y=i,s.prev=null,s.next=null,s.z=null,s.prevZ=null,s.nextZ=null,s.steiner=!1,s}}const De=new Array,Gn=8096;let Ge=0;for(let n=0;n<Gn;n++)De.push(new Vt);const Kn=1e-5,yt=new Is(0,0,0,1,0),Ke=new Is(0,0,0,1,0);function Qi(n,t,e){let i=0;for(let s=1;s<e;s++){const r=n[2*(t+s-1)],a=n[2*(t+s-1)+1];i+=(n[2*(t+s)]-r)*(n[2*(t+s)+1]+a)}return i}function Nn(n,t,e,i,s){let r=0;const a=2;for(let o=e;o<i;o+=3){const h=(n[o]-s)*a,l=(n[o+1]-s)*a,u=(n[o+2]-s)*a;r+=Math.abs((t[h]-t[u])*(t[l+1]-t[h+1])-(t[h]-t[l])*(t[u+1]-t[h+1]))}return r}function Zn(n,t){const{coords:e,lengths:i,hasIndeterminateRingOrder:s}=t,r=0,a=n;if(s)return!1;let o=0;for(let h=0;h<i.length;){let l=h,u=i[h],c=Qi(e,o,u);const d=[];for(;++l<i.length;){const p=i[l],y=Qi(e,o+u,p);if(!(y>0))break;c+=y,d.push(o+u),u+=p}const f=a.length;In(a,e,o,o+u,d,2,r);const _=Nn(a,e,f,a.length,r),m=Math.abs(c);if(Math.abs((_-m)/Math.max(1e-7,m))>Kn)return a.length=0,!1;h=l,o+=u}return!0}function Un(n){const{coords:t,lengths:e}=n,{buffer:i}=Fr(t,e);return i}function qn(n,t,e){let i=0;for(let s=0;s<n.lengths.length;s++){const r=n.lengths[s];for(let a=0;a<r;a++){const o=n.coords[2*(a+i)],h=n.coords[2*(a+i)+1];if(o<t||o>e||h<t||h>e)return!0}i+=r}return!1}function Xn(n,t){if(V(n))return null;if(!qn(n,-128,Mt+128))return n;yt.setPixelMargin(t),yt.reset(zs.Polygon);let e=0;for(let a=0;a<n.lengths.length;a++){const o=n.lengths[a];let h=n.coords[2*(0+e)],l=n.coords[2*(0+e)+1];yt.moveTo(h,l);for(let u=1;u<o;u++)h=n.coords[2*(u+e)],l=n.coords[2*(u+e)+1],yt.lineTo(h,l);yt.close(),e+=o}const i=yt.result(!1);if(!i)return null;const s=[],r=[];for(const a of i){let o=0;for(const h of a)r.push(h.x),r.push(h.y),o++;s.push(o)}return new tr(s,r)}function Hn(n,t){Ke.setPixelMargin(t);const e=Ke,i=-t,s=Mt+t;let r=[],a=!1,o=0;for(;o<n.length;){const h=[],l=n[o];if(!l)return null;e.reset(zs.LineString);let[u,c]=l[0];if(a)e.moveTo(u,c);else{if(u<i||u>s||c<i||c>s){a=!0;continue}h.push({x:u,y:c})}let d=!1;const f=l.length;for(let _=1;_<f;++_)if(u+=l[_][0],c+=l[_][1],a)e.lineTo(u,c);else{if(u<i||u>s||c<i||c>s){d=!0;break}h.push({x:u,y:c})}if(d)a=!0;else{if(a){const _=e.resultWithStarts();if(_)for(const m of _)r.push(m)}else r.push({line:h,start:0});o++,a=!1}}return r=r.filter(h=>h.line.length>1),r.length===0?null:r}yt.setExtent(Mt),Ke.setExtent(Mt);const le=8,O=16,Ji=65535,Zs=n=>class extends n{constructor(...t){super(...t),this.tessellationProperties={},this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0},this.geometryType=w.LINE}writeGeometry(t,e,i,s){this._writeGeometry(t,e,i,s)}_initializeTessellator(t){const e=dt.load(this._materialKey),i=et.load(this._materialKey),s=this._tessellationOptions,r=e.vvSizeFieldStops||e.vvSizeMinMaxValue||e.vvSizeScaleStops||e.vvSizeUnitValue,a=this.tessellationProperties._halfWidth<Vr&&!t&&!r;this.tessellationProperties.minMaxZoom=this._minMaxZoom,s.wrapDistance=Ji,s.textured=this._isDashed||this._hasPattern,s.offset=this.tessellationProperties.offset,s.halfWidth=this.tessellationProperties._halfWidth;const o=a?0:1,h=oe(i)?jn:Yn;this._lineTessellator=new Or(h(this.tessellationProperties,o,o),Qn(this.tessellationProperties),a)}_write(t,e,i,s){const r=e.geometryType==="esriGeometryPoint";t.recordStart(e.getDisplayId(),this._materialKey,this.geometryType,r),this._writeGeometry(t,e,s,r),t.recordEnd()}_writeGeometry(t,e,i,s){const r=i??e.readLegacyGeometryForDisplay(),a=this._getLines(r,s);V(a)||this._writeVertices(t,e,a)}_getLines(t,e){if(V(t))return null;const i=t.paths||t.rings;return V(i)?null:Hn(i,e?256:16)}_writeVertices(t,e,i){const s=e.getDisplayId(),r=t.vertexCount(),a=this.tessellationProperties,o=this._tessellationOptions;a.out=t,a.id=s,a.indexCount=0,a.vertexCount=0,a.offset=r,o.capType=this._capType,o.joinType=this._joinType;const h=et.load(this._materialKey);this.tessellationProperties.key=oe(h)?h:dt.load(this._materialKey);for(const{line:l,start:u}of i)o.initialDistance=u%Ji,this._lineTessellator.tessellate(l,o)}},Yn=(n,t,e)=>(i,s,r,a,o,h,l,u,c,d,f)=>{const _=x(f,Math.ceil(O*n._halfWidth)),m=I(Math.round(O*l),Math.round(O*u),Math.round(O*c),Math.round(O*d)),p=I(O*o,O*h,0,n._bitset),y=n.out;return y.vertexBounds(i,s,t,e),y.vertexWrite(x(le*i,le*s)),y.vertexWrite(n.id),y.vertexWrite(n._fillColor),y.vertexWrite(m),y.vertexWrite(_),y.vertexWrite(n._tl),y.vertexWrite(n._br),y.vertexWrite(p),y.vertexWrite(x(Math.ceil(O*n._halfReferenceWidth),0)),y.vertexWrite(n.minMaxZoom),y.vertexEnd(),n.offset+n.vertexCount++},jn=(n,t,e)=>(i,s,r,a,o,h,l,u,c,d,f)=>{const _=x(O*n._halfWidth,O*n._halfReferenceWidth),m=I(O*l+128,O*u+128,O*c+128,O*d+128),p=n.out,y=n._bitset<<24|n.id;p.vertexBounds(i,s,t,e),p.vertexWrite(x(le*i,le*s)),p.vertexWrite(y),p.vertexWrite(n._fillColor);const g=Es(n.key);return g||(p.vertexWrite(0),p.vertexWrite(0)),p.vertexWrite(0),p.vertexWrite(_),p.vertexWrite(m),g||p.vertexWrite(n.minMaxZoom),p.vertexEnd(),n.offset+n.vertexCount++},Qn=n=>(t,e,i)=>{const s=n.out;s.indexWrite(t),s.indexWrite(e),s.indexWrite(i),n.indexCount+=3};class st extends Zs(Ht){constructor(t,e,i,s,r,a,o,h,l,u,c,d,f,_,m,p,y,g,M,b){super();const S=dt.load(t);e&&(S.sdf=e.sdf,S.pattern=!0,S.textureBinding=e.textureBinding),this._capType=s,this._joinType=r,this._miterLimitCosine=Be(a),this.tessellationProperties._fillColor=o,this.tessellationProperties._tl=h,this.tessellationProperties._br=l,this._hasPattern=u,this._isDashed=c,this._zOrder=y,this._effects=g,this._minMaxZoom=x(Math.round(M*R),Math.round(b*R)),this._materialKey=S.data;const L=(f?xt:0)|(_?Br:0)|(d?Ss:0)|(m?de:0);this.tessellationProperties._bitset=L,this.tessellationProperties._halfWidth=.5*i,this.tessellationProperties._halfReferenceWidth=.5*p,this.tessellationProperties.offset=0,this._initializeTessellator(!1)}static fromCIMLine(t,e,i){const s=t.color,r=t.scaleFactor||1,a=!!t.dashTemplate;let o=t.cap;a&&o===pi.ROUND&&(o=pi.SQUARE);const h=t.join,l=v(t.width)*r,u=v(t.referenceWidth),c=v(t.miterLimit),d=s&&z(s)||0,[f,_]=mt(t.scaleInfo,i),m=!1;if(!e)return new st(t.materialKey,e,l,o,h,c,d,0,0,!1,a,t.scaleDash??!1,t.colorLocked??!1,m,t.sampleAlphaOnly,u,t.zOrder,t.effects,f,_);const{rect:p,width:y,height:g}=e,M=p.x+C,b=p.y+C,S=M+y,L=b+g,$=x(M,b),P=x(S,L),U=!1;return new st(t.materialKey,e,l,o,h,c,d,$,P,!0,a,t.scaleDash??!1,t.colorLocked??!1,U,t.sampleAlphaOnly,u,t.zOrder,t.effects,f,_)}static fromFillOutline(t){var i;const e=et.load(t.materialKey);return oe(e)&&t.outline&&((i=t.outline)==null?void 0:i.style)==="esriSLSSolid"?st.fromSimpleLine({hash:"",materialKey:t.materialKey,...t.outline},null,!0):null}static fromSimpleLine(t,e,i=!1){const{color:s}=t,r=t.style!=="esriSLSSolid"&&t.style!=="esriSLSNull",a=Lr(t.cap||"round"),o=Ir(t.join||"round");let h=s&&t.style!=="esriSLSNull"&&G(s)||0;t.style==="esriSLSNull"&&(h=0);const l=v(t.width),u=t.miterLimit;if(!e)return new st(t.materialKey,e,l,a,o,u,h,0,0,!1,r,!0,!1,i,!1,l,0,null,Q,J);const{rect:c,width:d,height:f}=e,_=c.x+C,m=c.y+C,p=_+d,y=m+f,g=x(_,m),M=x(p,y);return new st(t.materialKey,e,l,a,o,u,h,g,M,!0,r,!0,!1,i,!1,l,0,null,Q,J)}static fromPictureLineSymbol(t,e,i,s){return Bt.getLogger("esri.views.2d.engine.webgl.WGLLineTemplate").error("PictureLineSymbol support does not exist!"),null}}const Jn=100,ts=1,Us=n=>class extends n{constructor(...t){super(...t),this.forceLibtess=!1,this._bitset=0,this._lineTemplate=null,this.geometryType=w.FILL}_maybeAddLineTemplate(t){this._lineTemplate=st.fromFillOutline(t)}_write(t,e,i,s){const r=e.geometryType==="esriGeometryPoint",a=et.load(this._materialKey);t.recordStart(e.getDisplayId(),this._materialKey,this.geometryType,r),this._writeGeometry(t,e,a,s,r),oe(a)&&E(this._lineTemplate)&&this._lineTemplate.writeGeometry(t,e,s,r),t.recordEnd()}_writeGeometry(t,e,i,s,r){const a=this._getGeometry(e,s,r);if(V(a))return;const o=[];if(!(a.maxLength>Jn)&&!this.forceLibtess&&Zn(o,a))return void(o.length&&this._writeVertices(t,e,a.coords,a.lengths,i,o));const h=Un(a);this._writeVertices(t,e,h,[h.length/2],i)}_writeVertex(t,e,i,s,r,a){const o=x(ts*s,ts*r);if(t.vertexBounds(s,r,0,0),t.vertexWrite(o),t.vertexWrite(e),i.symbologyType===B.DOT_DENSITY)t.vertexWriteF32(1/Math.abs(a.readGeometryArea()));else{t.vertexWrite(this.fillColor);const h=Es(i);h||(t.vertexWrite(this.tl),t.vertexWrite(this.br)),t.vertexWrite(this.aux21),t.vertexWrite(this.aux22),t.vertexWrite(this.aux3),h||t.vertexWrite(this._minMaxZoom)}}_writeVertices(t,e,i,s,r,a){const o=e.getDisplayId(),h=this._bitset<<24|o,l=s.reduce((f,_)=>f+_),u=Ce(r.geometryType,r.symbologyType).geometry/4,c=t.vertexCount();t.vertexEnsureSize(u*l);let d=0;if(a)for(const f of a){const _=i[2*f],m=i[2*f+1];this._writeVertex(t,h,r,_,m,e),d++}else for(let f=0;f<i.length;f+=2){const _=Math.round(i[f]),m=Math.round(i[f+1]);this._writeVertex(t,h,r,_,m,e),d++}t.indexEnsureSize(d);for(let f=0;f<d;f++)t.indexWrite(f+c)}_getGeometry(t,e,i){const s=e?He(Ye(e),2):t.readGeometryForDisplay();return s?Xn(s,i?256:8):null}},es=Bt.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");let ve=class extends Ht{constructor(t){super(),this._ongoingMaterialRequestMap=new Map,this._materialCache=new Map,this._dynamicPropertyMap=new Map,this._cimLayer=t}analyze(t,e,i,s,r){if(r&&r.length===0)return null;const a=r&&r.length>0,o=e.readLegacyFeature(),h=e.getObjectId(),l=this._materialCache,u=this._cimLayer.materialHash;if(!u)return es.error("A Dynamic mesh template must have a material hash value or function!"),Promise.reject(null);const c=typeof u=="function"?u(o,i,s,h):u,d=l.get(c);if(d!=null)return Promise.resolve(d);const f=this._ongoingMaterialRequestMap.get(c);if(f)return f;const _=this._cimLayer,m=br(_.cim,this._cimLayer.materialOverrides);m.mosaicHash=c;const{type:p,url:y}=_,g={cim:m,type:p,mosaicHash:c,url:y,size:null,dashTemplate:null,text:null,fontName:null,objectId:h,animatedSymbolProperties:null};switch(p){case"marker":g.size=Yt(_.size,o,i,s),g.animatedSymbolProperties=Yt(_.animatedSymbolProperties,o,i,s);break;case"line":g.dashTemplate=_.dashTemplate;break;case"text":g.text=Yt(_.text,o,i,s),g.fontName=Yt(_.fontName,o,i,s)}const M=t.getMosaicItem(g,r).then(b=>(a||(this._ongoingMaterialRequestMap.delete(c),l.set(c,b)),b)).catch(b=>(this._ongoingMaterialRequestMap.delete(c),es.error(".analyze()",b.message),null));return a||this._ongoingMaterialRequestMap.set(c,M),M}};function D(n,t){if(n&&"name"in n){const e=n;return t&&t.error(new _t(e.name,e.message,e.details)),!1}return!0}const is=128;let ta=class qs extends Us(ve){constructor(t,e,i){var u;if(super(t),this._minMaxZoom=x(Math.round(e*R),Math.round(i*R)),T(t.color)){const c=(d,f,_)=>{const m=t.color(d,f,_);return m&&z(m)||0};this._dynamicPropertyMap.set("fillColor",c)}else{const c=t.color;this.fillColor=c&&z(c)||0}const s=((u=t.cim.placement)==null?void 0:u.type)==="CIMMarkerPlacementInsidePolygon"&&t.cim.placement.shiftOddRows?2:1,r=t.height;if(T(r)){const c=(d,f,_)=>r(d,f,_)*s;this._dynamicPropertyMap.set("_height",c)}else this._height=(r||0)*s;const a=t.offsetX;if(T(a)){const c=(d,f,_)=>v(a(d,f,_));this._dynamicPropertyMap.set("_offsetX",c)}else this._offsetX=v(a||0);const o=t.offsetY;if(T(o)){const c=(d,f,_)=>v(-o(d,f,_));this._dynamicPropertyMap.set("_offsetY",c)}else this._offsetY=v(-o||0);const h=t.scaleX;T(h)?this._dynamicPropertyMap.set("_scaleX",h):this._scaleX=h||1;const l=t.angle;if(T(l)){const c=(d,f,_)=>ke(l(d,f,_));this._dynamicPropertyMap.set("_angle",c)}else this._angle=ke(l)||0;if(E(t.effects)){const c=t.effects;T(c)?this._dynamicPropertyMap.set("_effects",c):this._effects=c}this._cimFillLayer=t,this._bitset=(t.colorLocked?xt:0)|(t.applyRandomOffset?Ts:0)|(t.sampleAlphaOnly?de:0)|(t.hasUnresolvedReplacementColor?Ls:0),this._fillMaterialKey=t.materialKey}static fromCIMFill(t,e){const[i,s]=mt(t.scaleInfo,e);return new qs(t,i,s)}bindFeature(t,e,i){const s=t.readLegacyFeature();this._dynamicPropertyMap.forEach((u,c)=>{this[c]=u(s,e,i)});const r=et.load(this._fillMaterialKey),a=this._materialCache,o=(0,this._cimFillLayer.materialHash)(s,e,i),h=a.get(o);let l=null;if(h&&D(h.spriteMosaicItem)&&(l=h.spriteMosaicItem),l){const{rect:u,width:c,height:d}=l,f=u.x+C,_=u.y+C,m=f+c,p=_+d;let y=Math.round(v(this._height));y<=0&&(y=p-_);let g=Math.round(v(this._height/d*c||0));g<=0&&(g=m-f);const M=this._scaleX,b=1;this.tl=x(f,_),this.br=x(m,p),this.aux21=x(g,y),this.aux22=x(this._offsetX,this._offsetY),this.aux3=I(M*is,b*is,this._angle,0),r.sdf=l.sdf,r.pattern=!0,r.textureBinding=l.textureBinding}else this.tl=0,this.br=0,this.aux21=0,this.aux22=0,this.aux3=0,r.sdf=!1,r.pattern=!1,r.textureBinding=0;this._materialKey=r.data}},ea=class Xs extends Zs(ve){constructor(t,e,i){super(t),this._minMaxZoom=x(Math.round(e*R),Math.round(i*R)),this._cimLineLayer=t;let s=0;T(t.width)||(s=.5*v(t.width));const r=(c,d,f)=>T(t.width)?.5*v(t.width(c,d,f)):s;this._dynamicPropertyMap.set("_halfWidth",r),T(t.cap)?this._dynamicPropertyMap.set("_capType",t.cap):this._capType=t.cap,T(t.join)?this._dynamicPropertyMap.set("_joinType",t.join):this._joinType=t.join;const a=t.color;if(T(a)){const c=(d,f,_)=>z(a(d,f,_));this._dynamicPropertyMap.set("_fillColor",c)}else this._fillColor=a&&z(a)||0;const o=t.miterLimit;if(T(o)){const c=(d,f,_)=>Be(o(d,f,_));this._dynamicPropertyMap.set("_miterLimitCosine",c)}else this._miterLimitCosine=Be(o);if(E(t.effects)){const c=t.effects;T(c)?this._dynamicPropertyMap.set("_effects",c):this._effects=c}this._scaleFactor=t.scaleFactor||1,this._isDashed=t.dashTemplate!=null;const h=t.colorLocked?xt:0,l=t.scaleDash?Ss:0,u=t.sampleAlphaOnly?de:0;this.tessellationProperties._bitset=h|l|u,this._materialKey=t.materialKey,this._initializeTessellator(!0)}static fromCIMLine(t,e){const[i,s]=mt(t.scaleInfo,e);return new Xs(t,i,s)}bindFeature(t,e,i){const s=t.readLegacyFeature();this._dynamicPropertyMap.forEach((u,c)=>{this[c]=u(s,e,i)}),this._halfWidth*=this._scaleFactor;const r=this._materialCache,a=(0,this._cimLineLayer.materialHash)(s,e,i),o=r.get(a);let h=null;if(o&&D(o.spriteMosaicItem)&&(h=o.spriteMosaicItem),h){this._hasPattern=!0;const{rect:u,width:c,height:d}=h,f=u.x+C,_=u.y+C,m=f+c,p=_+d;this.tessellationProperties._tl=x(f,_),this.tessellationProperties._br=x(m,p)}else this._hasPattern=!1,this.tessellationProperties._tl=0,this.tessellationProperties._br=0;this.tessellationProperties._fillColor=this._fillColor,this.tessellationProperties._halfWidth=this._halfWidth,this.tessellationProperties.offset=0,this.tessellationProperties._halfReferenceWidth=this.tessellationProperties._halfWidth;const l=dt.load(this._materialKey);h&&(l.sdf=h.sdf,l.pattern=!0,l.textureBinding=h.textureBinding),this._materialKey=l.data}};const ia=Wt(),sa=rt();class si extends Os(ve){constructor(t,e,i){super(t),this._cimMarkerLayer=t,this._minMaxZoom=x(Math.round(e*R),Math.round(i*R));const s=t.color;if(T(s)){const d=(f,_,m)=>z(s(f,_,m));this._dynamicPropertyMap.set("_fillColor",d)}else this._fillColor=z(s);const r=t.outlineColor;if(T(r)){const d=(f,_,m)=>z(r(f,_,m));this._dynamicPropertyMap.set("_outlineColor",d)}else this._outlineColor=z(r);const a=t.size;if(T(a)){const d=(f,_,m)=>v(a(f,_,m));this._dynamicPropertyMap.set("_size",d)}else this._size=v(a)||0;const o=t.scaleX;T(o)?this._dynamicPropertyMap.set("_scaleX",o):this._scaleX=o;const h=t.offsetX;if(T(h)){const d=(f,_,m)=>v(h(f,_,m));this._dynamicPropertyMap.set("xOffset",d)}else this.xOffset=v(h)||0;const l=t.offsetY;if(T(l)){const d=(f,_,m)=>v(l(f,_,m));this._dynamicPropertyMap.set("yOffset",d)}else this.yOffset=v(l)||0;const u=t.outlineWidth;if(T(u)){const d=(f,_,m)=>v(u(f,_,m));this._dynamicPropertyMap.set("_outlineWidth",d)}else this._outlineWidth=v(u)||0;const c=t.rotation;if(T(c)?this._dynamicPropertyMap.set("_angle",c):this._angle=c||0,E(t.effects)){const d=t.effects;T(d)?this._dynamicPropertyMap.set("_effects",d):this._effects=d}if(E(t.markerPlacement)){const d=t.markerPlacement;T(d)?this._dynamicPropertyMap.set("_markerPlacement",d):this._markerPlacement=d}this._scaleFactor=ae(t.scaleFactor,1),this._bitSet=(t.alignment===X.MAP?1:0)|(t.colorLocked?1:0)<<1|(t.scaleSymbolsProportionally?1:0)<<3,this._materialKey=t.materialKey}static fromCIMMarker(t,e){const[i,s]=mt(t.scaleInfo,e);return new si(t,i,s)}bindFeature(t,e,i){const s=t.readLegacyFeature(),r=t.getObjectId();this._dynamicPropertyMap.forEach((bt,St)=>{this[St]=bt(s,e,i)});const a=this._cimMarkerLayer.materialHash,o=typeof a=="function"?a(s,e,i,r):a,h=this._materialCache.get(o);if(!h||!D(h.spriteMosaicItem)||!h.spriteMosaicItem)return void Bt.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate").error(new _t("mapview-cim","Encountered an error when binding feature"));const l=h.spriteMosaicItem,u=this._cimMarkerLayer.sizeRatio,c=l.width/l.height*this._scaleX,d=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle;let f=this._size,_=f*c;const m=this.xOffset,p=this.yOffset;this.xOffset*=this._scaleFactor,this.yOffset*=this._scaleFactor;const y=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/v(this._cimMarkerLayer.frameHeight):1,g=this._outlineWidth*y,M=v(this._cimMarkerLayer.referenceSize);let b=0,S=0;const L=this._cimMarkerLayer.anchorPoint;L&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(b=v(L.x)/(this._size*c),S=v(L.y)/this._size):(b=L.x,S=L.y)),this._anchorX=b,this._anchorY=S,this._sizeOutlineWidth=I(Math.round(Math.min(Math.sqrt(128*_),255)),Math.round(Math.min(Math.sqrt(128*f),255)),Math.round(Math.min(Math.sqrt(128*g),255)),Math.round(Math.min(Math.sqrt(128*M),255))),this.angle=d;const $=Math.round(64*u);this._bitestAndDistRatio=x(this._bitSet,$);const P=l.rect.x+C,U=l.rect.y+C,q=P+l.width,nt=U+l.height;this._texUpperLeft=x(P,U),this._texUpperRight=x(q,U),this._texBottomLeft=x(P,nt),this._texBottomRight=x(q,nt);const j=wt.load(this._materialKey);j.sdf=l.sdf,j.pattern=!0,j.textureBinding=l.textureBinding,this._materialKey=j.data,_*=u,f*=u,_*=this._scaleFactor,f*=this._scaleFactor,_*=l.rect.width/l.width,f*=l.rect.height/l.height,this._computedWidth=_,this._computedHeight=f,this._applyTransformation(sa,ia),this.xOffset=m,this.yOffset=p}}function ri(n){if(n==null)return[];const t=new Array(n.length);for(let e=0;e<n.length;e++)t[e]=n.charCodeAt(e);return t}const ss=5;function ra(n,t,e,i){return typeof n.text=="string"?n.text:typeof n.text=="function"?n.text(t,e,i)??"":""}class ni extends Rs(ve){constructor(t,e,i){super(t),this._horizontalAlignment="center",this._verticalAlignment="middle",this._textToGlyphs=new Map,this._minMaxZoom=x(Math.round(e*R),Math.round(i*R));const s=t.scaleFactor||1;this._cimTextLayer=t;const r=t.color;if(T(r)){const m=(p,y,g)=>z(r(p,y,g));this._dynamicPropertyMap.set("_color",m)}else this._color=z(r);const a=t.outlineColor;if(T(a)){const m=(p,y,g)=>z(a(p,y,g));this._dynamicPropertyMap.set("_haloColor",m)}else this._haloColor=z(a);let o;T(t.size)||(o=Math.min(Math.round(v(t.size*t.sizeRatio)),127));const h=(m,p,y)=>T(t.size)?Math.min(Math.round(v(t.size(m,p,y)*t.sizeRatio)),127):o;if(this._dynamicPropertyMap.set("_size",h),T(t.outlineSize)){const m=(p,y,g)=>Math.min(Math.floor(ss*v(t.outlineSize(p,y,g)*t.sizeRatio)),127);this._dynamicPropertyMap.set("_haloSize",m)}else this._haloSize=Math.min(Math.floor(ss*v(t.outlineSize*t.sizeRatio)),127);let l;T(t.offsetX)||(l=Math.round(v(t.offsetX*t.sizeRatio)));const u=(m,p,y)=>T(t.offsetX)?Math.round(v(t.offsetX(m,p,y)*t.sizeRatio)):l;let c;this._dynamicPropertyMap.set("_xOffset",u),T(t.offsetY)||(c=Math.round(v(t.offsetY*t.sizeRatio)));const d=(m,p,y)=>T(t.offsetY)?Math.round(v(t.offsetY(m,p,y)*t.sizeRatio)):c;if(this._dynamicPropertyMap.set("_yOffset",d),T(t.angle)?this._dynamicPropertyMap.set("_angle",t.angle):this._angle=t.angle,T(t.horizontalAlignment)?this._dynamicPropertyMap.set("_horizontalAlignment",t.horizontalAlignment):this._horizontalAlignment=t.horizontalAlignment,T(t.verticalAlignment)?this._dynamicPropertyMap.set("_verticalAlignment",t.verticalAlignment):this._verticalAlignment=t.verticalAlignment,E(t.effects)){const m=t.effects;T(m)?this._dynamicPropertyMap.set("_effects",m):this._effects=m}if(E(t.markerPlacement)){const m=t.markerPlacement;T(m)?this._dynamicPropertyMap.set("_markerPlacement",m):this._textPlacement=m}T(t.text)?this._dynamicPropertyMap.set("_text",t.text):this._text=t.text,this._backgroundColor=t.backgroundColor&&z(t.backgroundColor),this._borderLineColor=t.borderLineColor&&z(t.borderLineColor),this._borderLineSize=t.borderLineWidth,this._scaleFactor=s;const f=Math.min(Math.round(v(t.referenceSize*t.sizeRatio)),127);this._referenceSize=Math.round(Math.sqrt(256*f)),this._materialKey=t.materialKey;const _=Kt.load(this._materialKey);_.sdf=!0,this._bitset=(t.alignment===X.MAP?1:0)|(t.colorLocked?1:0)<<1,this._materialKey=_.data,this._decoration="none",this._lineHeight=1,this._lineWidth=512,this._isCIM=!0}static fromCIMText(t,e){const[i,s]=mt(t.scaleInfo,e);return new ni(t,i,s)}async analyze(t,e,i,s){const r=e.readLegacyFeature(),a=ra(this._cimTextLayer,r,i,s),o=await super.analyze(t,e,i,s,ri(a));return o&&o.glyphMosaicItems&&this._textToGlyphs.set(a,o.glyphMosaicItems),o}bindFeature(t,e,i){const s=t.readLegacyFeature();if(this._dynamicPropertyMap.forEach((a,o)=>{this[o]=a(s,e,i)}),!this._text||this._text.length===0)return void(this._shapingInfo=null);this._size*=this._scaleFactor,this._scale=this._size/ws,this._xOffset*=this._scaleFactor,this._yOffset*=this._scaleFactor,this._xAlignD=gs(ae(this._horizontalAlignment,"center")),this._yAlignD=xs(ae(this._verticalAlignment,"baseline"));const r=this._textToGlyphs.get(this._text)??[];this.bindTextInfo(r,!1)}}const $t=128;let Le=class Ct extends Us(Ht){constructor(t,e,i,s,r,a,o,h,l,u,c,d,f,_,m,p){super(),this._effects=_;const y=et.load(t);e&&(y.sdf=e.sdf,y.pattern=!0,y.textureBinding=e.textureBinding),this.fillColor=i,this.tl=s,this.br=r,this.aux21=x(a,o),this.aux22=x(h,l),this.aux3=I(u,c,d,0),this._bitset=f,this._minMaxZoom=x(Math.round(m*R),Math.round(p*R)),this._materialKey=y.data}static fromCIMFill(t,e,i){const s=t.color,r=s&&z(s)||0,a=t.materialKey,[o,h]=mt(t.scaleInfo,i),l=(t.colorLocked?xt:0)|(t.applyRandomOffset?Ts:0)|(t.sampleAlphaOnly?de:0)|(t.hasUnresolvedReplacementColor?Ls:0);if(!e)return new Ct(a,null,r,0,0,0,0,0,0,0,0,0,l,t.effects,o,h);const{rect:u,width:c,height:d}=e,f=t.scaleX||1,_=u.x+C,m=u.y+C,p=_+c,y=m+d,g=v(t.height);let M=f*g;t.cim.type==="CIMHatchFill"&&(M*=c/d);let b=Math.round(g);b<=0&&(b=y-m);let S=Math.round(M);S<=0&&(S=p-_);const L=v(t.offsetX||0),$=v(-t.offsetY||0),P=x(_,m),U=x(p,y);return new Ct(a,e,r,P,U,S,b,L,$,$t,$t,ke(t.angle),l,t.effects,o,h)}static fromSimpleFill(t,e,i=!1){const{color:s}=t,r=s&&t.style!=="esriSFSNull"&&G(s)||0,a=i?xt:0,o=t.materialKey;let h;if(e){const{rect:l,width:u,height:c,pixelRatio:d}=e,f=l.x+C,_=l.y+C,m=f+u,p=_+c,y=x(f,_),g=x(m,p);h=new Ct(o,e,r,y,g,u/d,c/d,0,0,$t,$t,0,a,null,Q,J)}else h=new Ct(o,null,r,0,0,0,0,0,0,0,0,0,a,null,Q,J);return h._maybeAddLineTemplate(t),h}static fromPictureFill(t,e,i=!1){const s=bs,{rect:r,width:a,height:o}=e,h=r.x+C,l=r.y+C,u=h+a,c=l+o,d=x(h,l),f=x(u,c),_=Math.round(v(t.width)),m=Math.round(v(t.height)),p=v(t.xoffset),y=v(-t.yoffset),g=t.materialKey,M=i?xt:0,b=new Ct(g,e,s,d,f,_,m,p,y,$t*t.xscale,$t*t.yscale,0,M,null,Q,J);return b._maybeAddLineTemplate(t),b}},na=class{constructor(){this._resolver=null}isHeld(){return!!this._resolver}async acquire(){this._resolver?(await this._resolver.promise,await this.acquire()):this._resolver=er()}release(){const t=this._resolver;this._resolver=null,t==null||t.resolve()}};async function aa(n,t,e){try{await n.acquire(),await t(e),n.release()}catch(i){throw n.release(),i}}const oa={marker:w.MARKER,fill:w.FILL,line:w.LINE,text:w.TEXT};let ha=class{constructor(t,e,i,s){const r={minScale:e==null?void 0:e.minScale,maxScale:e==null?void 0:e.maxScale},a=la(r);this.layers=t,this.data=e,this.hash=this._createHash()+a,this.rendererKey=i;const o={isOutline:!1,placement:null,symbologyType:B.DEFAULT,vvFlags:i};for(const h of t){const l=oa[h.type];o.isOutline=h.type==="line"&&h.isOutline,h.materialKey=ye(l,o),h.maxVVSize=s,h.scaleInfo=r,h.templateHash+=a}}get type(){return"expanded-cim"}_createHash(){let t="";for(const e of this.layers)t+=e.templateHash;return t}};function la(n){return n.minScale||n.maxScale?n.minScale+"-"+n.maxScale:""}async function ca(n,t,e){if(!n.name)throw new _t("style-symbol-reference-name-missing","Missing name in style symbol reference");if(n.styleName&&n.styleName==="Esri2DPointSymbolsStyle")return ua(n,e);try{return da(await ir(n,t,e),n.name,t,e)}catch(i){return ct(i),null}}async function ua(n,t){const e=sr.replace(/\{SymbolName\}/gi,n.name);try{const i=await _s(e,t);return ms(i.data)}catch(i){return ct(i),null}}async function da(n,t,e,i){const s=n.data,r={portal:e&&E(e.portal)?e.portal:rr.getDefault(),url:nr(n.baseUrl),origin:"portal-item"},a=s.items.find(h=>h.name===t);if(!a)throw new _t("symbolstyleutils:symbol-name-not-found",`The symbol name '${t}' could not be found`,{symbolName:t});let o=ar(or(a,"cimRef"),r);hr()&&(o=lr(o));try{const h=await _s(o,i);return ms(h.data)}catch(h){return ct(h),null}}const rs=async(n,t,e)=>new ha(await Sr(n.data,t,e),n.data,n.rendererKey,n.maxVVSize);async function tt(n,t,e,i){if(!n)return null;if(n.type==="cim")return rs(n,t,e);if(n.type==="web-style"){const s={type:"cim",data:await ca(n,null,i)??void 0,rendererKey:n.rendererKey,maxVVSize:n.maxVVSize};return rs(s,t,e)}return n}function ne(n){if(!n)return null;const{avoidSDFRasterization:t,type:e,cim:i,url:s,materialHash:r}=n,a={cim:i,type:e,mosaicHash:r,url:s,size:null,dashTemplate:null,path:null,text:null,fontName:null,animatedSymbolProperties:null,avoidSDFRasterization:t};switch(e){case"marker":a.size=n.size,a.path=n.path,a.animatedSymbolProperties=n.animatedSymbolProperties;break;case"line":a.dashTemplate=n.dashTemplate;break;case"text":a.text=n.text,a.fontName=n.fontName}return a}const F=Bt.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),ns={sortKey:null,templates:new Array},ai={isOutline:!1,placement:null,symbologyType:B.DEFAULT,vvFlags:0},fa={...ui,hash:JSON.stringify(ui),materialKey:ye(w.MARKER,ai)},_a={...di,hash:JSON.stringify(di),materialKey:ye(w.LINE,ai)},ma={...fi,hash:JSON.stringify(fi),materialKey:ye(w.FILL,ai)};function it(n,t){const e=n.length;return n.push(null),t.then(i=>n[e]=i),n}function Dt(n){return n!=null&&!!(1&n)}function pa(n){return n.name==="worker:port-closed"}class ya{constructor(t,e){this._idCounter=1,this._templateIdCounter=1,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._cimTemplateCache=new Map,this._cimAnalyses=[],this._lock=new na,this._fetchResource=t,this._tileInfo=e}get _markerError(){return this._errorTemplates.marker[0]}get _fillError(){return this._errorTemplates.fill[0]}get _lineError(){return this._errorTemplates.line[0]}get _textError(){return this._errorTemplates.line[0]}createTemplateGroup(t,e,i=null){this._initErrorTemplates();const s=t.hash,r=this._symbolToTemplate.get(s);if(r!=null)return r;const a=new Array,o={sortKey:i,templates:a};e&&this._createMeshTemplates(a,e,!0),this._createMeshTemplates(a,t,!1);const h=this._createGroupId(t.type==="expanded-cim"&&ga(t));return this._idToTemplateGroup.set(h,o),this._symbolToTemplate.set(s,h),h}getTemplateGroup(t){return this._idToTemplateGroup.get(t)??ns}getDynamicTemplateGroup(t){return this._idToTemplateGroup.has(t)?(Dt(t)||F.error("mapview-template-store",`Id ${t} does not refer to a dynamic template`),this._idToTemplateGroup.get(t)):ns}getMosaicItem(t,e){const i=this._createTemplateId(),s=new Promise(r=>this._idToResolver.set(i,r));return this._fetchQueue.push({symbol:t,id:i,glyphIds:e}),s}finalize(t){return this._fetchQueue.length||this._lock.isHeld()?aa(this._lock,this._fetchAllQueuedResources.bind(this),t):Promise.resolve()}_initErrorTemplates(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],ma,!1),marker:this._createMeshTemplates([],fa,!1),line:this._createMeshTemplates([],_a,!1)})}_fetchAllQueuedResources(t){if(!this._fetchQueue.length)return Promise.resolve();const e=this._fetchQueue,i=this._cimAnalyses;return this._fetchQueue=[],this._cimAnalyses=[],Promise.all(i).then(()=>this._fetchResource(e,t).then(s=>{for(const{id:r,mosaicItem:a}of s)this._idToResolver.get(r)(a),this._idToResolver.delete(r)})).catch(s=>{je(s)?this._fetchQueue=this._fetchQueue.concat(e):pa(s)||F.error(new _t("mapview-template-store","Unable to fetch requested texture resources",s))})}_createGroupId(t){return this._idCounter++<<1|(t?1:0)}_createTemplateId(){return this._templateIdCounter++}async _createSMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return D(e,F)?Ft.fromSimpleMarker(t,e):this._markerError}async _createPMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return D(e,F)?Ft.fromPictureMarker(t,e):this._markerError}async _createSFS(t,e){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return D(i,F)?Le.fromSimpleFill(t,i,e):this._fillError}async _createPFS(t,e){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return D(i,F)?Le.fromPictureFill(t,i,e):this._fillError}async _createSLS(t,e){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return D(i,F)?st.fromSimpleLine(t,i):this._lineError}async _createLMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return D(e,F)?Ft.fromLineSymbolMarker(t,e):this._markerError}async _createTS(t){const{glyphMosaicItems:e}=await this.getMosaicItem(t);return Ae.fromText(t,e??[])}async _createCIMText(t){const{glyphMosaicItems:e}=await this.getMosaicItem(ne(t),ri(t.text));return D(e,F)?Ae.fromCIMText(t,e,this._tileInfo):this._textError}async _createCIMFill(t){const{spriteMosaicItem:e}=await this.getMosaicItem(ne(t));return D(e,F)?Le.fromCIMFill(t,e,this._tileInfo):this._fillError}async _createCIMLine(t){const{spriteMosaicItem:e}=await this.getMosaicItem(ne(t));return D(e,F)?st.fromCIMLine(t,e,this._tileInfo):this._lineError}async _createCIMMarker(t){const{spriteMosaicItem:e}=await this.getMosaicItem(ne(t));return D(e,F)?Ft.fromCIMMarker(t,e,this._tileInfo):this._markerError}async _createCIM(t){const e=t.templateHash;let i=this._cimTemplateCache.get(e);if(i!=null)return i;switch(t.type){case"marker":i=await this._createCIMMarker(t);break;case"line":i=await this._createCIMLine(t);break;case"fill":i=await this._createCIMFill(t);break;case"text":i=await this._createCIMText(t)}return this._cimTemplateCache.set(e,i),i}async _createDynamicCIM(t){const e=t.templateHash;let i=this._cimTemplateCache.get(e);if(i!=null)return i;switch(t.type){case"marker":i=si.fromCIMMarker(t,this._tileInfo);break;case"line":i=ea.fromCIMLine(t,this._tileInfo);break;case"fill":i=ta.fromCIMFill(t,this._tileInfo);break;case"text":i=ni.fromCIMText(t,this._tileInfo)}return this._cimTemplateCache.set(e,i),i}_createPrimitiveMeshTemplates(t,e,i){switch(e.type){case"esriSMS":return it(t,this._createSMS(e));case"esriPMS":return it(t,this._createPMS(e));case"esriSFS":return it(t,this._createSFS(e,i));case"line-marker":return it(t,this._createLMS(e));case"esriPFS":return it(t,this._createPFS(e,i));case"esriSLS":return it(t,this._createSLS(e,!1));case"esriTS":return it(t,this._createTS(e));default:return F.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),t}}_createMeshTemplates(t,e,i){if(e.type.includes("3d"))return F.error("3D symbols are not supported with MapView"),t;if(e.type==="expanded-cim"){for(const s of e.layers)typeof s.materialHash=="function"?it(t,this._createDynamicCIM(s)):it(t,this._createCIM(s));return t}if(e.type==="composite-symbol"){for(const s of e.layers)this._createPrimitiveMeshTemplates(t,s,i);return t}return e.type==="cim"||e.type==="label"||e.type==="web-style"?t:this._createPrimitiveMeshTemplates(t,e,i)}}const ga=n=>{if(!n.layers)return!1;for(const t of n.layers)if(typeof t.materialHash=="function")return!0;return!1};class xa{constructor(t,e,i){this._loadPromise=Dr(),this._geometryType=t,this._idField=e,this._templateStore=i}update(t,e){E(t.mesh.labels)&&(this._labelTemplates=this._createLabelTemplates(t.mesh.labels,e)),this._schema=t}_createLabelTemplates(t,e){const i=new Map;if(t.type==="simple"){for(const s of t.classes){const r=Xi.fromLabelClass(s,e);i.set(s.index,r)}return i}for(const s in t.classes){const r=t.classes[s];for(const a of r){const o=Xi.fromLabelClass(a,e);i.set(a.index,o)}}return i}get templates(){return this._templateStore}async analyze(t,e,i,s,r,a,o){if(_i(o))return;let h;(i==null?void 0:i.type)==="dictionary"&&(h=await i.analyze(this._idField,t.copy(),e,r,a,o));let l=0;for(;t.next();){let u=null;if(u=h?h[l++]:E(s)&&Ms(t.getDisplayId())&&t.readAttribute("cluster_count")!==1?s.match(this._idField,t,this._geometryType,r,a):i.match(this._idField,t,this._geometryType,r,a),t.setGroupId(u),Dt(u)){const c=this._templateStore.getDynamicTemplateGroup(u).templates;for(const d of c)d&&d.analyze&&d.analyze(this._templateStore,t,r,a)}}return await this._loadPromise,this._templateStore.finalize(o)}async analyzeGraphics(t,e,i,s,r,a){if(_i(a))return;const o=t.getCursor();for(i&&await i.analyze(this._idField,o.copy(),e,s,r,a);o.next();){let h=o.getGroupId();if(h!=null&&h!==-1||(h=i==null?void 0:i.match(this._idField,o,o.geometryType,s,r),o.setGroupId(h)),Dt(h)){const l=this._templateStore.getDynamicTemplateGroup(h).templates;for(const u of l)u&&u.analyze&&u.analyze(this._templateStore,o,s,r)}o.setGroupId(h)}return await this._loadPromise,this._templateStore.finalize(a)}writeGraphic(t,e,i,s){const r=e.getGroupId(),a=e.getDisplayId(),o=this._templateStore.getTemplateGroup(r);if(t.featureStart(e.insertAfter,0),a!=null){if(Dt(r))for(const h of o.templates)h&&h.bindFeature(e,null,null);if(o){for(const h of o.templates)h&&h.write(t,e,i,s);t.featureEnd()}}}writeCursor(t,e,i,s,r,a,o){const h=e.getGroupId(),l=e.getDisplayId(),u=this._templateStore.getTemplateGroup(h),c=u.templates,d=this._getSortKeyValue(e,u);if(t.featureStart(0,d),l!=null&&c){if(Dt(h))for(const f of c)f.bindFeature(e,i,s);for(const f of c)f.write(t,e,r,o);if(E(a)&&t.hasRecords){const f=a&&this._findLabelRef(c);this._writeLabels(t,e,a,f,r,o)}t.featureEnd()}}_getSortKeyValue(t,e){const i=this._schema.mesh.sortKey;if(V(i))return 0;let s=0;return s=i.byRenderer===!0&&e.sortKey!=null?e.sortKey:i.fieldIndex!=null?t.getComputedNumericAtIndex(i.fieldIndex):i.field!=null?t.readAttribute(i.field):t.readAttribute(this._idField),s*=i.order==="asc"?1:-1,s==null||isNaN(s)?0:s}_findLabelRef(t){for(const e of t)if(e instanceof Ft)return e;return null}_writeLabels(t,e,i,s,r,a){for(const o of i)if(E(o)&&o){const{glyphs:h,rtl:l,index:u}=o,c=this._labelTemplates.get(u);if(!c)continue;c.setZoomLevel(r),c.bindReferenceTemplate(s),c.bindTextInfo(h,l),c.write(t,e,null,a)}}}const Ne=Bt.getLogger("esri/views/2d/engine/webgl/util/Matcher");async function Ze(n,t,e,i){switch(n.type){case"simple":case"heatmap":return ft.fromBasicRenderer(n,t,e,i);case"map":return hi.fromUVRenderer(n,t,e,i);case"interval":return oi.fromCBRenderer(n,t,e,i);case"dictionary":return li.fromDictionaryRenderer(n,t,e,i);case"pie-chart":return ce.fromPieChartRenderer(n,t,e,i);case"subtype":return ce.fromSubtypes(n,t,e,i)}}class ft{constructor(){this.type="feature",this._defaultResult=null}static async fromBasicRenderer(t,e,i,s){const r=new ft;if(t.symbol){const a=await tt(t.symbol,i,s),o=e.createTemplateGroup(a,null);r.setDefault(o)}return r}static async fromPieChartRenderer(t,e,i,s){const r=new ft;if(t.markerSymbol){const a=await tt(t.markerSymbol,i,s);let o;t.fillSymbol&&(o=await tt(t.fillSymbol,i,s));const h=e.createTemplateGroup(a,o);r.setDefault(h)}return r}size(){return 1}getDefault(){return this._defaultResult}setDefault(t){this._defaultResult=t}match(t,e,i,s,r){return this.getDefault()}async analyze(t,e,i,s,r,a){return null}}class ce extends ft{constructor(t,e){super(),this._subMatchers=t,this._subtypeField=e}static async fromSubtypes(t,e,i,s){const r=new Map,a=[];for(const o in t.renderers){const h=parseInt(o,10),l=Ze(t.renderers[o],e,i,s).then(u=>r.set(h,u));a.push(l)}return await Promise.all(a),new ce(r,t.subtypeField)}match(t,e,i,s,r){const a=e.readAttribute(this._subtypeField),o=this._subMatchers.get(a);return o?o.match(t,e,i,s,r):null}}class oi extends ft{constructor(t,e,i,s){super(),this.type="interval",this._intervals=[],this._isMaxInclusive=e,this._fieldIndex=s,this._field=t,this._normalizationInfo=i}static async fromCBRenderer(t,e,i,s){const{isMaxInclusive:r,normalizationField:a,normalizationTotal:o,normalizationType:h}=t,l=t.field,u=new oi(l,r,{normalizationField:a,normalizationTotal:o,normalizationType:h},t.fieldIndex),c=await tt(t.backgroundFillSymbol,i,s);await Promise.all(t.intervals.map(async f=>{const _=await tt(f.symbol,i,s),m=await e.createTemplateGroup(_,c),p={min:f.min,max:f.max};u.add(p,m)}));const d=await tt(t.defaultSymbol,i,s);if(d){const f=await e.createTemplateGroup(d,c);u.setDefault(f)}return u}add(t,e){this._intervals.push({interval:t,result:e}),this._intervals.sort((i,s)=>i.interval.min-s.interval.min)}size(){return super.size()+this._intervals.length}match(t,e,i,s,r){if(this._fieldIndex==null&&!this._field)return this.getDefault();const a=this._fieldIndex!=null?e.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(e);if(a==null||isNaN(a)||a===1/0||a===-1/0)return this.getDefault();for(let o=0;o<this._intervals.length;o++){const{interval:h,result:l}=this._intervals[o],u=a>=h.min,c=this._isMaxInclusive?a<=h.max:a<h.max;if(u&&c)return l}return this.getDefault()}_needsNormalization(){const t=this._normalizationInfo;return t&&(t.normalizationField||t.normalizationTotal||t.normalizationType)}_getValueFromField(t){const e=t.readAttribute(this._field);if(!this._needsNormalization()||e==null)return e;const{normalizationField:i,normalizationTotal:s,normalizationType:r}=this._normalizationInfo,a=t.readAttribute(i)??1;if(r)switch(r){case"esriNormalizeByField":return a?e/a:void 0;case"esriNormalizeByLog":return Math.log(e)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return e/s*100;default:return void Ne.error(`Found unknown normalization type: ${r}`)}else Ne.error("Normalization is required, but no type was set!")}}class hi extends ft{constructor(t,e,i){super(),this.type="map",this._nullResult=null,this._resultsMap=new Map,this._fields=[],this._fieldsIndex=i,this._fields=t,this._seperator=e||""}static async fromUVRenderer(t,e,i,s){const r=t.fieldDelimiter,a=[t.field];t.field2&&a.push(t.field2),t.field3&&a.push(t.field3);const o=await tt(t.backgroundFillSymbol,i,s),h=new hi(a,r,t.fieldIndex);await Promise.all(t.map.map(async(u,c)=>{const d=await tt(u.symbol,i,s),f=c+1,_=await e.createTemplateGroup(d,o,f);u.value==="<Null>"?h.setNullResult(_):h.add(u.value,_)}));const l=await tt(t.defaultSymbol,i,s);if(l){const u=Number.MAX_SAFE_INTEGER,c=await e.createTemplateGroup(l,o,u);h.setDefault(c)}return h}setNullResult(t){this._nullResult=t}add(t,e){this._resultsMap.set(t.toString(),e)}size(){return super.size()+this._resultsMap.size}match(t,e,i,s,r){if(this._fieldsIndex==null&&!this._fields)return this.getDefault();const a=this._fieldsIndex!=null?e.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(e);if(this._nullResult!==null&&(a==null||a===""||a==="<Null>"))return this._nullResult;if(a==null)return this.getDefault();const o=a.toString();return this._resultsMap.has(o)?this._resultsMap.get(o):this.getDefault()}_getValueFromFields(t){const e=[];for(const i of this._fields){const s=t.readAttribute(i);s==null||s===""?e.push("<Null>"):e.push(s)}return e.join(this._seperator)}}async function va(n,t){const e=n||1;if(typeof e=="number")return(s,r,a)=>e;const i=await ur(e,t.spatialReference,t.fields);return(s,r,a)=>dr(i,s,{$view:a},t.geometryType,r)||1}let Ie;async function Ma(){return Ie||(Ie=ps(()=>import("./createSymbolSchema-8e9fc741.js"),["assets/createSymbolSchema-8e9fc741.js","assets/TileInfoView-c864a057.js","assets/index-df1c7459.js","assets/index-001d3307.css","assets/cimAnalyzer-0375b3f7.js","assets/BidiEngine-836b7ef6.js","assets/TileClipper-ae6eca9e.js","assets/enums-c655c737.js","assets/number-b10bd8f5.js","assets/Pipeline-40ecdda3.js","assets/QueryEngine-311866fa.js","assets/QueryEngineResult-a75eda3b.js","assets/WhereClause-2e7ef2fe.js","assets/executionError-fb3f283a.js","assets/utils-a8845e41.js","assets/generateRendererUtils-f1e35d90.js","assets/json-48e3ea08.js","assets/QueryEngineCapabilities-42e44ded.js","assets/StreamFeatureManager-b41ee58c.js","assets/quickselect-56c5966e.js","assets/arcadeTimeUtils-8aa77359.js","assets/centroid-0a3057d6.js","assets/ogcFeatureUtils-bdeff7e8.js","assets/geojson-e13f734b.js","assets/clientSideDefaults-5e9f56ed.js","assets/createConnection-ea8ef70b.js","assets/tileUtils-7f87edc3.js","assets/TurboLine-4561bd71.js","assets/Rect-98da58d6.js","assets/GeometryUtils-0258f920.js"])),Ie}class li extends ft{constructor(t,e,i,s,r,a){super(),this.type="dictionary",this._groupIdCache=new cr(100),this._loader=t,this._fieldMap=t.fieldMap,this._symbolFields=t.getSymbolFields(),this._templates=e,this._info=i,this._scaleFn=s,this._schemaUtilsModule=r,this._symbolOptions=a}static async fromDictionaryRenderer(t,e,i,s){const[{DictionaryLoader:r},a]=await Promise.all([ps(()=>import("./index-df1c7459.js").then(l=>l.un),["assets/index-df1c7459.js","assets/index-001d3307.css"]),Ma()]),o=new r(t.url,t.config,t.fieldMap);await o.fetchResources({spatialReference:i.spatialReference,fields:i.fields});const h=await va(t.scaleExpression,i);return new li(o,e,i,h,a,t.symbolOptions)}async _analyzeFeature(t,e,i,s,r){const a=t.readLegacyFeature(),o=this._scaleFn(a,i,s),h=this._attributeHash(a)+"-"+o,l=this._groupIdCache.get(h);if(l)return l;const u={...s,spatialReference:this._info.spatialReference,abortOptions:r,fields:this._info.fields},c=await this._loader.getSymbolAsync(a,u),d=this._schemaUtilsModule.createSymbolSchema(c,this._symbolOptions),f=tt(d,this._info,e,r).then(_=>{if((_==null?void 0:_.type)!=="expanded-cim")return Ne.error(new _t("mapview-bad-type",`Found unexpected type ${_==null?void 0:_.type} in dictionary response`)),null;_.hash+="-"+o;for(const m of _.layers)m.scaleFactor=o,m.templateHash+="-"+o;return this._templates.createTemplateGroup(_,null)});return this._groupIdCache.put(h,f,1),f}async analyze(t,e,i,s,r,a){const o=e.getCursor(),h=[];for(;o.next();)h.push(this._analyzeFeature(o,i,s,r,a));return Promise.all(h).then(l=>l.filter(E))}match(t,e,i,s,r){return null}_attributeHash(t){var i;let e="";for(const s of this._symbolFields){const r=(i=this._fieldMap)==null?void 0:i[s];r&&(e+=t.attributes[r]+"-")}return e}}class wa{constructor(t){this._remoteClient=t,this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}destroy(){}async fetchResource(t,e){const i=this._resourceMap,s=i.get(t);if(s)return s;let r=this._inFlightResourceMap.get(t);if(r)return r;try{r=this._remoteClient.invoke("tileRenderer.fetchResource",{url:t},{...e}),this._inFlightResourceMap.set(t,r),r.then(a=>(this._inFlightResourceMap.delete(t),i.set(t,a),a))}catch(a){return je(a)?null:{width:0,height:0}}return r}getResource(t){return this._resourceMap.get(t)??null}}function as(n,t){return(!n.minScale||n.minScale>=t)&&(!n.maxScale||n.maxScale<=t)}function os(n){const t=n.message,e={message:{data:{},tileKey:t.tileKey,tileKeyOrigin:t.tileKeyOrigin,version:t.version},transferList:new Array};for(const i in t.data){const s=t.data[i];if(e.message.data[i]=null,E(s)){const r=s.stride,a=s.indices.slice(0),o=s.vertices.slice(0),h=s.records.slice(0),l={stride:r,indices:a,vertices:o,records:h,metrics:Gt(s.metrics,u=>u.slice(0))};e.transferList.push(a,o,h),e.message.data[i]=l}}return e}let Ue=class extends Ar{constructor(){super(...arguments),this.type="symbol",this._matchers={feature:null,aggregate:null},this._bufferData=new Map,this._bufferIds=new Map}initialize(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))]),this._resourceManagerProxy=new wa(this.remoteClient)}destroy(){this._resourceManagerProxy.destroy()}get supportsTileUpdates(){return!0}forEachBufferId(n){this._bufferIds.forEach(t=>{t.forEach(n)})}async update(n,t){var s;const e=t.schema.processors[0];if(e.type!=="symbol")return;const i=fr(this._schema,e);(mi(i,"mesh")||mi(i,"target"))&&(n.mesh=!0,(s=n.why)==null||s.mesh.push("Symbology changed"),this._schema=e,this._factory=this._createFactory(e),this._factory.update(e,this.tileStore.tileScheme.tileInfo))}onTileMessage(n,t,e,i){return ct(i),this._onTileData(n,t,e,i)}onTileClear(n){const t={clear:!0};return this._bufferData.delete(n.key.id),this._bufferIds.delete(n.key.id),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:n.id,data:t})}onTileError(n,t,e){const i=e.signal,s={tileKey:n.id,error:t};return this.remoteClient.invoke("tileRenderer.onTileError",s,{signal:i})}onTileUpdate(n){for(const t of n.removed)this._bufferData.has(t.key.id)&&this._bufferData.delete(t.key.id),this._bufferIds.has(t.key.id)&&this._bufferIds.delete(t.key.id);for(const t of n.added)this._bufferData.forEach(e=>{for(const i of e)i.message.tileKey===t.id&&this._updateTileMesh("append",t,os(i),[],!1,!1,null)})}_addBufferData(n,t){var e;this._bufferData.has(n)||this._bufferData.set(n,[]),(e=this._bufferData.get(n))==null||e.push(os(t))}_createFactory(n){const{geometryType:t,objectIdField:e,fields:i}=this.service,s=(l,u)=>this.remoteClient.invoke("tileRenderer.getMaterialItems",l,u),r={geometryType:t,fields:i,spatialReference:_r.fromJSON(this.spatialReference)},a=new ya(s,this.tileStore.tileScheme.tileInfo),{matcher:o,aggregateMatcher:h}=n.mesh;return this._store=a,this._matchers.feature=Ze(o,a,r,this._resourceManagerProxy),this._matchers.aggregate=Gt(h,l=>Ze(l,a,r,this._resourceManagerProxy)),new xa(t,e,a)}async _onTileData(n,t,e,i){var c;ct(i);const{type:s,addOrUpdate:r,remove:a,clear:o,end:h}=t,l=!!this._schema.mesh.sortKey;if(!r){const d={type:s,addOrUpdate:null,remove:a,clear:o,end:h,sort:l};return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:n.id,data:d},i)}const u=this._processFeatures(n,r,e,i,(c=t.status)==null?void 0:c.version);try{const d=await u;if(V(d)){const _={type:s,addOrUpdate:null,remove:a,clear:o,end:h,sort:l};return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:n.id,data:_},i)}const f=[];for(const _ of d){let m=!1;const p=_.message.bufferIds,y=n.key.id,g=_.message.tileKey;if(y!==g&&E(p)){if(!this.tileStore.get(g)){this._addBufferData(y,_),f.push(_);continue}let M=this._bufferIds.get(g);M||(M=new Set,this._bufferIds.set(g,M));const b=Array.from(p);for(const S of b){if(M.has(S)){m=!0;break}M.add(S)}}m||(this._addBufferData(y,_),f.push(_))}await Promise.all(f.map(_=>{const m=n.key.id===_.message.tileKey,p=m?t.remove:[],y=m&&t.end;return this._updateTileMesh(s,n,_,p,y,!!t.clear,i.signal)}))}catch(d){this._handleError(n,d,i)}}async _updateTileMesh(n,t,e,i,s,r,a){const o=n,h=e.message.tileKey,l=!!this._schema.mesh.sortKey;h!==t.key.id&&(s=!1);const u=Gt(e,_=>_.message),c=Gt(e,_=>_.transferList)||[],d={type:o,addOrUpdate:u,remove:i,clear:r,end:s,sort:l},f={transferList:ue(c)||[],signal:a};return ct(f),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:h,data:d},f)}async _processFeatures(n,t,e,i,s){if(V(t)||!t.hasFeatures)return null;const r={transform:n.transform,hasZ:!1,hasM:!1},a=this._factory,o={viewingMode:"",scale:n.scale},h=await this._matchers.feature,l=await this._matchers.aggregate;ct(i);const u=this._getLabelInfos(n,t);return await a.analyze(t.getCursor(),this._resourceManagerProxy,h,l,r,o),ct(i),this._writeFeatureSet(n,t,r,u,a,e,s)}_writeFeatureSet(n,t,e,i,s,r,a){const o=t.getSize(),h=this._schema.mesh.matcher.symbologyType,l=new sn(n.key.id,{features:o,records:o,metrics:0},h,r,h!==B.HEATMAP,a),u={viewingMode:"",scale:n.scale},c=t.getCursor();for(;c.next();)try{const f=c.getDisplayId(),_=E(i)?i.get(f):null;s.writeCursor(l,c,e,u,n.level,_,this._resourceManagerProxy)}catch{}const d=n.tileInfoView.tileInfo.isWrappable;return l.serialize(d)}_handleError(n,t,e){if(!je(t)){const i={tileKey:n.id,error:t.message};return this.remoteClient.invoke("tileRenderer.onTileError",i,{signal:e.signal})}return Promise.resolve()}_getLabelingSchemaForScale(n){const t=this._schema.mesh.labels;if(V(t))return null;if(t.type==="subtype"){const i={type:"subtype",classes:{}};let s=!1;for(const r in t.classes){const a=t.classes[r].filter(o=>as(o,n.scale));s=s||!!a.length,i.classes[r]=a}return s?i:null}const e=t.classes.filter(i=>as(i,n.scale));return e.length?{type:"simple",classes:e}:null}_getLabels(n,t){if(t.type==="subtype"){const e=this.service.subtypeField,i=mr(e,"Expected to find subtype Field"),s=n.readAttribute(i);return s==null?[]:t.classes[s]??[]}return t.classes}_getLabelInfos(n,t){const e=this._getLabelingSchemaForScale(n);if(V(e))return null;const i=new Map,s=t.getCursor();for(;s.next();){const r=s.getDisplayId(),a=[],o=Ms(r),h=o&&s.readAttribute("cluster_count")!==1?"aggregate":"feature",l=this._getLabels(s,e);for(const u of l){if(u.target!==h)continue;const c=s.getStorage(),d=o&&h==="feature"?c.getComputedStringAtIndex(s.readAttribute("referenceId"),u.fieldIndex):c.getComputedStringAtIndex(r,u.fieldIndex);if(!d)continue;const f=Pe(d.toString()),_=f[0],m=f[1];this._store.getMosaicItem(u.symbol,ri(_)).then(p=>{a[u.index]={glyphs:p.glyphMosaicItems??[],rtl:m,index:u.index}})}i.set(r,a)}return i}};Ue=A([Xe("esri.views.2d.layers.features.processors.SymbolProcessor")],Ue);const ba=Ue,Ja=Object.freeze(Object.defineProperty({__proto__:null,default:ba},Symbol.toStringTag,{value:"Module"}));export{Ka as A,Ja as S,Cs as _,ye as f};
