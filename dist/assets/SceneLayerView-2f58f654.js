import{eK as V,bb as S,bc as z,e as d,a as A,y as f,d as j,eL as K,m as B,eM as Y,eN as Q,eO as H,dv as J,P as W,ay as X,b6 as Z,b3 as T,Y as M,_ as ee,aO as C,eP as te,dG as re,bf as ne}from"./index-d29f6b97.js";import{n as E}from"./FeatureLikeLayerView3D-a7fe98a3.js";import{a as ie,n as se,u as oe}from"./DefinitionExpressionSceneLayerView-60fa2b73.js";import{d as ae}from"./LayerView-923813e2.js";const le={setAttribute(){},setGeometry(e){},rollback(){},commit(){}};var I;function Ie(e,r){const t=r.attributes[e.objectIdField],n=e.sessions.get(t);if(n)return n;const a=V(r.attributes),i=new Set;if(t==null)return le;const c=e.i3sOverrides.createInteractiveEditSession(t),s=new Map,y=(p,l)=>{const u=s.get(p);if(u==null){const g=l.indexOf(t);return s.set(p,g),g}return u};let o=I.EDITING;const h={setAttribute(p,l){if(o!==I.EDITING)return;const u=e.fieldsIndex.get(p);if(!u)return;const g=e.attributeStorageInfo.findIndex(F=>F.name===u.name);if(g<0)return;c.setAttribute(g,l);const _=e.attributeStorageInfo[g];let x=!1;i.add(p),e.forEachNode((F,v)=>{const L=y(F,v);if(L===-1)return;const N=e.getAttributeData(F.index);if(N){const D=N[_.name];D&&(D[L]=l,e.setAttributeData(F.index,N,r),x=!0)}}),x&&e.clearMemCache()},setGeometry(p){o===I.EDITING&&c.setGeometry(p)},rollback(){if(o===I.EDITING){for(const p of i)this.setAttribute(p,a[p]);c.rollback(),o=I.ROLLED_BACK,e.sessions.delete(t)}},commit(){o===I.EDITING&&(c.commit(),o=I.COMMITTED,e.sessions.delete(t))}};return e.sessions.set(t,h),h}function we(e,r){const t=e.fieldsIndex,n=e.objectIdField,a=e.globalIdField;if(a==null)return;const i=new Map,c=pe(r.addedFeatures),s=r.edits.addFeatures,y=$(r.updatedFeatures),o=r.edits.updateFeatures,h=$(r.deletedFeatures),p=r.edits.deleteFeatures;if(s!=null&&s.length>0)for(const l of s){const u=E(t,l.attributes,a),g=c.get(u);l.geometry!=null&&l.geometry.type==="mesh"&&g!=null&&i.set(g,l.geometry)}if(o!=null&&o.length>0)for(const l of o){const u=E(t,l.attributes,n);l.geometry!=null&&l.geometry.type==="mesh"&&y.has(u)&&i.set(u,l.geometry)}if(p!=null&&p.length>0)for(const l of p){let u=null;u="attributes"in l?E(t,l.attributes,n):l.objectId,u!=null&&h.has(u)&&i.set(u,null)}for(const[l,u]of i)e.i3sOverrides.updateGeometry(l,u)}function Fe(e,r){const t=ue(e,r);if(t.size===0)return;const n=new Map;for(let i=0;i<e.attributeStorageInfo.length;i++)n.set(e.attributeStorageInfo[i].name,i);let a=!1;t.forEach((i,c)=>{const s=e.getAttributeData(c);let y=!1;i.forEach((o,h)=>{const p=s!=null?s[h]:null,l=n.get(h);for(const{featureIndex:u,value:g,featureId:_}of o)p&&(p[u]=g,y=!0,a=!0),e.i3sOverrides.updateAttributeValue(_,l,g)}),y&&e.setAttributeData(c,s,null)}),a&&e.clearMemCache()}function ue(e,r){const t=r.edits.updateFeatures;if(!t||t.length===0)return new P;const n=$(r.updatedFeatures),a=new P,i=new Map;for(let o=0;o<e.attributeStorageInfo.length;o++)i.set(e.attributeStorageInfo[o].name,o);const c=e.fieldsIndex,s=e.objectIdField,y=t.filter(o=>{const h=E(c,o.attributes,s);return n.has(h)});return e.forEachNode((o,h)=>{const p=new Set(h);for(const l of y){const u=E(c,l.attributes,s);if(!p.has(u))continue;const g=h.indexOf(u);for(const _ in l.attributes){const x=e.fieldsIndex.normalizeFieldName(_),F=de(a,o.index,x),v=l.attributes[_];F.push({featureIndex:g,featureId:u,value:v})}}}),a}function de(e,r,t){const n=ce(e,r),a=t!=null&&n.get(t);if(a)return a;const i=new Array;return n.set(t,i),i}function ce(e,r){const t=e.get(r);if(t)return t;const n=new fe;return e.set(r,n),n}function pe(e){const r=new Map;if(!e)return r;for(const t of e)t.globalId!=null&&t.objectId!=null&&t.error==null&&r.set(t.globalId,t.objectId);return r}function $(e){const r=new Set;if(!e)return r;for(const t of e)t.objectId!=null&&t.error==null&&r.add(t.objectId);return r}(function(e){e[e.EDITING=0]="EDITING",e[e.ROLLED_BACK=1]="ROLLED_BACK",e[e.COMMITTED=2]="COMMITTED"})(I||(I={}));const fe=Map,P=Map;function _e(){return{requiredFields:{type:[String],readOnly:!0},availableFields:{type:[String],readOnly:!0,get:function(){const{layer:e,layer:{fieldsIndex:r},requiredFields:t}=this;return e.outFields?S(r,[...z(r,e.outFields),...t]):S(r,t)}}}}const q=e=>{let r=class extends e{constructor(){super(...arguments),this._numUpdating=0,this._asyncUpdateState=new Map}get updating(){return this._numUpdating>0}autoUpdateAsync(t,n){return ye(a=>this._updateAsync(t,a),n)}async _updateAsync(t,n){if(!this._startAsyncUpdate(t)){try{const a=await n();this._set(t,a)}catch{j.getLogger(this.declaredClass).warn(`Async update of "${String(t)}" failed. Async update functions should not throw exceptions.`)}this._endAsyncUpdate(t)&&this._updateAsync(t,n)}}_startAsyncUpdate(t){const n=this._asyncUpdateState.get(t)??b.None;return n&b.Updating?(this._asyncUpdateState.set(t,n|b.Invalidated),!0):(++this._numUpdating,this._asyncUpdateState.set(t,n|b.Updating),!1)}_endAsyncUpdate(t){--this._numUpdating;const n=(this._asyncUpdateState.get(t)??b.None)&~b.Updating;return n&b.Invalidated?(this._asyncUpdateState.set(t,n&~b.Invalidated),!0):(this._asyncUpdateState.set(t,n),!1)}};return d([f({readOnly:!0})],r.prototype,"updating",null),d([f()],r.prototype,"_numUpdating",void 0),r=d([A("esri.core.AsyncUpdate")],r),r};var b;function ye(e,r){const t=()=>{i&&!c&&e(n)},n=()=>{if(!i||c)return r();i.clear(),c=!0;const s=Y(i,r);return c=!1,s},a=()=>{i&&(i.destroy(),i=null)};let i=new K(t),c=!1;return e(n),{remove:a}}(function(e){e[e.None=0]="None",e[e.Updating=1]="Updating",e[e.Invalidated=2]="Invalidated"})(b||(b={}));let R=class extends q(B){};R=d([A("esri.core.AsyncUpdate")],R);const G="esri.views.3d.layers.support.SceneLayerViewRequiredFields";let w=class extends q(J){get layer(){return this.layerView.layer}get requiredFields(){const{layerView:{layer:{fieldsIndex:e},definitionExpressionFields:r},rendererFields:t,labelingFields:n,viewFilterFields:a}=this;return S(e,[...r??[],...t??[],...n??[],...a??[]])}constructor(e){super(e)}initialize(){this.handles.add([this.autoUpdateAsync("rendererFields",async()=>{const{fieldsIndex:e,renderer:r}=this.layer;return r?O(t=>r.collectRequiredFields(t,e)):null}),this.autoUpdateAsync("labelingFields",async()=>{const{layer:e}=this;return e.labelsVisible?O(r=>Q(r,e)):null}),this.autoUpdateAsync("viewFilterFields",()=>{const{layer:e,filter:r}=this.layerView;return O(t=>H(t,e,r))})])}};async function O(e){const r=new Set;try{return await e(r),Array.from(r).sort()}catch(t){return j.getLogger(G).error(t),null}}d([f()],w.prototype,"layerView",void 0),d([f()],w.prototype,"layer",null),d([f()],w.prototype,"requiredFields",null),d([f()],w.prototype,"rendererFields",void 0),d([f()],w.prototype,"labelingFields",void 0),d([f()],w.prototype,"viewFilterFields",void 0),w=d([A(G)],w);const k="esri.views.layers.SceneLayerView",U=j.getLogger(k);let m=class extends ae{constructor(){super(...arguments),this.layer=null,this.filter=null,this._geometryEngine=null,this._projectionEngineLoaded=!1,this._abortController=new AbortController}get availableFields(){return[]}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){throw new Error("Not implemented")}get maximumNumberOfFeaturesExceeded(){return!1}get layerFilter(){return ie(this._layerFilter)}get _layerFilter(){const e=this.layer.filter;if(e==null||e.geometries.length<1)return null;const r=this._geometryEngine;if(r==null||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine)return se;const t=e.geometries.getItemAt(0).spatialReference,n=e.geometries.toArray().map(s=>{try{s=r.simplify(s)}catch{return U.warnOncePerTick("Failed to simplify scene filter mask polygon. Polygon will be ignored."),null}if(s==null)return null;if(s.spatialReference.equals(t))return s;try{return W(s,t)}catch{return U.warnOncePerTick("Failed to project scene filter mask polygon. Polygon will be ignored."),null}}).filter(X).sort((s,y)=>s.extent.xmin-y.extent.xmin),a=new Set,i=new Array,c=new Array;for(let s of n){const y=s.extent.xmin;if(i.length=0,a.forEach(o=>{if(y>=o.extent.xmax)return c.push(o),void a.delete(o);s.extent.ymin<=o.extent.ymax&&s.extent.ymax>=o.extent.ymin&&r.intersects(s,o)&&i.push(o)}),i.length>0){i.push(s);try{s=r.union(i)}catch{U.warnOncePerTick("Failed to unify filter mask polygons. Polygon will be ignored.");continue}i.pop(),i.forEach(o=>a.delete(o))}a.add(s)}return a.forEach(s=>c.push(s)),c.length>0?{spatialRelationship:e.spatialRelationship,geometries:c}:null}get _filterNeedsProjectionEngine(){const e=this.layer.filter;if(e==null||e.geometries.length<=1)return!1;const r=e.geometries.getItemAt(0).spatialReference;return e.geometries.some(({spatialReference:t})=>!t.equals(r)&&!Z(t,r))}get layerFilterUpdating(){return oe(this._layerFilter)}initialize(){const{signal:e}=this._abortController;T(()=>{var r,t,n;return this.destroyed||!this._geometryEngine&&((n=(t=(r=this.layer)==null?void 0:r.filter)==null?void 0:t.geometries)==null?void 0:n.length)},e).then(async()=>{M(e),this._geometryEngine=await ee(()=>import("./geometryEngine-cfc072f3.js"),["assets/geometryEngine-cfc072f3.js","assets/geometryEngineBase-4f4260d8.js","assets/index-d29f6b97.js","assets/index-0492b785.css","assets/hydrated-82b0583a.js"])}).catch(C),this._projectionEngineLoaded=te(),T(()=>this.destroyed||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine,e).then(async()=>{M(e),await re(),this._projectionEngineLoaded=!0}).catch(C)}destroy(){this._abortController=ne(this._abortController)}highlight(e){throw new Error("Not implemented")}queryFeatures(e,r){throw new Error("Not implemented")}queryObjectIds(e,r){throw new Error("Not implemented")}queryFeatureCount(e,r){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(e,r){throw new Error("Not implemented")}};d([f()],m.prototype,"layer",void 0),d([f()],m.prototype,"availableFields",null),d([f()],m.prototype,"maximumNumberOfFeatures",null),d([f({readOnly:!0})],m.prototype,"maximumNumberOfFeaturesExceeded",null),d([f()],m.prototype,"filter",void 0),d([f({readOnly:!0})],m.prototype,"layerFilter",null),d([f({readOnly:!0})],m.prototype,"_layerFilter",null),d([f()],m.prototype,"_geometryEngine",void 0),d([f()],m.prototype,"_projectionEngineLoaded",void 0),d([f()],m.prototype,"_filterNeedsProjectionEngine",null),d([f()],m.prototype,"layerFilterUpdating",null),m=d([A(k)],m);const xe=m;export{_e as i,xe as j,Ie as o,w as p,we as s,Fe as u};
