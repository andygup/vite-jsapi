import{su as L,sv as P,sw as j,ko as k,L as D,aw as _,sx as N,sr as q,at as B,sq as G,aM as $,sy as J,kn as K,sz as Q,kJ as C,et as A,sA as U,sB as E,sC as H,sD as V,sE as Z,sF as W,sG as h,sH as X,sI as Y,sJ as O,sK as M,sL as F,sM as ee,sN as te,sO as S,nF as z,sP as I,sQ as ne,sR as oe,bZ as w,ev as re,kz as se,sS as ae,sT as le,sU as ue}from"./index-bdad94d1.js";import{x as ie}from"./georeference-c22be248.js";function ce(e,n,t){const u=e.typedBuffer,r=e.typedBufferStride,f=n.typedBuffer,i=n.typedBufferStride,a=t?t.count:n.count;let s=(t&&t.dstIndex?t.dstIndex:0)*r,d=(t&&t.srcIndex?t.srcIndex:0)*i;for(let l=0;l<a;++l){for(let o=0;o<9;++o)u[s+o]=f[d+o];s+=r,d+=i}}Object.freeze(Object.defineProperty({__proto__:null,copy:ce},Symbol.toStringTag,{value:"Module"}));function fe(e,n,t){const u=e.typedBuffer,r=e.typedBufferStride,f=n.typedBuffer,i=n.typedBufferStride,a=t?t.count:n.count;let s=(t&&t.dstIndex?t.dstIndex:0)*r,d=(t&&t.srcIndex?t.srcIndex:0)*i;for(let l=0;l<a;++l){for(let o=0;o<16;++o)u[s+o]=f[d+o];s+=r,d+=i}}Object.freeze(Object.defineProperty({__proto__:null,copy:fe},Symbol.toStringTag,{value:"Module"}));function y(e,n){return new e(new ArrayBuffer(n*e.ElementCount*L(e.ElementType)))}async function Ce(e,n,t){const u=new P(de(t)),r=(await j(u,n,t,!0)).model,f=r.lods.shift(),i=new Map,a=new Map;r.textures.forEach((g,v)=>i.set(v,xe(g))),r.materials.forEach((g,v)=>a.set(v,ge(g,i)));const s=pe(f);for(const g of s.parts)$e(s,g,a);const{position:d,normal:l,tangent:o,color:c,texCoord0:m}=s.vertexAttributes,x={position:d.typedBuffer,normal:l!=null?l.typedBuffer:null,tangent:o!=null?o.typedBuffer:null,uv:m!=null?m.typedBuffer:null,color:c!=null?c.typedBuffer:null},b=ie(x,e,t);return{transform:b.transform,components:s.components,spatialReference:e.spatialReference,vertexAttributes:new k({position:b.vertexAttributes.position,normal:b.vertexAttributes.normal,tangent:b.vertexAttributes.tangent,color:x.color,uv:x.uv})}}function de(e){const n=e==null?void 0:e.resolveFile;return n?{busy:!1,request:async(t,u,r)=>{const f=n(t);return(await D(f,{responseType:u==="image"?"image":u==="binary"?"array-buffer":"json",signal:r!=null?r.signal:null})).data}}:null}function T(e,n){if(e==null)return"-";const t=e.typedBuffer;return`${_(n,t.buffer,()=>n.size)}/${t.byteOffset}/${t.byteLength}`}function me(e){return e!=null?e.toString():"-"}function pe(e){let n=0;const t={color:!1,tangent:!1,normal:!1,texCoord0:!1},u=new Map,r=new Map,f=[];for(const i of e.parts){const{attributes:{position:a,normal:s,color:d,tangent:l,texCoord0:o}}=i,c=`
      ${T(a,u)}/
      ${T(s,u)}/
      ${T(d,u)}/
      ${T(l,u)}/
      ${T(o,u)}/
      ${me(i.transform)}
    `;let m=!1;const x=_(r,c,()=>(m=!0,{start:n,length:a.count}));m&&(n+=a.count),s&&(t.normal=!0),d&&(t.color=!0),l&&(t.tangent=!0),o&&(t.texCoord0=!0),f.push({gltf:i,writeVertices:m,region:x})}return{vertexAttributes:{position:y(ae,n),normal:t.normal?y(z,n):null,tangent:t.tangent?y(O,n):null,color:t.color?y(F,n):null,texCoord0:t.texCoord0?y(le,n):null},parts:f,components:[]}}function xe(e){return new N({data:(q(e.data),e.data),wrap:be(e.parameters.wrap)})}function ge(e,n){const t=new B(ve(e.color,e.opacity)),u=e.emissiveFactor?new B(he(e.emissiveFactor)):null;return new G({color:t,colorTexture:$(e.textureColor,r=>n.get(r)),normalTexture:$(e.textureNormal,r=>n.get(r)),emissiveColor:u,emissiveTexture:$(e.textureEmissive,r=>n.get(r)),occlusionTexture:$(e.textureOcclusion,r=>n.get(r)),alphaMode:Te(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:$(e.textureMetallicRoughness,r=>n.get(r)),colorTextureTransform:e.colorTextureTransform,normalTextureTransform:e.normalTextureTransform,occlusionTextureTransform:e.occlusionTextureTransform,emissiveTextureTransform:e.emissiveTextureTransform,metallicRoughnessTextureTransform:e.metallicRoughnessTextureTransform})}function $e(e,n,t){n.writeVertices&&ye(e,n);const{indices:u,attributes:r,primitiveType:f,material:i}=n.gltf;let a=J(u||r.position.count,f);const s=n.region.start;if(s){const d=new Uint32Array(a);for(let l=0;l<a.length;l++)d[l]+=s;a=d}e.components.push(new K({faces:a,material:t.get(i),trustSourceNormals:!0}))}function ye(e,n){const{position:t,normal:u,tangent:r,color:f,texCoord0:i}=e.vertexAttributes,a=n.region.start,{attributes:s,transform:d}=n.gltf,l=s.position.count;if(Q(t.slice(a,l),s.position,d),s.normal!=null&&u!=null){const o=C(A(),d),c=u.slice(a,l);U(c,s.normal,o),E(o)&&H(c,c)}else u!=null&&V(u,0,0,1,{dstIndex:a,count:l});if(s.tangent!=null&&r!=null){const o=C(A(),d),c=r.slice(a,l);Z(c,s.tangent,o),E(o)&&W(c,c)}else r!=null&&h(r,0,0,1,1,{dstIndex:a,count:l});if(s.texCoord0!=null&&i!=null?X(i.slice(a,l),s.texCoord0):i!=null&&Y(i,0,0,{dstIndex:a,count:l}),s.color!=null&&f!=null){const o=s.color,c=f.slice(a,l);if(o.elementCount===4)o instanceof O?M(c,o,255):o instanceof F?ee(c,o):o instanceof te&&M(c,o,1/256);else{h(c,255,255,255,255);const m=S.fromTypedArray(c.typedBuffer,c.typedBufferStride);o instanceof z?I(m,o,255):o instanceof S?ne(m,o):o instanceof oe&&I(m,o,1/256)}}else f!=null&&h(f.slice(a,l),255,255,255,255)}function Te(e){switch(e){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function be(e){return{horizontal:R(e.s),vertical:R(e.t)}}function R(e){switch(e){case w.CLAMP_TO_EDGE:return"clamp";case w.MIRRORED_REPEAT:return"mirror";case w.REPEAT:return"repeat"}}function p(e){return e**(1/ue)*255}function ve(e,n){return re(p(e[0]),p(e[1]),p(e[2]),n)}function he(e){return se(p(e[0]),p(e[1]),p(e[2]))}export{Ce as loadGLTFMesh};
