import{ab as G,ac as W,e3 as Vt,ad as _t,aS as Dt,s as Lt,cn as Rt,J as Q,cw as Nt,m as tt,c as Et,bb as jt,ap as Ot,cO as Ut,aD as Gt}from"./index-56384765.js";let mt=class{constructor(e=null,n=null,r=null){this.minValue=e,this.maxValue=n,this.noDataValue=r}};const qt=9999999e31,Wt=2e-7,Xt={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-34028234663852886e22,34028234663852886e22],f64:[-Number.MAX_VALUE,Number.MAX_VALUE]};function ht(t){return Xt[t]??[-34028234663852886e22,34028234663852886e22]}function xe(t,e,n){if(t.depthCount&&t.depthCount>1)return;const{pixels:r,statistics:a,pixelType:i}=t,l=r[0].length,u=t.bandMasks??[],o=t.mask??new Uint8Array(l).fill(255),h=i==="f32"||i==="f64",s=ht(i);let c=!1;for(let p=0;p<r.length;p++){const f=typeof e=="number"?e:e[p];if(f==null)continue;const m=(a==null?void 0:a[p].minValue)??s[0],d=(a==null?void 0:a[p].maxValue)??s[1];if(m>f+Number.EPSILON||d<f-Number.EPSILON)continue;const g=u[p]||new Uint8Array(l).fill(255),y=r[p],M=n==null?void 0:n.customFloatTolerance;if(h&&M!==0){let k=M;k||(k=Math.abs(f)>=qt?Wt*Math.abs(f):i==="f32"?2**-23:Number.EPSILON);for(let x=0;x<y.length;x++)g[x]&&Math.abs(y[x]-f)<k&&(y[x]=0,g[x]=0,o[x]=0,c=!0)}else for(let k=0;k<y.length;k++)g[k]&&y[k]===f&&(y[k]=0,g[k]=0,o[k]=0,c=!0);u[p]=g}c&&(t.bandMasks=u,t.mask=o),c&&"updateStatistics"in t&&t.updateStatistics()}var Y;let j=Y=class extends Dt{static createEmptyBand(t,e){return new(Y.getPixelArrayConstructor(t))(e)}static getPixelArrayConstructor(t){let e;switch(t){case"u1":case"u2":case"u4":case"u8":e=Uint8Array;break;case"u16":e=Uint16Array;break;case"u32":e=Uint32Array;break;case"s8":e=Int8Array;break;case"s16":e=Int16Array;break;case"s32":e=Int32Array;break;case"f32":case"c64":case"c128":case"unknown":e=Float32Array;break;case"f64":e=Float64Array}return e}constructor(t){super(t),this.width=null,this.height=null,this.pixelType="f32",this.validPixelCount=null,this.mask=null,this.maskIsAlpha=!1,this.premultiplyAlpha=!1,this.statistics=null,this.depthCount=1}castPixelType(t){if(!t)return"f32";let e=t.toLowerCase();return["u1","u2","u4"].includes(e)?e="u8":["unknown","u8","s8","u16","s16","u32","s32","f32","f64"].includes(e)||(e="f32"),e}getPlaneCount(){var t;return(t=this.pixels)==null?void 0:t.length}addData(t){if(!t.pixels||t.pixels.length!==this.width*this.height)throw new Lt("pixelblock:invalid-or-missing-pixels","add data requires valid pixels array that has same length defined by pixel block width * height");this.pixels||(this.pixels=[]),this.statistics||(this.statistics=[]),this.pixels.push(t.pixels),this.statistics.push(t.statistics??new mt)}getAsRGBA(){const t=new ArrayBuffer(this.width*this.height*4);switch(this.pixelType){case"s8":case"s16":case"u16":case"s32":case"u32":case"f32":case"f64":this._fillFromNon8Bit(t);break;default:this._fillFrom8Bit(t)}return new Uint8ClampedArray(t)}getAsRGBAFloat(){const t=new Float32Array(this.width*this.height*4);return this._fillFrom32Bit(t),t}updateStatistics(){if(!this.pixels)return;this.statistics=this.pixels.map(n=>this._calculateBandStatistics(n,this.mask));const t=this.mask;let e=0;if(t!=null)for(let n=0;n<t.length;n++)t[n]&&e++;else e=this.width*this.height;this.validPixelCount=e}clamp(t){if(!t||t==="f64"||t==="f32"||!this.pixels)return;const[e,n]=ht(t),r=this.pixels,a=this.width*this.height,i=r.length;let l,u,o;const h=[];for(let s=0;s<i;s++){o=Y.createEmptyBand(t,a),l=r[s];for(let c=0;c<a;c++)u=l[c],o[c]=u>n?n:u<e?e:u;h.push(o)}this.pixels=h,this.pixelType=t}extractBands(t){const{pixels:e,statistics:n}=this;if(t==null||t.length===0||!e||e.length===0)return this;const r=e.length,a=t.some(l=>l>=e.length),i=r===t.length&&!t.some((l,u)=>l!==u);return a||i?this:new Y({pixelType:this.pixelType,width:this.width,height:this.height,mask:this.mask,validPixelCount:this.validPixelCount,maskIsAlpha:this.maskIsAlpha,pixels:t.map(l=>e[l]),statistics:n&&t.map(l=>n[l])})}clone(){const t=new Y({width:this.width,height:this.height,pixelType:this.pixelType,maskIsAlpha:this.maskIsAlpha,validPixelCount:this.validPixelCount});let e;this.mask!=null&&(this.mask instanceof Uint8Array?t.mask=new Uint8Array(this.mask):t.mask=this.mask.slice(0));const n=Y.getPixelArrayConstructor(this.pixelType);if(this.pixels&&this.pixels.length>0){t.pixels=[];const r=!!this.pixels[0].slice;for(e=0;e<this.pixels.length;e++)t.pixels[e]=r?this.pixels[e].slice(0,this.pixels[e].length):new n(this.pixels[e])}if(this.statistics)for(t.statistics=[],e=0;e<this.statistics.length;e++)t.statistics[e]=Rt(this.statistics[e]);return t.premultiplyAlpha=this.premultiplyAlpha,t}_fillFrom8Bit(t){const{mask:e,maskIsAlpha:n,premultiplyAlpha:r,pixels:a}=this;if(!t||!a||!a.length)return void Q.getLogger(this.declaredClass).error("getAsRGBA()","Unable to convert to RGBA. The input pixel block is empty.");let i,l,u,o;i=l=u=a[0],a.length>=3?(l=a[1],u=a[2]):a.length===2&&(l=a[1]);const h=new Uint32Array(t),s=this.width*this.height;if(i.length===s)if(e!=null&&e.length===s)if(n)for(o=0;o<s;o++){const c=e[o];if(c){const p=c/255;h[o]=r?c<<24|u[o]*p<<16|l[o]*p<<8|i[o]*p:c<<24|u[o]<<16|l[o]<<8|i[o]}}else for(o=0;o<s;o++)e[o]&&(h[o]=255<<24|u[o]<<16|l[o]<<8|i[o]);else for(o=0;o<s;o++)h[o]=255<<24|u[o]<<16|l[o]<<8|i[o];else Q.getLogger(this.declaredClass).error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.")}_fillFromNon8Bit(t){const{pixels:e,mask:n,statistics:r}=this;if(!t||!e||!e.length)return void Q.getLogger(this.declaredClass).error("getAsRGBA()","Unable to convert to RGBA. The input pixel block is empty.");const a=this.pixelType;let i=1,l=0,u=1;if(r&&r.length>0){for(const d of r)if(d.minValue!=null&&(l=Math.min(l,d.minValue)),d.maxValue!=null&&d.minValue!=null){const g=d.maxValue-d.minValue;u=Math.max(u,g)}i=255/u}else{let d=255;a==="s8"?(l=-128,d=127):a==="u16"?d=65535:a==="s16"?(l=-32768,d=32767):a==="u32"?d=4294967295:a==="s32"?(l=-2147483648,d=2147483647):a==="f32"?(l=-34e38,d=34e38):a==="f64"&&(l=-Number.MAX_VALUE,d=Number.MAX_VALUE),i=255/(d-l)}const o=new Uint32Array(t),h=this.width*this.height;let s,c,p,f,m;if(s=c=p=e[0],s.length!==h)return Q.getLogger(this.declaredClass).error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.");if(e.length>=2)if(c=e[1],e.length>=3&&(p=e[2]),n!=null&&n.length===h)for(f=0;f<h;f++)n[f]&&(o[f]=255<<24|(p[f]-l)*i<<16|(c[f]-l)*i<<8|(s[f]-l)*i);else for(f=0;f<h;f++)o[f]=255<<24|(p[f]-l)*i<<16|(c[f]-l)*i<<8|(s[f]-l)*i;else if(n!=null&&n.length===h)for(f=0;f<h;f++)m=(s[f]-l)*i,n[f]&&(o[f]=255<<24|m<<16|m<<8|m);else for(f=0;f<h;f++)m=(s[f]-l)*i,o[f]=255<<24|m<<16|m<<8|m}_fillFrom32Bit(t){const{pixels:e,mask:n}=this;if(!t||!e||!e.length)return Q.getLogger(this.declaredClass).error("getAsRGBAFloat()","Unable to convert to RGBA. The input pixel block is empty.");let r,a,i,l;r=a=i=e[0],e.length>=3?(a=e[1],i=e[2]):e.length===2&&(a=e[1]);const u=this.width*this.height;if(r.length!==u)return Q.getLogger(this.declaredClass).error("getAsRGBAFloat()","Unable to convert to RGBA. The pixelblock is invalid.");let o=0;if(n!=null&&n.length===u)for(l=0;l<u;l++)t[o++]=r[l],t[o++]=a[l],t[o++]=i[l],t[o++]=1&n[l];else for(l=0;l<u;l++)t[o++]=r[l],t[o++]=a[l],t[o++]=i[l],t[o++]=1}_calculateBandStatistics(t,e){let n=1/0,r=-1/0;const a=t.length;let i,l=0;if(e!=null)for(i=0;i<a;i++)e[i]&&(l=t[i],n=l<n?l:n,r=l>r?l:r);else for(i=0;i<a;i++)l=t[i],n=l<n?l:n,r=l>r?l:r;return new mt(n,r)}};G([W({json:{write:!0}})],j.prototype,"width",void 0),G([W({json:{write:!0}})],j.prototype,"height",void 0),G([W({json:{write:!0}})],j.prototype,"pixelType",void 0),G([Vt("pixelType")],j.prototype,"castPixelType",null),G([W({json:{write:!0}})],j.prototype,"validPixelCount",void 0),G([W({json:{write:!0}})],j.prototype,"mask",void 0),G([W({json:{write:!0}})],j.prototype,"maskIsAlpha",void 0),G([W({json:{write:!0}})],j.prototype,"pixels",void 0),G([W()],j.prototype,"premultiplyAlpha",void 0),G([W({json:{write:!0}})],j.prototype,"statistics",void 0),G([W({json:{write:!0}})],j.prototype,"depthCount",void 0),G([W({json:{write:!0}})],j.prototype,"noDataValues",void 0),G([W({json:{write:!0}})],j.prototype,"bandMasks",void 0),j=Y=G([_t("esri.layers.support.PixelBlock")],j);const _=j;var gt,xt;(function(t){t[t.matchAny=0]="matchAny",t[t.matchAll=1]="matchAll"})(gt||(gt={})),function(t){t[t.bestMatch=0]="bestMatch",t[t.fail=1]="fail"}(xt||(xt={}));const we=6;function L(t){return t!=null&&t.declaredClass==="esri.layers.support.PixelBlock"&&t.pixels&&t.pixels.length>0}function ye(t,e){if(!(e!=null&&e.length)||!L(t))return t;const n=t.pixels.length;return e&&e.some(r=>r>=n)||n===1&&e.length===1&&e[0]===0?t:n!==e.length||e.some((r,a)=>r!==a)?new _({pixelType:t.pixelType,width:t.width,height:t.height,mask:t.mask,validPixelCount:t.validPixelCount,maskIsAlpha:t.maskIsAlpha,pixels:e.map(r=>t.pixels[r]),statistics:t.statistics&&e.map(r=>t.statistics[r])}):t}function ke(t){var s;if(!(t!=null&&t.length)||t.some(c=>!L(c)))return null;if(t.length===1)return((s=t[0])==null?void 0:s.clone())??null;const e=t,{width:n,height:r,pixelType:a}=e[0];if(e.some(c=>c.width!==n||c.height!==r))return null;const i=e.map(({mask:c})=>c).filter(c=>c!=null);let l=null;i.length&&(l=new Uint8Array(n*r),l.set(i[0]),i.length>1&&$t(i.slice(1),l));const u=[];e.forEach(({pixels:c})=>u.push(...c));const o=e.map(({statistics:c})=>c).filter(c=>c==null?void 0:c.length),h=[];return o.forEach(c=>h.push(...c)),new _({pixelType:a,width:n,height:r,mask:l,pixels:u,statistics:h.length?h:null})}function Me(t){if(!t)return;const e=t.colormap;if(!e||e.length===0)return;const n=e.sort((c,p)=>c[0]-p[0]);let r=0;n[0][0]<0&&(r=n[0][0]);const a=Math.max(256,n[n.length-1][0]-r+1),i=new Uint8Array(4*a),l=[];let u,o=0,h=0;const s=n[0].length===5;if(a>65536)return n.forEach(c=>{l[c[0]-r]=s?c.slice(1):c.slice(1).concat([255])}),{indexed2DColormap:l,offset:r,alphaSpecified:s};if(t.fillUnspecified)for(u=n[h],o=u[0]-r;o<a;o++)i[4*o]=u[1],i[4*o+1]=u[2],i[4*o+2]=u[3],i[4*o+3]=s?u[4]:255,o===u[0]-r&&(u=h===n.length-1?u:n[++h]);else for(o=0;o<n.length;o++)u=n[o],h=4*(u[0]-r),i[h]=u[1],i[h+1]=u[2],i[h+2]=u[3],i[h+3]=s?u[4]:255;return{indexedColormap:i,offset:r,alphaSpecified:s}}function Ae(t,e){if(!L(t)||!e||!e.indexedColormap&&!e.indexed2DColormap)return t;const n=t.clone(),r=n.pixels;let a=n.mask;const i=n.width*n.height;if(r.length!==1)return t;const{indexedColormap:l,indexed2DColormap:u,offset:o,alphaSpecified:h}=e;let s=0;const c=r[0],p=new Uint8Array(c.length),f=new Uint8Array(c.length),m=new Uint8Array(c.length);let d,g=0;if(l){const y=l.length-1;if(a!=null)for(s=0;s<i;s++)a[s]&&(g=4*(c[s]-o),g<o||g>y?a[s]=0:(p[s]=l[g],f[s]=l[g+1],m[s]=l[g+2],a[s]=l[g+3]));else{for(a=new Uint8Array(i),s=0;s<i;s++)g=4*(c[s]-o),g<o||g>y?a[s]=0:(p[s]=l[g],f[s]=l[g+1],m[s]=l[g+2],a[s]=l[g+3]);n.mask=a}}else if(u)if(a!=null)for(s=0;s<i;s++)a[s]&&(d=u[c[s]],p[s]=d[0],f[s]=d[1],m[s]=d[2],a[s]=d[3]);else{for(a=new Uint8Array(i),s=0;s<i;s++)d=u[c[s]],p[s]=d[0],f[s]=d[1],m[s]=d[2],a[s]=d[3];n.mask=a}return n.pixels=[p,f,m],n.statistics=null,n.pixelType="u8",n.maskIsAlpha=h,n}function be(t,e){if(!L(t))return null;const{pixels:n,mask:r}=t,a=n.length;let i=e.lut;const{offset:l}=e;i&&i[0].length===1&&(i=n.map(()=>i));const u=[],o=e.outputPixelType||"u8";for(let s=0;s<a;s++){const c=Pt(n[s],r,i[s],l||0,o);u.push(c)}const h=new _({width:t.width,height:t.height,pixels:u,mask:r,pixelType:o});return h.updateStatistics(),h}function Pt(t,e,n,r,a){const i=t.length,l=_.createEmptyBand(a,i);if(e)for(let u=0;u<i;u++)e[u]&&(l[u]=n[t[u]-r]);else for(let u=0;u<i;u++)l[u]=n[t[u]-r];return l}function ve(t,e){if(!L(t))return null;const n=t.clone(),{pixels:r}=n,a=n.width*n.height,i=e.length,l=Math.floor(i/2),u=e[Math.floor(l)],o=r[0];let h,s,c,p,f,m,d=!1;const g=new Uint8Array(a),y=new Uint8Array(a),M=new Uint8Array(a);let k=n.mask;const x=e[0].mappedColor.length===4;for(k||(k=new Uint8Array(a),k.fill(x?255:1),n.mask=k),f=0;f<a;f++)if(k[f]){for(h=o[f],d=!1,m=l,s=u,c=0,p=i-1;p-c>1;){if(h===s.value){d=!0;break}h>s.value?c=m:p=m,m=Math.floor((c+p)/2),s=e[Math.floor(m)]}d||(h===e[c].value?(s=e[c],d=!0):h===e[p].value?(s=e[p],d=!0):h<e[c].value?(d=!1,s=null):h>e[c].value&&(h<e[p].value?(s=e[c],d=!0):p===i-1?(d=!1,s=null):(s=e[p],d=!0))),d?(g[f]=s.mappedColor[0],y[f]=s.mappedColor[1],M[f]=s.mappedColor[2],k[f]=s.mappedColor[3]):g[f]=y[f]=M[f]=k[f]=0}return n.pixels=[g,y,M],n.mask=k,n.pixelType="u8",n.maskIsAlpha=x,n}function Ue(t,e){if(!L(t))return null;const{width:n,height:r}=t,{inputRanges:a,outputValues:i,outputPixelType:l,noDataRanges:u,allowUnmatched:o,isLastInputRangeInclusive:h}=e,s=t.pixels[0],c=_.createEmptyBand(l,s.length),p=t.mask,f=new Uint8Array(n*r);p?f.set(p):f.fill(255);const m=t.pixelType.startsWith("f")?1e-6:0,d=a.map(x=>x-m);d[0]=a[0],d[d.length-1]=a[a.length-1]+(h?1e-6:0);const g=a.length/2,[y,M]=ht(l);for(let x=0;x<r;x++)for(let w=0;w<n;w++){const A=x*n+w;if(f[A]){const b=s[A];let v=!1;for(let U=g-1;U>=0;U--)if(b===d[2*U]||b>d[2*U]&&b<d[2*U+1]){c[A]=i[U],v=!0;break}v||(o?c[A]=b>M?M:b<y?y:b:f[A]=0)}}const k=u==null?void 0:u.length;if(k)for(let x=0;x<r;x++)for(let w=0;w<n;w++){const A=x*n+w;if(!p||p[A]){const b=s[A];for(let v=0;v<k;v+=2)if(b>=u[v]&&b<=u[v+1]){c[A]=0,f[A]=0;break}}}return new _({width:n,height:r,pixelType:l,pixels:[c],mask:f})}function wt(t,e,n,r){const a=n!=null&&n.length>=2?new Set(n):null,i=(n==null?void 0:n.length)===1?n[0]:null,l=!!(e!=null&&e.length);for(let u=0;u<t.length;u++)if(r[u]){const o=t[u];if(l){let h=!1;for(let s=0;s<e.length;s+=2)if(o>=e[s]&&o<=e[s+1]){h=!0;break}h||(r[u]=0)}r[u]&&(o===i||a!=null&&a.has(o))&&(r[u]=0)}}function yt(t,e){const n=t[0].length;for(let r=0;r<n;r++)if(e[r]){let a=!1;for(let i=0;i<t.length;i++)if(t[i][r]){a=!0;break}a||(e[r]=0)}}function $t(t,e){const n=t[0].length;for(let r=0;r<n;r++)if(e[r]){let a=!1;for(let i=0;i<t.length;i++)if(t[i][r]===0){a=!0;break}a&&(e[r]=0)}}function Pe(t,e){if(!L(t))return null;const{width:n,height:r,pixels:a}=t,i=n*r,l=new Uint8Array(i);t.mask?l.set(t.mask):l.fill(255);const u=a.length,{includedRanges:o,noDataValues:h,outputPixelType:s,matchAll:c,lookups:p}=e;if(p){const f=[];for(let m=0;m<u;m++){const d=p[m],g=Pt(a[m],l,d.lut,d.offset||0,"u8");f.push(g)}f.length===1?l.set(f[0]):c?yt(f,l):$t(f,l)}else if(c){const f=[];for(let m=0;m<u;m++){const d=new Uint8Array(i);d.set(l),wt(a[m],o==null?void 0:o.slice(2*m,2*m+2),h==null?void 0:h[m],d),f.push(d)}f.length===1?l.set(f[0]):yt(f,l)}else for(let f=0;f<u;f++)wt(a[f],o==null?void 0:o.slice(2*f,2*f+2),h==null?void 0:h[f],l);return new _({width:n,height:r,pixelType:s,pixels:a,mask:l})}function $e(t){const{srcPixelType:e,inputRanges:n,outputValues:r,allowUnmatched:a,noDataRanges:i,isLastInputRangeInclusive:l,outputPixelType:u}=t;if(e!=="u8"&&e!=="s8"&&e!=="u16"&&e!=="s16")return null;const o=e.includes("16")?65536:256,h=e.includes("s")?-o/2:0,s=_.createEmptyBand(u,o),c=new Uint8Array(o);a&&c.fill(255);const[p,f]=ht(u);if(n!=null&&n.length&&(r!=null&&r.length)){const d=n.map(g=>g-1e-6);d[0]=n[0],l&&(d[d.length-1]=n[n.length-1]);for(let g=0;g<d.length;g++){const y=r[g]>f?f:r[g]<p?p:r[g],M=Math.ceil(d[2*g]-h),k=Math.floor(d[2*g+1]-h);for(let x=M;x<=k;x++)s[x]=y,c[x]=255}}if(i!=null&&i.length)for(let m=0;m<i.length;m++){const d=Math.ceil(i[2*m]-h),g=Math.floor(i[2*m+1]-h);for(let y=d;y<=g;y++)c[y]=0}return{lut:s,offset:h,mask:c}}function Te(t,e,n){if(t!=="u8"&&t!=="s8"&&t!=="u16"&&t!=="s16")return null;const r=t.includes("16")?65536:256,a=t.includes("s")?-r/2:0,i=new Uint8Array(r);if(e)for(let l=0;l<e.length;l++){const u=Math.ceil(e[2*l]-a),o=Math.floor(e[2*l+1]-a);for(let h=u;h<=o;h++)i[h]=255}else i.fill(255);if(n)for(let l=0;l<n.length;l++)i[n[l]-a]=0;return{lut:i,offset:a}}function Jt(t,e,n,r,a,i,l,u){return{xmin:a<=n*t?0:a<n*t+t?a-n*t:t,ymin:i<=r*e?0:i<r*e+e?i-r*e:e,xmax:a+l<=n*t?0:a+l<n*t+t?a+l-n*t:t,ymax:i+u<=r*e?0:i+u<r*e+e?i+u-r*e:e}}function Ie(t,e){if(!t||t.length===0)return null;const n=t.find(m=>m.pixelBlock);if(!n||n.pixelBlock==null)return null;const r=(n.extent.xmax-n.extent.xmin)/n.pixelBlock.width,a=(n.extent.ymax-n.extent.ymin)/n.pixelBlock.height,i=.01*Math.min(r,a),l=t.sort((m,d)=>Math.abs(m.extent.ymax-d.extent.ymax)>i?d.extent.ymax-m.extent.ymax:Math.abs(m.extent.xmin-d.extent.xmin)>i?m.extent.xmin-d.extent.xmin:0),u=Math.min.apply(null,l.map(m=>m.extent.xmin)),o=Math.min.apply(null,l.map(m=>m.extent.ymin)),h=Math.max.apply(null,l.map(m=>m.extent.xmax)),s=Math.max.apply(null,l.map(m=>m.extent.ymax)),c={x:Math.round((e.xmin-u)/r),y:Math.round((s-e.ymax)/a)},p={width:Math.round((h-u)/r),height:Math.round((s-o)/a)},f={width:Math.round((e.xmax-e.xmin)/r),height:Math.round((e.ymax-e.ymin)/a)};return Math.round(p.width/n.pixelBlock.width)*Math.round(p.height/n.pixelBlock.height)!==l.length||c.x<0||c.y<0||p.width<f.width||p.height<f.height?null:{extent:e,pixelBlock:zt(l.map(m=>m.pixelBlock),p,{clipOffset:c,clipSize:f})}}function kt(t,e,n,r,a,i){const{width:l,height:u}=n.block,{x:o,y:h}=n.offset,{width:s,height:c}=n.mosaic,p=Jt(l,u,r,a,o,h,s,c);let f=0,m=0;if(i){const d=i.hasGCSSShiftTransform?360:i.halfWorldWidth??0,g=l*i.resolutionX,y=i.startX+r*g;y<d&&y+g>d?m=i.rightPadding:y>=d&&(f=i.leftMargin-i.rightPadding,m=0)}if(p.xmax-=m,typeof e!="number")for(let d=p.ymin;d<p.ymax;d++){const g=(a*u+d-h)*s+(r*l-o)+f,y=d*l;for(let M=p.xmin;M<p.xmax;M++)t[g+M]=e[y+M]}else for(let d=p.ymin;d<p.ymax;d++){const g=(a*u+d-h)*s+(r*l-o)+f;for(let y=p.xmin;y<p.xmax;y++)t[g+y]=e}}function zt(t,e,n={}){const{clipOffset:r,clipSize:a,alignmentInfo:i,blockWidths:l}=n;if(l)return Ht(t,e,{blockWidths:l});const u=t.find(b=>L(b));if(u==null)return null;const o=a?a.width:e.width,h=a?a.height:e.height,s=u.width,c=u.height,p=e.width/s,f=e.height/c,m={offset:r||{x:0,y:0},mosaic:a||e,block:{width:s,height:c}},d=u.pixelType,g=_.getPixelArrayConstructor(d),y=u.pixels.length,M=[];let k,x;for(let b=0;b<y;b++){x=new g(o*h);for(let v=0;v<f;v++)for(let U=0;U<p;U++){const P=t[v*p+U];L(P)&&(k=P.pixels[b],kt(x,k,m,U,v,i))}M.push(x)}let w;if(t.some(b=>b==null||b.mask!=null&&b.mask.length>0)){w=new Uint8Array(o*h);for(let b=0;b<f;b++)for(let v=0;v<p;v++){const U=t[b*p+v],P=U!=null?U.mask:null;kt(w,P??(U?1:0),m,v,b,i)}}const A=new _({width:o,height:h,pixels:M,pixelType:d,mask:w});return A.updateStatistics(),A}function Ht(t,e,n){const r=t.find(f=>f!=null);if(r==null)return null;const a=t.some(f=>f==null||!!f.mask),{width:i,height:l}=e,u=a?new Uint8Array(i*l):null,{blockWidths:o}=n,h=[],s=r.getPlaneCount(),c=_.getPixelArrayConstructor(r.pixelType);if(a)for(let f=0,m=0;f<t.length;m+=o[f],f++){const d=t[f];if(!L(d))continue;const g=d.mask;for(let y=0;y<l;y++)for(let M=0;M<o[f];M++)u[y*i+M+m]=g==null?255:g[y*d.width+M]}for(let f=0;f<s;f++){const m=new c(i*l);for(let d=0,g=0;d<t.length;g+=o[d],d++){const y=t[d];if(!L(y))continue;const M=y.pixels[f];if(M!=null)for(let k=0;k<l;k++)for(let x=0;x<o[d];x++)m[k*i+x+g]=M[k*y.width+x]}h.push(m)}const p=new _({width:i,height:l,mask:u,pixels:h,pixelType:r.pixelType});return p.updateStatistics(),p}function Se(t,e,n){if(!L(t))return null;const{width:r,height:a}=t,i=e.x,l=e.y,u=n.width+i,o=n.height+l;if(i<0||l<0||u>r||o>a||i===0&&l===0&&u===r&&o===a)return t;t.mask||(t.mask=new Uint8Array(r*a));const h=t.mask;for(let s=0;s<a;s++){const c=s*r;for(let p=0;p<r;p++)h[c+p]=s<l||s>=o||p<i||p>=u?0:1}return t.updateStatistics(),t}function Kt(t){if(!L(t))return null;const e=t.clone(),{width:n,height:r,pixels:a}=t,i=a[0],l=e.pixels[0],u=t.mask;for(let o=2;o<r-1;o++){const h=new Map;for(let c=o-2;c<o+2;c++)for(let p=0;p<4;p++){const f=c*n+p;lt(h,i[f],u?u[f]:1)}l[o*n]=Mt(h),l[o*n+1]=l[o*n+2]=l[o*n];let s=3;for(;s<n-1;s++){let c=(o-2)*n+s+1;lt(h,i[c],u?u[c]:1),c=(o-1)*n+s+1,lt(h,i[c],u?u[c]:1),c=o*n+s+1,lt(h,i[c],u?u[c]:1),c=(o+1)*n+s+1,lt(h,i[c],u?u[c]:1),c=(o-2)*n+s-3,rt(h,i[c],u?u[c]:1),c=(o-1)*n+s-3,rt(h,i[c],u?u[c]:1),c=o*n+s-3,rt(h,i[c],u?u[c]:1),c=(o+1)*n+s-3,rt(h,i[c],u?u[c]:1),l[o*n+s]=Mt(h)}l[o*n+s+1]=l[o*n+s]}for(let o=0;o<n;o++)l[o]=l[n+o]=l[2*n+o],l[(r-1)*n+o]=l[(r-2)*n+o];return e.updateStatistics(),e}function Mt(t){if(t.size===0)return 0;let e=0,n=-1,r=0;const a=t.keys();let i=a.next();for(;!i.done;)r=t.get(i.value),r>e&&(n=i.value,e=r),i=a.next();return n}function rt(t,e,n){if(n===0)return;const r=t.get(e);r===1?t.delete(e):t.set(e,r-1)}function lt(t,e,n){n!==0&&t.set(e,t.has(e)?t.get(e)+1:1)}function Qt(t,e,n){let{x:r,y:a}=e;const{width:i,height:l}=n;if(r===0&&a===0&&l===t.height&&i===t.width)return t;const{width:u,height:o}=t,h=Math.max(0,a),s=Math.max(0,r),c=Math.min(r+i,u),p=Math.min(a+l,o);if(c<0||p<0||!L(t))return null;r=Math.max(0,-r),a=Math.max(0,-a);const{pixels:f}=t,m=i*l,d=f.length,g=[];for(let x=0;x<d;x++){const w=f[x],A=_.createEmptyBand(t.pixelType,m);for(let b=h;b<p;b++){const v=b*u;let U=(b+a-h)*i+r;for(let P=s;P<c;P++)A[U++]=w[v+P]}g.push(A)}const y=new Uint8Array(m),M=t.mask;for(let x=h;x<p;x++){const w=x*u;let A=(x+a-h)*i+r;for(let b=s;b<c;b++)y[A++]=M?M[w+b]:1}const k=new _({width:n.width,height:n.height,pixelType:t.pixelType,pixels:g,mask:y});return k.updateStatistics(),k}function Yt(t,e=!0){if(!L(t))return null;const{pixels:n,width:r,height:a,mask:i,pixelType:l}=t,u=[],o=Math.round(r/2),h=Math.round(a/2),s=a-1,c=r-1;for(let f=0;f<n.length;f++){const m=n[f],d=_.createEmptyBand(l,o*h);let g=0;for(let y=0;y<a;y+=2)for(let M=0;M<r;M+=2){const k=m[y*r+M];if(e){const x=M===c?k:m[y*r+M+1],w=y===s?k:m[y*r+M+r],A=M===c?w:y===s?x:m[y*r+M+r+1];d[g++]=(k+x+w+A)/4}else d[g++]=k}u.push(d)}let p=null;if(i!=null){p=new Uint8Array(o*h);let f=0;for(let m=0;m<a;m+=2)for(let d=0;d<r;d+=2){const g=i[m*r+d];if(e){const y=d===c?g:i[m*r+d+1],M=m===s?g:i[m*r+d+r],k=d===c?M:m===s?y:i[m*r+d+r+1];p[f++]=g*y*M*k?1:0}else p[f++]=g}}return new _({width:o,height:h,pixelType:l,pixels:u,mask:p})}function Be(t,e,n){if(!L(t))return null;const{width:r,height:a}=e;let{width:i,height:l}=t;const u=new Map,o={x:0,y:0},h=n==null?1:1+n;let s=t;for(let c=0;c<h;c++){const p=Math.ceil(i/r),f=Math.ceil(l/a);for(let m=0;m<f;m++){o.y=m*a;for(let d=0;d<p;d++){o.x=d*r;const g=Qt(s,o,e);u.set(`${c}/${m}/${d}`,g)}}c<h-1&&(s=Yt(s)),i=Math.round(i/2),l=Math.round(l/2)}return u}function Tt(t,e,n,r,a=0){const{width:i,height:l}=t,{width:u,height:o}=e,h=r.cols,s=r.rows,c=Math.ceil(u/h-.1/h),p=Math.ceil(o/s-.1/s);let f,m,d,g,y,M,k;const x=c*h,w=x*p*s,A=new Float32Array(w),b=new Float32Array(w),v=new Uint32Array(w),U=new Uint32Array(w);let P,B,I=0;for(let S=0;S<p;S++)for(let F=0;F<c;F++){f=12*(S*c+F),m=n[f],d=n[f+1],g=n[f+2],y=n[f+3],M=n[f+4],k=n[f+5];for(let T=0;T<s;T++){I=(S*s+T)*x+F*h,B=(T+.5)/s;for(let $=0;$<T;$++)P=($+.5)/h,A[I+$]=(m*P+d*B+g)*i+a,b[I+$]=(y*P+M*B+k)*l+a,v[I+$]=Math.floor(A[I+$]),U[I+$]=Math.floor(b[I+$])}f+=6,m=n[f],d=n[f+1],g=n[f+2],y=n[f+3],M=n[f+4],k=n[f+5];for(let T=0;T<s;T++){I=(S*s+T)*x+F*h,B=(T+.5)/s;for(let $=T;$<h;$++)P=($+.5)/h,A[I+$]=(m*P+d*B+g)*i+a,b[I+$]=(y*P+M*B+k)*l+a,v[I+$]=Math.floor(A[I+$]),U[I+$]=Math.floor(b[I+$])}}return{offsets_x:A,offsets_y:b,offsets_xi:v,offsets_yi:U,gridWidth:x}}function Ce(t,e){const{coefficients:n,spacing:r}=e,{offsets_x:a,offsets_y:i,gridWidth:l}=Tt(t,t,n,{rows:r[0],cols:r[1]}),{width:u,height:o}=t,h=new Float32Array(u*o),s=180/Math.PI;for(let c=0;c<o;c++)for(let p=0;p<u;p++){const f=c*l+p,m=c===0?f:f-l,d=c===o-1?f:f+l,g=a[m]-a[d],y=i[d]-i[m];if(isNaN(g)||isNaN(y))h[c*u+p]=90;else{let M=Math.atan2(y,g)*s;M=(360+M)%360,h[c*u+p]=M}}return h}function Fe(t,e,n,r,a="nearest"){if(!L(t))return null;a==="majority"&&(t=Kt(t));const{pixels:i,mask:l,pixelType:u}=t,o=t.width,h=t.height,s=_.getPixelArrayConstructor(u),c=i.length,{width:p,height:f}=e;let m=!1;for(let U=0;U<n.length;U+=3)n[U]===-1&&n[U+1]===-1&&n[U+2]===-1&&(m=!0);const{offsets_x:d,offsets_y:g,offsets_xi:y,offsets_yi:M,gridWidth:k}=Tt({width:o,height:h},e,n,r,a==="majority"?.5:0);let x;const w=(U,P,B)=>{const I=U instanceof Float32Array||U instanceof Float64Array?0:.5;for(let S=0;S<f;S++){x=S*k;for(let F=0;F<p;F++){if(d[x]<0||g[x]<0)U[S*p+F]=0;else if(B)U[S*p+F]=P[y[x]+M[x]*o];else{const T=Math.floor(d[x]),$=Math.floor(g[x]),C=Math.ceil(d[x]),V=Math.ceil(g[x]),E=d[x]-T,X=g[x]-$;if(!l||l[T+$*o]&&l[C+$*o]&&l[T+V*o]&&l[C+V*o]){const O=(1-E)*P[T+$*o]+E*P[C+$*o],q=(1-E)*P[T+V*o]+E*P[C+V*o];U[S*p+F]=(1-X)*O+X*q+I}else U[S*p+F]=P[y[x]+M[x]*o]}x++}}},A=[];let b;for(let U=0;U<c;U++)b=new s(p*f),w(b,i[U],a==="nearest"||a==="majority"),A.push(b);const v=new _({width:p,height:f,pixelType:u,pixels:A});if(l!=null)v.mask=new Uint8Array(p*f),w(v.mask,l,!0);else if(m){v.mask=new Uint8Array(p*f);for(let U=0;U<p*f;U++)v.mask[U]=d[U]<0||g[U]<0?0:1}return v.updateStatistics(),v}const Z=new Map;Z.set("meter-per-second",1),Z.set("kilometer-per-hour",.277778),Z.set("knots",.514444),Z.set("feet-per-second",.3048),Z.set("mile-per-hour",.44704);const ft=180/Math.PI,pt=5,at=new Nt({esriMetersPerSecond:"meter-per-second",esriKilometersPerHour:"kilometer-per-hour",esriKnots:"knots",esriFeetPerSecond:"feet-per-second",esriMilesPerHour:"mile-per-hour"});function dt(t,e){return Z.get(t)/Z.get(e)||1}function It(t){return(450-t)%360}function St(t,e="geographic"){const[n,r]=t,a=Math.sqrt(n*n+r*r);let i=Math.atan2(r,n)*ft;return i=(360+i)%360,e==="geographic"&&(i=It(i)),[a,i]}function Bt(t,e="geographic"){let n=t[1];e==="geographic"&&(n=It(n)),n%=360;const r=t[0];return[r*Math.cos(n/ft),r*Math.sin(n/ft)]}function Ve(t,e,n,r="geographic"){if(!L(t)||n==null)return t;const a=e==="vector-magdir"?t.clone():At(t,e),i=a.pixels[1];for(let l=0;l<i.length;l++)i[l]=r==="geographic"?(i[l]+n[l]+270)%360:(i[l]+360-n[l])%360;return e==="vector-magdir"?a:At(a,"vector-magdir")}function At(t,e,n="geographic",r=1){if(!L(t))return t;const{pixels:a,width:i,height:l}=t,u=i*l,o=a[0],h=a[1],s=t.pixelType.startsWith("f")?t.pixelType:"f32",c=_.createEmptyBand(s,u),p=_.createEmptyBand(s,u);let f=0;for(let d=0;d<l;d++)for(let g=0;g<i;g++)e==="vector-uv"?([c[f],p[f]]=St([o[f],h[f]],n),c[f]*=r):([c[f],p[f]]=Bt([o[f],h[f]],n),c[f]*=r,p[f]*=r),f++;const m=new _({pixelType:s,width:t.width,height:t.height,mask:t.mask,validPixelCount:t.validPixelCount,maskIsAlpha:t.maskIsAlpha,pixels:[c,p]});return m.updateStatistics(),m}function _e(t,e,n=1){if(n===1||!L(t))return t;const r=t.clone(),{pixels:a,width:i,height:l}=r,u=a[0],o=a[1];let h=0;for(let s=0;s<l;s++)for(let c=0;c<i;c++)e==="vector-uv"?(u[h]*=n,o[h]*=n):u[h]*=n,h++;return r.updateStatistics(),r}function De(t,e,n,r,a){if(a==null||!a.spatialReference.equals(t.spatialReference))return{extent:t,width:Math.round(e/r),height:Math.round(n/r),resolution:t.width/e};const i=a.xmin,l=a.ymax,u=(t.xmax-t.xmin)/e*r,o=(t.ymax-t.ymin)/n*r,h=(u+o)/2;return t.xmin=i+Math.floor((t.xmin-i)/u)*u,t.xmax=i+Math.ceil((t.xmax-i)/u)*u,t.ymin=l+Math.floor((t.ymin-l)/o)*o,t.ymax=l+Math.ceil((t.ymax-l)/o)*o,{extent:t,width:Math.round(t.width/u),height:Math.round(t.height/o),resolution:h}}const Zt=Ct(0,0,0);function Ct(t=0,e=0,n=Math.PI,r=!0){r&&(n=(2*Math.PI-n)%(2*Math.PI));const a=r?-1:1,i=13*a,l=-7*a,u=-2*a,o=-16*a,h=21.75,[s,c]=N(0,e+i,n,h),[p,f]=N(t-5.5,e+l,n,h),[m,d]=N(t+5.5,e+l,n,h),[g,y]=N(t-1.5,e+u,n,h),[M,k]=N(t+1.5,e+u,n,h),[x,w]=N(t-1.5,e+o,n,h),[A,b]=N(t+1.5,e+o,n,h);return[s,c,p,f,g,y,M,k,m,d,x,w,A,b]}function te(t=0,e=Math.PI,n=!0){n&&(e=(2*Math.PI-e)%(2*Math.PI));const r=10,a=n?-1:1,i=5*a,l=20*a,u=25*a,o=45,h=0,s=0,c=2,p=0,f=c*a,m=n?1:-1,d=r/2*m;let[g,y]=[h+d,s-l],[M,k]=[g+c*m,y],[x,w]=[M-p*m,k+f],[A,b]=[h-d,s-u],[v,U]=[A+p*m,b-f],P=Math.ceil(t/pt),B=Math.floor(P/10);P-=8*B;const I=[],S=[];for(let z=0;z<P/2;z++,B--){B<=0&&P%2==1&&z===(P-1)/2&&(A=h,v=A+p*m,b=(b+y)/2,U=b-f);const[H,st]=N(A,b,e,o);if(B>0){const[et,nt]=N(M,b,e,o),[it,D]=N(g,y,e,o);I.push(et),I.push(nt),I.push(H),I.push(st),I.push(it),I.push(D)}else{const[et,nt]=N(M,k,e,o),[it,D]=N(x,w,e,o),[R,ct]=N(v,U,e,o);S.push(H),S.push(st),S.push(R),S.push(ct),S.push(it),S.push(D),S.push(et),S.push(nt)}b+=i,y+=i,k+=i,w+=i,U+=i}const[F,T]=N(h+d,s+l,e,o),$=(r/2+c)*m,[C,V]=N(h+$,s+l,e,o),[E,X]=N(h+d,s-u,e,o),[O,q]=N(h+$,s-u,e,o);return{pennants:I,barbs:S,shaft:[F,T,C,V,E,X,O,q]}}function N(t,e,n,r=1){const a=Math.sqrt(t*t+e*e)/r,i=(2*Math.PI+Math.atan2(e,t))%(2*Math.PI);return[a,(2*Math.PI+i-n)%(2*Math.PI)]}const ot=[0,1,3,6,10,16,21,27,33,40,47,55,63],ee=[0,.5,1,1.5,2],ne=[0,.25,.5,1,1.5,2,2.5,3,3.5,4];function K(t,e,n,r){const a=dt(r||"knots",n);let i;for(i=1;i<e.length;i++)if(i===e.length-1){if(t<e[i]*a)break}else if(t<=e[i]*a)break;return Math.min(i-1,e.length-2)}function ie(t,e,n,r,a){let i=0;switch(e){case"beaufort_kn":i=K(t,ot,"knots",n);break;case"beaufort_km":i=K(t,ot,"kilometer-per-hour",n);break;case"beaufort_ft":i=K(t,ot,"feet-per-second",n);break;case"beaufort_m":i=K(t,ot,"meter-per-second",n);break;case"classified_arrow":i=K(t,a??[],r,n);break;case"ocean_current_m":i=K(t,ee,"meter-per-second",n);break;case"ocean_current_kn":i=K(t,ne,"knots",n)}return i}function le(t,e){const{style:n,inputUnit:r,outputUnit:a,breakValues:i}=e,l=at.fromJSON(r),u=at.fromJSON(a),o=7*6,h=15;let s=0,c=0;const{width:p,height:f,mask:m}=t,d=t.pixels[0],g=t.pixels[1],y=m!=null?m.filter(w=>w>0).length:p*f,M=new Float32Array(y*o),k=new Uint32Array(h*y),x=e.invertDirection?Ct(0,0,0,!1):Zt;for(let w=0;w<f;w++)for(let A=0;A<p;A++){const b=w*p+A;if(!m||m[w*p+A]){const v=(g[b]+360)%360/180*Math.PI,U=ie(d[b],n,l,u,i);for(let B=0;B<x.length;B+=2)M[s++]=(A+.5)/p,M[s++]=(w+.5)/f,M[s++]=x[B],M[s++]=x[B+1]+v,M[s++]=U,M[s++]=d[b];const P=7*(s/o-1);k[c++]=P,k[c++]=P+1,k[c++]=P+2,k[c++]=P+0,k[c++]=P+4,k[c++]=P+3,k[c++]=P+0,k[c++]=P+2,k[c++]=P+3,k[c++]=P+2,k[c++]=P+5,k[c++]=P+3,k[c++]=P+5,k[c++]=P+6,k[c++]=P+3}}return{vertexData:M,indexData:k}}const ut=[];function se(t,e){if(ut.length===0)for(let f=0;f<30;f++)ut.push(te(5*f,0,!e.invertDirection));const n=dt(at.fromJSON(e.inputUnit),"knots"),{width:r,height:a,mask:i}=t,l=t.pixels[0],u=t.pixels[1],o=6,h=[],s=[];let c=0,p=0;for(let f=0;f<a;f++)for(let m=0;m<r;m++){const d=f*r+m,g=l[d]*n;if((!i||i[f*r+m])&&g>=pt){const y=(u[d]+360)%360/180*Math.PI,{pennants:M,barbs:k,shaft:x}=ut[Math.min(Math.floor(g/5),29)];if(M.length+k.length===0)continue;let w=h.length/o;const A=(m+.5)/r,b=(f+.5)/a;for(let v=0;v<M.length;v+=2)h[c++]=A,h[c++]=b,h[c++]=M[v],h[c++]=M[v+1]+y,h[c++]=0,h[c++]=g;for(let v=0;v<k.length;v+=2)h[c++]=A,h[c++]=b,h[c++]=k[v],h[c++]=k[v+1]+y,h[c++]=0,h[c++]=g;for(let v=0;v<x.length;v+=2)h[c++]=A,h[c++]=b,h[c++]=x[v],h[c++]=x[v+1]+y,h[c++]=0,h[c++]=g;for(let v=0;v<M.length/6;v++)s[p++]=w,s[p++]=w+1,s[p++]=w+2,w+=3;for(let v=0;v<k.length/8;v++)s[p++]=w,s[p++]=w+1,s[p++]=w+2,s[p++]=w+1,s[p++]=w+2,s[p++]=w+3,w+=4;s[p++]=w+0,s[p++]=w+1,s[p++]=w+2,s[p++]=w+1,s[p++]=w+3,s[p++]=w+2,w+=4}}return{vertexData:new Float32Array(h),indexData:new Uint32Array(s)}}function re(t,e){let r=0,a=0;const{width:i,height:l,mask:u}=t,o=t.pixels[0],h=[],s=[],c=dt(at.fromJSON(e.inputUnit),"knots"),p=e.style==="wind_speed"?pt:Number.MAX_VALUE;for(let f=0;f<l;f++)for(let m=0;m<i;m++){const d=o[f*i+m]*c;if((!u||u[f*i+m])&&d<p){for(let y=0;y<4;y++)h[r++]=(m+.5)/i,h[r++]=(f+.5)/l,h[r++]=y<2?-.5:.5,h[r++]=y%2==0?-.5:.5,h[r++]=0,h[r++]=d;const g=4*(r/24-1);s[a++]=g,s[a++]=g+1,s[a++]=g+2,s[a++]=g+1,s[a++]=g+2,s[a++]=g+3}}return{vertexData:new Float32Array(h),indexData:new Uint32Array(s)}}function Le(t,e){return e.style==="simple_scalar"?re(t,e):e.style==="wind_speed"?se(t,e):le(t,e)}function Re(t,e,n,r=[0,0],a=.5){const{width:i,height:l,mask:u}=t,[o,h]=t.pixels,[s,c]=r,p=Math.round((i-s)/n),f=Math.round((l-c)/n),m=p*f,d=new Float32Array(m),g=new Float32Array(m),y=new Uint8Array(m),M=e==="vector-uv";for(let x=0;x<f;x++)for(let w=0;w<p;w++){let A=0;const b=x*p+w,v=Math.max(0,x*n+c),U=Math.max(0,w*n+s),P=Math.min(l,v+n),B=Math.min(i,U+n);for(let I=v;I<P;I++)for(let S=U;S<B;S++){const F=I*i+S;if(!u||u[F]){A++;const T=M?[o[F],h[F]]:[o[F],(360+h[F])%360],[$,C]=M?T:Bt(T);d[b]+=$,g[b]+=C}}if(A>=(P-v)*(B-U)*(1-a)){y[b]=1;const[I,S]=St([d[b]/A,g[b]/A]);d[b]=I,g[b]=S}else y[b]=0,d[b]=0,g[b]=0}const k=new _({width:p,height:f,pixels:[d,g],mask:y});return k.updateStatistics(),k}const J=Q.getLogger("esri.views.2d.engine.flow.dataUtils"),oe=10;async function Ne(t,e,n,r){const a=performance.now(),i=ae(e,n),l=performance.now(),u=ce(e,i,n.width,n.height),o=performance.now(),h=fe(u,!0),s=performance.now(),c=t==="Streamlines"?pe(h,oe):de(h),p=performance.now();return tt("esri-2d-profiler")&&(J.info("I.1","_createFlowFieldFromData (ms)",Math.round(l-a)),J.info("I.2","_getStreamlines (ms)",Math.round(o-l)),J.info("I.3","createAnimatedLinesData (ms)",Math.round(s-o)),J.info("I.4","create{Streamlines|Particles}Mesh (ms)",Math.round(p-s)),J.info("I.5","createFlowMesh (ms)",Math.round(p-a)),J.info("I.6","Mesh size (bytes)",c.vertexData.buffer.byteLength+c.indexData.buffer.byteLength)),await Promise.resolve(),Et(r),c}function ae(t,e){const n=ue(e.data,e.width,e.height,t.smoothing);return t.interpolate?(r,a)=>{const i=Math.floor(r),l=Math.floor(a);if(i<0||i>=e.width)return[0,0];if(l<0||l>=e.height)return[0,0];const u=r-i,o=a-l,h=i,s=l,c=i<e.width-1?i+1:i,p=l<e.height-1?l+1:l,f=n[2*(s*e.width+h)],m=n[2*(s*e.width+c)],d=n[2*(p*e.width+h)],g=n[2*(p*e.width+c)],y=n[2*(s*e.width+h)+1],M=n[2*(s*e.width+c)+1];return[(f*(1-o)+d*o)*(1-u)+(m*(1-o)+g*o)*u,(y*(1-o)+n[2*(p*e.width+h)+1]*o)*(1-u)+(M*(1-o)+n[2*(p*e.width+c)+1]*o)*u]}:(r,a)=>{const i=Math.round(r),l=Math.round(a);return i<0||i>=e.width||l<0||l>=e.height?[0,0]:[n[2*(l*e.width+i)],n[2*(l*e.width+i)+1]]}}function he(t,e,n,r,a,i,l,u,o){const h=[];let s=n,c=r,p=0,[f,m]=e(s,c);f*=t.velocityScale,m*=t.velocityScale;const d=Math.sqrt(f*f+m*m);let g,y;h.push({x:s,y:c,t:p,speed:d});for(let M=0;M<t.verticesPerLine;M++){let[k,x]=e(s,c);k*=t.velocityScale,x*=t.velocityScale;const w=Math.sqrt(k*k+x*x);if(w<t.minSpeedThreshold)return h;const A=k/w,b=x/w;if(s+=A*t.segmentLength,c+=b*t.segmentLength,p+=t.segmentLength/w,Math.acos(A*g+b*y)>t.maxTurnAngle)return h;if(t.collisions){const v=Math.round(s*o),U=Math.round(c*o);if(v<0||v>l-1||U<0||U>u-1)return h;const P=i[U*l+v];if(P!==-1&&P!==a)return h;i[U*l+v]=a}h.push({x:s,y:c,t:p,speed:w}),g=A,y=b}return h}function ce(t,e,n,r){const a=[],i=new Ut,l=1/Math.max(t.lineCollisionWidth,1),u=Math.round(n*l),o=Math.round(r*l),h=new Int32Array(u*o);for(let c=0;c<h.length;c++)h[c]=-1;const s=[];for(let c=0;c<r;c+=t.lineSpacing)for(let p=0;p<n;p+=t.lineSpacing)s.push({x:p,y:c,sort:i.getFloat()});s.sort((c,p)=>c.sort-p.sort);for(const{x:c,y:p}of s)if(i.getFloat()<t.density){const f=he(t,e,c,p,a.length,h,u,o,l);if(f.length<2)continue;a.push(f)}return a}function ue(t,e,n,r){if(r===0)return t;const a=Math.round(3*r),i=new Array(2*a+1);let l=0;for(let h=-a;h<=a;h++){const s=Math.exp(-h*h/(r*r));i[h+a]=s,l+=s}for(let h=-a;h<=a;h++)i[h+a]/=l;const u=new Float32Array(t.length);for(let h=0;h<n;h++)for(let s=0;s<e;s++){let c=0,p=0;for(let f=-a;f<=a;f++){if(s+f<0||s+f>=e)continue;const m=i[f+a];c+=m*t[2*(h*e+(s+f))],p+=m*t[2*(h*e+(s+f))+1]}u[2*(h*e+s)]=c,u[2*(h*e+s)+1]=p}const o=new Float32Array(t.length);for(let h=0;h<e;h++)for(let s=0;s<n;s++){let c=0,p=0;for(let f=-a;f<=a;f++){if(s+f<0||s+f>=n)continue;const m=i[f+a];c+=m*u[2*((s+f)*e+h)],p+=m*u[2*((s+f)*e+h)+1]}o[2*(s*e+h)]=c,o[2*(s*e+h)+1]=p}return o}function fe(t,e){const n=new Ut,r=t.reduce((o,h)=>o+h.length,0),a=new Float32Array(4*r),i=new Array(t.length);let l=0,u=0;for(const o of t){const h=l;for(const s of o)a[4*l]=s.x,a[4*l+1]=s.y,a[4*l+2]=s.t,a[4*l+3]=s.speed,l++;i[u++]={startVertex:h,numberOfVertices:o.length,totalTime:o[o.length-1].t,timeSeed:e?n.getFloat():0}}return{lineVertices:a,lineDescriptors:i}}function pe(t,e){const{lineVertices:r,lineDescriptors:a}=t;let i=0,l=0;for(const f of a)i+=2*f.numberOfVertices,l+=6*(f.numberOfVertices-1);const u=new Float32Array(i*9),o=new Uint32Array(l);let h=0,s=0;function c(){o[s++]=h-2,o[s++]=h,o[s++]=h-1,o[s++]=h,o[s++]=h+1,o[s++]=h-1}function p(f,m,d,g,y,M,k,x){const w=h*9;let A=0;u[w+A++]=f,u[w+A++]=m,u[w+A++]=1,u[w+A++]=d,u[w+A++]=M,u[w+A++]=k,u[w+A++]=g/2,u[w+A++]=y/2,u[w+A++]=x,h++,u[w+A++]=f,u[w+A++]=m,u[w+A++]=-1,u[w+A++]=d,u[w+A++]=M,u[w+A++]=k,u[w+A++]=-g/2,u[w+A++]=-y/2,u[w+A++]=x,h++}for(const f of a){const{totalTime:m,timeSeed:d}=f;let g=null,y=null,M=null,k=null,x=null,w=null;for(let A=0;A<f.numberOfVertices;A++){const b=r[4*(f.startVertex+A)],v=r[4*(f.startVertex+A)+1],U=r[4*(f.startVertex+A)+2],P=r[4*(f.startVertex+A)+3];let B=null,I=null,S=null,F=null;if(A>0){B=b-g,I=v-y;const T=Math.sqrt(B*B+I*I);if(B/=T,I/=T,A>1){let $=B+x,C=I+w;const V=Math.sqrt($*$+C*C);$/=V,C/=V;const E=Math.min(1/($*B+C*I),e);$*=E,C*=E,S=-C,F=$}else S=-I,F=B;S!==null&&F!==null&&(p(g,y,M,S,F,m,d,P),c())}g=b,y=v,M=U,x=B,w=I,k=P}p(g,y,M,-w,x,m,d,k)}return{vertexData:u,indexData:o}}function de(t){const{lineVertices:a,lineDescriptors:i}=t;let l=0,u=0;for(const T of i){const $=T.numberOfVertices-1;l+=4*$*2,u+=6*$*2}const o=new Float32Array(l*16),h=new Uint32Array(u);let s,c,p,f,m,d,g,y,M,k,x,w,A,b,v=0,U=0;function P(){h[U++]=v-8,h[U++]=v-7,h[U++]=v-6,h[U++]=v-7,h[U++]=v-5,h[U++]=v-6,h[U++]=v-4,h[U++]=v-3,h[U++]=v-2,h[U++]=v-3,h[U++]=v-1,h[U++]=v-2}function B(T,$,C,V,E,X,O,q,z,H,st,et,nt,it){const D=v*16;let R=0;for(const ct of[1,2])for(const Ft of[1,2,3,4])o[D+R++]=T,o[D+R++]=$,o[D+R++]=C,o[D+R++]=V,o[D+R++]=O,o[D+R++]=q,o[D+R++]=z,o[D+R++]=H,o[D+R++]=ct,o[D+R++]=Ft,o[D+R++]=nt,o[D+R++]=it,o[D+R++]=E/2,o[D+R++]=X/2,o[D+R++]=st/2,o[D+R++]=et/2,v++}function I(T,$){let C=M+x,V=k+w;const E=Math.sqrt(C*C+V*V);C/=E,V/=E;const X=M*C+k*V;C/=X,V/=X;let O=x+A,q=w+b;const z=Math.sqrt(O*O+q*q);O/=z,q/=z;const H=x*O+w*q;O/=H,q/=H,B(s,c,p,f,-V,C,m,d,g,y,-q,O,T,$),P()}function S(T,$,C,V,E,X){if(M=x,k=w,x=A,w=b,M==null&&k==null&&(M=x,k=w),m!=null&&d!=null){A=T-m,b=$-d;const O=Math.sqrt(A*A+b*b);A/=O,b/=O}M!=null&&k!=null&&I(E,X),s=m,c=d,p=g,f=y,m=T,d=$,g=C,y=V}function F(T,$){M=x,k=w,x=A,w=b,M==null&&k==null&&(M=x,k=w),M!=null&&k!=null&&I(T,$)}for(const T of i){s=null,c=null,p=null,f=null,m=null,d=null,g=null,y=null,M=null,k=null,x=null,w=null,A=null,b=null;const{totalTime:$,timeSeed:C}=T;for(let V=0;V<T.numberOfVertices;V++)S(a[4*(T.startVertex+V)],a[4*(T.startVertex+V)+1],a[4*(T.startVertex+V)+2],a[4*(T.startVertex+V)+3],$,C);F($,C)}return{vertexData:o,indexData:h}}function bt(t,e){const n=e.pixels,{width:r,height:a}=e,i=new Float32Array(r*a*2),l=e.mask||new Uint8Array(r*a*2);if(e.mask||l.fill(255),t==="vector-uv")for(let u=0;u<r*a;u++)i[2*u]=n[0][u],i[2*u+1]=-n[1][u];else if(t==="vector-magdir")for(let u=0;u<r*a;u++){const o=n[0][u],h=Gt(n[1][u]),s=Math.cos(h-Math.PI/2),c=Math.sin(h-Math.PI/2);i[2*u]=s*o,i[2*u+1]=c*o}return{data:i,mask:l,width:r,height:a}}async function Ee(t,e,n,r,a,i){const l=performance.now(),u=jt(e.spatialReference);if(!u){const x=await vt(t,e,n,r,a,i);return tt("esri-2d-profiler")&&J.info("I.7","loadImagery, early exit (ms)",Math.round(performance.now()-l)),tt("esri-2d-profiler")&&J.info("I.9","Number of parts",1),x}const[o,h]=u.valid,s=h-o,c=Math.ceil(e.width/s),p=e.width/c,f=Math.round(n/c);let m=e.xmin;const d=[],g=performance.now();for(let x=0;x<c;x++){const w=new Ot({xmin:m,xmax:m+p,ymin:e.ymin,ymax:e.ymax,spatialReference:e.spatialReference});d.push(vt(t,w,f,r,a,i)),m+=p}const y=await Promise.all(d);tt("esri-2d-profiler")&&J.info("I.8","All calls to _fetchPart (ms)",Math.round(performance.now()-g)),tt("esri-2d-profiler")&&J.info("I.9","Number of parts",y.length);const M={data:new Float32Array(n*r*2),mask:new Uint8Array(n*r),width:n,height:r};let k=0;for(const x of y){for(let w=0;w<x.height;w++)for(let A=0;A<x.width;A++)k+A>=n||(M.data[2*(w*n+k+A)]=x.data[2*(w*x.width+A)],M.data[2*(w*n+k+A)+1]=x.data[2*(w*x.width+A)+1],M.mask[w*n+k+A]=x.mask[w*x.width+A]);k+=x.width}return tt("esri-2d-profiler")&&J.info("I.10","loadImagery, general exit (ms)",Math.round(performance.now()-l)),M}async function vt(t,e,n,r,a,i){const l={requestProjectedLocalDirections:!0,signal:i};if(a!=null&&(l.timeExtent=a),t.type==="imagery"){await t.load({signal:i});const h=t.rasterInfo.dataType,s=await t.fetchImage(e,n,r,l);return s&&s.pixelData!=null&&s.pixelData.pixelBlock!=null?bt(h,s.pixelData.pixelBlock):{data:new Float32Array(n*r*2),mask:new Uint8Array(n*r),width:n,height:r}}await t.load({signal:i});const u=t.rasterInfo.dataType,o=await t.fetchPixels(e,n,r,l);return o&&o.pixelBlock!=null?bt(u,o.pixelBlock):{data:new Float32Array(n*r*2),mask:new Uint8Array(n*r),width:n,height:r}}export{at as A,dt as B,_e as C,Se as D,Ce as E,Ie as M,Fe as R,Re as S,Le as U,re as _,Be as a,zt as b,Ve as c,Ne as d,xe as e,At as f,Ee as g,ht as h,Ae as i,ve as j,be as k,Me as l,De as m,xt as n,L as o,gt as p,we as q,ke as r,ye as s,Pe as t,_ as u,Pt as v,Te as w,Ue as x,$e as y,St as z};
