import{cG as fe,ae as r,af as o,ai as h,bD as U,dX as Re,bF as A,bG as z,eI as Ge,eB as $e,E as ve,aj as Me,L as T,ei as De,cD as I,eG as he,eA as Ne,eJ as be,ez as Ae,eK as Pe,ey as te,ec as Le,eo as _e,dY as we,eL as Ie,cE as m,a9 as K,ag as ye,eM as He,eg as Se,aL as me,aB as Je,dt as re,dv as We,eN as Ke,e7 as Ye,A as se,eO as Xe}from"./index-cc043433.js";import{L as qe}from"./LegendOptions-372efa9b.js";import{d as Qe}from"./diffUtils-8c2aaf62.js";import{A as Ze,V as Z,S as xe}from"./SizeVariable-16983f50.js";import{C as et}from"./ColorStop-e8ca6f78.js";import{a as Y}from"./jsonUtils-37a6e724.js";import{f as tt}from"./styleUtils-bb54ea55.js";const ie=new fe({simple:"simple",uniqueValue:"unique-value",classBreaks:"class-breaks",heatmap:"heatmap",dotDensity:"dot-density",dictionary:"dictionary",pieChart:"pie-chart"},{ignoreUnknown:!0});let D=class extends U{constructor(e){super(e),this.authoringInfo=null,this.type=null}async getRequiredFields(e){if(!this.collectRequiredFields)return[];const t=new Set;return await this.collectRequiredFields(t,e),Array.from(t).sort()}getSymbol(e,t){}async getSymbolAsync(e,t){}getSymbols(){return[]}getAttributeHash(){return JSON.stringify(this)}getMeshHash(){return JSON.stringify(this)}};r([o({type:Ze,json:{write:!0}})],D.prototype,"authoringInfo",void 0);r([o({type:ie.apiValues,readOnly:!0,json:{type:ie.jsonValues,read:!1,write:{writer:ie.write,ignoreOrigin:!0}}})],D.prototype,"type",void 0);D=r([h("esri.renderers.Renderer")],D);const Fe=D;function st(n){var e,t;return((t=(e=n.match(it))==null?void 0:e[1])==null?void 0:t.replace(/\\'/g,"'"))??null}const it=/^hash\(\$feature\['((\\'|[^'])+)'\]\) \* 8\.381e-8$/;var le;let E=le=class extends Z{constructor(e){super(e),this.type="color",this.normalizationField=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null}}set stops(e){e&&Array.isArray(e)&&(e=e.filter(t=>!!t),e.sort((t,s)=>t.value-s.value)),this._set("stops",e)}clone(){return new le({field:this.field,normalizationField:this.normalizationField,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,stops:this.stops&&this.stops.map(e=>e.clone()),legendOptions:this.legendOptions&&this.legendOptions.clone()})}getAttributeHash(){return`${super.getAttributeHash()}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(e=>e.value||0)}};r([o({readOnly:!0})],E.prototype,"cache",null);r([o({type:["color"],json:{type:["colorInfo"]}})],E.prototype,"type",void 0);r([o({type:String,json:{write:!0}})],E.prototype,"normalizationField",void 0);r([o({type:[et],json:{write:!0}})],E.prototype,"stops",null);E=le=r([h("esri.renderers.visualVariables.ColorVariable")],E);const Ee=E;var ae;let S=ae=class extends U{constructor(e){super(e),this.label=null,this.opacity=null,this.value=null}readOpacity(e,t){return Ge(t.transparency)}writeOpacity(e,t,s){t[s]=$e(e)}clone(){return new ae({label:this.label,opacity:this.opacity,value:this.value})}};r([o({type:String,json:{write:!0}})],S.prototype,"label",void 0);r([o({type:Number,json:{type:Re,write:{target:"transparency"}}})],S.prototype,"opacity",void 0);r([A("opacity",["transparency"])],S.prototype,"readOpacity",null);r([z("opacity")],S.prototype,"writeOpacity",null);r([o({type:Number,json:{write:!0}})],S.prototype,"value",void 0);S=ae=r([h("esri.renderers.visualVariables.support.OpacityStop")],S);const rt=S;var oe;let O=oe=class extends Z{constructor(e){super(e),this.type="opacity",this.normalizationField=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null}}set stops(e){e&&Array.isArray(e)&&(e=e.filter(t=>!!t),e.sort((t,s)=>t.value-s.value)),this._set("stops",e)}clone(){return new oe({field:this.field,normalizationField:this.normalizationField,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,stops:this.stops&&this.stops.map(e=>e.clone()),legendOptions:this.legendOptions&&this.legendOptions.clone()})}getAttributeHash(){return`${super.getAttributeHash()}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(e=>e.value||0)}};r([o({readOnly:!0})],O.prototype,"cache",null);r([o({type:["opacity"],json:{type:["transparencyInfo"]}})],O.prototype,"type",void 0);r([o({type:String,json:{write:!0}})],O.prototype,"normalizationField",void 0);r([o({type:[rt],json:{write:!0}})],O.prototype,"stops",null);O=oe=r([h("esri.renderers.visualVariables.OpacityVariable")],O);const Oe=O;var ne;let V=ne=class extends Z{constructor(e){super(e),this.axis=null,this.type="rotation",this.rotationType="geographic",this.valueExpressionTitle=null}get cache(){return{hasExpression:!!this.valueExpression,compiledFunc:null}}writeValueExpressionTitleWebScene(e,t,s,i){if(i&&i.messages){const l=`visualVariables[${this.index}]`;i.messages.push(new ve("property:unsupported",this.type+"VisualVariable.valueExpressionTitle is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:l+".valueExpressionTitle",context:i}))}}clone(){return new ne({axis:this.axis,rotationType:this.rotationType,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,legendOptions:this.legendOptions&&this.legendOptions.clone()})}};r([o({readOnly:!0})],V.prototype,"cache",null);r([o({type:["heading","tilt","roll"],json:{origins:{"web-scene":{default:"heading",write:!0}}}})],V.prototype,"axis",void 0);r([o({type:["rotation"],json:{type:["rotationInfo"]}})],V.prototype,"type",void 0);r([o({type:["geographic","arithmetic"],json:{write:!0,origins:{"web-document":{write:!0,default:"geographic"}}}})],V.prototype,"rotationType",void 0);r([o({type:String,json:{write:!0}})],V.prototype,"valueExpressionTitle",void 0);r([z("web-scene","valueExpressionTitle")],V.prototype,"writeValueExpressionTitleWebScene",null);V=ne=r([h("esri.renderers.visualVariables.RotationVariable")],V);const ke=V,lt={color:Ee,size:xe,opacity:Oe,rotation:ke},at=new fe({colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation",sizeInfo:"size"}),ot=/^\[([^\]]+)\]$/i;let X=class extends Me{constructor(){super(...arguments),this.colorVariables=null,this.opacityVariables=null,this.rotationVariables=null,this.sizeVariables=null}set visualVariables(e){if(this._resetVariables(),e=e&&e.filter(t=>!!t),!e||!e.length){this._set("visualVariables",e);return}for(const t of e)switch(t.type){case"color":this.colorVariables.push(t);break;case"opacity":this.opacityVariables.push(t);break;case"rotation":this.rotationVariables.push(t);break;case"size":this.sizeVariables.push(t);break}this.sizeVariables.length&&this.sizeVariables.some(s=>!!s.target)&&e.sort((s,i)=>{let l=null;return s.target===i.target?l=0:s.target?l=1:l=-1,l});for(let t=0;t<e.length;t++){const s=e[t];s.index=t}this._set("visualVariables",e)}readVariables(e,t,s){const{rotationExpression:i,rotationType:l}=t,a=i&&i.match(ot),u=a&&a[1];if(u&&(e||(e=[]),e.push({type:"rotationInfo",rotationType:l,field:u})),!!e)return e.map(c=>{const f=at.read(c.type),y=lt[f];y||(T.getLogger(this.declaredClass).warn(`Unknown variable type: ${f}`),s&&s.messages&&s.messages.push(new De("visual-variable:unsupported",`visualVariable of type '${f}' is not supported`,{definition:c,context:s})));const b=new y;return b.read(c,s),b})}writeVariables(e,t){const s=[];for(const i of e){const l=i.toJSON(t);l&&s.push(l)}return s}_resetVariables(){this.colorVariables=[],this.opacityVariables=[],this.rotationVariables=[],this.sizeVariables=[]}};r([o()],X.prototype,"visualVariables",null);X=r([h("esri.renderers.visualVariables.VisualVariableFactory")],X);const nt=X,ut={base:Z,key:"type",typeMap:{opacity:Oe,color:Ee,rotation:ke,size:xe}},Ue=n=>{let e=class extends n{constructor(){super(...arguments),this._vvFactory=new nt}set visualVariables(s){this._vvFactory.visualVariables=s,this._set("visualVariables",this._vvFactory.visualVariables)}readVisualVariables(s,i,l){return this._vvFactory.readVariables(s,i,l)}writeVisualVariables(s,i,l,a){i[l]=this._vvFactory.writeVariables(s,a)}get arcadeRequiredForVisualVariables(){if(!this.visualVariables)return!1;for(const s of this.visualVariables)if(s.arcadeRequired)return!0;return!1}hasVisualVariables(s,i){return s?this.getVisualVariablesForType(s,i).length>0:this.getVisualVariablesForType("size",i).length>0||this.getVisualVariablesForType("color",i).length>0||this.getVisualVariablesForType("opacity",i).length>0||this.getVisualVariablesForType("rotation",i).length>0}getVisualVariablesForType(s,i){const l=this.visualVariables;return l?l.filter(a=>a.type===s&&(typeof i=="string"?a.target===i:i===!1?!a.target:!0)):[]}async collectVVRequiredFields(s,i){let l=[];this.visualVariables&&(l=l.concat(this.visualVariables));for(const a of l)a&&(a.field&&I(s,i,a.field),a.normalizationField&&I(s,i,a.normalizationField),a.valueExpression&&(pt(a.valueExpression,s,i)||await he(s,i,a.valueExpression)))}};return r([o({types:[ut],value:null,json:{write:!0}})],e.prototype,"visualVariables",null),r([A("visualVariables",["visualVariables","rotationType","rotationExpression"])],e.prototype,"readVisualVariables",null),r([z("visualVariables")],e.prototype,"writeVisualVariables",null),e=r([h("esri.renderers.mixins.VisualVariablesMixin")],e),e};function pt(n,e,t){const s=st(n);return s!=null?(I(e,t,s),!0):!1}const P={types:Ne,json:{write:{writer:Y},origins:{"web-scene":{types:be,write:{writer:Y},read:{reader:Ae({types:be})}}}}},Te={types:{base:Pe,key:"type",typeMap:{"simple-fill":te.typeMap["simple-fill"],"picture-fill":te.typeMap["picture-fill"],"polygon-3d":te.typeMap["polygon-3d"]}},json:{write:{writer:Y},origins:{"web-scene":{type:Le,write:{writer:Y}}}}},ee={cast:n=>n==null||typeof n=="string"||typeof n=="number"?n:`${n}`,json:{type:String,write:{writer:(n,e)=>{e.value=n==null?void 0:n.toString()}}}};var ue;let q=ue=class extends U{constructor(e){super(e),this.description=null,this.label=null,this.minValue=null,this.maxValue=0,this.symbol=null}clone(){return new ue({description:this.description,label:this.label,minValue:this.minValue,maxValue:this.maxValue,symbol:this.symbol?this.symbol.clone():null})}getMeshHash(){const e=JSON.stringify(this.symbol);return`${this.minValue}.${this.maxValue}.${e}`}};r([o({type:String,json:{write:!0}})],q.prototype,"description",void 0);r([o({type:String,json:{write:!0}})],q.prototype,"label",void 0);r([o({type:Number,json:{read:{source:"classMinValue"},write:{target:"classMinValue"}}})],q.prototype,"minValue",void 0);r([o({type:Number,json:{read:{source:"classMaxValue"},write:{target:"classMaxValue"}}})],q.prototype,"maxValue",void 0);r([o(P)],q.prototype,"symbol",void 0);q=ue=r([h("esri.renderers.support.ClassBreakInfo")],q);const Q=q;var pe;const Be="log",J="percent-of-total",W="field",H=new fe({esriNormalizeByLog:Be,esriNormalizeByPercentOfTotal:J,esriNormalizeByField:W}),ct=_e(Q);let d=pe=class extends Ue(Fe){constructor(e){super(e),this._compiledValueExpression={valueExpression:null,compiledFunction:null},this.backgroundFillSymbol=null,this.classBreakInfos=null,this.defaultLabel=null,this.defaultSymbol=null,this.field=null,this.isMaxInclusive=!0,this.legendOptions=null,this.normalizationField=null,this.normalizationTotal=null,this.type="class-breaks",this.valueExpression=null,this.valueExpressionTitle=null,this._set("classBreakInfos",[])}readClassBreakInfos(e,t,s){if(!Array.isArray(e))return;let i=t.minValue;return e.map(l=>{const a=new Q;return a.read(l,s),a.minValue==null&&(a.minValue=i),a.maxValue==null&&(a.maxValue=a.minValue),i=a.maxValue,a})}writeClassBreakInfos(e,t,s,i){const l=e.map(a=>a.write({},i));this._areClassBreaksConsecutive()&&l.forEach(a=>delete a.classMinValue),t[s]=l}castField(e){return e==null?e:typeof e=="function"?(T.getLogger(this.declaredClass).error(".field: field must be a string value"),null):we(e)}get minValue(){return this.classBreakInfos&&this.classBreakInfos[0]&&this.classBreakInfos[0].minValue||0}get normalizationType(){let e=this._get("normalizationType");const t=!!this.normalizationField,s=this.normalizationTotal!=null;return t||s?(e=t&&W||s&&J||null,t&&s&&T.getLogger(this.declaredClass).warn("warning: both normalizationField and normalizationTotal are set!")):(e===W||e===J)&&(e=null),e}set normalizationType(e){this._set("normalizationType",e)}addClassBreakInfo(e,t,s){let i=null;typeof e=="number"?i=new Q({minValue:e,maxValue:t,symbol:Ie(s)}):i=ct(m(e)),this.classBreakInfos.push(i),this.classBreakInfos.length===1&&this.notifyChange("minValue")}removeClassBreakInfo(e,t){const s=this.classBreakInfos.length;for(let i=0;i<s;i++){const l=[this.classBreakInfos[i].minValue,this.classBreakInfos[i].maxValue];if(l[0]===e&&l[1]===t){this.classBreakInfos.splice(i,1);break}}}getBreakIndex(e,t){return this.valueExpression&&(t==null||t.arcade==null)&&T.getLogger(this.declaredClass).warn(""),this.valueExpression?this._getBreakIndexForExpression(e,t):this._getBreakIndexForField(e)}async getClassBreakInfo(e,t){let s=t;this.valueExpression&&(t==null||t.arcade==null)&&(s={...s,arcade:await K()});const i=this.getBreakIndex(e,s);return i!==-1?this.classBreakInfos[i]:null}getSymbol(e,t){if(this.valueExpression&&(t==null||t.arcade==null)){T.getLogger(this.declaredClass).error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");return}const s=this.getBreakIndex(e,t);return s>-1?this.classBreakInfos[s].symbol:this.defaultSymbol}async getSymbolAsync(e,t){let s=t;if(this.valueExpression&&(t==null||t.arcade==null)){const l=await K(),{arcadeUtils:a}=l;a.hasGeometryOperations(this.valueExpression)&&await a.enableGeometryOperations(),s={...s,arcade:l}}const i=this.getBreakIndex(e,s);return i>-1?this.classBreakInfos[i].symbol:this.defaultSymbol}getSymbols(){const e=[];return this.classBreakInfos.forEach(t=>{t.symbol&&e.push(t.symbol)}),this.defaultSymbol&&e.push(this.defaultSymbol),e}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((e,t)=>e+t.getAttributeHash(),"")}getMeshHash(){const e=JSON.stringify(this.backgroundFillSymbol),t=JSON.stringify(this.defaultSymbol),s=`${this.normalizationField}.${this.normalizationType}.${this.normalizationTotal}`,i=this.classBreakInfos.reduce((l,a)=>l+a.getMeshHash(),"");return`${e}.${t}.${i}.${s}.${this.field}.${this.valueExpression}`}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}clone(){return new pe({field:this.field,backgroundFillSymbol:this.backgroundFillSymbol&&this.backgroundFillSymbol.clone(),defaultLabel:this.defaultLabel,defaultSymbol:this.defaultSymbol&&this.defaultSymbol.clone(),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,classBreakInfos:m(this.classBreakInfos),isMaxInclusive:this.isMaxInclusive,normalizationField:this.normalizationField,normalizationTotal:this.normalizationTotal,normalizationType:this.normalizationType,visualVariables:m(this.visualVariables),legendOptions:m(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}async collectRequiredFields(e,t){const s=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)];await Promise.all(s)}async collectSymbolFields(e,t){const s=[...this.getSymbols().map(i=>i.collectRequiredFields(e,t)),he(e,t,this.valueExpression)];I(e,t,this.field),I(e,t,this.normalizationField),await Promise.all(s)}_getBreakIndexForExpression(e,t){const{viewingMode:s,scale:i,spatialReference:l,arcade:a}=t??{},{valueExpression:u}=this;let c=this._compiledValueExpression.valueExpression===u?this._compiledValueExpression.compiledFunction:null;const f=a.arcadeUtils;if(!c){const b=f.createSyntaxTree(u);c=f.createFunction(b),this._compiledValueExpression.compiledFunction=c}this._compiledValueExpression.valueExpression=u;const y=f.executeFunction(c,f.createExecContext(e,f.getViewInfo({viewingMode:s,scale:i,spatialReference:l})));return this._getBreakIndexfromInfos(y)}_getBreakIndexForField(e){const t=this.field,s=e.attributes,i=this.normalizationType;let l=parseFloat(s[t]);if(i){const a=this.normalizationTotal,u=parseFloat(this.normalizationField?s[this.normalizationField]:void 0);if(i===Be)l=Math.log(l)*Math.LOG10E;else if(i===J&&a!=null&&!isNaN(a))l=l/a*100;else if(i===W&&!isNaN(u))if(!isNaN(l)&&!isNaN(u))l=l/u;else return-1}return this._getBreakIndexfromInfos(l)}_getBreakIndexfromInfos(e){const t=this.isMaxInclusive;if(e!=null&&typeof e=="number"&&!isNaN(e))for(let s=0;s<this.classBreakInfos.length;s++){const i=[this.classBreakInfos[s].minValue,this.classBreakInfos[s].maxValue];if(i[0]<=e&&(t?e<=i[1]:e<i[1]))return s}return-1}_areClassBreaksConsecutive(){const e=this.classBreakInfos,t=e.length;for(let s=1;s<t;s++)if(e[s-1].maxValue!==e[s].minValue)return!1;return!0}};r([o(Te)],d.prototype,"backgroundFillSymbol",void 0);r([o({type:[Q]})],d.prototype,"classBreakInfos",void 0);r([A("classBreakInfos")],d.prototype,"readClassBreakInfos",null);r([z("classBreakInfos")],d.prototype,"writeClassBreakInfos",null);r([o({type:String,json:{write:!0}})],d.prototype,"defaultLabel",void 0);r([o(P)],d.prototype,"defaultSymbol",void 0);r([o({type:String,json:{write:!0}})],d.prototype,"field",void 0);r([ye("field")],d.prototype,"castField",null);r([o({type:Boolean})],d.prototype,"isMaxInclusive",void 0);r([o({type:qe,json:{write:!0}})],d.prototype,"legendOptions",void 0);r([o({type:Number,readOnly:!0,value:null,json:{read:!1,write:{overridePolicy(){return this.classBreakInfos.length===0||!this._areClassBreaksConsecutive()?{enabled:!1}:{enabled:!0}}}}})],d.prototype,"minValue",null);r([o({type:String,json:{write:!0}})],d.prototype,"normalizationField",void 0);r([o({type:Number,cast:n=>He(n),json:{write:!0}})],d.prototype,"normalizationTotal",void 0);r([o({type:H.apiValues,value:null,json:{type:H.jsonValues,read:H.read,write:H.write}})],d.prototype,"normalizationType",null);r([Se({classBreaks:"class-breaks"})],d.prototype,"type",void 0);r([o({type:String,json:{write:!0}})],d.prototype,"valueExpression",void 0);r([o({type:String,json:{write:!0}})],d.prototype,"valueExpressionTitle",void 0);d=pe=r([h("esri.renderers.ClassBreaksRenderer")],d);const Ut=d;let j=class extends me(U){constructor(e){super(e),this.value=null,this.value2=null,this.value3=null}};r([o(ee)],j.prototype,"value",void 0);r([o(ee)],j.prototype,"value2",void 0);r([o(ee)],j.prototype,"value3",void 0);j=r([h("esri.renderers.support.UniqueValue")],j);const B=j;let x=class extends me(U){constructor(e){super(e),this.description=null,this.label=null,this.symbol=null,this.values=null}castValues(e){if(e==null)return null;e=Array.isArray(e)?e:[e];const t=typeof e[0];return t==="string"||t==="number"?e.map(s=>new B({value:s})):t==="object"?e[0]instanceof B?e:e.map(s=>new B(s)):null}};r([o({type:String,json:{write:!0}})],x.prototype,"description",void 0);r([o({type:String,json:{write:!0}})],x.prototype,"label",void 0);r([o(P)],x.prototype,"symbol",void 0);r([o({type:[B],json:{type:[[String]],read:{reader:n=>n?n.map(e=>new B({value:e[0],value2:e[1],value3:e[2]})):null},write:{writer:(n,e)=>{const t=[];for(const s of n){const i=[s.value,s.value2,s.value3].filter(Je).map(l=>l.toString());t.push(i)}e.values=t}}}})],x.prototype,"values",void 0);r([ye("values")],x.prototype,"castValues",null);x=r([h("esri.renderers.support.UniqueValueClass")],x);const je=x;let N=class extends me(U){constructor(e){super(e),this.heading=null,this.classes=null}};r([o({type:String,json:{write:!0}})],N.prototype,"heading",void 0);r([o({type:[je],json:{write:!0}})],N.prototype,"classes",void 0);N=r([h("esri.renderers.support.UniqueValueGroup")],N);const ce=N;var de;let k=de=class extends U{constructor(e){super(e),this.description=null,this.label=null,this.symbol=null,this.value=null}clone(){return new de({value:this.value,description:this.description,label:this.label,symbol:this.symbol?this.symbol.clone():null})}getMeshHash(){const e=JSON.stringify(this.symbol&&this.symbol.toJSON());return`${this.value}.${e}`}};r([o({type:String,json:{write:!0}})],k.prototype,"description",void 0);r([o({type:String,json:{write:!0}})],k.prototype,"label",void 0);r([o(P)],k.prototype,"symbol",void 0);r([o(ee)],k.prototype,"value",void 0);k=de=r([h("esri.renderers.support.UniqueValueInfo")],k);const M=k;var $;const ze="esri.renderers.UniqueValueRenderer",w=T.getLogger(ze),Ve="uvInfos-watcher",ge="uvGroups-watcher",dt=",",ft=_e(M);function ht(n){const{field1:e,field2:t,field3:s,fieldDelimiter:i,uniqueValueInfos:l,valueExpression:a}=n,u=!!(e&&t);return[{classes:(l??[]).map(f=>{var F;const{symbol:y,label:b,value:g,description:v}=f,[C,R,G]=u?((F=g==null?void 0:g.toString())==null?void 0:F.split(i||""))||[]:[g],_=[];return(e||a)&&_.push(C),t&&_.push(R),s&&_.push(G),{symbol:y,label:b,values:[_],description:v}})}]}let p=$=class extends Ue(Fe){constructor(e){super(e),this._valueInfoMap={},this._isDefaultSymbolDerived=!1,this._isInfosSource=null,this.type="unique-value",this.backgroundFillSymbol=null,this.orderByClassesEnabled=!1,this.valueExpressionTitle=null,this.legendOptions=null,this.defaultLabel=null,this.portal=null,this.styleOrigin=null,this.diff={uniqueValueInfos(t,s){if(!t&&!s)return;if(!t||!s)return{type:"complete",oldValue:t,newValue:s};let i=!1;const l={type:"collection",added:[],removed:[],changed:[],unchanged:[]};for(let a=0;a<s.length;a++){const u=t.find(c=>c.value===s[a].value);u?Qe(u,s[a])?(l.changed.push({type:"complete",oldValue:u,newValue:s[a]}),i=!0):l.unchanged.push({oldValue:u,newValue:s[a]}):(l.added.push(s[a]),i=!0)}for(let a=0;a<t.length;a++)s.find(c=>c.value===t[a].value)||(l.removed.push(t[a]),i=!0);return i?l:void 0}},this._set("uniqueValueInfos",[]),this._set("uniqueValueGroups",[])}get _cache(){return{compiledFunc:null}}set field(e){this._set("field",e),this._updateFieldDelimiter(),this._updateUniqueValues()}castField(e){return e==null||typeof e=="function"?e:we(e)}writeField(e,t,s,i){typeof e=="string"?t[s]=e:i&&i.messages?i.messages.push(new ve("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):w.error(".field: cannot write field to JSON since it's not a string value")}set field2(e){this._set("field2",e),this._updateFieldDelimiter(),this._updateUniqueValues()}set field3(e){this._set("field3",e),this._updateUniqueValues()}set valueExpression(e){this._set("valueExpression",e),this._updateUniqueValues()}set defaultSymbol(e){this._isDefaultSymbolDerived=!1,this._set("defaultSymbol",e)}set fieldDelimiter(e){this._set("fieldDelimiter",e),this._updateUniqueValues()}readPortal(e,t,s){return s.portal||re.getDefault()}readStyleOrigin(e,t,s){if(t.styleName)return Object.freeze({styleName:t.styleName});if(t.styleUrl){const i=We(t.styleUrl,s);return Object.freeze({styleUrl:i})}}writeStyleOrigin(e,t,s,i){e.styleName?t.styleName=e.styleName:e.styleUrl&&(t.styleUrl=Ke(e.styleUrl,i))}set uniqueValueGroups(e){if(this.styleOrigin){w.error("#uniqueValueGroups=","Cannot modify unique value groups of a UniqueValueRenderer created from a web style");return}this._set("uniqueValueGroups",e),this._updateInfosFromGroups(),this._isInfosSource=!1,this._watchUniqueValueGroups()}set uniqueValueInfos(e){if(this.styleOrigin){w.error("#uniqueValueInfos=","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");return}this._set("uniqueValueInfos",e),this._updateValueInfoMap(),this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()}addUniqueValueInfo(e,t){var i;if(this.styleOrigin){w.error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");return}let s;typeof e=="object"?s=ft(e):s=new M({value:e,symbol:Ie(t)}),(i=this.uniqueValueInfos)==null||i.push(s),this._valueInfoMap[s.value]=s,this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()}removeUniqueValueInfo(e){if(this.styleOrigin){w.error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");return}const t=this.uniqueValueInfos;if(t){for(let s=0;s<t.length;s++)if(t[s].value===e+""){delete this._valueInfoMap[e],t.splice(s,1);break}}this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()}async getUniqueValueInfo(e,t){let s=t;return this.valueExpression&&(t==null||t.arcade==null)&&(s={...s,arcade:await K()}),this._getUniqueValueInfo(e,s)}getSymbol(e,t){if(this.valueExpression&&(t==null||t.arcade==null)){w.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");return}const s=this._getUniqueValueInfo(e,t);return s&&s.symbol||this.defaultSymbol}async getSymbolAsync(e,t){let s=t;if(this.valueExpression&&(s==null||s.arcade==null)){const l=await K(),{arcadeUtils:a}=l;a.hasGeometryOperations(this.valueExpression)&&await a.enableGeometryOperations(),s={...s,arcade:l}}const i=this._getUniqueValueInfo(e,s);return i&&i.symbol||this.defaultSymbol}getSymbols(){const e=[];for(const t of this.uniqueValueInfos??[])t.symbol&&e.push(t.symbol);return this.defaultSymbol&&e.push(this.defaultSymbol),e}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((e,t)=>e+t.getAttributeHash(),"")}getMeshHash(){var l;const e=JSON.stringify(this.backgroundFillSymbol),t=JSON.stringify(this.defaultSymbol),s=(l=this.uniqueValueInfos)==null?void 0:l.reduce((a,u)=>a+u.getMeshHash(),""),i=`${this.field}.${this.field2}.${this.field3}.${this.fieldDelimiter}`;return`${e}.${t}.${s}.${i}.${this.valueExpression}`}clone(){const e=new $({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:m(this.defaultSymbol),orderByClassesEnabled:this.orderByClassesEnabled,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:m(this.visualVariables),legendOptions:m(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),backgroundFillSymbol:m(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(e._isDefaultSymbolDerived=!0),e._set("portal",this.portal);const t=m(this.uniqueValueInfos),s=m(this.uniqueValueGroups);return this.styleOrigin&&(e._set("styleOrigin",Object.freeze(m(this.styleOrigin))),Object.freeze(t),Object.freeze(s)),e._set("uniqueValueInfos",t),e._updateValueInfoMap(),e._set("uniqueValueGroups",s),e._isInfosSource=this._isInfosSource,e._watchUniqueValueInfosAndGroups(),e}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}async collectRequiredFields(e,t){const s=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)];await Promise.all(s)}async collectSymbolFields(e,t){const s=[...this.getSymbols().map(i=>i.collectRequiredFields(e,t)),he(e,t,this.valueExpression)];I(e,t,this.field),I(e,t,this.field2),I(e,t,this.field3),await Promise.all(s)}populateFromStyle(){return tt(this.styleOrigin,{portal:this.portal}).then(e=>{var s;const t=[];return this._valueInfoMap={},e&&e.data&&Array.isArray(e.data.items)&&e.data.items.forEach(i=>{const l=new Ye({styleUrl:e.styleUrl,styleName:e.styleName,portal:this.portal,name:i.name});!this.defaultSymbol&&i.name===e.data.defaultItem&&(this.defaultSymbol=l,this._isDefaultSymbolDerived=!0);const a=new M({value:i.name,symbol:l});t.push(a),this._valueInfoMap[i.name]=a}),this._set("uniqueValueInfos",Object.freeze(t)),this._updateGroupsFromInfos(!0),this._isInfosSource=null,this._watchUniqueValueInfos(),!this.defaultSymbol&&((s=this.uniqueValueInfos)!=null&&s.length)&&(this.defaultSymbol=this.uniqueValueInfos[0].symbol,this._isDefaultSymbolDerived=!0),this})}_updateFieldDelimiter(){this.field&&this.field2&&!this.fieldDelimiter&&this._set("fieldDelimiter",dt)}_updateUniqueValues(){this._isInfosSource!=null&&(this._isInfosSource?this._updateGroupsFromInfos():this._updateInfosFromGroups())}_updateValueInfoMap(){this._valueInfoMap={};const{uniqueValueInfos:e}=this;if(e)for(const t of e)this._valueInfoMap[t.value+""]=t}_watchUniqueValueInfosAndGroups(){this._watchUniqueValueInfos(),this._watchUniqueValueGroups()}_watchUniqueValueInfos(){this.removeHandles(Ve);const{uniqueValueInfos:e}=this;if(e){const t=[];for(const s of e)t.push(se(()=>({symbol:s.symbol,value:s.value,label:s.label,description:s.description}),(i,l)=>{i!==l&&(this._updateGroupsFromInfos(),this._isInfosSource=!0)},{sync:!0}));this.addHandles(t,Ve)}}_watchUniqueValueGroups(){this.removeHandles(ge);const{uniqueValueGroups:e}=this;if(e){const t=[];for(const s of e){t.push(se(()=>({classes:s.classes}),(i,l)=>{i!==l&&(this._updateInfosFromGroups(),this._isInfosSource=!1)},{sync:!0}));for(const i of s.classes??[])t.push(se(()=>({symbol:i.symbol,values:i.values,label:i.label,description:i.description}),(l,a)=>{l!==a&&(this._updateInfosFromGroups(),this._isInfosSource=!1)},{sync:!0}))}this.addHandles(t,ge)}}_updateInfosFromGroups(){if(!this.uniqueValueGroups){this._set("uniqueValueInfos",null),this._updateValueInfoMap(),this._watchUniqueValueInfos();return}const e=[],{field:t,field2:s,field3:i,fieldDelimiter:l,uniqueValueGroups:a,valueExpression:u}=this;if(!t&&!u){this._set("uniqueValueInfos",e),this._updateValueInfoMap(),this._watchUniqueValueInfos();return}const c=!!(t&&s);for(const f of a)for(const y of f.classes??[]){const{symbol:b,label:g,values:v,description:C}=y;for(const R of v??[]){const{value:G,value2:_,value3:F}=R,L=[G];s&&L.push(_),i&&L.push(F);const Ce=c?L.join(l||""):L[0];e.push(new M({symbol:b,label:g,value:Ce,description:C}))}}this._set("uniqueValueInfos",e),this._updateValueInfoMap(),this._watchUniqueValueInfos()}_updateGroupsFromInfos(e=!1){if(!this.uniqueValueInfos){this._set("uniqueValueGroups",null),this._watchUniqueValueGroups();return}const{field:t,field2:s,valueExpression:i,fieldDelimiter:l,uniqueValueInfos:a}=this;if(!t&&!i||!a.length){this._set("uniqueValueGroups",[]),this._watchUniqueValueGroups();return}const u=!!(t&&s),c=a.map(y=>{var F;const{symbol:b,label:g,value:v,description:C}=y,[R,G,_]=u?((F=v==null?void 0:v.toString())==null?void 0:F.split(l||""))||[]:[v];return new je({symbol:b,label:g,description:C,values:[new B({value:R,value2:G,value3:_})]})}),f=[new ce({classes:c})];e&&Object.freeze(f),this._set("uniqueValueGroups",f),this._watchUniqueValueGroups()}_getUniqueValueInfo(e,t){return this.valueExpression?this._getUnqiueValueInfoForExpression(e,t):this._getUnqiueValueInfoForFields(e)}_getUnqiueValueInfoForExpression(e,t){const{viewingMode:s,scale:i,spatialReference:l,arcade:a}=t??{};let u=this._cache.compiledFunc;const c=a.arcadeUtils;if(!u){const y=c.createSyntaxTree(this.valueExpression);u=c.createFunction(y),this._cache.compiledFunc=u}const f=c.executeFunction(u,c.createExecContext(e,c.getViewInfo({viewingMode:s,scale:i,spatialReference:l})));return this._valueInfoMap[f+""]}_getUnqiueValueInfoForFields(e){const t=this.field,s=e.attributes;let i;if(typeof t!="function"&&this.field2){const l=this.field2,a=this.field3,u=[];t&&u.push(s[t]),l&&u.push(s[l]),a&&u.push(s[a]),i=u.join(this.fieldDelimiter||"")}else typeof t=="function"?i=t(e):t&&(i=s[t]);return this._valueInfoMap[i+""]}static fromPortalStyle(e,t){const s=new $(t&&t.properties);s._set("styleOrigin",Object.freeze({styleName:e})),s._set("portal",t&&t.portal||re.getDefault());const i=s.populateFromStyle();return i.catch(l=>{w.error(`#fromPortalStyle('${e}'[, ...])`,"Failed to create unique value renderer from style name",l)}),i}static fromStyleUrl(e,t){const s=new $(t&&t.properties);s._set("styleOrigin",Object.freeze({styleUrl:e}));const i=s.populateFromStyle();return i.catch(l=>{w.error(`#fromStyleUrl('${e}'[, ...])`,"Failed to create unique value renderer from style URL",l)}),i}};r([o({readOnly:!0})],p.prototype,"_cache",null);r([Se({uniqueValue:"unique-value"})],p.prototype,"type",void 0);r([o(Te)],p.prototype,"backgroundFillSymbol",void 0);r([o({value:null,json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],p.prototype,"field",null);r([ye("field")],p.prototype,"castField",null);r([z("field")],p.prototype,"writeField",null);r([o({type:String,value:null,json:{write:!0}})],p.prototype,"field2",null);r([o({type:String,value:null,json:{write:!0}})],p.prototype,"field3",null);r([o({type:Boolean,json:{name:"drawInClassOrder",default:!1,write:!0,origins:{"web-scene":{write:!1}}}})],p.prototype,"orderByClassesEnabled",void 0);r([o({type:String,value:null,json:{write:!0}})],p.prototype,"valueExpression",null);r([o({type:String,json:{write:!0}})],p.prototype,"valueExpressionTitle",void 0);r([o({type:qe,json:{write:!0}})],p.prototype,"legendOptions",void 0);r([o({type:String,json:{write:!0}})],p.prototype,"defaultLabel",void 0);r([o(Xe({...P},{json:{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}},origins:{"web-scene":{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],p.prototype,"defaultSymbol",null);r([o({type:String,value:null,json:{write:!0}})],p.prototype,"fieldDelimiter",null);r([o({type:re,readOnly:!0})],p.prototype,"portal",void 0);r([A("portal",["styleName"])],p.prototype,"readPortal",null);r([o({readOnly:!0,json:{write:{enabled:!1,overridePolicy:()=>({enabled:!0})}}})],p.prototype,"styleOrigin",void 0);r([A("styleOrigin",["styleName","styleUrl"])],p.prototype,"readStyleOrigin",null);r([z("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],p.prototype,"writeStyleOrigin",null);r([o({type:[ce],json:{read:{source:["uniqueValueGroups","uniqueValueInfos"],reader:(n,e,t)=>(e.uniqueValueGroups||ht(e)).map(i=>ce.fromJSON(i,t))},write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],p.prototype,"uniqueValueGroups",null);r([o({type:[M],json:{read:!1,write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],p.prototype,"uniqueValueInfos",null);p=$=r([h(ze)],p);const Rt=p;export{Fe as B,Ut as C,ke as R,Rt as U,Ue as V,Q as a,M as b,P as r};
