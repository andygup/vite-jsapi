import{cE as d,eZ as G,cH as x,bW as k,r as w,fz as P,fA as h,fB as g,fC as S,fD as E,bt as F,bb as M}from"./index-ffb342b4.js";import{f as N}from"./jsonUtils-fcc69467.js";import{F as T}from"./FeatureSet-b9324b47.js";const v={esriGeometryPoint:"points",esriGeometryPolyline:"polylines",esriGeometryPolygon:"polygons"};function R(s){const r=s.folders||[],t=r.slice(),e=new Map,n=new Map,u=new Map,p=new Map,f=new Map,i={esriGeometryPoint:n,esriGeometryPolyline:u,esriGeometryPolygon:p};(s.featureCollection&&s.featureCollection.layers||[]).forEach(o=>{const y=d(o);y.featureSet.features=[];const a=o.featureSet.geometryType;e.set(a,y);const c=o.layerDefinition.objectIdField;a==="esriGeometryPoint"?I(n,c,o.featureSet.features):a==="esriGeometryPolyline"?I(u,c,o.featureSet.features):a==="esriGeometryPolygon"&&I(p,c,o.featureSet.features)}),s.groundOverlays&&s.groundOverlays.forEach(o=>{f.set(o.id,o)}),r.forEach(o=>{o.networkLinkIds.forEach(y=>{const a=O(y,o.id,s.networkLinks);a&&t.push(a)})}),t.forEach(o=>{var y;if(o.featureInfos){o.points=d(e.get("esriGeometryPoint")),o.polylines=d(e.get("esriGeometryPolyline")),o.polygons=d(e.get("esriGeometryPolygon")),o.mapImages=[];for(const a of o.featureInfos)switch(a.type){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryPolygon":{const c=i[a.type].get(a.id);c&&((y=o[v[a.type]])==null||y.featureSet.features.push(c));break}case"GroundOverlay":{const c=f.get(a.id);c&&o.mapImages.push(c);break}}o.fullExtent=b([o])}});const m=b(t);return{folders:r,sublayers:t,extent:m}}function D(s,r,t,e){const n=G&&G.findCredential(s);s=x(s,{token:n&&n.token});const u=k.kmlServiceUrl;return w(u,{query:{url:s,model:"simple",folders:"",refresh:t!==0?!0:void 0,outSR:JSON.stringify(r)},responseType:"json",signal:e})}function q(s,r,t=null,e=[]){const n=[],u={},p=r.sublayers,f=r.folders.map(i=>i.id);return p.forEach(i=>{var m;const l=new s;if(t?l.read(i,t):l.read(i),e.length&&f.includes(l.id)&&(l.visible=e.includes(l.id)),u[i.id]=l,i.parentFolderId!=null&&i.parentFolderId!==-1){const o=u[i.parentFolderId];o.sublayers||(o.sublayers=[]),(m=o.sublayers)==null||m.unshift(l)}else n.unshift(l)}),n}function I(s,r,t){t.forEach(e=>{s.set(e.attributes[r],e)})}function B(s,r){let t;return r.some(e=>e.id===s?(t=e,!0):!1),t}function O(s,r,t){const e=B(s,t);return e&&(e.parentFolderId=r,e.networkLink=e),e}async function z(s){const t=T.fromJSON(s.featureSet).features,e=s.layerDefinition,n=N(e.drawingInfo.renderer),u=M.fromJSON(s.popupInfo),p=[];for(const f of t){const i=await n.getSymbolAsync(f);f.symbol=i,f.popupTemplate=u,f.visible=!0,p.push(f)}return p}function b(s){const r=P(h),t=P(h);for(const e of s){if(e.polygons&&e.polygons.featureSet&&e.polygons.featureSet.features)for(const n of e.polygons.featureSet.features)g(r,n.geometry),S(t,r);if(e.polylines&&e.polylines.featureSet&&e.polylines.featureSet.features)for(const n of e.polylines.featureSet.features)g(r,n.geometry),S(t,r);if(e.points&&e.points.featureSet&&e.points.featureSet.features)for(const n of e.points.featureSet.features)g(r,n.geometry),S(t,r);if(e.mapImages)for(const n of e.mapImages)g(r,n.extent),S(t,r)}return E(t,h)?void 0:{xmin:t[0],ymin:t[1],zmin:t[2],xmax:t[3],ymax:t[4],zmax:t[5],spatialReference:F.WGS84}}export{b as c,D as f,z as g,R as p,q as s};
