import{ae as i,ai as w,hA as Ee,fE as Y,L as V,af as a,K as d,hz as he,bt as me,bN as G,E as U,bO as H,h$ as _e,bF as D,bG as ne,i0 as B,i1 as le,cc as re,bL as M,aj as Me,k,bf as oe,gz as Le,l as Ie,i2 as Ce,ep as ye,r as Z,dv as Se,eN as ae,dK as ge,f8 as Pe,hP as Oe,hN as je,hO as $e,i3 as Te,hu as Ge,es as Be,J as q,cL as Ve,au as Ae,aP as Ne,A as Fe,t as He,bd as Ue,U as We,b9 as Je,V as ke,W as ze,bR as Ke,ag as qe,a$ as De}from"./index-468a9268.js";import{M as Qe}from"./MultiOriginJSONSupport-401b6783.js";import{B as Xe}from"./BlendLayer-3dc4b03d.js";import{O as Ye}from"./OperationalLayer-22d46980.js";import{S as Ze}from"./ScaleRangeLayer-58703611.js";import{t as I,g as et,M as tt}from"./perspectiveUtils-cb58c347.js";import{f as nt,c as ee}from"./mat3f64-c33d428a.js";import{g as rt}from"./resourceExtension-ca5d2c0c.js";import{B as ot}from"./BoundsStore-3b77c5e4.js";import"./jsonUtils-e00c5139.js";import"./parser-0c644652.js";import"./_commonjsHelpers-725317a4.js";import"./commonProperties-99999309.js";import"./ElevationInfo-3032ca55.js";import"./lengthUtils-edd0ce65.js";import"./normalizeUtilsSync-bef12c2c.js";import"./normalizeUtilsCommon-6cabd780.js";import"./PooledRBush-9a5564b0.js";let te=class extends Ee{projectOrWarn(e,t){if(e==null)return e;const{geometry:r,pending:n}=Y(e,t);return n?null:!n&&!r?(V.getLogger(this.declaredClass).warn("geometry could not be projected to the spatial reference",{georeference:this,geometry:e,sourceSpatialReference:e.spatialReference,targetSpatialReference:t}),null):r}};te=i([w("esri.layers.support.GeoreferenceBase")],te);const Q=te,X=ee(),p=M();let W=class extends Me{constructor(){super(...arguments),this.sourcePoint=null,this.mapPoint=null}};i([a()],W.prototype,"sourcePoint",void 0);i([a({type:d})],W.prototype,"mapPoint",void 0);W=i([w("esri.layers.support.ControlPoint")],W);let P=class extends he(Q){constructor(e){super(e),this.controlPoints=null,this.height=0,this.type="control-points",this.width=0}readControlPoints(e,t){const r=me.fromJSON(t.spatialReference),n=nt(...t.coefficients,1);return e.map(s=>(G(p,s.x,s.y),I(p,p,n),{sourcePoint:s,mapPoint:new d({x:p[0],y:p[1],spatialReference:r})}))}writeControlPoints(e,t,r,n){if(this.transform==null){const s=new U("web-document-write:invalid-georeference","Invalid 'controlPoints', 'width', 'height' configuration.",{layer:n==null?void 0:n.layer,georeference:this});n!=null&&n.messages?n.messages.push(s):V.getLogger(this.declaredClass).error(s.name,s.message);return}e!=null&&h(e[0])&&(t.controlPoints=e.map(s=>{const l=s.sourcePoint;return{x:l.x,y:l.y}}),t.spatialReference=e[0].mapPoint.spatialReference.toJSON(),t.coefficients=this.transform.slice(0,8))}get coords(){if(this.controlPoints==null)return null;const e=this._updateTransform(X);if(e==null||!h(this.controlPoints[0]))return null;const t=this.controlPoints[0].mapPoint.spatialReference;return ct(e,this.width,this.height,t)}set coords(e){if(this.controlPoints==null||!h(this.controlPoints[0]))return;const t=this.controlPoints[0].mapPoint.spatialReference;if(e=this.projectOrWarn(e,t),e==null)return;const{width:r,height:n}=this,{rings:[[s,l,c,f]]}=e,u={sourcePoint:H(0,n),mapPoint:new d({x:s[0],y:s[1],spatialReference:t})},y={sourcePoint:H(0,0),mapPoint:new d({x:l[0],y:l[1],spatialReference:t})},R={sourcePoint:H(r,0),mapPoint:new d({x:c[0],y:c[1],spatialReference:t})},L={sourcePoint:H(r,n),mapPoint:new d({x:f[0],y:f[1],spatialReference:t})};h(u)&&h(y)&&h(R)&&h(L)&&(ce(X,u,y,R,L),this.controlPoints=this.controlPoints.map(({sourcePoint:g})=>(G(p,g.x,g.y),I(p,p,X),{sourcePoint:g,mapPoint:new d({x:p[0],y:p[1],spatialReference:t})})))}get inverseTransform(){return this.transform==null?null:_e(ee(),this.transform)}get transform(){return this._updateTransform()}toMap(e){if(e==null||this.transform==null||this.controlPoints==null||!h(this.controlPoints[0]))return null;G(p,e.x,e.y);const t=this.controlPoints[0].mapPoint.spatialReference;return I(p,p,this.transform),new d({x:p[0],y:p[1],spatialReference:t})}toSource(e){if(e==null||this.inverseTransform==null||this.controlPoints==null||!h(this.controlPoints[0]))return null;const t=this.controlPoints[0].mapPoint.spatialReference;return e=e.normalize(),e=Y(e,t).geometry,e==null?null:(G(p,e.x,e.y),I(p,p,this.inverseTransform),H(p[0],p[1]))}_updateTransform(e){const{controlPoints:t,width:r,height:n}=this;if(t==null||!(r>0)||!(n>0))return null;const[s,l,c,f]=t;if(!h(s))return null;const u=s.mapPoint.spatialReference,y=this._projectControlPoint(l,u),R=this._projectControlPoint(c,u),L=this._projectControlPoint(f,u);if(!y.valid||!R.valid||!L.valid||!h(y.controlPoint))return null;e==null&&(e=ee());let g=null;return h(R.controlPoint)&&h(L.controlPoint)?g=ce(e,s,y.controlPoint,R.controlPoint,L.controlPoint):h(R.controlPoint)?g=it(e,s,y.controlPoint,R.controlPoint):g=st(e,s,y.controlPoint),g.every(be=>be===0)?null:g}_projectControlPoint(e,t){if(!h(e))return{valid:!0,controlPoint:e};const{sourcePoint:r,mapPoint:n}=e,{geometry:s,pending:l}=Y(n,t);return l?{valid:!1,controlPoint:null}:!l&&!s?(V.getLogger(this.declaredClass).warn("map point could not be projected to the spatial reference",{georeference:this,controlPoint:e,sourceSpatialReference:n.spatialReference,targetSpatialReference:t}),{valid:!1,controlPoint:null}):{valid:!0,controlPoint:{sourcePoint:r,mapPoint:s}}}};i([a({type:[W],json:{write:{allowNull:!1,isRequired:!0}}})],P.prototype,"controlPoints",void 0);i([D("controlPoints")],P.prototype,"readControlPoints",null);i([ne("controlPoints")],P.prototype,"writeControlPoints",null);i([a()],P.prototype,"coords",null);i([a({json:{write:!0}})],P.prototype,"height",void 0);i([a({readOnly:!0})],P.prototype,"inverseTransform",null);i([a({readOnly:!0})],P.prototype,"transform",null);i([a({json:{write:!0}})],P.prototype,"width",void 0);P=i([w("esri.layers.support.ControlPointsGeoreference")],P);function h(o){return o!=null&&o.sourcePoint!=null&&o.mapPoint!=null}const x=M(),v=M(),$=M(),C=M(),b=M(),E=M(),T=M(),S=M(),z=Math.PI/2;function _(o,e,t){G(o,t.sourcePoint.x,t.sourcePoint.y),G(e,t.mapPoint.x,t.mapPoint.y)}function st(o,e,t){return _(x,b,e),_(v,E,t),B($,v,x,z),B(C,x,v,z),B(T,E,b,-z),B(S,b,E,-z),se(o,x,v,$,C,b,E,T,S)}function it(o,e,t,r){return _(x,b,e),_(v,E,t),_($,T,r),le(C,x,v,.5),B(C,$,C,Math.PI),le(S,b,E,.5),B(S,T,S,Math.PI),se(o,x,v,$,C,b,E,T,S)}function ce(o,e,t,r,n){return _(x,b,e),_(v,E,t),_($,T,r),_(C,S,n),se(o,x,v,$,C,b,E,T,S)}const lt=new Array(8).fill(0),at=new Array(8).fill(0);function ue(o,e,t,r,n){return o[0]=e[0],o[1]=e[1],o[2]=t[0],o[3]=t[1],o[4]=r[0],o[5]=r[1],o[6]=n[0],o[7]=n[1],o}function se(o,e,t,r,n,s,l,c,f){return et(o,ue(lt,e,t,r,n),ue(at,s,l,c,f))}function ct(o,e,t,r){const n=k(0,t),s=k(0,0),l=k(e,0),c=k(e,t);return I(n,n,o),I(s,s,o),I(l,l,o),I(c,c,o),new re({rings:[[n,s,l,c,n]],spatialReference:r})}const Re=P;let O=class extends Q{constructor(e){super(e),this.bottomLeft=null,this.bottomRight=null,this.topLeft=null,this.topRight=null,this.type="corners"}get coords(){let{topLeft:e,topRight:t,bottomLeft:r,bottomRight:n}=this;if(e==null||t==null||r==null||n==null)return null;const s=e.spatialReference;return t=this.projectOrWarn(t,s),r=this.projectOrWarn(r,s),n=this.projectOrWarn(n,s),t==null||r==null||n==null?null:new re({rings:[[[r.x,r.y],[e.x,e.y],[t.x,t.y],[n.x,n.y],[r.x,r.y]]],spatialReference:s})}set coords(e){const{topLeft:t}=this;if(t==null)return;const r=t.spatialReference;if(e=this.projectOrWarn(e,r),e==null)return;const{rings:[[n,s,l,c]]}=e;this.bottomLeft=new d({x:n[0],y:n[1],spatialReference:r}),this.topLeft=new d({x:s[0],y:s[1],spatialReference:r}),this.topRight=new d({x:l[0],y:l[1],spatialReference:r}),this.bottomRight=new d({x:c[0],y:c[1],spatialReference:r})}};i([a()],O.prototype,"coords",null);i([a({type:d})],O.prototype,"bottomLeft",void 0);i([a({type:d})],O.prototype,"bottomRight",void 0);i([a({type:d})],O.prototype,"topLeft",void 0);i([a({type:d})],O.prototype,"topRight",void 0);O=i([w("esri.layers.support.CornersGeoreference")],O);const ut=O;let A=class extends Q{constructor(e){super(e),this.extent=null,this.rotation=0,this.type="extent-and-rotation"}get coords(){if(this.extent==null)return null;const{xmin:e,ymin:t,xmax:r,ymax:n,spatialReference:s}=this.extent;let l;if(!this.rotation)l=[[e,t],[e,n],[r,n],[r,t],[e,t]];else{const{x:c,y:f}=this.extent.center,u=pe(c,f,this.rotation);l=[u(e,t),u(e,n),u(r,n),u(r,t)],l.push(l[0])}return new re({rings:[l],spatialReference:s})}set coords(e){if(e==null||this.extent==null)return;const t=this.extent.spatialReference;if(e=this.projectOrWarn(e,t),e==null||e.extent==null)return;const{rings:[[r,n,s]],extent:{center:{x:l,y:c}}}=e,f=Le(Math.PI/2-Math.atan2(n[1]-r[1],n[0]-r[0])),u=pe(l,c,-f),[y,R]=u(r[0],r[1]),[L,g]=u(s[0],s[1]);this.extent=new oe({xmin:y,ymin:R,xmax:L,ymax:g,spatialReference:t}),this.rotation=f}};i([a()],A.prototype,"coords",null);i([a({type:oe})],A.prototype,"extent",void 0);i([a({type:Number})],A.prototype,"rotation",void 0);A=i([w("esri.layers.support.ExtentAndRotationGeoreference")],A);function pe(o,e,t){const r=Ie(t),n=Math.cos(r),s=Math.sin(r);return(l,c)=>[n*(l-o)+s*(c-e)+o,n*(c-e)-s*(l-o)+e]}const pt=A,ft={key:"type",base:Q,typeMap:{"control-points":Re,corners:ut,"extent-and-rotation":pt}};let N=class extends Ce(he(ye)){constructor(e){super(e),this.georeference=null,this.opacity=1}readGeoreference(e){return Re.fromJSON(e)}};i([a({types:ft,json:{write:!0}})],N.prototype,"georeference",void 0);i([D("georeference")],N.prototype,"readGeoreference",null);i([a()],N.prototype,"opacity",void 0);N=i([w("esri.layers.support.MediaElementBase")],N);const ie=N;let j=class extends ie{constructor(e){super(e),this.content=null,this.image=null,this.type="image",this.image=null}load(){const e=this.image;if(typeof e=="string"){const t=Z(e,{responseType:"image"}).then(({data:r})=>{this._set("content",r)});this.addResolvingPromise(t)}else if(e instanceof HTMLImageElement){const t=e.decode().then(()=>{this._set("content",e)});this.addResolvingPromise(t)}else e?this._set("content",e):this.addResolvingPromise(Promise.reject(new U("image-element:invalid-image-type","Invalid image type",{image:e})));return Promise.resolve(this)}readImage(e,t,r){return Se(t.url,r)}writeImage(e,t,r,n){if(e==null)return;const s=n==null?void 0:n.portalItem,l=n==null?void 0:n.resources;if(!s||!l){typeof e=="string"&&(t[r]=ae(e,n));return}const c=typeof e=="string"&&!ge(e)&&!Pe(e)?e:null;if(c){if(Oe(c)==null){t[r]=c;return}const u=ae(c,{...n,verifyItemRelativeUrls:n&&n.verifyItemRelativeUrls?{writtenUrls:n.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},je.NO);if(s&&u&&!$e(u)){l.toKeep.push({resource:s.resourceFromPath(u),compress:!1}),t[r]=u;return}}t[r]="<pending>",l.pendingOperations.push(xe(e).then(f=>{const u=ht(f,s);t[r]=u.itemRelativeUrl,l.toAdd.push({resource:u,content:f,compress:!1,finish:y=>{this.image=y.url}})}))}};i([a({readOnly:!0})],j.prototype,"content",void 0);i([a({json:{name:"url",type:String}})],j.prototype,"image",void 0);i([D("image",["url"])],j.prototype,"readImage",null);i([ne("image")],j.prototype,"writeImage",null);i([a({readOnly:!0,json:{name:"mediaType"}})],j.prototype,"type",void 0);j=i([w("esri.layers.support.ImageElement")],j);const we=j;async function xe(o){if(typeof o=="string"){if(Pe(o)){const{data:t}=await Z(o,{responseType:"blob"});return t}if(ge(o))return Te(o);const e=await Z(o,{responseType:"image"});return xe(e.data)}return new Promise(e=>dt(o).toBlob(e))}function dt(o){if(o instanceof HTMLCanvasElement)return o;const e=o instanceof HTMLImageElement?o.naturalWidth:o.width,t=o instanceof HTMLImageElement?o.naturalHeight:o.height,r=document.createElement("canvas"),n=r.getContext("2d");return r.width=e,r.height=t,o instanceof HTMLImageElement?n.drawImage(o,0,0,o.width,o.height):o instanceof ImageData&&n.putImageData(o,0,0),r}function ht(o,e){const t=Ge(),n=`${Be("media",t)}.${rt(o)}`;return e.resourceFromPath(n)}let J=class extends ie{constructor(e){super(e),this.content=null,this.type="video"}load(){const e=this.video;if(typeof e=="string"){const t=document.createElement("video");t.src=e,t.crossOrigin="anonymous",t.autoplay=!0,t.muted=!0,t.loop=!0,this.addResolvingPromise(this._loadVideo(t).then(()=>{this._set("content",t)}))}else e instanceof HTMLVideoElement?this.addResolvingPromise(this._loadVideo(e).then(()=>{this._set("content",e)})):this.addResolvingPromise(Promise.reject(new U("video-element:invalid-video-type","Invalid video type",{video:e})));return Promise.resolve(this)}set video(e){if(this.loadStatus!=="not-loaded"){V.getLogger(this.declaredClass).error("#video","video cannot be changed after the element is loaded.");return}this._set("video",e)}_loadVideo(e){return new Promise((t,r)=>{e.oncanplay=()=>{e.oncanplay=null,e.play().then(t,r)},e.crossOrigin!=="anonymous"&&(e.crossOrigin="anonymous",e.src=e.src)})}};i([a({readOnly:!0})],J.prototype,"content",void 0);i([a()],J.prototype,"video",null);J=i([w("esri.layers.support.VideoElement")],J);const ve=J,mt={key:"type",defaultKeyValue:"image",base:ie,typeMap:{image:we,video:ve}},fe=q.ofType(mt);let F=class extends ye.LoadableMixin(Ve(Ae(Ne.EventedAccessor))){constructor(e){super(e),this._index=new ot,this._elementViewsMap=new Map,this._elementsIndexes=new Map,this._elementsChangedHandler=t=>{for(const n of t.removed){const s=this._elementViewsMap.get(n);this._elementViewsMap.delete(n),this._index.delete(s),this.handles.remove(s),s.destroy(),this.notifyChange("fullExtent")}const{spatialReference:r}=this;for(const n of t.added){if(this._elementViewsMap.get(n))continue;const s=new tt({spatialReference:r,element:n});this._elementViewsMap.set(n,s);const l=Fe(()=>s.coords,()=>this._updateIndexForElement(s,!1));this._updateIndexForElement(s,!0),this.handles.add(l,s)}this._elementsIndexes.clear(),this.elements.forEach((n,s)=>this._elementsIndexes.set(n,s)),this.emit("refresh")},this.elements=new fe}async load(e){if(He(e),!this.spatialReference){const t=this.elements.find(r=>r.georeference!=null&&r.georeference.coords!=null);this._set("spatialReference",t?t.georeference.coords.spatialReference:me.WGS84)}return this._elementsChangedHandler({added:this.elements.items,removed:[]}),this.handles.add(this.elements.on("change",this._elementsChangedHandler)),this}destroy(){this._index.clear(),this._elementViewsMap.clear(),this._elementsIndexes.clear()}set elements(e){this._set("elements",Ue(e,this._get("elements"),fe))}get fullExtent(){if(this.loadStatus==="not-loaded")return null;const e=this._index.fullBounds;return e==null?null:new oe({xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:this.spatialReference})}set spatialReference(e){if(this.loadStatus!=="not-loaded"){V.getLogger(this.declaredClass).error("#spatialReference","spatialReference cannot be changed after the source is loaded.");return}this._set("spatialReference",e)}async queryElements(e,t){await this.load(),await We(e.spatialReference,this.spatialReference,null,t);const r=Je(e.spatialReference,this.spatialReference)?e:ke(e,this.spatialReference);if(!r)return[];const n=r.normalize(),s=[];for(const l of n)this._index.forEachInBounds(ze(l),({normalizedCoords:c,element:f})=>{c!=null&&Ke(l,c)&&s.push(f)});return s.sort((l,c)=>this._elementsIndexes.get(l)-this._elementsIndexes.get(c)),s}_updateIndexForElement(e,t){const r=e.normalizedBounds,n=this._index.has(e),s=r!=null;this._index.delete(e),s&&this._index.set(e,r),this.notifyChange("fullExtent"),t||(n!==s?this.emit("refresh"):this.emit("change",{element:e.element}))}};i([a()],F.prototype,"elements",null);i([a({readOnly:!0})],F.prototype,"fullExtent",null);i([a()],F.prototype,"spatialReference",null);F=i([w("esri.layers.support.LocalMediaElementSource")],F);const K=F;function de(o){return typeof o=="object"&&o!=null&&"type"in o}let m=class extends Xe(Ze(Ye(Qe(De)))){constructor(e){super(e),this.effectiveSource=null,this.copyright=null,this.operationalLayerType="MediaLayer",this.spatialReference=null,this.type="media",this.source=new K}load(e){const t=this.source;if(!t)return this.addResolvingPromise(Promise.reject(new U("media-layer:source-missing","Set 'MediaLayer.source' before loading the layer."))),Promise.resolve(this);const r=de(t)?new K({elements:new q([t])}):t;this._set("effectiveSource",r),this.spatialReference&&(r.spatialReference=this.spatialReference);const n=r.load(e).then(()=>{this.spatialReference=r.spatialReference});return this.addResolvingPromise(n),Promise.resolve(this)}destroy(){var e,t;(e=this.effectiveSource)==null||e.destroy(),(t=this.source)==null||t.destroy()}get fullExtent(){return this.loaded?this.effectiveSource.fullExtent:null}set source(e){if(this.loadStatus!=="not-loaded"){V.getLogger(this.declaredClass).error("#source","source cannot be changed after the layer is loaded.");return}this._set("source",e)}castSource(e){return e?Array.isArray(e)?new K({elements:new q(e)}):e instanceof q?new K({elements:e}):e:null}readSource(e,t,r){const n=t.mediaType==="image"?new we:t.mediaType==="video"?new ve:null;return n==null||n.read(t,r),n}writeSource(e,t,r,n){var s;if(!e||!de(e)||e.type!=="image"){n!=null&&n.messages&&((s=n==null?void 0:n.messages)==null||s.push(new U("media-layer:unsupported-source","source must be an 'ImageElement'")));return}e.write(t,n)}};i([a({readOnly:!0})],m.prototype,"effectiveSource",void 0);i([a({type:String})],m.prototype,"copyright",void 0);i([a({readOnly:!0})],m.prototype,"fullExtent",null);i([a({type:["MediaLayer"]})],m.prototype,"operationalLayerType",void 0);i([a({type:["show","hide"]})],m.prototype,"listMode",void 0);i([a({nonNullable:!0,json:{write:{enabled:!0,allowNull:!1}}})],m.prototype,"source",null);i([qe("source")],m.prototype,"castSource",null);i([D("source",["url"])],m.prototype,"readSource",null);i([ne("source")],m.prototype,"writeSource",null);i([a()],m.prototype,"spatialReference",void 0);i([a({readOnly:!0})],m.prototype,"type",void 0);m=i([w("esri.layers.MediaLayer")],m);const Jt=m;export{Jt as default};
