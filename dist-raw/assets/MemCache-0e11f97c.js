import{dW as u}from"./index-1ff2b83b.js";const m=-3;var a;(function(_){_[_.ALL=0]="ALL",_[_.SOME=1]="SOME"})(a||(a={}));class g{constructor(e,t,s){this._namespace=e,this._storage=t,this._removeFunc=!1,this._hit=0,this._miss=0,this._storage.register(this),this._namespace+=":",s&&(this._storage.registerRemoveFunc(this._namespace,s),this._removeFunc=!0)}destroy(){this._storage.clear(this._namespace),this._removeFunc&&this._storage.deregisterRemoveFunc(this._namespace),this._storage.deregister(this),this._storage=null}get namespace(){return this._namespace.slice(0,-1)}get hitRate(){return this._hit/(this._hit+this._miss)}get size(){return this._storage.size}get maxSize(){return this._storage.maxSize}resetHitRate(){this._hit=this._miss=0}put(e,t,s,r=0){this._storage.put(this._namespace+e,t,s,r)}get(e){const t=this._storage.get(this._namespace+e);return t===void 0?++this._miss:++this._hit,t}pop(e){const t=this._storage.pop(this._namespace+e);return t===void 0?++this._miss:++this._hit,t}updateSize(e,t,s){this._storage.updateSize(this._namespace+e,t,s)}clear(){this._storage.clear(this._namespace)}clearAll(){this._storage.clearAll()}getStats(){return this._storage.getStats()}resetStats(){this._storage.resetStats()}}class z{constructor(e=10485760){this._maxSize=e,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=new u,this._users=new u}destroy(){this.clearAll(),this._removeFuncs.clear(),this._users.clear(),this._db=null}register(e){this._users.push(e)}deregister(e){this._users.removeUnordered(e)}registerRemoveFunc(e,t){this._removeFuncs.push([e,t])}deregisterRemoveFunc(e){this._removeFuncs.filterInPlace(t=>t[0]!==e)}get size(){return this._size}get sizeMB(){return this._size/1024/1024}get maxSize(){return this._maxSize}set maxSize(e){this._maxSize=Math.max(e,0),this._checkSizeLimit()}put(e,t,s,r){const h=this._db.get(e);if(h&&(this._size-=h.size,this._db.delete(e),h.entry!==t&&this._notifyRemove(e,h.entry,a.ALL)),s>this._maxSize){this._notifyRemove(e,t,a.ALL);return}if(t===void 0){console.warn("Refusing to cache undefined entry ");return}if(!s||s<0){console.warn("Refusing to cache entry with invalid size "+s);return}const i=1+Math.max(r,m)-m;this._db.set(e,{entry:t,size:s,lifetime:i,lives:i}),this._size+=s,this._checkSizeLimit()}updateSize(e,t,s){const r=this._db.get(e);if(!(!r||r.entry!==t)){for(this._size-=r.size;s>this._maxSize;){const h=this._notifyRemove(e,t,a.SOME);if(h!=null&&h>0)s=h;else{this._db.delete(e);return}}r.size=s,this._size+=s,this._checkSizeLimit()}}pop(e){const t=this._db.get(e);if(t)return this._size-=t.size,this._db.delete(e),++this._hit,t.entry;++this._miss}get(e){const t=this._db.get(e);if(t===void 0){++this._miss;return}return this._db.delete(e),t.lives=t.lifetime,this._db.set(e,t),++this._hit,t.entry}getStats(){const e={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},t={},s=new Array;this._db.forEach((i,n)=>{const o=i.lifetime;s[o]=(s[o]||0)+i.size,this._users.forAll(l=>{const c=l.namespace;if(n.startsWith(c)){const f=t[c]||0;t[c]=f+i.size}})});const r={};this._users.forAll(i=>{const n=i.namespace;if(!isNaN(i.hitRate)&&i.hitRate>0){const o=t[n]||0;t[n]=o,r[n]=Math.round(100*i.hitRate)+"%"}else r[n]="0%"});const h=Object.keys(t);h.sort((i,n)=>t[n]-t[i]),h.forEach(i=>e[i]=Math.round(t[i]/2**20)+"MB / "+r[i]);for(let i=s.length-1;i>=0;--i){const n=s[i];n&&(e["Priority "+(i+m-1)]=Math.round(n/this.size*100)+"%")}return e}resetStats(){this._hit=this._miss=0,this._users.forAll(e=>e.resetHitRate())}clear(e){this._db.forEach((t,s)=>{s.startsWith(e)&&(this._size-=t.size,this._db.delete(s),this._notifyRemove(s,t.entry,a.ALL))})}clearAll(){this._db.forEach((e,t)=>this._notifyRemove(t,e.entry,a.ALL)),this._size=0,this._db.clear()}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(e,t,s){let r;return this._removeFuncs.some(h=>{if(e.startsWith(h[0])){const i=h[1](t,s);return typeof i=="number"&&(r=i),!0}return!1}),r}_checkSizeLimit(){if(!(this._size<=this._maxSize))for(const[e,t]of this._db){if(this._db.delete(e),t.lives<=1){this._size-=t.size;const s=this._notifyRemove(e,t.entry,a.SOME);s!=null&&s>0&&(this._size+=s,t.lives=t.lifetime,t.size=s,this._db.set(e,t))}else--t.lives,this._db.set(e,t);if(this._size<=this.maxSize*.9)return}}}export{z as M,g as a};
