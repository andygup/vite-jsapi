import{cG as L,ae as E,af as I,ai as Q,ep as v,be as P,m as j,r as m,aB as U,eZ as D,bf as G,bC as N,fg as $,es as V,_ as J,E as F,aO as z,er as Y,iQ as Z,L as C,bt as B,ah as X,bB as H,iR as K}from"./index-1ff2b83b.js";import{e as W}from"./External-b242d32b.js";import{a as ee}from"./clientSideDefaults-da6a9562.js";import{Q as te}from"./QueryTask-f0495c3e.js";import{u as se}from"./editsZScale-3081ebe7.js";import"./infoFor3D-91dff30a.js";import"./QueryEngineCapabilities-60118ddb.js";import"./defaultsJSON-b396ba80.js";import"./Query-89e89f36.js";import"./Field-48dd4cd6.js";import"./fieldType-bd6e776b.js";import"./executeForIds-99d38f4e.js";import"./query-d11f83f8.js";import"./normalizeUtils-19de81d3.js";import"./normalizeUtilsCommon-8aa6d9c6.js";import"./pbfQueryUtils-fd1aeb3c.js";import"./pbf-8c7438c3.js";import"./OptimizedGeometry-af84d2ad.js";import"./OptimizedFeatureSet-5c82fe5a.js";import"./queryZScale-647e3446.js";import"./executeQueryJSON-77eff55d.js";import"./FeatureSet-e679998d.js";import"./featureConversionUtils-e2e44d08.js";const ae=new L({originalAndCurrentFeatures:"original-and-current-features",none:"none"}),re=new Set(["Feature Layer","Table"]),ne=new L({Started:"published",Publishing:"publishing",Stopped:"unavailable"});let _=class extends v{constructor(){super(...arguments),this.type="feature-layer",this.refresh=P(async()=>{var n,s;await this.load();const t=(n=this.sourceJSON.editingInfo)==null?void 0:n.lastEditDate;if(t==null)return{dataChanged:!0,updates:{}};try{await this._fetchService(null)}catch{return{dataChanged:!0,updates:{}}}const e=t!==((s=this.sourceJSON.editingInfo)==null?void 0:s.lastEditDate),a=e?{editingInfo:this.sourceJSON.editingInfo,extent:this.sourceJSON.extent}:null;return{dataChanged:e,updates:a}}),this._ongoingAssetUploads=new Map}load(t){const e=t!=null?t.signal:null,a=this.layer.sourceJSON;return this.addResolvingPromise(this._fetchService(a,e)),Promise.resolve(this)}get queryTask(){var d;const{capabilities:t,parsedUrl:e,dynamicDataSource:a,infoFor3D:n,gdbVersion:s,spatialReference:o,fieldsIndex:r}=this.layer,l=j("featurelayer-pbf")&&(t==null?void 0:t.query.supportsFormatPBF)&&n==null,u=((d=t==null?void 0:t.operations)==null?void 0:d.supportsQueryAttachments)??!1;return new te({url:e.path,pbfSupported:l,fieldsIndex:r,infoFor3D:n,dynamicDataSource:a,gdbVersion:s,sourceSpatialReference:o,queryAttachmentsSupported:u})}async addAttachment(t,e){await this.load();const a=t.attributes[this.layer.objectIdField],n=this.layer.parsedUrl.path+"/"+a+"/addAttachment",s=this._getLayerRequestOptions(),o=this._getFormDataForAttachment(e,s.query);try{const r=await m(n,{body:o});return this._createFeatureEditResult(r.data.addAttachmentResult)}catch(r){throw this._createAttachmentErrorResult(a,r)}}async updateAttachment(t,e,a){await this.load();const n=t.attributes[this.layer.objectIdField],s=this.layer.parsedUrl.path+"/"+n+"/updateAttachment",o=this._getLayerRequestOptions({query:{attachmentId:e}}),r=this._getFormDataForAttachment(a,o.query);try{const l=await m(s,{body:r});return this._createFeatureEditResult(l.data.updateAttachmentResult)}catch(l){throw this._createAttachmentErrorResult(n,l)}}async applyEdits(t,e){var A,w,q,T,x,S,O;await this.load();const a=this.layer.infoFor3D,n=a!=null,s=n||((e==null?void 0:e.globalIdUsed)??!1),o=((A=t.addFeatures)==null?void 0:A.map(y=>this._serializeFeature(y,a)).filter(U))??[],r=((w=t.updateFeatures)==null?void 0:w.map(y=>this._serializeFeature(y,a)).filter(U))??[],l=this._getFeatureIds(t.deleteFeatures,s),u=n&&this.layer.capabilities.editing.supportsAsyncApplyEdits;se(o,r,this.layer.spatialReference);const d=[],h=[],b=[...t.deleteAttachments??[]];for(const y of t.addAttachments??[])d.push(await this._serializeAttachment(y));for(const y of t.updateAttachments??[])h.push(await this._serializeAttachment(y));const f=d.length||h.length||b.length?{adds:d,updates:h,deletes:b}:null;let p;if(n&&((q=t.addAssetFeatures)!=null&&q.length)){const{addAssetFeatures:y}=t,k=y.map(M=>M.geometry);await this.uploadAssets(k),p={adds:this._createAssetMapEdits(y),updates:[],deletes:[]}}const i={gdbVersion:(e==null?void 0:e.gdbVersion)||this.layer.gdbVersion,rollbackOnFailure:e==null?void 0:e.rollbackOnFailureEnabled,useGlobalIds:s,returnEditMoment:e==null?void 0:e.returnEditMoment,usePreviousEditMoment:e==null?void 0:e.usePreviousEditMoment,sessionId:e==null?void 0:e.sessionId,async:u};e!=null&&e.returnServiceEditsOption?(i.edits=JSON.stringify([{id:this.layer.layerId,adds:o,updates:r,deletes:l,attachments:f,assetMaps:p}]),i.returnServiceEditsOption=ae.toJSON(e==null?void 0:e.returnServiceEditsOption),i.returnServiceEditsInSourceSR=e==null?void 0:e.returnServiceEditsInSourceSR):(i.adds=o.length?JSON.stringify(o):null,i.updates=r.length?JSON.stringify(r):null,i.deletes=l.length?s?JSON.stringify(l):l.join(","):null,i.attachments=f&&JSON.stringify(f),i.assetMaps=p!=null?JSON.stringify(p):void 0);const c=this._getLayerRequestOptions({method:"post",query:i}),g=e!=null&&e.returnServiceEditsOption?this.layer.url:this.layer.parsedUrl.path,R=u?await this._asyncApplyEdits(g+"/applyEdits",c):await m(g+"/applyEdits",c);if(!((T=this.layer.capabilities.operations)!=null&&T.supportsEditing)&&((S=(x=this.layer.effectiveCapabilities)==null?void 0:x.operations)==null?void 0:S.supportsEditing)){const y=(O=D)==null?void 0:O.findCredential(this.layer.url);await(y==null?void 0:y.refreshToken())}return this._createEditsResult(R)}async deleteAttachments(t,e){await this.load();const a=t.attributes[this.layer.objectIdField],n=this.layer.parsedUrl.path+"/"+a+"/deleteAttachments";try{return(await m(n,this._getLayerRequestOptions({query:{attachmentIds:e.join(",")},method:"post"}))).data.deleteAttachmentResults.map(this._createFeatureEditResult)}catch(s){throw this._createAttachmentErrorResult(a,s)}}fetchRecomputedExtents(t={}){const e=t.signal;return this.load({signal:e}).then(async()=>{const a=this._getLayerRequestOptions({...t,query:{returnUpdates:!0}}),{layerId:n,url:s}=this.layer,{data:o}=await m(`${s}/${n}`,a),{id:r,extent:l,fullExtent:u,timeExtent:d}=o,h=l||u;return{id:r,fullExtent:h&&G.fromJSON(h),timeExtent:d&&N.fromJSON({start:d[0],end:d[1]})}})}async queryAttachments(t,e={}){await this.load();const a=this._getLayerRequestOptions(e);return this.queryTask.executeAttachmentQuery(t,a)}async queryFeatures(t,e){return await this.load(),this.queryTask.execute(t,{...e,query:this._createRequestQueryOptions(e)})}async queryFeaturesJSON(t,e){return await this.load(),this.queryTask.executeJSON(t,{...e,query:this._createRequestQueryOptions(e)})}async queryObjectIds(t,e){return await this.load(),this.queryTask.executeForIds(t,{...e,query:this._createRequestQueryOptions(e)})}async queryFeatureCount(t,e){return await this.load(),this.queryTask.executeForCount(t,{...e,query:this._createRequestQueryOptions(e)})}async queryExtent(t,e){return await this.load(),this.queryTask.executeForExtent(t,{...e,query:this._createRequestQueryOptions(e)})}async queryRelatedFeatures(t,e){return await this.load(),this.queryTask.executeRelationshipQuery(t,{...e,query:this._createRequestQueryOptions(e)})}async queryRelatedFeaturesCount(t,e){return await this.load(),this.queryTask.executeRelationshipQueryForCount(t,{...e,query:this._createRequestQueryOptions(e)})}async queryTopFeatures(t,e){return await this.load(),this.queryTask.executeTopFeaturesQuery(t,{...e,query:this._createRequestQueryOptions(e)})}async queryTopObjectIds(t,e){return await this.load(),this.queryTask.executeForTopIds(t,{...e,query:this._createRequestQueryOptions(e)})}async queryTopExtents(t,e){return await this.load(),this.queryTask.executeForTopExtents(t,{...e,query:this._createRequestQueryOptions(e)})}async queryTopCount(t,e){return await this.load(),this.queryTask.executeForTopCount(t,{...e,query:this._createRequestQueryOptions(e)})}async fetchPublishingStatus(){if(!$(this.layer.url))return"unavailable";const t=V(this.layer.url,"status"),e=await m(t,{query:{f:"json"}});return ne.fromJSON(e.data.status)}async uploadAssets(t,e){const{uploadAssets:a}=await J(()=>import("./uploadAssets-7c1324a2.js"),["assets/uploadAssets-7c1324a2.js","assets/index-1ff2b83b.js","assets/index-d832a396.css","assets/External-b242d32b.js","assets/infoFor3D-91dff30a.js"]);return a(t,{layer:this.layer,ongoingUploads:this._ongoingAssetUploads},e)}async _asyncApplyEdits(t,e){const s=(await m(t,e)).data.statusUrl;for(;;){const r=(await m(s,{query:{f:"json"},responseType:"json"})).data;switch(r.status){case"Completed":return m(r.resultUrl,{query:{f:"json"},responseType:"json"});case"CompletedWithErrors":throw new F("async-applyEdits-failed","asynchronous applyEdits call failed.");case"Failed ImportChanges":case"InProgress":case"Pending":case"ExportAttachments":case"ExportChanges":case"ExportingData":case"ExportingSnapshot":case"ImportAttachments":case"ProvisioningReplica":case"UnRegisteringReplica":break;default:throw new F("async-applyEdits-failed","asynchronous applyEdits call failed (undefined response status)")}await z(ie)}}_createRequestQueryOptions(t){const e={...this.layer.customParameters,token:this.layer.apiKey,...t==null?void 0:t.query};return this.layer.datesInUnknownTimezone&&(e.timeReferenceUnknownClient=!0),e}async _fetchService(t,e){if(!t){const{data:n}=await m(this.layer.parsedUrl.path,this._getLayerRequestOptions({query:j("featurelayer-advanced-symbols")?{returnAdvancedSymbols:!0}:{},signal:e}));t=n}this.sourceJSON=this._patchServiceJSON(t);const a=t.type;if(!re.has(a))throw new F("feature-layer-source:unsupported-type",`Source type "${a}" is not supported`)}_patchServiceJSON(t){var e;if(t.type!=="Table"&&t.geometryType&&!((e=t==null?void 0:t.drawingInfo)!=null&&e.renderer)&&!t.defaultSymbol){const a=ee(t.geometryType).renderer;Y("drawingInfo.renderer",a,t)}return t.geometryType==="esriGeometryMultiPatch"&&t.infoFor3D&&(t.geometryType="mesh"),t}_serializeFeature(t,e){const{geometry:a,attributes:n}=t;if(e!=null&&t.geometry!=null&&t.geometry.type==="mesh"){const s={...n},o=t.geometry,r=o.origin,l=o.transform;if(s[e.transformFieldRoles.originX]=r.x,s[e.transformFieldRoles.originY]=r.y,s[e.transformFieldRoles.originZ]=r.z,l!=null){const u=l.translation,d=l.scale,h=l.rotation;s[e.transformFieldRoles.translationX]=u[0],s[e.transformFieldRoles.translationY]=-u[2],s[e.transformFieldRoles.translationZ]=u[1],s[e.transformFieldRoles.scaleX]=d[0],s[e.transformFieldRoles.scaleY]=d[1],s[e.transformFieldRoles.scaleZ]=d[2],s[e.transformFieldRoles.rotationX]=h[0],s[e.transformFieldRoles.rotationY]=h[2],s[e.transformFieldRoles.rotationZ]=h[1],s[e.transformFieldRoles.rotationDeg]=h[3]}return{geometry:null,attributes:s}}return a==null?{attributes:n}:a.type==="mesh"||a.type==="extent"?null:{geometry:a.toJSON(),attributes:n}}async _serializeAttachment(t){const{feature:e,attachment:a}=t,{globalId:n,name:s,contentType:o,data:r,uploadId:l}=a,u={globalId:n,parentGlobalId:null,contentType:null,name:null,uploadId:null,data:null};if(e&&("attributes"in e?u.parentGlobalId=e.attributes&&e.attributes[this.layer.globalIdField]:u.parentGlobalId=e.globalId),l)u.uploadId=l;else if(r){const d=await Z(r);d&&(u.contentType=d.mediaType,u.data=d.data),r instanceof File&&(u.name=r.name)}return s&&(u.name=s),o&&(u.contentType=o),u}_createAssetMapEdits(t){var o;const e=new Array,a=this.layer.globalIdField,n=this.layer.parsedUrl,s=(r,l,u)=>{e.push({globalId:K(),parentGlobalId:l,assetName:r.assetName,assetHash:r.assetHash,flags:u})};for(const r of t){const l=r.geometry,{externalSources:u}=l.metadata,d=u.items.filter(i=>W(i,n)),h=r.getAttribute(a),f=((o=r.geometry.transform)==null?void 0:o.geographic)?["PROJECT_VERTICES"]:[],p=i=>s(i,h,f);for(const i of d){const{source:c}=i;Array.isArray(c)?c.map(p):p(c)}}return e}_getFeatureIds(t,e){const a=t==null?void 0:t[0];return a?this._canUseGlobalIds(e,t)?this._getGlobalIdsFromFeatureIdentifier(t):"objectId"in a?this._getObjectIdsFromFeatureIdentifier(t):this._getIdsFromFeatures(t):[]}_getIdsFromFeatures(t){const e=this.layer.objectIdField;return t.map(a=>a.attributes&&a.attributes[e])}_canUseGlobalIds(t,e){return t&&"globalId"in e[0]}_getObjectIdsFromFeatureIdentifier(t){return t.map(e=>e.objectId)}_getGlobalIdsFromFeatureIdentifier(t){return t.map(e=>e.globalId)}_createEditsResult(t){var u,d,h,b,f,p;const e=t.data,{layerId:a}=this.layer,n=[];let s=null;if(Array.isArray(e))for(const i of e)n.push({id:i.id,editedFeatures:i.editedFeatures}),i.id===a&&(s={addResults:i.addResults??[],updateResults:i.updateResults??[],deleteResults:i.deleteResults??[],attachments:i.attachments,editMoment:i.editMoment});else s=e;const o=s==null?void 0:s.assetMaps;if(o){for(const i of o.addResults)i.success||C.getLogger(this.declaredClass).error(`Failed to map asset to feature with globalId ${i.globalId}.`);for(const i of o.updateResults)i.success||C.getLogger(this.declaredClass).error(`Failed to map asset to feature with globalId ${i.globalId}.`)}const r=s==null?void 0:s.attachments,l={addFeatureResults:((u=s==null?void 0:s.addResults)==null?void 0:u.map(this._createFeatureEditResult,this))??[],updateFeatureResults:((d=s==null?void 0:s.updateResults)==null?void 0:d.map(this._createFeatureEditResult,this))??[],deleteFeatureResults:((h=s==null?void 0:s.deleteResults)==null?void 0:h.map(this._createFeatureEditResult,this))??[],addAttachmentResults:r&&r.addResults?r.addResults.map(this._createFeatureEditResult,this):[],updateAttachmentResults:r&&r.updateResults?r.updateResults.map(this._createFeatureEditResult,this):[],deleteAttachmentResults:r&&r.deleteResults?r.deleteResults.map(this._createFeatureEditResult,this):[]};if(s!=null&&s.editMoment&&(l.editMoment=s.editMoment),n.length>0){l.editedFeatureResults=[];for(const i of n){const{editedFeatures:c}=i,g=c!=null&&c.spatialReference?new B(c.spatialReference):null;l.editedFeatureResults.push({layerId:i.id,editedFeatures:{adds:((b=c==null?void 0:c.adds)==null?void 0:b.map(R=>this._createEditedFeature(R,g)))||[],updates:((f=c==null?void 0:c.updates)==null?void 0:f.map(R=>({original:this._createEditedFeature(R[0],g),current:this._createEditedFeature(R[1],g)})))||[],deletes:((p=c==null?void 0:c.deletes)==null?void 0:p.map(R=>this._createEditedFeature(R,g)))||[],spatialReference:g}})}}return l}_createEditedFeature(t,e){return new X({attributes:t.attributes,geometry:H({...t.geometry,spatialReference:e})})}_createFeatureEditResult(t){const e=t.success===!0?null:t.error||{code:void 0,description:void 0};return{objectId:t.objectId,globalId:t.globalId,error:e?new F("feature-layer-source:edit-failure",e.description,{code:e.code}):null}}_createAttachmentErrorResult(t,e){const a=e.details.messages&&e.details.messages[0]||e.message,n=e.details.httpStatus||e.details.messageCode;return{objectId:t,globalId:null,error:new F("feature-layer-source:attachment-failure",a,{code:n})}}_getFormDataForAttachment(t,e){const a=t instanceof FormData?t:t&&t.elements?new FormData(t):null;if(a)for(const n in e){const s=e[n];s!=null&&(a.set?a.set(n,s):a.append(n,s))}return a}_getLayerRequestOptions(t={}){const{parsedUrl:e,gdbVersion:a,dynamicDataSource:n}=this.layer;return{...t,query:{gdbVersion:a,layer:n?JSON.stringify({source:n}):void 0,...e.query,f:"json",...this._createRequestQueryOptions(t)},responseType:"json"}}};E([I()],_.prototype,"type",void 0);E([I({constructOnly:!0})],_.prototype,"layer",void 0);E([I({readOnly:!0})],_.prototype,"queryTask",null);_=E([Q("esri.layers.graphics.sources.FeatureLayerSource")],_);const ie=1e3,Le=_;export{Le as default};
