import{d as Et}from"./deduplicate-2c15084f.js";import{n as M}from"./InterleavedLayout-ca0609dc.js";import{V as u}from"./VertexAttribute-8238ac80.js";import{D}from"./enums-08489827.js";import{V as It}from"./VertexElementDescriptor-24e04d97.js";import{br as ot,gn as pt,go as At,s as H,gp as et,gq as k,gr as Ot,gs as St,gt as ft,gu as st,gv as ut,b as T,gw as wt,cR as Tt}from"./index-0cbe37a0.js";function j(t,n=0){const e=t.stride;return Array.from(t.fields.keys()).filter(c=>{var r;const s=(r=t.fields.get(c))==null?void 0:r.optional;return!(s&&s.glPadding)}).map(c=>{const s=t.fields.get(c),r=s.constructor.ElementCount,g=Pt(s.constructor.ElementType),i=s.offset,h=!!(s.optional&&s.optional.glNormalized);return new It(c,r,g,i,e,h,n)})}function Pt(t){const n=vt[t];if(n)return n;throw new Error("BufferType not supported in WebGL")}const vt={u8:D.UNSIGNED_BYTE,u16:D.UNSIGNED_SHORT,u32:D.UNSIGNED_INT,i8:D.BYTE,i16:D.SHORT,i32:D.INT,f32:D.FLOAT},Lt=M().vec3f(u.POSITION).u16(u.COMPONENTINDEX).u16(u.U16PADDING),yt=M().vec2u8(u.SIDENESS);j(yt);const gt=M().vec3f(u.POSITION0).vec3f(u.POSITION1).u16(u.COMPONENTINDEX).u8(u.VARIANTOFFSET,{glNormalized:!0}).u8(u.VARIANTSTROKE).u8(u.VARIANTEXTENSION,{glNormalized:!0}).u8(u.U8PADDING,{glPadding:!0}).u16(u.U16PADDING,{glPadding:!0}),K=gt.clone().vec3f(u.NORMAL),Y=gt.clone().vec3f(u.NORMALA).vec3f(u.NORMALB);u.POSITION0,u.POSITION1,u.COMPONENTINDEX,u.VARIANTOFFSET,u.VARIANTSTROKE,u.VARIANTEXTENSION,u.NORMAL,u.NORMALA,u.NORMALB,u.SIDENESS;const R=-1;var ct;(function(t){t[t.SOLID=0]="SOLID",t[t.SKETCH=1]="SKETCH"})(ct||(ct={}));function Dt(t,n,e,c=bt){const s=t.vertices.position,r=t.vertices.componentIndex,g=ot(c.anglePlanar),i=ot(c.angleSignificantEdge),h=Math.cos(i),l=Math.cos(g),f=z.edge,E=f.position0,I=f.position1,N=f.faceNormal0,P=f.faceNormal1,p=Bt(t),v=_t(t),o=v.length/4,a=n.allocate(o);let d=0;const m=o,A=e.allocate(m);let S=0,L=0,O=0;const Z=pt(0,o),b=new Float32Array(o);b.forEach((V,w,B)=>{s.getVec(v[w*4],E),s.getVec(v[w*4+1],I),B[w]=At(E,I)}),Z.sort((V,w)=>b[w]-b[V]);const $=new Array,tt=new Array;for(let V=0;V<o;V++){const w=Z[V],B=b[w],W=v[w*4],Nt=v[w*4+1],F=v[w*4+2],x=v[w*4+3],nt=x===R;if(s.getVec(W,E),s.getVec(Nt,I),nt)H(N,p[F*3],p[F*3+1],p[F*3+2]),et(P,N),f.componentIndex=r.get(W),f.cosAngle=k(N,P);else{if(H(N,p[F*3],p[F*3+1],p[F*3+2]),H(P,p[x*3],p[x*3+1],p[x*3+2]),f.componentIndex=r.get(W),f.cosAngle=k(N,P),Vt(f,l))continue;f.cosAngle<-.9999&&et(P,N)}L+=B,O++,nt||Rt(f,h)?(n.write(a,d++,f),$.push(B)):Ft(f,g)&&(e.write(A,S++,f),tt.push(B))}const mt=new Float32Array($.reverse()),ht=new Float32Array(tt.reverse());return{regular:{instancesData:n.trim(a,d),lodInfo:{lengths:mt}},silhouette:{instancesData:e.trim(A,S),lodInfo:{lengths:ht}},averageEdgeLength:L/O}}function Rt(t,n){return t.cosAngle<n}function Vt(t,n){return t.cosAngle>n}function Ft(t,n){const e=Ot(t.cosAngle),c=z.fwd,s=z.ortho;St(c,t.position1,t.position0);const r=k(ft(s,t.faceNormal0,t.faceNormal1),c)>0?-1:1;return e*r>n}function _t(t){const n=t.faces.length/3,e=t.faces,c=t.neighbors;let s=0;for(let i=0;i<n;i++){const h=c[i*3],l=c[i*3+1],f=c[i*3+2],E=e[i*3],I=e[i*3+1],N=e[i*3+2];s+=h===R||E<I?1:0,s+=l===R||I<N?1:0,s+=f===R||N<E?1:0}const r=new Int32Array(s*4);let g=0;for(let i=0;i<n;i++){const h=c[i*3],l=c[i*3+1],f=c[i*3+2],E=e[i*3],I=e[i*3+1],N=e[i*3+2];(h===R||E<I)&&(r[g++]=E,r[g++]=I,r[g++]=i,r[g++]=h),(l===R||I<N)&&(r[g++]=I,r[g++]=N,r[g++]=i,r[g++]=l),(f===R||N<E)&&(r[g++]=N,r[g++]=E,r[g++]=i,r[g++]=f)}return r}function Bt(t){const n=t.faces.length/3,e=t.vertices.position,c=t.faces,s=X.v0,r=X.v1,g=X.v2,i=new Float32Array(n*3);for(let h=0;h<n;h++){const l=c[h*3],f=c[h*3+1],E=c[h*3+2];e.getVec(l,s),e.getVec(f,r),e.getVec(E,g),st(r,r,s),st(g,g,s),ft(s,r,g),ut(s,s),i[h*3]=s[0],i[h*3+1]=s[1],i[h*3+2]=s[2]}return i}const Mt={position0:T(),position1:T(),faceNormal0:T(),faceNormal1:T(),componentIndex:0,cosAngle:0},z={edge:Mt,ortho:T(),fwd:T()},X={v0:T(),v1:T(),v2:T()},bt={anglePlanar:4,angleSignificantEdge:35};function rt(t,n,e){const c=n/3,s=new Uint32Array(e+1),r=new Uint32Array(e+1),g=(o,a)=>{o<a?s[o+1]++:r[a+1]++};for(let o=0;o<c;o++){const a=t[o*3],d=t[o*3+1],m=t[o*3+2];g(a,d),g(d,m),g(m,a)}let i=0,h=0;for(let o=0;o<e;o++){const a=s[o+1],d=r[o+1];s[o+1]=i,r[o+1]=h,i+=a,h+=d}const l=new Uint32Array(c*6),f=s[e],E=(o,a,d)=>{if(o<a){const m=s[o+1]++;l[2*m]=a,l[2*m+1]=d}else{const m=r[a+1]++;l[2*f+2*m]=o,l[2*f+2*m+1]=d}};for(let o=0;o<c;o++){const a=t[o*3],d=t[o*3+1],m=t[o*3+2];E(a,d,o),E(d,m,o),E(m,a,o)}const I=(o,a)=>{const d=o*2,m=a-o;for(let A=1;A<m;A++){const S=l[d+A*2],L=l[d+A*2+1];let O=A-1;for(O;O>=0&&l[d+O*2]>S;O--)l[d+O*2+2]=l[d+O*2],l[d+O*2+3]=l[d+O*2+1];l[d+O*2+2]=S,l[d+O*2+3]=L}};for(let o=0;o<e;o++)I(s[o],s[o+1]),I(f+r[o],f+r[o+1]);const N=new Int32Array(3*c),P=(o,a)=>o===t[a*3]?0:o===t[a*3+1]?1:o===t[a*3+2]?2:-1,p=(o,a)=>{const d=P(o,a);N[a*3+d]=-1},v=(o,a,d,m)=>{const A=P(o,a);N[a*3+A]=m;const S=P(d,m);N[m*3+S]=a};for(let o=0;o<e;o++){let a=s[o];const d=s[o+1];let m=r[o];const A=r[o+1];for(;a<d&&m<A;){const S=l[a*2],L=l[f*2+m*2];S===L?(v(o,l[a*2+1],L,l[f*2+m*2+1]),a++,m++):S<L?(p(o,l[a*2+1]),a++):(p(L,l[f*2+m*2+1]),m++)}for(;a<d;)p(o,l[a*2+1]),a++;for(;m<A;){const S=l[f*2+m*2];p(S,l[f*2+m*2+1]),m++}}return N}class dt{updateSettings(n){this.settings=n,this._edgeHashFunction=n.reducedPrecision?Ct:xt}write(n,e,c){const s=this._edgeHashFunction(c);U.seed=s;const r=U.getIntRange(0,255),g=U.getIntRange(0,this.settings.variants-1),i=.7,h=U.getFloat(),l=-(1-Math.min(h/i,1)),f=Math.max(0,h-i)/(1-i),I=(Ut(l+f,1.2)*.5+.5)*255;n.position0.setVec(e,c.position0),n.position1.setVec(e,c.position1),n.componentIndex.set(e,c.componentIndex),n.variantOffset.set(e,r),n.variantStroke.set(e,g),n.variantExtension.set(e,I)}trim(n,e){return n.slice(0,e)}}const q=new Float32Array(6),G=new Uint32Array(q.buffer),y=new Uint32Array(1);function xt(t){const n=q;n[0]=t.position0[0],n[1]=t.position0[1],n[2]=t.position0[2],n[3]=t.position1[0],n[4]=t.position1[1],n[5]=t.position1[2],y[0]=5381;for(let e=0;e<G.length;e++)y[0]=y[0]*31+G[e];return y[0]}function Ct(t){const n=q;n[0]=_(t.position0[0]),n[1]=_(t.position0[1]),n[2]=_(t.position0[2]),n[3]=_(t.position1[0]),n[4]=_(t.position1[1]),n[5]=_(t.position1[2]),y[0]=5381;for(let e=0;e<G.length;e++)y[0]=y[0]*31+G[e];return y[0]}const at=1e4;function _(t){return Math.round(t*at)/at}function Ut(t,n){const e=t<0?-1:1;return Math.abs(t)**n*e}class J{constructor(){this._commonWriter=new dt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return K.createBuffer(n)}write(n,e,c){this._commonWriter.write(n,e,c),wt(C,c.faceNormal0,c.faceNormal1),ut(C,C),n.normal.setVec(e,C)}trim(n,e){return this._commonWriter.trim(n,e)}}J.Layout=K;J.glLayout=j(K,1);class Q{constructor(){this._commonWriter=new dt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return Y.createBuffer(n)}write(n,e,c){this._commonWriter.write(n,e,c),n.normalA.setVec(e,c.faceNormal0),n.normalB.setVec(e,c.faceNormal1)}trim(n,e){return this._commonWriter.trim(n,e)}}Q.Layout=Y;Q.glLayout=j(Y,1);const C=T(),U=new Tt;function Yt(t){const n=Gt(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return it.updateSettings(t.writerSettings),lt.updateSettings(t.writerSettings),Dt(n,it,lt)}function Gt(t,n,e,c){if(n){const g=rt(e,c,t.count);return new Wt(e,c,g,t)}const s=Et(t.buffer,t.stride/4,{originalIndices:e,originalIndicesLength:c}),r=rt(s.indices,c,s.uniqueCount);return{faces:s.indices,facesLength:s.indices.length,neighbors:r,vertices:Lt.createView(s.buffer)}}class Wt{constructor(n,e,c,s){this.faces=n,this.facesLength=e,this.neighbors=c,this.vertices=s}}const it=new J,lt=new Q,qt=M().vec3f(u.POSITION0).vec3f(u.POSITION1),Jt=M().vec3f(u.POSITION0).vec3f(u.POSITION1).u16(u.COMPONENTINDEX).u16(u.U16PADDING,{glPadding:!0});export{Lt as E,Gt as a,Dt as b,qt as c,Jt as d,Yt as e};
