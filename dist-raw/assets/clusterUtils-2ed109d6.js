import{aL as x,ae as f,af as m,ai as A,bD as T,cE as k,bG as O,L as U,m as L,E as N}from"./index-ffb342b4.js";import{S as R,A as q,a as w}from"./SizeVariable-5571e455.js";import{i as j}from"./sizeVariableUtils-2914222a.js";let y=class extends x(T){constructor(a){super(a),this.expression=null,this.title=null,this.returnType=null}};f([m({type:String,json:{write:!0}})],y.prototype,"expression",void 0);f([m({type:String,json:{write:!0}})],y.prototype,"title",void 0);f([m({type:String,json:{write:!0}})],y.prototype,"returnType",void 0);y=f([A("esri.layers.support.ExpressionInfo")],y);const $=y;var _;let h=_=class extends T{constructor(a){super(a),this.isAutoGenerated=!1,this.name=null,this.alias=null,this.onStatisticField=null,this.onStatisticExpression=null,this.statisticType=null}clone(){return new _({name:this.name,alias:this.alias,isAutoGenerated:this.isAutoGenerated,onStatisticExpression:k(this.onStatisticExpression),onStatisticField:this.onStatisticField,statisticType:this.statisticType})}};f([m({type:Boolean,json:{write:!0}})],h.prototype,"isAutoGenerated",void 0);f([m({type:String,json:{write:!0}})],h.prototype,"name",void 0);f([m({type:String,json:{write:!0}})],h.prototype,"alias",void 0);f([m({type:String,json:{write:!0}})],h.prototype,"onStatisticField",void 0);f([m({type:$,json:{write:!0}})],h.prototype,"onStatisticExpression",void 0);f([m({type:String,json:{write:!0}})],h.prototype,"statisticType",void 0);h=_=f([A("esri.layers.support.AggregateField")],h);const F=h,b={Base64:0,Hex:1,String:2,Raw:3},S=8,D=(1<<S)-1;function g(e,a){const s=(e&65535)+(a&65535);return(e>>16)+(a>>16)+(s>>16)<<16|s&65535}function W(e){const a=[];for(let s=0,i=e.length*S;s<i;s+=S)a[s>>5]|=(e.charCodeAt(s/S)&D)<<s%32;return a}function J(e){const a=[];for(let s=0,i=e.length*32;s<i;s+=S)a.push(String.fromCharCode(e[s>>5]>>>s%32&D));return a.join("")}function X(e){const a="0123456789abcdef",s=[];for(let i=0,n=e.length*4;i<n;i++)s.push(a.charAt(e[i>>2]>>i%4*8+4&15)+a.charAt(e[i>>2]>>i%4*8&15));return s.join("")}function K(e){const a="=",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=[];for(let n=0,t=e.length*4;n<t;n+=3){const r=(e[n>>2]>>8*(n%4)&255)<<16|(e[n+1>>2]>>8*((n+1)%4)&255)<<8|e[n+2>>2]>>8*((n+2)%4)&255;for(let d=0;d<4;d++)n*8+d*6>e.length*32?i.push(a):i.push(s.charAt(r>>6*(3-d)&63))}return i.join("")}function P(e,a){return e<<a|e>>>32-a}function V(e,a,s,i,n,t){return g(P(g(g(a,e),g(i,t)),n),s)}function l(e,a,s,i,n,t,r){return V(a&s|~a&i,e,a,n,t,r)}function u(e,a,s,i,n,t,r){return V(a&i|s&~i,e,a,n,t,r)}function c(e,a,s,i,n,t,r){return V(a^s^i,e,a,n,t,r)}function p(e,a,s,i,n,t,r){return V(s^(a|~i),e,a,n,t,r)}function Q(e,a){e[a>>5]|=128<<a%32,e[(a+64>>>9<<4)+14]=a;let s=1732584193,i=-271733879,n=-1732584194,t=271733878;for(let r=0;r<e.length;r+=16){const d=s,o=i,B=n,M=t;s=l(s,i,n,t,e[r],7,-680876936),t=l(t,s,i,n,e[r+1],12,-389564586),n=l(n,t,s,i,e[r+2],17,606105819),i=l(i,n,t,s,e[r+3],22,-1044525330),s=l(s,i,n,t,e[r+4],7,-176418897),t=l(t,s,i,n,e[r+5],12,1200080426),n=l(n,t,s,i,e[r+6],17,-1473231341),i=l(i,n,t,s,e[r+7],22,-45705983),s=l(s,i,n,t,e[r+8],7,1770035416),t=l(t,s,i,n,e[r+9],12,-1958414417),n=l(n,t,s,i,e[r+10],17,-42063),i=l(i,n,t,s,e[r+11],22,-1990404162),s=l(s,i,n,t,e[r+12],7,1804603682),t=l(t,s,i,n,e[r+13],12,-40341101),n=l(n,t,s,i,e[r+14],17,-1502002290),i=l(i,n,t,s,e[r+15],22,1236535329),s=u(s,i,n,t,e[r+1],5,-165796510),t=u(t,s,i,n,e[r+6],9,-1069501632),n=u(n,t,s,i,e[r+11],14,643717713),i=u(i,n,t,s,e[r],20,-373897302),s=u(s,i,n,t,e[r+5],5,-701558691),t=u(t,s,i,n,e[r+10],9,38016083),n=u(n,t,s,i,e[r+15],14,-660478335),i=u(i,n,t,s,e[r+4],20,-405537848),s=u(s,i,n,t,e[r+9],5,568446438),t=u(t,s,i,n,e[r+14],9,-1019803690),n=u(n,t,s,i,e[r+3],14,-187363961),i=u(i,n,t,s,e[r+8],20,1163531501),s=u(s,i,n,t,e[r+13],5,-1444681467),t=u(t,s,i,n,e[r+2],9,-51403784),n=u(n,t,s,i,e[r+7],14,1735328473),i=u(i,n,t,s,e[r+12],20,-1926607734),s=c(s,i,n,t,e[r+5],4,-378558),t=c(t,s,i,n,e[r+8],11,-2022574463),n=c(n,t,s,i,e[r+11],16,1839030562),i=c(i,n,t,s,e[r+14],23,-35309556),s=c(s,i,n,t,e[r+1],4,-1530992060),t=c(t,s,i,n,e[r+4],11,1272893353),n=c(n,t,s,i,e[r+7],16,-155497632),i=c(i,n,t,s,e[r+10],23,-1094730640),s=c(s,i,n,t,e[r+13],4,681279174),t=c(t,s,i,n,e[r],11,-358537222),n=c(n,t,s,i,e[r+3],16,-722521979),i=c(i,n,t,s,e[r+6],23,76029189),s=c(s,i,n,t,e[r+9],4,-640364487),t=c(t,s,i,n,e[r+12],11,-421815835),n=c(n,t,s,i,e[r+15],16,530742520),i=c(i,n,t,s,e[r+2],23,-995338651),s=p(s,i,n,t,e[r],6,-198630844),t=p(t,s,i,n,e[r+7],10,1126891415),n=p(n,t,s,i,e[r+14],15,-1416354905),i=p(i,n,t,s,e[r+5],21,-57434055),s=p(s,i,n,t,e[r+12],6,1700485571),t=p(t,s,i,n,e[r+3],10,-1894986606),n=p(n,t,s,i,e[r+10],15,-1051523),i=p(i,n,t,s,e[r+1],21,-2054922799),s=p(s,i,n,t,e[r+8],6,1873313359),t=p(t,s,i,n,e[r+15],10,-30611744),n=p(n,t,s,i,e[r+6],15,-1560198380),i=p(i,n,t,s,e[r+13],21,1309151649),s=p(s,i,n,t,e[r+4],6,-145523070),t=p(t,s,i,n,e[r+11],10,-1120210379),n=p(n,t,s,i,e[r+2],15,718787259),i=p(i,n,t,s,e[r+9],21,-343485551),s=g(s,d),i=g(i,o),n=g(n,B),t=g(t,M)}return[s,i,n,t]}function G(e,a=b.Hex){const s=a||b.Base64,i=Q(W(e),e.length*S);switch(s){case b.Raw:return i;case b.Hex:return X(i);case b.String:return J(i);case b.Base64:return K(i)}}var C;let E=C=class extends R{writeLevels(a,s,i){for(const n in a){const t=this.levels[n];s.stops=t;return}}clone(){return new C({axis:this.axis,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,maxDataValue:this.maxDataValue,maxSize:j(this.maxSize)?this.maxSize.clone():this.maxSize,minDataValue:this.minDataValue,minSize:j(this.minSize)?this.minSize.clone():this.minSize,normalizationField:this.normalizationField,stops:this.stops&&this.stops.map(a=>a.clone()),target:this.target,useSymbolValue:this.useSymbolValue,valueRepresentation:this.valueRepresentation,valueUnit:this.valueUnit,legendOptions:this.legendOptions&&this.legendOptions.clone(),levels:k(this.levels)})}};f([m()],E.prototype,"levels",void 0);f([O("levels")],E.prototype,"writeLevels",null);E=C=f([A("esri.views.2d.engine.LevelDependentSizeVariable")],E);const Y=U.getLogger("esri.views.2d.layers.support.clusterUtils");L.add("esri-cluster-arcade-enabled",!0);const Z=L("esri-cluster-arcade-enabled"),ue=(e,a,s,i,n)=>{const t=a.clone();if(!te(t))return t;if(t.authoringInfo||(t.authoringInfo=new q),t.authoringInfo.isAutoGenerated=!0,"visualVariables"in t){const r=(t.visualVariables||[]).filter(o=>o.valueExpression!=="$view.scale"),d=I(r);r.forEach(o=>{o.type==="rotation"?o.field?o.field=v(e,o.field,"avg_angle","number"):o.valueExpression&&(o.field=z(e,o.valueExpression,"avg_angle","number"),o.valueExpression=null):o.normalizationField?(o.field=v(e,o.field,"avg_norm","number",o.normalizationField),o.normalizationField=null):o.field?o.field=v(e,o.field,"avg","number"):o.valueExpression&&(o.field=z(e,o.valueExpression,"avg","number"),o.valueExpression=null)}),d==null&&!ee(r)&&n&&(r.push(H(s,i)),t.dynamicClusterSize=!0),t.visualVariables=r}switch(t.type){case"simple":break;case"pie-chart":{for(const r of t.attributes)r.field?r.field=v(e,r.field,"sum","number"):r.valueExpression&&(r.field=z(e,r.valueExpression,"sum","number"),r.valueExpression=null);break}case"unique-value":t.field?t.field=v(e,t.field,"mode","string"):t.valueExpression&&(t.field=z(e,t.valueExpression,"mode","string"),t.valueExpression=null);break;case"class-breaks":t.normalizationField?(t.field=v(e,t.field,"avg_norm","number",t.normalizationField),t.normalizationField=null):t.field?t.field=v(e,t.field,"avg","number"):t.valueExpression&&(t.field=z(e,t.valueExpression,"avg","number"),t.valueExpression=null);break}return t},I=e=>{for(const a of e)if(a.type==="size")return a;return null};function ce(e,a,s){const i=e.clone();let n=!1;if("visualVariables"in i){const t=(i.visualVariables||[]).filter(d=>d.valueExpression!=="$view.scale");I(t)==null&&(i.visualVariables||(i.visualVariables=[]),i.visualVariables.push(H(a,s)),i.dynamicClusterSize=!0,n=!0)}return{renderer:i,didInject:n}}const ee=e=>{for(const a of e)if(a.field==="cluster_count")return!0;return!1},H=(e,a)=>{const s=[new w({value:0,size:0}),new w({value:1})];if(a==null)return new R({field:"cluster_count",stops:[...s,new w({value:2,size:0})]});const i=Object.keys(a).reduce((n,t)=>({...n,[t]:[...s,new w({value:Math.max(2,a[t].minValue),size:e.clusterMinSize}),new w({value:Math.max(3,a[t].maxValue),size:e.clusterMaxSize})]}),{});return new E({field:"cluster_count",levels:i})},te=e=>{const a=s=>Y.error(new N("Unsupported-renderer",s,{renderer:e}));if(!e)return!1;switch(e.type){case"unique-value":if(e.field2||e.field3)return a("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1;break;case"class-breaks":if(e.normalizationField){const s=e.normalizationType;if(s!=="field")return a(`FeatureReductionCluster does not support a normalizationType of ${s}`),!1}break;case"simple":case"pie-chart":break;default:return a(`FeatureReductionCluster does not support renderers of type ${e.type}`),!1}if(!Z){if("valueExpression"in e&&e.valueExpression)return a("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in e&&e.visualVariables||[]).some(i=>!!("valueExpression"in i&&i.valueExpression)))return a("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),!1}return!0};function se(e,a,s){switch(e){case"sum":return`cluster_sum_${a}`;case"avg":case"avg_angle":return`cluster_avg_${a}`;case"mode":return`cluster_type_${a}`;case"avg_norm":{const i=s,n="field",t=a.toLowerCase()+",norm:"+n+","+i.toLowerCase();return"cluster_avg_"+G(t)}}}function z(e,a,s,i){const n=G(a),t=s==="mode"?`cluster_type_${n}`:s==="sum"?`cluster_sum_${n}`:`cluster_avg_${n}`;return e.some(r=>r.name===t)||e.push(new F({name:t,isAutoGenerated:!0,onStatisticExpression:new $({expression:a,returnType:i}),statisticType:s})),t}function v(e,a,s,i,n){if(a==="cluster_count"||e.some(r=>r.name===a))return a;const t=se(s,a,n);return e.some(r=>r.name===t)||(s==="avg_norm"?e.push(new F({name:t,isAutoGenerated:!0,onStatisticExpression:new $({expression:`$feature.${a} / $feature.${n}`,returnType:i}),statisticType:"avg"})):e.push(new F({name:t,isAutoGenerated:!0,onStatisticField:a,statisticType:s}))),t}export{F as A,te as a,ue as b,H as c,G as d,I as f,ce as i,b as o};
