import{_ as wi,cd as N,cm as z,cq as Q,cn as R,cp as dt,cE as G,bt as hs,O as Z,cj as ce,cQ as Ys,cR as Vs,cS as Ci,cT as Ii,cU as ms,cV as ki,cW as Li,cX as vi,cY as Ti,cZ as Ai,c_ as Ei,m as Ni,c$ as zi,d0 as Oi,p as Bt,bj as Fi,bX as ss,d1 as le,d2 as Bs,d3 as is,d4 as gs,bN as me,d5 as Ws,d6 as De,d7 as ys,L as ue,d8 as Gi,d9 as Jt,da as Ri,ce as Di,E as Hi,db as ge,dc as Us,ax as qs,dd as F,de as se}from"./index-ffb342b4.js";import{B as Xi}from"./BidiEngine-cdaf024a.js";import{G as $s,T as Js,C as ye}from"./GeometryUtils-26dde58c.js";import{G as Pt,a as ve,b as v,L as $,c as ie,d as xe,P as it,E as ft,e as He,f as ne,g as Me,h as rt,i as ot,B as Yi,F as Vi,j as Bi,k as Wi,l as Ui,T as xs,V as qi,m as $i,n as Ms,o as Ee,C as Xe,J as Ye}from"./enums-eb6e4255.js";import{V as ae,H as Pe,c as Ji}from"./MaterialKey-6ab638aa.js";import{G as js,k as Ks,R as Zs,S as Qs}from"./definitions-3f56d206.js";import{z as J,a as be,b as ji}from"./color-3f29be9c.js";import{R as Ki}from"./Rect-df8ea165.js";import{u as Zi,b as Qi,c as tn,d as en}from"./quantizationUtils-3065e463.js";import{p as sn}from"./floatRGBA-413bea01.js";function A(l){return typeof l=="function"}function Ps(l,t,e,s){return A(l)?l(t,e,s):l}const nn=` /-,
`;function bs(l){let t=l.length;for(;t--;)if(!nn.includes(l.charAt(t)))return!1;return!0}function ti(l,t){const e=[];let s=0,i=-1;do if(i=l.indexOf("[",s),i>=s){if(i>s){const n=l.substr(s,i-s);e.push([n,null,bs(n)])}if(s=i+1,i=l.indexOf("]",s),i>=s){if(i>s){const n=l.substr(s,i-s),r=t[n];r&&e.push([null,r,!1])}s=i+1}}while(i!==-1);if(s<l.length-1){const n=l.substr(s);e.push([n,null,bs(n)])}return e}function ei(l,t,e){let s="",i=null;for(const n of t){const[r,a,o]=n;if(r)o?i=r:(i&&(s+=i,i=null),s+=r);else{const h=l.attributes[a];h&&(i&&(s+=i,i=null),s+=h)}}return si(s,e)}function rn(l,t,e){const s=ti(t,l);return i=>ei(i,s,e)}function si(l,t){switch(typeof l!="string"&&(l=String(l)),t){case"LowerCase":return l.toLowerCase();case"Allcaps":return l.toUpperCase();default:return l}}function bo(l,t,e,s,i,n,r=!0){const a=t/i,o=e/n,h=Math.ceil(a/2),c=Math.ceil(o/2);for(let u=0;u<n;u++)for(let f=0;f<i;f++){const _=(f+(r?n-u-1:u)*i)*4;let d=0,p=0,m=0,g=0,y=0,x=0,M=0;const P=(u+.5)*o;for(let b=Math.floor(u*o);b<(u+1)*o;b++){const w=Math.abs(P-(b+.5))/c,I=(f+.5)*a,k=w*w;for(let T=Math.floor(f*a);T<(f+1)*a;T++){let C=Math.abs(I-(T+.5))/h;const L=Math.sqrt(k+C*C);L>=-1&&L<=1&&(d=2*L*L*L-3*L*L+1,d>0&&(C=4*(T+b*t),M+=d*l[C+3],m+=d,l[C+3]<255&&(d=d*l[C+3]/250),g+=d*l[C],y+=d*l[C+1],x+=d*l[C+2],p+=d))}}s[_]=g/p,s[_+1]=y/p,s[_+2]=x/p,s[_+3]=M/m}}function W(l){return l?{r:l[0],g:l[1],b:l[2],a:l[3]/255}:{r:0,g:0,b:0,a:0}}function on(l){return l!=null&&(l.type==="CIMMarkerPlacementAlongLineRandomSize"||l.type==="CIMMarkerPlacementAlongLineSameSize"||l.type==="CIMMarkerPlacementAlongLineVariableSize"||l.type==="CIMMarkerPlacementAtExtremities"||l.type==="CIMMarkerPlacementAtMeasuredUnits"||l.type==="CIMMarkerPlacementAtRatioPositions"||l.type==="CIMMarkerPlacementOnLine"||l.type==="CIMMarkerPlacementOnVertices")}const S=(l,t=0)=>l==null||isNaN(l)?t:l,Se=l=>l.tintColor?W(l.tintColor):{r:255,g:255,b:255,a:1},an=l=>{if(!l)return!1;for(const t of l)switch(t.type){case"CIMGeometricEffectBuffer":case"CIMGeometricEffectOffset":case"CIMGeometricEffectDonut":return!0}return!1};function ln(){return wi(()=>import("./geometryEngineJSON-3f32db7a.js"),["assets/geometryEngineJSON-3f32db7a.js","assets/index-ffb342b4.js","assets/index-d832a396.css","assets/geometryEngineJSON-0e2cf205.js","assets/json-9ae8d6f8.js"])}function hn(l){if(!l)return"normal";switch(l.toLowerCase()){case"italic":return"italic";case"oblique":return"oblique";default:return"normal"}}function cn(l){if(!l)return"normal";switch(l.toLowerCase()){case"bold":return"bold";case"bolder":return"bolder";case"lighter":return"lighter";default:return"normal"}}function ii(l){let t="",e="";if(l){const s=l.toLowerCase();s.includes("italic")?t="italic":s.includes("oblique")&&(t="oblique"),s.includes("bold")?e="bold":s.includes("light")&&(e="lighter")}return{style:t,weight:e}}function ni(l){return l.underline?"underline":l.strikethrough?"line-through":"none"}function jt(l){if(!l)return null;switch(l.type){case"CIMPolygonSymbol":if(l.symbolLayers)for(const t of l.symbolLayers){const e=jt(t);if(e!=null)return e}break;case"CIMTextSymbol":return jt(l.symbol);case"CIMSolidFill":return l.color}}function Kt(l){if(l)switch(l.type){case"CIMPolygonSymbol":case"CIMLineSymbol":{const t=l.symbolLayers;if(t)for(const e of t){const s=Kt(e);if(s!=null)return s}break}case"CIMTextSymbol":return Kt(l.symbol);case"CIMSolidStroke":case"CIMSolidFill":return l.color}}function Ne(l){if(l)switch(l.type){case"CIMPolygonSymbol":case"CIMLineSymbol":if(l.symbolLayers)for(const t of l.symbolLayers){const e=Ne(t);if(e!==void 0)return e}break;case"CIMTextSymbol":return Ne(l.symbol);case"CIMSolidStroke":case"CIMGradientStroke":case"CIMPictureStroke":return l.width}}function ri(l){switch(l){case"Left":default:return"left";case"Right":return"right";case"Center":return"center";case"Justify":return"center"}}function oi(l){switch(l){case"Top":default:return"top";case"Center":return"middle";case"Baseline":return"baseline";case"Bottom":return"bottom"}}function un(l){return(l?Object.keys(l):[]).map(s=>({name:s,alias:s,type:typeof l[s]=="string"?"esriFieldTypeString":"esriFieldTypeDouble"}))}const Ut=l=>l.includes("data:image/svg+xml"),Ve=new Xi;function cs(l){if(l==null)return["",!1];if(!Ve.hasBidiChar(l))return[l,!1];const t=Ve.checkContextual(l);let e;return t==="rtl"?e="IDNNN":e="ICNNN",[Ve.bidiTransform(l,e,"VLYSN"),!0]}function us(l){if(!l)return"arial-unicode-ms";const t=l.toLowerCase().split(" ").join("-");switch(t){case"serif":return"noto-serif";case"sans-serif":return"arial-unicode-ms";case"monospace":return"ubuntu-mono";case"fantasy":return"cabin-sketch";case"cursive":return"redressed";default:return t}}function So(l){const t=fn(l)+_n(l);return us(l.family)+(t.length>0?t:"-regular")}function fn(l){if(!l.weight)return"";switch(l.weight.toLowerCase()){case"bold":case"bolder":return"-bold"}return""}function _n(l){if(!l.style)return"";switch(l.style.toLowerCase()){case"italic":case"oblique":return"-italic"}return""}class Qt{constructor(){this.setIdentity()}getAngle(){return(this.rz==null||this.rz===0&&this.rzCos!==1&&this.rzSin!==0)&&(this.rz=Math.atan2(this.rzSin,this.rzCos)),this.rz}setIdentity(){this.tx=0,this.ty=0,this.tz=0,this.s=1,this.rx=0,this.ry=0,this.rz=0,this.rzCos=1,this.rzSin=0}setTranslate(t,e){this.tx=t,this.ty=e}setTranslateZ(t){this.tz=t}setRotateCS(t,e){this.rz=void 0,this.rzCos=t,this.rzSin=e}setRotate(t){this.rz=t,this.rzCos=void 0,this.rzSin=void 0}setRotateY(t){this.ry=t}setScale(t){this.s=t}setMeasure(t){this.m=t}}class dn{constructor(){this._end=-1,this._yFactor=1,this._ids=new Map}initialize(t,e,s,i,n){return this.hasZ=s,this.hasM=i,this.geometryType=e,this._geometry=t,this._pathIndex=-1,this._pathOffset=0,this._stride=2+Number(s)+Number(i),this._pointOffset=-this._stride,this._end=-1,this._yFactor=n,this._ids.clear(),this}reset(){this.initialize(this._geometry,this.geometryType,this.hasZ,this.hasM,this._yFactor)}seekPathFront(){this._pointOffset=this._pathOffset-this._stride}seekPathEnd(){this._pointOffset=this._end}seekPathAt(t){const e=this._pathOffset+t*this._stride;return e>=0&&e<this._end?(this._pointOffset=e,!0):!1}nextPoint(){return(this._pointOffset+=this._stride)<this._end}prevPoint(){return(this._pointOffset-=this._stride)>=this._pathOffset}nextPath(){this._pathIndex>=0&&(this._pathOffset+=this._stride*this._geometry.lengths[this._pathIndex]),this._pointOffset=this._pathOffset-this._stride;const t=this._stride*this._geometry.lengths[this._pathIndex+1];return this._end=this._pointOffset+this._stride+t,++this._pathIndex<this._geometry.lengths.length}pathLength(){const t=this._end,e=this._stride,s=this._geometry.coords;let i=0;for(let n=this._pathOffset+e;n<t;n+=e){const r=s[n-e],a=s[n-e+1],o=s[n],h=s[n+1],c=o-r,u=h-a;i+=Math.sqrt(c*c+u*u)}return i}get numPoints(){const{lengths:t}=this._geometry;return this._pathIndex<0||this._pathIndex>t.length-1?0:t[this._pathIndex]}get numPaths(){return this._geometry.lengths.length}get pathIndex(){return this._pathIndex}get x(){return this._geometry.coords[this._pointOffset]}get y(){return this._yFactor*this._geometry.coords[this._pointOffset+1]}get z(){return this._geometry.coords[this._pointOffset+2]}get m(){const t=this.hasZ?3:2;return this._geometry.coords[this._pointOffset+t]}get id(){return this._ids.get(this._pointOffset)||0}set id(t){this._ids.set(this._pointOffset,t)}}function pn(l){const t=[l.x,l.y];return l.z&&t.push(l.z),l.m&&t.push(l.m),t}class mn{constructor(){this._pathLen=0,this._yFactor=1}initialize(t,e,s,i){const[n,r]=N(t)?[t.rings,"esriGeometryPolygon"]:z(t)?[t.paths,"esriGeometryPolyline"]:Q(t)?[[t.points],"esriGeometryMultipoint"]:R(t)?[[[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]]],"esriGeometryEnvelope"]:dt(t)?[[[pn(t)]],"esriGeometryPoint"]:[[],null];return this._paths=n,this.geometryType=r,this.hasZ=e,this.hasM=s,this._pathIndex=this._pointIndex=-1,this._yFactor=i,this}reset(){this._pathIndex=this._pointIndex=-1}seekPathFront(){this._pointIndex=-1}seekPathEnd(){this._pointIndex=this._currentPath.length}seekPathAt(t){return t>=0&&t<this._currentPath.length?(this._pointIndex=t,this._currentPoint=this._currentPath[this._pointIndex],!0):!1}nextPoint(){return this._currentPoint=this._currentPath[++this._pointIndex],this._pointIndex<this._pathLen}prevPoint(){return this._currentPoint=this._currentPath[--this._pointIndex],this._pointIndex>=0}nextPath(){return this._pointIndex=-1,this.pathIndex<this._paths.length-1?this._pathLen=this._paths[this._pathIndex+1].length:this._pathLen=0,this._currentPath=this._paths[++this._pathIndex],this._pathIndex<this._paths.length}pathLength(){const t=this._currentPath.length,e=this._currentPath;let s=0;for(let i=1;i<t;i++){const n=e[i-1],r=e[i],a=n[0],o=n[1],h=r[0],c=r[1],u=h-a,f=c-o;s+=Math.sqrt(u*u+f*f)}return s}get numPoints(){return this._pathIndex<0||this._pathIndex>this._paths.length-1?-1:this._paths[this._pathIndex].length}get numPaths(){return this._paths.length}get pathIndex(){return this._pathIndex}get pointIndex(){return this._pointIndex}get x(){return this._currentPoint[0]}get y(){return this._yFactor*this._currentPoint[1]}get z(){return this._currentPoint[2]}get m(){const t=this.hasZ?3:2;return this._currentPoint[t]}get id(){return this._currentPoint[4]}set id(t){this._currentPoint[4]=t}}const gn=new dn,yn=new mn;function wo(l,t,e=!1,s=!1,i=!1){return gn.initialize(l,t,s,i,e?-1:1)}function xn(l,t=!1,e=!1,s=!1){return yn.initialize(l,e,s,t?-1:1)}const ai=512;let D;class ns{constructor(t){this._geometry=t}next(){const t=this._geometry;return this._geometry=null,t}}function fs(l,t){D||(D=new Js(0,0,0,1)),D.reset($s.Polygon),D.setPixelMargin(t+1),D.setExtent(ai);let e,s;for(const n of l.rings)if(!(!n||n.length<3)){e=n[0][0],s=-n[0][1],D.moveTo(e,s);for(let r=1;r<n.length;r++)e=n[r][0],s=-n[r][1],D.lineTo(e,s);D.close()}const i=D.result(!1);if(i){const n=[];for(const r of i){const a=[];n.push(a);for(const o of r)a.push([o.x,-o.y])}return{rings:n}}return{rings:[]}}function li(l,t){D||(D=new Js(0,0,0,1)),D.reset($s.LineString),D.setPixelMargin(t+1),D.setExtent(ai);let e,s;for(const n of l.paths)if(!(!n||n.length<2)){e=n[0][0],s=-n[0][1],D.moveTo(e,s);for(let r=1;r<n.length;r++)e=n[r][0],s=-n[r][1],D.lineTo(e,s)}const i=D.result(!1);if(i){const n=[];for(const r of i){const a=[];n.push(a);for(const o of r)a.push([o.x,-o.y])}return{paths:n}}return{paths:[]}}class Mn{applyColorSubstituition(t,e){if(!e)return t;this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas"));const{width:s,height:i}=t,n=this._rasterizationCanvas,r=n.getContext("2d");t!==n&&(n.width=s,n.height=i,r.drawImage(t,0,0,s,i));const o=r.getImageData(0,0,s,i).data;if(e){for(const c of e)if(c&&c.oldColor&&c.oldColor.length===4&&c.newColor&&c.newColor.length===4){const[u,f,_,d]=c.oldColor,[p,m,g,y]=c.newColor;if(u===p&&f===m&&_===g&&d===y)continue;for(let x=0;x<o.length;x+=4)u===o[x]&&f===o[x+1]&&_===o[x+2]&&d===o[x+3]&&(o[x]=p,o[x+1]=m,o[x+2]=g,o[x+3]=y)}}const h=new ImageData(o,s,i);return r.putImageData(h,0,0),n}tintImageData(t,e){if(!e||e.length<4)return t;this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas"));const{width:s,height:i}=t,n=this._rasterizationCanvas,r=n.getContext("2d");t!==n&&(n.width=s,n.height=i,r.drawImage(t,0,0,s,i));const a=r.getImageData(0,0,s,i),o=new Uint8Array(a.data),h=[e[0]/255,e[1]/255,e[2]/255,e[3]/255];for(let u=0;u<o.length;u+=4)o[u]*=h[0],o[u+1]*=h[1],o[u+2]*=h[2],o[u+3]*=h[3];const c=new ImageData(new Uint8ClampedArray(o.buffer),s,i);return r.putImageData(c,0,0),n}}function Pn(l){const t=G(l);return bn(t),t}function hi(l){l&&(dt(l)?l.y=-l.y:N(l)?Ss(l.rings):z(l)?Ss(l.paths):Q(l)&&ci(l.points))}function ci(l){if(l){const t=l.length;for(let e=0;e<t;e++)l[e][1]=-l[e][1]}}function Ss(l){if(l)for(const t of l)ci(t)}function ui(l){if(l){const t=l.length;for(let e=t-1;e>0;--e)l[e][0]-=l[e-1][0],l[e][1]-=l[e-1][1]}}function ws(l){if(l)for(const t of l)ui(t)}function fi(l){if(l){const t=l.length;for(let e=1;e<t;++e)l[e][0]+=l[e-1][0],l[e][1]+=l[e-1][1]}}function Cs(l){if(l)for(const t of l)fi(t)}function bn(l){l&&(N(l)?Cs(l.rings):z(l)?Cs(l.paths):Q(l)&&fi(l.points),hi(l))}function Sn(l){l&&(hi(l),N(l)?ws(l.rings):z(l)?ws(l.paths):Q(l)&&ui(l.points))}function wn(l){if(l)for(const t of l)Cn(t)}function Cn(l){l&&l.reverse()}function rs(l,t,e){return[l[0]+(t[0]-l[0])*e,l[1]+(t[1]-l[1])*e]}function Be(l){return l[4]}function Vt(l,t){l[4]=t}class fe{constructor(t,e=!0,s=!0,i=0){this.isClosed=!1,this.geometryCursor=null,this.geometryCursor=!e&&t.geometryType==="esriGeometryPolygon"||!s&&t.geometryType==="esriGeometryPolyline"?null:t,this.geomUnitsPerPoint=i,this.iteratePath=!1,this.internalPlacement=new Qt}next(){if(!this.geometryCursor)return null;for(;this.iteratePath||this.geometryCursor.nextPath();){this.geometryCursor.seekPathFront();const t=this.processPath(this.geometryCursor);if(t)return t}return this.geometryCursor=null,null}}function In(l){return{rings:[[[l.xmin,l.ymin],[l.xmin,l.ymax],[l.xmax,l.ymax],[l.xmax,l.ymin],[l.xmin,l.ymin]]]}}class Oe{constructor(t,e,s,i=0){this.isClosed=!1,this.multiPath=null,this.inputGeometries=t,this.acceptPolygon=e,this.acceptPolyline=s,this.geomUnitsPerPoint=i,this.pathCount=-1,this.pathIndex=-1,this.iteratePath=!1}next(){for(;;){if(!this.multiPath){let t=this.inputGeometries.next();for(;t;){if(N(t)?this.acceptPolygon&&(this.multiPath=t.rings,this.isClosed=!0):z(t)?this.acceptPolyline&&(this.multiPath=t.paths,this.isClosed=!1):R(t)&&this.acceptPolygon&&(this.multiPath=In(t).rings,this.isClosed=!0),!this.multiPath){t=this.inputGeometries.next();continue}this.pathCount=this.multiPath.length,this.pathIndex=-1;break}if(!this.multiPath)return null}for(;this.iteratePath||this.pathIndex<this.pathCount-1;){this.iteratePath||this.pathIndex++;const t=this.processPath(this.multiPath[this.pathIndex]);if(t)return t}this.pathCount=-1,this.pathIndex=-1,this.multiPath=null}}}class bt{static local(){return bt.instance===null&&(bt.instance=new bt),bt.instance}execute(t,e,s,i,n){return new kn(t,e,s)}}bt.instance=null;class kn{constructor(t,e,s){this._inputGeometries=t,this._angleTolerance=e.angleTolerance!==void 0?e.angleTolerance:120,this._maxCosAngle=Math.cos((1-Math.abs(this._angleTolerance)/180)*Math.PI)}next(){let t=this._inputGeometries.next();for(;t;){if(N(t)){this._isClosed=!0;const e=G(t);return this._processMultipath(e.rings),e}if(z(t)){this._isClosed=!1;const e=G(t);return this._processMultipath(e.paths),e}if(R(t)){if(this._maxCosAngle)return t;this._isClosed=!0;const e=[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]];return this._processPath(e),{rings:[e]}}t=this._inputGeometries.next()}return null}_processMultipath(t){if(t)for(const e of t)this._processPath(e)}_processPath(t){if(t){let e=t.length,s=t[0],i,n,r,a,o,h;this._isClosed&&++e;for(let c=1;c<e;++c){let u;this._isClosed&&c===e-1?u=t[0]:u=t[c];const f=u[0]-s[0],_=u[1]-s[1],d=Math.sqrt(f*f+_*_);c>1&&d>0&&r>0&&(i*f+n*_)/d/r<=this._maxCosAngle&&Vt(s,1),c===1&&(a=f,o=_,h=d),d>0&&(s=u,i=f,n=_,r=d)}this._isClosed&&r>0&&h>0&&(i*a+n*o)/h/r<=this._maxCosAngle&&Vt(t[0],1)}}}const he=.03;class Zt{constructor(){this._path=[]}path(){return this._path}addPath(t,e){e||t.reverse(),Array.prototype.push.apply(this._path,t),e||t.reverse()}static mergePath(t,e){e&&Array.prototype.push.apply(t,e)}startPath(t){this._path.push(t)}lineTo(t){this._path.push(t)}close(){const t=this._path;t.length>1&&(t[0][0]!==t[t.length-1][0]||t[0][1]!==t[t.length-1][1])&&t.push([t[0][0],t[0][1]])}}class at{constructor(t=0,e=!1){}normalize(t){const e=Math.sqrt(t[0]*t[0]+t[1]*t[1]);e!==0&&(t[0]/=e,t[1]/=e)}calculateLength(t,e){const s=e[0]-t[0],i=e[1]-t[1];return Math.sqrt(s*s+i*i)}calculateSegLength(t,e){return this.calculateLength(t[e],t[e+1])}calculatePathLength(t){let e=0;const s=t?t.length:0;for(let i=0;i<s-1;++i)e+=this.calculateSegLength(t,i);return e}calculatePathArea(t){let e=0;const s=t?t.length:0;for(let i=0;i<s-1;++i)e+=(t[i+1][0]-t[i][0])*(t[i+1][1]+t[i][1]);return e/2}getCoord2D(t,e,s){return[t[0]+(e[0]-t[0])*s,t[1]+(e[1]-t[1])*s]}getSegCoord2D(t,e,s){return this.getCoord2D(t[e],t[e+1],s)}getAngle(t,e,s){const i=e[0]-t[0],n=e[1]-t[1];return Math.atan2(n,i)}getSegAngle(t,e,s){return this.getAngle(t[e],t[e+1],s)}getAngleCS(t,e,s){const i=e[0]-t[0],n=e[1]-t[1],r=Math.sqrt(i*i+n*n);return r>0?[i/r,n/r]:[1,0]}getSegAngleCS(t,e,s){return this.getAngleCS(t[e],t[e+1],s)}cut(t,e,s,i){const n=s<=0?t[e]:this.getSegCoord2D(t,e,s),r=i>=1?t[e+1]:this.getSegCoord2D(t,e,i);return[n,r]}addSegment(t,e,s){s&&t.push(e[0]),t.push(e[1])}getSubCurve(t,e,s){const i=[];return this.appendSubCurve(i,t,e,s)?i:null}appendSubCurve(t,e,s,i){const n=e?e.length-1:0;let r=0,a=!0,o=0;for(;o<n;){const h=this.calculateSegLength(e,o);if(h===0){++o;continue}if(a){if(r+h>s){const c=(s-r)/h;let u=1,f=!1;r+h>=i&&(u=(i-r)/h,f=!0);const _=this.cut(e,o,c,u);if(_&&this.addSegment(t,_,a),f)break;a=!1}}else{if(r+h>i){const c=this.cut(e,o,0,(i-r)/h);c&&this.addSegment(t,c,a);break}this.addSegment(t,[e[o],e[o+1]],a)}r+=h,++o}return!0}getCIMPointAlong(t,e){const s=t?t.length-1:0;let i=0,n=-1;for(;n<s;){++n;const r=this.calculateSegLength(t,n);if(r!==0){if(i+r>e){const a=(e-i)/r;return this.getCoord2D(t[n],t[n+1],a)}i+=r}}return null}isEmpty(t,e){if(!t||t.length<=1)return!0;const s=t?t.length-1:0;let i=-1;for(;i<s;)if(++i,t[i+1][0]!==t[i][0]||t[i+1][1]!==t[i][1]||e&&t[i+1][2]!==t[i][2])return!1;return!0}offset(t,e,s,i,n){if(!t||t.length<2)return null;let r=0,a=t[r++],o=r;for(;r<t.length;){const f=t[r];(f[0]!==a[0]||f[1]!==a[1])&&(r!==o&&(t[o]=t[r]),a=t[o++]),r++}const h=t[0][0]===t[o-1][0]&&t[0][1]===t[o-1][1];if(h&&--o,o<(h?3:2))return null;const c=[];a=h?t[o-1]:null;let u=t[0];for(let f=0;f<o;f++){const _=f===o-1?h?t[0]:null:t[f+1];if(a)if(_){const d=[_[0]-u[0],_[1]-u[1]];this.normalize(d);const p=[u[0]-a[0],u[1]-a[1]];this.normalize(p);const m=p[0]*d[1]-p[1]*d[0],g=p[0]*d[0]+p[1]*d[1];if(m===0&&g===1){u=_;continue}if(m>=0==e<=0){if(g<1){const y=[d[0]-p[0],d[1]-p[1]];this.normalize(y);const x=Math.sqrt((1+g)/2);if(x>1/i){const M=-Math.abs(e)/x;c.push([u[0]-y[0]*M,u[1]-y[1]*M])}}}else switch(s){case Pt.Mitered:{const y=Math.sqrt((1+g)/2);if(y>0&&1/y<i){const x=[d[0]-p[0],d[1]-p[1]];this.normalize(x);const M=Math.abs(e)/y;c.push([u[0]-x[0]*M,u[1]-x[1]*M]);break}}case Pt.Bevelled:c.push([u[0]+p[1]*e,u[1]-p[0]*e]),c.push([u[0]+d[1]*e,u[1]-d[0]*e]);break;case Pt.Rounded:{if(g<1){c.push([u[0]+p[1]*e,u[1]-p[0]*e]);const y=Math.floor(2.5*(1-g));if(y>0){const x=1/y;let M=x;for(let P=1;P<y;P++,M+=x){const b=[p[1]*(1-M)+d[1]*M,-p[0]*(1-M)-d[0]*M];this.normalize(b),c.push([u[0]+b[0]*e,u[1]+b[1]*e])}}c.push([u[0]+d[1]*e,u[1]-d[0]*e])}break}case Pt.Square:default:if(m<0)c.push([u[0]+(p[1]+p[0])*e,u[1]+(p[1]-p[0])*e]),c.push([u[0]+(d[1]-d[0])*e,u[1]-(d[0]+d[1])*e]);else{const y=Math.sqrt((1+Math.abs(g))/2),x=[d[0]-p[0],d[1]-p[1]];this.normalize(x);const M=e/y;c.push([u[0]-x[0]*M,u[1]-x[1]*M])}break}}else{const d=[u[0]-a[0],u[1]-a[1]];this.normalize(d),c.push([u[0]+d[1]*e,u[1]-d[0]*e])}else{const d=[_[0]-u[0],_[1]-u[1]];this.normalize(d),c.push([u[0]+d[1]*e,u[1]-d[0]*e])}a=u,u=_}return c.length<(h?3:2)?null:(h&&c.push([c[0][0],c[0][1]]),c)}}const We=1.7320508075688772,Ln=5,vn=ve.OpenEnded;class St{static local(){return St.instance===null&&(St.instance=new St),St.instance}execute(t,e,s,i,n){return new Tn(t,e,s)}}St.instance=null;class Tn extends Oe{constructor(t,e,s){super(t,!1,!0),this._curveHelper=new at,this._width=(e.width!==void 0?e.width:Ln)*s,this._arrowType=e.geometricEffectArrowType!==void 0?e.geometricEffectArrowType:e.arrowType!==void 0?e.arrowType:vn,this._offsetFlattenError=he*s}processPath(t){switch(this._arrowType){case ve.OpenEnded:default:return this._constructSimpleArrow(t,!0);case ve.Block:return this._constructSimpleArrow(t,!1);case ve.Crossed:return this._constructCrossedArrow(t)}}_constructSimpleArrow(t,e){const s=this._curveHelper.calculatePathLength(t);let i=this._width;s<2*i&&(i=s/2);const n=this._curveHelper.getSubCurve(t,0,s-i);if(!n)return null;const r=i/2;if(this._curveHelper.isEmpty(n,!1))return null;const a=this._constructOffset(n,-r);if(!a)return null;const o=this._constructOffset(n,r);if(!o)return null;const h=this._constructArrowBasePoint(a,-r/2);if(!h)return null;const c=this._constructArrowBasePoint(o,r/2);if(!c)return null;const u=t[t.length-1];e||(this._makeControlPoint(o,!0),this._makeControlPoint(a,!0));const f=new Zt;return f.addPath(o,!0),f.lineTo(c),this._makeControlPoint(f.path()),f.lineTo(u),this._makeControlPoint(f.path()),f.lineTo(h),this._makeControlPoint(f.path()),f.addPath(a,!1),e?{paths:[f.path()]}:(f.close(),{rings:[f.path()]})}_constructCrossedArrow(t){const e=this._curveHelper.calculatePathLength(t);let s=this._width;e<s*(1+We+1)&&(s=e/(1+We+1));const i=this._curveHelper.getSubCurve(t,0,e-s*(1+We));if(!i)return null;const n=s/2;if(this._curveHelper.isEmpty(i,!1))return null;const r=this._constructOffset(i,n);if(!r)return null;const a=this._constructOffset(i,-n);if(!a)return null;const o=this._curveHelper.getSubCurve(t,0,e-s);if(!o||this._curveHelper.isEmpty(o,!1))return null;const h=this._constructOffset(o,n);if(!h)return null;const c=this._constructOffset(o,-n);if(!c)return null;const u=h[h.length-1],f=this._constructArrowBasePoint(h,n/2);if(!f)return null;const _=c[c.length-1],d=this._constructArrowBasePoint(c,-n/2);if(!d)return null;const p=t[t.length-1];this._makeControlPoint(r,!1),this._makeControlPoint(a,!1);const m=new Zt;return m.addPath(r,!0),this._makeControlPoint(m.path()),m.lineTo(_),m.lineTo(d),this._makeControlPoint(m.path()),m.lineTo(p),this._makeControlPoint(m.path()),m.lineTo(f),this._makeControlPoint(m.path()),m.lineTo(u),this._makeControlPoint(m.path()),m.addPath(a,!1),{paths:[m.path()]}}_constructOffset(t,e){return this._curveHelper.offset(t,e,Pt.Rounded,4,this._offsetFlattenError)}_constructArrowBasePoint(t,e){if(!t||t.length<2)return null;const s=t[t.length-2],i=t[t.length-1],n=[i[0]-s[0],i[1]-s[1]];return this._curveHelper.normalize(n),[i[0]+n[1]*e,i[1]-n[0]*e]}_makeControlPoint(t,e=!1){Vt(e?t[0]:t[t.length-1],1)}}class wt{static local(){return wt.instance===null&&(wt.instance=new wt),wt.instance}execute(t,e,s,i,n){return new An(t,e,s,i,n)}}wt.instance=null;class An{constructor(t,e,s,i,n){this._inputGeometries=t,this._tileKey=i,this._geometryEngine=n,this._curveHelper=new at,this._size=(e.size!==void 0?e.size:1)*s,this._offsetFlattenError=he*s}next(){let t;for(;t=this._inputGeometries.next();){if(this._size===0)return t;if(R(t)){if(this._size>0){const i=[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]],n=this._curveHelper.offset(i,this._size,Pt.Rounded,4,this._offsetFlattenError);if(n)return{rings:[n]}}else if(this._size<0&&Math.min(t.xmax-t.xmin,t.ymax-t.ymin)+this._size*2>0)return{xmin:t.xmin-this._size,xmax:t.xmax+this._size,ymin:t.ymin-this._size,ymax:t.ymax+this._size}}const e=this._geometryEngine;if(e==null)return null;let s=t;if(!(N(t)&&this._tileKey&&(s=fs(t,Math.abs(this._size)+1),!s||!s.rings||s.rings.length===0))&&!(z(t)&&this._tileKey&&(s=li(t,Math.abs(this._size)+1),!s||!s.paths||s.paths.length===0)))return e.buffer(hs.WebMercator,s,this._size,1)}return null}}class Ct{static local(){return Ct.instance===null&&(Ct.instance=new Ct),Ct.instance}execute(t,e,s,i,n){return new En(t,e,s)}}Ct.instance=null;class En{constructor(t,e,s){this._defaultPointSize=20,this._inputGeometries=t,this._geomUnitsPerPoint=s,this._rule=e.rule??v.FullGeometry,this._defaultSize=this._defaultPointSize*s}next(){let t;for(;t=this._inputGeometries.next();){let e;if(dt(t)?e=this._processGeom([[[t.x,t.y]]]):Q(t)?e=this._processGeom([t.points]):z(t)?e=this._processGeom(t.paths):N(t)&&(e=this._processGeom(t.rings)),e&&e.length)return{paths:e}}return null}_clone(t){return[t[0],t[1]]}_mid(t,e){return[(t[0]+e[0])/2,(t[1]+e[1])/2]}_mix(t,e,s,i){return[t[0]*e+s[0]*i,t[1]*e+s[1]*i]}_add(t,e){return[t[0]+e[0],t[1]+e[1]]}_add2(t,e,s){return[t[0]+e,t[1]+s]}_sub(t,e){return[t[0]-e[0],t[1]-e[1]]}_dist(t,e){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1]))}_norm(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])}_normalize(t,e=1){const s=e/this._norm(t);t[0]*=s,t[1]*=s}_leftPerpendicular(t){const e=-t[1],s=t[0];t[0]=e,t[1]=s}_leftPerp(t){return[-t[1],t[0]]}_rightPerpendicular(t){const e=t[1],s=-t[0];t[0]=e,t[1]=s}_rightPerp(t){return[t[1],-t[0]]}_dotProduct(t,e){return t[0]*e[0]+t[1]*e[1]}_crossProduct(t,e){return t[0]*e[1]-t[1]*e[0]}_rotateDirect(t,e,s){const i=t[0]*e-t[1]*s,n=t[0]*s+t[1]*e;t[0]=i,t[1]=n}_makeCtrlPt(t){const e=[t[0],t[1]];return Vt(e,1),e}_addAngledTicks(t,e,s,i){const n=this._sub(s,e);this._normalize(n);const r=this._crossProduct(n,this._sub(i,e));let a;r>0?a=this._rightPerp(n):a=this._leftPerp(n);const o=Math.abs(r)/2,h=[];h.push([e[0]+(a[0]-n[0])*o,e[1]+(a[1]-n[1])*o]),h.push(e),h.push(s),h.push([s[0]+(a[0]+n[0])*o,s[1]+(a[1]+n[1])*o]),t.push(h)}_addBezier2(t,e,s,i,n){if(n--===0){t.push(i);return}const r=this._mid(e,s),a=this._mid(s,i),o=this._mid(r,a);this._addBezier2(t,e,r,o,n),this._addBezier2(t,o,a,i,n)}_addBezier3(t,e,s,i,n,r){if(r--===0){t.push(n);return}const a=this._mid(e,s),o=this._mid(s,i),h=this._mid(i,n),c=this._mid(a,o),u=this._mid(o,h),f=this._mid(c,u);this._addBezier3(t,e,a,c,f,r),this._addBezier3(t,f,u,h,n,r)}_add90DegArc(t,e,s,i,n){const r=n??this._crossProduct(this._sub(s,e),this._sub(i,e))>0,a=this._mid(e,s),o=this._sub(a,e);r?this._leftPerpendicular(o):this._rightPerpendicular(o),a[0]+=o[0],a[1]+=o[1],this._addBezier3(t,e,this._mix(e,.33333,a,.66667),this._mix(s,.33333,a,.66667),s,4)}_addArrow(t,e,s){const i=e[0],n=e[1],r=e[e.length-1],a=this._sub(i,n);this._normalize(a);const o=this._crossProduct(a,this._sub(r,n)),h=o*.5,c=this._leftPerp(a),u=[r[0]-c[0]*o,r[1]-c[1]*o],f=e.length-1,_=[];_.push(s?[-c[0],-c[1]]:c);let d=[-a[0],-a[1]];for(let p=1;p<f-1;p++){const m=this._sub(e[p+1],e[p]);this._normalize(m);const g=this._dotProduct(m,d),y=this._crossProduct(m,d),x=Math.sqrt((1+g)/2),M=this._sub(m,d);this._normalize(M),M[0]/=x,M[1]/=x,_.push(y<0?[-M[0],-M[1]]:M),d=m}_.push(this._rightPerp(d));for(let p=_.length-1;p>0;p--)t.push([e[p][0]+_[p][0]*h,e[p][1]+_[p][1]*h]);t.push([u[0]+_[0][0]*h,u[1]+_[0][1]*h]),t.push([u[0]+_[0][0]*o,u[1]+_[0][1]*o]),t.push(i),t.push([u[0]-_[0][0]*o,u[1]-_[0][1]*o]),t.push([u[0]-_[0][0]*h,u[1]-_[0][1]*h]);for(let p=1;p<_.length;p++)t.push([e[p][0]-_[p][0]*h,e[p][1]-_[p][1]*h])}_cp2(t,e,s){return t.length>=2?t[1]:this._add2(t[0],e*this._defaultSize,s*this._defaultSize)}_cp3(t,e,s,i){if(t.length>=3)return t[2];const n=this._mix(t[0],1-s,e,s),r=this._sub(e,t[0]);return this._normalize(r),this._rightPerpendicular(r),[n[0]+r[0]*i*this._defaultSize,n[1]+r[1]*i*this._defaultSize]}_arrowPath(t){if(t.length>2)return t;const e=t[0],s=this._cp2(t,-4,0),i=this._sub(e,s);this._normalize(i);const n=this._rightPerp(i),r=[e[0]+(n[0]-i[0])*this._defaultSize,e[1]+(n[1]-i[1])*this._defaultSize];return[e,s,r]}_arrowLastSeg(t){const e=t[0],s=this._cp2(t,-4,0);let i;if(t.length>=3)i=t[t.length-1];else{const n=this._sub(e,s);this._normalize(n);const r=this._rightPerp(n);i=[e[0]+(r[0]-n[0])*this._defaultSize,e[1]+(r[1]-n[1])*this._defaultSize]}return[s,i]}_processGeom(t){if(!t)return null;const e=[];for(const s of t){if(!s||s.length===0)continue;const i=s.length;let n=s[0];switch(this._rule){case v.PerpendicularFromFirstSegment:{const r=this._cp2(s,0,-1),a=this._cp3(s,r,.5,4),o=[];o.push(a),o.push(this._mid(n,r)),e.push(o);break}case v.ReversedFirstSegment:{const r=this._cp2(s,0,-1);e.push([r,n]);break}case v.PerpendicularToSecondSegment:{const r=this._cp2(s,-4,1),a=this._cp3(s,r,.882353,-1.94),o=[];o.push(this._mid(r,a)),o.push(n),e.push(o);break}case v.SecondSegmentWithTicks:{const r=this._cp2(s,-4,1),a=this._cp3(s,r,.882353,-1.94),o=this._sub(a,r);let h;this._crossProduct(o,this._sub(n,r))>0?h=this._rightPerp(h):h=this._leftPerp(o);const c=[];c.push([r[0]+(h[0]-o[0])/3,r[1]+(h[1]-o[1])/3]),c.push(r),c.push(a),c.push([a[0]+(h[0]+o[0])/3,a[1]+(h[1]+o[1])/3]),e.push(c);break}case v.DoublePerpendicular:{const r=this._cp2(s,0,-1),a=this._cp3(s,r,.5,3),o=this._mid(n,r),h=this._sub(o,a);this._normalize(h);const c=this._crossProduct(h,this._sub(n,a));this._leftPerpendicular(h);const u=[];u.push(n),u.push([a[0]+h[0]*c,a[1]+h[1]*c]),e.push(u);const f=[];f.push([a[0]-h[0]*c,a[1]-h[1]*c]),f.push(r),e.push(f);break}case v.OppositeToFirstSegment:{const r=this._cp2(s,0,-1),a=this._cp3(s,r,.5,3),o=this._mid(n,r),h=this._sub(o,a);this._normalize(h);const c=this._crossProduct(h,this._sub(n,a));this._leftPerpendicular(h);const u=[];u.push([a[0]+h[0]*c,a[1]+h[1]*c]),u.push([a[0]-h[0]*c,a[1]-h[1]*c]),e.push(u);break}case v.TriplePerpendicular:{const r=this._cp2(s,0,-1),a=this._cp3(s,r,.5,4),o=this._mid(n,r),h=this._sub(o,a);this._normalize(h);const c=this._crossProduct(h,this._sub(n,a));this._leftPerpendicular(h);const u=[];u.push([a[0]+h[0]*c*.8,a[1]+h[1]*c*.8]),u.push([o[0]+(n[0]-o[0])*.8,o[1]+(n[1]-o[1])*.8]),e.push(u),e.push([a,o]);const f=[];f.push([a[0]-h[0]*c*.8,a[1]-h[1]*c*.8]),f.push([o[0]+(r[0]-o[0])*.8,o[1]+(r[1]-o[1])*.8]),e.push(f);break}case v.HalfCircleFirstSegment:{const r=this._cp2(s,0,-1),a=this._cp3(s,r,.5,4),o=this._mid(n,r);let h=this._sub(r,n);const c=Math.cos(Math.PI/18),u=Math.sin(Math.PI/18),f=Math.sqrt((1+c)/2),_=Math.sqrt((1-c)/2),d=[];let p;this._crossProduct(h,this._sub(a,n))>0?(d.push(n),h=this._sub(n,o),p=r):(d.push(r),h=this._sub(r,o),p=n),this._rotateDirect(h,f,_),h[0]/=f,h[1]/=f;for(let m=1;m<=18;m++)d.push(this._add(o,h)),this._rotateDirect(h,c,u);d.push(p),e.push(d);break}case v.HalfCircleSecondSegment:{const r=this._cp2(s,0,-1),a=this._cp3(s,r,1,-1);let o=this._sub(n,r);this._normalize(o);const h=this._crossProduct(o,this._sub(a,r))/2;this._leftPerpendicular(o);const c=[r[0]+o[0]*h,r[1]+o[1]*h];o=this._sub(r,c);const u=Math.cos(Math.PI/18);let f=Math.sin(Math.PI/18);h>0&&(f=-f);const _=[r];for(let d=1;d<=18;d++)this._rotateDirect(o,u,f),_.push(this._add(c,o));e.push(_);break}case v.HalfCircleExtended:{const r=this._cp2(s,0,-2),a=this._cp3(s,r,1,-1);let o;if(i>=4)o=s[3];else{const d=this._sub(n,r);o=this._add(a,d)}const h=this._dist(r,a)/2/.75,c=this._sub(r,n);this._normalize(c,h);const u=this._sub(a,o);this._normalize(u,h);const f=[o,a];e.push(f);const _=[this._clone(a)];this._addBezier3(_,a,this._add(a,u),this._add(r,c),r,4),_.push(n),e.push(_);break}case v.OpenCircle:{const r=this._cp2(s,-2,0),a=this._sub(r,n),o=Math.cos(Math.PI/18),h=-Math.sin(Math.PI/18),c=[r];for(let u=1;u<=33;u++)this._rotateDirect(a,o,h),c.push(this._add(n,a));e.push(c);break}case v.CoverageEdgesWithTicks:{const r=this._cp2(s,0,-1);let a;if(i>=3)a=s[2];else{const f=this._sub(r,n),_=this._leftPerp(f);a=[n[0]+_[0]-f[0]*.25,n[1]+_[1]-f[1]*.25]}let o;if(i>=4)o=s[3];else{const f=this._mid(n,r),_=this._sub(n,r);this._normalize(_),this._leftPerpendicular(_);const d=this._crossProduct(_,this._sub(a,f));this._rightPerpendicular(_),o=[a[0]+_[0]*d*2,a[1]+_[1]*d*2]}const h=this._sub(r,n);let c,u;this._crossProduct(h,this._sub(a,n))>0?c=this._rightPerp(h):c=this._leftPerp(h),u=[],u.push(a),u.push(n),u.push([n[0]+(c[0]-h[0])/3,n[1]+(c[1]-h[1])/3]),e.push(u),this._crossProduct(h,this._sub(o,r))>0?c=this._rightPerp(c):c=this._leftPerp(h),u=[],u.push([r[0]+(c[0]+h[0])/3,r[1]+(c[1]+h[1])/3]),u.push(r),u.push(o),e.push(u);break}case v.GapExtentWithDoubleTicks:{const r=this._cp2(s,0,2),a=this._cp3(s,r,0,1);let o;if(i>=4)o=s[3];else{const h=this._sub(r,n);o=this._add(a,h)}this._addAngledTicks(e,n,r,this._mid(a,o)),this._addAngledTicks(e,a,o,this._mid(n,r));break}case v.GapExtentMidline:{const r=this._cp2(s,2,0),a=this._cp3(s,r,0,1);let o;if(i>=4)o=s[3];else{const c=this._sub(r,n);o=this._add(a,c)}const h=[];h.push(this._mid(n,a)),h.push(this._mid(r,o)),e.push(h);break}case v.Chevron:{const r=this._cp2(s,-1,-1);let a;if(i>=3)a=s[2];else{const o=this._sub(r,n);this._leftPerpendicular(o),a=this._add(n,o)}e.push([r,this._makeCtrlPt(n),a]);break}case v.PerpendicularWithArc:{const r=this._cp2(s,0,-2),a=this._cp3(s,r,.5,-1);let o=this._sub(r,n);const h=this._norm(o);o[0]/=h,o[1]/=h;const c=this._crossProduct(o,this._sub(a,n));let u=this._dotProduct(o,this._sub(a,n));u<h*.05?u=h*.05:u>h*.95&&(u=h*.95);const f=[n[0]+o[0]*u,n[1]+o[1]*u];this._leftPerpendicular(o);let _=[];_.push([f[0]-o[0]*c,f[1]-o[1]*c]),_.push([f[0]+o[0]*c,f[1]+o[1]*c]),e.push(_);const d=[r[0]+o[0]*c,r[1]+o[1]*c];o=this._sub(r,d);const p=Math.cos(Math.PI/18);let m=Math.sin(Math.PI/18);c<0&&(m=-m),_=[n,r];for(let g=1;g<=9;g++)this._rotateDirect(o,p,m),_.push(this._add(d,o));e.push(_);break}case v.ClosedHalfCircle:{const r=this._cp2(s,2,0),a=this._mid(n,r),o=this._sub(r,a),h=Math.cos(Math.PI/18),c=Math.sin(Math.PI/18),u=[n,r];for(let f=1;f<=18;f++)this._rotateDirect(o,h,c),u.push(this._add(a,o));e.push(u);break}case v.TripleParallelExtended:{const r=this._cp2(s,0,-2),a=this._cp3(s,r,1,-2),o=this._mid(n,r),h=this._sub(a,r);this._normalize(h);const c=Math.abs(this._crossProduct(h,this._sub(o,r)))/2,u=this._dist(r,a),f=[r,n];f.push([n[0]+h[0]*u*.5,n[1]+h[1]*u*.5]),e.push(f);const _=[];_.push([o[0]-h[0]*c,o[1]-h[1]*c]),_.push([o[0]+h[0]*u*.375,o[1]+h[1]*u*.375]),Vt(_[_.length-1],1),_.push([o[0]+h[0]*u*.75,o[1]+h[1]*u*.75]),e.push(_);const d=[r,a];e.push(d);break}case v.ParallelWithTicks:{const r=this._cp2(s,3,0),a=this._cp3(s,r,.5,-1),o=this._sub(a,r);this._normalize(o);const h=this._crossProduct(o,this._sub(a,n));this._leftPerpendicular(o),this._addAngledTicks(e,n,r,a),this._addAngledTicks(e,this._mix(n,1,o,h),this._mix(r,1,o,h),this._mid(n,r));break}case v.Parallel:{const r=this._cp2(s,3,0),a=this._cp3(s,r,.5,-1),o=this._sub(r,n);this._normalize(o);const h=this._leftPerp(o),c=this._crossProduct(o,this._sub(a,n));let u=[n,r];e.push(u),u=[],u.push([n[0]+h[0]*c,n[1]+h[1]*c]),u.push([r[0]+h[0]*c,r[1]+h[1]*c]),e.push(u);break}case v.PerpendicularToFirstSegment:{const r=this._cp2(s,3,0),a=this._cp3(s,r,.5,-1),o=this._mid(n,r),h=this._sub(r,n);this._normalize(h);const c=this._crossProduct(h,this._sub(a,n));this._leftPerpendicular(h);const u=[];u.push([o[0]-h[0]*c*.25,o[1]-h[1]*c*.25]),u.push([o[0]+h[0]*c*1.25,o[1]+h[1]*c*1.25]),e.push(u);break}case v.ParallelOffset:{const r=this._cp2(s,3,0),a=this._cp3(s,r,.5,-1),o=this._sub(r,n);this._normalize(o);const h=this._crossProduct(o,this._sub(a,n));this._leftPerpendicular(o);const c=[];c.push([n[0]-o[0]*h,n[1]-o[1]*h]),c.push([r[0]-o[0]*h,r[1]-o[1]*h]),e.push(c);const u=[];u.push([n[0]+o[0]*h,n[1]+o[1]*h]),u.push([r[0]+o[0]*h,r[1]+o[1]*h]),e.push(u);break}case v.OffsetOpposite:{const r=this._cp2(s,3,0),a=this._cp3(s,r,.5,-1),o=this._sub(r,n);this._normalize(o);const h=this._crossProduct(o,this._sub(a,n));this._leftPerpendicular(o);const c=[];c.push([n[0]-o[0]*h,n[1]-o[1]*h]),c.push([r[0]-o[0]*h,r[1]-o[1]*h]),e.push(c);break}case v.OffsetSame:{const r=this._cp2(s,3,0),a=this._cp3(s,r,.5,-1),o=this._sub(r,n);this._normalize(o);const h=this._crossProduct(o,this._sub(a,n));this._leftPerpendicular(o);const c=[];c.push([n[0]+o[0]*h,n[1]+o[1]*h]),c.push([r[0]+o[0]*h,r[1]+o[1]*h]),e.push(c);break}case v.CircleWithArc:{let r=this._cp2(s,3,0);const a=this._cp3(s,r,.5,-1);let o,h;if(i>=4)o=s[3],h=this._crossProduct(this._sub(o,r),this._sub(a,r))>0;else{o=r,h=this._crossProduct(this._sub(o,n),this._sub(a,n))>0;const d=24*this._geomUnitsPerPoint,p=this._sub(o,n);this._normalize(p,d);const m=Math.sqrt(2)/2;this._rotateDirect(p,m,h?m:-m),r=this._add(n,p)}const c=this._sub(r,n),u=Math.cos(Math.PI/18),f=Math.sin(Math.PI/18),_=[r];for(let d=1;d<=36;d++)this._rotateDirect(c,u,f),_.push(this._add(n,c));this._add90DegArc(_,r,o,a,h),Vt(_[_.length-8],1),e.push(_);break}case v.DoubleJog:{let r=this._cp2(s,-3,1),a;i>=3?a=s[2]:a=this._add(n,this._sub(n,r));let o;if(i>=4)o=s[3];else{const g=n;n=r,o=a;const y=this._dist(n,g),x=this._dist(o,g);let M=30*this._geomUnitsPerPoint;y*.5<M&&(M=y*.5),x*.5<M&&(M=x*.5),r=this._mix(n,M/y,g,(y-M)/y),a=this._mix(o,M/x,g,(x-M)/x)}const h=this._mid(n,r),c=this._mid(o,a),u=this._dist(n,r),f=this._dist(a,o);let _=Math.min(u,f)/8;_=Math.min(_,24*this._geomUnitsPerPoint);const d=Math.cos(Math.PI/4);let p=this._sub(n,r);this._normalize(p,_),this._crossProduct(p,this._sub(o,r))>0?this._rotateDirect(p,d,-d):this._rotateDirect(p,d,d);let m=[];m.push(r),m.push(this._add(h,p)),m.push(this._sub(h,p)),m.push(n),e.push(m),p=this._sub(o,a),this._normalize(p,_),this._crossProduct(p,this._sub(n,a))<0?this._rotateDirect(p,d,d):this._rotateDirect(p,d,-d),m=[],m.push(a),m.push(this._add(c,p)),m.push(this._sub(c,p)),m.push(o),e.push(m);break}case v.PerpendicularOffset:{const r=this._cp2(s,-4,1),a=this._cp3(s,r,.882353,-1.94),o=this._sub(a,r);this._crossProduct(o,this._sub(n,r))>0?this._rightPerpendicular(o):this._leftPerpendicular(o);const h=[o[0]/8,o[1]/8],c=this._sub(this._mid(r,a),h);e.push([c,n]);break}case v.LineExcludingLastSegment:{const r=this._arrowPath(s),a=[];let o=r.length-2;for(;o--;)a.push(r[o]);e.push(a);break}case v.MultivertexArrow:{const r=this._arrowPath(s),a=[];this._addArrow(a,r,!1),e.push(a);break}case v.CrossedArrow:{const r=this._arrowPath(s),a=[];this._addArrow(a,r,!0),e.push(a);break}case v.ChevronArrow:{const[r,a]=this._arrowLastSeg(s),o=10*this._geomUnitsPerPoint,h=this._sub(n,r);this._normalize(h);const c=this._crossProduct(h,this._sub(a,r)),u=this._leftPerp(h),f=[a[0]-u[0]*c*2,a[1]-u[1]*c*2],_=[];_.push([a[0]+h[0]*o,a[1]+h[1]*o]),_.push(n),_.push([f[0]+h[0]*o,f[1]+h[1]*o]),e.push(_);break}case v.ChevronArrowOffset:{const[r,a]=this._arrowLastSeg(s),o=this._sub(n,r);this._normalize(o);const h=this._crossProduct(o,this._sub(a,r));this._leftPerpendicular(o);const c=[a[0]-o[0]*h,a[1]-o[1]*h],u=[];u.push([c[0]+o[0]*h*.5,c[1]+o[1]*h*.5]),u.push(this._mid(c,n)),u.push([c[0]-o[0]*h*.5,c[1]-o[1]*h*.5]),e.push(u);break}case v.PartialFirstSegment:{const[r,a]=this._arrowLastSeg(s),o=this._sub(n,r);this._normalize(o);const h=this._crossProduct(o,this._sub(a,r));this._leftPerpendicular(o);const c=[a[0]-o[0]*h,a[1]-o[1]*h];e.push([r,c]);break}case v.Arch:{const r=this._cp2(s,0,-1),a=this._cp3(s,r,.5,1),o=this._sub(n,r),h=this._mix(a,1,o,.55),c=this._mix(a,1,o,-.55),u=[n];this._addBezier2(u,n,h,a,4),this._addBezier2(u,a,c,r,4),e.push(u);break}case v.CurvedParallelTicks:{const r=this._cp2(s,-4,1),a=this._cp3(s,r,.882353,-1.94),o=this._sub(a,r);this._crossProduct(o,this._sub(n,r))>0?this._rightPerpendicular(o):this._leftPerpendicular(o);const h=[o[0]/8,o[1]/8],c=this._sub(this._mid(r,a),h),u=this._sub(this._mix(r,.75,a,.25),h),f=this._sub(this._mix(r,.25,a,.75),h),_=[r];this._addBezier2(_,r,u,c,3),this._addBezier2(_,c,f,a,3),e.push(_);for(let d=0;d<8;d++){const p=_[d*2+1],m=[this._clone(p)];m.push(this._add(p,[o[0]/4,o[1]/4])),e.push(m)}break}case v.Arc90Degrees:{const r=this._cp2(s,0,-1),a=this._cp3(s,r,.5,1),o=[r];this._add90DegArc(o,r,n,a),e.push(o);break}case v.FullGeometry:default:e.push(s);break}}return e}}class It{static local(){return It.instance===null&&(It.instance=new It),It.instance}execute(t,e,s,i,n){return new Nn(t,e,s)}}It.instance=null;class Nn extends Oe{constructor(t,e,s){super(t,!0,!0),this._curveHelper=new at,this._beginCut=(e.beginCut!==void 0?e.beginCut:1)*s,this._endCut=(e.endCut!==void 0?e.endCut:1)*s,this._middleCut=(e.middleCut!==void 0?e.middleCut:0)*s,this._invert=e.invert!==void 0?e.invert:!1,this._beginCut<0&&(this._beginCut=0),this._endCut<0&&(this._endCut=0),this._middleCut<0&&(this._middleCut=0)}processPath(t){const e=this._beginCut,s=this._endCut,i=this._middleCut,n=this._curveHelper.calculatePathLength(t),r=[];if(this._invert){if(!(e===0&&s===0&&i===0))if(e+s+i>=n)r.push(t);else{let a=this._curveHelper.getSubCurve(t,0,e);a&&r.push(a),a=this._curveHelper.getSubCurve(t,(n-i)*.5,(n+i)*.5),a&&r.push(a),a=this._curveHelper.getSubCurve(t,n-s,s),a&&r.push(a)}}else if(e===0&&s===0&&i===0)r.push(t);else if(!(e+s+i>=n))if(i===0){const a=this._curveHelper.getSubCurve(t,e,n-s);a&&r.push(a)}else{let a=this._curveHelper.getSubCurve(t,e,(n-i)*.5);a&&r.push(a),a=this._curveHelper.getSubCurve(t,(n+i)*.5,n-s),a&&r.push(a)}return r.length===0?null:{paths:r}}}const Is=1e-7;class Fe{constructor(){this._values=[],this.extPtGap=0,this.ctrlPtGap=0,this._length=0,this._currentValue=0}isEmpty(){return this._values.length===0}size(){return this._values.length}init(t,e,s=!0){if(this._setEmpty(),!t||t.length===0)return!1;for(let i=0;i<t.length;i++){let n=Math.abs(t[i]);s&&n<Is&&(n=Is),this._values.push(n),this._length+=n}return e&&t.length&1&&(this._length*=2),this._length===0?!1:(this.ctrlPtGap=this.extPtGap=0,this._currentValue=-1,!0)}scale(t){const e=this._values?this._values.length:0;for(let s=0;s<e;++s)this._values[s]*=t;this._length*=t,this.extPtGap*=t,this.ctrlPtGap*=t}addValue(t){this._length+=t,this._values.push(t)}firstValue(){return this._values[0]}lastValue(){return this._values[this._values.length-1]}nextValue(){return this._currentValue++,this._currentValue===this._values.length&&(this._currentValue=0),this._values[this._currentValue]}reset(){this._currentValue=-1}length(){return this._length}_setEmpty(){this.extPtGap=this.ctrlPtGap=this._length=0,this._currentValue=-1,this._values.length=0}}class nt{constructor(){this.pt=null,this.ca=0,this.sa=0}}var ut;(function(l){l[l.FAIL=0]="FAIL",l[l.END=1]="END",l[l.CONTINUE=2]="CONTINUE"})(ut||(ut={}));class we{constructor(){this.reset()}reset(){this.segment=-1,this.segmentLength=0,this.abscissa=0,this.isPathEnd=!1,this.isPartEnd=!1}isValid(){return this.segment!==-1}copyTo(t){t.segment=this.segment,t.segmentLength=this.segmentLength,t.abscissa=this.abscissa,t.isPathEnd=this.isPathEnd,t.isPartEnd=this.isPartEnd}}class Ge extends at{constructor(t=0,e=!1){super(t,e),this._tolerance=he,this._currentPosition=new we}updateTolerance(t){this._tolerance=he*t}init(t,e,s=!0){return s?(this._patternLength=e.length(),this._partExtPtGap=e.extPtGap,this._partCtrlPtGap=e.ctrlPtGap):(this._patternLength=0,this._partExtPtGap=0,this._partCtrlPtGap=0),this._currentPosition.reset(),this._partSegCount=0,this._path=t,this._seg=-1,this._setPosAtNextPart()}curPositionIsValid(){return this._currentPosition.isValid()}nextPosition(t,e=ut.FAIL){const s=new we;return this._nextPosition(t,s,null,e)?(s.copyTo(this._currentPosition),!0):!1}curPointAndAngle(t){t.pt=this._getPoint(this._currentPosition);const[e,s]=this._getAngle(this._currentPosition);t.ca=e,t.sa=s}nextPointAndAngle(t,e,s=ut.FAIL){const i=new we;if(!this._nextPosition(t,i,null,s))return!1;i.copyTo(this._currentPosition),e.pt=this._getPoint(i);const[n,r]=this._getAngle(i);return e.ca=n,e.sa=r,!0}nextCurve(t){if(t===0)return null;const e=[],s=new we;return this._nextPosition(t,s,e,ut.END)?(s.copyTo(this._currentPosition),e):null}isPathEnd(){return this._currentPosition.isPathEnd}getPathEnd(){if(this._currentPosition.segment===-1)throw new Error("missing segment");return this._path[this._currentPosition.segment+1]}_nextPosition(t,e,s,i){if(this._currentPosition.isPathEnd)return!1;let n=this._currentPosition.abscissa;for(this._currentPosition.segmentLength>0&&(n/=this._currentPosition.segmentLength),this._currentPosition.copyTo(e);e.abscissa+t*this._partLengthRatio>e.segmentLength+this._tolerance;){if(s){if(s.length===0)if(n===0){const a=this._path[e.segment];s.push([a[0],a[1]])}else s.push(this.getSegCoord2D(this._path,e.segment,n));const r=this._path[e.segment+1];s.push([r[0],r[1]])}if(n=0,t-=(e.segmentLength-e.abscissa)/this._partLengthRatio,this._partSegCount)e.segment=this._nextSegment(),e.segmentLength=this.calculateSegLength(this._path,e.segment),e.abscissa=0,this._partSegCount--;else{if(!this._setPosAtNextPart())return i===ut.FAIL?!1:(e.segmentLength=this.calculateSegLength(this._path,e.segment),e.isPartEnd=!0,i===ut.END?(e.abscissa=e.segmentLength,e.isPathEnd=!0):e.abscissa=e.segmentLength+t,!0);this._currentPosition.copyTo(e)}}if(e.abscissa+=t*this._partLengthRatio,s){if(s.length===0)if(n===0){const a=this._path[e.segment];s.push([a[0],a[1]])}else s.push(this.getSegCoord2D(this._path,e.segment,n));const r=e.abscissa/e.segmentLength;if(r===1){const a=this._path[e.segment+1];s.push([a[0],a[1]])}else s.push(this.getSegCoord2D(this._path,e.segment,r))}return this._partSegCount||Math.abs(e.abscissa-e.segmentLength)<this._tolerance&&(e.isPathEnd=this._partIsLast,e.isPartEnd=!0),!0}_getPoint(t){if(t.segment===-1)throw new Error("missing segment");const e=t.segmentLength<=0?0:t.abscissa/t.segmentLength;return this.getSegCoord2D(this._path,t.segment,e)}_getAngle(t){if(t.segment===-1)throw new Error("missing segment");const e=t.segmentLength<=0?0:t.abscissa/t.segmentLength;return this.getSegAngleCS(this._path,t.segment,e)}_setPosAtNextPart(){for(;this._partSegCount;)this._hasNextSegment()&&this._nextSegment(),this._partSegCount--;if(!this._hasNextSegment())return!1;for(this._partLength=0,this._partIsLast=!0,this._partSegCount=0;this._hasNextSegment();)if(this._partLength+=this.calculateSegLength(this._path,this._nextSegment()),this._partSegCount++,Be(this._path[this._getEndPointIndex()])===1){this._partIsLast=!this._hasNextSegment();break}let t=this._partSegCount;for(;t;)this._previousSegment(),--t;this._currentPosition.segment=this._nextSegment(),this._currentPosition.segmentLength=this.calculateSegLength(this._path,this._currentPosition.segment),this._currentPosition.abscissa=0,this._currentPosition.isPathEnd=this._currentPosition.isPartEnd=!1,--this._partSegCount;const e=this._getStartPointIndex();this._ctrlPtBegin=Be(this._path[e])===1;let s=e+this._partSegCount+1;if(s>=this._path.length&&(s=0),this._ctrlPtEnd=Be(this._path[s])===1,this._patternLength>0){const i=this._ctrlPtBegin?this._partCtrlPtGap:this._partExtPtGap,n=this._ctrlPtEnd?this._partCtrlPtGap:this._partExtPtGap;let r=Math.round((this._partLength-(i+n))/this._patternLength);r<=0&&(i+n>0?r=0:r=1),this._partLengthRatio=this._partLength/(i+n+r*this._patternLength),this._partLengthRatio<.01&&(this._partLengthRatio=1)}else this._partLengthRatio=1;return!0}_hasNextSegment(){return this._seg<this._path.length-2}_previousSegment(){return--this._seg}_nextSegment(){return++this._seg}_getStartPointIndex(){return this._seg}_getEndPointIndex(){return this._seg+1}}class kt{static local(){return kt.instance===null&&(kt.instance=new kt),kt.instance}execute(t,e,s,i,n){return new zn(t,e,s)}}kt.instance=null;class zn extends Oe{constructor(t,e,s){super(t,!0,!0),this._firstCurve=null,this._walker=new Ge,this._walker.updateTolerance(s),this._endings=e.lineDashEnding,this._customDashPos=-(e.offsetAlongLine??0)*s,this._offsetAtEnd=(e.customEndingOffset??0)*s,this._pattern=new Fe,this._pattern.init(e.dashTemplate,!0),this._pattern.scale(s)}processPath(t){if(this._pattern.length()===0)return this.iteratePath=!1,{paths:[t]};if(!this.iteratePath){let i=!0;switch(this._endings){case $.HalfPattern:case $.HalfGap:default:this._pattern.extPtGap=0;break;case $.FullPattern:this.isClosed||(this._pattern.extPtGap=this._pattern.firstValue()*.5);break;case $.FullGap:this.isClosed||(this._pattern.extPtGap=this._pattern.lastValue()*.5);break;case $.NoConstraint:this.isClosed||(i=!1);break;case $.Custom:this.isClosed||(this._pattern.extPtGap=this._offsetAtEnd*.5);break}const n=this._walker.calculatePathLength(t);if(this._pattern.isEmpty()||n<.1*this._pattern.length())return{paths:[t]};if(!this._walker.init(t,this._pattern,i))return{paths:[t]}}let e;if(this.iteratePath)e=this._pattern.nextValue();else{let i;switch(this._endings){case $.HalfPattern:default:i=this._pattern.firstValue()*.5;break;case $.HalfGap:i=-this._pattern.lastValue()*.5;break;case $.FullGap:i=-this._pattern.lastValue();break;case $.FullPattern:i=0;break;case $.NoConstraint:case $.Custom:i=-this._customDashPos;break}let n=i/this._pattern.length();n-=Math.floor(n),i=n*this._pattern.length(),this._pattern.reset(),e=this._pattern.nextValue();let r=!1;for(;i>=e;)i-=e,e=this._pattern.nextValue(),r=!r;e-=i,r?(this._walker.nextPosition(e),e=this._pattern.nextValue()):this.isClosed&&(this._firstCurve=this._walker.nextCurve(e),e=this._pattern.nextValue(),this._walker.nextPosition(e),e=this._pattern.nextValue())}let s=this._walker.nextCurve(e);return s?this._walker.isPathEnd()?(this.iteratePath=!1,this._firstCurve&&(this._firstCurve.splice(0,1),Zt.mergePath(s,this._firstCurve),this._firstCurve=null)):(e=this._pattern.nextValue(),!this._walker.nextPosition(e)||this._walker.isPathEnd()?(this.iteratePath=!1,this._firstCurve&&(s=this._firstCurve,this._firstCurve=null)):this.iteratePath=!0):(this.iteratePath=!1,s=this._firstCurve,this._firstCurve=null),{paths:[s]}}}class Lt{static local(){return Lt.instance===null&&(Lt.instance=new Lt),Lt.instance}execute(t,e,s,i,n){return new On(t,e,s,i,n)}}Lt.instance=null;class On{constructor(t,e,s,i,n){switch(this._inputGeometries=t,this._tileKey=i,this._geometryEngine=n,this._width=(e.width!==void 0?e.width:2)*s,e.method){case ie.Mitered:default:break;case ie.Bevelled:break;case ie.Rounded:case ie.TrueBuffer:break;case ie.Square:break}this._option=e.option}next(){let t;for(;t=this._inputGeometries.next();){if(R(t)&&this._width>0){if(Math.min(t.xmax-t.xmin,t.ymax-t.ymin)-this._width*2<0)return t;const e=[];return e.push([[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]]),e.push([[t.xmin+this._width,t.ymin+this._width],[t.xmax-this._width,t.ymin+this._width],[t.xmax-this._width,t.ymax-this._width],[t.xmin+this._width,t.ymax-this._width],[t.xmin+this._width,t.ymin+this._width]]),{rings:e}}if(N(t)){let e=null;const s=this._geometryEngine;let i=t;if(this._tileKey&&(i=fs(t,Math.abs(this._width)+1),!i||!i.rings||i.rings.length===0))continue;if(s!=null&&(e=s.buffer(hs.WebMercator,i,-this._width,1)),this._width>0){const n=[];for(const r of t.rings)r&&n.push(r);if(e)for(const r of e.rings)r&&n.push(r.reverse());if(n.length)return{rings:n}}}}return null}}class vt{static local(){return vt.instance===null&&(vt.instance=new vt),vt.instance}execute(t,e,s,i,n){return new Fn(t,e,s)}}vt.instance=null;class Fn extends Oe{constructor(t,e,s){super(t,!1,!0),this._curveHelper=new at,this._length=(e.length!==void 0?e.length:20)*s,this._angle=e.angle!==void 0?e.angle:225,this._position=e.position!==void 0?e.position:50,this._length<0&&(this._length=-this._length),this._position<20&&(this._position=20),this._position>80&&(this._position=80),this._mirror=!1}processPath(t){if(this._curveHelper.isEmpty(t,!1))return null;const e=t[0],s=t[t.length-1],i=[s[0]-e[0],s[1]-e[1]];this._curveHelper.normalize(i);const n=[e[0]+(s[0]-e[0])*this._position/100,e[1]+(s[1]-e[1])*this._position/100],r=Math.cos((90-this._angle)/180*Math.PI);let a=Math.sin((90-this._angle)/180*Math.PI);this._mirror&&(a=-a),this._mirror=!this._mirror;const o=[n[0]-this._length/2*r,n[1]-this._length/2*a],h=[n[0]+this._length/2*r,n[1]+this._length/2*a];return{paths:[[e,o,h,s]]}}}class Tt{static local(){return Tt.instance===null&&(Tt.instance=new Tt),Tt.instance}execute(t,e,s,i,n){return new Gn(t,e,s)}}Tt.instance=null;class Gn{constructor(t,e,s){this._inputGeometries=t,this._offsetX=e.offsetX!==void 0?e.offsetX*s:0,this._offsetY=e.offsetY!==void 0?-e.offsetY*s:0}next(){let t=this._inputGeometries.next();for(;t;){if(R(t))return{xmin:t.xmin+this._offsetX,xmax:t.xmax+this._offsetX,ymin:t.ymin+this._offsetY,ymax:t.ymax+this._offsetY};if(N(t)){const e=G(t);return this._moveMultipath(e.rings,this._offsetX,this._offsetY),e}if(z(t)){const e=G(t);return this._moveMultipath(e.paths,this._offsetX,this._offsetY),e}if(Q(t)){const e=G(t);return this._movePath(e.points,this._offsetX,this._offsetY),e}if(dt(t))return{x:t.x+this._offsetX,y:t.y+this._offsetY};t=this._inputGeometries.next()}return null}_moveMultipath(t,e,s){if(t)for(const i of t)this._movePath(i,e,s)}_movePath(t,e,s){if(t)for(const i of t)i[0]+=e,i[1]+=s}}class At{static local(){return At.instance===null&&(At.instance=new At),At.instance}execute(t,e,s,i,n){return new Rn(t,e,s,i,n)}}At.instance=null;class Rn{constructor(t,e,s,i,n){this._inputGeometries=t,this._tileKey=i,this._geometryEngine=n,this._curveHelper=new at,this._offset=(e.offset??1)*s,this._method=e.method,this._option=e.option,this._offsetFlattenError=he*s}next(){let t;for(;t=this._inputGeometries.next();){if(this._offset===0)return t;if(R(t)){if(this._method===Pt.Rounded&&this._offset>0){const i=[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]],n=this._curveHelper.offset(i,-this._offset,this._method,4,this._offsetFlattenError);return n?{rings:[n]}:null}if(Math.min(t.xmax-t.xmin,t.ymax-t.ymin)+this._offset*2>0)return{xmin:t.xmin-this._offset,xmax:t.xmax+this._offset,ymin:t.ymin-this._offset,ymax:t.ymax+this._offset}}const e=this._geometryEngine;if(e==null)return null;let s=t;if(N(t)){if(this._tileKey&&(s=fs(t,Math.abs(this._offset)+1),!s||!s.rings||s.rings.length===0))continue}else if(z(t)&&this._tileKey&&(s=li(t,Math.abs(this._offset)+1),!s||!s.paths||s.paths.length===0))continue;return e.offset(hs.WebMercator,s,-this._offset,1,this._method,4,this._offsetFlattenError)}return null}}class Et{static local(){return Et.instance===null&&(Et.instance=new Et),Et.instance}execute(t,e,s,i,n){return new Dn(t,e,s)}}Et.instance=null;class Dn{constructor(t,e,s){this._inputGeometries=t,this._reverse=e.reverse!==void 0?e.reverse:!0}next(){let t=this._inputGeometries.next();for(;t;){if(!this._reverse)return t;if(z(t)){const e=G(t);return wn(e.paths),e}t=this._inputGeometries.next()}return null}}class Nt{static local(){return Nt.instance===null&&(Nt.instance=new Nt),Nt.instance}execute(t,e,s,i,n){return new Hn(t,e,s)}}Nt.instance=null;class Hn{constructor(t,e,s){this._inputGeometries=t,this._rotateAngle=e.angle!==void 0?e.angle*Math.PI/180:0}next(){let t=this._inputGeometries.next();for(;t;){if(this._rotateAngle===0)return t;const e=Z();ce(e,t);const s=(e[2]+e[0])/2,i=(e[3]+e[1])/2;if(R(t)){const n={rings:[[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]]]};return this._rotateMultipath(n.rings,s,i),n}if(N(t)){const n=G(t);return this._rotateMultipath(n.rings,s,i),n}if(z(t)){const n=G(t);return this._rotateMultipath(n.paths,s,i),n}if(Q(t)){const n=G(t);return this._rotatePath(n.points,s,i),n}if(dt(t))return t;t=this._inputGeometries.next()}return null}_rotateMultipath(t,e,s){if(t)for(const i of t)this._rotatePath(i,e,s)}_rotatePath(t,e,s){if(t){const i=Math.cos(this._rotateAngle),n=Math.sin(this._rotateAngle);for(const r of t){const a=r[0]-e,o=r[1]-s;r[0]=e+a*i-o*n,r[1]=s+a*n+o*i}}}}class zt{static local(){return zt.instance===null&&(zt.instance=new zt),zt.instance}execute(t,e,s,i,n){return new Xn(t,e,s)}}zt.instance=null;class Xn{constructor(t,e,s){this._inputGeometries=t,this._xFactor=e.xScaleFactor!==void 0?e.xScaleFactor:1.15,this._yFactor=e.yScaleFactor!==void 0?e.yScaleFactor:1.15}next(){let t=this._inputGeometries.next();for(;t;){if(this._xFactor===1&&this._yFactor===1)return t;const e=Z();ce(e,t);const s=(e[2]+e[0])/2,i=(e[3]+e[1])/2;if(R(t)){const n={rings:[[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]]]};return this._scaleMultipath(n.rings,s,i),n}if(N(t)){const n=G(t);return this._scaleMultipath(n.rings,s,i),n}if(z(t)){const n=G(t);return this._scaleMultipath(n.paths,s,i),n}if(Q(t)){const n=G(t);return this._scalePath(n.points,s,i),n}if(dt(t))return t;t=this._inputGeometries.next()}return null}_scaleMultipath(t,e,s){if(t)for(const i of t)this._scalePath(i,e,s)}_scalePath(t,e,s){if(t)for(const i of t){const n=(i[0]-e)*this._xFactor,r=(i[1]-s)*this._yFactor;i[0]=e+n,i[1]=s+r}}}class Ot{static local(){return Ot.instance===null&&(Ot.instance=new Ot),Ot.instance}execute(t,e,s,i,n){return new Yn(t,e,s)}}Ot.instance=null;class Yn{constructor(t,e,s){this._inputGeometries=t,this._height=(e.amplitude!==void 0?e.amplitude:2)*s,this._period=(e.period!==void 0?e.period:3)*s,this._style=e.waveform,this._height<=0&&(this._height=Math.abs(this._height)),this._period<=0&&(this._period=Math.abs(this._period)),this._pattern=new Fe,this._pattern.addValue(this._period),this._pattern.addValue(this._period),this._walker=new Ge,this._walker.updateTolerance(s)}next(){let t=this._inputGeometries.next();for(;t;){if(this._height===0||this._period===0)return t;if(z(t)){const e=this._processGeom(t.paths);if(e.length)return{paths:e}}if(N(t)){const e=this._processGeom(t.rings);if(e.length)return{rings:e}}t=this._inputGeometries.next()}return null}_processGeom(t){const e=[];for(const s of t)if(!this._walker.init(s,this._pattern))e.push(s);else switch(this._style){case xe.Sinus:default:e.push(this._constructCurve(s,!1));break;case xe.Square:e.push(this._constructSquare(s));break;case xe.Triangle:e.push(this._constructTriangle(s));break;case xe.Random:e.push(this._constructCurve(s,!0));break}return e}_constructCurve(t,e){const s=new Zt,i=this._walker.calculatePathLength(t);let n=Math.round(i/this._period);n===0&&(n=1);const a=n*16+1,o=i/n,h=this._period/16,c=1/a,u=Math.PI*2*i/o,f=Math.PI*2*Math.random(),_=Math.PI*2*Math.random(),d=Math.PI*2*Math.random(),p=.75-Math.random()/2,m=.75-Math.random()/2,g=new nt;this._walker.curPointAndAngle(g),s.startPath(g.pt);let y=0;for(;;)if(this._walker.nextPointAndAngle(h,g)){const x=y;y+=c;let M;if(e){const P=this._height/2*(1+.3*Math.sin(p*u*x+f));M=P*Math.sin(u*x+_),M+=P*Math.sin(m*u*x+d),M/=2}else M=.5*this._height*Math.sin(.5*u*x);s.lineTo([g.pt[0]-M*g.sa,g.pt[1]+M*g.ca])}else{s.lineTo(t[t.length-1]);break}return s.path()}_constructSquare(t){const e=new Zt,s=this._walker.calculatePathLength(t);Math.round(s/this._period);let i=!0;for(;;){let n=!1;if(this._walker.curPositionIsValid()){const r=new nt;this._walker.curPointAndAngle(r);const a=new nt;if(this._walker.nextPointAndAngle(this._period,a)){const o=new nt;this._walker.nextPointAndAngle(this._period,o)&&(i?(e.startPath(r.pt),i=!1):e.lineTo(r.pt),e.lineTo([r.pt[0]-this._height/2*r.sa,r.pt[1]+this._height/2*r.ca]),e.lineTo([a.pt[0]-this._height/2*a.sa,a.pt[1]+this._height/2*a.ca]),e.lineTo([a.pt[0]+this._height/2*a.sa,a.pt[1]-this._height/2*a.ca]),e.lineTo([o.pt[0]+this._height/2*o.sa,o.pt[1]-this._height/2*o.ca]),n=!0)}}if(!n){e.lineTo(this._walker.getPathEnd());break}}return e.path()}_constructTriangle(t){const e=new Zt,s=this._walker.calculatePathLength(t);Math.round(s/this._period);let i=!0;for(;;){let n=!1;if(this._walker.curPositionIsValid()){const r=new nt;this._walker.curPointAndAngle(r);const a=new nt;if(this._walker.nextPointAndAngle(this._period/2,a)){const o=new nt;this._walker.nextPointAndAngle(this._period,o)&&(this._walker.nextPosition(this._period/2)&&(i?(e.startPath(r.pt),i=!1):e.lineTo(r.pt),e.lineTo([a.pt[0]-this._height/2*a.sa,a.pt[1]+this._height/2*a.ca]),e.lineTo([o.pt[0]+this._height/2*o.sa,o.pt[1]-this._height/2*o.ca])),n=!0)}}if(!n){e.lineTo(this._walker.getPathEnd());break}}return e.path()}}class Ft{static local(){return Ft.instance===null&&(Ft.instance=new Ft),Ft.instance}execute(t,e,s,i,n){return new Vn(t,e,s)}}Ft.instance=null;class Vn extends fe{constructor(t,e,s){super(t),this._geometryWalker=new Ge,this._geometryWalker.updateTolerance(s),this._angleToLine=e.angleToLine??!0,this._offset=(e.offset?e.offset:0)*s,this._originalEndings=e.endings,this._offsetAtEnd=(e.customEndingOffset?e.customEndingOffset:0)*s,this._position=-(e.offsetAlongLine?e.offsetAlongLine:0)*s,this._pattern=new Fe,this._pattern.init(e.placementTemplate,!1),this._pattern.scale(s),this._endings=this._originalEndings}processPath(t){if(this._pattern.isEmpty())return null;let e;if(this.iteratePath)e=this._pattern.nextValue();else{this._originalEndings===it.WithFullGap&&this.isClosed?this._endings=it.WithMarkers:this._endings=this._originalEndings,this._pattern.extPtGap=0;let i=!0,n;switch(this._endings){case it.NoConstraint:n=-this._position,n=this._adjustPosition(n),i=!1;break;case it.WithHalfGap:default:n=-this._pattern.lastValue()/2;break;case it.WithFullGap:n=-this._pattern.lastValue(),this._pattern.extPtGap=this._pattern.lastValue();break;case it.WithMarkers:n=0;break;case it.Custom:n=-this._position,n=this._adjustPosition(n),this._pattern.extPtGap=this._offsetAtEnd*.5;break}const r=Ys(t);if(!this._geometryWalker.init(r,this._pattern,i))return null;this._pattern.reset();let a=0;for(;n>a;)n-=a,a=this._pattern.nextValue();a-=n,e=a,this.iteratePath=!0}const s=new nt;return this._geometryWalker.nextPointAndAngle(e,s)?this._endings===it.WithFullGap&&this._geometryWalker.isPathEnd()?(this.iteratePath=!1,null):this._endings===it.WithMarkers&&this._geometryWalker.isPathEnd()&&(this.iteratePath=!1,this.isClosed)?null:(this.internalPlacement.setTranslate(s.pt[0]-this._offset*s.sa,s.pt[1]+this._offset*s.ca),this._angleToLine&&this.internalPlacement.setRotateCS(s.ca,s.sa),this.internalPlacement):(this.iteratePath=!1,null)}_adjustPosition(t){let e=t/this._pattern.length();return e-=Math.floor(e),e*this._pattern.length()}}class Gt{static local(){return Gt.instance===null&&(Gt.instance=new Gt),Gt.instance}execute(t,e,s,i,n){return new Bn(t,e,s)}}Gt.instance=null;class Bn extends fe{constructor(t,e,s){super(t,!1,!0),this._curveHelper=new at,this._angleToLine=e.angleToLine!==void 0?e.angleToLine:!0,this._offset=e.offset!==void 0?e.offset*s:0,this._type=e.extremityPlacement,this._position=e.offsetAlongLine!==void 0?e.offsetAlongLine*s:0,this._beginProcessed=!1}processPath(t){let e;switch(this._type){case ft.Both:default:this._beginProcessed?(e=this._atExtremities(t,this._position,!1),this._beginProcessed=!1,this.iteratePath=!1):(e=this._atExtremities(t,this._position,!0),this._beginProcessed=!0,this.iteratePath=!0);break;case ft.JustBegin:e=this._atExtremities(t,this._position,!0);break;case ft.JustEnd:e=this._atExtremities(t,this._position,!1);break;case ft.None:break}return e}_atExtremities(t,e,s){if(s||t.seekPathEnd(),s?t.nextPoint():t.prevPoint()){let i=0;const n=[0,0],r=[t.x,t.y];for(;s?t.nextPoint():t.prevPoint();){n[0]=r[0],n[1]=r[1],r[0]=t.x,r[1]=t.y;const a=this._curveHelper.calculateLength(n,r);if(i+a>e){const o=(e-i)/a,[h,c]=this._curveHelper.getAngleCS(n,r,o),u=rs(n,r,o);return this.internalPlacement.setTranslate(u[0]-this._offset*c,u[1]+this._offset*h),this._angleToLine&&this.internalPlacement.setRotateCS(-h,-c),this.internalPlacement}i+=a}}return null}}class Rt{static local(){return Rt.instance===null&&(Rt.instance=new Rt),Rt.instance}execute(t,e,s,i,n){return new Wn(t,e,s)}}Rt.instance=null;class Wn extends fe{constructor(t,e,s){super(t),this._walker=new Ge,this._walker.updateTolerance(s),this._angleToLine=e.angleToLine!==void 0?e.angleToLine:!0,this._offset=e.offset!==void 0?e.offset*s:0,this._beginGap=e.beginPosition!==void 0?e.beginPosition*s:0,this._endGap=e.endPosition!==void 0?e.endPosition*s:0,this._flipFirst=e.flipFirst!==void 0?e.flipFirst:!0,this._pattern=new Fe,this._pattern.init(e.positionArray,!1,!1),this._subPathLen=0,this._posCount=this._pattern.size(),this._isFirst=!0,this._prevPos=0}processPath(t){if(this._pattern.isEmpty())return null;let e;if(this.iteratePath){const a=this._pattern.nextValue()*this._subPathLen,o=this._beginGap+a;e=o-this._prevPos,this._prevPos=o}else{this._posCount=this._pattern.size(),this._isFirst=!0,this._prevPos=0;const a=Ys(t);if(this._subPathLen=this._walker.calculatePathLength(a)-this._beginGap-this._endGap,this._subPathLen<0)return this.iteratePath=!1,null;if(!this._walker.init(a,this._pattern,!1))return null;this._pattern.reset();const o=this._pattern.nextValue()*this._subPathLen,h=this._beginGap+o;e=h-this._prevPos,this._prevPos=h,this.iteratePath=!0}const s=new nt;if(!this._walker.nextPointAndAngle(e,s,ut.END))return this.iteratePath=!1,null;this.internalPlacement.setTranslate(s.pt[0]-this._offset*s.sa,s.pt[1]+this._offset*s.ca);const i=this._isFirst&&this._flipFirst;let n,r;return this._angleToLine?(n=s.ca,r=s.sa):(n=1,r=0),i&&(n=-n,r=-r),this.internalPlacement.setRotateCS(n,r),this._isFirst=!1,this._posCount--,this._posCount===0&&(this.iteratePath=!1),this.internalPlacement}}const ht=512,Un=10,tt=24;class Dt{static local(){return Dt.instance===null&&(Dt.instance=new Dt),Dt.instance}execute(t,e,s,i,n){return new ct(t,e,s,i,n)}}Dt.instance=null;class ct{constructor(t,e,s,i,n){if(this._xMin=0,this._xMax=0,this._yMin=0,this._yMax=0,this._currentX=0,this._currentY=0,this._accelerationMap=null,this._testInsidePolygon=!1,this._verticalSubdivision=!0,this._stepX=Math.abs(e.stepX??16)*s,this._stepY=Math.abs(e.stepY??16)*s,!(this._stepX===0||this._stepY===0)){if(this._gridType=e.gridType??He.Fixed,this._gridType===He.Random){const r=e.seed??13,a=1;this._randomLCG=new Vs(r*a),this._randomness=(e.randomness??100)/100,this._gridAngle=0,this._shiftOddRows=!1,this._cosAngle=1,this._sinAngle=0,this._offsetX=0,this._offsetY=0,this._buildRandomValues()}else{if(this._randomness=0,this._gridAngle=e.gridAngle??0,this._shiftOddRows=e.shiftOddRows??!1,this._offsetX=(e.offsetX??0)*s,this._offsetY=(e.offsetY??0)*s,this._cosAngle=Math.cos(this._gridAngle/180*Math.PI),this._sinAngle=-Math.sin(this._gridAngle/180*Math.PI),this._stepX)if(this._offsetX<0)for(;this._offsetX<-.5*this._stepX;)this._offsetX+=this._stepX;else for(;this._offsetX>=.5*this._stepX;)this._offsetX-=this._stepX;if(this._stepY)if(this._offsetY<0)for(;this._offsetY<-.5*this._stepY;)this._offsetY+=this._stepY;else for(;this._offsetY>=.5*this._stepY;)this._offsetY-=this._stepY}if(this._graphicOriginX=0,this._graphicOriginY=0,i!=null){const[r,a,o]=i.split("/"),h=parseFloat(a),c=parseFloat(o);this._graphicOriginX=-c*ht,this._graphicOriginY=h*ht,this._testInsidePolygon=!0}this._internalPlacement=new Qt,this._calculateMinMax(t),this._geometryCursor=t}}next(){return this._geometryCursor?this._nextInside():null}_buildRandomValues(){if(!ct._randValues){ct._randValues=[];for(let t=0;t<tt;t++)for(let e=0;e<tt;e++)ct._randValues.push(this._randomLCG.getFloat()),ct._randValues.push(this._randomLCG.getFloat())}}_calculateMinMax(t){this._xMin=0,this._xMax=0,this._yMin=0,this._yMax=0;let e,s,i,n,r,a,o,h,c,u,f,_,d,p;o=h=d=f=Number.MAX_VALUE,c=u=p=_=-Number.MAX_VALUE;const m=this._cosAngle!==1;for(t.reset();t.nextPath();)for(;t.nextPoint();)a=t.x,r=t.y,e=a-this._graphicOriginX-this._offsetX,s=r-this._graphicOriginY-this._offsetY,m?(i=this._cosAngle*e-this._sinAngle*s,n=this._sinAngle*e+this._cosAngle*s):(i=e,n=s),o=Math.min(o,i),c=Math.max(c,i),h=Math.min(h,n),u=Math.max(u,n),f=Math.min(f,r),_=Math.max(_,r),d=Math.min(d,a),p=Math.max(p,a);f=f!==Number.MAX_VALUE?f:-ht-this._stepY,_=_!==-Number.MAX_VALUE?_:this._stepY,d=d!==Number.MAX_VALUE?d:-this._stepX,p=p!==-Number.MAX_VALUE?p:ht+this._stepX;const g=_-f,y=p-d;if(this._verticalSubdivision=g>=y,this._polygonMin=this._verticalSubdivision?f:d,this._testInsidePolygon){let x=0-this._graphicOriginX-this._offsetX-this._stepX,M=ht-this._graphicOriginX-this._offsetX+this._stepX,P=-ht-this._graphicOriginY-this._offsetY-this._stepY,b=0-this._graphicOriginY-this._offsetY+this._stepY;if(m){const w=[[x,P],[x,b],[M,P],[M,b]];x=P=Number.MAX_VALUE,M=b=-Number.MAX_VALUE;for(const I of w){const k=this._cosAngle*I[0]-this._sinAngle*I[1],T=this._sinAngle*I[0]+this._cosAngle*I[1];x=Math.min(x,k),M=Math.max(M,k),P=Math.min(P,T),b=Math.max(b,T)}}o=o!==Number.MAX_VALUE?Math.max(o,x):x,h=h!==Number.MAX_VALUE?Math.max(h,P):P,c=c!==-Number.MAX_VALUE?Math.min(c,M):M,u=u!==-Number.MAX_VALUE?Math.min(u,b):b}this._xMin=Math.round(o/this._stepX),this._xMax=Math.round(c/this._stepX),this._yMin=Math.round(h/this._stepY),this._yMax=Math.round(u/this._stepY),this._currentX=this._xMax+1,this._currentY=this._yMin-1,this._buildAccelerationMap(t,d,p,f,_)}_buildAccelerationMap(t,e,s,i,n){t.reset();const r=new Map,a=this._verticalSubdivision,o=a?n-i:s-e;let h=Math.ceil(o/Un);if(h<=1)return;const c=Math.floor(o/h);h++,this._delta=c;let u,f,_,d,p,m,g,y,x,M,P;for(a?(x=-ht-this._stepY,M=this._stepY,P=i):(x=-this._stepX,M=ht+this._stepX,P=e);t.nextPath();)if(!(t.numPoints<2)&&t.nextPoint())for(u=t.x,f=t.y;t.nextPoint();u=_,f=d){if(_=t.x,d=t.y,a){if(f===d||f<x&&d<x||f>M&&d>M)continue;p=Math.min(f,d),m=Math.max(f,d)}else{if(u===_||u<x&&_<x||u>M&&_>M)continue;p=Math.min(u,_),m=Math.max(u,_)}for(;p<m;)g=Math.floor((p-P)/c),ks(g,u,f,_,d,r),p+=c;y=Math.floor((m-P)/c),y>g&&ks(y,u,f,_,d,r)}this._accelerationMap=r}_nextInside(){for(;;){if(this._currentX>this._xMax){if(this._currentY++,this._currentY>this._yMax)return null;this._currentX=this._xMin,this._shiftOddRows&&this._currentY%2&&this._currentX--}let t=this._currentX*this._stepX+this._offsetX;this._shiftOddRows&&this._currentY%2&&(t+=.5*this._stepX);const e=this._currentY*this._stepY+this._offsetY;this._currentX++;let s,i;if(this._gridType===He.Random){const n=(this._currentX%tt+tt)%tt,r=(this._currentY%tt+tt)%tt;s=this._graphicOriginX+t+this._stepX*this._randomness*(.5-ct._randValues[r*tt+n])*2/3,i=this._graphicOriginY+e+this._stepY*this._randomness*(.5-ct._randValues[r*tt+n+1])*2/3}else s=this._graphicOriginX+this._cosAngle*t+this._sinAngle*e,i=this._graphicOriginY-this._sinAngle*t+this._cosAngle*e;if(!(this._testInsidePolygon&&!this._isInsidePolygon(s,i,this._geometryCursor)))return this._internalPlacement.setTranslate(s,i),this._internalPlacement}}_isInsidePolygon(t,e,s){if(this._accelerationMap==null)return qn(t,e,s);const i=this._verticalSubdivision,r=Math.floor(((i?e:t)-this._polygonMin)/this._delta),a=this._accelerationMap.get(r);if(!a)return!1;let o=0,h,c,u;for(const f of a){if(h=f[0],c=f[1],i){if(h[1]>e==c[1]>e)continue;u=(c[0]-h[0])*(e-h[1])-(c[1]-h[1])*(t-h[0])}else{if(h[0]>t==c[0]>t)continue;u=(c[1]-h[1])*(t-h[0])-(c[0]-h[0])*(e-h[1])}u>0?o++:o--}return o!==0}}function qn(l,t,e){let s=0,i,n,r,a;for(e.reset();e.nextPath();)if(e.nextPoint())for(i=e.x,n=e.y;e.nextPoint();i=r,n=a){if(r=e.x,a=e.y,n>t==a>t)continue;(r-i)*(t-n)-(a-n)*(l-i)>0?s++:s--}return s!==0}function ks(l,t,e,s,i,n){let r=n.get(l);r||(r=[],n.set(l,r)),r.push([[t,e],[s,i]])}const $n=.001;class Ht{static local(){return Ht.instance===null&&(Ht.instance=new Ht),Ht.instance}execute(t,e,s,i,n){return new Jn(t,e,s)}}Ht.instance=null;class Jn extends fe{constructor(t,e,s){super(t),this._curveHelper=new at,this._angleToLine=e.angleToLine!==void 0?e.angleToLine:!0,this._offset=e.offset!==void 0?e.offset*s:0,this._relativeTo=e.relativeTo,this._position=e.startPointOffset!==void 0?e.startPointOffset*s:0,this._epsilon=$n*s}processPath(t){const e=this._position;if(this._relativeTo===ne.SegmentMidpoint){if(this.iteratePath||(this.iteratePath=!0),t.nextPoint()){const n=[t.x,t.y],r=[0,0];for(;t.nextPoint();){r[0]=t.x,r[1]=t.y;const a=this._curveHelper.calculateLength(n,r);if(a<this._epsilon){n[0]=r[0],n[1]=r[1];continue}const o=.5+this._position/a,[h,c]=this._curveHelper.getAngleCS(n,r,o),u=rs(n,r,o);return this.internalPlacement.setTranslate(u[0]-this._offset*c,u[1]+this._offset*h),this._angleToLine&&this.internalPlacement.setRotateCS(h,c),this.internalPlacement}}return this.iteratePath=!1,null}const s=this._relativeTo===ne.LineEnd;return this.onLine(t,e,s)}onLine(t,e,s){let i,n=!1;switch(this._relativeTo){case ne.LineMiddle:default:t.seekPathFront(),i=t.pathLength()/2+e;break;case ne.LineBeginning:i=e;break;case ne.LineEnd:i=e,n=!0;break}s?t.seekPathEnd():t.seekPathFront();let r=0;if(s?t.prevPoint():t.nextPoint()){const a=[t.x,t.y],o=[0,0];for(;s?t.prevPoint():t.nextPoint();){o[0]=t.x,o[1]=t.y;const h=this._curveHelper.calculateLength(a,o);if(r+h>i){const c=(i-r)/h,[u,f]=this._curveHelper.getAngleCS(a,o,c),_=rs(a,o,c),d=n?-this._offset:this._offset;return this.internalPlacement.setTranslate(_[0]-d*f,_[1]+d*u),this._angleToLine&&(n?this.internalPlacement.setRotateCS(-u,-f):this.internalPlacement.setRotateCS(u,f)),this.internalPlacement}a[0]=o[0],a[1]=o[1],r+=h}}return null}}const jn=1e-15;class Xt{static local(){return Xt.instance===null&&(Xt.instance=new Xt),Xt.instance}execute(t,e,s,i,n){return new Kn(t,e,s)}}Xt.instance=null;class Kn extends fe{constructor(t,e,s){super(t),this._curveHelper=new at,this._angleToLine=e.angleToLine!==void 0?e.angleToLine:!0,this._offset=e.offset!==void 0?e.offset*s:0,this._endPoints=e.placeOnEndPoints!==void 0?e.placeOnEndPoints:!0,this._controlPoints=e.placeOnControlPoints!==void 0?e.placeOnControlPoints:!0,this._regularVertices=e.placeOnRegularVertices!==void 0?e.placeOnRegularVertices:!0,this._tags=[],this._tagIterator=0}processPath(t){if(this.iteratePath||(this._preparePath(t),this.iteratePath=!0),this._tagIterator>=this._tags.length)return this._tags.length=0,this._tagIterator=0,this.iteratePath=!1,null;const e=this._tags[this._tagIterator];this._angleToLine&&this.internalPlacement.setRotate(e[2]);let s=e[0],i=e[1];if(this._offset!==0){const n=Math.cos(e[2]),r=Math.sin(e[2]);s-=this._offset*r,i+=this._offset*n}return this.internalPlacement.setTranslate(s,i),this._tagIterator++,this.internalPlacement}_preparePath(t){this._tags.length=0,this._tagIterator=0,t.seekPathFront();const e=Zn(t);let s=0,i=0,n=0,r=0;if(t.seekPathFront(),t.nextPoint()){let a=t.x,o=t.y,h=t.id,c=!0,u=t.nextPoint();for(;u;){const f=t.x,_=t.y,d=t.id,p=[a,o],m=[f,_];(this._angleToLine||this._offset!==0)&&(n=this._curveHelper.getAngle(p,m,0)),c?(c=!1,e?(s=n,i=h):(this._endPoints||this._controlPoints&&h===1)&&this._tags.push([p[0],p[1],n])):h===1?this._controlPoints&&this._tags.push([p[0],p[1],Ce(r,n)]):this._regularVertices&&this._tags.push([p[0],p[1],Ce(r,n)]),(this._angleToLine||this._offset!==0)&&(r=this._curveHelper.getAngle(p,m,1)),u=t.nextPoint(),u||(e?d===1||i===1?this._controlPoints&&this._tags.push([m[0],m[1],Ce(r,s)]):this._regularVertices&&this._tags.push([m[0],m[1],Ce(r,s)]):(this._endPoints||this._controlPoints&&d===1)&&this._tags.push([m[0],m[1],r])),a=f,o=_,h=d}}this._tagIterator=0}}function Ce(l,t){const e=Math.PI;for(;Math.abs(t-l)>e+2*jn;)t-l>e?t-=2*e:t+=2*e;return(l+t)/2}function Zn(l){if(!l.nextPoint())return!1;const t=l.x,e=l.y;if(l.seekPathEnd(),!l.prevPoint())return!1;const s=l.x,i=l.y;return t===s&&e===i}class Qn{constructor(t=tr){this._data=[],this._compare=t}get size(){return this._data.length}enqueue(t){if(t==null)return;const{_data:e,_compare:s}=this;e.push(t);let i=e.length-1>>>0;const n=e[i];for(;i>0;){const r=i-1>>1,a=e[r];if(s(a,n)<=0)e[r]=n,e[i]=a,i=r;else break}}dequeue(){const{_data:t,_compare:e}=this,s=t[0],i=t.pop();if(t.length===0)return s;t[0]=i;let n=0;const r=t.length,a=t[0];let o,h,c=null;for(;;){const u=2*n+1,f=2*n+2;if(c=null,u<r&&(o=t[u],e(o,a)>0&&(c=u)),f<r&&(h=t[f],(c===null&&e(h,a)<=0||c!==null&&e(h,o)<=0)&&(c=f)),c===null)break;t[n]=t[c],t[c]=a,n=c}return s}}const tr=(l,t)=>l<t?-1:l>t?1:0,er=222045e-21,sr=100*er;function ir(l){const e={rings:Ci(l)};return nr(e)}function nr(l){const{rings:t}=l;if(!t||t.length===0)return null;const e=ce(Z(),l);if(!e)return null;const i=4*(Math.abs(e[0])+Math.abs(e[2])+Math.abs(e[1])+Math.abs(e[3])+1)*sr;let n=0,r=0;for(let C=0;C<t.length;C++){const L=Ii(t[C]);L>r&&(r=L,n=C)}if(Math.abs(r)<=2*i*i){const C=ms(Z(),t[n]);return[(C[0]+C[2])/2,(C[1]+C[3])/2]}const a=ki(t[n],!1,Z());if(a===null)return null;if(t.length===1&&t[0].length<4)return a;const o=[[NaN,NaN],[NaN,NaN],[NaN,NaN],[NaN,NaN]],h=[NaN,NaN,NaN,NaN],c=[NaN,NaN,NaN,NaN];let u=!1,f=re(a,l,!0);f.distance===0&&(u=!0,o[0][0]=a[0],o[0][1]=a[1],f=re(a,l,!1)),h[0]=f.distance,c[0]=0;const _=[NaN,NaN];let d=!1,p=.25,m=-1;const g=ms(Z(),t[n]);let y=NaN;do if(y=NaN,o[1]=Ue(l,qe(g[0],g[2],p),i,e),!isNaN(o[1][0])&&!isNaN(o[1][1])&&(f=re(o[1],l,!1),y=f.distance),!isNaN(y)&&y>i&&Te(o[1],l))d=!0,h[1]=y,c[1]=yt(o[1],a);else if(!isNaN(y)&&y>m&&(m=y,_[0]=o[1][0],_[1]=o[1][1]),p-=.01,p<.1)if(m>=0)d=!0,h[1]=m,o[1][0]=_[0],o[1][1]=_[1],c[1]=yt(o[1],a);else break;while(!d);d=!1,p=.5,m=-1;let x=.01,M=1;do if(y=NaN,o[2]=Ue(l,qe(g[0],g[2],p),i,e),!isNaN(o[2][0])&&!isNaN(o[2][1])&&(f=re(o[2],l,!1),y=f.distance),!isNaN(y)&&y>i&&Te(o[2],l))d=!0,h[2]=y,c[2]=yt(o[2],a);else if(!isNaN(y)&&y>m)m=y,_[0]=o[2][0],_[1]=o[2][1];else if(y>m&&(m=y,_[0]=o[2][0],_[1]=o[2][1]),p=.5+x*M,x+=.01,M*=-1,p<.3||p>.7)if(m>=0)d=!0,h[2]=m,o[2][0]=_[0],o[2][1]=_[1],c[2]=yt(o[2],a);else break;while(!d);d=!1,p=.75,m=-1;do if(y=NaN,o[3]=Ue(l,qe(g[0],g[2],p),i,e),!isNaN(o[3][0])&&!isNaN(o[3][1])&&(f=re(o[3],l,!1),y=f.distance),!isNaN(y)&&y>i&&Te(o[3],l))d=!0,h[3]=y,c[3]=yt(o[3],a);else if(y>m&&(m=y,_[0]=o[3][0],_[1]=o[3][1]),p+=.01,p>.9)if(m>=0)d=!0,h[3]=m,o[3][0]=_[0],o[3][1]=_[1],c[3]=yt(o[3],a);else break;while(!d);const P=[0,1,2,3],b=u?0:1;let w;for(let C=b;C<4;C++)for(let L=b;L<3;L++){const Y=c[L],U=c[L+1];ar(Y,U)>0&&(w=P[L],P[L]=P[L+1],P[L+1]=w,c[L]=U,c[L+1]=Y)}let I=b,k=0,T=0;for(let C=b;C<4;C++){switch(C){case 0:T=h[P[C]]*2;break;case 1:T=h[P[C]]*1.66666666;break;case 2:T=h[P[C]]*1.33333333;break;case 3:T=h[P[C]];break}T>k&&(k=T,I=P[C])}return o[I]}function Te(l,t){const{rings:e}=t;let s=0;for(const i of e){const n=i.length;for(let r=1;r<n;++r){const a=i[r-1],o=i[r];if(a[1]>l[1]==o[1]>l[1])continue;(o[0]-a[0])*(l[1]-a[1])-(o[1]-a[1])*(l[0]-a[0])>0?s++:s--}}return s!==0}function re(l,t,e){if(e&&Te(l,t))return{coord:l,distance:0};let s=1/0,i=0,n=0;const r=[0,0],{rings:a}=t;for(const o of a)if(!(o.length<2))for(let h=0;h<o.length-1;h++){Li(r,l,o,h);const c=yt(l,r);c<s&&(s=c,i=r[0],n=r[1])}return{coord:[i,n],distance:Math.sqrt(s)}}function Ue(l,t,e,s){const i=[t,0];let n=1/0,r=1/0,a=!1,o=!1;const h=[[t,s[1]-1],[t,s[3]+1]],c=[0,0],u=[0,0],f=[0,0],_=[[0,0],[0,0]],d=Z(),{rings:p}=l;for(const m of p)if(!(m.length<2))for(let g=1;g<m.length;g++){if(_[0][0]=m[g-1][0],_[0][1]=m[g-1][1],_[1][0]=m[g][0],_[1][1]=m[g][1],rr(d,_)===null||(u[0]=h[0][0],u[1]=h[0][1],f[0]=h[1][0],f[1]=h[1][1],or(d,u,f)===0)||!vi(h[0],h[1],_[0],_[1],c))continue;const y=c[1];n>r?y<n&&(n=y,a=!0):y<r&&(r=y,o=!0)}return a&&o?i[1]=(n+r)/2:i[0]=i[1]=NaN,i}function rr(l,t){if(t.length<2)return null;l||(l=Z());const[e,s]=t[0],[i,n]=t[1];return l[0]=Math.min(e,i),l[1]=Math.min(s,n),l[2]=Math.max(e,i),l[3]=Math.max(s,n),l}const Ie=1,ke=4,Ls=3,vs=12;function or(l,t,e){let s=et(t,l),i=et(e,l);const n=l[0],r=l[1],a=l[2],o=l[3];if(s&i)return 0;if(!(s|i))return 4;const h=(s?1:0)|(i?2:0);do{const c=e[0]-t[0],u=e[1]-t[1];if(c>u)s&Ls?(s&Ie?(t[1]+=u*(n-t[0])/c,t[0]=n):(t[1]+=u*(a-t[0])/c,t[0]=a),s=et(t,l)):i&Ls?(i&Ie?(e[1]+=u*(n-e[0])/c,e[0]=n):(e[1]+=u*(a-e[0])/c,e[0]=a),i=et(e,l)):s?(s&ke?(t[0]+=c*(r-t[1])/u,t[1]=r):(t[0]+=c*(o-t[1])/u,t[1]=o),s=et(t,l)):(i&ke?(e[0]+=c*(r-e[1])/u,e[1]=r):(e[0]+=c*(o-e[1])/u,e[1]=o),i=et(e,l));else if(s&vs?(s&ke?(t[0]+=c*(r-t[1])/u,t[1]=r):(t[0]+=c*(o-t[1])/u,t[1]=o),s=et(t,l)):i&vs?(i&ke?(e[0]+=c*(r-e[1])/u,e[1]=r):(e[0]+=c*(o-e[1])/u,e[1]=o),i=et(e,l)):s?(s&Ie?(t[1]+=u*(n-t[0])/c,t[0]=n):(t[1]+=u*(a-t[0])/c,t[0]=a),s=et(t,l)):(i&Ie?(e[1]+=u*(n-e[0])/c,e[0]=n):(e[1]+=u*(a-e[0])/c,e[0]=a),i=et(e,l)),s&i)return 0}while(s|i);return h}function et(l,t){return(l[0]<t[0]?1:0)|(l[0]>t[2]?1:0)<<1|(l[1]<t[1]?1:0)<<2|(l[1]>t[3]?1:0)<<3}function qe(l,t,e){return l+(t-l)*e}function yt(l,t){return(l[0]-t[0])*(l[0]-t[0])+(l[1]-t[1])*(l[1]-t[1])}function ar(l,t){if(l<t)return-1;if(l>t)return 1;if(l===t)return 0;const e=isNaN(l),s=isNaN(t);return e<s?-1:e>s?1:0}class qt{constructor(t,e,s,i){this.x=t,this.y=e,this.cellSize=s,this.distancefromCellCenter=Ei(t,e,i),this.maxDistanceToPolygon=this.distancefromCellCenter+this.cellSize*Math.SQRT2}}const lr=1,hr=100;function cr(l){if(!l.nextPath()||!l.numPoints)return null;const t=Ti(l),e=t[2]-t[0],s=t[3]-t[1];if(e===0||s===0)return[t[0]+e/2,t[1]+s/2];const i=Math.max(Math.min(e,s)/hr,lr),n=new Qn((_,d)=>d.maxDistanceToPolygon-_.maxDistanceToPolygon),r=Math.min(e,s);let a=r/2,o=0,h=0;for(o=t[0];o<t[2];o+=r)for(h=t[1];h<t[3];h+=r)n.enqueue(new qt(o+a,h+a,a,l));const c=Ai(l);if(c===null)return null;let u=new qt(c[0],c[1],0,l),f;for(;n.size>0;)f=n.dequeue(),f.distancefromCellCenter>u.distancefromCellCenter&&(u=f),!(f.maxDistanceToPolygon-u.distancefromCellCenter<=i)&&(a=f.cellSize/2,n.enqueue(new qt(f.x-a,f.y-a,a,l)),n.enqueue(new qt(f.x+a,f.y-a,a,l)),n.enqueue(new qt(f.x-a,f.y+a,a,l)),n.enqueue(new qt(f.x+a,f.y+a,a,l)));return[u.x,u.y]}class Yt{static local(){return Yt.instance===null&&(Yt.instance=new Yt),Yt.instance}execute(t,e,s,i,n){return new ur(t,e,s)}}Yt.instance=null;class ur{constructor(t,e,s){this._geometryCursor=t,this._offsetX=e.offsetX!==void 0?e.offsetX*s:0,this._offsetY=e.offsetY!==void 0?e.offsetY*s:0,this._method=e.method!==void 0?e.method:Me.OnPolygon,this._internalPlacement=new Qt}next(){const t=this._geometryCursor;return this._geometryCursor=null,t?this._polygonCenter(t):null}_polygonCenter(t){let e=!1;switch(this._method){case Me.CenterOfMass:{const s=Oi(t);s&&(this._internalPlacement.setTranslate(s[0]+this._offsetX,s[1]+this._offsetY),e=!0)}break;case Me.BoundingBoxCenter:{const s=zi(t);s&&(this._internalPlacement.setTranslate((s[2]+s[0])/2+this._offsetX,(s[3]+s[1])/2+this._offsetY),e=!0)}break;case Me.OnPolygon:default:{let s;Ni("polylabel-placement-enabled")?s=cr(t):s=ir(t),s!==null&&(this._internalPlacement.setTranslate(s[0]+this._offsetX,s[1]+this._offsetY),e=!0)}break}return e?this._internalPlacement:null}}function os(l){if(!l)return null;switch(l.type){case"CIMGeometricEffectAddControlPoints":return bt.local();case"CIMGeometricEffectArrow":return St.local();case"CIMGeometricEffectBuffer":return wt.local();case"CIMGeometricEffectControlMeasureLine":return Ct.local();case"CIMGeometricEffectCut":return It.local();case"CIMGeometricEffectDashes":return kt.local();case"CIMGeometricEffectDonut":return Lt.local();case"CIMGeometricEffectJog":return vt.local();case"CIMGeometricEffectMove":return Tt.local();case"CIMGeometricEffectOffset":return At.local();case"CIMGeometricEffectReverse":return Et.local();case"CIMGeometricEffectRotate":return Nt.local();case"CIMGeometricEffectScale":return zt.local();case"CIMGeometricEffectWave":return Ot.local()}return null}function fr(l){if(!l)return null;switch(l.type){case"CIMMarkerPlacementAlongLineSameSize":return Ft.local();case"CIMMarkerPlacementAtExtremities":return Gt.local();case"CIMMarkerPlacementAtRatioPositions":return Rt.local();case"CIMMarkerPlacementInsidePolygon":return Dt.local();case"CIMMarkerPlacementOnLine":return Ht.local();case"CIMMarkerPlacementOnVertices":return Xt.local();case"CIMMarkerPlacementPolygonCenter":return Yt.local()}return null}function $e(l){const t=l.getFrame(0);if(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement)return t;const e=document.createElement("canvas");e.width=l.width,e.height=l.height;const s=e.getContext("2d");return t instanceof ImageData?s.putImageData(t,0,0):s.drawImage(t,0,0),e}class _i{constructor(t=0,e=0,s=0,i=0){this.x=t,this.y=e,this.width=s,this.height=i}get isEmpty(){return this.width<=0||this.height<=0}union(t){this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.width=Math.max(this.width,t.width),this.height=Math.max(this.height,t.height)}}function _r(l){return`rgb(${l.slice(0,3).toString()})`}function dr(l){return`rgba(${l.slice(0,3).toString()},${l[3]})`}class di{constructor(t){t&&(this._textRasterizationCanvas=t)}rasterizeText(t,e){this._textRasterizationCanvas||(this._textRasterizationCanvas=document.createElement("canvas"));const s=this._textRasterizationCanvas,i=s.getContext("2d");this._setFontProperties(i,e),this._parameters=e,this._textLines=t.split(/\r?\n/),this._lineHeight=this._computeLineHeight();const n=this._computeTextWidth(i,e),{decoration:r,weight:a}=e.font;this._lineThroughWidthOffset=r&&r==="line-through"?.1*this._lineHeight:0;const o=this._lineHeight*this._textLines.length;if(s.width=n+2*this._lineThroughWidthOffset,s.height=o,e.size<.5)return s.width=s.height=1,{size:[0,0],image:new Uint32Array(0),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0,canvas:s};this._renderedLineHeight=Math.round(this._lineHeight*e.pixelRatio),this._renderedHaloSize=e.halo.size*e.pixelRatio,this._renderedWidth=n*e.pixelRatio,this._renderedHeight=o*e.pixelRatio,this._lineThroughWidthOffset*=e.pixelRatio;const h=e.color??[0,0,0,0],c=e.halo&&e.halo.color?e.halo.color:[0,0,0,0];this._fillStyle=dr(h),this._haloStyle=_r(c);const u=this._renderedLineHeight,f=this._renderedHaloSize;i.save(),i.clearRect(0,0,s.width,s.height),this._setFontProperties(i,e);const _=pr(i.textAlign,this._renderedWidth)+f,d=f,p=f>0;let m=this._lineThroughWidthOffset,g=0;p&&this._renderHalo(i,_,d,m,g,e),g+=d,m+=_;for(const I of this._textLines)p?(i.globalCompositeOperation="destination-out",i.fillStyle="rgb(0, 0, 0)",i.fillText(I,m,g),i.globalCompositeOperation="source-over",i.fillStyle=this._fillStyle,i.fillText(I,m,g)):(i.fillStyle=this._fillStyle,i.fillText(I,m,g)),r&&r!=="none"&&this._renderDecoration(i,m,g,r,a),g+=u;i.restore();const y=this._renderedWidth+2*this._lineThroughWidthOffset,x=this._renderedHeight,M=i.getImageData(0,0,y,x),P=new Uint8Array(M.data);if(e.premultiplyColors){let I;for(let k=0;k<P.length;k+=4)I=P[k+3]/255,P[k]=P[k]*I,P[k+1]=P[k+1]*I,P[k+2]=P[k+2]*I}let b;switch(e.horizontalAlignment){case"left":b=-.5;break;case"right":b=.5;break;case"center":default:b=0;break}let w;switch(e.verticalAlignment){case"bottom":w=-.5;break;case"top":w=.5;break;case"middle":default:w=0;break}return{size:[y,x],image:new Uint32Array(P.buffer),sdf:!1,simplePattern:!1,anchorX:b,anchorY:w,canvas:s}}_renderHalo(t,e,s,i,n,r){const a=this._renderedWidth,o=this._renderedHeight;this._haloRasterizationCanvas||(this._haloRasterizationCanvas=document.createElement("canvas")),this._haloRasterizationCanvas.width=a,this._haloRasterizationCanvas.height=o;const h=this._haloRasterizationCanvas,c=h.getContext("2d");c.clearRect(0,0,a,o),this._setFontProperties(c,r);const{decoration:u,weight:f}=r.font;c.fillStyle=this._haloStyle,c.strokeStyle=this._haloStyle,c.lineJoin="round",this._renderHaloNative(c,e,s,u,f),t.globalAlpha=this._parameters.halo.color[3],t.drawImage(h,0,0,a,o,i,n,a,o),t.globalAlpha=1}_renderHaloNative(t,e,s,i,n){const r=this._renderedLineHeight,a=this._renderedHaloSize;for(const o of this._textLines){const h=2*a,c=5,u=.1;for(let f=0;f<c;f++){const p=(1-(c-1)*u+f*u)*h;t.lineWidth=p,t.strokeText(o,e,s),i&&i!=="none"&&this._renderDecoration(t,e,s,i,n,p)}s+=r}}_setFontProperties(t,e){const s=Math.max(e.size,.5),i=e.font,n=`${i.style} ${i.weight} ${Bt(s*e.pixelRatio).toFixed(1)}px ${i.family}, sans-serif`;t.font=n,t.textBaseline="top";let r;switch(e.horizontalAlignment){case"left":r="left";break;case"right":r="right";break;case"center":r="center";break;default:r="left";break}t.textAlign=r}computeTextSize(t,e){this._textRasterizationCanvas||(this._textRasterizationCanvas=document.createElement("canvas"));const s=this._textRasterizationCanvas,i=s.getContext("2d");this._setFontProperties(i,e),this._parameters=e,this._textLines=t.split(/\r?\n/),this._lineHeight=this._computeLineHeight();const n=this._computeTextWidth(i,e),r=this._lineHeight*this._textLines.length;return s.width=n,s.height=r,[n*e.pixelRatio,r*e.pixelRatio]}_computeTextWidth(t,e){let s=0;for(const n of this._textLines)s=Math.max(s,t.measureText(n).width);const i=e.font;return(i.style==="italic"||i.style==="oblique"||typeof i.weight=="string"&&(i.weight==="bold"||i.weight==="bolder")||typeof i.weight=="number"&&i.weight>600)&&(s+=t.measureText("w").width*.3),s+=2*this._parameters.halo.size,Math.round(s)}_computeLineHeight(){let t=this._parameters.size*1.275;const e=this._parameters.font.decoration;return e&&e==="underline"&&(t*=1.3),Math.round(t+2*this._parameters.halo.size)}_renderDecoration(t,e,s,i,n,r){const a=.9*this._lineHeight,o=n==="bold"?.06:n==="bolder"?.09:.04;switch(t.textAlign){case"center":e-=this._renderedWidth/2;break;case"right":e-=this._renderedWidth;break}const h=t.textBaseline;if(i==="underline")switch(h){case"top":s+=a;break;case"middle":s+=a/2;break}else if(i==="line-through")switch(h){case"top":s+=a/1.5;break;case"middle":s+=a/3}const c=r?1.5*r:Math.ceil(a*o);t.save(),t.beginPath(),t.strokeStyle=t.fillStyle,t.lineWidth=c,t.moveTo(e-this._lineThroughWidthOffset,s),t.lineTo(e+this._renderedWidth+2*this._lineThroughWidthOffset,s),t.stroke(),t.restore()}}function pr(l,t){return l==="center"?.5*t:l==="right"?t:0}class _t{constructor(t,e,s,i){this.center=Fi(t,e),this.centerT=ss(),this.halfWidth=s/2,this.halfHeight=i/2,this.width=s,this.height=i}get x(){return this.center[0]}get y(){return this.center[1]}get blX(){return this.center[0]+this.halfWidth}get blY(){return this.center[1]+this.halfHeight}get trX(){return this.center[0]-this.halfWidth}get trY(){return this.center[1]-this.halfHeight}get xmin(){return this.x-this.halfWidth}get xmax(){return this.x+this.halfWidth}get ymin(){return this.y-this.halfHeight}get ymax(){return this.y+this.halfHeight}set x(t){this.center[0]=t}set y(t){this.center[1]=t}clone(){return new _t(this.x,this.y,this.width,this.height)}serialize(t){return t.writeF32(this.center[0]),t.writeF32(this.center[1]),t.push(this.width),t.push(this.height),t}findCollisionDelta(t,e=4){const s=Math.abs(t.centerT[0]-this.centerT[0]),i=Math.abs(t.centerT[1]-this.centerT[1]),n=t.halfWidth+this.halfWidth+e,r=t.halfHeight+this.halfHeight+e,a=n/s,o=r/i,h=Math.min(a,o);return Math.log2(h)}extend(t){const e=Math.min(this.xmin,t.xmin),s=Math.min(this.ymin,t.ymin),i=Math.max(this.xmax,t.xmax),n=Math.max(this.ymax,t.ymax),r=i-e,a=n-s,o=e+r/2,h=s+a/2;this.width=r,this.height=a,this.halfWidth=r/2,this.halfHeight=a/2,this.x=o,this.y=h}static deserialize(t){const e=t.readF32(),s=t.readF32(),i=t.readInt32(),n=t.readInt32();return new _t(e,s,i,n)}}const _s=26,pi=4,mr=6,gr=_s+pi,yr=_s-mr,Ts=3,X=8,xr=Math.PI/180,Mr=8,Pr=1.5;class mi{constructor(t,e,s,i){this._rotationT=le(),this._xBounds=0,this._yBounds=0,this.minZoom=0,this.maxZoom=255,this._bounds=null;const n=s.rect,r=new Float32Array(8);t*=i,e*=i;const a=s.code?n.width*i:s.metrics.width,o=s.code?n.height*i:s.metrics.height;this.width=a,this.height=o,r[0]=t,r[1]=e,r[2]=t+a,r[3]=e,r[4]=t,r[5]=e+o,r[6]=t+a,r[7]=e+o,this._data=r,this._setTextureCoords(n),this._scale=i,this._mosaic=s,this.x=t,this.y=e,this.maxOffset=Math.max(t+a,e+o)}get mosaic(){return this._mosaic}set angle(t){this._angle=t,Bs(this._rotationT,-t),this._setOffsets(this._data)}get angle(){return this._angle}get xTopLeft(){return this._data[0]}get yTopLeft(){return this._data[1]}get xBottomRight(){return this._data[6]}get yBottomRight(){return this._data[7]}get texcoords(){return this._texcoords}get textureBinding(){return this._mosaic.textureBinding}get offsets(){return this._offsets||this._setOffsets(this._data),this._offsets}get char(){return String.fromCharCode(this._mosaic.code)}get code(){return this._mosaic.code}get bounds(){if(!this._bounds){const{height:t,width:e}=this._mosaic.metrics,s=e*this._scale,i=Math.abs(t)*this._scale,n=new Float32Array(8);n[0]=this.x,n[1]=this.y,n[2]=this.x+s,n[3]=this.y,n[4]=this.x,n[5]=this.y+i,n[6]=this.x+s,n[7]=this.y+i;const r=is(le(),this._rotationT,this._transform);gs(n,n,r);let a=1/0,o=1/0,h=0,c=0;for(let p=0;p<4;p++){const m=n[p*2],g=n[p*2+1];a=Math.min(a,m),o=Math.min(o,g),h=Math.max(h,m),c=Math.max(c,g)}const u=h-a,f=c-o,_=a+u/2,d=o+f/2;this._bounds=new _t(_,d,u,f)}return this._bounds}setTransform(t){this._transform=t,this._offsets=null}_setOffsets(t){this._offsets||(this._offsets={upperLeft:0,upperRight:0,lowerLeft:0,lowerRight:0});const e=this._offsets,s=new Float32Array(8),i=is(le(),this._rotationT,this._transform);gs(s,t,i),e.upperLeft=J(s[0]*X,s[1]*X),e.upperRight=J(s[2]*X,s[3]*X),e.lowerLeft=J(s[4]*X,s[5]*X),e.lowerRight=J(s[6]*X,s[7]*X)}_setTextureCoords({x:t,y:e,width:s,height:i}){this._texcoords={upperLeft:J(t,e),upperRight:J(t+s,e),lowerLeft:J(t,e+i),lowerRight:J(t+s,e+i)}}}const br=(l,t)=>({code:0,page:0,sdf:!0,rect:new Ki(0,0,11,8),textureBinding:t,metrics:{advance:0,height:4,width:l,left:0,top:0}});function oe(l,t){return l.forEach(e=>Ws(e,e,t)),{upperLeft:J(X*l[0][0],X*l[0][1]),upperRight:J(X*l[1][0],X*l[1][1]),lowerLeft:J(X*l[2][0],X*l[2][1]),lowerRight:J(X*l[3][0],X*l[3][1])}}class Sr{constructor(t,e,s){this._rotation=0,this._decorate(t,e,s),this.glyphs=t,this.bounds=this._createBounds(t),this.isMultiline=e.length>1,this._hasRotation=s.angle!==0,this._transform=this._createGlyphTransform(this.bounds,s),this._borderLineSize=s.borderLineSize,(s.borderLineSize||s.hasBackground)&&([this.bounds,this.background]=this.shapeBackground(this._transform));for(const i of t)i.setTransform(this._transform)}setRotation(t){if(t===0&&this._rotation===0)return;this._rotation=t;const e=this._transform,s=Bs(le(),t);is(e,s,e);for(const i of this.glyphs)i.setTransform(this._transform)}_decorate(t,e,s){if(!s.decoration||s.decoration==="none"||!t.length)return;const i=s.scale,n=s.decoration==="underline"?gr:yr,r=t[0].textureBinding;for(const a of e){const o=a.startX*i,h=a.startY*i,c=(a.width+a.glyphWidthEnd)*i;t.push(new mi(o,h+n*i,br(c,r),1))}}shapeBackground(t){const e=Bt(this._borderLineSize||0),s=(Pr+e)/2,i=this._borderLineSize?s:0,{xmin:n,ymin:r,xmax:a,ymax:o,x:h,y:c,width:u,height:f}=this.bounds,_=Mr,d=[n-_,r-_],p=[a+_,r-_],m=[n-_,o+_],g=[a+_,o+_],y=oe([[d[0]-s,d[1]-s],[p[0]+s,p[1]-s],[d[0]+i,d[1]+i],[p[0]-i,p[1]+i]],t),x=oe([[m[0]+i,m[1]-i],[g[0]-i,g[1]-i],[m[0]-s,m[1]+s],[g[0]+s,g[1]+s]],t),M=oe([[d[0]-s,d[1]-s],[d[0]+i,d[1]+i],[m[0]-s,m[1]+s],[m[0]+i,m[1]-i]],t),P=oe([[p[0]-i,p[1]+i],[p[0]+s,p[1]-s],[g[0]-i,g[1]-i],[g[0]+s,g[1]+s]],t),b={main:oe([d,p,m,g],t),top:y,bot:x,left:M,right:P};return[new _t(h,c,u+s*2,f+s*2),b]}get boundsT(){const t=this.bounds,e=me(ss(),t.x,t.y);if(Ws(e,e,this._transform),this._hasRotation){const s=Math.max(t.width,t.height);return new _t(e[0],e[1],s,s)}return new _t(e[0],e[1],t.width,t.height)}_createBounds(t){let e=1/0,s=1/0,i=0,n=0;for(const c of t)e=Math.min(e,c.xTopLeft),s=Math.min(s,c.yTopLeft),i=Math.max(i,c.xBottomRight),n=Math.max(n,c.yBottomRight);const r=i-e,a=n-s,o=e+r/2,h=s+a/2;return new _t(o,h,r,a)}_createGlyphTransform(t,e){const s=xr*e.angle,i=le(),n=ss();return De(i,i,me(n,e.xOffset,-e.yOffset)),e.isCIM?ys(i,i,s):(De(i,i,me(n,t.x,t.y)),ys(i,i,s),De(i,i,me(n,-t.x,-t.y))),i}}class Le{constructor(t,e,s,i,n,r){this.glyphWidthEnd=0,this.startX=0,this.startY=0,this.start=Math.max(0,Math.min(e,s)),this.end=Math.max(0,Math.max(e,s)),this.end<t.length&&(this.glyphWidthEnd=t[this.end].metrics.width),this.width=i,this.yMin=n,this.yMax=r}}const as=l=>l===10,As=l=>l===32;function wr(l,t,e){const s=new Array,i=1/e.scale,n=e.maxLineWidth*i,r=t?l.length-1:0,a=t?-1:l.length,o=t?-1:1;let h=r,c=0,u=0,f=h,_=f,d=0,p=1/0,m=0;for(;h!==a;){const{code:y,metrics:x}=l[h],M=Math.abs(x.top);if(!as(y)&&!As(y)&&(p=Math.min(p,M),m=Math.max(m,M+x.height)),as(y))h!==r&&(s.push(new Le(l,f,h-o,c,p,m)),p=1/0,m=0),c=0,f=h+o,_=h+o,u=0;else if(As(y))_=h+o,u=0,d=x.advance,c+=x.advance;else if(c>n){if(_!==f){const P=_-2*o;c-=d,s.push(new Le(l,f,P,c-u,p,m)),p=1/0,m=0,f=_,c=u}else s.push(new Le(l,f,h-o,c,p,m)),p=1/0,m=0,f=h,_=h,c=0;c+=x.advance,u+=x.advance}else c+=x.advance,u+=x.advance;h+=o}const g=new Le(l,f,h-o,c,p,m);return g.start>=0&&g.end<l.length&&s.push(g),s}function Cr(l,t){let e=0;for(let o=0;o<l.length;o++){const{width:h}=l[o];e=Math.max(h,e)}const s=t.decoration==="underline"?pi:0,i=l[0].yMin,r=l[l.length-1].yMax+t.lineHeight*(l.length-1)+s-i;return{x:0,y:i,height:r,width:e}}function gi(l,t,e){const s=e.scale,i=new Array,n=wr(l,t,e),r=Cr(n,e),{vAlign:a,hAlign:o}=e,h=a===ae.Baseline?1:0,c=h?0:a-1,u=(1-h)*-r.y+c*(r.height/2)+(h?1:0)*-_s;for(let f=0;f<n.length;f++){const{start:_,end:d,width:p}=n[f];let g=(o+1)*-1*(p/2)-Ts;const y=f*e.lineHeight+u-Ts;n[f].startX=g,n[f].startY=y;for(let x=_;x<=d;x++){const M=l[x];if(as(M.code))continue;const P=new mi(g+M.metrics.left,y-M.metrics.top,M,s);g+=M.metrics.advance,i.push(P)}}return new Sr(i,n,e)}const gt=Math.PI/180,yi=ue.getLogger("esri.symbols.cim.CIMSymbolDrawHelper"),xt=4,ze=10,Ir=10,ds=4,Re=10;class H{constructor(t){this._t=t}static createIdentity(){return new H([1,0,0,0,1,0])}clone(){const t=this._t;return new H(t.slice())}transform(t){const e=this._t;return[e[0]*t[0]+e[1]*t[1]+e[2],e[3]*t[0]+e[4]*t[1]+e[5]]}static createScale(t,e){return new H([t,0,0,0,e,0])}scale(t,e){const s=this._t;return s[0]*=t,s[1]*=t,s[2]*=t,s[3]*=e,s[4]*=e,s[5]*=e,this}scaleRatio(){return Math.sqrt(this._t[0]*this._t[0]+this._t[1]*this._t[1])}static createTranslate(t,e){return new H([0,0,t,0,0,e])}translate(t,e){const s=this._t;return s[2]+=t,s[5]+=e,this}static createRotate(t){const e=Math.cos(t),s=Math.sin(t);return new H([e,-s,0,s,e,0])}rotate(t){return H.multiply(this,H.createRotate(t),this)}angle(){const t=this._t[0],e=this._t[3],s=Math.sqrt(t*t+e*e);return[t/s,e/s]}static multiply(t,e,s){const i=t._t,n=e._t,r=i[0]*n[0]+i[3]*n[1],a=i[1]*n[0]+i[4]*n[1],o=i[2]*n[0]+i[5]*n[1]+n[2],h=i[0]*n[3]+i[3]*n[4],c=i[1]*n[3]+i[4]*n[4],u=i[2]*n[3]+i[5]*n[4]+n[5],f=s._t;return f[0]=r,f[1]=a,f[2]=o,f[3]=h,f[4]=c,f[5]=u,s}invert(){const t=this._t;let e=t[0]*t[4]-t[1]*t[3];if(e===0)return new H([0,0,0,0,0,0]);e=1/e;const s=(t[1]*t[5]-t[2]*t[4])*e,i=(t[2]*t[3]-t[0]*t[5])*e,n=t[4]*e,r=-t[1]*e,a=-t[3]*e,o=t[0]*e;return new H([n,r,s,a,o,i])}}class ps{constructor(t,e){this._resourceManager=t,this._transfos=[],this._sizeTransfos=[],this._geomUnitsPerPoint=1,this._placementPool=new Ri(Qt,void 0,void 0,100),this._earlyReturn=!1,this._mapRotation=0,this._transfos.push(e||H.createIdentity()),this._sizeTransfos.push(e?e.scaleRatio():1)}setTransform(t,e){this._transfos=[t||H.createIdentity()],this._sizeTransfos=[e||(t?t.scaleRatio():1)]}setGeomUnitsPerPoint(t){this._geomUnitsPerPoint=t}transformPt(t){return this._transfos[this._transfos.length-1].transform(t)}transformSize(t){return t*this._sizeTransfos[this._sizeTransfos.length-1]}reverseTransformPt(t){return this._transfos[this._transfos.length-1].invert().transform(t)}reverseTransformSize(t){return t/this._sizeTransfos[this._sizeTransfos.length-1]}getTransformAngle(){return this._transfos[this._transfos.length-1].angle()}geomUnitsPerPoint(){return this.isEmbedded()?1:this._geomUnitsPerPoint}isEmbedded(){return this._transfos.length>1}back(){return this._transfos[this._transfos.length-1]}push(t,e){const s=e?t.scaleRatio():1;H.multiply(t,this.back(),t),this._transfos.push(t),this._sizeTransfos.push(this._sizeTransfos[this._sizeTransfos.length-1]*s)}pop(){this._transfos.splice(-1,1),this._sizeTransfos.splice(-1,1)}drawSymbol(t,e,s){if(t)switch(t.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":this.drawMultiLayerSymbol(t,e);break;case"CIMTextSymbol":this.drawTextSymbol(t,e,s);break}}drawMultiLayerSymbol(t,e){if(!t||!e)return;const s=t.symbolLayers;if(!s)return;const i=t.effects;if(i&&i.length>0){const n=this.executeEffects(i,e);if(n){let r=n.next();for(;r;)this.drawSymbolLayers(s,r),r=n.next()}}else this.drawSymbolLayers(s,e)}executeEffects(t,e){const s=this._resourceManager.geometryEngine;let i=new ns(e);for(const n of t){const r=os(n);r&&(i=r.execute(i,n,this.geomUnitsPerPoint(),null,s))}return i}drawSymbolLayers(t,e){let s=t.length;for(;s--;){const i=t[s];if(!i||i.enable===!1)continue;const n=i.effects;if(n&&n.length>0){const r=this.executeEffects(n,e);if(r){let a=null;for(;(a=r.next())&&(this.drawSymbolLayer(i,a),!this._earlyReturn););}}else this.drawSymbolLayer(i,e);if(this._earlyReturn)return}}drawSymbolLayer(t,e){switch(t.type){case"CIMSolidFill":this.drawSolidFill(e,t.color);break;case"CIMHatchFill":this.drawHatchFill(e,t);break;case"CIMPictureFill":this.drawPictureFill(e,t);break;case"CIMGradientFill":this.drawGradientFill(e,t);break;case"CIMSolidStroke":this.drawSolidStroke(e,t.color,t.width,t.capStyle,t.joinStyle,t.miterLimit);break;case"CIMPictureStroke":this.drawPictureStroke(e,t);break;case"CIMGradientStroke":this.drawGradientStroke(e,t);break;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":this.drawMarkerLayer(t,e);break}}drawHatchFill(t,e){const s=this._buildHatchPolyline(e,t,this.geomUnitsPerPoint());s&&(this.pushClipPath(t),this.drawMultiLayerSymbol(e.lineSymbol,s),this.popClipPath())}drawPictureFill(t,e){}drawGradientFill(t,e){}drawPictureStroke(t,e){}drawGradientStroke(t,e){}drawMarkerLayer(t,e){const s=t.markerPlacement;if(s){const i=fr(s);if(i){const n=s.type==="CIMMarkerPlacementInsidePolygon"||s.type==="CIMMarkerPlacementPolygonCenter"&&s.clipAtBoundary;n&&this.pushClipPath(e);const r=i.execute(xn(e),s,this.geomUnitsPerPoint(),null,this._resourceManager.geometryEngine);if(r){let a=null;for(;(a=r.next())&&(this.drawMarker(t,a),!this._earlyReturn););}n&&this.popClipPath()}}else{const i=this._placementPool.acquire();if(dt(e))i.tx=e.x,i.ty=e.y,this.drawMarker(t,i);else if(N(e)){const n=Di(e);n&&([i.tx,i.ty]=n,this.drawMarker(t,i))}else for(const n of e.points)if(i.tx=n[0],i.ty=n[1],this.drawMarker(t,i),this._earlyReturn)break;this._placementPool.release(i)}}drawMarker(t,e){switch(t.type){case"CIMCharacterMarker":case"CIMPictureMarker":this.drawPictureMarker(t,e);break;case"CIMVectorMarker":this.drawVectorMarker(t,e);break}}drawPictureMarker(t,e){if(!t)return;const s=this._resourceManager.getResource(t.url),i=S(t.size,ze);if(s==null||i<=0)return;const n=s.width,r=s.height;if(!n||!r)return;const a=n/r,o=S(t.scaleX,1),h=H.createIdentity(),c=t.anchorPoint;if(c){let m=c.x,g=c.y;t.anchorPointUnits!=="Absolute"&&(m*=i*a*o,g*=i),h.translate(-m,-g)}let u=S(t.rotation);t.rotateClockwise&&(u=-u),this._mapRotation&&(u+=this._mapRotation),u&&h.rotate(u*gt);let f=S(t.offsetX),_=S(t.offsetY);if(f||_){if(this._mapRotation){const m=gt*this._mapRotation,g=Math.cos(m),y=Math.sin(m),x=f*g-_*y,M=f*y+_*g;f=x,_=M}h.translate(f,_)}const d=this.geomUnitsPerPoint();d!==1&&h.scale(d,d);const p=e.getAngle();p&&h.rotate(p),h.translate(e.tx,e.ty),this.push(h,!1),this.drawImage(t,i),this.pop()}drawVectorMarker(t,e){if(!t)return;const s=t.markerGraphics;if(!s)return;const i=S(t.size,ze),n=t.frame,r=n?n.ymax-n.ymin:0,a=i&&r?i/r:1,o=H.createIdentity();n&&o.translate(-(n.xmax+n.xmin)*.5,-(n.ymax+n.ymin)*.5);const h=t.anchorPoint;if(h){let p=h.x,m=h.y;t.anchorPointUnits!=="Absolute"?n&&(p*=n.xmax-n.xmin,m*=n.ymax-n.ymin):(p/=a,m/=a),o.translate(-p,-m)}a!==1&&o.scale(a,a);let c=S(t.rotation);t.rotateClockwise&&(c=-c),this._mapRotation&&(c+=this._mapRotation),c&&o.rotate(c*gt);let u=S(t.offsetX),f=S(t.offsetY);if(u||f){if(this._mapRotation){const p=gt*this._mapRotation,m=Math.cos(p),g=Math.sin(p),y=u*m-f*g,x=u*g+f*m;u=y,f=x}o.translate(u,f)}const _=this.geomUnitsPerPoint();_!==1&&o.scale(_,_);const d=e.getAngle();d&&o.rotate(d),o.translate(e.tx,e.ty),this.push(o,t.scaleSymbolsProportionally);for(const p of s)if((!p||!p.symbol||!p.geometry)&&yi.error("Invalid marker graphic",p),this.drawSymbol(p.symbol,p.geometry,p.textString),this._earlyReturn)break;this.pop()}drawTextSymbol(t,e,s){if(!t||!dt(e)||S(t.height,Re)<=0)return;const n=H.createIdentity();let r=S(t.angle);r=-r,r&&n.rotate(r*gt);const a=S(t.offsetX),o=S(t.offsetY);(a||o)&&n.translate(a,o);const h=this.geomUnitsPerPoint();h!==1&&n.scale(h,h),n.translate(e.x,e.y),this.push(n,!1),this.drawText(t,s),this.pop()}_buildHatchPolyline(t,e,s){let i=S(t.separation,ds)*s,n=S(t.rotation);if(i===0)return null;i<0&&(i=-i);let r=0;const a=.5*i;for(;r>a;)r-=i;for(;r<-a;)r+=i;const o=Z();ce(o,e),o[0]-=a,o[1]-=a,o[2]+=a,o[3]+=a;const h=[[o[0],o[1]],[o[0],o[3]],[o[2],o[3]],[o[2],o[1]]];for(;n>180;)n-=180;for(;n<0;)n+=180;const c=Math.cos(n*gt),u=Math.sin(n*gt),f=-i*u,_=i*c,d=S(t.offsetX)*s,p=S(t.offsetY)*s;r=d*u-p*c;let m,g,y,x;m=y=Number.MAX_VALUE,g=x=-Number.MAX_VALUE;for(const C of h){const L=C[0],Y=C[1],U=c*L+u*Y,V=-u*L+c*Y;m=Math.min(m,U),y=Math.min(y,V),g=Math.max(g,U),x=Math.max(x,V)}y=Math.floor(y/i)*i;let P=c*m-u*y-f*r/i,b=u*m+c*y-_*r/i,w=c*g-u*y-f*r/i,I=u*g+c*y-_*r/i;const k=1+Math.round((x-y)/i),T=[];for(let C=0;C<k;C++)P+=f,b+=_,w+=f,I+=_,T.push([[P,b],[w,I]]);return{paths:T}}}class kr extends ps{constructor(t,e){super(t,e),this.reset()}reset(){this._xmin=this._ymin=1/0,this._xmax=this._ymax=-1/0,this._clipCount=0}envelope(){return new _i(this._xmin,this._ymin,this._xmax-this._xmin,this._ymax-this._ymin)}bounds(){return Gi(this._xmin,this._ymin,this._xmax,this._ymax)}drawSolidFill(t){if(!(!t||this._clipCount>0))if(N(t))this._processPath(t.rings,0);else if(z(t))this._processPath(t.paths,0);else if(R(t)){const e=Mt(t);e&&this._processPath(e.rings,0)}else console.error("drawSolidFill Unexpected geometry type!")}drawSolidStroke(t,e,s){if(!t||this._clipCount>0)return;const i=this.transformSize(S(s,xt))*.5;if(N(t))this._processPath(t.rings,i);else if(z(t))this._processPath(t.paths,i);else if(R(t)){const n=Mt(t);n&&this._processPath(n.rings,i)}else console.error("drawSolidStroke unexpected geometry type!")}drawMarkerLayer(t,e){N(e)&&t.markerPlacement&&(t.markerPlacement.type==="CIMMarkerPlacementInsidePolygon"||t.markerPlacement.type==="CIMMarkerPlacementPolygonCenter"&&t.markerPlacement.clipAtBoundary)?this._processPath(e.rings,0):super.drawMarkerLayer(t,e)}drawHatchFill(t,e){this.drawSolidFill(t)}drawPictureFill(t,e){this.drawSolidFill(t)}drawGradientFill(t,e){this.drawSolidFill(t)}drawPictureStroke(t,e){this.drawSolidStroke(t,null,e.width)}drawGradientStroke(t,e){this.drawSolidStroke(t,null,e.width)}pushClipPath(t){this.drawSolidFill(t),this._clipCount++}popClipPath(){this._clipCount--}drawImage(t,e){const{url:s}=t,i=S(t.scaleX,1);let n=i*e,r=e;const a=this._resourceManager.getResource(s);!e&&a!=null&&(n=i*a.width,r=a.height),this._merge(this.transformPt([-n/2,-r/2]),0),this._merge(this.transformPt([-n/2,r/2]),0),this._merge(this.transformPt([n/2,-r/2]),0),this._merge(this.transformPt([n/2,r/2]),0)}drawText(t,e){if(!e||e.length===0)return;this._textRasterizer||(this._textRasterizer=new di);const s=bi(t),[i,n]=this._textRasterizer.computeTextSize(e,s);let r=0;switch(t.horizontalAlignment){case"Left":r=i/2;break;case"Right":r=-i/2;break}let a=0;switch(t.verticalAlignment){case"Bottom":a=n/2;break;case"Top":a=-n/2;break;case"Baseline":a=n/6;break}this._merge(this.transformPt([-i/2+r,-n/2+a]),0),this._merge(this.transformPt([-i/2+r,n/2+a]),0),this._merge(this.transformPt([i/2+r,-n/2+a]),0),this._merge(this.transformPt([i/2+r,n/2+a]),0)}_processPath(t,e){if(t)for(const s of t){const i=s?s.length:0;if(i>1){this._merge(this.transformPt(s[0]),e);for(let n=1;n<i;n++)this._merge(this.transformPt(s[n]),e)}}}_merge(t,e){t[0]-e<this._xmin&&(this._xmin=t[0]-e),t[0]+e>this._xmax&&(this._xmax=t[0]+e),t[1]-e<this._ymin&&(this._ymin=t[1]-e),t[1]+e>this._ymax&&(this._ymax=t[1]+e)}}class Co extends ps{constructor(){super(...arguments),this._searchPoint=[0,0],this._searchDistPoint=0,this._textInfo=null}hitTest(t,e,s,i,n,r){const a=r*Bt(1);this.setTransform(),this.setGeomUnitsPerPoint(a),this._searchPoint=[(t[0]+t[2])/2,(t[1]+t[3])/2],this._searchDistPoint=(t[2]-t[0])/2/a,this._textInfo=i;const o=e&&(e.type==="CIMPointSymbol"&&e.angleAlignment!=="Map"||e.type==="CIMTextSymbol");return this._mapRotation=o?n:0,this._earlyReturn=!1,this.drawSymbol(e,s),this._earlyReturn}drawSolidFill(t,e){this._hitTestFill(t)}drawHatchFill(t,e){this._hitTestFill(t)}drawPictureFill(t,e){this._hitTestFill(t)}drawGradientFill(t,e){this._hitTestFill(t)}drawSolidStroke(t,e,s,i,n,r){this._hitTestStroke(t,s)}drawPictureStroke(t,e){this._hitTestStroke(t,e.width)}drawGradientStroke(t,e){this._hitTestStroke(t,e.width)}drawMarkerLayer(t,e){t.markerPlacement&&(t.markerPlacement.type==="CIMMarkerPlacementInsidePolygon"||t.markerPlacement.type==="CIMMarkerPlacementPolygonCenter"&&t.markerPlacement.clipAtBoundary)?this._hitTestFill(e):super.drawMarkerLayer(t,e)}pushClipPath(t){}popClipPath(){}drawImage(t,e){const{url:s}=t,i=S(t.scaleX,1),n=this._resourceManager.getResource(s);if(n==null||n.height===0||e===0)return;const r=e*this.geomUnitsPerPoint(),a=r*i*(n.width/n.height),o=this.reverseTransformPt(this._searchPoint),h=this._searchDistPoint;Math.abs(o[0])<a/2+h&&Math.abs(o[1])<r/2+h&&(this._earlyReturn=!0)}drawText(t,e){var x,M;const s=this._textInfo;if(!s)return;const i=s.get(t);if(!i)return;const{text:n,mosaicItem:r}=i;if(!((x=r==null?void 0:r.glyphMosaicItems)!=null&&x.length))return;const a=S(t.height,Re),{lineGapType:o,lineGap:h}=t,c=o?Pi(o,S(h),a):0,f=cs(n)[1],_=r.glyphMosaicItems,d=((M=t.callout)==null?void 0:M.type)==="CIMBackgroundCallout",p=gi(_,f,{scale:a/js,angle:0,xOffset:0,yOffset:0,hAlign:xi(t.horizontalAlignment),vAlign:Mi(t.verticalAlignment),maxLineWidth:512,lineHeight:Ks*Math.max(.25,Math.min(c||1,4)),decoration:t.font.decoration||"none",isCIM:!0,hasBackground:d}),m=this.reverseTransformPt(this._searchPoint),g=m[0],y=m[1];for(const P of p.glyphs)if(g>P.xTopLeft&&g<P.xBottomRight&&y>-P.yBottomRight&&y<-P.yTopLeft){this._earlyReturn=!0;break}}_hitTestFill(t){let e=null;if(R(t)){const i=t;e=[[[i.xmin,i.ymin],[i.xmin,i.ymax],[i.xmax,i.ymax],[i.xmax,i.ymin],[i.xmin,i.ymin]]]}else if(N(t))e=t.rings;else if(z(t))e=t.paths;else return;const s=this.reverseTransformPt(this._searchPoint);if(this._pointInPolygon(s,e)&&(this._earlyReturn=!0),!this._earlyReturn){const i=this.reverseTransformSize(this._searchDistPoint)*this.geomUnitsPerPoint();this._nearLine(s,e,i)&&(this._earlyReturn=!0)}}_hitTestStroke(t,e){let s=null;if(R(t)){const a=t;s=[[[a.xmin,a.ymin],[a.xmin,a.ymax],[a.xmax,a.ymax],[a.xmax,a.ymin],[a.xmin,a.ymin]]]}else if(N(t))s=t.rings;else if(z(t))s=t.paths;else return;const i=this.reverseTransformPt(this._searchPoint),n=S(e,xt)*this.geomUnitsPerPoint(),r=this.reverseTransformSize(this._searchDistPoint)*this.geomUnitsPerPoint();this._nearLine(i,s,n/2+r)&&(this._earlyReturn=!0)}_pointInPolygon(t,e){let s=0;for(const i of e){const n=i.length;for(let r=1;r<n;r++){const a=i[r-1],o=i[r];if(a[1]>t[1]==o[1]>t[1])continue;(o[0]-a[0])*(t[1]-a[1])-(o[1]-a[1])*(t[0]-a[0])>0?s++:s--}}return s!==0}_nearLine(t,e,s){for(const i of e){const n=i.length;for(let r=1;r<n;r++){const a=i[r-1],o=i[r];let h=(o[0]-a[0])*(o[0]-a[0])+(o[1]-a[1])*(o[1]-a[1]);if(h===0)continue;h=Math.sqrt(h);const c=((o[0]-a[0])*(t[1]-a[1])-(o[1]-a[1])*(t[0]-a[0]))/h;if(Math.abs(c)<s){const u=((o[0]-a[0])*(t[0]-a[0])+(o[1]-a[1])*(t[1]-a[1]))/h;if(u>-s&&u<h+s)return!0}}}return!1}}class Lr extends ps{constructor(t,e,s,i){super(e,s),this._applyAdditionalRenderProps=i,this._colorSubstitutionHelper=new Mn,this._ctx=t}drawSolidFill(t,e){if(!t)return;if(N(t))this._buildPath(t.rings,!0);else if(z(t))this._buildPath(t.paths,!0);else if(R(t))this._buildPath(Mt(t).rings,!0);else if(Q(t))console.log("CanvasDrawHelper.drawSolidFill - No implementation!");else return;const s=this._ctx;typeof e=="string"?s.fillStyle=e:s.fillStyle="rgba("+Math.round(e[0])+","+Math.round(e[1])+","+Math.round(e[2])+","+(e[3]??255)/255+")",s.fill("evenodd")}drawSolidStroke(t,e,s,i,n,r){if(!t||!e||s===0)return;if(N(t))this._buildPath(t.rings,!0);else if(z(t))this._buildPath(t.paths,!1);else if(R(t))this._buildPath(Mt(t).rings,!0);else{console.log("CanvasDrawHelper.drawSolidStroke isn't implemented!");return}const a=this._ctx;typeof e=="string"?a.strokeStyle=e:a.strokeStyle="rgba("+Math.round(e[0])+","+Math.round(e[1])+","+Math.round(e[2])+","+(e[3]??255)/255+")",a.lineWidth=Math.max(this.transformSize(s),.5),this._setCapStyle(i),this._setJoinStyle(n),a.miterLimit=r,a.stroke()}pushClipPath(t){if(this._ctx.save(),N(t))this._buildPath(t.rings,!0);else if(z(t))this._buildPath(t.paths,!0);else if(R(t))this._buildPath(Mt(t).rings,!0);else return;this._ctx.clip("evenodd")}popClipPath(){this._ctx.restore()}drawImage(t,e){const{colorSubstitutions:s,url:i,tintColor:n}=t,r=S(t.scaleX,1),a=this._resourceManager.getResource(i);if(a==null)return;let o=e*(a.width/a.height),h=e;e||(o=a.width,h=a.height);const c=Ut(i)||"src"in a&&Ut(a.src);let u="getFrame"in a?$e(a):a;s&&(u=this._colorSubstitutionHelper.applyColorSubstituition(u,s)),this._applyAdditionalRenderProps&&!c&&n&&(u=this._colorSubstitutionHelper.tintImageData(u,n));const f=this.transformPt([0,0]),[_,d]=this.getTransformAngle(),p=this.transformSize(1),m=this._ctx;m.save(),m.setTransform({m11:r*p*_,m12:r*p*d,m21:-p*d,m22:p*_,m41:f[0],m42:f[1]}),m.drawImage(u,-o/2,-h/2,o,h),m.restore()}drawText(t,e){if(!e||e.length===0)return;this._textRasterizer||(this._textRasterizer=new di);const s=bi(t);s.size*=this.transformSize(Jt(1));const i=this._textRasterizer.rasterizeText(e,s);if(!i)return;const{size:n,anchorX:r,anchorY:a,canvas:o}=i,h=n[0]*(r+.5),c=n[1]*(a-.5),u=this._ctx,f=this.transformPt([0,0]),[_,d]=this.getTransformAngle(),p=1;u.save(),u.setTransform({m11:p*_,m12:p*d,m21:-p*d,m22:p*_,m41:f[0]-p*h,m42:f[1]+p*c}),u.drawImage(o,0,0),u.restore()}drawPictureFill(t,e){if(!t)return;let{colorSubstitutions:s,height:i,offsetX:n,offsetY:r,rotation:a,scaleX:o,tintColor:h,url:c}=e;const u=this._resourceManager.getResource(c);if(u==null)return;if(N(t))this._buildPath(t.rings,!0);else if(z(t))this._buildPath(t.paths,!0);else if(R(t))this._buildPath(Mt(t).rings,!0);else if(Q(t))console.log("CanvasDrawHelper.drawPictureFill - No implementation!");else return;const f=this._ctx,_=Ut(c)||"src"in u&&Ut(u.src);let d="getFrame"in u?$e(u):u;s&&(d=this._colorSubstitutionHelper.applyColorSubstituition(d,s));let p;if(this._applyAdditionalRenderProps){_||h&&(d=this._colorSubstitutionHelper.tintImageData(d,h)),p=f.createPattern(d,"repeat");const m=this.transformSize(1);a||(a=0),n?n=m*n:n=0,r?r=m*r:r=0,i&&(i=m*i);const g=i?i/u.height:1,y=o&&i?o*i/u.width:1;if(a!==0||g!==1||y!==1||n!==0||r!==0){const x=new DOMMatrix;x.rotateSelf(0,0,-a).translateSelf(n,r).scaleSelf(y,g,1),p.setTransform(x)}}else p=f.createPattern(d,"repeat");f.save(),f.fillStyle=p,f.fill("evenodd"),f.restore()}drawPictureStroke(t,e){if(!t)return;let{colorSubstitutions:s,capStyle:i,joinStyle:n,miterLimit:r,tintColor:a,url:o,width:h}=e;const c=this._resourceManager.getResource(o);if(c==null)return;let u;if(N(t))u=t.rings;else if(z(t))u=t.paths;else if(R(t))u=Mt(t).rings;else if(Q(t)){console.log("CanvasDrawHelper.drawPictureStroke - No implementation!");return}else return;h||(h=c.width);const f=Ut(o)||"src"in c&&Ut(c.src);let _="getFrame"in c?$e(c):c;s&&(_=this._colorSubstitutionHelper.applyColorSubstituition(_,s)),this._applyAdditionalRenderProps&&(f||a&&(_=this._colorSubstitutionHelper.tintImageData(_,a)));const d=Math.max(this.transformSize(Bt(h)),.5),p=_.width,m=d/p,g=this._ctx,y=g.createPattern(_,"repeat-y");g.save(),this._setCapStyle(i),this._setJoinStyle(n),r!==void 0&&(g.miterLimit=r),g.lineWidth=d;let x,M;for(let P of u)if(P=G(P),Ar(P),!(!P||P.length<=1)){x=this.transformPt(P[0]);for(let b=1;b<P.length;b++){M=this.transformPt(P[b]);const w=vr(x,M),I=new DOMMatrix;I.translateSelf(0,x[1]-d/2).scaleSelf(m,m,1).rotateSelf(0,0,90-w),y.setTransform(I),g.strokeStyle=y,g.beginPath(),g.moveTo(x[0],x[1]),g.lineTo(M[0],M[1]),g.stroke(),x=M}}g.restore()}_buildPath(t,e){const s=this._ctx;if(s.beginPath(),t)for(const i of t){const n=i?i.length:0;if(n>1){let r=this.transformPt(i[0]);s.moveTo(r[0],r[1]);for(let a=1;a<n;a++)r=this.transformPt(i[a]),s.lineTo(r[0],r[1]);e&&s.closePath()}}}_setCapStyle(t){switch(t){case rt.Butt:this._ctx.lineCap="butt";break;case rt.Round:this._ctx.lineCap="round";break;case rt.Square:this._ctx.lineCap="square";break}}_setJoinStyle(t){switch(t){case ot.Bevel:this._ctx.lineJoin="bevel";break;case ot.Round:this._ctx.lineJoin="round";break;case ot.Miter:this._ctx.lineJoin="miter";break}}}function vr(l,t){const e=t[0]-l[0],s=t[1]-l[1];return 180/Math.PI*Math.atan2(s,e)}const Mt=l=>l?{spatialReference:l.spatialReference,rings:[[[l.xmin,l.ymin],[l.xmin,l.ymax],[l.xmax,l.ymax],[l.xmax,l.ymin],[l.xmin,l.ymin]]]}:null,xi=l=>{switch(l){case"Left":return Pe.Left;case"Right":return Pe.Right;case"Center":return Pe.Center;case"Justify":return yi.warnOnce("Horizontal alignment 'justify' is not implemented. Falling back to 'center'."),Pe.Center}},Mi=l=>{switch(l){case"Top":return ae.Top;case"Center":return ae.Center;case"Bottom":return ae.Bottom;case"Baseline":return ae.Baseline}},Pi=(l,t,e)=>{switch(l){case"ExtraLeading":return 1+t/e;case"Multiple":return t;case"Exact":return t/e}};function bi(l,t=1){const e=ni(l),s=ii(l.fontStyleName),i=us(l.fontFamilyName),{weight:n,style:r}=s,a=t*(l.height||5),o=ri(l.horizontalAlignment),h=oi(l.verticalAlignment),c=jt(l),u=Kt(l.haloSymbol),f=u?t*(l.haloSize|0):0;return{color:c,size:a,horizontalAlignment:o,verticalAlignment:h,font:{family:i,style:hn(r),weight:cn(n),decoration:e},halo:{size:f||0,color:u,style:r},pixelRatio:1,premultiplyColors:!0}}const Tr=1e-4;function Ar(l){let t=l[0],e=1,s,i,n,r,a;for(;e<l.length;)s=l[e][0]-t[0],i=l[e][1]-t[1],r=s!==0?i/s:Math.PI/2,n!==void 0&&r-n<=Tr?(l.splice(e-1,1),t=a):(a=t,t=l[e],e++),n=r}function $t(l,t,e,s,i){if(l==null)return null;const r=l.referencesGeometry()&&i?Er(t,s,i):t,a=l.repurposeFeature(r);try{return l.evaluate({...e,$feature:a})}catch(o){return ue.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",o),null}}const Je=new Map;function Er(l,t,e){const{transform:s,hasZ:i,hasM:n}=e;Je.has(t)||Je.set(t,Nr(t));const r=Je.get(t)(l.geometry,s,i,n);return{...l,geometry:r}}function Nr(l){const t={};switch(l){case"esriGeometryPoint":return(e,s,i,n)=>en(s,t,e,i,n);case"esriGeometryPolygon":return(e,s,i,n)=>tn(s,t,e,i,n);case"esriGeometryPolyline":return(e,s,i,n)=>Qi(s,t,e,i,n);case"esriGeometryMultipoint":return(e,s,i,n)=>Zi(s,t,e,i,n);default:return ue.getLogger("esri.views.2d.support.arcadeOnDemand").error(new Hi("mapview-arcade",`Unable to handle geometryType: ${l}`)),e=>e}}const Si=Math.PI,zr=Si/2,Es=Math.PI/180,st=96/72,Ns=4,ls=ue.getLogger("esri.symbols.cim.CIMSymbolHelper");function Io(l){if(!l||!l.type)return null;let t;switch(l.type){case"cim":return l.data;case"web-style":return l;case"simple-marker":{const e=j.fromSimpleMarker(l);if(!e)return null;t=e;break}case"picture-marker":t=j.fromPictureMarker(l);break;case"simple-line":t=j.fromSimpleLineSymbol(l);break;case"simple-fill":t=j.fromSimpleFillSymbol(l);break;case"picture-fill":t=j.fromPictureFillSymbol(l);break;case"text":t=j.fromTextSymbol(l)}return{type:"CIMSymbolReference",symbol:t}}function Ae(l,t,e){switch(t.type){case"CIMSymbolReference":return Ae(l,t.symbol,e);case"CIMPointSymbol":{e==null&&(e={x:0,y:0}),l.drawSymbol(t,e);break}case"CIMLineSymbol":{e==null&&(e={paths:[[[0,0],[10,0]]]}),l.drawSymbol(t,e);break}case"CIMPolygonSymbol":{e==null&&(e={rings:[[[0,0],[0,10],[10,10],[10,0],[0,0]]]}),l.drawSymbol(t,e);break}case"CIMTextSymbol":{const s={x:0,y:0};l.drawSymbol(t,s);break}case"CIMVectorMarker":{const s=new Qt;l.drawMarker(t,s);break}}return l.envelope()}function Or(l){if(!l)return 0;switch(l.type){case"CIMMarkerPlacementAlongLineSameSize":return Math.abs(l.offset);case"CIMMarkerPlacementAlongLineRandomSize":return Math.abs(l.offset);case"CIMMarkerPlacementAtExtremities":return Math.abs(l.offset);case"CIMMarkerPlacementAtMeasuredUnits":return Math.abs(l.offset);case"CIMMarkerPlacementAtRatioPositions":return Math.abs(l.offset);case"CIMMarkerPlacementInsidePolygon":return 0;case"CIMMarkerPlacementOnLine":return Math.abs(l.offset);case"CIMMarkerPlacementOnVertices":return Math.abs(l.offset);case"CIMMarkerPlacementPolygonCenter":return 0;default:return 0}}function Fr(l){if(!l)return 0;switch(l.type){case"CIMGeometricEffectArrow":return Math.abs(l.width*.5);case"CIMGeometricEffectBuffer":return Math.abs(l.size);case"CIMGeometricEffectExtension":return Math.abs(l.length);case"CIMGeometricEffectJog":return Math.abs(l.length*.5);case"CIMGeometricEffectMove":return Math.max(Math.abs(S(l.offsetX)),Math.abs(S(l.offsetY)));case"CIMGeometricEffectOffset":return Math.abs(l.offset);case"CIMGeometricEffectOffsetTangent":return Math.abs(l.offset);case"CIMGeometricEffectRadial":return Math.abs(l.length);case"CIMGeometricEffectRegularPolygon":return Math.abs(l.radius);case"CIMGeometricEffectRotate":return 0;case"CIMGeometricEffectScale":return 0;case"CIMGeometricEffectTaperedPolygon":return Math.max(Math.abs(l.fromWidth),Math.abs(l.toWidth))*.5;case"CIMGeometricEffectWave":return Math.abs(l.amplitude);default:return 0}}function zs(l){if(!l)return 0;let t=0;for(const e of l)t+=Fr(e);return t}class ko{getSymbolInflateSize(t,e,s,i,n){return t||(t=[0,0,0,0]),e?this._getInflateSize(t,e,s,i,n):t}static safeSize(t){const e=Math.max(Math.abs(t[0]),Math.abs(t[2])),s=Math.max(Math.abs(t[1]),Math.abs(t[3]));return Math.sqrt(e*e+s*s)}_vectorMarkerBounds(t,e,s,i){let n=!0;const r=Z();if(e&&e.markerGraphics)for(const a of e.markerGraphics){const o=[0,0,0,0];a.geometry&&(ce(r,a.geometry),o[0]=0,o[1]=0,o[2]=0,o[3]=0,this.getSymbolInflateSize(o,a.symbol,s,0,i),r[0]+=o[0],r[1]+=o[1],r[2]+=o[2],r[3]+=o[3],n?(t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],n=!1):(t[0]=Math.min(t[0],r[0]),t[1]=Math.min(t[1],r[1]),t[2]=Math.max(t[2],r[2]),t[3]=Math.max(t[3],r[3])))}return t}_getInflateSize(t,e,s,i,n){if(Yr(e)){const r=this._getLayersInflateSize(t,e.symbolLayers,s,i,n),a=zs(e.effects);return a>0&&(r[0]-=a,r[1]-=a,r[2]+=a,r[3]+=a),r}return this._getTextInflatedSize(t,e,n)}_getLayersInflateSize(t,e,s,i,n){let r=!0;if(!e)return t;for(const a of e){if(!a)continue;let o=[0,0,0,0];switch(a.type){case"CIMSolidFill":case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":break;case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":{const c=a;let u=c.width;u!=null&&(c.capStyle===rt.Square||c.joinStyle===ot.Miter?u/=1.4142135623730951:u/=2,o[0]=-u,o[1]=-u,o[2]=u,o[3]=u);break}case"CIMCharacterMarker":case"CIMVectorMarker":case"CIMPictureMarker":{const c=a;if(a.type==="CIMVectorMarker"){const p=a;if(o=this._vectorMarkerBounds(o,p,s,n),p.frame){const m=(p.frame.xmin+p.frame.xmax)/2,g=(p.frame.ymin+p.frame.ymax)/2;if(o[0]-=m,o[1]-=g,o[2]-=m,o[3]-=g,p.size!=null){const y=p.size/(p.frame.ymax-p.frame.ymin);o[0]*=y,o[1]*=y,o[2]*=y,o[3]*=y}}}else if(a.type==="CIMPictureMarker"){const p=a,m=s.getResource(p.url);let g=1;if(m!=null&&m.height&&(g=m.width/m.height),c.size!=null){const y=c.size/2,x=c.size*g*p.scaleX/2;o=[-x,-y,x,y]}}else if(c.size!=null){const p=c.size/2;o=[-p,-p,p,p]}if(c.anchorPoint){let p,m;c.anchorPointUnits==="Absolute"?(p=c.anchorPoint.x,m=c.anchorPoint.y):(p=c.anchorPoint.x*(o[2]-o[0]),m=c.anchorPoint.y*(o[3]-o[1])),o[0]-=p,o[1]-=m,o[2]-=p,o[3]-=m}let u=S(c.rotation);if(c.rotateClockwise&&(u=-u),i&&(u-=i),u){const p=Es*u,m=Math.cos(p),g=Math.sin(p),y=Z([ye,ye,-ye,-ye]);ge(y,[o[0]*m-o[1]*g,o[0]*g+o[1]*m]),ge(y,[o[0]*m-o[3]*g,o[0]*g+o[3]*m]),ge(y,[o[2]*m-o[1]*g,o[2]*g+o[1]*m]),ge(y,[o[2]*m-o[3]*g,o[2]*g+o[3]*m]),o=y}let f=S(c.offsetX),_=S(c.offsetY);if(i){const p=Es*i,m=Math.cos(p),g=Math.sin(p),y=f*m-_*g,x=f*g+_*m;f=y,_=x}o[0]+=f,o[1]+=_,o[2]+=f,o[3]+=_;const d=Or(c.markerPlacement);d>0&&(o[0]-=d,o[1]-=d,o[2]+=d,o[3]+=d);break}}const h=zs(a.effects);h>0&&(o[0]-=h,o[1]-=h,o[2]+=h,o[3]+=h),r?(t[0]=o[0],t[1]=o[1],t[2]=o[2],t[3]=o[3],r=!1):(t[0]=Math.min(t[0],o[0]),t[1]=Math.min(t[1],o[1]),t[2]=Math.max(t[2],o[2]),t[3]=Math.max(t[3],o[3]))}return t}_getTextInflatedSize(t,e,s){var g,y;const i=e.height??Re;if(t[0]=-i/2,t[1]=-i/2,t[2]=i/2,t[3]=i/2,!s)return t;const n=s.get(e);if(!n)return t;const{text:r,mosaicItem:a}=n;if(!((g=a==null?void 0:a.glyphMosaicItems)!=null&&g.length))return t;const{lineGapType:o,lineGap:h}=e,c=o?Pi(o,h??0,i):0,f=cs(r)[1],_=a.glyphMosaicItems,d=((y=e.callout)==null?void 0:y.type)==="CIMBackgroundCallout",m=gi(_,f,{scale:i/js,angle:S(e.angle),xOffset:S(e.offsetX),yOffset:S(e.offsetY),hAlign:xi(e.horizontalAlignment),vAlign:Mi(e.verticalAlignment),maxLineWidth:512,lineHeight:Ks*Math.max(.25,Math.min(c||1,4)),decoration:e.font.decoration||"none",isCIM:!0,hasBackground:d}).boundsT;return t[0]=m.x-m.halfWidth,t[1]=-m.y-m.halfHeight,t[2]=m.x+m.halfWidth,t[3]=-m.y+m.halfHeight,t}}class j{static getEnvelope(t,e,s){if(!t)return null;const i=new kr(s);if(Array.isArray(t)){let n;for(const r of t)n?n.union(Ae(i,r,e)):n=Ae(i,r,e);return n}return Ae(i,t,e)}static getTextureAnchor(t,e){const s=this.getEnvelope(t,null,e);if(!s)return[0,0,0];const i=(s.x+s.width*.5)*st,n=(s.y+s.height*.5)*st,r=s.width*st+2,a=s.height*st+2;return[-i/r,-n/a,a]}static rasterize(t,e,s,i,n=!0){const r=s||this.getEnvelope(e,null,i);if(!r)return[null,0,0,0,0];const a=(r.x+r.width*.5)*st,o=(r.y+r.height*.5)*st;t.width=r.width*st,t.height=r.height*st,s||(t.width+=2,t.height+=2);const h=t.getContext("2d"),c=H.createScale(st,-st);c.translate(t.width*.5-a,t.height*.5+o);const u=new Lr(h,i,c);switch(e.type){case"CIMPointSymbol":{const d={type:"point",x:0,y:0};u.drawSymbol(e,d);break}case"CIMVectorMarker":{const d=new Qt;u.drawMarker(e,d);break}}const f=h.getImageData(0,0,t.width,t.height),_=new Uint8Array(f.data);if(n){let d;for(let p=0;p<_.length;p+=4)d=_[p+3]/255,_[p]=_[p]*d,_[p+1]=_[p+1]*d,_[p+2]=_[p+2]*d}return[_,t.width,t.height,-a/t.width,-o/t.height]}static fromTextSymbol(t){const{angle:e,color:s,font:i,haloColor:n,haloSize:r,horizontalAlignment:a,kerning:o,text:h,verticalAlignment:c,xoffset:u,yoffset:f,backgroundColor:_,borderLineColor:d,borderLineSize:p}=t;let m,g,y,x,M,P;i&&(m=i.family,g=i.style,y=i.weight,x=i.size,M=i.decoration);let b=!1;return h&&(b=cs(h)[1]),(_||p)&&(P={type:"CIMBackgroundCallout",margin:null,backgroundSymbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",color:B(_)},{type:"CIMSolidStroke",color:B(d),width:p}]},accentBarSymbol:null,gap:null,leaderLineSymbol:null,lineStyle:null}),{type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,anchorPointUnits:"Relative",dominantSizeAxis3D:"Y",size:10,billboardMode3D:"FaceNearPlane",frame:{xmin:-5,ymin:-5,xmax:5,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{x:0,y:0},symbol:{type:"CIMTextSymbol",angle:e,blockProgression:Yi.BTT,depth3D:1,extrapolateBaselines:!0,fontEffects:Vi.Normal,fontEncoding:Bi.Unicode,fontFamilyName:m||"Arial",fontStyleName:Dr(g,y),fontType:Wi.Unspecified,haloSize:r,height:x,hinting:Ui.Default,horizontalAlignment:Gr(a??"center"),kerning:o,letterWidth:100,ligatures:!0,lineGapType:"Multiple",offsetX:S(u),offsetY:S(f),strikethrough:M==="line-through",underline:M==="underline",symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:B(s)}]},haloSymbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:B(n)}]},shadowColor:[0,0,0,255],shadowOffsetX:1,shadowOffsetY:1,textCase:"Normal",textDirection:b?xs.RTL:xs.LTR,verticalAlignment:Rr(c??"baseline"),verticalGlyphOrientation:qi.Right,wordSpacing:100,billboardMode3D:$i.FaceNearPlane,callout:P},textString:h}],scaleSymbolsProportionally:!0,respectFrame:!0}],scaleX:1,angleAlignment:"Display"}}static fromPictureFillSymbol(t){const{height:e,outline:s,width:i,xoffset:n,xscale:r,yoffset:a,yscale:o}=t,h=[],c={type:"CIMPolygonSymbol",symbolLayers:h};if(s){const{cap:p,join:m,miterLimit:g,width:y}=s;h.push({type:"CIMSolidStroke",color:B(s.color),capStyle:je(p),joinStyle:Ke(m),miterLimit:g,width:y})}let u=t.url;t.type==="esriPFS"&&t.imageData&&(u=t.imageData);const f="angle"in t?t.angle??0:0,_=(i??0)*(r||1),d=(e??0)*(o||1);return h.push({type:"CIMPictureFill",invertBackfaceTexture:!1,scaleX:1,textureFilter:Ms.Picture,tintColor:null,url:u,height:d,width:_,offsetX:S(n),offsetY:S(a),rotation:S(-f),colorSubstitutions:null}),c}static fromSimpleFillSymbol(t){const{color:e,style:s,outline:i}=t,n=[],r={type:"CIMPolygonSymbol",symbolLayers:n};let a=null;if(i){const{cap:o,join:h,style:c}=i;c!=="solid"&&c!=="none"&&c!=="esriSLSSolid"&&c!=="esriSLSNull"&&(a=[{type:"CIMGeometricEffectDashes",dashTemplate:Os(c,o),lineDashEnding:"NoConstraint",scaleDash:!0,offsetAlongLine:null}]),n.push({type:"CIMSolidStroke",color:B(i.color),capStyle:je(o),joinStyle:Ke(h),miterLimit:i.miterLimit,width:i.width,effects:a})}if(s&&s!=="solid"&&s!=="none"&&s!=="esriSFSSolid"&&s!=="esriSFSNull"){const o={type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",color:B(e),capStyle:rt.Butt,joinStyle:ot.Miter,width:.75}]};let h=0;const c=Jt(Vr(s)?8:10);switch(s){case"vertical":case"esriSFSVertical":h=90;break;case"forward-diagonal":case"esriSFSForwardDiagonal":h=-45;break;case"backward-diagonal":case"esriSFSBackwardDiagonal":h=45;break;case"cross":case"esriSFSCross":h=0;break;case"diagonal-cross":case"esriSFSDiagonalCross":h=-45;break}n.push({type:"CIMHatchFill",lineSymbol:o,offsetX:0,offsetY:0,rotation:h,separation:c}),s==="cross"||s==="esriSFSCross"?n.push({type:"CIMHatchFill",lineSymbol:G(o),offsetX:0,offsetY:0,rotation:90,separation:c}):(s==="diagonal-cross"||s==="esriSFSDiagonalCross")&&n.push({type:"CIMHatchFill",lineSymbol:G(o),offsetX:0,offsetY:0,rotation:45,separation:c})}else s&&(s==="solid"||s==="esriSFSSolid")&&n.push({type:"CIMSolidFill",enable:!0,color:B(e)});return r}static fromSimpleLineSymbol(t){const{cap:e,color:s,join:i,marker:n,miterLimit:r,style:a,width:o}=t,h=a!=="solid"&&a!=="none"&&a!=="esriSLSSolid"&&a!=="esriSLSNull";let c=null;h&&(c=[{type:"CIMGeometricEffectDashes",dashTemplate:Os(a,e),lineDashEnding:"NoConstraint",scaleDash:!0,offsetAlongLine:null}]);const u=[];if(n){let f;switch(n.placement){case"begin-end":f=ft.Both;break;case"begin":f=ft.JustBegin;break;case"end":f=ft.JustEnd;break;default:f=ft.None}const _=j.fromSimpleMarker(n,o,s).symbolLayers[0];_.markerPlacement={type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:f,offsetAlongLine:0},u.push(_)}return a!=="none"&&a!=="esriSLSNull"&&u.push({type:"CIMSolidStroke",color:B(s),capStyle:je(e),joinStyle:Ke(i),miterLimit:r,width:o,effects:c}),{type:"CIMLineSymbol",symbolLayers:u}}static fromPictureMarker(t){const{angle:e,height:s,width:i,xoffset:n,yoffset:r}=t;let a=t.url;return t.type==="esriPMS"&&t.imageData&&(a=t.imageData),{type:"CIMPointSymbol",symbolLayers:[{type:"CIMPictureMarker",invertBackfaceTexture:!1,scaleX:1,textureFilter:Ms.Picture,tintColor:null,url:a,size:s,width:i,offsetX:S(n),offsetY:S(r),rotation:S(-e)}]}}static fromSimpleMarker(t,e,s){const{style:i}=t,n=t.color??s;if(i==="path"){const h=[];if("outline"in t&&t.outline){const f=t.outline;h.push({type:"CIMSolidStroke",enable:!0,width:Bt(Math.round(Jt(f.width))),color:B(f.color)})}h.push({type:"CIMSolidFill",enable:!0,color:B(n),path:t.path});const[c,u]=Fs("square");return{type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,rotation:S(-t.angle),size:S(t.size||6),offsetX:S(t.xoffset),offsetY:S(t.yoffset),frame:c,markerGraphics:[{type:"CIMMarkerGraphic",geometry:u,symbol:{type:"CIMPolygonSymbol",symbolLayers:h}}]}]}}const[r,a]=Fs(i);let o;if(a&&r){const h=[];if("outline"in t&&t.outline){const u=t.outline;h.push({type:"CIMSolidStroke",enable:!0,width:u.width!=null&&u.width>.667?Bt(Math.round(Jt(u.width))):u.width,color:B(u.color)})}else e&&t.type==="line-marker"&&(t.style==="cross"||t.style==="x")&&h.push({type:"CIMSolidStroke",enable:!0,width:e,color:B(n)});h.push({type:"CIMSolidFill",enable:!0,color:B(n)});const c={type:"CIMPolygonSymbol",symbolLayers:h};o={type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,rotation:S(-t.angle),size:S(t.size||e*6),offsetX:S(t.xoffset),offsetY:S(t.yoffset),frame:r,markerGraphics:[{type:"CIMMarkerGraphic",geometry:a,symbol:c}]}]}}return o}static fromCIMHatchFill(t,e){var c;const s=e*(t.separation??ds),i=s/2,n=G(t.lineSymbol);(c=n.symbolLayers)==null||c.forEach(u=>{var f;switch(u.type){case"CIMSolidStroke":{u.width!=null&&(u.width*=e),(f=u.effects)==null||f.forEach(_=>{_.type==="CIMGeometricEffectDashes"&&(_.dashTemplate=_.dashTemplate.map(d=>d*e))});break}case"CIMVectorMarker":{u.size!=null&&(u.size*=e);const _=u.markerPlacement;_!=null&&"placementTemplate"in _&&(_.placementTemplate=_.placementTemplate.map(d=>d*e));break}}});let r=this._getLineSymbolPeriod(n)||Ns;for(;r<Ns;)r*=2;const a=r/2,o={xmin:-a,xmax:a,ymin:-i,ymax:i},h={type:"CIMMarkerGraphic",geometry:{paths:[[[-a,0],[a,0]]]},symbol:n};return{type:"CIMVectorMarker",frame:o,markerGraphics:[h],size:s}}static fetchResources(t,e,s){if(!(!t||!e))switch(t.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":{const i=t.symbolLayers;if(!i)return;for(const n of i)switch(Wr(n,e,s),n.type){case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMCharacterMarker":case"CIMPictureMarker":"url"in n&&n.url&&s.push(e.fetchResource(n.url,null));break;case"CIMVectorMarker":{const a=n.markerGraphics;if(!a)continue;for(const o of a)if(o){const h=o.symbol;h&&j.fetchResources(h,e,s)}}}}}}static _getLineSymbolPeriod(t){if(t){const e=this._getEffectsRepeat(t.effects);if(e)return e;if(t.symbolLayers){for(const s of t.symbolLayers)if(s){const i=this._getEffectsRepeat(s.effects);if(i)return i;switch(s.type){case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":case"CIMObjectMarker3D":case"CIMglTFMarker3D":{const n=this._getPlacementRepeat(s.markerPlacement);if(n)return n}}}}}return 0}static _getEffectsRepeat(t){if(t){for(const e of t)if(e)switch(e.type){case"CIMGeometricEffectDashes":{const s=e.dashTemplate;if(s&&s.length){let i=0;for(const n of s)i+=n;return s.length&1&&(i*=2),i}break}case"CIMGeometricEffectWave":return e.period;default:ls.error(`unsupported geometric effect type ${e.type}`)}}return 0}static _getPlacementRepeat(t){if(t)switch(t.type){case"CIMMarkerPlacementAlongLineSameSize":case"CIMMarkerPlacementAlongLineRandomSize":case"CIMMarkerPlacementAlongLineVariableSize":{const e=t.placementTemplate;if(e&&e.length){let s=0;for(const i of e)s+=+i;return e.length&1&&(s*=2),s}break}}return 0}static fromCIMInsidePolygon(t){const e=t.markerPlacement,s={...t};s.markerPlacement=null,s.anchorPoint=null;const i=Math.abs(e.stepX),n=Math.abs(e.stepY),r=(e.randomness??100)/100;let a,o,h,c;if(e.gridType==="Random"){const _=Jt(Zs),d=Math.max(Math.floor(_/i),1),p=Math.max(Math.floor(_/n),1);a=d*i/2,o=p*n/2,h=o*2;const m=new Vs(e.seed),g=r*i/1.5,y=r*n/1.5;c=[];for(let x=0;x<d;x++)for(let M=0;M<p;M++){const P=x*i-a+g*(.5-m.getFloat()),b=M*n-o+y*(.5-m.getFloat());c.push({x:P,y:b}),x===0&&c.push({x:P+a*2,y:b}),M===0&&c.push({x:P,y:b+o*2})}}else e.shiftOddRows===!0?(a=i/2,o=n,h=n*2,c=[{x:-a,y:0},{x:a,y:0},{x:0,y:o},{x:0,y:-o}]):(a=i/2,o=n/2,h=n,c=[{x:-i,y:0},{x:0,y:-n},{x:-i,y:-n},{x:0,y:0},{x:i,y:0},{x:0,y:n},{x:i,y:n},{x:-i,y:n},{x:i,y:-n}]);const u=c.map(_=>({type:"CIMMarkerGraphic",geometry:_,symbol:{type:"CIMPointSymbol",symbolLayers:[s]}}));return{type:"CIMVectorMarker",frame:{xmin:-a,xmax:a,ymin:-o,ymax:o},markerGraphics:u,size:h}}static getSize(t){if(t)switch(t.type){case"CIMTextSymbol":return t.height;case"CIMPointSymbol":{let e=0;if(t.symbolLayers){for(const s of t.symbolLayers)if(s)switch(s.type){case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":case"CIMObjectMarker3D":case"CIMglTFMarker3D":{const i=s.size;i!=null&&i>e&&(e=i);break}}}return e}case"CIMLineSymbol":case"CIMPolygonSymbol":{let e=0;if(t.symbolLayers){for(const s of t.symbolLayers)if(s)switch(s.type){case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":{const i=s.width;i!=null&&i>e&&(e=i);break}case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":case"CIMObjectMarker3D":case"CIMglTFMarker3D":{if(s.markerPlacement&&on(s.markerPlacement)){const i=s.size;i!=null&&i>e&&(e=i)}break}}}return e}}}static getMarkerScaleRatio(t){if(t)switch(t.type){case"CIMVectorMarker":if(t.scaleSymbolsProportionally!==!1&&t.frame&&t.size!=null){const e=t.frame.ymax-t.frame.ymin;return t.size/e}break}return 1}}class E{static findApplicableOverrides(t,e,s){if(!(!t||!e)){if(t.primitiveName){let i=!1;for(const n of s)if(n.primitiveName===t.primitiveName){i=!0;break}if(!i)for(const n of e)n.primitiveName===t.primitiveName&&s.push(n)}switch(t.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(t.effects)for(const i of t.effects)E.findApplicableOverrides(i,e,s);if(t.symbolLayers)for(const i of t.symbolLayers)E.findApplicableOverrides(i,e,s);break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMSolidFill":case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMVectorMarker":case"CIMCharacterMarker":case"CIMPictureMarker":if(t.effects)for(const i of t.effects)E.findApplicableOverrides(i,e,s);if(t.markerPlacement&&E.findApplicableOverrides(t.markerPlacement,e,s),t.type==="CIMVectorMarker"){if(t.markerGraphics)for(const i of t.markerGraphics)E.findApplicableOverrides(i,e,s),E.findApplicableOverrides(i.symbol,e,s)}else t.type==="CIMCharacterMarker"?E.findApplicableOverrides(t.symbol,e,s):t.type==="CIMHatchFill"?E.findApplicableOverrides(t.lineSymbol,e,s):t.type==="CIMPictureMarker"&&E.findApplicableOverrides(t.animatedSymbolProperties,e,s);break}}}static findEffectOverrides(t,e,s){if(!e||!t)return;const i=t.length;for(let n=0;n<i;n++){const r=t[n],a=r==null?void 0:r.primitiveName;if(a){let o=!1;for(const h of s)if(h.primitiveName===a){o=!0;break}if(!o)for(const h of e)h.primitiveName===a&&s.push(h)}}}static async resolveSymbolOverrides(t,e,s,i,n,r,a){if(!t||!t.symbol)return null;let{symbol:o,primitiveOverrides:h}=t;const c=!!h;if(!c&&!i)return o;o=G(o);let u=!0;if(e||(e={attributes:{}},u=!1),c){if(u||(h=h.filter(f=>{var _;return!((_=f.valueExpressionInfo)!=null&&_.expression.includes("$feature"))})),a||(h=h.filter(f=>{var _;return!((_=f.valueExpressionInfo)!=null&&_.expression.includes("$view"))})),h.length>0){const f=un(e.attributes);await E.evaluateOverrides(h,e,{spatialReference:s,fields:f,geometryType:n},r,a)}E.applyOverrides(o,h)}return i&&E.applyDictionaryTextOverrides(o,e,i),o}static async evaluateOverrides(t,e,s,i,n){if(!e)return;let r;for(const a of t){const o=a.valueExpressionInfo;if(o&&s&&s.geometryType){r||(r=[]),a.value=void 0;const h=Us(o.expression,s.spatialReference,s.fields).then(c=>{a.value=$t(c,e,{$view:n},s.geometryType,i)});r.push(h)}}r!==void 0&&r.length>0&&await Promise.all(r)}static applyDictionaryTextOverrides(t,e,s,i="Normal"){if(!(!t||!t.type))switch(t.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":case"CIMTextSymbol":{const n=t.symbolLayers;if(!n)return;for(const r of n)r&&r.type==="CIMVectorMarker"&&E.applyDictionaryTextOverrides(r,e,s,t.type==="CIMTextSymbol"?t.textCase:i)}break;case"CIMVectorMarker":{const n=t.markerGraphics;if(!n)return;for(const r of n)r&&E.applyDictionaryTextOverrides(r,e,s)}break;case"CIMMarkerGraphic":{const n=t.textString;if(n&&n.includes("[")){const r=ti(n,s);t.textString=ei(e,r,i)}}break}}static applyOverrides(t,e,s,i){if(t.primitiveName){for(const n of e)if(n.primitiveName===t.primitiveName){const r=Br(n.propertyName);if(i&&i.push({cim:t,nocapPropertyName:r,value:t[r]}),n.expression&&(n.value=E.toValue(n.propertyName,n.expression)),s){let a=!1;for(const o of s)o.primitiveName===t.primitiveName&&(a=!0);a||s.push(n)}n.value!=null&&(t[r]=n.value)}}switch(t.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(t.effects)for(const n of t.effects)E.applyOverrides(n,e,s,i);if(t.symbolLayers)for(const n of t.symbolLayers)E.applyOverrides(n,e,s,i);break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMSolidFill":case"CIMVectorMarker":if(t.effects)for(const n of t.effects)E.applyOverrides(n,e,s,i);if(t.type==="CIMVectorMarker"&&t.markerGraphics)for(const n of t.markerGraphics)E.applyOverrides(n,e,s,i),E.applyOverrides(n.symbol,e,s,i);break}}static restoreOverrides(t){for(const e of t)e.cim[e.nocapPropertyName]=e.value}static buildOverrideKey(t){let e="";for(const s of t)s.value!==void 0&&(e+=`${s.primitiveName}${s.propertyName}${JSON.stringify(s.value)}`);return e}static toValue(t,e){if(t==="DashTemplate")return e.split(" ").map(s=>Number(s));if(t==="Color"){const s=new qs(e).toRgba();return s[3]*=255,s}return e}}const je=l=>{if(!l)return rt.Butt;switch(l){case"butt":return rt.Butt;case"square":return rt.Square;case"round":return rt.Round}},Ke=l=>{if(!l)return ot.Miter;switch(l){case"miter":return ot.Miter;case"round":return ot.Round;case"bevel":return ot.Bevel}},Gr=l=>{if(l==null)return"Center";switch(l){case"left":return"Left";case"right":return"Right";case"center":return"Center"}},Rr=l=>{if(l==null)return"Center";switch(l){case"baseline":return"Baseline";case"top":return"Top";case"middle":return"Center";case"bottom":return"Bottom"}},B=l=>{if(!l)return[0,0,0,0];const{r:t,g:e,b:s,a:i}=l;return[t,e,s,i*255]},Dr=(l,t)=>{const e=Hr(t),s=Xr(l);return e&&s?`${e}-${s}`:`${e}${s}`},Hr=l=>{if(!l)return"";switch(l.toLowerCase()){case"bold":case"bolder":return"bold"}return""},Xr=l=>{if(!l)return"";switch(l.toLowerCase()){case"italic":case"oblique":return"italic"}return""},Os=(l,t)=>{const e=t==="butt";switch(l){case"dash":case"esriSLSDash":return e?[4,3]:[3,4];case"dash-dot":case"esriSLSDashDot":return e?[4,3,1,3]:[3,4,0,4];case"dot":case"esriSLSDot":return e?[1,3]:[0,4];case"long-dash":case"esriSLSLongDash":return e?[8,3]:[7,4];case"long-dash-dot":case"esriSLSLongDashDot":return e?[8,3,1,3]:[7,4,0,4];case"long-dash-dot-dot":case"esriSLSDashDotDot":return e?[8,3,1,3,1,3]:[7,4,0,4,0,4];case"short-dash":case"esriSLSShortDash":return e?[4,1]:[3,2];case"short-dash-dot":case"esriSLSShortDashDot":return e?[4,1,1,1]:[3,2,0,2];case"short-dash-dot-dot":case"esriSLSShortDashDotDot":return e?[4,1,1,1,1,1]:[3,2,0,2,0,2];case"short-dot":case"esriSLSShortDot":return e?[1,1]:[0,2];case"solid":case"esriSLSSolid":case"none":return ls.error("Unexpected: style does not require rasterization"),[0,0];default:return ls.error(`Tried to rasterize SLS, but found an unexpected style: ${l}!`),[0,0]}};function Yr(l){return l.symbolLayers!==void 0}const Fs=l=>{let s,i;const n=l;if(n==="circle"||n==="esriSMSCircle"){let a=Math.acos(.995),o=Math.ceil(Si/a/4);o===0&&(o=1),a=zr/o,o*=4;const h=[];h.push([50,0]);for(let c=1;c<o;c++)h.push([50*Math.cos(c*a),-50*Math.sin(c*a)]);h.push([50,0]),s={rings:[h]},i={xmin:-50,ymin:-50,xmax:50,ymax:50}}else if(n==="cross"||n==="esriSMSCross")s={rings:[[[0,50],[0,0],[50,0],[50,-0],[0,-0],[0,-50],[-0,-50],[-0,-0],[-50,-0],[-50,0],[-0,0],[-0,50],[0,50]]]},i={xmin:-50,ymin:-50,xmax:50,ymax:50};else if(n==="diamond"||n==="esriSMSDiamond")s={rings:[[[-50,0],[0,50],[50,0],[0,-50],[-50,0]]]},i={xmin:-50,ymin:-50,xmax:50,ymax:50};else if(n==="square"||n==="esriSMSSquare")s={rings:[[[-50,-50],[-50,50],[50,50],[50,-50],[-50,-50]]]},i={xmin:-50,ymin:-50,xmax:50,ymax:50};else if(n==="x"||n==="esriSMSX")s={rings:[[[0,0],[50-0,50],[50,50-0],[0,0],[50,0-50],[50-0,-50],[0,-0],[0-50,-50],[-50,0-50],[-0,0],[-50,50-0],[0-50,50],[0,0]]]},i={xmin:-50,ymin:-50,xmax:50,ymax:50};else if(n==="triangle"||n==="esriSMSTriangle"){const a=100*.5773502691896257,o=-a,h=2/3*100,c=h-100;s={rings:[[[o,c],[0,h],[a,c],[o,c]]]},i={xmin:o,ymin:c,xmax:a,ymax:h}}else n==="arrow"&&(s={rings:[[[-50,50],[50,0],[-50,-50],[-33,-20],[-33,20],[-50,50]]]},i={xmin:-50,ymin:-50,xmax:50,ymax:50});return[i,s]},Vr=l=>l==="vertical"||l==="horizontal"||l==="cross"||l==="esriSFSCross"||l==="esriSFSVertical"||l==="esriSFSHorizontal",Br=l=>l&&l.charAt(0).toLowerCase()+l.substr(1);function Wr(l,t,e){if(!l.effects||t.geometryEngine!=null)return;if(t.geometryEnginePromise){e.push(t.geometryEnginePromise);return}an(l.effects)&&(t.geometryEnginePromise=ln(),e.push(t.geometryEnginePromise),t.geometryEnginePromise.then(i=>t.geometryEngine=i))}function Ur(l){var t;if(!l)return null;switch(l.type){case"CIMPointSymbol":{const e=l.symbolLayers;return!e||e.length!==1?null:Ur(e[0])}case"CIMVectorMarker":{const e=l.markerGraphics;if(!e||e.length!==1)return null;const s=e[0];if(!s)return null;const i=s.geometry;if(!i)return null;const n=s.symbol;return!n||n.type!=="CIMPolygonSymbol"&&n.type!=="CIMLineSymbol"||(t=n.symbolLayers)!=null&&t.some(r=>!!r.effects)?null:{geom:i,asFill:n.type==="CIMPolygonSymbol"}}case"sdf":return{geom:l.geom,asFill:l.asFill}}return null}function qr(l){return l?l.rings?l.rings:l.paths?l.paths:l.xmin!==void 0&&l.ymin!==void 0&&l.xmax!==void 0&&l.ymax!==void 0?[[[l.xmin,l.ymin],[l.xmin,l.ymax],[l.xmax,l.ymax],[l.xmax,l.ymin],[l.xmin,l.ymin]]]:null:null}function $r(l){let t=1/0,e=-1/0,s=1/0,i=-1/0;for(const n of l)for(const r of n)r[0]<t&&(t=r[0]),r[0]>e&&(e=r[0]),r[1]<s&&(s=r[1]),r[1]>i&&(i=r[1]);return new _i(t,s,e-t,i-s)}function Gs(l){let t=1/0,e=-1/0,s=1/0,i=-1/0;for(const n of l)for(const r of n)r[0]<t&&(t=r[0]),r[0]>e&&(e=r[0]),r[1]<s&&(s=r[1]),r[1]>i&&(i=r[1]);return[t,s,e,i]}function Rs(l){return l?l.rings?Gs(l.rings):l.paths?Gs(l.paths):R(l)?[l.xmin,l.ymin,l.xmax,l.ymax]:null:null}function Ds(l,t,e,s,i){const[n,r,a,o]=l;if(a<n||o<r)return[0,0,0];const h=a-n,c=o-r,u=128,f=Qs,_=Math.floor((u*.5-f)*.5),d=u-(_+f)*2,p=Math.max(h,c),m=d/p,g=Math.round(h*m),y=Math.round(c*m),x=g+2*_,M=y+2*_;let P=1;if(t){const C=t.ymax-t.ymin;P=M/m/C}let b=0,w=0,I=1;s&&(i?t&&e&&t.ymax-t.ymin>0&&(I=(t.xmax-t.xmin)/(t.ymax-t.ymin),b=s.x/(e*I),w=s.y/e):(b=s.x,w=s.y)),t&&(b=(t.xmax+t.xmin)*.5+b*(t.xmax-t.xmin),w=(t.ymax+t.ymin)*.5+w*(t.ymax-t.ymin)),b-=n,w-=r,b*=m,w*=m,b+=_,w+=_;let k=b/x-.5,T=w/M-.5;return i&&e&&(k*=e*I,T*=e),[P,k,T]}function Lo(l){const t=qr(l.geom),e=$r(t),s=128,i=Qs,n=Math.floor((s*.5-i)*.5),r=s-(n+i)*2,a=Math.max(e.width,e.height),o=r/a,h=Math.round(e.width*o),c=Math.round(e.height*o),u=h+2*n,f=c+2*n,_=[];for(const p of t)if(p&&p.length>1){const m=[];for(const g of p){let[y,x]=g;y-=e.x,x-=e.y,y*=o,x*=o,y+=n-.5,x+=n-.5,l.asFill?m.push([y,x]):m.push([Math.round(y),Math.round(x)])}if(l.asFill){const g=m.length-1;(m[0][0]!==m[g][0]||m[0][1]!==m[g][1])&&m.push(m[0])}_.push(m)}const d=Jr(_,u,f,n);return l.asFill&&jr(_,u,f,n,d),[Kr(d,n),u,f]}function Jr(l,t,e,s){const i=t*e,n=new Array(i),r=s*s+1;for(let a=0;a<i;++a)n[a]=r;for(const a of l){const o=a.length;for(let h=1;h<o;++h){const c=a[h-1],u=a[h];let f,_;c[0]<u[0]?(f=c[0],_=u[0]):(f=u[0],_=c[0]);let d,p;c[1]<u[1]?(d=c[1],p=u[1]):(d=u[1],p=c[1]);let m=Math.floor(f)-s,g=Math.floor(_)+s,y=Math.floor(d)-s,x=Math.floor(p)+s;m<0&&(m=0),g>t&&(g=t),y<0&&(y=0),x>e&&(x=e);const M=u[0]-c[0],P=u[1]-c[1],b=M*M+P*P;for(let w=m;w<g;w++)for(let I=y;I<x;I++){let k=(w-c[0])*M+(I-c[1])*P,T,C;k<0?(T=c[0],C=c[1]):k>b?(T=u[0],C=u[1]):(k/=b,T=c[0]+k*M,C=c[1]+k*P);const L=(w-T)*(w-T)+(I-C)*(I-C),Y=(e-I-1)*t+w;L<n[Y]&&(n[Y]=L)}}}for(let a=0;a<i;++a)n[a]=Math.sqrt(n[a]);return n}function jr(l,t,e,s,i){for(const n of l){const r=n.length;for(let a=1;a<r;++a){const o=n[a-1],h=n[a];let c,u;o[0]<h[0]?(c=o[0],u=h[0]):(c=h[0],u=o[0]);let f,_;o[1]<h[1]?(f=o[1],_=h[1]):(f=h[1],_=o[1]);let d=Math.floor(c),p=Math.floor(u)+1,m=Math.floor(f),g=Math.floor(_)+1;d<s&&(d=s),p>t-s&&(p=t-s),m<s&&(m=s),g>e-s&&(g=e-s);for(let y=m;y<g;++y){if(o[1]>y==h[1]>y)continue;const x=(e-y-1)*t;for(let M=d;M<p;++M)M<(h[0]-o[0])*(y-o[1])/(h[1]-o[1])+o[0]&&(i[x+M]=-i[x+M]);for(let M=s;M<d;++M)i[x+M]=-i[x+M]}}}}function Kr(l,t){const e=2*t,s=l.length,i=new Uint8Array(s*4);for(let n=0;n<s;++n){const r=.5-l[n]/e;sn(r,i,4*n)}return i}function Zr(l,t){let e;if(typeof l=="string")e=F(l+`-seed(${t})`);else{let s=12;e=l^t;do e=(e>>8^e)*107+s|0;while(--s!==0)}return(1+e/(1<<31))/2}function Qr(l){return Math.floor(Zr(l,to)*eo)}const to=53290320,eo=10,so=96/72;class Hs{static executeEffects(t,e,s,i){const n=Pn(e),r=so;let a=new ns(n);for(const o of t){const h=os(o);h&&(a=h.execute(a,o,r,s,i))}return a}static next(t){const e=t.next();return Sn(e),e}static applyEffects(t,e,s){if(!t)return e;let i=new ns(e);for(const a of t){const o=os(a);o&&(i=o.execute(i,a,1,null,s))}let n=null,r;for(;r=i.next();)n?z(n)?z(r)&&n.paths.push(...r.paths):N(n)&&N(r)&&n.rings.push(...r.rings):n=r;return n}}const Xs=.05;function io(l){return Math.max(Math.round(l/Xs),1)*Xs}const no=new Set(["StartTimeOffset","Duration","RepeatDelay"]);function ro(l,t){return no.has(t)?io(l):l}const oo=ue.getLogger("esri.symbols.cim.cimAnalyzer");function Ze(l){switch(l){case"Butt":return Xe.BUTT;case"Square":return Xe.SQUARE;case"Round":default:return Xe.ROUND}}function Qe(l){switch(l){case"Bevel":return Ye.BEVEL;case"Miter":return Ye.MITER;case"Round":default:return Ye.ROUND}}function ao(l){const t=l.markerPlacement;return t&&t.angleToLine?Ee.MAP:Ee.SCREEN}class vo{constructor(t,e){this._cimLayers=[],this._poMap={},this._resourceManager=t,this._info=e}async analyzeSymbolReference(t,e,s){if(this._cimLayers=s??[],!t)return this._cimLayers;const i=t.primitiveOverrides;if(i){this._poMap={};const a=[],o=this._info;for(const h of i){const c=h.valueExpressionInfo;if(c&&o){const u=c.expression,f=Us(u,o.spatialReference,o.fields).then(_=>{_!=null&&this._setPoMap(h.primitiveName,h.propertyName,_)});a.push(f)}else h.value!=null&&this._setPoMap(h.primitiveName,h.propertyName,h.value)}a.length>0&&await Promise.all(a)}const n=t.symbol,r=[];return j.fetchResources(n,this._resourceManager,r),r.length>0&&await Promise.all(r),this._analyzeSymbol(n,i,e),this._cimLayers}_analyzeSymbol(t,e,s){switch(t==null?void 0:t.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":this._analyzeMultiLayerSymbol(t,e,s,1,0,0,0);break}}_analyzeMultiLayerSymbol(t,e,s,i,n,r,a){const o=t==null?void 0:t.symbolLayers;if(!o)return;const h=t.effects;let c=Ee.SCREEN;const u=j.getSize(t)??0;t.type==="CIMPointSymbol"&&t.angleAlignment==="Map"&&(c=Ee.MAP);const f=t.type==="CIMPolygonSymbol";let _=o.length;for(;_--;){const d=o[_];if(!d||d.enable===!1)continue;let p;h&&h.length&&(p=[...h]);const m=d.effects;m&&m.length&&(h?p.push(...m):p=[...m]);const g=[];E.findEffectOverrides(p,e,g);let y;g.length>0?y=this._createEffectsOverrideFunction(p,g):y=p;const x=[];switch(E.findApplicableOverrides(d,e,x),d.type){case"CIMSolidFill":this._analyzeSolidFill(d,y,x);break;case"CIMPictureFill":this._analyzePictureFill(d,y,x);break;case"CIMHatchFill":this._analyzeHatchFill(d,y,x);break;case"CIMGradientFill":this._analyzeGradientFill(d,y,x);break;case"CIMSolidStroke":this._analyzeSolidStroke(d,y,x,f,u);break;case"CIMPictureStroke":this._analyzePictureStroke(d,y,x,f,u);break;case"CIMGradientStroke":this._analyzeGradientStroke(d,y,x,f,u);break;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":{t.type==="CIMLineSymbol"&&(c=ao(d)),this._analyzeMarker(d,y,null,x,c,u,1,s,i,n,r,a);break}default:oo.error("Cannot analyze CIM layer",d.type)}}}_analyzeSolidFill(t,e,s){const i=t.primitiveName,n=W(t.color),[r,a]=this._analyzePrimitiveOverrides(s,i,e,null,null),o=F(JSON.stringify(t)+a).toString();this._cimLayers.push({type:"fill",templateHash:o,materialHash:r?()=>o:o,cim:t,materialOverrides:null,colorLocked:!!t.colorLocked,color:this._createOverrideFunction(i,"Color",n,K),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:e,applyRandomOffset:!1,sampleAlphaOnly:!0})}_analyzePictureFill(t,e,s){const i=t.primitiveName,n=Se(t),[r,a]=this._analyzePrimitiveOverrides(s,i,e,null,null),o=F(JSON.stringify(t)+a).toString(),h=F(`${t.url}${JSON.stringify(t.colorSubstitutions)}`).toString(),c=S(t.height,Ir);let u=S(t.scaleX,1);if("width"in t&&typeof t.width=="number"){const f=t.width;let _=1;const d=this._resourceManager.getResource(t.url);d!=null&&(_=d.width/d.height),u/=_*(c/f)}this._cimLayers.push({type:"fill",templateHash:o,materialHash:r?()=>h:h,cim:t,materialOverrides:null,colorLocked:!!t.colorLocked,effects:e,color:this._createOverrideFunction(i,"TintColor",n,K),height:this._createOverrideFunction(i,"Height",c),scaleX:this._createOverrideFunction(i,"ScaleX",u),angle:this._createOverrideFunction(i,"Rotation",S(t.rotation)),offsetX:this._createOverrideFunction(i,"OffsetX",S(t.offsetX)),offsetY:this._createOverrideFunction(i,"OffsetY",S(t.offsetY)),url:t.url,applyRandomOffset:!1,sampleAlphaOnly:!1})}_analyzeHatchFill(t,e,s){var d,p;const i=["Rotation","OffsetX","OffsetY"],n=s.filter(m=>m.primitiveName!==t.primitiveName||!i.includes(m.propertyName)),r=t.primitiveName;let[a,o]=this._analyzePrimitiveOverrides(s,r,e,null,null);const h=F(JSON.stringify(t)+o).toString(),c=F(`${t.separation}${JSON.stringify(t.lineSymbol)}`).toString();let u={r:255,g:255,b:255,a:1},f=!1;const _=(p=(d=t.lineSymbol)==null?void 0:d.symbolLayers)==null?void 0:p.find(m=>{var g;return m.type==="CIMSolidStroke"&&((g=this._poMap[m.primitiveName])==null?void 0:g.Color)!=null});if(_){u=W(_.color),u=this._createOverrideFunction(_.primitiveName,"Color",u,K);const m=typeof u=="function";a=a||m,f=_.color!=null||m}this._cimLayers.push({type:"fill",templateHash:h,materialHash:a?this._createMaterialHashFunction(c,n):c,cim:t,materialOverrides:n,colorLocked:!!t.colorLocked,effects:e,color:u,height:this._createOverrideFunction(r,"Separation",S(t.separation,ds)),scaleX:1,angle:this._createOverrideFunction(r,"Rotation",S(t.rotation)),offsetX:this._createOverrideFunction(r,"OffsetX",S(t.offsetX)),offsetY:this._createOverrideFunction(r,"OffsetY",S(t.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!0,hasUnresolvedReplacementColor:!f})}_analyzeGradientFill(t,e,s){const i=t.primitiveName,[n,r]=this._analyzePrimitiveOverrides(s,i,e,null,null),a=F(JSON.stringify(t)+r).toString();this._cimLayers.push({type:"fill",templateHash:a,materialHash:n?this._createMaterialHashFunction(a,s):a,cim:t,materialOverrides:null,colorLocked:!!t.colorLocked,effects:e,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,applyRandomOffset:!1,sampleAlphaOnly:!1})}_analyzeSolidStroke(t,e,s,i,n){const r=t.primitiveName,a=W(t.color),o=S(t.width,xt),h=Ze(t.capStyle),c=Qe(t.joinStyle),u=t.miterLimit,[f,_]=this._analyzePrimitiveOverrides(s,r,e,null,null),d=F(JSON.stringify(t)+_).toString();let p,m;if(e&&e instanceof Array&&e.length>0){const g=e[e.length-1];if(g.type==="CIMGeometricEffectDashes"&&g.lineDashEnding==="NoConstraint"&&g.offsetAlongLine===null){e=[...e];const y=e.pop();p=y.dashTemplate,m=y.scaleDash}}this._cimLayers.push({type:"line",templateHash:d,materialHash:f?()=>d:d,cim:t,materialOverrides:null,isOutline:i,colorLocked:!!t.colorLocked,effects:e,color:this._createOverrideFunction(r,"Color",a,K),width:this._createOverrideFunction(r,"Width",o),cap:this._createOverrideFunction(r,"CapStyle",h),join:this._createOverrideFunction(r,"JoinStyle",c),miterLimit:u&&this._createOverrideFunction(r,"MiterLimit",u),referenceWidth:n,zOrder:ts(t.name),dashTemplate:p,scaleDash:m,sampleAlphaOnly:!0})}_analyzePictureStroke(t,e,s,i,n){const r=F(`${t.url}${JSON.stringify(t.colorSubstitutions)}`).toString(),a=t.primitiveName,o=Se(t),h=S(t.width,xt),c=Ze(t.capStyle),u=Qe(t.joinStyle),f=t.miterLimit,[_,d]=this._analyzePrimitiveOverrides(s,a,e,null,null),p=F(JSON.stringify(t)+d).toString();this._cimLayers.push({type:"line",templateHash:p,materialHash:_?()=>r:r,cim:t,materialOverrides:null,isOutline:i,colorLocked:!!t.colorLocked,effects:e,color:this._createOverrideFunction(a,"TintColor",o,K),width:this._createOverrideFunction(a,"Width",h),cap:this._createOverrideFunction(a,"CapStyle",c),join:this._createOverrideFunction(a,"JoinStyle",u),miterLimit:f&&this._createOverrideFunction(a,"MiterLimit",f),referenceWidth:n,zOrder:ts(t.name),dashTemplate:null,scaleDash:!1,url:t.url,sampleAlphaOnly:!1})}_analyzeGradientStroke(t,e,s,i,n){const r=t.primitiveName,a=S(t.width,xt),o=Ze(t.capStyle),h=Qe(t.joinStyle),c=t.miterLimit,[u,f]=this._analyzePrimitiveOverrides(s,r,e,null,null),_=F(JSON.stringify(t)+f).toString();this._cimLayers.push({type:"line",templateHash:_,materialHash:u?this._createMaterialHashFunction(_,s):_,cim:t,materialOverrides:null,isOutline:i,colorLocked:!!t.colorLocked,effects:e,color:{r:128,g:128,b:128,a:1},width:this._createOverrideFunction(r,"Width",a),cap:this._createOverrideFunction(r,"CapStyle",o),join:this._createOverrideFunction(r,"JoinStyle",h),miterLimit:c&&this._createOverrideFunction(r,"MiterLimit",c),referenceWidth:n,zOrder:ts(t.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}_analyzeMarker(t,e,s,i,n,r,a,o,h,c,u,f){if(this._analyzeMarkerInsidePolygon(t,e,i))return;const _=S(t.size,ze),d=S(t.rotation),p=S(t.offsetX),m=S(t.offsetY);let g=this._createOverrideFunction(t.primitiveName,"Size",_),y=this._createOverrideFunction(t.primitiveName,"Rotation",d),x=this._createOverrideFunction(t.primitiveName,"OffsetX",p),M=this._createOverrideFunction(t.primitiveName,"OffsetY",m);g=this._transformSize(g,a),y=this._transformRotation(y,!!t.rotateClockwise,c);const P=this._transformOffsetX(x,M,c,a,u),b=this._transformOffsetY(x,M,c,a,f);switch(x=P,M=b,t.type){case"CIMPictureMarker":this._analyzePictureMarker(t,e,s,i,n,r,g,y,x,M);break;case"CIMVectorMarker":this._analyzeVectorMarker(t,e,s,i,n,r,a,o,g,y,x,M);break}}_analyzeMarkerInsidePolygon(t,e,s){const{markerPlacement:i,type:n}=t;if(!i||i.type!=="CIMMarkerPlacementInsidePolygon")return!1;if(n==="CIMVectorMarker"||n==="CIMPictureMarker"){const x=t.primitiveName;if(x){const[P,b]=this._analyzePrimitiveOverrides(s,x,e,null,null);if(P)return!1}const M=i.primitiveName;if(M){const[P,b]=this._analyzePrimitiveOverrides(s,M,e,null,null);if(P)return!1}if(n==="CIMVectorMarker"){const{markerGraphics:P}=t;if(P)for(const b of P){const{symbol:w}=b;if((w==null?void 0:w.type)==="CIMPolygonSymbol"&&w.symbolLayers){const{symbolLayers:I}=w;for(const k of I)if(k.type==="CIMSolidStroke")return!1}}}else{const{animatedSymbolProperties:P}=t;if(P)return!1}}const r=i,a=Math.abs(r.stepX),o=Math.abs(r.stepY);if(a===0||o===0)return!0;const h=["Rotation","OffsetX","OffsetY"],c=s.filter(x=>x.primitiveName!==t.primitiveName||!h.includes(x.propertyName)),u="url"in t&&typeof t.url=="string"?t.url:void 0,[f,_]=this._analyzePrimitiveOverrides(s,r.primitiveName,e,null,null),d=F(JSON.stringify(t)+_).toString();let p,m=null,g;if(i.gridType==="Random"){const x=Jt(Zs),M=Math.max(Math.floor(x/a),1),P=Math.max(Math.floor(x/o),1);p=o*P,m=w=>w?w*P:0,g=M*a/p}else i.shiftOddRows?(p=o*2,m=x=>x?x*2:0,g=.5*(a/o)):(p=o,m=null,g=a/o);const y=Se(t);return this._cimLayers.push({type:"fill",templateHash:d,materialHash:f?this._createMaterialHashFunction(d,c):d,cim:t,materialOverrides:c,colorLocked:!!t.colorLocked,effects:e,color:this._createOverrideFunction(r.primitiveName,"TintColor",y,K),height:this._createOverrideFunction(r.primitiveName,"StepY",p,m),scaleX:g,angle:this._createOverrideFunction(r.primitiveName,"GridAngle",r.gridAngle),offsetX:this._createOverrideFunction(r.primitiveName,"OffsetX",S(r.offsetX)),offsetY:this._createOverrideFunction(r.primitiveName,"OffsetY",S(r.offsetY)),url:u,applyRandomOffset:i.gridType==="Random",sampleAlphaOnly:!u,hasUnresolvedReplacementColor:!0}),!0}_analyzePictureMarker(t,e,s,i,n,r,a,o,h,c){const u=t.primitiveName;let f=S(t.scaleX,1);const _=Se(t),d=F(`${t.url}${JSON.stringify(t.colorSubstitutions)}${JSON.stringify(t.animatedSymbolProperties)}`).toString();s||(s=this._createMarkerPlacementOverrideFunction(t.markerPlacement,i));const p=this._createAnimatedSymbolPropertiesOverrideFunction(t.animatedSymbolProperties,i),[m,g]=this._analyzePrimitiveOverrides(i,u,e,s,p),y=F(JSON.stringify(t)+g).toString(),x=t.anchorPoint??{x:0,y:0};if("width"in t&&typeof t.width=="number"){const w=t.width;let I=1;const k=this._resourceManager.getResource(t.url);k!=null&&(I=k.width/k.height);const T=S(t.size);f/=I*(T/w)}const M=t.animatedSymbolProperties&&t.animatedSymbolProperties.randomizeStartTime===!0;function P(w,I){return p!=null?Ps(p,w,I):null}const b=M?(w,I,k,T)=>{const C=Qr(T??0),L=P(w,I);return d+`-MATERIALGROUP(${C})-ASP(${JSON.stringify(L)})`}:m?(w,I)=>{const k=P(w,I);return d+`-ASP(${JSON.stringify(k)})`}:d;this._cimLayers.push({type:"marker",templateHash:y,materialHash:b,cim:t,materialOverrides:null,colorLocked:!!t.colorLocked,effects:e,scaleSymbolsProportionally:!1,alignment:n,size:a,scaleX:this._createOverrideFunction(u,"ScaleX",f),rotation:o,offsetX:h,offsetY:c,color:this._createOverrideFunction(u,"TintColor",_,K),anchorPoint:{x:x.x,y:x.y},isAbsoluteAnchorPoint:t.anchorPointUnits!=="Relative",outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:!1,referenceSize:r,sizeRatio:1,markerPlacement:s,url:t.url,animatedSymbolProperties:p})}_analyzeVectorMarker(t,e,s,i,n,r,a,o,h,c,u,f){const _=t.markerGraphics;if(!_)return;let d,p=0,m=1;t.scaleSymbolsProportionally&&(d=t.frame,d&&(p=d.ymax-d.ymin,m=this._transformSize(h,1/p))),m=this._transformSize(m,a),s||(s=this._createMarkerPlacementOverrideFunction(t.markerPlacement,i));for(const g of _)if(g){const y=g.symbol;if(!y)continue;let x=u,M=f;if((y.type==="CIMPointSymbol"||y.type==="CIMTextSymbol")&&d){let P=0,b=0;const w=g.geometry;"x"in w&&"y"in w&&(P+=w.x-(d.xmin+d.xmax)*.5,b+=w.y-(d.ymin+d.ymax)*.5);const I=t.anchorPoint;I&&(t.anchorPointUnits==="Absolute"?(P-=I.x,b-=I.y):d&&(P-=(d.xmax-d.xmin)*I.x,b-=(d.ymax-d.ymin)*I.y)),x=this._transformOffsetX(P,b,c,m,u),M=this._transformOffsetY(P,b,c,m,f)}switch(y.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":o?this._analyzeMultiLayerGraphicNonSDF(t,e,s,null,g,i,n,r,p):this._analyzeMultiLayerGraphic(t,e,s,null,g,i,n,r,p,m,h,c,x,M);break;case"CIMTextSymbol":{this._analyzeTextGraphic(t,e,s,g,i,n,r,p,m,h,c,x,M);break}}}}_analyzeMultiLayerGraphic(t,e,s,i,n,r,a,o,h,c,u,f,_,d){const p=n.symbol,m=p.symbolLayers;if(!m)return;let g=m.length;if(lo(m)){this._analyzeCompositeMarkerGraphic(t,e,s,i,n,m,r,a,o,h,u,f,_,d);return}const y=this._resourceManager.geometryEngine,x=Hs.applyEffects(p.effects,n.geometry,y);if(x)for(;g--;){const M=m[g];if(!(!M||M.enable===!1))switch(M.type){case"CIMSolidFill":case"CIMSolidStroke":{const P=Hs.applyEffects(M.effects,x,y),b=Rs(P);if(!b)continue;const w=t.anchorPointUnits!=="Relative",[I,k,T]=Ds(b,t.frame,t.size,t.anchorPoint,w),C=M.type==="CIMSolidFill",L={type:"sdf",geom:P,asFill:C},Y=t.primitiveName,U=M.path,V=M.primitiveName,Wt=W(C?jt(M):Kt(M)),te=C?{r:0,g:0,b:0,a:0}:W(Kt(M)),pt=Ne(M)??0;if(!C&&!pt)break;let lt=!1,O="";for(const q of r)(q.primitiveName===V||q.primitiveName===Y)&&(q.value!==void 0?O+=`-${q.primitiveName}-${q.propertyName}-${JSON.stringify(q.value)}`:q.valueExpressionInfo&&(lt=!0));(e!=null&&typeof e=="function"||s!=null&&typeof s=="function")&&(lt=!0),(A(u)||A(f)||A(_)||A(d))&&(lt=!0);const _e=JSON.stringify({...t,markerGraphics:null}),ee=F(JSON.stringify(L)+U).toString(),de=F(JSON.stringify(n)+JSON.stringify(M)+_e+O).toString();this._cimLayers.push({type:"marker",templateHash:de,materialHash:lt?()=>ee:ee,cim:L,materialOverrides:null,colorLocked:!!t.colorLocked,effects:e,scaleSymbolsProportionally:!!t.scaleSymbolsProportionally,alignment:a,anchorPoint:{x:k,y:T},isAbsoluteAnchorPoint:w,size:u,rotation:f,offsetX:_,offsetY:d,scaleX:1,frameHeight:h,rotateClockwise:!1,referenceSize:o,sizeRatio:I,color:this._createOverrideFunction(V,"Color",Wt,K),outlineColor:this._createOverrideFunction(V,"Color",te,K),outlineWidth:this._createOverrideFunction(V,"Width",pt),markerPlacement:s,animatedSymbolProperties:i,path:U});break}case"CIMVectorMarker":{M.markerPlacement?this._analyzeMultiLayerGraphicNonSDF(t,e,s,i,n,r,a,o,h):this._analyzeMarker(M,e,s,r,a,o,c,!1,u,f,_,d);break}default:{this._analyzeMultiLayerGraphicNonSDF(t,e,s,i,n,r,a,o,h);break}}}}_analyzeTextGraphic(t,e,s,i,n,r,a,o,h,c,u,f,_){const d=[];E.findApplicableOverrides(i,n,d);const p=i.geometry;if(!("x"in p)||!("y"in p))return;const m=i.symbol,g=ni(m),y=ii(m.fontStyleName),x=us(m.fontFamilyName);m.font={family:x,decoration:g,...y};let M=S(m.height,Re),P=S(m.angle),b=S(m.offsetX),w=S(m.offsetY);M=this._transformSize(M,h),P=this._transformRotation(P,!1,u);const I=this._transformOffsetX(b,w,u,h,f),k=this._transformOffsetY(b,w,u,h,_);b=I,w=k;const T=W(jt(m));let C=W(Kt(m)),L=Ne(m)??0;L||(C=W(jt(m.haloSymbol)),L=S(m.haloSize)),L=this._transformSize(L,h);let Y=null,U=null,V=0;if(m.callout&&m.callout.type==="CIMBackgroundCallout"){const q=m.callout;if(q.backgroundSymbol){const pe=q.backgroundSymbol.symbolLayers;if(pe)for(const mt of pe)mt.type==="CIMSolidFill"?Y=W(mt.color):mt.type==="CIMSolidStroke"&&(U=W(mt.color),V=S(mt.width,xt))}}const[Wt,te]=this._analyzePrimitiveOverrides(n,t.primitiveName,e,s,null),pt=JSON.stringify(t.effects)+Number(t.colorLocked).toString()+JSON.stringify(t.anchorPoint)+t.anchorPointUnits+JSON.stringify(t.markerPlacement)+t.size.toString(),lt=F(JSON.stringify(i)+pt+te).toString();let O=this._createOverrideFunction(i.primitiveName,"TextString",i.textString??"",si,m.textCase);if(O==null)return;const{fontStyleName:_e}=m,ee=x+(_e?"-"+_e.toLowerCase():"-regular"),de=ee;typeof O=="string"&&O.includes("[")&&m.fieldMap&&(O=rn(m.fieldMap,O,m.textCase)),this._cimLayers.push({type:"text",templateHash:lt,materialHash:Wt||typeof O=="function"||O.match(/\[(.*?)\]/)?(q,pe,mt)=>de+"-"+Ps(O,q,pe,mt):de+"-"+F(O),cim:m,materialOverrides:null,colorLocked:!!t.colorLocked,effects:e,alignment:r,anchorPoint:{x:0,y:0},isAbsoluteAnchorPoint:t.anchorPointUnits!=="Relative",fontName:ee,decoration:g,weight:y.weight,style:y.style,size:M,angle:P,offsetX:b,offsetY:w,horizontalAlignment:ri(m.horizontalAlignment),verticalAlignment:oi(m.verticalAlignment),text:O,color:T,outlineColor:C,outlineSize:L,backgroundColor:Y,borderLineColor:U,borderLineWidth:V,referenceSize:a,sizeRatio:1,markerPlacement:s})}_analyzeMultiLayerGraphicNonSDF(t,e,s,i,n,r,a,o,h){const c=this._buildSimpleMarker(t,n),u=["Rotation","OffsetX","OffsetY"],f=r.filter(w=>w.primitiveName!==t.primitiveName||!u.includes(w.propertyName));let _="";for(const w of r)w.value!==void 0&&(_+=`-${w.primitiveName}-${w.propertyName}-${JSON.stringify(w.value)}`);const[d,p,m]=j.getTextureAnchor(c,this._resourceManager),g=t.primitiveName,y=S(t.rotation),x=S(t.offsetX),M=S(t.offsetY),P=F(JSON.stringify(c)+_).toString(),b=f.length>0||e!=null&&typeof e=="function";this._cimLayers.push({type:"marker",templateHash:P,materialHash:b?this._createMaterialHashFunction(P,f):P,cim:c,materialOverrides:f,colorLocked:!!t.colorLocked,effects:e,scaleSymbolsProportionally:!!t.scaleSymbolsProportionally,alignment:a,anchorPoint:{x:d,y:p},isAbsoluteAnchorPoint:!1,size:S(t.size,ze),rotation:this._createOverrideFunction(g,"Rotation",y),offsetX:this._createOverrideFunction(g,"OffsetX",x),offsetY:this._createOverrideFunction(g,"OffsetY",M),color:{r:255,g:255,b:255,a:1},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:h,rotateClockwise:!!t.rotateClockwise,referenceSize:o,sizeRatio:m/Bt(t.size),markerPlacement:s,animatedSymbolProperties:i,avoidSDFRasterization:!0})}_buildSimpleMarker(t,e){return{type:t.type,enable:!0,name:t.name,colorLocked:t.colorLocked,primitiveName:t.primitiveName,anchorPoint:t.anchorPoint,anchorPointUnits:t.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:t.rotateClockwise,rotation:0,size:t.size,billboardMode3D:t.billboardMode3D,depth3D:t.depth3D,frame:t.frame,markerGraphics:[e],scaleSymbolsProportionally:t.scaleSymbolsProportionally,respectFrame:t.respectFrame,clippingPath:t.clippingPath}}_analyzeCompositeMarkerGraphic(t,e,s,i,n,r,a,o,h,c,u,f,_,d){const p=n.geometry,m=r[0],g=r[1],y=Rs(p);if(!y)return;const x=t.anchorPointUnits!=="Relative",[M,P,b]=Ds(y,t.frame,t.size,t.anchorPoint,x),w={type:"sdf",geom:p,asFill:!0},I=t.primitiveName,k=g.path,T=g.primitiveName,C=m.primitiveName,L=W(g.color),Y=W(m.color),U=S(m.width,xt);let V=!1,Wt="";for(const O of a)(O.primitiveName===T||O.primitiveName===C||O.primitiveName===I)&&(O.value!==void 0?Wt+=`-${O.primitiveName}-${O.propertyName}-${JSON.stringify(O.value)}`:O.valueExpressionInfo&&(V=!0));s!=null&&typeof s=="function"&&(V=!0),(A(u)||A(f)||A(_)||A(d))&&(V=!0);const te=JSON.stringify({...t,markerGraphics:null}),pt=F(JSON.stringify(w)+k).toString(),lt=F(JSON.stringify(n)+JSON.stringify(g)+JSON.stringify(m)+te+Wt).toString();this._cimLayers.push({type:"marker",templateHash:lt,materialHash:V?()=>pt:pt,cim:w,materialOverrides:null,colorLocked:!!t.colorLocked,effects:e,scaleSymbolsProportionally:!!t.scaleSymbolsProportionally,alignment:o,anchorPoint:{x:P,y:b},isAbsoluteAnchorPoint:x,size:u,rotation:f,offsetX:_,offsetY:d,scaleX:1,frameHeight:c,rotateClockwise:!1,referenceSize:h,sizeRatio:M,color:this._createOverrideFunction(T,"Color",L,K),outlineColor:this._createOverrideFunction(C,"Color",Y,K),outlineWidth:this._createOverrideFunction(C,"Width",U),markerPlacement:s,path:k,animatedSymbolProperties:i})}_createMaterialHashFunction(t,e){var i;const s=(i=this._info)==null?void 0:i.geometryType;if(s){const n=this._poMap;for(const r of e)if(r.valueExpressionInfo){const o=n[r.primitiveName]&&n[r.primitiveName][r.propertyName];o instanceof se&&(r.fn=(h,c,u)=>$t(o,h,{$view:u},s,c))}}return(n,r,a)=>{for(const o of e)o.fn&&(o.value=o.fn(n,r,a));return F(t+E.buildOverrideKey(e)).toString()}}_setPoMap(t,e,s){let i;this._poMap[t]?i=this._poMap[t]:(i={},this._poMap[t]=i),i[e]=s}_createOverrideFunction(t,e,s,i,n){var h;if(t==null)return s;const r=this._poMap[t];if(r==null)return s;const a=r[e];if(typeof a=="string"||typeof a=="number"||a instanceof Array)return i?i.call(null,a,n):a;const o=(h=this._info)==null?void 0:h.geometryType;return a==null||!(a instanceof se)||o==null?s:(c,u,f)=>{let _=$t(a,c,{$view:f},o,u);return _!==null&&i&&(_=i.call(null,_,n)),_!==null?_:s}}_createEffectsOverrideFunction(t,e){var n;const s=this._poMap,i=(n=this._info)==null?void 0:n.geometryType;for(const r of e)if(r.valueExpressionInfo&&i){const o=s[r.primitiveName]&&s[r.primitiveName][r.propertyName];o instanceof se&&(r.fn=(h,c,u)=>$t(o,h,{$view:u},i,c))}return(r,a,o)=>{for(const c of e)c.fn&&(c.value=c.fn(r,a,o));const h=[];for(let c of t){const u=c==null?void 0:c.primitiveName;if(u){let f=!1;for(const _ of e)if(_.primitiveName===u){const d=es(_.propertyName);_.value!=null&&_.value!==c[d]&&(f||(c=G(c),f=!0),c[d]=_.value)}}h.push(c)}return h}}_createMarkerPlacementOverrideFunction(t,e){var r;const s=[];if(E.findApplicableOverrides(t,e,s),t==null||s.length===0)return t;const i=this._poMap,n=(r=this._info)==null?void 0:r.geometryType;for(const a of s)if(a.valueExpressionInfo&&n){const h=i[a.primitiveName]&&i[a.primitiveName][a.propertyName];h instanceof se&&(a.fn=(c,u,f)=>$t(h,c,{$view:f},n,u))}return(a,o,h)=>{for(const f of s)f.fn&&(f.value=f.fn(a,o,h));const c=G(t),u=t.primitiveName;for(const f of s)if(f.primitiveName===u){const _=es(f.propertyName);f.value!=null&&f.value!==c[_]&&(c[_]=f.value)}return c}}_createAnimatedSymbolPropertiesOverrideFunction(t,e){var n;const s=[];if(E.findApplicableOverrides(t,e,s),t==null||s.length===0)return t;const i=(n=this._info)==null?void 0:n.geometryType;if(i){const r=this._poMap;for(const a of s)if(a.valueExpressionInfo){const h=r[a.primitiveName]&&r[a.primitiveName][a.propertyName];h instanceof se&&(a.fn=(c,u,f)=>$t(h,c,{$view:f},i,u))}}return(r,a,o)=>{for(const u of s)u.fn&&(u.value=u.fn(r,a,o));const h=G(t),c=t.primitiveName;for(const u of s)if(u.primitiveName===c){const f=es(u.propertyName);if(u.value!=null){const _=ro(u.value,u.propertyName);_!==h[f]&&(h[f]=_)}}return h}}_analyzePrimitiveOverrides(t,e,s,i,n){let r=!1,a="";for(const o of t)o.primitiveName===e&&(o.value!==void 0?a+=`-${o.primitiveName}-${o.propertyName}-${JSON.stringify(o.value)}`:o.valueExpressionInfo&&(r=!0));return s!=null&&typeof s=="function"&&(r=!0),i!=null&&typeof i=="function"&&(r=!0),n!=null&&typeof n=="function"&&(r=!0),[r,a]}_transformSize(t,e){return!A(t)&&!A(e)?t*e:(s,i,n)=>{const r=A(t)?t(s,i,n):t,a=A(e)?e(s,i,n):e;return r*a}}_transformRotation(t,e,s){return!A(t)&&!A(s)?e?s-t:s+t:(i,n,r)=>{const a=A(t)?t(i,n,r):t,o=A(s)?s(i,n,r):s;return e?o-a:o+a}}_transformOffsetX(t,e,s,i,n){if(!A(t)&&!A(e)&&!A(s)&&!A(i)&&!A(n)){const r=s*Math.PI/180;if(r){const a=Math.cos(r),o=Math.sin(r);return(a*t-o*e)*i+n}return t*i+n}return(r,a,o)=>{let h=A(s)?s(r,a,o):s;const c=A(i)?i(r,a,o):i,u=A(t)?t(r,a,o):t,f=A(n)?n(r,a,o):n;if(h){h*=Math.PI/180;const _=Math.cos(h),d=Math.sin(h),p=A(e)?e(r,a,o):e;return(_*u-d*p)*c+f}return u*c+f}}_transformOffsetY(t,e,s,i,n){if(!A(t)&&!A(e)&&!A(s)&&!A(i)&&!A(n)){const r=s*Math.PI/180;if(r){const a=Math.cos(r);return(Math.sin(r)*t+a*e)*i+n}return e*i+n}return(r,a,o)=>{let h=A(s)?s(r,a,o):s;const c=A(i)?i(r,a,o):i,u=A(e)?e(r,a,o):e,f=A(n)?n(r,a,o):n;if(h){h*=Math.PI/180;const _=Math.cos(h),d=Math.sin(h),p=A(t)?t(r,a,o):t;return(d*p+_*u)*c+f}return u*c+f}}}function ts(l){if(l&&l.indexOf("Level_")===0){const t=parseInt(l.substr(6),10);if(!isNaN(t))return t}return 0}function K(l){if(!l||l.length===0)return null;const t=new qs(l).toRgba();return{r:t[0],g:t[1],b:t[2],a:t[3]}}function es(l){return l&&l.charAt(0).toLowerCase()+l.substr(1)}function To(l,t){if(!t||t.length===0)return l;const e=G(l);return E.applyOverrides(e,t),e}const lo=l=>l&&l.length===2&&l[0].enable&&l[1].enable&&l[0].type==="CIMSolidStroke"&&l[1].type==="CIMSolidFill"&&!l[0].effects&&!l[1].effects,ho={marker:be.MARKER,fill:be.FILL,line:be.LINE,text:be.TEXT};class Ao{constructor(t,e,s,i){const n={minScale:e==null?void 0:e.minScale,maxScale:e==null?void 0:e.maxScale},r=co(n);this.layers=t,this.data=e,this.hash=this._createHash()+r,this.rendererKey=s;const a={isOutline:!1,placement:null,symbologyType:ji.DEFAULT,vvFlags:s};for(const o of t){const h=ho[o.type];a.isOutline=o.type==="line"&&o.isOutline,o.materialKey=Ji(h,a),o.maxVVSize=i,o.scaleInfo=n,o.templateHash+=r}}get type(){return"expanded-cim"}_createHash(){let t="";for(const e of this.layers)t+=e.templateHash;return t}}function co(l){return!l.minScale&&!l.maxScale?"":l.minScale+"-"+l.maxScale}export{j as C,Ao as E,Co as H,_i as R,Qr as a,Lo as b,Zr as c,So as d,cs as e,ko as f,Ur as g,Io as h,fr as i,gi as j,bn as k,xn as l,wo as m,Hs as n,To as o,Ps as p,A as q,bo as r,Os as s,vo as t,$t as u};
