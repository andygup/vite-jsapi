import{du as y,r as S,es as p,bz as x}from"./index-ffb342b4.js";import{n as E}from"./normalizeUtils-ec352ded.js";import{p as R}from"./pbfQueryUtils-0fea6fbe.js";import{a as F}from"./queryZScale-b5ad7594.js";function m(r){const t={};for(const i in r){if(i==="declaredClass")continue;const e=r[i];if(!(e==null||typeof e=="function"))if(Array.isArray(e)){t[i]=[];for(let n=0;n<e.length;n++)t[i][n]=m(e[n])}else typeof e=="object"?e.toJSON&&(t[i]=JSON.stringify(e)):t[i]=e}return t}const d="Layer does not support extent calculation.";function O(r,t){if(t&&r.type==="extent")return`${r.xmin},${r.ymin},${r.xmax},${r.ymax}`;if(t&&r.type==="point")return`${r.x},${r.y}`;const i=r.toJSON();return delete i.spatialReference,JSON.stringify(i)}function g(r,t){const i=r.geometry,e=r.toJSON();delete e.compactGeometryEnabled,delete e.defaultSpatialReferenceEnabled;const n=e;let a,s,u;if(i!=null&&(s=i.spatialReference,u=i.spatialReference.wkid||JSON.stringify(i.spatialReference),n.geometryType=x(i),n.geometry=O(i,r.compactGeometryEnabled),n.inSR=u),e.groupByFieldsForStatistics&&(n.groupByFieldsForStatistics=e.groupByFieldsForStatistics.join(",")),e.objectIds&&(n.objectIds=e.objectIds.join(",")),e.orderByFields&&(n.orderByFields=e.orderByFields.join(",")),e.outFields&&(e.returnDistinctValues||!(t!=null&&t.returnCountOnly||t!=null&&t.returnExtentOnly||t!=null&&t.returnIdsOnly))?e.outFields.includes("*")?n.outFields="*":n.outFields=e.outFields.join(","):delete n.outFields,e.outSR?(n.outSR=e.outSR.wkid||JSON.stringify(e.outSR),a=r.outSpatialReference):i&&(e.returnGeometry||e.returnCentroid)&&(n.outSR=n.inSR,a=s),e.returnGeometry&&delete e.returnGeometry,e.outStatistics&&(n.outStatistics=JSON.stringify(e.outStatistics)),e.fullText&&(n.fullText=JSON.stringify(e.fullText)),e.pixelSize&&(n.pixelSize=JSON.stringify(e.pixelSize)),e.quantizationParameters&&(r.defaultSpatialReferenceEnabled&&s!=null&&r.quantizationParameters!=null&&r.quantizationParameters.extent!=null&&s.equals(r.quantizationParameters.extent.spatialReference)&&delete e.quantizationParameters.extent.spatialReference,n.quantizationParameters=JSON.stringify(e.quantizationParameters)),e.parameterValues&&(n.parameterValues=JSON.stringify(e.parameterValues)),e.rangeValues&&(n.rangeValues=JSON.stringify(e.rangeValues)),e.dynamicDataSource&&(n.layer=JSON.stringify({source:e.dynamicDataSource}),delete e.dynamicDataSource),e.timeExtent){const f=e.timeExtent,{start:l,end:c}=f;(l!=null||c!=null)&&(l===c?n.time=l:n.time=`${l??"null"},${c??"null"}`),delete e.timeExtent}return r.defaultSpatialReferenceEnabled&&s!=null&&a!=null&&s.equals(a)&&(n.defaultSR=n.inSR,delete n.inSR,delete n.outSR),n}async function z(r,t,i,e){const n=t.timeExtent!=null&&t.timeExtent.isEmpty?{data:{features:[]}}:await o(r,t,"json",e);return F(t,i,n.data),n}async function w(r,t,i,e){if(t.timeExtent!=null&&t.timeExtent.isEmpty)return{data:i.createFeatureResult()};const n=await j(r,t,e),a=n;return a.data=R(n.data,i),a}function j(r,t,i){return o(r,t,"pbf",i)}function B(r,t,i){return t.timeExtent!=null&&t.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):o(r,t,"json",i,{returnIdsOnly:!0})}function Q(r,t,i){return t.timeExtent!=null&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):o(r,t,"json",i,{returnIdsOnly:!0,returnCountOnly:!0})}async function I(r,t,i){if(t.timeExtent!=null&&t.timeExtent.isEmpty)return{data:{count:0,extent:null}};const e=await o(r,t,"json",i,{returnExtentOnly:!0,returnCountOnly:!0}),n=e.data;if(n.hasOwnProperty("extent"))return e;if(n.features)throw new Error(d);if(n.hasOwnProperty("count"))throw new Error(d);return e}async function o(r,t,i,e={},n={}){const a=typeof r=="string"?y(r):r,s=t.geometry?[t.geometry]:[];e.responseType=i==="pbf"?"array-buffer":"json";const u=await E(s,null,e),f=u&&u[0];f!=null&&(t=t.clone(),t.geometry=f);const l=m({...a.query,f:i,...n,...g(t,n)});return S(p(a.path,t.is3D?"query3d":"query"),{...e,query:{...l,...e.query}})}export{I as a,w as b,Q as c,j as d,z as e,B as f,m};
